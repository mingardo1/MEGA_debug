<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>196</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    196
                    <a href="195.html">prev</a>
                    <a href="197.html">next</a>
                    <a href="196_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_f6b200b2a988ba1c8c9bdce1f9018ade9b322480_Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;f6b200b2a988ba1c8c9bdce1f9018ade9b322480:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;f6b200b2a988ba1c8c9bdce1f9018ade9b322480^1:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;f6b200b2a988ba1c8c9bdce1f9018ade9b322480^2:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;9e22297053412e6b042d92d1d612bb91cc42a7e0:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [bs], [sbj], [bs], [sbj], [bs], [sbj], [sbj]], subset: [[b], [b], [bs], [sbj], [bs], [sbj], [bs], [sbj], [sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.content.ClipData;
   5 import android.content.ClipboardManager;
   6 import android.content.Context;
   7 import android.content.Intent;
   8 import android.database.Cursor;
   9 import android.graphics.drawable.Drawable;
  10 import android.net.Uri;
  11 import android.os.AsyncTask;
  12 import android.os.Build;
  13 import android.os.Bundle;
  14 import android.os.Handler;
  15 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  16 import android.support.design.widget.Snackbar;</span>
  17 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18 import android.os.Handler;</span>
  19 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  20 import android.support.v4.app.Fragment;</span>
  21 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  22 import android.support.v7.app.AppCompatActivity;
  23 import android.support.v7.view.ActionMode;
  24 import android.text.Editable;
  25 import android.text.Spanned;
  26 import android.text.TextWatcher;
  27 import android.text.style.RelativeSizeSpan;
  28 import android.text.style.URLSpan;
  29 import android.text.util.Linkify;
  30 import android.util.TypedValue;
  31 import android.view.LayoutInflater;
  32 import android.view.Menu;
  33 import android.view.MenuInflater;
  34 import android.view.MenuItem;
  35 import android.view.View;
  36 import android.view.ViewGroup;
  37 import android.view.inputmethod.InputMethodManager;
  38 import android.webkit.WebView;
  39 import android.widget.CursorAdapter;
  40 import android.widget.LinearLayout;
  41 import android.widget.TextView;
  42 import android.widget.Toast;
  43 
  44 import com.automattic.simplenote.analytics.AnalyticsTracker;
  45 import com.automattic.simplenote.models.Note;
  46 import com.automattic.simplenote.models.Tag;
  47 import com.automattic.simplenote.utils.AutoBullet;
  48 import com.automattic.simplenote.utils.DisplayUtils;
  49 import com.automattic.simplenote.utils.DrawableUtils;
  50 import com.automattic.simplenote.utils.MatchOffsetHighlighter;
  51 import com.automattic.simplenote.utils.NoteUtils;
  52 import com.automattic.simplenote.utils.PrefUtils;
  53 import com.automattic.simplenote.utils.SimplenoteLinkify;
  54 import com.automattic.simplenote.utils.SnackbarUtils;
  55 import com.automattic.simplenote.utils.SpaceTokenizer;
  56 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  57 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  58 import com.automattic.simplenote.utils.TextHighlighter;
  59 import com.automattic.simplenote.widgets.SimplenoteEditText;
  60 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  61 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62 import com.automattic.simplenote.utils.SpaceTokenizer;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65 import com.automattic.simplenote.utils.TextHighlighter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66 import com.automattic.simplenote.widgets.SimplenoteEditText;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67 import com.kennyc.bottomsheet.BottomSheet;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68 import com.kennyc.bottomsheet.BottomSheetListener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69 import com.simperium.client.Bucket;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 import com.simperium.client.BucketObjectMissingException;</span>
  71 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72 import com.commonsware.cwac.anddown.AndDown;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73 import com.kennyc.bottomsheet.BottomSheet;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74 import com.kennyc.bottomsheet.BottomSheetListener;</span>
  75 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  76 import com.simperium.client.Bucket;
  77 import com.simperium.client.BucketObjectMissingException;
  78 import com.simperium.client.Query;
  79 
  80 import java.util.Calendar;
  81 
  82 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;,
  83         TextWatcher, OnTagAddedListener, View.OnFocusChangeListener,
  84         SimplenoteEditText.OnSelectionChangedListener,
  85         ShareBottomSheetDialog.ShareSheetListener,
  86         HistoryBottomSheetDialog.HistorySheetListener,
  87         InfoBottomSheetDialog.InfoSheetListener {
  88 
  89     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  90     public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  91     static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;
  92     static public final String ARG_MARKDOWN_ENABLED = &quot;markdown_enabled&quot;;
  93     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  94     private static final int MAX_REVISIONS = 30;
  95 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96     private static final int PUBLISH_TIMEOUT = 20000;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97     private static final int HISTORY_TIMEOUT = 10000;</span>
  98 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  99 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListener, View.OnFocusChangeListener, SimplenoteEditText.OnSelectionChangedListener {">  99 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddeðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101     public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102     public static final String ARG_NEW_NOTE = &quot;new_note&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103     static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104     private static final int AUTOSAVE_DELAY_MILLIS = 2000;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105     private static final int MAX_REVISIONS = 30;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107     private Note mNote;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108     private Bucket&lt;Note&gt; mNotesBucket;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110     private SimplenoteEditText mContentEditText;</span>
 111 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112     public static final int THEME_LIGHT = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113     public static final int THEME_DARK = 1;</span>
 114 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 115 
 116     private Note mNote;
 117     private Bucket&lt;Note&gt; mNotesBucket;
 118 
 119     private SimplenoteEditText mContentEditText;
 120     private TagsMultiAutoCompleteTextView mTagView;
 121 
 122     private Handler mAutoSaveHandler;
 123     private Handler mPublishTimeoutHandler;
 124     private Handler mHistoryTimeoutHandler;
 125 
 126     private LinearLayout mPlaceholderView;
 127     private CursorAdapter mAutocompleteAdapter;
 128 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129     private boolean mIsNewNote, mIsLoadingNote;</span>
 130 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131     private SeekBar mHistorySeekBar;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132     private BottomSheet mBottomSheet;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133     private TextView mHistoryDate;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135     private ToggleButton mPinButton;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137     private Handler mAutoSaveHandler;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     private Handler mPublishTimeoutHandler;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140     private LinearLayout mPlaceholderView;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141     private CursorAdapter mAutocompleteAdapter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142     private boolean mIsNewNote, mIsLoadingNote, mDidTapHistoryButton;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143     private ActionMode mActionMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144     private MenuItem mViewLinkMenuItem;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145     private String mLinkUrl;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146     private String mLinkText;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147     private MatchOffsetHighlighter mHighlighter;</span>
 148 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 149     private boolean mIsNewNote, mIsLoadingNote, mDidTapHistoryButton, mIsMarkdownEnabled, mIsMarkdownEnabledGlobal;"> 149     private boolean mIsNewNote, mIsLoadingNote, mDidTapHistoryButton, mIsMarkdownEnabled, mIsMarkdownEnabðŸ”µ</abbr></span>
 150 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 151     private ActionMode mActionMode;
 152     private MenuItem mViewLinkMenuItem;
 153     private String mLinkUrl;
 154     private String mLinkText;
 155     private MatchOffsetHighlighter mHighlighter;
 156     private Drawable mEmailIcon, mWebIcon, mMapIcon, mCallIcon;
 157     private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
 158     private String mMatchOffsets;
 159     private int mCurrentCursorPosition;
 160 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161     private String mLastContentString;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163     private HistoryBottomSheetDialog mHistoryBottomSheet;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164     private InfoBottomSheetDialog mInfoBottomSheet;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165     private ShareBottomSheetDialog mShareBottomSheet;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167     private Snackbar mPublishingSnackbar;</span>
 168 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169     private CursorAdapter mAutocompleteAdapter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170     private boolean mIsNewNote, mIsLoadingNote, mDidTapHistoryButton;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171     private ActionMode mActionMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172     private MenuItem mViewLinkMenuItem;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173     private String mLinkUrl;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174     private String mLinkText;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175     private MatchOffsetHighlighter mHighlighter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176     private int mEmailIconResId, mWebIconResId, mMapIconResId, mCallIconResId;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177     private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178     private String mMatchOffsets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179     private int mCurrentCursorPosition;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180     private ArrayList&lt;Note&gt; mNoteRevisionsList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183      * Mandatory empty constructor for the fragment manager to instantiate the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184      * fragment (e.g. upon screen orientation changes).</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186     public NoteEditorFragment() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188 </span>
 189 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190     private ArrayList&lt;Note&gt; mNoteRevisionsList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191     private NoteMarkdownFragment mNoteMarkdownFragment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192     private String mCss;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193     private WebView mMarkdown;</span>
 194 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 195 
 196     /**
 197      * Mandatory empty constructor for the fragment manager to instantiate the
 198      * fragment (e.g. upon screen orientation changes).
 199      */
 200     public NoteEditorFragment() {
 201     }
 202 
 203     @Override
 204     public void onCreate(Bundle savedInstanceState) {
 205         super.onCreate(savedInstanceState);
 206 
 207         if (getActivity() != null) {
 208             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 209             mNotesBucket = currentApp.getNotesBucket();
 210         }
 211 
<abbr title=" 212         mCallIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_call_white_24dp, R.attr.actionModeTextColor);"> 212         mCallIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_call_white_24dp,ðŸ”µ</abbr>
<abbr title=" 213         mEmailIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_email_white_24dp, R.attr.actionModeTextColor);"> 213         mEmailIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_email_white_24dðŸ”µ</abbr>
<abbr title=" 214         mMapIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_map_white_24dp, R.attr.actionModeTextColor);"> 214         mMapIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_map_white_24dp, RðŸ”µ</abbr>
<abbr title=" 215         mWebIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_web_white_24dp, R.attr.actionModeTextColor);"> 215         mWebIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_web_white_24dp, RðŸ”µ</abbr>
 216 
 217         mAutoSaveHandler = new Handler();
 218         mPublishTimeoutHandler = new Handler();
 219         mHistoryTimeoutHandler = new Handler();
 220 
 221         mLastContentString = &quot;&quot;;
 222 
 223         mMatchHighlighter = new TextHighlighter(getActivity(),
<abbr title=" 224                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);"> 224                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor)ðŸ”µ</abbr>
 225         mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0) {
 226             @Override
 227             public View newView(Context context, Cursor cursor, ViewGroup parent) {
 228                 Activity activity = (Activity) context;
 229                 if (activity == null) return null;
 230                 return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 231             }
 232 
 233             @Override
 234             public void bindView(View view, Context context, Cursor cursor) {
 235                 TextView textView = (TextView) view;
 236                 textView.setText(convertToString(cursor));
 237             }
 238 
 239             @Override
 240             public CharSequence convertToString(Cursor cursor){
 241                 return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 242             }
 243 
 244             @Override
 245             public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 246                 Activity activity = getActivity();
 247                 if (activity == null) return null;
 248                 Simplenote application = (Simplenote) activity.getApplication();
 249                 Query&lt;Tag&gt; query = application.getTagsBucket().query();
 250                 // make the tag name available to the cursor
 251                 query.include(Tag.NAME_PROPERTY);
 252                 // sort the tags by their names
 253                 query.order(Tag.NAME_PROPERTY);
 254                 // if there&#x27;s a filter string find only matching tag names
<abbr title=" 255                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 255                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.forðŸ”µ</abbr>
 256                 return query.execute();
 257             }
 258         };
 259     }
 260 
 261     @Override
 262     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 263         setHasOptionsMenu(true);
 264         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 265         mContentEditText = ((SimplenoteEditText) rootView.findViewById(R.id.note_content));
 266         mContentEditText.addOnSelectionChangedListener(this);
 267         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 268         mTagView.setTokenizer(new SpaceTokenizer());
 269         mTagView.setOnFocusChangeListener(this);
 270 
 271         mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 272 
 273         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
 274         if (DisplayUtils.isLargeScreenLandscape(getActivity()) &amp;&amp; mNote == null) {
 275             mPlaceholderView.setVisibility(View.VISIBLE);
 276 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277             getActivity().invalidateOptionsMenu();</span>
 278 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280         mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283         mPinButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285             public void onClick(View v) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286                 if (mPinButton.isChecked()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287                     // Friendly message to the user as to what this button does.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288                     Toast.makeText(getActivity(), R.string.note_pinned, Toast.LENGTH_SHORT).show();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294         if (DisplayUtils.isLargeScreenLandscape(getActivity()) &amp;&amp; mNote == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295             mPlaceholderView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298         mTagView.setAdapter(mAutocompleteAdapter);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300         // Load note if we were passed a note Id</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301         Bundle arguments = getArguments();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303             String key = arguments.getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304             if (arguments.containsKey(ARG_MATCH_OFFSETS)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307             new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308             setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311 		return rootView;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312 	}</span>
 313 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314             mMarkdown = (WebView) rootView.findViewById(R.id.markdown);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316             switch (PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_THEME, THEME_LIGHT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317                 case THEME_DARK:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318                     mCss = &quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;dark.css\&quot; /&gt;&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319                     break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320                 case THEME_LIGHT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321                     mCss = &quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;light.css\&quot; /&gt;&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322                     break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323             }</span>
 324 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 325         }
 326 
 327         mTagView.setAdapter(mAutocompleteAdapter);
 328 
 329         // Load note if we were passed a note Id
 330         Bundle arguments = getArguments();
 331         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
 332             String key = arguments.getString(ARG_ITEM_ID);
 333             if (arguments.containsKey(ARG_MATCH_OFFSETS)) {
 334                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);
 335             }
 336             new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
 337             setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));
 338         }
 339 
 340 		return rootView;
 341 	}
 342 
 343     @Override
 344     public void onResume() {
 345         super.onResume();
 346         mNotesBucket.start();
 347         mNotesBucket.addListener(this);
 348 
 349         mTagView.setOnTagAddedListener(this);
 350 
 351         if (mContentEditText != null) {
<abbr title=" 352             mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_FONT_SIZE, 14));"> 352             mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), ðŸ”µ</abbr>
 353         }
 354     }
 355 
 356     @Override
 357     public void onPause() {
 358         mNotesBucket.removeListener(this);
 359         // Hide soft keyboard if it is showing...
 360         if (getActivity() != null) {
<abbr title=" 361             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 361             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(CðŸ”µ</abbr>
 362             if (inputMethodManager != null) {
 363                 inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 364             }
 365         }
 366 
 367         // Delete the note if it is new and has empty fields
 368         if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty()) {
 369             mNote.delete();
 370         } else {
 371             saveNote();
 372         }
 373 
 374         mTagView.setOnTagAddedListener(null);
 375 
 376         if (mAutoSaveHandler != null) {
 377             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 378         }
 379 
 380         if (mPublishTimeoutHandler != null) {
 381             mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 382         }
 383 
 384         if (mHistoryTimeoutHandler != null) {
 385             mHistoryTimeoutHandler.removeCallbacks(mHistoryTimeoutRunnable);
 386         }
 387 
 388         mHighlighter.stop();
 389 
 390         super.onPause();
 391     }
 392 
 393     @Override
 394     public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
<abbr title=" 395         if (!isAdded() || DisplayUtils.isLargeScreenLandscape(getActivity()) &amp;&amp; mNoteMarkdownFragment == null) {"> 395         if (!isAdded() || DisplayUtils.isLargeScreenLandscape(getActivity()) &amp;&amp; mNoteMarkdownFragment == ðŸ”µ</abbr>
 396             return;
 397         }
 398 
 399         inflater.inflate(R.menu.note_editor, menu);
 400 
 401         if (mNote != null) {
 402             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_view_info);
 403             viewPublishedNoteItem.setVisible(true);
 404 
 405             if (mIsMarkdownEnabledGlobal) {
 406                 MenuItem markdownEnableItem = menu.findItem(R.id.menu_markdown_enable);
 407                 markdownEnableItem.setChecked(mNote.isMarkdownEnabled());
 408                 markdownEnableItem.setVisible(true);
 409             }
 410 
 411             MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 412             if (mNote.isDeleted())
 413                 trashItem.setTitle(R.string.undelete);
 414             else
 415                 trashItem.setTitle(R.string.delete);
 416         }
 417 
 418         DrawableUtils.tintMenuWithAttribute(getActivity(), menu, R.attr.actionBarTextColor);
 419 
 420         super.onCreateOptionsMenu(menu, inflater);
 421     }
 422 
 423     @Override
 424     public boolean onOptionsItemSelected(MenuItem item) {
 425         switch (item.getItemId()) {
 426             case R.id.menu_view_info:
 427                 showInfo();
 428                 return true;
 429 
 430             case R.id.menu_history:
 431                 showHistory();
 432                 return true;
 433             case R.id.menu_share:
 434                 shareNote();
 435                 return true;
 436             case R.id.menu_markdown_enable:
 437                 mIsMarkdownEnabled = !item.isChecked();
 438                 item.setChecked(mIsMarkdownEnabled);
 439 
 440                 if (mIsMarkdownEnabled) {
 441                     ((NoteEditorActivity) getActivity()).showTabs();
 442 
 443                     if (mNoteMarkdownFragment == null) {
 444                         // Get markdown fragment and update content
 445                         mNoteMarkdownFragment =
 446                                 ((NoteEditorActivity) getActivity()).getNoteMarkdownFragment();
 447                         mNoteMarkdownFragment.updateMarkdown(getNoteContentString());
 448                     }
 449                 } else {
 450                     ((NoteEditorActivity) getActivity()).hideTabs();
 451                 }
 452 
 453                 return true;
 454             case R.id.menu_delete:
 455                 if (!isAdded()) return false;
 456 
 457                 deleteNote();
 458                 return true;
 459             case android.R.id.home:
 460                 if (!isAdded()) return false;
 461 
 462                 getActivity().finish();
 463                 return true;
 464             default:
 465                 return super.onOptionsItemSelected(item);
 466         }
 467     }
 468 
 469 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 470     private void deleteNote() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 471         if (mNote != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 472             mNote.setDeleted(!mNote.isDeleted());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 473             mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 474             mNote.save();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 475             Intent resultIntent = new Intent();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 476             if (mNote.isDeleted()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 477                 resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 478             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 479             getActivity().setResult(Activity.RESULT_OK, resultIntent);</span>
 480 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 481                             &quot;action_bar_share_button&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482                     );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484                 return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485             case R.id.menu_delete:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486                 if (!isAdded()) return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488                 if (mNote != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489                     mNote.setDeleted(!mNote.isDeleted());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 490                     mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 491                     mNote.save();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 492                     Intent resultIntent = new Intent();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 493                     if (mNote.isDeleted()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 494                         resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496                     getActivity().setResult(Activity.RESULT_OK, resultIntent);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498                     AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499                             AnalyticsTracker.Stat.EDITOR_NOTE_DELETED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500                             AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501                             &quot;trash_menu_item&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 502                     );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 503                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 504 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505                 getActivity().finish();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 506                 return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 507             case android.R.id.home:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 508                 if (!isAdded()) return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 509 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510                 getActivity().finish();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 511                 return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 512             default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 513                 return super.onOptionsItemSelected(item);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 514         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 515     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 516 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 517     // show a popup view from the info action bar item</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 518     private void showInfoPopup(View view) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 519         if (!isAdded() || view == null) return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 520 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 521         if (mInfoPopupWindow == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 522             mInfoPopupWindow = new PopupWindow(getActivity());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 523             mInfoPopupWindow.setWidth(WindowManager.LayoutParams.WRAP_CONTENT);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 524             mInfoPopupWindow.setHeight(WindowManager.LayoutParams.WRAP_CONTENT);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525             mInfoPopupWindow.setBackgroundDrawable(new ColorDrawable(0));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526             mInfoPopupWindow.setOutsideTouchable(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527             mInfoPopupWindow.setFocusable(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 528 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529             LayoutInflater inflater = LayoutInflater.from(getActivity());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530             View popupView = inflater.inflate(R.layout.popup_info, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531             mInfoPopupWindow.setContentView(popupView);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 534         updateInfoPopup();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 535 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 536         mInfoPopupWindow.showAsDropDown(view);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 537 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 538         // Request revisions for the current note</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 539         mNotesBucket.getRevisions(mNote, MAX_REVISIONS, mRevisionsRequestCallbacks);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 540     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 541 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 542     // update the content of the popupview</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 543     private void updateInfoPopup() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 544         if (mInfoPopupWindow == null || mInfoPopupWindow.getContentView() == null) return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 545 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 546         View popupView = mInfoPopupWindow.getContentView();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 547 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 548         View publishButton = popupView.findViewById(R.id.publish_note_button);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 549         TextView publishButtonTextView = (TextView)popupView.findViewById(R.id.publish_note_button_text);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 550         ImageView publishButtonIcon = (ImageView)popupView.findViewById(R.id.publish_note_button_icon);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 551         TextView publishTextView = (TextView) popupView.findViewById(R.id.publish_url_textview);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 552         TextView wordCountTextView = (TextView) popupView.findViewById(R.id.word_count);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 553         ImageButton publishCopyButton = (ImageButton) popupView.findViewById(R.id.publish_copy_url);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 554         ImageButton publishShareButton = (ImageButton) popupView.findViewById(R.id.publish_share_url);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 555         View actionsView = popupView.findViewById(R.id.publish_actions);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 556         final View historyButton = popupView.findViewById(R.id.history_button);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 557 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 558         final ViewSwitcher viewSwitcher = (ViewSwitcher) popupView.findViewById(R.id.publish_view_switcher);"> 558         final ViewSwitcher viewSwitcher = (ViewSwitcher) popupView.findViewById(R.id.publish_view_switcheðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 559 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 560         publishButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 561             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 562             public void onClick(View v) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 563                 if (mNote != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 564                     boolean newPublishedStatus = !mNote.isPublished();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 565                     mNote.setPublished(newPublishedStatus);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 566                     mNote.save();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 567 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 568                     if (viewSwitcher.getDisplayedChild() == 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 569                         viewSwitcher.showNext();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 570                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 571 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 572                     // reset publish status in 20 seconds if we don&#x27;t hear back from Simperium</span>
 573 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574     protected void clearMarkdown() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575         mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss + &quot;&quot;, &quot;text/html&quot;, &quot;utf-8&quot;, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578     protected void hideMarkdown() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579         mMarkdown.setVisibility(View.INVISIBLE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582     protected void showMarkdown() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583         mMarkdown.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586     // show a popup view from the info action bar item</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587     private void showInfoPopup(View view) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588         if (!isAdded() || view == null) return;</span>
 589 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 590 
 591             AnalyticsTracker.track(
 592                     AnalyticsTracker.Stat.EDITOR_NOTE_DELETED,
 593                     AnalyticsTracker.CATEGORY_NOTE,
 594                     &quot;trash_menu_item&quot;
 595             );
 596         }
 597 
 598         getActivity().finish();
 599     }
 600 
 601     private void shareNote() {
 602         if (mNote != null) {
 603             mContentEditText.clearFocus();
 604             showShareSheet();
 605             AnalyticsTracker.track(
 606                     AnalyticsTracker.Stat.EDITOR_NOTE_CONTENT_SHARED,
 607                     AnalyticsTracker.CATEGORY_NOTE,
 608                     &quot;action_bar_share_button&quot;
 609             );
 610         }
 611     }
 612 
 613     private void showHistory() {
 614         if (mNote != null &amp;&amp; mNote.getVersion() &gt; 1) {
 615             mContentEditText.clearFocus();
 616             mHistoryTimeoutHandler.postDelayed(mHistoryTimeoutRunnable, HISTORY_TIMEOUT);
 617             showHistorySheet();
 618         }
 619         else {
 620             Toast.makeText(getActivity(), R.string.error_history, Toast.LENGTH_LONG).show();
 621         }
 622     }
 623 
 624     private void showInfo() {
 625         if (mNote != null) {
 626             mContentEditText.clearFocus();
 627             saveNote();
 628             showInfoSheet();
 629         }
 630     }
 631 
 632     private boolean noteIsEmpty() {
 633         return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 634     }
 635 
 636     protected void setMarkdownEnabled(boolean enabled) {
 637         mIsMarkdownEnabled = enabled;
 638 
 639         if (mIsMarkdownEnabled) {
 640             mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss +
 641                     new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, null);
 642         }
 643     }
 644 
 645     public void setNote(String noteID){
 646         setNote(noteID, null);
 647     }
 648 
 649     public void setNote(String noteID, String matchOffsets) {
 650         if (mAutoSaveHandler != null)
 651             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 652 
 653         mPlaceholderView.setVisibility(View.GONE);
 654 
 655         if (matchOffsets != null) {
 656             mMatchOffsets = matchOffsets;
 657         } else {
 658             mMatchOffsets = null;
 659         }
 660 
 661         // If we have a note already (on a tablet in landscape), save the note.
 662         if (mNote != null) {
 663             if (mIsNewNote &amp;&amp; noteIsEmpty())
 664                 mNote.delete();
 665             else if (mNote != null)
 666                 saveNote();
 667         }
 668 
 669         new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 670     }
 671 
 672     private void updateNote(Note updatedNote) {
 673         // update note if network change arrived
 674         mNote = updatedNote;
 675         refreshContent(true);
 676     }
 677 
 678     private void refreshContent(boolean isNoteUpdate) {
 679         if (mNote != null) {
 680             // Restore the cursor position if possible.
 681 
<abbr title=" 682             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 682             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEdðŸ”µ</abbr>
 683 
 684             mContentEditText.setText(mNote.getContent());
 685 
 686             if (isNoteUpdate) {
 687                 // Save the note so any local changes get synced
 688                 mNote.save();
 689 
<abbr title=" 690                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) {"> 690                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) ðŸ”µ</abbr>
 691                     mContentEditText.setSelection(cursorPosition);
 692                 }
 693             }
 694 
 695             afterTextChanged(mContentEditText.getText());
 696 
 697             updateTagList();
 698         }
 699     }
 700 
 701     private void updateTagList() {
 702         Activity activity = getActivity();
 703         if (activity == null) return;
 704 
 705         // Populate this note&#x27;s tags in the tagView
 706         mTagView.setChips(mNote.getTagString());
 707     }
 708 
 709     private int newCursorLocation(String newText, String oldText, int cursorLocation) {
 710         // Ported from the iOS app :)
 711         // Cases:
 712         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 713         // 1. Text was added after the cursor ==&gt; no change
 714         // 2. Text was added before the cursor ==&gt; location advances
 715         // 3. Text was removed after the cursor ==&gt; no change
 716         // 4. Text was removed before the cursor ==&gt; location retreats
 717         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 718 
 719         int newCursorLocation = cursorLocation;
 720 
 721         int deltaLength = newText.length() - oldText.length();
 722 
 723         // Case 0
 724         if (newText.length() &lt; cursorLocation)
 725             return newText.length();
 726 
 727         boolean beforeCursorMatches = false;
 728         boolean afterCursorMatches = false;
 729 
 730         try {
<abbr title=" 731             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 731             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorðŸ”µ</abbr>
<abbr title=" 732             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 732             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substðŸ”µ</abbr>
 733         } catch (Exception e) {
 734             e.printStackTrace();
 735         }
 736 
 737         // Cases 2 and 4
 738         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 739             newCursorLocation += deltaLength;
 740 
 741         // Cases 1, 3 and 5 have no change
 742         return newCursorLocation;
 743     }
 744 
 745     private final Runnable mAutoSaveRunnable = new Runnable() {
 746         @Override
 747         public void run() {
 748             saveAndSyncNote();
 749         }
 750     };
 751 
 752     @Override
 753     public void onTagsChanged(String tagString) {
 754         if (mNote == null || !isAdded()) return;
 755 
 756         if (mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length()) {
 757             AnalyticsTracker.track(
 758                     AnalyticsTracker.Stat.EDITOR_TAG_ADDED,
 759                     AnalyticsTracker.CATEGORY_NOTE,
 760                     &quot;tag_added_to_note&quot;
 761             );
 762         }
 763         else {
 764             AnalyticsTracker.track(
 765                     AnalyticsTracker.Stat.EDITOR_TAG_REMOVED,
 766                     AnalyticsTracker.CATEGORY_NOTE,
 767                     &quot;tag_removed_from_note&quot;
 768             );
 769         }
 770 
 771         mNote.setTagString(tagString);
 772         mNote.setModificationDate(Calendar.getInstance());
 773         updateTagList();
 774         mNote.save();
 775     }
 776 
 777     @Override
 778     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 779         // Unused
 780     }
 781 
 782     @Override
 783     public void afterTextChanged(Editable editable) {
 784         // check that the content has really changed (line spacing fix)
 785         if (!mLastContentString.equals(editable.toString())) {
 786             mLastContentString = editable.toString();
 787             setTitleSpan(editable);
 788             attemptAutoList(editable);
 789         }
 790     }
 791 
 792     @Override
 793     public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 794 
 795         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 796         if (mAutoSaveHandler != null) {
 797             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 798             mAutoSaveHandler.postDelayed(mAutoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 799         }
 800 
 801         // Remove search highlight spans when note content changes
 802         if (mMatchOffsets != null) {
 803             mMatchOffsets = null;
 804             mHighlighter.removeMatches();
 805         }
 806     }
 807 
 808     private void setTitleSpan(Editable editable) {
 809         // Set the note title to be a larger size
 810         // Remove any existing size spans
 811         RelativeSizeSpan spans[] = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 812         for (RelativeSizeSpan span : spans) {
 813             editable.removeSpan(span);
 814         }
 815         int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 816         if (newLinePosition == 0)
 817             return;
<abbr title=" 818         editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 818         editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editaðŸ”µ</abbr>
 819 
 820         fixLineSpacing();
 821     }
 822 
 823     // Fix for a line spacing bug
 824     // https://code.google.com/p/android/issues/detail?id=78706
 825     private void fixLineSpacing() {
 826         mContentEditText.setLineSpacing(8, 1);
 827         int startSelection = mContentEditText.getSelectionStart();
 828         mContentEditText.setText(mContentEditText.getText());
 829         mContentEditText.setSelection(startSelection);
 830     }
 831 
 832     private void attemptAutoList(Editable editable) {
 833         int oldCursorPosition = mCurrentCursorPosition;
 834         mCurrentCursorPosition = mContentEditText.getSelectionStart();
 835         AutoBullet.apply(editable, oldCursorPosition, mCurrentCursorPosition);
 836         mCurrentCursorPosition = mContentEditText.getSelectionStart();
 837     }
 838 
 839     private void saveAndSyncNote() {
 840         if (mNote == null) {
 841             return;
 842         }
 843 
 844         new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 845     }
 846 
 847     public void setPlaceholderVisible(boolean isVisible) {
 848         if (isVisible) {
 849             mNote = null;
 850             mContentEditText.setText(&quot;&quot;);
 851             mTagView.setText(&quot;&quot;);
 852             if (mPlaceholderView != null)
 853                 mPlaceholderView.setVisibility(View.VISIBLE);
 854         } else {
 855             if (mPlaceholderView != null)
 856                 mPlaceholderView.setVisibility(View.GONE);
 857         }
 858     }
 859 
 860     public void setIsNewNote(boolean isNewNote) {
 861         this.mIsNewNote = isNewNote;
 862     }
 863 
 864     @Override
 865     public void onFocusChange(View v, boolean hasFocus) {
 866         if (!hasFocus) {
 867             String tagString = getNoteTagsString().trim();
 868             if (tagString.length() &gt; 0) {
 869                 mTagView.setChips(tagString);
 870             }
 871         }
 872     }
 873 
 874     private Note getNote() {
 875         return mNote;
 876     }
 877 
 878     private String getNoteContentString() {
 879         if (mContentEditText == null || mContentEditText.getText() == null) {
 880             return &quot;&quot;;
 881         } else {
 882             return mContentEditText.getText().toString();
 883         }
 884     }
 885 
 886     private String getNoteTagsString() {
 887         if (mTagView == null || mTagView.getText() == null) {
 888             return &quot;&quot;;
 889         } else {
 890             return mTagView.getText().toString();
 891         }
 892     }
 893 
 894     /**
 895      *  Share bottom sheet callbacks
 896      */
 897 
 898     @Override
 899     public void onSharePublishClicked() {
 900         publishNote();
 901         mShareBottomSheet.dismiss();
 902     }
 903 
 904     @Override
 905     public void onShareUnpublishClicked() {
 906         unpublishNote();
 907         mShareBottomSheet.dismiss();
 908     }
 909 
 910     @Override
 911     public void onShareCollaborateClicked() {
 912         Toast.makeText(getActivity(), R.string.collaborate_message, Toast.LENGTH_LONG).show();
 913     }
 914 
 915     @Override
 916     public void onShareDismissed() {
 917 
 918     }
 919 
 920     /**
 921      *  History bottom sheet listeners
 922      */
 923 
 924     @Override
 925     public void onHistoryCancelClicked() {
 926         mContentEditText.setText(mNote.getContent());
 927         mHistoryBottomSheet.dismiss();
 928     }
 929 
 930     @Override
 931     public void onHistoryRestoreClicked() {
 932         mHistoryBottomSheet.dismiss();
 933         saveAndSyncNote();
 934     }
 935 
 936     @Override
 937     public void onHistoryDismissed() {
 938         if (!mHistoryBottomSheet.didTapOnButton()) {
 939             mContentEditText.setText(mNote.getContent());
 940         }
 941 
 942         if (mHistoryTimeoutHandler != null) {
 943             mHistoryTimeoutHandler.removeCallbacks(mHistoryTimeoutRunnable);
 944         }
 945     }
 946 
 947     @Override
 948     public void onHistoryUpdateNote(String content) {
 949         mContentEditText.setText(content);
 950     }
 951 
 952     /**
 953      *  Info bottom sheet listeners
 954      */
 955 
 956     @Override
 957     public void onInfoPinSwitchChanged(boolean isSwitchedOn) {
 958         NoteUtils.setNotePin(mNote, isSwitchedOn);
 959     }
 960 
 961     @Override
 962     public void onInfoMarkdownSwitchChanged(boolean isSwitchedOn) {
 963 
 964     }
 965 
 966     @Override
 967     public void onInfoCopyLinkClicked() {
 968         copyToClipboard(mNote.getPublishedUrl());
 969         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();
 970     }
 971 
 972     @Override
 973     public void onInfoShareLinkClicked() {
 974         mInfoBottomSheet.dismiss();
 975         showShareSheet();
 976     }
 977 
 978     @Override
 979     public void onInfoDismissed() {
 980 
 981     }
 982 
 983     private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 984 
 985         @Override
 986         protected void onPreExecute() {
 987             mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 988             mIsLoadingNote = true;
 989         }
 990 
 991         @Override
 992         protected Void doInBackground(String... args) {
 993             if (getActivity() == null) {
 994                 return null;
 995             }
 996 
 997             String noteID = args[0];
 998             Simplenote application = (Simplenote) getActivity().getApplication();
 999             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
1000             try {
1001                 mNote = notesBucket.get(noteID);
1002                 // Set the current note in NotesActivity when on a tablet
1003                 if (getActivity() instanceof NotesActivity) {
1004                     ((NotesActivity) getActivity()).setCurrentNote(mNote);
1005                 }
1006 
1007                 // Set markdown flag for global setting
<abbr title="1008                 mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_MARKDOWN_ENABLED, false);">1008                 mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_MARKDOWN_EðŸ”µ</abbr>
1009 
1010                 // Set markdown flag for current note
1011                 if (mNote != null) {
1012                     mIsMarkdownEnabled = mNote.isMarkdownEnabled();
1013                 }
1014             } catch (BucketObjectMissingException e) {
1015                 // TODO: Handle a missing note
1016             }
1017             return null;
1018         }
1019 
1020         @Override
1021         protected void onPostExecute(Void nada) {
1022             if (getActivity() == null || getActivity().isFinishing())
1023                 return;
1024             refreshContent(false);
1025             if (mMatchOffsets != null) {
<abbr title="1026                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);">1026                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.COðŸ”µ</abbr>
1027                 mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
1028             }
1029             mContentEditText.addTextChangedListener(NoteEditorFragment.this);
1030             if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
1031                 // Show soft keyboard
1032                 mContentEditText.requestFocus();
1033                 new Handler().postDelayed(new Runnable() {
1034                     @Override
1035                     public void run() {
<abbr title="1036                         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);">1036                         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSysðŸ”µ</abbr>
1037                         if (inputMethodManager != null)
1038                             inputMethodManager.showSoftInput(mContentEditText, 0);
1039                     }
1040                 }, 100);
1041 
1042             }
1043 
1044             // Show tabs if markdown is enabled globally, for current note, and not tablet landscape
1045             if (mIsMarkdownEnabledGlobal &amp;&amp; mIsMarkdownEnabled) {
1046                 // Get markdown view and update content
1047                 if (DisplayUtils.isLargeScreenLandscape(getActivity())) {
1048                     mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss +
<abbr title="1049                             new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, null);">1049                             new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, nðŸ”µ</abbr>
1050                 } else {
1051                     mNoteMarkdownFragment =
1052                             ((NoteEditorActivity) getActivity()).getNoteMarkdownFragment();
1053                     mNoteMarkdownFragment.updateMarkdown(getNoteContentString());
1054                 }
1055             }
1056 
1057             getActivity().invalidateOptionsMenu();
1058 
1059             SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
1060 
1061             mIsLoadingNote = false;
1062         }
1063     }
1064 
1065     private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
1066 
1067         @Override
1068         protected Void doInBackground(Void... args) {
1069             saveNote();
1070             return null;
1071         }
1072 
1073         @Override
1074         protected void onPostExecute(Void nada) {
1075             if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {
1076                 // Update links
1077                 SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
1078 
1079                 // Update markdown fragment
1080                 if (DisplayUtils.isLargeScreenLandscape(getActivity())) {
1081                     mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss +
<abbr title="1082                             new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, null);">1082                             new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, nðŸ”µ</abbr>
1083                 } else {
1084                     mNoteMarkdownFragment.updateMarkdown(getNoteContentString());
1085                 }
1086             }
1087         }
1088     }
1089 
1090 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1091     private void saveNote() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1092         if (mNote == null || (mHistoryBottomSheet != null &amp;&amp; mHistoryBottomSheet.isShowing())) {</span>
1093 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1094             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1095 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1096             SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1097 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1098             mIsLoadingNote = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1099         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1100     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1101 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1102     private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1103 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1104         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1105         protected Void doInBackground(Void... args) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1106             saveNote();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1107             return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1108         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1109 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1110         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1111         protected void onPostExecute(Void nada) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1112             if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1113                 // Update links</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1114                 SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1115             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1116         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1117     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1118 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1119     private void saveNote() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1120         if (mNote == null || (mBottomSheet != null &amp;&amp; mBottomSheet.isShowing())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1121             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1122         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1123 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1124         String content = getNoteContentString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1125         String tagString = getNoteTagsString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1126         if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1127             mNote.setContent(content);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1128             mNote.setTagString(tagString);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1129             mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1130             // Send pinned event to google analytics if changed</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1131             mNote.setPinned(mPinButton.isChecked());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1132             mNote.save();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1133             if (getActivity() != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1134                 if (mNote.isPinned() != mPinButton.isChecked()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1135                     AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1136                             mPinButton.isChecked() ? AnalyticsTracker.Stat.EDITOR_NOTE_PINNED :</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1137                                     AnalyticsTracker.Stat.EDITOR_NOTE_UNPINNED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1138                             AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1139                             &quot;pin_button&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1140                     );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1141                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1142 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1143                 AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1144                         AnalyticsTracker.Stat.EDITOR_NOTE_EDITED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1145                         AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1146                         &quot;editor_save&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1147                 );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1148             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1149         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1150     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1151 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1152     // Contextual action bar for dealing with links</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1153     private final ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1154 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1155         // Called when the action mode is created; startActionMode() was called</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1156         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1157         public boolean onCreateActionMode(ActionMode mode, Menu menu) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1158             // Inflate a menu resource providing context menu items</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1159             MenuInflater inflater = mode.getMenuInflater();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1160             if (inflater != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1161                 inflater.inflate(R.menu.view_link, menu);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1162                 mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1163                 mode.setTitle(getString(R.string.link));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1164                 if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1165                     mode.setTitleOptionalHint(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1166                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1167             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1168             return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1169         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1170 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1171         // Called each time the action mode is shown. Always called after onCreateActionMode, but</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1172         // may be called multiple times if the mode is invalidated.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1173         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1174         public boolean onPrepareActionMode(ActionMode mode, Menu menu) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1175             return false; // Return false if nothing is done</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1176         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1177 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1178         // Called when the user selects a contextual menu item</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1179         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1180         public boolean onActionItemClicked(ActionMode mode, MenuItem item) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1181             switch (item.getItemId()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1182                 case R.id.menu_view_link:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1183                     if (mLinkUrl != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1184                         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1185                             Uri uri = Uri.parse(mLinkUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1186                             Intent i = new Intent(Intent.ACTION_VIEW);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1187                             i.setData(uri);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1188                             startActivity(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1189                         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1190                             e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1191                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1192                         mode.finish(); // Action picked, so close the CAB</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1193                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1194                     return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1195                 case R.id.menu_copy:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1196                     if (mLinkText != null &amp;&amp; getActivity() != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1197                         ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);">1197                         ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(ConðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1198                         ClipData clip = ClipData.newPlainText(getString(R.string.app_name),mLinkText);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1199                         clipboard.setPrimaryClip(clip);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1200                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();">1200                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORTðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1201                         mode.finish();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1202                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1203                     return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1204                 case R.id.menu_share:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1205                     if (mLinkText != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1206                         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1207                             Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1208                             shareIntent.setType(&quot;text/plain&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1209                             shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mLinkText);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1210                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));">1210                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.stðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1211                         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1212                             e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1213                         }</span>
1214 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1215     protected void saveNote() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1216         if (mNote == null || (mBottomSheet != null &amp;&amp; mBottomSheet.isShowing())) {</span>
1217 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1218             return;
1219         }
1220 
1221         String content = getNoteContentString();
1222         String tagString = getNoteTagsString();
1223 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1224         if (mNote.hasChanges(content, tagString.trim(), mNote.isPinned())) {</span>
1225 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1226 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1227     private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1228 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1229         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1230         protected Void doInBackground(Void... args) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1231             saveNote();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1232             return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1233         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1234 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1235         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1236         protected void onPostExecute(Void nada) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1237             if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1238                 // Update links</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1239                 SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1240             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1241         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1242     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1243 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1244     private void saveNote() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1245         if (mNote == null || (mBottomSheet != null &amp;&amp; mBottomSheet.isShowing())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1246             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1247         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1248 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1249         String content = getNoteContentString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1250         String tagString = getNoteTagsString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1251         if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1252             mNote.setContent(content);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1253             mNote.setTagString(tagString);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1254             mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1255             // Send pinned event to google analytics if changed</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1256             mNote.setPinned(mPinButton.isChecked());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1257             mNote.save();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1258             if (getActivity() != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1259                 if (mNote.isPinned() != mPinButton.isChecked()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1260                     AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1261                             mPinButton.isChecked() ? AnalyticsTracker.Stat.EDITOR_NOTE_PINNED :</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1262                                     AnalyticsTracker.Stat.EDITOR_NOTE_UNPINNED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1263                             AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1264                             &quot;pin_button&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1265                     );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1266                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1267 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1268                 AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1269                         AnalyticsTracker.Stat.EDITOR_NOTE_EDITED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1270                         AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1271                         &quot;editor_save&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1272                 );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1273             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1274         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1275     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1276 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1277     // Contextual action bar for dealing with links</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1278     private final ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1279 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1280         // Called when the action mode is created; startActionMode() was called</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1281         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1282         public boolean onCreateActionMode(ActionMode mode, Menu menu) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1283             // Inflate a menu resource providing context menu items</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1284             MenuInflater inflater = mode.getMenuInflater();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1285             if (inflater != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1286                 inflater.inflate(R.menu.view_link, menu);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1287                 mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1288                 mode.setTitle(getString(R.string.link));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1289                 if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1290                     mode.setTitleOptionalHint(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1291                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1292             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1293             return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1294         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1295 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1296         // Called each time the action mode is shown. Always called after onCreateActionMode, but</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1297         // may be called multiple times if the mode is invalidated.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1298         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1299         public boolean onPrepareActionMode(ActionMode mode, Menu menu) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1300             return false; // Return false if nothing is done</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1301         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1302 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1303         // Called when the user selects a contextual menu item</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1304         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1305         public boolean onActionItemClicked(ActionMode mode, MenuItem item) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1306             switch (item.getItemId()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1307                 case R.id.menu_view_link:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1308                     if (mLinkUrl != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1309                         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1310                             Uri uri = Uri.parse(mLinkUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1311                             Intent i = new Intent(Intent.ACTION_VIEW);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1312                             i.setData(uri);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1313                             startActivity(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1314                         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1315                             e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1316                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1317                         mode.finish(); // Action picked, so close the CAB</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1318                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1319                     return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1320                 case R.id.menu_copy:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1321                     if (mLinkText != null &amp;&amp; getActivity() != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1322                         ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);">1322                         ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(ConðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1323                         ClipData clip = ClipData.newPlainText(getString(R.string.app_name),mLinkText);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1324                         clipboard.setPrimaryClip(clip);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1325                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();">1325                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORTðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1326                         mode.finish();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1327                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1328                     return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1329                 case R.id.menu_share:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1330                     if (mLinkText != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1331                         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1332                             Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1333                             shareIntent.setType(&quot;text/plain&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1334                             shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mLinkText);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1335                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));">1335                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.stðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1336                         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1337                             e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1338                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1339                         mode.finish();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1340                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1341                     return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1342                 default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1343                     return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1344             }</span>
1345 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1346         if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked(), mIsMarkdownEnabled)) {</span>
1347 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1348             mNote.setContent(content);
1349             mNote.setTagString(tagString);
1350             mNote.setModificationDate(Calendar.getInstance());
1351             mNote.setMarkdownEnabled(mIsMarkdownEnabled);
1352             // Send pinned event to google analytics if changed
1353             mNote.save();
1354 
1355             AnalyticsTracker.track(
1356                     AnalyticsTracker.Stat.EDITOR_NOTE_EDITED,
1357                     AnalyticsTracker.CATEGORY_NOTE,
1358                     &quot;editor_save&quot;
1359             );
1360         }
1361     }
1362 
1363     // Contextual action bar for dealing with links
1364     private final ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
1365 
1366         // Called when the action mode is created; startActionMode() was called
1367         @Override
1368         public boolean onCreateActionMode(ActionMode mode, Menu menu) {
1369             // Inflate a menu resource providing context menu items
1370             MenuInflater inflater = mode.getMenuInflater();
1371             if (inflater != null) {
1372                 inflater.inflate(R.menu.view_link, menu);
1373                 mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
1374                 mode.setTitle(getString(R.string.link));
1375                 if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
1376                     mode.setTitleOptionalHint(false);
1377                 }
1378 
1379                 DrawableUtils.tintMenuWithAttribute(getActivity(), menu, R.attr.actionModeTextColor);
1380             }
1381             return true;
1382         }
1383 
1384         // Called each time the action mode is shown. Always called after onCreateActionMode, but
1385         // may be called multiple times if the mode is invalidated.
1386         @Override
1387         public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
1388             return false; // Return false if nothing is done
1389         }
1390 
1391         // Called when the user selects a contextual menu item
1392         @Override
1393         public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
1394             switch (item.getItemId()) {
1395                 case R.id.menu_view_link:
1396                     if (mLinkUrl != null) {
1397                         try {
1398                             Uri uri = Uri.parse(mLinkUrl);
1399                             Intent i = new Intent(Intent.ACTION_VIEW);
1400                             i.setData(uri);
1401                             startActivity(i);
1402                         } catch (Exception e) {
1403                             e.printStackTrace();
1404                         }
1405                         mode.finish(); // Action picked, so close the CAB
1406                     }
1407                     return true;
1408                 case R.id.menu_copy:
1409                     if (mLinkText != null &amp;&amp; getActivity() != null) {
1410                         copyToClipboard(mLinkText);
<abbr title="1411                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();">1411                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORTðŸ”µ</abbr>
1412                         mode.finish();
1413                     }
1414                     return true;
1415                 case R.id.menu_share:
1416                     if (mLinkText != null) {
1417                         showShareSheet();
1418                         mode.finish();
1419                     }
1420                     return true;
1421                 default:
1422                     return false;
1423             }
1424         }
1425 
1426         // Called when the user exits the action mode
1427         @Override
1428         public void onDestroyActionMode(ActionMode mode) {
1429             mActionMode = null;
1430         }
1431     };
1432 
1433     // Checks if cursor is at a URL when the selection changes
1434     // If it is a URL, show the contextual action bar
1435     @Override
1436     public void onSelectionChanged(int selStart, int selEnd) {
1437         if (selStart == selEnd) {
1438             Editable noteContent = mContentEditText.getText();
1439             if (noteContent == null)
1440                 return;
1441 
1442             URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
1443             if (urlSpans.length &gt; 0) {
1444                 URLSpan urlSpan = urlSpans[0];
1445                 mLinkUrl = urlSpan.getURL();
<abbr title="1446                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();">1446                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpaðŸ”µ</abbr>
1447                 if (mActionMode != null) {
1448                     mActionMode.setSubtitle(mLinkText);
1449                     setLinkMenuItem();
1450                     return;
1451                 }
1452 
1453                 // Show the Contextual Action Bar
1454                 if (getActivity() != null) {
<abbr title="1455                     mActionMode = ((AppCompatActivity)getActivity()).startSupportActionMode(mActionModeCallback);">1455                     mActionMode = ((AppCompatActivity)getActivity()).startSupportActionMode(mActionModeCaðŸ”µ</abbr>
1456                     if (mActionMode != null) {
1457                         mActionMode.setSubtitle(mLinkText);
1458                     }
1459 
1460                     setLinkMenuItem();
1461                 }
1462             } else if (mActionMode != null) {
1463                 mActionMode.finish();
1464                 mActionMode = null;
1465             }
1466         } else if (mActionMode != null) {
1467             mActionMode.finish();
1468             mActionMode = null;
1469         }
1470     }
1471 
1472     private void setLinkMenuItem() {
1473         if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
1474             if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
1475                 mViewLinkMenuItem.setIcon(mCallIcon);
1476                 mViewLinkMenuItem.setTitle(getString(R.string.call));
1477             } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
1478                 mViewLinkMenuItem.setIcon(mEmailIcon);
1479                 mViewLinkMenuItem.setTitle(getString(R.string.email));
1480             } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
1481                 mViewLinkMenuItem.setIcon(mMapIcon);
1482                 mViewLinkMenuItem.setTitle(getString(R.string.view_map));
1483             } else {
1484                 mViewLinkMenuItem.setIcon(mWebIcon);
1485                 mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
1486             }
1487         }
1488     }
1489 
1490     // Resets note publish status if Simperium never returned the new publish status
1491     private final Runnable mPublishTimeoutRunnable = new Runnable() {
1492         @Override
1493         public void run() {
1494             if (!isAdded()) return;
1495 
1496             getActivity().runOnUiThread(new Runnable() {
1497                 @Override
1498                 public void run() {
1499 
1500                     mNote.setPublished(!mNote.isPublished());
1501                     mNote.save();
1502 
1503                     updatePublishedState(false);
1504 
1505                 }
1506             });
1507 
1508         }
1509     };
1510 
1511     // Hides the history bottom sheet if no revisions are loaded
1512     private final Runnable mHistoryTimeoutRunnable = new Runnable() {
1513         @Override
1514         public void run() {
1515             if (!isAdded()) return;
1516 
1517             getActivity().runOnUiThread(new Runnable() {
1518                 @Override
1519                 public void run() {
1520 
1521                     if (mHistoryBottomSheet.isShowing() &amp;&amp; !mHistoryBottomSheet.isHistoryLoaded()) {
1522                         mHistoryBottomSheet.dismiss();
1523                         Toast.makeText(getActivity(), R.string.error_history, Toast.LENGTH_LONG).show();
1524                     }
1525                 }
1526             });
1527 
1528         }
1529     };
1530 
1531     private void setPublishedNote(boolean isPublished) {
1532         if (mNote != null) {
1533             mNote.setPublished(isPublished);
1534             mNote.save();
1535 
1536             // reset publish status in 20 seconds if we don&#x27;t hear back from Simperium
1537             mPublishTimeoutHandler.postDelayed(mPublishTimeoutRunnable, PUBLISH_TIMEOUT);
1538 
1539             AnalyticsTracker.track(
1540                     (isPublished) ? AnalyticsTracker.Stat.EDITOR_NOTE_PUBLISHED :
1541                             AnalyticsTracker.Stat.EDITOR_NOTE_UNPUBLISHED,
1542                     AnalyticsTracker.CATEGORY_NOTE,
1543                     &quot;publish_note_button&quot;
1544             );
1545         }
1546     }
1547 
1548     private void updatePublishedState(boolean isSuccess) {
1549 
1550         if (mPublishingSnackbar == null) {
1551             return;
1552         }
1553 
1554         mPublishingSnackbar.dismiss();
1555         mPublishingSnackbar = null;
1556 
1557         if (isSuccess &amp;&amp; isAdded()) {
1558             if (mNote.isPublished()) {
1559                 SnackbarUtils.showSnackbar(getActivity(), R.string.publish_successful,
1560                         R.color.simplenote_positive_green,
1561                         Snackbar.LENGTH_LONG, R.string.undo, new View.OnClickListener() {
1562                             @Override
1563                             public void onClick(View v) {
1564                                 unpublishNote();
1565                             }
1566                         });
1567                 copyToClipboard(mNote.getPublishedUrl());
1568             } else {
1569                 SnackbarUtils.showSnackbar(getActivity(), R.string.unpublish_successful,
1570                         R.color.simplenote_negative_red,
1571                         Snackbar.LENGTH_LONG, R.string.undo, new View.OnClickListener() {
1572                             @Override
1573                             public void onClick(View v) {
1574                                 publishNote();
1575                             }
1576                         });
1577             }
1578         } else {
1579             if (mNote.isPublished()) {
1580                 SnackbarUtils.showSnackbar(getActivity(), R.string.unpublish_error,
1581                         R.color.simplenote_negative_red, Snackbar.LENGTH_LONG);
1582             } else {
1583                 SnackbarUtils.showSnackbar(getActivity(), R.string.publish_error,
1584                         R.color.simplenote_negative_red, Snackbar.LENGTH_LONG);
1585             }
1586         }
1587     }
1588 
1589     private void publishNote() {
1590 
1591         if (isAdded()) {
1592             mPublishingSnackbar = SnackbarUtils.showSnackbar(getActivity(), R.string.publishing,
1593                     R.color.simplenote_blue, Snackbar.LENGTH_INDEFINITE);
1594         }
1595         setPublishedNote(true);
1596     }
1597 
1598     private void unpublishNote() {
1599 
1600         if (isAdded()) {
1601             mPublishingSnackbar = SnackbarUtils.showSnackbar(getActivity(), R.string.unpublishing,
1602                     R.color.simplenote_blue, Snackbar.LENGTH_INDEFINITE);
1603         }
1604         setPublishedNote(false);
1605     }
1606 
1607     private void copyToClipboard(String text) {
<abbr title="1608         ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);">1608         ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_ðŸ”µ</abbr>
1609         ClipData clip = ClipData.newPlainText(getString(R.string.app_name), text);
1610         clipboard.setPrimaryClip(clip);
1611     }
1612 
1613     private void showShareSheet() {
1614         if (isAdded()) {
1615             if (mShareBottomSheet == null) {
1616                 mShareBottomSheet = new ShareBottomSheetDialog(this, this);
1617             }
1618             mShareBottomSheet.show(mNote);
1619         }
1620     }
1621 
1622     private void showInfoSheet() {
1623         if (isAdded()) {
1624             if (mInfoBottomSheet == null) {
1625                 mInfoBottomSheet = new InfoBottomSheetDialog(this, this);
1626             }
1627             mInfoBottomSheet.show(mNote);
1628         }
1629 
1630     }
1631 
1632     private void showHistorySheet() {
1633         if (isAdded()) {
1634             if (mHistoryBottomSheet == null) {
1635                 mHistoryBottomSheet = new HistoryBottomSheetDialog(this, this);
1636             }
1637 
1638             // Request revisions for the current note
<abbr title="1639             mNotesBucket.getRevisions(mNote, MAX_REVISIONS, mHistoryBottomSheet.getRevisionsRequestCallbacks());">1639             mNotesBucket.getRevisions(mNote, MAX_REVISIONS, mHistoryBottomSheet.getRevisionsRequestCallbaðŸ”µ</abbr>
1640             saveNote();
1641 
1642             mHistoryBottomSheet.show(mNote);
1643         }
1644     }
1645 
1646     /**
1647      * Simperium listeners
1648      */
1649 
1650     @Override
1651     public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
1652 
1653     }
1654 
1655     @Override
<abbr title="1656     public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {">1656     public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) ðŸ”µ</abbr>
1657         if (changeType == Bucket.ChangeType.MODIFY) {
1658             if (getNote() != null &amp;&amp; getNote().getSimperiumKey().equals(key)) {
1659                 try {
1660                     final Note updatedNote = mNotesBucket.get(key);
1661                     if (getActivity() != null) {
1662                         getActivity().runOnUiThread(new Runnable() {
1663                             @Override
1664                             public void run() {
1665                                 if (mPublishTimeoutHandler != null) {
1666                                     mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
1667                                 }
1668 
1669                                 updateNote(updatedNote);
1670                                 updatePublishedState(true);
1671                             }
1672                         });
1673                     }
1674                 } catch (BucketObjectMissingException e) {
1675                     e.printStackTrace();
1676                 }
1677             }
1678         }
1679     }
1680 
1681 
1682     @Override
1683     public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
1684         // noop
1685     }
1686 
1687     @Override
1688     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1689         // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
1690         if (mIsLoadingNote)
1691             return;
1692 
1693         Note openNote = getNote();
1694         if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
1695             return;
1696 
1697         note.setContent(getNoteContentString());
1698     }
1699 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.content.ClipData;
   5 import android.content.ClipboardManager;
   6 import android.content.Context;
   7 import android.content.Intent;
   8 import android.database.Cursor;
   9 import android.graphics.drawable.Drawable;
  10 import android.net.Uri;
  11 import android.os.AsyncTask;
  12 import android.os.Build;
  13 import android.os.Bundle;
  14 import android.os.Handler;
  15 import android.support.design.widget.Snackbar;
  16 import android.support.v4.app.Fragment;
  17 import android.support.v7.app.AppCompatActivity;
  18 import android.support.v7.view.ActionMode;
  19 import android.text.Editable;
  20 import android.text.Spanned;
  21 import android.text.TextWatcher;
  22 import android.text.style.RelativeSizeSpan;
  23 import android.text.style.URLSpan;
  24 import android.text.util.Linkify;
  25 import android.util.TypedValue;
  26 import android.view.LayoutInflater;
  27 import android.view.Menu;
  28 import android.view.MenuInflater;
  29 import android.view.MenuItem;
  30 import android.view.View;
  31 import android.view.ViewGroup;
  32 import android.view.inputmethod.InputMethodManager;
  33 import android.webkit.WebView;
  34 import android.widget.CursorAdapter;
  35 import android.widget.LinearLayout;
  36 import android.widget.TextView;
  37 import android.widget.Toast;
  38 
  39 import com.automattic.simplenote.analytics.AnalyticsTracker;
  40 import com.automattic.simplenote.models.Note;
  41 import com.automattic.simplenote.models.Tag;
  42 import com.automattic.simplenote.utils.AutoBullet;
  43 import com.automattic.simplenote.utils.DisplayUtils;
  44 import com.automattic.simplenote.utils.DrawableUtils;
  45 import com.automattic.simplenote.utils.MatchOffsetHighlighter;
  46 import com.automattic.simplenote.utils.NoteUtils;
  47 import com.automattic.simplenote.utils.PrefUtils;
  48 import com.automattic.simplenote.utils.SimplenoteLinkify;
  49 import com.automattic.simplenote.utils.SnackbarUtils;
  50 import com.automattic.simplenote.utils.SpaceTokenizer;
  51 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  52 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  53 import com.automattic.simplenote.utils.TextHighlighter;
  54 import com.automattic.simplenote.widgets.SimplenoteEditText;
  55 import com.commonsware.cwac.anddown.AndDown;
  56 import com.simperium.client.Bucket;
  57 import com.simperium.client.BucketObjectMissingException;
  58 import com.simperium.client.Query;
  59 
  60 import java.util.Calendar;
  61 
  62 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;,
  63         TextWatcher, OnTagAddedListener, View.OnFocusChangeListener,
  64         SimplenoteEditText.OnSelectionChangedListener,
  65         ShareBottomSheetDialog.ShareSheetListener,
  66         HistoryBottomSheetDialog.HistorySheetListener,
  67         InfoBottomSheetDialog.InfoSheetListener {
  68 
  69     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  70     public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  71     static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;
  72     static public final String ARG_MARKDOWN_ENABLED = &quot;markdown_enabled&quot;;
  73     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  74     private static final int MAX_REVISIONS = 30;
  75     private static final int PUBLISH_TIMEOUT = 20000;
  76     private static final int HISTORY_TIMEOUT = 10000;
  77     public static final int THEME_LIGHT = 0;
  78     public static final int THEME_DARK = 1;
  79 
  80     private Note mNote;
  81     private Bucket&lt;Note&gt; mNotesBucket;
  82 
  83     private SimplenoteEditText mContentEditText;
  84     private TagsMultiAutoCompleteTextView mTagView;
  85 
  86     private Handler mAutoSaveHandler;
  87     private Handler mPublishTimeoutHandler;
  88     private Handler mHistoryTimeoutHandler;
  89 
  90     private LinearLayout mPlaceholderView;
  91     private CursorAdapter mAutocompleteAdapter;
  92 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93 private boolean mIsNewNote, mIsLoadingNote;</span>
  94 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95 private boolean mIsNewNote, mIsLoadingNote, mDidTapHistoryButton;</span>
  96 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  97 private boolean mIsNewNote, mIsLoadingNote, mDidTapHistoryButton, mIsMarkdownEnabled, mIsMarkdownEnabledGlobal;">  97 private boolean mIsNewNote, mIsLoadingNote, mDidTapHistoryButton, mIsMarkdownEnabled, mIsMarkdownEnabledGðŸ”µ</abbr></span>
  98 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  99 
 100     private ActionMode mActionMode;
 101     private MenuItem mViewLinkMenuItem;
 102     private String mLinkUrl;
 103     private String mLinkText;
 104     private MatchOffsetHighlighter mHighlighter;
 105     private Drawable mEmailIcon, mWebIcon, mMapIcon, mCallIcon;
 106     private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
 107     private String mMatchOffsets;
 108     private int mCurrentCursorPosition;
 109     private String mLastContentString;
 110 
 111     private HistoryBottomSheetDialog mHistoryBottomSheet;
 112     private InfoBottomSheetDialog mInfoBottomSheet;
 113     private ShareBottomSheetDialog mShareBottomSheet;
 114 
 115     private Snackbar mPublishingSnackbar;
 116     private NoteMarkdownFragment mNoteMarkdownFragment;
 117     private String mCss;
 118     private WebView mMarkdown;
 119 
 120     /**
 121      * Mandatory empty constructor for the fragment manager to instantiate the
 122      * fragment (e.g. upon screen orientation changes).
 123      */
 124     public NoteEditorFragment() {
 125     }
 126 
 127     @Override
 128     public void onCreate(Bundle savedInstanceState) {
 129         super.onCreate(savedInstanceState);
 130 
 131         if (getActivity() != null) {
 132             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 133             mNotesBucket = currentApp.getNotesBucket();
 134         }
 135 
<abbr title=" 136         mCallIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_call_white_24dp, R.attr.actionModeTextColor);"> 136         mCallIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_call_white_24dp,ðŸ”µ</abbr>
<abbr title=" 137         mEmailIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_email_white_24dp, R.attr.actionModeTextColor);"> 137         mEmailIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_email_white_24dðŸ”µ</abbr>
<abbr title=" 138         mMapIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_map_white_24dp, R.attr.actionModeTextColor);"> 138         mMapIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_map_white_24dp, RðŸ”µ</abbr>
<abbr title=" 139         mWebIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_web_white_24dp, R.attr.actionModeTextColor);"> 139         mWebIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_web_white_24dp, RðŸ”µ</abbr>
 140 
 141         mAutoSaveHandler = new Handler();
 142         mPublishTimeoutHandler = new Handler();
 143         mHistoryTimeoutHandler = new Handler();
 144 
 145         mLastContentString = &quot;&quot;;
 146 
 147         mMatchHighlighter = new TextHighlighter(getActivity(),
<abbr title=" 148                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);"> 148                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor)ðŸ”µ</abbr>
 149         mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0) {
 150             @Override
 151             public View newView(Context context, Cursor cursor, ViewGroup parent) {
 152                 Activity activity = (Activity) context;
 153                 if (activity == null) return null;
 154                 return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 155             }
 156 
 157             @Override
 158             public void bindView(View view, Context context, Cursor cursor) {
 159                 TextView textView = (TextView) view;
 160                 textView.setText(convertToString(cursor));
 161             }
 162 
 163             @Override
 164             public CharSequence convertToString(Cursor cursor){
 165                 return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 166             }
 167 
 168             @Override
 169             public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 170                 Activity activity = getActivity();
 171                 if (activity == null) return null;
 172                 Simplenote application = (Simplenote) activity.getApplication();
 173                 Query&lt;Tag&gt; query = application.getTagsBucket().query();
 174                 // make the tag name available to the cursor
 175                 query.include(Tag.NAME_PROPERTY);
 176                 // sort the tags by their names
 177                 query.order(Tag.NAME_PROPERTY);
 178                 // if there&#x27;s a filter string find only matching tag names
<abbr title=" 179                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 179                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.forðŸ”µ</abbr>
 180                 return query.execute();
 181             }
 182         };
 183     }
 184 
 185     @Override
 186     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 187         setHasOptionsMenu(true);
 188         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 189         mContentEditText = ((SimplenoteEditText) rootView.findViewById(R.id.note_content));
 190         mContentEditText.addOnSelectionChangedListener(this);
 191         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 192         mTagView.setTokenizer(new SpaceTokenizer());
 193         mTagView.setOnFocusChangeListener(this);
 194 
 195         mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 196 
 197         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
 198         if (DisplayUtils.isLargeScreenLandscape(getActivity()) &amp;&amp; mNote == null) {
 199             mPlaceholderView.setVisibility(View.VISIBLE);
 200 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201             getActivity().invalidateOptionsMenu();</span>
 202 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203             public void onClick(View v) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204                 if (mPinButton.isChecked()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205                     // Friendly message to the user as to what this button does.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206                     Toast.makeText(getActivity(), R.string.note_pinned, Toast.LENGTH_SHORT).show();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212         if (DisplayUtils.isLargeScreenLandscape(getActivity()) &amp;&amp; mNote == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213             mPlaceholderView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216         mTagView.setAdapter(mAutocompleteAdapter);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218         // Load note if we were passed a note Id</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219         Bundle arguments = getArguments();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221             String key = arguments.getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222             if (arguments.containsKey(ARG_MATCH_OFFSETS)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);</span>
 224 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225             mMarkdown = (WebView) rootView.findViewById(R.id.markdown);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227             switch (PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_THEME, THEME_LIGHT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228                 case THEME_DARK:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229                     mCss = &quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;dark.css\&quot; /&gt;&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230                     break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231                 case THEME_LIGHT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232                     mCss = &quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;light.css\&quot; /&gt;&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233                     break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234             }</span>
 235 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 236         }
 237 
 238         mTagView.setAdapter(mAutocompleteAdapter);
 239 
 240         // Load note if we were passed a note Id
 241         Bundle arguments = getArguments();
 242         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
 243             String key = arguments.getString(ARG_ITEM_ID);
 244             if (arguments.containsKey(ARG_MATCH_OFFSETS)) {
 245                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);
 246             }
 247             new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
 248             setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));
 249         }
 250 
 251 		return rootView;
 252 	}
 253 
 254     @Override
 255     public void onResume() {
 256         super.onResume();
 257         mNotesBucket.start();
 258         mNotesBucket.addListener(this);
 259 
 260         mTagView.setOnTagAddedListener(this);
 261 
 262         if (mContentEditText != null) {
<abbr title=" 263             mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_FONT_SIZE, 14));"> 263             mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), ðŸ”µ</abbr>
 264         }
 265     }
 266 
 267     @Override
 268     public void onPause() {
 269         mNotesBucket.removeListener(this);
 270         // Hide soft keyboard if it is showing...
 271         if (getActivity() != null) {
<abbr title=" 272             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 272             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(CðŸ”µ</abbr>
 273             if (inputMethodManager != null) {
 274                 inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 275             }
 276         }
 277 
 278         // Delete the note if it is new and has empty fields
 279         if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty()) {
 280             mNote.delete();
 281         } else {
 282             saveNote();
 283         }
 284 
 285         mTagView.setOnTagAddedListener(null);
 286 
 287         if (mAutoSaveHandler != null) {
 288             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 289         }
 290 
 291         if (mPublishTimeoutHandler != null) {
 292             mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 293         }
 294 
 295         if (mHistoryTimeoutHandler != null) {
 296             mHistoryTimeoutHandler.removeCallbacks(mHistoryTimeoutRunnable);
 297         }
 298 
 299         mHighlighter.stop();
 300 
 301         super.onPause();
 302     }
 303 
 304     @Override
 305     public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
<abbr title=" 306         if (!isAdded() || DisplayUtils.isLargeScreenLandscape(getActivity()) &amp;&amp; mNoteMarkdownFragment == null) {"> 306         if (!isAdded() || DisplayUtils.isLargeScreenLandscape(getActivity()) &amp;&amp; mNoteMarkdownFragment == ðŸ”µ</abbr>
 307             return;
 308         }
 309 
 310         inflater.inflate(R.menu.note_editor, menu);
 311 
 312         if (mNote != null) {
 313             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_view_info);
 314             viewPublishedNoteItem.setVisible(true);
 315 
 316             if (mIsMarkdownEnabledGlobal) {
 317                 MenuItem markdownEnableItem = menu.findItem(R.id.menu_markdown_enable);
 318                 markdownEnableItem.setChecked(mNote.isMarkdownEnabled());
 319                 markdownEnableItem.setVisible(true);
 320             }
 321 
 322             MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 323             if (mNote.isDeleted())
 324                 trashItem.setTitle(R.string.undelete);
 325             else
 326                 trashItem.setTitle(R.string.delete);
 327         }
 328 
 329         DrawableUtils.tintMenuWithAttribute(getActivity(), menu, R.attr.actionBarTextColor);
 330 
 331         super.onCreateOptionsMenu(menu, inflater);
 332     }
 333 
 334     @Override
 335     public boolean onOptionsItemSelected(MenuItem item) {
 336         switch (item.getItemId()) {
 337             case R.id.menu_view_info:
 338                 showInfo();
 339                 return true;
 340 
 341             case R.id.menu_history:
 342                 showHistory();
 343                 return true;
 344             case R.id.menu_share:
 345                 shareNote();
 346                 return true;
 347             case R.id.menu_markdown_enable:
 348                 mIsMarkdownEnabled = !item.isChecked();
 349                 item.setChecked(mIsMarkdownEnabled);
 350 
 351                 if (mIsMarkdownEnabled) {
 352                     ((NoteEditorActivity) getActivity()).showTabs();
 353 
 354                     if (mNoteMarkdownFragment == null) {
 355                         // Get markdown fragment and update content
 356                         mNoteMarkdownFragment =
 357                                 ((NoteEditorActivity) getActivity()).getNoteMarkdownFragment();
 358                         mNoteMarkdownFragment.updateMarkdown(getNoteContentString());
 359                     }
 360                 } else {
 361                     ((NoteEditorActivity) getActivity()).hideTabs();
 362                 }
 363 
 364                 return true;
 365             case R.id.menu_delete:
 366                 if (!isAdded()) return false;
 367 
 368                 deleteNote();
 369                 return true;
 370             case android.R.id.home:
 371                 if (!isAdded()) return false;
 372 
 373                 getActivity().finish();
 374                 return true;
 375             default:
 376                 return super.onOptionsItemSelected(item);
 377         }
 378     }
 379 
 380     private void deleteNote() {
 381         if (mNote != null) {
 382             mNote.setDeleted(!mNote.isDeleted());
 383             mNote.setModificationDate(Calendar.getInstance());
 384             mNote.save();
 385             Intent resultIntent = new Intent();
 386             if (mNote.isDeleted()) {
 387                 resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());
 388             }
 389             getActivity().setResult(Activity.RESULT_OK, resultIntent);
 390 
 391             AnalyticsTracker.track(
 392                     AnalyticsTracker.Stat.EDITOR_NOTE_DELETED,
 393                     AnalyticsTracker.CATEGORY_NOTE,
 394                     &quot;trash_menu_item&quot;
 395             );
 396         }
 397 
 398         getActivity().finish();
 399     }
 400 
 401     private void shareNote() {
 402         if (mNote != null) {
 403             mContentEditText.clearFocus();
 404             showShareSheet();
 405             AnalyticsTracker.track(
 406                     AnalyticsTracker.Stat.EDITOR_NOTE_CONTENT_SHARED,
 407                     AnalyticsTracker.CATEGORY_NOTE,
 408                     &quot;action_bar_share_button&quot;
 409             );
 410         }
 411     }
 412 
 413     private void showHistory() {
 414         if (mNote != null &amp;&amp; mNote.getVersion() &gt; 1) {
 415             mContentEditText.clearFocus();
 416             mHistoryTimeoutHandler.postDelayed(mHistoryTimeoutRunnable, HISTORY_TIMEOUT);
 417             showHistorySheet();
 418         }
 419         else {
 420             Toast.makeText(getActivity(), R.string.error_history, Toast.LENGTH_LONG).show();
 421         }
 422     }
 423 
 424     private void showInfo() {
 425         if (mNote != null) {
 426             mContentEditText.clearFocus();
 427             saveNote();
 428             showInfoSheet();
 429         }
 430     }
 431 
 432     protected void clearMarkdown() {
 433         mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss + &quot;&quot;, &quot;text/html&quot;, &quot;utf-8&quot;, null);
 434     }
 435 
 436     protected void hideMarkdown() {
 437         mMarkdown.setVisibility(View.INVISIBLE);
 438     }
 439 
 440     protected void showMarkdown() {
 441         mMarkdown.setVisibility(View.VISIBLE);
 442     }
 443 
 444     private boolean noteIsEmpty() {
 445         return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 446     }
 447 
 448     protected void setMarkdownEnabled(boolean enabled) {
 449         mIsMarkdownEnabled = enabled;
 450 
 451         if (mIsMarkdownEnabled) {
 452             mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss +
 453                     new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, null);
 454         }
 455     }
 456 
 457     public void setNote(String noteID){
 458         setNote(noteID, null);
 459     }
 460 
 461     public void setNote(String noteID, String matchOffsets) {
 462         if (mAutoSaveHandler != null)
 463             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 464 
 465         mPlaceholderView.setVisibility(View.GONE);
 466 
 467         if (matchOffsets != null) {
 468             mMatchOffsets = matchOffsets;
 469         } else {
 470             mMatchOffsets = null;
 471         }
 472 
 473         // If we have a note already (on a tablet in landscape), save the note.
 474         if (mNote != null) {
 475             if (mIsNewNote &amp;&amp; noteIsEmpty())
 476                 mNote.delete();
 477             else if (mNote != null)
 478                 saveNote();
 479         }
 480 
 481         new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 482     }
 483 
 484     private void updateNote(Note updatedNote) {
 485         // update note if network change arrived
 486         mNote = updatedNote;
 487         refreshContent(true);
 488     }
 489 
 490     private void refreshContent(boolean isNoteUpdate) {
 491         if (mNote != null) {
 492             // Restore the cursor position if possible.
 493 
<abbr title=" 494             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 494             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEdðŸ”µ</abbr>
 495 
 496             mContentEditText.setText(mNote.getContent());
 497 
 498             if (isNoteUpdate) {
 499                 // Save the note so any local changes get synced
 500                 mNote.save();
 501 
<abbr title=" 502                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) {"> 502                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) ðŸ”µ</abbr>
 503                     mContentEditText.setSelection(cursorPosition);
 504                 }
 505             }
 506 
 507             afterTextChanged(mContentEditText.getText());
 508 
 509             updateTagList();
 510         }
 511     }
 512 
 513     private void updateTagList() {
 514         Activity activity = getActivity();
 515         if (activity == null) return;
 516 
 517         // Populate this note&#x27;s tags in the tagView
 518         mTagView.setChips(mNote.getTagString());
 519     }
 520 
 521     private int newCursorLocation(String newText, String oldText, int cursorLocation) {
 522         // Ported from the iOS app :)
 523         // Cases:
 524         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 525         // 1. Text was added after the cursor ==&gt; no change
 526         // 2. Text was added before the cursor ==&gt; location advances
 527         // 3. Text was removed after the cursor ==&gt; no change
 528         // 4. Text was removed before the cursor ==&gt; location retreats
 529         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 530 
 531         int newCursorLocation = cursorLocation;
 532 
 533         int deltaLength = newText.length() - oldText.length();
 534 
 535         // Case 0
 536         if (newText.length() &lt; cursorLocation)
 537             return newText.length();
 538 
 539         boolean beforeCursorMatches = false;
 540         boolean afterCursorMatches = false;
 541 
 542         try {
<abbr title=" 543             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 543             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorðŸ”µ</abbr>
<abbr title=" 544             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 544             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substðŸ”µ</abbr>
 545         } catch (Exception e) {
 546             e.printStackTrace();
 547         }
 548 
 549         // Cases 2 and 4
 550         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 551             newCursorLocation += deltaLength;
 552 
 553         // Cases 1, 3 and 5 have no change
 554         return newCursorLocation;
 555     }
 556 
 557     private final Runnable mAutoSaveRunnable = new Runnable() {
 558         @Override
 559         public void run() {
 560             saveAndSyncNote();
 561         }
 562     };
 563 
 564     @Override
 565     public void onTagsChanged(String tagString) {
 566         if (mNote == null || !isAdded()) return;
 567 
 568         if (mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length()) {
 569             AnalyticsTracker.track(
 570                     AnalyticsTracker.Stat.EDITOR_TAG_ADDED,
 571                     AnalyticsTracker.CATEGORY_NOTE,
 572                     &quot;tag_added_to_note&quot;
 573             );
 574         }
 575         else {
 576             AnalyticsTracker.track(
 577                     AnalyticsTracker.Stat.EDITOR_TAG_REMOVED,
 578                     AnalyticsTracker.CATEGORY_NOTE,
 579                     &quot;tag_removed_from_note&quot;
 580             );
 581         }
 582 
 583         mNote.setTagString(tagString);
 584         mNote.setModificationDate(Calendar.getInstance());
 585         updateTagList();
 586         mNote.save();
 587     }
 588 
 589     @Override
 590     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 591         // Unused
 592     }
 593 
 594     @Override
 595     public void afterTextChanged(Editable editable) {
 596         // check that the content has really changed (line spacing fix)
 597         if (!mLastContentString.equals(editable.toString())) {
 598             mLastContentString = editable.toString();
 599         setTitleSpan(editable);
 600         attemptAutoList(editable);
 601     }
 602     }
 603 
 604     @Override
 605     public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 606 
 607         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 608         if (mAutoSaveHandler != null) {
 609             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 610             mAutoSaveHandler.postDelayed(mAutoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 611         }
 612 
 613         // Remove search highlight spans when note content changes
 614         if (mMatchOffsets != null) {
 615             mMatchOffsets = null;
 616             mHighlighter.removeMatches();
 617         }
 618     }
 619 
 620     private void setTitleSpan(Editable editable) {
 621         // Set the note title to be a larger size
 622         // Remove any existing size spans
 623         RelativeSizeSpan spans[] = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 624         for (RelativeSizeSpan span : spans) {
 625             editable.removeSpan(span);
 626         }
 627         int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 628         if (newLinePosition == 0)
 629             return;
<abbr title=" 630         editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 630         editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editaðŸ”µ</abbr>
 631 
 632         fixLineSpacing();
 633     }
 634 
 635     // Fix for a line spacing bug
 636     // https://code.google.com/p/android/issues/detail?id=78706
 637     private void fixLineSpacing() {
 638         mContentEditText.setLineSpacing(8, 1);
 639         int startSelection = mContentEditText.getSelectionStart();
 640         mContentEditText.setText(mContentEditText.getText());
 641         mContentEditText.setSelection(startSelection);
 642     }
 643 
 644     private void attemptAutoList(Editable editable) {
 645         int oldCursorPosition = mCurrentCursorPosition;
 646         mCurrentCursorPosition = mContentEditText.getSelectionStart();
 647         AutoBullet.apply(editable, oldCursorPosition, mCurrentCursorPosition);
 648         mCurrentCursorPosition = mContentEditText.getSelectionStart();
 649     }
 650 
 651     private void saveAndSyncNote() {
 652         if (mNote == null) {
 653             return;
 654         }
 655 
 656         new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 657     }
 658 
 659     public void setPlaceholderVisible(boolean isVisible) {
 660         if (isVisible) {
 661             mNote = null;
 662             mContentEditText.setText(&quot;&quot;);
 663             mTagView.setText(&quot;&quot;);
 664             if (mPlaceholderView != null)
 665                 mPlaceholderView.setVisibility(View.VISIBLE);
 666         } else {
 667             if (mPlaceholderView != null)
 668                 mPlaceholderView.setVisibility(View.GONE);
 669         }
 670     }
 671 
 672     public void setIsNewNote(boolean isNewNote) {
 673         this.mIsNewNote = isNewNote;
 674     }
 675 
 676     @Override
 677     public void onFocusChange(View v, boolean hasFocus) {
 678         if (!hasFocus) {
 679             String tagString = getNoteTagsString().trim();
 680             if (tagString.length() &gt; 0) {
 681                 mTagView.setChips(tagString);
 682             }
 683         }
 684     }
 685 
 686     private Note getNote() {
 687         return mNote;
 688     }
 689 
 690     private String getNoteContentString() {
 691         if (mContentEditText == null || mContentEditText.getText() == null) {
 692             return &quot;&quot;;
 693         } else {
 694             return mContentEditText.getText().toString();
 695         }
 696     }
 697 
 698     private String getNoteTagsString() {
 699         if (mTagView == null || mTagView.getText() == null) {
 700             return &quot;&quot;;
 701         } else {
 702             return mTagView.getText().toString();
 703         }
 704     }
 705 
 706     /**
 707      *  Share bottom sheet callbacks
 708      */
 709 
 710     @Override
 711     public void onSharePublishClicked() {
 712         publishNote();
 713         mShareBottomSheet.dismiss();
 714     }
 715 
 716     @Override
 717     public void onShareUnpublishClicked() {
 718         unpublishNote();
 719         mShareBottomSheet.dismiss();
 720     }
 721 
 722     @Override
 723     public void onShareCollaborateClicked() {
 724         Toast.makeText(getActivity(), R.string.collaborate_message, Toast.LENGTH_LONG).show();
 725     }
 726 
 727     @Override
 728     public void onShareDismissed() {
 729 
 730     }
 731 
 732     /**
 733      *  History bottom sheet listeners
 734      */
 735 
 736     @Override
 737     public void onHistoryCancelClicked() {
 738         mContentEditText.setText(mNote.getContent());
 739         mHistoryBottomSheet.dismiss();
 740     }
 741 
 742     @Override
 743     public void onHistoryRestoreClicked() {
 744         mHistoryBottomSheet.dismiss();
 745         saveAndSyncNote();
 746     }
 747 
 748     @Override
 749     public void onHistoryDismissed() {
 750         if (!mHistoryBottomSheet.didTapOnButton()) {
 751             mContentEditText.setText(mNote.getContent());
 752         }
 753 
 754         if (mHistoryTimeoutHandler != null) {
 755             mHistoryTimeoutHandler.removeCallbacks(mHistoryTimeoutRunnable);
 756         }
 757     }
 758 
 759     @Override
 760     public void onHistoryUpdateNote(String content) {
 761         mContentEditText.setText(content);
 762     }
 763 
 764     /**
 765      *  Info bottom sheet listeners
 766      */
 767 
 768     @Override
 769     public void onInfoPinSwitchChanged(boolean isSwitchedOn) {
 770         NoteUtils.setNotePin(mNote, isSwitchedOn);
 771     }
 772 
 773     @Override
 774     public void onInfoMarkdownSwitchChanged(boolean isSwitchedOn) {
 775 
 776     }
 777 
 778     @Override
 779     public void onInfoCopyLinkClicked() {
 780         copyToClipboard(mNote.getPublishedUrl());
 781         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();
 782     }
 783 
 784     @Override
 785     public void onInfoShareLinkClicked() {
 786         mInfoBottomSheet.dismiss();
 787         showShareSheet();
 788     }
 789 
 790     @Override
 791     public void onInfoDismissed() {
 792 
 793     }
 794 
 795     private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 796 
 797         @Override
 798         protected void onPreExecute() {
 799             mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 800             mIsLoadingNote = true;
 801         }
 802 
 803         @Override
 804         protected Void doInBackground(String... args) {
 805             if (getActivity() == null) {
 806                 return null;
 807             }
 808 
 809             String noteID = args[0];
 810             Simplenote application = (Simplenote) getActivity().getApplication();
 811             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 812             try {
 813                 mNote = notesBucket.get(noteID);
 814                 // Set the current note in NotesActivity when on a tablet
 815                 if (getActivity() instanceof NotesActivity) {
 816                     ((NotesActivity) getActivity()).setCurrentNote(mNote);
 817                 }
 818 
 819                 // Set markdown flag for global setting
<abbr title=" 820                 mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_MARKDOWN_ENABLED, false);"> 820                 mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_MARKDOWN_EðŸ”µ</abbr>
 821 
 822                 // Set markdown flag for current note
 823                 if (mNote != null) {
 824                     mIsMarkdownEnabled = mNote.isMarkdownEnabled();
 825                 }
 826             } catch (BucketObjectMissingException e) {
 827                 // TODO: Handle a missing note
 828             }
 829             return null;
 830         }
 831 
 832         @Override
 833         protected void onPostExecute(Void nada) {
 834             if (getActivity() == null || getActivity().isFinishing())
 835                 return;
 836             refreshContent(false);
 837             if (mMatchOffsets != null) {
<abbr title=" 838                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);"> 838                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.COðŸ”µ</abbr>
 839                 mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
 840             }
 841             mContentEditText.addTextChangedListener(NoteEditorFragment.this);
 842             if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 843                 // Show soft keyboard
 844                 mContentEditText.requestFocus();
 845                 new Handler().postDelayed(new Runnable() {
 846                     @Override
 847                     public void run() {
<abbr title=" 848                         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 848                         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSysðŸ”µ</abbr>
 849                         if (inputMethodManager != null)
 850                             inputMethodManager.showSoftInput(mContentEditText, 0);
 851                     }
 852                 }, 100);
 853 
 854             }
 855 
 856             // Show tabs if markdown is enabled globally, for current note, and not tablet landscape
 857             if (mIsMarkdownEnabledGlobal &amp;&amp; mIsMarkdownEnabled) {
 858                 // Get markdown view and update content
 859                 if (DisplayUtils.isLargeScreenLandscape(getActivity())) {
 860                     mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss +
<abbr title=" 861                             new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, null);"> 861                             new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, nðŸ”µ</abbr>
 862                 } else {
 863                     mNoteMarkdownFragment =
 864                             ((NoteEditorActivity) getActivity()).getNoteMarkdownFragment();
 865                     mNoteMarkdownFragment.updateMarkdown(getNoteContentString());
 866                 }
 867             }
 868 
 869             getActivity().invalidateOptionsMenu();
 870 
 871             SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 872 
 873             mIsLoadingNote = false;
 874         }
 875     }
 876 
 877     private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
 878 
 879         @Override
 880         protected Void doInBackground(Void... args) {
 881             saveNote();
 882             return null;
 883         }
 884 
 885         @Override
 886         protected void onPostExecute(Void nada) {
 887             if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {
 888                 // Update links
 889                 SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 890 
 891                 // Update markdown fragment
 892                 if (DisplayUtils.isLargeScreenLandscape(getActivity())) {
 893                     mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss +
<abbr title=" 894                             new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, null);"> 894                             new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, nðŸ”µ</abbr>
 895                 } else {
 896                     mNoteMarkdownFragment.updateMarkdown(getNoteContentString());
 897                 }
 898             }
 899         }
 900     }
 901 
 902 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 903 private void saveNote() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 904         if (mNote == null || (mHistoryBottomSheet != null &amp;&amp; mHistoryBottomSheet.isShowing())) {</span>
 905 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 906 private void saveNote() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 907         if (mNote == null || (mBottomSheet != null &amp;&amp; mBottomSheet.isShowing())) {</span>
 908 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 909 protected void saveNote() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 910         if (mNote == null || (mBottomSheet != null &amp;&amp; mBottomSheet.isShowing())) {</span>
 911 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 912             return;
 913         }
 914 
 915         String content = getNoteContentString();
 916         String tagString = getNoteTagsString();
 917 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 918         if (mNote.hasChanges(content, tagString.trim(), mNote.isPinned())) {</span>
 919 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 920         if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {</span>
 921 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 922         if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked(), mIsMarkdownEnabled)) {</span>
 923 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 924             mNote.setContent(content);
 925             mNote.setTagString(tagString);
 926             mNote.setModificationDate(Calendar.getInstance());
 927             mNote.setMarkdownEnabled(mIsMarkdownEnabled);
 928             // Send pinned event to google analytics if changed
 929             mNote.save();
 930 
 931                 AnalyticsTracker.track(
 932                         AnalyticsTracker.Stat.EDITOR_NOTE_EDITED,
 933                         AnalyticsTracker.CATEGORY_NOTE,
 934                         &quot;editor_save&quot;
 935                 );
 936             }
 937         }
 938 
 939     // Contextual action bar for dealing with links
 940     private final ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
 941 
 942         // Called when the action mode is created; startActionMode() was called
 943         @Override
 944         public boolean onCreateActionMode(ActionMode mode, Menu menu) {
 945             // Inflate a menu resource providing context menu items
 946             MenuInflater inflater = mode.getMenuInflater();
 947             if (inflater != null) {
 948                 inflater.inflate(R.menu.view_link, menu);
 949                 mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
 950                 mode.setTitle(getString(R.string.link));
 951                 if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
 952                     mode.setTitleOptionalHint(false);
 953                 }
 954 
 955                 DrawableUtils.tintMenuWithAttribute(getActivity(), menu, R.attr.actionModeTextColor);
 956             }
 957             return true;
 958         }
 959 
 960         // Called each time the action mode is shown. Always called after onCreateActionMode, but
 961         // may be called multiple times if the mode is invalidated.
 962         @Override
 963         public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 964             return false; // Return false if nothing is done
 965         }
 966 
 967         // Called when the user selects a contextual menu item
 968         @Override
 969         public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 970             switch (item.getItemId()) {
 971                 case R.id.menu_view_link:
 972                     if (mLinkUrl != null) {
 973                         try {
 974                             Uri uri = Uri.parse(mLinkUrl);
 975                             Intent i = new Intent(Intent.ACTION_VIEW);
 976                             i.setData(uri);
 977                             startActivity(i);
 978                         } catch (Exception e) {
 979                             e.printStackTrace();
 980                         }
 981                         mode.finish(); // Action picked, so close the CAB
 982                     }
 983                     return true;
 984                 case R.id.menu_copy:
 985                     if (mLinkText != null &amp;&amp; getActivity() != null) {
 986                         copyToClipboard(mLinkText);
<abbr title=" 987                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();"> 987                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORTðŸ”µ</abbr>
 988                         mode.finish();
 989                     }
 990                     return true;
 991                 case R.id.menu_share:
 992                     if (mLinkText != null) {
 993                         showShareSheet();
 994                         mode.finish();
 995                     }
 996                     return true;
 997                 default:
 998                     return false;
 999             }
1000         }
1001 
1002         // Called when the user exits the action mode
1003         @Override
1004         public void onDestroyActionMode(ActionMode mode) {
1005             mActionMode = null;
1006         }
1007     };
1008 
1009     // Checks if cursor is at a URL when the selection changes
1010     // If it is a URL, show the contextual action bar
1011     @Override
1012     public void onSelectionChanged(int selStart, int selEnd) {
1013         if (selStart == selEnd) {
1014             Editable noteContent = mContentEditText.getText();
1015             if (noteContent == null)
1016                 return;
1017 
1018             URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
1019             if (urlSpans.length &gt; 0) {
1020                 URLSpan urlSpan = urlSpans[0];
1021                 mLinkUrl = urlSpan.getURL();
<abbr title="1022                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();">1022                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpaðŸ”µ</abbr>
1023                 if (mActionMode != null) {
1024                     mActionMode.setSubtitle(mLinkText);
1025                     setLinkMenuItem();
1026                     return;
1027                 }
1028 
1029                 // Show the Contextual Action Bar
1030                 if (getActivity() != null) {
<abbr title="1031                     mActionMode = ((AppCompatActivity)getActivity()).startSupportActionMode(mActionModeCallback);">1031                     mActionMode = ((AppCompatActivity)getActivity()).startSupportActionMode(mActionModeCaðŸ”µ</abbr>
1032                     if (mActionMode != null) {
1033                         mActionMode.setSubtitle(mLinkText);
1034                     }
1035 
1036                     setLinkMenuItem();
1037                 }
1038             } else if (mActionMode != null) {
1039                 mActionMode.finish();
1040                 mActionMode = null;
1041             }
1042         } else if (mActionMode != null) {
1043             mActionMode.finish();
1044             mActionMode = null;
1045         }
1046     }
1047 
1048     private void setLinkMenuItem() {
1049         if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
1050             if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
1051                 mViewLinkMenuItem.setIcon(mCallIcon);
1052                 mViewLinkMenuItem.setTitle(getString(R.string.call));
1053             } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
1054                 mViewLinkMenuItem.setIcon(mEmailIcon);
1055                 mViewLinkMenuItem.setTitle(getString(R.string.email));
1056             } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
1057                 mViewLinkMenuItem.setIcon(mMapIcon);
1058                 mViewLinkMenuItem.setTitle(getString(R.string.view_map));
1059             } else {
1060                 mViewLinkMenuItem.setIcon(mWebIcon);
1061                 mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
1062             }
1063         }
1064     }
1065 
1066     // Resets note publish status if Simperium never returned the new publish status
1067     private final Runnable mPublishTimeoutRunnable = new Runnable() {
1068         @Override
1069         public void run() {
1070             if (!isAdded()) return;
1071 
1072             getActivity().runOnUiThread(new Runnable() {
1073                 @Override
1074                 public void run() {
1075 
1076                     mNote.setPublished(!mNote.isPublished());
1077                     mNote.save();
1078 
1079                     updatePublishedState(false);
1080 
1081                 }
1082             });
1083 
1084         }
1085     };
1086 
1087     // Hides the history bottom sheet if no revisions are loaded
1088     private final Runnable mHistoryTimeoutRunnable = new Runnable() {
1089         @Override
1090         public void run() {
1091             if (!isAdded()) return;
1092 
1093             getActivity().runOnUiThread(new Runnable() {
1094                 @Override
1095                 public void run() {
1096 
1097                     if (mHistoryBottomSheet.isShowing() &amp;&amp; !mHistoryBottomSheet.isHistoryLoaded()) {
1098                         mHistoryBottomSheet.dismiss();
1099                         Toast.makeText(getActivity(), R.string.error_history, Toast.LENGTH_LONG).show();
1100                     }
1101                 }
1102             });
1103 
1104         }
1105     };
1106 
1107     private void setPublishedNote(boolean isPublished) {
1108         if (mNote != null) {
1109             mNote.setPublished(isPublished);
1110             mNote.save();
1111 
1112             // reset publish status in 20 seconds if we don&#x27;t hear back from Simperium
1113             mPublishTimeoutHandler.postDelayed(mPublishTimeoutRunnable, PUBLISH_TIMEOUT);
1114 
1115             AnalyticsTracker.track(
1116                     (isPublished) ? AnalyticsTracker.Stat.EDITOR_NOTE_PUBLISHED :
1117                             AnalyticsTracker.Stat.EDITOR_NOTE_UNPUBLISHED,
1118                     AnalyticsTracker.CATEGORY_NOTE,
1119                     &quot;publish_note_button&quot;
1120             );
1121         }
1122     }
1123 
1124     private void updatePublishedState(boolean isSuccess) {
1125 
1126         if (mPublishingSnackbar == null) {
1127             return;
1128         }
1129 
1130         mPublishingSnackbar.dismiss();
1131         mPublishingSnackbar = null;
1132 
1133         if (isSuccess &amp;&amp; isAdded()) {
1134             if (mNote.isPublished()) {
1135                 SnackbarUtils.showSnackbar(getActivity(), R.string.publish_successful,
1136                         R.color.simplenote_positive_green,
1137                         Snackbar.LENGTH_LONG, R.string.undo, new View.OnClickListener() {
1138                             @Override
1139                             public void onClick(View v) {
1140                                 unpublishNote();
1141                             }
1142                         });
1143                 copyToClipboard(mNote.getPublishedUrl());
1144             } else {
1145                 SnackbarUtils.showSnackbar(getActivity(), R.string.unpublish_successful,
1146                         R.color.simplenote_negative_red,
1147                         Snackbar.LENGTH_LONG, R.string.undo, new View.OnClickListener() {
1148                             @Override
1149                             public void onClick(View v) {
1150                                 publishNote();
1151                             }
1152                         });
1153             }
1154         } else {
1155             if (mNote.isPublished()) {
1156                 SnackbarUtils.showSnackbar(getActivity(), R.string.unpublish_error,
1157                         R.color.simplenote_negative_red, Snackbar.LENGTH_LONG);
1158             } else {
1159                 SnackbarUtils.showSnackbar(getActivity(), R.string.publish_error,
1160                         R.color.simplenote_negative_red, Snackbar.LENGTH_LONG);
1161             }
1162         }
1163     }
1164 
1165     private void publishNote() {
1166 
1167         if (isAdded()) {
1168             mPublishingSnackbar = SnackbarUtils.showSnackbar(getActivity(), R.string.publishing,
1169                     R.color.simplenote_blue, Snackbar.LENGTH_INDEFINITE);
1170         }
1171         setPublishedNote(true);
1172     }
1173 
1174     private void unpublishNote() {
1175 
1176         if (isAdded()) {
1177             mPublishingSnackbar = SnackbarUtils.showSnackbar(getActivity(), R.string.unpublishing,
1178                     R.color.simplenote_blue, Snackbar.LENGTH_INDEFINITE);
1179         }
1180         setPublishedNote(false);
1181     }
1182 
1183     private void copyToClipboard(String text) {
<abbr title="1184         ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);">1184         ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_ðŸ”µ</abbr>
1185         ClipData clip = ClipData.newPlainText(getString(R.string.app_name), text);
1186         clipboard.setPrimaryClip(clip);
1187     }
1188 
1189     private void showShareSheet() {
1190         if (isAdded()) {
1191             if (mShareBottomSheet == null) {
1192                 mShareBottomSheet = new ShareBottomSheetDialog(this, this);
1193             }
1194             mShareBottomSheet.show(mNote);
1195         }
1196     }
1197 
1198     private void showInfoSheet() {
1199         if (isAdded()) {
1200             if (mInfoBottomSheet == null) {
1201                 mInfoBottomSheet = new InfoBottomSheetDialog(this, this);
1202             }
1203             mInfoBottomSheet.show(mNote);
1204         }
1205 
1206     }
1207 
1208     private void showHistorySheet() {
1209         if (isAdded()) {
1210             if (mHistoryBottomSheet == null) {
1211                 mHistoryBottomSheet = new HistoryBottomSheetDialog(this, this);
1212                 }
1213 
1214             // Request revisions for the current note
<abbr title="1215             mNotesBucket.getRevisions(mNote, MAX_REVISIONS, mHistoryBottomSheet.getRevisionsRequestCallbacks());">1215             mNotesBucket.getRevisions(mNote, MAX_REVISIONS, mHistoryBottomSheet.getRevisionsRequestCallbaðŸ”µ</abbr>
1216             saveNote();
1217 
1218             mHistoryBottomSheet.show(mNote);
1219             }
1220     }
1221 
1222     /**
1223      * Simperium listeners
1224      */
1225 
1226     @Override
1227     public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
1228 
1229     }
1230 
1231     @Override
<abbr title="1232     public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {">1232     public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) ðŸ”µ</abbr>
1233         if (changeType == Bucket.ChangeType.MODIFY) {
1234             if (getNote() != null &amp;&amp; getNote().getSimperiumKey().equals(key)) {
1235                 try {
1236                     final Note updatedNote = mNotesBucket.get(key);
1237                     if (getActivity() != null) {
1238                         getActivity().runOnUiThread(new Runnable() {
1239                             @Override
1240                             public void run() {
1241                                 if (mPublishTimeoutHandler != null) {
1242                                     mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
1243                                 }
1244 
1245                                 updateNote(updatedNote);
1246                                 updatePublishedState(true);
1247                             }
1248                         });
1249                     }
1250                 } catch (BucketObjectMissingException e) {
1251                     e.printStackTrace();
1252                 }
1253             }
1254         }
1255     }
1256 
1257 
1258     @Override
1259     public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
1260         // noop
1261     }
1262 
1263     @Override
1264     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1265         // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
1266         if (mIsLoadingNote)
1267             return;
1268 
1269         Note openNote = getNote();
1270         if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
1271             return;
1272 
1273         note.setContent(getNoteContentString());
1274     }
1275 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.content.ClipData;
   5 import android.content.ClipboardManager;
   6 import android.content.Context;
   7 import android.content.Intent;
   8 import android.database.Cursor;
   9 import android.graphics.drawable.Drawable;
  10 import android.net.Uri;
  11 import android.os.AsyncTask;
  12 import android.os.Build;
  13 import android.os.Bundle;
  14 import android.os.Handler;
  15 import android.support.design.widget.Snackbar;
  16 import android.support.v4.app.Fragment;
  17 import android.support.v7.app.AppCompatActivity;
  18 import android.support.v7.view.ActionMode;
  19 import android.text.Editable;
  20 import android.text.Spanned;
  21 import android.text.TextWatcher;
  22 import android.text.style.RelativeSizeSpan;
  23 import android.text.style.URLSpan;
  24 import android.text.util.Linkify;
  25 import android.util.TypedValue;
  26 import android.view.LayoutInflater;
  27 import android.view.Menu;
  28 import android.view.MenuInflater;
  29 import android.view.MenuItem;
  30 import android.view.View;
  31 import android.view.ViewGroup;
  32 import android.view.inputmethod.InputMethodManager;
  33 import android.webkit.WebView;
  34 import android.widget.CursorAdapter;
  35 import android.widget.LinearLayout;
  36 import android.widget.TextView;
  37 import android.widget.Toast;
  38 import com.automattic.simplenote.analytics.AnalyticsTracker;
  39 import com.automattic.simplenote.models.Note;
  40 import com.automattic.simplenote.models.Tag;
  41 import com.automattic.simplenote.utils.AutoBullet;
  42 import com.automattic.simplenote.utils.DisplayUtils;
  43 import com.automattic.simplenote.utils.DrawableUtils;
  44 import com.automattic.simplenote.utils.MatchOffsetHighlighter;
  45 import com.automattic.simplenote.utils.NoteUtils;
  46 import com.automattic.simplenote.utils.PrefUtils;
  47 import com.automattic.simplenote.utils.SimplenoteLinkify;
  48 import com.automattic.simplenote.utils.SnackbarUtils;
  49 import com.automattic.simplenote.utils.SpaceTokenizer;
  50 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  51 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  52 import com.automattic.simplenote.utils.TextHighlighter;
  53 import com.automattic.simplenote.widgets.SimplenoteEditText;
  54 import com.commonsware.cwac.anddown.AndDown;
  55 import com.simperium.client.Bucket;
  56 import com.simperium.client.BucketObjectMissingException;
  57 import com.simperium.client.Query;
  58 import java.util.Calendar;
  59 
  60 
  61 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;,
  62         TextWatcher, OnTagAddedListener, View.OnFocusChangeListener,
  63         SimplenoteEditText.OnSelectionChangedListener,
  64         ShareBottomSheetDialog.ShareSheetListener,
  65         HistoryBottomSheetDialog.HistorySheetListener,
  66         InfoBottomSheetDialog.InfoSheetListener {
  67 
  68     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  69     public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  70     static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;
  71     static public final String ARG_MARKDOWN_ENABLED = &quot;markdown_enabled&quot;;
  72     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  73     private static final int MAX_REVISIONS = 30;
  74 
  75 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76     private static final int PUBLISH_TIMEOUT = 20000;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77     private static final int HISTORY_TIMEOUT = 10000;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78 </span>
  79 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  80 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  80 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
  81 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83     public static final int THEME_LIGHT = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84     public static final int THEME_DARK = 1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85 </span>
  86 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
  87 
  88     private Note mNote;
  89     private Bucket&lt;Note&gt; mNotesBucket;
  90 
  91     private SimplenoteEditText mContentEditText;
  92     private TagsMultiAutoCompleteTextView mTagView;
  93 
  94     private Handler mAutoSaveHandler;
  95     private Handler mPublishTimeoutHandler;
  96     private Handler mHistoryTimeoutHandler;
  97 
  98     private LinearLayout mPlaceholderView;
  99     private CursorAdapter mAutocompleteAdapter;
 100 
 101 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102     private boolean mIsNewNote, mIsLoadingNote;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103 </span>
 104 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 105 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 105 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 106 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 108     private boolean mIsNewNote, mIsLoadingNote, mDidTapHistoryButton, mIsMarkdownEnabled, mIsMarkdownEnabledGlobal;"> 108     private boolean mIsNewNote, mIsLoadingNote, mDidTapHistoryButton, mIsMarkdownEnabled, mIsMarkdownEnabðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109 </span>
 110 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 111     private ActionMode mActionMode;
 112     private MenuItem mViewLinkMenuItem;
 113     private String mLinkUrl;
 114     private String mLinkText;
 115     private MatchOffsetHighlighter mHighlighter;
 116     private Drawable mEmailIcon, mWebIcon, mMapIcon, mCallIcon;
 117     private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
 118     private String mMatchOffsets;
 119     private int mCurrentCursorPosition;
 120 
 121 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122     private String mLastContentString;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124     private HistoryBottomSheetDialog mHistoryBottomSheet;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125     private InfoBottomSheetDialog mInfoBottomSheet;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126     private ShareBottomSheetDialog mShareBottomSheet;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128     private Snackbar mPublishingSnackbar;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129 </span>
 130 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 131 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 131 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 132 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134     private ArrayList&lt;Note&gt; mNoteRevisionsList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135     private NoteMarkdownFragment mNoteMarkdownFragment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136     private String mCss;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137     private WebView mMarkdown;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138 </span>
 139 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 140 
 141     /**
 142      * Mandatory empty constructor for the fragment manager to instantiate the
 143      * fragment (e.g. upon screen orientation changes).
 144      */
 145     public NoteEditorFragment() {
 146     }
 147 
 148     @Override
 149     public void onCreate(Bundle savedInstanceState) {
 150         super.onCreate(savedInstanceState);
 151 
 152         if (getActivity() != null) {
 153             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 154             mNotesBucket = currentApp.getNotesBucket();
 155         }
 156 
<abbr title=" 157         mCallIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_call_white_24dp, R.attr.actionModeTextColor);"> 157         mCallIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_call_white_24dp,ðŸ”µ</abbr>
<abbr title=" 158         mEmailIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_email_white_24dp, R.attr.actionModeTextColor);"> 158         mEmailIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_email_white_24dðŸ”µ</abbr>
<abbr title=" 159         mMapIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_map_white_24dp, R.attr.actionModeTextColor);"> 159         mMapIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_map_white_24dp, RðŸ”µ</abbr>
<abbr title=" 160         mWebIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_web_white_24dp, R.attr.actionModeTextColor);"> 160         mWebIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_web_white_24dp, RðŸ”µ</abbr>
 161 
 162         mAutoSaveHandler = new Handler();
 163         mPublishTimeoutHandler = new Handler();
 164         mHistoryTimeoutHandler = new Handler();
 165 
 166         mLastContentString = &quot;&quot;;
 167 
 168         mMatchHighlighter = new TextHighlighter(getActivity(),
<abbr title=" 169                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);"> 169                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor)ðŸ”µ</abbr>
 170         mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0) {
 171             @Override
 172             public View newView(Context context, Cursor cursor, ViewGroup parent) {
 173                 Activity activity = (Activity) context;
 174                 if (activity == null) return null;
 175                 return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 176             }
 177 
 178             @Override
 179             public void bindView(View view, Context context, Cursor cursor) {
 180                 TextView textView = (TextView) view;
 181                 textView.setText(convertToString(cursor));
 182             }
 183 
 184             @Override
 185             public CharSequence convertToString(Cursor cursor){
 186                 return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 187             }
 188 
 189             @Override
 190             public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 191                 Activity activity = getActivity();
 192                 if (activity == null) return null;
 193                 Simplenote application = (Simplenote) activity.getApplication();
 194                 Query&lt;Tag&gt; query = application.getTagsBucket().query();
 195                 // make the tag name available to the cursor
 196                 query.include(Tag.NAME_PROPERTY);
 197                 // sort the tags by their names
 198                 query.order(Tag.NAME_PROPERTY);
 199                 // if there&#x27;s a filter string find only matching tag names
<abbr title=" 200                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 200                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.forðŸ”µ</abbr>
 201                 return query.execute();
 202             }
 203         };
 204     }
 205 
 206     @Override
 207     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 208         setHasOptionsMenu(true);
 209         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 210         mContentEditText = ((SimplenoteEditText) rootView.findViewById(R.id.note_content));
 211         mContentEditText.addOnSelectionChangedListener(this);
 212         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 213         mTagView.setTokenizer(new SpaceTokenizer());
 214         mTagView.setOnFocusChangeListener(this);
 215 
 216         mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 217 
 218         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
 219         if (DisplayUtils.isLargeScreenLandscape(getActivity()) &amp;&amp; mNote == null) {
 220             mPlaceholderView.setVisibility(View.VISIBLE);
 221 
 222 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223             getActivity().invalidateOptionsMenu();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224 </span>
 225 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 226 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 226 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 227 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229             mMarkdown = (WebView) rootView.findViewById(R.id.markdown);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231             switch (PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_THEME, THEME_LIGHT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232                 case THEME_DARK:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233                     mCss = &quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;dark.css\&quot; /&gt;&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234                     break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235                 case THEME_LIGHT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236                     mCss = &quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;light.css\&quot; /&gt;&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237                     break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239 </span>
 240 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 241         }
 242 
 243         mTagView.setAdapter(mAutocompleteAdapter);
 244 
 245         // Load note if we were passed a note Id
 246         Bundle arguments = getArguments();
 247         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
 248             String key = arguments.getString(ARG_ITEM_ID);
 249             if (arguments.containsKey(ARG_MATCH_OFFSETS)) {
 250                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);
 251             }
 252             new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
 253             setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));
 254         }
 255 
 256 		return rootView;
 257 	}
 258 
 259     @Override
 260     public void onResume() {
 261         super.onResume();
 262         mNotesBucket.start();
 263         mNotesBucket.addListener(this);
 264 
 265         mTagView.setOnTagAddedListener(this);
 266 
 267         if (mContentEditText != null) {
<abbr title=" 268             mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_FONT_SIZE, 14));"> 268             mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), ðŸ”µ</abbr>
 269         }
 270     }
 271 
 272     @Override
 273     public void onPause() {
 274         mNotesBucket.removeListener(this);
 275         // Hide soft keyboard if it is showing...
 276         if (getActivity() != null) {
<abbr title=" 277             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 277             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(CðŸ”µ</abbr>
 278             if (inputMethodManager != null) {
 279                 inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 280             }
 281         }
 282 
 283         // Delete the note if it is new and has empty fields
 284         if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty()) {
 285             mNote.delete();
 286         } else {
 287             saveNote();
 288         }
 289 
 290         mTagView.setOnTagAddedListener(null);
 291 
 292         if (mAutoSaveHandler != null) {
 293             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 294         }
 295 
 296         if (mPublishTimeoutHandler != null) {
 297             mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 298         }
 299 
 300         if (mHistoryTimeoutHandler != null) {
 301             mHistoryTimeoutHandler.removeCallbacks(mHistoryTimeoutRunnable);
 302         }
 303 
 304         mHighlighter.stop();
 305 
 306         super.onPause();
 307     }
 308 
 309     @Override
 310     public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
<abbr title=" 311         if (!isAdded() || DisplayUtils.isLargeScreenLandscape(getActivity()) &amp;&amp; mNoteMarkdownFragment == null) {"> 311         if (!isAdded() || DisplayUtils.isLargeScreenLandscape(getActivity()) &amp;&amp; mNoteMarkdownFragment == ðŸ”µ</abbr>
 312             return;
 313         }
 314 
 315         inflater.inflate(R.menu.note_editor, menu);
 316 
 317         if (mNote != null) {
 318             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_view_info);
 319             viewPublishedNoteItem.setVisible(true);
 320 
 321             if (mIsMarkdownEnabledGlobal) {
 322                 MenuItem markdownEnableItem = menu.findItem(R.id.menu_markdown_enable);
 323                 markdownEnableItem.setChecked(mNote.isMarkdownEnabled());
 324                 markdownEnableItem.setVisible(true);
 325             }
 326 
 327             MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 328             if (mNote.isDeleted())
 329                 trashItem.setTitle(R.string.undelete);
 330             else
 331                 trashItem.setTitle(R.string.delete);
 332         }
 333 
 334         DrawableUtils.tintMenuWithAttribute(getActivity(), menu, R.attr.actionBarTextColor);
 335 
 336         super.onCreateOptionsMenu(menu, inflater);
 337     }
 338 
 339     @Override
 340     public boolean onOptionsItemSelected(MenuItem item) {
 341         switch (item.getItemId()) {
 342             case R.id.menu_view_info:
 343                 showInfo();
 344                 return true;
 345 
 346             case R.id.menu_history:
 347                 showHistory();
 348                 return true;
 349             case R.id.menu_share:
 350                 shareNote();
 351                 return true;
 352             case R.id.menu_markdown_enable:
 353                 mIsMarkdownEnabled = !item.isChecked();
 354                 item.setChecked(mIsMarkdownEnabled);
 355 
 356                 if (mIsMarkdownEnabled) {
 357                     ((NoteEditorActivity) getActivity()).showTabs();
 358 
 359                     if (mNoteMarkdownFragment == null) {
 360                         // Get markdown fragment and update content
 361                         mNoteMarkdownFragment =
 362                                 ((NoteEditorActivity) getActivity()).getNoteMarkdownFragment();
 363                         mNoteMarkdownFragment.updateMarkdown(getNoteContentString());
 364                     }
 365                 } else {
 366                     ((NoteEditorActivity) getActivity()).hideTabs();
 367                 }
 368 
 369                 return true;
 370             case R.id.menu_delete:
 371                 if (!isAdded()) return false;
 372 
 373                 deleteNote();
 374                 return true;
 375             case android.R.id.home:
 376                 if (!isAdded()) return false;
 377 
 378                 getActivity().finish();
 379                 return true;
 380             default:
 381                 return super.onOptionsItemSelected(item);
 382         }
 383     }
 384 
 385 
 386 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 387     private void deleteNote() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 388         if (mNote != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 389             mNote.setDeleted(!mNote.isDeleted());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 390             mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 391             mNote.save();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 392             Intent resultIntent = new Intent();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 393             if (mNote.isDeleted()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 394                 resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 395             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 396             getActivity().setResult(Activity.RESULT_OK, resultIntent);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 397 </span>
 398 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 399 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 399 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 400 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402     protected void clearMarkdown() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403         mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss + &quot;&quot;, &quot;text/html&quot;, &quot;utf-8&quot;, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406     protected void hideMarkdown() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407         mMarkdown.setVisibility(View.INVISIBLE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410     protected void showMarkdown() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411         mMarkdown.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414     // show a popup view from the info action bar item</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415     private void showInfoPopup(View view) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416         if (!isAdded() || view == null) return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417 </span>
 418 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 419 
 420             AnalyticsTracker.track(
 421                     AnalyticsTracker.Stat.EDITOR_NOTE_DELETED,
 422                     AnalyticsTracker.CATEGORY_NOTE,
 423                     &quot;trash_menu_item&quot;
 424             );
 425         }
 426 
 427         getActivity().finish();
 428     }
 429 
 430     private void shareNote() {
 431         if (mNote != null) {
 432             mContentEditText.clearFocus();
 433             showShareSheet();
 434             AnalyticsTracker.track(
 435                     AnalyticsTracker.Stat.EDITOR_NOTE_CONTENT_SHARED,
 436                     AnalyticsTracker.CATEGORY_NOTE,
 437                     &quot;action_bar_share_button&quot;
 438             );
 439         }
 440     }
 441 
 442     private void showHistory() {
 443         if (mNote != null &amp;&amp; mNote.getVersion() &gt; 1) {
 444             mContentEditText.clearFocus();
 445             mHistoryTimeoutHandler.postDelayed(mHistoryTimeoutRunnable, HISTORY_TIMEOUT);
 446             showHistorySheet();
 447         }
 448         else {
 449             Toast.makeText(getActivity(), R.string.error_history, Toast.LENGTH_LONG).show();
 450         }
 451     }
 452 
 453     private void showInfo() {
 454         if (mNote != null) {
 455             mContentEditText.clearFocus();
 456             saveNote();
 457             showInfoSheet();
 458         }
 459     }
 460 
 461     private boolean noteIsEmpty() {
 462         return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 463     }
 464 
 465     protected void setMarkdownEnabled(boolean enabled) {
 466         mIsMarkdownEnabled = enabled;
 467 
 468         if (mIsMarkdownEnabled) {
 469             mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss +
 470                     new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, null);
 471         }
 472     }
 473 
 474     public void setNote(String noteID){
 475         setNote(noteID, null);
 476     }
 477 
 478     public void setNote(String noteID, String matchOffsets) {
 479         if (mAutoSaveHandler != null)
 480             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 481 
 482         mPlaceholderView.setVisibility(View.GONE);
 483 
 484         if (matchOffsets != null) {
 485             mMatchOffsets = matchOffsets;
 486         } else {
 487             mMatchOffsets = null;
 488         }
 489 
 490         // If we have a note already (on a tablet in landscape), save the note.
 491         if (mNote != null) {
 492             if (mIsNewNote &amp;&amp; noteIsEmpty())
 493                 mNote.delete();
 494             else if (mNote != null)
 495                 saveNote();
 496         }
 497 
 498         new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 499     }
 500 
 501     private void updateNote(Note updatedNote) {
 502         // update note if network change arrived
 503         mNote = updatedNote;
 504         refreshContent(true);
 505     }
 506 
 507     private void refreshContent(boolean isNoteUpdate) {
 508         if (mNote != null) {
 509             // Restore the cursor position if possible.
 510 
<abbr title=" 511             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 511             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEdðŸ”µ</abbr>
 512 
 513             mContentEditText.setText(mNote.getContent());
 514 
 515             if (isNoteUpdate) {
 516                 // Save the note so any local changes get synced
 517                 mNote.save();
 518 
<abbr title=" 519                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) {"> 519                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) ðŸ”µ</abbr>
 520                     mContentEditText.setSelection(cursorPosition);
 521                 }
 522             }
 523 
 524             afterTextChanged(mContentEditText.getText());
 525 
 526             updateTagList();
 527         }
 528     }
 529 
 530     private void updateTagList() {
 531         Activity activity = getActivity();
 532         if (activity == null) return;
 533 
 534         // Populate this note&#x27;s tags in the tagView
 535         mTagView.setChips(mNote.getTagString());
 536     }
 537 
 538     private int newCursorLocation(String newText, String oldText, int cursorLocation) {
 539         // Ported from the iOS app :)
 540         // Cases:
 541         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 542         // 1. Text was added after the cursor ==&gt; no change
 543         // 2. Text was added before the cursor ==&gt; location advances
 544         // 3. Text was removed after the cursor ==&gt; no change
 545         // 4. Text was removed before the cursor ==&gt; location retreats
 546         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 547 
 548         int newCursorLocation = cursorLocation;
 549 
 550         int deltaLength = newText.length() - oldText.length();
 551 
 552         // Case 0
 553         if (newText.length() &lt; cursorLocation)
 554             return newText.length();
 555 
 556         boolean beforeCursorMatches = false;
 557         boolean afterCursorMatches = false;
 558 
 559         try {
<abbr title=" 560             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 560             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorðŸ”µ</abbr>
<abbr title=" 561             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 561             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substðŸ”µ</abbr>
 562         } catch (Exception e) {
 563             e.printStackTrace();
 564         }
 565 
 566         // Cases 2 and 4
 567         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 568             newCursorLocation += deltaLength;
 569 
 570         // Cases 1, 3 and 5 have no change
 571         return newCursorLocation;
 572     }
 573 
 574     private final Runnable mAutoSaveRunnable = new Runnable() {
 575         @Override
 576         public void run() {
 577             saveAndSyncNote();
 578         }
 579     };
 580 
 581     @Override
 582     public void onTagsChanged(String tagString) {
 583         if (mNote == null || !isAdded()) return;
 584 
 585         if (mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length()) {
 586             AnalyticsTracker.track(
 587                     AnalyticsTracker.Stat.EDITOR_TAG_ADDED,
 588                     AnalyticsTracker.CATEGORY_NOTE,
 589                     &quot;tag_added_to_note&quot;
 590             );
 591         }
 592         else {
 593             AnalyticsTracker.track(
 594                     AnalyticsTracker.Stat.EDITOR_TAG_REMOVED,
 595                     AnalyticsTracker.CATEGORY_NOTE,
 596                     &quot;tag_removed_from_note&quot;
 597             );
 598         }
 599 
 600         mNote.setTagString(tagString);
 601         mNote.setModificationDate(Calendar.getInstance());
 602         updateTagList();
 603         mNote.save();
 604     }
 605 
 606     @Override
 607     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 608         // Unused
 609     }
 610 
 611     @Override
 612     public void afterTextChanged(Editable editable) {
 613         // check that the content has really changed (line spacing fix)
 614         if (!mLastContentString.equals(editable.toString())) {
 615             mLastContentString = editable.toString();
 616             setTitleSpan(editable);
 617             attemptAutoList(editable);
 618         }
 619     }
 620 
 621     @Override
 622     public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 623 
 624         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 625         if (mAutoSaveHandler != null) {
 626             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 627             mAutoSaveHandler.postDelayed(mAutoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 628         }
 629 
 630         // Remove search highlight spans when note content changes
 631         if (mMatchOffsets != null) {
 632             mMatchOffsets = null;
 633             mHighlighter.removeMatches();
 634         }
 635     }
 636 
 637     private void setTitleSpan(Editable editable) {
 638         // Set the note title to be a larger size
 639         // Remove any existing size spans
 640         RelativeSizeSpan spans[] = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 641         for (RelativeSizeSpan span : spans) {
 642             editable.removeSpan(span);
 643         }
 644         int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 645         if (newLinePosition == 0)
 646             return;
<abbr title=" 647         editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 647         editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editaðŸ”µ</abbr>
 648 
 649         fixLineSpacing();
 650     }
 651 
 652     // Fix for a line spacing bug
 653     // https://code.google.com/p/android/issues/detail?id=78706
 654     private void fixLineSpacing() {
 655         mContentEditText.setLineSpacing(8, 1);
 656         int startSelection = mContentEditText.getSelectionStart();
 657         mContentEditText.setText(mContentEditText.getText());
 658         mContentEditText.setSelection(startSelection);
 659     }
 660 
 661     private void attemptAutoList(Editable editable) {
 662         int oldCursorPosition = mCurrentCursorPosition;
 663         mCurrentCursorPosition = mContentEditText.getSelectionStart();
 664         AutoBullet.apply(editable, oldCursorPosition, mCurrentCursorPosition);
 665         mCurrentCursorPosition = mContentEditText.getSelectionStart();
 666     }
 667 
 668     private void saveAndSyncNote() {
 669         if (mNote == null) {
 670             return;
 671         }
 672 
 673         new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 674     }
 675 
 676     public void setPlaceholderVisible(boolean isVisible) {
 677         if (isVisible) {
 678             mNote = null;
 679             mContentEditText.setText(&quot;&quot;);
 680             mTagView.setText(&quot;&quot;);
 681             if (mPlaceholderView != null)
 682                 mPlaceholderView.setVisibility(View.VISIBLE);
 683         } else {
 684             if (mPlaceholderView != null)
 685                 mPlaceholderView.setVisibility(View.GONE);
 686         }
 687     }
 688 
 689     public void setIsNewNote(boolean isNewNote) {
 690         this.mIsNewNote = isNewNote;
 691     }
 692 
 693     @Override
 694     public void onFocusChange(View v, boolean hasFocus) {
 695         if (!hasFocus) {
 696             String tagString = getNoteTagsString().trim();
 697             if (tagString.length() &gt; 0) {
 698                 mTagView.setChips(tagString);
 699             }
 700         }
 701     }
 702 
 703     private Note getNote() {
 704         return mNote;
 705     }
 706 
 707     private String getNoteContentString() {
 708         if (mContentEditText == null || mContentEditText.getText() == null) {
 709             return &quot;&quot;;
 710         } else {
 711             return mContentEditText.getText().toString();
 712         }
 713     }
 714 
 715     private String getNoteTagsString() {
 716         if (mTagView == null || mTagView.getText() == null) {
 717             return &quot;&quot;;
 718         } else {
 719             return mTagView.getText().toString();
 720         }
 721     }
 722 
 723     /**
 724      *  Share bottom sheet callbacks
 725      */
 726 
 727     @Override
 728     public void onSharePublishClicked() {
 729         publishNote();
 730         mShareBottomSheet.dismiss();
 731     }
 732 
 733     @Override
 734     public void onShareUnpublishClicked() {
 735         unpublishNote();
 736         mShareBottomSheet.dismiss();
 737     }
 738 
 739     @Override
 740     public void onShareCollaborateClicked() {
 741         Toast.makeText(getActivity(), R.string.collaborate_message, Toast.LENGTH_LONG).show();
 742     }
 743 
 744     @Override
 745     public void onShareDismissed() {
 746 
 747     }
 748 
 749     /**
 750      *  History bottom sheet listeners
 751      */
 752 
 753     @Override
 754     public void onHistoryCancelClicked() {
 755         mContentEditText.setText(mNote.getContent());
 756         mHistoryBottomSheet.dismiss();
 757     }
 758 
 759     @Override
 760     public void onHistoryRestoreClicked() {
 761         mHistoryBottomSheet.dismiss();
 762         saveAndSyncNote();
 763     }
 764 
 765     @Override
 766     public void onHistoryDismissed() {
 767         if (!mHistoryBottomSheet.didTapOnButton()) {
 768             mContentEditText.setText(mNote.getContent());
 769         }
 770 
 771         if (mHistoryTimeoutHandler != null) {
 772             mHistoryTimeoutHandler.removeCallbacks(mHistoryTimeoutRunnable);
 773         }
 774     }
 775 
 776     @Override
 777     public void onHistoryUpdateNote(String content) {
 778         mContentEditText.setText(content);
 779     }
 780 
 781     /**
 782      *  Info bottom sheet listeners
 783      */
 784 
 785     @Override
 786     public void onInfoPinSwitchChanged(boolean isSwitchedOn) {
 787         NoteUtils.setNotePin(mNote, isSwitchedOn);
 788     }
 789 
 790     @Override
 791     public void onInfoMarkdownSwitchChanged(boolean isSwitchedOn) {
 792 
 793     }
 794 
 795     @Override
 796     public void onInfoCopyLinkClicked() {
 797         copyToClipboard(mNote.getPublishedUrl());
 798         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();
 799     }
 800 
 801     @Override
 802     public void onInfoShareLinkClicked() {
 803         mInfoBottomSheet.dismiss();
 804         showShareSheet();
 805     }
 806 
 807     @Override
 808     public void onInfoDismissed() {
 809 
 810     }
 811 
 812     private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 813 
 814         @Override
 815         protected void onPreExecute() {
 816             mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 817             mIsLoadingNote = true;
 818         }
 819 
 820         @Override
 821         protected Void doInBackground(String... args) {
 822             if (getActivity() == null) {
 823                 return null;
 824             }
 825 
 826             String noteID = args[0];
 827             Simplenote application = (Simplenote) getActivity().getApplication();
 828             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 829             try {
 830                 mNote = notesBucket.get(noteID);
 831                 // Set the current note in NotesActivity when on a tablet
 832                 if (getActivity() instanceof NotesActivity) {
 833                     ((NotesActivity) getActivity()).setCurrentNote(mNote);
 834                 }
 835 
 836                 // Set markdown flag for global setting
<abbr title=" 837                 mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_MARKDOWN_ENABLED, false);"> 837                 mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_MARKDOWN_EðŸ”µ</abbr>
 838 
 839                 // Set markdown flag for current note
 840                 if (mNote != null) {
 841                     mIsMarkdownEnabled = mNote.isMarkdownEnabled();
 842                 }
 843             } catch (BucketObjectMissingException e) {
 844                 // TODO: Handle a missing note
 845             }
 846             return null;
 847         }
 848 
 849         @Override
 850         protected void onPostExecute(Void nada) {
 851             if (getActivity() == null || getActivity().isFinishing())
 852                 return;
 853             refreshContent(false);
 854             if (mMatchOffsets != null) {
<abbr title=" 855                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);"> 855                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.COðŸ”µ</abbr>
 856                 mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
 857             }
 858             mContentEditText.addTextChangedListener(NoteEditorFragment.this);
 859             if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 860                 // Show soft keyboard
 861                 mContentEditText.requestFocus();
 862                 new Handler().postDelayed(new Runnable() {
 863                     @Override
 864                     public void run() {
<abbr title=" 865                         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 865                         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSysðŸ”µ</abbr>
 866                         if (inputMethodManager != null)
 867                             inputMethodManager.showSoftInput(mContentEditText, 0);
 868                     }
 869                 }, 100);
 870 
 871             }
 872 
 873             // Show tabs if markdown is enabled globally, for current note, and not tablet landscape
 874             if (mIsMarkdownEnabledGlobal &amp;&amp; mIsMarkdownEnabled) {
 875                 // Get markdown view and update content
 876                 if (DisplayUtils.isLargeScreenLandscape(getActivity())) {
 877                     mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss +
<abbr title=" 878                             new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, null);"> 878                             new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, nðŸ”µ</abbr>
 879                 } else {
 880                     mNoteMarkdownFragment =
 881                             ((NoteEditorActivity) getActivity()).getNoteMarkdownFragment();
 882                     mNoteMarkdownFragment.updateMarkdown(getNoteContentString());
 883                 }
 884             }
 885 
 886             getActivity().invalidateOptionsMenu();
 887 
 888             SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 889 
 890             mIsLoadingNote = false;
 891         }
 892     }
 893 
 894     private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
 895 
 896         @Override
 897         protected Void doInBackground(Void... args) {
 898             saveNote();
 899             return null;
 900         }
 901 
 902         @Override
 903         protected void onPostExecute(Void nada) {
 904             if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {
 905                 // Update links
 906                 SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 907 
 908                 // Update markdown fragment
 909                 if (DisplayUtils.isLargeScreenLandscape(getActivity())) {
 910                     mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss +
<abbr title=" 911                             new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, null);"> 911                             new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, nðŸ”µ</abbr>
 912                 } else {
 913                     mNoteMarkdownFragment.updateMarkdown(getNoteContentString());
 914                 }
 915             }
 916         }
 917     }
 918 
 919 
 920 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 921     private void saveNote() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 922         if (mNote == null || (mHistoryBottomSheet != null &amp;&amp; mHistoryBottomSheet.isShowing())) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 923 </span>
 924 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 925 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 925 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 926 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 927 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 928     protected void saveNote() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 929         if (mNote == null || (mBottomSheet != null &amp;&amp; mBottomSheet.isShowing())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 930 </span>
 931 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 932             return;
 933         }
 934 
 935         String content = getNoteContentString();
 936         String tagString = getNoteTagsString();
 937 
 938 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 939         if (mNote.hasChanges(content, tagString.trim(), mNote.isPinned())) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 940 </span>
 941 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 942 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 942 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 943 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 944 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 945         if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked(), mIsMarkdownEnabled)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 946 </span>
 947 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 948             mNote.setContent(content);
 949             mNote.setTagString(tagString);
 950             mNote.setModificationDate(Calendar.getInstance());
 951             mNote.setMarkdownEnabled(mIsMarkdownEnabled);
 952             // Send pinned event to google analytics if changed
 953             mNote.save();
 954 
 955             AnalyticsTracker.track(
 956                     AnalyticsTracker.Stat.EDITOR_NOTE_EDITED,
 957                     AnalyticsTracker.CATEGORY_NOTE,
 958                     &quot;editor_save&quot;
 959             );
 960         }
 961     }
 962 
 963     // Contextual action bar for dealing with links
 964     private final ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
 965 
 966         // Called when the action mode is created; startActionMode() was called
 967         @Override
 968         public boolean onCreateActionMode(ActionMode mode, Menu menu) {
 969             // Inflate a menu resource providing context menu items
 970             MenuInflater inflater = mode.getMenuInflater();
 971             if (inflater != null) {
 972                 inflater.inflate(R.menu.view_link, menu);
 973                 mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
 974                 mode.setTitle(getString(R.string.link));
 975                 if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
 976                     mode.setTitleOptionalHint(false);
 977                 }
 978 
 979                 DrawableUtils.tintMenuWithAttribute(getActivity(), menu, R.attr.actionModeTextColor);
 980             }
 981             return true;
 982         }
 983 
 984         // Called each time the action mode is shown. Always called after onCreateActionMode, but
 985         // may be called multiple times if the mode is invalidated.
 986         @Override
 987         public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 988             return false; // Return false if nothing is done
 989         }
 990 
 991         // Called when the user selects a contextual menu item
 992         @Override
 993         public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 994             switch (item.getItemId()) {
 995                 case R.id.menu_view_link:
 996                     if (mLinkUrl != null) {
 997                         try {
 998                             Uri uri = Uri.parse(mLinkUrl);
 999                             Intent i = new Intent(Intent.ACTION_VIEW);
1000                             i.setData(uri);
1001                             startActivity(i);
1002                         } catch (Exception e) {
1003                             e.printStackTrace();
1004                         }
1005                         mode.finish(); // Action picked, so close the CAB
1006                     }
1007                     return true;
1008                 case R.id.menu_copy:
1009                     if (mLinkText != null &amp;&amp; getActivity() != null) {
1010                         copyToClipboard(mLinkText);
<abbr title="1011                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();">1011                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORTðŸ”µ</abbr>
1012                         mode.finish();
1013                     }
1014                     return true;
1015                 case R.id.menu_share:
1016                     if (mLinkText != null) {
1017                         showShareSheet();
1018                         mode.finish();
1019                     }
1020                     return true;
1021                 default:
1022                     return false;
1023             }
1024         }
1025 
1026         // Called when the user exits the action mode
1027         @Override
1028         public void onDestroyActionMode(ActionMode mode) {
1029             mActionMode = null;
1030         }
1031     };
1032 
1033     // Checks if cursor is at a URL when the selection changes
1034     // If it is a URL, show the contextual action bar
1035     @Override
1036     public void onSelectionChanged(int selStart, int selEnd) {
1037         if (selStart == selEnd) {
1038             Editable noteContent = mContentEditText.getText();
1039             if (noteContent == null)
1040                 return;
1041 
1042             URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
1043             if (urlSpans.length &gt; 0) {
1044                 URLSpan urlSpan = urlSpans[0];
1045                 mLinkUrl = urlSpan.getURL();
<abbr title="1046                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();">1046                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpaðŸ”µ</abbr>
1047                 if (mActionMode != null) {
1048                     mActionMode.setSubtitle(mLinkText);
1049                     setLinkMenuItem();
1050                     return;
1051                 }
1052 
1053                 // Show the Contextual Action Bar
1054                 if (getActivity() != null) {
<abbr title="1055                     mActionMode = ((AppCompatActivity)getActivity()).startSupportActionMode(mActionModeCallback);">1055                     mActionMode = ((AppCompatActivity)getActivity()).startSupportActionMode(mActionModeCaðŸ”µ</abbr>
1056                     if (mActionMode != null) {
1057                         mActionMode.setSubtitle(mLinkText);
1058                     }
1059 
1060                     setLinkMenuItem();
1061                 }
1062             } else if (mActionMode != null) {
1063                 mActionMode.finish();
1064                 mActionMode = null;
1065             }
1066         } else if (mActionMode != null) {
1067             mActionMode.finish();
1068             mActionMode = null;
1069         }
1070     }
1071 
1072     private void setLinkMenuItem() {
1073         if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
1074             if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
1075                 mViewLinkMenuItem.setIcon(mCallIcon);
1076                 mViewLinkMenuItem.setTitle(getString(R.string.call));
1077             } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
1078                 mViewLinkMenuItem.setIcon(mEmailIcon);
1079                 mViewLinkMenuItem.setTitle(getString(R.string.email));
1080             } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
1081                 mViewLinkMenuItem.setIcon(mMapIcon);
1082                 mViewLinkMenuItem.setTitle(getString(R.string.view_map));
1083             } else {
1084                 mViewLinkMenuItem.setIcon(mWebIcon);
1085                 mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
1086             }
1087         }
1088     }
1089 
1090     // Resets note publish status if Simperium never returned the new publish status
1091     private final Runnable mPublishTimeoutRunnable = new Runnable() {
1092         @Override
1093         public void run() {
1094             if (!isAdded()) return;
1095 
1096             getActivity().runOnUiThread(new Runnable() {
1097                 @Override
1098                 public void run() {
1099 
1100                     mNote.setPublished(!mNote.isPublished());
1101                     mNote.save();
1102 
1103                     updatePublishedState(false);
1104 
1105                 }
1106             });
1107 
1108         }
1109     };
1110 
1111     // Hides the history bottom sheet if no revisions are loaded
1112     private final Runnable mHistoryTimeoutRunnable = new Runnable() {
1113         @Override
1114         public void run() {
1115             if (!isAdded()) return;
1116 
1117             getActivity().runOnUiThread(new Runnable() {
1118                 @Override
1119                 public void run() {
1120 
1121                     if (mHistoryBottomSheet.isShowing() &amp;&amp; !mHistoryBottomSheet.isHistoryLoaded()) {
1122                         mHistoryBottomSheet.dismiss();
1123                         Toast.makeText(getActivity(), R.string.error_history, Toast.LENGTH_LONG).show();
1124                     }
1125                 }
1126             });
1127 
1128         }
1129     };
1130 
1131     private void setPublishedNote(boolean isPublished) {
1132         if (mNote != null) {
1133             mNote.setPublished(isPublished);
1134             mNote.save();
1135 
1136             // reset publish status in 20 seconds if we don&#x27;t hear back from Simperium
1137             mPublishTimeoutHandler.postDelayed(mPublishTimeoutRunnable, PUBLISH_TIMEOUT);
1138 
1139             AnalyticsTracker.track(
1140                     (isPublished) ? AnalyticsTracker.Stat.EDITOR_NOTE_PUBLISHED :
1141                             AnalyticsTracker.Stat.EDITOR_NOTE_UNPUBLISHED,
1142                     AnalyticsTracker.CATEGORY_NOTE,
1143                     &quot;publish_note_button&quot;
1144             );
1145         }
1146     }
1147 
1148     private void updatePublishedState(boolean isSuccess) {
1149 
1150         if (mPublishingSnackbar == null) {
1151             return;
1152         }
1153 
1154         mPublishingSnackbar.dismiss();
1155         mPublishingSnackbar = null;
1156 
1157         if (isSuccess &amp;&amp; isAdded()) {
1158             if (mNote.isPublished()) {
1159                 SnackbarUtils.showSnackbar(getActivity(), R.string.publish_successful,
1160                         R.color.simplenote_positive_green,
1161                         Snackbar.LENGTH_LONG, R.string.undo, new View.OnClickListener() {
1162                             @Override
1163                             public void onClick(View v) {
1164                                 unpublishNote();
1165                             }
1166                         });
1167                 copyToClipboard(mNote.getPublishedUrl());
1168             } else {
1169                 SnackbarUtils.showSnackbar(getActivity(), R.string.unpublish_successful,
1170                         R.color.simplenote_negative_red,
1171                         Snackbar.LENGTH_LONG, R.string.undo, new View.OnClickListener() {
1172                             @Override
1173                             public void onClick(View v) {
1174                                 publishNote();
1175                             }
1176                         });
1177             }
1178         } else {
1179             if (mNote.isPublished()) {
1180                 SnackbarUtils.showSnackbar(getActivity(), R.string.unpublish_error,
1181                         R.color.simplenote_negative_red, Snackbar.LENGTH_LONG);
1182             } else {
1183                 SnackbarUtils.showSnackbar(getActivity(), R.string.publish_error,
1184                         R.color.simplenote_negative_red, Snackbar.LENGTH_LONG);
1185             }
1186         }
1187     }
1188 
1189     private void publishNote() {
1190 
1191         if (isAdded()) {
1192             mPublishingSnackbar = SnackbarUtils.showSnackbar(getActivity(), R.string.publishing,
1193                     R.color.simplenote_blue, Snackbar.LENGTH_INDEFINITE);
1194         }
1195         setPublishedNote(true);
1196     }
1197 
1198     private void unpublishNote() {
1199 
1200         if (isAdded()) {
1201             mPublishingSnackbar = SnackbarUtils.showSnackbar(getActivity(), R.string.unpublishing,
1202                     R.color.simplenote_blue, Snackbar.LENGTH_INDEFINITE);
1203         }
1204         setPublishedNote(false);
1205     }
1206 
1207     private void copyToClipboard(String text) {
<abbr title="1208         ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);">1208         ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_ðŸ”µ</abbr>
1209         ClipData clip = ClipData.newPlainText(getString(R.string.app_name), text);
1210         clipboard.setPrimaryClip(clip);
1211     }
1212 
1213     private void showShareSheet() {
1214         if (isAdded()) {
1215             if (mShareBottomSheet == null) {
1216                 mShareBottomSheet = new ShareBottomSheetDialog(this, this);
1217             }
1218             mShareBottomSheet.show(mNote);
1219         }
1220     }
1221 
1222     private void showInfoSheet() {
1223         if (isAdded()) {
1224             if (mInfoBottomSheet == null) {
1225                 mInfoBottomSheet = new InfoBottomSheetDialog(this, this);
1226             }
1227             mInfoBottomSheet.show(mNote);
1228         }
1229 
1230     }
1231 
1232     private void showHistorySheet() {
1233         if (isAdded()) {
1234             if (mHistoryBottomSheet == null) {
1235                 mHistoryBottomSheet = new HistoryBottomSheetDialog(this, this);
1236             }
1237 
1238             // Request revisions for the current note
<abbr title="1239             mNotesBucket.getRevisions(mNote, MAX_REVISIONS, mHistoryBottomSheet.getRevisionsRequestCallbacks());">1239             mNotesBucket.getRevisions(mNote, MAX_REVISIONS, mHistoryBottomSheet.getRevisionsRequestCallbaðŸ”µ</abbr>
1240             saveNote();
1241 
1242             mHistoryBottomSheet.show(mNote);
1243         }
1244     }
1245 
1246     /**
1247      * Simperium listeners
1248      */
1249 
1250     @Override
1251     public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
1252 
1253     }
1254 
1255     @Override
<abbr title="1256     public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {">1256     public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) ðŸ”µ</abbr>
1257         if (changeType == Bucket.ChangeType.MODIFY) {
1258             if (getNote() != null &amp;&amp; getNote().getSimperiumKey().equals(key)) {
1259                 try {
1260                     final Note updatedNote = mNotesBucket.get(key);
1261                     if (getActivity() != null) {
1262                         getActivity().runOnUiThread(new Runnable() {
1263                             @Override
1264                             public void run() {
1265                                 if (mPublishTimeoutHandler != null) {
1266                                     mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
1267                                 }
1268 
1269                                 updateNote(updatedNote);
1270                                 updatePublishedState(true);
1271                             }
1272                         });
1273                     }
1274                 } catch (BucketObjectMissingException e) {
1275                     e.printStackTrace();
1276                 }
1277             }
1278         }
1279     }
1280 
1281 
1282     @Override
1283     public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
1284         // noop
1285     }
1286 
1287     @Override
1288     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1289         // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
1290         if (mIsLoadingNote)
1291             return;
1292 
1293         Note openNote = getNote();
1294         if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
1295             return;
1296 
1297         note.setContent(getNoteContentString());
1298     }
1299 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.Fragment;
   5  import android.content.ClipData;
   6  import android.content.ClipboardManager;
   7  import android.content.Context;
   8  import android.content.Intent;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 -import android.content.res.TypedArray;</span>
  10  import android.database.Cursor;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 -import android.graphics.drawable.ColorDrawable;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 +import android.graphics.drawable.Drawable;</span>
  13  import android.net.Uri;
  14  import android.os.AsyncTask;
  15  import android.os.Build;
  16  import android.os.Bundle;
  17  import android.os.Handler;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +import android.support.design.widget.Snackbar;</span>
  19  import android.support.v7.app.AppCompatActivity;
  20  import android.support.v7.view.ActionMode;
  21  import android.text.Editable;
  22  import android.text.Spanned;
  23  import android.text.TextWatcher;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import android.text.format.DateUtils;</span>
  25  import android.text.style.RelativeSizeSpan;
  26  import android.text.style.URLSpan;
  27  import android.text.util.Linkify;
  28  import android.util.TypedValue;
  29  import android.view.LayoutInflater;
  30  import android.view.Menu;
  31  import android.view.MenuInflater;
  32  import android.view.MenuItem;
  33  import android.view.View;
  34  import android.view.ViewGroup;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import android.view.WindowManager;</span>
  36  import android.view.inputmethod.InputMethodManager;

  37  import android.widget.CursorAdapter;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import android.widget.ImageButton;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import android.widget.ImageView;</span>
  40  import android.widget.LinearLayout;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import android.widget.PopupWindow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import android.widget.SeekBar;</span>
  43  import android.widget.TextView;
  44  import android.widget.Toast;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import android.widget.ToggleButton;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import android.widget.ViewSwitcher;</span>
  47  
  48  import com.automattic.simplenote.analytics.AnalyticsTracker;
  49  import com.automattic.simplenote.models.Note;
  50  import com.automattic.simplenote.models.Tag;
  51  import com.automattic.simplenote.utils.AutoBullet;
  52  import com.automattic.simplenote.utils.DisplayUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +import com.automattic.simplenote.utils.DrawableUtils;</span>
  54  import com.automattic.simplenote.utils.MatchOffsetHighlighter;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +import com.automattic.simplenote.utils.NoteUtils;</span>
  56  import com.automattic.simplenote.utils.PrefUtils;
  57  import com.automattic.simplenote.utils.SimplenoteLinkify;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +import com.automattic.simplenote.utils.SnackbarUtils;</span>
  59  import com.automattic.simplenote.utils.SpaceTokenizer;
  60  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  61  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  62  import com.automattic.simplenote.utils.TextHighlighter;
  63  import com.automattic.simplenote.widgets.SimplenoteEditText;

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -import com.kennyc.bottomsheet.BottomSheet;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -import com.kennyc.bottomsheet.BottomSheetListener;</span>
  66  import com.simperium.client.Bucket;
  67  import com.simperium.client.BucketObjectMissingException;
  68  import com.simperium.client.Query;
  69  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -import org.json.JSONObject;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -import java.text.NumberFormat;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -import java.util.ArrayList;</span>
  74  import java.util.Calendar;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -import java.util.Map;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  77 -public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListener, View.OnFocusChangeListener, SimplenoteEditText.OnSelectionChangedListener {">  77 -public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListenerðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +        TextWatcher, OnTagAddedListener, View.OnFocusChangeListener,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +        SimplenoteEditText.OnSelectionChangedListener,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +        ShareBottomSheetDialog.ShareSheetListener,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +        HistoryBottomSheetDialog.HistorySheetListener,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +        InfoBottomSheetDialog.InfoSheetListener {</span>
  85  
  86      public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  87      public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  88      static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;

  89      private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  90      private static final int MAX_REVISIONS = 30;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +    private static final int PUBLISH_TIMEOUT = 20000;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +    private static final int HISTORY_TIMEOUT = 10000;</span>
  93  
  94      private Note mNote;
  95      private Bucket&lt;Note&gt; mNotesBucket;
  96  
  97      private SimplenoteEditText mContentEditText;
  98      private TagsMultiAutoCompleteTextView mTagView;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -    private PopupWindow mInfoPopupWindow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -    private View mHistoryView;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -    private SeekBar mHistorySeekBar;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -    private BottomSheet mBottomSheet;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -    private TextView mHistoryDate;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -    private ToggleButton mPinButton;</span>
 106  
 107      private Handler mAutoSaveHandler;
 108      private Handler mPublishTimeoutHandler;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +    private Handler mHistoryTimeoutHandler;</span>
 110  
 111      private LinearLayout mPlaceholderView;
 112      private CursorAdapter mAutocompleteAdapter;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -    private boolean mIsNewNote, mIsLoadingNote, mDidTapHistoryButton;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +    private boolean mIsNewNote, mIsLoadingNote;</span>
 115      private ActionMode mActionMode;
 116      private MenuItem mViewLinkMenuItem;
 117      private String mLinkUrl;
 118      private String mLinkText;
 119      private MatchOffsetHighlighter mHighlighter;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -    private int mEmailIconResId, mWebIconResId, mMapIconResId, mCallIconResId;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +    private Drawable mEmailIcon, mWebIcon, mMapIcon, mCallIcon;</span>
 122      private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
 123      private String mMatchOffsets;
 124      private int mCurrentCursorPosition;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -    private ArrayList&lt;Note&gt; mNoteRevisionsList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +    private String mLastContentString;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +    private HistoryBottomSheetDialog mHistoryBottomSheet;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +    private InfoBottomSheetDialog mInfoBottomSheet;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +    private ShareBottomSheetDialog mShareBottomSheet;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +    private Snackbar mPublishingSnackbar;</span>
 133  
 134      /**
 135       * Mandatory empty constructor for the fragment manager to instantiate the
 136       * fragment (e.g. upon screen orientation changes).
 137       */
 138      public NoteEditorFragment() {
 139      }
 140  
 141      @Override
 142      public void onCreate(Bundle savedInstanceState) {
 143          super.onCreate(savedInstanceState);
 144  
 145          if (getActivity() != null) {
 146              Simplenote currentApp = (Simplenote) getActivity().getApplication();
 147              mNotesBucket = currentApp.getNotesBucket();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 149 -            TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionBarIconWeb, R.attr.actionBarIconMap, R.attr.actionBarIconCall});"> 149 -            TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -            if (a != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -                mEmailIconResId = a.getResourceId(0, 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -                mWebIconResId = a.getResourceId(1, 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -                mMapIconResId = a.getResourceId(2, 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -                mCallIconResId = a.getResourceId(3, 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -                a.recycle();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 160 +        mCallIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_call_white_24dp, R.attr.actionModeTextColor);"> 160 +        mCallIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_call_white_24dp, R.attr.aðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 161 +        mEmailIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_email_white_24dp, R.attr.actionModeTextColor);"> 161 +        mEmailIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_email_white_24dp, R.attrðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 162 +        mMapIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_map_white_24dp, R.attr.actionModeTextColor);"> 162 +        mMapIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_map_white_24dp, R.attr.actðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 163 +        mWebIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_web_white_24dp, R.attr.actionModeTextColor);"> 163 +        mWebIcon = DrawableUtils.tintDrawableWithAttribute(getActivity(), R.drawable.ic_web_white_24dp, R.attr.actðŸ”µ</abbr></span>
 164  
 165          mAutoSaveHandler = new Handler();
 166          mPublishTimeoutHandler = new Handler();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +        mHistoryTimeoutHandler = new Handler();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +        mLastContentString = &quot;&quot;;</span>
 170  
 171          mMatchHighlighter = new TextHighlighter(getActivity(),
 172                  R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);
 173          mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0) {
 174              @Override
 175              public View newView(Context context, Cursor cursor, ViewGroup parent) {
 176                  Activity activity = (Activity) context;
 177                  if (activity == null) return null;
 178                  return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 179              }
 180  
 181              @Override
 182              public void bindView(View view, Context context, Cursor cursor) {
 183                  TextView textView = (TextView) view;
 184                  textView.setText(convertToString(cursor));
 185              }
 186  
 187              @Override
 188              public CharSequence convertToString(Cursor cursor){
 189                  return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 190              }
 191  
 192              @Override
 193              public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 194                  Activity activity = getActivity();
 195                  if (activity == null) return null;
 196                  Simplenote application = (Simplenote) activity.getApplication();
 197                  Query&lt;Tag&gt; query = application.getTagsBucket().query();
 198                  // make the tag name available to the cursor
 199                  query.include(Tag.NAME_PROPERTY);
 200                  // sort the tags by their names
 201                  query.order(Tag.NAME_PROPERTY);
 202                  // if there&#x27;s a filter string find only matching tag names
<abbr title=" 203                  if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 203                  if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%ðŸ”µ</abbr>
 204                  return query.execute();
 205              }
 206          };
 207      }
 208  
 209  
 210      @Override
 211      public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 212          setHasOptionsMenu(true);
 213          View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 214          mContentEditText = ((SimplenoteEditText) rootView.findViewById(R.id.note_content));
 215          mContentEditText.addOnSelectionChangedListener(this);
 216          mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 217          mTagView.setTokenizer(new SpaceTokenizer());
 218          mTagView.setOnFocusChangeListener(this);
 219  
 220          mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 221  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -        mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -        mPinButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -            public void onClick(View v) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -                if (mPinButton.isChecked()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -                    // Friendly message to the user as to what this button does.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -                    Toast.makeText(getActivity(), R.string.note_pinned, Toast.LENGTH_SHORT).show();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -</span>
 233          mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
 234          if (DisplayUtils.isLargeScreenLandscape(getActivity()) &amp;&amp; mNote == null) {
 235              mPlaceholderView.setVisibility(View.VISIBLE);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +            getActivity().invalidateOptionsMenu();</span>









 237          }
 238  
 239          mTagView.setAdapter(mAutocompleteAdapter);
 240  
 241          // Load note if we were passed a note Id
 242          Bundle arguments = getArguments();
 243          if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
 244              String key = arguments.getString(ARG_ITEM_ID);
 245              if (arguments.containsKey(ARG_MATCH_OFFSETS)) {
 246                  mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);
 247              }
 248              new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
 249              setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));
 250          }
 251  
 252  		return rootView;
 253  	}
 254  
 255      @Override
 256      public void onResume() {
 257          super.onResume();
 258          mNotesBucket.start();
 259          mNotesBucket.addListener(this);
 260  
 261          mTagView.setOnTagAddedListener(this);
 262  
 263          if (mContentEditText != null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 264 -            mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_FONT_SIZE, 18));"> 264 -            mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), PrefUtilsðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 265 +            mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_FONT_SIZE, 14));"> 265 +            mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), PrefUtilsðŸ”µ</abbr></span>
 266          }
 267      }
 268  
 269      @Override
 270      public void onPause() {
 271          mNotesBucket.removeListener(this);
 272          // Hide soft keyboard if it is showing...
 273          if (getActivity() != null) {
<abbr title=" 274              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 274              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INðŸ”µ</abbr>
 275              if (inputMethodManager != null) {
 276                  inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 277              }
 278          }
 279  
 280          // Delete the note if it is new and has empty fields
 281          if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty()) {
 282              mNote.delete();
 283          } else {
 284              saveNote();
 285          }
 286  
 287          mTagView.setOnTagAddedListener(null);
 288  
 289          if (mAutoSaveHandler != null) {
 290              mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 291          }
 292  
 293          if (mPublishTimeoutHandler != null) {
 294              mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 295          }
 296  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +        if (mHistoryTimeoutHandler != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +            mHistoryTimeoutHandler.removeCallbacks(mHistoryTimeoutRunnable);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +</span>
 301          mHighlighter.stop();
 302  
 303          super.onPause();
 304      }
 305  
 306      @Override
 307      public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 308          if (!isAdded() || DisplayUtils.isLargeScreenLandscape(getActivity())) {

 309              return;
 310          }
 311  
 312          inflater.inflate(R.menu.note_editor, menu);
 313  
 314          if (mNote != null) {
 315              MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_view_info);
 316              viewPublishedNoteItem.setVisible(true);






 317  
 318              MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 319              if (mNote.isDeleted())
 320                  trashItem.setTitle(R.string.undelete);
 321              else
 322                  trashItem.setTitle(R.string.delete);
 323          }
 324  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +        DrawableUtils.tintMenuWithAttribute(getActivity(), menu, R.attr.actionBarTextColor);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +</span>
 327          super.onCreateOptionsMenu(menu, inflater);
 328      }
 329  
 330      @Override
 331      public boolean onOptionsItemSelected(MenuItem item) {
 332          switch (item.getItemId()) {
 333              case R.id.menu_view_info:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 334 -                if (mNote != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -                    View menuItemView = getActivity().findViewById(R.id.menu_view_info);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -                    showInfoPopup(menuItemView);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +                showInfo();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +            case R.id.menu_history:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +                showHistory();</span>
 343                  return true;
 344              case R.id.menu_share:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 345 -                if (mNote != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 346 -                    Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -                    shareIntent.setType(&quot;text/plain&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 348 -                    shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mNote.getContent());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 349 -                    startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 349 -                    startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note))ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 350 -                    AnalyticsTracker.track(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 351 -                            AnalyticsTracker.Stat.EDITOR_NOTE_CONTENT_SHARED,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 352 -                            AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 353 -                            &quot;action_bar_share_button&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 354 -                    );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +                shareNote();</span>
 357                  return true;


















 358              case R.id.menu_delete:
 359                  if (!isAdded()) return false;
 360  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -                if (mNote != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -                    mNote.setDeleted(!mNote.isDeleted());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -                    mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -                    mNote.save();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -                    Intent resultIntent = new Intent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -                    if (mNote.isDeleted()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 367 -                        resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -                    getActivity().setResult(Activity.RESULT_OK, resultIntent);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -                    AnalyticsTracker.track(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -                            AnalyticsTracker.Stat.EDITOR_NOTE_DELETED,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -                            AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -                            &quot;trash_menu_item&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -                    );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 377 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 378 -                getActivity().finish();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +                deleteNote();</span>
 380                  return true;
 381              case android.R.id.home:
 382                  if (!isAdded()) return false;
 383  
 384                  getActivity().finish();
 385                  return true;
 386              default:
 387                  return super.onOptionsItemSelected(item);
 388          }












 389      }
 390  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 391 -    // show a popup view from the info action bar item</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 392 -    private void showInfoPopup(View view) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 393 -        if (!isAdded() || view == null) return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 394 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 395 -        if (mInfoPopupWindow == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -            mInfoPopupWindow = new PopupWindow(getActivity());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -            mInfoPopupWindow.setWidth(WindowManager.LayoutParams.WRAP_CONTENT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -            mInfoPopupWindow.setHeight(WindowManager.LayoutParams.WRAP_CONTENT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -            mInfoPopupWindow.setBackgroundDrawable(new ColorDrawable(0));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -            mInfoPopupWindow.setOutsideTouchable(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 401 -            mInfoPopupWindow.setFocusable(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 403 -            LayoutInflater inflater = LayoutInflater.from(getActivity());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -            View popupView = inflater.inflate(R.layout.popup_info, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -            mInfoPopupWindow.setContentView(popupView);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -        updateInfoPopup();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -        mInfoPopupWindow.showAsDropDown(view);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -        // Request revisions for the current note</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -        mNotesBucket.getRevisions(mNote, MAX_REVISIONS, mRevisionsRequestCallbacks);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -    // update the content of the popupview</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 417 -    private void updateInfoPopup() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 418 -        if (mInfoPopupWindow == null || mInfoPopupWindow.getContentView() == null) return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 419 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 420 -        View popupView = mInfoPopupWindow.getContentView();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 421 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 422 -        View publishButton = popupView.findViewById(R.id.publish_note_button);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 423 -        TextView publishButtonTextView = (TextView)popupView.findViewById(R.id.publish_note_button_text);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 424 -        ImageView publishButtonIcon = (ImageView)popupView.findViewById(R.id.publish_note_button_icon);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 425 -        TextView publishTextView = (TextView) popupView.findViewById(R.id.publish_url_textview);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 426 -        TextView wordCountTextView = (TextView) popupView.findViewById(R.id.word_count);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 427 -        ImageButton publishCopyButton = (ImageButton) popupView.findViewById(R.id.publish_copy_url);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 428 -        ImageButton publishShareButton = (ImageButton) popupView.findViewById(R.id.publish_share_url);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 429 -        View actionsView = popupView.findViewById(R.id.publish_actions);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 430 -        final View historyButton = popupView.findViewById(R.id.history_button);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 431 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 432 -        final ViewSwitcher viewSwitcher = (ViewSwitcher) popupView.findViewById(R.id.publish_view_switcher);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 433 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 434 -        publishButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 435 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 436 -            public void onClick(View v) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 437 -                if (mNote != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 438 -                    boolean newPublishedStatus = !mNote.isPublished();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 439 -                    mNote.setPublished(newPublishedStatus);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 440 -                    mNote.save();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 441 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 442 -                    if (viewSwitcher.getDisplayedChild() == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 443 -                        viewSwitcher.showNext();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 444 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 445 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 446 -                    // reset publish status in 20 seconds if we don&#x27;t hear back from Simperium</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 447 -                    mPublishTimeoutHandler.postDelayed(mPublishTimeoutRunnable, 20000);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 448 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 449 -                    AnalyticsTracker.track(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 450 -                            (newPublishedStatus) ? AnalyticsTracker.Stat.EDITOR_NOTE_PUBLISHED :</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 451 -                            AnalyticsTracker.Stat.EDITOR_NOTE_UNPUBLISHED,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 452 -                            AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 453 -                            &quot;publish_note_button&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 454 -                    );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 455 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 456 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 457 -        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 458 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 459 -        publishTextView.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 460 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 461 -            public void onClick(View v) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 462 -                try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 463 -                    startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(mNote.getPublishedUrl())));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 464 -                    AnalyticsTracker.track(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 465 -                            AnalyticsTracker.Stat.EDITOR_NOTE_PUBLISHED_URL_PRESSED,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 466 -                            AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 467 -                            &quot;publish_note_url_button&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 468 -                    );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 469 -                } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 470 -                    e.printStackTrace();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 471 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 472 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 473 -        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 474 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 475 -        publishCopyButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 476 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 477 -            public void onClick(View v) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 478 -                ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 478 -                ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 479 -                ClipData clip = ClipData.newPlainText(getString(R.string.app_name), mNote.getPublishedUrl());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 480 -                clipboard.setPrimaryClip(clip);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 481 -                Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 482 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 483 -        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 484 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 485 -        publishShareButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 486 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 487 -            public void onClick(View v) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 488 -                Intent i = new Intent(Intent.ACTION_SEND);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 489 -                i.setType(&quot;text/plain&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 490 -                i.putExtra(Intent.EXTRA_TEXT, mNote.getPublishedUrl());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 491 -                startActivity(Intent.createChooser(i, getString(R.string.share_url)));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 492 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 493 -        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 494 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 495 -        updateWordCount(wordCountTextView);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 496 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 497 -        if (mNote.isPublished()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 498 -            publishButtonTextView.setText(getString(R.string.published));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 499 -            publishButtonIcon.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 500 -            publishTextView.setText(mNote.getPublishedUrl());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 501 -            actionsView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 502 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 503 -            publishButtonTextView.setText(getString(R.string.publish));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 504 -            publishButtonIcon.setVisibility(View.GONE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 505 -            actionsView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 506 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 507 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 508 -        Simplenote currentApp = (Simplenote) getActivity().getApplication();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 509 -        if (currentApp.getSimperium().needsAuthorization()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 510 -            viewSwitcher.setVisibility(View.GONE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 511 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 512 -            viewSwitcher.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 513 -            if (viewSwitcher.getDisplayedChild() == 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 514 -                viewSwitcher.showPrevious();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 515 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 516 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 517 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 518 -        historyButton.setEnabled(mNote.getVersion() &gt; 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 519 -        if (historyButton.isEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 520 -            historyButton.setAlpha(1.0f);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 521 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 522 -            historyButton.setAlpha(0.5f);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 523 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 524 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 525 -        historyButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 526 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 527 -            public void onClick(View view) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 528 -                saveNote();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 529 -                showHistorySheet();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 530 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 531 -        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 532 +    private void deleteNote() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 533 +        if (mNote != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 534 +            mNote.setDeleted(!mNote.isDeleted());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 535 +            mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 536 +            mNote.save();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 537 +            Intent resultIntent = new Intent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 538 +            if (mNote.isDeleted()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 539 +                resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 540 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 541 +            getActivity().setResult(Activity.RESULT_OK, resultIntent);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 542 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 543 +            AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 544 +                    AnalyticsTracker.Stat.EDITOR_NOTE_DELETED,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 545 +                    AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 546 +                    &quot;trash_menu_item&quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 547 +            );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 548 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 549 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 550 +        getActivity().finish();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 551 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 552 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 553 +    private void shareNote() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 554 +        if (mNote != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 555 +            mContentEditText.clearFocus();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 556 +            showShareSheet();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 557 +            AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 558 +                    AnalyticsTracker.Stat.EDITOR_NOTE_CONTENT_SHARED,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 559 +                    AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 560 +                    &quot;action_bar_share_button&quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 561 +            );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 562 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 563 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 564 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 565 +    private void showHistory() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 566 +        if (mNote != null &amp;&amp; mNote.getVersion() &gt; 1) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 567 +            mContentEditText.clearFocus();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 568 +            mHistoryTimeoutHandler.postDelayed(mHistoryTimeoutRunnable, HISTORY_TIMEOUT);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 569 +            showHistorySheet();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 570 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 571 +        else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 572 +            Toast.makeText(getActivity(), R.string.error_history, Toast.LENGTH_LONG).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 573 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 574 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 575 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 576 +    private void showInfo() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 577 +        if (mNote != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 578 +            mContentEditText.clearFocus();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 579 +            saveNote();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 580 +            showInfoSheet();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 581 +        }</span>
 582      }
 583  
 584      private boolean noteIsEmpty() {
 585          return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 586      }
 587  









 588      public void setNote(String noteID){
 589          setNote(noteID, null);
 590      }
 591  
 592      public void setNote(String noteID, String matchOffsets) {
 593          if (mAutoSaveHandler != null)
 594              mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 595  
 596          mPlaceholderView.setVisibility(View.GONE);
 597  
 598          if (matchOffsets != null) {
 599              mMatchOffsets = matchOffsets;
 600          } else {
 601              mMatchOffsets = null;
 602          }
 603  
 604          // If we have a note already (on a tablet in landscape), save the note.
 605          if (mNote != null) {
 606              if (mIsNewNote &amp;&amp; noteIsEmpty())
 607                  mNote.delete();
 608              else if (mNote != null)
 609                  saveNote();
 610          }
 611  
 612          new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 613      }
 614  
 615      private void updateNote(Note updatedNote) {
 616          // update note if network change arrived
 617          mNote = updatedNote;
 618          refreshContent(true);
 619      }
 620  
 621      private void refreshContent(boolean isNoteUpdate) {
 622          if (mNote != null) {
 623              // Restore the cursor position if possible.
 624  
<abbr title=" 625              int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 625              int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.geðŸ”µ</abbr>
 626  
 627              mContentEditText.setText(mNote.getContent());
 628  
 629              if (isNoteUpdate) {
 630                  // Save the note so any local changes get synced
 631                  mNote.save();
 632  
 633                  if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) {
 634                      mContentEditText.setSelection(cursorPosition);
 635                  }
 636              }
 637  
 638              afterTextChanged(mContentEditText.getText());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 639 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 640 -            mPinButton.setChecked(mNote.isPinned());</span>
 641  
 642              updateTagList();
 643          }
 644      }
 645  
 646      private void updateTagList() {
 647          Activity activity = getActivity();
 648          if (activity == null) return;
 649  
 650          // Populate this note&#x27;s tags in the tagView
 651          mTagView.setChips(mNote.getTagString());
 652      }
 653  
 654      private int newCursorLocation(String newText, String oldText, int cursorLocation) {
 655          // Ported from the iOS app :)
 656          // Cases:
 657          // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 658          // 1. Text was added after the cursor ==&gt; no change
 659          // 2. Text was added before the cursor ==&gt; location advances
 660          // 3. Text was removed after the cursor ==&gt; no change
 661          // 4. Text was removed before the cursor ==&gt; location retreats
 662          // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 663  
 664          int newCursorLocation = cursorLocation;
 665  
 666          int deltaLength = newText.length() - oldText.length();
 667  
 668          // Case 0
 669          if (newText.length() &lt; cursorLocation)
 670              return newText.length();
 671  
 672          boolean beforeCursorMatches = false;
 673          boolean afterCursorMatches = false;
 674  
 675          try {
<abbr title=" 676              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 676              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation)ðŸ”µ</abbr>
<abbr title=" 677              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 677              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursðŸ”µ</abbr>
 678          } catch (Exception e) {
 679              e.printStackTrace();
 680          }
 681  
 682          // Cases 2 and 4
 683          if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 684              newCursorLocation += deltaLength;
 685  
 686          // Cases 1, 3 and 5 have no change
 687          return newCursorLocation;
 688      }
 689  
 690      private final Runnable mAutoSaveRunnable = new Runnable() {
 691          @Override
 692          public void run() {
 693              saveAndSyncNote();
 694          }
 695      };
 696  
 697      @Override
 698      public void onTagsChanged(String tagString) {
 699          if (mNote == null || !isAdded()) return;
 700  
 701          if (mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length()) {
 702              AnalyticsTracker.track(
 703                      AnalyticsTracker.Stat.EDITOR_TAG_ADDED,
 704                      AnalyticsTracker.CATEGORY_NOTE,
 705                      &quot;tag_added_to_note&quot;
 706              );
 707          }
 708          else {
 709              AnalyticsTracker.track(
 710                      AnalyticsTracker.Stat.EDITOR_TAG_REMOVED,
 711                      AnalyticsTracker.CATEGORY_NOTE,
 712                      &quot;tag_removed_from_note&quot;
 713              );
 714          }
 715  
 716          mNote.setTagString(tagString);
 717          mNote.setModificationDate(Calendar.getInstance());
 718          updateTagList();
 719          mNote.save();
 720      }
 721  
 722      @Override
 723      public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 724          // Unused
 725      }
 726  
 727      @Override
 728      public void afterTextChanged(Editable editable) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 729 -        setTitleSpan(editable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 730 -        attemptAutoList(editable);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 731 +        // check that the content has really changed (line spacing fix)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 732 +        if (!mLastContentString.equals(editable.toString())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 733 +            mLastContentString = editable.toString();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 734 +            setTitleSpan(editable);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 735 +            attemptAutoList(editable);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 736 +        }</span>
 737      }
 738  
 739      @Override
 740      public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 741  
 742          // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 743          if (mAutoSaveHandler != null) {
 744              mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 745              mAutoSaveHandler.postDelayed(mAutoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 746          }
 747  
 748          // Remove search highlight spans when note content changes
 749          if (mMatchOffsets != null) {
 750              mMatchOffsets = null;
 751              mHighlighter.removeMatches();
 752          }
 753      }
 754  
 755      private void setTitleSpan(Editable editable) {
 756          // Set the note title to be a larger size
 757          // Remove any existing size spans
 758          RelativeSizeSpan spans[] = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 759          for (RelativeSizeSpan span : spans) {
 760              editable.removeSpan(span);
 761          }
 762          int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 763          if (newLinePosition == 0)
 764              return;
<abbr title=" 765          editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 765          editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.lengtðŸ”µ</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 766 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 767 +        fixLineSpacing();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 768 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 769 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 770 +    // Fix for a line spacing bug</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 771 +    // https://code.google.com/p/android/issues/detail?id=78706</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 772 +    private void fixLineSpacing() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 773 +        mContentEditText.setLineSpacing(8, 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 774 +        int startSelection = mContentEditText.getSelectionStart();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 775 +        mContentEditText.setText(mContentEditText.getText());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 776 +        mContentEditText.setSelection(startSelection);</span>
 777      }
 778  
 779      private void attemptAutoList(Editable editable) {
 780          int oldCursorPosition = mCurrentCursorPosition;
 781          mCurrentCursorPosition = mContentEditText.getSelectionStart();
 782          AutoBullet.apply(editable, oldCursorPosition, mCurrentCursorPosition);
 783          mCurrentCursorPosition = mContentEditText.getSelectionStart();
 784      }
 785  
 786      private void saveAndSyncNote() {
 787          if (mNote == null) {
 788              return;
 789          }
 790  
 791          new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 792      }
 793  
 794      public void setPlaceholderVisible(boolean isVisible) {
 795          if (isVisible) {
 796              mNote = null;
 797              mContentEditText.setText(&quot;&quot;);
 798              mTagView.setText(&quot;&quot;);
 799              if (mPlaceholderView != null)
 800                  mPlaceholderView.setVisibility(View.VISIBLE);
 801          } else {
 802              if (mPlaceholderView != null)
 803                  mPlaceholderView.setVisibility(View.GONE);
 804          }
 805      }
 806  
 807      public void setIsNewNote(boolean isNewNote) {
 808          this.mIsNewNote = isNewNote;
 809      }
 810  
 811      @Override
 812      public void onFocusChange(View v, boolean hasFocus) {
 813          if (!hasFocus) {
 814              String tagString = getNoteTagsString().trim();
 815              if (tagString.length() &gt; 0) {
 816                  mTagView.setChips(tagString);
 817              }
 818          }
 819      }
 820  
 821      private Note getNote() {
 822          return mNote;
 823      }
 824  
 825      private String getNoteContentString() {
 826          if (mContentEditText == null || mContentEditText.getText() == null) {
 827              return &quot;&quot;;
 828          } else {
 829              return mContentEditText.getText().toString();
 830          }
 831      }
 832  
 833      private String getNoteTagsString() {
 834          if (mTagView == null || mTagView.getText() == null) {
 835              return &quot;&quot;;
 836          } else {
 837              return mTagView.getText().toString();
 838          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 839 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 840 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 841 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 842 +     *  Share bottom sheet callbacks</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 843 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 844 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 845 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 846 +    public void onSharePublishClicked() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 847 +        publishNote();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 848 +        mShareBottomSheet.dismiss();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 849 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 850 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 851 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 852 +    public void onShareUnpublishClicked() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 853 +        unpublishNote();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 854 +        mShareBottomSheet.dismiss();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 855 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 856 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 857 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 858 +    public void onShareCollaborateClicked() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 859 +        Toast.makeText(getActivity(), R.string.collaborate_message, Toast.LENGTH_LONG).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 860 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 861 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 862 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 863 +    public void onShareDismissed() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 864 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 865 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 866 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 867 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 868 +     *  History bottom sheet listeners</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 869 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 870 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 871 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 872 +    public void onHistoryCancelClicked() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 873 +        mContentEditText.setText(mNote.getContent());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 874 +        mHistoryBottomSheet.dismiss();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 875 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 876 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 877 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 878 +    public void onHistoryRestoreClicked() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 879 +        mHistoryBottomSheet.dismiss();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 880 +        saveAndSyncNote();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 881 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 882 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 883 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 884 +    public void onHistoryDismissed() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 885 +        if (!mHistoryBottomSheet.didTapOnButton()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 886 +            mContentEditText.setText(mNote.getContent());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 887 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 888 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 889 +        if (mHistoryTimeoutHandler != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 890 +            mHistoryTimeoutHandler.removeCallbacks(mHistoryTimeoutRunnable);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 891 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 892 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 893 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 894 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 895 +    public void onHistoryUpdateNote(String content) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 896 +        mContentEditText.setText(content);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 897 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 898 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 899 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 900 +     *  Info bottom sheet listeners</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 901 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 902 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 903 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 904 +    public void onInfoPinSwitchChanged(boolean isSwitchedOn) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 905 +        NoteUtils.setNotePin(mNote, isSwitchedOn);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 906 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 907 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 908 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 909 +    public void onInfoMarkdownSwitchChanged(boolean isSwitchedOn) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 910 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 911 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 912 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 913 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 914 +    public void onInfoCopyLinkClicked() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 915 +        copyToClipboard(mNote.getPublishedUrl());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 916 +        Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 917 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 918 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 919 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 920 +    public void onInfoShareLinkClicked() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 921 +        mInfoBottomSheet.dismiss();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 922 +        showShareSheet();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 923 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 924 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 925 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 926 +    public void onInfoDismissed() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 927 +</span>
 928      }
 929  
 930      private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 931  
 932          @Override
 933          protected void onPreExecute() {
 934              mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 935              mIsLoadingNote = true;
 936          }
 937  
 938          @Override
 939          protected Void doInBackground(String... args) {
 940              if (getActivity() == null) {
 941                  return null;
 942              }
 943  
 944              String noteID = args[0];
 945              Simplenote application = (Simplenote) getActivity().getApplication();
 946              Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 947              try {
 948                  mNote = notesBucket.get(noteID);
 949                  // Set the current note in NotesActivity when on a tablet
 950                  if (getActivity() instanceof NotesActivity) {
 951                      ((NotesActivity) getActivity()).setCurrentNote(mNote);








 952                  }
 953              } catch (BucketObjectMissingException e) {
 954                  // TODO: Handle a missing note
 955              }
 956              return null;
 957          }
 958  
 959          @Override
 960          protected void onPostExecute(Void nada) {
 961              if (getActivity() == null || getActivity().isFinishing())
 962                  return;
 963              refreshContent(false);
 964              if (mMatchOffsets != null) {
<abbr title=" 965                  int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);"> 965                  int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROðŸ”µ</abbr>
 966                  mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
 967              }
 968              mContentEditText.addTextChangedListener(NoteEditorFragment.this);
 969              if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 970                  // Show soft keyboard
 971                  mContentEditText.requestFocus();
 972                  new Handler().postDelayed(new Runnable() {
 973                      @Override
 974                      public void run() {
<abbr title=" 975                          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 975                          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemServicðŸ”µ</abbr>
 976                          if (inputMethodManager != null)
 977                              inputMethodManager.showSoftInput(mContentEditText, 0);
 978                      }
 979                  }, 100);
 980  
 981              }
 982  















 983              SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 984  
 985              mIsLoadingNote = false;
 986          }
 987      }
 988  
 989      private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
 990  
 991          @Override
 992          protected Void doInBackground(Void... args) {
 993              saveNote();
 994              return null;
 995          }
 996  
 997          @Override
 998          protected void onPostExecute(Void nada) {
 999              if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {
1000                  // Update links
1001                  SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
1002              }
1003          }
1004      }
1005  
1006      private void saveNote() {













<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1007 -        if (mNote == null || (mBottomSheet != null &amp;&amp; mBottomSheet.isShowing())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1008 +        if (mNote == null || (mHistoryBottomSheet != null &amp;&amp; mHistoryBottomSheet.isShowing())) {</span>
1009              return;
1010          }
1011  
1012          String content = getNoteContentString();
1013          String tagString = getNoteTagsString();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1014 -        if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1015 +        if (mNote.hasChanges(content, tagString.trim(), mNote.isPinned())) {</span>
1016              mNote.setContent(content);
1017              mNote.setTagString(tagString);
1018              mNote.setModificationDate(Calendar.getInstance());

1019              // Send pinned event to google analytics if changed
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1020 -            mNote.setPinned(mPinButton.isChecked());</span>
1021              mNote.save();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1022 -            if (getActivity() != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1023 -                if (mNote.isPinned() != mPinButton.isChecked()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1024 -                    AnalyticsTracker.track(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1025 -                            mPinButton.isChecked() ? AnalyticsTracker.Stat.EDITOR_NOTE_PINNED :</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1026 -                                    AnalyticsTracker.Stat.EDITOR_NOTE_UNPINNED,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1027 -                            AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1028 -                            &quot;pin_button&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1029 -                    );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1030 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1031 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1032 -                AnalyticsTracker.track(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1033 -                        AnalyticsTracker.Stat.EDITOR_NOTE_EDITED,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1034 -                        AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1035 -                        &quot;editor_save&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1036 -                );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1037 -            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1038 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1039 +            AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1040 +                    AnalyticsTracker.Stat.EDITOR_NOTE_EDITED,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1041 +                    AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1042 +                    &quot;editor_save&quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1043 +            );</span>
1044          }
1045      }
1046  
1047      // Contextual action bar for dealing with links
1048      private final ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
1049  
1050          // Called when the action mode is created; startActionMode() was called
1051          @Override
1052          public boolean onCreateActionMode(ActionMode mode, Menu menu) {
1053              // Inflate a menu resource providing context menu items
1054              MenuInflater inflater = mode.getMenuInflater();
1055              if (inflater != null) {
1056                  inflater.inflate(R.menu.view_link, menu);
1057                  mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
1058                  mode.setTitle(getString(R.string.link));
1059                  if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
1060                      mode.setTitleOptionalHint(false);
1061                  }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1062 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1063 +                DrawableUtils.tintMenuWithAttribute(getActivity(), menu, R.attr.actionModeTextColor);</span>
1064              }
1065              return true;
1066          }
1067  
1068          // Called each time the action mode is shown. Always called after onCreateActionMode, but
1069          // may be called multiple times if the mode is invalidated.
1070          @Override
1071          public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
1072              return false; // Return false if nothing is done
1073          }
1074  
1075          // Called when the user selects a contextual menu item
1076          @Override
1077          public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
1078              switch (item.getItemId()) {
1079                  case R.id.menu_view_link:
1080                      if (mLinkUrl != null) {
1081                          try {
1082                              Uri uri = Uri.parse(mLinkUrl);
1083                              Intent i = new Intent(Intent.ACTION_VIEW);
1084                              i.setData(uri);
1085                              startActivity(i);
1086                          } catch (Exception e) {
1087                              e.printStackTrace();
1088                          }
1089                          mode.finish(); // Action picked, so close the CAB
1090                      }
1091                      return true;
1092                  case R.id.menu_copy:
1093                      if (mLinkText != null &amp;&amp; getActivity() != null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1094 -                        ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);">1094 -                        ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1095 -                        ClipData clip = ClipData.newPlainText(getString(R.string.app_name),mLinkText);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1096 -                        clipboard.setPrimaryClip(clip);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1097 +                        copyToClipboard(mLinkText);</span>
1098                          Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();
1099                          mode.finish();
1100                      }
1101                      return true;
1102                  case R.id.menu_share:
1103                      if (mLinkText != null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1104 -                        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1105 -                            Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1106 -                            shareIntent.setType(&quot;text/plain&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1107 -                            shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mLinkText);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1108 -                            startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));">1108 -                            startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.sharðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1109 -                        } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1110 -                            e.printStackTrace();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1111 -                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1112 +                        showShareSheet();</span>
1113                          mode.finish();
1114                      }
1115                      return true;
1116                  default:
1117                      return false;
1118              }
1119          }
1120  
1121          // Called when the user exits the action mode
1122          @Override
1123          public void onDestroyActionMode(ActionMode mode) {
1124              mActionMode = null;
1125          }
1126      };
1127  
1128      // Checks if cursor is at a URL when the selection changes
1129      // If it is a URL, show the contextual action bar
1130      @Override
1131      public void onSelectionChanged(int selStart, int selEnd) {
1132          if (selStart == selEnd) {
1133              Editable noteContent = mContentEditText.getText();
1134              if (noteContent == null)
1135                  return;
1136  
1137              URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
1138              if (urlSpans.length &gt; 0) {
1139                  URLSpan urlSpan = urlSpans[0];
1140                  mLinkUrl = urlSpan.getURL();
<abbr title="1141                  mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();">1141                  mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSðŸ”µ</abbr>
1142                  if (mActionMode != null) {
1143                      mActionMode.setSubtitle(mLinkText);
1144                      setLinkMenuItem();
1145                      return;
1146                  }
1147  
1148                  // Show the Contextual Action Bar
1149                  if (getActivity() != null) {
1150                      mActionMode = ((AppCompatActivity)getActivity()).startSupportActionMode(mActionModeCallback);
1151                      if (mActionMode != null) {
1152                          mActionMode.setSubtitle(mLinkText);
1153                      }
1154  
1155                      setLinkMenuItem();
1156                  }
1157              } else if (mActionMode != null) {
1158                  mActionMode.finish();
1159                  mActionMode = null;
1160              }
1161          } else if (mActionMode != null) {
1162              mActionMode.finish();
1163              mActionMode = null;
1164          }
1165      }
1166  
1167      private void setLinkMenuItem() {
1168          if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
1169              if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1170 -                mViewLinkMenuItem.setIcon(mCallIconResId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1171 +                mViewLinkMenuItem.setIcon(mCallIcon);</span>
1172                  mViewLinkMenuItem.setTitle(getString(R.string.call));
1173              } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1174 -                mViewLinkMenuItem.setIcon(mEmailIconResId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1175 +                mViewLinkMenuItem.setIcon(mEmailIcon);</span>
1176                  mViewLinkMenuItem.setTitle(getString(R.string.email));
1177              } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1178 -                mViewLinkMenuItem.setIcon(mMapIconResId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1179 +                mViewLinkMenuItem.setIcon(mMapIcon);</span>
1180                  mViewLinkMenuItem.setTitle(getString(R.string.view_map));
1181              } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1182 -                mViewLinkMenuItem.setIcon(mWebIconResId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1183 +                mViewLinkMenuItem.setIcon(mWebIcon);</span>
1184                  mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
1185              }
1186          }
1187      }
1188  
1189      // Resets note publish status if Simperium never returned the new publish status
1190      private final Runnable mPublishTimeoutRunnable = new Runnable() {
1191          @Override
1192          public void run() {
1193              if (!isAdded()) return;
1194  
1195              getActivity().runOnUiThread(new Runnable() {
1196                  @Override
1197                  public void run() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1198 -                    Toast.makeText(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1199 -                            getActivity(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1200 -                            mNote.isPublished() ? R.string.publish_error : R.string.unpublish_error,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1201 -                            Toast.LENGTH_SHORT</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1202 -                    ).show();</span>
1203  
1204                      mNote.setPublished(!mNote.isPublished());
1205                      mNote.save();
1206  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1207 -                    if (mInfoPopupWindow != null &amp;&amp; mInfoPopupWindow.isShowing()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1208 -                        ViewSwitcher viewSwitcher = (ViewSwitcher)mInfoPopupWindow.getContentView().findViewById(R.id.publish_view_switcher);">1208 -                        ViewSwitcher viewSwitcher = (ViewSwitcher)mInfoPopupWindow.getContentView().findViewById(RðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1209 -                        if (viewSwitcher.getDisplayedChild() == 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1210 -                            viewSwitcher.showPrevious();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1211 -                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1212 +                    updatePublishedState(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1213 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1214 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1215 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1216 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1217 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1218 +    };</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1219 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1220 +    // Hides the history bottom sheet if no revisions are loaded</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1221 +    private final Runnable mHistoryTimeoutRunnable = new Runnable() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1222 +        @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1223 +        public void run() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1224 +            if (!isAdded()) return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1225 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1226 +            getActivity().runOnUiThread(new Runnable() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1227 +                @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1228 +                public void run() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1229 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1230 +                    if (mHistoryBottomSheet.isShowing() &amp;&amp; !mHistoryBottomSheet.isHistoryLoaded()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1231 +                        mHistoryBottomSheet.dismiss();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1232 +                        Toast.makeText(getActivity(), R.string.error_history, Toast.LENGTH_LONG).show();</span>
1233                      }
1234                  }
1235              });
1236  
1237          }
1238      };
1239  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1240 -    private void updateWordCount(TextView textView) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1241 -        String content = getNoteContentString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1242 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1243 -        if (content == null || textView == null) return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1244 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1245 -        int numWords = (content.trim().length() == 0) ? 0 : content.trim().split(&quot;([\\W]+)&quot;).length;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1246 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1247 -        String wordCountString = getResources().getQuantityString(R.plurals.word_count, numWords);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1248 -        String formattedWordCount = NumberFormat.getInstance().format(numWords);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1249 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1250 -        textView.setText(formattedWordCount + &quot; &quot; + wordCountString);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1251 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1252 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1253 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1254 -     * History methods</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1255 -     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1256 +    private void setPublishedNote(boolean isPublished) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1257 +        if (mNote != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1258 +            mNote.setPublished(isPublished);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1259 +            mNote.save();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1260 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1261 +            // reset publish status in 20 seconds if we don&#x27;t hear back from Simperium</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1262 +            mPublishTimeoutHandler.postDelayed(mPublishTimeoutRunnable, PUBLISH_TIMEOUT);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1263 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1264 +            AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1265 +                    (isPublished) ? AnalyticsTracker.Stat.EDITOR_NOTE_PUBLISHED :</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1266 +                            AnalyticsTracker.Stat.EDITOR_NOTE_UNPUBLISHED,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1267 +                    AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1268 +                    &quot;publish_note_button&quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1269 +            );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1270 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1271 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1272 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1273 +    private void updatePublishedState(boolean isSuccess) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1274 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1275 +        if (mPublishingSnackbar == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1276 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1277 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1278 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1279 +        mPublishingSnackbar.dismiss();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1280 +        mPublishingSnackbar = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1281 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1282 +        if (isSuccess &amp;&amp; isAdded()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1283 +            if (mNote.isPublished()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1284 +                SnackbarUtils.showSnackbar(getActivity(), R.string.publish_successful,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1285 +                        R.color.simplenote_positive_green,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1286 +                        Snackbar.LENGTH_LONG, R.string.undo, new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1287 +                            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1288 +                            public void onClick(View v) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1289 +                                unpublishNote();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1290 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1291 +                        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1292 +                copyToClipboard(mNote.getPublishedUrl());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1293 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1294 +                SnackbarUtils.showSnackbar(getActivity(), R.string.unpublish_successful,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1295 +                        R.color.simplenote_negative_red,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1296 +                        Snackbar.LENGTH_LONG, R.string.undo, new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1297 +                            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1298 +                            public void onClick(View v) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1299 +                                publishNote();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1300 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1301 +                        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1302 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1303 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1304 +            if (mNote.isPublished()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1305 +                SnackbarUtils.showSnackbar(getActivity(), R.string.unpublish_error,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1306 +                        R.color.simplenote_negative_red, Snackbar.LENGTH_LONG);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1307 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1308 +                SnackbarUtils.showSnackbar(getActivity(), R.string.publish_error,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1309 +                        R.color.simplenote_negative_red, Snackbar.LENGTH_LONG);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1310 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1311 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1312 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1313 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1314 +    private void publishNote() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1315 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1316 +        if (isAdded()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1317 +            mPublishingSnackbar = SnackbarUtils.showSnackbar(getActivity(), R.string.publishing,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1318 +                    R.color.simplenote_blue, Snackbar.LENGTH_INDEFINITE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1319 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1320 +        setPublishedNote(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1321 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1322 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1323 +    private void unpublishNote() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1324 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1325 +        if (isAdded()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1326 +            mPublishingSnackbar = SnackbarUtils.showSnackbar(getActivity(), R.string.unpublishing,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1327 +                    R.color.simplenote_blue, Snackbar.LENGTH_INDEFINITE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1328 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1329 +        setPublishedNote(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1330 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1331 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1332 +    private void copyToClipboard(String text) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1333 +        ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1334 +        ClipData clip = ClipData.newPlainText(getString(R.string.app_name), text);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1335 +        clipboard.setPrimaryClip(clip);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1336 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1337 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1338 +    private void showShareSheet() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1339 +        if (isAdded()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1340 +            if (mShareBottomSheet == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1341 +                mShareBottomSheet = new ShareBottomSheetDialog(this, this);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1342 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1343 +            mShareBottomSheet.show(mNote);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1344 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1345 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1346 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1347 +    private void showInfoSheet() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1348 +        if (isAdded()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1349 +            if (mInfoBottomSheet == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1350 +                mInfoBottomSheet = new InfoBottomSheetDialog(this, this);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1351 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1352 +            mInfoBottomSheet.show(mNote);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1353 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1354 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1355 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1356 +</span>
1357      private void showHistorySheet() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1358 -        mContentEditText.clearFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1359 -        mHistoryView = LayoutInflater.from(getActivity()).inflate(R.layout.history_view, null, false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1360 -        mHistoryDate = (TextView)mHistoryView.findViewById(R.id.history_date);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1361 -        mHistorySeekBar = (SeekBar) mHistoryView.findViewById(R.id.seek_bar);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1362 -        mHistorySeekBar.setOnSeekBarChangeListener(new SeekBar.OnSeekBarChangeListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1363 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1364 -            public void onProgressChanged(SeekBar seekBar, int progress, boolean fromUser) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1365 -                if (mNoteRevisionsList == null  || mBottomSheet == null || !mBottomSheet.isShowing()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1366 -                    return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1367 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1368 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1369 -                Calendar noteDate = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1370 -                if (progress == mNoteRevisionsList.size()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1371 -                    mContentEditText.setText(mNote.getContent());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1372 -                    noteDate = mNote.getModificationDate();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1373 -                } else if (progress &lt; mNoteRevisionsList.size() &amp;&amp; mNoteRevisionsList.get(progress) != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1374 -                    Note revisedNote = mNoteRevisionsList.get(progress);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1375 -                    noteDate = revisedNote.getModificationDate();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1376 -                    mContentEditText.setText(revisedNote.getContent());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1377 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1378 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1379 -                updateHistoryDateText(noteDate);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1380 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1381 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1382 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1383 -            public void onStartTrackingTouch(SeekBar seekBar) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1384 -                // noop</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1385 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1386 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1387 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1388 -            public void onStopTrackingTouch(SeekBar seekBar) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1389 -                // noop</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1390 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1391 -        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1392 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1393 -        View cancelHistoryButton = mHistoryView.findViewById(R.id.cancel_history_button);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1394 -        cancelHistoryButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1395 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1396 -            public void onClick(View v) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1397 -                mContentEditText.setText(mNote.getContent());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1398 -                if (mBottomSheet != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1399 -                    mDidTapHistoryButton = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1400 -                    mBottomSheet.dismiss();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1401 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1402 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1403 -        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1404 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1405 -        View restoreHistoryButton = mHistoryView.findViewById(R.id.restore_history_button);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1406 -        restoreHistoryButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1407 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1408 -            public void onClick(View v) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1409 -                if (mBottomSheet != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1410 -                    mDidTapHistoryButton = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1411 -                    mBottomSheet.dismiss();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1412 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1413 -                saveAndSyncNote();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1414 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1415 -        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1416 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1417 -        mBottomSheet = new BottomSheet.Builder(getActivity(), R.style.Simplestyle_BottomSheet)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1418 -                .setView(mHistoryView)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1419 -                .setListener(new BottomSheetListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1420 -                    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1421 -                    public void onSheetDismissed(int dismissalType) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1422 -                        if (dismissalType == Integer.MIN_VALUE &amp;&amp; !mDidTapHistoryButton) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1423 -                            mContentEditText.setText(mNote.getContent());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1424 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1425 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1426 -                        mDidTapHistoryButton = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1427 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1428 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1429 -                    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1430 -                    public void onSheetShown() {}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1431 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1432 -                    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1433 -                    public void onSheetItemSelected(MenuItem menuItem) {}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1434 -                }).create();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1435 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1436 -        updateHistoryProgressBar();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1437 -        mBottomSheet.getWindow().setDimAmount(0.3f);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1438 -        mBottomSheet.show();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1439 -        mInfoPopupWindow.dismiss();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1440 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1441 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1442 -    private void updateHistoryDateText(Calendar noteDate) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1443 -        if (!isAdded() || noteDate == null || mHistoryDate == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1444 -            return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1445 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1446 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1447 -        long now = Calendar.getInstance().getTimeInMillis();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1448 -        CharSequence dateText = DateUtils.getRelativeDateTimeString(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1449 -                getActivity(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1450 -                noteDate.getTimeInMillis(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1451 -                now,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1452 -                0L,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1453 -                DateUtils.FORMAT_ABBREV_ALL</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1454 -        );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1455 -        mHistoryDate.setText(dateText);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1456 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1457 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1458 -    private void updateHistoryProgressBar() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1459 -        if (mHistorySeekBar == null) return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1460 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1461 -        int totalRevs = mNoteRevisionsList == null ? 0 : mNoteRevisionsList.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1462 -        if (totalRevs &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1463 -            mHistorySeekBar.setMax(totalRevs);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1464 -            mHistorySeekBar.setProgress(totalRevs);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1465 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1466 -            updateHistoryDateText(mNote.getModificationDate());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1467 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1468 -            mHistoryView.findViewById(R.id.history_loading_view).setVisibility(View.GONE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1469 -            mHistoryView.findViewById(R.id.history_slider_view).setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1470 +        if (isAdded()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1471 +            if (mHistoryBottomSheet == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1472 +                mHistoryBottomSheet = new HistoryBottomSheetDialog(this, this);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1473 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1474 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1475 +            // Request revisions for the current note</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1476 +            mNotesBucket.getRevisions(mNote, MAX_REVISIONS, mHistoryBottomSheet.getRevisionsRequestCallbacks());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1477 +            saveNote();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1478 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1479 +            mHistoryBottomSheet.show(mNote);</span>
1480          }
1481      }
1482  
1483      /**
1484       * Simperium listeners
1485       */
1486  
1487      @Override
1488      public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
1489  
1490      }
1491  
1492      @Override
1493      public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {
1494          if (changeType == Bucket.ChangeType.MODIFY) {
1495              if (getNote() != null &amp;&amp; getNote().getSimperiumKey().equals(key)) {
1496                  try {
1497                      final Note updatedNote = mNotesBucket.get(key);
1498                      if (getActivity() != null) {
1499                          getActivity().runOnUiThread(new Runnable() {
1500                              @Override
1501                              public void run() {
1502                                  if (mPublishTimeoutHandler != null) {
1503                                      mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
1504                                  }
1505  
1506                                  updateNote(updatedNote);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1507 -                                updateInfoPopup();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1508 +                                updatePublishedState(true);</span>
1509                              }
1510                          });
1511                      }
1512                  } catch (BucketObjectMissingException e) {
1513                      e.printStackTrace();
1514                  }
1515              }
1516          }
1517      }
1518  
1519  
1520      @Override
1521      public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
1522          // noop
1523      }
1524  
1525      @Override
1526      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1527          // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
1528          if (mIsLoadingNote)
1529              return;
1530  
1531          Note openNote = getNote();
1532          if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
1533              return;
1534  
1535          note.setContent(getNoteContentString());
1536      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1537 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1538 -    private final Bucket.RevisionsRequestCallbacks&lt;Note&gt; mRevisionsRequestCallbacks = new</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1539 -            Bucket.RevisionsRequestCallbacks&lt;Note&gt;() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1540 -                // Note: These callbacks won&#x27;t be running on the main thread</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1541 -                @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1542 -                public void onComplete(Map&lt;Integer, Note&gt; revisionsMap) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1543 -                    if (!isAdded()) return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1544 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1545 -                    // Convert map to an array list, to work better with the 0-index based seekbar</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1546 -                    mNoteRevisionsList = new ArrayList&lt;&gt;(revisionsMap.values());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1547 -                    getActivity().runOnUiThread(new Runnable() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1548 -                        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1549 -                        public void run() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1550 -                            updateHistoryProgressBar();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1551 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1552 -                    });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1553 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1554 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1555 -                @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1556 -                public void onRevision(String key, int version, JSONObject object) {}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1557 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1558 -                @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1559 -                public void onError(Throwable exception) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1560 -                    if (!isAdded() || mHistoryView == null) return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1561 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1562 -                    getActivity().runOnUiThread(new Runnable() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1563 -                        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1564 -                        public void run() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1565 -                            mHistoryView.findViewById(R.id.history_progress_bar).setVisibility(View.GONE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1566 -                            mHistoryView.findViewById(R.id.history_error_text).setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1567 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1568 -                    });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1569 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1570 -            };</span>
1571  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 -import android.app.Fragment;</span>
   5  import android.content.ClipData;
   6  import android.content.ClipboardManager;
   7  import android.content.Context;
   8  import android.content.Intent;
   9  import android.content.res.TypedArray;
  10  import android.database.Cursor;
  11  import android.graphics.drawable.ColorDrawable;

  12  import android.net.Uri;
  13  import android.os.AsyncTask;
  14  import android.os.Build;
  15  import android.os.Bundle;
  16  import android.os.Handler;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 +import android.support.v4.app.Fragment;</span>
  18  import android.support.v7.app.AppCompatActivity;
  19  import android.support.v7.view.ActionMode;
  20  import android.text.Editable;
  21  import android.text.Spanned;
  22  import android.text.TextWatcher;
  23  import android.text.format.DateUtils;
  24  import android.text.style.RelativeSizeSpan;
  25  import android.text.style.URLSpan;
  26  import android.text.util.Linkify;
  27  import android.util.TypedValue;
  28  import android.view.LayoutInflater;
  29  import android.view.Menu;
  30  import android.view.MenuInflater;
  31  import android.view.MenuItem;
  32  import android.view.View;
  33  import android.view.ViewGroup;
  34  import android.view.WindowManager;
  35  import android.view.inputmethod.InputMethodManager;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import android.webkit.WebView;</span>
  37  import android.widget.CursorAdapter;
  38  import android.widget.ImageButton;
  39  import android.widget.ImageView;
  40  import android.widget.LinearLayout;
  41  import android.widget.PopupWindow;
  42  import android.widget.SeekBar;
  43  import android.widget.TextView;
  44  import android.widget.Toast;
  45  import android.widget.ToggleButton;
  46  import android.widget.ViewSwitcher;
  47  
  48  import com.automattic.simplenote.analytics.AnalyticsTracker;
  49  import com.automattic.simplenote.models.Note;
  50  import com.automattic.simplenote.models.Tag;
  51  import com.automattic.simplenote.utils.AutoBullet;
  52  import com.automattic.simplenote.utils.DisplayUtils;

  53  import com.automattic.simplenote.utils.MatchOffsetHighlighter;

  54  import com.automattic.simplenote.utils.PrefUtils;
  55  import com.automattic.simplenote.utils.SimplenoteLinkify;

  56  import com.automattic.simplenote.utils.SpaceTokenizer;
  57  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  58  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  59  import com.automattic.simplenote.utils.TextHighlighter;
  60  import com.automattic.simplenote.widgets.SimplenoteEditText;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +import com.commonsware.cwac.anddown.AndDown;</span>
  62  import com.kennyc.bottomsheet.BottomSheet;
  63  import com.kennyc.bottomsheet.BottomSheetListener;
  64  import com.simperium.client.Bucket;
  65  import com.simperium.client.BucketObjectMissingException;
  66  import com.simperium.client.Query;
  67  
  68  import org.json.JSONObject;
  69  
  70  import java.text.NumberFormat;
  71  import java.util.ArrayList;
  72  import java.util.Calendar;
  73  import java.util.Map;
  74  
<abbr title="  75  public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListener, View.OnFocusChangeListener, SimplenoteEditText.OnSelectionChangedListener {">  75  public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListenerðŸ”µ</abbr>







  76  
  77      public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  78      public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  79      static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +    static public final String ARG_MARKDOWN_ENABLED = &quot;markdown_enabled&quot;;</span>
  81      private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  82      private static final int MAX_REVISIONS = 30;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +    public static final int THEME_LIGHT = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +    public static final int THEME_DARK = 1;</span>
  85  
  86      private Note mNote;
  87      private Bucket&lt;Note&gt; mNotesBucket;
  88  
  89      private SimplenoteEditText mContentEditText;
  90      private TagsMultiAutoCompleteTextView mTagView;
  91      private PopupWindow mInfoPopupWindow;
  92      private View mHistoryView;
  93      private SeekBar mHistorySeekBar;
  94      private BottomSheet mBottomSheet;
  95      private TextView mHistoryDate;
  96  
  97      private ToggleButton mPinButton;
  98  
  99      private Handler mAutoSaveHandler;
 100      private Handler mPublishTimeoutHandler;

 101  
 102      private LinearLayout mPlaceholderView;
 103      private CursorAdapter mAutocompleteAdapter;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -    private boolean mIsNewNote, mIsLoadingNote, mDidTapHistoryButton;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 105 +    private boolean mIsNewNote, mIsLoadingNote, mDidTapHistoryButton, mIsMarkdownEnabled, mIsMarkdownEnabledGlobal;"> 105 +    private boolean mIsNewNote, mIsLoadingNote, mDidTapHistoryButton, mIsMarkdownEnabled, mIsMarkdownEnabledGlobalðŸ”µ</abbr></span>
 106      private ActionMode mActionMode;
 107      private MenuItem mViewLinkMenuItem;
 108      private String mLinkUrl;
 109      private String mLinkText;
 110      private MatchOffsetHighlighter mHighlighter;
 111      private int mEmailIconResId, mWebIconResId, mMapIconResId, mCallIconResId;

 112      private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
 113      private String mMatchOffsets;
 114      private int mCurrentCursorPosition;
 115      private ArrayList&lt;Note&gt; mNoteRevisionsList;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +    private NoteMarkdownFragment mNoteMarkdownFragment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +    private String mCss;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +    private WebView mMarkdown;</span>




 119  
 120      /**
 121       * Mandatory empty constructor for the fragment manager to instantiate the
 122       * fragment (e.g. upon screen orientation changes).
 123       */
 124      public NoteEditorFragment() {
 125      }
 126  
 127      @Override
 128      public void onCreate(Bundle savedInstanceState) {
 129          super.onCreate(savedInstanceState);
 130  
 131          if (getActivity() != null) {
 132              Simplenote currentApp = (Simplenote) getActivity().getApplication();
 133              mNotesBucket = currentApp.getNotesBucket();
 134  
<abbr title=" 135              TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionBarIconWeb, R.attr.actionBarIconMap, R.attr.actionBarIconCall});"> 135              TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionðŸ”µ</abbr>
 136              if (a != null) {
 137                  mEmailIconResId = a.getResourceId(0, 0);
 138                  mWebIconResId = a.getResourceId(1, 0);
 139                  mMapIconResId = a.getResourceId(2, 0);
 140                  mCallIconResId = a.getResourceId(3, 0);
 141                  a.recycle();
 142              }
 143          }






 144  
 145          mAutoSaveHandler = new Handler();
 146          mPublishTimeoutHandler = new Handler();



 147  
 148          mMatchHighlighter = new TextHighlighter(getActivity(),
 149                  R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);
 150          mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0) {
 151              @Override
 152              public View newView(Context context, Cursor cursor, ViewGroup parent) {
 153                  Activity activity = (Activity) context;
 154                  if (activity == null) return null;
 155                  return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 156              }
 157  
 158              @Override
 159              public void bindView(View view, Context context, Cursor cursor) {
 160                  TextView textView = (TextView) view;
 161                  textView.setText(convertToString(cursor));
 162              }
 163  
 164              @Override
 165              public CharSequence convertToString(Cursor cursor){
 166                  return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 167              }
 168  
 169              @Override
 170              public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 171                  Activity activity = getActivity();
 172                  if (activity == null) return null;
 173                  Simplenote application = (Simplenote) activity.getApplication();
 174                  Query&lt;Tag&gt; query = application.getTagsBucket().query();
 175                  // make the tag name available to the cursor
 176                  query.include(Tag.NAME_PROPERTY);
 177                  // sort the tags by their names
 178                  query.order(Tag.NAME_PROPERTY);
 179                  // if there&#x27;s a filter string find only matching tag names
<abbr title=" 180                  if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 180                  if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%ðŸ”µ</abbr>
 181                  return query.execute();
 182              }
 183          };
 184      }
 185  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -</span>
 187      @Override
 188      public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 189          setHasOptionsMenu(true);
 190          View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 191          mContentEditText = ((SimplenoteEditText) rootView.findViewById(R.id.note_content));
 192          mContentEditText.addOnSelectionChangedListener(this);
 193          mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 194          mTagView.setTokenizer(new SpaceTokenizer());
 195          mTagView.setOnFocusChangeListener(this);
 196  
 197          mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 198  
 199          mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
 200          mPinButton.setOnClickListener(new View.OnClickListener() {
 201              @Override
 202              public void onClick(View v) {
 203                  if (mPinButton.isChecked()) {
 204                      // Friendly message to the user as to what this button does.
 205                      Toast.makeText(getActivity(), R.string.note_pinned, Toast.LENGTH_SHORT).show();
 206                  }
 207              }
 208          });
 209  
 210          mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
 211          if (DisplayUtils.isLargeScreenLandscape(getActivity()) &amp;&amp; mNote == null) {
 212              mPlaceholderView.setVisibility(View.VISIBLE);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +            mMarkdown = (WebView) rootView.findViewById(R.id.markdown);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +            switch (PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_THEME, THEME_LIGHT)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +                case THEME_DARK:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +                    mCss = &quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;dark.css\&quot; /&gt;&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +                    break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +                case THEME_LIGHT:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +                    mCss = &quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;light.css\&quot; /&gt;&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +                    break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +            }</span>
 223          }
 224  
 225          mTagView.setAdapter(mAutocompleteAdapter);
 226  
 227          // Load note if we were passed a note Id
 228          Bundle arguments = getArguments();
 229          if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
 230              String key = arguments.getString(ARG_ITEM_ID);
 231              if (arguments.containsKey(ARG_MATCH_OFFSETS)) {
 232                  mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);
 233              }
 234              new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
 235              setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));
 236          }
 237  
 238  		return rootView;
 239  	}
 240  
 241      @Override
 242      public void onResume() {
 243          super.onResume();
 244          mNotesBucket.start();
 245          mNotesBucket.addListener(this);
 246  
 247          mTagView.setOnTagAddedListener(this);
 248  
 249          if (mContentEditText != null) {
<abbr title=" 250              mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_FONT_SIZE, 18));"> 250              mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), PrefUtilsðŸ”µ</abbr>

 251          }
 252      }
 253  
 254      @Override
 255      public void onPause() {
 256          mNotesBucket.removeListener(this);
 257          // Hide soft keyboard if it is showing...
 258          if (getActivity() != null) {
<abbr title=" 259              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 259              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INðŸ”µ</abbr>
 260              if (inputMethodManager != null) {
 261                  inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 262              }
 263          }
 264  
 265          // Delete the note if it is new and has empty fields
 266          if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty()) {
 267              mNote.delete();
 268          } else {
 269              saveNote();
 270          }
 271  
 272          mTagView.setOnTagAddedListener(null);
 273  
 274          if (mAutoSaveHandler != null) {
 275              mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 276          }
 277  
 278          if (mPublishTimeoutHandler != null) {
 279              mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 280          }
 281  




 282          mHighlighter.stop();
 283  
 284          super.onPause();
 285      }
 286  
 287      @Override
 288      public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -        if (!isAdded() || DisplayUtils.isLargeScreenLandscape(getActivity())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +        if (!isAdded() || DisplayUtils.isLargeScreenLandscape(getActivity()) &amp;&amp; mNoteMarkdownFragment == null) {</span>
 291              return;
 292          }
 293  
 294          inflater.inflate(R.menu.note_editor, menu);
 295  
 296          if (mNote != null) {
 297              MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_view_info);
 298              viewPublishedNoteItem.setVisible(true);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +            if (mIsMarkdownEnabledGlobal) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +                MenuItem markdownEnableItem = menu.findItem(R.id.menu_markdown_enable);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +                markdownEnableItem.setChecked(mNote.isMarkdownEnabled());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +                markdownEnableItem.setVisible(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +            }</span>
 305  
 306              MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 307              if (mNote.isDeleted())
 308                  trashItem.setTitle(R.string.undelete);
 309              else
 310                  trashItem.setTitle(R.string.delete);
 311          }
 312  


 313          super.onCreateOptionsMenu(menu, inflater);
 314      }
 315  
 316      @Override
 317      public boolean onOptionsItemSelected(MenuItem item) {
 318          switch (item.getItemId()) {
 319              case R.id.menu_view_info:
 320                  if (mNote != null) {
 321                      View menuItemView = getActivity().findViewById(R.id.menu_view_info);
 322                      showInfoPopup(menuItemView);
 323                  }





 324                  return true;
 325              case R.id.menu_share:
 326                  if (mNote != null) {
 327                      Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 328                      shareIntent.setType(&quot;text/plain&quot;);
 329                      shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mNote.getContent());
<abbr title=" 330                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 330                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note))ðŸ”µ</abbr>
 331                      AnalyticsTracker.track(
 332                              AnalyticsTracker.Stat.EDITOR_NOTE_CONTENT_SHARED,
 333                              AnalyticsTracker.CATEGORY_NOTE,
 334                              &quot;action_bar_share_button&quot;
 335                      );
 336                  }

 337                  return true;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +            case R.id.menu_markdown_enable:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +                mIsMarkdownEnabled = !item.isChecked();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +                item.setChecked(mIsMarkdownEnabled);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +                if (mIsMarkdownEnabled) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +                    ((NoteEditorActivity) getActivity()).showTabs();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +                    if (mNoteMarkdownFragment == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +                        // Get markdown fragment and update content</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +                        mNoteMarkdownFragment =</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +                                ((NoteEditorActivity) getActivity()).getNoteMarkdownFragment();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +                        mNoteMarkdownFragment.updateMarkdown(getNoteContentString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +                    ((NoteEditorActivity) getActivity()).hideTabs();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +                return true;</span>
 356              case R.id.menu_delete:
 357                  if (!isAdded()) return false;
 358  
 359                  if (mNote != null) {
 360                      mNote.setDeleted(!mNote.isDeleted());
 361                      mNote.setModificationDate(Calendar.getInstance());
 362                      mNote.save();
 363                      Intent resultIntent = new Intent();
 364                      if (mNote.isDeleted()) {
 365                          resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());
 366                      }
 367                      getActivity().setResult(Activity.RESULT_OK, resultIntent);
 368  
 369                      AnalyticsTracker.track(
 370                              AnalyticsTracker.Stat.EDITOR_NOTE_DELETED,
 371                              AnalyticsTracker.CATEGORY_NOTE,
 372                              &quot;trash_menu_item&quot;
 373                      );
 374                  }
 375  
 376                  getActivity().finish();

 377                  return true;
 378              case android.R.id.home:
 379                  if (!isAdded()) return false;
 380  
 381                  getActivity().finish();
 382                  return true;
 383              default:
 384                  return super.onOptionsItemSelected(item);
 385          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +    protected void clearMarkdown() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +        mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss + &quot;&quot;, &quot;text/html&quot;, &quot;utf-8&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +    protected void hideMarkdown() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +        mMarkdown.setVisibility(View.INVISIBLE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 395 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 396 +    protected void showMarkdown() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 397 +        mMarkdown.setVisibility(View.VISIBLE);</span>
 398      }
 399  
 400      // show a popup view from the info action bar item
 401      private void showInfoPopup(View view) {
 402          if (!isAdded() || view == null) return;
 403  
 404          if (mInfoPopupWindow == null) {
 405              mInfoPopupWindow = new PopupWindow(getActivity());
 406              mInfoPopupWindow.setWidth(WindowManager.LayoutParams.WRAP_CONTENT);
 407              mInfoPopupWindow.setHeight(WindowManager.LayoutParams.WRAP_CONTENT);
 408              mInfoPopupWindow.setBackgroundDrawable(new ColorDrawable(0));
 409              mInfoPopupWindow.setOutsideTouchable(true);
 410              mInfoPopupWindow.setFocusable(true);
 411  
 412              LayoutInflater inflater = LayoutInflater.from(getActivity());
 413              View popupView = inflater.inflate(R.layout.popup_info, null);
 414              mInfoPopupWindow.setContentView(popupView);
 415          }
 416  
 417          updateInfoPopup();
 418  
 419          mInfoPopupWindow.showAsDropDown(view);
 420  
 421          // Request revisions for the current note
 422          mNotesBucket.getRevisions(mNote, MAX_REVISIONS, mRevisionsRequestCallbacks);
 423      }
 424  
 425      // update the content of the popupview
 426      private void updateInfoPopup() {
 427          if (mInfoPopupWindow == null || mInfoPopupWindow.getContentView() == null) return;
 428  
 429          View popupView = mInfoPopupWindow.getContentView();
 430  
 431          View publishButton = popupView.findViewById(R.id.publish_note_button);
 432          TextView publishButtonTextView = (TextView)popupView.findViewById(R.id.publish_note_button_text);
 433          ImageView publishButtonIcon = (ImageView)popupView.findViewById(R.id.publish_note_button_icon);
 434          TextView publishTextView = (TextView) popupView.findViewById(R.id.publish_url_textview);
 435          TextView wordCountTextView = (TextView) popupView.findViewById(R.id.word_count);
 436          ImageButton publishCopyButton = (ImageButton) popupView.findViewById(R.id.publish_copy_url);
 437          ImageButton publishShareButton = (ImageButton) popupView.findViewById(R.id.publish_share_url);
 438          View actionsView = popupView.findViewById(R.id.publish_actions);
 439          final View historyButton = popupView.findViewById(R.id.history_button);
 440  
 441          final ViewSwitcher viewSwitcher = (ViewSwitcher) popupView.findViewById(R.id.publish_view_switcher);
 442  
 443          publishButton.setOnClickListener(new View.OnClickListener() {
 444              @Override
 445              public void onClick(View v) {
 446                  if (mNote != null) {
 447                      boolean newPublishedStatus = !mNote.isPublished();
 448                      mNote.setPublished(newPublishedStatus);
 449                      mNote.save();
 450  
 451                      if (viewSwitcher.getDisplayedChild() == 0) {
 452                          viewSwitcher.showNext();
 453                      }
 454  
 455                      // reset publish status in 20 seconds if we don&#x27;t hear back from Simperium
 456                      mPublishTimeoutHandler.postDelayed(mPublishTimeoutRunnable, 20000);
 457  
 458                      AnalyticsTracker.track(
 459                              (newPublishedStatus) ? AnalyticsTracker.Stat.EDITOR_NOTE_PUBLISHED :
 460                              AnalyticsTracker.Stat.EDITOR_NOTE_UNPUBLISHED,
 461                              AnalyticsTracker.CATEGORY_NOTE,
 462                              &quot;publish_note_button&quot;
 463                      );
 464                  }
 465              }
 466          });
 467  
 468          publishTextView.setOnClickListener(new View.OnClickListener() {
 469              @Override
 470              public void onClick(View v) {
 471                  try {
 472                      startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(mNote.getPublishedUrl())));
 473                      AnalyticsTracker.track(
 474                              AnalyticsTracker.Stat.EDITOR_NOTE_PUBLISHED_URL_PRESSED,
 475                              AnalyticsTracker.CATEGORY_NOTE,
 476                              &quot;publish_note_url_button&quot;
 477                      );
 478                  } catch (Exception e) {
 479                      e.printStackTrace();
 480                  }
 481              }
 482          });
 483  
 484          publishCopyButton.setOnClickListener(new View.OnClickListener() {
 485              @Override
 486              public void onClick(View v) {
<abbr title=" 487                  ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 487                  ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SðŸ”µ</abbr>
 488                  ClipData clip = ClipData.newPlainText(getString(R.string.app_name), mNote.getPublishedUrl());
 489                  clipboard.setPrimaryClip(clip);
 490                  Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();
 491              }
 492          });
 493  
 494          publishShareButton.setOnClickListener(new View.OnClickListener() {
 495              @Override
 496              public void onClick(View v) {
 497                  Intent i = new Intent(Intent.ACTION_SEND);
 498                  i.setType(&quot;text/plain&quot;);
 499                  i.putExtra(Intent.EXTRA_TEXT, mNote.getPublishedUrl());
 500                  startActivity(Intent.createChooser(i, getString(R.string.share_url)));
 501              }
 502          });
 503  
 504          updateWordCount(wordCountTextView);
 505  
 506          if (mNote.isPublished()) {
 507              publishButtonTextView.setText(getString(R.string.published));
 508              publishButtonIcon.setVisibility(View.VISIBLE);
 509              publishTextView.setText(mNote.getPublishedUrl());
 510              actionsView.setVisibility(View.VISIBLE);
 511          } else {
 512              publishButtonTextView.setText(getString(R.string.publish));
 513              publishButtonIcon.setVisibility(View.GONE);
 514              actionsView.setVisibility(View.GONE);
 515          }
 516  
 517          Simplenote currentApp = (Simplenote) getActivity().getApplication();
 518          if (currentApp.getSimperium().needsAuthorization()) {
 519              viewSwitcher.setVisibility(View.GONE);
 520          } else {
 521              viewSwitcher.setVisibility(View.VISIBLE);
 522              if (viewSwitcher.getDisplayedChild() == 1) {
 523                  viewSwitcher.showPrevious();
 524              }
 525          }
 526  
 527          historyButton.setEnabled(mNote.getVersion() &gt; 1);
 528          if (historyButton.isEnabled()) {
 529              historyButton.setAlpha(1.0f);
 530          } else {
 531              historyButton.setAlpha(0.5f);
 532          }
 533  
 534          historyButton.setOnClickListener(new View.OnClickListener() {
 535              @Override
 536              public void onClick(View view) {
 537                  saveNote();
 538                  showHistorySheet();
 539              }
 540          });


















































 541      }
 542  
 543      private boolean noteIsEmpty() {
 544          return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 545      }
 546  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 547 +    protected void setMarkdownEnabled(boolean enabled) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 548 +        mIsMarkdownEnabled = enabled;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 549 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 550 +        if (mIsMarkdownEnabled) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 551 +            mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 552 +                    new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 553 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 554 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 555 +</span>
 556      public void setNote(String noteID){
 557          setNote(noteID, null);
 558      }
 559  
 560      public void setNote(String noteID, String matchOffsets) {
 561          if (mAutoSaveHandler != null)
 562              mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 563  
 564          mPlaceholderView.setVisibility(View.GONE);
 565  
 566          if (matchOffsets != null) {
 567              mMatchOffsets = matchOffsets;
 568          } else {
 569              mMatchOffsets = null;
 570          }
 571  
 572          // If we have a note already (on a tablet in landscape), save the note.
 573          if (mNote != null) {
 574              if (mIsNewNote &amp;&amp; noteIsEmpty())
 575                  mNote.delete();
 576              else if (mNote != null)
 577                  saveNote();
 578          }
 579  
 580          new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 581      }
 582  
 583      private void updateNote(Note updatedNote) {
 584          // update note if network change arrived
 585          mNote = updatedNote;
 586          refreshContent(true);
 587      }
 588  
 589      private void refreshContent(boolean isNoteUpdate) {
 590          if (mNote != null) {
 591              // Restore the cursor position if possible.
 592  
<abbr title=" 593              int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 593              int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.geðŸ”µ</abbr>
 594  
 595              mContentEditText.setText(mNote.getContent());
 596  
 597              if (isNoteUpdate) {
 598                  // Save the note so any local changes get synced
 599                  mNote.save();
 600  
 601                  if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) {
 602                      mContentEditText.setSelection(cursorPosition);
 603                  }
 604              }
 605  
 606              afterTextChanged(mContentEditText.getText());
 607  
 608              mPinButton.setChecked(mNote.isPinned());
 609  
 610              updateTagList();
 611          }
 612      }
 613  
 614      private void updateTagList() {
 615          Activity activity = getActivity();
 616          if (activity == null) return;
 617  
 618          // Populate this note&#x27;s tags in the tagView
 619          mTagView.setChips(mNote.getTagString());
 620      }
 621  
 622      private int newCursorLocation(String newText, String oldText, int cursorLocation) {
 623          // Ported from the iOS app :)
 624          // Cases:
 625          // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 626          // 1. Text was added after the cursor ==&gt; no change
 627          // 2. Text was added before the cursor ==&gt; location advances
 628          // 3. Text was removed after the cursor ==&gt; no change
 629          // 4. Text was removed before the cursor ==&gt; location retreats
 630          // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 631  
 632          int newCursorLocation = cursorLocation;
 633  
 634          int deltaLength = newText.length() - oldText.length();
 635  
 636          // Case 0
 637          if (newText.length() &lt; cursorLocation)
 638              return newText.length();
 639  
 640          boolean beforeCursorMatches = false;
 641          boolean afterCursorMatches = false;
 642  
 643          try {
<abbr title=" 644              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 644              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation)ðŸ”µ</abbr>
<abbr title=" 645              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 645              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursðŸ”µ</abbr>
 646          } catch (Exception e) {
 647              e.printStackTrace();
 648          }
 649  
 650          // Cases 2 and 4
 651          if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 652              newCursorLocation += deltaLength;
 653  
 654          // Cases 1, 3 and 5 have no change
 655          return newCursorLocation;
 656      }
 657  
 658      private final Runnable mAutoSaveRunnable = new Runnable() {
 659          @Override
 660          public void run() {
 661              saveAndSyncNote();
 662          }
 663      };
 664  
 665      @Override
 666      public void onTagsChanged(String tagString) {
 667          if (mNote == null || !isAdded()) return;
 668  
 669          if (mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length()) {
 670              AnalyticsTracker.track(
 671                      AnalyticsTracker.Stat.EDITOR_TAG_ADDED,
 672                      AnalyticsTracker.CATEGORY_NOTE,
 673                      &quot;tag_added_to_note&quot;
 674              );
 675          }
 676          else {
 677              AnalyticsTracker.track(
 678                      AnalyticsTracker.Stat.EDITOR_TAG_REMOVED,
 679                      AnalyticsTracker.CATEGORY_NOTE,
 680                      &quot;tag_removed_from_note&quot;
 681              );
 682          }
 683  
 684          mNote.setTagString(tagString);
 685          mNote.setModificationDate(Calendar.getInstance());
 686          updateTagList();
 687          mNote.save();
 688      }
 689  
 690      @Override
 691      public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 692          // Unused
 693      }
 694  
 695      @Override
 696      public void afterTextChanged(Editable editable) {
 697          setTitleSpan(editable);
 698          attemptAutoList(editable);






 699      }
 700  
 701      @Override
 702      public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 703  
 704          // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 705          if (mAutoSaveHandler != null) {
 706              mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 707              mAutoSaveHandler.postDelayed(mAutoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 708          }
 709  
 710          // Remove search highlight spans when note content changes
 711          if (mMatchOffsets != null) {
 712              mMatchOffsets = null;
 713              mHighlighter.removeMatches();
 714          }
 715      }
 716  
 717      private void setTitleSpan(Editable editable) {
 718          // Set the note title to be a larger size
 719          // Remove any existing size spans
 720          RelativeSizeSpan spans[] = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 721          for (RelativeSizeSpan span : spans) {
 722              editable.removeSpan(span);
 723          }
 724          int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 725          if (newLinePosition == 0)
 726              return;
<abbr title=" 727          editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 727          editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.lengtðŸ”µ</abbr>











 728      }
 729  
 730      private void attemptAutoList(Editable editable) {
 731          int oldCursorPosition = mCurrentCursorPosition;
 732          mCurrentCursorPosition = mContentEditText.getSelectionStart();
 733          AutoBullet.apply(editable, oldCursorPosition, mCurrentCursorPosition);
 734          mCurrentCursorPosition = mContentEditText.getSelectionStart();
 735      }
 736  
 737      private void saveAndSyncNote() {
 738          if (mNote == null) {
 739              return;
 740          }
 741  
 742          new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 743      }
 744  
 745      public void setPlaceholderVisible(boolean isVisible) {
 746          if (isVisible) {
 747              mNote = null;
 748              mContentEditText.setText(&quot;&quot;);
 749              mTagView.setText(&quot;&quot;);
 750              if (mPlaceholderView != null)
 751                  mPlaceholderView.setVisibility(View.VISIBLE);
 752          } else {
 753              if (mPlaceholderView != null)
 754                  mPlaceholderView.setVisibility(View.GONE);
 755          }
 756      }
 757  
 758      public void setIsNewNote(boolean isNewNote) {
 759          this.mIsNewNote = isNewNote;
 760      }
 761  
 762      @Override
 763      public void onFocusChange(View v, boolean hasFocus) {
 764          if (!hasFocus) {
 765              String tagString = getNoteTagsString().trim();
 766              if (tagString.length() &gt; 0) {
 767                  mTagView.setChips(tagString);
 768              }
 769          }
 770      }
 771  
 772      private Note getNote() {
 773          return mNote;
 774      }
 775  
 776      private String getNoteContentString() {
 777          if (mContentEditText == null || mContentEditText.getText() == null) {
 778              return &quot;&quot;;
 779          } else {
 780              return mContentEditText.getText().toString();
 781          }
 782      }
 783  
 784      private String getNoteTagsString() {
 785          if (mTagView == null || mTagView.getText() == null) {
 786              return &quot;&quot;;
 787          } else {
 788              return mTagView.getText().toString();
 789          }

























































































 790      }
 791  
 792      private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 793  
 794          @Override
 795          protected void onPreExecute() {
 796              mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 797              mIsLoadingNote = true;
 798          }
 799  
 800          @Override
 801          protected Void doInBackground(String... args) {
 802              if (getActivity() == null) {
 803                  return null;
 804              }
 805  
 806              String noteID = args[0];
 807              Simplenote application = (Simplenote) getActivity().getApplication();
 808              Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 809              try {
 810                  mNote = notesBucket.get(noteID);
 811                  // Set the current note in NotesActivity when on a tablet
 812                  if (getActivity() instanceof NotesActivity) {
 813                      ((NotesActivity) getActivity()).setCurrentNote(mNote);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 814 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 815 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 816 +                // Set markdown flag for global setting</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 817 +                mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_MARKDOWN_ENABLED, false);"> 817 +                mIsMarkdownEnabledGlobal = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_MARKDOWN_ENABLED, fðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 818 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 819 +                // Set markdown flag for current note</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 820 +                if (mNote != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 821 +                    mIsMarkdownEnabled = mNote.isMarkdownEnabled();</span>
 822                  }
 823              } catch (BucketObjectMissingException e) {
 824                  // TODO: Handle a missing note
 825              }
 826              return null;
 827          }
 828  
 829          @Override
 830          protected void onPostExecute(Void nada) {
 831              if (getActivity() == null || getActivity().isFinishing())
 832                  return;
 833              refreshContent(false);
 834              if (mMatchOffsets != null) {
<abbr title=" 835                  int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);"> 835                  int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROðŸ”µ</abbr>
 836                  mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
 837              }
 838              mContentEditText.addTextChangedListener(NoteEditorFragment.this);
 839              if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 840                  // Show soft keyboard
 841                  mContentEditText.requestFocus();
 842                  new Handler().postDelayed(new Runnable() {
 843                      @Override
 844                      public void run() {
<abbr title=" 845                          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 845                          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemServicðŸ”µ</abbr>
 846                          if (inputMethodManager != null)
 847                              inputMethodManager.showSoftInput(mContentEditText, 0);
 848                      }
 849                  }, 100);
 850  
 851              }
 852  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 853 +            // Show tabs if markdown is enabled globally, for current note, and not tablet landscape</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 854 +            if (mIsMarkdownEnabledGlobal &amp;&amp; mIsMarkdownEnabled) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 855 +                // Get markdown view and update content</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 856 +                if (DisplayUtils.isLargeScreenLandscape(getActivity())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 857 +                    mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 858 +                            new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 859 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 860 +                    mNoteMarkdownFragment =</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 861 +                            ((NoteEditorActivity) getActivity()).getNoteMarkdownFragment();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 862 +                    mNoteMarkdownFragment.updateMarkdown(getNoteContentString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 863 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 864 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 865 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 866 +            getActivity().invalidateOptionsMenu();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 867 +</span>
 868              SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 869  
 870              mIsLoadingNote = false;
 871          }
 872      }
 873  
 874      private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
 875  
 876          @Override
 877          protected Void doInBackground(Void... args) {
 878              saveNote();
 879              return null;
 880          }
 881  
 882          @Override
 883          protected void onPostExecute(Void nada) {
 884              if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {
 885                  // Update links
 886                  SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 887 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 888 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 889 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 890 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 891 -    private void saveNote() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 892 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 893 +                // Update markdown fragment</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 894 +                if (DisplayUtils.isLargeScreenLandscape(getActivity())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 895 +                    mMarkdown.loadDataWithBaseURL(&quot;file:///android_asset/&quot;, mCss +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 896 +                            new AndDown().markdownToHtml(getNoteContentString()), &quot;text/html&quot;, &quot;utf-8&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 897 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 898 +                    mNoteMarkdownFragment.updateMarkdown(getNoteContentString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 899 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 900 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 901 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 902 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 903 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 904 +    protected void saveNote() {</span>
 905          if (mNote == null || (mBottomSheet != null &amp;&amp; mBottomSheet.isShowing())) {

 906              return;
 907          }
 908  
 909          String content = getNoteContentString();
 910          String tagString = getNoteTagsString();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 911 -        if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 912 +        if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked(), mIsMarkdownEnabled)) {</span>
 913              mNote.setContent(content);
 914              mNote.setTagString(tagString);
 915              mNote.setModificationDate(Calendar.getInstance());
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 916 +            mNote.setMarkdownEnabled(mIsMarkdownEnabled);</span>
 917              // Send pinned event to google analytics if changed
 918              mNote.setPinned(mPinButton.isChecked());
 919              mNote.save();
 920              if (getActivity() != null) {
 921                  if (mNote.isPinned() != mPinButton.isChecked()) {
 922                      AnalyticsTracker.track(
 923                              mPinButton.isChecked() ? AnalyticsTracker.Stat.EDITOR_NOTE_PINNED :
 924                                      AnalyticsTracker.Stat.EDITOR_NOTE_UNPINNED,
 925                              AnalyticsTracker.CATEGORY_NOTE,
 926                              &quot;pin_button&quot;
 927                      );
 928                  }
 929  
 930                  AnalyticsTracker.track(
 931                          AnalyticsTracker.Stat.EDITOR_NOTE_EDITED,
 932                          AnalyticsTracker.CATEGORY_NOTE,
 933                          &quot;editor_save&quot;
 934                  );
 935              }






 936          }
 937      }
 938  
 939      // Contextual action bar for dealing with links
 940      private final ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
 941  
 942          // Called when the action mode is created; startActionMode() was called
 943          @Override
 944          public boolean onCreateActionMode(ActionMode mode, Menu menu) {
 945              // Inflate a menu resource providing context menu items
 946              MenuInflater inflater = mode.getMenuInflater();
 947              if (inflater != null) {
 948                  inflater.inflate(R.menu.view_link, menu);
 949                  mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
 950                  mode.setTitle(getString(R.string.link));
 951                  if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
 952                      mode.setTitleOptionalHint(false);
 953                  }


 954              }
 955              return true;
 956          }
 957  
 958          // Called each time the action mode is shown. Always called after onCreateActionMode, but
 959          // may be called multiple times if the mode is invalidated.
 960          @Override
 961          public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 962              return false; // Return false if nothing is done
 963          }
 964  
 965          // Called when the user selects a contextual menu item
 966          @Override
 967          public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 968              switch (item.getItemId()) {
 969                  case R.id.menu_view_link:
 970                      if (mLinkUrl != null) {
 971                          try {
 972                              Uri uri = Uri.parse(mLinkUrl);
 973                              Intent i = new Intent(Intent.ACTION_VIEW);
 974                              i.setData(uri);
 975                              startActivity(i);
 976                          } catch (Exception e) {
 977                              e.printStackTrace();
 978                          }
 979                          mode.finish(); // Action picked, so close the CAB
 980                      }
 981                      return true;
 982                  case R.id.menu_copy:
 983                      if (mLinkText != null &amp;&amp; getActivity() != null) {
<abbr title=" 984                          ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 984                          ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPðŸ”µ</abbr>
 985                          ClipData clip = ClipData.newPlainText(getString(R.string.app_name),mLinkText);
 986                          clipboard.setPrimaryClip(clip);

 987                          Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();
 988                          mode.finish();
 989                      }
 990                      return true;
 991                  case R.id.menu_share:
 992                      if (mLinkText != null) {
 993                          try {
 994                              Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 995                              shareIntent.setType(&quot;text/plain&quot;);
 996                              shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mLinkText);
<abbr title=" 997                              startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 997                              startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.sharðŸ”µ</abbr>
 998                          } catch (Exception e) {
 999                              e.printStackTrace();
1000                          }

1001                          mode.finish();
1002                      }
1003                      return true;
1004                  default:
1005                      return false;
1006              }
1007          }
1008  
1009          // Called when the user exits the action mode
1010          @Override
1011          public void onDestroyActionMode(ActionMode mode) {
1012              mActionMode = null;
1013          }
1014      };
1015  
1016      // Checks if cursor is at a URL when the selection changes
1017      // If it is a URL, show the contextual action bar
1018      @Override
1019      public void onSelectionChanged(int selStart, int selEnd) {
1020          if (selStart == selEnd) {
1021              Editable noteContent = mContentEditText.getText();
1022              if (noteContent == null)
1023                  return;
1024  
1025              URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
1026              if (urlSpans.length &gt; 0) {
1027                  URLSpan urlSpan = urlSpans[0];
1028                  mLinkUrl = urlSpan.getURL();
<abbr title="1029                  mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();">1029                  mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSðŸ”µ</abbr>
1030                  if (mActionMode != null) {
1031                      mActionMode.setSubtitle(mLinkText);
1032                      setLinkMenuItem();
1033                      return;
1034                  }
1035  
1036                  // Show the Contextual Action Bar
1037                  if (getActivity() != null) {
1038                      mActionMode = ((AppCompatActivity)getActivity()).startSupportActionMode(mActionModeCallback);
1039                      if (mActionMode != null) {
1040                          mActionMode.setSubtitle(mLinkText);
1041                      }
1042  
1043                      setLinkMenuItem();
1044                  }
1045              } else if (mActionMode != null) {
1046                  mActionMode.finish();
1047                  mActionMode = null;
1048              }
1049          } else if (mActionMode != null) {
1050              mActionMode.finish();
1051              mActionMode = null;
1052          }
1053      }
1054  
1055      private void setLinkMenuItem() {
1056          if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
1057              if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
1058                  mViewLinkMenuItem.setIcon(mCallIconResId);

1059                  mViewLinkMenuItem.setTitle(getString(R.string.call));
1060              } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
1061                  mViewLinkMenuItem.setIcon(mEmailIconResId);

1062                  mViewLinkMenuItem.setTitle(getString(R.string.email));
1063              } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
1064                  mViewLinkMenuItem.setIcon(mMapIconResId);

1065                  mViewLinkMenuItem.setTitle(getString(R.string.view_map));
1066              } else {
1067                  mViewLinkMenuItem.setIcon(mWebIconResId);

1068                  mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
1069              }
1070          }
1071      }
1072  
1073      // Resets note publish status if Simperium never returned the new publish status
1074      private final Runnable mPublishTimeoutRunnable = new Runnable() {
1075          @Override
1076          public void run() {
1077              if (!isAdded()) return;
1078  
1079              getActivity().runOnUiThread(new Runnable() {
1080                  @Override
1081                  public void run() {
1082                      Toast.makeText(
1083                              getActivity(),
1084                              mNote.isPublished() ? R.string.publish_error : R.string.unpublish_error,
1085                              Toast.LENGTH_SHORT
1086                      ).show();
1087  
1088                      mNote.setPublished(!mNote.isPublished());
1089                      mNote.save();
1090  
1091                      if (mInfoPopupWindow != null &amp;&amp; mInfoPopupWindow.isShowing()) {
<abbr title="1092                          ViewSwitcher viewSwitcher = (ViewSwitcher)mInfoPopupWindow.getContentView().findViewById(R.id.publish_view_switcher);">1092                          ViewSwitcher viewSwitcher = (ViewSwitcher)mInfoPopupWindow.getContentView().findViewById(RðŸ”µ</abbr>
1093                          if (viewSwitcher.getDisplayedChild() == 1) {
1094                              viewSwitcher.showPrevious();
1095                          }





















1096                      }
1097                  }
1098              });
1099  
1100          }
1101      };
1102  
1103      private void updateWordCount(TextView textView) {
1104          String content = getNoteContentString();
1105  
1106          if (content == null || textView == null) return;
1107  
1108          int numWords = (content.trim().length() == 0) ? 0 : content.trim().split(&quot;([\\W]+)&quot;).length;
1109  
1110          String wordCountString = getResources().getQuantityString(R.plurals.word_count, numWords);
1111          String formattedWordCount = NumberFormat.getInstance().format(numWords);
1112  
1113          textView.setText(formattedWordCount + &quot; &quot; + wordCountString);
1114      }
1115  
1116      /**
1117       * History methods
1118       */





































































































1119      private void showHistorySheet() {
1120          mContentEditText.clearFocus();
1121          mHistoryView = LayoutInflater.from(getActivity()).inflate(R.layout.history_view, null, false);
1122          mHistoryDate = (TextView)mHistoryView.findViewById(R.id.history_date);
1123          mHistorySeekBar = (SeekBar) mHistoryView.findViewById(R.id.seek_bar);
1124          mHistorySeekBar.setOnSeekBarChangeListener(new SeekBar.OnSeekBarChangeListener() {
1125              @Override
1126              public void onProgressChanged(SeekBar seekBar, int progress, boolean fromUser) {
1127                  if (mNoteRevisionsList == null  || mBottomSheet == null || !mBottomSheet.isShowing()) {
1128                      return;
1129                  }
1130  
1131                  Calendar noteDate = null;
1132                  if (progress == mNoteRevisionsList.size()) {
1133                      mContentEditText.setText(mNote.getContent());
1134                      noteDate = mNote.getModificationDate();
1135                  } else if (progress &lt; mNoteRevisionsList.size() &amp;&amp; mNoteRevisionsList.get(progress) != null) {
1136                      Note revisedNote = mNoteRevisionsList.get(progress);
1137                      noteDate = revisedNote.getModificationDate();
1138                      mContentEditText.setText(revisedNote.getContent());
1139                  }
1140  
1141                  updateHistoryDateText(noteDate);
1142              }
1143  
1144              @Override
1145              public void onStartTrackingTouch(SeekBar seekBar) {
1146                  // noop
1147              }
1148  
1149              @Override
1150              public void onStopTrackingTouch(SeekBar seekBar) {
1151                  // noop
1152              }
1153          });
1154  
1155          View cancelHistoryButton = mHistoryView.findViewById(R.id.cancel_history_button);
1156          cancelHistoryButton.setOnClickListener(new View.OnClickListener() {
1157              @Override
1158              public void onClick(View v) {
1159                  mContentEditText.setText(mNote.getContent());
1160                  if (mBottomSheet != null) {
1161                      mDidTapHistoryButton = true;
1162                      mBottomSheet.dismiss();
1163                  }
1164              }
1165          });
1166  
1167          View restoreHistoryButton = mHistoryView.findViewById(R.id.restore_history_button);
1168          restoreHistoryButton.setOnClickListener(new View.OnClickListener() {
1169              @Override
1170              public void onClick(View v) {
1171                  if (mBottomSheet != null) {
1172                      mDidTapHistoryButton = true;
1173                      mBottomSheet.dismiss();
1174                  }
1175                  saveAndSyncNote();
1176              }
1177          });
1178  
1179          mBottomSheet = new BottomSheet.Builder(getActivity(), R.style.Simplestyle_BottomSheet)
1180                  .setView(mHistoryView)
1181                  .setListener(new BottomSheetListener() {
1182                      @Override
1183                      public void onSheetDismissed(int dismissalType) {
1184                          if (dismissalType == Integer.MIN_VALUE &amp;&amp; !mDidTapHistoryButton) {
1185                              mContentEditText.setText(mNote.getContent());
1186                          }
1187  
1188                          mDidTapHistoryButton = false;
1189                      }
1190  
1191                      @Override
1192                      public void onSheetShown() {}
1193  
1194                      @Override
1195                      public void onSheetItemSelected(MenuItem menuItem) {}
1196                  }).create();
1197  
1198          updateHistoryProgressBar();
1199          mBottomSheet.getWindow().setDimAmount(0.3f);
1200          mBottomSheet.show();
1201          mInfoPopupWindow.dismiss();
1202      }
1203  
1204      private void updateHistoryDateText(Calendar noteDate) {
1205          if (!isAdded() || noteDate == null || mHistoryDate == null) {
1206              return;
1207          }
1208  
1209          long now = Calendar.getInstance().getTimeInMillis();
1210          CharSequence dateText = DateUtils.getRelativeDateTimeString(
1211                  getActivity(),
1212                  noteDate.getTimeInMillis(),
1213                  now,
1214                  0L,
1215                  DateUtils.FORMAT_ABBREV_ALL
1216          );
1217          mHistoryDate.setText(dateText);
1218      }
1219  
1220      private void updateHistoryProgressBar() {
1221          if (mHistorySeekBar == null) return;
1222  
1223          int totalRevs = mNoteRevisionsList == null ? 0 : mNoteRevisionsList.size();
1224          if (totalRevs &gt; 0) {
1225              mHistorySeekBar.setMax(totalRevs);
1226              mHistorySeekBar.setProgress(totalRevs);
1227  
1228              updateHistoryDateText(mNote.getModificationDate());
1229  
1230              mHistoryView.findViewById(R.id.history_loading_view).setVisibility(View.GONE);
1231              mHistoryView.findViewById(R.id.history_slider_view).setVisibility(View.VISIBLE);










1232          }
1233      }
1234  
1235      /**
1236       * Simperium listeners
1237       */
1238  
1239      @Override
1240      public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
1241  
1242      }
1243  
1244      @Override
1245      public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {
1246          if (changeType == Bucket.ChangeType.MODIFY) {
1247              if (getNote() != null &amp;&amp; getNote().getSimperiumKey().equals(key)) {
1248                  try {
1249                      final Note updatedNote = mNotesBucket.get(key);
1250                      if (getActivity() != null) {
1251                          getActivity().runOnUiThread(new Runnable() {
1252                              @Override
1253                              public void run() {
1254                                  if (mPublishTimeoutHandler != null) {
1255                                      mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
1256                                  }
1257  
1258                                  updateNote(updatedNote);
1259                                  updateInfoPopup();

1260                              }
1261                          });
1262                      }
1263                  } catch (BucketObjectMissingException e) {
1264                      e.printStackTrace();
1265                  }
1266              }
1267          }
1268      }
1269  
1270  
1271      @Override
1272      public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
1273          // noop
1274      }
1275  
1276      @Override
1277      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1278          // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
1279          if (mIsLoadingNote)
1280              return;
1281  
1282          Note openNote = getNote();
1283          if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
1284              return;
1285  
1286          note.setContent(getNoteContentString());
1287      }
1288  
1289      private final Bucket.RevisionsRequestCallbacks&lt;Note&gt; mRevisionsRequestCallbacks = new
1290              Bucket.RevisionsRequestCallbacks&lt;Note&gt;() {
1291                  // Note: These callbacks won&#x27;t be running on the main thread
1292                  @Override
1293                  public void onComplete(Map&lt;Integer, Note&gt; revisionsMap) {
1294                      if (!isAdded()) return;
1295  
1296                      // Convert map to an array list, to work better with the 0-index based seekbar
1297                      mNoteRevisionsList = new ArrayList&lt;&gt;(revisionsMap.values());
1298                      getActivity().runOnUiThread(new Runnable() {
1299                          @Override
1300                          public void run() {
1301                              updateHistoryProgressBar();
1302                          }
1303                      });
1304                  }
1305  
1306                  @Override
1307                  public void onRevision(String key, int version, JSONObject object) {}
1308  
1309                  @Override
1310                  public void onError(Throwable exception) {
1311                      if (!isAdded() || mHistoryView == null) return;
1312  
1313                      getActivity().runOnUiThread(new Runnable() {
1314                          @Override
1315                          public void run() {
1316                              mHistoryView.findViewById(R.id.history_progress_bar).setVisibility(View.GONE);
1317                              mHistoryView.findViewById(R.id.history_error_text).setVisibility(View.VISIBLE);
1318                          }
1319                      });
1320                  }
1321              };
1322  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            