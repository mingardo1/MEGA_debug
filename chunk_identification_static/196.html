<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>196</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    196
                    <a href="195.html">prev</a>
                    <a href="197.html">next</a>
                    <a href="196_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_b2a9625a2da1de433a00f59e3aa0231c7d90f5c1_common/src/main/java/org/broadleafcommerce/common/security/service/ExploitProtectionServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;b2a9625a2da1de433a00f59e3aa0231c7d90f5c1:common/src/main/java/org/broadleafcommerce/common/security/service/ExploitProtectionServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;b2a9625a2da1de433a00f59e3aa0231c7d90f5c1^1:common/src/main/java/org/broadleafcommerce/common/security/service/ExploitProtectionServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;b2a9625a2da1de433a00f59e3aa0231c7d90f5c1^2:common/src/main/java/org/broadleafcommerce/common/security/service/ExploitProtectionServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;8813443c29cdb73b52b415dd74478662f71f6324:common/src/main/java/org/broadleafcommerce/common/security/service/ExploitProtectionServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [s]], subset: [[bsj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-4573490878212285276" onmouseenter="enter('-4573490878212285276');" onmouseout="out('-4573490878212285276');" style="">   3  * BroadleafCommerce Common Libraries                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-8883203776714723065" onmouseenter="enter('-8883203776714723065');" onmouseout="out('-8883203776714723065');" style="">  18 package org.broadleafcommerce.common.security.service;                                                   </span>
<span  style="">  19                                                                                                          </span>
<span class="7952073036463698968" onmouseenter="enter('7952073036463698968');" onmouseout="out('7952073036463698968');" style="">  20 import org.apache.commons.lang.StringUtils;                                                              </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  21 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  22 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="5945096539699516699" onmouseenter="enter('5945096539699516699');" onmouseout="out('5945096539699516699');" style="">  23 import org.broadleafcommerce.common.exception.ServiceException;                                          </span>
<span class="3835463558667680002" onmouseenter="enter('3835463558667680002');" onmouseout="out('3835463558667680002');" style="">  24 import org.broadleafcommerce.common.security.RandomGenerator;                                            </span>
<span class="-6556509414411446728" onmouseenter="enter('-6556509414411446728');" onmouseout="out('-6556509414411446728');" style="">  25 import org.broadleafcommerce.common.util.BLCRequestUtils;                                                </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  26 import org.broadleafcommerce.common.web.BroadleafRequestContext;                                         </span>
<span class="-8732799094142472106" onmouseenter="enter('-8732799094142472106');" onmouseout="out('-8732799094142472106');" style="">  27 import org.owasp.validator.html.AntiSamy;                                                                </span>
<span class="-2632485097715966841" onmouseenter="enter('-2632485097715966841');" onmouseout="out('-2632485097715966841');" style="">  28 import org.owasp.validator.html.CleanResults;                                                            </span>
<span class="3991596715890294789" onmouseenter="enter('3991596715890294789');" onmouseout="out('3991596715890294789');" style="">  29 import org.owasp.validator.html.Policy;                                                                  </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  30 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  31 import org.springframework.stereotype.Service;                                                           </span>
<span class="6793981704939320962" onmouseenter="enter('6793981704939320962');" onmouseout="out('6793981704939320962');" style="">  32 import org.springframework.web.context.request.RequestContextHolder;                                     </span>
<span class="-3977424511564612993" onmouseenter="enter('-3977424511564612993');" onmouseout="out('-3977424511564612993');" style="">  33 import org.springframework.web.context.request.ServletRequestAttributes;                                 </span>
<span class="-208569050100229982" onmouseenter="enter('-208569050100229982');" onmouseout="out('-208569050100229982');" style="">  34 import org.springframework.web.context.request.ServletWebRequest;                                        </span>
<span class="6387767356345417225" onmouseenter="enter('6387767356345417225');" onmouseout="out('6387767356345417225');" style="">  35 import org.springframework.web.util.HtmlUtils;                                                           </span>
<span  style="">  36                                                                                                          </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  37 import java.io.IOException;                                                                              </span>
<span class="-5598187278321027129" onmouseenter="enter('-5598187278321027129');" onmouseout="out('-5598187278321027129');" style="">  38 import java.net.URL;                                                                                     </span>
<span class="-5521468699455618699" onmouseenter="enter('-5521468699455618699');" onmouseout="out('-5521468699455618699');" style="">  39 import java.net.URLConnection;                                                                           </span>
<span class="-4333778487385766125" onmouseenter="enter('-4333778487385766125');" onmouseout="out('-4333778487385766125');" style="">  40 import java.net.URLStreamHandler;                                                                        </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  41 import java.security.NoSuchAlgorithmException;                                                           </span>
<span class="2159928926335330273" onmouseenter="enter('2159928926335330273');" onmouseout="out('2159928926335330273');" style="">  42 import java.util.regex.Matcher;                                                                          </span>
<span class="1513108047920599059" onmouseenter="enter('1513108047920599059');" onmouseout="out('1513108047920599059');" style="">  43 import java.util.regex.Pattern;                                                                          </span>
<span  style="">  44                                                                                                          </span>
<span class="-2972028083581866805" onmouseenter="enter('-2972028083581866805');" onmouseout="out('-2972028083581866805');" style="">  45 import javax.servlet.http.HttpServletRequest;                                                            </span>
<span class="8881497316694208384" onmouseenter="enter('8881497316694208384');" onmouseout="out('8881497316694208384');" style="">  46 import javax.servlet.http.HttpSession;                                                                   </span>
<span  style="">  47                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  48 /**                                                                                                      </span>
<span class="3104529581940833663" onmouseenter="enter('3104529581940833663');" onmouseout="out('3104529581940833663');" style="">  49  * @author jfischer                                                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  50  */                                                                                                      </span>
<span class="4656496461683189908" onmouseenter="enter('4656496461683189908');" onmouseout="out('4656496461683189908');" style="">  51 @Service(&quot;blExploitProtectionService&quot;)                                                                   </span>
<span class="-7577265369649440547" onmouseenter="enter('-7577265369649440547');" onmouseout="out('-7577265369649440547');" style="">  52 public class ExploitProtectionServiceImpl implements ExploitProtectionService {                          </span>
<span  style="">  53                                                                                                          </span>
<span class="-5831399856344568636" onmouseenter="enter('-5831399856344568636');" onmouseout="out('-5831399856344568636');" style="">  54     private static final String CSRFTOKEN = &quot;csrfToken&quot;;                                                 </span>
<span class="4054840031468773172" onmouseenter="enter('4054840031468773172');" onmouseout="out('4054840031468773172');" style="">  55     private static final String CSRFTOKENPARAMETER = &quot;csrfToken&quot;;                                        </span>
<span class="-3587117648406762558" onmouseenter="enter('-3587117648406762558');" onmouseout="out('-3587117648406762558');" style="">  56     private static final Log LOG = LogFactory.getLog(ExploitProtectionServiceImpl.class);                </span>
<span class="5243695742915787640" onmouseenter="enter('5243695742915787640');" onmouseout="out('5243695742915787640');" style="">  57     private static final String JAVASCRIPT = &quot;javascript&quot;;                                               </span>
<span  style="">  58                                                                                                          </span>
<span class="-1677855597483692443" onmouseenter="enter('-1677855597483692443');" onmouseout="out('-1677855597483692443');" style="">  59     private static class Handler extends URLStreamHandler {                                              </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  60         @Override                                                                                        </span>
<span class="4194659681324326585" onmouseenter="enter('4194659681324326585');" onmouseout="out('4194659681324326585');" style="">  61         protected URLConnection openConnection(URL u) throws IOException {                               </span>
<span class="3399592013355094643" onmouseenter="enter('3399592013355094643');" onmouseout="out('3399592013355094643');" style="">  62             URL resourceUrl = getClass().getClassLoader().getResource(u.getPath());                      </span>
<span class="-3140647383470477526" onmouseenter="enter('-3140647383470477526');" onmouseout="out('-3140647383470477526');" style="">  63             return resourceUrl.openConnection();                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  64         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  65     }                                                                                                    </span>
<span  style="">  66                                                                                                          </span>
<span class="-8848917178886287682" onmouseenter="enter('-8848917178886287682');" onmouseout="out('-8848917178886287682');" style="">  67     private static Policy getAntiSamyPolicy(String policyFileLocation) {                                 </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  68         try {                                                                                            </span>
<span class="-6525552564951312691" onmouseenter="enter('-6525552564951312691');" onmouseout="out('-6525552564951312691');" style="">  69             URL url = new URL(null, policyFileLocation, new Handler());                                  </span>
<span class="-5530491709875789570" onmouseenter="enter('-5530491709875789570');" onmouseout="out('-5530491709875789570');" style="">  70             return Policy.getInstance(url);                                                              </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style="">  71         } catch (Exception e) {                                                                          </span>
<span class="-5494209266994971292" onmouseenter="enter('-5494209266994971292');" onmouseout="out('-5494209266994971292');" style="">  72             throw new RuntimeException(&quot;Unable to create URL&quot;, e);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  73         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  74     }                                                                                                    </span>
<span  style="">  75                                                                                                          </span>
<span class="-8454650068140773264" onmouseenter="enter('-8454650068140773264');" onmouseout="out('-8454650068140773264');" style="">  76     private static final String DEFAULTANTISAMYPOLICYFILELOCATION = &quot;classpath:antisamy-myspace.xml&quot;;    </span>
<span  style="">  77                                                                                                          </span>
<span class="-3769185808508381094" onmouseenter="enter('-3769185808508381094');" onmouseout="out('-3769185808508381094');" style="">  78     protected String antiSamyPolicyFileLocation = DEFAULTANTISAMYPOLICYFILELOCATION;                     </span>
<span class="-2092034659289993705" onmouseenter="enter('-2092034659289993705');" onmouseout="out('-2092034659289993705');" style="">  79     //this is thread safe                                                                                </span>
<span class="-5052904289597337609" onmouseenter="enter('-5052904289597337609');" onmouseout="out('-5052904289597337609');" style="">  80     private Policy antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);                       </span>
<span class="-3549700451460963582" onmouseenter="enter('-3549700451460963582');" onmouseout="out('-3549700451460963582');" style="">  81     //this is thread safe for the usage of scan()                                                        </span>
<span class="-511658793236644044" onmouseenter="enter('-511658793236644044');" onmouseout="out('-511658793236644044');" style="">  82     private final AntiSamy as = new AntiSamy();                                                          </span>
<span  style="">  83                                                                                                          </span>
<span class="7158989760436170559" onmouseenter="enter('7158989760436170559');" onmouseout="out('7158989760436170559');" style="">  84     @Value(&quot;${exploitProtection.xsrfEnabled:true}&quot;)                                                      </span>
<span class="-2564124477522755746" onmouseenter="enter('-2564124477522755746');" onmouseout="out('-2564124477522755746');" style="">  85     protected boolean xsrfProtectionEnabled;                                                             </span>
<span  style="">  86                                                                                                          </span>
<span class="-4505422957119254609" onmouseenter="enter('-4505422957119254609');" onmouseout="out('-4505422957119254609');" style="">  87     @Value(&quot;${exploitProtection.xssEnabled:true}&quot;)                                                       </span>
<span class="3841797600292304306" onmouseenter="enter('3841797600292304306');" onmouseout="out('3841797600292304306');" style="">  88     protected boolean xssProtectionEnabled;                                                              </span>
<span  style="">  89                                                                                                          </span>
<span class="-370742803470628032" onmouseenter="enter('-370742803470628032');" onmouseout="out('-370742803470628032');" style="">  90     private static final String HTML_PATTERN = &quot;&lt;(\&quot;[^\&quot;]*\&quot;|&#x27;[^&#x27;]*&#x27;|[^&#x27;\&quot;&gt;])*&gt;&quot;;                        </span>
<span class="6568771706925125326" onmouseenter="enter('6568771706925125326');" onmouseout="out('6568771706925125326');" style="">  91     private Pattern pattern = Pattern.compile(HTML_PATTERN);                                             </span>
<span  style="">  92                                                                                                          </span>
<span  style="">  93                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  94     @Override                                                                                            </span>
<span class="7723107530827058384" onmouseenter="enter('7723107530827058384');" onmouseout="out('7723107530827058384');" style="">  95     public String cleanString(String string) throws ServiceException {                                   </span>
<span class="8556081284105346376" onmouseenter="enter('8556081284105346376');" onmouseout="out('8556081284105346376');" style="">  96         if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {                                      </span>
<span class="8152157400372312470" onmouseenter="enter('8152157400372312470');" onmouseout="out('8152157400372312470');" style="">  97             return string;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  98         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  99         try {                                                                                            </span>
<span class="3719546269160040656" onmouseenter="enter('3719546269160040656');" onmouseout="out('3719546269160040656');" style=""> 100             CleanResults results = as.scan(string, antiSamyPolicy);                                      </span>
<span class="-4993842330815521799" onmouseenter="enter('-4993842330815521799');" onmouseout="out('-4993842330815521799');" style=""> 101             return results.getCleanHTML();                                                               </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 102         } catch (Exception e) {                                                                          </span>
<span class="-3714012217960046682" onmouseenter="enter('-3714012217960046682');" onmouseout="out('-3714012217960046682');" style=""> 103             LOG.error(&quot;Unable to clean the passed in entity values&quot;, e);                                 </span>
<span class="-4231105004970935433" onmouseenter="enter('-4231105004970935433');" onmouseout="out('-4231105004970935433');" style=""> 104             throw new ServiceException(&quot;Unable to clean the passed in entity values&quot;, e);                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 105         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 106     }                                                                                                    </span>
<span  style=""> 107                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 108     @Override                                                                                            </span>
<span class="6957345652409804029" onmouseenter="enter('6957345652409804029');" onmouseout="out('6957345652409804029');" style=""> 109     public String cleanStringWithResults(String string) throws ServiceException {                        </span>
<span class="8556081284105346376" onmouseenter="enter('8556081284105346376');" onmouseout="out('8556081284105346376');" style=""> 110         if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {                                      </span>
<span class="8152157400372312470" onmouseenter="enter('8152157400372312470');" onmouseout="out('8152157400372312470');" style=""> 111             return string;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 112         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 113         try {                                                                                            </span>
<span class="3719546269160040656" onmouseenter="enter('3719546269160040656');" onmouseout="out('3719546269160040656');" style=""> 114             CleanResults results = as.scan(string, antiSamyPolicy);                                      </span>
<span class="6620008653670353106" onmouseenter="enter('6620008653670353106');" onmouseout="out('6620008653670353106');" style=""> 115             if (results.getNumberOfErrors() &gt; 0) {                                                       </span>
<span class="1000732835935543819" onmouseenter="enter('1000732835935543819');" onmouseout="out('1000732835935543819');" style=""> 116                 throw new CleanStringException(results);                                                 </span>
<span class="2918192000430827733" onmouseenter="enter('2918192000430827733');" onmouseout="out('2918192000430827733');" style=""> 117             }else{                                                                                       </span>
<span class="-4795652360206896091" onmouseenter="enter('-4795652360206896091');" onmouseout="out('-4795652360206896091');" style=""><abbr title=" 118                 //ok no errors, but what if it has regular string with javascript:xxx and it possibly can be used to construct anchor link"> 118                 //ok no errors, but what if it has regular string with javascript:xxx and it possibly canðŸ”µ</abbr></span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 119 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="3256541859477974579" onmouseenter="enter('3256541859477974579');" onmouseout="out('3256541859477974579');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120                 if (string.toLowerCase().startsWith(&quot;javascript&quot;)) {                                     </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 121 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="-2693852864669979181" onmouseenter="enter('-2693852864669979181');" onmouseout="out('-2693852864669979181');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122                 // let&#x27;s maybe try wrap string into &lt;a href=&quot;string&quot;&gt;qqq&lt;/a&gt;                             </span>
<span class="-4670124309314849634" onmouseenter="enter('-4670124309314849634');" onmouseout="out('-4670124309314849634');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123                 if(!hasHTMLTags(string)){                                                                </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 124 =======                                                                                                  </span>
<span class="560426641368843814" onmouseenter="enter('560426641368843814');" onmouseout="out('560426641368843814');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125                 if (string.toLowerCase().startsWith(JAVASCRIPT)) {                                       </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 126 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="1000732835935543819" onmouseenter="enter('1000732835935543819');" onmouseout="out('1000732835935543819');" style=""> 127                     throw new CleanStringException(results);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 128                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 129             }                                                                                            </span>
<span class="-4993842330815521799" onmouseenter="enter('-4993842330815521799');" onmouseout="out('-4993842330815521799');" style=""> 130             return results.getCleanHTML();                                                               </span>
<span class="522446021072007597" onmouseenter="enter('522446021072007597');" onmouseout="out('522446021072007597');" style=""> 131         } catch (CleanStringException e) {                                                               </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 132             throw e;                                                                                     </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 133         } catch (Exception e) {                                                                          </span>
<span class="-8642289478502472483" onmouseenter="enter('-8642289478502472483');" onmouseout="out('-8642289478502472483');" style=""> 134             StringBuilder sb = new StringBuilder();                                                      </span>
<span class="8547071428257112481" onmouseenter="enter('8547071428257112481');" onmouseout="out('8547071428257112481');" style=""> 135             sb.append(&quot;Unable to clean the passed in entity values&quot;);                                    </span>
<span class="2140406039510895093" onmouseenter="enter('2140406039510895093');" onmouseout="out('2140406039510895093');" style=""> 136             sb.append(&quot;\nNote - &quot;);                                                                      </span>
<span class="-8281191545228522440" onmouseenter="enter('-8281191545228522440');" onmouseout="out('-8281191545228522440');" style=""> 137             sb.append(getAntiSamyPolicyFileLocation());                                                  </span>
<span class="5644375583917836025" onmouseenter="enter('5644375583917836025');" onmouseout="out('5644375583917836025');" style=""><abbr title=" 138             sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.&quot;);"> 138             sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.ðŸ”µ</abbr></span>
<span class="8762389184290087645" onmouseenter="enter('8762389184290087645');" onmouseout="out('8762389184290087645');" style=""> 139             LOG.error(sb.toString(), e);                                                                 </span>
<span class="6944673230759443700" onmouseenter="enter('6944673230759443700');" onmouseout="out('6944673230759443700');" style=""> 140             throw new ServiceException(sb.toString(), e);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 141         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 142     }                                                                                                    </span>
<span  style=""> 143                                                                                                          </span>
<span  style=""> 144                                                                                                          </span>
<span class="-2764905234348603584" onmouseenter="enter('-2764905234348603584');" onmouseout="out('-2764905234348603584');" style=""> 145     protected boolean hasHTMLTags(String text){                                                          </span>
<span class="9198642012760827534" onmouseenter="enter('9198642012760827534');" onmouseout="out('9198642012760827534');" style=""> 146         Matcher matcher = pattern.matcher(text);                                                         </span>
<span class="4330132740674744148" onmouseenter="enter('4330132740674744148');" onmouseout="out('4330132740674744148');" style=""> 147         return matcher.find();                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 148     }                                                                                                    </span>
<span  style=""> 149                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 150     @Override                                                                                            </span>
<span class="648464666007064624" onmouseenter="enter('648464666007064624');" onmouseout="out('648464666007064624');" style=""> 151     public void compareToken(String passedToken) throws ServiceException {                               </span>
<span class="6844728555353595853" onmouseenter="enter('6844728555353595853');" onmouseout="out('6844728555353595853');" style=""> 152         if (xsrfProtectionEnabled) {                                                                     </span>
<span class="7666852928030705963" onmouseenter="enter('7666852928030705963');" onmouseout="out('7666852928030705963');" style=""> 153             if (!getCSRFToken().equals(passedToken)) {                                                   </span>
<span class="-7786080020397166211" onmouseenter="enter('-7786080020397166211');" onmouseout="out('-7786080020397166211');" style=""><abbr title=" 154                 throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expired.&quot;);"> 154                 throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 155             } else {                                                                                     </span>
<span class="-1749099532355983279" onmouseenter="enter('-1749099532355983279');" onmouseout="out('-1749099532355983279');" style=""> 156                 LOG.debug(&quot;Validated CSRF token&quot;);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 157             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 158         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 159     }                                                                                                    </span>
<span  style=""> 160                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 161     @Override                                                                                            </span>
<span class="-2908233649961592868" onmouseenter="enter('-2908233649961592868');" onmouseout="out('-2908233649961592868');" style=""> 162     public String getCSRFToken() throws ServiceException {                                               </span>
<span class="-7374102838628651207" onmouseenter="enter('-7374102838628651207');" onmouseout="out('-7374102838628651207');" style=""><abbr title=" 163         //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated instance."> 163         //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated ðŸ”µ</abbr></span>
<span class="4360254575720880810" onmouseenter="enter('4360254575720880810');" onmouseout="out('4360254575720880810');" style=""> 164         HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();  </span>
<span class="-8754897222759985477" onmouseenter="enter('-8754897222759985477');" onmouseout="out('-8754897222759985477');" style=""> 165         if (request == null) {                                                                           </span>
<span class="5506354016540775394" onmouseenter="enter('5506354016540775394');" onmouseout="out('5506354016540775394');" style=""><abbr title=" 166             //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holder"> 166             //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holdðŸ”µ</abbr></span>
<span class="-4990660252016144867" onmouseenter="enter('-4990660252016144867');" onmouseout="out('-4990660252016144867');" style=""><abbr title=" 167             request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();"> 167             request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequestðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 168         }                                                                                                </span>
<span  style=""> 169                                                                                                          </span>
<span class="-7858468375027211236" onmouseenter="enter('-7858468375027211236');" onmouseout="out('-7858468375027211236');" style=""> 170         if (BLCRequestUtils.isOKtoUseSession(new ServletWebRequest(request))) {                          </span>
<span class="4564433423788020137" onmouseenter="enter('4564433423788020137');" onmouseout="out('4564433423788020137');" style=""> 171             HttpSession session = request.getSession();                                                  </span>
<span class="3674149774037115881" onmouseenter="enter('3674149774037115881');" onmouseout="out('3674149774037115881');" style=""> 172             String token = (String) session.getAttribute(CSRFTOKEN);                                     </span>
<span class="3304317599319354346" onmouseenter="enter('3304317599319354346');" onmouseout="out('3304317599319354346');" style=""> 173             if (StringUtils.isEmpty(token)) {                                                            </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 174                 try {                                                                                    </span>
<span class="421293466978398183" onmouseenter="enter('421293466978398183');" onmouseout="out('421293466978398183');" style=""> 175                     token = RandomGenerator.generateRandomId(&quot;SHA1PRNG&quot;, 32);                            </span>
<span class="-7636130466757008337" onmouseenter="enter('-7636130466757008337');" onmouseout="out('-7636130466757008337');" style=""> 176                 } catch (NoSuchAlgorithmException e) {                                                   </span>
<span class="-3918768481161186829" onmouseenter="enter('-3918768481161186829');" onmouseout="out('-3918768481161186829');" style=""> 177                     LOG.error(&quot;Unable to generate random number&quot;, e);                                    </span>
<span class="1263583644110830904" onmouseenter="enter('1263583644110830904');" onmouseout="out('1263583644110830904');" style=""> 178                     throw new ServiceException(&quot;Unable to generate random number&quot;, e);                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179                 }                                                                                        </span>
<span class="-1497228977843385516" onmouseenter="enter('-1497228977843385516');" onmouseout="out('-1497228977843385516');" style=""> 180                 session.setAttribute(CSRFTOKEN, token);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181             }                                                                                            </span>
<span class="263037551027375388" onmouseenter="enter('263037551027375388');" onmouseout="out('263037551027375388');" style=""> 182             return token;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183         }                                                                                                </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 184         return null;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 185     }                                                                                                    </span>
<span  style=""> 186                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 187     @Override                                                                                            </span>
<span class="1999013554829426715" onmouseenter="enter('1999013554829426715');" onmouseout="out('1999013554829426715');" style=""> 188     public String getAntiSamyPolicyFileLocation() {                                                      </span>
<span class="-2303053444344810326" onmouseenter="enter('-2303053444344810326');" onmouseout="out('-2303053444344810326');" style=""> 189         return antiSamyPolicyFileLocation;                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 190     }                                                                                                    </span>
<span  style=""> 191                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 192     @Override                                                                                            </span>
<span class="8594302017839572248" onmouseenter="enter('8594302017839572248');" onmouseout="out('8594302017839572248');" style=""> 193     public void setAntiSamyPolicyFileLocation(String antiSamyPolicyFileLocation) {                       </span>
<span class="-4970186044531545303" onmouseenter="enter('-4970186044531545303');" onmouseout="out('-4970186044531545303');" style=""> 194         this.antiSamyPolicyFileLocation = antiSamyPolicyFileLocation;                                    </span>
<span class="5908386672201459822" onmouseenter="enter('5908386672201459822');" onmouseout="out('5908386672201459822');" style=""> 195         antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 196     }                                                                                                    </span>
<span  style=""> 197                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 198     @Override                                                                                            </span>
<span class="-9133900204457152332" onmouseenter="enter('-9133900204457152332');" onmouseout="out('-9133900204457152332');" style=""> 199     public String getCsrfTokenParameter() {                                                              </span>
<span class="-707553498228991610" onmouseenter="enter('-707553498228991610');" onmouseout="out('-707553498228991610');" style=""> 200         return CSRFTOKENPARAMETER;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 201     }                                                                                                    </span>
<span  style=""> 202                                                                                                          </span>
<span class="2679016982828970129" onmouseenter="enter('2679016982828970129');" onmouseout="out('2679016982828970129');" style=""> 203     public void setXssProtectionEnabled(boolean xssProtectionEnabled) {                                  </span>
<span class="-6551933069661854213" onmouseenter="enter('-6551933069661854213');" onmouseout="out('-6551933069661854213');" style=""> 204         this.xssProtectionEnabled = xssProtectionEnabled;                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 205     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 206 }                                                                                                        </span>


</pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-4573490878212285276" onmouseenter="enter('-4573490878212285276');" onmouseout="out('-4573490878212285276');" style="">   3  * BroadleafCommerce Common Libraries                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-8883203776714723065" onmouseenter="enter('-8883203776714723065');" onmouseout="out('-8883203776714723065');" style="">  18 package org.broadleafcommerce.common.security.service;                                                   </span>
<span  style="">  19                                                                                                          </span>
<span class="7952073036463698968" onmouseenter="enter('7952073036463698968');" onmouseout="out('7952073036463698968');" style="">  20 import org.apache.commons.lang.StringUtils;                                                              </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  21 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  22 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="5945096539699516699" onmouseenter="enter('5945096539699516699');" onmouseout="out('5945096539699516699');" style="">  23 import org.broadleafcommerce.common.exception.ServiceException;                                          </span>
<span class="3835463558667680002" onmouseenter="enter('3835463558667680002');" onmouseout="out('3835463558667680002');" style="">  24 import org.broadleafcommerce.common.security.RandomGenerator;                                            </span>
<span class="-6556509414411446728" onmouseenter="enter('-6556509414411446728');" onmouseout="out('-6556509414411446728');" style="">  25 import org.broadleafcommerce.common.util.BLCRequestUtils;                                                </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  26 import org.broadleafcommerce.common.web.BroadleafRequestContext;                                         </span>
<span class="-8732799094142472106" onmouseenter="enter('-8732799094142472106');" onmouseout="out('-8732799094142472106');" style="">  27 import org.owasp.validator.html.AntiSamy;                                                                </span>
<span class="-2632485097715966841" onmouseenter="enter('-2632485097715966841');" onmouseout="out('-2632485097715966841');" style="">  28 import org.owasp.validator.html.CleanResults;                                                            </span>
<span class="3991596715890294789" onmouseenter="enter('3991596715890294789');" onmouseout="out('3991596715890294789');" style="">  29 import org.owasp.validator.html.Policy;                                                                  </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  30 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  31 import org.springframework.stereotype.Service;                                                           </span>
<span class="6793981704939320962" onmouseenter="enter('6793981704939320962');" onmouseout="out('6793981704939320962');" style="">  32 import org.springframework.web.context.request.RequestContextHolder;                                     </span>
<span class="-3977424511564612993" onmouseenter="enter('-3977424511564612993');" onmouseout="out('-3977424511564612993');" style="">  33 import org.springframework.web.context.request.ServletRequestAttributes;                                 </span>
<span class="-208569050100229982" onmouseenter="enter('-208569050100229982');" onmouseout="out('-208569050100229982');" style="">  34 import org.springframework.web.context.request.ServletWebRequest;                                        </span>
<span class="6387767356345417225" onmouseenter="enter('6387767356345417225');" onmouseout="out('6387767356345417225');" style="">  35 import org.springframework.web.util.HtmlUtils;                                                           </span>
<span  style="">  36                                                                                                          </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  37 import java.io.IOException;                                                                              </span>
<span class="-5598187278321027129" onmouseenter="enter('-5598187278321027129');" onmouseout="out('-5598187278321027129');" style="">  38 import java.net.URL;                                                                                     </span>
<span class="-5521468699455618699" onmouseenter="enter('-5521468699455618699');" onmouseout="out('-5521468699455618699');" style="">  39 import java.net.URLConnection;                                                                           </span>
<span class="-4333778487385766125" onmouseenter="enter('-4333778487385766125');" onmouseout="out('-4333778487385766125');" style="">  40 import java.net.URLStreamHandler;                                                                        </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  41 import java.security.NoSuchAlgorithmException;                                                           </span>
<span class="2159928926335330273" onmouseenter="enter('2159928926335330273');" onmouseout="out('2159928926335330273');" style="">  42 import java.util.regex.Matcher;                                                                          </span>
<span class="1513108047920599059" onmouseenter="enter('1513108047920599059');" onmouseout="out('1513108047920599059');" style="">  43 import java.util.regex.Pattern;                                                                          </span>
<span  style="">  44                                                                                                          </span>
<span class="-2972028083581866805" onmouseenter="enter('-2972028083581866805');" onmouseout="out('-2972028083581866805');" style="">  45 import javax.servlet.http.HttpServletRequest;                                                            </span>
<span class="8881497316694208384" onmouseenter="enter('8881497316694208384');" onmouseout="out('8881497316694208384');" style="">  46 import javax.servlet.http.HttpSession;                                                                   </span>
<span  style="">  47                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  48 /**                                                                                                      </span>
<span class="3104529581940833663" onmouseenter="enter('3104529581940833663');" onmouseout="out('3104529581940833663');" style="">  49  * @author jfischer                                                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  50  */                                                                                                      </span>
<span class="4656496461683189908" onmouseenter="enter('4656496461683189908');" onmouseout="out('4656496461683189908');" style="">  51 @Service(&quot;blExploitProtectionService&quot;)                                                                   </span>
<span class="-7577265369649440547" onmouseenter="enter('-7577265369649440547');" onmouseout="out('-7577265369649440547');" style="">  52 public class ExploitProtectionServiceImpl implements ExploitProtectionService {                          </span>
<span  style="">  53                                                                                                          </span>
<span class="-5831399856344568636" onmouseenter="enter('-5831399856344568636');" onmouseout="out('-5831399856344568636');" style="">  54     private static final String CSRFTOKEN = &quot;csrfToken&quot;;                                                 </span>
<span class="4054840031468773172" onmouseenter="enter('4054840031468773172');" onmouseout="out('4054840031468773172');" style="">  55     private static final String CSRFTOKENPARAMETER = &quot;csrfToken&quot;;                                        </span>
<span class="-3587117648406762558" onmouseenter="enter('-3587117648406762558');" onmouseout="out('-3587117648406762558');" style="">  56     private static final Log LOG = LogFactory.getLog(ExploitProtectionServiceImpl.class);                </span>
<span class="5243695742915787640" onmouseenter="enter('5243695742915787640');" onmouseout="out('5243695742915787640');" style="">  57     private static final String JAVASCRIPT = &quot;javascript&quot;;                                               </span>
<span  style="">  58                                                                                                          </span>
<span class="-1677855597483692443" onmouseenter="enter('-1677855597483692443');" onmouseout="out('-1677855597483692443');" style="">  59     private static class Handler extends URLStreamHandler {                                              </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  60         @Override                                                                                        </span>
<span class="4194659681324326585" onmouseenter="enter('4194659681324326585');" onmouseout="out('4194659681324326585');" style="">  61         protected URLConnection openConnection(URL u) throws IOException {                               </span>
<span class="3399592013355094643" onmouseenter="enter('3399592013355094643');" onmouseout="out('3399592013355094643');" style="">  62             URL resourceUrl = getClass().getClassLoader().getResource(u.getPath());                      </span>
<span class="-3140647383470477526" onmouseenter="enter('-3140647383470477526');" onmouseout="out('-3140647383470477526');" style="">  63             return resourceUrl.openConnection();                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  64         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  65     }                                                                                                    </span>
<span  style="">  66                                                                                                          </span>
<span class="-8848917178886287682" onmouseenter="enter('-8848917178886287682');" onmouseout="out('-8848917178886287682');" style="">  67     private static Policy getAntiSamyPolicy(String policyFileLocation) {                                 </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  68         try {                                                                                            </span>
<span class="-6525552564951312691" onmouseenter="enter('-6525552564951312691');" onmouseout="out('-6525552564951312691');" style="">  69             URL url = new URL(null, policyFileLocation, new Handler());                                  </span>
<span class="-5530491709875789570" onmouseenter="enter('-5530491709875789570');" onmouseout="out('-5530491709875789570');" style="">  70             return Policy.getInstance(url);                                                              </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style="">  71         } catch (Exception e) {                                                                          </span>
<span class="-5494209266994971292" onmouseenter="enter('-5494209266994971292');" onmouseout="out('-5494209266994971292');" style="">  72             throw new RuntimeException(&quot;Unable to create URL&quot;, e);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  73         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  74     }                                                                                                    </span>
<span  style="">  75                                                                                                          </span>
<span class="-8454650068140773264" onmouseenter="enter('-8454650068140773264');" onmouseout="out('-8454650068140773264');" style="">  76     private static final String DEFAULTANTISAMYPOLICYFILELOCATION = &quot;classpath:antisamy-myspace.xml&quot;;    </span>
<span  style="">  77                                                                                                          </span>
<span class="-3769185808508381094" onmouseenter="enter('-3769185808508381094');" onmouseout="out('-3769185808508381094');" style="">  78     protected String antiSamyPolicyFileLocation = DEFAULTANTISAMYPOLICYFILELOCATION;                     </span>
<span class="-2092034659289993705" onmouseenter="enter('-2092034659289993705');" onmouseout="out('-2092034659289993705');" style="">  79     //this is thread safe                                                                                </span>
<span class="-5052904289597337609" onmouseenter="enter('-5052904289597337609');" onmouseout="out('-5052904289597337609');" style="">  80     private Policy antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);                       </span>
<span class="-3549700451460963582" onmouseenter="enter('-3549700451460963582');" onmouseout="out('-3549700451460963582');" style="">  81     //this is thread safe for the usage of scan()                                                        </span>
<span class="-511658793236644044" onmouseenter="enter('-511658793236644044');" onmouseout="out('-511658793236644044');" style="">  82     private final AntiSamy as = new AntiSamy();                                                          </span>
<span  style="">  83                                                                                                          </span>
<span class="7158989760436170559" onmouseenter="enter('7158989760436170559');" onmouseout="out('7158989760436170559');" style="">  84     @Value(&quot;${exploitProtection.xsrfEnabled:true}&quot;)                                                      </span>
<span class="-2564124477522755746" onmouseenter="enter('-2564124477522755746');" onmouseout="out('-2564124477522755746');" style="">  85     protected boolean xsrfProtectionEnabled;                                                             </span>
<span  style="">  86                                                                                                          </span>
<span class="-4505422957119254609" onmouseenter="enter('-4505422957119254609');" onmouseout="out('-4505422957119254609');" style="">  87     @Value(&quot;${exploitProtection.xssEnabled:true}&quot;)                                                       </span>
<span class="3841797600292304306" onmouseenter="enter('3841797600292304306');" onmouseout="out('3841797600292304306');" style="">  88     protected boolean xssProtectionEnabled;                                                              </span>
<span  style="">  89                                                                                                          </span>
<span class="-370742803470628032" onmouseenter="enter('-370742803470628032');" onmouseout="out('-370742803470628032');" style="">  90     private static final String HTML_PATTERN = &quot;&lt;(\&quot;[^\&quot;]*\&quot;|&#x27;[^&#x27;]*&#x27;|[^&#x27;\&quot;&gt;])*&gt;&quot;;                        </span>
<span class="6568771706925125326" onmouseenter="enter('6568771706925125326');" onmouseout="out('6568771706925125326');" style="">  91     private Pattern pattern = Pattern.compile(HTML_PATTERN);                                             </span>
<span  style="">  92                                                                                                          </span>
<span  style="">  93                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  94     @Override                                                                                            </span>
<span class="7723107530827058384" onmouseenter="enter('7723107530827058384');" onmouseout="out('7723107530827058384');" style="">  95     public String cleanString(String string) throws ServiceException {                                   </span>
<span class="8556081284105346376" onmouseenter="enter('8556081284105346376');" onmouseout="out('8556081284105346376');" style="">  96         if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {                                      </span>
<span class="8152157400372312470" onmouseenter="enter('8152157400372312470');" onmouseout="out('8152157400372312470');" style="">  97             return string;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  98         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  99         try {                                                                                            </span>
<span class="3719546269160040656" onmouseenter="enter('3719546269160040656');" onmouseout="out('3719546269160040656');" style=""> 100             CleanResults results = as.scan(string, antiSamyPolicy);                                      </span>
<span class="-4993842330815521799" onmouseenter="enter('-4993842330815521799');" onmouseout="out('-4993842330815521799');" style=""> 101             return results.getCleanHTML();                                                               </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 102         } catch (Exception e) {                                                                          </span>
<span class="-3714012217960046682" onmouseenter="enter('-3714012217960046682');" onmouseout="out('-3714012217960046682');" style=""> 103             LOG.error(&quot;Unable to clean the passed in entity values&quot;, e);                                 </span>
<span class="-4231105004970935433" onmouseenter="enter('-4231105004970935433');" onmouseout="out('-4231105004970935433');" style=""> 104             throw new ServiceException(&quot;Unable to clean the passed in entity values&quot;, e);                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 105         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 106     }                                                                                                    </span>
<span  style=""> 107                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 108     @Override                                                                                            </span>
<span class="6957345652409804029" onmouseenter="enter('6957345652409804029');" onmouseout="out('6957345652409804029');" style=""> 109     public String cleanStringWithResults(String string) throws ServiceException {                        </span>
<span class="8556081284105346376" onmouseenter="enter('8556081284105346376');" onmouseout="out('8556081284105346376');" style=""> 110         if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {                                      </span>
<span class="8152157400372312470" onmouseenter="enter('8152157400372312470');" onmouseout="out('8152157400372312470');" style=""> 111             return string;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 112         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 113         try {                                                                                            </span>
<span class="3719546269160040656" onmouseenter="enter('3719546269160040656');" onmouseout="out('3719546269160040656');" style=""> 114             CleanResults results = as.scan(string, antiSamyPolicy);                                      </span>
<span class="6620008653670353106" onmouseenter="enter('6620008653670353106');" onmouseout="out('6620008653670353106');" style=""> 115             if (results.getNumberOfErrors() &gt; 0) {                                                       </span>
<span class="1000732835935543819" onmouseenter="enter('1000732835935543819');" onmouseout="out('1000732835935543819');" style=""> 116                 throw new CleanStringException(results);                                                 </span>
<span class="2918192000430827733" onmouseenter="enter('2918192000430827733');" onmouseout="out('2918192000430827733');" style=""> 117             }else{                                                                                       </span>
<span class="-4795652360206896091" onmouseenter="enter('-4795652360206896091');" onmouseout="out('-4795652360206896091');" style=""><abbr title=" 118                 //ok no errors, but what if it has regular string with javascript:xxx and it possibly can be used to construct anchor link"> 118                 //ok no errors, but what if it has regular string with javascript:xxx and it possibly canðŸ”µ</abbr></span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style=""> 119 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="3256541859477974579" onmouseenter="enter('3256541859477974579');" onmouseout="out('3256541859477974579');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120                 if (string.toLowerCase().startsWith(&quot;javascript&quot;)) {                                     </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 121 ||||||| BASE                                                                                             </span>
<span class="-2693852864669979181" onmouseenter="enter('-2693852864669979181');" onmouseout="out('-2693852864669979181');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122                 // let&#x27;s maybe try wrap string into &lt;a href=&quot;string&quot;&gt;qqq&lt;/a&gt;                             </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 123 =======                                                                                                  </span>
<span class="560426641368843814" onmouseenter="enter('560426641368843814');" onmouseout="out('560426641368843814');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124                 if (string.toLowerCase().startsWith(JAVASCRIPT)) {                                       </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 125 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span class="1000732835935543819" onmouseenter="enter('1000732835935543819');" onmouseout="out('1000732835935543819');" style=""> 126                         throw new CleanStringException(results);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 127                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 128                 }                                                                                        </span>
<span class="-4993842330815521799" onmouseenter="enter('-4993842330815521799');" onmouseout="out('-4993842330815521799');" style=""> 129             return results.getCleanHTML();                                                               </span>
<span class="522446021072007597" onmouseenter="enter('522446021072007597');" onmouseout="out('522446021072007597');" style=""> 130         } catch (CleanStringException e) {                                                               </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 131             throw e;                                                                                     </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 132         } catch (Exception e) {                                                                          </span>
<span class="-8642289478502472483" onmouseenter="enter('-8642289478502472483');" onmouseout="out('-8642289478502472483');" style=""> 133             StringBuilder sb = new StringBuilder();                                                      </span>
<span class="8547071428257112481" onmouseenter="enter('8547071428257112481');" onmouseout="out('8547071428257112481');" style=""> 134             sb.append(&quot;Unable to clean the passed in entity values&quot;);                                    </span>
<span class="2140406039510895093" onmouseenter="enter('2140406039510895093');" onmouseout="out('2140406039510895093');" style=""> 135             sb.append(&quot;\nNote - &quot;);                                                                      </span>
<span class="-8281191545228522440" onmouseenter="enter('-8281191545228522440');" onmouseout="out('-8281191545228522440');" style=""> 136             sb.append(getAntiSamyPolicyFileLocation());                                                  </span>
<span class="5644375583917836025" onmouseenter="enter('5644375583917836025');" onmouseout="out('5644375583917836025');" style=""><abbr title=" 137             sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.&quot;);"> 137             sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.ðŸ”µ</abbr></span>
<span class="8762389184290087645" onmouseenter="enter('8762389184290087645');" onmouseout="out('8762389184290087645');" style=""> 138             LOG.error(sb.toString(), e);                                                                 </span>
<span class="6944673230759443700" onmouseenter="enter('6944673230759443700');" onmouseout="out('6944673230759443700');" style=""> 139             throw new ServiceException(sb.toString(), e);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 140         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 141     }                                                                                                    </span>
<span  style=""> 142                                                                                                          </span>
<span  style=""> 143                                                                                                          </span>
<span class="-2764905234348603584" onmouseenter="enter('-2764905234348603584');" onmouseout="out('-2764905234348603584');" style=""> 144     protected boolean hasHTMLTags(String text){                                                          </span>
<span class="9198642012760827534" onmouseenter="enter('9198642012760827534');" onmouseout="out('9198642012760827534');" style=""> 145         Matcher matcher = pattern.matcher(text);                                                         </span>
<span class="4330132740674744148" onmouseenter="enter('4330132740674744148');" onmouseout="out('4330132740674744148');" style=""> 146         return matcher.find();                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147     }                                                                                                    </span>
<span  style=""> 148                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 149     @Override                                                                                            </span>
<span class="648464666007064624" onmouseenter="enter('648464666007064624');" onmouseout="out('648464666007064624');" style=""> 150     public void compareToken(String passedToken) throws ServiceException {                               </span>
<span class="6844728555353595853" onmouseenter="enter('6844728555353595853');" onmouseout="out('6844728555353595853');" style=""> 151         if (xsrfProtectionEnabled) {                                                                     </span>
<span class="7666852928030705963" onmouseenter="enter('7666852928030705963');" onmouseout="out('7666852928030705963');" style=""> 152             if (!getCSRFToken().equals(passedToken)) {                                                   </span>
<span class="-7786080020397166211" onmouseenter="enter('-7786080020397166211');" onmouseout="out('-7786080020397166211');" style=""><abbr title=" 153                 throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expired.&quot;);"> 153                 throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 154             } else {                                                                                     </span>
<span class="-1749099532355983279" onmouseenter="enter('-1749099532355983279');" onmouseout="out('-1749099532355983279');" style=""> 155                 LOG.debug(&quot;Validated CSRF token&quot;);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 156             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 157         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 158     }                                                                                                    </span>
<span  style=""> 159                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 160     @Override                                                                                            </span>
<span class="-2908233649961592868" onmouseenter="enter('-2908233649961592868');" onmouseout="out('-2908233649961592868');" style=""> 161     public String getCSRFToken() throws ServiceException {                                               </span>
<span class="-7374102838628651207" onmouseenter="enter('-7374102838628651207');" onmouseout="out('-7374102838628651207');" style=""><abbr title=" 162         //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated instance."> 162         //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated ðŸ”µ</abbr></span>
<span class="4360254575720880810" onmouseenter="enter('4360254575720880810');" onmouseout="out('4360254575720880810');" style=""> 163         HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();  </span>
<span class="-8754897222759985477" onmouseenter="enter('-8754897222759985477');" onmouseout="out('-8754897222759985477');" style=""> 164         if (request == null) {                                                                           </span>
<span class="5506354016540775394" onmouseenter="enter('5506354016540775394');" onmouseout="out('5506354016540775394');" style=""><abbr title=" 165             //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holder"> 165             //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holdðŸ”µ</abbr></span>
<span class="-4990660252016144867" onmouseenter="enter('-4990660252016144867');" onmouseout="out('-4990660252016144867');" style=""><abbr title=" 166             request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();"> 166             request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequestðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 167         }                                                                                                </span>
<span  style=""> 168                                                                                                          </span>
<span class="-7858468375027211236" onmouseenter="enter('-7858468375027211236');" onmouseout="out('-7858468375027211236');" style=""> 169         if (BLCRequestUtils.isOKtoUseSession(new ServletWebRequest(request))) {                          </span>
<span class="4564433423788020137" onmouseenter="enter('4564433423788020137');" onmouseout="out('4564433423788020137');" style=""> 170             HttpSession session = request.getSession();                                                  </span>
<span class="3674149774037115881" onmouseenter="enter('3674149774037115881');" onmouseout="out('3674149774037115881');" style=""> 171             String token = (String) session.getAttribute(CSRFTOKEN);                                     </span>
<span class="3304317599319354346" onmouseenter="enter('3304317599319354346');" onmouseout="out('3304317599319354346');" style=""> 172             if (StringUtils.isEmpty(token)) {                                                            </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 173                 try {                                                                                    </span>
<span class="421293466978398183" onmouseenter="enter('421293466978398183');" onmouseout="out('421293466978398183');" style=""> 174                     token = RandomGenerator.generateRandomId(&quot;SHA1PRNG&quot;, 32);                            </span>
<span class="-7636130466757008337" onmouseenter="enter('-7636130466757008337');" onmouseout="out('-7636130466757008337');" style=""> 175                 } catch (NoSuchAlgorithmException e) {                                                   </span>
<span class="-3918768481161186829" onmouseenter="enter('-3918768481161186829');" onmouseout="out('-3918768481161186829');" style=""> 176                     LOG.error(&quot;Unable to generate random number&quot;, e);                                    </span>
<span class="1263583644110830904" onmouseenter="enter('1263583644110830904');" onmouseout="out('1263583644110830904');" style=""> 177                     throw new ServiceException(&quot;Unable to generate random number&quot;, e);                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 178                 }                                                                                        </span>
<span class="-1497228977843385516" onmouseenter="enter('-1497228977843385516');" onmouseout="out('-1497228977843385516');" style=""> 179                 session.setAttribute(CSRFTOKEN, token);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180             }                                                                                            </span>
<span class="263037551027375388" onmouseenter="enter('263037551027375388');" onmouseout="out('263037551027375388');" style=""> 181             return token;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 182         }                                                                                                </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 183         return null;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 184     }                                                                                                    </span>
<span  style=""> 185                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 186     @Override                                                                                            </span>
<span class="1999013554829426715" onmouseenter="enter('1999013554829426715');" onmouseout="out('1999013554829426715');" style=""> 187     public String getAntiSamyPolicyFileLocation() {                                                      </span>
<span class="-2303053444344810326" onmouseenter="enter('-2303053444344810326');" onmouseout="out('-2303053444344810326');" style=""> 188         return antiSamyPolicyFileLocation;                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189     }                                                                                                    </span>
<span  style=""> 190                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 191     @Override                                                                                            </span>
<span class="8594302017839572248" onmouseenter="enter('8594302017839572248');" onmouseout="out('8594302017839572248');" style=""> 192     public void setAntiSamyPolicyFileLocation(String antiSamyPolicyFileLocation) {                       </span>
<span class="-4970186044531545303" onmouseenter="enter('-4970186044531545303');" onmouseout="out('-4970186044531545303');" style=""> 193         this.antiSamyPolicyFileLocation = antiSamyPolicyFileLocation;                                    </span>
<span class="5908386672201459822" onmouseenter="enter('5908386672201459822');" onmouseout="out('5908386672201459822');" style=""> 194         antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 195     }                                                                                                    </span>
<span  style=""> 196                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 197     @Override                                                                                            </span>
<span class="-9133900204457152332" onmouseenter="enter('-9133900204457152332');" onmouseout="out('-9133900204457152332');" style=""> 198     public String getCsrfTokenParameter() {                                                              </span>
<span class="-707553498228991610" onmouseenter="enter('-707553498228991610');" onmouseout="out('-707553498228991610');" style=""> 199         return CSRFTOKENPARAMETER;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 200     }                                                                                                    </span>
<span  style=""> 201                                                                                                          </span>
<span class="2679016982828970129" onmouseenter="enter('2679016982828970129');" onmouseout="out('2679016982828970129');" style=""> 202     public void setXssProtectionEnabled(boolean xssProtectionEnabled) {                                  </span>
<span class="-6551933069661854213" onmouseenter="enter('-6551933069661854213');" onmouseout="out('-6551933069661854213');" style=""> 203         this.xssProtectionEnabled = xssProtectionEnabled;                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 204     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 205 }                                                                                                        </span>



</pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-4573490878212285276" onmouseenter="enter('-4573490878212285276');" onmouseout="out('-4573490878212285276');" style="">   3  * BroadleafCommerce Common Libraries                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-8883203776714723065" onmouseenter="enter('-8883203776714723065');" onmouseout="out('-8883203776714723065');" style="">  18 package org.broadleafcommerce.common.security.service;                                                   </span>
<span  style="">  19                                                                                                          </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  20 import java.io.IOException;                                                                              </span>
<span class="-5598187278321027129" onmouseenter="enter('-5598187278321027129');" onmouseout="out('-5598187278321027129');" style="">  21 import java.net.URL;                                                                                     </span>
<span class="-5521468699455618699" onmouseenter="enter('-5521468699455618699');" onmouseout="out('-5521468699455618699');" style="">  22 import java.net.URLConnection;                                                                           </span>
<span class="-4333778487385766125" onmouseenter="enter('-4333778487385766125');" onmouseout="out('-4333778487385766125');" style="">  23 import java.net.URLStreamHandler;                                                                        </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  24 import java.security.NoSuchAlgorithmException;                                                           </span>
<span class="2159928926335330273" onmouseenter="enter('2159928926335330273');" onmouseout="out('2159928926335330273');" style="">  25 import java.util.regex.Matcher;                                                                          </span>
<span class="1513108047920599059" onmouseenter="enter('1513108047920599059');" onmouseout="out('1513108047920599059');" style="">  26 import java.util.regex.Pattern;                                                                          </span>
<span class="-2972028083581866805" onmouseenter="enter('-2972028083581866805');" onmouseout="out('-2972028083581866805');" style="">  27 import javax.servlet.http.HttpServletRequest;                                                            </span>
<span class="8881497316694208384" onmouseenter="enter('8881497316694208384');" onmouseout="out('8881497316694208384');" style="">  28 import javax.servlet.http.HttpSession;                                                                   </span>
<span class="7952073036463698968" onmouseenter="enter('7952073036463698968');" onmouseout="out('7952073036463698968');" style="">  29 import org.apache.commons.lang.StringUtils;                                                              </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  30 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  31 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="5945096539699516699" onmouseenter="enter('5945096539699516699');" onmouseout="out('5945096539699516699');" style="">  32 import org.broadleafcommerce.common.exception.ServiceException;                                          </span>
<span class="3835463558667680002" onmouseenter="enter('3835463558667680002');" onmouseout="out('3835463558667680002');" style="">  33 import org.broadleafcommerce.common.security.RandomGenerator;                                            </span>
<span class="-6556509414411446728" onmouseenter="enter('-6556509414411446728');" onmouseout="out('-6556509414411446728');" style="">  34 import org.broadleafcommerce.common.util.BLCRequestUtils;                                                </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  35 import org.broadleafcommerce.common.web.BroadleafRequestContext;                                         </span>
<span class="-8732799094142472106" onmouseenter="enter('-8732799094142472106');" onmouseout="out('-8732799094142472106');" style="">  36 import org.owasp.validator.html.AntiSamy;                                                                </span>
<span class="-2632485097715966841" onmouseenter="enter('-2632485097715966841');" onmouseout="out('-2632485097715966841');" style="">  37 import org.owasp.validator.html.CleanResults;                                                            </span>
<span class="3991596715890294789" onmouseenter="enter('3991596715890294789');" onmouseout="out('3991596715890294789');" style="">  38 import org.owasp.validator.html.Policy;                                                                  </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  39 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  40 import org.springframework.stereotype.Service;                                                           </span>
<span class="6793981704939320962" onmouseenter="enter('6793981704939320962');" onmouseout="out('6793981704939320962');" style="">  41 import org.springframework.web.context.request.RequestContextHolder;                                     </span>
<span class="-3977424511564612993" onmouseenter="enter('-3977424511564612993');" onmouseout="out('-3977424511564612993');" style="">  42 import org.springframework.web.context.request.ServletRequestAttributes;                                 </span>
<span class="-208569050100229982" onmouseenter="enter('-208569050100229982');" onmouseout="out('-208569050100229982');" style="">  43 import org.springframework.web.context.request.ServletWebRequest;                                        </span>
<span class="6387767356345417225" onmouseenter="enter('6387767356345417225');" onmouseout="out('6387767356345417225');" style="">  44 import org.springframework.web.util.HtmlUtils;                                                           </span>
<span  style="">  45                                                                                                          </span>
<span  style="">  46                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  47 /**                                                                                                      </span>
<span class="3104529581940833663" onmouseenter="enter('3104529581940833663');" onmouseout="out('3104529581940833663');" style="">  48  * @author jfischer                                                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  49  */                                                                                                      </span>
<span class="4656496461683189908" onmouseenter="enter('4656496461683189908');" onmouseout="out('4656496461683189908');" style="">  50 @Service(&quot;blExploitProtectionService&quot;)                                                                   </span>
<span class="-7577265369649440547" onmouseenter="enter('-7577265369649440547');" onmouseout="out('-7577265369649440547');" style="">  51 public class ExploitProtectionServiceImpl implements ExploitProtectionService {                          </span>
<span class="-5831399856344568636" onmouseenter="enter('-5831399856344568636');" onmouseout="out('-5831399856344568636');" style="">  52     private static final String CSRFTOKEN = &quot;csrfToken&quot;;                                                 </span>
<span  style="">  53                                                                                                          </span>
<span class="4054840031468773172" onmouseenter="enter('4054840031468773172');" onmouseout="out('4054840031468773172');" style="">  54     private static final String CSRFTOKENPARAMETER = &quot;csrfToken&quot;;                                        </span>
<span  style="">  55                                                                                                          </span>
<span class="-3587117648406762558" onmouseenter="enter('-3587117648406762558');" onmouseout="out('-3587117648406762558');" style="">  56     private static final Log LOG = LogFactory.getLog(ExploitProtectionServiceImpl.class);                </span>
<span  style="">  57                                                                                                          </span>
<span class="5243695742915787640" onmouseenter="enter('5243695742915787640');" onmouseout="out('5243695742915787640');" style="">  58     private static final String JAVASCRIPT = &quot;javascript&quot;;                                               </span>
<span  style="">  59                                                                                                          </span>
<span class="-1677855597483692443" onmouseenter="enter('-1677855597483692443');" onmouseout="out('-1677855597483692443');" style="">  60     private static class Handler extends URLStreamHandler {                                              </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  61         @Override                                                                                        </span>
<span class="4194659681324326585" onmouseenter="enter('4194659681324326585');" onmouseout="out('4194659681324326585');" style="">  62         protected URLConnection openConnection(URL u) throws IOException {                               </span>
<span class="3399592013355094643" onmouseenter="enter('3399592013355094643');" onmouseout="out('3399592013355094643');" style="">  63             URL resourceUrl = getClass().getClassLoader().getResource(u.getPath());                      </span>
<span class="-3140647383470477526" onmouseenter="enter('-3140647383470477526');" onmouseout="out('-3140647383470477526');" style="">  64             return resourceUrl.openConnection();                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  65         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  66     }                                                                                                    </span>
<span  style="">  67                                                                                                          </span>
<span class="-8848917178886287682" onmouseenter="enter('-8848917178886287682');" onmouseout="out('-8848917178886287682');" style="">  68     private static Policy getAntiSamyPolicy(String policyFileLocation) {                                 </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  69         try {                                                                                            </span>
<span class="-6525552564951312691" onmouseenter="enter('-6525552564951312691');" onmouseout="out('-6525552564951312691');" style="">  70             URL url = new URL(null, policyFileLocation, new Handler());                                  </span>
<span class="-5530491709875789570" onmouseenter="enter('-5530491709875789570');" onmouseout="out('-5530491709875789570');" style="">  71             return Policy.getInstance(url);                                                              </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style="">  72         } catch (Exception e) {                                                                          </span>
<span class="-5494209266994971292" onmouseenter="enter('-5494209266994971292');" onmouseout="out('-5494209266994971292');" style="">  73             throw new RuntimeException(&quot;Unable to create URL&quot;, e);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  74         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  75     }                                                                                                    </span>
<span  style="">  76                                                                                                          </span>
<span class="-8454650068140773264" onmouseenter="enter('-8454650068140773264');" onmouseout="out('-8454650068140773264');" style="">  77     private static final String DEFAULTANTISAMYPOLICYFILELOCATION = &quot;classpath:antisamy-myspace.xml&quot;;    </span>
<span  style="">  78                                                                                                          </span>
<span class="-3769185808508381094" onmouseenter="enter('-3769185808508381094');" onmouseout="out('-3769185808508381094');" style="">  79     protected String antiSamyPolicyFileLocation = DEFAULTANTISAMYPOLICYFILELOCATION;                     </span>
<span  style="">  80                                                                                                          </span>
<span class="-2092034659289993705" onmouseenter="enter('-2092034659289993705');" onmouseout="out('-2092034659289993705');" style="">  81     //this is thread safe                                                                                </span>
<span class="-2092034659289993705" onmouseenter="enter('-2092034659289993705');" onmouseout="out('-2092034659289993705');" style="">  82     //this is thread safe                                                                                </span>
<span class="-5052904289597337609" onmouseenter="enter('-5052904289597337609');" onmouseout="out('-5052904289597337609');" style="">  83     private Policy antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);                       </span>
<span  style="">  84                                                                                                          </span>
<span class="-3549700451460963582" onmouseenter="enter('-3549700451460963582');" onmouseout="out('-3549700451460963582');" style="">  85     //this is thread safe for the usage of scan()                                                        </span>
<span class="-3549700451460963582" onmouseenter="enter('-3549700451460963582');" onmouseout="out('-3549700451460963582');" style="">  86     //this is thread safe for the usage of scan()                                                        </span>
<span class="-511658793236644044" onmouseenter="enter('-511658793236644044');" onmouseout="out('-511658793236644044');" style="">  87     private final AntiSamy as = new AntiSamy();                                                          </span>
<span  style="">  88                                                                                                          </span>
<span class="7158989760436170559" onmouseenter="enter('7158989760436170559');" onmouseout="out('7158989760436170559');" style="">  89     @Value(&quot;${exploitProtection.xsrfEnabled:true}&quot;)                                                      </span>
<span class="-2564124477522755746" onmouseenter="enter('-2564124477522755746');" onmouseout="out('-2564124477522755746');" style="">  90     protected boolean xsrfProtectionEnabled;                                                             </span>
<span  style="">  91                                                                                                          </span>
<span class="-4505422957119254609" onmouseenter="enter('-4505422957119254609');" onmouseout="out('-4505422957119254609');" style="">  92     @Value(&quot;${exploitProtection.xssEnabled:true}&quot;)                                                       </span>
<span class="3841797600292304306" onmouseenter="enter('3841797600292304306');" onmouseout="out('3841797600292304306');" style="">  93     protected boolean xssProtectionEnabled;                                                              </span>
<span  style="">  94                                                                                                          </span>
<span class="-370742803470628032" onmouseenter="enter('-370742803470628032');" onmouseout="out('-370742803470628032');" style="">  95     private static final String HTML_PATTERN = &quot;&lt;(\&quot;[^\&quot;]*\&quot;|&#x27;[^&#x27;]*&#x27;|[^&#x27;\&quot;&gt;])*&gt;&quot;;                        </span>
<span  style="">  96                                                                                                          </span>
<span class="6568771706925125326" onmouseenter="enter('6568771706925125326');" onmouseout="out('6568771706925125326');" style="">  97     private Pattern pattern = Pattern.compile(HTML_PATTERN);                                             </span>
<span  style="">  98                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  99     @Override                                                                                            </span>
<span class="7723107530827058384" onmouseenter="enter('7723107530827058384');" onmouseout="out('7723107530827058384');" style=""> 100     public String cleanString(String string) throws ServiceException {                                   </span>
<span class="8556081284105346376" onmouseenter="enter('8556081284105346376');" onmouseout="out('8556081284105346376');" style=""> 101         if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {                                      </span>
<span class="8152157400372312470" onmouseenter="enter('8152157400372312470');" onmouseout="out('8152157400372312470');" style=""> 102             return string;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 103         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 104         try {                                                                                            </span>
<span class="3719546269160040656" onmouseenter="enter('3719546269160040656');" onmouseout="out('3719546269160040656');" style=""> 105             CleanResults results = as.scan(string, antiSamyPolicy);                                      </span>
<span class="-4993842330815521799" onmouseenter="enter('-4993842330815521799');" onmouseout="out('-4993842330815521799');" style=""> 106             return results.getCleanHTML();                                                               </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 107         } catch (Exception e) {                                                                          </span>
<span class="-3714012217960046682" onmouseenter="enter('-3714012217960046682');" onmouseout="out('-3714012217960046682');" style=""> 108             LOG.error(&quot;Unable to clean the passed in entity values&quot;, e);                                 </span>
<span class="-4231105004970935433" onmouseenter="enter('-4231105004970935433');" onmouseout="out('-4231105004970935433');" style=""> 109             throw new ServiceException(&quot;Unable to clean the passed in entity values&quot;, e);                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 110         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 111     }                                                                                                    </span>
<span  style=""> 112                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 113     @Override                                                                                            </span>
<span class="6957345652409804029" onmouseenter="enter('6957345652409804029');" onmouseout="out('6957345652409804029');" style=""> 114     public String cleanStringWithResults(String string) throws ServiceException {                        </span>
<span class="5378446896749936106" onmouseenter="enter('5378446896749936106');" onmouseout="out('5378446896749936106');" style=""> 115         if ((!xssProtectionEnabled) || StringUtils.isEmpty(string)) {                                    </span>
<span class="8152157400372312470" onmouseenter="enter('8152157400372312470');" onmouseout="out('8152157400372312470');" style=""> 116             return string;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 117         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 118         try {                                                                                            </span>
<span class="3719546269160040656" onmouseenter="enter('3719546269160040656');" onmouseout="out('3719546269160040656');" style=""> 119             CleanResults results = as.scan(string, antiSamyPolicy);                                      </span>
<span class="6620008653670353106" onmouseenter="enter('6620008653670353106');" onmouseout="out('6620008653670353106');" style=""> 120             if (results.getNumberOfErrors() &gt; 0) {                                                       </span>
<span class="1000732835935543819" onmouseenter="enter('1000732835935543819');" onmouseout="out('1000732835935543819');" style=""> 121                 throw new CleanStringException(results);                                                 </span>
<span class="5793294318824058002" onmouseenter="enter('5793294318824058002');" onmouseout="out('5793294318824058002');" style=""><abbr title=" 122             } else //ok no errors, but what if it has regular string with javascript:xxx and it possibly can be used to construct anchor link"> 122             } else //ok no errors, but what if it has regular string with javascript:xxx and it possibly ðŸ”µ</abbr></span>
<span class="7717622633225589961" onmouseenter="enter('7717622633225589961');" onmouseout="out('7717622633225589961');" style=""> 123             if (                                                                                         </span>
<span class="-6681681893462133916" onmouseenter="enter('-6681681893462133916');" onmouseout="out('-6681681893462133916');" style=""> 124 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT                                                                                             </span>
<span class="1496728843045818064" onmouseenter="enter('1496728843045818064');" onmouseout="out('1496728843045818064');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125 string.toLowerCase().startsWith(&quot;javascript&quot;)                                                            </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 126 ||||||| BASE                                                                                             </span>
<span class="-3639349873877828882" onmouseenter="enter('-3639349873877828882');" onmouseout="out('-3639349873877828882');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 127 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 127 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 128 =======                                                                                                  </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129                                                                                                          </span>
<span class="-8557293948919830285" onmouseenter="enter('-8557293948919830285');" onmouseout="out('-8557293948919830285');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130 string.toLowerCase().startsWith(JAVASCRIPT)                                                              </span>
<span class="-1814092468913316143" onmouseenter="enter('-1814092468913316143');" onmouseout="out('-1814092468913316143');" style=""> 131 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT                                                                                            </span>
<span class="-1344992967432647558" onmouseenter="enter('-1344992967432647558');" onmouseout="out('-1344992967432647558');" style=""> 132             ) {                                                                                          </span>
<span class="1000732835935543819" onmouseenter="enter('1000732835935543819');" onmouseout="out('1000732835935543819');" style=""> 133                 throw new CleanStringException(results);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 134             }                                                                                            </span>
<span class="-4993842330815521799" onmouseenter="enter('-4993842330815521799');" onmouseout="out('-4993842330815521799');" style=""> 135             return results.getCleanHTML();                                                               </span>
<span class="522446021072007597" onmouseenter="enter('522446021072007597');" onmouseout="out('522446021072007597');" style=""> 136         } catch (CleanStringException e) {                                                               </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 137             throw e;                                                                                     </span>
<span class="-3589222456918676513" onmouseenter="enter('-3589222456918676513');" onmouseout="out('-3589222456918676513');" style=""> 138         } catch (java.lang.Exception e) {                                                                </span>
<span class="-8642289478502472483" onmouseenter="enter('-8642289478502472483');" onmouseout="out('-8642289478502472483');" style=""> 139             StringBuilder sb = new StringBuilder();                                                      </span>
<span class="8547071428257112481" onmouseenter="enter('8547071428257112481');" onmouseout="out('8547071428257112481');" style=""> 140             sb.append(&quot;Unable to clean the passed in entity values&quot;);                                    </span>
<span class="2140406039510895093" onmouseenter="enter('2140406039510895093');" onmouseout="out('2140406039510895093');" style=""> 141             sb.append(&quot;\nNote - &quot;);                                                                      </span>
<span class="-8281191545228522440" onmouseenter="enter('-8281191545228522440');" onmouseout="out('-8281191545228522440');" style=""> 142             sb.append(getAntiSamyPolicyFileLocation());                                                  </span>
<span class="5644375583917836025" onmouseenter="enter('5644375583917836025');" onmouseout="out('5644375583917836025');" style=""><abbr title=" 143             sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.&quot;);"> 143             sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.ðŸ”µ</abbr></span>
<span class="8762389184290087645" onmouseenter="enter('8762389184290087645');" onmouseout="out('8762389184290087645');" style=""> 144             LOG.error(sb.toString(), e);                                                                 </span>
<span class="6944673230759443700" onmouseenter="enter('6944673230759443700');" onmouseout="out('6944673230759443700');" style=""> 145             throw new ServiceException(sb.toString(), e);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 146         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147     }                                                                                                    </span>
<span  style=""> 148                                                                                                          </span>
<span class="-2764905234348603584" onmouseenter="enter('-2764905234348603584');" onmouseout="out('-2764905234348603584');" style=""> 149     protected boolean hasHTMLTags(String text){                                                          </span>
<span class="9198642012760827534" onmouseenter="enter('9198642012760827534');" onmouseout="out('9198642012760827534');" style=""> 150         Matcher matcher = pattern.matcher(text);                                                         </span>
<span class="4330132740674744148" onmouseenter="enter('4330132740674744148');" onmouseout="out('4330132740674744148');" style=""> 151         return matcher.find();                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 152     }                                                                                                    </span>
<span  style=""> 153                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 154     @Override                                                                                            </span>
<span class="648464666007064624" onmouseenter="enter('648464666007064624');" onmouseout="out('648464666007064624');" style=""> 155     public void compareToken(String passedToken) throws ServiceException {                               </span>
<span class="6844728555353595853" onmouseenter="enter('6844728555353595853');" onmouseout="out('6844728555353595853');" style=""> 156         if (xsrfProtectionEnabled) {                                                                     </span>
<span class="7666852928030705963" onmouseenter="enter('7666852928030705963');" onmouseout="out('7666852928030705963');" style=""> 157             if (!getCSRFToken().equals(passedToken)) {                                                   </span>
<span class="-7786080020397166211" onmouseenter="enter('-7786080020397166211');" onmouseout="out('-7786080020397166211');" style=""><abbr title=" 158                 throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expired.&quot;);"> 158                 throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 159             } else {                                                                                     </span>
<span class="-1749099532355983279" onmouseenter="enter('-1749099532355983279');" onmouseout="out('-1749099532355983279');" style=""> 160                 LOG.debug(&quot;Validated CSRF token&quot;);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 162         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 163     }                                                                                                    </span>
<span  style=""> 164                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 165     @Override                                                                                            </span>
<span class="-2908233649961592868" onmouseenter="enter('-2908233649961592868');" onmouseout="out('-2908233649961592868');" style=""> 166     public String getCSRFToken() throws ServiceException {                                               </span>
<span class="-7374102838628651207" onmouseenter="enter('-7374102838628651207');" onmouseout="out('-7374102838628651207');" style=""><abbr title=" 167         //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated instance."> 167         //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated ðŸ”µ</abbr></span>
<span class="4360254575720880810" onmouseenter="enter('4360254575720880810');" onmouseout="out('4360254575720880810');" style=""> 168         HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();  </span>
<span class="-8754897222759985477" onmouseenter="enter('-8754897222759985477');" onmouseout="out('-8754897222759985477');" style=""> 169         if (request == null) {                                                                           </span>
<span class="5506354016540775394" onmouseenter="enter('5506354016540775394');" onmouseout="out('5506354016540775394');" style=""><abbr title=" 170             //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holder"> 170             //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holdðŸ”µ</abbr></span>
<span class="-4990660252016144867" onmouseenter="enter('-4990660252016144867');" onmouseout="out('-4990660252016144867');" style=""><abbr title=" 171             request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();"> 171             request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequestðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 172         }                                                                                                </span>
<span  style=""> 173                                                                                                          </span>
<span class="-7858468375027211236" onmouseenter="enter('-7858468375027211236');" onmouseout="out('-7858468375027211236');" style=""> 174         if (BLCRequestUtils.isOKtoUseSession(new ServletWebRequest(request))) {                          </span>
<span class="4564433423788020137" onmouseenter="enter('4564433423788020137');" onmouseout="out('4564433423788020137');" style=""> 175             HttpSession session = request.getSession();                                                  </span>
<span class="3674149774037115881" onmouseenter="enter('3674149774037115881');" onmouseout="out('3674149774037115881');" style=""> 176             String token = (String) session.getAttribute(CSRFTOKEN);                                     </span>
<span class="3304317599319354346" onmouseenter="enter('3304317599319354346');" onmouseout="out('3304317599319354346');" style=""> 177             if (StringUtils.isEmpty(token)) {                                                            </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 178                 try {                                                                                    </span>
<span class="421293466978398183" onmouseenter="enter('421293466978398183');" onmouseout="out('421293466978398183');" style=""> 179                     token = RandomGenerator.generateRandomId(&quot;SHA1PRNG&quot;, 32);                            </span>
<span class="-7636130466757008337" onmouseenter="enter('-7636130466757008337');" onmouseout="out('-7636130466757008337');" style=""> 180                 } catch (NoSuchAlgorithmException e) {                                                   </span>
<span class="-3918768481161186829" onmouseenter="enter('-3918768481161186829');" onmouseout="out('-3918768481161186829');" style=""> 181                     LOG.error(&quot;Unable to generate random number&quot;, e);                                    </span>
<span class="1263583644110830904" onmouseenter="enter('1263583644110830904');" onmouseout="out('1263583644110830904');" style=""> 182                     throw new ServiceException(&quot;Unable to generate random number&quot;, e);                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183                 }                                                                                        </span>
<span class="-1497228977843385516" onmouseenter="enter('-1497228977843385516');" onmouseout="out('-1497228977843385516');" style=""> 184                 session.setAttribute(CSRFTOKEN, token);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 185             }                                                                                            </span>
<span class="263037551027375388" onmouseenter="enter('263037551027375388');" onmouseout="out('263037551027375388');" style=""> 186             return token;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 187         }                                                                                                </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 188         return null;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189     }                                                                                                    </span>
<span  style=""> 190                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 191     @Override                                                                                            </span>
<span class="1999013554829426715" onmouseenter="enter('1999013554829426715');" onmouseout="out('1999013554829426715');" style=""> 192     public String getAntiSamyPolicyFileLocation() {                                                      </span>
<span class="-2303053444344810326" onmouseenter="enter('-2303053444344810326');" onmouseout="out('-2303053444344810326');" style=""> 193         return antiSamyPolicyFileLocation;                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 194     }                                                                                                    </span>
<span  style=""> 195                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 196     @Override                                                                                            </span>
<span class="8594302017839572248" onmouseenter="enter('8594302017839572248');" onmouseout="out('8594302017839572248');" style=""> 197     public void setAntiSamyPolicyFileLocation(String antiSamyPolicyFileLocation) {                       </span>
<span class="-4970186044531545303" onmouseenter="enter('-4970186044531545303');" onmouseout="out('-4970186044531545303');" style=""> 198         this.antiSamyPolicyFileLocation = antiSamyPolicyFileLocation;                                    </span>
<span class="5908386672201459822" onmouseenter="enter('5908386672201459822');" onmouseout="out('5908386672201459822');" style=""> 199         antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 200     }                                                                                                    </span>
<span  style=""> 201                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 202     @Override                                                                                            </span>
<span class="-9133900204457152332" onmouseenter="enter('-9133900204457152332');" onmouseout="out('-9133900204457152332');" style=""> 203     public String getCsrfTokenParameter() {                                                              </span>
<span class="-707553498228991610" onmouseenter="enter('-707553498228991610');" onmouseout="out('-707553498228991610');" style=""> 204         return CSRFTOKENPARAMETER;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 205     }                                                                                                    </span>
<span  style=""> 206                                                                                                          </span>
<span class="2679016982828970129" onmouseenter="enter('2679016982828970129');" onmouseout="out('2679016982828970129');" style=""> 207     public void setXssProtectionEnabled(boolean xssProtectionEnabled) {                                  </span>
<span class="-6551933069661854213" onmouseenter="enter('-6551933069661854213');" onmouseout="out('-6551933069661854213');" style=""> 208         this.xssProtectionEnabled = xssProtectionEnabled;                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 209     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 210 }                                                                                                        </span></pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-4573490878212285276" onmouseenter="enter('-4573490878212285276');" onmouseout="out('-4573490878212285276');" style="">   3   * BroadleafCommerce Common Libraries                                                                             </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-8883203776714723065" onmouseenter="enter('-8883203776714723065');" onmouseout="out('-8883203776714723065');" style="">  18  package org.broadleafcommerce.common.security.service;                                                            </span>
<span  style="">  19                                                                                                                    </span>
<span class="7952073036463698968" onmouseenter="enter('7952073036463698968');" onmouseout="out('7952073036463698968');" style="">  20  import org.apache.commons.lang.StringUtils;                                                                       </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  21  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  22  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="5945096539699516699" onmouseenter="enter('5945096539699516699');" onmouseout="out('5945096539699516699');" style="">  23  import org.broadleafcommerce.common.exception.ServiceException;                                                   </span>
<span class="3835463558667680002" onmouseenter="enter('3835463558667680002');" onmouseout="out('3835463558667680002');" style="">  24  import org.broadleafcommerce.common.security.RandomGenerator;                                                     </span>
<span class="-6556509414411446728" onmouseenter="enter('-6556509414411446728');" onmouseout="out('-6556509414411446728');" style="">  25  import org.broadleafcommerce.common.util.BLCRequestUtils;                                                         </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  26  import org.broadleafcommerce.common.web.BroadleafRequestContext;                                                  </span>
<span class="-8732799094142472106" onmouseenter="enter('-8732799094142472106');" onmouseout="out('-8732799094142472106');" style="">  27  import org.owasp.validator.html.AntiSamy;                                                                         </span>
<span class="-2632485097715966841" onmouseenter="enter('-2632485097715966841');" onmouseout="out('-2632485097715966841');" style="">  28  import org.owasp.validator.html.CleanResults;                                                                     </span>
<span class="3991596715890294789" onmouseenter="enter('3991596715890294789');" onmouseout="out('3991596715890294789');" style="">  29  import org.owasp.validator.html.Policy;                                                                           </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  30  import org.springframework.beans.factory.annotation.Value;                                                        </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  31  import org.springframework.stereotype.Service;                                                                    </span>
<span class="6793981704939320962" onmouseenter="enter('6793981704939320962');" onmouseout="out('6793981704939320962');" style="">  32  import org.springframework.web.context.request.RequestContextHolder;                                              </span>
<span class="-3977424511564612993" onmouseenter="enter('-3977424511564612993');" onmouseout="out('-3977424511564612993');" style="">  33  import org.springframework.web.context.request.ServletRequestAttributes;                                          </span>
<span class="-208569050100229982" onmouseenter="enter('-208569050100229982');" onmouseout="out('-208569050100229982');" style="">  34  import org.springframework.web.context.request.ServletWebRequest;                                                 </span>
<span class="6387767356345417225" onmouseenter="enter('6387767356345417225');" onmouseout="out('6387767356345417225');" style="">  35  import org.springframework.web.util.HtmlUtils;                                                                    </span>
<span  style="">  36                                                                                                                    </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  37  import java.io.IOException;                                                                                       </span>
<span class="-5598187278321027129" onmouseenter="enter('-5598187278321027129');" onmouseout="out('-5598187278321027129');" style="">  38  import java.net.URL;                                                                                              </span>
<span class="-5521468699455618699" onmouseenter="enter('-5521468699455618699');" onmouseout="out('-5521468699455618699');" style="">  39  import java.net.URLConnection;                                                                                    </span>
<span class="-4333778487385766125" onmouseenter="enter('-4333778487385766125');" onmouseout="out('-4333778487385766125');" style="">  40  import java.net.URLStreamHandler;                                                                                 </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  41  import java.security.NoSuchAlgorithmException;                                                                    </span>
<span class="2159928926335330273" onmouseenter="enter('2159928926335330273');" onmouseout="out('2159928926335330273');" style="">  42  import java.util.regex.Matcher;                                                                                   </span>
<span class="1513108047920599059" onmouseenter="enter('1513108047920599059');" onmouseout="out('1513108047920599059');" style="">  43  import java.util.regex.Pattern;                                                                                   </span>
<span  style="">  44                                                                                                                    </span>
<span class="-2972028083581866805" onmouseenter="enter('-2972028083581866805');" onmouseout="out('-2972028083581866805');" style="">  45  import javax.servlet.http.HttpServletRequest;                                                                     </span>
<span class="8881497316694208384" onmouseenter="enter('8881497316694208384');" onmouseout="out('8881497316694208384');" style="">  46  import javax.servlet.http.HttpSession;                                                                            </span>
<span  style="">  47                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  48  /**                                                                                                               </span>
<span class="3104529581940833663" onmouseenter="enter('3104529581940833663');" onmouseout="out('3104529581940833663');" style="">  49   * @author jfischer                                                                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  50   */                                                                                                               </span>
<span class="4656496461683189908" onmouseenter="enter('4656496461683189908');" onmouseout="out('4656496461683189908');" style="">  51  @Service(&quot;blExploitProtectionService&quot;)                                                                            </span>
<span class="-7577265369649440547" onmouseenter="enter('-7577265369649440547');" onmouseout="out('-7577265369649440547');" style="">  52  public class ExploitProtectionServiceImpl implements ExploitProtectionService {                                   </span>
<span  style="">  53                                                                                                                    </span>
<span class="-5831399856344568636" onmouseenter="enter('-5831399856344568636');" onmouseout="out('-5831399856344568636');" style="">  54      private static final String CSRFTOKEN = &quot;csrfToken&quot;;                                                          </span>
<span class="4054840031468773172" onmouseenter="enter('4054840031468773172');" onmouseout="out('4054840031468773172');" style="">  55      private static final String CSRFTOKENPARAMETER = &quot;csrfToken&quot;;                                                 </span>
<span class="-3587117648406762558" onmouseenter="enter('-3587117648406762558');" onmouseout="out('-3587117648406762558');" style="">  56      private static final Log LOG = LogFactory.getLog(ExploitProtectionServiceImpl.class);                         </span>

<span  style="">  57                                                                                                                    </span>
<span class="-1677855597483692443" onmouseenter="enter('-1677855597483692443');" onmouseout="out('-1677855597483692443');" style="">  58      private static class Handler extends URLStreamHandler {                                                       </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  59          @Override                                                                                                 </span>
<span class="4194659681324326585" onmouseenter="enter('4194659681324326585');" onmouseout="out('4194659681324326585');" style="">  60          protected URLConnection openConnection(URL u) throws IOException {                                        </span>
<span class="3399592013355094643" onmouseenter="enter('3399592013355094643');" onmouseout="out('3399592013355094643');" style="">  61              URL resourceUrl = getClass().getClassLoader().getResource(u.getPath());                               </span>
<span class="-3140647383470477526" onmouseenter="enter('-3140647383470477526');" onmouseout="out('-3140647383470477526');" style="">  62              return resourceUrl.openConnection();                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  63          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  64      }                                                                                                             </span>
<span  style="">  65                                                                                                                    </span>
<span class="-8848917178886287682" onmouseenter="enter('-8848917178886287682');" onmouseout="out('-8848917178886287682');" style="">  66      private static Policy getAntiSamyPolicy(String policyFileLocation) {                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  67          try {                                                                                                     </span>
<span class="-6525552564951312691" onmouseenter="enter('-6525552564951312691');" onmouseout="out('-6525552564951312691');" style="">  68              URL url = new URL(null, policyFileLocation, new Handler());                                           </span>
<span class="-5530491709875789570" onmouseenter="enter('-5530491709875789570');" onmouseout="out('-5530491709875789570');" style="">  69              return Policy.getInstance(url);                                                                       </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style="">  70          } catch (Exception e) {                                                                                   </span>
<span class="-5494209266994971292" onmouseenter="enter('-5494209266994971292');" onmouseout="out('-5494209266994971292');" style="">  71              throw new RuntimeException(&quot;Unable to create URL&quot;, e);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  72          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  73      }                                                                                                             </span>
<span  style="">  74                                                                                                                    </span>
<span class="-8454650068140773264" onmouseenter="enter('-8454650068140773264');" onmouseout="out('-8454650068140773264');" style="">  75      private static final String DEFAULTANTISAMYPOLICYFILELOCATION = &quot;classpath:antisamy-myspace.xml&quot;;             </span>
<span  style="">  76                                                                                                                    </span>
<span class="-3769185808508381094" onmouseenter="enter('-3769185808508381094');" onmouseout="out('-3769185808508381094');" style="">  77      protected String antiSamyPolicyFileLocation = DEFAULTANTISAMYPOLICYFILELOCATION;                              </span>
<span class="-2092034659289993705" onmouseenter="enter('-2092034659289993705');" onmouseout="out('-2092034659289993705');" style="">  78      //this is thread safe                                                                                         </span>
<span class="-5052904289597337609" onmouseenter="enter('-5052904289597337609');" onmouseout="out('-5052904289597337609');" style="">  79      private Policy antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);                                </span>
<span class="-3549700451460963582" onmouseenter="enter('-3549700451460963582');" onmouseout="out('-3549700451460963582');" style="">  80      //this is thread safe for the usage of scan()                                                                 </span>
<span class="-511658793236644044" onmouseenter="enter('-511658793236644044');" onmouseout="out('-511658793236644044');" style="">  81      private final AntiSamy as = new AntiSamy();                                                                   </span>
<span  style="">  82                                                                                                                    </span>
<span class="7158989760436170559" onmouseenter="enter('7158989760436170559');" onmouseout="out('7158989760436170559');" style="">  83      @Value(&quot;${exploitProtection.xsrfEnabled:true}&quot;)                                                               </span>
<span class="-2564124477522755746" onmouseenter="enter('-2564124477522755746');" onmouseout="out('-2564124477522755746');" style="">  84      protected boolean xsrfProtectionEnabled;                                                                      </span>
<span  style="">  85                                                                                                                    </span>
<span class="-4505422957119254609" onmouseenter="enter('-4505422957119254609');" onmouseout="out('-4505422957119254609');" style="">  86      @Value(&quot;${exploitProtection.xssEnabled:true}&quot;)                                                                </span>
<span class="3841797600292304306" onmouseenter="enter('3841797600292304306');" onmouseout="out('3841797600292304306');" style="">  87      protected boolean xssProtectionEnabled;                                                                       </span>
<span  style="">  88                                                                                                                    </span>
<span class="-370742803470628032" onmouseenter="enter('-370742803470628032');" onmouseout="out('-370742803470628032');" style="">  89      private static final String HTML_PATTERN = &quot;&lt;(\&quot;[^\&quot;]*\&quot;|&#x27;[^&#x27;]*&#x27;|[^&#x27;\&quot;&gt;])*&gt;&quot;;                                 </span>
<span class="6568771706925125326" onmouseenter="enter('6568771706925125326');" onmouseout="out('6568771706925125326');" style="">  90      private Pattern pattern = Pattern.compile(HTML_PATTERN);                                                      </span>
<span  style="">  91                                                                                                                    </span>
<span  style="">  92                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  93      @Override                                                                                                     </span>
<span class="7723107530827058384" onmouseenter="enter('7723107530827058384');" onmouseout="out('7723107530827058384');" style="">  94      public String cleanString(String string) throws ServiceException {                                            </span>
<span class="8556081284105346376" onmouseenter="enter('8556081284105346376');" onmouseout="out('8556081284105346376');" style="">  95          if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {                                               </span>
<span class="8152157400372312470" onmouseenter="enter('8152157400372312470');" onmouseout="out('8152157400372312470');" style="">  96              return string;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  97          }                                                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  98          try {                                                                                                     </span>
<span class="3719546269160040656" onmouseenter="enter('3719546269160040656');" onmouseout="out('3719546269160040656');" style="">  99              CleanResults results = as.scan(string, antiSamyPolicy);                                               </span>
<span class="-4993842330815521799" onmouseenter="enter('-4993842330815521799');" onmouseout="out('-4993842330815521799');" style=""> 100              return results.getCleanHTML();                                                                        </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 101          } catch (Exception e) {                                                                                   </span>
<span class="-3714012217960046682" onmouseenter="enter('-3714012217960046682');" onmouseout="out('-3714012217960046682');" style=""> 102              LOG.error(&quot;Unable to clean the passed in entity values&quot;, e);                                          </span>
<span class="-4231105004970935433" onmouseenter="enter('-4231105004970935433');" onmouseout="out('-4231105004970935433');" style=""> 103              throw new ServiceException(&quot;Unable to clean the passed in entity values&quot;, e);                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 104          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 105      }                                                                                                             </span>
<span  style=""> 106                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 107      @Override                                                                                                     </span>
<span class="6957345652409804029" onmouseenter="enter('6957345652409804029');" onmouseout="out('6957345652409804029');" style=""> 108      public String cleanStringWithResults(String string) throws ServiceException {                                 </span>
<span class="8556081284105346376" onmouseenter="enter('8556081284105346376');" onmouseout="out('8556081284105346376');" style=""> 109          if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {                                               </span>
<span class="8152157400372312470" onmouseenter="enter('8152157400372312470');" onmouseout="out('8152157400372312470');" style=""> 110              return string;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 111          }                                                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 112          try {                                                                                                     </span>
<span class="3719546269160040656" onmouseenter="enter('3719546269160040656');" onmouseout="out('3719546269160040656');" style=""> 113              CleanResults results = as.scan(string, antiSamyPolicy);                                               </span>
<span class="6620008653670353106" onmouseenter="enter('6620008653670353106');" onmouseout="out('6620008653670353106');" style=""> 114              if (results.getNumberOfErrors() &gt; 0) {                                                                </span>
<span class="1000732835935543819" onmouseenter="enter('1000732835935543819');" onmouseout="out('1000732835935543819');" style=""> 115                  throw new CleanStringException(results);                                                          </span>
<span class="2918192000430827733" onmouseenter="enter('2918192000430827733');" onmouseout="out('2918192000430827733');" style=""> 116              }else{                                                                                                </span>
<span class="-4795652360206896091" onmouseenter="enter('-4795652360206896091');" onmouseout="out('-4795652360206896091');" style=""><abbr title=" 117                  //ok no errors, but what if it has regular string with javascript:xxx and it possibly can be used to construct anchor link"> 117                  //ok no errors, but what if it has regular string with javascript:xxx and it possibly can be used ðŸ”µ</abbr></span>
<span class="-2693852864669979181" onmouseenter="enter('-2693852864669979181');" onmouseout="out('-2693852864669979181');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 118 -                // let&#x27;s maybe try wrap string into &lt;a href=&quot;string&quot;&gt;qqq&lt;/a&gt;                                      </span>
<span class="-4670124309314849634" onmouseenter="enter('-4670124309314849634');" onmouseout="out('-4670124309314849634');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 119 -                if(!hasHTMLTags(string)){                                                                         </span>
<span class="-2532407930978426494" onmouseenter="enter('-2532407930978426494');" onmouseout="out('-2532407930978426494');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"><abbr title=" 120 -                    CleanResults resultsTemp = as.scan(&quot;&lt;a href=\&quot;&quot; + HtmlUtils.htmlEscape(string) + &quot;\&quot;/&gt;tt&lt;/a&gt;&quot;, antiSamyPolicy);"> 120 -                    CleanResults resultsTemp = as.scan(&quot;&lt;a href=\&quot;&quot; + HtmlUtils.htmlEscape(string) + &quot;\&quot;/&gt;tt&lt;/a&gt;&quot;,ðŸ”µ</abbr></span>
<span class="-6529348574061263195" onmouseenter="enter('-6529348574061263195');" onmouseout="out('-6529348574061263195');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 121 -                    if (resultsTemp.getNumberOfErrors() &gt; 0) {                                                    </span>
<span class="1000732835935543819" onmouseenter="enter('1000732835935543819');" onmouseout="out('1000732835935543819');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 122 -                        throw new CleanStringException(results);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 123 -                    }                                                                                             </span>
<span class="3256541859477974579" onmouseenter="enter('3256541859477974579');" onmouseout="out('3256541859477974579');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +                if (string.toLowerCase().startsWith(&quot;javascript&quot;)) {                                              </span>
<span class="1000732835935543819" onmouseenter="enter('1000732835935543819');" onmouseout="out('1000732835935543819');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +                    throw new CleanStringException(results);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 126                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 127              }                                                                                                     </span>
<span class="-4993842330815521799" onmouseenter="enter('-4993842330815521799');" onmouseout="out('-4993842330815521799');" style=""> 128              return results.getCleanHTML();                                                                        </span>
<span class="522446021072007597" onmouseenter="enter('522446021072007597');" onmouseout="out('522446021072007597');" style=""> 129          } catch (CleanStringException e) {                                                                        </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 130              throw e;                                                                                              </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 131          } catch (Exception e) {                                                                                   </span>
<span class="-8642289478502472483" onmouseenter="enter('-8642289478502472483');" onmouseout="out('-8642289478502472483');" style=""> 132              StringBuilder sb = new StringBuilder();                                                               </span>
<span class="8547071428257112481" onmouseenter="enter('8547071428257112481');" onmouseout="out('8547071428257112481');" style=""> 133              sb.append(&quot;Unable to clean the passed in entity values&quot;);                                             </span>
<span class="2140406039510895093" onmouseenter="enter('2140406039510895093');" onmouseout="out('2140406039510895093');" style=""> 134              sb.append(&quot;\nNote - &quot;);                                                                               </span>
<span class="-8281191545228522440" onmouseenter="enter('-8281191545228522440');" onmouseout="out('-8281191545228522440');" style=""> 135              sb.append(getAntiSamyPolicyFileLocation());                                                           </span>
<span class="5644375583917836025" onmouseenter="enter('5644375583917836025');" onmouseout="out('5644375583917836025');" style=""> 136              sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.&quot;);      </span>
<span class="8762389184290087645" onmouseenter="enter('8762389184290087645');" onmouseout="out('8762389184290087645');" style=""> 137              LOG.error(sb.toString(), e);                                                                          </span>
<span class="6944673230759443700" onmouseenter="enter('6944673230759443700');" onmouseout="out('6944673230759443700');" style=""> 138              throw new ServiceException(sb.toString(), e);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 139          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 140      }                                                                                                             </span>
<span  style=""> 141                                                                                                                    </span>
<span  style=""> 142                                                                                                                    </span>
<span class="-2764905234348603584" onmouseenter="enter('-2764905234348603584');" onmouseout="out('-2764905234348603584');" style=""> 143      protected boolean hasHTMLTags(String text){                                                                   </span>
<span class="9198642012760827534" onmouseenter="enter('9198642012760827534');" onmouseout="out('9198642012760827534');" style=""> 144          Matcher matcher = pattern.matcher(text);                                                                  </span>
<span class="4330132740674744148" onmouseenter="enter('4330132740674744148');" onmouseout="out('4330132740674744148');" style=""> 145          return matcher.find();                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 146      }                                                                                                             </span>
<span  style=""> 147                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 148      @Override                                                                                                     </span>
<span class="648464666007064624" onmouseenter="enter('648464666007064624');" onmouseout="out('648464666007064624');" style=""> 149      public void compareToken(String passedToken) throws ServiceException {                                        </span>
<span class="6844728555353595853" onmouseenter="enter('6844728555353595853');" onmouseout="out('6844728555353595853');" style=""> 150          if (xsrfProtectionEnabled) {                                                                              </span>
<span class="7666852928030705963" onmouseenter="enter('7666852928030705963');" onmouseout="out('7666852928030705963');" style=""> 151              if (!getCSRFToken().equals(passedToken)) {                                                            </span>
<span class="-7786080020397166211" onmouseenter="enter('-7786080020397166211');" onmouseout="out('-7786080020397166211');" style=""> 152                  throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expired.&quot;); </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 153              } else {                                                                                              </span>
<span class="-1749099532355983279" onmouseenter="enter('-1749099532355983279');" onmouseout="out('-1749099532355983279');" style=""> 154                  LOG.debug(&quot;Validated CSRF token&quot;);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 155              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 156          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 157      }                                                                                                             </span>
<span  style=""> 158                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 159      @Override                                                                                                     </span>
<span class="-2908233649961592868" onmouseenter="enter('-2908233649961592868');" onmouseout="out('-2908233649961592868');" style=""> 160      public String getCSRFToken() throws ServiceException {                                                        </span>
<span class="-7374102838628651207" onmouseenter="enter('-7374102838628651207');" onmouseout="out('-7374102838628651207');" style=""> 161          //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated instance.</span>
<span class="4360254575720880810" onmouseenter="enter('4360254575720880810');" onmouseout="out('4360254575720880810');" style=""> 162          HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();           </span>
<span class="-8754897222759985477" onmouseenter="enter('-8754897222759985477');" onmouseout="out('-8754897222759985477');" style=""> 163          if (request == null) {                                                                                    </span>
<span class="5506354016540775394" onmouseenter="enter('5506354016540775394');" onmouseout="out('5506354016540775394');" style=""> 164              //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holder       </span>
<span class="-4990660252016144867" onmouseenter="enter('-4990660252016144867');" onmouseout="out('-4990660252016144867');" style=""> 165              request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 166          }                                                                                                         </span>
<span  style=""> 167                                                                                                                    </span>
<span class="-7858468375027211236" onmouseenter="enter('-7858468375027211236');" onmouseout="out('-7858468375027211236');" style=""> 168          if (BLCRequestUtils.isOKtoUseSession(new ServletWebRequest(request))) {                                   </span>
<span class="4564433423788020137" onmouseenter="enter('4564433423788020137');" onmouseout="out('4564433423788020137');" style=""> 169              HttpSession session = request.getSession();                                                           </span>
<span class="3674149774037115881" onmouseenter="enter('3674149774037115881');" onmouseout="out('3674149774037115881');" style=""> 170              String token = (String) session.getAttribute(CSRFTOKEN);                                              </span>
<span class="3304317599319354346" onmouseenter="enter('3304317599319354346');" onmouseout="out('3304317599319354346');" style=""> 171              if (StringUtils.isEmpty(token)) {                                                                     </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 172                  try {                                                                                             </span>
<span class="421293466978398183" onmouseenter="enter('421293466978398183');" onmouseout="out('421293466978398183');" style=""> 173                      token = RandomGenerator.generateRandomId(&quot;SHA1PRNG&quot;, 32);                                     </span>
<span class="-7636130466757008337" onmouseenter="enter('-7636130466757008337');" onmouseout="out('-7636130466757008337');" style=""> 174                  } catch (NoSuchAlgorithmException e) {                                                            </span>
<span class="-3918768481161186829" onmouseenter="enter('-3918768481161186829');" onmouseout="out('-3918768481161186829');" style=""> 175                      LOG.error(&quot;Unable to generate random number&quot;, e);                                             </span>
<span class="1263583644110830904" onmouseenter="enter('1263583644110830904');" onmouseout="out('1263583644110830904');" style=""> 176                      throw new ServiceException(&quot;Unable to generate random number&quot;, e);                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 177                  }                                                                                                 </span>
<span class="-1497228977843385516" onmouseenter="enter('-1497228977843385516');" onmouseout="out('-1497228977843385516');" style=""> 178                  session.setAttribute(CSRFTOKEN, token);                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179              }                                                                                                     </span>
<span class="263037551027375388" onmouseenter="enter('263037551027375388');" onmouseout="out('263037551027375388');" style=""> 180              return token;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181          }                                                                                                         </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 182          return null;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183      }                                                                                                             </span>
<span  style=""> 184                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 185      @Override                                                                                                     </span>
<span class="1999013554829426715" onmouseenter="enter('1999013554829426715');" onmouseout="out('1999013554829426715');" style=""> 186      public String getAntiSamyPolicyFileLocation() {                                                               </span>
<span class="-2303053444344810326" onmouseenter="enter('-2303053444344810326');" onmouseout="out('-2303053444344810326');" style=""> 187          return antiSamyPolicyFileLocation;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 188      }                                                                                                             </span>
<span  style=""> 189                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 190      @Override                                                                                                     </span>
<span class="8594302017839572248" onmouseenter="enter('8594302017839572248');" onmouseout="out('8594302017839572248');" style=""> 191      public void setAntiSamyPolicyFileLocation(String antiSamyPolicyFileLocation) {                                </span>
<span class="-4970186044531545303" onmouseenter="enter('-4970186044531545303');" onmouseout="out('-4970186044531545303');" style=""> 192          this.antiSamyPolicyFileLocation = antiSamyPolicyFileLocation;                                             </span>
<span class="5908386672201459822" onmouseenter="enter('5908386672201459822');" onmouseout="out('5908386672201459822');" style=""> 193          antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 194      }                                                                                                             </span>
<span  style=""> 195                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 196      @Override                                                                                                     </span>
<span class="-9133900204457152332" onmouseenter="enter('-9133900204457152332');" onmouseout="out('-9133900204457152332');" style=""> 197      public String getCsrfTokenParameter() {                                                                       </span>
<span class="-707553498228991610" onmouseenter="enter('-707553498228991610');" onmouseout="out('-707553498228991610');" style=""> 198          return CSRFTOKENPARAMETER;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 199      }                                                                                                             </span>
<span  style=""> 200                                                                                                                    </span>
<span class="2679016982828970129" onmouseenter="enter('2679016982828970129');" onmouseout="out('2679016982828970129');" style=""> 201      public void setXssProtectionEnabled(boolean xssProtectionEnabled) {                                           </span>
<span class="-6551933069661854213" onmouseenter="enter('-6551933069661854213');" onmouseout="out('-6551933069661854213');" style=""> 202          this.xssProtectionEnabled = xssProtectionEnabled;                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 203      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 204  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-4573490878212285276" onmouseenter="enter('-4573490878212285276');" onmouseout="out('-4573490878212285276');" style="">   3   * BroadleafCommerce Common Libraries                                                                             </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-8883203776714723065" onmouseenter="enter('-8883203776714723065');" onmouseout="out('-8883203776714723065');" style="">  18  package org.broadleafcommerce.common.security.service;                                                            </span>
<span  style="">  19                                                                                                                    </span>
<span class="7952073036463698968" onmouseenter="enter('7952073036463698968');" onmouseout="out('7952073036463698968');" style="">  20  import org.apache.commons.lang.StringUtils;                                                                       </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  21  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  22  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="5945096539699516699" onmouseenter="enter('5945096539699516699');" onmouseout="out('5945096539699516699');" style="">  23  import org.broadleafcommerce.common.exception.ServiceException;                                                   </span>
<span class="3835463558667680002" onmouseenter="enter('3835463558667680002');" onmouseout="out('3835463558667680002');" style="">  24  import org.broadleafcommerce.common.security.RandomGenerator;                                                     </span>
<span class="-6556509414411446728" onmouseenter="enter('-6556509414411446728');" onmouseout="out('-6556509414411446728');" style="">  25  import org.broadleafcommerce.common.util.BLCRequestUtils;                                                         </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  26  import org.broadleafcommerce.common.web.BroadleafRequestContext;                                                  </span>
<span class="-8732799094142472106" onmouseenter="enter('-8732799094142472106');" onmouseout="out('-8732799094142472106');" style="">  27  import org.owasp.validator.html.AntiSamy;                                                                         </span>
<span class="-2632485097715966841" onmouseenter="enter('-2632485097715966841');" onmouseout="out('-2632485097715966841');" style="">  28  import org.owasp.validator.html.CleanResults;                                                                     </span>
<span class="3991596715890294789" onmouseenter="enter('3991596715890294789');" onmouseout="out('3991596715890294789');" style="">  29  import org.owasp.validator.html.Policy;                                                                           </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  30  import org.springframework.beans.factory.annotation.Value;                                                        </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  31  import org.springframework.stereotype.Service;                                                                    </span>
<span class="6793981704939320962" onmouseenter="enter('6793981704939320962');" onmouseout="out('6793981704939320962');" style="">  32  import org.springframework.web.context.request.RequestContextHolder;                                              </span>
<span class="-3977424511564612993" onmouseenter="enter('-3977424511564612993');" onmouseout="out('-3977424511564612993');" style="">  33  import org.springframework.web.context.request.ServletRequestAttributes;                                          </span>
<span class="-208569050100229982" onmouseenter="enter('-208569050100229982');" onmouseout="out('-208569050100229982');" style="">  34  import org.springframework.web.context.request.ServletWebRequest;                                                 </span>
<span class="6387767356345417225" onmouseenter="enter('6387767356345417225');" onmouseout="out('6387767356345417225');" style="">  35  import org.springframework.web.util.HtmlUtils;                                                                    </span>
<span  style="">  36                                                                                                                    </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  37  import java.io.IOException;                                                                                       </span>
<span class="-5598187278321027129" onmouseenter="enter('-5598187278321027129');" onmouseout="out('-5598187278321027129');" style="">  38  import java.net.URL;                                                                                              </span>
<span class="-5521468699455618699" onmouseenter="enter('-5521468699455618699');" onmouseout="out('-5521468699455618699');" style="">  39  import java.net.URLConnection;                                                                                    </span>
<span class="-4333778487385766125" onmouseenter="enter('-4333778487385766125');" onmouseout="out('-4333778487385766125');" style="">  40  import java.net.URLStreamHandler;                                                                                 </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  41  import java.security.NoSuchAlgorithmException;                                                                    </span>
<span class="2159928926335330273" onmouseenter="enter('2159928926335330273');" onmouseout="out('2159928926335330273');" style="">  42  import java.util.regex.Matcher;                                                                                   </span>
<span class="1513108047920599059" onmouseenter="enter('1513108047920599059');" onmouseout="out('1513108047920599059');" style="">  43  import java.util.regex.Pattern;                                                                                   </span>
<span  style="">  44                                                                                                                    </span>
<span class="-2972028083581866805" onmouseenter="enter('-2972028083581866805');" onmouseout="out('-2972028083581866805');" style="">  45  import javax.servlet.http.HttpServletRequest;                                                                     </span>
<span class="8881497316694208384" onmouseenter="enter('8881497316694208384');" onmouseout="out('8881497316694208384');" style="">  46  import javax.servlet.http.HttpSession;                                                                            </span>
<span  style="">  47                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  48  /**                                                                                                               </span>
<span class="3104529581940833663" onmouseenter="enter('3104529581940833663');" onmouseout="out('3104529581940833663');" style="">  49   * @author jfischer                                                                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  50   */                                                                                                               </span>
<span class="4656496461683189908" onmouseenter="enter('4656496461683189908');" onmouseout="out('4656496461683189908');" style="">  51  @Service(&quot;blExploitProtectionService&quot;)                                                                            </span>
<span class="-7577265369649440547" onmouseenter="enter('-7577265369649440547');" onmouseout="out('-7577265369649440547');" style="">  52  public class ExploitProtectionServiceImpl implements ExploitProtectionService {                                   </span>
<span  style="">  53                                                                                                                    </span>
<span class="-5831399856344568636" onmouseenter="enter('-5831399856344568636');" onmouseout="out('-5831399856344568636');" style="">  54      private static final String CSRFTOKEN = &quot;csrfToken&quot;;                                                          </span>
<span class="4054840031468773172" onmouseenter="enter('4054840031468773172');" onmouseout="out('4054840031468773172');" style="">  55      private static final String CSRFTOKENPARAMETER = &quot;csrfToken&quot;;                                                 </span>
<span class="-3587117648406762558" onmouseenter="enter('-3587117648406762558');" onmouseout="out('-3587117648406762558');" style="">  56      private static final Log LOG = LogFactory.getLog(ExploitProtectionServiceImpl.class);                         </span>
<span class="5243695742915787640" onmouseenter="enter('5243695742915787640');" onmouseout="out('5243695742915787640');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +    private static final String JAVASCRIPT = &quot;javascript&quot;;                                                        </span>
<span  style="">  58                                                                                                                    </span>
<span class="-1677855597483692443" onmouseenter="enter('-1677855597483692443');" onmouseout="out('-1677855597483692443');" style="">  59      private static class Handler extends URLStreamHandler {                                                       </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  60          @Override                                                                                                 </span>
<span class="4194659681324326585" onmouseenter="enter('4194659681324326585');" onmouseout="out('4194659681324326585');" style="">  61          protected URLConnection openConnection(URL u) throws IOException {                                        </span>
<span class="3399592013355094643" onmouseenter="enter('3399592013355094643');" onmouseout="out('3399592013355094643');" style="">  62              URL resourceUrl = getClass().getClassLoader().getResource(u.getPath());                               </span>
<span class="-3140647383470477526" onmouseenter="enter('-3140647383470477526');" onmouseout="out('-3140647383470477526');" style="">  63              return resourceUrl.openConnection();                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  64          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  65      }                                                                                                             </span>
<span  style="">  66                                                                                                                    </span>
<span class="-8848917178886287682" onmouseenter="enter('-8848917178886287682');" onmouseout="out('-8848917178886287682');" style="">  67      private static Policy getAntiSamyPolicy(String policyFileLocation) {                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  68          try {                                                                                                     </span>
<span class="-6525552564951312691" onmouseenter="enter('-6525552564951312691');" onmouseout="out('-6525552564951312691');" style="">  69              URL url = new URL(null, policyFileLocation, new Handler());                                           </span>
<span class="-5530491709875789570" onmouseenter="enter('-5530491709875789570');" onmouseout="out('-5530491709875789570');" style="">  70              return Policy.getInstance(url);                                                                       </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style="">  71          } catch (Exception e) {                                                                                   </span>
<span class="-5494209266994971292" onmouseenter="enter('-5494209266994971292');" onmouseout="out('-5494209266994971292');" style="">  72              throw new RuntimeException(&quot;Unable to create URL&quot;, e);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  73          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  74      }                                                                                                             </span>
<span  style="">  75                                                                                                                    </span>
<span class="-8454650068140773264" onmouseenter="enter('-8454650068140773264');" onmouseout="out('-8454650068140773264');" style="">  76      private static final String DEFAULTANTISAMYPOLICYFILELOCATION = &quot;classpath:antisamy-myspace.xml&quot;;             </span>
<span  style="">  77                                                                                                                    </span>
<span class="-3769185808508381094" onmouseenter="enter('-3769185808508381094');" onmouseout="out('-3769185808508381094');" style="">  78      protected String antiSamyPolicyFileLocation = DEFAULTANTISAMYPOLICYFILELOCATION;                              </span>
<span class="-2092034659289993705" onmouseenter="enter('-2092034659289993705');" onmouseout="out('-2092034659289993705');" style="">  79      //this is thread safe                                                                                         </span>
<span class="-5052904289597337609" onmouseenter="enter('-5052904289597337609');" onmouseout="out('-5052904289597337609');" style="">  80      private Policy antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);                                </span>
<span class="-3549700451460963582" onmouseenter="enter('-3549700451460963582');" onmouseout="out('-3549700451460963582');" style="">  81      //this is thread safe for the usage of scan()                                                                 </span>
<span class="-511658793236644044" onmouseenter="enter('-511658793236644044');" onmouseout="out('-511658793236644044');" style="">  82      private final AntiSamy as = new AntiSamy();                                                                   </span>
<span  style="">  83                                                                                                                    </span>
<span class="7158989760436170559" onmouseenter="enter('7158989760436170559');" onmouseout="out('7158989760436170559');" style="">  84      @Value(&quot;${exploitProtection.xsrfEnabled:true}&quot;)                                                               </span>
<span class="-2564124477522755746" onmouseenter="enter('-2564124477522755746');" onmouseout="out('-2564124477522755746');" style="">  85      protected boolean xsrfProtectionEnabled;                                                                      </span>
<span  style="">  86                                                                                                                    </span>
<span class="-4505422957119254609" onmouseenter="enter('-4505422957119254609');" onmouseout="out('-4505422957119254609');" style="">  87      @Value(&quot;${exploitProtection.xssEnabled:true}&quot;)                                                                </span>
<span class="3841797600292304306" onmouseenter="enter('3841797600292304306');" onmouseout="out('3841797600292304306');" style="">  88      protected boolean xssProtectionEnabled;                                                                       </span>
<span  style="">  89                                                                                                                    </span>
<span class="-370742803470628032" onmouseenter="enter('-370742803470628032');" onmouseout="out('-370742803470628032');" style="">  90      private static final String HTML_PATTERN = &quot;&lt;(\&quot;[^\&quot;]*\&quot;|&#x27;[^&#x27;]*&#x27;|[^&#x27;\&quot;&gt;])*&gt;&quot;;                                 </span>
<span class="6568771706925125326" onmouseenter="enter('6568771706925125326');" onmouseout="out('6568771706925125326');" style="">  91      private Pattern pattern = Pattern.compile(HTML_PATTERN);                                                      </span>
<span  style="">  92                                                                                                                    </span>
<span  style="">  93                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  94      @Override                                                                                                     </span>
<span class="7723107530827058384" onmouseenter="enter('7723107530827058384');" onmouseout="out('7723107530827058384');" style="">  95      public String cleanString(String string) throws ServiceException {                                            </span>
<span class="8556081284105346376" onmouseenter="enter('8556081284105346376');" onmouseout="out('8556081284105346376');" style="">  96          if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {                                               </span>
<span class="8152157400372312470" onmouseenter="enter('8152157400372312470');" onmouseout="out('8152157400372312470');" style="">  97              return string;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  98          }                                                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  99          try {                                                                                                     </span>
<span class="3719546269160040656" onmouseenter="enter('3719546269160040656');" onmouseout="out('3719546269160040656');" style=""> 100              CleanResults results = as.scan(string, antiSamyPolicy);                                               </span>
<span class="-4993842330815521799" onmouseenter="enter('-4993842330815521799');" onmouseout="out('-4993842330815521799');" style=""> 101              return results.getCleanHTML();                                                                        </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 102          } catch (Exception e) {                                                                                   </span>
<span class="-3714012217960046682" onmouseenter="enter('-3714012217960046682');" onmouseout="out('-3714012217960046682');" style=""> 103              LOG.error(&quot;Unable to clean the passed in entity values&quot;, e);                                          </span>
<span class="-4231105004970935433" onmouseenter="enter('-4231105004970935433');" onmouseout="out('-4231105004970935433');" style=""> 104              throw new ServiceException(&quot;Unable to clean the passed in entity values&quot;, e);                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 105          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 106      }                                                                                                             </span>
<span  style=""> 107                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 108      @Override                                                                                                     </span>
<span class="6957345652409804029" onmouseenter="enter('6957345652409804029');" onmouseout="out('6957345652409804029');" style=""> 109      public String cleanStringWithResults(String string) throws ServiceException {                                 </span>
<span class="8556081284105346376" onmouseenter="enter('8556081284105346376');" onmouseout="out('8556081284105346376');" style=""> 110          if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {                                               </span>
<span class="8152157400372312470" onmouseenter="enter('8152157400372312470');" onmouseout="out('8152157400372312470');" style=""> 111              return string;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 112          }                                                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 113          try {                                                                                                     </span>
<span class="3719546269160040656" onmouseenter="enter('3719546269160040656');" onmouseout="out('3719546269160040656');" style=""> 114              CleanResults results = as.scan(string, antiSamyPolicy);                                               </span>
<span class="6620008653670353106" onmouseenter="enter('6620008653670353106');" onmouseout="out('6620008653670353106');" style=""> 115              if (results.getNumberOfErrors() &gt; 0) {                                                                </span>
<span class="1000732835935543819" onmouseenter="enter('1000732835935543819');" onmouseout="out('1000732835935543819');" style=""> 116                  throw new CleanStringException(results);                                                          </span>
<span class="2918192000430827733" onmouseenter="enter('2918192000430827733');" onmouseout="out('2918192000430827733');" style=""> 117              }else{                                                                                                </span>
<span class="-4795652360206896091" onmouseenter="enter('-4795652360206896091');" onmouseout="out('-4795652360206896091');" style=""><abbr title=" 118                  //ok no errors, but what if it has regular string with javascript:xxx and it possibly can be used to construct anchor link"> 118                  //ok no errors, but what if it has regular string with javascript:xxx and it possibly can be used ðŸ”µ</abbr></span>
<span class="-2693852864669979181" onmouseenter="enter('-2693852864669979181');" onmouseout="out('-2693852864669979181');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 119 -                // let&#x27;s maybe try wrap string into &lt;a href=&quot;string&quot;&gt;qqq&lt;/a&gt;                                      </span>
<span class="-4670124309314849634" onmouseenter="enter('-4670124309314849634');" onmouseout="out('-4670124309314849634');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 120 -                if(!hasHTMLTags(string)){                                                                         </span>
<span class="-2532407930978426494" onmouseenter="enter('-2532407930978426494');" onmouseout="out('-2532407930978426494');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"><abbr title=" 121 -                    CleanResults resultsTemp = as.scan(&quot;&lt;a href=\&quot;&quot; + HtmlUtils.htmlEscape(string) + &quot;\&quot;/&gt;tt&lt;/a&gt;&quot;, antiSamyPolicy);"> 121 -                    CleanResults resultsTemp = as.scan(&quot;&lt;a href=\&quot;&quot; + HtmlUtils.htmlEscape(string) + &quot;\&quot;/&gt;tt&lt;/a&gt;&quot;,ðŸ”µ</abbr></span>
<span class="-6529348574061263195" onmouseenter="enter('-6529348574061263195');" onmouseout="out('-6529348574061263195');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 122 -                    if (resultsTemp.getNumberOfErrors() &gt; 0) {                                                    </span>
<span class="1000732835935543819" onmouseenter="enter('1000732835935543819');" onmouseout="out('1000732835935543819');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 123 -                        throw new CleanStringException(results);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 124 -                    }                                                                                             </span>
<span class="560426641368843814" onmouseenter="enter('560426641368843814');" onmouseout="out('560426641368843814');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +                if (string.toLowerCase().startsWith(JAVASCRIPT)) {                                                </span>
<span class="1000732835935543819" onmouseenter="enter('1000732835935543819');" onmouseout="out('1000732835935543819');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +                    throw new CleanStringException(results);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 127                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 128              }                                                                                                     </span>
<span class="-4993842330815521799" onmouseenter="enter('-4993842330815521799');" onmouseout="out('-4993842330815521799');" style=""> 129              return results.getCleanHTML();                                                                        </span>
<span class="522446021072007597" onmouseenter="enter('522446021072007597');" onmouseout="out('522446021072007597');" style=""> 130          } catch (CleanStringException e) {                                                                        </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 131              throw e;                                                                                              </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 132          } catch (Exception e) {                                                                                   </span>
<span class="-8642289478502472483" onmouseenter="enter('-8642289478502472483');" onmouseout="out('-8642289478502472483');" style=""> 133              StringBuilder sb = new StringBuilder();                                                               </span>
<span class="8547071428257112481" onmouseenter="enter('8547071428257112481');" onmouseout="out('8547071428257112481');" style=""> 134              sb.append(&quot;Unable to clean the passed in entity values&quot;);                                             </span>
<span class="2140406039510895093" onmouseenter="enter('2140406039510895093');" onmouseout="out('2140406039510895093');" style=""> 135              sb.append(&quot;\nNote - &quot;);                                                                               </span>
<span class="-8281191545228522440" onmouseenter="enter('-8281191545228522440');" onmouseout="out('-8281191545228522440');" style=""> 136              sb.append(getAntiSamyPolicyFileLocation());                                                           </span>
<span class="5644375583917836025" onmouseenter="enter('5644375583917836025');" onmouseout="out('5644375583917836025');" style=""> 137              sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.&quot;);      </span>
<span class="8762389184290087645" onmouseenter="enter('8762389184290087645');" onmouseout="out('8762389184290087645');" style=""> 138              LOG.error(sb.toString(), e);                                                                          </span>
<span class="6944673230759443700" onmouseenter="enter('6944673230759443700');" onmouseout="out('6944673230759443700');" style=""> 139              throw new ServiceException(sb.toString(), e);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 140          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 141      }                                                                                                             </span>
<span  style=""> 142                                                                                                                    </span>
<span  style=""> 143                                                                                                                    </span>
<span class="-2764905234348603584" onmouseenter="enter('-2764905234348603584');" onmouseout="out('-2764905234348603584');" style=""> 144      protected boolean hasHTMLTags(String text){                                                                   </span>
<span class="9198642012760827534" onmouseenter="enter('9198642012760827534');" onmouseout="out('9198642012760827534');" style=""> 145          Matcher matcher = pattern.matcher(text);                                                                  </span>
<span class="4330132740674744148" onmouseenter="enter('4330132740674744148');" onmouseout="out('4330132740674744148');" style=""> 146          return matcher.find();                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147      }                                                                                                             </span>
<span  style=""> 148                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 149      @Override                                                                                                     </span>
<span class="648464666007064624" onmouseenter="enter('648464666007064624');" onmouseout="out('648464666007064624');" style=""> 150      public void compareToken(String passedToken) throws ServiceException {                                        </span>
<span class="6844728555353595853" onmouseenter="enter('6844728555353595853');" onmouseout="out('6844728555353595853');" style=""> 151          if (xsrfProtectionEnabled) {                                                                              </span>
<span class="7666852928030705963" onmouseenter="enter('7666852928030705963');" onmouseout="out('7666852928030705963');" style=""> 152              if (!getCSRFToken().equals(passedToken)) {                                                            </span>
<span class="-7786080020397166211" onmouseenter="enter('-7786080020397166211');" onmouseout="out('-7786080020397166211');" style=""> 153                  throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expired.&quot;); </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 154              } else {                                                                                              </span>
<span class="-1749099532355983279" onmouseenter="enter('-1749099532355983279');" onmouseout="out('-1749099532355983279');" style=""> 155                  LOG.debug(&quot;Validated CSRF token&quot;);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 156              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 157          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 158      }                                                                                                             </span>
<span  style=""> 159                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 160      @Override                                                                                                     </span>
<span class="-2908233649961592868" onmouseenter="enter('-2908233649961592868');" onmouseout="out('-2908233649961592868');" style=""> 161      public String getCSRFToken() throws ServiceException {                                                        </span>
<span class="-7374102838628651207" onmouseenter="enter('-7374102838628651207');" onmouseout="out('-7374102838628651207');" style=""> 162          //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated instance.</span>
<span class="4360254575720880810" onmouseenter="enter('4360254575720880810');" onmouseout="out('4360254575720880810');" style=""> 163          HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();           </span>
<span class="-8754897222759985477" onmouseenter="enter('-8754897222759985477');" onmouseout="out('-8754897222759985477');" style=""> 164          if (request == null) {                                                                                    </span>
<span class="5506354016540775394" onmouseenter="enter('5506354016540775394');" onmouseout="out('5506354016540775394');" style=""> 165              //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holder       </span>
<span class="-4990660252016144867" onmouseenter="enter('-4990660252016144867');" onmouseout="out('-4990660252016144867');" style=""> 166              request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 167          }                                                                                                         </span>
<span  style=""> 168                                                                                                                    </span>
<span class="-7858468375027211236" onmouseenter="enter('-7858468375027211236');" onmouseout="out('-7858468375027211236');" style=""> 169          if (BLCRequestUtils.isOKtoUseSession(new ServletWebRequest(request))) {                                   </span>
<span class="4564433423788020137" onmouseenter="enter('4564433423788020137');" onmouseout="out('4564433423788020137');" style=""> 170              HttpSession session = request.getSession();                                                           </span>
<span class="3674149774037115881" onmouseenter="enter('3674149774037115881');" onmouseout="out('3674149774037115881');" style=""> 171              String token = (String) session.getAttribute(CSRFTOKEN);                                              </span>
<span class="3304317599319354346" onmouseenter="enter('3304317599319354346');" onmouseout="out('3304317599319354346');" style=""> 172              if (StringUtils.isEmpty(token)) {                                                                     </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 173                  try {                                                                                             </span>
<span class="421293466978398183" onmouseenter="enter('421293466978398183');" onmouseout="out('421293466978398183');" style=""> 174                      token = RandomGenerator.generateRandomId(&quot;SHA1PRNG&quot;, 32);                                     </span>
<span class="-7636130466757008337" onmouseenter="enter('-7636130466757008337');" onmouseout="out('-7636130466757008337');" style=""> 175                  } catch (NoSuchAlgorithmException e) {                                                            </span>
<span class="-3918768481161186829" onmouseenter="enter('-3918768481161186829');" onmouseout="out('-3918768481161186829');" style=""> 176                      LOG.error(&quot;Unable to generate random number&quot;, e);                                             </span>
<span class="1263583644110830904" onmouseenter="enter('1263583644110830904');" onmouseout="out('1263583644110830904');" style=""> 177                      throw new ServiceException(&quot;Unable to generate random number&quot;, e);                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 178                  }                                                                                                 </span>
<span class="-1497228977843385516" onmouseenter="enter('-1497228977843385516');" onmouseout="out('-1497228977843385516');" style=""> 179                  session.setAttribute(CSRFTOKEN, token);                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180              }                                                                                                     </span>
<span class="263037551027375388" onmouseenter="enter('263037551027375388');" onmouseout="out('263037551027375388');" style=""> 181              return token;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 182          }                                                                                                         </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 183          return null;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 184      }                                                                                                             </span>
<span  style=""> 185                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 186      @Override                                                                                                     </span>
<span class="1999013554829426715" onmouseenter="enter('1999013554829426715');" onmouseout="out('1999013554829426715');" style=""> 187      public String getAntiSamyPolicyFileLocation() {                                                               </span>
<span class="-2303053444344810326" onmouseenter="enter('-2303053444344810326');" onmouseout="out('-2303053444344810326');" style=""> 188          return antiSamyPolicyFileLocation;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189      }                                                                                                             </span>
<span  style=""> 190                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 191      @Override                                                                                                     </span>
<span class="8594302017839572248" onmouseenter="enter('8594302017839572248');" onmouseout="out('8594302017839572248');" style=""> 192      public void setAntiSamyPolicyFileLocation(String antiSamyPolicyFileLocation) {                                </span>
<span class="-4970186044531545303" onmouseenter="enter('-4970186044531545303');" onmouseout="out('-4970186044531545303');" style=""> 193          this.antiSamyPolicyFileLocation = antiSamyPolicyFileLocation;                                             </span>
<span class="5908386672201459822" onmouseenter="enter('5908386672201459822');" onmouseout="out('5908386672201459822');" style=""> 194          antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 195      }                                                                                                             </span>
<span  style=""> 196                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 197      @Override                                                                                                     </span>
<span class="-9133900204457152332" onmouseenter="enter('-9133900204457152332');" onmouseout="out('-9133900204457152332');" style=""> 198      public String getCsrfTokenParameter() {                                                                       </span>
<span class="-707553498228991610" onmouseenter="enter('-707553498228991610');" onmouseout="out('-707553498228991610');" style=""> 199          return CSRFTOKENPARAMETER;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 200      }                                                                                                             </span>
<span  style=""> 201                                                                                                                    </span>
<span class="2679016982828970129" onmouseenter="enter('2679016982828970129');" onmouseout="out('2679016982828970129');" style=""> 202      public void setXssProtectionEnabled(boolean xssProtectionEnabled) {                                           </span>
<span class="-6551933069661854213" onmouseenter="enter('-6551933069661854213');" onmouseout="out('-6551933069661854213');" style=""> 203          this.xssProtectionEnabled = xssProtectionEnabled;                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 204      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 205  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            