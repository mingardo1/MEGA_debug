<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>128</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    128
                    <a href="127.html">prev</a>
                    <a href="129.html">next</a>
                    <a href="128_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    CarGuo/GSYVideoPlayer_a1061d62099001b02357c265e6d4fce0b95a66fc_gsyVideoPlayer-exo_player2/src/main/java/tv/danmaku/ijk/media/exo2/ExoSourceManager.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CarGuo\GSYVideoPlayer show &quot;a1061d62099001b02357c265e6d4fce0b95a66fc:gsyVideoPlayer-exo_player2/src/main/java/tv/danmaku/ijk/media/exo2/ExoSourceManager.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CarGuo\GSYVideoPlayer show &quot;a1061d62099001b02357c265e6d4fce0b95a66fc^1:gsyVideoPlayer-exo_player2/src/main/java/tv/danmaku/ijk/media/exo2/ExoSourceManager.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CarGuo\GSYVideoPlayer show &quot;a1061d62099001b02357c265e6d4fce0b95a66fc^2:gsyVideoPlayer-exo_player2/src/main/java/tv/danmaku/ijk/media/exo2/ExoSourceManager.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CarGuo\GSYVideoPlayer show &quot;0bbf9d653eac231e9add9fe4bd2073e7054970dc:gsyVideoPlayer-exo_player2/src/main/java/tv/danmaku/ijk/media/exo2/ExoSourceManager.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [b], [bj], [j], [s]], subset: [[sbj], [bj], [bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package tv.danmaku.ijk.media.exo2;
   2 
   3 import android.annotation.SuppressLint;
   4 import android.content.Context;
   5 import android.net.Uri;
   6 import android.text.TextUtils;
   7 
   8 import androidx.annotation.NonNull;
   9 import androidx.annotation.Nullable;
  10 
  11 import com.google.android.exoplayer2.C;
  12 import com.google.android.exoplayer2.MediaItem;
  13 import com.google.android.exoplayer2.database.DatabaseProvider;
  14 import com.google.android.exoplayer2.ext.rtmp.RtmpDataSourceFactory;
  15 import com.google.android.exoplayer2.extractor.DefaultExtractorsFactory;
  16 import com.google.android.exoplayer2.source.MediaSource;
  17 import com.google.android.exoplayer2.source.ProgressiveMediaSource;
  18 import com.google.android.exoplayer2.source.dash.DashMediaSource;
  19 import com.google.android.exoplayer2.source.dash.DefaultDashChunkSource;
  20 import com.google.android.exoplayer2.source.hls.HlsMediaSource;
  21 import com.google.android.exoplayer2.source.smoothstreaming.DefaultSsChunkSource;
  22 import com.google.android.exoplayer2.source.smoothstreaming.SsMediaSource;
  23 import com.google.android.exoplayer2.upstream.DataSource;
  24 import com.google.android.exoplayer2.upstream.DataSpec;
  25 import com.google.android.exoplayer2.upstream.DefaultBandwidthMeter;
  26 import com.google.android.exoplayer2.upstream.DefaultDataSourceFactory;
  27 import com.google.android.exoplayer2.upstream.DefaultHttpDataSource;
  28 import com.google.android.exoplayer2.upstream.RawResourceDataSource;
  29 import com.google.android.exoplayer2.upstream.cache.Cache;
  30 import com.google.android.exoplayer2.upstream.cache.CacheDataSource;
  31 import com.google.android.exoplayer2.upstream.cache.CacheKeyFactory;
  32 import com.google.android.exoplayer2.upstream.cache.CacheSpan;
  33 import com.google.android.exoplayer2.upstream.cache.ContentMetadata;
  34 import com.google.android.exoplayer2.upstream.cache.LeastRecentlyUsedCacheEvictor;
  35 import com.google.android.exoplayer2.upstream.cache.SimpleCache;
  36 import com.google.android.exoplayer2.util.Util;
  37 import com.google.common.base.Ascii;
  38 
  39 import java.io.File;
  40 import java.util.Locale;
  41 import java.util.Map;
  42 import java.util.NavigableSet;
  43 
  44 
  45 /**
  46  * Created by guoshuyu on 2018/5/18.
  47  */
  48 
  49 public class ExoSourceManager {
  50 
  51     private static final String TAG = &quot;ExoSourceManager&quot;;
  52 
  53     private static final long DEFAULT_MAX_SIZE = 512 * 1024 * 1024;
  54 
  55 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56     public static final int TYPE_RTMP = 100;</span>
  57 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58     private static final long DEFAULT_MAX_SIZE = 512 * 1024 * 1024;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60     public static final int TYPE_RTMP = 4;</span>
  61 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62     public static final int TYPE_RTMP = 14;</span>
  63 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  64 
  65     private static Cache mCache;
  66     /**
  67      * ÂøΩÂæãHttpsËØÅ‰π¶Ê†°È™å
  68      *
  69      * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
  70      */
  71     @Deprecated
  72     private static boolean sSkipSSLChain = false;
  73 
  74     private static int sHttpReadTimeout = -1;
  75 
  76     private static int sHttpConnectTimeout = -1;
  77 
  78 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80     private static final boolean s = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82     private final Context mAppContext;</span>
  83 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84     private static int sHttpConnectTimeout = -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87     private static boolean s = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89     private Context mAppContext;</span>
  90 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91     private Context mAppContext;</span>
  92 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  93 
  94     private final Map&lt;String, String&gt; mMapHeadData;
  95 
  96     private String mDataSource;
  97 
  98     private static ExoMediaSourceInterceptListener sExoMediaSourceInterceptListener;
  99     private static DatabaseProvider sDatabaseProvider;
 100 
 101     private boolean isCached = false;
 102 
<abbr title=" 103     public static ExoSourceManager newInstance(Context context, @Nullable Map&lt;String, String&gt; mapHeadData) {"> 103     public static ExoSourceManager newInstance(Context context, @Nullable Map&lt;String, String&gt; mapHeadDataüîµ</abbr>
 104         return new ExoSourceManager(context, mapHeadData);
 105     }
 106 
 107     private ExoSourceManager(Context context, Map&lt;String, String&gt; mapHeadData) {
 108         mAppContext = context.getApplicationContext();
 109         mMapHeadData = mapHeadData;
 110     }
 111 
 112     /**
 113      * @param dataSource  ÈìæÊé•
 114      * @param preview     ÊòØÂê¶Â∏¶‰∏äheaderÔºåÈªòËÆ§ÊúâheaderËá™Âä®ËÆæÁΩÆ‰∏∫true
 115      * @param cacheEnable ÊòØÂê¶ÈúÄË¶ÅÁºìÂ≠ò
 116      * @param isLooping   ÊòØÂê¶Âæ™ÁéØ
 117      * @param cacheDir    Ëá™ÂÆö‰πâÁºìÂ≠òÁõÆÂΩï
 118      */
<abbr title=" 119     public MediaSource getMediaSource(String dataSource, boolean preview, boolean cacheEnable, boolean isLooping, File cacheDir, @Nullable String overrideExtension) {"> 119     public MediaSource getMediaSource(String dataSource, boolean preview, boolean cacheEnable, boolean isüîµ</abbr>
 120         MediaSource mediaSource = null;
 121         if (sExoMediaSourceInterceptListener != null) {
<abbr title=" 122             mediaSource = sExoMediaSourceInterceptListener.getMediaSource(dataSource, preview, cacheEnable, isLooping, cacheDir);"> 122             mediaSource = sExoMediaSourceInterceptListener.getMediaSource(dataSource, preview, cacheEnablüîµ</abbr>
 123         }
 124         if (mediaSource != null) {
 125             return mediaSource;
 126         }
 127         mDataSource = dataSource;
 128         Uri contentUri = Uri.parse(dataSource);
 129         MediaItem mediaItem = MediaItem.fromUri(contentUri);
 130         int contentType = inferContentType(dataSource, overrideExtension);
 131 
 132         String uerAgent = null;
 133         if (mMapHeadData != null) {
 134             uerAgent = mMapHeadData.get(&quot;User-Agent&quot;);
 135         }
 136         if (&quot;android.resource&quot;.equals(contentUri.getScheme())) {
 137             DataSpec dataSpec = new DataSpec(contentUri);
 138             final RawResourceDataSource rawResourceDataSource = new RawResourceDataSource(mAppContext);
 139             try {
 140                 rawResourceDataSource.open(dataSpec);
 141             } catch (RawResourceDataSource.RawResourceDataSourceException e) {
 142                 e.printStackTrace();
 143             }
 144             DataSource.Factory factory = () -&gt; rawResourceDataSource;
 145             return new ProgressiveMediaSource.Factory(
 146                     factory).createMediaSource(mediaItem);
 147 
 148         }
 149 
 150         switch (contentType) {
 151             case C.TYPE_SS:
 152                 mediaSource = new SsMediaSource.Factory(
<abbr title=" 153                         new DefaultSsChunkSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent)),"> 153                         new DefaultSsChunkSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnabüîµ</abbr>
 154                         new DefaultDataSourceFactory(mAppContext, null,
<abbr title=" 155                                 getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSource(mediaItem);"> 155                                 getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSouüîµ</abbr>
 156                 break;
 157             case C.TYPE_DASH:
<abbr title=" 158                 mediaSource = new DashMediaSource.Factory(new DefaultDashChunkSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent)),"> 158                 mediaSource = new DashMediaSource.Factory(new DefaultDashChunkSource.Factory(getDataSourcüîµ</abbr>
 159                         new DefaultDataSourceFactory(mAppContext, null,
<abbr title=" 160                                 getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSource(mediaItem);"> 160                                 getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSouüîµ</abbr>
 161                 break;
 162             case C.TYPE_HLS:
<abbr title=" 163                 mediaSource = new HlsMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent))"> 163                 mediaSource = new HlsMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnabüîµ</abbr>
 164                         .setAllowChunklessPreparation(true)
 165                         .createMediaSource(mediaItem);
 166                 break;
 167             case TYPE_RTMP:
 168                 RtmpDataSourceFactory rtmpDataSourceFactory = new RtmpDataSourceFactory(null);
 169                 mediaSource = new ProgressiveMediaSource.Factory(rtmpDataSourceFactory,
 170                         new DefaultExtractorsFactory())
 171                         .createMediaSource(mediaItem);
 172                 break;
 173             case C.TYPE_OTHER:
 174             default:
<abbr title=" 175                 mediaSource = new ProgressiveMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable,"> 175                 mediaSource = new ProgressiveMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cüîµ</abbr>
 176                         preview, cacheDir, uerAgent), new DefaultExtractorsFactory())
 177                         .createMediaSource(mediaItem);
 178                 break;
 179         }
 180         return mediaSource;
 181     }
 182 
 183 
 184     /**
 185      * ËÆæÁΩÆExoPlayer ÁöÑ MediaSource ÂàõÂª∫Êã¶Êà™
 186      */
<abbr title=" 187     public static void setExoMediaSourceInterceptListener(ExoMediaSourceInterceptListener exoMediaSourceInterceptListener) {"> 187     public static void setExoMediaSourceInterceptListener(ExoMediaSourceInterceptListener exoMediaSourceIüîµ</abbr>
 188         sExoMediaSourceInterceptListener = exoMediaSourceInterceptListener;
 189     }
 190 
 191     public static void resetExoMediaSourceInterceptListener() {
 192         sExoMediaSourceInterceptListener = null;
 193     }
 194 
 195     public static ExoMediaSourceInterceptListener getExoMediaSourceInterceptListener() {
 196         return sExoMediaSourceInterceptListener;
 197     }
 198 
 199 
 200     @SuppressLint(&quot;WrongConstant&quot;)
 201     @C.ContentType
 202 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203     public static int inferContentType(@NonNull String fileName, @Nullable String overrideExtension) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204         fileName = fileName.toLowerCase(Locale.US);</span>
 205 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206     public static ExoMediaSourceInterceptListener getExoMediaSourceInterceptListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207         return sExoMediaSourceInterceptListener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209 </span>
 210 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211     public static int inferContentType(String fileName, @Nullable String overrideExtension) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212         fileName = Ascii.toLowerCase(fileName);</span>
 213 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 214         if (fileName.startsWith(&quot;rtmp:&quot;)) {
 215             return TYPE_RTMP;
 216         } else {
 217             return inferContentType(Uri.parse(fileName), overrideExtension);
 218         }
 219     }
 220 
 221     @C.ContentType
 222     public static int inferContentType(Uri uri, @Nullable String overrideExtension) {
 223         return Util.inferContentType(uri, overrideExtension);
 224     }
 225 
 226     /**
 227      * Êú¨Âú∞ÁºìÂ≠òÁõÆÂΩï
 228      */
 229     public static synchronized Cache getCacheSingleInstance(Context context, File cacheDir) {
 230         String dirs = context.getCacheDir().getAbsolutePath();
 231         if (cacheDir != null) {
 232             dirs = cacheDir.getAbsolutePath();
 233         }
 234         if (mCache == null) {
 235             String path = dirs + File.separator + &quot;exo&quot;;
 236             boolean isLocked = SimpleCache.isCacheFolderLocked(new File(path));
 237             if (!isLocked) {
<abbr title=" 238                 mCache = new SimpleCache(new File(path), new LeastRecentlyUsedCacheEvictor(DEFAULT_MAX_SIZE), sDatabaseProvider);"> 238                 mCache = new SimpleCache(new File(path), new LeastRecentlyUsedCacheEvictor(DEFAULT_MAX_SIüîµ</abbr>
 239             }
 240         }
 241         return mCache;
 242     }
 243 
 244     public void release() {
 245         isCached = false;
 246         if (mCache != null) {
 247             try {
 248                 mCache.release();
 249                 mCache = null;
 250             } catch (Exception e) {
 251                 e.printStackTrace();
 252             }
 253         }
 254     }
 255 
 256     /**
 257      * CacheÈúÄË¶Årelease‰πãÂêéÊâçËÉΩclear
 258      */
 259     public static void clearCache(Context context, File cacheDir, String url) {
 260         try {
 261             Cache cache = getCacheSingleInstance(context, cacheDir);
 262             if (!TextUtils.isEmpty(url)) {
 263                 if (cache != null) {
 264                     removeCache(cache, url);
 265                 }
 266             } else {
 267                 if (cache != null) {
 268                     for (String key : cache.getKeys()) {
 269                         removeCache(cache, key);
 270                     }
 271                 }
 272             }
 273         } catch (Exception e) {
 274             e.printStackTrace();
 275         }
 276     }
 277 
 278 
 279     public static void removeCache(Cache cache, String url) {
 280         NavigableSet&lt;CacheSpan&gt; cachedSpans = cache.getCachedSpans(buildCacheKey(url));
 281         for (CacheSpan cachedSpan : cachedSpans) {
 282             try {
 283                 cache.removeSpan(cachedSpan);
 284             } catch (Exception e) {
 285                 // Do nothing.
 286             }
 287         }
 288     }
 289 
 290     public static String buildCacheKey(String url) {
 291         DataSpec dataSpec = new DataSpec(Uri.parse(url));
 292         return CacheKeyFactory.DEFAULT.buildCacheKey(dataSpec);
 293     }
 294 
 295     public static boolean cachePreView(Context context, File cacheDir, String url) {
 296         return resolveCacheState(getCacheSingleInstance(context, cacheDir), url);
 297     }
 298 
 299     public boolean hadCached() {
 300         return isCached;
 301     }
 302 
 303     /**
 304      * ÂøΩÂæãHttpsËØÅ‰π¶Ê†°È™å
 305      *
 306      * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
 307      */
 308     @Deprecated
 309     public static boolean isSkipSSLChain() {
 310         return sSkipSSLChain;
 311     }
 312 
 313     /**
 314      * ËÆæÁΩÆhttpsÂøΩÁï•ËØÅ‰π¶
 315      *
 316      * @param skipSSLChain trueÊó∂ÊòØhulve
 317      * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
 318      */
 319     @Deprecated
 320     public static void setSkipSSLChain(boolean skipSSLChain) {
 321         sSkipSSLChain = skipSSLChain;
 322     }
 323 
 324 
 325     public static int getHttpReadTimeout() {
 326         return sHttpReadTimeout;
 327     }
 328 
 329     /**
 330      * Â¶ÇÊûúËÆæÁΩÆÂ∞è‰∫é 0 Â∞±‰ΩøÁî®ÈªòËÆ§ 8000 MILLIS
 331      */
 332     public static void setHttpReadTimeout(int httpReadTimeout) {
 333         ExoSourceManager.sHttpReadTimeout = httpReadTimeout;
 334     }
 335 
 336     public static int getHttpConnectTimeout() {
 337         return sHttpConnectTimeout;
 338     }
 339 
 340     /**
 341      * Â¶ÇÊûúËÆæÁΩÆÂ∞è‰∫é 0 Â∞±‰ΩøÁî®ÈªòËÆ§ 8000 MILLIS
 342      */
 343     public static void setHttpConnectTimeout(int httpConnectTimeout) {
 344         ExoSourceManager.sHttpConnectTimeout = httpConnectTimeout;
 345     }
 346 
 347     public static DatabaseProvider getDatabaseProvider() {
 348         return sDatabaseProvider;
 349     }
 350 
 351     public static void setDatabaseProvider(DatabaseProvider databaseProvider) {
 352         ExoSourceManager.sDatabaseProvider = databaseProvider;
 353     }
 354 
 355     /**
 356      * Ëé∑ÂèñSourceFactoryÔºåÊòØÂê¶Â∏¶Cache
 357      */
<abbr title=" 358     private DataSource.Factory getDataSourceFactoryCache(Context context, boolean cacheEnable, boolean preview, File cacheDir, String uerAgent) {"> 358     private DataSource.Factory getDataSourceFactoryCache(Context context, boolean cacheEnable, boolean prüîµ</abbr>
 359         if (cacheEnable) {
 360             Cache cache = getCacheSingleInstance(context, cacheDir);
 361             if (cache != null) {
 362                 isCached = resolveCacheState(cache, mDataSource);
 363                 CacheDataSource.Factory factory = new CacheDataSource.Factory();
 364                 return factory.
<abbr title=" 365                         setCache(cache).setCacheReadDataSourceFactory(getDataSourceFactory(context, preview, uerAgent)).setFlags(CacheDataSource.FLAG_IGNORE_CACHE_ON_ERROR);"> 365                         setCache(cache).setCacheReadDataSourceFactory(getDataSourceFactory(context, previüîµ</abbr>
 366             }
 367         }
 368         return getDataSourceFactory(context, preview, uerAgent);
 369     }
 370 
 371     /**
 372      * Ëé∑ÂèñSourceFactory
 373      */
 374     private DataSource.Factory getDataSourceFactory(Context context, boolean preview, String uerAgent) {
<abbr title=" 375         return new DefaultDataSourceFactory(context, preview ? null : new DefaultBandwidthMeter.Builder(context).build(),"> 375         return new DefaultDataSourceFactory(context, preview ? null : new DefaultBandwidthMeter.Builder(cüîµ</abbr>
 376                 getHttpDataSourceFactory(context, preview, uerAgent));
 377     }
 378 
<abbr title=" 379     private DataSource.Factory getHttpDataSourceFactory(Context context, boolean preview, String uerAgent) {"> 379     private DataSource.Factory getHttpDataSourceFactory(Context context, boolean preview, String uerAgentüîµ</abbr>
 380         if (uerAgent == null) {
 381             uerAgent = Util.getUserAgent(context, TAG);
 382         }
 383         int connectTimeout = DefaultHttpDataSource.DEFAULT_CONNECT_TIMEOUT_MILLIS;
 384         int readTimeout = DefaultHttpDataSource.DEFAULT_READ_TIMEOUT_MILLIS;
 385         if (sHttpConnectTimeout &gt; 0) {
 386             connectTimeout = sHttpConnectTimeout;
 387         }
 388         if (sHttpReadTimeout &gt; 0) {
 389             readTimeout = sHttpReadTimeout;
 390         }
 391         boolean allowCrossProtocolRedirects = false;
 392         if (mMapHeadData != null &amp;&amp; mMapHeadData.size() &gt; 0) {
 393             allowCrossProtocolRedirects = &quot;true&quot;.equals(mMapHeadData.get(&quot;allowCrossProtocolRedirects&quot;));
 394         }
 395         DataSource.Factory dataSourceFactory;
 396         if (sExoMediaSourceInterceptListener != null) {
<abbr title=" 397             dataSourceFactory = sExoMediaSourceInterceptListener.getHttpDataSourceFactory(uerAgent, preview ? null : new DefaultBandwidthMeter.Builder(mAppContext).build(),"> 397             dataSourceFactory = sExoMediaSourceInterceptListener.getHttpDataSourceFactory(uerAgent, previüîµ</abbr>
 398                     connectTimeout,
 399                     readTimeout, mMapHeadData, allowCrossProtocolRedirects);
 400         } else {
 401             dataSourceFactory = new DefaultHttpDataSource.Factory()
 402                     .setAllowCrossProtocolRedirects(allowCrossProtocolRedirects)
 403                     .setConnectTimeoutMs(connectTimeout)
 404                     .setReadTimeoutMs(readTimeout)
<abbr title=" 405                     .setTransferListener(preview ? null : new DefaultBandwidthMeter.Builder(mAppContext).build());"> 405                     .setTransferListener(preview ? null : new DefaultBandwidthMeter.Builder(mAppContext).üîµ</abbr>
 406             if (mMapHeadData != null &amp;&amp; mMapHeadData.size() &gt; 0) {
<abbr title=" 407                 ((DefaultHttpDataSource.Factory) dataSourceFactory).setDefaultRequestProperties(mMapHeadData);"> 407                 ((DefaultHttpDataSource.Factory) dataSourceFactory).setDefaultRequestProperties(mMapHeadDüîµ</abbr>
 408             }
 409         }
 410         return dataSourceFactory;
 411     }
 412 
 413     /**
 414      * Ê†πÊçÆÁºìÂ≠òÂùóÂà§Êñ≠ÊòØÂê¶ÁºìÂ≠òÊàêÂäü
 415      */
 416     private static boolean resolveCacheState(Cache cache, String url) {
 417         boolean isCache = true;
 418         if (!TextUtils.isEmpty(url)) {
 419             String key = buildCacheKey(url);
 420             if (!TextUtils.isEmpty(key)) {
 421                 NavigableSet&lt;CacheSpan&gt; cachedSpans = cache.getCachedSpans(key);
 422                 if (cachedSpans.size() == 0) {
 423                     isCache = false;
 424                 } else {
<abbr title=" 425                     long contentLength = cache.getContentMetadata(key).get(ContentMetadata.KEY_CONTENT_LENGTH, C.LENGTH_UNSET);"> 425                     long contentLength = cache.getContentMetadata(key).get(ContentMetadata.KEY_CONTENT_LEüîµ</abbr>
 426                     long currentLength = 0;
 427                     for (CacheSpan cachedSpan : cachedSpans) {
<abbr title=" 428                         currentLength += cache.getCachedLength(key, cachedSpan.position, cachedSpan.length);"> 428                         currentLength += cache.getCachedLength(key, cachedSpan.position, cachedSpan.lengtüîµ</abbr>
 429                     }
 430                     isCache = currentLength &gt;= contentLength;
 431                 }
 432             } else {
 433                 isCache = false;
 434             }
 435         }
 436         return isCache;
 437     }
 438 }</pre></td>
                            <td><pre>   1 package tv.danmaku.ijk.media.exo2;
   2 
   3 import android.annotation.SuppressLint;
   4 import android.content.Context;
   5 import android.net.Uri;
   6 import androidx.annotation.Nullable;
   7 import android.text.TextUtils;
   8 
   9 import androidx.annotation.NonNull;
  10 
  11 import com.google.android.exoplayer2.C;
  12 import com.google.android.exoplayer2.MediaItem;
  13 import com.google.android.exoplayer2.database.DatabaseProvider;
  14 import com.google.android.exoplayer2.ext.rtmp.RtmpDataSourceFactory;
  15 import com.google.android.exoplayer2.extractor.DefaultExtractorsFactory;
  16 import com.google.android.exoplayer2.source.MediaSource;
  17 import com.google.android.exoplayer2.source.ProgressiveMediaSource;
  18 import com.google.android.exoplayer2.source.dash.DashMediaSource;
  19 import com.google.android.exoplayer2.source.dash.DefaultDashChunkSource;
  20 import com.google.android.exoplayer2.source.hls.HlsMediaSource;
  21 import com.google.android.exoplayer2.source.smoothstreaming.DefaultSsChunkSource;
  22 import com.google.android.exoplayer2.source.smoothstreaming.SsMediaSource;
  23 import com.google.android.exoplayer2.upstream.DataSource;
  24 import com.google.android.exoplayer2.upstream.DataSpec;
  25 import com.google.android.exoplayer2.upstream.DefaultBandwidthMeter;
  26 import com.google.android.exoplayer2.upstream.DefaultDataSourceFactory;
  27 import com.google.android.exoplayer2.upstream.DefaultHttpDataSource;
  28 import com.google.android.exoplayer2.upstream.RawResourceDataSource;
  29 import com.google.android.exoplayer2.upstream.cache.Cache;
  30 import com.google.android.exoplayer2.upstream.cache.CacheDataSource;
  31 import com.google.android.exoplayer2.upstream.cache.CacheKeyFactory;
  32 import com.google.android.exoplayer2.upstream.cache.CacheSpan;
  33 import com.google.android.exoplayer2.upstream.cache.ContentMetadata;
  34 import com.google.android.exoplayer2.upstream.cache.LeastRecentlyUsedCacheEvictor;
  35 import com.google.android.exoplayer2.upstream.cache.SimpleCache;
  36 import com.google.android.exoplayer2.util.Util;
  37 import com.google.common.base.Ascii;
  38 
  39 import java.io.File;
  40 import java.util.Locale;
  41 import java.util.Map;
  42 import java.util.NavigableSet;
  43 
  44 
  45 /**
  46  * Created by guoshuyu on 2018/5/18.
  47  */
  48 
  49 public class ExoSourceManager {
  50 
  51     private static final String TAG = &quot;ExoSourceManager&quot;;
  52 
  53     private static final long DEFAULT_MAX_SIZE = 512 * 1024 * 1024;
  54 
  55 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56 public static final int TYPE_RTMP = 100;</span>
  57 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 public static final int TYPE_RTMP = 4;</span>
  59 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60 public static final int TYPE_RTMP = 14;</span>
  61 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  62 
  63 
  64     private static Cache mCache;
  65     /**
  66      * ÂøΩÂæãHttpsËØÅ‰π¶Ê†°È™å
  67      *
  68      * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
  69      */
  70     @Deprecated
  71     private static boolean sSkipSSLChain = false;
  72 
  73     private static int sHttpReadTimeout = -1;
  74 
  75     private static int sHttpConnectTimeout = -1;
  76 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77 private static final boolean s = false;</span>
  78 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79 private static boolean s = false;</span>
  80 =======
  81 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  82 
  83 
  84     private final Context mAppContext;
  85 
  86     private final Map&lt;String, String&gt; mMapHeadData;
  87 
  88     private String mDataSource;
  89 
  90     private static ExoMediaSourceInterceptListener sExoMediaSourceInterceptListener;
  91     private static DatabaseProvider sDatabaseProvider;
  92 
  93     private boolean isCached = false;
  94 
<abbr title="  95     public static ExoSourceManager newInstance(Context context, @Nullable Map&lt;String, String&gt; mapHeadData) {">  95     public static ExoSourceManager newInstance(Context context, @Nullable Map&lt;String, String&gt; mapHeadDataüîµ</abbr>
  96         return new ExoSourceManager(context, mapHeadData);
  97     }
  98 
  99     private ExoSourceManager(Context context, Map&lt;String, String&gt; mapHeadData) {
 100         mAppContext = context.getApplicationContext();
 101         mMapHeadData = mapHeadData;
 102     }
 103 
 104     /**
 105      * @param dataSource  ÈìæÊé•
 106      * @param preview     ÊòØÂê¶Â∏¶‰∏äheaderÔºåÈªòËÆ§ÊúâheaderËá™Âä®ËÆæÁΩÆ‰∏∫true
 107      * @param cacheEnable ÊòØÂê¶ÈúÄË¶ÅÁºìÂ≠ò
 108      * @param isLooping   ÊòØÂê¶Âæ™ÁéØ
 109      * @param cacheDir    Ëá™ÂÆö‰πâÁºìÂ≠òÁõÆÂΩï
 110      */
<abbr title=" 111     public MediaSource getMediaSource(String dataSource, boolean preview, boolean cacheEnable, boolean isLooping, File cacheDir, @Nullable String overrideExtension) {"> 111     public MediaSource getMediaSource(String dataSource, boolean preview, boolean cacheEnable, boolean isüîµ</abbr>
 112         MediaSource mediaSource = null;
 113         if (sExoMediaSourceInterceptListener != null) {
<abbr title=" 114             mediaSource = sExoMediaSourceInterceptListener.getMediaSource(dataSource, preview, cacheEnable, isLooping, cacheDir);"> 114             mediaSource = sExoMediaSourceInterceptListener.getMediaSource(dataSource, preview, cacheEnablüîµ</abbr>
 115         }
 116         if (mediaSource != null) {
 117             return mediaSource;
 118         }
 119         mDataSource = dataSource;
 120         Uri contentUri = Uri.parse(dataSource);
 121         MediaItem mediaItem = MediaItem.fromUri(contentUri);
 122         int contentType = inferContentType(dataSource, overrideExtension);
 123 
 124         String uerAgent = null;
 125         if (mMapHeadData != null) {
 126             uerAgent = mMapHeadData.get(&quot;User-Agent&quot;);
 127         }
 128         if (&quot;android.resource&quot;.equals(contentUri.getScheme())) {
 129             DataSpec dataSpec = new DataSpec(contentUri);
 130             final RawResourceDataSource rawResourceDataSource = new RawResourceDataSource(mAppContext);
 131             try {
 132                 rawResourceDataSource.open(dataSpec);
 133             } catch (RawResourceDataSource.RawResourceDataSourceException e) {
 134                 e.printStackTrace();
 135             }
 136             DataSource.Factory factory = () -&gt; rawResourceDataSource;
 137             return new ProgressiveMediaSource.Factory(
 138                     factory).createMediaSource(mediaItem);
 139 
 140         }
 141 
 142         switch (contentType) {
 143             case C.TYPE_SS:
 144                 mediaSource = new SsMediaSource.Factory(
<abbr title=" 145                         new DefaultSsChunkSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent)),"> 145                         new DefaultSsChunkSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnabüîµ</abbr>
 146                         new DefaultDataSourceFactory(mAppContext, null,
<abbr title=" 147                                 getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSource(mediaItem);"> 147                                 getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSouüîµ</abbr>
 148                 break;
 149             case C.TYPE_DASH:
<abbr title=" 150                 mediaSource = new DashMediaSource.Factory(new DefaultDashChunkSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent)),"> 150                 mediaSource = new DashMediaSource.Factory(new DefaultDashChunkSource.Factory(getDataSourcüîµ</abbr>
 151                         new DefaultDataSourceFactory(mAppContext, null,
<abbr title=" 152                                 getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSource(mediaItem);"> 152                                 getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSouüîµ</abbr>
 153                 break;
 154             case C.TYPE_HLS:
<abbr title=" 155                 mediaSource = new HlsMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent))"> 155                 mediaSource = new HlsMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnabüîµ</abbr>
 156                         .setAllowChunklessPreparation(true)
 157                         .createMediaSource(mediaItem);
 158                 break;
 159             case TYPE_RTMP:
 160                 RtmpDataSourceFactory rtmpDataSourceFactory = new RtmpDataSourceFactory(null);
 161                 mediaSource = new ProgressiveMediaSource.Factory(rtmpDataSourceFactory,
 162                         new DefaultExtractorsFactory())
 163                         .createMediaSource(mediaItem);
 164                 break;
 165             case C.TYPE_OTHER:
 166             default:
<abbr title=" 167                 mediaSource = new ProgressiveMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable,"> 167                 mediaSource = new ProgressiveMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cüîµ</abbr>
 168                         preview, cacheDir, uerAgent), new DefaultExtractorsFactory())
 169                         .createMediaSource(mediaItem);
 170                 break;
 171         }
 172         return mediaSource;
 173     }
 174 
 175 
 176     /**
 177      * ËÆæÁΩÆExoPlayer ÁöÑ MediaSource ÂàõÂª∫Êã¶Êà™
 178      */
<abbr title=" 179     public static void setExoMediaSourceInterceptListener(ExoMediaSourceInterceptListener exoMediaSourceInterceptListener) {"> 179     public static void setExoMediaSourceInterceptListener(ExoMediaSourceInterceptListener exoMediaSourceIüîµ</abbr>
 180         sExoMediaSourceInterceptListener = exoMediaSourceInterceptListener;
 181     }
 182 
 183     public static void resetExoMediaSourceInterceptListener() {
 184         sExoMediaSourceInterceptListener = null;
 185     }
 186 
 187     public static ExoMediaSourceInterceptListener getExoMediaSourceInterceptListener() {
 188         return sExoMediaSourceInterceptListener;
 189     }
 190 
 191 
 192     @SuppressLint(&quot;WrongConstant&quot;)
 193     @C.ContentType
 194 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195     public static int inferContentType(@NonNull String fileName, @Nullable String overrideExtension) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196         fileName = fileName.toLowerCase(Locale.US);</span>
 197 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198     public static int inferContentType(String fileName, @Nullable String overrideExtension) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199         fileName = Util.toLowerInvariant(fileName);</span>
 200 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201     public static int inferContentType(String fileName, @Nullable String overrideExtension) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202         fileName = Ascii.toLowerCase(fileName);</span>
 203 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 204         if (fileName.startsWith(&quot;rtmp:&quot;)) {
 205             return TYPE_RTMP;
 206         } else {
 207             return inferContentType(Uri.parse(fileName), overrideExtension);
 208         }
 209     }
 210 
 211     @C.ContentType
 212     public static int inferContentType(Uri uri, @Nullable String overrideExtension) {
 213         return Util.inferContentType(uri, overrideExtension);
 214     }
 215 
 216     /**
 217      * Êú¨Âú∞ÁºìÂ≠òÁõÆÂΩï
 218      */
 219     public static synchronized Cache getCacheSingleInstance(Context context, File cacheDir) {
 220         String dirs = context.getCacheDir().getAbsolutePath();
 221         if (cacheDir != null) {
 222             dirs = cacheDir.getAbsolutePath();
 223         }
 224         if (mCache == null) {
 225             String path = dirs + File.separator + &quot;exo&quot;;
 226             boolean isLocked = SimpleCache.isCacheFolderLocked(new File(path));
 227             if (!isLocked) {
<abbr title=" 228                 mCache = new SimpleCache(new File(path), new LeastRecentlyUsedCacheEvictor(DEFAULT_MAX_SIZE), sDatabaseProvider);"> 228                 mCache = new SimpleCache(new File(path), new LeastRecentlyUsedCacheEvictor(DEFAULT_MAX_SIüîµ</abbr>
 229             }
 230         }
 231         return mCache;
 232     }
 233 
 234     public void release() {
 235         isCached = false;
 236         if (mCache != null) {
 237             try {
 238                 mCache.release();
 239                 mCache = null;
 240             } catch (Exception e) {
 241                 e.printStackTrace();
 242             }
 243         }
 244     }
 245 
 246     /**
 247      * CacheÈúÄË¶Årelease‰πãÂêéÊâçËÉΩclear
 248      */
 249     public static void clearCache(Context context, File cacheDir, String url) {
 250         try {
 251             Cache cache = getCacheSingleInstance(context, cacheDir);
 252             if (!TextUtils.isEmpty(url)) {
 253                 if (cache != null) {
 254                     removeCache(cache, url);
 255                 }
 256             } else {
 257                 if (cache != null) {
 258                     for (String key : cache.getKeys()) {
 259                         removeCache(cache, key);
 260                     }
 261                 }
 262             }
 263         } catch (Exception e) {
 264             e.printStackTrace();
 265         }
 266     }
 267 
 268 
 269     public static void removeCache(Cache cache, String url) {
 270         NavigableSet&lt;CacheSpan&gt; cachedSpans = cache.getCachedSpans(buildCacheKey(url));
 271         for (CacheSpan cachedSpan : cachedSpans) {
 272             try {
 273                 cache.removeSpan(cachedSpan);
 274             } catch (Exception e) {
 275                 // Do nothing.
 276             }
 277         }
 278     }
 279 
 280     public static String buildCacheKey(String url) {
 281         DataSpec dataSpec = new DataSpec(Uri.parse(url));
 282         return CacheKeyFactory.DEFAULT.buildCacheKey(dataSpec);
 283     }
 284 
 285     public static boolean cachePreView(Context context, File cacheDir, String url) {
 286         return resolveCacheState(getCacheSingleInstance(context, cacheDir), url);
 287     }
 288 
 289     public boolean hadCached() {
 290         return isCached;
 291     }
 292 
 293     /**
 294      * ÂøΩÂæãHttpsËØÅ‰π¶Ê†°È™å
 295      *
 296      * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
 297      */
 298     @Deprecated
 299     public static boolean isSkipSSLChain() {
 300         return sSkipSSLChain;
 301     }
 302 
 303     /**
 304      * ËÆæÁΩÆhttpsÂøΩÁï•ËØÅ‰π¶
 305      *
 306      * @param skipSSLChain trueÊó∂ÊòØhulve
 307      * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
 308      */
 309     @Deprecated
 310     public static void setSkipSSLChain(boolean skipSSLChain) {
 311         sSkipSSLChain = skipSSLChain;
 312     }
 313 
 314 
 315     public static int getHttpReadTimeout() {
 316         return sHttpReadTimeout;
 317     }
 318 
 319     /**
 320      * Â¶ÇÊûúËÆæÁΩÆÂ∞è‰∫é 0 Â∞±‰ΩøÁî®ÈªòËÆ§ 8000 MILLIS
 321      */
 322     public static void setHttpReadTimeout(int httpReadTimeout) {
 323         ExoSourceManager.sHttpReadTimeout = httpReadTimeout;
 324     }
 325 
 326     public static int getHttpConnectTimeout() {
 327         return sHttpConnectTimeout;
 328     }
 329 
 330     /**
 331      * Â¶ÇÊûúËÆæÁΩÆÂ∞è‰∫é 0 Â∞±‰ΩøÁî®ÈªòËÆ§ 8000 MILLIS
 332      */
 333     public static void setHttpConnectTimeout(int httpConnectTimeout) {
 334         ExoSourceManager.sHttpConnectTimeout = httpConnectTimeout;
 335     }
 336 
 337     public static DatabaseProvider getDatabaseProvider() {
 338         return sDatabaseProvider;
 339     }
 340 
 341     public static void setDatabaseProvider(DatabaseProvider databaseProvider) {
 342         ExoSourceManager.sDatabaseProvider = databaseProvider;
 343     }
 344 
 345     /**
 346      * Ëé∑ÂèñSourceFactoryÔºåÊòØÂê¶Â∏¶Cache
 347      */
<abbr title=" 348     private DataSource.Factory getDataSourceFactoryCache(Context context, boolean cacheEnable, boolean preview, File cacheDir, String uerAgent) {"> 348     private DataSource.Factory getDataSourceFactoryCache(Context context, boolean cacheEnable, boolean prüîµ</abbr>
 349         if (cacheEnable) {
 350             Cache cache = getCacheSingleInstance(context, cacheDir);
 351             if (cache != null) {
 352                 isCached = resolveCacheState(cache, mDataSource);
 353                 CacheDataSource.Factory factory = new CacheDataSource.Factory();
 354                 return factory.
<abbr title=" 355                         setCache(cache).setCacheReadDataSourceFactory(getDataSourceFactory(context, preview, uerAgent)).setFlags(CacheDataSource.FLAG_IGNORE_CACHE_ON_ERROR);"> 355                         setCache(cache).setCacheReadDataSourceFactory(getDataSourceFactory(context, previüîµ</abbr>
 356             }
 357         }
 358         return getDataSourceFactory(context, preview, uerAgent);
 359     }
 360 
 361     /**
 362      * Ëé∑ÂèñSourceFactory
 363      */
 364     private DataSource.Factory getDataSourceFactory(Context context, boolean preview, String uerAgent) {
<abbr title=" 365         return new DefaultDataSourceFactory(context, preview ? null : new DefaultBandwidthMeter.Builder(context).build(),"> 365         return new DefaultDataSourceFactory(context, preview ? null : new DefaultBandwidthMeter.Builder(cüîµ</abbr>
 366                 getHttpDataSourceFactory(context, preview, uerAgent));
 367     }
 368 
<abbr title=" 369     private DataSource.Factory getHttpDataSourceFactory(Context context, boolean preview, String uerAgent) {"> 369     private DataSource.Factory getHttpDataSourceFactory(Context context, boolean preview, String uerAgentüîµ</abbr>
 370         if (uerAgent == null) {
 371             uerAgent = Util.getUserAgent(context, TAG);
 372         }
 373         int connectTimeout = DefaultHttpDataSource.DEFAULT_CONNECT_TIMEOUT_MILLIS;
 374         int readTimeout = DefaultHttpDataSource.DEFAULT_READ_TIMEOUT_MILLIS;
 375         if (sHttpConnectTimeout &gt; 0) {
 376             connectTimeout = sHttpConnectTimeout;
 377         }
 378         if (sHttpReadTimeout &gt; 0) {
 379             readTimeout = sHttpReadTimeout;
 380         }
 381         boolean allowCrossProtocolRedirects = false;
 382         if (mMapHeadData != null &amp;&amp; mMapHeadData.size() &gt; 0) {
 383             allowCrossProtocolRedirects = &quot;true&quot;.equals(mMapHeadData.get(&quot;allowCrossProtocolRedirects&quot;));
 384         }
 385         DataSource.Factory dataSourceFactory;
 386         if (sExoMediaSourceInterceptListener != null) {
<abbr title=" 387             dataSourceFactory = sExoMediaSourceInterceptListener.getHttpDataSourceFactory(uerAgent, preview ? null : new DefaultBandwidthMeter.Builder(mAppContext).build(),"> 387             dataSourceFactory = sExoMediaSourceInterceptListener.getHttpDataSourceFactory(uerAgent, previüîµ</abbr>
 388                     connectTimeout,
 389                     readTimeout, mMapHeadData, allowCrossProtocolRedirects);
 390         } else {
 391             dataSourceFactory = new DefaultHttpDataSource.Factory()
 392                     .setAllowCrossProtocolRedirects(allowCrossProtocolRedirects)
 393                     .setConnectTimeoutMs(connectTimeout)
 394                     .setReadTimeoutMs(readTimeout)
<abbr title=" 395                     .setTransferListener(preview ? null : new DefaultBandwidthMeter.Builder(mAppContext).build());"> 395                     .setTransferListener(preview ? null : new DefaultBandwidthMeter.Builder(mAppContext).üîµ</abbr>
 396         if (mMapHeadData != null &amp;&amp; mMapHeadData.size() &gt; 0) {
<abbr title=" 397                 ((DefaultHttpDataSource.Factory) dataSourceFactory).setDefaultRequestProperties(mMapHeadData);"> 397                 ((DefaultHttpDataSource.Factory) dataSourceFactory).setDefaultRequestProperties(mMapHeadDüîµ</abbr>
 398             }
 399         }
 400         return dataSourceFactory;
 401     }
 402 
 403     /**
 404      * Ê†πÊçÆÁºìÂ≠òÂùóÂà§Êñ≠ÊòØÂê¶ÁºìÂ≠òÊàêÂäü
 405      */
 406     private static boolean resolveCacheState(Cache cache, String url) {
 407         boolean isCache = true;
 408         if (!TextUtils.isEmpty(url)) {
 409             String key = buildCacheKey(url);
 410             if (!TextUtils.isEmpty(key)) {
 411                 NavigableSet&lt;CacheSpan&gt; cachedSpans = cache.getCachedSpans(key);
 412                 if (cachedSpans.size() == 0) {
 413                     isCache = false;
 414                 } else {
<abbr title=" 415                     long contentLength = cache.getContentMetadata(key).get(ContentMetadata.KEY_CONTENT_LENGTH, C.LENGTH_UNSET);"> 415                     long contentLength = cache.getContentMetadata(key).get(ContentMetadata.KEY_CONTENT_LEüîµ</abbr>
 416                     long currentLength = 0;
 417                     for (CacheSpan cachedSpan : cachedSpans) {
<abbr title=" 418                         currentLength += cache.getCachedLength(key, cachedSpan.position, cachedSpan.length);"> 418                         currentLength += cache.getCachedLength(key, cachedSpan.position, cachedSpan.lengtüîµ</abbr>
 419                     }
 420                     isCache = currentLength &gt;= contentLength;
 421                 }
 422             } else {
 423                 isCache = false;
 424             }
 425         }
 426         return isCache;
 427     }
 428 }
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package tv.danmaku.ijk.media.exo2;
   2 
   3 import android.annotation.SuppressLint;
   4 import android.content.Context;
   5 import android.net.Uri;
   6 import android.text.TextUtils;
   7 import androidx.annotation.NonNull;
   8 import androidx.annotation.Nullable;
   9 import com.google.android.exoplayer2.C;
  10 import com.google.android.exoplayer2.MediaItem;
  11 import com.google.android.exoplayer2.database.DatabaseProvider;
  12 import com.google.android.exoplayer2.ext.rtmp.RtmpDataSourceFactory;
  13 import com.google.android.exoplayer2.extractor.DefaultExtractorsFactory;
  14 import com.google.android.exoplayer2.source.MediaSource;
  15 import com.google.android.exoplayer2.source.ProgressiveMediaSource;
  16 import com.google.android.exoplayer2.source.dash.DashMediaSource;
  17 import com.google.android.exoplayer2.source.dash.DefaultDashChunkSource;
  18 import com.google.android.exoplayer2.source.hls.HlsMediaSource;
  19 import com.google.android.exoplayer2.source.smoothstreaming.DefaultSsChunkSource;
  20 import com.google.android.exoplayer2.source.smoothstreaming.SsMediaSource;
  21 import com.google.android.exoplayer2.upstream.DataSource;
  22 import com.google.android.exoplayer2.upstream.DataSpec;
  23 import com.google.android.exoplayer2.upstream.DefaultBandwidthMeter;
  24 import com.google.android.exoplayer2.upstream.DefaultDataSourceFactory;
  25 import com.google.android.exoplayer2.upstream.DefaultHttpDataSource;
  26 import com.google.android.exoplayer2.upstream.RawResourceDataSource;
  27 import com.google.android.exoplayer2.upstream.cache.Cache;
  28 import com.google.android.exoplayer2.upstream.cache.CacheDataSource;
  29 import com.google.android.exoplayer2.upstream.cache.CacheKeyFactory;
  30 import com.google.android.exoplayer2.upstream.cache.CacheSpan;
  31 import com.google.android.exoplayer2.upstream.cache.ContentMetadata;
  32 import com.google.android.exoplayer2.upstream.cache.LeastRecentlyUsedCacheEvictor;
  33 import com.google.android.exoplayer2.upstream.cache.SimpleCache;
  34 import com.google.android.exoplayer2.util.Util;
  35 import com.google.common.base.Ascii;
  36 import java.io.File;
  37 import java.util.Locale;
  38 import java.util.Map;
  39 import java.util.NavigableSet;
  40 
  41 
  42 /**
  43  * Created by guoshuyu on 2018/5/18.
  44  */
  45 public class ExoSourceManager {
  46     private static final String TAG = &quot;ExoSourceManager&quot;;
  47 
  48     private static final long DEFAULT_MAX_SIZE = 512 * 1024 * 1024;
  49 
  50     public static final int TYPE_RTMP =
  51 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52 100</span>
  53 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  54 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  54 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwüîµ</abbr></span>
  55 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57 14</span>
  58 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
  59     ;
  60 
  61     private static Cache mCache;
  62 
  63     /**
  64      * ÂøΩÂæãHttpsËØÅ‰π¶Ê†°È™å
  65      *
  66      * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
  67      */
  68     @Deprecated
  69     private static boolean sSkipSSLChain = false;
  70 
  71     private static int sHttpReadTimeout = -1;
  72 
  73     private static int sHttpConnectTimeout = -1;
  74 
  75     private final Context mAppContext;
  76 
  77     private final Map&lt;String, String&gt; mMapHeadData;
  78 
  79     private String mDataSource;
  80 
  81     private static ExoMediaSourceInterceptListener sExoMediaSourceInterceptListener;
  82 
  83     private static final DatabaseProvider sDatabaseProvider;
  84 
  85     private boolean isCached = false;
  86 
<abbr title="  87     public static ExoSourceManager newInstance(Context context, @Nullable Map&lt;String, String&gt; mapHeadData) {">  87     public static ExoSourceManager newInstance(Context context, @Nullable Map&lt;String, String&gt; mapHeadDataüîµ</abbr>
  88         return new ExoSourceManager(context, mapHeadData);
  89     }
  90 
  91     private ExoSourceManager(Context context, Map&lt;String, String&gt; mapHeadData) {
  92         mAppContext = context.getApplicationContext();
  93         mMapHeadData = mapHeadData;
  94     }
  95 
  96     /**
  97      * @param dataSource  ÈìæÊé•
  98      * @param preview     ÊòØÂê¶Â∏¶‰∏äheaderÔºåÈªòËÆ§ÊúâheaderËá™Âä®ËÆæÁΩÆ‰∏∫true
  99      * @param cacheEnable ÊòØÂê¶ÈúÄË¶ÅÁºìÂ≠ò
 100      * @param isLooping   ÊòØÂê¶Âæ™ÁéØ
 101      * @param cacheDir    Ëá™ÂÆö‰πâÁºìÂ≠òÁõÆÂΩï
 102      */
<abbr title=" 103     public MediaSource getMediaSource(String dataSource, boolean preview, boolean cacheEnable, boolean isLooping, File cacheDir, @Nullable"> 103     public MediaSource getMediaSource(String dataSource, boolean preview, boolean cacheEnable, boolean isüîµ</abbr>
 104     String overrideExtension) {
 105         MediaSource mediaSource = null;
 106         if (sExoMediaSourceInterceptListener != null) {
<abbr title=" 107             mediaSource = sExoMediaSourceInterceptListener.getMediaSource(dataSource, preview, cacheEnable, isLooping, cacheDir);"> 107             mediaSource = sExoMediaSourceInterceptListener.getMediaSource(dataSource, preview, cacheEnablüîµ</abbr>
 108         }
 109         if (mediaSource != null) {
 110             return mediaSource;
 111         }
 112         mDataSource = dataSource;
 113         Uri contentUri = Uri.parse(dataSource);
 114         MediaItem mediaItem = MediaItem.fromUri(contentUri);
 115         int contentType = inferContentType(dataSource, overrideExtension);
 116         String uerAgent = null;
 117         if (mMapHeadData != null) {
 118             uerAgent = mMapHeadData.get(&quot;User-Agent&quot;);
 119         }
 120         if (&quot;android.resource&quot;.equals(contentUri.getScheme())) {
 121             DataSpec dataSpec = new DataSpec(contentUri);
 122             final RawResourceDataSource rawResourceDataSource = new RawResourceDataSource(mAppContext);
 123             try {
 124                 rawResourceDataSource.open(dataSpec);
 125             } catch (RawResourceDataSource e) {
 126                 e.printStackTrace();
 127             }
 128             DataSource.Factory factory = () -&gt; rawResourceDataSource;
 129             return new ProgressiveMediaSource.Factory(factory).createMediaSource(mediaItem);
 130         }
 131         switch (contentType) {
 132             case C.TYPE_SS :
<abbr title=" 133                 mediaSource = new SsMediaSource.Factory(new DefaultSsChunkSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent)), new DefaultDataSourceFactory(mAppContext, null, getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSource(mediaItem);"> 133                 mediaSource = new SsMediaSource.Factory(new DefaultSsChunkSource.Factory(getDataSourceFacüîµ</abbr>
 134                 break;
 135             case C.TYPE_DASH :
<abbr title=" 136                 mediaSource = new DashMediaSource.Factory(new DefaultDashChunkSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent)), new DefaultDataSourceFactory(mAppContext, null, getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSource(mediaItem);"> 136                 mediaSource = new DashMediaSource.Factory(new DefaultDashChunkSource.Factory(getDataSourcüîµ</abbr>
 137                 break;
 138             case C.TYPE_HLS :
<abbr title=" 139                 mediaSource = new HlsMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent)).setAllowChunklessPreparation(true).createMediaSource(mediaItem);"> 139                 mediaSource = new HlsMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnabüîµ</abbr>
 140                 break;
 141             case TYPE_RTMP :
 142                 RtmpDataSourceFactory rtmpDataSourceFactory = new RtmpDataSourceFactory(null);
<abbr title=" 143                 mediaSource = new ProgressiveMediaSource.Factory(rtmpDataSourceFactory, new DefaultExtractorsFactory()).createMediaSource(mediaItem);"> 143                 mediaSource = new ProgressiveMediaSource.Factory(rtmpDataSourceFactory, new DefaultExtracüîµ</abbr>
 144                 break;
 145             case C.TYPE_OTHER :
 146             default :
<abbr title=" 147                 mediaSource = new ProgressiveMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent), new DefaultExtractorsFactory()).createMediaSource(mediaItem);"> 147                 mediaSource = new ProgressiveMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cüîµ</abbr>
 148                 break;
 149         }
 150         return mediaSource;
 151     }
 152 
 153     /**
 154      * ËÆæÁΩÆExoPlayer ÁöÑ MediaSource ÂàõÂª∫Êã¶Êà™
 155      */
<abbr title=" 156     public static void setExoMediaSourceInterceptListener(ExoMediaSourceInterceptListener exoMediaSourceInterceptListener) {"> 156     public static void setExoMediaSourceInterceptListener(ExoMediaSourceInterceptListener exoMediaSourceIüîµ</abbr>
 157         sExoMediaSourceInterceptListener = exoMediaSourceInterceptListener;
 158     }
 159 
 160     public static void resetExoMediaSourceInterceptListener() {
 161         sExoMediaSourceInterceptListener = null;
 162     }
 163 
 164     public static ExoMediaSourceInterceptListener getExoMediaSourceInterceptListener() {
 165         return sExoMediaSourceInterceptListener;
 166     }
 167 
 168     @SuppressLint(&quot;WrongConstant&quot;)
 169     @C.ContentType
 170     public static int inferContentType(@NonNull
 171     String fileName, @Nullable
 172     String overrideExtension) {
 173         fileName = fileName.toLowerCase(Locale.US);
 174         if (fileName.startsWith(&quot;rtmp:&quot;)) {
 175             return TYPE_RTMP;
 176         } else {
 177             return inferContentType(Uri.parse(fileName), overrideExtension);
 178         }
 179     }
 180 
 181     @C.ContentType
 182     public static int inferContentType(Uri uri, @Nullable String overrideExtension) {
 183         return Util.inferContentType(uri, overrideExtension);
 184     }
 185 
 186     /**
 187      * Êú¨Âú∞ÁºìÂ≠òÁõÆÂΩï
 188      */
 189     public static synchronized Cache getCacheSingleInstance(Context context, File cacheDir) {
 190         String dirs = context.getCacheDir().getAbsolutePath();
 191         if (cacheDir != null) {
 192             dirs = cacheDir.getAbsolutePath();
 193         }
 194         if (mCache == null) {
 195             String path = (dirs + File.separator) + &quot;exo&quot;;
 196             boolean isLocked = SimpleCache.isCacheFolderLocked(new File(path));
 197             if (!isLocked) {
<abbr title=" 198                 mCache = new SimpleCache(new File(path), new LeastRecentlyUsedCacheEvictor(DEFAULT_MAX_SIZE), sDatabaseProvider);"> 198                 mCache = new SimpleCache(new File(path), new LeastRecentlyUsedCacheEvictor(DEFAULT_MAX_SIüîµ</abbr>
 199             }
 200         }
 201         return mCache;
 202     }
 203 
 204     public void release() {
 205         isCached = false;
 206         if (mCache != null) {
 207             try {
 208                 mCache.release();
 209                 mCache = null;
 210             } catch (Exception e) {
 211                 e.printStackTrace();
 212             }
 213         }
 214     }
 215 
 216     /**
 217      * CacheÈúÄË¶Årelease‰πãÂêéÊâçËÉΩclear
 218      */
 219     public static void clearCache(Context context, File cacheDir, String url) {
 220         try {
 221             Cache cache = getCacheSingleInstance(context, cacheDir);
 222             if (!TextUtils.isEmpty(url)) {
 223                 if (cache != null) {
 224                     removeCache(cache, url);
 225                 }
 226             } else if (cache != null) {
 227                 for (String key : cache.getKeys()) {
 228                     removeCache(cache, key);
 229                 }
 230             }
 231         } catch (java.lang.Exception e) {
 232             e.printStackTrace();
 233         }
 234     }
 235 
 236     public static void removeCache(Cache cache, String url) {
 237         NavigableSet&lt;CacheSpan&gt; cachedSpans = cache.getCachedSpans(buildCacheKey(url));
 238         for (CacheSpan cachedSpan : cachedSpans) {
 239             try {
 240                 cache.removeSpan(cachedSpan);
 241             } catch (Exception e) {
 242                 // Do nothing.
 243             }
 244         }
 245     }
 246 
 247     public static String buildCacheKey(String url) {
 248         DataSpec dataSpec = new DataSpec(Uri.parse(url));
 249         return CacheKeyFactory.DEFAULT.buildCacheKey(dataSpec);
 250     }
 251 
 252     public static boolean cachePreView(Context context, File cacheDir, String url) {
 253         return resolveCacheState(getCacheSingleInstance(context, cacheDir), url);
 254     }
 255 
 256     public boolean hadCached() {
 257         return isCached;
 258     }
 259 
 260     /**
 261      * ÂøΩÂæãHttpsËØÅ‰π¶Ê†°È™å
 262      *
 263      * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
 264      */
 265     @Deprecated
 266     public static boolean isSkipSSLChain() {
 267         return sSkipSSLChain;
 268     }
 269 
 270     /**
 271      * ËÆæÁΩÆhttpsÂøΩÁï•ËØÅ‰π¶
 272      *
 273      * @param skipSSLChain trueÊó∂ÊòØhulve
 274      * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
 275      */
 276     @Deprecated
 277     public static void setSkipSSLChain(boolean skipSSLChain) {
 278         sSkipSSLChain = skipSSLChain;
 279     }
 280 
 281     public static int getHttpReadTimeout() {
 282         return sHttpReadTimeout;
 283     }
 284 
 285     /**
 286      * Â¶ÇÊûúËÆæÁΩÆÂ∞è‰∫é 0 Â∞±‰ΩøÁî®ÈªòËÆ§ 8000 MILLIS
 287      */
 288     public static void setHttpReadTimeout(int httpReadTimeout) {
 289         ExoSourceManager.sHttpReadTimeout = httpReadTimeout;
 290     }
 291 
 292     public static int getHttpConnectTimeout() {
 293         return sHttpConnectTimeout;
 294     }
 295 
 296     /**
 297      * Â¶ÇÊûúËÆæÁΩÆÂ∞è‰∫é 0 Â∞±‰ΩøÁî®ÈªòËÆ§ 8000 MILLIS
 298      */
 299     public static void setHttpConnectTimeout(int httpConnectTimeout) {
 300         ExoSourceManager.sHttpConnectTimeout = httpConnectTimeout;
 301     }
 302 
 303     public static DatabaseProvider getDatabaseProvider() {
 304         return sDatabaseProvider;
 305     }
 306 
 307     public static void setDatabaseProvider(DatabaseProvider databaseProvider) {
 308         ExoSourceManager.sDatabaseProvider = databaseProvider;
 309     }
 310 
 311     /**
 312      * Ëé∑ÂèñSourceFactoryÔºåÊòØÂê¶Â∏¶Cache
 313      */
<abbr title=" 314     private DataSource.Factory getDataSourceFactoryCache(Context context, boolean cacheEnable, boolean preview, File cacheDir, String uerAgent) {"> 314     private DataSource.Factory getDataSourceFactoryCache(Context context, boolean cacheEnable, boolean prüîµ</abbr>
 315         if (cacheEnable) {
 316             Cache cache = getCacheSingleInstance(context, cacheDir);
 317             if (cache != null) {
 318                 isCached = resolveCacheState(cache, mDataSource);
 319                 CacheDataSource.Factory factory = new CacheDataSource.Factory();
 320                 return factory.
<abbr title=" 321                         setCache(cache).setCacheReadDataSourceFactory(getDataSourceFactory(context, preview, uerAgent)).setFlags(CacheDataSource.FLAG_IGNORE_CACHE_ON_ERROR);"> 321                         setCache(cache).setCacheReadDataSourceFactory(getDataSourceFactory(context, previüîµ</abbr>
 322             }
 323         }
 324         return getDataSourceFactory(context, preview, uerAgent);
 325     }
 326 
 327     /**
 328      * Ëé∑ÂèñSourceFactory
 329      */
 330     private DataSource.Factory getDataSourceFactory(Context context, boolean preview, String uerAgent) {
<abbr title=" 331         return new DefaultDataSourceFactory(context, preview ? null : new DefaultBandwidthMeter.Builder(context).build(),"> 331         return new DefaultDataSourceFactory(context, preview ? null : new DefaultBandwidthMeter.Builder(cüîµ</abbr>
 332                 getHttpDataSourceFactory(context, preview, uerAgent));
 333     }
 334 
<abbr title=" 335     private DataSource.Factory getHttpDataSourceFactory(Context context, boolean preview, String uerAgent) {"> 335     private DataSource.Factory getHttpDataSourceFactory(Context context, boolean preview, String uerAgentüîµ</abbr>
 336         if (uerAgent == null) {
 337             uerAgent = Util.getUserAgent(context, TAG);
 338         }
 339         int connectTimeout = DefaultHttpDataSource.DEFAULT_CONNECT_TIMEOUT_MILLIS;
 340         int readTimeout = DefaultHttpDataSource.DEFAULT_READ_TIMEOUT_MILLIS;
 341         if (sHttpConnectTimeout &gt; 0) {
 342             connectTimeout = sHttpConnectTimeout;
 343         }
 344         if (sHttpReadTimeout &gt; 0) {
 345             readTimeout = sHttpReadTimeout;
 346         }
 347         boolean allowCrossProtocolRedirects = false;
 348         if ((mMapHeadData != null) &amp;&amp; (mMapHeadData.size() &gt; 0)) {
 349             allowCrossProtocolRedirects = &quot;true&quot;.equals(mMapHeadData.get(&quot;allowCrossProtocolRedirects&quot;));
 350         }
 351         DataSource.Factory dataSourceFactory;
 352         if (sExoMediaSourceInterceptListener != null) {
<abbr title=" 353             dataSourceFactory = sExoMediaSourceInterceptListener.getHttpDataSourceFactory(uerAgent, preview ? null : new DefaultBandwidthMeter.Builder(mAppContext).build(), connectTimeout, readTimeout, mMapHeadData, allowCrossProtocolRedirects);"> 353             dataSourceFactory = sExoMediaSourceInterceptListener.getHttpDataSourceFactory(uerAgent, previüîµ</abbr>
 354         } else {
<abbr title=" 355             dataSourceFactory = new DefaultHttpDataSource.Factory().setAllowCrossProtocolRedirects(allowCrossProtocolRedirects).setConnectTimeoutMs(connectTimeout).setReadTimeoutMs(readTimeout).setTransferListener(preview ? null : new DefaultBandwidthMeter.Builder(mAppContext).build());"> 355             dataSourceFactory = new DefaultHttpDataSource.Factory().setAllowCrossProtocolRedirects(allowCüîµ</abbr>
 356             if ((mMapHeadData != null) &amp;&amp; (mMapHeadData.size() &gt; 0)) {
<abbr title=" 357                 ((DefaultHttpDataSource.Factory) (dataSourceFactory)).setDefaultRequestProperties(mMapHeadData);"> 357                 ((DefaultHttpDataSource.Factory) (dataSourceFactory)).setDefaultRequestProperties(mMapHeaüîµ</abbr>
 358             }
 359         }
 360         return dataSourceFactory;
 361     }
 362 
 363     /**
 364      * Ê†πÊçÆÁºìÂ≠òÂùóÂà§Êñ≠ÊòØÂê¶ÁºìÂ≠òÊàêÂäü
 365      */
 366     private static boolean resolveCacheState(Cache cache, String url) {
 367         boolean isCache = true;
 368         if (!TextUtils.isEmpty(url)) {
 369             String key = buildCacheKey(url);
 370             if (!TextUtils.isEmpty(key)) {
 371                 NavigableSet&lt;CacheSpan&gt; cachedSpans = cache.getCachedSpans(key);
 372                 if (cachedSpans.size() == 0) {
 373                     isCache = false;
 374                 } else {
<abbr title=" 375                     long contentLength = cache.getContentMetadata(key).get(ContentMetadata.KEY_CONTENT_LENGTH, C.LENGTH_UNSET);"> 375                     long contentLength = cache.getContentMetadata(key).get(ContentMetadata.KEY_CONTENT_LEüîµ</abbr>
 376                     long currentLength = 0;
 377                     for (CacheSpan cachedSpan : cachedSpans) {
<abbr title=" 378                         currentLength += cache.getCachedLength(key, cachedSpan.position, cachedSpan.length);"> 378                         currentLength += cache.getCachedLength(key, cachedSpan.position, cachedSpan.lengtüîµ</abbr>
 379                     }
 380                     isCache = currentLength &gt;= contentLength;
 381                 }
 382             } else {
 383                 isCache = false;
 384             }
 385         }
 386         return isCache;
 387     }
 388 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package tv.danmaku.ijk.media.exo2;
   2  
   3  import android.annotation.SuppressLint;
   4  import android.content.Context;
   5  import android.net.Uri;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 +import android.text.TextUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 +import androidx.annotation.NonNull;</span>
  10  import androidx.annotation.Nullable;
  11  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 -import android.text.TextUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 -</span>
  14  import com.google.android.exoplayer2.C;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 -import com.google.android.exoplayer2.Format;</span>
  16  import com.google.android.exoplayer2.MediaItem;

  17  import com.google.android.exoplayer2.ext.rtmp.RtmpDataSourceFactory;
  18  import com.google.android.exoplayer2.extractor.DefaultExtractorsFactory;
  19  import com.google.android.exoplayer2.source.LoopingMediaSource;
  20  import com.google.android.exoplayer2.source.MediaSource;
  21  import com.google.android.exoplayer2.source.ProgressiveMediaSource;
  22  import com.google.android.exoplayer2.source.dash.DashMediaSource;
  23  import com.google.android.exoplayer2.source.dash.DefaultDashChunkSource;
  24  import com.google.android.exoplayer2.source.hls.HlsMediaSource;
  25  import com.google.android.exoplayer2.source.smoothstreaming.DefaultSsChunkSource;
  26  import com.google.android.exoplayer2.source.smoothstreaming.SsMediaSource;
  27  import com.google.android.exoplayer2.upstream.DataSource;
  28  import com.google.android.exoplayer2.upstream.DataSpec;
  29  import com.google.android.exoplayer2.upstream.DefaultBandwidthMeter;
  30  import com.google.android.exoplayer2.upstream.DefaultDataSourceFactory;
  31  import com.google.android.exoplayer2.upstream.DefaultHttpDataSource;
  32  import com.google.android.exoplayer2.upstream.DefaultHttpDataSourceFactory;
  33  import com.google.android.exoplayer2.upstream.HttpDataSource;
  34  import com.google.android.exoplayer2.upstream.RawResourceDataSource;
  35  import com.google.android.exoplayer2.upstream.cache.Cache;
  36  import com.google.android.exoplayer2.upstream.cache.CacheDataSource;
  37  import com.google.android.exoplayer2.upstream.cache.CacheKeyFactory;
  38  import com.google.android.exoplayer2.upstream.cache.CacheSpan;
  39  import com.google.android.exoplayer2.upstream.cache.ContentMetadata;
  40  import com.google.android.exoplayer2.upstream.cache.LeastRecentlyUsedCacheEvictor;
  41  import com.google.android.exoplayer2.upstream.cache.SimpleCache;
  42  import com.google.android.exoplayer2.util.Util;

  43  
  44  import java.io.File;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import java.util.Locale;</span>
  46  import java.util.Map;
  47  import java.util.NavigableSet;
  48  
  49  
  50  /**
  51   * Created by guoshuyu on 2018/5/18.
  52   */
  53  
  54  public class ExoSourceManager {
  55  
  56      private static final String TAG = &quot;ExoSourceManager&quot;;
  57  
  58      private static final long DEFAULT_MAX_SIZE = 512 * 1024 * 1024;
  59  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -    public static final int TYPE_RTMP = 4;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +    public static final int TYPE_RTMP = 100;</span>
  62  
  63      private static Cache mCache;
  64      /**
  65       * ÂøΩÂæãHttpsËØÅ‰π¶Ê†°È™å
  66       *
  67       * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
  68       */
  69      @Deprecated
  70      private static boolean sSkipSSLChain = false;
  71  
  72      private static int sHttpReadTimeout = -1;
  73  
  74      private static int sHttpConnectTimeout = -1;
  75  
  76  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -    private static boolean s = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -    private Context mAppContext;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -    private Map&lt;String, String&gt; mMapHeadData;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +    private static final boolean s = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +    private final Context mAppContext;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +    private final Map&lt;String, String&gt; mMapHeadData;</span>
  87  
  88      private String mDataSource;
  89  
  90      private static ExoMediaSourceInterceptListener sExoMediaSourceInterceptListener;

  91  
  92      private boolean isCached = false;
  93  
  94      public static ExoSourceManager newInstance(Context context, @Nullable Map&lt;String, String&gt; mapHeadData) {
  95          return new ExoSourceManager(context, mapHeadData);
  96      }
  97  
  98      private ExoSourceManager(Context context, Map&lt;String, String&gt; mapHeadData) {
  99          mAppContext = context.getApplicationContext();
 100          mMapHeadData = mapHeadData;
 101      }
 102  
 103      /**
 104       * @param dataSource  ÈìæÊé•
 105       * @param preview     ÊòØÂê¶Â∏¶‰∏äheaderÔºåÈªòËÆ§ÊúâheaderËá™Âä®ËÆæÁΩÆ‰∏∫true
 106       * @param cacheEnable ÊòØÂê¶ÈúÄË¶ÅÁºìÂ≠ò
 107       * @param isLooping   ÊòØÂê¶Âæ™ÁéØ
 108       * @param cacheDir    Ëá™ÂÆö‰πâÁºìÂ≠òÁõÆÂΩï
 109       */
<abbr title=" 110      public MediaSource getMediaSource(String dataSource, boolean preview, boolean cacheEnable, boolean isLooping, File cacheDir, @Nullable String overrideExtension) {"> 110      public MediaSource getMediaSource(String dataSource, boolean preview, boolean cacheEnable, boolean isLooping, üîµ</abbr>
 111          MediaSource mediaSource = null;
 112          if (sExoMediaSourceInterceptListener != null) {
<abbr title=" 113              mediaSource = sExoMediaSourceInterceptListener.getMediaSource(dataSource, preview, cacheEnable, isLooping, cacheDir);"> 113              mediaSource = sExoMediaSourceInterceptListener.getMediaSource(dataSource, preview, cacheEnable, isLoopüîµ</abbr>
 114          }
 115          if (mediaSource != null) {
 116              return mediaSource;
 117          }
 118          mDataSource = dataSource;
 119          Uri contentUri = Uri.parse(dataSource);
 120          MediaItem mediaItem = MediaItem.fromUri(contentUri);
 121          int contentType = inferContentType(dataSource, overrideExtension);
 122  
 123          String uerAgent = null;
 124          if (mMapHeadData != null) {
 125              uerAgent = mMapHeadData.get(&quot;User-Agent&quot;);
 126          }
 127          if (&quot;android.resource&quot;.equals(contentUri.getScheme())) {
 128              DataSpec dataSpec = new DataSpec(contentUri);
 129              final RawResourceDataSource rawResourceDataSource = new RawResourceDataSource(mAppContext);
 130              try {
 131                  rawResourceDataSource.open(dataSpec);
 132              } catch (RawResourceDataSource.RawResourceDataSourceException e) {
 133                  e.printStackTrace();
 134              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -            DataSource.Factory factory = new DataSource.Factory() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -                @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -                public DataSource createDataSource() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -                    return rawResourceDataSource;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -            };</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +            DataSource.Factory factory = () -&gt; rawResourceDataSource;</span>
 142              return new ProgressiveMediaSource.Factory(
 143                      factory).createMediaSource(mediaItem);
 144  
 145          }
 146  
 147          switch (contentType) {
 148              case C.TYPE_SS:
 149                  mediaSource = new SsMediaSource.Factory(
<abbr title=" 150                          new DefaultSsChunkSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent)),"> 150                          new DefaultSsChunkSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, previüîµ</abbr>
 151                          new DefaultDataSourceFactory(mAppContext, null,
<abbr title=" 152                                  getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSource(mediaItem);"> 152                                  getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSource(mediaüîµ</abbr>
 153                  break;
 154              case C.TYPE_DASH:
<abbr title=" 155                  mediaSource = new DashMediaSource.Factory(new DefaultDashChunkSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent)),"> 155                  mediaSource = new DashMediaSource.Factory(new DefaultDashChunkSource.Factory(getDataSourceFactoryCüîµ</abbr>
 156                          new DefaultDataSourceFactory(mAppContext, null,
<abbr title=" 157                                  getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSource(mediaItem);"> 157                                  getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSource(mediaüîµ</abbr>
 158                  break;
 159              case C.TYPE_HLS:
<abbr title=" 160                  mediaSource = new HlsMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent))"> 160                  mediaSource = new HlsMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, previüîµ</abbr>
 161                          .setAllowChunklessPreparation(true)
 162                          .createMediaSource(mediaItem);
 163                  break;
 164              case TYPE_RTMP:
 165                  RtmpDataSourceFactory rtmpDataSourceFactory = new RtmpDataSourceFactory(null);
 166                  mediaSource = new ProgressiveMediaSource.Factory(rtmpDataSourceFactory,
 167                          new DefaultExtractorsFactory())
 168                          .createMediaSource(mediaItem);
 169                  break;
 170              case C.TYPE_OTHER:
 171              default:
<abbr title=" 172                  mediaSource = new ProgressiveMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable,"> 172                  mediaSource = new ProgressiveMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnablüîµ</abbr>
 173                          preview, cacheDir, uerAgent), new DefaultExtractorsFactory())
 174                          .createMediaSource(mediaItem);
 175                  break;
 176          }
 177          if (isLooping) {
 178              return new LoopingMediaSource(mediaSource);
 179          }
 180          return mediaSource;
 181      }
 182  
 183  
 184      /**
 185       * ËÆæÁΩÆExoPlayer ÁöÑ MediaSource ÂàõÂª∫Êã¶Êà™
 186       */
<abbr title=" 187      public static void setExoMediaSourceInterceptListener(ExoMediaSourceInterceptListener exoMediaSourceInterceptListener) {"> 187      public static void setExoMediaSourceInterceptListener(ExoMediaSourceInterceptListener exoMediaSourceInterceptLüîµ</abbr>
 188          sExoMediaSourceInterceptListener = exoMediaSourceInterceptListener;
 189      }
 190  
 191      public static void resetExoMediaSourceInterceptListener() {
 192          sExoMediaSourceInterceptListener = null;
 193      }
 194  
 195      public static ExoMediaSourceInterceptListener getExoMediaSourceInterceptListener() {
 196          return sExoMediaSourceInterceptListener;
 197      }
 198  
 199  
 200      @SuppressLint(&quot;WrongConstant&quot;)
 201      @C.ContentType
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -    public static int inferContentType(String fileName, @Nullable String overrideExtension) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -        fileName = Util.toLowerInvariant(fileName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +    public static int inferContentType(@NonNull String fileName, @Nullable String overrideExtension) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +        fileName = fileName.toLowerCase(Locale.US);</span>
 206          if (fileName.startsWith(&quot;rtmp:&quot;)) {
 207              return TYPE_RTMP;
 208          } else {
 209              return inferContentType(Uri.parse(fileName), overrideExtension);
 210          }
 211      }
 212  
 213      @C.ContentType
 214      public static int inferContentType(Uri uri, @Nullable String overrideExtension) {
 215          return Util.inferContentType(uri, overrideExtension);
 216      }
 217  
 218      /**
 219       * Êú¨Âú∞ÁºìÂ≠òÁõÆÂΩï
 220       */
 221      public static synchronized Cache getCacheSingleInstance(Context context, File cacheDir) {
 222          String dirs = context.getCacheDir().getAbsolutePath();
 223          if (cacheDir != null) {
 224              dirs = cacheDir.getAbsolutePath();
 225          }
 226          if (mCache == null) {
 227              String path = dirs + File.separator + &quot;exo&quot;;
 228              boolean isLocked = SimpleCache.isCacheFolderLocked(new File(path));
 229              if (!isLocked) {
 230                  mCache = new SimpleCache(new File(path), new LeastRecentlyUsedCacheEvictor(DEFAULT_MAX_SIZE));

 231              }
 232          }
 233          return mCache;
 234      }
 235  
 236      public void release() {
 237          isCached = false;
 238          if (mCache != null) {
 239              try {
 240                  mCache.release();
 241                  mCache = null;
 242              } catch (Exception e) {
 243                  e.printStackTrace();
 244              }
 245          }
 246      }
 247  
 248      /**
 249       * CacheÈúÄË¶Årelease‰πãÂêéÊâçËÉΩclear
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -     * @param context</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -     * @param cacheDir</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -     * @param url</span>
 254       */
 255      public static void clearCache(Context context, File cacheDir, String url) {
 256          try {
 257              Cache cache = getCacheSingleInstance(context, cacheDir);
 258              if (!TextUtils.isEmpty(url)) {
 259                  if (cache != null) {
 260                      removeCache(cache, url);
 261                  }
 262              } else {
 263                  if (cache != null) {
 264                      for (String key : cache.getKeys()) {
 265                          removeCache(cache, key);
 266                      }
 267                  }
 268              }
 269          } catch (Exception e) {
 270              e.printStackTrace();
 271          }
 272      }
 273  
 274  
 275      public static void removeCache(Cache cache, String url) {
 276          NavigableSet&lt;CacheSpan&gt; cachedSpans = cache.getCachedSpans(buildCacheKey(url));
 277          for (CacheSpan cachedSpan : cachedSpans) {
 278              try {
 279                  cache.removeSpan(cachedSpan);
 280              } catch (Exception e) {
 281                  // Do nothing.
 282              }
 283          }
 284      }
 285  
 286      public static String buildCacheKey(String url) {
 287          DataSpec dataSpec = new DataSpec(Uri.parse(url));
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -        String key = CacheKeyFactory.DEFAULT.buildCacheKey(dataSpec);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -        return key;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +        return CacheKeyFactory.DEFAULT.buildCacheKey(dataSpec);</span>
 291      }
 292  
 293      public static boolean cachePreView(Context context, File cacheDir, String url) {
 294          return resolveCacheState(getCacheSingleInstance(context, cacheDir), url);
 295      }
 296  
 297      public boolean hadCached() {
 298          return isCached;
 299      }
 300  
 301      /**
 302       * ÂøΩÂæãHttpsËØÅ‰π¶Ê†°È™å
 303       *
 304       * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
 305       */
 306      @Deprecated
 307      public static boolean isSkipSSLChain() {
 308          return sSkipSSLChain;
 309      }
 310  
 311      /**
 312       * ËÆæÁΩÆhttpsÂøΩÁï•ËØÅ‰π¶
 313       *
 314       * @param skipSSLChain trueÊó∂ÊòØhulve
 315       * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
 316       */
 317      @Deprecated
 318      public static void setSkipSSLChain(boolean skipSSLChain) {
 319          sSkipSSLChain = skipSSLChain;
 320      }
 321  
 322  
 323      public static int getHttpReadTimeout() {
 324          return sHttpReadTimeout;
 325      }
 326  
 327      /**
 328       * Â¶ÇÊûúËÆæÁΩÆÂ∞è‰∫é 0 Â∞±‰ΩøÁî®ÈªòËÆ§ 8000 MILLIS
 329       */
 330      public static void setHttpReadTimeout(int httpReadTimeout) {
 331          ExoSourceManager.sHttpReadTimeout = httpReadTimeout;
 332      }
 333  
 334      public static int getHttpConnectTimeout() {
 335          return sHttpConnectTimeout;
 336      }
 337  
 338      /**
 339       * Â¶ÇÊûúËÆæÁΩÆÂ∞è‰∫é 0 Â∞±‰ΩøÁî®ÈªòËÆ§ 8000 MILLIS
 340       */
 341      public static void setHttpConnectTimeout(int httpConnectTimeout) {
 342          ExoSourceManager.sHttpConnectTimeout = httpConnectTimeout;
 343      }
 344  








 345      /**
 346       * Ëé∑ÂèñSourceFactoryÔºåÊòØÂê¶Â∏¶Cache
 347       */
<abbr title=" 348      private DataSource.Factory getDataSourceFactoryCache(Context context, boolean cacheEnable, boolean preview, File cacheDir, String uerAgent) {"> 348      private DataSource.Factory getDataSourceFactoryCache(Context context, boolean cacheEnable, boolean preview, Fiüîµ</abbr>
 349          if (cacheEnable) {
 350              Cache cache = getCacheSingleInstance(context, cacheDir);
 351              if (cache != null) {
 352                  isCached = resolveCacheState(cache, mDataSource);
 353                  CacheDataSource.Factory factory = new CacheDataSource.Factory();
 354                  return factory.
<abbr title=" 355                          setCache(cache).setCacheReadDataSourceFactory(getDataSourceFactory(context, preview, uerAgent)).setFlags(CacheDataSource.FLAG_IGNORE_CACHE_ON_ERROR);"> 355                          setCache(cache).setCacheReadDataSourceFactory(getDataSourceFactory(context, preview, uerAgüîµ</abbr>
 356              }
 357          }
 358          return getDataSourceFactory(context, preview, uerAgent);
 359      }
 360  
 361      /**
 362       * Ëé∑ÂèñSourceFactory
 363       */
 364      private DataSource.Factory getDataSourceFactory(Context context, boolean preview, String uerAgent) {
<abbr title=" 365          return new DefaultDataSourceFactory(context, preview ? null : new DefaultBandwidthMeter.Builder(context).build(),"> 365          return new DefaultDataSourceFactory(context, preview ? null : new DefaultBandwidthMeter.Builder(context).büîµ</abbr>
 366                  getHttpDataSourceFactory(context, preview, uerAgent));
 367      }
 368  
 369      private DataSource.Factory getHttpDataSourceFactory(Context context, boolean preview, String uerAgent) {
 370          if (uerAgent == null) {
 371              uerAgent = Util.getUserAgent(context, TAG);
 372          }
 373          int connectTimeout = DefaultHttpDataSource.DEFAULT_CONNECT_TIMEOUT_MILLIS;
 374          int readTimeout = DefaultHttpDataSource.DEFAULT_READ_TIMEOUT_MILLIS;
 375          if (sHttpConnectTimeout &gt; 0) {
 376              connectTimeout = sHttpConnectTimeout;
 377          }
 378          if (sHttpReadTimeout &gt; 0) {
 379              readTimeout = sHttpReadTimeout;
 380          }
 381          boolean allowCrossProtocolRedirects = false;
 382          if (mMapHeadData != null &amp;&amp; mMapHeadData.size() &gt; 0) {
 383              allowCrossProtocolRedirects = &quot;true&quot;.equals(mMapHeadData.get(&quot;allowCrossProtocolRedirects&quot;));
 384          }
 385          HttpDataSource.BaseFactory dataSourceFactory;

 386          if (sExoMediaSourceInterceptListener != null) {
<abbr title=" 387              dataSourceFactory = sExoMediaSourceInterceptListener.getHttpDataSourceFactory(uerAgent, preview ? null : new DefaultBandwidthMeter.Builder(mAppContext).build(),"> 387              dataSourceFactory = sExoMediaSourceInterceptListener.getHttpDataSourceFactory(uerAgent, preview ? nullüîµ</abbr>
 388                      connectTimeout,
 389                      readTimeout, allowCrossProtocolRedirects);

 390          } else {
<abbr title=" 391              dataSourceFactory = new DefaultHttpDataSourceFactory(uerAgent, preview ? null : new DefaultBandwidthMeter.Builder(mAppContext).build(),"> 391              dataSourceFactory = new DefaultHttpDataSourceFactory(uerAgent, preview ? null : new DefaultBandwidthMeüîµ</abbr>
 392                      connectTimeout,
 393                      readTimeout, allowCrossProtocolRedirects);
 394          }
 395          if (mMapHeadData != null &amp;&amp; mMapHeadData.size() &gt; 0) {
 396              for (Map.Entry&lt;String, String&gt; header : mMapHeadData.entrySet()) {
 397                  dataSourceFactory.getDefaultRequestProperties().set(header.getKey(), header.getValue());







 398              }
 399          }
 400          return dataSourceFactory;
 401      }
 402  
 403      /**
 404       * Ê†πÊçÆÁºìÂ≠òÂùóÂà§Êñ≠ÊòØÂê¶ÁºìÂ≠òÊàêÂäü
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -     * @param cache</span>
 407       */
 408      private static boolean resolveCacheState(Cache cache, String url) {
 409          boolean isCache = true;
 410          if (!TextUtils.isEmpty(url)) {
 411              String key = buildCacheKey(url);
 412              if (!TextUtils.isEmpty(key)) {
 413                  NavigableSet&lt;CacheSpan&gt; cachedSpans = cache.getCachedSpans(key);
 414                  if (cachedSpans.size() == 0) {
 415                      isCache = false;
 416                  } else {
<abbr title=" 417                      long contentLength = cache.getContentMetadata(key).get(ContentMetadata.KEY_CONTENT_LENGTH, C.LENGTH_UNSET);"> 417                      long contentLength = cache.getContentMetadata(key).get(ContentMetadata.KEY_CONTENT_LENGTH, C.Lüîµ</abbr>
 418                      long currentLength = 0;
 419                      for (CacheSpan cachedSpan : cachedSpans) {
 420                          currentLength += cache.getCachedLength(key, cachedSpan.position, cachedSpan.length);
 421                      }
 422                      isCache = currentLength &gt;= contentLength;
 423                  }
 424              } else {
 425                  isCache = false;
 426              }
 427          }
 428          return isCache;
 429      }
 430  }</pre></td>
                            <td><pre>   1  package tv.danmaku.ijk.media.exo2;
   2  
   3  import android.annotation.SuppressLint;
   4  import android.content.Context;
   5  import android.net.Uri;
   6  



   7  import androidx.annotation.Nullable;
   8  
   9  import android.text.TextUtils;
  10  
  11  import com.google.android.exoplayer2.C;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 -import com.google.android.exoplayer2.Format;</span>
  13  import com.google.android.exoplayer2.MediaItem;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 +import com.google.android.exoplayer2.database.DatabaseProvider;</span>
  15  import com.google.android.exoplayer2.ext.rtmp.RtmpDataSourceFactory;
  16  import com.google.android.exoplayer2.extractor.DefaultExtractorsFactory;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 -import com.google.android.exoplayer2.source.LoopingMediaSource;</span>
  18  import com.google.android.exoplayer2.source.MediaSource;
  19  import com.google.android.exoplayer2.source.ProgressiveMediaSource;
  20  import com.google.android.exoplayer2.source.dash.DashMediaSource;
  21  import com.google.android.exoplayer2.source.dash.DefaultDashChunkSource;
  22  import com.google.android.exoplayer2.source.hls.HlsMediaSource;
  23  import com.google.android.exoplayer2.source.smoothstreaming.DefaultSsChunkSource;
  24  import com.google.android.exoplayer2.source.smoothstreaming.SsMediaSource;
  25  import com.google.android.exoplayer2.upstream.DataSource;
  26  import com.google.android.exoplayer2.upstream.DataSpec;
  27  import com.google.android.exoplayer2.upstream.DefaultBandwidthMeter;
  28  import com.google.android.exoplayer2.upstream.DefaultDataSourceFactory;
  29  import com.google.android.exoplayer2.upstream.DefaultHttpDataSource;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import com.google.android.exoplayer2.upstream.DefaultHttpDataSourceFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import com.google.android.exoplayer2.upstream.HttpDataSource;</span>
  32  import com.google.android.exoplayer2.upstream.RawResourceDataSource;
  33  import com.google.android.exoplayer2.upstream.cache.Cache;
  34  import com.google.android.exoplayer2.upstream.cache.CacheDataSource;
  35  import com.google.android.exoplayer2.upstream.cache.CacheKeyFactory;
  36  import com.google.android.exoplayer2.upstream.cache.CacheSpan;
  37  import com.google.android.exoplayer2.upstream.cache.ContentMetadata;
  38  import com.google.android.exoplayer2.upstream.cache.LeastRecentlyUsedCacheEvictor;
  39  import com.google.android.exoplayer2.upstream.cache.SimpleCache;
  40  import com.google.android.exoplayer2.util.Util;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import com.google.common.base.Ascii;</span>
  42  
  43  import java.io.File;

  44  import java.util.Map;
  45  import java.util.NavigableSet;
  46  
  47  
  48  /**
  49   * Created by guoshuyu on 2018/5/18.
  50   */
  51  
  52  public class ExoSourceManager {
  53  
  54      private static final String TAG = &quot;ExoSourceManager&quot;;
  55  
  56      private static final long DEFAULT_MAX_SIZE = 512 * 1024 * 1024;
  57  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -    public static final int TYPE_RTMP = 4;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +    public static final int TYPE_RTMP = 14;</span>
  60  
  61      private static Cache mCache;
  62      /**
  63       * ÂøΩÂæãHttpsËØÅ‰π¶Ê†°È™å
  64       *
  65       * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
  66       */
  67      @Deprecated
  68      private static boolean sSkipSSLChain = false;
  69  
  70      private static int sHttpReadTimeout = -1;
  71  
  72      private static int sHttpConnectTimeout = -1;
  73  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -    private static boolean s = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -</span>
  77      private Context mAppContext;
  78  
  79      private Map&lt;String, String&gt; mMapHeadData;





  80  
  81      private String mDataSource;
  82  
  83      private static ExoMediaSourceInterceptListener sExoMediaSourceInterceptListener;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +    private static DatabaseProvider sDatabaseProvider;</span>
  85  
  86      private boolean isCached = false;
  87  
  88      public static ExoSourceManager newInstance(Context context, @Nullable Map&lt;String, String&gt; mapHeadData) {
  89          return new ExoSourceManager(context, mapHeadData);
  90      }
  91  
  92      private ExoSourceManager(Context context, Map&lt;String, String&gt; mapHeadData) {
  93          mAppContext = context.getApplicationContext();
  94          mMapHeadData = mapHeadData;
  95      }
  96  
  97      /**
  98       * @param dataSource  ÈìæÊé•
  99       * @param preview     ÊòØÂê¶Â∏¶‰∏äheaderÔºåÈªòËÆ§ÊúâheaderËá™Âä®ËÆæÁΩÆ‰∏∫true
 100       * @param cacheEnable ÊòØÂê¶ÈúÄË¶ÅÁºìÂ≠ò
 101       * @param isLooping   ÊòØÂê¶Âæ™ÁéØ
 102       * @param cacheDir    Ëá™ÂÆö‰πâÁºìÂ≠òÁõÆÂΩï
 103       */
<abbr title=" 104      public MediaSource getMediaSource(String dataSource, boolean preview, boolean cacheEnable, boolean isLooping, File cacheDir, @Nullable String overrideExtension) {"> 104      public MediaSource getMediaSource(String dataSource, boolean preview, boolean cacheEnable, boolean isLooping, üîµ</abbr>
 105          MediaSource mediaSource = null;
 106          if (sExoMediaSourceInterceptListener != null) {
<abbr title=" 107              mediaSource = sExoMediaSourceInterceptListener.getMediaSource(dataSource, preview, cacheEnable, isLooping, cacheDir);"> 107              mediaSource = sExoMediaSourceInterceptListener.getMediaSource(dataSource, preview, cacheEnable, isLoopüîµ</abbr>
 108          }
 109          if (mediaSource != null) {
 110              return mediaSource;
 111          }
 112          mDataSource = dataSource;
 113          Uri contentUri = Uri.parse(dataSource);
 114          MediaItem mediaItem = MediaItem.fromUri(contentUri);
 115          int contentType = inferContentType(dataSource, overrideExtension);
 116  
 117          String uerAgent = null;
 118          if (mMapHeadData != null) {
 119              uerAgent = mMapHeadData.get(&quot;User-Agent&quot;);
 120          }
 121          if (&quot;android.resource&quot;.equals(contentUri.getScheme())) {
 122              DataSpec dataSpec = new DataSpec(contentUri);
 123              final RawResourceDataSource rawResourceDataSource = new RawResourceDataSource(mAppContext);
 124              try {
 125                  rawResourceDataSource.open(dataSpec);
 126              } catch (RawResourceDataSource.RawResourceDataSourceException e) {
 127                  e.printStackTrace();
 128              }
 129              DataSource.Factory factory = new DataSource.Factory() {
 130                  @Override
 131                  public DataSource createDataSource() {
 132                      return rawResourceDataSource;
 133                  }
 134              };

 135              return new ProgressiveMediaSource.Factory(
 136                      factory).createMediaSource(mediaItem);
 137  
 138          }
 139  
 140          switch (contentType) {
 141              case C.TYPE_SS:
 142                  mediaSource = new SsMediaSource.Factory(
<abbr title=" 143                          new DefaultSsChunkSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent)),"> 143                          new DefaultSsChunkSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, previüîµ</abbr>
 144                          new DefaultDataSourceFactory(mAppContext, null,
<abbr title=" 145                                  getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSource(mediaItem);"> 145                                  getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSource(mediaüîµ</abbr>
 146                  break;
 147              case C.TYPE_DASH:
<abbr title=" 148                  mediaSource = new DashMediaSource.Factory(new DefaultDashChunkSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent)),"> 148                  mediaSource = new DashMediaSource.Factory(new DefaultDashChunkSource.Factory(getDataSourceFactoryCüîµ</abbr>
 149                          new DefaultDataSourceFactory(mAppContext, null,
<abbr title=" 150                                  getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSource(mediaItem);"> 150                                  getHttpDataSourceFactory(mAppContext, preview, uerAgent))).createMediaSource(mediaüîµ</abbr>
 151                  break;
 152              case C.TYPE_HLS:
<abbr title=" 153                  mediaSource = new HlsMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, preview, cacheDir, uerAgent))"> 153                  mediaSource = new HlsMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable, previüîµ</abbr>
 154                          .setAllowChunklessPreparation(true)
 155                          .createMediaSource(mediaItem);
 156                  break;
 157              case TYPE_RTMP:
 158                  RtmpDataSourceFactory rtmpDataSourceFactory = new RtmpDataSourceFactory(null);
 159                  mediaSource = new ProgressiveMediaSource.Factory(rtmpDataSourceFactory,
 160                          new DefaultExtractorsFactory())
 161                          .createMediaSource(mediaItem);
 162                  break;
 163              case C.TYPE_OTHER:
 164              default:
<abbr title=" 165                  mediaSource = new ProgressiveMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnable,"> 165                  mediaSource = new ProgressiveMediaSource.Factory(getDataSourceFactoryCache(mAppContext, cacheEnablüîµ</abbr>
 166                          preview, cacheDir, uerAgent), new DefaultExtractorsFactory())
 167                          .createMediaSource(mediaItem);
 168                  break;
 169          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -        if (isLooping) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -            return new LoopingMediaSource(mediaSource);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -        }</span>
 173          return mediaSource;
 174      }
 175  
 176  
 177      /**
 178       * ËÆæÁΩÆExoPlayer ÁöÑ MediaSource ÂàõÂª∫Êã¶Êà™
 179       */
<abbr title=" 180      public static void setExoMediaSourceInterceptListener(ExoMediaSourceInterceptListener exoMediaSourceInterceptListener) {"> 180      public static void setExoMediaSourceInterceptListener(ExoMediaSourceInterceptListener exoMediaSourceInterceptLüîµ</abbr>
 181          sExoMediaSourceInterceptListener = exoMediaSourceInterceptListener;
 182      }
 183  
 184      public static void resetExoMediaSourceInterceptListener() {
 185          sExoMediaSourceInterceptListener = null;
 186      }
 187  
 188      public static ExoMediaSourceInterceptListener getExoMediaSourceInterceptListener() {
 189          return sExoMediaSourceInterceptListener;
 190      }
 191  
 192  
 193      @SuppressLint(&quot;WrongConstant&quot;)
 194      @C.ContentType
 195      public static int inferContentType(String fileName, @Nullable String overrideExtension) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -        fileName = Util.toLowerInvariant(fileName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +        fileName = Ascii.toLowerCase(fileName);</span>

 198          if (fileName.startsWith(&quot;rtmp:&quot;)) {
 199              return TYPE_RTMP;
 200          } else {
 201              return inferContentType(Uri.parse(fileName), overrideExtension);
 202          }
 203      }
 204  
 205      @C.ContentType
 206      public static int inferContentType(Uri uri, @Nullable String overrideExtension) {
 207          return Util.inferContentType(uri, overrideExtension);
 208      }
 209  
 210      /**
 211       * Êú¨Âú∞ÁºìÂ≠òÁõÆÂΩï
 212       */
 213      public static synchronized Cache getCacheSingleInstance(Context context, File cacheDir) {
 214          String dirs = context.getCacheDir().getAbsolutePath();
 215          if (cacheDir != null) {
 216              dirs = cacheDir.getAbsolutePath();
 217          }
 218          if (mCache == null) {
 219              String path = dirs + File.separator + &quot;exo&quot;;
 220              boolean isLocked = SimpleCache.isCacheFolderLocked(new File(path));
 221              if (!isLocked) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -                mCache = new SimpleCache(new File(path), new LeastRecentlyUsedCacheEvictor(DEFAULT_MAX_SIZE));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 223 +                mCache = new SimpleCache(new File(path), new LeastRecentlyUsedCacheEvictor(DEFAULT_MAX_SIZE), sDatabaseProvider);"> 223 +                mCache = new SimpleCache(new File(path), new LeastRecentlyUsedCacheEvictor(DEFAULT_MAX_SIZE), sDatüîµ</abbr></span>
 224              }
 225          }
 226          return mCache;
 227      }
 228  
 229      public void release() {
 230          isCached = false;
 231          if (mCache != null) {
 232              try {
 233                  mCache.release();
 234                  mCache = null;
 235              } catch (Exception e) {
 236                  e.printStackTrace();
 237              }
 238          }
 239      }
 240  
 241      /**
 242       * CacheÈúÄË¶Årelease‰πãÂêéÊâçËÉΩclear
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -     * @param context</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -     * @param cacheDir</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -     * @param url</span>
 247       */
 248      public static void clearCache(Context context, File cacheDir, String url) {
 249          try {
 250              Cache cache = getCacheSingleInstance(context, cacheDir);
 251              if (!TextUtils.isEmpty(url)) {
 252                  if (cache != null) {
 253                      removeCache(cache, url);
 254                  }
 255              } else {
 256                  if (cache != null) {
 257                      for (String key : cache.getKeys()) {
 258                          removeCache(cache, key);
 259                      }
 260                  }
 261              }
 262          } catch (Exception e) {
 263              e.printStackTrace();
 264          }
 265      }
 266  
 267  
 268      public static void removeCache(Cache cache, String url) {
 269          NavigableSet&lt;CacheSpan&gt; cachedSpans = cache.getCachedSpans(buildCacheKey(url));
 270          for (CacheSpan cachedSpan : cachedSpans) {
 271              try {
 272                  cache.removeSpan(cachedSpan);
 273              } catch (Exception e) {
 274                  // Do nothing.
 275              }
 276          }
 277      }
 278  
 279      public static String buildCacheKey(String url) {
 280          DataSpec dataSpec = new DataSpec(Uri.parse(url));
 281          String key = CacheKeyFactory.DEFAULT.buildCacheKey(dataSpec);
 282          return key;

 283      }
 284  
 285      public static boolean cachePreView(Context context, File cacheDir, String url) {
 286          return resolveCacheState(getCacheSingleInstance(context, cacheDir), url);
 287      }
 288  
 289      public boolean hadCached() {
 290          return isCached;
 291      }
 292  
 293      /**
 294       * ÂøΩÂæãHttpsËØÅ‰π¶Ê†°È™å
 295       *
 296       * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
 297       */
 298      @Deprecated
 299      public static boolean isSkipSSLChain() {
 300          return sSkipSSLChain;
 301      }
 302  
 303      /**
 304       * ËÆæÁΩÆhttpsÂøΩÁï•ËØÅ‰π¶
 305       *
 306       * @param skipSSLChain trueÊó∂ÊòØhulve
 307       * @deprecated Â¶ÇÊûúÈúÄË¶ÅÂøΩÁï•ËØÅ‰π¶ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® ExoMediaSourceInterceptListener ÁöÑ getHttpDataSourceFactory
 308       */
 309      @Deprecated
 310      public static void setSkipSSLChain(boolean skipSSLChain) {
 311          sSkipSSLChain = skipSSLChain;
 312      }
 313  
 314  
 315      public static int getHttpReadTimeout() {
 316          return sHttpReadTimeout;
 317      }
 318  
 319      /**
 320       * Â¶ÇÊûúËÆæÁΩÆÂ∞è‰∫é 0 Â∞±‰ΩøÁî®ÈªòËÆ§ 8000 MILLIS
 321       */
 322      public static void setHttpReadTimeout(int httpReadTimeout) {
 323          ExoSourceManager.sHttpReadTimeout = httpReadTimeout;
 324      }
 325  
 326      public static int getHttpConnectTimeout() {
 327          return sHttpConnectTimeout;
 328      }
 329  
 330      /**
 331       * Â¶ÇÊûúËÆæÁΩÆÂ∞è‰∫é 0 Â∞±‰ΩøÁî®ÈªòËÆ§ 8000 MILLIS
 332       */
 333      public static void setHttpConnectTimeout(int httpConnectTimeout) {
 334          ExoSourceManager.sHttpConnectTimeout = httpConnectTimeout;
 335      }
 336  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +    public static DatabaseProvider getDatabaseProvider() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +        return sDatabaseProvider;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +    public static void setDatabaseProvider(DatabaseProvider databaseProvider) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +        ExoSourceManager.sDatabaseProvider = databaseProvider;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +</span>
 345      /**
 346       * Ëé∑ÂèñSourceFactoryÔºåÊòØÂê¶Â∏¶Cache
 347       */
<abbr title=" 348      private DataSource.Factory getDataSourceFactoryCache(Context context, boolean cacheEnable, boolean preview, File cacheDir, String uerAgent) {"> 348      private DataSource.Factory getDataSourceFactoryCache(Context context, boolean cacheEnable, boolean preview, Fiüîµ</abbr>
 349          if (cacheEnable) {
 350              Cache cache = getCacheSingleInstance(context, cacheDir);
 351              if (cache != null) {
 352                  isCached = resolveCacheState(cache, mDataSource);
 353                  CacheDataSource.Factory factory = new CacheDataSource.Factory();
 354                  return factory.
<abbr title=" 355                          setCache(cache).setCacheReadDataSourceFactory(getDataSourceFactory(context, preview, uerAgent)).setFlags(CacheDataSource.FLAG_IGNORE_CACHE_ON_ERROR);"> 355                          setCache(cache).setCacheReadDataSourceFactory(getDataSourceFactory(context, preview, uerAgüîµ</abbr>
 356              }
 357          }
 358          return getDataSourceFactory(context, preview, uerAgent);
 359      }
 360  
 361      /**
 362       * Ëé∑ÂèñSourceFactory
 363       */
 364      private DataSource.Factory getDataSourceFactory(Context context, boolean preview, String uerAgent) {
<abbr title=" 365          return new DefaultDataSourceFactory(context, preview ? null : new DefaultBandwidthMeter.Builder(context).build(),"> 365          return new DefaultDataSourceFactory(context, preview ? null : new DefaultBandwidthMeter.Builder(context).büîµ</abbr>
 366                  getHttpDataSourceFactory(context, preview, uerAgent));
 367      }
 368  
 369      private DataSource.Factory getHttpDataSourceFactory(Context context, boolean preview, String uerAgent) {
 370          if (uerAgent == null) {
 371              uerAgent = Util.getUserAgent(context, TAG);
 372          }
 373          int connectTimeout = DefaultHttpDataSource.DEFAULT_CONNECT_TIMEOUT_MILLIS;
 374          int readTimeout = DefaultHttpDataSource.DEFAULT_READ_TIMEOUT_MILLIS;
 375          if (sHttpConnectTimeout &gt; 0) {
 376              connectTimeout = sHttpConnectTimeout;
 377          }
 378          if (sHttpReadTimeout &gt; 0) {
 379              readTimeout = sHttpReadTimeout;
 380          }
 381          boolean allowCrossProtocolRedirects = false;
 382          if (mMapHeadData != null &amp;&amp; mMapHeadData.size() &gt; 0) {
 383              allowCrossProtocolRedirects = &quot;true&quot;.equals(mMapHeadData.get(&quot;allowCrossProtocolRedirects&quot;));
 384          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 385 -        HttpDataSource.BaseFactory dataSourceFactory;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +        DataSource.Factory dataSourceFactory;</span>
 387          if (sExoMediaSourceInterceptListener != null) {
<abbr title=" 388              dataSourceFactory = sExoMediaSourceInterceptListener.getHttpDataSourceFactory(uerAgent, preview ? null : new DefaultBandwidthMeter.Builder(mAppContext).build(),"> 388              dataSourceFactory = sExoMediaSourceInterceptListener.getHttpDataSourceFactory(uerAgent, preview ? nullüîµ</abbr>
 389                      connectTimeout,
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 390 -                    readTimeout, allowCrossProtocolRedirects);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +                    readTimeout, mMapHeadData, allowCrossProtocolRedirects);</span>
 392          } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 393 -            dataSourceFactory = new DefaultHttpDataSourceFactory(uerAgent, preview ? null : new DefaultBandwidthMeter.Builder(mAppContext).build(),"> 393 -            dataSourceFactory = new DefaultHttpDataSourceFactory(uerAgent, preview ? null : new DefaultBandwidthMeüîµ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 394 -                    connectTimeout,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 395 -                    readTimeout, allowCrossProtocolRedirects);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -        if (mMapHeadData != null &amp;&amp; mMapHeadData.size() &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -            for (Map.Entry&lt;String, String&gt; header : mMapHeadData.entrySet()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -                dataSourceFactory.getDefaultRequestProperties().set(header.getKey(), header.getValue());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 400 +            dataSourceFactory = new DefaultHttpDataSource.Factory()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 401 +                    .setAllowCrossProtocolRedirects(allowCrossProtocolRedirects)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 402 +                    .setConnectTimeoutMs(connectTimeout)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 403 +                    .setReadTimeoutMs(readTimeout)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 404 +                    .setTransferListener(preview ? null : new DefaultBandwidthMeter.Builder(mAppContext).build());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 405 +            if (mMapHeadData != null &amp;&amp; mMapHeadData.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 406 +                ((DefaultHttpDataSource.Factory) dataSourceFactory).setDefaultRequestProperties(mMapHeadData);</span>
 407              }
 408          }
 409          return dataSourceFactory;
 410      }
 411  
 412      /**
 413       * Ê†πÊçÆÁºìÂ≠òÂùóÂà§Êñ≠ÊòØÂê¶ÁºìÂ≠òÊàêÂäü
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -     * @param cache</span>
 416       */
 417      private static boolean resolveCacheState(Cache cache, String url) {
 418          boolean isCache = true;
 419          if (!TextUtils.isEmpty(url)) {
 420              String key = buildCacheKey(url);
 421              if (!TextUtils.isEmpty(key)) {
 422                  NavigableSet&lt;CacheSpan&gt; cachedSpans = cache.getCachedSpans(key);
 423                  if (cachedSpans.size() == 0) {
 424                      isCache = false;
 425                  } else {
<abbr title=" 426                      long contentLength = cache.getContentMetadata(key).get(ContentMetadata.KEY_CONTENT_LENGTH, C.LENGTH_UNSET);"> 426                      long contentLength = cache.getContentMetadata(key).get(ContentMetadata.KEY_CONTENT_LENGTH, C.Lüîµ</abbr>
 427                      long currentLength = 0;
 428                      for (CacheSpan cachedSpan : cachedSpans) {
 429                          currentLength += cache.getCachedLength(key, cachedSpan.position, cachedSpan.length);
 430                      }
 431                      isCache = currentLength &gt;= contentLength;
 432                  }
 433              } else {
 434                  isCache = false;
 435              }
 436          }
 437          return isCache;
 438      }
 439  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            