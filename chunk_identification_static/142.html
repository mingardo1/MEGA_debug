<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>142</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    142
                    <a href="141.html">prev</a>
                    <a href="143.html">next</a>
                    <a href="142_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_ce13b629173d7eb617f15b31f7cbff34f821464b_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/search/service/solr/MvelToSearchCriteriaConversionServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ce13b629173d7eb617f15b31f7cbff34f821464b:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/search/service/solr/MvelToSearchCriteriaConversionServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ce13b629173d7eb617f15b31f7cbff34f821464b^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/search/service/solr/MvelToSearchCriteriaConversionServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ce13b629173d7eb617f15b31f7cbff34f821464b^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/search/service/solr/MvelToSearchCriteriaConversionServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;56fa0f50efc09097a89d82211429952f70c40d5c:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/search/service/solr/MvelToSearchCriteriaConversionServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [s], [s], [s], [s], [s], [s], [s]], subset: [[sbj], [s], [s]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.search.service.solr;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.lang3.StringUtils;
  22 import org.apache.commons.logging.Log;
  23 import org.apache.commons.logging.LogFactory;
  24 import org.broadleafcommerce.common.locale.domain.Locale;
  25 import org.broadleafcommerce.common.locale.domain.LocaleImpl;
  26 import org.broadleafcommerce.common.locale.service.LocaleService;
  27 import org.broadleafcommerce.core.catalog.service.CatalogService;
  28 import org.broadleafcommerce.core.search.dao.IndexFieldDao;
  29 import org.broadleafcommerce.core.search.domain.IndexFieldType;
  30 import org.broadleafcommerce.core.search.domain.IndexFieldTypeImpl;
  31 import org.broadleafcommerce.core.search.domain.SearchCriteria;
  32 import org.broadleafcommerce.core.search.domain.solr.FieldType;
  33 import org.springframework.stereotype.Service;
  34 
  35 import java.util.ArrayList;
  36 import java.util.Collection;
  37 import java.util.Collections;
  38 import java.util.List;
  39 import java.util.regex.Matcher;
  40 import java.util.regex.Pattern;
  41 
  42 import javax.annotation.Resource;
  43 
  44 /**
  45  * Convenience methods for converting simple MVEL rules to Solr SearchCriteria
  46  * 
  47  * @author Chris Kittrell (ckittrell)
  48  */
  49 @Service(&quot;blMvelToSearchCriteriaConversionService&quot;)
  50 public class MvelToSearchCriteriaConversionServiceImpl implements MvelToSearchCriteriaConversionService {
  51 
  52     private static final Log LOG = LogFactory.getLog(MvelToSearchCriteriaConversionServiceImpl.class);
  53 
<abbr title="  54     public static final String CATEGORY_FORMAT_REGEX = &quot;^CollectionUtils\\.intersection\\(product\\.\\?allParentCategoryIds,\\[\\\&quot;([0-9]+)(,\\\&quot;[0-9]+\\\&quot;)*\\\&quot;\\]\\)\\.size\\(\\)&gt;0$&quot;;">  54     public static final String CATEGORY_FORMAT_REGEX = &quot;^CollectionUtils\\.intersection\\(product\\.\\?alðŸ”µ</abbr>
  55 
  56     @Resource(name = &quot;blCatalogService&quot;)
  57     protected CatalogService catalogService;
  58 
  59     @Resource(name = &quot;blIndexFieldDao&quot;)
  60     protected IndexFieldDao indexFieldDao;
  61 
  62     @Resource(name = &quot;blLocaleService&quot;)
  63     protected LocaleService localeService;
  64 
  65     @Resource(name=&quot;blSolrHelperService&quot;)
  66     protected SolrHelperService solrHelperService;
  67 
  68     @Override
  69     public SearchCriteria convert(String mvelRule) {
  70         SearchCriteria criteria = new SearchCriteria();
  71         criteria.setPageSize(Integer.MAX_VALUE);
  72 
  73         if (isProductRule(mvelRule) || isCategoryTargetingRule(mvelRule)) {
  74             Collection&lt;String&gt; strings = convertRuleToFilters(mvelRule);
  75             criteria.setFilterQueries(strings);
  76         }else {
<abbr title="  77             throw new UnsupportedOperationException(&quot;The selected Add-On Product Group is defined using Rules &quot; +">  77             throw new UnsupportedOperationException(&quot;The selected Add-On Product Group is defined using RðŸ”µ</abbr>
<abbr title="  78                     &quot;(Conditional Rules) and selected rule can&#x27;t be translated to solr criteria and so &quot; +">  78                     &quot;(Conditional Rules) and selected rule can&#x27;t be translated to solr criteria and so &quot; ðŸ”µ</abbr>
<abbr title="  79                     &quot;does not support selection of a Default Product. See Tooltip for supported rule details&quot;);">  79                     &quot;does not support selection of a Default Product. See Tooltip for supported rule detaðŸ”µ</abbr>
  80         }
  81 
  82         return criteria;
  83     }
  84 
  85     protected boolean isProductRule(String rule){
  86         return rule.contains(&quot;product.&quot;);
  87     }
  88 
  89     protected boolean isCustomFieldIndexed(List&lt;IndexFieldType&gt; indexFieldTypes) {
  90         return CollectionUtils.isNotEmpty(indexFieldTypes);
  91     }
  92 
<abbr title="  93     // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()&gt;0">  93     // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;ðŸ”µ</abbr>
  94     protected boolean isCategoryTargetingRule(String mvelRule) {
  95         return mvelRule.matches(CATEGORY_FORMAT_REGEX);
  96     }
  97 
<abbr title="  98     // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;,...]).size()&gt;0">  98     // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;ðŸ”µ</abbr>
  99     protected Long[] getCategoryIds(String mvelRule) {
 100         int startIndex = mvelRule.indexOf(&quot;[\&quot;&quot;) + 2;
 101         int endIndex = mvelRule.indexOf(&quot;\&quot;]&quot;);
 102         String categoryId = mvelRule.substring(startIndex, endIndex);
 103         //how about multivalue ?
 104         String[] split = categoryId.split(&quot;,&quot;);
 105         Long[] result = null;
 106         int length = split.length;
 107         if (length &gt; 0) {
 108             result = new Long[length];
 109             for (int i = 0; i &lt; length; i++) {
 110                 result[i] = Long.parseLong(split[i].replace(&quot;\&quot;&quot;,&quot;&quot;));
 111             }
 112         }
 113         return result;
 114     }
 115 
 116     // Expected Custom Field Rule Formats
 117     // Equals - product.?getProductAttributes()[&quot;custom_field_name&quot;]==&quot;custom field value&quot;
<abbr title=" 118     // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelper.toUpperCase(&quot;custom field value&quot;))"> 118     // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MðŸ”µ</abbr>
 119     // Also supports string property contains, not contains, starts with, ends with etc.
 120     protected Collection&lt;String&gt; convertRuleToFilters(String matchRule) {
 121         List&lt;String&gt; filters = new ArrayList&lt;&gt;();
 122 
 123         boolean allRulesMustBeTrue = !matchRule.contains(&quot;||&quot;);
 124         String[] fragments;
 125         if (allRulesMustBeTrue) {
 126             fragments = StringUtils.split(matchRule, &quot;&amp;&amp;&quot;);
 127         } else {
 128             fragments = StringUtils.split(matchRule, &quot;||&quot;);
 129         }
 130 
 131         for (String fragment : fragments) {
 132             if (isCategoryTargetingRule(fragment)) {
 133                 Long[] categoryIds = getCategoryIds(fragment);
 134                 if (categoryIds != null) {
 135                     String explicitCategoryFieldName = solrHelperService.getExplicitCategoryFieldName();
 136                     StringBuilder categoryFilter = new StringBuilder(explicitCategoryFieldName + &quot;:(\&quot;&quot;);
 137                     for (int i = 0; i &lt; categoryIds.length; i++) {
 138                         Long catId = solrHelperService.getCategoryId(categoryIds[i]);
 139                         categoryFilter.append(catId);
 140                         if (i + 1 &lt; categoryIds.length) {
 141                             categoryFilter.append(&quot;,&quot;);
 142                         }
 143                     }
 144                     categoryFilter.append(&quot;\&quot;)&quot;);
 145                     filters.add(categoryFilter.toString());
 146 
 147                 }
 148             } else {
 149                 String fieldName = getCustomFieldPropertyName(fragment);
 150                 String fieldValue = getCustomFieldValue(fragment);
 151                 boolean exclude = fragment.contains(&quot;!=&quot;) || fragment.startsWith(&quot;!&quot;);
 152                 boolean isWildCardSearch = isWildCardSearch(fieldValue);
 153                 fieldName = convertFieldName(fieldName);
<abbr title=" 154                 List&lt;IndexFieldType&gt; indexFieldTypes = indexFieldDao.getIndexFieldTypesByAbbreviationOrPropertyName(fieldName);"> 154                 List&lt;IndexFieldType&gt; indexFieldTypes = indexFieldDao.getIndexFieldTypesByAbbreviationOrPrðŸ”µ</abbr>
 155 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156                 boolean isCatalog = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157                 if(&quot;embeddableCatalogTenantDiscriminator.catalogDiscriminator&quot;.equals(fieldName)){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158                     fieldName = solrHelperService.getCatalogFieldName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159                     isCatalog = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160                     indexFieldTypes = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161                     indexFieldTypes.add(new IndexFieldTypeImpl());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163                 if (indexFieldTypes.size() &gt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 164                     Boolean translatable = !isCatalog &amp;&amp; indexFieldTypes.get(0).getIndexField().getField().getTranslatable();"> 164                     Boolean translatable = !isCatalog &amp;&amp; indexFieldTypes.get(0).getIndexField().getField(ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165                     List&lt;Locale&gt; allLocales;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166                     if (translatable==null || !translatable) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167                         allLocales = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168                         LocaleImpl e = new LocaleImpl();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169                         e.setLocaleCode(&quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170                         allLocales.add(e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171                     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172                         allLocales = localeService.findAllLocales();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174                     List&lt;String&gt; tmpFilters = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 175                     String abbreviation = isCatalog ? &quot;&quot;: indexFieldTypes.get(0).getIndexField().getField().getAbbreviation();"> 175                     String abbreviation = isCatalog ? &quot;&quot;: indexFieldTypes.get(0).getIndexField().getFieldðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176                     for (Locale locale : allLocales) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177                         for (IndexFieldType indexFieldType : indexFieldTypes) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178                             String type = isCatalog ? &quot;&quot; :indexFieldType.getFieldType().getType();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 179                             if (!isWildCardSearch || FieldType.STRING.getType().equals(type) || isCatalog) {"> 179                             if (!isWildCardSearch || FieldType.STRING.getType().equals(type) || isCatalogðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180                                 String prefix;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181                                 if (StringUtils.isNotEmpty(locale.getLocaleCode())) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182                                     prefix = locale.getLocaleCode() + &quot;_&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183                                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184                                     prefix = &quot;&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185                                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 187                                 String indexFieldName = isCatalog ? fieldName : (prefix + abbreviation + &quot;_&quot; + type);"> 187                                 String indexFieldName = isCatalog ? fieldName : (prefix + abbreviation + ðŸ”µ</abbr></span>
 188 ||||||| GitAnalyzerPlus_base
 189 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190                 if (indexFieldTypes.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 191                     Boolean translatable = indexFieldTypes.get(0).getIndexField().getField().getTranslatable();"> 191                     Boolean translatable = indexFieldTypes.get(0).getIndexField().getField().getTranslataðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192                     List&lt;Locale&gt; allLocales;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193                     if (translatable==null || !translatable) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194                         allLocales = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195                         LocaleImpl e = new LocaleImpl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196                         e.setLocaleCode(&quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197                         allLocales.add(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198                     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199                         allLocales = localeService.findAllLocales();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201                     List&lt;String&gt; tmpFilters = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 202                     String abbreviation = indexFieldTypes.get(0).getIndexField().getField().getAbbreviation();"> 202                     String abbreviation = indexFieldTypes.get(0).getIndexField().getField().getAbbreviatiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203                     for (Locale locale : allLocales) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204                         for (IndexFieldType indexFieldType : indexFieldTypes) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205                             String type = indexFieldType.getFieldType().getType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206                             if (!isWildCardSearch || FieldType.STRING.getType().equals(type)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207                                 String prefix;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208                                 if (StringUtils.isNotEmpty(locale.getLocaleCode())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209                                     prefix = locale.getLocaleCode() + &quot;_&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210                                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211                                     prefix = &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212                                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213                                 String indexFieldName = prefix + abbreviation + &quot;_&quot; + type;</span>
 214 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 215 
<abbr title=" 216                                 // if this is a wildcard search then we do not want to surround the value with quotes"> 216                                 // if this is a wildcard search then we do not want to surround the valueðŸ”µ</abbr>
 217                                 String indexFieldValue = fieldValue;
 218                                 if (!isWildCardSearch &amp;&amp; !fieldValue.equals(&quot;null&quot;)) {
 219                                     if(fieldValue.contains(&quot;\&quot;,\&quot;&quot;)){
 220                                         indexFieldValue = &quot;(\&quot;&quot; + fieldValue + &quot;\&quot;)&quot;;
 221                                     }else {
 222                                         indexFieldValue = &quot;\&quot;&quot; + fieldValue + &quot;\&quot;&quot;;
 223                                     }
 224                                 }
 225 
 226                                 String filter;
 227                                 if (indexFieldValue.equals(&quot;null&quot;)) {
 228                                     // this is for checking if null or non-existent fields
 229                                     filter = &quot;(*:* AND -&quot; + indexFieldName + &quot;:[* TO *])&quot;;
 230                                 } else {
 231                                     filter = indexFieldName + &quot;:&quot; + indexFieldValue;
 232                                 }
 233 
 234                                 if (exclude) {
 235                                     filter = &quot;NOT &quot; + filter;
 236                                 }
 237 
 238                                 tmpFilters.add(filter);
 239                             }
 240                         }
 241                     }
 242 
 243                     if (!exclude) {
<abbr title=" 244                         //any of translation and type fields like en_name_tsy, en_name_s etc can match, so concatinate with OR"> 244                         //any of translation and type fields like en_name_tsy, en_name_s etc can match, sðŸ”µ</abbr>
 245 
 246                         String s = tmpFilters.get(0);
 247                         s = &quot;(&quot; + s;
 248                         tmpFilters.set(0, s);
 249                         int size = tmpFilters.size() - 1;
 250                         String s1 = tmpFilters.get(size);
 251                         s1 = s1 + &quot;)&quot;;
 252                         tmpFilters.set(size, s1);
 253                         filters.add(StringUtils.join(tmpFilters, &quot; OR &quot;));
 254                     } else {
 255                         //if we exclude we don&#x27;t want to see if at all so &quot;AND&quot; is ok
 256                         filters.addAll(tmpFilters);
 257                     }
 258                     if (org.apache.commons.collections4.CollectionUtils.isEmpty(indexFieldTypes)) {
 259                         if (fieldName.contains(&quot;catalogDiscriminator&quot;)) {
 260                             String substring = fieldValue.substring(1, fieldValue.length() - 1);
 261                             filters.add(&quot;catalog_s:(&quot; + substring + &quot;)&quot;);
 262                         }
 263                     }
 264                 } else {
 265                     return Collections.emptyList();
 266                 }
 267             }
 268         }
 269         if (allRulesMustBeTrue) {
 270             return filters;
 271         } else {
 272             return Collections.singletonList(StringUtils.join(filters, &quot; OR &quot;));
 273         }
 274     }
 275 
 276     protected String convertFieldName(String fieldName) {
 277         String result = fieldName;
 278         if (fieldName.startsWith(&quot;product.&quot;)) {
 279             result = fieldName.substring(&quot;product.&quot;.length());
 280         }
 281         if (result.endsWith(&quot;()&quot;)) {
 282             result = parseMethod(result);
 283         }
 284         result = result.replaceAll(&quot;\\?&quot;, &quot;&quot;);
 285         return result;
 286     }
 287 
 288     /**
<abbr title=" 289      * Takes in a fieldName that contains a method (indicated with &quot;()&quot;) and converts the method to an attribute."> 289      * Takes in a fieldName that contains a method (indicated with &quot;()&quot;) and converts the method to an atðŸ”µ</abbr>
 290      * Currently supports getX() methods
 291      * For example, getType() -&gt; type
 292      * @param fieldName
 293      * @return 
 294      */
 295     protected String parseMethod(String fieldName) {
 296         String[] segments = fieldName.split(&quot;\\.&quot;);
 297         //parse the last segment removing the method prefix (e.g. get)
 298         String methodSegment = segments[segments.length-1].replaceFirst(&quot;(^get)&quot;, &quot;&quot;);
 299         //lowercase first char and remove the ()
<abbr title=" 300         segments[segments.length - 1] = Character.toLowerCase(methodSegment.charAt(0)) + methodSegment.substring(1, methodSegment.length() - 2);"> 300         segments[segments.length - 1] = Character.toLowerCase(methodSegment.charAt(0)) + methodSegment.suðŸ”µ</abbr>
 301         return String.join(&quot;.&quot;, segments);
 302     }
 303     
 304     /**
<abbr title=" 305      * Determines if the given field value string represents a wild card search. In Solr a wild card search either"> 305      * Determines if the given field value string represents a wild card search. In Solr a wild card searðŸ”µ</abbr>
 306      * starts or ends with an asterisk.
 307      *
 308      * @param fieldValue the String field value
 309      * @return whether the value is for a wildcard search
 310      */
 311     protected boolean isWildCardSearch(String fieldValue) {
 312         return fieldValue.startsWith(&quot;*&quot;) || fieldValue.endsWith(&quot;*&quot;);
 313     }
 314 
 315     protected String getCustomFieldPropertyName(String mvelRule) {
 316         if (mvelRule.contains(&quot;CollectionUtils&quot;)) {
 317             //assuming left param is field, right is value
 318             int startIndex = mvelRule.indexOf(&quot;(&quot;);
 319             int endIndex = mvelRule.indexOf(&quot;,&quot;);
 320             mvelRule = mvelRule.substring(startIndex + 1, endIndex);
 321         }
 322         if (mvelRule.indexOf(&quot;[\&quot;&quot;) &gt; 0) {
 323             int startIndex = mvelRule.indexOf(&quot;[\&quot;&quot;) + 2;
 324             int endIndex = mvelRule.lastIndexOf(&quot;\&quot;]&quot;);
 325 
 326             return mvelRule.substring(startIndex, endIndex);
 327         } else {
<abbr title=" 328             if (mvelRule.contains(&quot;org.apache.commons.lang3.StringUtils.contains&quot;) || mvelRule.contains(&quot;.startsWith&quot;) || mvelRule.contains(&quot;.endsWith&quot;)) {"> 328             if (mvelRule.contains(&quot;org.apache.commons.lang3.StringUtils.contains&quot;) || mvelRule.contains(&quot;ðŸ”µ</abbr>
 329                 int startIndex = mvelRule.indexOf(&quot;(&quot;);
 330                 int endIndex = mvelRule.indexOf(&quot;,&quot;);
 331                 mvelRule = mvelRule.substring(startIndex + 1, endIndex);
 332             }
 333             mvelRule = getRuleOrPropertyFromFunction(mvelRule);
 334             return mvelRule;
 335         }
 336     }
 337 
 338     protected String getRuleOrPropertyFromFunction(String mvelRule) {
 339         int i = mvelRule.indexOf(&#x27;(&#x27;);
 340         int j = mvelRule.indexOf(&#x27;)&#x27;, i);
 341 
 342         //no function or maybe just some function? like xxx.xxx.getType()
 343         if (i == j || j == i + 1) {
 344             //expect to have either == or !=
 345             int exclamationMark = mvelRule.indexOf(&quot;!&quot;);
 346             if (exclamationMark &gt; 0) {
 347                 return mvelRule.substring(0, exclamationMark);
 348             } else {
 349                 int equalsSign = mvelRule.indexOf(&quot;=&quot;);
 350                 if (equalsSign &gt; 0) {
 351                     return mvelRule.substring(0, equalsSign);
 352                 }
 353                 //unknown format
 354             }
 355         } else {
 356             //looks like some function ?
 357             Pattern pattern = Pattern.compile(&quot;\\([^!=]+\\)&quot;);
 358             Matcher matcher = pattern.matcher(mvelRule);
 359             if (matcher.find()) {
 360                 String group = matcher.group();
 361                 return group.substring(1, group.length() - 1);
 362             }
 363 
 364         }
 365         return mvelRule;
 366     }
 367 
 368     protected String getCustomFieldValue(String mvelRule) {
 369         String customFieldValue = &quot;&quot;;
 370         if (mvelRule.contains(&quot;.contains&quot;)) {
 371             int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 372             int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);
 373 
 374             customFieldValue = mvelRule.substring(startIndex, endIndex);
 375         } else if (mvelRule.contains(&quot;==\&quot;&quot;) || mvelRule.contains(&quot;!=\&quot;&quot;)) {
 376             int startIndex;
 377             int endIndex;
 378             if (mvelRule.contains(&quot;toUpperCase&quot;)) {
 379                 startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 380                 endIndex = mvelRule.lastIndexOf(&quot;\&quot;)&quot;);
 381             } else {
 382                 startIndex = mvelRule.indexOf(&quot;==\&quot;&quot;) + 3;
 383                 endIndex = mvelRule.lastIndexOf(&quot;\&quot;&quot;);
 384             }
 385 
 386             customFieldValue = mvelRule.substring(startIndex, endIndex);
 387         } else if (mvelRule.contains(&quot;==&quot;) || mvelRule.contains(&quot;!=&quot;)) {
 388             int startIndex;
 389             int endIndex = mvelRule.length();
 390             if (mvelRule.contains(&quot;toUpperCase&quot;)) {
 391                 startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 392                 endIndex = mvelRule.indexOf(&quot;\&quot;)&quot;, startIndex);
 393             } else {
 394                 int i = mvelRule.indexOf(&quot;==&quot;);
 395                 if (i &gt; 0) {
 396                     startIndex = i + 2;
 397                 } else {
 398                     startIndex = mvelRule.indexOf(&quot;!=&quot;) + 2;
 399                 }
 400             }
 401 
 402             customFieldValue = mvelRule.substring(startIndex, endIndex);
 403         } else if (mvelRule.contains(&quot;.startsWith&quot;)) {
 404             int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 405             int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);
 406 
 407             customFieldValue = mvelRule.substring(startIndex, endIndex).replaceAll(&quot; &quot;, &quot;\\ &quot;) + &quot;*&quot;;
 408         } else if (mvelRule.contains(&quot;.endsWith&quot;)) {
 409             int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 410             int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);
 411 
 412             customFieldValue = &quot;*&quot; + mvelRule.substring(startIndex, endIndex).replaceAll(&quot; &quot;, &quot;\\ &quot;);
 413         } else if (mvelRule.contains(&quot;==null&quot;)) {
 414             // this means we have an &quot;is blank&quot; rule
 415             customFieldValue = &quot;null&quot;;
 416         } else if (mvelRule.contains(&quot;CollectionUtils&quot;)) {
 417             int startIndex = mvelRule.indexOf(&quot;,&quot;);
 418             int endIndex = mvelRule.indexOf(&quot;)&quot;, startIndex);
 419             customFieldValue = mvelRule.substring(startIndex + 1, endIndex);
 420         }
 421         //maybe it is something like [x,x1,x2]? -&gt; (x,x1,x2), or [x1]-&gt;x1
 422         if (customFieldValue.startsWith(&quot;[&quot;) &amp;&amp; customFieldValue.endsWith(&quot;]&quot;)) {
 423                 customFieldValue = customFieldValue.substring(1, customFieldValue.length() - 1);
 424                 if(customFieldValue.startsWith(&quot;\&quot;&quot;) &amp;&amp; customFieldValue.endsWith(&quot;\&quot;&quot;)){
 425                     customFieldValue = customFieldValue.substring(1, customFieldValue.length() - 1);
 426                 }
 427         }
 428         return customFieldValue;
 429     }
 430 
 431 
 432 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.search.service.solr;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.lang3.StringUtils;
  22 import org.apache.commons.logging.Log;
  23 import org.apache.commons.logging.LogFactory;
  24 import org.broadleafcommerce.common.locale.domain.Locale;
  25 import org.broadleafcommerce.common.locale.domain.LocaleImpl;
  26 import org.broadleafcommerce.common.locale.service.LocaleService;
  27 import org.broadleafcommerce.core.catalog.service.CatalogService;
  28 import org.broadleafcommerce.core.search.dao.IndexFieldDao;
  29 import org.broadleafcommerce.core.search.domain.IndexFieldType;
  30 import org.broadleafcommerce.core.search.domain.IndexFieldTypeImpl;
  31 import org.broadleafcommerce.core.search.domain.SearchCriteria;
  32 import org.broadleafcommerce.core.search.domain.solr.FieldType;
  33 import org.springframework.stereotype.Service;
  34 
  35 import java.util.ArrayList;
  36 import java.util.Collection;
  37 import java.util.Collections;
  38 import java.util.List;
  39 import java.util.regex.Matcher;
  40 import java.util.regex.Pattern;
  41 
  42 import javax.annotation.Resource;
  43 
  44 /**
  45  * Convenience methods for converting simple MVEL rules to Solr SearchCriteria
  46  *
  47  * @author Chris Kittrell (ckittrell)
  48  */
  49 @Service(&quot;blMvelToSearchCriteriaConversionService&quot;)
  50 public class MvelToSearchCriteriaConversionServiceImpl implements MvelToSearchCriteriaConversionService {
  51 
  52     private static final Log LOG = LogFactory.getLog(MvelToSearchCriteriaConversionServiceImpl.class);
  53 
<abbr title="  54     public static final String CATEGORY_FORMAT_REGEX = &quot;^CollectionUtils\\.intersection\\(product\\.\\?allParentCategoryIds,\\[\\\&quot;([0-9]+)(,\\\&quot;[0-9]+\\\&quot;)*\\\&quot;\\]\\)\\.size\\(\\)&gt;0$&quot;;">  54     public static final String CATEGORY_FORMAT_REGEX = &quot;^CollectionUtils\\.intersection\\(product\\.\\?alðŸ”µ</abbr>
  55 
  56     @Resource(name = &quot;blCatalogService&quot;)
  57     protected CatalogService catalogService;
  58 
  59     @Resource(name = &quot;blIndexFieldDao&quot;)
  60     protected IndexFieldDao indexFieldDao;
  61 
  62     @Resource(name = &quot;blLocaleService&quot;)
  63     protected LocaleService localeService;
  64 
  65     @Resource(name=&quot;blSolrHelperService&quot;)
  66     protected SolrHelperService solrHelperService;
  67 
  68     @Override
  69     public SearchCriteria convert(String mvelRule) {
  70         SearchCriteria criteria = new SearchCriteria();
  71         criteria.setPageSize(Integer.MAX_VALUE);
  72 
  73         if (isProductRule(mvelRule) || isCategoryTargetingRule(mvelRule)) {
  74             Collection&lt;String&gt; strings = convertRuleToFilters(mvelRule);
  75             criteria.setFilterQueries(strings);
  76         } else {
<abbr title="  77             throw new UnsupportedOperationException(&quot;The selected Add-On Product Group is defined using Rules &quot; +">  77             throw new UnsupportedOperationException(&quot;The selected Add-On Product Group is defined using RðŸ”µ</abbr>
<abbr title="  78                     &quot;(Conditional Rules) and selected rule can&#x27;t be translated to solr criteria and so &quot; +">  78                     &quot;(Conditional Rules) and selected rule can&#x27;t be translated to solr criteria and so &quot; ðŸ”µ</abbr>
<abbr title="  79                     &quot;does not support selection of a Default Product. See Tooltip for supported rule details&quot;);">  79                     &quot;does not support selection of a Default Product. See Tooltip for supported rule detaðŸ”µ</abbr>
  80         }
  81 
  82         return criteria;
  83     }
  84 
  85     protected boolean isProductRule(String rule){
  86         return rule.contains(&quot;product.&quot;);
  87     }
  88 
  89     protected boolean isCustomFieldIndexed(List&lt;IndexFieldType&gt; indexFieldTypes) {
  90         return CollectionUtils.isNotEmpty(indexFieldTypes);
  91     }
  92 
<abbr title="  93     // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()&gt;0">  93     // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;ðŸ”µ</abbr>
  94     protected boolean isCategoryTargetingRule(String mvelRule) {
  95         return mvelRule.matches(CATEGORY_FORMAT_REGEX);
  96     }
  97 
<abbr title="  98     // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;,...]).size()&gt;0">  98     // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;ðŸ”µ</abbr>
  99     protected Long[] getCategoryIds(String mvelRule) {
 100         int startIndex = mvelRule.indexOf(&quot;[\&quot;&quot;) + 2;
 101         int endIndex = mvelRule.indexOf(&quot;\&quot;]&quot;);
 102         String categoryId = mvelRule.substring(startIndex, endIndex);
 103         //how about multivalue ?
 104         String[] split = categoryId.split(&quot;,&quot;);
 105         Long[] result = null;
 106         int length = split.length;
 107         if (length &gt; 0) {
 108             result = new Long[length];
 109             for (int i = 0; i &lt; length; i++) {
 110                 result[i] = Long.parseLong(split[i].replace(&quot;\&quot;&quot;,&quot;&quot;));
 111             }
 112         }
 113         return result;
 114     }
 115 
 116     // Expected Custom Field Rule Formats
 117     // Equals - product.?getProductAttributes()[&quot;custom_field_name&quot;]==&quot;custom field value&quot;
<abbr title=" 118     // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelper.toUpperCase(&quot;custom field value&quot;))"> 118     // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MðŸ”µ</abbr>
 119     // Also supports string property contains, not contains, starts with, ends with etc.
 120     protected Collection&lt;String&gt; convertRuleToFilters(String matchRule) {
 121         List&lt;String&gt; filters = new ArrayList&lt;&gt;();
 122 
 123         boolean allRulesMustBeTrue = !matchRule.contains(&quot;||&quot;);
 124         String[] fragments;
 125         if (allRulesMustBeTrue) {
 126             fragments = StringUtils.split(matchRule, &quot;&amp;&amp;&quot;);
 127         } else {
 128             fragments = StringUtils.split(matchRule, &quot;||&quot;);
 129         }
 130 
 131         for (String fragment : fragments) {
 132             if (isCategoryTargetingRule(fragment)) {
 133                 Long[] categoryIds = getCategoryIds(fragment);
 134                 if (categoryIds != null) {
 135                     String explicitCategoryFieldName = solrHelperService.getExplicitCategoryFieldName();
 136                     StringBuilder categoryFilter = new StringBuilder(explicitCategoryFieldName + &quot;:(\&quot;&quot;);
 137                     for (int i = 0; i &lt; categoryIds.length; i++) {
 138                         Long catId = solrHelperService.getCategoryId(categoryIds[i]);
 139                         categoryFilter.append(catId);
 140                         if (i + 1 &lt; categoryIds.length) {
 141                             categoryFilter.append(&quot;,&quot;);
 142                         }
 143                     }
 144                     categoryFilter.append(&quot;\&quot;)&quot;);
 145                     filters.add(categoryFilter.toString());
 146 
 147                 }
 148             } else {
 149                 String fieldName = getCustomFieldPropertyName(fragment);
 150                 String fieldValue = getCustomFieldValue(fragment);
 151                 boolean exclude = fragment.contains(&quot;!=&quot;) || fragment.startsWith(&quot;!&quot;);
 152                 boolean isWildCardSearch = isWildCardSearch(fieldValue);
 153                 fieldName = convertFieldName(fieldName);
<abbr title=" 154                 List&lt;IndexFieldType&gt; indexFieldTypes = indexFieldDao.getIndexFieldTypesByAbbreviationOrPropertyName(fieldName);"> 154                 List&lt;IndexFieldType&gt; indexFieldTypes = indexFieldDao.getIndexFieldTypesByAbbreviationOrPrðŸ”µ</abbr>
 155 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156                 boolean isCatalog = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157                 if(&quot;embeddableCatalogTenantDiscriminator.catalogDiscriminator&quot;.equals(fieldName)){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158                     fieldName = solrHelperService.getCatalogFieldName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159                     isCatalog = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160                     indexFieldTypes = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161                     indexFieldTypes.add(new IndexFieldTypeImpl());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163                 if (indexFieldTypes.size() &gt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 164                     Boolean translatable = !isCatalog &amp;&amp; indexFieldTypes.get(0).getIndexField().getField().getTranslatable();"> 164                     Boolean translatable = !isCatalog &amp;&amp; indexFieldTypes.get(0).getIndexField().getField(ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165                     List&lt;Locale&gt; allLocales;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166                     if (translatable==null || !translatable) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167                         allLocales = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168                         LocaleImpl e = new LocaleImpl();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169                         e.setLocaleCode(&quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170                         allLocales.add(e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171                     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172                         allLocales = localeService.findAllLocales();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174                     List&lt;String&gt; tmpFilters = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 175                     String abbreviation = isCatalog ? &quot;&quot;: indexFieldTypes.get(0).getIndexField().getField().getAbbreviation();"> 175                     String abbreviation = isCatalog ? &quot;&quot;: indexFieldTypes.get(0).getIndexField().getFieldðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176                     for (Locale locale : allLocales) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177                         for (IndexFieldType indexFieldType : indexFieldTypes) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178                             String type = isCatalog ? &quot;&quot; :indexFieldType.getFieldType().getType();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 179                             if (!isWildCardSearch || FieldType.STRING.getType().equals(type) || isCatalog) {"> 179                             if (!isWildCardSearch || FieldType.STRING.getType().equals(type) || isCatalogðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180                                 String prefix;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181                                 if (StringUtils.isNotEmpty(locale.getLocaleCode())) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182                                     prefix = locale.getLocaleCode() + &quot;_&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183                                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184                                     prefix = &quot;&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185                                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 187                                 String indexFieldName = isCatalog ? fieldName : (prefix + abbreviation + &quot;_&quot; + type);"> 187                                 String indexFieldName = isCatalog ? fieldName : (prefix + abbreviation + ðŸ”µ</abbr></span>
 188 ||||||| BASE
 189 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190                 if (indexFieldTypes.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 191                     Boolean translatable = indexFieldTypes.get(0).getIndexField().getField().getTranslatable();"> 191                     Boolean translatable = indexFieldTypes.get(0).getIndexField().getField().getTranslataðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192                     List&lt;Locale&gt; allLocales;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193                     if (translatable==null || !translatable) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194                         allLocales = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195                         LocaleImpl e = new LocaleImpl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196                         e.setLocaleCode(&quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197                         allLocales.add(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198                     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199                         allLocales = localeService.findAllLocales();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201                     List&lt;String&gt; tmpFilters = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 202                     String abbreviation = indexFieldTypes.get(0).getIndexField().getField().getAbbreviation();"> 202                     String abbreviation = indexFieldTypes.get(0).getIndexField().getField().getAbbreviatiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203                     for (Locale locale : allLocales) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204                         for (IndexFieldType indexFieldType : indexFieldTypes) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205                             String type = indexFieldType.getFieldType().getType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206                             if (!isWildCardSearch || FieldType.STRING.getType().equals(type)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207                                 String prefix;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208                                 if (StringUtils.isNotEmpty(locale.getLocaleCode())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209                                     prefix = locale.getLocaleCode() + &quot;_&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210                                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211                                     prefix = &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212                                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213                                 String indexFieldName = prefix + abbreviation + &quot;_&quot; + type;</span>
 214 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 215 
<abbr title=" 216                                 // if this is a wildcard search then we do not want to surround the value with quotes"> 216                                 // if this is a wildcard search then we do not want to surround the valueðŸ”µ</abbr>
 217                                 String indexFieldValue = fieldValue;
 218                                 if (!isWildCardSearch &amp;&amp; !fieldValue.equals(&quot;null&quot;)) {
 219                                     if(fieldValue.contains(&quot;\&quot;,\&quot;&quot;)){
 220                                         indexFieldValue = &quot;(\&quot;&quot; + fieldValue + &quot;\&quot;)&quot;;
 221                                     }else {
 222                                         indexFieldValue = &quot;\&quot;&quot; + fieldValue + &quot;\&quot;&quot;;
 223                                     }
 224                                 }
 225 
 226                                 String filter;
 227                                 if (indexFieldValue.equals(&quot;null&quot;)) {
 228                                     // this is for checking if null or non-existent fields
 229                                     filter = &quot;(*:* AND -&quot; + indexFieldName + &quot;:[* TO *])&quot;;
 230                                 } else {
 231                                     filter = indexFieldName + &quot;:&quot; + indexFieldValue;
 232                                 }
 233 
 234                                 if (exclude) {
 235                                     filter = &quot;NOT &quot; + filter;
 236                                 }
 237 
 238                                 tmpFilters.add(filter);
 239                             }
 240                         }
 241                     }
 242 
 243                     if (!exclude) {
<abbr title=" 244                         //any of translation and type fields like en_name_tsy, en_name_s etc can match, so concatinate with OR"> 244                         //any of translation and type fields like en_name_tsy, en_name_s etc can match, sðŸ”µ</abbr>
 245 
 246                         String s = tmpFilters.get(0);
 247                         s = &quot;(&quot; + s;
 248                         tmpFilters.set(0, s);
 249                         int size = tmpFilters.size() - 1;
 250                         String s1 = tmpFilters.get(size);
 251                         s1 = s1 + &quot;)&quot;;
 252                         tmpFilters.set(size, s1);
 253                         filters.add(StringUtils.join(tmpFilters, &quot; OR &quot;));
 254                     } else {
 255                         //if we exclude we don&#x27;t want to see if at all so &quot;AND&quot; is ok
 256                         filters.addAll(tmpFilters);
 257                     }
 258                     if (org.apache.commons.collections4.CollectionUtils.isEmpty(indexFieldTypes)) {
 259                         if (fieldName.contains(&quot;catalogDiscriminator&quot;)) {
 260                             String substring = fieldValue.substring(1, fieldValue.length() - 1);
 261                             filters.add(&quot;catalog_s:(&quot; + substring + &quot;)&quot;);
 262                         }
 263                     }
 264                 } else {
 265                     return Collections.emptyList();
 266                 }
 267             }
 268         }
 269         if (allRulesMustBeTrue) {
 270             return filters;
 271         } else {
 272             return Collections.singletonList(StringUtils.join(filters, &quot; OR &quot;));
 273         }
 274     }
 275 
 276     protected String convertFieldName(String fieldName) {
 277         String result = fieldName;
 278         if (fieldName.startsWith(&quot;product.&quot;)) {
 279             result = fieldName.substring(&quot;product.&quot;.length());
 280         }
 281         if (result.endsWith(&quot;()&quot;)) {
 282             result = parseMethod(result);
 283         }
 284         result = result.replaceAll(&quot;\\?&quot;, &quot;&quot;);
 285         return result;
 286     }
 287 
 288     /**
<abbr title=" 289      * Takes in a fieldName that contains a method (indicated with &quot;()&quot;) and converts the method to an attribute."> 289      * Takes in a fieldName that contains a method (indicated with &quot;()&quot;) and converts the method to an atðŸ”µ</abbr>
 290      * Currently supports getX() methods
 291      * For example, getType() -&gt; type
 292      * @param fieldName
 293      * @return
 294      */
 295     protected String parseMethod(String fieldName) {
 296         String[] segments = fieldName.split(&quot;\\.&quot;);
 297         //parse the last segment removing the method prefix (e.g. get)
 298         String methodSegment = segments[segments.length-1].replaceFirst(&quot;(^get)&quot;, &quot;&quot;);
 299         //lowercase first char and remove the ()
<abbr title=" 300         segments[segments.length - 1] = Character.toLowerCase(methodSegment.charAt(0)) + methodSegment.substring(1, methodSegment.length() - 2);"> 300         segments[segments.length - 1] = Character.toLowerCase(methodSegment.charAt(0)) + methodSegment.suðŸ”µ</abbr>
 301         return String.join(&quot;.&quot;, segments);
 302     }
 303 
 304     /**
<abbr title=" 305      * Determines if the given field value string represents a wild card search. In Solr a wild card search either"> 305      * Determines if the given field value string represents a wild card search. In Solr a wild card searðŸ”µ</abbr>
 306      * starts or ends with an asterisk.
 307      *
 308      * @param fieldValue the String field value
 309      * @return whether the value is for a wildcard search
 310      */
 311     protected boolean isWildCardSearch(String fieldValue) {
 312         return fieldValue.startsWith(&quot;*&quot;) || fieldValue.endsWith(&quot;*&quot;);
 313     }
 314 
 315     protected String getCustomFieldPropertyName(String mvelRule) {
 316         if (mvelRule.contains(&quot;CollectionUtils&quot;)) {
 317             //assuming left param is field, right is value
 318             int startIndex = mvelRule.indexOf(&quot;(&quot;);
 319             int endIndex = mvelRule.indexOf(&quot;,&quot;);
 320             mvelRule = mvelRule.substring(startIndex + 1, endIndex);
 321         }
 322         if (mvelRule.indexOf(&quot;[\&quot;&quot;) &gt; 0) {
 323         int startIndex = mvelRule.indexOf(&quot;[\&quot;&quot;) + 2;
 324         int endIndex = mvelRule.lastIndexOf(&quot;\&quot;]&quot;);
 325 
 326         return mvelRule.substring(startIndex, endIndex);
 327         } else {
<abbr title=" 328             if (mvelRule.contains(&quot;org.apache.commons.lang3.StringUtils.contains&quot;) || mvelRule.contains(&quot;.startsWith&quot;) || mvelRule.contains(&quot;.endsWith&quot;)) {"> 328             if (mvelRule.contains(&quot;org.apache.commons.lang3.StringUtils.contains&quot;) || mvelRule.contains(&quot;ðŸ”µ</abbr>
 329                 int startIndex = mvelRule.indexOf(&quot;(&quot;);
 330                 int endIndex = mvelRule.indexOf(&quot;,&quot;);
 331                 mvelRule = mvelRule.substring(startIndex + 1, endIndex);
 332             }
 333             mvelRule = getRuleOrPropertyFromFunction(mvelRule);
 334             return mvelRule;
 335         }
 336     }
 337 
 338     protected String getRuleOrPropertyFromFunction(String mvelRule) {
 339         int i = mvelRule.indexOf(&#x27;(&#x27;);
 340         int j = mvelRule.indexOf(&#x27;)&#x27;, i);
 341 
 342         //no function or maybe just some function? like xxx.xxx.getType()
 343         if (i == j || j == i + 1) {
 344             //expect to have either == or !=
 345             int exclamationMark = mvelRule.indexOf(&quot;!&quot;);
 346             if (exclamationMark &gt; 0) {
 347                 return mvelRule.substring(0, exclamationMark);
 348             } else {
 349                 int equalsSign = mvelRule.indexOf(&quot;=&quot;);
 350                 if (equalsSign &gt; 0) {
 351                     return mvelRule.substring(0, equalsSign);
 352                 }
 353                 //unknown format
 354             }
 355         } else {
 356             //looks like some function ?
 357             Pattern pattern = Pattern.compile(&quot;\\([^!=]+\\)&quot;);
 358             Matcher matcher = pattern.matcher(mvelRule);
 359             if (matcher.find()) {
 360                 String group = matcher.group();
 361                 return group.substring(1, group.length() - 1);
 362             }
 363 
 364         }
 365         return mvelRule;
 366     }
 367 
 368     protected String getCustomFieldValue(String mvelRule) {
 369         String customFieldValue = &quot;&quot;;
 370         if (mvelRule.contains(&quot;.contains&quot;)) {
 371             int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 372             int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);
 373 
 374             customFieldValue = mvelRule.substring(startIndex, endIndex);
 375         } else if (mvelRule.contains(&quot;==\&quot;&quot;) || mvelRule.contains(&quot;!=\&quot;&quot;)) {
 376             int startIndex;
 377             int endIndex;
 378             if (mvelRule.contains(&quot;toUpperCase&quot;)) {
 379                 startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 380                 endIndex = mvelRule.lastIndexOf(&quot;\&quot;)&quot;);
 381             } else {
 382                 startIndex = mvelRule.indexOf(&quot;==\&quot;&quot;) + 3;
 383                 endIndex = mvelRule.lastIndexOf(&quot;\&quot;&quot;);
 384         }
 385 
 386             customFieldValue = mvelRule.substring(startIndex, endIndex);
 387         } else if (mvelRule.contains(&quot;==&quot;) || mvelRule.contains(&quot;!=&quot;)) {
 388             int startIndex;
 389             int endIndex = mvelRule.length();
 390             if (mvelRule.contains(&quot;toUpperCase&quot;)) {
 391                 startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 392                 endIndex = mvelRule.indexOf(&quot;\&quot;)&quot;, startIndex);
 393             } else {
 394                 int i = mvelRule.indexOf(&quot;==&quot;);
 395                 if (i &gt; 0) {
 396                     startIndex = i + 2;
 397                 } else {
 398                     startIndex = mvelRule.indexOf(&quot;!=&quot;) + 2;
 399                 }
 400             }
 401 
 402             customFieldValue = mvelRule.substring(startIndex, endIndex);
 403         } else if (mvelRule.contains(&quot;.startsWith&quot;)) {
 404             int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 405             int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);
 406 
 407             customFieldValue = mvelRule.substring(startIndex, endIndex).replaceAll(&quot; &quot;, &quot;\\ &quot;) + &quot;*&quot;;
 408         } else if (mvelRule.contains(&quot;.endsWith&quot;)) {
 409             int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 410             int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);
 411 
 412             customFieldValue = &quot;*&quot; + mvelRule.substring(startIndex, endIndex).replaceAll(&quot; &quot;, &quot;\\ &quot;);
 413         } else if (mvelRule.contains(&quot;==null&quot;)) {
 414             // this means we have an &quot;is blank&quot; rule
 415             customFieldValue = &quot;null&quot;;
 416         } else if (mvelRule.contains(&quot;CollectionUtils&quot;)) {
 417             int startIndex = mvelRule.indexOf(&quot;,&quot;);
 418             int endIndex = mvelRule.indexOf(&quot;)&quot;, startIndex);
 419             customFieldValue = mvelRule.substring(startIndex + 1, endIndex);
 420         }
 421         //maybe it is something like [x,x1,x2]? -&gt; (x,x1,x2), or [x1]-&gt;x1
 422         if (customFieldValue.startsWith(&quot;[&quot;) &amp;&amp; customFieldValue.endsWith(&quot;]&quot;)) {
 423                 customFieldValue = customFieldValue.substring(1, customFieldValue.length() - 1);
 424                 if(customFieldValue.startsWith(&quot;\&quot;&quot;) &amp;&amp; customFieldValue.endsWith(&quot;\&quot;&quot;)){
 425                     customFieldValue = customFieldValue.substring(1, customFieldValue.length() - 1);
 426                 }
 427         }
 428         return customFieldValue;
 429     }
 430 
 431 
 432 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.search.service.solr;
  19 
  20 import java.util.ArrayList;
  21 import java.util.Collection;
  22 import java.util.Collections;
  23 import java.util.List;
  24 import java.util.regex.Matcher;
  25 import java.util.regex.Pattern;
  26 import javax.annotation.Resource;
  27 import org.apache.commons.collections.CollectionUtils;
  28 import org.apache.commons.lang3.StringUtils;
  29 import org.apache.commons.logging.Log;
  30 import org.apache.commons.logging.LogFactory;
  31 import org.broadleafcommerce.common.locale.domain.Locale;
  32 import org.broadleafcommerce.common.locale.domain.LocaleImpl;
  33 import org.broadleafcommerce.common.locale.service.LocaleService;
  34 import org.broadleafcommerce.core.catalog.service.CatalogService;
  35 import org.broadleafcommerce.core.search.dao.IndexFieldDao;
  36 import org.broadleafcommerce.core.search.domain.IndexFieldType;
  37 import org.broadleafcommerce.core.search.domain.IndexFieldTypeImpl;
  38 import org.broadleafcommerce.core.search.domain.SearchCriteria;
  39 import org.broadleafcommerce.core.search.domain.solr.FieldType;
  40 import org.springframework.stereotype.Service;
  41 
  42 
  43 /**
  44  * Convenience methods for converting simple MVEL rules to Solr SearchCriteria
  45  *
  46  * @author Chris Kittrell (ckittrell)
  47  */
  48 @Service(&quot;blMvelToSearchCriteriaConversionService&quot;)
  49 public class MvelToSearchCriteriaConversionServiceImpl implements MvelToSearchCriteriaConversionService {
  50     private static final Log LOG = LogFactory.getLog(MvelToSearchCriteriaConversionServiceImpl.class);
  51 
<abbr title="  52     public static final String CATEGORY_FORMAT_REGEX = &quot;^CollectionUtils\.intersection\(product\.\?allParentCategoryIds,\[\&quot;([0-9]+)(,\&quot;[0-9]+\&quot;)*\&quot;\]\)\.size\(\)&gt;0$&quot;;">  52     public static final String CATEGORY_FORMAT_REGEX = &quot;^CollectionUtils\.intersection\(product\.\?allParðŸ”µ</abbr>
  53 
  54     @Resource(name = &quot;blCatalogService&quot;)
  55     protected CatalogService catalogService;
  56 
  57     @Resource(name = &quot;blIndexFieldDao&quot;)
  58     protected IndexFieldDao indexFieldDao;
  59 
  60     @Resource(name = &quot;blLocaleService&quot;)
  61     protected LocaleService localeService;
  62 
  63     @Resource(name = &quot;blSolrHelperService&quot;)
  64     protected SolrHelperService solrHelperService;
  65 
  66     @Override
  67     public SearchCriteria convert(String mvelRule) {
  68         SearchCriteria criteria = new SearchCriteria();
  69         criteria.setPageSize(Integer.MAX_VALUE);
  70         if (isProductRule(mvelRule) || isCategoryTargetingRule(mvelRule)) {
  71             Collection&lt;String&gt; strings = convertRuleToFilters(mvelRule);
  72             criteria.setFilterQueries(strings);
  73         } else {
<abbr title="  74             throw new UnsupportedOperationException(&quot;The selected Add-On Product Group is defined using Rules &quot; + (&quot;(Conditional Rules) and selected rule can&#x27;t be translated to solr criteria and so &quot; + &quot;does not support selection of a Default Product. See Tooltip for supported rule details&quot;));">  74             throw new UnsupportedOperationException(&quot;The selected Add-On Product Group is defined using RðŸ”µ</abbr>
  75         }
  76         return criteria;
  77     }
  78 
  79     protected boolean isProductRule(String rule) {
  80         return rule.contains(&quot;product.&quot;);
  81     }
  82 
  83     protected boolean isCustomFieldIndexed(List&lt;IndexFieldType&gt; indexFieldTypes) {
  84         return CollectionUtils.isNotEmpty(indexFieldTypes);
  85     }
  86 
<abbr title="  87     // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()&gt;0">  87     // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;ðŸ”µ</abbr>
  88     protected boolean isCategoryTargetingRule(String mvelRule) {
  89         return mvelRule.matches(CATEGORY_FORMAT_REGEX);
  90     }
  91 
<abbr title="  92     // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;,...]).size()&gt;0">  92     // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;ðŸ”µ</abbr>
  93     protected Long[] getCategoryIds(String mvelRule) {
  94         int startIndex = mvelRule.indexOf(&quot;[\&quot;&quot;) + 2;
  95         int endIndex = mvelRule.indexOf(&quot;\&quot;]&quot;);
  96         String categoryId = mvelRule.substring(startIndex, endIndex);
  97         // how about multivalue ?
  98         String[] split = categoryId.split(&quot;,&quot;);
  99         Long[] result = null;
 100         int length = split.length;
 101         if (length &gt; 0) {
 102             result = new Long[length];
 103             for (int i = 0; i &lt; length; i++) {
 104                 result[i] = Long.parseLong(split[i].replace(&quot;\&quot;&quot;, &quot;&quot;));
 105             }
 106         }
 107         return result;
 108     }
 109 
 110 
 111 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112     // Expected Custom Field Rule Formats</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113     // Equals - product.?getProductAttributes()[&quot;custom_field_name&quot;]==&quot;custom field value&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 114     // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelper.toUpperCase(&quot;custom field value&quot;))"> 114     // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115     // Also supports string property contains, not contains, starts with, ends with etc.</span>
 116 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 117 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 117 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 118 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120     // Expected Custom Field Rule Formats</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121     // Equals - product.?getProductAttributes()[&quot;custom_field_name&quot;]==&quot;custom field value&quot;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 122     // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelper.toUpperCase(&quot;custom field value&quot;))"> 122     // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123     // Also supports string property contains, not contains, starts with, ends with etc.</span>
 124 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 125 
 126     protected Collection&lt;String&gt; convertRuleToFilters(String matchRule) {
 127         List&lt;String&gt; filters = new ArrayList&lt;&gt;();
 128         boolean allRulesMustBeTrue = !matchRule.contains(&quot;||&quot;);
 129         String[] fragments;
 130         if (allRulesMustBeTrue) {
 131             fragments = StringUtils.split(matchRule, &quot;&amp;&amp;&quot;);
 132         } else {
 133             fragments = StringUtils.split(matchRule, &quot;||&quot;);
 134         }
 135         for (String fragment : fragments) {
 136             if (isCategoryTargetingRule(fragment)) {
 137                 Long[] categoryIds = getCategoryIds(fragment);
 138                 if (categoryIds != null) {
 139                     String explicitCategoryFieldName = solrHelperService.getExplicitCategoryFieldName();
 140                     StringBuilder categoryFilter = new StringBuilder(explicitCategoryFieldName + &quot;:(\&quot;&quot;);
 141                     for (int i = 0; i &lt; categoryIds.length; i++) {
 142                         Long catId = solrHelperService.getCategoryId(categoryIds[i]);
 143                         categoryFilter.append(catId);
 144                         if ((i + 1) &lt; categoryIds.length) {
 145                             categoryFilter.append(&quot;,&quot;);
 146                         }
 147                     }
 148                     categoryFilter.append(&quot;\&quot;)&quot;);
 149                     filters.add(categoryFilter.toString());
 150                 }
 151             } else {
 152                 String fieldName = getCustomFieldPropertyName(fragment);
 153                 String fieldValue = getCustomFieldValue(fragment);
 154                 boolean exclude = fragment.contains(&quot;!=&quot;) || fragment.startsWith(&quot;!&quot;);
 155                 boolean isWildCardSearch = isWildCardSearch(fieldValue);
 156                 fieldName = convertFieldName(fieldName);
<abbr title=" 157                 List&lt;IndexFieldType&gt; indexFieldTypes = indexFieldDao.getIndexFieldTypesByAbbreviationOrPropertyName(fieldName);"> 157                 List&lt;IndexFieldType&gt; indexFieldTypes = indexFieldDao.getIndexFieldTypesByAbbreviationOrPrðŸ”µ</abbr>
 158                 boolean isCatalog = false;
 159                 if (&quot;embeddableCatalogTenantDiscriminator.catalogDiscriminator&quot;.equals(fieldName)) {
 160                     fieldName = solrHelperService.getCatalogFieldName();
 161                     isCatalog = true;
 162                     indexFieldTypes = new ArrayList&lt;&gt;();
 163                     indexFieldTypes.add(new IndexFieldTypeImpl());
 164                 }
 165                 if (indexFieldTypes.size() &gt; 0) {
 166 
 167 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 168                     Boolean translatable = !isCatalog &amp;&amp; indexFieldTypes.get(0).getIndexField().getField().getTranslatable();"> 168                     Boolean translatable = !isCatalog &amp;&amp; indexFieldTypes.get(0).getIndexField().getField(ðŸ”µ</abbr></span>
 169 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 170 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 170 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 171 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 173                     Boolean translatable = indexFieldTypes.get(0).getIndexField().getField().getTranslatable();"> 173                     Boolean translatable = indexFieldTypes.get(0).getIndexField().getField().getTranslataðŸ”µ</abbr></span>
 174 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 175 
 176                     List&lt;Locale&gt; allLocales;
 177                     if ((translatable == null) || (!translatable)) {
 178                         allLocales = new ArrayList&lt;&gt;();
 179                         LocaleImpl e = new LocaleImpl();
 180                         e.setLocaleCode(&quot;&quot;);
 181                         allLocales.add(e);
 182                     } else {
 183                         allLocales = localeService.findAllLocales();
 184                     }
 185                     List&lt;String&gt; tmpFilters = new ArrayList&lt;&gt;();
 186 
 187 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 188                     String abbreviation = isCatalog ? &quot;&quot;: indexFieldTypes.get(0).getIndexField().getField().getAbbreviation();"> 188                     String abbreviation = isCatalog ? &quot;&quot;: indexFieldTypes.get(0).getIndexField().getFieldðŸ”µ</abbr></span>
 189 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 190 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 190 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 191 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 193                     String abbreviation = indexFieldTypes.get(0).getIndexField().getField().getAbbreviation();"> 193                     String abbreviation = indexFieldTypes.get(0).getIndexField().getField().getAbbreviatiðŸ”µ</abbr></span>
 194 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 195 
 196                     for (Locale locale : allLocales) {
 197                         for (IndexFieldType indexFieldType : indexFieldTypes) {
 198 
 199 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200                             String type = isCatalog ? &quot;&quot; :indexFieldType.getFieldType().getType();</span>
 201 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 202 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 202 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 203 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205                 String type = indexFieldType.getFieldType().getType();</span>
 206 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 207 
 208                             if (
 209 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210 !isWildCardSearch || FieldType.STRING.getType().equals(type) || isCatalog</span>
 211 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 212 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 212 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 213 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215 !isWildCardSearch || FieldType.STRING.getType().equals(type)</span>
 216 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 217                              || )
 218 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219 {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220             customFieldQuery = &quot;*:*&amp;fq=(&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221             for (IndexFieldType indexFieldType : indexFieldTypes) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222                 String type = indexFieldType.getFieldType().getType();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223                 String indexFieldName = customFieldPropertyName + &quot;_&quot; + type;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224                 String indexFieldValue = &quot;\&quot;&quot; + customFieldValue + &quot;\&quot;&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226                 if (!isFirstItem(customFieldQuery)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227                     customFieldQuery += &quot; OR &quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230                 customFieldQuery += indexFieldName + &quot;:&quot; + indexFieldValue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232             customFieldQuery += &quot;)&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233         }</span>
 234 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 235 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 235 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 236 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238 {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239                                 String prefix;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240                                 if (StringUtils.isNotEmpty(locale.getLocaleCode())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241                                     prefix = locale.getLocaleCode() + &quot;_&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242                                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243                                     prefix = &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244                                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245                                 String indexFieldName = prefix + abbreviation + &quot;_&quot; + type;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 247                                 // if this is a wildcard search then we do not want to surround the value with quotes"> 247                                 // if this is a wildcard search then we do not want to surround the valueðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248                                 String indexFieldValue = fieldValue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249                                 if (!isWildCardSearch &amp;&amp; !fieldValue.equals(&quot;null&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250                                     if(fieldValue.contains(&quot;\&quot;,\&quot;&quot;)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251                                         indexFieldValue = &quot;(\&quot;&quot; + fieldValue + &quot;\&quot;)&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252                                     }else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253                                         indexFieldValue = &quot;\&quot;&quot; + fieldValue + &quot;\&quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254                                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255                                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257                                 String filter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258                                 if (indexFieldValue.equals(&quot;null&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259                                     // this is for checking if null or non-existent fields</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260                                     filter = &quot;(*:* AND -&quot; + indexFieldName + &quot;:[* TO *])&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261                                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262                                     filter = indexFieldName + &quot;:&quot; + indexFieldValue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263                                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265                                 if (exclude) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266                                     filter = &quot;NOT &quot; + filter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267                                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269                                 tmpFilters.add(filter);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270                             }</span>
 271 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 272 
 273                         }
 274                     }
 275                     if (!exclude) {
<abbr title=" 276                         // any of translation and type fields like en_name_tsy, en_name_s etc can match, so concatinate with OR"> 276                         // any of translation and type fields like en_name_tsy, en_name_s etc can match, ðŸ”µ</abbr>
 277                         String s = tmpFilters.get(0);
 278 
 279 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280                         s</span>
 281 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 282 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 282 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 283 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285                         s</span>
 286 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 287                          = &quot;(&quot; + s;
 288                         tmpFilters.set(0, s);
 289                         int size = tmpFilters.size() - 1;
 290                         String s1 = tmpFilters.get(size);
 291                         s1 = s1 + &quot;)&quot;;
 292                         tmpFilters.set(size, s1);
 293                         filters.add(StringUtils.join(tmpFilters, &quot; OR &quot;));
 294                     } else {
 295                         // if we exclude we don&#x27;t want to see if at all so &quot;AND&quot; is ok
 296                         filters.addAll(tmpFilters);
 297                     }
 298                     if (org.apache.commons.collections4.CollectionUtils.isEmpty(indexFieldTypes)) {
 299                         if (fieldName.contains(&quot;catalogDiscriminator&quot;)) {
 300                             String substring = fieldValue.substring(1, fieldValue.length() - 1);
 301                             filters.add((&quot;catalog_s:(&quot; + substring) + &quot;)&quot;);
 302                         }
 303                     }
 304                 } else {
 305                     return Collections.emptyList();
 306                 }
 307             }
 308         }
 309         if (allRulesMustBeTrue) {
 310             return filters;
 311         } else {
 312             return Collections.singletonList(StringUtils.join(filters, &quot; OR &quot;));
 313         }
 314     }
 315 
 316     protected String convertFieldName(String fieldName) {
 317         String result = fieldName;
 318         if (fieldName.startsWith(&quot;product.&quot;)) {
 319             result = fieldName.substring(&quot;product.&quot;.length());
 320         }
 321         if (result.endsWith(&quot;()&quot;)) {
 322             result = parseMethod(result);
 323         }
 324         result = result.replaceAll(&quot;\\?&quot;, &quot;&quot;);
 325         return result;
 326     }
 327 
 328     /**
<abbr title=" 329      * Takes in a fieldName that contains a method (indicated with &quot;()&quot;) and converts the method to an attribute."> 329      * Takes in a fieldName that contains a method (indicated with &quot;()&quot;) and converts the method to an atðŸ”µ</abbr>
 330      * Currently supports getX() methods
 331      * For example, getType() -&gt; type
 332      * @param fieldName
 333      * @return
 334      */
 335     protected String parseMethod(String fieldName) {
 336         String[] segments = fieldName.split(&quot;\\.&quot;);
 337         // parse the last segment removing the method prefix (e.g. get)
 338         String methodSegment = segments[segments.length - 1].replaceFirst(&quot;(^get)&quot;, &quot;&quot;);
 339         // lowercase first char and remove the ()
<abbr title=" 340         segments[segments.length - 1] = Character.toLowerCase(methodSegment.charAt(0)) + methodSegment.substring(1, methodSegment.length() - 2);"> 340         segments[segments.length - 1] = Character.toLowerCase(methodSegment.charAt(0)) + methodSegment.suðŸ”µ</abbr>
 341         return String.join(&quot;.&quot;, segments);
 342     }
 343 
 344     /**
<abbr title=" 345      * Determines if the given field value string represents a wild card search. In Solr a wild card search either"> 345      * Determines if the given field value string represents a wild card search. In Solr a wild card searðŸ”µ</abbr>
 346      * starts or ends with an asterisk.
 347      *
 348      * @param fieldValue
 349      * 		the String field value
 350      * @return whether the value is for a wildcard search
 351      */
 352     protected boolean isWildCardSearch(String fieldValue) {
 353         return fieldValue.startsWith(&quot;*&quot;) || fieldValue.endsWith(&quot;*&quot;);
 354     }
 355 
 356     protected String getCustomFieldPropertyName(String mvelRule) {
 357         if (mvelRule.contains(&quot;CollectionUtils&quot;)) {
 358             //assuming left param is field, right is value
 359             int startIndex = mvelRule.indexOf(&quot;(&quot;);
 360             int endIndex = mvelRule.indexOf(&quot;,&quot;);
 361             mvelRule = mvelRule.substring(startIndex + 1, endIndex);
 362         }
 363         if (mvelRule.indexOf(&quot;[\&quot;&quot;) &gt; 0) {
 364             int startIndex = mvelRule.indexOf(&quot;[\&quot;&quot;) + 2;
 365             int endIndex = mvelRule.lastIndexOf(&quot;\&quot;]&quot;);
 366             return mvelRule.substring(startIndex, endIndex);
 367         } else {
<abbr title=" 368             if ((mvelRule.contains(&quot;org.apache.commons.lang3.StringUtils.contains&quot;) || mvelRule.contains(&quot;.startsWith&quot;)) || mvelRule.contains(&quot;.endsWith&quot;)) {"> 368             if ((mvelRule.contains(&quot;org.apache.commons.lang3.StringUtils.contains&quot;) || mvelRule.contains(ðŸ”µ</abbr>
 369                 int startIndex = mvelRule.indexOf(&quot;(&quot;);
 370                 int endIndex = mvelRule.indexOf(&quot;,&quot;);
 371                 mvelRule = mvelRule.substring(startIndex + 1, endIndex);
 372             }
 373             mvelRule = getRuleOrPropertyFromFunction(mvelRule);
 374             return mvelRule;
 375         }
 376     }
 377 
 378     protected String getRuleOrPropertyFromFunction(String mvelRule) {
 379         int i = mvelRule.indexOf(&#x27;(&#x27;);
 380         int j = mvelRule.indexOf(&#x27;)&#x27;, i);
 381         //no function or maybe just some function? like xxx.xxx.getType()
 382         if ((i == j) || (j == (i + 1))) {
 383             //expect to have either == or !=
 384             int exclamationMark = mvelRule.indexOf(&quot;!&quot;);
 385             if (exclamationMark &gt; 0) {
 386                 return mvelRule.substring(0, exclamationMark);
 387             } else {
 388                 int equalsSign = mvelRule.indexOf(&quot;=&quot;);
 389                 if (equalsSign &gt; 0) {
 390                     return mvelRule.substring(0, equalsSign);
 391                 }
 392                 //unknown format
 393             }
 394         } else {
 395             //looks like some function ?
 396             Pattern pattern = Pattern.compile(&quot;\\([^!=]+\\)&quot;);
 397             Matcher matcher = pattern.matcher(mvelRule);
 398             if (matcher.find()) {
 399                 String group = matcher.group();
 400                 return group.substring(1, group.length() - 1);
 401             }
 402         }
 403         return mvelRule;
 404     }
 405 
 406     protected String getCustomFieldValue(String mvelRule) {
 407         String customFieldValue = &quot;&quot;;
 408         if (mvelRule.contains(&quot;.contains&quot;)) {
 409             int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 410             int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);
 411             customFieldValue = mvelRule.substring(startIndex, endIndex);
 412         } else if (mvelRule.contains(&quot;==\&quot;&quot;) || mvelRule.contains(&quot;!=\&quot;&quot;)) {
 413             int startIndex;
 414             int endIndex;
 415             if (mvelRule.contains(&quot;toUpperCase&quot;)) {
 416                 startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 417                 endIndex = mvelRule.lastIndexOf(&quot;\&quot;)&quot;);
 418             } else {
 419                 startIndex = mvelRule.indexOf(&quot;==\&quot;&quot;) + 3;
 420                 endIndex = mvelRule.lastIndexOf(&quot;\&quot;&quot;);
 421             }
 422             customFieldValue = mvelRule.substring(startIndex, endIndex);
 423         } else if (mvelRule.contains(&quot;==&quot;) || mvelRule.contains(&quot;!=&quot;)) {
 424             int startIndex;
 425             int endIndex = mvelRule.length();
 426             if (mvelRule.contains(&quot;toUpperCase&quot;)) {
 427                 startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 428                 endIndex = mvelRule.indexOf(&quot;\&quot;)&quot;, startIndex);
 429             } else {
 430                 int i = mvelRule.indexOf(&quot;==&quot;);
 431                 if (i &gt; 0) {
 432                     startIndex = i + 2;
 433                 } else {
 434                     startIndex = mvelRule.indexOf(&quot;!=&quot;) + 2;
 435                 }
 436             }
 437             customFieldValue = mvelRule.substring(startIndex, endIndex);
 438         } else if (mvelRule.contains(&quot;.startsWith&quot;)) {
 439             int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 440             int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);
 441             customFieldValue = mvelRule.substring(startIndex, endIndex).replaceAll(&quot; &quot;, &quot;\\ &quot;) + &quot;*&quot;;
 442         } else if (mvelRule.contains(&quot;.endsWith&quot;)) {
 443             int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 444             int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);
 445             customFieldValue = &quot;*&quot; + mvelRule.substring(startIndex, endIndex).replaceAll(&quot; &quot;, &quot;\\ &quot;);
 446         } else if (mvelRule.contains(&quot;==null&quot;)) {
 447             // this means we have an &quot;is blank&quot; rule
 448             customFieldValue = &quot;null&quot;;
 449         } else if (mvelRule.contains(&quot;CollectionUtils&quot;)) {
 450             int startIndex = mvelRule.indexOf(&quot;,&quot;);
 451             int endIndex = mvelRule.indexOf(&quot;)&quot;, startIndex);
 452             customFieldValue = mvelRule.substring(startIndex + 1, endIndex);
 453         }
 454         //maybe it is something like [x,x1,x2]? -&gt; (x,x1,x2), or [x1]-&gt;x1
 455         if (customFieldValue.startsWith(&quot;[&quot;) &amp;&amp; customFieldValue.endsWith(&quot;]&quot;)) {
 456             customFieldValue = customFieldValue.substring(1, customFieldValue.length() - 1);
 457             if (customFieldValue.startsWith(&quot;\&quot;&quot;) &amp;&amp; customFieldValue.endsWith(&quot;\&quot;&quot;)) {
 458                 customFieldValue = customFieldValue.substring(1, customFieldValue.length() - 1);
 459             }
 460         }
 461         return customFieldValue;
 462     }
 463 }</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.search.service.solr;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import org.apache.commons.lang3.StringUtils;</span>
  22  import org.apache.commons.logging.Log;
  23  import org.apache.commons.logging.LogFactory;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import org.broadleafcommerce.core.catalog.domain.Category;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import org.broadleafcommerce.common.locale.domain.Locale;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import org.broadleafcommerce.common.locale.domain.LocaleImpl;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import org.broadleafcommerce.common.locale.service.LocaleService;</span>
  28  import org.broadleafcommerce.core.catalog.service.CatalogService;
  29  import org.broadleafcommerce.core.search.dao.IndexFieldDao;
  30  import org.broadleafcommerce.core.search.domain.IndexFieldType;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import org.broadleafcommerce.core.search.domain.IndexFieldTypeImpl;</span>
  32  import org.broadleafcommerce.core.search.domain.SearchCriteria;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.broadleafcommerce.core.search.domain.solr.FieldType;</span>
  34  import org.springframework.stereotype.Service;
  35  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +import java.util.Collection;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import java.util.Collections;</span>
  39  import java.util.List;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import java.util.regex.Matcher;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import java.util.regex.Pattern;</span>
  42  
  43  import javax.annotation.Resource;
  44  
  45  /**
  46   * Convenience methods for converting simple MVEL rules to Solr SearchCriteria
  47   *
  48   * @author Chris Kittrell (ckittrell)
  49   */
  50  @Service(&quot;blMvelToSearchCriteriaConversionService&quot;)
  51  public class MvelToSearchCriteriaConversionServiceImpl implements MvelToSearchCriteriaConversionService {
  52  
  53      private static final Log LOG = LogFactory.getLog(MvelToSearchCriteriaConversionServiceImpl.class);
  54  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  55 -    public static final String CATEGORY_FORMAT_REGEX = &quot;^CollectionUtils\\.intersection\\(product\\.\\?allParentCategoryIds,\\[\\\&quot;([0-9]+)\\\&quot;\\]\\)\\.size\\(\\)&gt;0$&quot;;">  55 -    public static final String CATEGORY_FORMAT_REGEX = &quot;^CollectionUtils\\.intersection\\(product\\.\\?allParentCaðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  56 -    public static final String CUSTOM_FIELD_EQUALS_FORMAT_REGEX = &quot;^product\\.\\?getProductAttributes\\(\\)\\[\\\&quot;([a-zA-Z0-9_]+)\\\&quot;\\]\\=\\=\\\&quot;([a-zA-Z0-9\\s]+)\\\&quot;$&quot;;">  56 -    public static final String CUSTOM_FIELD_EQUALS_FORMAT_REGEX = &quot;^product\\.\\?getProductAttributes\\(\\)\\[\\\&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  57 -    public static final String CUSTOM_FIELD_CONTAINS_FORMAT_REGEX = &quot;^MvelHelper\\.toUpperCase\\(product\\.\\?getProductAttributes\\(\\)\\[\\\&quot;([a-zA-Z0-9_]+)\\\&quot;\\]\\)\\.contains\\(MvelHelper\\.toUpperCase\\(\\\&quot;([a-zA-Z0-9\\s]+)\\\&quot;\\)\\)$&quot;;">  57 -    public static final String CUSTOM_FIELD_CONTAINS_FORMAT_REGEX = &quot;^MvelHelper\\.toUpperCase\\(product\\.\\?getPðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  58 +    public static final String CATEGORY_FORMAT_REGEX = &quot;^CollectionUtils\\.intersection\\(product\\.\\?allParentCategoryIds,\\[\\\&quot;([0-9]+)(,\\\&quot;[0-9]+\\\&quot;)*\\\&quot;\\]\\)\\.size\\(\\)&gt;0$&quot;;">  58 +    public static final String CATEGORY_FORMAT_REGEX = &quot;^CollectionUtils\\.intersection\\(product\\.\\?allParentCaðŸ”µ</abbr></span>
  59  
  60      @Resource(name = &quot;blCatalogService&quot;)
  61      protected CatalogService catalogService;
  62  
  63      @Resource(name = &quot;blIndexFieldDao&quot;)
  64      protected IndexFieldDao indexFieldDao;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +    @Resource(name = &quot;blLocaleService&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +    protected LocaleService localeService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +    @Resource(name=&quot;blSolrHelperService&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +    protected SolrHelperService solrHelperService;</span>
  71  
  72      @Override
  73      public SearchCriteria convert(String mvelRule) {
  74          SearchCriteria criteria = new SearchCriteria();
  75          criteria.setPageSize(Integer.MAX_VALUE);
  76  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -        if (isCustomFieldTargetingRule(mvelRule)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -            String customFieldQuery = buildCustomFieldQuery(mvelRule);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -            criteria.setQuery(customFieldQuery);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -        } else if (isCategoryTargetingRule(mvelRule)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -            Long categoryId = getCategoryId(mvelRule);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -            Category category = catalogService.findCategoryById(categoryId);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -            criteria.setCategory(category);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -            throw new UnsupportedOperationException(&quot;The provided MVEL rule format is not currently supported &quot; +</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -                    &quot;for MVEL to Solr Search Criteria conversion.&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +        if (isProductRule(mvelRule) || isCategoryTargetingRule(mvelRule)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +            Collection&lt;String&gt; strings = convertRuleToFilters(mvelRule);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +            criteria.setFilterQueries(strings);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +        }else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +            throw new UnsupportedOperationException(&quot;The selected Add-On Product Group is defined using Rules &quot; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +                    &quot;(Conditional Rules) and selected rule can&#x27;t be translated to solr criteria and so &quot; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +                    &quot;does not support selection of a Default Product. See Tooltip for supported rule details&quot;);</span>
  94          }
  95  
  96          return criteria;
  97      }
  98  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -    protected String buildCustomFieldQuery(String mvelRule) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -        String customFieldPropertyName = getCustomFieldPropertyName(mvelRule);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -        String customFieldValue = getCustomFieldValue(mvelRule);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        return buildCustomFieldQuery(customFieldPropertyName, customFieldValue);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +    protected boolean isProductRule(String rule){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +        return rule.contains(&quot;product.&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +    protected boolean isCustomFieldIndexed(List&lt;IndexFieldType&gt; indexFieldTypes) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +        return CollectionUtils.isNotEmpty(indexFieldTypes);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 112 +    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()&gt;0"> 112 +    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +    protected boolean isCategoryTargetingRule(String mvelRule) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +        return mvelRule.matches(CATEGORY_FORMAT_REGEX);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 117 +    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;,...]).size()&gt;0"> 117 +    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;,...]).siðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +    protected Long[] getCategoryIds(String mvelRule) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        int startIndex = mvelRule.indexOf(&quot;[\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +        int endIndex = mvelRule.indexOf(&quot;\&quot;]&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +        String categoryId = mvelRule.substring(startIndex, endIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +        //how about multivalue ?</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +        String[] split = categoryId.split(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +        Long[] result = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +        int length = split.length;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        if (length &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +            result = new Long[length];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +            for (int i = 0; i &lt; length; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +                result[i] = Long.parseLong(split[i].replace(&quot;\&quot;&quot;,&quot;&quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +        return result;</span>
 133      }
 134  
 135      // Expected Custom Field Rule Formats
 136      // Equals - product.?getProductAttributes()[&quot;custom_field_name&quot;]==&quot;custom field value&quot;
<abbr title=" 137      // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelper.toUpperCase(&quot;custom field value&quot;))"> 137      // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelperðŸ”µ</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +    // Also supports string property contains, not contains, starts with, ends with etc.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +    protected Collection&lt;String&gt; convertRuleToFilters(String matchRule) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +        List&lt;String&gt; filters = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +        boolean allRulesMustBeTrue = !matchRule.contains(&quot;||&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +        String[] fragments;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +        if (allRulesMustBeTrue) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +            fragments = StringUtils.split(matchRule, &quot;&amp;&amp;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +            fragments = StringUtils.split(matchRule, &quot;||&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +        for (String fragment : fragments) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +            if (isCategoryTargetingRule(fragment)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +                Long[] categoryIds = getCategoryIds(fragment);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +                if (categoryIds != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +                    String explicitCategoryFieldName = solrHelperService.getExplicitCategoryFieldName();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +                    StringBuilder categoryFilter = new StringBuilder(explicitCategoryFieldName + &quot;:(\&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +                    for (int i = 0; i &lt; categoryIds.length; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +                        Long catId = solrHelperService.getCategoryId(categoryIds[i]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +                        categoryFilter.append(catId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +                        if (i + 1 &lt; categoryIds.length) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +                            categoryFilter.append(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +                    categoryFilter.append(&quot;\&quot;)&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +                    filters.add(categoryFilter.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +                String fieldName = getCustomFieldPropertyName(fragment);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +                String fieldValue = getCustomFieldValue(fragment);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +                boolean exclude = fragment.contains(&quot;!=&quot;) || fragment.startsWith(&quot;!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +                boolean isWildCardSearch = isWildCardSearch(fieldValue);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +                fieldName = convertFieldName(fieldName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 173 +                List&lt;IndexFieldType&gt; indexFieldTypes = indexFieldDao.getIndexFieldTypesByAbbreviationOrPropertyName(fieldName);"> 173 +                List&lt;IndexFieldType&gt; indexFieldTypes = indexFieldDao.getIndexFieldTypesByAbbreviationOrPropertyNamðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +                boolean isCatalog = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +                if(&quot;embeddableCatalogTenantDiscriminator.catalogDiscriminator&quot;.equals(fieldName)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +                    fieldName = solrHelperService.getCatalogFieldName();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +                    isCatalog = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +                    indexFieldTypes = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +                    indexFieldTypes.add(new IndexFieldTypeImpl());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +                if (indexFieldTypes.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 182 +                    Boolean translatable = !isCatalog &amp;&amp; indexFieldTypes.get(0).getIndexField().getField().getTranslatable();"> 182 +                    Boolean translatable = !isCatalog &amp;&amp; indexFieldTypes.get(0).getIndexField().getField().getTranðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +                    List&lt;Locale&gt; allLocales;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +                    if (translatable==null || !translatable) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +                        allLocales = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +                        LocaleImpl e = new LocaleImpl();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +                        e.setLocaleCode(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +                        allLocales.add(e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +                    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +                        allLocales = localeService.findAllLocales();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +                    List&lt;String&gt; tmpFilters = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 193 +                    String abbreviation = isCatalog ? &quot;&quot;: indexFieldTypes.get(0).getIndexField().getField().getAbbreviation();"> 193 +                    String abbreviation = isCatalog ? &quot;&quot;: indexFieldTypes.get(0).getIndexField().getField().getAbbðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +                    for (Locale locale : allLocales) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +                        for (IndexFieldType indexFieldType : indexFieldTypes) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +                            String type = isCatalog ? &quot;&quot; :indexFieldType.getFieldType().getType();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +                            if (!isWildCardSearch || FieldType.STRING.getType().equals(type) || isCatalog) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +                                String prefix;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +                                if (StringUtils.isNotEmpty(locale.getLocaleCode())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +                                    prefix = locale.getLocaleCode() + &quot;_&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +                                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +                                    prefix = &quot;&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 205 +                                String indexFieldName = isCatalog ? fieldName : (prefix + abbreviation + &quot;_&quot; + type);"> 205 +                                String indexFieldName = isCatalog ? fieldName : (prefix + abbreviation + &quot;_&quot; + typðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 207 +                                // if this is a wildcard search then we do not want to surround the value with quotes"> 207 +                                // if this is a wildcard search then we do not want to surround the value with quoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +                                String indexFieldValue = fieldValue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +                                if (!isWildCardSearch &amp;&amp; !fieldValue.equals(&quot;null&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +                                    if(fieldValue.contains(&quot;\&quot;,\&quot;&quot;)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +                                        indexFieldValue = &quot;(\&quot;&quot; + fieldValue + &quot;\&quot;)&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +                                    }else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +                                        indexFieldValue = &quot;\&quot;&quot; + fieldValue + &quot;\&quot;&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +                                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +                                String filter;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +                                if (indexFieldValue.equals(&quot;null&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +                                    // this is for checking if null or non-existent fields</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +                                    filter = &quot;(*:* AND -&quot; + indexFieldName + &quot;:[* TO *])&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +                                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +                                    filter = indexFieldName + &quot;:&quot; + indexFieldValue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +                                if (exclude) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +                                    filter = &quot;NOT &quot; + filter;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +                                tmpFilters.add(filter);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +                    if (!exclude) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 235 +                        //any of translation and type fields like en_name_tsy, en_name_s etc can match, so concatinate with OR"> 235 +                        //any of translation and type fields like en_name_tsy, en_name_s etc can match, so concatiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +                        String s = tmpFilters.get(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +                        s = &quot;(&quot; + s;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +                        tmpFilters.set(0, s);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +                        int size = tmpFilters.size() - 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +                        String s1 = tmpFilters.get(size);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +                        s1 = s1 + &quot;)&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +                        tmpFilters.set(size, s1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +                        filters.add(StringUtils.join(tmpFilters, &quot; OR &quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +                    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +                        //if we exclude we don&#x27;t want to see if at all so &quot;AND&quot; is ok</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +                        filters.addAll(tmpFilters);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +                    if (org.apache.commons.collections4.CollectionUtils.isEmpty(indexFieldTypes)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +                        if (fieldName.contains(&quot;catalogDiscriminator&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +                            String substring = fieldValue.substring(1, fieldValue.length() - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +                            filters.add(&quot;catalog_s:(&quot; + substring + &quot;)&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +                    return Collections.emptyList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +        if (allRulesMustBeTrue) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +            return filters;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +            return Collections.singletonList(StringUtils.join(filters, &quot; OR &quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +    protected String convertFieldName(String fieldName) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +        String result = fieldName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +        if (fieldName.startsWith(&quot;product.&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +            result = fieldName.substring(&quot;product.&quot;.length());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +        if (result.endsWith(&quot;()&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +            result = parseMethod(result);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +        result = result.replaceAll(&quot;\\?&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +        return result;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +     * Takes in a fieldName that contains a method (indicated with &quot;()&quot;) and converts the method to an attribute.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +     * Currently supports getX() methods</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +     * For example, getType() -&gt; type</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +     * @param fieldName</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +     * @return</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +    protected String parseMethod(String fieldName) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +        String[] segments = fieldName.split(&quot;\\.&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +        //parse the last segment removing the method prefix (e.g. get)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +        String methodSegment = segments[segments.length-1].replaceFirst(&quot;(^get)&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +        //lowercase first char and remove the ()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 291 +        segments[segments.length - 1] = Character.toLowerCase(methodSegment.charAt(0)) + methodSegment.substring(1, methodSegment.length() - 2);"> 291 +        segments[segments.length - 1] = Character.toLowerCase(methodSegment.charAt(0)) + methodSegment.substring(1ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +        return String.join(&quot;.&quot;, segments);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +     * Determines if the given field value string represents a wild card search. In Solr a wild card search either</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +     * starts or ends with an asterisk.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +     * @param fieldValue the String field value</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +     * @return whether the value is for a wildcard search</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +    protected boolean isWildCardSearch(String fieldValue) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +        return fieldValue.startsWith(&quot;*&quot;) || fieldValue.endsWith(&quot;*&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +</span>
 306      protected String getCustomFieldPropertyName(String mvelRule) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -        int startIndex = mvelRule.indexOf(&quot;[\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -        int endIndex = mvelRule.lastIndexOf(&quot;\&quot;]&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -        return mvelRule.substring(startIndex, endIndex);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -    // Expected Custom Field Rule Formats</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -    // Equals - product.?getProductAttributes()[&quot;custom_field_name&quot;]==&quot;custom field value&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 315 -    // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelper.toUpperCase(&quot;custom field value&quot;))"> 315 -    // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelperðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +        if (mvelRule.contains(&quot;CollectionUtils&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +            //assuming left param is field, right is value</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +            int startIndex = mvelRule.indexOf(&quot;(&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +            int endIndex = mvelRule.indexOf(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +            mvelRule = mvelRule.substring(startIndex + 1, endIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +        if (mvelRule.indexOf(&quot;[\&quot;&quot;) &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +            int startIndex = mvelRule.indexOf(&quot;[\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +            int endIndex = mvelRule.lastIndexOf(&quot;\&quot;]&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +            return mvelRule.substring(startIndex, endIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 328 +            if (mvelRule.contains(&quot;org.apache.commons.lang3.StringUtils.contains&quot;) || mvelRule.contains(&quot;.startsWith&quot;) || mvelRule.contains(&quot;.endsWith&quot;)) {"> 328 +            if (mvelRule.contains(&quot;org.apache.commons.lang3.StringUtils.contains&quot;) || mvelRule.contains(&quot;.startsWiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +                int startIndex = mvelRule.indexOf(&quot;(&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +                int endIndex = mvelRule.indexOf(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +                mvelRule = mvelRule.substring(startIndex + 1, endIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +            mvelRule = getRuleOrPropertyFromFunction(mvelRule);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +            return mvelRule;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +    protected String getRuleOrPropertyFromFunction(String mvelRule) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +        int i = mvelRule.indexOf(&#x27;(&#x27;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +        int j = mvelRule.indexOf(&#x27;)&#x27;, i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +        //no function or maybe just some function? like xxx.xxx.getType()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +        if (i == j || j == i + 1) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +            //expect to have either == or !=</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +            int exclamationMark = mvelRule.indexOf(&quot;!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +            if (exclamationMark &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +                return mvelRule.substring(0, exclamationMark);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +                int equalsSign = mvelRule.indexOf(&quot;=&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +                if (equalsSign &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +                    return mvelRule.substring(0, equalsSign);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +                //unknown format</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +            //looks like some function ?</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +            Pattern pattern = Pattern.compile(&quot;\\([^!=]+\\)&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +            Matcher matcher = pattern.matcher(mvelRule);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +            if (matcher.find()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +                String group = matcher.group();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +                return group.substring(1, group.length() - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +        return mvelRule;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 367 +</span>
 368      protected String getCustomFieldValue(String mvelRule) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -        String customFieldValue = new String();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -        if (isCustomFieldEqualsCheck(mvelRule)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -            int startIndex = mvelRule.indexOf(&quot;==\&quot;&quot;) + 3;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -            int endIndex = mvelRule.lastIndexOf(&quot;\&quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -            customFieldValue = mvelRule.substring(startIndex, endIndex);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -        } else if (isCustomFieldContainsCheck(mvelRule)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +        String customFieldValue = &quot;&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 378 +        if (mvelRule.contains(&quot;.contains&quot;)) {</span>
 379              int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 380              int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);
 381  
 382              customFieldValue = mvelRule.substring(startIndex, endIndex);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 383 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 384 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +        } else if (mvelRule.contains(&quot;==\&quot;&quot;) || mvelRule.contains(&quot;!=\&quot;&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +            int startIndex;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +            int endIndex;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +            if (mvelRule.contains(&quot;toUpperCase&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +                startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +                endIndex = mvelRule.lastIndexOf(&quot;\&quot;)&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +                startIndex = mvelRule.indexOf(&quot;==\&quot;&quot;) + 3;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +                endIndex = mvelRule.lastIndexOf(&quot;\&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 395 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 396 +            customFieldValue = mvelRule.substring(startIndex, endIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 397 +        } else if (mvelRule.contains(&quot;==&quot;) || mvelRule.contains(&quot;!=&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 398 +            int startIndex;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 399 +            int endIndex = mvelRule.length();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 400 +            if (mvelRule.contains(&quot;toUpperCase&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 401 +                startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 402 +                endIndex = mvelRule.indexOf(&quot;\&quot;)&quot;, startIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 403 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 404 +                int i = mvelRule.indexOf(&quot;==&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 405 +                if (i &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 406 +                    startIndex = i + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 407 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 408 +                    startIndex = mvelRule.indexOf(&quot;!=&quot;) + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 409 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 410 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 411 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 412 +            customFieldValue = mvelRule.substring(startIndex, endIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 413 +        } else if (mvelRule.contains(&quot;.startsWith&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 414 +            int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 415 +            int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 416 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 417 +            customFieldValue = mvelRule.substring(startIndex, endIndex).replaceAll(&quot; &quot;, &quot;\\ &quot;) + &quot;*&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +        } else if (mvelRule.contains(&quot;.endsWith&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 419 +            int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 420 +            int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 421 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 422 +            customFieldValue = &quot;*&quot; + mvelRule.substring(startIndex, endIndex).replaceAll(&quot; &quot;, &quot;\\ &quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 423 +        } else if (mvelRule.contains(&quot;==null&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 424 +            // this means we have an &quot;is blank&quot; rule</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 425 +            customFieldValue = &quot;null&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 426 +        } else if (mvelRule.contains(&quot;CollectionUtils&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 427 +            int startIndex = mvelRule.indexOf(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 428 +            int endIndex = mvelRule.indexOf(&quot;)&quot;, startIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 429 +            customFieldValue = mvelRule.substring(startIndex + 1, endIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 430 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 431 +        //maybe it is something like [x,x1,x2]? -&gt; (x,x1,x2), or [x1]-&gt;x1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 432 +        if (customFieldValue.startsWith(&quot;[&quot;) &amp;&amp; customFieldValue.endsWith(&quot;]&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 433 +                customFieldValue = customFieldValue.substring(1, customFieldValue.length() - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 434 +                if(customFieldValue.startsWith(&quot;\&quot;&quot;) &amp;&amp; customFieldValue.endsWith(&quot;\&quot;&quot;)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 435 +                    customFieldValue = customFieldValue.substring(1, customFieldValue.length() - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 436 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 437 +        }</span>
 438          return customFieldValue;
 439      }
 440  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 441 -    protected String buildCustomFieldQuery(String customFieldPropertyName, String customFieldValue) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 442 -        String customFieldQuery;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 443 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 444 -        List&lt;IndexFieldType&gt; indexFieldTypes = indexFieldDao.getIndexFieldTypesByAbbreviationOrPropertyName(customFieldPropertyName);"> 444 -        List&lt;IndexFieldType&gt; indexFieldTypes = indexFieldDao.getIndexFieldTypesByAbbreviationOrPropertyName(customðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 445 -        if (isCustomFieldIndexed(indexFieldTypes)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 446 -            customFieldQuery = &quot;*:*&amp;fq=(&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 447 -            for (IndexFieldType indexFieldType : indexFieldTypes) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 448 -                String type = indexFieldType.getFieldType().getType();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 449 -                String indexFieldName = customFieldPropertyName + &quot;_&quot; + type;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 450 -                String indexFieldValue = &quot;\&quot;&quot; + customFieldValue + &quot;\&quot;&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 451 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 452 -                if (!isFirstItem(customFieldQuery)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 453 -                    customFieldQuery += &quot; OR &quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 454 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 455 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 456 -                customFieldQuery += indexFieldName + &quot;:&quot; + indexFieldValue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 457 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 458 -            customFieldQuery += &quot;)&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 459 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 460 -            customFieldQuery = &quot;&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 461 -            LOG.warn(&quot;The &quot; + customFieldPropertyName + &quot; Custom Field must be indexed with Solr in order &quot; +</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 462 -                    &quot;to gather results based on an MVEL rule.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 463 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 464 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 465 -        return customFieldQuery;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 466 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 467 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 468 -    protected boolean isFirstItem(String customFieldQuery) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 469 -        return customFieldQuery.endsWith(&quot;&amp;fq=(&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 470 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 471 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 472 -    protected boolean isCustomFieldIndexed(List&lt;IndexFieldType&gt; indexFieldTypes) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 473 -        return CollectionUtils.isNotEmpty(indexFieldTypes);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 474 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 475 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 476 -    // Expected Custom Field Rule Formats</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 477 -    // Equals - product.?getProductAttributes()[&quot;custom_field_name&quot;]==&quot;custom field value&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 478 -    // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelper.toUpperCase(&quot;custom field value&quot;))"> 478 -    // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelperðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 479 -    protected boolean isCustomFieldTargetingRule(String mvelRule) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 480 -        boolean isEqualsCheck = isCustomFieldEqualsCheck(mvelRule);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 481 -        boolean isContainsCheck = isCustomFieldContainsCheck(mvelRule);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 482 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 483 -        return isEqualsCheck || isContainsCheck;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 484 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 485 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 486 -    protected boolean isCustomFieldEqualsCheck(String mvelRule) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 487 -        return mvelRule.matches(CUSTOM_FIELD_EQUALS_FORMAT_REGEX);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 488 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 489 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 490 -    protected boolean isCustomFieldContainsCheck(String mvelRule) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 491 -        return mvelRule.matches(CUSTOM_FIELD_CONTAINS_FORMAT_REGEX);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 492 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 493 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 494 -    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()&gt;0"> 494 -    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 495 -    protected boolean isCategoryTargetingRule(String mvelRule) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 496 -        return mvelRule.matches(CATEGORY_FORMAT_REGEX);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 497 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 498 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 499 -    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()&gt;0"> 499 -    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 500 -    protected Long getCategoryId(String mvelRule) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 501 -        int startIndex = mvelRule.indexOf(&quot;[\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 502 -        int endIndex = mvelRule.indexOf(&quot;\&quot;]&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 503 -        String categoryId = mvelRule.substring(startIndex, endIndex);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 504 -        return categoryId == null ? null : Long.parseLong(categoryId);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 505 -    }</span>
 506  
 507  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.search.service.solr;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import org.apache.commons.lang3.StringUtils;</span>
  22  import org.apache.commons.logging.Log;
  23  import org.apache.commons.logging.LogFactory;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import org.broadleafcommerce.core.catalog.domain.Category;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import org.broadleafcommerce.common.locale.domain.Locale;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import org.broadleafcommerce.common.locale.domain.LocaleImpl;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import org.broadleafcommerce.common.locale.service.LocaleService;</span>
  28  import org.broadleafcommerce.core.catalog.service.CatalogService;
  29  import org.broadleafcommerce.core.search.dao.IndexFieldDao;
  30  import org.broadleafcommerce.core.search.domain.IndexFieldType;

  31  import org.broadleafcommerce.core.search.domain.SearchCriteria;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import org.broadleafcommerce.core.search.domain.solr.FieldType;</span>
  33  import org.springframework.stereotype.Service;
  34  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import java.util.Collection;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +import java.util.Collections;</span>
  38  import java.util.List;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +import java.util.regex.Matcher;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import java.util.regex.Pattern;</span>
  41  
  42  import javax.annotation.Resource;
  43  
  44  /**
  45   * Convenience methods for converting simple MVEL rules to Solr SearchCriteria
  46   *
  47   * @author Chris Kittrell (ckittrell)
  48   */
  49  @Service(&quot;blMvelToSearchCriteriaConversionService&quot;)
  50  public class MvelToSearchCriteriaConversionServiceImpl implements MvelToSearchCriteriaConversionService {
  51  
  52      private static final Log LOG = LogFactory.getLog(MvelToSearchCriteriaConversionServiceImpl.class);
  53  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  54 -    public static final String CATEGORY_FORMAT_REGEX = &quot;^CollectionUtils\\.intersection\\(product\\.\\?allParentCategoryIds,\\[\\\&quot;([0-9]+)\\\&quot;\\]\\)\\.size\\(\\)&gt;0$&quot;;">  54 -    public static final String CATEGORY_FORMAT_REGEX = &quot;^CollectionUtils\\.intersection\\(product\\.\\?allParentCaðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  55 -    public static final String CUSTOM_FIELD_EQUALS_FORMAT_REGEX = &quot;^product\\.\\?getProductAttributes\\(\\)\\[\\\&quot;([a-zA-Z0-9_]+)\\\&quot;\\]\\=\\=\\\&quot;([a-zA-Z0-9\\s]+)\\\&quot;$&quot;;">  55 -    public static final String CUSTOM_FIELD_EQUALS_FORMAT_REGEX = &quot;^product\\.\\?getProductAttributes\\(\\)\\[\\\&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  56 -    public static final String CUSTOM_FIELD_CONTAINS_FORMAT_REGEX = &quot;^MvelHelper\\.toUpperCase\\(product\\.\\?getProductAttributes\\(\\)\\[\\\&quot;([a-zA-Z0-9_]+)\\\&quot;\\]\\)\\.contains\\(MvelHelper\\.toUpperCase\\(\\\&quot;([a-zA-Z0-9\\s]+)\\\&quot;\\)\\)$&quot;;">  56 -    public static final String CUSTOM_FIELD_CONTAINS_FORMAT_REGEX = &quot;^MvelHelper\\.toUpperCase\\(product\\.\\?getPðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  57 +    public static final String CATEGORY_FORMAT_REGEX = &quot;^CollectionUtils\\.intersection\\(product\\.\\?allParentCategoryIds,\\[\\\&quot;([0-9]+)(,\\\&quot;[0-9]+\\\&quot;)*\\\&quot;\\]\\)\\.size\\(\\)&gt;0$&quot;;">  57 +    public static final String CATEGORY_FORMAT_REGEX = &quot;^CollectionUtils\\.intersection\\(product\\.\\?allParentCaðŸ”µ</abbr></span>
  58  
  59      @Resource(name = &quot;blCatalogService&quot;)
  60      protected CatalogService catalogService;
  61  
  62      @Resource(name = &quot;blIndexFieldDao&quot;)
  63      protected IndexFieldDao indexFieldDao;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +    @Resource(name = &quot;blLocaleService&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +    protected LocaleService localeService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +    @Resource(name=&quot;blSolrHelperService&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +    protected SolrHelperService solrHelperService;</span>
  70  
  71      @Override
  72      public SearchCriteria convert(String mvelRule) {
  73          SearchCriteria criteria = new SearchCriteria();
  74          criteria.setPageSize(Integer.MAX_VALUE);
  75  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -        if (isCustomFieldTargetingRule(mvelRule)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -            String customFieldQuery = buildCustomFieldQuery(mvelRule);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -            criteria.setQuery(customFieldQuery);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -        } else if (isCategoryTargetingRule(mvelRule)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -            Long categoryId = getCategoryId(mvelRule);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -            Category category = catalogService.findCategoryById(categoryId);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -            criteria.setCategory(category);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -            throw new UnsupportedOperationException(&quot;The provided MVEL rule format is not currently supported &quot; +</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -                    &quot;for MVEL to Solr Search Criteria conversion.&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +        if (isProductRule(mvelRule) || isCategoryTargetingRule(mvelRule)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +            Collection&lt;String&gt; strings = convertRuleToFilters(mvelRule);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +            criteria.setFilterQueries(strings);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +        }else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +            throw new UnsupportedOperationException(&quot;The selected Add-On Product Group is defined using Rules &quot; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +                    &quot;(Conditional Rules) and selected rule can&#x27;t be translated to solr criteria and so &quot; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +                    &quot;does not support selection of a Default Product. See Tooltip for supported rule details&quot;);</span>
  93          }
  94  
  95          return criteria;
  96      }
  97  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -    protected String buildCustomFieldQuery(String mvelRule) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -        String customFieldPropertyName = getCustomFieldPropertyName(mvelRule);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -        String customFieldValue = getCustomFieldValue(mvelRule);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -        return buildCustomFieldQuery(customFieldPropertyName, customFieldValue);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +    protected boolean isProductRule(String rule){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        return rule.contains(&quot;product.&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +    protected boolean isCustomFieldIndexed(List&lt;IndexFieldType&gt; indexFieldTypes) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +        return CollectionUtils.isNotEmpty(indexFieldTypes);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 111 +    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()&gt;0"> 111 +    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +    protected boolean isCategoryTargetingRule(String mvelRule) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +        return mvelRule.matches(CATEGORY_FORMAT_REGEX);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 116 +    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;,...]).size()&gt;0"> 116 +    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;,...]).siðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +    protected Long[] getCategoryIds(String mvelRule) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +        int startIndex = mvelRule.indexOf(&quot;[\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        int endIndex = mvelRule.indexOf(&quot;\&quot;]&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +        String categoryId = mvelRule.substring(startIndex, endIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +        //how about multivalue ?</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +        String[] split = categoryId.split(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +        Long[] result = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +        int length = split.length;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +        if (length &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +            result = new Long[length];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +            for (int i = 0; i &lt; length; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +                result[i] = Long.parseLong(split[i].replace(&quot;\&quot;&quot;,&quot;&quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        return result;</span>
 132      }
 133  
 134      // Expected Custom Field Rule Formats
 135      // Equals - product.?getProductAttributes()[&quot;custom_field_name&quot;]==&quot;custom field value&quot;
<abbr title=" 136      // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelper.toUpperCase(&quot;custom field value&quot;))"> 136      // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelperðŸ”µ</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +    // Also supports string property contains, not contains, starts with, ends with etc.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +    protected Collection&lt;String&gt; convertRuleToFilters(String matchRule) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +        List&lt;String&gt; filters = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +        boolean allRulesMustBeTrue = !matchRule.contains(&quot;||&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +        String[] fragments;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +        if (allRulesMustBeTrue) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +            fragments = StringUtils.split(matchRule, &quot;&amp;&amp;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +            fragments = StringUtils.split(matchRule, &quot;||&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +        for (String fragment : fragments) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +            if (isCategoryTargetingRule(fragment)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +                Long[] categoryIds = getCategoryIds(fragment);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +                if (categoryIds != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +                    String explicitCategoryFieldName = solrHelperService.getExplicitCategoryFieldName();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +                    StringBuilder categoryFilter = new StringBuilder(explicitCategoryFieldName + &quot;:(\&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +                    for (int i = 0; i &lt; categoryIds.length; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +                        Long catId = solrHelperService.getCategoryId(categoryIds[i]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +                        categoryFilter.append(catId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +                        if (i + 1 &lt; categoryIds.length) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +                            categoryFilter.append(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +                    categoryFilter.append(&quot;\&quot;)&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +                    filters.add(categoryFilter.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +                String fieldName = getCustomFieldPropertyName(fragment);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +                String fieldValue = getCustomFieldValue(fragment);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +                boolean exclude = fragment.contains(&quot;!=&quot;) || fragment.startsWith(&quot;!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +                boolean isWildCardSearch = isWildCardSearch(fieldValue);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +                fieldName = convertFieldName(fieldName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 172 +                List&lt;IndexFieldType&gt; indexFieldTypes = indexFieldDao.getIndexFieldTypesByAbbreviationOrPropertyName(fieldName);"> 172 +                List&lt;IndexFieldType&gt; indexFieldTypes = indexFieldDao.getIndexFieldTypesByAbbreviationOrPropertyNamðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +                if (indexFieldTypes.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +                    Boolean translatable = indexFieldTypes.get(0).getIndexField().getField().getTranslatable();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +                    List&lt;Locale&gt; allLocales;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +                    if (translatable==null || !translatable) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +                        allLocales = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +                        LocaleImpl e = new LocaleImpl();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +                        e.setLocaleCode(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +                        allLocales.add(e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +                    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +                        allLocales = localeService.findAllLocales();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +                    List&lt;String&gt; tmpFilters = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +                    String abbreviation = indexFieldTypes.get(0).getIndexField().getField().getAbbreviation();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +                    for (Locale locale : allLocales) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +                        for (IndexFieldType indexFieldType : indexFieldTypes) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +                            String type = indexFieldType.getFieldType().getType();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +                            if (!isWildCardSearch || FieldType.STRING.getType().equals(type)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +                                String prefix;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +                                if (StringUtils.isNotEmpty(locale.getLocaleCode())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +                                    prefix = locale.getLocaleCode() + &quot;_&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +                                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +                                    prefix = &quot;&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +                                String indexFieldName = prefix + abbreviation + &quot;_&quot; + type;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 198 +                                // if this is a wildcard search then we do not want to surround the value with quotes"> 198 +                                // if this is a wildcard search then we do not want to surround the value with quoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +                                String indexFieldValue = fieldValue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +                                if (!isWildCardSearch &amp;&amp; !fieldValue.equals(&quot;null&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +                                    if(fieldValue.contains(&quot;\&quot;,\&quot;&quot;)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +                                        indexFieldValue = &quot;(\&quot;&quot; + fieldValue + &quot;\&quot;)&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +                                    }else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +                                        indexFieldValue = &quot;\&quot;&quot; + fieldValue + &quot;\&quot;&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +                                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +                                String filter;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +                                if (indexFieldValue.equals(&quot;null&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +                                    // this is for checking if null or non-existent fields</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +                                    filter = &quot;(*:* AND -&quot; + indexFieldName + &quot;:[* TO *])&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +                                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +                                    filter = indexFieldName + &quot;:&quot; + indexFieldValue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +                                if (exclude) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +                                    filter = &quot;NOT &quot; + filter;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +                                tmpFilters.add(filter);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +                    if (!exclude) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 226 +                        //any of translation and type fields like en_name_tsy, en_name_s etc can match, so concatinate with OR"> 226 +                        //any of translation and type fields like en_name_tsy, en_name_s etc can match, so concatiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +                        String s = tmpFilters.get(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +                        s = &quot;(&quot; + s;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +                        tmpFilters.set(0, s);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +                        int size = tmpFilters.size() - 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +                        String s1 = tmpFilters.get(size);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +                        s1 = s1 + &quot;)&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +                        tmpFilters.set(size, s1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +                        filters.add(StringUtils.join(tmpFilters, &quot; OR &quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +                    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +                        //if we exclude we don&#x27;t want to see if at all so &quot;AND&quot; is ok</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +                        filters.addAll(tmpFilters);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +                    if (org.apache.commons.collections4.CollectionUtils.isEmpty(indexFieldTypes)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +                        if (fieldName.contains(&quot;catalogDiscriminator&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +                            String substring = fieldValue.substring(1, fieldValue.length() - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +                            filters.add(&quot;catalog_s:(&quot; + substring + &quot;)&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +                    return Collections.emptyList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +        if (allRulesMustBeTrue) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +            return filters;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +            return Collections.singletonList(StringUtils.join(filters, &quot; OR &quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +    protected String convertFieldName(String fieldName) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +        String result = fieldName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +        if (fieldName.startsWith(&quot;product.&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +            result = fieldName.substring(&quot;product.&quot;.length());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +        if (result.endsWith(&quot;()&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +            result = parseMethod(result);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +        result = result.replaceAll(&quot;\\?&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +        return result;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +     * Takes in a fieldName that contains a method (indicated with &quot;()&quot;) and converts the method to an attribute.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +     * Currently supports getX() methods</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +     * For example, getType() -&gt; type</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +     * @param fieldName</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +     * @return</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +    protected String parseMethod(String fieldName) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +        String[] segments = fieldName.split(&quot;\\.&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +        //parse the last segment removing the method prefix (e.g. get)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +        String methodSegment = segments[segments.length-1].replaceFirst(&quot;(^get)&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +        //lowercase first char and remove the ()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 282 +        segments[segments.length - 1] = Character.toLowerCase(methodSegment.charAt(0)) + methodSegment.substring(1, methodSegment.length() - 2);"> 282 +        segments[segments.length - 1] = Character.toLowerCase(methodSegment.charAt(0)) + methodSegment.substring(1ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +        return String.join(&quot;.&quot;, segments);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +     * Determines if the given field value string represents a wild card search. In Solr a wild card search either</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +     * starts or ends with an asterisk.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +     * @param fieldValue the String field value</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +     * @return whether the value is for a wildcard search</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +    protected boolean isWildCardSearch(String fieldValue) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +        return fieldValue.startsWith(&quot;*&quot;) || fieldValue.endsWith(&quot;*&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +</span>








 297      protected String getCustomFieldPropertyName(String mvelRule) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -        int startIndex = mvelRule.indexOf(&quot;[\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -        int endIndex = mvelRule.lastIndexOf(&quot;\&quot;]&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -        return mvelRule.substring(startIndex, endIndex);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -    // Expected Custom Field Rule Formats</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 305 -    // Equals - product.?getProductAttributes()[&quot;custom_field_name&quot;]==&quot;custom field value&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 306 -    // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelper.toUpperCase(&quot;custom field value&quot;))"> 306 -    // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelperðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +        if (mvelRule.contains(&quot;CollectionUtils&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +            //assuming left param is field, right is value</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +            int startIndex = mvelRule.indexOf(&quot;(&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +            int endIndex = mvelRule.indexOf(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +            mvelRule = mvelRule.substring(startIndex + 1, endIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 313 +        if (mvelRule.indexOf(&quot;[\&quot;&quot;) &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 314 +            int startIndex = mvelRule.indexOf(&quot;[\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 315 +            int endIndex = mvelRule.lastIndexOf(&quot;\&quot;]&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +            return mvelRule.substring(startIndex, endIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 319 +            if (mvelRule.contains(&quot;org.apache.commons.lang3.StringUtils.contains&quot;) || mvelRule.contains(&quot;.startsWith&quot;) || mvelRule.contains(&quot;.endsWith&quot;)) {"> 319 +            if (mvelRule.contains(&quot;org.apache.commons.lang3.StringUtils.contains&quot;) || mvelRule.contains(&quot;.startsWiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +                int startIndex = mvelRule.indexOf(&quot;(&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +                int endIndex = mvelRule.indexOf(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +                mvelRule = mvelRule.substring(startIndex + 1, endIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +            mvelRule = getRuleOrPropertyFromFunction(mvelRule);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +            return mvelRule;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +    protected String getRuleOrPropertyFromFunction(String mvelRule) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +        int i = mvelRule.indexOf(&#x27;(&#x27;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +        int j = mvelRule.indexOf(&#x27;)&#x27;, i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +        //no function or maybe just some function? like xxx.xxx.getType()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +        if (i == j || j == i + 1) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +            //expect to have either == or !=</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +            int exclamationMark = mvelRule.indexOf(&quot;!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +            if (exclamationMark &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +                return mvelRule.substring(0, exclamationMark);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +                int equalsSign = mvelRule.indexOf(&quot;=&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +                if (equalsSign &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +                    return mvelRule.substring(0, equalsSign);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +                //unknown format</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +            //looks like some function ?</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +            Pattern pattern = Pattern.compile(&quot;\\([^!=]+\\)&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +            Matcher matcher = pattern.matcher(mvelRule);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +            if (matcher.find()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +                String group = matcher.group();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +                return group.substring(1, group.length() - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +        return mvelRule;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +</span>
 359      protected String getCustomFieldValue(String mvelRule) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -        String customFieldValue = new String();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -        if (isCustomFieldEqualsCheck(mvelRule)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -            int startIndex = mvelRule.indexOf(&quot;==\&quot;&quot;) + 3;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -            int endIndex = mvelRule.lastIndexOf(&quot;\&quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -            customFieldValue = mvelRule.substring(startIndex, endIndex);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 367 -        } else if (isCustomFieldContainsCheck(mvelRule)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 368 +        String customFieldValue = &quot;&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 369 +        if (mvelRule.contains(&quot;.contains&quot;)) {</span>
 370              int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;
 371              int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);
 372  
 373              customFieldValue = mvelRule.substring(startIndex, endIndex);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 376 +        } else if (mvelRule.contains(&quot;==\&quot;&quot;) || mvelRule.contains(&quot;!=\&quot;&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +            int startIndex;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 378 +            int endIndex;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +            if (mvelRule.contains(&quot;toUpperCase&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 380 +                startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 381 +                endIndex = mvelRule.lastIndexOf(&quot;\&quot;)&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 382 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +                startIndex = mvelRule.indexOf(&quot;==\&quot;&quot;) + 3;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 384 +                endIndex = mvelRule.lastIndexOf(&quot;\&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +            customFieldValue = mvelRule.substring(startIndex, endIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +        } else if (mvelRule.contains(&quot;==&quot;) || mvelRule.contains(&quot;!=&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +            int startIndex;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +            int endIndex = mvelRule.length();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +            if (mvelRule.contains(&quot;toUpperCase&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +                startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +                endIndex = mvelRule.indexOf(&quot;\&quot;)&quot;, startIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 395 +                int i = mvelRule.indexOf(&quot;==&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 396 +                if (i &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 397 +                    startIndex = i + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 398 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 399 +                    startIndex = mvelRule.indexOf(&quot;!=&quot;) + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 400 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 401 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 402 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 403 +            customFieldValue = mvelRule.substring(startIndex, endIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 404 +        } else if (mvelRule.contains(&quot;.startsWith&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 405 +            int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 406 +            int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 407 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 408 +            customFieldValue = mvelRule.substring(startIndex, endIndex).replaceAll(&quot; &quot;, &quot;\\ &quot;) + &quot;*&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 409 +        } else if (mvelRule.contains(&quot;.endsWith&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 410 +            int startIndex = mvelRule.lastIndexOf(&quot;(\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 411 +            int endIndex = mvelRule.lastIndexOf(&quot;\&quot;))&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 412 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 413 +            customFieldValue = &quot;*&quot; + mvelRule.substring(startIndex, endIndex).replaceAll(&quot; &quot;, &quot;\\ &quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 414 +        } else if (mvelRule.contains(&quot;==null&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 415 +            // this means we have an &quot;is blank&quot; rule</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 416 +            customFieldValue = &quot;null&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 417 +        } else if (mvelRule.contains(&quot;CollectionUtils&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +            int startIndex = mvelRule.indexOf(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 419 +            int endIndex = mvelRule.indexOf(&quot;)&quot;, startIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 420 +            customFieldValue = mvelRule.substring(startIndex + 1, endIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 421 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 422 +        //maybe it is something like [x,x1,x2]? -&gt; (x,x1,x2), or [x1]-&gt;x1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 423 +        if (customFieldValue.startsWith(&quot;[&quot;) &amp;&amp; customFieldValue.endsWith(&quot;]&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 424 +                customFieldValue = customFieldValue.substring(1, customFieldValue.length() - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 425 +                if(customFieldValue.startsWith(&quot;\&quot;&quot;) &amp;&amp; customFieldValue.endsWith(&quot;\&quot;&quot;)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 426 +                    customFieldValue = customFieldValue.substring(1, customFieldValue.length() - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 427 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 428 +        }</span>
 429          return customFieldValue;
 430      }
 431  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 432 -    protected String buildCustomFieldQuery(String customFieldPropertyName, String customFieldValue) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 433 -        String customFieldQuery;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 434 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 435 -        List&lt;IndexFieldType&gt; indexFieldTypes = indexFieldDao.getIndexFieldTypesByAbbreviationOrPropertyName(customFieldPropertyName);"> 435 -        List&lt;IndexFieldType&gt; indexFieldTypes = indexFieldDao.getIndexFieldTypesByAbbreviationOrPropertyName(customðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 436 -        if (isCustomFieldIndexed(indexFieldTypes)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 437 -            customFieldQuery = &quot;*:*&amp;fq=(&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 438 -            for (IndexFieldType indexFieldType : indexFieldTypes) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 439 -                String type = indexFieldType.getFieldType().getType();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 440 -                String indexFieldName = customFieldPropertyName + &quot;_&quot; + type;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 441 -                String indexFieldValue = &quot;\&quot;&quot; + customFieldValue + &quot;\&quot;&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 442 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 443 -                if (!isFirstItem(customFieldQuery)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 444 -                    customFieldQuery += &quot; OR &quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 445 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 446 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 447 -                customFieldQuery += indexFieldName + &quot;:&quot; + indexFieldValue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 448 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 449 -            customFieldQuery += &quot;)&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 450 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 451 -            customFieldQuery = &quot;&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 452 -            LOG.warn(&quot;The &quot; + customFieldPropertyName + &quot; Custom Field must be indexed with Solr in order &quot; +</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 453 -                    &quot;to gather results based on an MVEL rule.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 454 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 455 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 456 -        return customFieldQuery;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 457 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 458 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 459 -    protected boolean isFirstItem(String customFieldQuery) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 460 -        return customFieldQuery.endsWith(&quot;&amp;fq=(&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 461 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 462 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 463 -    protected boolean isCustomFieldIndexed(List&lt;IndexFieldType&gt; indexFieldTypes) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 464 -        return CollectionUtils.isNotEmpty(indexFieldTypes);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 465 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 466 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 467 -    // Expected Custom Field Rule Formats</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 468 -    // Equals - product.?getProductAttributes()[&quot;custom_field_name&quot;]==&quot;custom field value&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 469 -    // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelper.toUpperCase(&quot;custom field value&quot;))"> 469 -    // Contains - MvelHelper.toUpperCase(product.?getProductAttributes()[&quot;custom_field_name&quot;]).contains(MvelHelperðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 470 -    protected boolean isCustomFieldTargetingRule(String mvelRule) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 471 -        boolean isEqualsCheck = isCustomFieldEqualsCheck(mvelRule);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 472 -        boolean isContainsCheck = isCustomFieldContainsCheck(mvelRule);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 473 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 474 -        return isEqualsCheck || isContainsCheck;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 475 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 476 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 477 -    protected boolean isCustomFieldEqualsCheck(String mvelRule) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 478 -        return mvelRule.matches(CUSTOM_FIELD_EQUALS_FORMAT_REGEX);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 479 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 480 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 481 -    protected boolean isCustomFieldContainsCheck(String mvelRule) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 482 -        return mvelRule.matches(CUSTOM_FIELD_CONTAINS_FORMAT_REGEX);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 483 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 484 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 485 -    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()&gt;0"> 485 -    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 486 -    protected boolean isCategoryTargetingRule(String mvelRule) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 487 -        return mvelRule.matches(CATEGORY_FORMAT_REGEX);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 488 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 489 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 490 -    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()&gt;0"> 490 -    // Expected Category Rule Format - CollectionUtils.intersection(product.?allParentCategoryIds,[&quot;2002&quot;]).size()ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 491 -    protected Long getCategoryId(String mvelRule) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 492 -        int startIndex = mvelRule.indexOf(&quot;[\&quot;&quot;) + 2;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 493 -        int endIndex = mvelRule.indexOf(&quot;\&quot;]&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 494 -        String categoryId = mvelRule.substring(startIndex, endIndex);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 495 -        return categoryId == null ? null : Long.parseLong(categoryId);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 496 -    }</span>
 497  
 498  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            