<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>144</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    144
                    <a href="143.html">prev</a>
                    <a href="145.html">next</a>
                    <a href="144_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_43bc5971257bc0b34863e0fb492c7371153eda52_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;43bc5971257bc0b34863e0fb492c7371153eda52:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;43bc5971257bc0b34863e0fb492c7371153eda52^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;43bc5971257bc0b34863e0fb492c7371153eda52^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;68d0a170f9399845027214d6e8e6e30c591900dd:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.Transformer;
  22 import org.apache.commons.logging.Log;
  23 import org.apache.commons.logging.LogFactory;
  24 import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;
  25 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  26 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  27 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  28 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  29 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  30 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  31 import org.broadleafcommerce.core.offer.dao.OfferDao;
  32 import org.broadleafcommerce.core.offer.domain.*;
  33 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  34 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  35 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  36 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  37 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  38 import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;
  39 import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;
  40 import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;
  41 import org.broadleafcommerce.core.offer.service.type.OfferType;
  42 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  43 import org.broadleafcommerce.core.order.domain.Order;
  44 import org.broadleafcommerce.core.order.domain.OrderItem;
  45 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  46 import org.broadleafcommerce.core.order.service.OrderService;
  47 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  48 import org.broadleafcommerce.profile.core.domain.Customer;
  49 import org.springframework.stereotype.Service;
  50 import org.springframework.transaction.annotation.Transactional;
  51 
  52 import java.util.ArrayList;
  53 import java.util.Collection;
  54 import java.util.HashMap;
  55 import java.util.HashSet;
  56 import java.util.Iterator;
  57 import java.util.List;
  58 import java.util.Map;
  59 import java.util.Objects;
  60 import java.util.Set;
  61 
  62 import javax.annotation.Resource;
  63 import javax.persistence.EntityManager;
  64 import javax.persistence.PersistenceContext;
  65 
  66 /**
  67  * The Class OfferServiceImpl.
  68  */
  69 @Service(&quot;blOfferService&quot;)
  70 public class OfferServiceImpl implements OfferService {
  71     
  72     private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);
  73 
  74     // should be called outside of Offer service after Offer service is executed
  75     @Resource(name=&quot;blCustomerOfferDao&quot;)
  76     protected CustomerOfferDao customerOfferDao;
  77 
  78     @Resource(name=&quot;blOfferCodeDao&quot;)
  79     protected OfferCodeDao offerCodeDao;
  80     
  81     @Resource(name=&quot;blOfferAuditService&quot;)
  82     protected OfferAuditService offerAuditService;
  83 
  84     @Resource(name=&quot;blOfferDao&quot;)
  85     protected OfferDao offerDao;
  86     
  87     @Resource(name=&quot;blOrderOfferProcessor&quot;)
  88     protected OrderOfferProcessor orderOfferProcessor;
  89     
  90     @Resource(name=&quot;blItemOfferProcessor&quot;)
  91     protected ItemOfferProcessor itemOfferProcessor;
  92     
  93     @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)
  94     protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;
  95     
  96     @Resource(name=&quot;blPromotableItemFactory&quot;)
  97     protected PromotableItemFactory promotableItemFactory;
  98 
  99     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
 100     protected OfferServiceExtensionManager extensionManager;
 101 
 102     @Resource(name = &quot;blOrderService&quot;)
 103     protected OrderService orderService;
 104 
 105     @Resource(name = &quot;blSandBoxHelper&quot;)
 106     protected SandBoxHelper sandBoxHelper;
 107 
 108     @PersistenceContext(unitName=&quot;blPU&quot;)
 109     protected EntityManager em;
 110 
 111     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 112     protected StreamingTransactionCapableUtil transUtil;
 113 
 114     @Resource(name=&quot;blEntityDuplicator&quot;)
 115     protected EntityDuplicator duplicator;
 116 
 117     @Resource(name=&quot;blOfferDuplicateModifier&quot;)
 118     protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;
 119 
 120     @Override
 121     public List&lt;Offer&gt; findAllOffers() {
 122         return offerDao.readAllOffers();
 123     }
 124 
 125     @Override
 126     @Transactional(&quot;blTransactionManager&quot;)
 127     public Offer save(Offer offer) {
 128         return offerDao.save(offer);
 129     }
 130 
 131     @Override
 132     @Transactional(&quot;blTransactionManager&quot;)
 133     public OfferCode saveOfferCode(OfferCode offerCode) {
 134         offerCode.setOffer(offerDao.save(offerCode.getOffer()));
 135         return offerCodeDao.save(offerCode);
 136     }
 137 
 138     /**
<abbr title=" 139      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 139      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr>
<abbr title=" 140      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 140      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr>
 141      * cannot appear more than once in the list.
 142      *
 143      * @param code
 144      * @return a List of offers that may apply to this order
 145      */
 146     @Override
 147     public Offer lookupOfferByCode(String code) {
 148         Offer offer = null;
 149         OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);
 150         if (offerCode != null) {
 151             offer = offerCode.getOffer();
 152         }
 153         return offer;
 154     }
 155     
 156     @Override
 157     public OfferCode lookupOfferCodeByCode(String code){
 158         return offerCodeDao.readOfferCodeByCode(code);
 159     }
 160 
 161     @Override
 162     public List&lt;Offer&gt; lookupAllOffersByCode(String code) {
 163         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 164         List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);
 165         for (OfferCode offerCode : offerCodes) {
 166             if (offerCode != null) {
 167                 offers.add(offerCode.getOffer());
 168             }
 169         }
 170         return offers;
 171     }
 172 
 173     @Override
 174     public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){
 175         return offerCodeDao.readAllOfferCodesByCode(code);
 176     }
 177 
 178     /**
<abbr title=" 179      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 179      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr>
<abbr title=" 180      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 180      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr>
 181      * cannot appear more than once in the list.
 182      *
 183      * @param order
 184      * @return a List of offers that may apply to this order
 185      */
 186     @Override
 187     public List&lt;Offer&gt; buildOfferListForOrder(Order order) {
 188         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 189         List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());
 190         for (CustomerOffer customerOffer : customerOffers) {
 191             if (!offers.contains(customerOffer.getOffer())) {
 192                 offers.add(customerOffer.getOffer());
 193             }
 194         }
 195         List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);
 196 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197 //        int before = orderOfferCodes.size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198 //        orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199 /*        int after = orderOfferCodes.size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 200         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 200         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201         if(o !=null &amp;&amp; (Boolean)o &amp;&amp; before!=after){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 202             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 202             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203         }*/</span>
 204 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205             if (!offers.contains(customerOffer.getOffer())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206                 offers.add(customerOffer.getOffer());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209         List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210         int before = orderOfferCodes.size();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);</span>
 212 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);</span>
 214 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 215         for (OfferCode orderOfferCode : orderOfferCodes) {
 216             if (!offers.contains(orderOfferCode.getOffer())) {
 217                 offers.add(orderOfferCode.getOffer());
 218             }
 219             extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);
 220         }
 221         List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();
 222         for (Offer globalOffer : globalOffers) {
 223             if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {
 224                 offers.add(globalOffer);
 225             }
 226         }
 227         
 228         if (extensionManager != null) {
 229             extensionManager.applyAdditionalFilters(offers, order);
 230         }
 231         
 232         return offers;
 233     }
 234 
 235     @Override
 236     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {
 237         Customer customer = order.getCustomer();
 238         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();
 239         
 240         if (extensionManager != null) {
 241             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 242         }
 243         if (!offerCodes.isEmpty()) {
 244             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 245             while (itr.hasNext()) {
 246                 OfferCode offerCode = itr.next();
 247                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {
 248                     itr.remove();
 249                 }
 250             }
 251         }
 252         return offerCodes;
 253     }
 254     
 255     @Deprecated
 256     @Override
 257     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {
 258         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();
 259         if (extensionManager != null) {
 260             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 261         }
 262         if (!offerCodes.isEmpty()) {
 263             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 264             while (itr.hasNext()) {
 265                 OfferCode offerCode = itr.next();
 266                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {
 267                     itr.remove();
 268                 }
 269             }
 270         }
 271         return offerCodes;
 272     }
 273 
 274     /**
 275      * Private method used to retrieve all offers assigned to this customer.  These offers are
 276      * programmatically assigned to the customer.
 277      *
 278      * @param customer
 279      * @return a List of offers assigned to the customer
 280      */
 281     protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {
 282         List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);
 283         return offerCustomers;
 284     }
 285 
 286     /**
 287      * Private method used to retrieve all offers with automaticallyAdded set to true
 288      *
 289      * @return a List of automatic delivery offers
 290      */
 291     protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {
 292         List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();
 293         return globalOffers;
 294     }
 295 
 296     /**
 297      * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end
 298      * date.  If an offerCode has a later start date, that offerCode will be removed.
 299      * OfferCodes without a start date will still be processed. If the offerCode
 300      * has a end date that has already passed, that offerCode will be removed.  OfferCodes
 301      * without a end date will be processed.  The start and end dates on the offer will
 302      * still need to be evaluated.
 303      *
 304      * @param offerCodes
 305      * @return a List of non-expired offers
 306      */
 307     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){
 308         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();
 309         for (OfferCode offerCode : offerCodes) {
 310             if (!offerCode.isActive()){
 311                 offerCodesToRemove.add(offerCode);
 312             }
 313         }
 314         // remove all offers in the offersToRemove list from original offers list
 315         for (OfferCode offerCode : offerCodesToRemove) {
 316             offerCodes.remove(offerCode);
 317         }
 318         return offerCodes;
 319     }
 320 
<abbr title=" 321     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodesAndOffers(List&lt;OfferCode&gt; offerCodes, List&lt;Offer&gt; offers){"> 321     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodesAndOffers(List&lt;OfferCode&gt; offerCodes, List&lt;Offer&gt; ðŸ”µ</abbr>
 322         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();
 323         for (OfferCode offerCode : offerCodes) {
 324             if (!offerCode.isActive()){
 325                 offerCodesToRemove.add(offerCode);
 326             }
 327         }
 328         // remove all offers in the offersToRemove list from original offers list
 329         for (OfferCode offerCode : offerCodesToRemove) {
 330             offerCodes.remove(offerCode);
 331             offers.remove(offerCode.getOffer());
 332         }
 333         return offerCodes;
 334     }
 335 
 336     /**
 337      * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with
 338      * current sandbox status.
 339      *
 340      * @param order the order to check
 341      * @return the refreshed list of OfferCodes
 342      */
 343     protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {
 344         final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();
 345 
 346         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 347             @Override
 348             public void execute() {
 349                 for (OfferCode offerCode : orderOfferCodes) {
 350                     if (offerCode.getOffer() != null) {
<abbr title=" 351                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 351                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCðŸ”µ</abbr>
<abbr title=" 352                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 352                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOfðŸ”µ</abbr>
 353                             em.refresh(offerCode);
 354                         }
 355                     }
 356                 }
 357             }
 358 
 359             @Override
 360             public boolean shouldRetryOnTransactionLockAcquisitionFailure() {
 361                 return true;
 362             }
 363         }, RuntimeException.class);
 364 
 365         return orderOfferCodes;
 366     }
 367 
 368     /*
 369      *
 370      * Offers Logic:
 371      * 1) Remove all existing offers in the Order (order, item, and fulfillment)
 372      * 2) Check and remove offers
 373      *    a) Remove out of date offers
 374      *    b) Remove offers that do not apply to this customer
 375      * 3) Loop through offers
 376      *    a) Verifies type of offer (order, order item, fulfillment)
 377      *    b) Verifies if offer can be applies
 378      *    c) Assign offer to type (order, order item, or fulfillment)
 379      * 4) Sorts the order and item offers list by priority and then discount
 380      * 5) Identify the best offers to apply to order item and create adjustments for each item offer
<abbr title=" 381      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better"> 381      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is betðŸ”µ</abbr>
 382      * 7) Identify the best offers to apply to the order and create adjustments for each order offer
<abbr title=" 383      * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 383      * 8) If item contains non-combinable offers remove either the item or order adjustments based on disðŸ”µ</abbr>
 384      * 9) Set final order item prices and reapply order offers
 385      *
 386      * Assumptions:
 387      * 1) % off all items will be created as an item offer with no expression
 388      * 2) $ off order will be created as an order offer
 389      * 3) Order offers applies to the best price for each item (not just retail price)
 390      * 4) Fulfillment offers apply to best price for each item (not just retail price)
<abbr title=" 391      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 391      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used witðŸ”µ</abbr>
 392      * 6) Fulfillment offers cannot be not combinable
 393      * 7) Order offers cannot be FIXED_PRICE
 394      * 8) FIXED_PRICE offers cannot be stackable
<abbr title=" 395      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 395      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will alðŸ”µ</abbr>
 396      *
 397      */
 398     @Override
 399     @Transactional(&quot;blTransactionManager&quot;)
 400     public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 401         /*
 402         TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to
 403         use a richer object to describe the parameters of the pricing call. This object would include
 404         the pricing boolean, but would also include a list of activities to include or exclude in the
 405         call - see http://jira.broadleafcommerce.org/browse/BLC-664
 406          */
<abbr title=" 407         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 407         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINðŸ”µ</abbr>
 408         int offerCount = 0;
 409         if(o!=null &amp;&amp; (Boolean)o){
 410             if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())){
 411                 for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {
 412                     if(orderAdjustment.getOffer()!=null){
 413                         offerCount++;
 414                     }
 415                 }
 416             }
 417         }
 418         OfferContext offerContext = OfferContext.getOfferContext();
 419         if (offerContext == null || offerContext.executePromotionCalculation) {
 420             PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false);
 421             List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);
 422             removeOutOfDateOfferCodesAndOffers(orderOfferCodes, offers);
 423             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());
 424             if ((filteredOffers == null) || (filteredOffers.isEmpty())) {
 425                 if (LOG.isTraceEnabled()) {
 426                     LOG.trace(&quot;No offers applicable to this order.&quot;);
 427                 }
 428             } else {
<abbr title=" 429                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 429                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidðŸ”µ</abbr>
<abbr title=" 430                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 430                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
 431 
<abbr title=" 432                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 432                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, quðŸ”µ</abbr>
 433 
<abbr title=" 434                 if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {                "> 434                 if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {               ðŸ”µ</abbr>
<abbr title=" 435                     // At this point, we should have a PromotableOrder that contains PromotableItems each of which"> 435                     // At this point, we should have a PromotableOrder that contains PromotableItems eachðŸ”µ</abbr>
 436                     // has a list of candidatePromotions that might be applied.
 437 
<abbr title=" 438                     // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 438                     // We also have a list of orderOffers that might apply and a list of itemOffers that ðŸ”µ</abbr>
<abbr title=" 439                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 439                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOðŸ”µ</abbr>
 440                 }
 441             }
 442             orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 443             
 444             verifyAdjustments(order, true);
 445             
 446             order.setSubTotal(order.calculateSubTotal());
 447             order.finalizeItemPrices();
 448             
 449             order = orderService.save(order, false);
 450             
 451             boolean madeChange = verifyAdjustments(order, false);
 452             if (madeChange) {
 453                 order = orderService.save(order, false);
 454             }
 455             int offerCountAfter=0;
 456             if(o!=null &amp;&amp; (Boolean)o){
<abbr title=" 457                 if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())){"> 457                 if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments()ðŸ”µ</abbr>
 458                     for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {
 459                         if(orderAdjustment.getOffer()!=null){
 460                             offerCountAfter++;
 461                         }
 462                     }
 463                 }
 464                 if(offerCountAfter!=offerCount){
<abbr title=" 465                     BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 465                     BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfðŸ”µ</abbr>
 466                 }
 467             }
 468         }
 469 
 470         return order;
 471     }
 472     
 473     protected boolean verifyAdjustments(Order order, boolean beforeSave) {
 474         boolean madeChange = false;
 475         
 476         if (order.getOrderItems() == null) {
 477             return madeChange;
 478         }
 479 
 480         for (OrderItem oi : order.getOrderItems()) {
 481             if (oi.getOrderItemPriceDetails() == null) {
 482                 continue;
 483             }
 484 
 485             for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {
 486                 if (pd.getOrderItemPriceDetailAdjustments() == null) {
 487                     continue;
 488                 }
 489 
<abbr title=" 490                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 490                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdðŸ”µ</abbr>
<abbr title=" 491                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 491                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDeðŸ”µ</abbr>
 492                 for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {
 493                     if (adjs.containsKey(adj.getOffer().getId())) {
 494                         adjustmentsToRemove.add(adj);
 495                         if (LOG.isDebugEnabled()) {
 496                             StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)
 497                                 .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)
 498                                 .append(&quot; with ids &quot;)
 499                                 .append(adjs.get(adj.getOffer().getId()).getId())
 500                                 .append(&quot; and &quot;)
 501                                 .append(adj.getId());
 502                             LOG.debug(sb.toString());
 503                         }
 504                     } else {
 505                         adjs.put(adj.getOffer().getId(), adj);
 506                     }
 507                 }
 508                 
 509                 for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {
 510                     pd.getOrderItemPriceDetailAdjustments().remove(adj);
 511                     madeChange = true;
 512                 }
 513             }
 514         }
 515 
 516         return madeChange;
 517      }
 518 
 519     @Override
 520     @Transactional(&quot;blTransactionManager&quot;)
 521     @Deprecated
 522     public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 523         applyAndSaveOffersToOrder(offers, order);
 524     }
 525 
 526     @Override
 527     @Transactional(&quot;blTransactionManager&quot;)
 528     @Deprecated
<abbr title=" 529     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 529     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptiðŸ”µ</abbr>
 530         applyAndSaveFulfillmentGroupOffersToOrder(offers, order);
 531     }
 532 
 533     @Override
 534     @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 535     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 535     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricinðŸ”µ</abbr>
 536         OfferContext offerContext = OfferContext.getOfferContext();
 537         if (offerContext == null || offerContext.executePromotionCalculation) {
 538             PromotableOrder promotableOrder =
 539                     promotableItemFactory.createPromotableOrder(order, true);
 540             List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();
 541             for (Offer offer : offers) {
 542                 if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {
 543                     possibleFGOffers.add(offer);
 544                 }
 545             }
<abbr title=" 546             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());"> 546             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustðŸ”µ</abbr>
<abbr title=" 547             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 547             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCaðŸ”µ</abbr>
 548             for (Offer offer : filteredOffers) {
<abbr title=" 549                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 549                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifieðŸ”µ</abbr>
 550             }
 551             if (!qualifiedFGOffers.isEmpty()) {
<abbr title=" 552                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);"> 552                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotabðŸ”µ</abbr>
 553                 fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);
 554                 orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 555             }
 556 
 557             return orderService.save(order, false);
 558         }
 559         return order;
 560     }
 561 
 562     @Override
 563     public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {
 564         Customer customer = order.getCustomer();
 565         
 566         if (offer.isLimitedUsePerCustomer()) {
<abbr title=" 567             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());"> 567             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getIdðŸ”µ</abbr>
 568             
 569             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 570                 return false;
 571             }
 572         }
 573         
 574         return true;
 575     }
 576     
 577     @Deprecated
 578     @Override
 579     public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {
 580         if (offer.isLimitedUsePerCustomer()) {                
 581             Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());
 582             
 583             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 584                 return false;
 585             }
 586         }
 587         
 588         return true;
 589     }
 590 
 591     @Override
 592     public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {
 593         boolean underCodeMaxUses = true;
 594         
 595         if (code.isLimitedUse()) {
 596             Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());
 597             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 598         }
 599         
 600         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());
 601     }
 602 
 603     @Deprecated
 604     @Override
 605     public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {
 606         boolean underCodeMaxUses = true;
 607         if (code.isLimitedUse()) {
 608             Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());
 609             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 610         }
 611         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());
 612     }
 613     
 614     @Override
 615     @SuppressWarnings(&quot;unchecked&quot;)
 616     public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {
 617         HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();
 618         
 619         Transformer adjustmentToOfferTransformer = new Transformer() {
 620             
 621             @Override
 622             public Object transform(Object input) {
 623                 return ((Adjustment)input).getOffer();
 624             }
 625         };
 626         
<abbr title=" 627         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));"> 627         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer))ðŸ”µ</abbr>
 628 
 629         if (order.getOrderItems() != null) {
 630             for (OrderItem item : order.getOrderItems()) {
<abbr title=" 631                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 631                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTrðŸ”µ</abbr>
 632                 
 633                 //record usage for price details on the item as well
 634                 if (item.getOrderItemPriceDetails() != null) {
 635                     for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 636                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 636                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments()ðŸ”µ</abbr>
 637                     }
 638                 }
 639             }
 640         }
 641 
 642         if (order.getFulfillmentGroups() != null) {
 643             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
<abbr title=" 644                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 644                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfðŸ”µ</abbr>
 645             }
 646         }
 647         return result;
 648     }
 649     
 650     @Override
 651     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {
 652         return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order));
 653     }
 654     
 655     @Override
<abbr title=" 656     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {"> 656     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffðŸ”µ</abbr>
 657         HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();
 658         for (OfferCode code : codes) {
 659             if (appliedOffers.contains(code.getOffer())) {
 660                 offerToCodeMapping.put(code.getOffer(), code);
 661             }
 662 
 663             List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();
 664 
 665             extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);
 666             for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {
 667                 offerToCodeMapping.put(additionalOfferToBeApplied, code);
 668             }
 669         }
 670         return offerToCodeMapping;
 671     }
 672     
 673     @Override
 674     @Transactional(&quot;blTransactionManager&quot;)
 675     public Boolean deleteOfferCode(OfferCode code) {
 676         if (offerCodeDao.offerCodeIsUsed(code)) {
 677             return false;
 678         }
 679 
 680         offerCodeDao.delete(code);
 681         return true;
 682     }
 683 
 684     @Transactional(&quot;blTransactionManager&quot;)
 685     @Override
 686     public Offer duplicate(Long originalOfferId) {
 687         Map&lt;String, String&gt; copyHints = new HashMap&lt;String, String&gt;();
 688         copyHints.put(OfferImpl.EXCLUDE_OFFERCODE_COPY_HINT, &quot;true&quot;);
 689         return duplicator.copy(OfferImpl.class, originalOfferId, copyHints, offerDuplicateModifier);
 690     }
 691 
 692     @Override
 693     public CustomerOfferDao getCustomerOfferDao() {
 694         return customerOfferDao;
 695     }
 696 
 697     @Override
 698     public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {
 699         this.customerOfferDao = customerOfferDao;
 700     }
 701 
 702     @Override
 703     public OfferCodeDao getOfferCodeDao() {
 704         return offerCodeDao;
 705     }
 706 
 707     @Override
 708     public void setOfferCodeDao(OfferCodeDao offerCodeDao) {
 709         this.offerCodeDao = offerCodeDao;
 710     }
 711 
 712     @Override
 713     public OfferDao getOfferDao() {
 714         return offerDao;
 715     }
 716 
 717     @Override
 718     public void setOfferDao(OfferDao offerDao) {
 719         this.offerDao = offerDao;
 720     }
 721 
 722     @Override
 723     public OrderOfferProcessor getOrderOfferProcessor() {
 724         return orderOfferProcessor;
 725     }
 726 
 727     @Override
 728     public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {
 729         this.orderOfferProcessor = orderOfferProcessor;
 730     }
 731 
 732     @Override
 733     public ItemOfferProcessor getItemOfferProcessor() {
 734         return itemOfferProcessor;
 735     }
 736 
 737     @Override
 738     public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {
 739         this.itemOfferProcessor = itemOfferProcessor;
 740     }
 741 
 742     @Override
 743     public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {
 744         return fulfillmentGroupOfferProcessor;
 745     }
 746 
 747     @Override
<abbr title=" 748     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {"> 748     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProðŸ”µ</abbr>
 749         this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;
 750     }
 751 
 752     @Override
 753     public PromotableItemFactory getPromotableItemFactory() {
 754         return promotableItemFactory;
 755     }
 756 
 757     @Override
 758     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 759         this.promotableItemFactory = promotableItemFactory;
 760     }
 761 
 762     @Override
 763     public OfferCode findOfferCodeById(Long id) {
 764         return offerCodeDao.readOfferCodeById(id);
 765     }
 766 
 767     @Override
 768     public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {
 769         return offerCodeDao.readOfferCodesByIds(ids);
 770     }
 771 
 772     @Override
 773     public OrderService getOrderService() {
 774         return orderService;
 775     }
 776 
 777     @Override
 778     public void setOrderService(OrderService orderService) {
 779         this.orderService = orderService;
 780     }
 781 
 782     @Override
 783     public Offer findOfferById(Long offerId) {
 784         return offerDao.readOfferById(offerId);
 785     }
 786 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.Transformer;
  22 import org.apache.commons.logging.Log;
  23 import org.apache.commons.logging.LogFactory;
  24 import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;
  25 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  26 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  27 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  28 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  29 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  30 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  31 import org.broadleafcommerce.core.offer.dao.OfferDao;
  32 import org.broadleafcommerce.core.offer.domain.*;
  33 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  34 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  35 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  36 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  37 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  38 import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;
  39 import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;
  40 import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;
  41 import org.broadleafcommerce.core.offer.service.type.OfferType;
  42 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  43 import org.broadleafcommerce.core.order.domain.Order;
  44 import org.broadleafcommerce.core.order.domain.OrderItem;
  45 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  46 import org.broadleafcommerce.core.order.service.OrderService;
  47 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  48 import org.broadleafcommerce.profile.core.domain.Customer;
  49 import org.springframework.stereotype.Service;
  50 import org.springframework.transaction.annotation.Transactional;
  51 
  52 import java.util.ArrayList;
  53 import java.util.Collection;
  54 import java.util.HashMap;
  55 import java.util.HashSet;
  56 import java.util.Iterator;
  57 import java.util.List;
  58 import java.util.Map;
  59 import java.util.Objects;
  60 import java.util.Set;
  61 
  62 import javax.annotation.Resource;
  63 import javax.persistence.EntityManager;
  64 import javax.persistence.PersistenceContext;
  65 
  66 /**
  67  * The Class OfferServiceImpl.
  68  */
  69 @Service(&quot;blOfferService&quot;)
  70 public class OfferServiceImpl implements OfferService {
  71 
  72     private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);
  73 
  74     // should be called outside of Offer service after Offer service is executed
  75     @Resource(name=&quot;blCustomerOfferDao&quot;)
  76     protected CustomerOfferDao customerOfferDao;
  77 
  78     @Resource(name=&quot;blOfferCodeDao&quot;)
  79     protected OfferCodeDao offerCodeDao;
  80 
  81     @Resource(name=&quot;blOfferAuditService&quot;)
  82     protected OfferAuditService offerAuditService;
  83 
  84     @Resource(name=&quot;blOfferDao&quot;)
  85     protected OfferDao offerDao;
  86 
  87     @Resource(name=&quot;blOrderOfferProcessor&quot;)
  88     protected OrderOfferProcessor orderOfferProcessor;
  89 
  90     @Resource(name=&quot;blItemOfferProcessor&quot;)
  91     protected ItemOfferProcessor itemOfferProcessor;
  92 
  93     @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)
  94     protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;
  95 
  96     @Resource(name=&quot;blPromotableItemFactory&quot;)
  97     protected PromotableItemFactory promotableItemFactory;
  98 
  99     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
 100     protected OfferServiceExtensionManager extensionManager;
 101 
 102     @Resource(name = &quot;blOrderService&quot;)
 103     protected OrderService orderService;
 104 
 105     @Resource(name = &quot;blSandBoxHelper&quot;)
 106     protected SandBoxHelper sandBoxHelper;
 107 
 108     @PersistenceContext(unitName=&quot;blPU&quot;)
 109     protected EntityManager em;
 110 
 111     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 112     protected StreamingTransactionCapableUtil transUtil;
 113 
 114     @Resource(name=&quot;blEntityDuplicator&quot;)
 115     protected EntityDuplicator duplicator;
 116 
 117     @Resource(name=&quot;blOfferDuplicateModifier&quot;)
 118     protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;
 119 
 120     @Override
 121     public List&lt;Offer&gt; findAllOffers() {
 122         return offerDao.readAllOffers();
 123     }
 124 
 125     @Override
 126     @Transactional(&quot;blTransactionManager&quot;)
 127     public Offer save(Offer offer) {
 128         return offerDao.save(offer);
 129     }
 130 
 131     @Override
 132     @Transactional(&quot;blTransactionManager&quot;)
 133     public OfferCode saveOfferCode(OfferCode offerCode) {
 134         offerCode.setOffer(offerDao.save(offerCode.getOffer()));
 135         return offerCodeDao.save(offerCode);
 136     }
 137 
 138     /**
<abbr title=" 139      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 139      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr>
<abbr title=" 140      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 140      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr>
 141      * cannot appear more than once in the list.
 142      *
 143      * @param code
 144      * @return a List of offers that may apply to this order
 145      */
 146     @Override
 147     public Offer lookupOfferByCode(String code) {
 148         Offer offer = null;
 149         OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);
 150         if (offerCode != null) {
 151             offer = offerCode.getOffer();
 152         }
 153         return offer;
 154     }
 155 
 156     @Override
 157     public OfferCode lookupOfferCodeByCode(String code){
 158         return offerCodeDao.readOfferCodeByCode(code);
 159     }
 160 
 161     @Override
 162     public List&lt;Offer&gt; lookupAllOffersByCode(String code) {
 163         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 164         List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);
 165         for (OfferCode offerCode : offerCodes) {
 166             if (offerCode != null) {
 167                 offers.add(offerCode.getOffer());
 168             }
 169         }
 170         return offers;
 171     }
 172 
 173     @Override
 174     public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){
 175         return offerCodeDao.readAllOfferCodesByCode(code);
 176     }
 177 
 178     /**
<abbr title=" 179      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 179      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr>
<abbr title=" 180      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 180      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr>
 181      * cannot appear more than once in the list.
 182      *
 183      * @param order
 184      * @return a List of offers that may apply to this order
 185      */
 186     @Override
 187     public List&lt;Offer&gt; buildOfferListForOrder(Order order) {
 188         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 189         List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());
 190         for (CustomerOffer customerOffer : customerOffers) {
 191             if (!offers.contains(customerOffer.getOffer())) {
 192                 offers.add(customerOffer.getOffer());
 193             }
 194         }
 195         List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);
 196 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197 //        int before = orderOfferCodes.size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198 //        orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199 /*        int after = orderOfferCodes.size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 200         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 200         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201         if(o !=null &amp;&amp; (Boolean)o &amp;&amp; before!=after){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 202             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 202             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203         }*/</span>
 204 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205         int before = orderOfferCodes.size();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207         int after = orderOfferCodes.size();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 208         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 208         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209         if(o !=null &amp;&amp; (Boolean)o &amp;&amp; before!=after){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 210             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 210             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211         }</span>
 212 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);</span>
 214 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 215         for (OfferCode orderOfferCode : orderOfferCodes) {
 216             if (!offers.contains(orderOfferCode.getOffer())) {
 217                 offers.add(orderOfferCode.getOffer());
 218             }
 219             extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);
 220         }
 221         List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();
 222         for (Offer globalOffer : globalOffers) {
 223             if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {
 224                 offers.add(globalOffer);
 225             }
 226         }
 227 
 228         if (extensionManager != null) {
 229             extensionManager.applyAdditionalFilters(offers, order);
 230         }
 231 
 232         return offers;
 233     }
 234 
 235     @Override
 236     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {
 237         Customer customer = order.getCustomer();
 238         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();
 239 
 240         if (extensionManager != null) {
 241             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 242         }
 243         if (!offerCodes.isEmpty()) {
 244             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 245             while (itr.hasNext()) {
 246                 OfferCode offerCode = itr.next();
 247                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {
 248                     itr.remove();
 249                 }
 250             }
 251         }
 252         return offerCodes;
 253     }
 254 
 255     @Deprecated
 256     @Override
 257     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {
 258         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();
 259         if (extensionManager != null) {
 260             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 261         }
 262         if (!offerCodes.isEmpty()) {
 263             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 264             while (itr.hasNext()) {
 265                 OfferCode offerCode = itr.next();
 266                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {
 267                     itr.remove();
 268                 }
 269             }
 270         }
 271         return offerCodes;
 272     }
 273 
 274     /**
 275      * Private method used to retrieve all offers assigned to this customer.  These offers are
 276      * programmatically assigned to the customer.
 277      *
 278      * @param customer
 279      * @return a List of offers assigned to the customer
 280      */
 281     protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {
 282         List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);
 283         return offerCustomers;
 284     }
 285 
 286     /**
 287      * Private method used to retrieve all offers with automaticallyAdded set to true
 288      *
 289      * @return a List of automatic delivery offers
 290      */
 291     protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {
 292         List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();
 293         return globalOffers;
 294     }
 295 
 296     /**
 297      * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end
 298      * date.  If an offerCode has a later start date, that offerCode will be removed.
 299      * OfferCodes without a start date will still be processed. If the offerCode
 300      * has a end date that has already passed, that offerCode will be removed.  OfferCodes
 301      * without a end date will be processed.  The start and end dates on the offer will
 302      * still need to be evaluated.
 303      *
 304      * @param offerCodes
 305      * @return a List of non-expired offers
 306      */
 307     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){
 308         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();
 309         for (OfferCode offerCode : offerCodes) {
 310             if (!offerCode.isActive()){
 311                 offerCodesToRemove.add(offerCode);
 312             }
 313         }
 314         // remove all offers in the offersToRemove list from original offers list
 315         for (OfferCode offerCode : offerCodesToRemove) {
 316             offerCodes.remove(offerCode);
 317         }
 318         return offerCodes;
 319     }
 320 
<abbr title=" 321     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodesAndOffers(List&lt;OfferCode&gt; offerCodes, List&lt;Offer&gt; offers){"> 321     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodesAndOffers(List&lt;OfferCode&gt; offerCodes, List&lt;Offer&gt; ðŸ”µ</abbr>
 322         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();
 323         for (OfferCode offerCode : offerCodes) {
 324             if (!offerCode.isActive()){
 325                 offerCodesToRemove.add(offerCode);
 326             }
 327         }
 328         // remove all offers in the offersToRemove list from original offers list
 329         for (OfferCode offerCode : offerCodesToRemove) {
 330             offerCodes.remove(offerCode);
 331             offers.remove(offerCode.getOffer());
 332         }
 333         return offerCodes;
 334     }
 335 
 336     /**
 337      * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with
 338      * current sandbox status.
 339      *
 340      * @param order the order to check
 341      * @return the refreshed list of OfferCodes
 342      */
 343     protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {
 344         final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();
 345 
 346         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 347             @Override
 348             public void execute() {
 349                 for (OfferCode offerCode : orderOfferCodes) {
 350                     if (offerCode.getOffer() != null) {
<abbr title=" 351                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 351                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCðŸ”µ</abbr>
<abbr title=" 352                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 352                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOfðŸ”µ</abbr>
 353                             em.refresh(offerCode);
 354                         }
 355                     }
 356                 }
 357             }
 358 
 359             @Override
 360             public boolean shouldRetryOnTransactionLockAcquisitionFailure() {
 361                 return true;
 362             }
 363         }, RuntimeException.class);
 364 
 365         return orderOfferCodes;
 366     }
 367 
 368     /*
 369      *
 370      * Offers Logic:
 371      * 1) Remove all existing offers in the Order (order, item, and fulfillment)
 372      * 2) Check and remove offers
 373      *    a) Remove out of date offers
 374      *    b) Remove offers that do not apply to this customer
 375      * 3) Loop through offers
 376      *    a) Verifies type of offer (order, order item, fulfillment)
 377      *    b) Verifies if offer can be applies
 378      *    c) Assign offer to type (order, order item, or fulfillment)
 379      * 4) Sorts the order and item offers list by priority and then discount
 380      * 5) Identify the best offers to apply to order item and create adjustments for each item offer
<abbr title=" 381      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better"> 381      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is betðŸ”µ</abbr>
 382      * 7) Identify the best offers to apply to the order and create adjustments for each order offer
<abbr title=" 383      * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 383      * 8) If item contains non-combinable offers remove either the item or order adjustments based on disðŸ”µ</abbr>
 384      * 9) Set final order item prices and reapply order offers
 385      *
 386      * Assumptions:
 387      * 1) % off all items will be created as an item offer with no expression
 388      * 2) $ off order will be created as an order offer
 389      * 3) Order offers applies to the best price for each item (not just retail price)
 390      * 4) Fulfillment offers apply to best price for each item (not just retail price)
<abbr title=" 391      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 391      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used witðŸ”µ</abbr>
 392      * 6) Fulfillment offers cannot be not combinable
 393      * 7) Order offers cannot be FIXED_PRICE
 394      * 8) FIXED_PRICE offers cannot be stackable
<abbr title=" 395      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 395      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will alðŸ”µ</abbr>
 396      *
 397      */
 398     @Override
 399     @Transactional(&quot;blTransactionManager&quot;)
 400     public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 401         /*
 402         TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to
 403         use a richer object to describe the parameters of the pricing call. This object would include
 404         the pricing boolean, but would also include a list of activities to include or exclude in the
 405         call - see http://jira.broadleafcommerce.org/browse/BLC-664
 406          */
<abbr title=" 407         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 407         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINðŸ”µ</abbr>
 408         int offerCount = 0;
 409         if(o!=null &amp;&amp; (Boolean)o){
 410             if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())){
 411                 for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {
 412                     if(orderAdjustment.getOffer()!=null){
 413                         offerCount++;
 414                     }
 415                 }
 416             }
 417         }
 418         OfferContext offerContext = OfferContext.getOfferContext();
 419         if (offerContext == null || offerContext.executePromotionCalculation) {
 420             PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false);
 421             List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);
 422             removeOutOfDateOfferCodesAndOffers(orderOfferCodes, offers);
 423             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());
 424             if ((filteredOffers == null) || (filteredOffers.isEmpty())) {
 425                 if (LOG.isTraceEnabled()) {
 426                     LOG.trace(&quot;No offers applicable to this order.&quot;);
 427                 }
 428             } else {
<abbr title=" 429                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 429                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidðŸ”µ</abbr>
<abbr title=" 430                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 430                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
 431 
<abbr title=" 432                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 432                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, quðŸ”µ</abbr>
 433 
 434                 if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {
<abbr title=" 435                     // At this point, we should have a PromotableOrder that contains PromotableItems each of which"> 435                     // At this point, we should have a PromotableOrder that contains PromotableItems eachðŸ”µ</abbr>
 436                     // has a list of candidatePromotions that might be applied.
 437 
<abbr title=" 438                     // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 438                     // We also have a list of orderOffers that might apply and a list of itemOffers that ðŸ”µ</abbr>
<abbr title=" 439                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 439                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOðŸ”µ</abbr>
 440                 }
 441             }
 442             orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 443 
 444             verifyAdjustments(order, true);
 445 
 446             order.setSubTotal(order.calculateSubTotal());
 447             order.finalizeItemPrices();
 448 
 449             order = orderService.save(order, false);
 450 
 451             boolean madeChange = verifyAdjustments(order, false);
 452             if (madeChange) {
 453                 order = orderService.save(order, false);
 454             }
 455             int offerCountAfter=0;
 456             if(o!=null &amp;&amp; (Boolean)o){
<abbr title=" 457                 if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())){"> 457                 if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments()ðŸ”µ</abbr>
 458                     for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {
 459                         if(orderAdjustment.getOffer()!=null){
 460                             offerCountAfter++;
 461                         }
 462                     }
 463                 }
 464                 if(offerCountAfter!=offerCount){
<abbr title=" 465                     BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 465                     BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfðŸ”µ</abbr>
 466                 }
 467             }
 468         }
 469 
 470         return order;
 471     }
 472 
 473     protected boolean verifyAdjustments(Order order, boolean beforeSave) {
 474         boolean madeChange = false;
 475 
 476         if (order.getOrderItems() == null) {
 477             return madeChange;
 478         }
 479 
 480         for (OrderItem oi : order.getOrderItems()) {
 481             if (oi.getOrderItemPriceDetails() == null) {
 482                 continue;
 483             }
 484 
 485             for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {
 486                 if (pd.getOrderItemPriceDetailAdjustments() == null) {
 487                     continue;
 488                 }
 489 
<abbr title=" 490                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 490                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdðŸ”µ</abbr>
<abbr title=" 491                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 491                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDeðŸ”µ</abbr>
 492                 for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {
 493                     if (adjs.containsKey(adj.getOffer().getId())) {
 494                         adjustmentsToRemove.add(adj);
 495                         if (LOG.isDebugEnabled()) {
 496                             StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)
 497                                 .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)
 498                                 .append(&quot; with ids &quot;)
 499                                 .append(adjs.get(adj.getOffer().getId()).getId())
 500                                 .append(&quot; and &quot;)
 501                                 .append(adj.getId());
 502                             LOG.debug(sb.toString());
 503                         }
 504                     } else {
 505                         adjs.put(adj.getOffer().getId(), adj);
 506                     }
 507                 }
 508 
 509                 for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {
 510                     pd.getOrderItemPriceDetailAdjustments().remove(adj);
 511                     madeChange = true;
 512                 }
 513             }
 514         }
 515 
 516         return madeChange;
 517      }
 518 
 519     @Override
 520     @Transactional(&quot;blTransactionManager&quot;)
 521     @Deprecated
 522     public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 523         applyAndSaveOffersToOrder(offers, order);
 524     }
 525 
 526     @Override
 527     @Transactional(&quot;blTransactionManager&quot;)
 528     @Deprecated
<abbr title=" 529     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 529     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptiðŸ”µ</abbr>
 530         applyAndSaveFulfillmentGroupOffersToOrder(offers, order);
 531     }
 532 
 533     @Override
 534     @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 535     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 535     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricinðŸ”µ</abbr>
 536         OfferContext offerContext = OfferContext.getOfferContext();
 537         if (offerContext == null || offerContext.executePromotionCalculation) {
 538             PromotableOrder promotableOrder =
 539                     promotableItemFactory.createPromotableOrder(order, true);
 540             List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();
 541             for (Offer offer : offers) {
 542                 if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {
 543                     possibleFGOffers.add(offer);
 544                 }
 545             }
<abbr title=" 546             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());"> 546             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustðŸ”µ</abbr>
<abbr title=" 547             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 547             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCaðŸ”µ</abbr>
 548             for (Offer offer : filteredOffers) {
<abbr title=" 549                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 549                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifieðŸ”µ</abbr>
 550             }
 551             if (!qualifiedFGOffers.isEmpty()) {
<abbr title=" 552                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);"> 552                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotabðŸ”µ</abbr>
 553                 fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);
 554                 orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 555             }
 556 
 557             return orderService.save(order, false);
 558         }
 559         return order;
 560     }
 561 
 562     @Override
 563     public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {
 564         Customer customer = order.getCustomer();
 565 
 566         if (offer.isLimitedUsePerCustomer()) {
<abbr title=" 567             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());"> 567             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getIdðŸ”µ</abbr>
 568 
 569             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 570                 return false;
 571             }
 572         }
 573 
 574         return true;
 575     }
 576 
 577     @Deprecated
 578     @Override
 579     public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {
 580         if (offer.isLimitedUsePerCustomer()) {
 581             Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());
 582 
 583             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 584                 return false;
 585             }
 586         }
 587 
 588         return true;
 589     }
 590 
 591     @Override
 592     public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {
 593         boolean underCodeMaxUses = true;
 594 
 595         if (code.isLimitedUse()) {
 596             Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());
 597             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 598         }
 599 
 600         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());
 601     }
 602 
 603     @Deprecated
 604     @Override
 605     public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {
 606         boolean underCodeMaxUses = true;
 607         if (code.isLimitedUse()) {
 608             Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());
 609             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 610         }
 611         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());
 612     }
 613 
 614     @Override
 615     @SuppressWarnings(&quot;unchecked&quot;)
 616     public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {
 617         HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();
 618 
 619         Transformer adjustmentToOfferTransformer = new Transformer() {
 620 
 621             @Override
 622             public Object transform(Object input) {
 623                 return ((Adjustment)input).getOffer();
 624             }
 625         };
 626 
<abbr title=" 627         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));"> 627         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer))ðŸ”µ</abbr>
 628 
 629         if (order.getOrderItems() != null) {
 630             for (OrderItem item : order.getOrderItems()) {
<abbr title=" 631                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 631                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTrðŸ”µ</abbr>
 632 
 633                 //record usage for price details on the item as well
 634                 if (item.getOrderItemPriceDetails() != null) {
 635                     for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 636                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 636                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments()ðŸ”µ</abbr>
 637                     }
 638                 }
 639             }
 640         }
 641 
 642         if (order.getFulfillmentGroups() != null) {
 643             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
<abbr title=" 644                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 644                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfðŸ”µ</abbr>
 645             }
 646         }
 647         return result;
 648     }
 649 
 650     @Override
 651     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {
 652         return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order));
 653     }
 654 
 655     @Override
<abbr title=" 656     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {"> 656     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffðŸ”µ</abbr>
 657         HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();
 658         for (OfferCode code : codes) {
 659             if (appliedOffers.contains(code.getOffer())) {
 660                 offerToCodeMapping.put(code.getOffer(), code);
 661             }
 662 
 663             List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();
 664 
 665             extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);
 666             for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {
 667                 offerToCodeMapping.put(additionalOfferToBeApplied, code);
 668             }
 669         }
 670         return offerToCodeMapping;
 671     }
 672 
 673     @Override
 674     @Transactional(&quot;blTransactionManager&quot;)
 675     public Boolean deleteOfferCode(OfferCode code) {
 676         if (offerCodeDao.offerCodeIsUsed(code)) {
 677             return false;
 678         }
 679 
 680         offerCodeDao.delete(code);
 681         return true;
 682     }
 683 
 684     @Transactional(&quot;blTransactionManager&quot;)
 685     @Override
 686     public Offer duplicate(Long originalOfferId) {
 687         Map&lt;String, String&gt; copyHints = new HashMap&lt;String, String&gt;();
 688         copyHints.put(OfferImpl.EXCLUDE_OFFERCODE_COPY_HINT, &quot;true&quot;);
 689         return duplicator.copy(OfferImpl.class, originalOfferId, copyHints, offerDuplicateModifier);
 690     }
 691 
 692     @Override
 693     public CustomerOfferDao getCustomerOfferDao() {
 694         return customerOfferDao;
 695     }
 696 
 697     @Override
 698     public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {
 699         this.customerOfferDao = customerOfferDao;
 700     }
 701 
 702     @Override
 703     public OfferCodeDao getOfferCodeDao() {
 704         return offerCodeDao;
 705     }
 706 
 707     @Override
 708     public void setOfferCodeDao(OfferCodeDao offerCodeDao) {
 709         this.offerCodeDao = offerCodeDao;
 710     }
 711 
 712     @Override
 713     public OfferDao getOfferDao() {
 714         return offerDao;
 715     }
 716 
 717     @Override
 718     public void setOfferDao(OfferDao offerDao) {
 719         this.offerDao = offerDao;
 720     }
 721 
 722     @Override
 723     public OrderOfferProcessor getOrderOfferProcessor() {
 724         return orderOfferProcessor;
 725     }
 726 
 727     @Override
 728     public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {
 729         this.orderOfferProcessor = orderOfferProcessor;
 730     }
 731 
 732     @Override
 733     public ItemOfferProcessor getItemOfferProcessor() {
 734         return itemOfferProcessor;
 735     }
 736 
 737     @Override
 738     public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {
 739         this.itemOfferProcessor = itemOfferProcessor;
 740     }
 741 
 742     @Override
 743     public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {
 744         return fulfillmentGroupOfferProcessor;
 745     }
 746 
 747     @Override
<abbr title=" 748     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {"> 748     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProðŸ”µ</abbr>
 749         this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;
 750     }
 751 
 752     @Override
 753     public PromotableItemFactory getPromotableItemFactory() {
 754         return promotableItemFactory;
 755     }
 756 
 757     @Override
 758     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 759         this.promotableItemFactory = promotableItemFactory;
 760     }
 761 
 762     @Override
 763     public OfferCode findOfferCodeById(Long id) {
 764         return offerCodeDao.readOfferCodeById(id);
 765     }
 766 
 767     @Override
 768     public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {
 769         return offerCodeDao.readOfferCodesByIds(ids);
 770     }
 771 
 772     @Override
 773     public OrderService getOrderService() {
 774         return orderService;
 775     }
 776 
 777     @Override
 778     public void setOrderService(OrderService orderService) {
 779         this.orderService = orderService;
 780     }
 781 
 782     @Override
 783     public Offer findOfferById(Long offerId) {
 784         return offerDao.readOfferById(offerId);
 785     }
 786 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service;
  19 
  20 import java.util.ArrayList;
  21 import java.util.Collection;
  22 import java.util.HashMap;
  23 import java.util.HashSet;
  24 import java.util.Iterator;
  25 import java.util.List;
  26 import java.util.Map;
  27 import java.util.Objects;
  28 import java.util.Set;
  29 import javax.annotation.Resource;
  30 import javax.persistence.EntityManager;
  31 import javax.persistence.PersistenceContext;
  32 import org.apache.commons.collections.CollectionUtils;
  33 import org.apache.commons.collections.Transformer;
  34 import org.apache.commons.logging.Log;
  35 import org.apache.commons.logging.LogFactory;
  36 import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;
  37 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  38 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  39 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  40 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  41 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  42 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  43 import org.broadleafcommerce.core.offer.dao.OfferDao;
  44 import org.broadleafcommerce.core.offer.domain.*;
  45 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  46 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  47 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  48 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  49 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  50 import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;
  51 import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;
  52 import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;
  53 import org.broadleafcommerce.core.offer.service.type.OfferType;
  54 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  55 import org.broadleafcommerce.core.order.domain.Order;
  56 import org.broadleafcommerce.core.order.domain.OrderItem;
  57 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  58 import org.broadleafcommerce.core.order.service.OrderService;
  59 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  60 import org.broadleafcommerce.profile.core.domain.Customer;
  61 import org.springframework.stereotype.Service;
  62 import org.springframework.transaction.annotation.Transactional;
  63 
  64 
  65 /**
  66  * The Class OfferServiceImpl.
  67  */
  68 @Service(&quot;blOfferService&quot;)
  69 public class OfferServiceImpl implements OfferService {
  70     private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);
  71 
  72     // should be called outside of Offer service after Offer service is executed
  73     // should be called outside of Offer service after Offer service is executed
  74     @Resource(name=&quot;blCustomerOfferDao&quot;)
  75     protected CustomerOfferDao customerOfferDao;
  76 
  77     @Resource(name=&quot;blOfferCodeDao&quot;)
  78     protected OfferCodeDao offerCodeDao;
  79 
  80     @Resource(name=&quot;blOfferAuditService&quot;)
  81     protected OfferAuditService offerAuditService;
  82 
  83     @Resource(name=&quot;blOfferDao&quot;)
  84     protected OfferDao offerDao;
  85 
  86     @Resource(name=&quot;blOrderOfferProcessor&quot;)
  87     protected OrderOfferProcessor orderOfferProcessor;
  88 
  89     @Resource(name=&quot;blItemOfferProcessor&quot;)
  90     protected ItemOfferProcessor itemOfferProcessor;
  91 
  92     @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)
  93     protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;
  94 
  95     @Resource(name=&quot;blPromotableItemFactory&quot;)
  96     protected PromotableItemFactory promotableItemFactory;
  97 
  98     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
  99     protected OfferServiceExtensionManager extensionManager;
 100 
 101     @Resource(name = &quot;blOrderService&quot;)
 102     protected OrderService orderService;
 103 
 104     @Resource(name = &quot;blSandBoxHelper&quot;)
 105     protected SandBoxHelper sandBoxHelper;
 106 
 107     @PersistenceContext(unitName=&quot;blPU&quot;)
 108     protected EntityManager em;
 109 
 110     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 111     protected StreamingTransactionCapableUtil transUtil;
 112 
 113     @Resource(name=&quot;blEntityDuplicator&quot;)
 114     protected EntityDuplicator duplicator;
 115 
 116     @Resource(name = &quot;blOfferDuplicateModifier&quot;)
 117     protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;
 118 
 119     @Override
 120     public List&lt;Offer&gt; findAllOffers() {
 121         return offerDao.readAllOffers();
 122     }
 123 
 124     @Override
 125     @Transactional(&quot;blTransactionManager&quot;)
 126     public Offer save(Offer offer) {
 127         return offerDao.save(offer);
 128     }
 129 
 130     @Override
 131     @Transactional(&quot;blTransactionManager&quot;)
 132     public OfferCode saveOfferCode(OfferCode offerCode) {
 133         offerCode.setOffer(offerDao.save(offerCode.getOffer()));
 134         return offerCodeDao.save(offerCode);
 135     }
 136 
 137     /**
<abbr title=" 138      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 138      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr>
<abbr title=" 139      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 139      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr>
 140      * cannot appear more than once in the list.
 141      *
 142      * @param code
 143      * @return a List of offers that may apply to this order
 144      */
 145     @Override
 146     public Offer lookupOfferByCode(String code) {
 147         Offer offer = null;
 148         OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);
 149         if (offerCode != null) {
 150             offer = offerCode.getOffer();
 151         }
 152         return offer;
 153     }
 154 
 155     @Override
 156     public OfferCode lookupOfferCodeByCode(String code) {
 157         return offerCodeDao.readOfferCodeByCode(code);
 158     }
 159 
 160     @Override
 161     public List&lt;Offer&gt; lookupAllOffersByCode(String code) {
 162         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 163         List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);
 164         for (OfferCode offerCode : offerCodes) {
 165             if (offerCode != null) {
 166                 offers.add(offerCode.getOffer());
 167             }
 168         }
 169         return offers;
 170     }
 171 
 172     @Override
 173     public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code) {
 174         return offerCodeDao.readAllOfferCodesByCode(code);
 175     }
 176 
 177     /**
<abbr title=" 178      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 178      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr>
<abbr title=" 179      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 179      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr>
 180      * cannot appear more than once in the list.
 181      *
 182      * @param order
 183      * @return a List of offers that may apply to this order
 184      */
 185     @Override
 186     public List&lt;Offer&gt; buildOfferListForOrder(Order order) {
 187         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 188         List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());
 189         for (CustomerOffer customerOffer : customerOffers) {
 190             if (!offers.contains(customerOffer.getOffer())) {
 191                 offers.add(customerOffer.getOffer());
 192             }
 193         }
 194         List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);
 195         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);
 196 //        int before = orderOfferCodes.size();
 197 //        orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);
 198 /*        int after = orderOfferCodes.size();
<abbr title=" 199         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 199         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINðŸ”µ</abbr>
 200         if(o !=null &amp;&amp; (Boolean)o &amp;&amp; before!=after){
<abbr title=" 201             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 201             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiðŸ”µ</abbr>
 202         }*/
 203         for (OfferCode orderOfferCode : orderOfferCodes) {
 204             if (!offers.contains(orderOfferCode.getOffer())) {
 205                 offers.add(orderOfferCode.getOffer());
 206             }
 207             extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);
 208         }
 209         List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();
 210         for (Offer globalOffer : globalOffers) {
 211             if ((!offers.contains(globalOffer)) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {
 212                 offers.add(globalOffer);
 213             }
 214         }
 215         if (extensionManager != null) {
 216             extensionManager.applyAdditionalFilters(offers, order);
 217         }
 218         return offers;
 219     }
 220 
 221     @Override
 222     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {
 223         Customer customer = order.getCustomer();
 224         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();
 225         if (extensionManager != null) {
 226             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 227         }
 228         if (!offerCodes.isEmpty()) {
 229             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 230             while (itr.hasNext()) {
 231                 OfferCode offerCode = itr.next();
 232                 if ((!offerCode.isActive()) || (!verifyMaxCustomerUsageThreshold(order, offerCode))) {
 233                     itr.remove();
 234                 }
 235             }
 236         }
 237         return offerCodes;
 238     }
 239 
 240     @Deprecated
 241     @Override
 242     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {
 243         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();
 244         if (extensionManager != null) {
 245             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 246         }
 247         if (!offerCodes.isEmpty()) {
 248             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 249             while (itr.hasNext()) {
 250                 OfferCode offerCode = itr.next();
 251                 if ((!offerCode.isActive()) || (!verifyMaxCustomerUsageThreshold(customer, offerCode))) {
 252                     itr.remove();
 253                 }
 254             }
 255         }
 256         return offerCodes;
 257     }
 258 
 259     /**
 260      * Private method used to retrieve all offers assigned to this customer.  These offers are
 261      * programmatically assigned to the customer.
 262      *
 263      * @param customer
 264      * @return a List of offers assigned to the customer
 265      */
 266     protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {
 267         List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);
 268         return offerCustomers;
 269     }
 270 
 271     /**
 272      * Private method used to retrieve all offers with automaticallyAdded set to true
 273      *
 274      * @return a List of automatic delivery offers
 275      */
 276     protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {
 277         List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();
 278         return globalOffers;
 279     }
 280 
 281     /**
 282      * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end
 283      * date.  If an offerCode has a later start date, that offerCode will be removed.
 284      * OfferCodes without a start date will still be processed. If the offerCode
 285      * has a end date that has already passed, that offerCode will be removed.  OfferCodes
 286      * without a end date will be processed.  The start and end dates on the offer will
 287      * still need to be evaluated.
 288      *
 289      * @param offerCodes
 290      * @return a List of non-expired offers
 291      */
 292     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes) {
 293         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();
 294         for (OfferCode offerCode : offerCodes) {
 295             if (!offerCode.isActive()) {
 296                 offerCodesToRemove.add(offerCode);
 297             }
 298         }
 299         // remove all offers in the offersToRemove list from original offers list
 300         for (OfferCode offerCode : offerCodesToRemove) {
 301             offerCodes.remove(offerCode);
 302         }
 303         return offerCodes;
 304     }
 305 
<abbr title=" 306     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodesAndOffers(List&lt;OfferCode&gt; offerCodes, List&lt;Offer&gt; offers) {"> 306     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodesAndOffers(List&lt;OfferCode&gt; offerCodes, List&lt;Offer&gt; ðŸ”µ</abbr>
 307         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();
 308         for (OfferCode offerCode : offerCodes) {
 309             if (!offerCode.isActive()) {
 310                 offerCodesToRemove.add(offerCode);
 311             }
 312         }
 313         // remove all offers in the offersToRemove list from original offers list
 314         for (OfferCode offerCode : offerCodesToRemove) {
 315             offerCodes.remove(offerCode);
 316             offers.remove(offerCode.getOffer());
 317         }
 318         return offerCodes;
 319     }
 320 
 321     /**
 322      * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with
 323      * current sandbox status.
 324      *
 325      * @param order the order to check
 326      * @return the refreshed list of OfferCodes
 327      */
 328     protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {
 329         final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();
 330         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 331             @Override
 332             public void execute() {
 333                 for (OfferCode offerCode : orderOfferCodes) {
 334                     if (offerCode.getOffer() != null) {
<abbr title=" 335                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 335                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCðŸ”µ</abbr>
<abbr title=" 336                         if ((sandBoxVersionId != null) &amp;&amp; (!Objects.equals(sandBoxVersionId, offerCode.getOffer().getId()))) {"> 336                         if ((sandBoxVersionId != null) &amp;&amp; (!Objects.equals(sandBoxVersionId, offerCode.geðŸ”µ</abbr>
 337                             em.refresh(offerCode);
 338                         }
 339                     }
 340                 }
 341             }
 342 
 343             @Override
 344             public boolean shouldRetryOnTransactionLockAcquisitionFailure() {
 345                 return true;
 346             }
 347         }, java.lang.RuntimeException.class);
 348         return orderOfferCodes;
 349     }
 350 
 351     /*
 352      *
 353      * Offers Logic:
 354      * 1) Remove all existing offers in the Order (order, item, and fulfillment)
 355      * 2) Check and remove offers
 356      *    a) Remove out of date offers
 357      *    b) Remove offers that do not apply to this customer
 358      * 3) Loop through offers
 359      *    a) Verifies type of offer (order, order item, fulfillment)
 360      *    b) Verifies if offer can be applies
 361      *    c) Assign offer to type (order, order item, or fulfillment)
 362      * 4) Sorts the order and item offers list by priority and then discount
 363      * 5) Identify the best offers to apply to order item and create adjustments for each item offer
<abbr title=" 364      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better"> 364      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is betðŸ”µ</abbr>
 365      * 7) Identify the best offers to apply to the order and create adjustments for each order offer
<abbr title=" 366      * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 366      * 8) If item contains non-combinable offers remove either the item or order adjustments based on disðŸ”µ</abbr>
 367      * 9) Set final order item prices and reapply order offers
 368      *
 369      * Assumptions:
 370      * 1) % off all items will be created as an item offer with no expression
 371      * 2) $ off order will be created as an order offer
 372      * 3) Order offers applies to the best price for each item (not just retail price)
 373      * 4) Fulfillment offers apply to best price for each item (not just retail price)
<abbr title=" 374      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 374      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used witðŸ”µ</abbr>
 375      * 6) Fulfillment offers cannot be not combinable
 376      * 7) Order offers cannot be FIXED_PRICE
 377      * 8) FIXED_PRICE offers cannot be stackable
<abbr title=" 378      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 378      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will alðŸ”µ</abbr>
 379      *
 380      */
 381     @Override
 382     @Transactional(&quot;blTransactionManager&quot;)
 383     public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 384         /*
 385         TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to
 386         use a richer object to describe the parameters of the pricing call. This object would include
 387         the pricing boolean, but would also include a list of activities to include or exclude in the
 388         call - see http://jira.broadleafcommerce.org/browse/BLC-664
 389          */
<abbr title=" 390         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 390         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINðŸ”µ</abbr>
 391         int offerCount = 0;
 392         if ((o != null) &amp;&amp; ((Boolean) (o))) {
<abbr title=" 393             if (org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())) {"> 393             if (org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())) ðŸ”µ</abbr>
 394                 for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {
 395                     if (orderAdjustment.getOffer() != null) {
 396                         offerCount++;
 397                     }
 398                 }
 399             }
 400         }
 401         OfferContext offerContext = OfferContext.getOfferContext();
 402         if ((offerContext == null) || offerContext.executePromotionCalculation) {
 403             PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false);
 404             List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);
 405             removeOutOfDateOfferCodesAndOffers(orderOfferCodes, offers);
 406             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());
 407             if ((filteredOffers == null) || filteredOffers.isEmpty()) {
 408                 if (LOG.isTraceEnabled()) {
 409                     LOG.trace(&quot;No offers applicable to this order.&quot;);
 410                 }
 411             } else {
<abbr title=" 412                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 412                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidðŸ”µ</abbr>
<abbr title=" 413                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 413                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
<abbr title=" 414                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 414                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, quðŸ”µ</abbr>
 415                 if (!(qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {
<abbr title=" 416                     // At this point, we should have a PromotableOrder that contains PromotableItems each of which"> 416                     // At this point, we should have a PromotableOrder that contains PromotableItems eachðŸ”µ</abbr>
 417                     // has a list of candidatePromotions that might be applied.
<abbr title=" 418                     // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 418                     // We also have a list of orderOffers that might apply and a list of itemOffers that ðŸ”µ</abbr>
<abbr title=" 419                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 419                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOðŸ”µ</abbr>
 420                 }
 421             }
 422             orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 423             verifyAdjustments(order, true);
 424             order.setSubTotal(order.calculateSubTotal());
 425             order.finalizeItemPrices();
 426             order = orderService.save(order, false);
 427             boolean madeChange = verifyAdjustments(order, false);
 428             if (madeChange) {
 429                 order = orderService.save(order, false);
 430             }
 431             int offerCountAfter = 0;
 432             if ((o != null) &amp;&amp; ((Boolean) (o))) {
<abbr title=" 433                 if (org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())) {"> 433                 if (org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments(ðŸ”µ</abbr>
 434                     for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {
 435                         if (orderAdjustment.getOffer() != null) {
 436                             offerCountAfter++;
 437                         }
 438                     }
 439                 }
 440                 if (offerCountAfter != offerCount) {
<abbr title=" 441                     BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 441                     BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfðŸ”µ</abbr>
 442                 }
 443             }
 444         }
 445         return order;
 446     }
 447 
 448     protected boolean verifyAdjustments(Order order, boolean beforeSave) {
 449         boolean madeChange = false;
 450         if (order.getOrderItems() == null) {
 451             return madeChange;
 452         }
 453         for (OrderItem oi : order.getOrderItems()) {
 454             if (oi.getOrderItemPriceDetails() == null) {
 455                 continue;
 456             }
 457             for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {
 458                 if (pd.getOrderItemPriceDetailAdjustments() == null) {
 459                     continue;
 460                 }
<abbr title=" 461                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 461                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdðŸ”µ</abbr>
<abbr title=" 462                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 462                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDeðŸ”µ</abbr>
 463                 for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {
 464                     if (adjs.containsKey(adj.getOffer().getId())) {
 465                         adjustmentsToRemove.add(adj);
 466                         if (LOG.isDebugEnabled()) {
<abbr title=" 467                             StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;).append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;).append(&quot; with ids &quot;).append(adjs.get(adj.getOffer().getId()).getId()).append(&quot; and &quot;).append(adj.getId());"> 467                             StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;).append(beforeSavðŸ”µ</abbr>
 468                             LOG.debug(sb.toString());
 469                         }
 470                     } else {
 471                         adjs.put(adj.getOffer().getId(), adj);
 472                     }
 473                 }
 474                 for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {
 475                     pd.getOrderItemPriceDetailAdjustments().remove(adj);
 476                     madeChange = true;
 477                 }
 478             }
 479         }
 480         return madeChange;
 481     }
 482 
 483     @Override
 484     @Transactional(&quot;blTransactionManager&quot;)
 485     @Deprecated
 486     public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 487         applyAndSaveOffersToOrder(offers, order);
 488     }
 489 
 490     @Override
 491     @Transactional(&quot;blTransactionManager&quot;)
 492     @Deprecated
<abbr title=" 493     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 493     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptiðŸ”µ</abbr>
 494         applyAndSaveFulfillmentGroupOffersToOrder(offers, order);
 495     }
 496 
 497     @Override
 498     @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 499     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 499     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricinðŸ”µ</abbr>
 500         OfferContext offerContext = OfferContext.getOfferContext();
 501         if ((offerContext == null) || offerContext.executePromotionCalculation) {
 502             PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, true);
 503             List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();
 504             for (Offer offer : offers) {
 505                 if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {
 506                     possibleFGOffers.add(offer);
 507                 }
 508             }
<abbr title=" 509             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());"> 509             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustðŸ”µ</abbr>
<abbr title=" 510             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 510             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCaðŸ”µ</abbr>
 511             for (Offer offer : filteredOffers) {
<abbr title=" 512                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 512                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifieðŸ”µ</abbr>
 513             }
 514             if (!qualifiedFGOffers.isEmpty()) {
<abbr title=" 515                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);"> 515                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotabðŸ”µ</abbr>
 516                 fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);
 517                 orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 518             }
 519             return orderService.save(order, false);
 520         }
 521         return order;
 522     }
 523 
 524     @Override
 525     public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {
 526         Customer customer = order.getCustomer();
 527         if (offer.isLimitedUsePerCustomer()) {
<abbr title=" 528             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());"> 528             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getIdðŸ”µ</abbr>
 529             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 530                 return false;
 531             }
 532         }
 533         return true;
 534     }
 535 
 536     @Deprecated
 537     @Override
 538     public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {
 539         if (offer.isLimitedUsePerCustomer()) {
 540             Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());
 541             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 542                 return false;
 543             }
 544         }
 545         return true;
 546     }
 547 
 548     @Override
 549     public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {
 550         boolean underCodeMaxUses = true;
 551         if (code.isLimitedUse()) {
 552             Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());
 553             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 554         }
 555         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());
 556     }
 557 
 558     @Deprecated
 559     @Override
 560     public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {
 561         boolean underCodeMaxUses = true;
 562         if (code.isLimitedUse()) {
 563             Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());
 564             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 565         }
 566         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());
 567     }
 568 
 569     @Override
 570     @SuppressWarnings(&quot;unchecked&quot;)
 571     public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {
 572         HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();
 573         Transformer adjustmentToOfferTransformer = new Transformer() {
 574             @Override
 575             public Object transform(Object input) {
 576                 return ((Adjustment) (input)).getOffer();
 577             }
 578         };
<abbr title=" 579         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));"> 579         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer))ðŸ”µ</abbr>
 580         if (order.getOrderItems() != null) {
 581             for (OrderItem item : order.getOrderItems()) {
<abbr title=" 582                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 582                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTrðŸ”µ</abbr>
 583                 //record usage for price details on the item as well
 584                 if (item.getOrderItemPriceDetails() != null) {
 585                     for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 586                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 586                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments()ðŸ”µ</abbr>
 587                     }
 588                 }
 589             }
 590         }
 591         if (order.getFulfillmentGroups() != null) {
 592             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
<abbr title=" 593                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 593                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfðŸ”µ</abbr>
 594             }
 595         }
 596         return result;
 597     }
 598 
 599     @Override
 600     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order) {
 601         return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order));
 602     }
 603 
 604     @Override
<abbr title=" 605     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {"> 605     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffðŸ”µ</abbr>
 606         HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();
 607         for (OfferCode code : codes) {
 608             if (appliedOffers.contains(code.getOffer())) {
 609                 offerToCodeMapping.put(code.getOffer(), code);
 610             }
 611             List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();
 612             extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);
 613             for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {
 614                 offerToCodeMapping.put(additionalOfferToBeApplied, code);
 615             }
 616         }
 617         return offerToCodeMapping;
 618     }
 619 
 620     @Override
 621     @Transactional(&quot;blTransactionManager&quot;)
 622     public Boolean deleteOfferCode(OfferCode code) {
 623         if (offerCodeDao.offerCodeIsUsed(code)) {
 624             return false;
 625         }
 626         offerCodeDao.delete(code);
 627         return true;
 628     }
 629 
 630     @Transactional(&quot;blTransactionManager&quot;)
 631     @Override
 632     public Offer duplicate(Long originalOfferId) {
 633         Map&lt;String, String&gt; copyHints = new HashMap&lt;String, String&gt;();
 634         copyHints.put(OfferImpl.EXCLUDE_OFFERCODE_COPY_HINT, &quot;true&quot;);
 635         return duplicator.copy(OfferImpl.class, originalOfferId, copyHints, offerDuplicateModifier);
 636     }
 637 
 638     @Override
 639     public CustomerOfferDao getCustomerOfferDao() {
 640         return customerOfferDao;
 641     }
 642 
 643     @Override
 644     public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {
 645         this.customerOfferDao = customerOfferDao;
 646     }
 647 
 648     @Override
 649     public OfferCodeDao getOfferCodeDao() {
 650         return offerCodeDao;
 651     }
 652 
 653     @Override
 654     public void setOfferCodeDao(OfferCodeDao offerCodeDao) {
 655         this.offerCodeDao = offerCodeDao;
 656     }
 657 
 658     @Override
 659     public OfferDao getOfferDao() {
 660         return offerDao;
 661     }
 662 
 663     @Override
 664     public void setOfferDao(OfferDao offerDao) {
 665         this.offerDao = offerDao;
 666     }
 667 
 668     @Override
 669     public OrderOfferProcessor getOrderOfferProcessor() {
 670         return orderOfferProcessor;
 671     }
 672 
 673     @Override
 674     public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {
 675         this.orderOfferProcessor = orderOfferProcessor;
 676     }
 677 
 678     @Override
 679     public ItemOfferProcessor getItemOfferProcessor() {
 680         return itemOfferProcessor;
 681     }
 682 
 683     @Override
 684     public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {
 685         this.itemOfferProcessor = itemOfferProcessor;
 686     }
 687 
 688     @Override
 689     public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {
 690         return fulfillmentGroupOfferProcessor;
 691     }
 692 
 693     @Override
<abbr title=" 694     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {"> 694     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProðŸ”µ</abbr>
 695         this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;
 696     }
 697 
 698     @Override
 699     public PromotableItemFactory getPromotableItemFactory() {
 700         return promotableItemFactory;
 701     }
 702 
 703     @Override
 704     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 705         this.promotableItemFactory = promotableItemFactory;
 706     }
 707 
 708     @Override
 709     public OfferCode findOfferCodeById(Long id) {
 710         return offerCodeDao.readOfferCodeById(id);
 711     }
 712 
 713     @Override
 714     public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {
 715         return offerCodeDao.readOfferCodesByIds(ids);
 716     }
 717 
 718     @Override
 719     public OrderService getOrderService() {
 720         return orderService;
 721     }
 722 
 723     @Override
 724     public void setOrderService(OrderService orderService) {
 725         this.orderService = orderService;
 726     }
 727 
 728     @Override
 729     public Offer findOfferById(Long offerId) {
 730         return offerDao.readOfferById(offerId);
 731     }
 732 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.offer.service;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.Transformer;
  22  import org.apache.commons.logging.Log;
  23  import org.apache.commons.logging.LogFactory;
  24  import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;
  25  import org.broadleafcommerce.common.persistence.EntityDuplicator;
  26  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  27  import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  28  import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  29  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  30  import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  31  import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  32  import org.broadleafcommerce.core.offer.dao.OfferDao;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import org.broadleafcommerce.core.offer.domain.Adjustment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import org.broadleafcommerce.core.offer.domain.CustomerOffer;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import org.broadleafcommerce.core.offer.domain.Offer;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import org.broadleafcommerce.core.offer.domain.OfferCode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import org.broadleafcommerce.core.offer.domain.OfferImpl;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +import org.broadleafcommerce.core.offer.domain.*;</span>
  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  42  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  43  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  44  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  45  import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;
  46  import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;
  47  import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;
  48  import org.broadleafcommerce.core.offer.service.type.OfferType;
  49  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  50  import org.broadleafcommerce.core.order.domain.Order;
  51  import org.broadleafcommerce.core.order.domain.OrderItem;
  52  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  53  import org.broadleafcommerce.core.order.service.OrderService;
  54  import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  55  import org.broadleafcommerce.profile.core.domain.Customer;
  56  import org.springframework.stereotype.Service;
  57  import org.springframework.transaction.annotation.Transactional;
  58  
  59  import java.util.ArrayList;
  60  import java.util.Collection;
  61  import java.util.HashMap;
  62  import java.util.HashSet;
  63  import java.util.Iterator;
  64  import java.util.List;
  65  import java.util.Map;
  66  import java.util.Objects;
  67  import java.util.Set;
  68  
  69  import javax.annotation.Resource;
  70  import javax.persistence.EntityManager;
  71  import javax.persistence.PersistenceContext;
  72  
  73  /**
  74   * The Class OfferServiceImpl.
  75   */
  76  @Service(&quot;blOfferService&quot;)
  77  public class OfferServiceImpl implements OfferService {
  78  
  79      private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);
  80      public static final String FINALIZE_CHECKOUT = &quot;FINALIZE_CHECKOUT&quot;;
  81      public static final String OFFERS_EXPIRED = &quot;OFFERS_EXPIRED&quot;;
  82  
  83      // should be called outside of Offer service after Offer service is executed
  84      @Resource(name=&quot;blCustomerOfferDao&quot;)
  85      protected CustomerOfferDao customerOfferDao;
  86  
  87      @Resource(name=&quot;blOfferCodeDao&quot;)
  88      protected OfferCodeDao offerCodeDao;
  89  
  90      @Resource(name=&quot;blOfferAuditService&quot;)
  91      protected OfferAuditService offerAuditService;
  92  
  93      @Resource(name=&quot;blOfferDao&quot;)
  94      protected OfferDao offerDao;
  95  
  96      @Resource(name=&quot;blOrderOfferProcessor&quot;)
  97      protected OrderOfferProcessor orderOfferProcessor;
  98  
  99      @Resource(name=&quot;blItemOfferProcessor&quot;)
 100      protected ItemOfferProcessor itemOfferProcessor;
 101  
 102      @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)
 103      protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;
 104  
 105      @Resource(name=&quot;blPromotableItemFactory&quot;)
 106      protected PromotableItemFactory promotableItemFactory;
 107  
 108      @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
 109      protected OfferServiceExtensionManager extensionManager;
 110  
 111      @Resource(name = &quot;blOrderService&quot;)
 112      protected OrderService orderService;
 113  
 114      @Resource(name = &quot;blSandBoxHelper&quot;)
 115      protected SandBoxHelper sandBoxHelper;
 116  
 117      @PersistenceContext(unitName=&quot;blPU&quot;)
 118      protected EntityManager em;
 119  
 120      @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 121      protected StreamingTransactionCapableUtil transUtil;
 122  
 123      @Resource(name=&quot;blEntityDuplicator&quot;)
 124      protected EntityDuplicator duplicator;
 125  
 126      @Resource(name=&quot;blOfferDuplicateModifier&quot;)
 127      protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;
 128  
 129      @Override
 130      public List&lt;Offer&gt; findAllOffers() {
 131          return offerDao.readAllOffers();
 132      }
 133  
 134      @Override
 135      @Transactional(&quot;blTransactionManager&quot;)
 136      public Offer save(Offer offer) {
 137          return offerDao.save(offer);
 138      }
 139  
 140      @Override
 141      @Transactional(&quot;blTransactionManager&quot;)
 142      public OfferCode saveOfferCode(OfferCode offerCode) {
 143          offerCode.setOffer(offerDao.save(offerCode.getOffer()));
 144          return offerCodeDao.save(offerCode);
 145      }
 146  
 147      /**
 148       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,
 149       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer
 150       * cannot appear more than once in the list.
 151       *
 152       * @param code
 153       * @return a List of offers that may apply to this order
 154       */
 155      @Override
 156      public Offer lookupOfferByCode(String code) {
 157          Offer offer = null;
 158          OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);
 159          if (offerCode != null) {
 160              offer = offerCode.getOffer();
 161          }
 162          return offer;
 163      }
 164  
 165      @Override
 166      public OfferCode lookupOfferCodeByCode(String code){
 167          return offerCodeDao.readOfferCodeByCode(code);
 168      }
 169  
 170      @Override
 171      public List&lt;Offer&gt; lookupAllOffersByCode(String code) {
 172          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 173          List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);
 174          for (OfferCode offerCode : offerCodes) {
 175              if (offerCode != null) {
 176                  offers.add(offerCode.getOffer());
 177              }
 178          }
 179          return offers;
 180      }
 181  
 182      @Override
 183      public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){
 184          return offerCodeDao.readAllOfferCodesByCode(code);
 185      }
 186  
 187      /**
 188       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,
 189       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer
 190       * cannot appear more than once in the list.
 191       *
 192       * @param order
 193       * @return a List of offers that may apply to this order
 194       */
 195      @Override
 196      public List&lt;Offer&gt; buildOfferListForOrder(Order order) {
 197          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 198          List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());
 199          for (CustomerOffer customerOffer : customerOffers) {
 200              if (!offers.contains(customerOffer.getOffer())) {
 201                  offers.add(customerOffer.getOffer());
 202              }
 203          }
 204          List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -        int before = orderOfferCodes.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -        orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -        int after = orderOfferCodes.size();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +//        int before = orderOfferCodes.size();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +//        orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +/*        int after = orderOfferCodes.size();</span>
<abbr title=" 211          Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 211          Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHEðŸ”µ</abbr>
 212          if(o !=null &amp;&amp; (Boolean)o &amp;&amp; before!=after){
<abbr title=" 213              BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 213              BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +        }*/</span>
 216          for (OfferCode orderOfferCode : orderOfferCodes) {
 217              if (!offers.contains(orderOfferCode.getOffer())) {
 218                  offers.add(orderOfferCode.getOffer());
 219              }
 220              extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);
 221          }
 222          List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();
 223          for (Offer globalOffer : globalOffers) {
 224              if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {
 225                  offers.add(globalOffer);
 226              }
 227          }
 228  
 229          if (extensionManager != null) {
 230              extensionManager.applyAdditionalFilters(offers, order);
 231          }
 232  
 233          return offers;
 234      }
 235  
 236      @Override
 237      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {
 238          Customer customer = order.getCustomer();
 239          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();
 240  
 241          if (extensionManager != null) {
 242              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 243          }
 244          if (!offerCodes.isEmpty()) {
 245              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 246              while (itr.hasNext()) {
 247                  OfferCode offerCode = itr.next();
 248                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {
 249                      itr.remove();
 250                  }
 251              }
 252          }
 253          return offerCodes;
 254      }
 255  
 256      @Deprecated
 257      @Override
 258      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {
 259          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();
 260          if (extensionManager != null) {
 261              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 262          }
 263          if (!offerCodes.isEmpty()) {
 264              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 265              while (itr.hasNext()) {
 266                  OfferCode offerCode = itr.next();
 267                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {
 268                      itr.remove();
 269                  }
 270              }
 271          }
 272          return offerCodes;
 273      }
 274  
 275      /**
 276       * Private method used to retrieve all offers assigned to this customer.  These offers are
 277       * programmatically assigned to the customer.
 278       *
 279       * @param customer
 280       * @return a List of offers assigned to the customer
 281       */
 282      protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {
 283          List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);
 284          return offerCustomers;
 285      }
 286  
 287      /**
 288       * Private method used to retrieve all offers with automaticallyAdded set to true
 289       *
 290       * @return a List of automatic delivery offers
 291       */
 292      protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {
 293          List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();
 294          return globalOffers;
 295      }
 296  
 297      /**
 298       * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end
 299       * date.  If an offerCode has a later start date, that offerCode will be removed.
 300       * OfferCodes without a start date will still be processed. If the offerCode
 301       * has a end date that has already passed, that offerCode will be removed.  OfferCodes
 302       * without a end date will be processed.  The start and end dates on the offer will
 303       * still need to be evaluated.
 304       *
 305       * @param offerCodes
 306       * @return a List of non-expired offers
 307       */
 308      protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){
 309          List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();
 310          for (OfferCode offerCode : offerCodes) {
 311              if (!offerCode.isActive()){
 312                  offerCodesToRemove.add(offerCode);
 313              }
 314          }
 315          // remove all offers in the offersToRemove list from original offers list
 316          for (OfferCode offerCode : offerCodesToRemove) {
 317              offerCodes.remove(offerCode);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +        return offerCodes;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +    protected List&lt;OfferCode&gt; removeOutOfDateOfferCodesAndOffers(List&lt;OfferCode&gt; offerCodes, List&lt;Offer&gt; offers){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +        List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +        for (OfferCode offerCode : offerCodes) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +            if (!offerCode.isActive()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +                offerCodesToRemove.add(offerCode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +        // remove all offers in the offersToRemove list from original offers list</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +        for (OfferCode offerCode : offerCodesToRemove) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +            offerCodes.remove(offerCode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +            offers.remove(offerCode.getOffer());</span>
 333          }
 334          return offerCodes;
 335      }
 336  
 337      /**
 338       * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with
 339       * current sandbox status.
 340       *
 341       * @param order the order to check
 342       * @return the refreshed list of OfferCodes
 343       */
 344      protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {
 345          final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();
 346  
 347          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 348              @Override
 349              public void execute() {
 350                  for (OfferCode offerCode : orderOfferCodes) {
 351                      if (offerCode.getOffer() != null) {
<abbr title=" 352                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 352                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOfðŸ”µ</abbr>
<abbr title=" 353                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 353                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getðŸ”µ</abbr>
 354                              em.refresh(offerCode);
 355                          }
 356                      }
 357                  }
 358              }
 359  
 360              @Override
 361              public boolean shouldRetryOnTransactionLockAcquisitionFailure() {
 362                  return true;
 363              }
 364          }, RuntimeException.class);
 365  
 366          return orderOfferCodes;
 367      }
 368  
 369      /*
 370       *
 371       * Offers Logic:
 372       * 1) Remove all existing offers in the Order (order, item, and fulfillment)
 373       * 2) Check and remove offers
 374       *    a) Remove out of date offers
 375       *    b) Remove offers that do not apply to this customer
 376       * 3) Loop through offers
 377       *    a) Verifies type of offer (order, order item, fulfillment)
 378       *    b) Verifies if offer can be applies
 379       *    c) Assign offer to type (order, order item, or fulfillment)
 380       * 4) Sorts the order and item offers list by priority and then discount
 381       * 5) Identify the best offers to apply to order item and create adjustments for each item offer
 382       * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better
 383       * 7) Identify the best offers to apply to the order and create adjustments for each order offer
<abbr title=" 384       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 384       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount valðŸ”µ</abbr>
 385       * 9) Set final order item prices and reapply order offers
 386       *
 387       * Assumptions:
 388       * 1) % off all items will be created as an item offer with no expression
 389       * 2) $ off order will be created as an order offer
 390       * 3) Order offers applies to the best price for each item (not just retail price)
 391       * 4) Fulfillment offers apply to best price for each item (not just retail price)
<abbr title=" 392       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 392       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item ofðŸ”µ</abbr>
 393       * 6) Fulfillment offers cannot be not combinable
 394       * 7) Order offers cannot be FIXED_PRICE
 395       * 8) FIXED_PRICE offers cannot be stackable
<abbr title=" 396       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 396       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always applðŸ”µ</abbr>
 397       *
 398       */
 399      @Override
 400      @Transactional(&quot;blTransactionManager&quot;)
 401      public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 402          /*
 403          TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to
 404          use a richer object to describe the parameters of the pricing call. This object would include
 405          the pricing boolean, but would also include a list of activities to include or exclude in the
 406          call - see http://jira.broadleafcommerce.org/browse/BLC-664
 407           */
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 408 +        Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 408 +        Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHEðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 409 +        int offerCount = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 410 +        if(o!=null &amp;&amp; (Boolean)o){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 411 +            if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 412 +                for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 413 +                    if(orderAdjustment.getOffer()!=null){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 414 +                        offerCount++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 415 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 416 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 417 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +        }</span>
 419          OfferContext offerContext = OfferContext.getOfferContext();
 420          if (offerContext == null || offerContext.executePromotionCalculation) {
 421              PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 422 +            List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 423 +            removeOutOfDateOfferCodesAndOffers(orderOfferCodes, offers);</span>
 424              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());
 425              if ((filteredOffers == null) || (filteredOffers.isEmpty())) {
 426                  if (LOG.isTraceEnabled()) {
 427                      LOG.trace(&quot;No offers applicable to this order.&quot;);
 428                  }
 429              } else {
<abbr title=" 430                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 430                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOðŸ”µ</abbr>
<abbr title=" 431                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 431                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffeðŸ”µ</abbr>
 432  
<abbr title=" 433                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 433                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItðŸ”µ</abbr>
 434  
 435                  if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {
 436                      // At this point, we should have a PromotableOrder that contains PromotableItems each of which
 437                      // has a list of candidatePromotions that might be applied.
 438  
<abbr title=" 439                      // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 439                      // We also have a list of orderOffers that might apply and a list of itemOffers that might appðŸ”µ</abbr>
<abbr title=" 440                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 440                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, quðŸ”µ</abbr>
 441                  }
 442              }
 443              orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 444  
 445              verifyAdjustments(order, true);
 446  
 447              order.setSubTotal(order.calculateSubTotal());
 448              order.finalizeItemPrices();
 449  
 450              order = orderService.save(order, false);
 451  
 452              boolean madeChange = verifyAdjustments(order, false);
 453              if (madeChange) {
 454                  order = orderService.save(order, false);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 455 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 456 +            int offerCountAfter=0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 457 +            if(o!=null &amp;&amp; (Boolean)o){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 458 +                if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 459 +                    for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 460 +                        if(orderAdjustment.getOffer()!=null){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 461 +                            offerCountAfter++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 462 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 463 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 464 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 465 +                if(offerCountAfter!=offerCount){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 466 +                    BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 466 +                    BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServicðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 467 +                }</span>
 468              }
 469          }
 470  
 471          return order;
 472      }
 473  
 474      protected boolean verifyAdjustments(Order order, boolean beforeSave) {
 475          boolean madeChange = false;
 476  
 477          if (order.getOrderItems() == null) {
 478              return madeChange;
 479          }
 480  
 481          for (OrderItem oi : order.getOrderItems()) {
 482              if (oi.getOrderItemPriceDetails() == null) {
 483                  continue;
 484              }
 485  
 486              for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {
 487                  if (pd.getOrderItemPriceDetailAdjustments() == null) {
 488                      continue;
 489                  }
 490  
<abbr title=" 491                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 491                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;ðŸ”µ</abbr>
<abbr title=" 492                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 492                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjusðŸ”µ</abbr>
 493                  for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {
 494                      if (adjs.containsKey(adj.getOffer().getId())) {
 495                          adjustmentsToRemove.add(adj);
 496                          if (LOG.isDebugEnabled()) {
 497                              StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)
 498                                  .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)
 499                                  .append(&quot; with ids &quot;)
 500                                  .append(adjs.get(adj.getOffer().getId()).getId())
 501                                  .append(&quot; and &quot;)
 502                                  .append(adj.getId());
 503                              LOG.debug(sb.toString());
 504                          }
 505                      } else {
 506                          adjs.put(adj.getOffer().getId(), adj);
 507                      }
 508                  }
 509  
 510                  for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {
 511                      pd.getOrderItemPriceDetailAdjustments().remove(adj);
 512                      madeChange = true;
 513                  }
 514              }
 515          }
 516  
 517          return madeChange;
 518       }
 519  
 520      @Override
 521      @Transactional(&quot;blTransactionManager&quot;)
 522      @Deprecated
 523      public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 524          applyAndSaveOffersToOrder(offers, order);
 525      }
 526  
 527      @Override
 528      @Transactional(&quot;blTransactionManager&quot;)
 529      @Deprecated
 530      public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 531          applyAndSaveFulfillmentGroupOffersToOrder(offers, order);
 532      }
 533  
 534      @Override
 535      @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 536      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 536      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptioðŸ”µ</abbr>
 537          OfferContext offerContext = OfferContext.getOfferContext();
 538          if (offerContext == null || offerContext.executePromotionCalculation) {
 539              PromotableOrder promotableOrder =
 540                      promotableItemFactory.createPromotableOrder(order, true);
 541              List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();
 542              for (Offer offer : offers) {
 543                  if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {
 544                      possibleFGOffers.add(offer);
 545                  }
 546              }
 547              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());
<abbr title=" 548              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 548              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFuðŸ”µ</abbr>
 549              for (Offer offer : filteredOffers) {
<abbr title=" 550                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 550                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffersðŸ”µ</abbr>
 551              }
 552              if (!qualifiedFGOffers.isEmpty()) {
 553                  fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);
 554                  fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);
 555                  orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 556              }
 557  
 558              return orderService.save(order, false);
 559          }
 560          return order;
 561      }
 562  
 563      @Override
 564      public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {
 565          Customer customer = order.getCustomer();
 566  
 567          if (offer.isLimitedUsePerCustomer()) {
 568              Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());
 569  
 570              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 571                  return false;
 572              }
 573          }
 574  
 575          return true;
 576      }
 577  
 578      @Deprecated
 579      @Override
 580      public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {
 581          if (offer.isLimitedUsePerCustomer()) {
 582              Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());
 583  
 584              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 585                  return false;
 586              }
 587          }
 588  
 589          return true;
 590      }
 591  
 592      @Override
 593      public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {
 594          boolean underCodeMaxUses = true;
 595  
 596          if (code.isLimitedUse()) {
 597              Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());
 598              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 599          }
 600  
 601          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());
 602      }
 603  
 604      @Deprecated
 605      @Override
 606      public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {
 607          boolean underCodeMaxUses = true;
 608          if (code.isLimitedUse()) {
 609              Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());
 610              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 611          }
 612          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());
 613      }
 614  
 615      @Override
 616      @SuppressWarnings(&quot;unchecked&quot;)
 617      public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {
 618          HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();
 619  
 620          Transformer adjustmentToOfferTransformer = new Transformer() {
 621  
 622              @Override
 623              public Object transform(Object input) {
 624                  return ((Adjustment)input).getOffer();
 625              }
 626          };
 627  
 628          result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));
 629  
 630          if (order.getOrderItems() != null) {
 631              for (OrderItem item : order.getOrderItems()) {
<abbr title=" 632                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 632                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformerðŸ”µ</abbr>
 633  
 634                  //record usage for price details on the item as well
 635                  if (item.getOrderItemPriceDetails() != null) {
 636                      for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 637                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 637                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmðŸ”µ</abbr>
 638                      }
 639                  }
 640              }
 641          }
 642  
 643          if (order.getFulfillmentGroups() != null) {
 644              for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
<abbr title=" 645                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 645                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransfðŸ”µ</abbr>
 646              }
 647          }
 648          return result;
 649      }
 650  
 651      @Override
 652      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {
 653          return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order));
 654      }
 655  
 656      @Override
 657      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {
 658          HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();
 659          for (OfferCode code : codes) {
 660              if (appliedOffers.contains(code.getOffer())) {
 661                  offerToCodeMapping.put(code.getOffer(), code);
 662              }
 663  
 664              List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();
 665  
 666              extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);
 667              for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {
 668                  offerToCodeMapping.put(additionalOfferToBeApplied, code);
 669              }
 670          }
 671          return offerToCodeMapping;
 672      }
 673  
 674      @Override
 675      @Transactional(&quot;blTransactionManager&quot;)
 676      public Boolean deleteOfferCode(OfferCode code) {
 677          if (offerCodeDao.offerCodeIsUsed(code)) {
 678              return false;
 679          }
 680  
 681          offerCodeDao.delete(code);
 682          return true;
 683      }
 684  
 685      @Transactional(&quot;blTransactionManager&quot;)
 686      @Override
 687      public Offer duplicate(Long originalOfferId) {
 688          Map&lt;String, String&gt; copyHints = new HashMap&lt;String, String&gt;();
 689          copyHints.put(OfferImpl.EXCLUDE_OFFERCODE_COPY_HINT, &quot;true&quot;);
 690          return duplicator.copy(OfferImpl.class, originalOfferId, copyHints, offerDuplicateModifier);
 691      }
 692  
 693      @Override
 694      public CustomerOfferDao getCustomerOfferDao() {
 695          return customerOfferDao;
 696      }
 697  
 698      @Override
 699      public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {
 700          this.customerOfferDao = customerOfferDao;
 701      }
 702  
 703      @Override
 704      public OfferCodeDao getOfferCodeDao() {
 705          return offerCodeDao;
 706      }
 707  
 708      @Override
 709      public void setOfferCodeDao(OfferCodeDao offerCodeDao) {
 710          this.offerCodeDao = offerCodeDao;
 711      }
 712  
 713      @Override
 714      public OfferDao getOfferDao() {
 715          return offerDao;
 716      }
 717  
 718      @Override
 719      public void setOfferDao(OfferDao offerDao) {
 720          this.offerDao = offerDao;
 721      }
 722  
 723      @Override
 724      public OrderOfferProcessor getOrderOfferProcessor() {
 725          return orderOfferProcessor;
 726      }
 727  
 728      @Override
 729      public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {
 730          this.orderOfferProcessor = orderOfferProcessor;
 731      }
 732  
 733      @Override
 734      public ItemOfferProcessor getItemOfferProcessor() {
 735          return itemOfferProcessor;
 736      }
 737  
 738      @Override
 739      public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {
 740          this.itemOfferProcessor = itemOfferProcessor;
 741      }
 742  
 743      @Override
 744      public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {
 745          return fulfillmentGroupOfferProcessor;
 746      }
 747  
 748      @Override
 749      public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {
 750          this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;
 751      }
 752  
 753      @Override
 754      public PromotableItemFactory getPromotableItemFactory() {
 755          return promotableItemFactory;
 756      }
 757  
 758      @Override
 759      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 760          this.promotableItemFactory = promotableItemFactory;
 761      }
 762  
 763      @Override
 764      public OfferCode findOfferCodeById(Long id) {
 765          return offerCodeDao.readOfferCodeById(id);
 766      }
 767  
 768      @Override
 769      public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {
 770          return offerCodeDao.readOfferCodesByIds(ids);
 771      }
 772  
 773      @Override
 774      public OrderService getOrderService() {
 775          return orderService;
 776      }
 777  
 778      @Override
 779      public void setOrderService(OrderService orderService) {
 780          this.orderService = orderService;
 781      }
 782  
 783      @Override
 784      public Offer findOfferById(Long offerId) {
 785          return offerDao.readOfferById(offerId);
 786      }
 787  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.offer.service;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.Transformer;
  22  import org.apache.commons.logging.Log;
  23  import org.apache.commons.logging.LogFactory;
  24  import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;
  25  import org.broadleafcommerce.common.persistence.EntityDuplicator;
  26  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  27  import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  28  import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import org.broadleafcommerce.common.web.BroadleafRequestContext;</span>
  30  import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  31  import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  32  import org.broadleafcommerce.core.offer.dao.OfferDao;
  33  import org.broadleafcommerce.core.offer.domain.Adjustment;
  34  import org.broadleafcommerce.core.offer.domain.CustomerOffer;
  35  import org.broadleafcommerce.core.offer.domain.Offer;
  36  import org.broadleafcommerce.core.offer.domain.OfferCode;
  37  import org.broadleafcommerce.core.offer.domain.OfferImpl;
  38  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;

  39  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  42  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  43  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  44  import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;
  45  import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;
  46  import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;
  47  import org.broadleafcommerce.core.offer.service.type.OfferType;
  48  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  49  import org.broadleafcommerce.core.order.domain.Order;
  50  import org.broadleafcommerce.core.order.domain.OrderItem;
  51  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  52  import org.broadleafcommerce.core.order.service.OrderService;
  53  import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  54  import org.broadleafcommerce.profile.core.domain.Customer;
  55  import org.springframework.stereotype.Service;
  56  import org.springframework.transaction.annotation.Transactional;
  57  
  58  import java.util.ArrayList;
  59  import java.util.Collection;
  60  import java.util.HashMap;
  61  import java.util.HashSet;
  62  import java.util.Iterator;
  63  import java.util.List;
  64  import java.util.Map;
  65  import java.util.Objects;
  66  import java.util.Set;
  67  
  68  import javax.annotation.Resource;
  69  import javax.persistence.EntityManager;
  70  import javax.persistence.PersistenceContext;
  71  
  72  /**
  73   * The Class OfferServiceImpl.
  74   */
  75  @Service(&quot;blOfferService&quot;)
  76  public class OfferServiceImpl implements OfferService {
  77  
  78      private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -    public static final String FINALIZE_CHECKOUT = &quot;FINALIZE_CHECKOUT&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -    public static final String OFFERS_EXPIRED = &quot;OFFERS_EXPIRED&quot;;</span>
  81  
  82      // should be called outside of Offer service after Offer service is executed
  83      @Resource(name=&quot;blCustomerOfferDao&quot;)
  84      protected CustomerOfferDao customerOfferDao;
  85  
  86      @Resource(name=&quot;blOfferCodeDao&quot;)
  87      protected OfferCodeDao offerCodeDao;
  88  
  89      @Resource(name=&quot;blOfferAuditService&quot;)
  90      protected OfferAuditService offerAuditService;
  91  
  92      @Resource(name=&quot;blOfferDao&quot;)
  93      protected OfferDao offerDao;
  94  
  95      @Resource(name=&quot;blOrderOfferProcessor&quot;)
  96      protected OrderOfferProcessor orderOfferProcessor;
  97  
  98      @Resource(name=&quot;blItemOfferProcessor&quot;)
  99      protected ItemOfferProcessor itemOfferProcessor;
 100  
 101      @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)
 102      protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;
 103  
 104      @Resource(name=&quot;blPromotableItemFactory&quot;)
 105      protected PromotableItemFactory promotableItemFactory;
 106  
 107      @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
 108      protected OfferServiceExtensionManager extensionManager;
 109  
 110      @Resource(name = &quot;blOrderService&quot;)
 111      protected OrderService orderService;
 112  
 113      @Resource(name = &quot;blSandBoxHelper&quot;)
 114      protected SandBoxHelper sandBoxHelper;
 115  
 116      @PersistenceContext(unitName=&quot;blPU&quot;)
 117      protected EntityManager em;
 118  
 119      @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 120      protected StreamingTransactionCapableUtil transUtil;
 121  
 122      @Resource(name=&quot;blEntityDuplicator&quot;)
 123      protected EntityDuplicator duplicator;
 124  
 125      @Resource(name=&quot;blOfferDuplicateModifier&quot;)
 126      protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;
 127  
 128      @Override
 129      public List&lt;Offer&gt; findAllOffers() {
 130          return offerDao.readAllOffers();
 131      }
 132  
 133      @Override
 134      @Transactional(&quot;blTransactionManager&quot;)
 135      public Offer save(Offer offer) {
 136          return offerDao.save(offer);
 137      }
 138  
 139      @Override
 140      @Transactional(&quot;blTransactionManager&quot;)
 141      public OfferCode saveOfferCode(OfferCode offerCode) {
 142          offerCode.setOffer(offerDao.save(offerCode.getOffer()));
 143          return offerCodeDao.save(offerCode);
 144      }
 145  
 146      /**
 147       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,
 148       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer
 149       * cannot appear more than once in the list.
 150       *
 151       * @param code
 152       * @return a List of offers that may apply to this order
 153       */
 154      @Override
 155      public Offer lookupOfferByCode(String code) {
 156          Offer offer = null;
 157          OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);
 158          if (offerCode != null) {
 159              offer = offerCode.getOffer();
 160          }
 161          return offer;
 162      }
 163  
 164      @Override
 165      public OfferCode lookupOfferCodeByCode(String code){
 166          return offerCodeDao.readOfferCodeByCode(code);
 167      }
 168  
 169      @Override
 170      public List&lt;Offer&gt; lookupAllOffersByCode(String code) {
 171          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 172          List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);
 173          for (OfferCode offerCode : offerCodes) {
 174              if (offerCode != null) {
 175                  offers.add(offerCode.getOffer());
 176              }
 177          }
 178          return offers;
 179      }
 180  
 181      @Override
 182      public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){
 183          return offerCodeDao.readAllOfferCodesByCode(code);
 184      }
 185  
 186      /**
 187       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,
 188       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer
 189       * cannot appear more than once in the list.
 190       *
 191       * @param order
 192       * @return a List of offers that may apply to this order
 193       */
 194      @Override
 195      public List&lt;Offer&gt; buildOfferListForOrder(Order order) {
 196          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 197          List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());
 198          for (CustomerOffer customerOffer : customerOffers) {
 199              if (!offers.contains(customerOffer.getOffer())) {
 200                  offers.add(customerOffer.getOffer());
 201              }
 202          }
 203          List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -        int before = orderOfferCodes.size();</span>
 205          orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -        int after = orderOfferCodes.size();</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 207 -        Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 207 -        Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHEðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -        if(o !=null &amp;&amp; (Boolean)o &amp;&amp; before!=after){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 209 -            BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 209 -            BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -        }</span>

 211          for (OfferCode orderOfferCode : orderOfferCodes) {
 212              if (!offers.contains(orderOfferCode.getOffer())) {
 213                  offers.add(orderOfferCode.getOffer());
 214              }
 215              extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);
 216          }
 217          List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();
 218          for (Offer globalOffer : globalOffers) {
 219              if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {
 220                  offers.add(globalOffer);
 221              }
 222          }
 223  
 224          if (extensionManager != null) {
 225              extensionManager.applyAdditionalFilters(offers, order);
 226          }
 227  
 228          return offers;
 229      }
 230  
 231      @Override
 232      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {
 233          Customer customer = order.getCustomer();
 234          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();
 235  
 236          if (extensionManager != null) {
 237              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 238          }
 239          if (!offerCodes.isEmpty()) {
 240              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 241              while (itr.hasNext()) {
 242                  OfferCode offerCode = itr.next();
 243                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {
 244                      itr.remove();
 245                  }
 246              }
 247          }
 248          return offerCodes;
 249      }
 250  
 251      @Deprecated
 252      @Override
 253      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {
 254          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();
 255          if (extensionManager != null) {
 256              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);
 257          }
 258          if (!offerCodes.isEmpty()) {
 259              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();
 260              while (itr.hasNext()) {
 261                  OfferCode offerCode = itr.next();
 262                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {
 263                      itr.remove();
 264                  }
 265              }
 266          }
 267          return offerCodes;
 268      }
 269  
 270      /**
 271       * Private method used to retrieve all offers assigned to this customer.  These offers are
 272       * programmatically assigned to the customer.
 273       *
 274       * @param customer
 275       * @return a List of offers assigned to the customer
 276       */
 277      protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {
 278          List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);
 279          return offerCustomers;
 280      }
 281  
 282      /**
 283       * Private method used to retrieve all offers with automaticallyAdded set to true
 284       *
 285       * @return a List of automatic delivery offers
 286       */
 287      protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {
 288          List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();
 289          return globalOffers;
 290      }
 291  
 292      /**
 293       * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end
 294       * date.  If an offerCode has a later start date, that offerCode will be removed.
 295       * OfferCodes without a start date will still be processed. If the offerCode
 296       * has a end date that has already passed, that offerCode will be removed.  OfferCodes
 297       * without a end date will be processed.  The start and end dates on the offer will
 298       * still need to be evaluated.
 299       *
 300       * @param offerCodes
 301       * @return a List of non-expired offers
 302       */
 303      protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){
 304          List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();
 305          for (OfferCode offerCode : offerCodes) {
 306              if (!offerCode.isActive()){
 307                  offerCodesToRemove.add(offerCode);
 308              }
 309          }
 310          // remove all offers in the offersToRemove list from original offers list
 311          for (OfferCode offerCode : offerCodesToRemove) {
 312              offerCodes.remove(offerCode);















 313          }
 314          return offerCodes;
 315      }
 316  
 317      /**
 318       * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with
 319       * current sandbox status.
 320       *
 321       * @param order the order to check
 322       * @return the refreshed list of OfferCodes
 323       */
 324      protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {
 325          final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();
 326  
 327          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 328              @Override
 329              public void execute() {
 330                  for (OfferCode offerCode : orderOfferCodes) {
 331                      if (offerCode.getOffer() != null) {
<abbr title=" 332                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 332                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOfðŸ”µ</abbr>
<abbr title=" 333                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 333                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getðŸ”µ</abbr>
 334                              em.refresh(offerCode);
 335                          }
 336                      }
 337                  }
 338              }
 339  
 340              @Override
 341              public boolean shouldRetryOnTransactionLockAcquisitionFailure() {
 342                  return true;
 343              }
 344          }, RuntimeException.class);
 345  
 346          return orderOfferCodes;
 347      }
 348  
 349      /*
 350       *
 351       * Offers Logic:
 352       * 1) Remove all existing offers in the Order (order, item, and fulfillment)
 353       * 2) Check and remove offers
 354       *    a) Remove out of date offers
 355       *    b) Remove offers that do not apply to this customer
 356       * 3) Loop through offers
 357       *    a) Verifies type of offer (order, order item, fulfillment)
 358       *    b) Verifies if offer can be applies
 359       *    c) Assign offer to type (order, order item, or fulfillment)
 360       * 4) Sorts the order and item offers list by priority and then discount
 361       * 5) Identify the best offers to apply to order item and create adjustments for each item offer
 362       * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better
 363       * 7) Identify the best offers to apply to the order and create adjustments for each order offer
<abbr title=" 364       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 364       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount valðŸ”µ</abbr>
 365       * 9) Set final order item prices and reapply order offers
 366       *
 367       * Assumptions:
 368       * 1) % off all items will be created as an item offer with no expression
 369       * 2) $ off order will be created as an order offer
 370       * 3) Order offers applies to the best price for each item (not just retail price)
 371       * 4) Fulfillment offers apply to best price for each item (not just retail price)
<abbr title=" 372       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 372       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item ofðŸ”µ</abbr>
 373       * 6) Fulfillment offers cannot be not combinable
 374       * 7) Order offers cannot be FIXED_PRICE
 375       * 8) FIXED_PRICE offers cannot be stackable
<abbr title=" 376       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 376       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always applðŸ”µ</abbr>
 377       *
 378       */
 379      @Override
 380      @Transactional(&quot;blTransactionManager&quot;)
 381      public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 382          /*
 383          TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to
 384          use a richer object to describe the parameters of the pricing call. This object would include
 385          the pricing boolean, but would also include a list of activities to include or exclude in the
 386          call - see http://jira.broadleafcommerce.org/browse/BLC-664
 387           */











 388          OfferContext offerContext = OfferContext.getOfferContext();
 389          if (offerContext == null || offerContext.executePromotionCalculation) {
 390              PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false);


 391              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());
 392              if ((filteredOffers == null) || (filteredOffers.isEmpty())) {
 393                  if (LOG.isTraceEnabled()) {
 394                      LOG.trace(&quot;No offers applicable to this order.&quot;);
 395                  }
 396              } else {
<abbr title=" 397                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 397                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOðŸ”µ</abbr>
<abbr title=" 398                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 398                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffeðŸ”µ</abbr>
 399  
<abbr title=" 400                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 400                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItðŸ”µ</abbr>
 401  
 402                  if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {
 403                      // At this point, we should have a PromotableOrder that contains PromotableItems each of which
 404                      // has a list of candidatePromotions that might be applied.
 405  
<abbr title=" 406                      // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 406                      // We also have a list of orderOffers that might apply and a list of itemOffers that might appðŸ”µ</abbr>
<abbr title=" 407                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 407                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, quðŸ”µ</abbr>
 408                  }
 409              }
 410              orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 411  
 412              verifyAdjustments(order, true);
 413  
 414              order.setSubTotal(order.calculateSubTotal());
 415              order.finalizeItemPrices();
 416  
 417              order = orderService.save(order, false);
 418  
 419              boolean madeChange = verifyAdjustments(order, false);
 420              if (madeChange) {
 421                  order = orderService.save(order, false);













 422              }
 423          }
 424  
 425          return order;
 426      }
 427  
 428      protected boolean verifyAdjustments(Order order, boolean beforeSave) {
 429          boolean madeChange = false;
 430  
 431          if (order.getOrderItems() == null) {
 432              return madeChange;
 433          }
 434  
 435          for (OrderItem oi : order.getOrderItems()) {
 436              if (oi.getOrderItemPriceDetails() == null) {
 437                  continue;
 438              }
 439  
 440              for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {
 441                  if (pd.getOrderItemPriceDetailAdjustments() == null) {
 442                      continue;
 443                  }
 444  
<abbr title=" 445                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 445                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;ðŸ”µ</abbr>
<abbr title=" 446                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 446                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjusðŸ”µ</abbr>
 447                  for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {
 448                      if (adjs.containsKey(adj.getOffer().getId())) {
 449                          adjustmentsToRemove.add(adj);
 450                          if (LOG.isDebugEnabled()) {
 451                              StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)
 452                                  .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)
 453                                  .append(&quot; with ids &quot;)
 454                                  .append(adjs.get(adj.getOffer().getId()).getId())
 455                                  .append(&quot; and &quot;)
 456                                  .append(adj.getId());
 457                              LOG.debug(sb.toString());
 458                          }
 459                      } else {
 460                          adjs.put(adj.getOffer().getId(), adj);
 461                      }
 462                  }
 463  
 464                  for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {
 465                      pd.getOrderItemPriceDetailAdjustments().remove(adj);
 466                      madeChange = true;
 467                  }
 468              }
 469          }
 470  
 471          return madeChange;
 472       }
 473  
 474      @Override
 475      @Transactional(&quot;blTransactionManager&quot;)
 476      @Deprecated
 477      public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 478          applyAndSaveOffersToOrder(offers, order);
 479      }
 480  
 481      @Override
 482      @Transactional(&quot;blTransactionManager&quot;)
 483      @Deprecated
 484      public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {
 485          applyAndSaveFulfillmentGroupOffersToOrder(offers, order);
 486      }
 487  
 488      @Override
 489      @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 490      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 490      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptioðŸ”µ</abbr>
 491          OfferContext offerContext = OfferContext.getOfferContext();
 492          if (offerContext == null || offerContext.executePromotionCalculation) {
 493              PromotableOrder promotableOrder =
 494                      promotableItemFactory.createPromotableOrder(order, true);
 495              List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();
 496              for (Offer offer : offers) {
 497                  if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {
 498                      possibleFGOffers.add(offer);
 499                  }
 500              }
 501              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());
<abbr title=" 502              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 502              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFuðŸ”µ</abbr>
 503              for (Offer offer : filteredOffers) {
<abbr title=" 504                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 504                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffersðŸ”µ</abbr>
 505              }
 506              if (!qualifiedFGOffers.isEmpty()) {
 507                  fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);
 508                  fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);
 509                  orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);
 510              }
 511  
 512              return orderService.save(order, false);
 513          }
 514          return order;
 515      }
 516  
 517      @Override
 518      public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {
 519          Customer customer = order.getCustomer();
 520  
 521          if (offer.isLimitedUsePerCustomer()) {
 522              Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());
 523  
 524              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 525                  return false;
 526              }
 527          }
 528  
 529          return true;
 530      }
 531  
 532      @Deprecated
 533      @Override
 534      public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {
 535          if (offer.isLimitedUsePerCustomer()) {
 536              Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());
 537  
 538              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {
 539                  return false;
 540              }
 541          }
 542  
 543          return true;
 544      }
 545  
 546      @Override
 547      public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {
 548          boolean underCodeMaxUses = true;
 549  
 550          if (code.isLimitedUse()) {
 551              Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());
 552              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 553          }
 554  
 555          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());
 556      }
 557  
 558      @Deprecated
 559      @Override
 560      public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {
 561          boolean underCodeMaxUses = true;
 562          if (code.isLimitedUse()) {
 563              Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());
 564              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();
 565          }
 566          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());
 567      }
 568  
 569      @Override
 570      @SuppressWarnings(&quot;unchecked&quot;)
 571      public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {
 572          HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();
 573  
 574          Transformer adjustmentToOfferTransformer = new Transformer() {
 575  
 576              @Override
 577              public Object transform(Object input) {
 578                  return ((Adjustment)input).getOffer();
 579              }
 580          };
 581  
 582          result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));
 583  
 584          if (order.getOrderItems() != null) {
 585              for (OrderItem item : order.getOrderItems()) {
<abbr title=" 586                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 586                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformerðŸ”µ</abbr>
 587  
 588                  //record usage for price details on the item as well
 589                  if (item.getOrderItemPriceDetails() != null) {
 590                      for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 591                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 591                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmðŸ”µ</abbr>
 592                      }
 593                  }
 594              }
 595          }
 596  
 597          if (order.getFulfillmentGroups() != null) {
 598              for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
<abbr title=" 599                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 599                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransfðŸ”µ</abbr>
 600              }
 601          }
 602          return result;
 603      }
 604  
 605      @Override
 606      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {
 607          return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order));
 608      }
 609  
 610      @Override
 611      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {
 612          HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();
 613          for (OfferCode code : codes) {
 614              if (appliedOffers.contains(code.getOffer())) {
 615                  offerToCodeMapping.put(code.getOffer(), code);
 616              }
 617  
 618              List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();
 619  
 620              extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);
 621              for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {
 622                  offerToCodeMapping.put(additionalOfferToBeApplied, code);
 623              }
 624          }
 625          return offerToCodeMapping;
 626      }
 627  
 628      @Override
 629      @Transactional(&quot;blTransactionManager&quot;)
 630      public Boolean deleteOfferCode(OfferCode code) {
 631          if (offerCodeDao.offerCodeIsUsed(code)) {
 632              return false;
 633          }
 634  
 635          offerCodeDao.delete(code);
 636          return true;
 637      }
 638  
 639      @Transactional(&quot;blTransactionManager&quot;)
 640      @Override
 641      public Offer duplicate(Long originalOfferId) {
 642          Map&lt;String, String&gt; copyHints = new HashMap&lt;String, String&gt;();
 643          copyHints.put(OfferImpl.EXCLUDE_OFFERCODE_COPY_HINT, &quot;true&quot;);
 644          return duplicator.copy(OfferImpl.class, originalOfferId, copyHints, offerDuplicateModifier);
 645      }
 646  
 647      @Override
 648      public CustomerOfferDao getCustomerOfferDao() {
 649          return customerOfferDao;
 650      }
 651  
 652      @Override
 653      public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {
 654          this.customerOfferDao = customerOfferDao;
 655      }
 656  
 657      @Override
 658      public OfferCodeDao getOfferCodeDao() {
 659          return offerCodeDao;
 660      }
 661  
 662      @Override
 663      public void setOfferCodeDao(OfferCodeDao offerCodeDao) {
 664          this.offerCodeDao = offerCodeDao;
 665      }
 666  
 667      @Override
 668      public OfferDao getOfferDao() {
 669          return offerDao;
 670      }
 671  
 672      @Override
 673      public void setOfferDao(OfferDao offerDao) {
 674          this.offerDao = offerDao;
 675      }
 676  
 677      @Override
 678      public OrderOfferProcessor getOrderOfferProcessor() {
 679          return orderOfferProcessor;
 680      }
 681  
 682      @Override
 683      public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {
 684          this.orderOfferProcessor = orderOfferProcessor;
 685      }
 686  
 687      @Override
 688      public ItemOfferProcessor getItemOfferProcessor() {
 689          return itemOfferProcessor;
 690      }
 691  
 692      @Override
 693      public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {
 694          this.itemOfferProcessor = itemOfferProcessor;
 695      }
 696  
 697      @Override
 698      public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {
 699          return fulfillmentGroupOfferProcessor;
 700      }
 701  
 702      @Override
 703      public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {
 704          this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;
 705      }
 706  
 707      @Override
 708      public PromotableItemFactory getPromotableItemFactory() {
 709          return promotableItemFactory;
 710      }
 711  
 712      @Override
 713      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 714          this.promotableItemFactory = promotableItemFactory;
 715      }
 716  
 717      @Override
 718      public OfferCode findOfferCodeById(Long id) {
 719          return offerCodeDao.readOfferCodeById(id);
 720      }
 721  
 722      @Override
 723      public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {
 724          return offerCodeDao.readOfferCodesByIds(ids);
 725      }
 726  
 727      @Override
 728      public OrderService getOrderService() {
 729          return orderService;
 730      }
 731  
 732      @Override
 733      public void setOrderService(OrderService orderService) {
 734          this.orderService = orderService;
 735      }
 736  
 737      @Override
 738      public Offer findOfferById(Long offerId) {
 739          return offerDao.readOfferById(offerId);
 740      }
 741  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            