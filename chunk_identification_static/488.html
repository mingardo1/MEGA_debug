<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>488</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    488
                    <a href="487.html">prev</a>
                    <a href="489.html">next</a>
                    <a href="488_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_b44a86dc90b7fbefeec65e6c5a467a259b41ec59_core/src/main/java/com/dtstack/flink/sql/Main.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b44a86dc90b7fbefeec65e6c5a467a259b41ec59:core/src/main/java/com/dtstack/flink/sql/Main.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b44a86dc90b7fbefeec65e6c5a467a259b41ec59^1:core/src/main/java/com/dtstack/flink/sql/Main.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b44a86dc90b7fbefeec65e6c5a467a259b41ec59^2:core/src/main/java/com/dtstack/flink/sql/Main.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;1a973cf785a926fcd45c51fa474acc2ae880f8cb:core/src/main/java/com/dtstack/flink/sql/Main.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [j]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql;
  21 
  22 
  23 
  24 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
  25 
  26 import com.dtstack.flink.sql.exec.ExecuteProcessHelper;
  27 import com.dtstack.flink.sql.exec.ParamsInfo;
  28 import org.slf4j.Logger;
  29 import org.slf4j.LoggerFactory;
  30 
  31 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  32 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import ch.qos.logback.classic.Level;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import ch.qos.logback.classic.LoggerContext;</span>
  35 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 </span>
  37 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  38 /**
  39  * Date: 2018/6/26
  40  * Company: www.dtstack.com
  41  * @author xuchao
  42  */
  43 
  44 public class Main {
  45     private static final Logger LOG = LoggerFactory.getLogger(Main.class);
  46 
  47     public static void main(String[] args) throws Exception {
  48         ParamsInfo paramsInfo = ExecuteProcessHelper.parseParams(args);
  49         ExecuteProcessHelper.setLogLevel(paramsInfo);
  50         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExecution(paramsInfo);
  51         env.execute(paramsInfo.getName());
  52         LOG.info(&quot;program {} execution success&quot;, paramsInfo.getName());
  53     }
  54 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql;
  21 
  22 
  23 
  24 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
  25 
  26 import com.dtstack.flink.sql.exec.ExecuteProcessHelper;
  27 import com.dtstack.flink.sql.exec.ParamsInfo;
  28 import org.slf4j.Logger;
  29 import org.slf4j.LoggerFactory;
  30 
  31 
  32 /**
  33  * Date: 2018/6/26
  34  * Company: www.dtstack.com
  35  * @author xuchao
  36  */
  37 
  38 public class Main {
  39     private static final Logger LOG = LoggerFactory.getLogger(Main.class);
  40 
  41     public static void main(String[] args) throws Exception {
  42         ParamsInfo paramsInfo = ExecuteProcessHelper.parseParams(args);
  43 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44         ExecuteProcessHelper.setLogLevel(paramsInfo);</span>
  45 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46         OptionParser optionParser = new OptionParser(args);</span>
  47 =======
  48 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  49         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExecution(paramsInfo);
  50         env.execute(paramsInfo.getName());
  51         LOG.info(&quot;program {} execution success&quot;, paramsInfo.getName());
  52     }
  53 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql;
  19 
  20 import com.dtstack.flink.sql.exec.ExecuteProcessHelper;
  21 import com.dtstack.flink.sql.exec.ParamsInfo;
  22 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
  23 import org.slf4j.Logger;
  24 import org.slf4j.LoggerFactory;
  25 
  26 
  27 /**
  28  * Date: 2018/6/26
  29  * Company: www.dtstack.com
  30  * @author xuchao
  31  */
  32 public class Main {
  33     private static final Logger LOG = LoggerFactory.getLogger(Main.class);
  34 
  35     public static void main(String[] args) throws Exception {
  36         ParamsInfo paramsInfo = ExecuteProcessHelper.parseParams(args);
  37         ExecuteProcessHelper.setLogLevel(paramsInfo);
  38         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExecution(paramsInfo);
  39         env.execute(paramsInfo.getName());
  40         LOG.info(&quot;program {} execution success&quot;, paramsInfo.getName());
  41     }
  42 }
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql;
  21  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.dtstack.flink.sql.config.CalciteConfig;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.classloader.ClassLoaderManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import com.dtstack.flink.sql.enums.ECacheType;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import com.dtstack.flink.sql.environment.StreamEnvConfigManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import com.dtstack.flink.sql.exec.FlinkSQLExec;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import com.dtstack.flink.sql.option.OptionParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import com.dtstack.flink.sql.parser.CreateFuncParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import com.dtstack.flink.sql.parser.CreateTmpTableParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import com.dtstack.flink.sql.parser.InsertSqlParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import com.dtstack.flink.sql.parser.SqlParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import com.dtstack.flink.sql.parser.SqlTree;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import com.dtstack.flink.sql.side.SideSqlExec;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import com.dtstack.flink.sql.side.SideTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import com.dtstack.flink.sql.table.SourceTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import com.dtstack.flink.sql.table.TableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import com.dtstack.flink.sql.table.TargetTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import com.google.common.base.Strings;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +import com.dtstack.flink.sql.exec.ExecuteProcessHelper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +import com.dtstack.flink.sql.exec.ParamsInfo;</span>
  62  import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -import org.apache.flink.types.Row;</span>



  69  import org.slf4j.Logger;
  70  import org.slf4j.LoggerFactory;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -import java.io.File;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -import java.net.URL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -import java.net.URLClassLoader;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -import java.net.URLDecoder;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -import java.util.Map;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -import java.util.Optional;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -import java.util.Properties;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -import java.util.Set;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -import com.dtstack.flink.sql.option.Options;</span>
  84  
  85  /**
  86   * Date: 2018/6/26
  87   * Company: www.dtstack.com
  88   * @author xuchao
  89   */
  90  
  91  public class Main {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -    private static final String CLASS_FILE_NAME_FMT = &quot;class_path_%d&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -    private static final ObjectMapper objMapper = new ObjectMapper();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -</span>
  97      private static final Logger LOG = LoggerFactory.getLogger(Main.class);
  98  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -</span>
 100      public static void main(String[] args) throws Exception {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -        OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        String sql = options.getSql();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -        String name = options.getName();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -        String addJarListStr = options.getAddjar();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -        String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -        String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -        String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -        String deployMode = options.getMode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        String confProp = options.getConfProp();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -        sql = URLDecoder.decode(sql, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -        SqlParser.setLocalSqlPluginRoot(localSqlPluginPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -        List&lt;String&gt; addJarFileList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -        if (!Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -            addJarListStr = URLDecoder.decode(addJarListStr, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -            addJarFileList = objMapper.readValue(addJarListStr, List.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -        confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -        Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -        StreamExecutionEnvironment env = getStreamExeEnv(confProperties, deployMode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -        StreamTableEnvironment tableEnv =  StreamTableEnvironment.getTableEnvironment(env);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 126 -        StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties);"> 126 -        StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -        List&lt;URL&gt; jarURList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -        SqlTree sqlTree = SqlParser.parseSql(sql);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -        //Get External jar to load</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -            File tmpFile = new File(addJarPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -            jarURList.add(tmpFile.toURI().toURL());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -        Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -        Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -        //register udf</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -        registerUserDefinedFunction(sqlTree, jarURList, tableEnv);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        //register table schema</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 143 -        Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode, sideTableMap, registerTableCache);"> 143 -        Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pl🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -        // cache classPathSets</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -        registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 147 -        sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 147 -        sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig)🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -        if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -            ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -        env.execute(name);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 156 -    private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,Map&lt;String, SideTableInfo&gt; sideTableMap,Map&lt;String, Table&gt; registerTableCache, StreamQueryConfig queryConfig) throws Exception {"> 156 -    private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -        SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -        sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -        for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 160 -            sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result);"> 160 -            sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result)🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -        for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -            if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -                LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -            boolean isSide = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -            for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -                if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -                    CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -                    String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 173 -                    SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 173 -                    SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -                    String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -                    tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 176 -                    sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tmp);"> 176 -                    sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tm🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -                    for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -                        if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -                            isSide = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -                    if (isSide) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -                        //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 186 -                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, null);"> 186 -                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryCon🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -                    }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -                        System.out.println(&quot;----------exec sql without dimension join-----------&quot; );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -                        System.out.println(&quot;----------real sql exec is--------------------------&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -                        System.out.println(result.getExecSql());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -                        FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -                        if(LOG.isInfoEnabled()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -                            System.out.println();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -                            LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 205 -    private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEnv)"> 205 -    private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEn🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -            throws IllegalAccessException, InvocationTargetException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -        // udf和tableEnv须由同一个类加载器加载</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -        ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -        URLClassLoader classLoader = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -        List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -        for (CreateFuncParser.SqlParserResult funcInfo : funcList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -            //classloader</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -            if (classLoader == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -                classLoader = ClassLoaderManager.loadExtraJar(jarURList, (URLClassLoader) levelClassLoader);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 216 -            FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 216 -            FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv,🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -     *    向Flink注册源表和结果表，返回执行时插件包的全路径</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -     * @param sqlTree</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -     * @param env</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -     * @param tableEnv</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -     * @param localSqlPluginPath</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -     * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -     * @param pluginLoadMode   插件加载模式 classpath or shipfile</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -     * @param sideTableMap</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -     * @param registerTableCache</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -     * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -     * @throws Exception</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 233 -    private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 233 -    private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment 🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 234 -                                          String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 234 -                                          String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTable🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -        Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -        WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -        for (TableInfo tableInfo : sqlTree.getTableInfoMap().values()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -            if (tableInfo instanceof SourceTableInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -                SourceTableInfo sourceTableInfo = (SourceTableInfo) tableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 242 -                Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 242 -                Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPa🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -                tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 244 -                //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 244 -                //Note --- parameter conversion function can not be used inside a function of the type of polymeri🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -                //Create table in which the function is arranged only need adaptation sql</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -                String adaptSql = sourceTableInfo.getAdaptSelectSql();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -                Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 249 -                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().getColumnNames());"> 249 -                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().g🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -                DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -                        .filter((Tuple2&lt;Boolean, Row&gt; f0) -&gt; f0.f0)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -                        .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; f0.f1)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -                        .returns(typeInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -                String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -                if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -                    adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -                    fields += &quot;,ROWTIME.ROWTIME&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -                    fields += &quot;,PROCTIME.PROCTIME&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -                Table regTable = tableEnv.fromDataStream(adaptStream, fields);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -                tableEnv.registerTable(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -                if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -                    LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -                registerTableCache.put(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 271 -                URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 271 -                URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTa🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -                pluginClassPatshSets.add(sourceTablePathUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -            } else if (tableInfo instanceof TargetTableInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 275 -                TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPath);"> 275 -                TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPa🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -                TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -                tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 279 -                URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 279 -                URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTabl🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -                pluginClassPatshSets.add(sinkTablePathUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -            } else if (tableInfo instanceof SideTableInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 282 -                String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 282 -                String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -                sideTableMap.put(tableInfo.getName(), (SideTableInfo) tableInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 285 -                URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 285 -                URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideT🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -                pluginClassPatshSets.add(sideTablePathUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -                throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -        return pluginClassPatshSets;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -     *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -     * @param env</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -     * @param classPathSet</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -    private static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -        int i = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -        for (URL url : classPathSet) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -            String classFileName = String.format(CLASS_FILE_NAME_FMT, i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -            env.registerCachedFile(url.getPath(), classFileName, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -            i++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 305 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 308 -    private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 308 -    private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -        StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -                StreamExecutionEnvironment.getExecutionEnvironment() :</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -                new MyLocalStreamEnvironment();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -        StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -        return env;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 315 +        ParamsInfo paramsInfo = ExecuteProcessHelper.parseParams(args);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +        ExecuteProcessHelper.setLogLevel(paramsInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +        StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExecution(paramsInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +        env.execute(paramsInfo.getName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +        LOG.info(&quot;program {} execution success&quot;, paramsInfo.getName());</span>
 320      }
 321  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql;
  21  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.dtstack.flink.sql.config.CalciteConfig;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.classloader.ClassLoaderManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import com.dtstack.flink.sql.enums.ECacheType;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import com.dtstack.flink.sql.environment.StreamEnvConfigManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import com.dtstack.flink.sql.exec.FlinkSQLExec;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import com.dtstack.flink.sql.option.OptionParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import com.dtstack.flink.sql.parser.CreateFuncParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import com.dtstack.flink.sql.parser.CreateTmpTableParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import com.dtstack.flink.sql.parser.InsertSqlParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import com.dtstack.flink.sql.parser.SqlParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import com.dtstack.flink.sql.parser.SqlTree;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import com.dtstack.flink.sql.side.SideSqlExec;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import com.dtstack.flink.sql.side.SideTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import com.dtstack.flink.sql.table.SourceTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import com.dtstack.flink.sql.table.TableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import com.dtstack.flink.sql.table.TargetTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import com.google.common.base.Strings;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +</span>


  60  import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +import com.dtstack.flink.sql.exec.ExecuteProcessHelper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +import com.dtstack.flink.sql.exec.ParamsInfo;</span>
  70  import org.slf4j.Logger;
  71  import org.slf4j.LoggerFactory;
  72  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -import java.io.File;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -import java.net.URL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -import java.net.URLClassLoader;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -import java.net.URLDecoder;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -import java.util.Map;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -import java.util.Optional;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -import java.util.Properties;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -import java.util.Set;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -import com.dtstack.flink.sql.option.Options;</span>
  85  
  86  /**
  87   * Date: 2018/6/26
  88   * Company: www.dtstack.com
  89   * @author xuchao
  90   */
  91  
  92  public class Main {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -    private static final String CLASS_FILE_NAME_FMT = &quot;class_path_%d&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -    private static final ObjectMapper objMapper = new ObjectMapper();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -</span>
  98      private static final Logger LOG = LoggerFactory.getLogger(Main.class);
  99  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -</span>
 101      public static void main(String[] args) throws Exception {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -        String sql = options.getSql();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -        String name = options.getName();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -        String addJarListStr = options.getAddjar();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -        String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -        String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -        String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        String deployMode = options.getMode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -        String confProp = options.getConfProp();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -        sql = URLDecoder.decode(sql, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -        SqlParser.setLocalSqlPluginRoot(localSqlPluginPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -        List&lt;String&gt; addJarFileList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -        if (!Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -            addJarListStr = URLDecoder.decode(addJarListStr, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -            addJarFileList = objMapper.readValue(addJarListStr, List.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -        confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -        Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -        StreamExecutionEnvironment env = getStreamExeEnv(confProperties, deployMode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -        StreamTableEnvironment tableEnv =  StreamTableEnvironment.getTableEnvironment(env);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 127 -        StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties);"> 127 -        StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -        List&lt;URL&gt; jarURList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -        SqlTree sqlTree = SqlParser.parseSql(sql);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        //Get External jar to load</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -        for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -            File tmpFile = new File(addJarPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -            jarURList.add(tmpFile.toURI().toURL());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -        Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -        Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -        //register udf</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        registerUserDefinedFunction(sqlTree, jarURList, tableEnv);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -        //register table schema</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 144 -        Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode, sideTableMap, registerTableCache);"> 144 -        Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pl🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -        // cache classPathSets</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -        registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 148 -        sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 148 -        sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig)🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -        if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -            ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -        env.execute(name);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 157 -    private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,Map&lt;String, SideTableInfo&gt; sideTableMap,Map&lt;String, Table&gt; registerTableCache, StreamQueryConfig queryConfig) throws Exception {"> 157 -    private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -        SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -        sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -        for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 161 -            sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result);"> 161 -            sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result)🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -        for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -            if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -                LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -            boolean isSide = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -            for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -                if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -                    CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -                    String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 174 -                    SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 174 -                    SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -                    String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -                    tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 177 -                    sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tmp);"> 177 -                    sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tm🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -                    for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -                        if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -                            isSide = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -                    if (isSide) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -                        //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 187 -                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, null);"> 187 -                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryCon🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -                    }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -                        System.out.println(&quot;----------exec sql without dimension join-----------&quot; );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -                        System.out.println(&quot;----------real sql exec is--------------------------&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -                        System.out.println(result.getExecSql());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -                        FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -                        if(LOG.isInfoEnabled()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -                            System.out.println();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -                            LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 206 -    private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEnv)"> 206 -    private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEn🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -            throws IllegalAccessException, InvocationTargetException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -        // udf和tableEnv须由同一个类加载器加载</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -        ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -        URLClassLoader classLoader = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -        List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -        for (CreateFuncParser.SqlParserResult funcInfo : funcList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -            //classloader</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -            if (classLoader == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -                classLoader = ClassLoaderManager.loadExtraJar(jarURList, (URLClassLoader) levelClassLoader);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 217 -            FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 217 -            FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv,🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -     *    向Flink注册源表和结果表，返回执行时插件包的全路径</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -     * @param sqlTree</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -     * @param env</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -     * @param tableEnv</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -     * @param localSqlPluginPath</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -     * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -     * @param pluginLoadMode   插件加载模式 classpath or shipfile</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -     * @param sideTableMap</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -     * @param registerTableCache</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -     * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -     * @throws Exception</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 234 -    private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 234 -    private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment 🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 235 -                                          String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 235 -                                          String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTable🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -        Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -        WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -        for (TableInfo tableInfo : sqlTree.getTableInfoMap().values()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -            if (tableInfo instanceof SourceTableInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -                SourceTableInfo sourceTableInfo = (SourceTableInfo) tableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 243 -                Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 243 -                Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPa🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -                tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 245 -                //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 245 -                //Note --- parameter conversion function can not be used inside a function of the type of polymeri🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -                //Create table in which the function is arranged only need adaptation sql</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -                String adaptSql = sourceTableInfo.getAdaptSelectSql();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -                Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 250 -                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().getColumnNames());"> 250 -                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().g🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -                DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -                        .filter((Tuple2&lt;Boolean, Row&gt; f0) -&gt; f0.f0)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -                        .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; f0.f1)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -                        .returns(typeInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -                String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -                if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -                    adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -                    fields += &quot;,ROWTIME.ROWTIME&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -                    fields += &quot;,PROCTIME.PROCTIME&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -                Table regTable = tableEnv.fromDataStream(adaptStream, fields);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -                tableEnv.registerTable(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -                if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -                    LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -                registerTableCache.put(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 272 -                URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 272 -                URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTa🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -                pluginClassPatshSets.add(sourceTablePathUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -            } else if (tableInfo instanceof TargetTableInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 276 -                TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPath);"> 276 -                TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPa🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -                TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -                tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 280 -                URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 280 -                URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTabl🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -                pluginClassPatshSets.add(sinkTablePathUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -            } else if (tableInfo instanceof SideTableInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 283 -                String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 283 -                String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -                sideTableMap.put(tableInfo.getName(), (SideTableInfo) tableInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 286 -                URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 286 -                URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideT🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -                pluginClassPatshSets.add(sideTablePathUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -                throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -        return pluginClassPatshSets;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -     *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -     * @param env</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -     * @param classPathSet</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -    private static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -        int i = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -        for (URL url : classPathSet) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -            String classFileName = String.format(CLASS_FILE_NAME_FMT, i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -            env.registerCachedFile(url.getPath(), classFileName, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 305 -            i++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 309 -    private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 309 -    private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -        StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -                StreamExecutionEnvironment.getExecutionEnvironment() :</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -                new MyLocalStreamEnvironment();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -        StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -        return env;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +        ParamsInfo paramsInfo = ExecuteProcessHelper.parseParams(args);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +        StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExecution(paramsInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +        env.execute(paramsInfo.getName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +        LOG.info(&quot;program {} execution success&quot;, paramsInfo.getName());</span>

 320      }
 321  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            