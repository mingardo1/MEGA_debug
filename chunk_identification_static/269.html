<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>269</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    269
                    <a href="268.html">prev</a>
                    <a href="270.html">next</a>
                    <a href="269_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_7372a30b9f3190df28e61f8437f110c95d36b4fa_common/src/main/java/org/broadleafcommerce/common/web/resource/BroadleafContextUtil.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;7372a30b9f3190df28e61f8437f110c95d36b4fa:common/src/main/java/org/broadleafcommerce/common/web/resource/BroadleafContextUtil.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;7372a30b9f3190df28e61f8437f110c95d36b4fa^1:common/src/main/java/org/broadleafcommerce/common/web/resource/BroadleafContextUtil.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;7372a30b9f3190df28e61f8437f110c95d36b4fa^2:common/src/main/java/org/broadleafcommerce/common/web/resource/BroadleafContextUtil.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;65989a8b6469e6f21626a6b7292822865b1618ba:common/src/main/java/org/broadleafcommerce/common/web/resource/BroadleafContextUtil.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.web.resource;
  19 
  20 import org.broadleafcommerce.common.RequestDTOImpl;
  21 import org.broadleafcommerce.common.classloader.release.ThreadLocalManager;
  22 import org.broadleafcommerce.common.util.DeployBehaviorUtil;
  23 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  24 import org.broadleafcommerce.common.web.BroadleafSandBoxResolver;
  25 import org.broadleafcommerce.common.web.BroadleafSiteResolver;
  26 import org.broadleafcommerce.common.web.BroadleafThemeResolver;
  27 import org.broadleafcommerce.common.web.DeployBehavior;
  28 import org.springframework.security.core.context.SecurityContext;
  29 import org.springframework.security.core.context.SecurityContextHolder;
  30 import org.springframework.security.web.context.HttpSessionSecurityContextRepository;
  31 import org.springframework.stereotype.Service;
  32 import org.springframework.web.context.request.RequestContextHolder;
  33 import org.springframework.web.context.request.ServletRequestAttributes;
  34 import org.springframework.web.context.request.WebRequest;
  35 
  36 import javax.servlet.http.HttpServletRequest;
  37 import javax.servlet.http.HttpSession;
  38 
  39 /**
  40  * &lt;p&gt;
  41  * Some resource handlers need a valid site, theme, or sandbox to be available when serving request.
  42  * 
  43  * &lt;p&gt;
  44  * This component provides the {@link #establishThinRequestContext()} method for that purpose.  
  45  *
  46  * @author bpolster
  47  *
  48  */
  49 @Service(&quot;blBroadleafContextUtil&quot;)
  50 public class BroadleafContextUtil {
  51     
  52     @javax.annotation.Resource(name = &quot;blSiteResolver&quot;)
  53     protected BroadleafSiteResolver siteResolver;
  54     
  55     @javax.annotation.Resource(name = &quot;blSandBoxResolver&quot;)
  56     protected BroadleafSandBoxResolver sbResolver;
  57     
  58     @javax.annotation.Resource(name = &quot;blThemeResolver&quot;)
  59     protected BroadleafThemeResolver themeResolver;
  60 
  61     @javax.annotation.Resource(name = &quot;blDeployBehaviorUtil&quot;)
  62     protected DeployBehaviorUtil deployBehaviorUtil;
  63 
  64     protected boolean versioningEnabled = false;
  65 
  66     /**
  67      * Creates a BroadleafRequestContext with supported values populated
  68      * @see #establishThinRequestContextInternal(boolean, boolean)
  69      */
  70     public void establishThinRequestContext() {
  71         establishThinRequestContextInternal(true, true);
  72     }
  73 
  74     /**
  75      * Creates a BroadleafRequestContext without a Sandbox
  76      * @see #establishThinRequestContextInternal(boolean, boolean)
  77      */
  78     public void establishThinRequestContextWithoutSandBox() {
  79         establishThinRequestContextInternal(true, false);
  80     }
  81 
  82     /**
  83      * Creates a BroadleafRequestContext without a Theme or Sandbox
  84      * @see #establishThinRequestContextInternal(boolean, boolean)
  85      */
  86     public void establishThinRequestContextWithoutThemeOrSandbox() {
  87         establishThinRequestContextInternal(false, false);
  88     }
  89 
  90     /**
  91      * Adds request and site to the BroadleafRequestContext
  92      * 
  93      * If includeTheme is true then also adds the Theme.
  94      * If includeSandBox is true then also adds the SandBox.
  95      * 
  96      * @param includeTheme
  97      * @param includeSandBox
  98      */
  99     protected void establishThinRequestContextInternal(boolean includeTheme, boolean includeSandBox) {
 100         BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();
 101 
 102         if (brc.getRequest() == null) {
<abbr title=" 103             ServletRequestAttributes requestAttributes = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes());"> 103             ServletRequestAttributes requestAttributes = ((ServletRequestAttributes) RequestContextHolderðŸ”µ</abbr>
 104             if (requestAttributes != null) {
 105                 HttpServletRequest req = requestAttributes.getRequest();
 106                 HttpSession session = req.getSession(false);
 107                 SecurityContext ctx = readSecurityContextFromSession(session);
 108                 if (ctx != null) {
 109                     SecurityContextHolder.setContext(ctx);
 110                 }
 111                 brc.setRequest(req);
 112             }
 113         }
 114 
 115         WebRequest wr = brc.getWebRequest();
 116 
 117         if (wr != null) {
 118             if (brc.getNonPersistentSite() == null) {
 119                 brc.setNonPersistentSite(siteResolver.resolveSite(wr, true));
 120                 if (includeSandBox) {
 121                     brc.setSandBox(sbResolver.resolveSandBox(wr, brc.getNonPersistentSite()));
 122                 }
<abbr title=" 123                 brc.setDeployBehavior(deployBehaviorUtil.isProductionSandBoxMode() ? DeployBehavior.CLONE_PARENT : DeployBehavior.OVERWRITE_PARENT);"> 123                 brc.setDeployBehavior(deployBehaviorUtil.isProductionSandBoxMode() ? DeployBehavior.CLONEðŸ”µ</abbr>
 124             }
 125 
 126 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127             if (includeTheme) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128                 if (brc.getTheme() == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129                     brc.setTheme(themeResolver.resolveTheme(wr));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130                 }</span>
 131 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132             if (brc.getTheme() == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133                 brc.setTheme(themeResolver.resolveTheme(wr));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     public void clearThinRequestContext() {</span>
 139 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140         if (includeTheme) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141             if (brc.getTheme() == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142                 brc.setRequestDTO(new RequestDTOImpl(brc.getRequest()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143                 brc.setTheme(themeResolver.resolveTheme(wr));</span>
 144 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 145             }
 146         }
 147     }
 148 
 149     public void clearThinRequestContext() {
 150         ThreadLocalManager.remove();
 151     }
 152 
 153     protected String getContextName(HttpServletRequest request) {
 154         String contextName = request.getServerName();
 155         int pos = contextName.indexOf(&#x27;.&#x27;);
 156         if (pos &gt;= 0) {
 157             contextName = contextName.substring(0, contextName.indexOf(&#x27;.&#x27;));
 158         }
 159         return contextName;
 160     }
 161 
 162     // **NOTE** This method is lifted from HttpSessionSecurityContextRepository
 163     protected SecurityContext readSecurityContextFromSession(HttpSession httpSession) {
 164         if (httpSession == null) {
 165             return null;
 166         }
 167 
<abbr title=" 168         Object ctxFromSession = httpSession.getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);"> 168         Object ctxFromSession = httpSession.getAttribute(HttpSessionSecurityContextRepository.SPRING_SECUðŸ”µ</abbr>
 169         if (ctxFromSession == null) {
 170             return null;
 171         }
 172 
 173         if (!(ctxFromSession instanceof SecurityContext)) {
 174             return null;
 175         }
 176 
 177         return (SecurityContext) ctxFromSession;
 178     }
 179     
 180     
 181 
 182 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.web.resource;
  19 
  20 import org.broadleafcommerce.common.RequestDTOImpl;
  21 import org.broadleafcommerce.common.classloader.release.ThreadLocalManager;
  22 import org.broadleafcommerce.common.util.DeployBehaviorUtil;
  23 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  24 import org.broadleafcommerce.common.web.BroadleafSandBoxResolver;
  25 import org.broadleafcommerce.common.web.BroadleafSiteResolver;
  26 import org.broadleafcommerce.common.web.BroadleafThemeResolver;
  27 import org.broadleafcommerce.common.web.DeployBehavior;
  28 import org.springframework.security.core.context.SecurityContext;
  29 import org.springframework.security.core.context.SecurityContextHolder;
  30 import org.springframework.security.web.context.HttpSessionSecurityContextRepository;
  31 import org.springframework.stereotype.Service;
  32 import org.springframework.web.context.request.RequestContextHolder;
  33 import org.springframework.web.context.request.ServletRequestAttributes;
  34 import org.springframework.web.context.request.WebRequest;
  35 
  36 import javax.servlet.http.HttpServletRequest;
  37 import javax.servlet.http.HttpSession;
  38 
  39 /**
  40  * &lt;p&gt;
  41  * Some resource handlers need a valid site, theme, or sandbox to be available when serving request.
  42  *
  43  * &lt;p&gt;
  44  * This component provides the {@link #establishThinRequestContext()} method for that purpose.
  45  *
  46  * @author bpolster
  47  *
  48  */
  49 @Service(&quot;blBroadleafContextUtil&quot;)
  50 public class BroadleafContextUtil {
  51 
  52     @javax.annotation.Resource(name = &quot;blSiteResolver&quot;)
  53     protected BroadleafSiteResolver siteResolver;
  54 
  55     @javax.annotation.Resource(name = &quot;blSandBoxResolver&quot;)
  56     protected BroadleafSandBoxResolver sbResolver;
  57 
  58     @javax.annotation.Resource(name = &quot;blThemeResolver&quot;)
  59     protected BroadleafThemeResolver themeResolver;
  60 
  61     @javax.annotation.Resource(name = &quot;blDeployBehaviorUtil&quot;)
  62     protected DeployBehaviorUtil deployBehaviorUtil;
  63 
  64     protected boolean versioningEnabled = false;
  65 
  66     /**
  67      * Creates a BroadleafRequestContext with supported values populated
  68      * @see #establishThinRequestContextInternal(boolean, boolean)
  69      */
  70     public void establishThinRequestContext() {
  71         establishThinRequestContextInternal(true, true);
  72     }
  73 
  74     /**
  75      * Creates a BroadleafRequestContext without a Sandbox
  76      * @see #establishThinRequestContextInternal(boolean, boolean)
  77      */
  78     public void establishThinRequestContextWithoutSandBox() {
  79         establishThinRequestContextInternal(true, false);
  80     }
  81 
  82     /**
  83      * Creates a BroadleafRequestContext without a Theme or Sandbox
  84      * @see #establishThinRequestContextInternal(boolean, boolean)
  85      */
  86     public void establishThinRequestContextWithoutThemeOrSandbox() {
  87         establishThinRequestContextInternal(false, false);
  88     }
  89 
  90     /**
  91      * Adds request and site to the BroadleafRequestContext
  92      *
  93      * If includeTheme is true then also adds the Theme.
  94      * If includeSandBox is true then also adds the SandBox.
  95      *
  96      * @param includeTheme
  97      * @param includeSandBox
  98      */
  99     protected void establishThinRequestContextInternal(boolean includeTheme, boolean includeSandBox) {
 100         BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();
 101 
 102         if (brc.getRequest() == null) {
<abbr title=" 103             ServletRequestAttributes requestAttributes = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes());"> 103             ServletRequestAttributes requestAttributes = ((ServletRequestAttributes) RequestContextHolderðŸ”µ</abbr>
 104             if (requestAttributes != null) {
 105                 HttpServletRequest req = requestAttributes.getRequest();
 106             HttpSession session = req.getSession(false);
 107             SecurityContext ctx = readSecurityContextFromSession(session);
 108             if (ctx != null) {
 109                 SecurityContextHolder.setContext(ctx);
 110             }
 111             brc.setRequest(req);
 112         }
 113         }
 114 
 115         WebRequest wr = brc.getWebRequest();
 116 
 117         if (wr != null) {
 118         if (brc.getNonPersistentSite() == null) {
 119             brc.setNonPersistentSite(siteResolver.resolveSite(wr, true));
 120             if (includeSandBox) {
 121                 brc.setSandBox(sbResolver.resolveSandBox(wr, brc.getNonPersistentSite()));
 122             }
<abbr title=" 123             brc.setDeployBehavior(deployBehaviorUtil.isProductionSandBoxMode() ? DeployBehavior.CLONE_PARENT : DeployBehavior.OVERWRITE_PARENT);"> 123             brc.setDeployBehavior(deployBehaviorUtil.isProductionSandBoxMode() ? DeployBehavior.CLONE_PARðŸ”µ</abbr>
 124         }
 125 
 126         if (includeTheme) {
 127             if (brc.getTheme() == null) {
 128                 brc.setRequestDTO(new RequestDTOImpl(brc.getRequest()));
 129                 brc.setTheme(themeResolver.resolveTheme(wr));
 130             }
 131         }
 132     }
 133     }
 134 
 135     public void clearThinRequestContext() {
 136         ThreadLocalManager.remove();
 137     }
 138 
 139     protected String getContextName(HttpServletRequest request) {
 140         String contextName = request.getServerName();
 141         int pos = contextName.indexOf(&#x27;.&#x27;);
 142         if (pos &gt;= 0) {
 143             contextName = contextName.substring(0, contextName.indexOf(&#x27;.&#x27;));
 144         }
 145         return contextName;
 146     }
 147 
 148     // **NOTE** This method is lifted from HttpSessionSecurityContextRepository
 149     protected SecurityContext readSecurityContextFromSession(HttpSession httpSession) {
 150         if (httpSession == null) {
 151             return null;
 152         }
 153 
<abbr title=" 154         Object ctxFromSession = httpSession.getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);"> 154         Object ctxFromSession = httpSession.getAttribute(HttpSessionSecurityContextRepository.SPRING_SECUðŸ”µ</abbr>
 155         if (ctxFromSession == null) {
 156             return null;
 157         }
 158 
 159         if (!(ctxFromSession instanceof SecurityContext)) {
 160             return null;
 161         }
 162 
 163         return (SecurityContext) ctxFromSession;
 164     }
 165 
 166 
 167 
 168 }
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.web.resource;
  19 
  20 import javax.servlet.http.HttpServletRequest;
  21 import javax.servlet.http.HttpSession;
  22 import org.broadleafcommerce.common.RequestDTOImpl;
  23 import org.broadleafcommerce.common.classloader.release.ThreadLocalManager;
  24 import org.broadleafcommerce.common.util.DeployBehaviorUtil;
  25 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  26 import org.broadleafcommerce.common.web.BroadleafSandBoxResolver;
  27 import org.broadleafcommerce.common.web.BroadleafSiteResolver;
  28 import org.broadleafcommerce.common.web.BroadleafThemeResolver;
  29 import org.broadleafcommerce.common.web.DeployBehavior;
  30 import org.springframework.security.core.context.SecurityContext;
  31 import org.springframework.security.core.context.SecurityContextHolder;
  32 import org.springframework.security.web.context.HttpSessionSecurityContextRepository;
  33 import org.springframework.stereotype.Service;
  34 import org.springframework.web.context.request.RequestContextHolder;
  35 import org.springframework.web.context.request.ServletRequestAttributes;
  36 import org.springframework.web.context.request.WebRequest;
  37 
  38 
  39 /**
  40  * &lt;p&gt;
  41  * Some resource handlers need a valid site, theme, or sandbox to be available when serving request.
  42  *
  43  * &lt;p&gt;
  44  * This component provides the {@link #establishThinRequestContext()} method for that purpose.
  45  *
  46  * @author bpolster
  47  *
  48  */
  49 @Service(&quot;blBroadleafContextUtil&quot;)
  50 public class BroadleafContextUtil {
  51     @javax.annotation.Resource(name = &quot;blSiteResolver&quot;)
  52     protected BroadleafSiteResolver siteResolver;
  53 
  54     @javax.annotation.Resource(name = &quot;blSandBoxResolver&quot;)
  55     protected BroadleafSandBoxResolver sbResolver;
  56 
  57     @javax.annotation.Resource(name = &quot;blThemeResolver&quot;)
  58     protected BroadleafThemeResolver themeResolver;
  59 
  60     @javax.annotation.Resource(name = &quot;blDeployBehaviorUtil&quot;)
  61     protected DeployBehaviorUtil deployBehaviorUtil;
  62 
  63     protected boolean versioningEnabled = false;
  64 
  65     /**
  66      * Creates a BroadleafRequestContext with supported values populated
  67      * @see #establishThinRequestContextInternal(boolean, boolean)
  68      */
  69     public void establishThinRequestContext() {
  70         establishThinRequestContextInternal(true, true);
  71     }
  72 
  73     /**
  74      * Creates a BroadleafRequestContext without a Sandbox
  75      * @see #establishThinRequestContextInternal(boolean, boolean)
  76      */
  77     public void establishThinRequestContextWithoutSandBox() {
  78         establishThinRequestContextInternal(true, false);
  79     }
  80 
  81     /**
  82      * Creates a BroadleafRequestContext without a Theme or Sandbox
  83      * @see #establishThinRequestContextInternal(boolean, boolean)
  84      */
  85     public void establishThinRequestContextWithoutThemeOrSandbox() {
  86         establishThinRequestContextInternal(false, false);
  87     }
  88 
  89     /**
  90      * Adds request and site to the BroadleafRequestContext
  91      *
  92      * If includeTheme is true then also adds the Theme.
  93      * If includeSandBox is true then also adds the SandBox.
  94      *
  95      * @param includeTheme
  96      * @param includeSandBox
  97      */
  98     protected void establishThinRequestContextInternal(boolean includeTheme, boolean includeSandBox) {
  99         BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();
 100         if (brc.getRequest() == null) {
<abbr title=" 101             ServletRequestAttributes requestAttributes = ((ServletRequestAttributes) (RequestContextHolder.getRequestAttributes()));"> 101             ServletRequestAttributes requestAttributes = ((ServletRequestAttributes) (RequestContextHoldeðŸ”µ</abbr>
 102             if (requestAttributes != null) {
 103                 HttpServletRequest req = requestAttributes.getRequest();
 104                 HttpSession session = req.getSession(false);
 105                 SecurityContext ctx = readSecurityContextFromSession(session);
 106                 if (ctx != null) {
 107                     SecurityContextHolder.setContext(ctx);
 108                 }
 109                 brc.setRequest(req);
 110             }
 111         }
 112         WebRequest wr = brc.getWebRequest();
 113         if (wr != null) {
 114             if (brc.getNonPersistentSite() == null) {
 115                 brc.setNonPersistentSite(siteResolver.resolveSite(wr, true));
 116                 if (includeSandBox) {
 117                     brc.setSandBox(sbResolver.resolveSandBox(wr, brc.getNonPersistentSite()));
 118                 }
<abbr title=" 119                 brc.setDeployBehavior(deployBehaviorUtil.isProductionSandBoxMode() ? DeployBehavior.CLONE_PARENT : DeployBehavior.OVERWRITE_PARENT);"> 119                 brc.setDeployBehavior(deployBehaviorUtil.isProductionSandBoxMode() ? DeployBehavior.CLONEðŸ”µ</abbr>
 120             }
 121             if (includeTheme) {
 122                 if (brc.getTheme() == null) {
 123                     brc.setRequestDTO(new RequestDTOImpl(brc.getRequest()));
 124                     brc.setTheme(themeResolver.resolveTheme(wr));
 125                 }
 126             }
 127         }
 128     }
 129 
 130     public void clearThinRequestContext() {
 131         ThreadLocalManager.remove();
 132     }
 133 
 134     protected String getContextName(HttpServletRequest request) {
 135         String contextName = request.getServerName();
 136         int pos = contextName.indexOf(&#x27;.&#x27;);
 137         if (pos &gt;= 0) {
 138             contextName = contextName.substring(0, contextName.indexOf(&#x27;.&#x27;));
 139         }
 140         return contextName;
 141     }
 142 
 143     // **NOTE** This method is lifted from HttpSessionSecurityContextRepository
 144     protected SecurityContext readSecurityContextFromSession(HttpSession httpSession) {
 145         if (httpSession == null) {
 146             return null;
 147         }
 148 
<abbr title=" 149         Object ctxFromSession = httpSession.getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);"> 149         Object ctxFromSession = httpSession.getAttribute(HttpSessionSecurityContextRepository.SPRING_SECUðŸ”µ</abbr>
 150         if (ctxFromSession == null) {
 151             return null;
 152         }
 153 
 154         if (!(ctxFromSession instanceof SecurityContext)) {
 155             return null;
 156         }
 157 
 158         return (SecurityContext) ctxFromSession;
 159     }
 160 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.web.resource;
  19  

  20  import org.broadleafcommerce.common.classloader.release.ThreadLocalManager;
  21  import org.broadleafcommerce.common.util.DeployBehaviorUtil;
  22  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  23  import org.broadleafcommerce.common.web.BroadleafSandBoxResolver;
  24  import org.broadleafcommerce.common.web.BroadleafSiteResolver;
  25  import org.broadleafcommerce.common.web.BroadleafThemeResolver;
  26  import org.broadleafcommerce.common.web.DeployBehavior;
  27  import org.springframework.security.core.context.SecurityContext;
  28  import org.springframework.security.core.context.SecurityContextHolder;
  29  import org.springframework.security.web.context.HttpSessionSecurityContextRepository;
  30  import org.springframework.stereotype.Service;
  31  import org.springframework.web.context.request.RequestContextHolder;
  32  import org.springframework.web.context.request.ServletRequestAttributes;
  33  import org.springframework.web.context.request.WebRequest;
  34  
  35  import javax.servlet.http.HttpServletRequest;
  36  import javax.servlet.http.HttpSession;
  37  
  38  /**
  39   * &lt;p&gt;
  40   * Some resource handlers need a valid site, theme, or sandbox to be available when serving request.
  41   *
  42   * &lt;p&gt;
  43   * This component provides the {@link #establishThinRequestContext()} method for that purpose.
  44   *
  45   * @author bpolster
  46   *
  47   */
  48  @Service(&quot;blBroadleafContextUtil&quot;)
  49  public class BroadleafContextUtil {
  50  
  51      @javax.annotation.Resource(name = &quot;blSiteResolver&quot;)
  52      protected BroadleafSiteResolver siteResolver;
  53  
  54      @javax.annotation.Resource(name = &quot;blSandBoxResolver&quot;)
  55      protected BroadleafSandBoxResolver sbResolver;
  56  
  57      @javax.annotation.Resource(name = &quot;blThemeResolver&quot;)
  58      protected BroadleafThemeResolver themeResolver;
  59  
  60      @javax.annotation.Resource(name = &quot;blDeployBehaviorUtil&quot;)
  61      protected DeployBehaviorUtil deployBehaviorUtil;
  62  
  63      protected boolean versioningEnabled = false;
  64  
  65      /**
  66       * Creates a BroadleafRequestContext with supported values populated
  67       * @see #establishThinRequestContextInternal(boolean, boolean)
  68       */
  69      public void establishThinRequestContext() {
  70          establishThinRequestContextInternal(true, true);
  71      }
  72  
  73      /**
  74       * Creates a BroadleafRequestContext without a Sandbox
  75       * @see #establishThinRequestContextInternal(boolean, boolean)
  76       */
  77      public void establishThinRequestContextWithoutSandBox() {
  78          establishThinRequestContextInternal(true, false);
  79      }
  80  
  81      /**
  82       * Creates a BroadleafRequestContext without a Theme or Sandbox
  83       * @see #establishThinRequestContextInternal(boolean, boolean)
  84       */
  85      public void establishThinRequestContextWithoutThemeOrSandbox() {
  86          establishThinRequestContextInternal(false, false);
  87      }
  88  
  89      /**
  90       * Adds request and site to the BroadleafRequestContext
  91       *
  92       * If includeTheme is true then also adds the Theme.
  93       * If includeSandBox is true then also adds the SandBox.
  94       *
  95       * @param includeTheme
  96       * @param includeSandBox
  97       */
  98      protected void establishThinRequestContextInternal(boolean includeTheme, boolean includeSandBox) {
  99          BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();
 100  
 101          if (brc.getRequest() == null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 102 -            HttpServletRequest req = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();"> 102 -            HttpServletRequest req = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -            HttpSession session = req.getSession(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -            SecurityContext ctx = readSecurityContextFromSession(session);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -            if (ctx != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -                SecurityContextHolder.setContext(ctx);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 107 +            ServletRequestAttributes requestAttributes = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes());"> 107 +            ServletRequestAttributes requestAttributes = ((ServletRequestAttributes) RequestContextHolder.getRequeðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +            if (requestAttributes != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +                HttpServletRequest req = requestAttributes.getRequest();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +                HttpSession session = req.getSession(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +                SecurityContext ctx = readSecurityContextFromSession(session);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +                if (ctx != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +                    SecurityContextHolder.setContext(ctx);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +                brc.setRequest(req);</span>
 116              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -            brc.setRequest(req);</span>
 118          }
 119  
 120          WebRequest wr = brc.getWebRequest();
 121  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -        if (brc.getNonPersistentSite() == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -            brc.setNonPersistentSite(siteResolver.resolveSite(wr, true));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -            if (includeSandBox) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -                brc.setSandBox(sbResolver.resolveSandBox(wr, brc.getNonPersistentSite()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        if (wr != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +            if (brc.getNonPersistentSite() == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +                brc.setNonPersistentSite(siteResolver.resolveSite(wr, true));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +                if (includeSandBox) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +                    brc.setSandBox(sbResolver.resolveSandBox(wr, brc.getNonPersistentSite()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 132 +                brc.setDeployBehavior(deployBehaviorUtil.isProductionSandBoxMode() ? DeployBehavior.CLONE_PARENT : DeployBehavior.OVERWRITE_PARENT);"> 132 +                brc.setDeployBehavior(deployBehaviorUtil.isProductionSandBoxMode() ? DeployBehavior.CLONE_PARENT :ðŸ”µ</abbr></span>
 133              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 134 -            brc.setDeployBehavior(deployBehaviorUtil.isProductionSandBoxMode() ? DeployBehavior.CLONE_PARENT : DeployBehavior.OVERWRITE_PARENT);"> 134 -            brc.setDeployBehavior(deployBehaviorUtil.isProductionSandBoxMode() ? DeployBehavior.CLONE_PARENT : DepðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        }</span>
 136  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -        if (includeTheme) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -            if (brc.getTheme() == null) {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -                brc.setTheme(themeResolver.resolveTheme(wr));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +            if (includeTheme) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +                if (brc.getTheme() == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +                    brc.setTheme(themeResolver.resolveTheme(wr));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +                }</span>
 144              }
 145          }
 146      }
 147  
 148      public void clearThinRequestContext() {
 149          ThreadLocalManager.remove();
 150      }
 151  
 152      protected String getContextName(HttpServletRequest request) {
 153          String contextName = request.getServerName();
 154          int pos = contextName.indexOf(&#x27;.&#x27;);
 155          if (pos &gt;= 0) {
 156              contextName = contextName.substring(0, contextName.indexOf(&#x27;.&#x27;));
 157          }
 158          return contextName;
 159      }
 160  
 161      // **NOTE** This method is lifted from HttpSessionSecurityContextRepository
 162      protected SecurityContext readSecurityContextFromSession(HttpSession httpSession) {
 163          if (httpSession == null) {
 164              return null;
 165          }
 166  
<abbr title=" 167          Object ctxFromSession = httpSession.getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);"> 167          Object ctxFromSession = httpSession.getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTðŸ”µ</abbr>
 168          if (ctxFromSession == null) {
 169              return null;
 170          }
 171  
 172          if (!(ctxFromSession instanceof SecurityContext)) {
 173              return null;
 174          }
 175  
 176          return (SecurityContext) ctxFromSession;
 177      }
 178  
 179  
 180  
 181  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.web.resource;
  19  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import org.broadleafcommerce.common.RequestDTOImpl;</span>
  21  import org.broadleafcommerce.common.classloader.release.ThreadLocalManager;
  22  import org.broadleafcommerce.common.util.DeployBehaviorUtil;
  23  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  24  import org.broadleafcommerce.common.web.BroadleafSandBoxResolver;
  25  import org.broadleafcommerce.common.web.BroadleafSiteResolver;
  26  import org.broadleafcommerce.common.web.BroadleafThemeResolver;
  27  import org.broadleafcommerce.common.web.DeployBehavior;
  28  import org.springframework.security.core.context.SecurityContext;
  29  import org.springframework.security.core.context.SecurityContextHolder;
  30  import org.springframework.security.web.context.HttpSessionSecurityContextRepository;
  31  import org.springframework.stereotype.Service;
  32  import org.springframework.web.context.request.RequestContextHolder;
  33  import org.springframework.web.context.request.ServletRequestAttributes;
  34  import org.springframework.web.context.request.WebRequest;
  35  
  36  import javax.servlet.http.HttpServletRequest;
  37  import javax.servlet.http.HttpSession;
  38  
  39  /**
  40   * &lt;p&gt;
  41   * Some resource handlers need a valid site, theme, or sandbox to be available when serving request.
  42   *
  43   * &lt;p&gt;
  44   * This component provides the {@link #establishThinRequestContext()} method for that purpose.
  45   *
  46   * @author bpolster
  47   *
  48   */
  49  @Service(&quot;blBroadleafContextUtil&quot;)
  50  public class BroadleafContextUtil {
  51  
  52      @javax.annotation.Resource(name = &quot;blSiteResolver&quot;)
  53      protected BroadleafSiteResolver siteResolver;
  54  
  55      @javax.annotation.Resource(name = &quot;blSandBoxResolver&quot;)
  56      protected BroadleafSandBoxResolver sbResolver;
  57  
  58      @javax.annotation.Resource(name = &quot;blThemeResolver&quot;)
  59      protected BroadleafThemeResolver themeResolver;
  60  
  61      @javax.annotation.Resource(name = &quot;blDeployBehaviorUtil&quot;)
  62      protected DeployBehaviorUtil deployBehaviorUtil;
  63  
  64      protected boolean versioningEnabled = false;
  65  
  66      /**
  67       * Creates a BroadleafRequestContext with supported values populated
  68       * @see #establishThinRequestContextInternal(boolean, boolean)
  69       */
  70      public void establishThinRequestContext() {
  71          establishThinRequestContextInternal(true, true);
  72      }
  73  
  74      /**
  75       * Creates a BroadleafRequestContext without a Sandbox
  76       * @see #establishThinRequestContextInternal(boolean, boolean)
  77       */
  78      public void establishThinRequestContextWithoutSandBox() {
  79          establishThinRequestContextInternal(true, false);
  80      }
  81  
  82      /**
  83       * Creates a BroadleafRequestContext without a Theme or Sandbox
  84       * @see #establishThinRequestContextInternal(boolean, boolean)
  85       */
  86      public void establishThinRequestContextWithoutThemeOrSandbox() {
  87          establishThinRequestContextInternal(false, false);
  88      }
  89  
  90      /**
  91       * Adds request and site to the BroadleafRequestContext
  92       *
  93       * If includeTheme is true then also adds the Theme.
  94       * If includeSandBox is true then also adds the SandBox.
  95       *
  96       * @param includeTheme
  97       * @param includeSandBox
  98       */
  99      protected void establishThinRequestContextInternal(boolean includeTheme, boolean includeSandBox) {
 100          BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();
 101  
 102          if (brc.getRequest() == null) {
<abbr title=" 103              HttpServletRequest req = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();"> 103              HttpServletRequest req = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRðŸ”µ</abbr>
 104              HttpSession session = req.getSession(false);
 105              SecurityContext ctx = readSecurityContextFromSession(session);
 106              if (ctx != null) {
 107                  SecurityContextHolder.setContext(ctx);









 108              }
 109              brc.setRequest(req);
 110          }
 111  
 112          WebRequest wr = brc.getWebRequest();
 113  
 114          if (brc.getNonPersistentSite() == null) {
 115              brc.setNonPersistentSite(siteResolver.resolveSite(wr, true));
 116              if (includeSandBox) {
 117                  brc.setSandBox(sbResolver.resolveSandBox(wr, brc.getNonPersistentSite()));







 118              }
<abbr title=" 119              brc.setDeployBehavior(deployBehaviorUtil.isProductionSandBoxMode() ? DeployBehavior.CLONE_PARENT : DeployBehavior.OVERWRITE_PARENT);"> 119              brc.setDeployBehavior(deployBehaviorUtil.isProductionSandBoxMode() ? DeployBehavior.CLONE_PARENT : DepðŸ”µ</abbr>
 120          }
 121  
 122          if (includeTheme) {
 123              if (brc.getTheme() == null) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +                brc.setRequestDTO(new RequestDTOImpl(brc.getRequest()));</span>
 125                  brc.setTheme(themeResolver.resolveTheme(wr));




 126              }
 127          }
 128      }
 129  
 130      public void clearThinRequestContext() {
 131          ThreadLocalManager.remove();
 132      }
 133  
 134      protected String getContextName(HttpServletRequest request) {
 135          String contextName = request.getServerName();
 136          int pos = contextName.indexOf(&#x27;.&#x27;);
 137          if (pos &gt;= 0) {
 138              contextName = contextName.substring(0, contextName.indexOf(&#x27;.&#x27;));
 139          }
 140          return contextName;
 141      }
 142  
 143      // **NOTE** This method is lifted from HttpSessionSecurityContextRepository
 144      protected SecurityContext readSecurityContextFromSession(HttpSession httpSession) {
 145          if (httpSession == null) {
 146              return null;
 147          }
 148  
<abbr title=" 149          Object ctxFromSession = httpSession.getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);"> 149          Object ctxFromSession = httpSession.getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTðŸ”µ</abbr>
 150          if (ctxFromSession == null) {
 151              return null;
 152          }
 153  
 154          if (!(ctxFromSession instanceof SecurityContext)) {
 155              return null;
 156          }
 157  
 158          return (SecurityContext) ctxFromSession;
 159      }
 160  
 161  
 162  
 163  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            