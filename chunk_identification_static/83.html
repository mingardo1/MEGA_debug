<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>83</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    83
                    <a href="82.html">prev</a>
                    <a href="84.html">next</a>
                    <a href="83_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_a34d41194e233178cf5a5271c80c76c76357ef92_Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;a34d41194e233178cf5a5271c80c76c76357ef92:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;a34d41194e233178cf5a5271c80c76c76357ef92^1:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;a34d41194e233178cf5a5271c80c76c76357ef92^2:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;68c4cd2a0207d8e703f7a7f293023155b1ea425d:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.DialogInterface;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.net.Uri;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.ParcelFileDescriptor;
  12 import android.widget.Toast;
  13 
  14 import androidx.appcompat.app.AlertDialog;
  15 import androidx.appcompat.view.ContextThemeWrapper;
  16 import androidx.core.app.ShareCompat;
  17 import androidx.preference.ListPreference;
  18 import androidx.preference.Preference;
  19 import androidx.preference.PreferenceFragmentCompat;
  20 import androidx.preference.PreferenceManager;
  21 import androidx.preference.SwitchPreferenceCompat;
  22 
  23 import com.automattic.simplenote.analytics.AnalyticsTracker;
  24 import com.automattic.simplenote.models.Note;
  25 import com.automattic.simplenote.models.Preferences;
  26 import com.automattic.simplenote.utils.AppLog;
  27 import com.automattic.simplenote.utils.AppLog.Type;
  28 import com.automattic.simplenote.utils.BrowserUtils;
  29 import com.automattic.simplenote.utils.CrashUtils;
  30 import com.automattic.simplenote.utils.HtmlCompat;
  31 import com.automattic.simplenote.utils.PrefUtils;
  32 import com.automattic.simplenote.utils.WidgetUtils;
  33 import com.simperium.Simperium;
  34 import com.simperium.client.Bucket;
  35 import com.simperium.client.BucketObjectMissingException;
  36 import com.simperium.client.BucketObjectNameInvalid;
  37 import com.simperium.client.User;
  38 
  39 import org.json.JSONArray;
  40 import org.json.JSONObject;
  41 import org.wordpress.passcodelock.AppLockManager;
  42 
  43 import java.io.FileOutputStream;
  44 import java.lang.ref.WeakReference;
  45 import java.util.Collections;
  46 import java.util.Comparator;
  47 import java.util.List;
  48 
  49 import static android.app.Activity.RESULT_OK;
  50 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  51 
  52 /**
  53  * A simple {@link Fragment} subclass.
  54  */
<abbr title="  55 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.OnUserCreatedListener {">  55 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, SðŸ”µ</abbr>
  56     public static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  57 
  58     private static final int REQUEST_EXPORT_DATA = 9001;
  59     private static final int REQUEST_EXPORT_UNSYNCED = 9002;
  60 
  61     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  62     private SwitchPreferenceCompat mAnalyticsSwitch;
  63 
  64     public PreferencesFragment() {
  65         // Required empty public constructor
  66     }
  67 
  68     @Override
  69     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  70         addPreferencesFromResource(R.xml.preferences);
  71     }
  72 
  73     @Override
  74     public void onActivityCreated(Bundle savedInstanceState) {
  75         super.onActivityCreated(savedInstanceState);
  76 
  77         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  78         Simplenote currentApp = (Simplenote) getActivity().getApplication();
  79         Simperium simperium = currentApp.getSimperium();
  80         simperium.setUserStatusChangeListener(this);
  81         simperium.setOnUserCreatedListener(this);
  82         mPreferencesBucket = currentApp.getPreferencesBucket();
  83         mPreferencesBucket.start();
  84 
  85         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  86         if (simperium.needsAuthorization()) {
  87             authenticatePreference.setTitle(R.string.log_in);
  88         } else {
  89             authenticatePreference.setTitle(R.string.log_out);
  90         }
  91 
  92         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
  93             @Override
  94             public boolean onPreferenceClick(Preference preference) {
  95                 if (!isAdded()) {
  96                     return false;
  97                 }
  98 
  99                 Simplenote currentApp = (Simplenote) getActivity().getApplication();
 100                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 101                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);"> 101                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
 102                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 103                 } else {
 104                     new LogOutTask(PreferencesFragment.this).execute();
 105                 }
 106                 return true;
 107             }
 108         });
 109 
<abbr title=" 110         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 110         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
 111             @Override
 112             public boolean onPreferenceClick(Preference preference) {
 113                 try {
 114                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 115                 } catch (Exception e) {
<abbr title=" 116                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();"> 116                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show(ðŸ”µ</abbr>
 117                 }
 118                 return true;
 119             }
 120         });
 121 
<abbr title=" 122         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 122         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
 123             @Override
 124             public boolean onPreferenceClick(Preference preference) {
 125                 startActivity(new Intent(getActivity(), AboutActivity.class));
 126                 return true;
 127             }
 128         });
 129 
<abbr title=" 130         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 130         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 131             @Override
 132             public boolean onPreferenceClick(Preference preference) {
 133                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 134                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 135                 intent.setType(&quot;application/json&quot;);
 136                 intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 137                 startActivityForResult(intent, REQUEST_EXPORT_DATA);
 138                 return true;
 139             }
 140         });
 141 
 142         final ListPreference themePreference = findPreference(PrefUtils.PREF_THEME);
 143         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 144             @Override
 145             public boolean onPreferenceChange(Preference preference, Object newValue) {
 146                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 147                 return true;
 148             }
 149 
 150             private void updateTheme(Activity activity, int index) {
 151                 CharSequence[] entries = themePreference.getEntries();
 152                 themePreference.setSummary(entries[index]);
 153 
 154                 AnalyticsTracker.track(
 155                         AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 156                         AnalyticsTracker.CATEGORY_USER,
 157                         &quot;theme_preference&quot;
 158                 );
 159 
 160                 // recreate the activity so new theme is applied
 161                 activity.recreate();
 162             }
 163         });
 164 
 165         final Preference stylePreference = findPreference(&quot;pref_key_style&quot;);
 166         stylePreference.setSummary(
 167             PrefUtils.isPremium(requireContext()) ?
 168                 PrefUtils.getStyleNameFromIndexSelected(requireContext()) :
 169                 PrefUtils.getStyleNameDefault(requireContext())
 170         );
 171         stylePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 172             @Override
 173             public boolean onPreferenceClick(Preference preference) {
 174                 startActivity(new Intent(requireContext(), StyleActivity.class));
 175                 return true;
 176             }
 177         });
 178 
 179         final ListPreference sortPreference = findPreference(PrefUtils.PREF_SORT_ORDER);
 180         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 181             @Override
 182             public boolean onPreferenceChange(Preference preference, Object newValue) {
 183                 int index = Integer.parseInt(newValue.toString());
 184                 CharSequence[] entries = sortPreference.getEntries();
 185                 sortPreference.setSummary(entries[index]);
 186 
 187                 return true;
 188             }
 189         });
 190 
 191 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192         Preference versionPref = findPreference(&quot;pref_key_build&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193         versionPref.setSummary(PrefUtils.versionInfo());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194 </span>
 195 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 196         SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_note_list&quot;);"> 196         SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condeðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199             public boolean onPreferenceChange(Preference preference, Object o) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200                 if (((SwitchPreferenceCompat) preference).isChecked()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201                     AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202                             AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203                             AnalyticsTracker.CATEGORY_USER,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204                             &quot;condensed_list_preference&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205                     );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208                 return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210         });</span>
 211 =======
 212 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 213         SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);
 214         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 215             @Override
 216             public boolean onPreferenceChange(Preference preference, Object o) {
 217                 if (((SwitchPreferenceCompat) preference).isChecked()) {
 218                     AnalyticsTracker.track(
 219                             AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 220                             AnalyticsTracker.CATEGORY_USER,
 221                             &quot;condensed_list_preference&quot;
 222                     );
 223                 }
 224 
 225                 return true;
 226             }
 227         });
 228 
 229         // Add the hyperlink to the analytics summary
 230         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 231         String formattedSummary = String.format(
 232                 getString(R.string.share_analytics_summary),
 233                 &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 234                 &quot;&lt;/a&gt;&quot;
 235         );
 236         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 237 
 238         mAnalyticsSwitch = findPreference(&quot;pref_key_analytics_switch&quot;);
 239         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 240             @Override
 241             public boolean onPreferenceChange(Preference preference, Object newValue) {
 242                 try {
 243                     boolean isChecked = (boolean)newValue;
 244                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 245                     prefs.setAnalyticsEnabled(isChecked);
 246                     prefs.save();
 247                 } catch (BucketObjectMissingException e) {
 248                     e.printStackTrace();
 249                 }
 250 
 251                 return true;
 252             }
 253         });
 254 
 255         updateAnalyticsSwitchState();
 256 
<abbr title=" 257         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 257         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 258             @Override
 259             public boolean onPreferenceClick(Preference preference) {
 260                 startActivity(
 261                     ShareCompat.IntentBuilder.from(requireActivity())
 262                         .setText(AppLog.get())
 263                         .setType(&quot;text/plain&quot;)
 264                         .createChooserIntent()
 265                 );
 266                 return true;
 267             }
 268         });
 269     }
 270 
 271     @Override
 272     public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 273         if (resultCode != RESULT_OK || resultData == null) {
 274             return;
 275         }
 276 
 277         if (resultData.getData() == null) {
<abbr title=" 278             Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 278             Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHOðŸ”µ</abbr>
 279             return;
 280         }
 281 
 282         switch (requestCode) {
 283             case REQUEST_EXPORT_DATA:
 284                 exportData(resultData.getData(), false);
 285                 break;
 286             case REQUEST_EXPORT_UNSYNCED:
 287                 exportData(resultData.getData(), true);
 288                 break;
 289         }
 290     }
 291 
 292     @Override
 293     public void onPause() {
 294         super.onPause();
 295         mPreferencesBucket.stop();
 296     }
 297 
 298     private boolean hasUnsyncedNotes() {
 299         Simplenote application = (Simplenote) getActivity().getApplication();
 300         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 301         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 302         while (notesCursor.moveToNext()) {
 303             Note note = notesCursor.getObject();
 304             if (note.isNew() || note.isModified()) {
 305                 return true;
 306             }
 307         }
 308 
 309         return false;
 310     }
 311 
 312     private void logOut() {
 313         Simplenote application = (Simplenote) getActivity().getApplication();
 314         application.getSimperium().deauthorizeUser();
 315 
 316         application.getNotesBucket().reset();
 317         application.getTagsBucket().reset();
 318         application.getPreferencesBucket().reset();
 319 
 320         application.getNotesBucket().stop();
 321         AppLog.add(Type.SYNC, &quot;Stopped note bucket (PreferencesFragment)&quot;);
 322         application.getTagsBucket().stop();
 323         AppLog.add(Type.SYNC, &quot;Stopped tag bucket (PreferencesFragment)&quot;);
 324         application.getPreferencesBucket().stop();
 325 
 326         AnalyticsTracker.track(
 327                 AnalyticsTracker.Stat.USER_SIGNED_OUT,
 328                 AnalyticsTracker.CATEGORY_USER,
 329                 &quot;preferences_sign_out_button&quot;
 330         );
 331 
 332         // Resets analytics user back to &#x27;anon&#x27; type
 333         AnalyticsTracker.refreshMetadata(null);
 334         CrashUtils.clearCurrentUser();
 335 
 336         // Remove wp.com token
<abbr title=" 337         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();"> 337         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edðŸ”µ</abbr>
 338         editor.remove(PrefUtils.PREF_WP_TOKEN);
 339 
 340         // Remove WordPress sites
 341         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 342         editor.apply();
 343 
 344         // Remove Passcode Lock password
 345         AppLockManager.getInstance().getAppLock().setPassword(&quot;&quot;);
 346 
 347         WidgetUtils.updateNoteWidgets(requireActivity().getApplicationContext());
 348 
 349         getActivity().finish();
 350     }
 351 
 352     @Override
 353     public void onUserStatusChange(User.Status status) {
 354         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 355             // User signed in
 356             getActivity().runOnUiThread(new Runnable() {
 357                 public void run() {
 358                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 359                     authenticatePreference.setTitle(R.string.log_out);
 360                 }
 361             });
 362 
 363             Simplenote app = (Simplenote) getActivity().getApplication();
 364             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 365             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 366 
 367             AnalyticsTracker.track(
 368                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 369                     AnalyticsTracker.CATEGORY_USER,
 370                     &quot;signed_in_from_preferences_activity&quot;
 371             );
 372         }
 373     }
 374 
 375     @Override
 376     public void onUserCreated(User user) {
 377         AnalyticsTracker.track(
 378                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 379                 AnalyticsTracker.CATEGORY_USER,
 380                 &quot;account_created_from_preferences_activity&quot;
 381         );
 382     }
 383 
 384     private void exportData(Uri uri, boolean isUnsyncedNotes) {
 385         Simplenote currentApp = (Simplenote) requireActivity().getApplication();
 386         Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 387         JSONObject account = new JSONObject();
 388         Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 389 
 390         try {
 391             JSONArray activeNotes = new JSONArray();
 392             JSONArray trashedNotes = new JSONArray();
 393             Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 394                 @Override
 395                 public int compare(String text1, String text2) {
 396                     return text1.compareToIgnoreCase(text2);
 397                 }
 398             };
 399 
 400             while (cursor.moveToNext()) {
 401                 Note note = cursor.getObject();
 402 
 403                 if (isUnsyncedNotes &amp;&amp; !note.isNew() &amp;&amp; !note.isModified()) {
 404                     continue;
 405                 }
 406 
 407                 JSONObject noteJson = new JSONObject();
 408 
 409                 noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 410                 noteJson.put(&quot;content&quot;, note.getContent());
 411                 noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 412                 noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 413 
 414                 if (note.isPinned()) {
 415                     noteJson.put(&quot;pinned&quot;, note.isPinned());
 416                 }
 417 
 418                 if (note.isMarkdownEnabled()) {
 419                     noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 420                 }
 421 
 422                 if (note.getTags().size() &gt; 0) {
 423                     List&lt;String&gt; tags = note.getTags();
 424                     Collections.sort(tags, comparator);
 425                     noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 426                 }
 427 
 428                 if (!note.getPublishedUrl().isEmpty()) {
 429                     noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 430                 }
 431 
 432                 if (note.isDeleted()) {
 433                     trashedNotes.put(noteJson);
 434                 } else {
 435                     activeNotes.put(noteJson);
 436                 }
 437             }
 438 
 439             account.put(&quot;activeNotes&quot;, activeNotes);
 440             account.put(&quot;trashedNotes&quot;, trashedNotes);
 441 
<abbr title=" 442             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 442             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDesðŸ”µ</abbr>
 443 
 444             if (parcelFileDescriptor != null) {
<abbr title=" 445                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 445                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescðŸ”µ</abbr>
 446                 fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;,&quot;/&quot;).getBytes());
 447                 parcelFileDescriptor.close();
<abbr title=" 448                 Toast.makeText(requireContext(), getString(R.string.export_message_success), Toast.LENGTH_SHORT).show();"> 448                 Toast.makeText(requireContext(), getString(R.string.export_message_success), Toast.LENGTHðŸ”µ</abbr>
 449             } else {
<abbr title=" 450                 Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 450                 Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTHðŸ”µ</abbr>
 451             }
 452         } catch (Exception e) {
<abbr title=" 453             Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 453             Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHOðŸ”µ</abbr>
 454         }
 455     }
 456 
 457     private void updateAnalyticsSwitchState() {
 458         try {
 459             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 460             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 461         } catch (BucketObjectMissingException e) {
 462             // The preferences object doesn&#x27;t exist for this user yet, create it
 463             try {
 464                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 465                 prefs.setAnalyticsEnabled(true);
 466                 prefs.save();
 467             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 468                 bucketObjectNameInvalid.printStackTrace();
 469             }
 470         }
 471     }
 472 
 473     private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 474         private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 475 
 476         LogOutTask(PreferencesFragment fragment) {
 477             mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 478         }
 479 
 480         @Override
 481         protected Boolean doInBackground(Void... voids) {
 482             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 483             return fragment == null || fragment.hasUnsyncedNotes();
 484         }
 485 
 486         @Override
 487         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 488             final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 489 
 490             if (fragment == null) {
 491                 return;
 492             }
 493 
 494             // Safety first! Check if any notes are unsynced and warn the user if so.
 495             if (hasUnsyncedNotes) {
<abbr title=" 496                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))"> 496                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 497                     .setTitle(R.string.unsynced_notes)
 498                     .setMessage(R.string.unsynced_notes_message)
 499                     .setPositiveButton(R.string.log_out_anyway,
 500                         new DialogInterface.OnClickListener() {
 501                             @Override
 502                             public void onClick(DialogInterface dialogInterface, int i) {
 503                                 fragment.logOut();
 504                             }
 505                         }
 506                     )
 507                     .setNeutralButton(R.string.export_unsynced_notes,
 508                         new DialogInterface.OnClickListener() {
 509                             @Override
 510                             public void onClick(DialogInterface dialogInterface, int i) {
 511                                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 512                                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 513                                 intent.setType(&quot;application/json&quot;);
<abbr title=" 514                                 intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));"> 514                                 intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_fiðŸ”µ</abbr>
 515                                 fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 516                             }
 517                         }
 518                     )
 519                     .setNegativeButton(R.string.cancel, null)
 520                     .show();
 521             } else {
 522                 fragment.logOut();
 523             }
 524         }
 525     }
 526 }
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.DialogInterface;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.net.Uri;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.ParcelFileDescriptor;
  12 import android.widget.Toast;
  13 
  14 import androidx.appcompat.app.AlertDialog;
  15 import androidx.appcompat.view.ContextThemeWrapper;
  16 import androidx.core.app.ShareCompat;
  17 import androidx.preference.ListPreference;
  18 import androidx.preference.Preference;
  19 import androidx.preference.PreferenceFragmentCompat;
  20 import androidx.preference.PreferenceManager;
  21 import androidx.preference.SwitchPreferenceCompat;
  22 
  23 import com.automattic.simplenote.analytics.AnalyticsTracker;
  24 import com.automattic.simplenote.models.Note;
  25 import com.automattic.simplenote.models.Preferences;
  26 import com.automattic.simplenote.utils.AppLog;
  27 import com.automattic.simplenote.utils.AppLog.Type;
  28 import com.automattic.simplenote.utils.BrowserUtils;
  29 import com.automattic.simplenote.utils.CrashUtils;
  30 import com.automattic.simplenote.utils.HtmlCompat;
  31 import com.automattic.simplenote.utils.PrefUtils;
  32 import com.automattic.simplenote.utils.WidgetUtils;
  33 import com.simperium.Simperium;
  34 import com.simperium.client.Bucket;
  35 import com.simperium.client.BucketObjectMissingException;
  36 import com.simperium.client.BucketObjectNameInvalid;
  37 import com.simperium.client.User;
  38 
  39 import org.json.JSONArray;
  40 import org.json.JSONObject;
  41 import org.wordpress.passcodelock.AppLockManager;
  42 
  43 import java.io.FileOutputStream;
  44 import java.lang.ref.WeakReference;
  45 import java.util.Collections;
  46 import java.util.Comparator;
  47 import java.util.List;
  48 
  49 import static android.app.Activity.RESULT_OK;
  50 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  51 
  52 /**
  53  * A simple {@link Fragment} subclass.
  54  */
<abbr title="  55 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.OnUserCreatedListener {">  55 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, SðŸ”µ</abbr>
  56     public static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  57 
  58     private static final int REQUEST_EXPORT_DATA = 9001;
  59     private static final int REQUEST_EXPORT_UNSYNCED = 9002;
  60 
  61     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  62     private SwitchPreferenceCompat mAnalyticsSwitch;
  63 
  64     public PreferencesFragment() {
  65         // Required empty public constructor
  66     }
  67 
  68     @Override
  69     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  70         addPreferencesFromResource(R.xml.preferences);
  71     }
  72 
  73     @Override
  74     public void onActivityCreated(Bundle savedInstanceState) {
  75         super.onActivityCreated(savedInstanceState);
  76 
  77         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  78         Simplenote currentApp = (Simplenote) getActivity().getApplication();
  79         Simperium simperium = currentApp.getSimperium();
  80         simperium.setUserStatusChangeListener(this);
  81         simperium.setOnUserCreatedListener(this);
  82         mPreferencesBucket = currentApp.getPreferencesBucket();
  83         mPreferencesBucket.start();
  84 
  85         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  86         if (simperium.needsAuthorization()) {
  87             authenticatePreference.setTitle(R.string.log_in);
  88         } else {
  89             authenticatePreference.setTitle(R.string.log_out);
  90         }
  91 
  92         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
  93             @Override
  94             public boolean onPreferenceClick(Preference preference) {
  95                 if (!isAdded()) {
  96                     return false;
  97                 }
  98 
  99                 Simplenote currentApp = (Simplenote) getActivity().getApplication();
 100                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 101                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);"> 101                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
 102                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 103                 } else {
 104                     new LogOutTask(PreferencesFragment.this).execute();
 105                 }
 106                 return true;
 107             }
 108         });
 109 
<abbr title=" 110         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 110         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
 111             @Override
 112             public boolean onPreferenceClick(Preference preference) {
 113                 try {
 114                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 115                 } catch (Exception e) {
<abbr title=" 116                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();"> 116                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show(ðŸ”µ</abbr>
 117                 }
 118                 return true;
 119             }
 120         });
 121 
<abbr title=" 122         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 122         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
 123             @Override
 124             public boolean onPreferenceClick(Preference preference) {
 125                 startActivity(new Intent(getActivity(), AboutActivity.class));
 126                 return true;
 127             }
 128         });
 129 
<abbr title=" 130         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 130         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 131             @Override
 132             public boolean onPreferenceClick(Preference preference) {
 133                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 134                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 135                 intent.setType(&quot;application/json&quot;);
 136                 intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 137                 startActivityForResult(intent, REQUEST_EXPORT_DATA);
 138                 return true;
 139             }
 140         });
 141 
 142         final ListPreference themePreference = findPreference(PrefUtils.PREF_THEME);
 143         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 144             @Override
 145             public boolean onPreferenceChange(Preference preference, Object newValue) {
 146                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 147                 return true;
 148             }
 149 
 150             private void updateTheme(Activity activity, int index) {
 151                 CharSequence[] entries = themePreference.getEntries();
 152                 themePreference.setSummary(entries[index]);
 153 
 154                 AnalyticsTracker.track(
 155                         AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 156                         AnalyticsTracker.CATEGORY_USER,
 157                         &quot;theme_preference&quot;
 158                 );
 159 
 160                 // recreate the activity so new theme is applied
 161                 activity.recreate();
 162             }
 163         });
 164 
 165         final Preference stylePreference = findPreference(&quot;pref_key_style&quot;);
 166         stylePreference.setSummary(
 167             PrefUtils.isPremium(requireContext()) ?
 168                 PrefUtils.getStyleNameFromIndexSelected(requireContext()) :
 169                 PrefUtils.getStyleNameDefault(requireContext())
 170         );
 171         stylePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 172             @Override
 173             public boolean onPreferenceClick(Preference preference) {
 174                 startActivity(new Intent(requireContext(), StyleActivity.class));
 175                 return true;
 176             }
 177         });
 178 
 179         final ListPreference sortPreference = findPreference(PrefUtils.PREF_SORT_ORDER);
 180         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 181             @Override
 182             public boolean onPreferenceChange(Preference preference, Object newValue) {
 183                 int index = Integer.parseInt(newValue.toString());
 184                 CharSequence[] entries = sortPreference.getEntries();
 185                 sortPreference.setSummary(entries[index]);
 186 
 187                 return true;
 188             }
 189         });
 190 
 191 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192         Preference versionPref = findPreference(&quot;pref_key_build&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193         versionPref.setSummary(PrefUtils.versionInfo());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194 </span>
 195 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196         Preference versionPref = findPreference(&quot;pref_key_build&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197         versionPref.setSummary(PrefUtils.versionInfo());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 199         SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_note_list&quot;);"> 199         SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condeðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202             public boolean onPreferenceChange(Preference preference, Object o) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203                 if (((SwitchPreferenceCompat) preference).isChecked()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204                     AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205                             AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206                             AnalyticsTracker.CATEGORY_USER,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207                             &quot;condensed_list_preference&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208                     );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211                 return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212             }</span>
 213 =======
 214 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 215         SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);
 216         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 217             @Override
 218             public boolean onPreferenceChange(Preference preference, Object o) {
 219                 if (((SwitchPreferenceCompat) preference).isChecked()) {
 220                     AnalyticsTracker.track(
 221                             AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 222                             AnalyticsTracker.CATEGORY_USER,
 223                             &quot;condensed_list_preference&quot;
 224                     );
 225                 }
 226 
 227                 return true;
 228             }
 229         });
 230 
 231         // Add the hyperlink to the analytics summary
 232         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 233         String formattedSummary = String.format(
 234                 getString(R.string.share_analytics_summary),
 235                 &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 236                 &quot;&lt;/a&gt;&quot;
 237         );
 238         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 239 
 240         mAnalyticsSwitch = findPreference(&quot;pref_key_analytics_switch&quot;);
 241         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 242             @Override
 243             public boolean onPreferenceChange(Preference preference, Object newValue) {
 244                 try {
 245                     boolean isChecked = (boolean)newValue;
 246                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 247                     prefs.setAnalyticsEnabled(isChecked);
 248                     prefs.save();
 249                 } catch (BucketObjectMissingException e) {
 250                     e.printStackTrace();
 251                 }
 252 
 253                 return true;
 254             }
 255         });
 256 
 257         updateAnalyticsSwitchState();
 258 
<abbr title=" 259         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 259         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 260             @Override
 261             public boolean onPreferenceClick(Preference preference) {
 262                 startActivity(
 263                     ShareCompat.IntentBuilder.from(requireActivity())
 264                         .setText(AppLog.get())
 265                         .setType(&quot;text/plain&quot;)
 266                         .createChooserIntent()
 267                 );
 268                 return true;
 269             }
 270         });
 271     }
 272 
 273     @Override
 274     public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 275         if (resultCode != RESULT_OK || resultData == null) {
 276             return;
 277         }
 278 
 279         if (resultData.getData() == null) {
<abbr title=" 280             Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 280             Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHOðŸ”µ</abbr>
 281             return;
 282         }
 283 
 284         switch (requestCode) {
 285             case REQUEST_EXPORT_DATA:
 286                 exportData(resultData.getData(), false);
 287                 break;
 288             case REQUEST_EXPORT_UNSYNCED:
 289                 exportData(resultData.getData(), true);
 290                 break;
 291         }
 292     }
 293 
 294     @Override
 295     public void onPause() {
 296         super.onPause();
 297         mPreferencesBucket.stop();
 298     }
 299 
 300     private boolean hasUnsyncedNotes() {
 301         Simplenote application = (Simplenote) getActivity().getApplication();
 302         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 303         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 304         while (notesCursor.moveToNext()) {
 305             Note note = notesCursor.getObject();
 306             if (note.isNew() || note.isModified()) {
 307                 return true;
 308             }
 309         }
 310 
 311         return false;
 312     }
 313 
 314     private void logOut() {
 315         Simplenote application = (Simplenote) getActivity().getApplication();
 316         application.getSimperium().deauthorizeUser();
 317 
 318         application.getNotesBucket().reset();
 319         application.getTagsBucket().reset();
 320         application.getPreferencesBucket().reset();
 321 
 322         application.getNotesBucket().stop();
 323         AppLog.add(Type.SYNC, &quot;Stopped note bucket (PreferencesFragment)&quot;);
 324         application.getTagsBucket().stop();
 325         AppLog.add(Type.SYNC, &quot;Stopped tag bucket (PreferencesFragment)&quot;);
 326         application.getPreferencesBucket().stop();
 327 
 328         AnalyticsTracker.track(
 329                 AnalyticsTracker.Stat.USER_SIGNED_OUT,
 330                 AnalyticsTracker.CATEGORY_USER,
 331                 &quot;preferences_sign_out_button&quot;
 332         );
 333 
 334         // Resets analytics user back to &#x27;anon&#x27; type
 335         AnalyticsTracker.refreshMetadata(null);
 336         CrashUtils.clearCurrentUser();
 337 
 338         // Remove wp.com token
<abbr title=" 339         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();"> 339         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edðŸ”µ</abbr>
 340         editor.remove(PrefUtils.PREF_WP_TOKEN);
 341 
 342         // Remove WordPress sites
 343         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 344         editor.apply();
 345 
 346         // Remove Passcode Lock password
 347         AppLockManager.getInstance().getAppLock().setPassword(&quot;&quot;);
 348 
 349         WidgetUtils.updateNoteWidgets(requireActivity().getApplicationContext());
 350 
 351         getActivity().finish();
 352     }
 353 
 354     @Override
 355     public void onUserStatusChange(User.Status status) {
 356         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 357             // User signed in
 358             getActivity().runOnUiThread(new Runnable() {
 359                 public void run() {
 360                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 361                     authenticatePreference.setTitle(R.string.log_out);
 362                 }
 363             });
 364 
 365             Simplenote app = (Simplenote) getActivity().getApplication();
 366             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 367             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 368 
 369             AnalyticsTracker.track(
 370                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 371                     AnalyticsTracker.CATEGORY_USER,
 372                     &quot;signed_in_from_preferences_activity&quot;
 373             );
 374         }
 375     }
 376 
 377     @Override
 378     public void onUserCreated(User user) {
 379         AnalyticsTracker.track(
 380                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 381                 AnalyticsTracker.CATEGORY_USER,
 382                 &quot;account_created_from_preferences_activity&quot;
 383         );
 384     }
 385 
 386     private void exportData(Uri uri, boolean isUnsyncedNotes) {
 387         Simplenote currentApp = (Simplenote) requireActivity().getApplication();
 388         Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 389         JSONObject account = new JSONObject();
 390         Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 391 
 392         try {
 393             JSONArray activeNotes = new JSONArray();
 394             JSONArray trashedNotes = new JSONArray();
 395             Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 396                 @Override
 397                 public int compare(String text1, String text2) {
 398                     return text1.compareToIgnoreCase(text2);
 399                 }
 400             };
 401 
 402             while (cursor.moveToNext()) {
 403                 Note note = cursor.getObject();
 404 
 405                 if (isUnsyncedNotes &amp;&amp; !note.isNew() &amp;&amp; !note.isModified()) {
 406                     continue;
 407                 }
 408 
 409                 JSONObject noteJson = new JSONObject();
 410 
 411                 noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 412                 noteJson.put(&quot;content&quot;, note.getContent());
 413                 noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 414                 noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 415 
 416                 if (note.isPinned()) {
 417                     noteJson.put(&quot;pinned&quot;, note.isPinned());
 418                 }
 419 
 420                 if (note.isMarkdownEnabled()) {
 421                     noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 422                 }
 423 
 424                 if (note.getTags().size() &gt; 0) {
 425                     List&lt;String&gt; tags = note.getTags();
 426                     Collections.sort(tags, comparator);
 427                     noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 428                 }
 429 
 430                 if (!note.getPublishedUrl().isEmpty()) {
 431                     noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 432                 }
 433 
 434                 if (note.isDeleted()) {
 435                     trashedNotes.put(noteJson);
 436                 } else {
 437                     activeNotes.put(noteJson);
 438                 }
 439             }
 440 
 441             account.put(&quot;activeNotes&quot;, activeNotes);
 442             account.put(&quot;trashedNotes&quot;, trashedNotes);
 443 
<abbr title=" 444             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 444             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDesðŸ”µ</abbr>
 445 
 446             if (parcelFileDescriptor != null) {
<abbr title=" 447                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 447                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescðŸ”µ</abbr>
 448                 fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;,&quot;/&quot;).getBytes());
 449                 parcelFileDescriptor.close();
<abbr title=" 450                 Toast.makeText(requireContext(), getString(R.string.export_message_success), Toast.LENGTH_SHORT).show();"> 450                 Toast.makeText(requireContext(), getString(R.string.export_message_success), Toast.LENGTHðŸ”µ</abbr>
 451             } else {
<abbr title=" 452                 Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 452                 Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTHðŸ”µ</abbr>
 453             }
 454         } catch (Exception e) {
<abbr title=" 455             Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 455             Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHOðŸ”µ</abbr>
 456         }
 457     }
 458 
 459     private void updateAnalyticsSwitchState() {
 460         try {
 461             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 462             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 463         } catch (BucketObjectMissingException e) {
 464             // The preferences object doesn&#x27;t exist for this user yet, create it
 465             try {
 466                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 467                 prefs.setAnalyticsEnabled(true);
 468                 prefs.save();
 469             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 470                 bucketObjectNameInvalid.printStackTrace();
 471             }
 472         }
 473     }
 474 
 475     private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 476         private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 477 
 478         LogOutTask(PreferencesFragment fragment) {
 479             mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 480         }
 481 
 482         @Override
 483         protected Boolean doInBackground(Void... voids) {
 484             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 485             return fragment == null || fragment.hasUnsyncedNotes();
 486         }
 487 
 488         @Override
 489         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 490             final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 491 
 492             if (fragment == null) {
 493                 return;
 494             }
 495 
 496             // Safety first! Check if any notes are unsynced and warn the user if so.
 497             if (hasUnsyncedNotes) {
<abbr title=" 498                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))"> 498                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 499                     .setTitle(R.string.unsynced_notes)
 500                     .setMessage(R.string.unsynced_notes_message)
 501                     .setPositiveButton(R.string.log_out_anyway,
 502                         new DialogInterface.OnClickListener() {
 503                             @Override
 504                             public void onClick(DialogInterface dialogInterface, int i) {
 505                                 fragment.logOut();
 506                             }
 507                         }
 508                     )
 509                     .setNeutralButton(R.string.export_unsynced_notes,
 510                         new DialogInterface.OnClickListener() {
 511                             @Override
 512                             public void onClick(DialogInterface dialogInterface, int i) {
 513                                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 514                                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 515                                 intent.setType(&quot;application/json&quot;);
<abbr title=" 516                                 intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));"> 516                                 intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_fiðŸ”µ</abbr>
 517                                 fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 518                             }
 519                         }
 520                     )
 521                     .setNegativeButton(R.string.cancel, null)
 522                     .show();
 523             } else {
 524                 fragment.logOut();
 525             }
 526         }
 527     }
 528 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.DialogInterface;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.net.Uri;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.ParcelFileDescriptor;
  12 import android.widget.Toast;
  13 import androidx.appcompat.app.AlertDialog;
  14 import androidx.appcompat.view.ContextThemeWrapper;
  15 import androidx.core.app.ShareCompat;
  16 import androidx.preference.ListPreference;
  17 import androidx.preference.Preference;
  18 import androidx.preference.PreferenceFragmentCompat;
  19 import androidx.preference.PreferenceManager;
  20 import androidx.preference.SwitchPreferenceCompat;
  21 import com.automattic.simplenote.analytics.AnalyticsTracker;
  22 import com.automattic.simplenote.models.Note;
  23 import com.automattic.simplenote.models.Preferences;
  24 import com.automattic.simplenote.utils.AppLog.Type;
  25 import com.automattic.simplenote.utils.AppLog;
  26 import com.automattic.simplenote.utils.BrowserUtils;
  27 import com.automattic.simplenote.utils.CrashUtils;
  28 import com.automattic.simplenote.utils.HtmlCompat;
  29 import com.automattic.simplenote.utils.PrefUtils;
  30 import com.automattic.simplenote.utils.WidgetUtils;
  31 import com.simperium.Simperium;
  32 import com.simperium.client.Bucket;
  33 import com.simperium.client.BucketObjectMissingException;
  34 import com.simperium.client.BucketObjectNameInvalid;
  35 import com.simperium.client.User;
  36 import java.io.FileOutputStream;
  37 import java.lang.ref.WeakReference;
  38 import java.util.Collections;
  39 import java.util.Comparator;
  40 import java.util.List;
  41 import org.json.JSONArray;
  42 import org.json.JSONObject;
  43 import org.wordpress.passcodelock.AppLockManager;
  44 import static android.app.Activity.RESULT_OK;
  45 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  46 
  47 
  48 /**
  49  * A simple {@link Fragment} subclass.
  50  */
<abbr title="  51 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener , Simperium.OnUserCreatedListener {">  51 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener , ðŸ”µ</abbr>
  52     public static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  53 
  54     private static final int REQUEST_EXPORT_DATA = 9001;
  55 
  56     private static final int REQUEST_EXPORT_UNSYNCED = 9002;
  57 
  58     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  59 
  60     private SwitchPreferenceCompat mAnalyticsSwitch;
  61 
  62     public PreferencesFragment() {
  63         // Required empty public constructor
  64     }
  65 
  66     @Override
  67     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  68         addPreferencesFromResource(R.xml.preferences);
  69     }
  70 
  71     @Override
  72     public void onActivityCreated(Bundle savedInstanceState) {
  73         super.onActivityCreated(savedInstanceState);
  74         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  75         Simplenote currentApp = ((Simplenote) (getActivity().getApplication()));
  76         Simperium simperium = currentApp.getSimperium();
  77         simperium.setUserStatusChangeListener(this);
  78         simperium.setOnUserCreatedListener(this);
  79         mPreferencesBucket = currentApp.getPreferencesBucket();
  80         mPreferencesBucket.start();
  81         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  82         if (simperium.needsAuthorization()) {
  83             authenticatePreference.setTitle(R.string.log_in);
  84         } else {
  85             authenticatePreference.setTitle(R.string.log_out);
  86         }
  87         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
  88             @Override
  89             public boolean onPreferenceClick(Preference preference) {
  90                 if (!isAdded()) {
  91                     return false;
  92                 }
  93                 Simplenote currentApp = ((Simplenote) (getActivity().getApplication()));
  94                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title="  95                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);">  95                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
  96                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
  97                 } else {
  98                     new LogOutTask(PreferencesFragment.this).execute();
  99                 }
 100                 return true;
 101             }
 102         });
<abbr title=" 103         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 103         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
 104             @Override
 105             public boolean onPreferenceClick(Preference preference) {
 106                 try {
 107                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 108                 } catch (java.lang.Exception e) {
<abbr title=" 109                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();"> 109                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show(ðŸ”µ</abbr>
 110                 }
 111                 return true;
 112             }
 113         });
<abbr title=" 114         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 114         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
 115             @Override
 116             public boolean onPreferenceClick(Preference preference) {
 117                 startActivity(new Intent(getActivity(), AboutActivity.class));
 118                 return true;
 119             }
 120         });
<abbr title=" 121         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 121         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 122             @Override
 123             public boolean onPreferenceClick(Preference preference) {
 124                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 125                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 126                 intent.setType(&quot;application/json&quot;);
 127                 intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 128                 startActivityForResult(intent, REQUEST_EXPORT_DATA);
 129                 return true;
 130             }
 131         });
 132         final ListPreference themePreference = findPreference(PrefUtils.PREF_THEME);
 133         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 134             @Override
 135             public boolean onPreferenceChange(Preference preference, Object newValue) {
 136                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 137                 return true;
 138             }
 139 
 140             private void updateTheme(Activity activity, int index) {
 141                 CharSequence[] entries = themePreference.getEntries();
 142                 themePreference.setSummary(entries[index]);
<abbr title=" 143                 AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED, AnalyticsTracker.CATEGORY_USER, &quot;theme_preference&quot;);"> 143                 AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED, AnalyticsTracker.CATðŸ”µ</abbr>
 144                 // recreate the activity so new theme is applied
 145                 activity.recreate();
 146             }
 147         });
 148         final Preference stylePreference = findPreference(&quot;pref_key_style&quot;);
<abbr title=" 149         stylePreference.setSummary(PrefUtils.isPremium(requireContext()) ? PrefUtils.getStyleNameFromIndexSelected(requireContext()) : PrefUtils.getStyleNameDefault(requireContext()));"> 149         stylePreference.setSummary(PrefUtils.isPremium(requireContext()) ? PrefUtils.getStyleNameFromIndeðŸ”µ</abbr>
 150         stylePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 151             @Override
 152             public boolean onPreferenceClick(Preference preference) {
 153                 startActivity(new Intent(requireContext(), StyleActivity.class));
 154                 return true;
 155             }
 156         });
 157         final ListPreference sortPreference = findPreference(PrefUtils.PREF_SORT_ORDER);
 158         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 159             @Override
 160             public boolean onPreferenceChange(Preference preference, Object newValue) {
 161                 int index = Integer.parseInt(newValue.toString());
 162                 CharSequence[] entries = sortPreference.getEntries();
 163                 sortPreference.setSummary(entries[index]);
 164                 return true;
 165             }
 166         });
 167         SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);
 168         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 169             @Override
 170             public boolean onPreferenceChange(Preference preference, Object o) {
 171                 if (((SwitchPreferenceCompat) (preference)).isChecked()) {
<abbr title=" 172                     AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED, AnalyticsTracker.CATEGORY_USER, &quot;condensed_list_preference&quot;);"> 172                     AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED, AnalytiðŸ”µ</abbr>
 173                 }
 174                 return true;
 175             }
 176         });
 177         // Add the hyperlink to the analytics summary
 178         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
<abbr title=" 179         String formattedSummary = String.format(getString(R.string.share_analytics_summary), &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;, &quot;&lt;/a&gt;&quot;);"> 179         String formattedSummary = String.format(getString(R.string.share_analytics_summary), &quot;&lt;a href=\&quot;hðŸ”µ</abbr>
 180         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 181         mAnalyticsSwitch = findPreference(&quot;pref_key_analytics_switch&quot;);
 182         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 183             @Override
 184             public boolean onPreferenceChange(Preference preference, Object newValue) {
 185                 try {
 186                     boolean isChecked = ((boolean) (newValue));
 187                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 188                     prefs.setAnalyticsEnabled(isChecked);
 189                     prefs.save();
 190                 } catch (BucketObjectMissingException e) {
 191                     e.printStackTrace();
 192                 }
 193                 return true;
 194             }
 195         });
 196         updateAnalyticsSwitchState();
<abbr title=" 197         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 197         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 198             @Override
 199             public boolean onPreferenceClick(Preference preference) {
<abbr title=" 200                 startActivity(ShareCompat.IntentBuilder.from(requireActivity()).setText(AppLog.get()).setType(&quot;text/plain&quot;).createChooserIntent());"> 200                 startActivity(ShareCompat.IntentBuilder.from(requireActivity()).setText(AppLog.get()).setðŸ”µ</abbr>
 201                 return true;
 202             }
 203         });
 204     }
 205 
 206     @Override
 207     public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 208         if ((resultCode != RESULT_OK) || (resultData == null)) {
 209             return;
 210         }
 211         if (resultData.getData() == null) {
<abbr title=" 212             Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 212             Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHOðŸ”µ</abbr>
 213             return;
 214         }
 215         switch (requestCode) {
 216             case REQUEST_EXPORT_DATA :
 217                 exportData(resultData.getData(), false);
 218                 break;
 219             case REQUEST_EXPORT_UNSYNCED :
 220                 exportData(resultData.getData(), true);
 221                 break;
 222         }
 223     }
 224 
 225     @Override
 226     public void onPause() {
 227         super.onPause();
 228         mPreferencesBucket.stop();
 229     }
 230 
 231     private boolean hasUnsyncedNotes() {
 232         Simplenote application = (Simplenote) getActivity().getApplication();
 233         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 234         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 235         while (notesCursor.moveToNext()) {
 236             Note note = notesCursor.getObject();
 237             if (note.isNew() || note.isModified()) {
 238                 return true;
 239             }
 240         }
 241 
 242         return false;
 243     }
 244 
 245     private void logOut() {
 246         Simplenote application = ((Simplenote) (getActivity().getApplication()));
 247         application.getSimperium().deauthorizeUser();
 248         application.getNotesBucket().reset();
 249         application.getTagsBucket().reset();
 250         application.getPreferencesBucket().reset();
 251         application.getNotesBucket().stop();
 252         AppLog.add(Type.SYNC, &quot;Stopped note bucket (PreferencesFragment)&quot;);
 253         application.getTagsBucket().stop();
 254         AppLog.add(Type.SYNC, &quot;Stopped tag bucket (PreferencesFragment)&quot;);
 255         application.getPreferencesBucket().stop();
<abbr title=" 256         AnalyticsTracker.track(AnalyticsTracker.Stat.USER_SIGNED_OUT, AnalyticsTracker.CATEGORY_USER, &quot;preferences_sign_out_button&quot;);"> 256         AnalyticsTracker.track(AnalyticsTracker.Stat.USER_SIGNED_OUT, AnalyticsTracker.CATEGORY_USER, &quot;prðŸ”µ</abbr>
 257         // Resets analytics user back to &#x27;anon&#x27; type
 258         AnalyticsTracker.refreshMetadata(null);
 259         CrashUtils.clearCurrentUser();
 260         // Remove wp.com token
<abbr title=" 261         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();"> 261         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edðŸ”µ</abbr>
 262         editor.remove(PrefUtils.PREF_WP_TOKEN);
 263         // Remove WordPress sites
 264         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 265         editor.apply();
 266         // Remove Passcode Lock password
 267         AppLockManager.getInstance().getAppLock().setPassword(&quot;&quot;);
 268         WidgetUtils.updateNoteWidgets(requireActivity().getApplicationContext());
 269         getActivity().finish();
 270     }
 271 
 272     @Override
 273     public void onUserStatusChange(User.Status status) {
 274         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 275             // User signed in
 276             getActivity().runOnUiThread(new Runnable() {
 277                 public void run() {
 278                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 279                     authenticatePreference.setTitle(R.string.log_out);
 280                 }
 281             });
 282 
 283             Simplenote app = (Simplenote) getActivity().getApplication();
 284             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 285             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 286 
 287             AnalyticsTracker.track(
 288                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 289                     AnalyticsTracker.CATEGORY_USER,
 290                     &quot;signed_in_from_preferences_activity&quot;
 291             );
 292         }
 293     }
 294 
 295     @Override
 296     public void onUserCreated(User user) {
 297         AnalyticsTracker.track(
 298                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 299                 AnalyticsTracker.CATEGORY_USER,
 300                 &quot;account_created_from_preferences_activity&quot;
 301         );
 302     }
 303 
 304     private void exportData(Uri uri, boolean isUnsyncedNotes) {
 305         Simplenote currentApp = (Simplenote) requireActivity().getApplication();
 306         Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 307         JSONObject account = new JSONObject();
 308         Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 309 
 310         try {
 311             JSONArray activeNotes = new JSONArray();
 312             JSONArray trashedNotes = new JSONArray();
 313             Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 314                 @Override
 315                 public int compare(String text1, String text2) {
 316                     return text1.compareToIgnoreCase(text2);
 317                 }
 318             };
 319 
 320             while (cursor.moveToNext()) {
 321                 Note note = cursor.getObject();
 322 
 323                 if (isUnsyncedNotes &amp;&amp; !note.isNew() &amp;&amp; !note.isModified()) {
 324                     continue;
 325                 }
 326 
 327                 JSONObject noteJson = new JSONObject();
 328 
 329                 noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 330                 noteJson.put(&quot;content&quot;, note.getContent());
 331                 noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 332                 noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 333 
 334                 if (note.isPinned()) {
 335                     noteJson.put(&quot;pinned&quot;, note.isPinned());
 336                 }
 337 
 338                 if (note.isMarkdownEnabled()) {
 339                     noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 340                 }
 341 
 342                 if (note.getTags().size() &gt; 0) {
 343                     List&lt;String&gt; tags = note.getTags();
 344                     Collections.sort(tags, comparator);
 345                     noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 346                 }
 347 
 348                 if (!note.getPublishedUrl().isEmpty()) {
 349                     noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 350                 }
 351 
 352                 if (note.isDeleted()) {
 353                     trashedNotes.put(noteJson);
 354                 } else {
 355                     activeNotes.put(noteJson);
 356                 }
 357             }
 358 
 359             account.put(&quot;activeNotes&quot;, activeNotes);
 360             account.put(&quot;trashedNotes&quot;, trashedNotes);
 361 
<abbr title=" 362             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 362             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDesðŸ”µ</abbr>
 363 
 364             if (parcelFileDescriptor != null) {
<abbr title=" 365                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 365                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescðŸ”µ</abbr>
 366                 fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;,&quot;/&quot;).getBytes());
 367                 parcelFileDescriptor.close();
<abbr title=" 368                 Toast.makeText(requireContext(), getString(R.string.export_message_success), Toast.LENGTH_SHORT).show();"> 368                 Toast.makeText(requireContext(), getString(R.string.export_message_success), Toast.LENGTHðŸ”µ</abbr>
 369             } else {
<abbr title=" 370                 Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 370                 Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTHðŸ”µ</abbr>
 371             }
 372         } catch (Exception e) {
<abbr title=" 373             Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 373             Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHOðŸ”µ</abbr>
 374         }
 375     }
 376 
 377     private void updateAnalyticsSwitchState() {
 378         try {
 379             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 380             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 381         } catch (BucketObjectMissingException e) {
 382             // The preferences object doesn&#x27;t exist for this user yet, create it
 383             try {
 384                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 385                 prefs.setAnalyticsEnabled(true);
 386                 prefs.save();
 387             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 388                 bucketObjectNameInvalid.printStackTrace();
 389             }
 390         }
 391     }
 392 
 393     private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 394         private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 395 
 396         LogOutTask(PreferencesFragment fragment) {
 397             mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 398         }
 399 
 400         @Override
 401         protected Boolean doInBackground(Void... voids) {
 402             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 403             return (fragment == null) || fragment.hasUnsyncedNotes();
 404         }
 405 
 406         @Override
 407         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 408             final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 409             if (fragment == null) {
 410                 return;
 411             }
 412             // Safety first! Check if any notes are unsynced and warn the user if so.
 413             if (hasUnsyncedNotes) {
<abbr title=" 414                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog)).setTitle(R.string.unsynced_notes).setMessage(R.string.unsynced_notes_message).setPositiveButton(R.string.log_out_anyway, new DialogInterface.OnClickListener() {"> 414                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 415                     @Override
 416                     public void onClick(DialogInterface dialogInterface, int i) {
 417                         fragment.logOut();
 418                     }
<abbr title=" 419                 }).setNeutralButton(R.string.export_unsynced_notes, new DialogInterface.OnClickListener() {"> 419                 }).setNeutralButton(R.string.export_unsynced_notes, new DialogInterface.OnClickListener()ðŸ”µ</abbr>
 420                     @Override
 421                     public void onClick(DialogInterface dialogInterface, int i) {
 422                         Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 423                         intent.addCategory(Intent.CATEGORY_OPENABLE);
 424                         intent.setType(&quot;application/json&quot;);
 425                         intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));
 426                         fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 427                     }
 428                 }).setNegativeButton(R.string.cancel, null).show();
 429             } else {
 430                 fragment.logOut();
 431             }
 432         }
 433     }
 434 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.Fragment;
   5  import android.content.DialogInterface;
   6  import android.content.Intent;
   7  import android.content.SharedPreferences;
   8  import android.net.Uri;
   9  import android.os.AsyncTask;
  10  import android.os.Bundle;
  11  import android.os.ParcelFileDescriptor;
  12  import android.widget.Toast;
  13  
  14  import androidx.appcompat.app.AlertDialog;
  15  import androidx.appcompat.view.ContextThemeWrapper;

  16  import androidx.preference.ListPreference;
  17  import androidx.preference.Preference;
  18  import androidx.preference.PreferenceFragmentCompat;
  19  import androidx.preference.PreferenceManager;
  20  import androidx.preference.SwitchPreferenceCompat;
  21  
  22  import com.automattic.simplenote.analytics.AnalyticsTracker;
  23  import com.automattic.simplenote.models.Note;
  24  import com.automattic.simplenote.models.Preferences;


  25  import com.automattic.simplenote.utils.BrowserUtils;
  26  import com.automattic.simplenote.utils.CrashUtils;
  27  import com.automattic.simplenote.utils.HtmlCompat;
  28  import com.automattic.simplenote.utils.PrefUtils;
  29  import com.automattic.simplenote.utils.WidgetUtils;
  30  import com.simperium.Simperium;
  31  import com.simperium.client.Bucket;
  32  import com.simperium.client.BucketObjectMissingException;
  33  import com.simperium.client.BucketObjectNameInvalid;
  34  import com.simperium.client.User;
  35  
  36  import org.json.JSONArray;
  37  import org.json.JSONObject;
  38  import org.wordpress.passcodelock.AppLockManager;
  39  
  40  import java.io.FileOutputStream;
  41  import java.lang.ref.WeakReference;
  42  import java.util.Collections;
  43  import java.util.Comparator;
  44  import java.util.List;
  45  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +import static android.app.Activity.RESULT_OK;</span>
  47  import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  48  
  49  /**
  50   * A simple {@link Fragment} subclass.
  51   */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -        Simperium.OnUserCreatedListener {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -    private static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  55 +public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.OnUserCreatedListener {">  55 +public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +    public static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +</span>
  58      private static final int REQUEST_EXPORT_DATA = 9001;
  59      private static final int REQUEST_EXPORT_UNSYNCED = 9002;
  60  
  61      private Bucket&lt;Preferences&gt; mPreferencesBucket;
  62      private SwitchPreferenceCompat mAnalyticsSwitch;
  63  
  64      public PreferencesFragment() {
  65          // Required empty public constructor
  66      }
  67  
  68      @Override
  69      public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  70          addPreferencesFromResource(R.xml.preferences);
  71      }
  72  
  73      @Override
  74      public void onActivityCreated(Bundle savedInstanceState) {
  75          super.onActivityCreated(savedInstanceState);
  76  
  77          Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  78          Simplenote currentApp = (Simplenote) getActivity().getApplication();
  79          Simperium simperium = currentApp.getSimperium();
  80          simperium.setUserStatusChangeListener(this);
  81          simperium.setOnUserCreatedListener(this);
  82          mPreferencesBucket = currentApp.getPreferencesBucket();
  83          mPreferencesBucket.start();
  84  
  85          authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  86          if (simperium.needsAuthorization()) {
  87              authenticatePreference.setTitle(R.string.log_in);
  88          } else {
  89              authenticatePreference.setTitle(R.string.log_out);
  90          }
  91  
  92          authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
  93              @Override
  94              public boolean onPreferenceClick(Preference preference) {
  95                  if (!isAdded()) {
  96                      return false;
  97                  }
  98  
  99                  Simplenote currentApp = (Simplenote) getActivity().getApplication();
 100                  if (currentApp.getSimperium().needsAuthorization()) {
 101                      Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);
 102                      startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 103                  } else {
 104                      new LogOutTask(PreferencesFragment.this).execute();
 105                  }
 106                  return true;
 107              }
 108          });
 109  
<abbr title=" 110          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 110          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener()ðŸ”µ</abbr>
 111              @Override
 112              public boolean onPreferenceClick(Preference preference) {
 113                  try {
 114                      BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 115                  } catch (Exception e) {
 116                      Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();
 117                  }
 118                  return true;
 119              }
 120          });
 121  
 122          findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 123              @Override
 124              public boolean onPreferenceClick(Preference preference) {
 125                  startActivity(new Intent(getActivity(), AboutActivity.class));
 126                  return true;
 127              }
 128          });
 129  
<abbr title=" 130          findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 130          findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() ðŸ”µ</abbr>
 131              @Override
 132              public boolean onPreferenceClick(Preference preference) {
 133                  Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 134                  intent.addCategory(Intent.CATEGORY_OPENABLE);
 135                  intent.setType(&quot;application/json&quot;);
 136                  intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 137                  startActivityForResult(intent, REQUEST_EXPORT_DATA);
 138                  return true;
 139              }
 140          });
 141  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        final ListPreference themePreference = (ListPreference) findPreference(PrefUtils.PREF_THEME);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +        final ListPreference themePreference = findPreference(PrefUtils.PREF_THEME);</span>
 144          themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 145              @Override
 146              public boolean onPreferenceChange(Preference preference, Object newValue) {
 147                  updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 148                  return true;
 149              }
 150  
 151              private void updateTheme(Activity activity, int index) {
 152                  CharSequence[] entries = themePreference.getEntries();
 153                  themePreference.setSummary(entries[index]);
 154  
 155                  AnalyticsTracker.track(
 156                          AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 157                          AnalyticsTracker.CATEGORY_USER,
 158                          &quot;theme_preference&quot;
 159                  );
 160  
 161                  // recreate the activity so new theme is applied
 162                  activity.recreate();
 163              }
 164          });
 165  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -        final ListPreference sortPreference = (ListPreference) findPreference(PrefUtils.PREF_SORT_ORDER);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +        final Preference stylePreference = findPreference(&quot;pref_key_style&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +        stylePreference.setSummary(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +            PrefUtils.isPremium(requireContext()) ?</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +                PrefUtils.getStyleNameFromIndexSelected(requireContext()) :</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +                PrefUtils.getStyleNameDefault(requireContext())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +        );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +        stylePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +            public boolean onPreferenceClick(Preference preference) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +                startActivity(new Intent(requireContext(), StyleActivity.class));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +        final ListPreference sortPreference = findPreference(PrefUtils.PREF_SORT_ORDER);</span>
 182          sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 183              @Override
 184              public boolean onPreferenceChange(Preference preference, Object newValue) {
 185                  int index = Integer.parseInt(newValue.toString());
 186                  CharSequence[] entries = sortPreference.getEntries();
 187                  sortPreference.setSummary(entries[index]);
 188  
 189                  return true;
 190              }
 191          });
 192  
 193          Preference versionPref = findPreference(&quot;pref_key_build&quot;);
 194          versionPref.setSummary(PrefUtils.versionInfo());
 195  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 196 -        SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_note_list&quot;);"> 196 -        SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_noteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +        SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);</span>
 198          switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 199              @Override
 200              public boolean onPreferenceChange(Preference preference, Object o) {
 201                  if (((SwitchPreferenceCompat) preference).isChecked()) {
 202                      AnalyticsTracker.track(
 203                              AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 204                              AnalyticsTracker.CATEGORY_USER,
 205                              &quot;condensed_list_preference&quot;
 206                      );
 207                  }
 208  
 209                  return true;
 210              }
 211          });
 212  
 213          // Add the hyperlink to the analytics summary
 214          Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 215          String formattedSummary = String.format(
 216                  getString(R.string.share_analytics_summary),
 217                  &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 218                  &quot;&lt;/a&gt;&quot;
 219          );
 220          analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 221  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -        mAnalyticsSwitch = (SwitchPreferenceCompat)findPreference(&quot;pref_key_analytics_switch&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +        mAnalyticsSwitch = findPreference(&quot;pref_key_analytics_switch&quot;);</span>
 224          mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 225              @Override
 226              public boolean onPreferenceChange(Preference preference, Object newValue) {
 227                  try {
 228                      boolean isChecked = (boolean)newValue;
 229                      Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 230                      prefs.setAnalyticsEnabled(isChecked);
 231                      prefs.save();
 232                  } catch (BucketObjectMissingException e) {
 233                      e.printStackTrace();
 234                  }
 235  
 236                  return true;
 237              }
 238          });
 239  
 240          updateAnalyticsSwitchState();













 241      }
 242  
 243      @Override
 244      public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -        if (resultCode != Activity.RESULT_OK || resultData == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +        if (resultCode != RESULT_OK || resultData == null) {</span>
 247              return;
 248          }
 249  
 250          if (resultData.getData() == null) {
<abbr title=" 251              Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 251              Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show(ðŸ”µ</abbr>
 252              return;
 253          }
 254  
 255          switch (requestCode) {
 256              case REQUEST_EXPORT_DATA:
 257                  exportData(resultData.getData(), false);
 258                  break;
 259              case REQUEST_EXPORT_UNSYNCED:
 260                  exportData(resultData.getData(), true);
 261                  break;
 262          }
 263      }
 264  
 265      @Override
 266      public void onPause() {
 267          super.onPause();
 268          mPreferencesBucket.stop();
 269      }
 270  
 271      private boolean hasUnsyncedNotes() {
 272          Simplenote application = (Simplenote) getActivity().getApplication();
 273          Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 274          Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 275          while (notesCursor.moveToNext()) {
 276              Note note = notesCursor.getObject();
 277              if (note.isNew() || note.isModified()) {
 278                  return true;
 279              }
 280          }
 281  
 282          return false;
 283      }
 284  
 285      private void logOut() {
 286          Simplenote application = (Simplenote) getActivity().getApplication();
 287          application.getSimperium().deauthorizeUser();
 288  
 289          application.getNotesBucket().reset();
 290          application.getTagsBucket().reset();
 291          application.getPreferencesBucket().reset();
 292  
 293          application.getNotesBucket().stop();

 294          application.getTagsBucket().stop();

 295          application.getPreferencesBucket().stop();
 296  
 297          AnalyticsTracker.track(
 298                  AnalyticsTracker.Stat.USER_SIGNED_OUT,
 299                  AnalyticsTracker.CATEGORY_USER,
 300                  &quot;preferences_sign_out_button&quot;
 301          );
 302  
 303          // Resets analytics user back to &#x27;anon&#x27; type
 304          AnalyticsTracker.refreshMetadata(null);
 305          CrashUtils.clearCurrentUser();
 306  
 307          // Remove wp.com token
 308          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();
 309          editor.remove(PrefUtils.PREF_WP_TOKEN);
 310  
 311          // Remove WordPress sites
 312          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 313          editor.apply();
 314  
 315          // Remove Passcode Lock password
 316          AppLockManager.getInstance().getAppLock().setPassword(&quot;&quot;);
 317  
 318          WidgetUtils.updateNoteWidgets(requireActivity().getApplicationContext());
 319  
 320          getActivity().finish();
 321      }
 322  
 323      @Override
 324      public void onUserStatusChange(User.Status status) {
 325          if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 326              // User signed in
 327              getActivity().runOnUiThread(new Runnable() {
 328                  public void run() {
 329                      Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 330                      authenticatePreference.setTitle(R.string.log_out);
 331                  }
 332              });
 333  
 334              Simplenote app = (Simplenote) getActivity().getApplication();
 335              AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 336              CrashUtils.setCurrentUser(app.getSimperium().getUser());
 337  
 338              AnalyticsTracker.track(
 339                      AnalyticsTracker.Stat.USER_SIGNED_IN,
 340                      AnalyticsTracker.CATEGORY_USER,
 341                      &quot;signed_in_from_preferences_activity&quot;
 342              );
 343          }
 344      }
 345  
 346      @Override
 347      public void onUserCreated(User user) {
 348          AnalyticsTracker.track(
 349                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 350                  AnalyticsTracker.CATEGORY_USER,
 351                  &quot;account_created_from_preferences_activity&quot;
 352          );
 353      }
 354  
 355      private void exportData(Uri uri, boolean isUnsyncedNotes) {
 356          Simplenote currentApp = (Simplenote) requireActivity().getApplication();
 357          Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 358          JSONObject account = new JSONObject();
 359          Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 360  
 361          try {
 362              JSONArray activeNotes = new JSONArray();
 363              JSONArray trashedNotes = new JSONArray();
 364              Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 365                  @Override
 366                  public int compare(String text1, String text2) {
 367                      return text1.compareToIgnoreCase(text2);
 368                  }
 369              };
 370  
 371              while (cursor.moveToNext()) {
 372                  Note note = cursor.getObject();
 373  
 374                  if (isUnsyncedNotes &amp;&amp; !note.isNew() &amp;&amp; !note.isModified()) {
 375                      continue;
 376                  }
 377  
 378                  JSONObject noteJson = new JSONObject();
 379  
 380                  noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 381                  noteJson.put(&quot;content&quot;, note.getContent());
 382                  noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 383                  noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 384  
 385                  if (note.isPinned()) {
 386                      noteJson.put(&quot;pinned&quot;, note.isPinned());
 387                  }
 388  
 389                  if (note.isMarkdownEnabled()) {
 390                      noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 391                  }
 392  
 393                  if (note.getTags().size() &gt; 0) {
 394                      List&lt;String&gt; tags = note.getTags();
 395                      Collections.sort(tags, comparator);
 396                      noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 397                  }
 398  
 399                  if (!note.getPublishedUrl().isEmpty()) {
 400                      noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 401                  }
 402  
 403                  if (note.isDeleted()) {
 404                      trashedNotes.put(noteJson);
 405                  } else {
 406                      activeNotes.put(noteJson);
 407                  }
 408              }
 409  
 410              account.put(&quot;activeNotes&quot;, activeNotes);
 411              account.put(&quot;trashedNotes&quot;, trashedNotes);
 412  
<abbr title=" 413              ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 413              ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uðŸ”µ</abbr>
 414  
 415              if (parcelFileDescriptor != null) {
<abbr title=" 416                  FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 416                  FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor())ðŸ”µ</abbr>
 417                  fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;,&quot;/&quot;).getBytes());
 418                  parcelFileDescriptor.close();
<abbr title=" 419                  Toast.makeText(requireContext(), getString(R.string.export_message_success), Toast.LENGTH_SHORT).show();"> 419                  Toast.makeText(requireContext(), getString(R.string.export_message_success), Toast.LENGTH_SHORT).sðŸ”µ</abbr>
 420              } else {
<abbr title=" 421                  Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 421                  Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).sðŸ”µ</abbr>
 422              }
 423          } catch (Exception e) {
<abbr title=" 424              Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 424              Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show(ðŸ”µ</abbr>
 425          }
 426      }
 427  
 428      private void updateAnalyticsSwitchState() {
 429          try {
 430              Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 431              mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 432          } catch (BucketObjectMissingException e) {
 433              // The preferences object doesn&#x27;t exist for this user yet, create it
 434              try {
 435                  Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 436                  prefs.setAnalyticsEnabled(true);
 437                  prefs.save();
 438              } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 439                  bucketObjectNameInvalid.printStackTrace();
 440              }
 441          }
 442      }
 443  
 444      private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 445          private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 446  
 447          LogOutTask(PreferencesFragment fragment) {
 448              mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 449          }
 450  
 451          @Override
 452          protected Boolean doInBackground(Void... voids) {
 453              PreferencesFragment fragment = mPreferencesFragmentReference.get();
 454              return fragment == null || fragment.hasUnsyncedNotes();
 455          }
 456  
 457          @Override
 458          protected void onPostExecute(Boolean hasUnsyncedNotes) {
 459              final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 460  
 461              if (fragment == null) {
 462                  return;
 463              }
 464  
 465              // Safety first! Check if any notes are unsynced and warn the user if so.
 466              if (hasUnsyncedNotes) {
 467                  new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))
 468                      .setTitle(R.string.unsynced_notes)
 469                      .setMessage(R.string.unsynced_notes_message)
 470                      .setPositiveButton(R.string.log_out_anyway,
 471                          new DialogInterface.OnClickListener() {
 472                              @Override
 473                              public void onClick(DialogInterface dialogInterface, int i) {
 474                                  fragment.logOut();
 475                              }
 476                          }
 477                      )
 478                      .setNeutralButton(R.string.export_unsynced_notes,
 479                          new DialogInterface.OnClickListener() {
 480                              @Override
 481                              public void onClick(DialogInterface dialogInterface, int i) {
 482                                  Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 483                                  intent.addCategory(Intent.CATEGORY_OPENABLE);
 484                                  intent.setType(&quot;application/json&quot;);
 485                                  intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));
 486                                  fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 487                              }
 488                          }
 489                      )
 490                      .setNegativeButton(R.string.cancel, null)
 491                      .show();
 492              } else {
 493                  fragment.logOut();
 494              }
 495          }
 496      }
 497  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.Fragment;
   5  import android.content.DialogInterface;
   6  import android.content.Intent;
   7  import android.content.SharedPreferences;
   8  import android.net.Uri;
   9  import android.os.AsyncTask;
  10  import android.os.Bundle;
  11  import android.os.ParcelFileDescriptor;
  12  import android.widget.Toast;
  13  
  14  import androidx.appcompat.app.AlertDialog;
  15  import androidx.appcompat.view.ContextThemeWrapper;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 +import androidx.core.app.ShareCompat;</span>
  17  import androidx.preference.ListPreference;
  18  import androidx.preference.Preference;
  19  import androidx.preference.PreferenceFragmentCompat;
  20  import androidx.preference.PreferenceManager;
  21  import androidx.preference.SwitchPreferenceCompat;
  22  
  23  import com.automattic.simplenote.analytics.AnalyticsTracker;
  24  import com.automattic.simplenote.models.Note;
  25  import com.automattic.simplenote.models.Preferences;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import com.automattic.simplenote.utils.AppLog;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import com.automattic.simplenote.utils.AppLog.Type;</span>
  28  import com.automattic.simplenote.utils.BrowserUtils;
  29  import com.automattic.simplenote.utils.CrashUtils;
  30  import com.automattic.simplenote.utils.HtmlCompat;
  31  import com.automattic.simplenote.utils.PrefUtils;
  32  import com.automattic.simplenote.utils.WidgetUtils;
  33  import com.simperium.Simperium;
  34  import com.simperium.client.Bucket;
  35  import com.simperium.client.BucketObjectMissingException;
  36  import com.simperium.client.BucketObjectNameInvalid;
  37  import com.simperium.client.User;
  38  
  39  import org.json.JSONArray;
  40  import org.json.JSONObject;
  41  import org.wordpress.passcodelock.AppLockManager;
  42  
  43  import java.io.FileOutputStream;
  44  import java.lang.ref.WeakReference;
  45  import java.util.Collections;
  46  import java.util.Comparator;
  47  import java.util.List;
  48  

  49  import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  50  
  51  /**
  52   * A simple {@link Fragment} subclass.
  53   */
  54  public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener,
  55          Simperium.OnUserCreatedListener {
  56      private static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;



  57      private static final int REQUEST_EXPORT_DATA = 9001;
  58      private static final int REQUEST_EXPORT_UNSYNCED = 9002;
  59  
  60      private Bucket&lt;Preferences&gt; mPreferencesBucket;
  61      private SwitchPreferenceCompat mAnalyticsSwitch;
  62  
  63      public PreferencesFragment() {
  64          // Required empty public constructor
  65      }
  66  
  67      @Override
  68      public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  69          addPreferencesFromResource(R.xml.preferences);
  70      }
  71  
  72      @Override
  73      public void onActivityCreated(Bundle savedInstanceState) {
  74          super.onActivityCreated(savedInstanceState);
  75  
  76          Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  77          Simplenote currentApp = (Simplenote) getActivity().getApplication();
  78          Simperium simperium = currentApp.getSimperium();
  79          simperium.setUserStatusChangeListener(this);
  80          simperium.setOnUserCreatedListener(this);
  81          mPreferencesBucket = currentApp.getPreferencesBucket();
  82          mPreferencesBucket.start();
  83  
  84          authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  85          if (simperium.needsAuthorization()) {
  86              authenticatePreference.setTitle(R.string.log_in);
  87          } else {
  88              authenticatePreference.setTitle(R.string.log_out);
  89          }
  90  
  91          authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
  92              @Override
  93              public boolean onPreferenceClick(Preference preference) {
  94                  if (!isAdded()) {
  95                      return false;
  96                  }
  97  
  98                  Simplenote currentApp = (Simplenote) getActivity().getApplication();
  99                  if (currentApp.getSimperium().needsAuthorization()) {
 100                      Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);
 101                      startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 102                  } else {
 103                      new LogOutTask(PreferencesFragment.this).execute();
 104                  }
 105                  return true;
 106              }
 107          });
 108  
<abbr title=" 109          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 109          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener()ðŸ”µ</abbr>
 110              @Override
 111              public boolean onPreferenceClick(Preference preference) {
 112                  try {
 113                      BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 114                  } catch (Exception e) {
 115                      Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();
 116                  }
 117                  return true;
 118              }
 119          });
 120  
 121          findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 122              @Override
 123              public boolean onPreferenceClick(Preference preference) {
 124                  startActivity(new Intent(getActivity(), AboutActivity.class));
 125                  return true;
 126              }
 127          });
 128  
<abbr title=" 129          findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 129          findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() ðŸ”µ</abbr>
 130              @Override
 131              public boolean onPreferenceClick(Preference preference) {
 132                  Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 133                  intent.addCategory(Intent.CATEGORY_OPENABLE);
 134                  intent.setType(&quot;application/json&quot;);
 135                  intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 136                  startActivityForResult(intent, REQUEST_EXPORT_DATA);
 137                  return true;
 138              }
 139          });
 140  
 141          final ListPreference themePreference = (ListPreference) findPreference(PrefUtils.PREF_THEME);

 142          themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 143              @Override
 144              public boolean onPreferenceChange(Preference preference, Object newValue) {
 145                  updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 146                  return true;
 147              }
 148  
 149              private void updateTheme(Activity activity, int index) {
 150                  CharSequence[] entries = themePreference.getEntries();
 151                  themePreference.setSummary(entries[index]);
 152  
 153                  AnalyticsTracker.track(
 154                          AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 155                          AnalyticsTracker.CATEGORY_USER,
 156                          &quot;theme_preference&quot;
 157                  );
 158  
 159                  // recreate the activity so new theme is applied
 160                  activity.recreate();
 161              }
 162          });
 163  
 164          final ListPreference sortPreference = (ListPreference) findPreference(PrefUtils.PREF_SORT_ORDER);















 165          sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 166              @Override
 167              public boolean onPreferenceChange(Preference preference, Object newValue) {
 168                  int index = Integer.parseInt(newValue.toString());
 169                  CharSequence[] entries = sortPreference.getEntries();
 170                  sortPreference.setSummary(entries[index]);
 171  
 172                  return true;
 173              }
 174          });
 175  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -        Preference versionPref = findPreference(&quot;pref_key_build&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -        versionPref.setSummary(PrefUtils.versionInfo());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 179 -        SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_note_list&quot;);"> 179 -        SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_noteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +        SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);</span>
 181          switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 182              @Override
 183              public boolean onPreferenceChange(Preference preference, Object o) {
 184                  if (((SwitchPreferenceCompat) preference).isChecked()) {
 185                      AnalyticsTracker.track(
 186                              AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 187                              AnalyticsTracker.CATEGORY_USER,
 188                              &quot;condensed_list_preference&quot;
 189                      );
 190                  }
 191  
 192                  return true;
 193              }
 194          });
 195  
 196          // Add the hyperlink to the analytics summary
 197          Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 198          String formattedSummary = String.format(
 199                  getString(R.string.share_analytics_summary),
 200                  &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 201                  &quot;&lt;/a&gt;&quot;
 202          );
 203          analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 204  
 205          mAnalyticsSwitch = (SwitchPreferenceCompat)findPreference(&quot;pref_key_analytics_switch&quot;);

 206          mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 207              @Override
 208              public boolean onPreferenceChange(Preference preference, Object newValue) {
 209                  try {
 210                      boolean isChecked = (boolean)newValue;
 211                      Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 212                      prefs.setAnalyticsEnabled(isChecked);
 213                      prefs.save();
 214                  } catch (BucketObjectMissingException e) {
 215                      e.printStackTrace();
 216                  }
 217  
 218                  return true;
 219              }
 220          });
 221  
 222          updateAnalyticsSwitchState();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +        findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +            public boolean onPreferenceClick(Preference preference) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +                startActivity(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +                    ShareCompat.IntentBuilder.from(requireActivity())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +                        .setText(AppLog.get())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +                        .setType(&quot;text/plain&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +                        .createChooserIntent()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +                );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +        });</span>
 236      }
 237  
 238      @Override
 239      public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 240          if (resultCode != Activity.RESULT_OK || resultData == null) {

 241              return;
 242          }
 243  
 244          if (resultData.getData() == null) {
<abbr title=" 245              Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 245              Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show(ðŸ”µ</abbr>
 246              return;
 247          }
 248  
 249          switch (requestCode) {
 250              case REQUEST_EXPORT_DATA:
 251                  exportData(resultData.getData(), false);
 252                  break;
 253              case REQUEST_EXPORT_UNSYNCED:
 254                  exportData(resultData.getData(), true);
 255                  break;
 256          }
 257      }
 258  
 259      @Override
 260      public void onPause() {
 261          super.onPause();
 262          mPreferencesBucket.stop();
 263      }
 264  
 265      private boolean hasUnsyncedNotes() {
 266          Simplenote application = (Simplenote) getActivity().getApplication();
 267          Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 268          Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 269          while (notesCursor.moveToNext()) {
 270              Note note = notesCursor.getObject();
 271              if (note.isNew() || note.isModified()) {
 272                  return true;
 273              }
 274          }
 275  
 276          return false;
 277      }
 278  
 279      private void logOut() {
 280          Simplenote application = (Simplenote) getActivity().getApplication();
 281          application.getSimperium().deauthorizeUser();
 282  
 283          application.getNotesBucket().reset();
 284          application.getTagsBucket().reset();
 285          application.getPreferencesBucket().reset();
 286  
 287          application.getNotesBucket().stop();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +        AppLog.add(Type.SYNC, &quot;Stopped note bucket (PreferencesFragment)&quot;);</span>
 289          application.getTagsBucket().stop();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +        AppLog.add(Type.SYNC, &quot;Stopped tag bucket (PreferencesFragment)&quot;);</span>
 291          application.getPreferencesBucket().stop();
 292  
 293          AnalyticsTracker.track(
 294                  AnalyticsTracker.Stat.USER_SIGNED_OUT,
 295                  AnalyticsTracker.CATEGORY_USER,
 296                  &quot;preferences_sign_out_button&quot;
 297          );
 298  
 299          // Resets analytics user back to &#x27;anon&#x27; type
 300          AnalyticsTracker.refreshMetadata(null);
 301          CrashUtils.clearCurrentUser();
 302  
 303          // Remove wp.com token
 304          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();
 305          editor.remove(PrefUtils.PREF_WP_TOKEN);
 306  
 307          // Remove WordPress sites
 308          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 309          editor.apply();
 310  
 311          // Remove Passcode Lock password
 312          AppLockManager.getInstance().getAppLock().setPassword(&quot;&quot;);
 313  
 314          WidgetUtils.updateNoteWidgets(requireActivity().getApplicationContext());
 315  
 316          getActivity().finish();
 317      }
 318  
 319      @Override
 320      public void onUserStatusChange(User.Status status) {
 321          if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 322              // User signed in
 323              getActivity().runOnUiThread(new Runnable() {
 324                  public void run() {
 325                      Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 326                      authenticatePreference.setTitle(R.string.log_out);
 327                  }
 328              });
 329  
 330              Simplenote app = (Simplenote) getActivity().getApplication();
 331              AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 332              CrashUtils.setCurrentUser(app.getSimperium().getUser());
 333  
 334              AnalyticsTracker.track(
 335                      AnalyticsTracker.Stat.USER_SIGNED_IN,
 336                      AnalyticsTracker.CATEGORY_USER,
 337                      &quot;signed_in_from_preferences_activity&quot;
 338              );
 339          }
 340      }
 341  
 342      @Override
 343      public void onUserCreated(User user) {
 344          AnalyticsTracker.track(
 345                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 346                  AnalyticsTracker.CATEGORY_USER,
 347                  &quot;account_created_from_preferences_activity&quot;
 348          );
 349      }
 350  
 351      private void exportData(Uri uri, boolean isUnsyncedNotes) {
 352          Simplenote currentApp = (Simplenote) requireActivity().getApplication();
 353          Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 354          JSONObject account = new JSONObject();
 355          Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 356  
 357          try {
 358              JSONArray activeNotes = new JSONArray();
 359              JSONArray trashedNotes = new JSONArray();
 360              Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 361                  @Override
 362                  public int compare(String text1, String text2) {
 363                      return text1.compareToIgnoreCase(text2);
 364                  }
 365              };
 366  
 367              while (cursor.moveToNext()) {
 368                  Note note = cursor.getObject();
 369  
 370                  if (isUnsyncedNotes &amp;&amp; !note.isNew() &amp;&amp; !note.isModified()) {
 371                      continue;
 372                  }
 373  
 374                  JSONObject noteJson = new JSONObject();
 375  
 376                  noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 377                  noteJson.put(&quot;content&quot;, note.getContent());
 378                  noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 379                  noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 380  
 381                  if (note.isPinned()) {
 382                      noteJson.put(&quot;pinned&quot;, note.isPinned());
 383                  }
 384  
 385                  if (note.isMarkdownEnabled()) {
 386                      noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 387                  }
 388  
 389                  if (note.getTags().size() &gt; 0) {
 390                      List&lt;String&gt; tags = note.getTags();
 391                      Collections.sort(tags, comparator);
 392                      noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 393                  }
 394  
 395                  if (!note.getPublishedUrl().isEmpty()) {
 396                      noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 397                  }
 398  
 399                  if (note.isDeleted()) {
 400                      trashedNotes.put(noteJson);
 401                  } else {
 402                      activeNotes.put(noteJson);
 403                  }
 404              }
 405  
 406              account.put(&quot;activeNotes&quot;, activeNotes);
 407              account.put(&quot;trashedNotes&quot;, trashedNotes);
 408  
<abbr title=" 409              ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 409              ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uðŸ”µ</abbr>
 410  
 411              if (parcelFileDescriptor != null) {
<abbr title=" 412                  FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 412                  FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor())ðŸ”µ</abbr>
 413                  fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;,&quot;/&quot;).getBytes());
 414                  parcelFileDescriptor.close();
<abbr title=" 415                  Toast.makeText(requireContext(), getString(R.string.export_message_success), Toast.LENGTH_SHORT).show();"> 415                  Toast.makeText(requireContext(), getString(R.string.export_message_success), Toast.LENGTH_SHORT).sðŸ”µ</abbr>
 416              } else {
<abbr title=" 417                  Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 417                  Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).sðŸ”µ</abbr>
 418              }
 419          } catch (Exception e) {
<abbr title=" 420              Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 420              Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show(ðŸ”µ</abbr>
 421          }
 422      }
 423  
 424      private void updateAnalyticsSwitchState() {
 425          try {
 426              Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 427              mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 428          } catch (BucketObjectMissingException e) {
 429              // The preferences object doesn&#x27;t exist for this user yet, create it
 430              try {
 431                  Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 432                  prefs.setAnalyticsEnabled(true);
 433                  prefs.save();
 434              } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 435                  bucketObjectNameInvalid.printStackTrace();
 436              }
 437          }
 438      }
 439  
 440      private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 441          private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 442  
 443          LogOutTask(PreferencesFragment fragment) {
 444              mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 445          }
 446  
 447          @Override
 448          protected Boolean doInBackground(Void... voids) {
 449              PreferencesFragment fragment = mPreferencesFragmentReference.get();
 450              return fragment == null || fragment.hasUnsyncedNotes();
 451          }
 452  
 453          @Override
 454          protected void onPostExecute(Boolean hasUnsyncedNotes) {
 455              final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 456  
 457              if (fragment == null) {
 458                  return;
 459              }
 460  
 461              // Safety first! Check if any notes are unsynced and warn the user if so.
 462              if (hasUnsyncedNotes) {
 463                  new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))
 464                      .setTitle(R.string.unsynced_notes)
 465                      .setMessage(R.string.unsynced_notes_message)
 466                      .setPositiveButton(R.string.log_out_anyway,
 467                          new DialogInterface.OnClickListener() {
 468                              @Override
 469                              public void onClick(DialogInterface dialogInterface, int i) {
 470                                  fragment.logOut();
 471                              }
 472                          }
 473                      )
 474                      .setNeutralButton(R.string.export_unsynced_notes,
 475                          new DialogInterface.OnClickListener() {
 476                              @Override
 477                              public void onClick(DialogInterface dialogInterface, int i) {
 478                                  Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 479                                  intent.addCategory(Intent.CATEGORY_OPENABLE);
 480                                  intent.setType(&quot;application/json&quot;);
 481                                  intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));
 482                                  fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 483                              }
 484                          }
 485                      )
 486                      .setNegativeButton(R.string.cancel, null)
 487                      .show();
 488              } else {
 489                  fragment.logOut();
 490              }
 491          }
 492      }
 493  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            