<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>151</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    151
                    <a href="150.html">prev</a>
                    <a href="152.html">next</a>
                    <a href="151_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_c1628ae4ae2b997b9894dbff28542a206be59668_core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c1628ae4ae2b997b9894dbff28542a206be59668:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c1628ae4ae2b997b9894dbff28542a206be59668^1:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c1628ae4ae2b997b9894dbff28542a206be59668^2:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;8190d758e3d29bd0889f0df84843dbf3af909030:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [sbj]], subset: [[b], [sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.controller.checkout;
  19 
  20 import org.apache.commons.logging.Log;
  21 import org.apache.commons.logging.LogFactory;
  22 import org.broadleafcommerce.common.exception.ServiceException;
  23 import org.broadleafcommerce.common.payment.PaymentGatewayType;
  24 import org.broadleafcommerce.common.payment.PaymentTransactionType;
  25 import org.broadleafcommerce.common.payment.PaymentType;
  26 import org.broadleafcommerce.common.vendor.service.exception.PaymentException;
  27 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  28 import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;
  29 import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;
  30 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import org.broadleafcommerce.core.offer.service.exception.OfferExpiredException;</span>
  33 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.broadleafcommerce.core.order.domain.NullOrderImpl;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.broadleafcommerce.core.order.domain.Order;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;</span>
  37 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import org.broadleafcommerce.core.offer.service.exception.OfferMaxUseExceededException;</span>
  39 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  40 import org.broadleafcommerce.core.order.domain.NullOrderImpl;
  41 import org.broadleafcommerce.core.order.domain.Order;
  42 import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;
  43 import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  44 import org.broadleafcommerce.core.payment.domain.OrderPayment;
  45 import org.broadleafcommerce.core.payment.domain.PaymentTransaction;
  46 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  47 import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;
  48 import org.broadleafcommerce.core.web.order.CartState;
  49 import org.broadleafcommerce.profile.web.core.CustomerState;
  50 import org.springframework.ui.Model;
  51 import org.springframework.validation.BindingResult;
  52 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  53 
  54 import java.util.ArrayList;
  55 import java.util.List;
  56 
  57 import javax.servlet.http.HttpServletRequest;
  58 import javax.servlet.http.HttpServletResponse;
  59 
  60 /**
  61  * In charge of performing the various checkout operations
  62  * 
  63  * @author Andre Azzolini (apazzolini)
  64  * @author Elbert Bautista (elbertbautista)
  65  * @author Joshua Skorton (jskorton)
  66  */
  67 public class BroadleafCheckoutController extends AbstractCheckoutController {
  68 
  69     private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);
  70     protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;
  71 
  72     /**
  73      * Renders the default checkout page and allows modules to add variables to the model.
  74      *
  75      * @param request
  76      * @param response
  77      * @param model
  78      * @param model
  79      * @return the checkout view path
  80      */
  81     public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,
  82             RedirectAttributes redirectAttributes) {
  83         preValidateCartOperation(model);
  84         populateModelWithReferenceData(request, model);
  85 
  86         return getCheckoutView();
  87     }
  88 
  89     protected void preValidateCartOperation(Model model) {
  90         try {
  91             Order cart = CartState.getCart();
  92             orderService.preValidateCartOperation(cart);
  93         } catch (IllegalCartOperationException ex) {
  94             model.addAttribute(&quot;cartRequiresLock&quot;, true);
  95         }
  96     }
  97 
  98     /**
  99      * Renders checkout stages partial at the requested stage
 100      *
 101      * @param request
 102      * @param response
 103      * @param model
 104      * @param stage
 105      * @return the checkout stages partial path
 106      */
<abbr title=" 107     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,"> 107     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, ModelðŸ”µ</abbr>
 108             String stage, RedirectAttributes redirectAttributes) {
 109         model.addAttribute(ACTIVE_STAGE, stage);
 110         return getCheckoutStagesPartial();
 111     }
 112 
 113     /**
 114      * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously
 115      * @param request
 116      * @param model
 117      * @param orderInfoForm
 118      * @param result
 119      * @return
 120      * @throws ServiceException
 121      */
 122     public String saveGlobalOrderDetails(HttpServletRequest request, Model model, 
 123             OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {
 124         Order cart = CartState.getCart();
 125 
 126         orderInfoFormValidator.validate(orderInfoForm, result);
 127         if (result.hasErrors()) {
 128             // We need to clear the email on error in case they are trying to edit it
 129             try {
 130                 cart.setEmailAddress(null);
 131                 orderService.save(cart, false);
 132             } catch (PricingException pe) {
 133                 LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 134             }
 135             
 136             populateModelWithReferenceData(request, model);
 137             return getCheckoutView();
 138         }
 139         
 140         try {
 141             cart.setEmailAddress(orderInfoForm.getEmailAddress());
 142             orderService.save(cart, false);
 143         } catch (PricingException pe) {
 144             LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 145         }
 146         
 147         return getCheckoutPageRedirect();   
 148     }
 149 
 150     /**
 151      * Creates a pass-through payment of the PaymentType passed in with
 152      * an amount equal to the order total after any non-final applied payments.
 153      * (for example gift cards, customer credit, or third party accounts)
 154      *
 155      * This intended to be used in cases like COD and other Payment Types where implementations wish
 156      * to just checkout without having to do any payment processing.
 157      *
 158      * This default implementations assumes that the pass-through payment is the only
 159      * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED
<abbr title=" 160      * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 160      * That means that it will look at all transactions on the order payment and see if it has unconfirmeðŸ”µ</abbr>
 161      * If it does, it will not remove it.
 162      *
 163      * Make sure not to expose this method in your extended Controller if you do not wish to
 164      * have this feature enabled.
 165      *
 166      * @param redirectAttributes
 167      * @param paymentType
 168      * @return
 169      * @throws PaymentException
 170      * @throws PricingException
 171      */
 172     public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,
<abbr title=" 173                                              PaymentType paymentType) throws PaymentException, PricingException {"> 173                                              PaymentType paymentType) throws PaymentException, PricingExcðŸ”µ</abbr>
 174         Order cart = CartState.getCart();
 175 
<abbr title=" 176         //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED"> 176         //Invalidate any payments already on the order that do not have transactions on them that are UNCðŸ”µ</abbr>
 177         List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();
 178         for (OrderPayment payment : cart.getPayments()) {
 179             if (payment.isActive()) {
 180                 if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {
 181                     paymentsToInvalidate.add(payment);
 182                 } else {
 183                     for (PaymentTransaction transaction : payment.getTransactions()) {
 184                         if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {
 185                              paymentsToInvalidate.add(payment);
 186                         }
 187                     }
 188                 }
 189             }
 190         }
 191 
 192         for (OrderPayment payment : paymentsToInvalidate) {
 193             cart.getPayments().remove(payment);
 194             if (paymentGatewayCheckoutService != null) {
 195                 paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());
 196             }
 197         }
 198 
 199         //Create a new Order Payment of the passed in type
 200         OrderPayment passthroughPayment = orderPaymentService.create();
 201         passthroughPayment.setType(paymentType);
 202         passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);
 203         passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());
 204         passthroughPayment.setOrder(cart);
 205 
 206         // Create the transaction for the payment
 207         PaymentTransaction transaction = orderPaymentService.createTransaction();
 208         transaction.setAmount(cart.getTotalAfterAppliedPayments());
 209         transaction.setRawResponse(&quot;Passthrough Payment&quot;);
 210         transaction.setSuccess(true);
 211         transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);
<abbr title=" 212         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 212         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymeðŸ”µ</abbr>
 213 
 214         transaction.setOrderPayment(passthroughPayment);
 215         passthroughPayment.addTransaction(transaction);
 216         orderService.addPaymentToOrder(cart, passthroughPayment, null);
 217 
 218         orderService.save(cart, true);
 219 
 220         return processCompleteCheckoutOrderFinalized(redirectAttributes);
 221     }
 222 
 223     /**
 224      * If the order has been finalized. i.e. all the payments have been applied to the order,
 225      * then you can go ahead and call checkout using the passed in order id.
<abbr title=" 226      * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 226      * This is usually called from a Review Page or if enough Payments have been applied to the Order to ðŸ”µ</abbr>
<abbr title=" 227      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or"> 227      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway,ðŸ”µ</abbr>
<abbr title=" 228      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)"> 228      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express CheckoutðŸ”µ</abbr>
 229      *
 230      * @return
 231      * @throws Exception
 232      */
<abbr title=" 233     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 233     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throðŸ”µ</abbr>
 234         Order cart = CartState.getCart();
 235         String param = &quot;&quot;;
 236         if (cart != null &amp;&amp; !(cart instanceof NullOrderImpl)) {
 237             try {
<abbr title=" 238                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OfferServiceImpl.OFFERS_EXPIRED);"> 238                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties()ðŸ”µ</abbr>
 239                 if(o!=null &amp;&amp; (Boolean) o){
<abbr title=" 240                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was re-calculated, check order total and try again&quot;);"> 240                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order pðŸ”µ</abbr>
 241                 }
 242                 String orderNumber = initiateCheckout(cart.getId());
 243                 return getConfirmationViewRedirect(orderNumber);
 244             } catch (Exception e) {
 245                 handleProcessingException(e, redirectAttributes);
 246                 if(CustomerState.getCustomer().isAnonymous()){
 247                     param=&quot;?guest-checkout=true&quot;;
 248                 }
 249             }
 250         }
 251 
 252         return getCheckoutPageRedirect()+param;
 253     }
 254 
 255     public String initiateCheckout(Long orderId) throws Exception{
 256         if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {
 257             return paymentGatewayCheckoutService.initiateCheckout(orderId);
 258         }
 259         return null;
 260     }
 261 
<abbr title=" 262     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 262     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymðŸ”µ</abbr>
<abbr title=" 263         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 263         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect AttribuðŸ”µ</abbr>
 264 
 265         Throwable cause = e.getCause();
 266 
 267         if (cause!= null &amp;&amp; cause.getCause() instanceof RequiredAttributeNotProvidedException) {
 268             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 269                     PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());
 270 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 271         }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredException) {"> 271         }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferEðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 272             String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMessage();"> 272             String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 274                     message);</span>
 275 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277     public String getBaseConfirmationRedirect() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278         return baseConfirmationRedirect;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281     protected String getConfirmationViewRedirect(String orderNumber) {</span>
 282 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283         } else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferMaxUseExceededException) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285                     &quot;There was an error during checkout:&quot;+cause.getCause().getMessage());</span>
 286 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 287         } else {
 288             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 289                     PaymentGatewayAbstractController.getProcessingErrorMessage());
 290         }
 291     }
 292 
 293     public String getBaseConfirmationRedirect() {
 294         return baseConfirmationRedirect;
 295     }
 296 
 297     protected String getConfirmationViewRedirect(String orderNumber) {
 298         return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;
 299     }
 300 
 301 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.controller.checkout;
  19 
  20 import org.apache.commons.logging.Log;
  21 import org.apache.commons.logging.LogFactory;
  22 import org.broadleafcommerce.common.exception.ServiceException;
  23 import org.broadleafcommerce.common.payment.PaymentGatewayType;
  24 import org.broadleafcommerce.common.payment.PaymentTransactionType;
  25 import org.broadleafcommerce.common.payment.PaymentType;
  26 import org.broadleafcommerce.common.vendor.service.exception.PaymentException;
  27 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  28 import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;
  29 import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;
  30 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  31 import org.broadleafcommerce.core.offer.service.exception.OfferExpiredException;
  32 import org.broadleafcommerce.core.offer.service.exception.OfferMaxUseExceededException;
  33 import org.broadleafcommerce.core.order.domain.NullOrderImpl;
  34 import org.broadleafcommerce.core.order.domain.Order;
  35 import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;
  36 import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  37 import org.broadleafcommerce.core.payment.domain.OrderPayment;
  38 import org.broadleafcommerce.core.payment.domain.PaymentTransaction;
  39 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  40 import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;
  41 import org.broadleafcommerce.core.web.order.CartState;
  42 import org.broadleafcommerce.profile.web.core.CustomerState;
  43 import org.springframework.ui.Model;
  44 import org.springframework.validation.BindingResult;
  45 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  46 
  47 import java.util.ArrayList;
  48 import java.util.List;
  49 
  50 import javax.servlet.http.HttpServletRequest;
  51 import javax.servlet.http.HttpServletResponse;
  52 
  53 /**
  54  * In charge of performing the various checkout operations
  55  *
  56  * @author Andre Azzolini (apazzolini)
  57  * @author Elbert Bautista (elbertbautista)
  58  * @author Joshua Skorton (jskorton)
  59  */
  60 public class BroadleafCheckoutController extends AbstractCheckoutController {
  61 
  62     private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);
  63     protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;
  64 
  65     /**
  66      * Renders the default checkout page and allows modules to add variables to the model.
  67      *
  68      * @param request
  69      * @param response
  70      * @param model
  71      * @param model
  72      * @return the checkout view path
  73      */
  74     public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,
  75             RedirectAttributes redirectAttributes) {
  76         preValidateCartOperation(model);
  77         populateModelWithReferenceData(request, model);
  78 
  79         return getCheckoutView();
  80     }
  81 
  82     protected void preValidateCartOperation(Model model) {
  83         try {
  84             Order cart = CartState.getCart();
  85             orderService.preValidateCartOperation(cart);
  86         } catch (IllegalCartOperationException ex) {
  87             model.addAttribute(&quot;cartRequiresLock&quot;, true);
  88         }
  89     }
  90 
  91     /**
  92      * Renders checkout stages partial at the requested stage
  93      *
  94      * @param request
  95      * @param response
  96      * @param model
  97      * @param stage
  98      * @return the checkout stages partial path
  99      */
<abbr title=" 100     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,"> 100     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, ModelðŸ”µ</abbr>
 101             String stage, RedirectAttributes redirectAttributes) {
 102         model.addAttribute(ACTIVE_STAGE, stage);
 103         return getCheckoutStagesPartial();
 104     }
 105 
 106     /**
 107      * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously
 108      * @param request
 109      * @param model
 110      * @param orderInfoForm
 111      * @param result
 112      * @return
 113      * @throws ServiceException
 114      */
 115     public String saveGlobalOrderDetails(HttpServletRequest request, Model model,
 116             OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {
 117         Order cart = CartState.getCart();
 118 
 119         orderInfoFormValidator.validate(orderInfoForm, result);
 120         if (result.hasErrors()) {
 121             // We need to clear the email on error in case they are trying to edit it
 122             try {
 123                 cart.setEmailAddress(null);
 124                 orderService.save(cart, false);
 125             } catch (PricingException pe) {
 126                 LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 127             }
 128 
 129             populateModelWithReferenceData(request, model);
 130             return getCheckoutView();
 131         }
 132 
 133         try {
 134             cart.setEmailAddress(orderInfoForm.getEmailAddress());
 135             orderService.save(cart, false);
 136         } catch (PricingException pe) {
 137             LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 138         }
 139 
 140         return getCheckoutPageRedirect();
 141     }
 142 
 143     /**
 144      * Creates a pass-through payment of the PaymentType passed in with
 145      * an amount equal to the order total after any non-final applied payments.
 146      * (for example gift cards, customer credit, or third party accounts)
 147      *
 148      * This intended to be used in cases like COD and other Payment Types where implementations wish
 149      * to just checkout without having to do any payment processing.
 150      *
 151      * This default implementations assumes that the pass-through payment is the only
 152      * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED
<abbr title=" 153      * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 153      * That means that it will look at all transactions on the order payment and see if it has unconfirmeðŸ”µ</abbr>
 154      * If it does, it will not remove it.
 155      *
 156      * Make sure not to expose this method in your extended Controller if you do not wish to
 157      * have this feature enabled.
 158      *
 159      * @param redirectAttributes
 160      * @param paymentType
 161      * @return
 162      * @throws PaymentException
 163      * @throws PricingException
 164      */
 165     public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,
<abbr title=" 166                                              PaymentType paymentType) throws PaymentException, PricingException {"> 166                                              PaymentType paymentType) throws PaymentException, PricingExcðŸ”µ</abbr>
 167         Order cart = CartState.getCart();
 168 
<abbr title=" 169         //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED"> 169         //Invalidate any payments already on the order that do not have transactions on them that are UNCðŸ”µ</abbr>
 170         List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();
 171         for (OrderPayment payment : cart.getPayments()) {
 172             if (payment.isActive()) {
 173                 if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {
 174                     paymentsToInvalidate.add(payment);
 175                 } else {
 176                     for (PaymentTransaction transaction : payment.getTransactions()) {
 177                         if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {
 178                              paymentsToInvalidate.add(payment);
 179                         }
 180                     }
 181                 }
 182             }
 183         }
 184 
 185         for (OrderPayment payment : paymentsToInvalidate) {
 186             cart.getPayments().remove(payment);
 187             if (paymentGatewayCheckoutService != null) {
 188                 paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());
 189             }
 190         }
 191 
 192         //Create a new Order Payment of the passed in type
 193         OrderPayment passthroughPayment = orderPaymentService.create();
 194         passthroughPayment.setType(paymentType);
 195         passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);
 196         passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());
 197         passthroughPayment.setOrder(cart);
 198 
 199         // Create the transaction for the payment
 200         PaymentTransaction transaction = orderPaymentService.createTransaction();
 201         transaction.setAmount(cart.getTotalAfterAppliedPayments());
 202         transaction.setRawResponse(&quot;Passthrough Payment&quot;);
 203         transaction.setSuccess(true);
 204         transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);
<abbr title=" 205         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 205         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymeðŸ”µ</abbr>
 206 
 207         transaction.setOrderPayment(passthroughPayment);
 208         passthroughPayment.addTransaction(transaction);
 209         orderService.addPaymentToOrder(cart, passthroughPayment, null);
 210 
 211         orderService.save(cart, true);
 212 
 213         return processCompleteCheckoutOrderFinalized(redirectAttributes);
 214     }
 215 
 216     /**
 217      * If the order has been finalized. i.e. all the payments have been applied to the order,
 218      * then you can go ahead and call checkout using the passed in order id.
<abbr title=" 219      * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 219      * This is usually called from a Review Page or if enough Payments have been applied to the Order to ðŸ”µ</abbr>
<abbr title=" 220      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or"> 220      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway,ðŸ”µ</abbr>
<abbr title=" 221      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)"> 221      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express CheckoutðŸ”µ</abbr>
 222      *
 223      * @return
 224      * @throws Exception
 225      */
<abbr title=" 226     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 226     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throðŸ”µ</abbr>
 227         Order cart = CartState.getCart();
 228         String param = &quot;&quot;;
 229         if (cart != null &amp;&amp; !(cart instanceof NullOrderImpl)) {
 230             try {
<abbr title=" 231                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OfferServiceImpl.OFFERS_EXPIRED);"> 231                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties()ðŸ”µ</abbr>
 232                 if(o!=null &amp;&amp; (Boolean) o){
<abbr title=" 233                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was re-calculated, check order total and try again&quot;);"> 233                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order pðŸ”µ</abbr>
 234                 }
 235                 String orderNumber = initiateCheckout(cart.getId());
 236                 return getConfirmationViewRedirect(orderNumber);
 237             } catch (Exception e) {
 238                 handleProcessingException(e, redirectAttributes);
 239                 if(CustomerState.getCustomer().isAnonymous()){
 240                     param=&quot;?guest-checkout=true&quot;;
 241                 }
 242             }
 243         }
 244 
 245         return getCheckoutPageRedirect()+param;
 246     }
 247 
 248     public String initiateCheckout(Long orderId) throws Exception{
 249         if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {
 250             return paymentGatewayCheckoutService.initiateCheckout(orderId);
 251         }
 252         return null;
 253     }
 254 
<abbr title=" 255     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 255     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymðŸ”µ</abbr>
<abbr title=" 256         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 256         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect AttribuðŸ”µ</abbr>
 257 
 258         Throwable cause = e.getCause();
 259 
 260         if (cause!= null &amp;&amp; cause.getCause() instanceof RequiredAttributeNotProvidedException) {
 261             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 262                     PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());
 263 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 264         }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredException) {"> 264         }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferEðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 265             String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMessage();"> 265             String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267                     message);</span>
 268 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271                     PaymentGatewayAbstractController.getProcessingErrorMessage());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272         }</span>
 273 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274         } else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferMaxUseExceededException) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276                     &quot;There was an error during checkout:&quot;+cause.getCause().getMessage());</span>
 277 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 278         } else {
 279             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 280                     PaymentGatewayAbstractController.getProcessingErrorMessage());
 281         }
 282     }
 283 
 284     public String getBaseConfirmationRedirect() {
 285         return baseConfirmationRedirect;
 286     }
 287 
 288     protected String getConfirmationViewRedirect(String orderNumber) {
 289         return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;
 290     }
 291 
 292 }
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.controller.checkout;
  19 
  20 import java.util.ArrayList;
  21 import java.util.List;
  22 import javax.servlet.http.HttpServletRequest;
  23 import javax.servlet.http.HttpServletResponse;
  24 import org.apache.commons.logging.Log;
  25 import org.apache.commons.logging.LogFactory;
  26 import org.broadleafcommerce.common.exception.ServiceException;
  27 import org.broadleafcommerce.common.payment.PaymentGatewayType;
  28 import org.broadleafcommerce.common.payment.PaymentTransactionType;
  29 import org.broadleafcommerce.common.payment.PaymentType;
  30 import org.broadleafcommerce.common.vendor.service.exception.PaymentException;
  31 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  32 import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;
  33 import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;
  34 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  35 import org.broadleafcommerce.core.offer.service.exception.OfferExpiredException;
  36 import org.broadleafcommerce.core.offer.service.exception.OfferMaxUseExceededException;
  37 import org.broadleafcommerce.core.order.domain.NullOrderImpl;
  38 import org.broadleafcommerce.core.order.domain.Order;
  39 import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;
  40 import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  41 import org.broadleafcommerce.core.payment.domain.OrderPayment;
  42 import org.broadleafcommerce.core.payment.domain.PaymentTransaction;
  43 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  44 import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;
  45 import org.broadleafcommerce.core.web.order.CartState;
  46 import org.broadleafcommerce.profile.web.core.CustomerState;
  47 import org.springframework.ui.Model;
  48 import org.springframework.validation.BindingResult;
  49 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  50 
  51 
  52 /**
  53  * In charge of performing the various checkout operations
  54  *
  55  * @author Andre Azzolini (apazzolini)
  56  * @author Elbert Bautista (elbertbautista)
  57  * @author Joshua Skorton (jskorton)
  58  */
  59 public class BroadleafCheckoutController extends AbstractCheckoutController {
  60     private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);
  61 
  62     protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;
  63 
  64     /**
  65      * Renders the default checkout page and allows modules to add variables to the model.
  66      *
  67      * @param request
  68      * @param response
  69      * @param model
  70      * @param model
  71      * @return the checkout view path
  72      */
  73     public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,
  74             RedirectAttributes redirectAttributes) {
  75         preValidateCartOperation(model);
  76         populateModelWithReferenceData(request, model);
  77 
  78         return getCheckoutView();
  79     }
  80 
  81     protected void preValidateCartOperation(Model model) {
  82         try {
  83             Order cart = CartState.getCart();
  84             orderService.preValidateCartOperation(cart);
  85         } catch (IllegalCartOperationException ex) {
  86             model.addAttribute(&quot;cartRequiresLock&quot;, true);
  87         }
  88     }
  89 
  90     /**
  91      * Renders checkout stages partial at the requested stage
  92      *
  93      * @param request
  94      * @param response
  95      * @param model
  96      * @param stage
  97      * @return the checkout stages partial path
  98      */
<abbr title="  99     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,">  99     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, ModelðŸ”µ</abbr>
 100             String stage, RedirectAttributes redirectAttributes) {
 101         model.addAttribute(ACTIVE_STAGE, stage);
 102         return getCheckoutStagesPartial();
 103     }
 104 
 105     /**
 106      * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously
 107      * @param request
 108      * @param model
 109      * @param orderInfoForm
 110      * @param result
 111      * @return
 112      * @throws ServiceException
 113      */
 114     public String saveGlobalOrderDetails(HttpServletRequest request, Model model,
 115             OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {
 116         Order cart = CartState.getCart();
 117 
 118         orderInfoFormValidator.validate(orderInfoForm, result);
 119         if (result.hasErrors()) {
 120             // We need to clear the email on error in case they are trying to edit it
 121             try {
 122                 cart.setEmailAddress(null);
 123                 orderService.save(cart, false);
 124             } catch (PricingException pe) {
 125                 LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 126             }
 127 
 128             populateModelWithReferenceData(request, model);
 129             return getCheckoutView();
 130         }
 131 
 132         try {
 133             cart.setEmailAddress(orderInfoForm.getEmailAddress());
 134             orderService.save(cart, false);
 135         } catch (PricingException pe) {
 136             LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 137         }
 138 
 139         return getCheckoutPageRedirect();
 140     }
 141 
 142     /**
 143      * Creates a pass-through payment of the PaymentType passed in with
 144      * an amount equal to the order total after any non-final applied payments.
 145      * (for example gift cards, customer credit, or third party accounts)
 146      *
 147      * This intended to be used in cases like COD and other Payment Types where implementations wish
 148      * to just checkout without having to do any payment processing.
 149      *
 150      * This default implementations assumes that the pass-through payment is the only
 151      * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED
<abbr title=" 152      * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 152      * That means that it will look at all transactions on the order payment and see if it has unconfirmeðŸ”µ</abbr>
 153      * If it does, it will not remove it.
 154      *
 155      * Make sure not to expose this method in your extended Controller if you do not wish to
 156      * have this feature enabled.
 157      *
 158      * @param redirectAttributes
 159      * @param paymentType
 160      * @return
 161      * @throws PaymentException
 162      * @throws PricingException
 163      */
 164     public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,
<abbr title=" 165                                              PaymentType paymentType) throws PaymentException, PricingException {"> 165                                              PaymentType paymentType) throws PaymentException, PricingExcðŸ”µ</abbr>
 166         Order cart = CartState.getCart();
 167 
<abbr title=" 168         //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED"> 168         //Invalidate any payments already on the order that do not have transactions on them that are UNCðŸ”µ</abbr>
 169         List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();
 170         for (OrderPayment payment : cart.getPayments()) {
 171             if (payment.isActive()) {
 172                 if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {
 173                     paymentsToInvalidate.add(payment);
 174                 } else {
 175                     for (PaymentTransaction transaction : payment.getTransactions()) {
 176                         if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {
 177                              paymentsToInvalidate.add(payment);
 178                         }
 179                     }
 180                 }
 181             }
 182         }
 183 
 184         for (OrderPayment payment : paymentsToInvalidate) {
 185             cart.getPayments().remove(payment);
 186             if (paymentGatewayCheckoutService != null) {
 187                 paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());
 188             }
 189         }
 190 
 191         //Create a new Order Payment of the passed in type
 192         OrderPayment passthroughPayment = orderPaymentService.create();
 193         passthroughPayment.setType(paymentType);
 194         passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);
 195         passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());
 196         passthroughPayment.setOrder(cart);
 197 
 198         // Create the transaction for the payment
 199         PaymentTransaction transaction = orderPaymentService.createTransaction();
 200         transaction.setAmount(cart.getTotalAfterAppliedPayments());
 201         transaction.setRawResponse(&quot;Passthrough Payment&quot;);
 202         transaction.setSuccess(true);
 203         transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);
<abbr title=" 204         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 204         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymeðŸ”µ</abbr>
 205 
 206         transaction.setOrderPayment(passthroughPayment);
 207         passthroughPayment.addTransaction(transaction);
 208         orderService.addPaymentToOrder(cart, passthroughPayment, null);
 209 
 210         orderService.save(cart, true);
 211 
 212         return processCompleteCheckoutOrderFinalized(redirectAttributes);
 213     }
 214 
 215     /**
 216      * If the order has been finalized. i.e. all the payments have been applied to the order,
 217      * then you can go ahead and call checkout using the passed in order id.
<abbr title=" 218      * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 218      * This is usually called from a Review Page or if enough Payments have been applied to the Order to ðŸ”µ</abbr>
<abbr title=" 219      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or"> 219      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway,ðŸ”µ</abbr>
<abbr title=" 220      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)"> 220      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express CheckoutðŸ”µ</abbr>
 221      *
 222      * @return
 223      * @throws Exception
 224      */
<abbr title=" 225     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 225     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throðŸ”µ</abbr>
 226         Order cart = CartState.getCart();
 227         String param = &quot;&quot;;
 228         if ((cart != null) &amp;&amp; (!(cart instanceof NullOrderImpl))) {
 229             try {
<abbr title=" 230                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OfferServiceImpl.OFFERS_EXPIRED);"> 230                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties()ðŸ”µ</abbr>
 231                 if ((o != null) &amp;&amp; ((Boolean) (o))) {
<abbr title=" 232                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was re-calculated, check order total and try again&quot;);"> 232                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order pðŸ”µ</abbr>
 233                 }
 234                 String orderNumber = initiateCheckout(cart.getId());
 235                 return getConfirmationViewRedirect(orderNumber);
 236             } catch (java.lang.Exception e) {
 237                 handleProcessingException(e, redirectAttributes);
 238                 if (CustomerState.getCustomer().isAnonymous()) {
 239                     param = &quot;?guest-checkout=true&quot;;
 240                 }
 241             }
 242         }
 243         return getCheckoutPageRedirect() + param;
 244     }
 245 
 246     public String initiateCheckout(Long orderId) throws Exception{
 247         if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {
 248             return paymentGatewayCheckoutService.initiateCheckout(orderId);
 249         }
 250         return null;
 251     }
 252 
<abbr title=" 253     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 253     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymðŸ”µ</abbr>
<abbr title=" 254         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 254         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect AttribuðŸ”µ</abbr>
 255 
 256         Throwable cause = e.getCause();
 257 
 258         if (cause!= null &amp;&amp; cause.getCause() instanceof RequiredAttributeNotProvidedException) {
 259             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 260                     PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());
 261 
 262 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 263         }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredException) {"> 263         }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferEðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 264             String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMessage();"> 264             String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 265             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266                     message);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267 </span>
 268 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 269 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 269 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 270 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272         } else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferMaxUseExceededException) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274                     &quot;There was an error during checkout:&quot;+cause.getCause().getMessage());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275 </span>
 276 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 277         } else {
 278             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 279                     PaymentGatewayAbstractController.getProcessingErrorMessage());
 280         }
 281     }
 282 
 283     public String getBaseConfirmationRedirect() {
 284         return baseConfirmationRedirect;
 285     }
 286 
 287     protected String getConfirmationViewRedirect(String orderNumber) {
 288         return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;
 289     }
 290 }
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework Web
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.web.controller.checkout;
  19  
  20  import org.apache.commons.logging.Log;
  21  import org.apache.commons.logging.LogFactory;
  22  import org.broadleafcommerce.common.exception.ServiceException;
  23  import org.broadleafcommerce.common.payment.PaymentGatewayType;
  24  import org.broadleafcommerce.common.payment.PaymentTransactionType;
  25  import org.broadleafcommerce.common.payment.PaymentType;
  26  import org.broadleafcommerce.common.vendor.service.exception.PaymentException;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import org.broadleafcommerce.common.web.BroadleafRequestContext;</span>
  28  import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;
  29  import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import org.broadleafcommerce.core.offer.service.OfferServiceImpl;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import org.broadleafcommerce.core.offer.service.exception.OfferExpiredException;</span>
  32  import org.broadleafcommerce.core.order.domain.NullOrderImpl;
  33  import org.broadleafcommerce.core.order.domain.Order;
  34  import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;
  35  import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  36  import org.broadleafcommerce.core.payment.domain.OrderPayment;
  37  import org.broadleafcommerce.core.payment.domain.PaymentTransaction;
  38  import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  39  import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;
  40  import org.broadleafcommerce.core.web.order.CartState;

  41  import org.springframework.ui.Model;
  42  import org.springframework.validation.BindingResult;
  43  import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  44  
  45  import java.util.ArrayList;
  46  import java.util.List;
  47  
  48  import javax.servlet.http.HttpServletRequest;
  49  import javax.servlet.http.HttpServletResponse;
  50  
  51  /**
  52   * In charge of performing the various checkout operations
  53   *
  54   * @author Andre Azzolini (apazzolini)
  55   * @author Elbert Bautista (elbertbautista)
  56   * @author Joshua Skorton (jskorton)
  57   */
  58  public class BroadleafCheckoutController extends AbstractCheckoutController {
  59  
  60      private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);
  61      protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;
  62  
  63      /**
  64       * Renders the default checkout page and allows modules to add variables to the model.
  65       *
  66       * @param request
  67       * @param response
  68       * @param model
  69       * @param model
  70       * @return the checkout view path
  71       */
  72      public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,
  73              RedirectAttributes redirectAttributes) {
  74          preValidateCartOperation(model);
  75          populateModelWithReferenceData(request, model);
  76  
  77          return getCheckoutView();
  78      }
  79  
  80      protected void preValidateCartOperation(Model model) {
  81          try {
  82              Order cart = CartState.getCart();
  83              orderService.preValidateCartOperation(cart);
  84          } catch (IllegalCartOperationException ex) {
  85              model.addAttribute(&quot;cartRequiresLock&quot;, true);
  86          }
  87      }
  88  
  89      /**
  90       * Renders checkout stages partial at the requested stage
  91       *
  92       * @param request
  93       * @param response
  94       * @param model
  95       * @param stage
  96       * @return the checkout stages partial path
  97       */
  98      public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,
  99              String stage, RedirectAttributes redirectAttributes) {
 100          model.addAttribute(ACTIVE_STAGE, stage);
 101          return getCheckoutStagesPartial();
 102      }
 103  
 104      /**
 105       * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously
 106       * @param request
 107       * @param model
 108       * @param orderInfoForm
 109       * @param result
 110       * @return
 111       * @throws ServiceException
 112       */
 113      public String saveGlobalOrderDetails(HttpServletRequest request, Model model,
 114              OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {
 115          Order cart = CartState.getCart();
 116  
 117          orderInfoFormValidator.validate(orderInfoForm, result);
 118          if (result.hasErrors()) {
 119              // We need to clear the email on error in case they are trying to edit it
 120              try {
 121                  cart.setEmailAddress(null);
 122                  orderService.save(cart, false);
 123              } catch (PricingException pe) {
 124                  LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 125              }
 126  
 127              populateModelWithReferenceData(request, model);
 128              return getCheckoutView();
 129          }
 130  
 131          try {
 132              cart.setEmailAddress(orderInfoForm.getEmailAddress());
 133              orderService.save(cart, false);
 134          } catch (PricingException pe) {
 135              LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 136          }
 137  
 138          return getCheckoutPageRedirect();
 139      }
 140  
 141      /**
 142       * Creates a pass-through payment of the PaymentType passed in with
 143       * an amount equal to the order total after any non-final applied payments.
 144       * (for example gift cards, customer credit, or third party accounts)
 145       *
 146       * This intended to be used in cases like COD and other Payment Types where implementations wish
 147       * to just checkout without having to do any payment processing.
 148       *
 149       * This default implementations assumes that the pass-through payment is the only
 150       * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED
<abbr title=" 151       * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 151       * That means that it will look at all transactions on the order payment and see if it has unconfirmed transacðŸ”µ</abbr>
 152       * If it does, it will not remove it.
 153       *
 154       * Make sure not to expose this method in your extended Controller if you do not wish to
 155       * have this feature enabled.
 156       *
 157       * @param redirectAttributes
 158       * @param paymentType
 159       * @return
 160       * @throws PaymentException
 161       * @throws PricingException
 162       */
 163      public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,
 164                                               PaymentType paymentType) throws PaymentException, PricingException {
 165          Order cart = CartState.getCart();
 166  
 167          //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED
 168          List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();
 169          for (OrderPayment payment : cart.getPayments()) {
 170              if (payment.isActive()) {
 171                  if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {
 172                      paymentsToInvalidate.add(payment);
 173                  } else {
 174                      for (PaymentTransaction transaction : payment.getTransactions()) {
 175                          if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {
 176                               paymentsToInvalidate.add(payment);
 177                          }
 178                      }
 179                  }
 180              }
 181          }
 182  
 183          for (OrderPayment payment : paymentsToInvalidate) {
 184              cart.getPayments().remove(payment);
 185              if (paymentGatewayCheckoutService != null) {
 186                  paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());
 187              }
 188          }
 189  
 190          //Create a new Order Payment of the passed in type
 191          OrderPayment passthroughPayment = orderPaymentService.create();
 192          passthroughPayment.setType(paymentType);
 193          passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);
 194          passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());
 195          passthroughPayment.setOrder(cart);
 196  
 197          // Create the transaction for the payment
 198          PaymentTransaction transaction = orderPaymentService.createTransaction();
 199          transaction.setAmount(cart.getTotalAfterAppliedPayments());
 200          transaction.setRawResponse(&quot;Passthrough Payment&quot;);
 201          transaction.setSuccess(true);
 202          transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);
<abbr title=" 203          transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 203          transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.geðŸ”µ</abbr>
 204  
 205          transaction.setOrderPayment(passthroughPayment);
 206          passthroughPayment.addTransaction(transaction);
 207          orderService.addPaymentToOrder(cart, passthroughPayment, null);
 208  
 209          orderService.save(cart, true);
 210  
 211          return processCompleteCheckoutOrderFinalized(redirectAttributes);
 212      }
 213  
 214      /**
 215       * If the order has been finalized. i.e. all the payments have been applied to the order,
 216       * then you can go ahead and call checkout using the passed in order id.
<abbr title=" 217       * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 217       * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete ðŸ”µ</abbr>
 218       * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or
 219       * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)
 220       *
 221       * @return
 222       * @throws Exception
 223       */
<abbr title=" 224      public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 224      public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymenðŸ”µ</abbr>
 225          Order cart = CartState.getCart();
 226  

 227          if (cart != null &amp;&amp; !(cart instanceof NullOrderImpl)) {
 228              try {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 229 +                Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OfferServiceImpl.OFFERS_EXPIRED);"> 229 +                Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OffeðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +                if(o!=null &amp;&amp; (Boolean) o){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 231 +                    throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was re-calculated, check order total and try again&quot;);"> 231 +                    throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +                }</span>
 233                  String orderNumber = initiateCheckout(cart.getId());
 234                  return getConfirmationViewRedirect(orderNumber);
 235              } catch (Exception e) {
 236                  handleProcessingException(e, redirectAttributes);
 237              }
 238          }
 239  
 240          return getCheckoutPageRedirect();







 241      }
 242  
 243      public String initiateCheckout(Long orderId) throws Exception{
 244          if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {
 245              return paymentGatewayCheckoutService.initiateCheckout(orderId);
 246          }
 247          return null;
 248      }
 249  
<abbr title=" 250      public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 250      public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentExceptðŸ”µ</abbr>
<abbr title=" 251          LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 251          LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e)ðŸ”µ</abbr>
 252  
 253          Throwable cause = e.getCause();
 254  
 255          if (cause!= null &amp;&amp; cause.getCause() instanceof RequiredAttributeNotProvidedException) {
 256              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 257                      PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 258 +        }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredException) {"> 258 +        }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredExcðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 259 +            String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMessage();"> 259 +            String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMeðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +            redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +                    message);</span>
 262          } else {
 263              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 264                      PaymentGatewayAbstractController.getProcessingErrorMessage());
 265          }
 266      }
 267  
 268      public String getBaseConfirmationRedirect() {
 269          return baseConfirmationRedirect;
 270      }
 271  
 272      protected String getConfirmationViewRedirect(String orderNumber) {
 273          return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;
 274      }
 275  
 276  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework Web
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.web.controller.checkout;
  19  
  20  import org.apache.commons.logging.Log;
  21  import org.apache.commons.logging.LogFactory;
  22  import org.broadleafcommerce.common.exception.ServiceException;
  23  import org.broadleafcommerce.common.payment.PaymentGatewayType;
  24  import org.broadleafcommerce.common.payment.PaymentTransactionType;
  25  import org.broadleafcommerce.common.payment.PaymentType;
  26  import org.broadleafcommerce.common.vendor.service.exception.PaymentException;

  27  import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;
  28  import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import org.broadleafcommerce.core.offer.service.exception.OfferMaxUseExceededException;</span>

  30  import org.broadleafcommerce.core.order.domain.NullOrderImpl;
  31  import org.broadleafcommerce.core.order.domain.Order;
  32  import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;
  33  import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  34  import org.broadleafcommerce.core.payment.domain.OrderPayment;
  35  import org.broadleafcommerce.core.payment.domain.PaymentTransaction;
  36  import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  37  import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;
  38  import org.broadleafcommerce.core.web.order.CartState;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +import org.broadleafcommerce.profile.web.core.CustomerState;</span>
  40  import org.springframework.ui.Model;
  41  import org.springframework.validation.BindingResult;
  42  import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  43  
  44  import java.util.ArrayList;
  45  import java.util.List;
  46  
  47  import javax.servlet.http.HttpServletRequest;
  48  import javax.servlet.http.HttpServletResponse;
  49  
  50  /**
  51   * In charge of performing the various checkout operations
  52   *
  53   * @author Andre Azzolini (apazzolini)
  54   * @author Elbert Bautista (elbertbautista)
  55   * @author Joshua Skorton (jskorton)
  56   */
  57  public class BroadleafCheckoutController extends AbstractCheckoutController {
  58  
  59      private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);
  60      protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;
  61  
  62      /**
  63       * Renders the default checkout page and allows modules to add variables to the model.
  64       *
  65       * @param request
  66       * @param response
  67       * @param model
  68       * @param model
  69       * @return the checkout view path
  70       */
  71      public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,
  72              RedirectAttributes redirectAttributes) {
  73          preValidateCartOperation(model);
  74          populateModelWithReferenceData(request, model);
  75  
  76          return getCheckoutView();
  77      }
  78  
  79      protected void preValidateCartOperation(Model model) {
  80          try {
  81              Order cart = CartState.getCart();
  82              orderService.preValidateCartOperation(cart);
  83          } catch (IllegalCartOperationException ex) {
  84              model.addAttribute(&quot;cartRequiresLock&quot;, true);
  85          }
  86      }
  87  
  88      /**
  89       * Renders checkout stages partial at the requested stage
  90       *
  91       * @param request
  92       * @param response
  93       * @param model
  94       * @param stage
  95       * @return the checkout stages partial path
  96       */
  97      public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,
  98              String stage, RedirectAttributes redirectAttributes) {
  99          model.addAttribute(ACTIVE_STAGE, stage);
 100          return getCheckoutStagesPartial();
 101      }
 102  
 103      /**
 104       * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously
 105       * @param request
 106       * @param model
 107       * @param orderInfoForm
 108       * @param result
 109       * @return
 110       * @throws ServiceException
 111       */
 112      public String saveGlobalOrderDetails(HttpServletRequest request, Model model,
 113              OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {
 114          Order cart = CartState.getCart();
 115  
 116          orderInfoFormValidator.validate(orderInfoForm, result);
 117          if (result.hasErrors()) {
 118              // We need to clear the email on error in case they are trying to edit it
 119              try {
 120                  cart.setEmailAddress(null);
 121                  orderService.save(cart, false);
 122              } catch (PricingException pe) {
 123                  LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 124              }
 125  
 126              populateModelWithReferenceData(request, model);
 127              return getCheckoutView();
 128          }
 129  
 130          try {
 131              cart.setEmailAddress(orderInfoForm.getEmailAddress());
 132              orderService.save(cart, false);
 133          } catch (PricingException pe) {
 134              LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 135          }
 136  
 137          return getCheckoutPageRedirect();
 138      }
 139  
 140      /**
 141       * Creates a pass-through payment of the PaymentType passed in with
 142       * an amount equal to the order total after any non-final applied payments.
 143       * (for example gift cards, customer credit, or third party accounts)
 144       *
 145       * This intended to be used in cases like COD and other Payment Types where implementations wish
 146       * to just checkout without having to do any payment processing.
 147       *
 148       * This default implementations assumes that the pass-through payment is the only
 149       * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED
<abbr title=" 150       * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 150       * That means that it will look at all transactions on the order payment and see if it has unconfirmed transacðŸ”µ</abbr>
 151       * If it does, it will not remove it.
 152       *
 153       * Make sure not to expose this method in your extended Controller if you do not wish to
 154       * have this feature enabled.
 155       *
 156       * @param redirectAttributes
 157       * @param paymentType
 158       * @return
 159       * @throws PaymentException
 160       * @throws PricingException
 161       */
 162      public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,
 163                                               PaymentType paymentType) throws PaymentException, PricingException {
 164          Order cart = CartState.getCart();
 165  
 166          //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED
 167          List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();
 168          for (OrderPayment payment : cart.getPayments()) {
 169              if (payment.isActive()) {
 170                  if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {
 171                      paymentsToInvalidate.add(payment);
 172                  } else {
 173                      for (PaymentTransaction transaction : payment.getTransactions()) {
 174                          if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {
 175                               paymentsToInvalidate.add(payment);
 176                          }
 177                      }
 178                  }
 179              }
 180          }
 181  
 182          for (OrderPayment payment : paymentsToInvalidate) {
 183              cart.getPayments().remove(payment);
 184              if (paymentGatewayCheckoutService != null) {
 185                  paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());
 186              }
 187          }
 188  
 189          //Create a new Order Payment of the passed in type
 190          OrderPayment passthroughPayment = orderPaymentService.create();
 191          passthroughPayment.setType(paymentType);
 192          passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);
 193          passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());
 194          passthroughPayment.setOrder(cart);
 195  
 196          // Create the transaction for the payment
 197          PaymentTransaction transaction = orderPaymentService.createTransaction();
 198          transaction.setAmount(cart.getTotalAfterAppliedPayments());
 199          transaction.setRawResponse(&quot;Passthrough Payment&quot;);
 200          transaction.setSuccess(true);
 201          transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);
<abbr title=" 202          transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 202          transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.geðŸ”µ</abbr>
 203  
 204          transaction.setOrderPayment(passthroughPayment);
 205          passthroughPayment.addTransaction(transaction);
 206          orderService.addPaymentToOrder(cart, passthroughPayment, null);
 207  
 208          orderService.save(cart, true);
 209  
 210          return processCompleteCheckoutOrderFinalized(redirectAttributes);
 211      }
 212  
 213      /**
 214       * If the order has been finalized. i.e. all the payments have been applied to the order,
 215       * then you can go ahead and call checkout using the passed in order id.
<abbr title=" 216       * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 216       * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete ðŸ”µ</abbr>
 217       * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or
 218       * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)
 219       *
 220       * @return
 221       * @throws Exception
 222       */
<abbr title=" 223      public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 223      public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymenðŸ”µ</abbr>
 224          Order cart = CartState.getCart();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +        String param = &quot;&quot;;</span>
 227          if (cart != null &amp;&amp; !(cart instanceof NullOrderImpl)) {
 228              try {




 229                  String orderNumber = initiateCheckout(cart.getId());
 230                  return getConfirmationViewRedirect(orderNumber);
 231              } catch (Exception e) {
 232                  handleProcessingException(e, redirectAttributes);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -        return getCheckoutPageRedirect();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +                if(CustomerState.getCustomer().isAnonymous()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +                    param=&quot;?guest-checkout=true&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +        return getCheckoutPageRedirect()+param;</span>
 244      }
 245  
 246      public String initiateCheckout(Long orderId) throws Exception{
 247          if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {
 248              return paymentGatewayCheckoutService.initiateCheckout(orderId);
 249          }
 250          return null;
 251      }
 252  
<abbr title=" 253      public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 253      public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentExceptðŸ”µ</abbr>
<abbr title=" 254          LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 254          LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e)ðŸ”µ</abbr>
 255  
 256          Throwable cause = e.getCause();
 257  
 258          if (cause!= null &amp;&amp; cause.getCause() instanceof RequiredAttributeNotProvidedException) {
 259              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 260                      PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +        } else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferMaxUseExceededException) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +            redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +                    &quot;There was an error during checkout:&quot;+cause.getCause().getMessage());</span>

 264          } else {
 265              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 266                      PaymentGatewayAbstractController.getProcessingErrorMessage());
 267          }
 268      }
 269  
 270      public String getBaseConfirmationRedirect() {
 271          return baseConfirmationRedirect;
 272      }
 273  
 274      protected String getConfirmationViewRedirect(String orderNumber) {
 275          return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;
 276      }
 277  
 278  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            