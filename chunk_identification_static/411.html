<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>411</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    411
                    <a href="410.html">prev</a>
                    <a href="412.html">next</a>
                    <a href="411_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_cd618352eabd0c074c56f3cd6eba99a0825ae16c_launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;cd618352eabd0c074c56f3cd6eba99a0825ae16c:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;cd618352eabd0c074c56f3cd6eba99a0825ae16c^1:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;cd618352eabd0c074c56f3cd6eba99a0825ae16c^2:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;1fc0d53fde0767c2c203339b9a5dcfef1607de24:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [s]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /**
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  * &lt;p&gt;
  10  * http://www.apache.org/licenses/LICENSE-2.0
  11  * &lt;p&gt;
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.launcher;
  20 
  21 import com.dtstack.flink.sql.enums.ClusterMode;
  22 import com.dtstack.flink.sql.option.Options;
  23 import com.dtstack.flink.sql.util.PluginUtil;
  24 import org.apache.commons.io.Charsets;
  25 import org.apache.commons.lang.StringUtils;
  26 import org.apache.flink.client.program.ClusterClient;
  27 import org.apache.flink.client.program.rest.RestClusterClient;
  28 import org.apache.flink.configuration.Configuration;
  29 import org.apache.flink.configuration.GlobalConfiguration;
  30 import org.apache.flink.configuration.JobManagerOptions;
  31 import org.apache.flink.core.fs.FileSystem;
  32 import org.apache.flink.runtime.akka.AkkaUtils;
  33 import org.apache.flink.runtime.util.LeaderConnectionInfo;
  34 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  35 import org.apache.flink.yarn.YarnClusterDescriptor;
  36 import org.apache.hadoop.yarn.api.records.ApplicationId;
  37 import org.apache.hadoop.yarn.api.records.ApplicationReport;
  38 import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  39 import org.apache.hadoop.yarn.client.api.YarnClient;
  40 import org.apache.hadoop.yarn.conf.YarnConfiguration;
  41 import org.apache.hadoop.yarn.util.StringHelper;
  42 import org.slf4j.Logger;
  43 import org.slf4j.LoggerFactory;
  44 
  45 import java.net.InetSocketAddress;
  46 import java.net.URLDecoder;
  47 import java.util.EnumSet;
  48 import java.util.HashSet;
  49 import java.util.Set;
  50 import java.util.List;
  51 import java.util.Properties;
  52 import java.util.Iterator;
  53 
  54 /**
  55  * @author sishu.yss
  56  */
  57 public class ClusterClientFactory {
  58 
  59     private static final Logger LOG = LoggerFactory.getLogger(ClusterClientFactory.class);
  60 
  61     private static final String HA_CLUSTER_ID = &quot;high-availability.cluster-id&quot;;
  62 
  63     private static final String HIGH_AVAILABILITY = &quot;high-availability&quot;;
  64 
  65     private static final String NODE = &quot;NONE&quot;;
  66 
  67     private static final String ZOOKEEPER = &quot;zookeeper&quot;;
  68 
  69     private static final String HADOOP_CONF = &quot;fs.hdfs.hadoopconf&quot;;
  70 
  71     public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  72         String mode = launcherOptions.getMode();
  73         if (mode.equals(ClusterMode.standalone.name())) {
  74             return createStandaloneClient(launcherOptions);
  75         } else if (mode.equals(ClusterMode.yarn.name())) {
  76             return createYarnSessionClient(launcherOptions);
  77         }
  78         throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  79     }
  80 
  81     public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  82         String flinkConfDir = launcherOptions.getFlinkconf();
  83         Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
  84 
  85         LOG.info(&quot;------------config params-------------------------&quot;);
  86         config.toMap().forEach((key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));
  87         LOG.info(&quot;-------------------------------------------&quot;);
  88 
  89         RestClusterClient clusterClient = new RestClusterClient&lt;&gt;(config, &quot;clusterClient&quot;);
  90         LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
<abbr title="  91         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());">  91         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress()ðŸ”µ</abbr>
  92         config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
  93         config.setInteger(JobManagerOptions.PORT, address.getPort());
  94         clusterClient.setDetached(true);
  95         return clusterClient;
  96     }
  97 
  98     public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title="  99         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();">  99         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.ðŸ”µ</abbr>
<abbr title=" 100         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);"> 100         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguratðŸ”µ</abbr>
 101         String yarnConfDir = launcherOptions.getYarnconf();
 102 
 103         if (StringUtils.isNotBlank(yarnConfDir)) {
 104             try {
 105                 boolean isHighAvailability;
 106 
 107                 config.setString(HADOOP_CONF, yarnConfDir);
 108                 FileSystem.initialize(config);
 109 
 110                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
 111                 YarnClient yarnClient = YarnClient.createYarnClient();
 112                 yarnClient.init(yarnConf);
 113                 yarnClient.start();
 114                 ApplicationId applicationId;
 115 
 116                 String yarnSessionConf = launcherOptions.getYarnSessionConf();
 117                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 118                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 118                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr>
 119 
 120                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 121 
 122                 if (null != yid) {
 123                     applicationId = toApplicationId(yid.toString());
 124                 } else {
 125                     applicationId = getYarnClusterApplicationId(yarnClient);
 126                 }
 127 
 128                 LOG.info(&quot;current applicationId = {}&quot;, applicationId.toString());
 129 
 130                 if (StringUtils.isEmpty(applicationId.toString())) {
 131                     throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 132                 }
 133 
 134                 isHighAvailability = config.getString(HIGH_AVAILABILITY, NODE).equals(ZOOKEEPER);
 135 
 136                 if (isHighAvailability &amp;&amp; config.getString(HA_CLUSTER_ID, null) == null) {
 137                     config.setString(HA_CLUSTER_ID, applicationId.toString());
 138                 }
 139 
 140                 LOG.info(&quot;------------config params-------------------------&quot;);
 141                 config.toMap().forEach((key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));
 142                 LOG.info(&quot;-------------------------------------------&quot;);
 143 
<abbr title=" 144                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 144                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnCðŸ”µ</abbr>
 145                 ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 146                 clusterClient.setDetached(true);
 147                 return clusterClient;
 148             } catch (Exception e) {
 149                 throw new RuntimeException(e);
 150             }
 151         } else {
 152             throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 153         }
 154     }
 155 
 156 
 157     private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 158         ApplicationId applicationId = null;
 159 
 160         Set&lt;String&gt; set = new HashSet&lt;&gt;();
 161         set.add(&quot;Apache Flink&quot;);
 162         EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 163         enumSet.add(YarnApplicationState.RUNNING);
 164         List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 165 
 166         int maxMemory = -1;
 167         int maxCores = -1;
 168         for (ApplicationReport report : reportList) {
 169             if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 170                 continue;
 171             }
 172 
 173             if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 174                 continue;
 175             }
 176 
 177             int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
<abbr title=" 178             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();"> 178             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCorðŸ”µ</abbr>
 179             if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {
 180                 maxMemory = thisMemory;
 181                 maxCores = thisCores;
 182                 applicationId = report.getApplicationId();
 183             }
 184 
 185         }
 186 
 187 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188         if (applicationId == null || StringUtils.isEmpty(applicationId.toString())) {</span>
 189 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190         if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193         return applicationId;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196     private static ApplicationId toApplicationId(String appIdStr) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         if (!&quot;application&quot;.equals(it.next())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 199             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 199             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The validðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201             try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202                 return toApplicationId(it);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203             } catch (NumberFormatException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213 }</span>
 214 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215         if (null == applicationId) {</span>
 216 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 217             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 218         }
 219         return applicationId;
 220     }
 221 
 222     private static ApplicationId toApplicationId(String appIdStr) {
 223         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
 224         if (!&quot;application&quot;.equals(it.next())) {
<abbr title=" 225             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 225             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The validðŸ”µ</abbr>
 226         } else {
 227             try {
 228                 return toApplicationId(it);
 229             } catch (NumberFormatException e) {
 230                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 231             }
 232         }
 233     }
 234 
 235     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 236         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 237     }
 238 
 239 }</pre></td>
                            <td><pre>   1 /**
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  * &lt;p&gt;
  10  * http://www.apache.org/licenses/LICENSE-2.0
  11  * &lt;p&gt;
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.launcher;
  20 
  21 import com.dtstack.flink.sql.enums.ClusterMode;
  22 import com.dtstack.flink.sql.option.Options;
  23 import com.dtstack.flink.sql.util.PluginUtil;
  24 import org.apache.commons.io.Charsets;
  25 import org.apache.commons.lang.StringUtils;
  26 import org.apache.flink.client.program.ClusterClient;
  27 import org.apache.flink.client.program.rest.RestClusterClient;
  28 import org.apache.flink.configuration.Configuration;
  29 import org.apache.flink.configuration.GlobalConfiguration;
  30 import org.apache.flink.configuration.JobManagerOptions;
  31 import org.apache.flink.core.fs.FileSystem;
  32 import org.apache.flink.runtime.akka.AkkaUtils;
  33 import org.apache.flink.runtime.util.LeaderConnectionInfo;
  34 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  35 import org.apache.flink.yarn.YarnClusterDescriptor;
  36 import org.apache.hadoop.yarn.api.records.ApplicationId;
  37 import org.apache.hadoop.yarn.api.records.ApplicationReport;
  38 import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  39 import org.apache.hadoop.yarn.client.api.YarnClient;
  40 import org.apache.hadoop.yarn.conf.YarnConfiguration;
  41 import org.apache.hadoop.yarn.util.StringHelper;
  42 import org.slf4j.Logger;
  43 import org.slf4j.LoggerFactory;
  44 
  45 import java.net.InetSocketAddress;
  46 import java.net.URLDecoder;
  47 import java.util.EnumSet;
  48 import java.util.HashSet;
  49 import java.util.Iterator;
  50 import java.util.List;
  51 import java.util.Properties;
  52 import java.util.Set;
  53 
  54 /**
  55  * @author sishu.yss
  56  */
  57 public class ClusterClientFactory {
  58 
  59     private static final Logger LOG = LoggerFactory.getLogger(ClusterClientFactory.class);
  60 
  61     private static final String HA_CLUSTER_ID = &quot;high-availability.cluster-id&quot;;
  62 
  63     private static final String HIGH_AVAILABILITY = &quot;high-availability&quot;;
  64 
  65     private static final String NODE = &quot;NONE&quot;;
  66 
  67     private static final String ZOOKEEPER = &quot;zookeeper&quot;;
  68 
  69     private static final String HADOOP_CONF = &quot;fs.hdfs.hadoopconf&quot;;
  70 
  71     public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  72         String mode = launcherOptions.getMode();
  73         if (mode.equals(ClusterMode.standalone.name())) {
  74             return createStandaloneClient(launcherOptions);
  75         } else if (mode.equals(ClusterMode.yarn.name())) {
  76             return createYarnSessionClient(launcherOptions);
  77         }
  78         throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  79     }
  80 
  81     public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  82         String flinkConfDir = launcherOptions.getFlinkconf();
  83         Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
  84 
  85         LOG.info(&quot;------------config params-------------------------&quot;);
  86         config.toMap().forEach((key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));
  87         LOG.info(&quot;-------------------------------------------&quot;);
  88 
  89         RestClusterClient clusterClient = new RestClusterClient&lt;&gt;(config, &quot;clusterClient&quot;);
  90         LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
<abbr title="  91         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());">  91         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress()ðŸ”µ</abbr>
  92         config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
  93         config.setInteger(JobManagerOptions.PORT, address.getPort());
  94         clusterClient.setDetached(true);
  95         return clusterClient;
  96     }
  97 
  98     public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title="  99         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();">  99         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.ðŸ”µ</abbr>
<abbr title=" 100         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);"> 100         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguratðŸ”µ</abbr>
 101         String yarnConfDir = launcherOptions.getYarnconf();
 102 
 103         if (StringUtils.isNotBlank(yarnConfDir)) {
 104             try {
 105                 boolean isHighAvailability;
 106 
 107                 config.setString(HADOOP_CONF, yarnConfDir);
 108                 FileSystem.initialize(config);
 109 
 110                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
 111                 YarnClient yarnClient = YarnClient.createYarnClient();
 112                 yarnClient.init(yarnConf);
 113                 yarnClient.start();
 114                 ApplicationId applicationId;
 115 
 116                 String yarnSessionConf = launcherOptions.getYarnSessionConf();
 117                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 118                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 118                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr>
 119 
 120                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 121 
 122                 if (null != yid) {
 123                     applicationId = toApplicationId(yid.toString());
 124                 } else {
 125                     applicationId = getYarnClusterApplicationId(yarnClient);
 126                 }
 127 
 128                 LOG.info(&quot;current applicationId = {}&quot;, applicationId.toString());
 129 
 130                 if (StringUtils.isEmpty(applicationId.toString())) {
 131                     throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 132                 }
 133 
 134                 isHighAvailability = config.getString(HIGH_AVAILABILITY, NODE).equals(ZOOKEEPER);
 135 
 136                 if (isHighAvailability &amp;&amp; config.getString(HA_CLUSTER_ID, null) == null) {
 137                     config.setString(HA_CLUSTER_ID, applicationId.toString());
 138                 }
 139 
 140                 LOG.info(&quot;------------config params-------------------------&quot;);
 141                 config.toMap().forEach((key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));
 142                 LOG.info(&quot;-------------------------------------------&quot;);
 143 
<abbr title=" 144                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 144                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnCðŸ”µ</abbr>
 145                 ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 146                 clusterClient.setDetached(true);
 147                 return clusterClient;
 148             } catch (Exception e) {
 149                 throw new RuntimeException(e);
 150             }
 151         }else{
 152             throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 153         }
 154     }
 155 
 156 
 157     private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 158         ApplicationId applicationId = null;
 159 
 160         Set&lt;String&gt; set = new HashSet&lt;&gt;();
 161         set.add(&quot;Apache Flink&quot;);
 162         EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 163         enumSet.add(YarnApplicationState.RUNNING);
 164         List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 165 
 166         int maxMemory = -1;
 167         int maxCores = -1;
 168         for (ApplicationReport report : reportList) {
 169             if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 170                 continue;
 171             }
 172 
 173             if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 174                 continue;
 175             }
 176 
 177             int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
<abbr title=" 178             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();"> 178             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCorðŸ”µ</abbr>
 179             if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {
 180                 maxMemory = thisMemory;
 181                 maxCores = thisCores;
 182                 applicationId = report.getApplicationId();
 183             }
 184 
 185         }
 186 
 187 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188         if (applicationId == null || StringUtils.isEmpty(applicationId.toString())) {</span>
 189 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190         if (StringUtils.isEmpty(applicationId.toString())) {</span>
 191 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192         if (null == applicationId) {</span>
 193 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 194             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 195         }
 196         return applicationId;
 197     }
 198 
 199     private static ApplicationId toApplicationId(String appIdStr) {
 200         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
 201         if (!&quot;application&quot;.equals(it.next())) {
<abbr title=" 202             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 202             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The validðŸ”µ</abbr>
 203         } else {
 204             try {
 205                 return toApplicationId(it);
 206             } catch (NumberFormatException e) {
 207                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 208             }
 209         }
 210     }
 211 
 212     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 213         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 214     }
 215 
 216 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /**
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  * &lt;p&gt;
  10  * http://www.apache.org/licenses/LICENSE-2.0
  11  * &lt;p&gt;
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.launcher;
  19 
  20 import com.dtstack.flink.sql.enums.ClusterMode;
  21 import com.dtstack.flink.sql.option.Options;
  22 import com.dtstack.flink.sql.util.PluginUtil;
  23 import java.net.InetSocketAddress;
  24 import java.net.URLDecoder;
  25 import java.util.EnumSet;
  26 import java.util.HashSet;
  27 import java.util.Iterator;
  28 import java.util.List;
  29 import java.util.Properties;
  30 import java.util.Set;
  31 import org.apache.commons.io.Charsets;
  32 import org.apache.commons.lang.StringUtils;
  33 import org.apache.flink.client.program.ClusterClient;
  34 import org.apache.flink.client.program.rest.RestClusterClient;
  35 import org.apache.flink.configuration.Configuration;
  36 import org.apache.flink.configuration.GlobalConfiguration;
  37 import org.apache.flink.configuration.JobManagerOptions;
  38 import org.apache.flink.core.fs.FileSystem;
  39 import org.apache.flink.runtime.akka.AkkaUtils;
  40 import org.apache.flink.runtime.util.LeaderConnectionInfo;
  41 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  42 import org.apache.flink.yarn.YarnClusterDescriptor;
  43 import org.apache.hadoop.yarn.api.records.ApplicationId;
  44 import org.apache.hadoop.yarn.api.records.ApplicationReport;
  45 import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  46 import org.apache.hadoop.yarn.client.api.YarnClient;
  47 import org.apache.hadoop.yarn.conf.YarnConfiguration;
  48 import org.apache.hadoop.yarn.util.StringHelper;
  49 import org.slf4j.Logger;
  50 import org.slf4j.LoggerFactory;
  51 
  52 
  53 /**
  54  * @author sishu.yss
  55  */
  56 public class ClusterClientFactory {
  57     private static final Logger LOG = LoggerFactory.getLogger(ClusterClientFactory.class);
  58 
  59     private static final String HA_CLUSTER_ID = &quot;high-availability.cluster-id&quot;;
  60 
  61     private static final String HIGH_AVAILABILITY = &quot;high-availability&quot;;
  62 
  63     private static final String NODE = &quot;NONE&quot;;
  64 
  65     private static final String ZOOKEEPER = &quot;zookeeper&quot;;
  66 
  67     private static final String HADOOP_CONF = &quot;fs.hdfs.hadoopconf&quot;;
  68 
  69     public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  70         String mode = launcherOptions.getMode();
  71         if (mode.equals(ClusterMode.standalone.name())) {
  72             return createStandaloneClient(launcherOptions);
  73         } else if (mode.equals(ClusterMode.yarn.name())) {
  74             return createYarnSessionClient(launcherOptions);
  75         }
  76         throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  77     }
  78 
  79     public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  80         String flinkConfDir = launcherOptions.getFlinkconf();
  81         Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
  82         LOG.info(&quot;------------config params-------------------------&quot;);
  83         config.toMap().forEach(( key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));
  84         LOG.info(&quot;-------------------------------------------&quot;);
  85         RestClusterClient clusterClient = new RestClusterClient&lt;&gt;(config, &quot;clusterClient&quot;);
  86         LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
<abbr title="  87         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());">  87         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress()ðŸ”µ</abbr>
  88         config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
  89         config.setInteger(JobManagerOptions.PORT, address.getPort());
  90         clusterClient.setDetached(true);
  91         return clusterClient;
  92     }
  93 
  94     public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title="  95         String flinkConfDir = (StringUtils.isEmpty(launcherOptions.getFlinkconf())) ? &quot;&quot; : launcherOptions.getFlinkconf();">  95         String flinkConfDir = (StringUtils.isEmpty(launcherOptions.getFlinkconf())) ? &quot;&quot; : launcherOptionðŸ”µ</abbr>
<abbr title="  96         Configuration config = (StringUtils.isEmpty(flinkConfDir)) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);">  96         Configuration config = (StringUtils.isEmpty(flinkConfDir)) ? new Configuration() : GlobalConfigurðŸ”µ</abbr>
  97         String yarnConfDir = launcherOptions.getYarnconf();
  98         if (StringUtils.isNotBlank(yarnConfDir)) {
  99             try {
 100                 boolean isHighAvailability;
 101                 config.setString(HADOOP_CONF, yarnConfDir);
 102                 FileSystem.initialize(config);
 103                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
 104                 YarnClient yarnClient = YarnClient.createYarnClient();
 105                 yarnClient.init(yarnConf);
 106                 yarnClient.start();
 107                 ApplicationId applicationId;
 108                 String yarnSessionConf = launcherOptions.getYarnSessionConf();
 109                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 110                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 110                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr>
 111                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 112                 if (null != yid) {
 113                     applicationId = toApplicationId(yid.toString());
 114                 } else {
 115                     applicationId = getYarnClusterApplicationId(yarnClient);
 116                 }
 117                 LOG.info(&quot;current applicationId = {}&quot;, applicationId.toString());
 118                 if (StringUtils.isEmpty(applicationId.toString())) {
 119                     throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 120                 }
 121                 isHighAvailability = config.getString(HIGH_AVAILABILITY, NODE).equals(ZOOKEEPER);
 122                 if (isHighAvailability &amp;&amp; (config.getString(HA_CLUSTER_ID, null) == null)) {
 123                     config.setString(HA_CLUSTER_ID, applicationId.toString());
 124                 }
 125                 LOG.info(&quot;------------config params-------------------------&quot;);
 126                 config.toMap().forEach(( key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));
 127                 LOG.info(&quot;-------------------------------------------&quot;);
<abbr title=" 128                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 128                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnCðŸ”µ</abbr>
 129                 ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 130                 clusterClient.setDetached(true);
 131                 return clusterClient;
 132             } catch (java.lang.Exception e) {
 133                 throw new RuntimeException(e);
 134             }
 135         } else {
 136             throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 137         }
 138     }
 139 
 140     private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 141         ApplicationId applicationId = null;
 142         Set&lt;String&gt; set = new HashSet&lt;&gt;();
 143         set.add(&quot;Apache Flink&quot;);
 144         EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 145         enumSet.add(YarnApplicationState.RUNNING);
 146         List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 147         int maxMemory = -1;
 148         int maxCores = -1;
 149         for (ApplicationReport report : reportList) {
 150             if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 151                 continue;
 152             }
 153             if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 154                 continue;
 155             }
 156             int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
<abbr title=" 157             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();"> 157             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCorðŸ”µ</abbr>
 158             if ((thisMemory &gt; maxMemory) || ((thisMemory == maxMemory) &amp;&amp; (thisCores &gt; maxCores))) {
 159                 maxMemory = thisMemory;
 160                 maxCores = thisCores;
 161                 applicationId = report.getApplicationId();
 162             }
 163         }
 164         if (
 165 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166 applicationId == null || StringUtils.isEmpty(applicationId.toString())</span>
 167 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 168 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 168 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 169 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171 null == applicationId</span>
 172 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 173         ) {
 174             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 175         }
 176         return applicationId;
 177     }
 178 
 179     private static ApplicationId toApplicationId(String appIdStr) {
 180         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
 181         if (!&quot;application&quot;.equals(it.next())) {
<abbr title=" 182             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 182             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The validðŸ”µ</abbr>
 183         } else {
 184             try {
 185                 return toApplicationId(it);
 186             } catch (NumberFormatException e) {
 187                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 188             }
 189         }
 190     }
 191 
 192     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 193         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 194     }
 195 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /**
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + * &lt;p&gt;</span>
  11   * http://www.apache.org/licenses/LICENSE-2.0
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + * &lt;p&gt;</span>
  14   * Unless required by applicable law or agreed to in writing, software
  15   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  16   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  17   * See the License for the specific language governing permissions and
  18   * limitations under the License.
  19   */
  20  
  21  package com.dtstack.flink.sql.launcher;
  22  
  23  import com.dtstack.flink.sql.enums.ClusterMode;
  24  import com.dtstack.flink.sql.option.Options;
  25  import com.dtstack.flink.sql.util.PluginUtil;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import com.esotericsoftware.minlog.Log;</span>
  27  import org.apache.commons.io.Charsets;
  28  import org.apache.commons.lang.StringUtils;
  29  import org.apache.flink.client.program.ClusterClient;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import org.apache.flink.client.program.MiniClusterClient;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import org.apache.flink.client.program.rest.RestClusterClient;</span>
  32  import org.apache.flink.configuration.Configuration;
  33  import org.apache.flink.configuration.GlobalConfiguration;
  34  import org.apache.flink.configuration.JobManagerOptions;
  35  import org.apache.flink.core.fs.FileSystem;
  36  import org.apache.flink.runtime.akka.AkkaUtils;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import org.apache.flink.runtime.minicluster.MiniCluster;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;</span>
  39  import org.apache.flink.runtime.util.LeaderConnectionInfo;
  40  import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  41  import org.apache.flink.yarn.YarnClusterDescriptor;
  42  import org.apache.hadoop.yarn.api.records.ApplicationId;
  43  import org.apache.hadoop.yarn.api.records.ApplicationReport;
  44  import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  45  import org.apache.hadoop.yarn.client.api.YarnClient;
  46  import org.apache.hadoop.yarn.conf.YarnConfiguration;
  47  import org.apache.hadoop.yarn.util.StringHelper;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +import org.slf4j.LoggerFactory;</span>
  50  
  51  import java.net.InetSocketAddress;
  52  import java.net.URLDecoder;
  53  import java.util.EnumSet;
  54  import java.util.HashSet;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -import java.util.Iterator;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +import java.util.Set;</span>
  57  import java.util.List;
  58  import java.util.Properties;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -import java.util.Set;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +import java.util.Iterator;</span>
  61  
  62  /**
  63   * @author sishu.yss
  64   */
  65  public class ClusterClientFactory {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +    private static final Logger LOG = LoggerFactory.getLogger(ClusterClientFactory.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +    private static final String HA_CLUSTER_ID = &quot;high-availability.cluster-id&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +    private static final String HIGH_AVAILABILITY = &quot;high-availability&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +    private static final String NODE = &quot;NONE&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +    private static final String ZOOKEEPER = &quot;zookeeper&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +    private static final String HADOOP_CONF = &quot;fs.hdfs.hadoopconf&quot;;</span>
  78  
  79      public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  80          String mode = launcherOptions.getMode();
  81          if (mode.equals(ClusterMode.standalone.name())) {
  82              return createStandaloneClient(launcherOptions);
  83          } else if (mode.equals(ClusterMode.yarn.name())) {
  84              return createYarnSessionClient(launcherOptions);
  85          }
  86          throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  87      }
  88  
  89      public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  90          String flinkConfDir = launcherOptions.getFlinkconf();
  91          Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -        configBuilder.setConfiguration(config);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -        MiniCluster miniCluster = new MiniCluster(configBuilder.build());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -        MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +        LOG.info(&quot;------------config params-------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +        config.toMap().forEach((key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +        LOG.info(&quot;-------------------------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +        RestClusterClient clusterClient = new RestClusterClient&lt;&gt;(config, &quot;clusterClient&quot;);</span>
 102          LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
 103          InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());
 104          config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
 105          config.setInteger(JobManagerOptions.PORT, address.getPort());
 106          clusterClient.setDetached(true);
 107          return clusterClient;
 108      }
 109  
 110      public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title=" 111          String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();"> 111          String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkcðŸ”µ</abbr>
<abbr title=" 112          Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);"> 112          Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadCðŸ”µ</abbr>
 113          String yarnConfDir = launcherOptions.getYarnconf();
 114  
 115          if (StringUtils.isNotBlank(yarnConfDir)) {
 116              try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -                config.setString(&quot;fs.hdfs.hadoopconf&quot;, yarnConfDir);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +                boolean isHighAvailability;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +                config.setString(HADOOP_CONF, yarnConfDir);</span>
 121                  FileSystem.initialize(config);
 122  
 123                  YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
 124                  YarnClient yarnClient = YarnClient.createYarnClient();
 125                  yarnClient.init(yarnConf);
 126                  yarnClient.start();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -                ApplicationId applicationId = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +                ApplicationId applicationId;</span>
 129  
 130                  String yarnSessionConf = launcherOptions.getYarnSessionConf();
 131                  yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 132                  Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 132                  Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.clasðŸ”µ</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +</span>
 134                  Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 135  
 136                  if (null != yid) {
 137                      applicationId = toApplicationId(yid.toString());
 138                  } else {
 139                      applicationId = getYarnClusterApplicationId(yarnClient);
 140                  }
 141  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -                Log.info(&quot;applicationId={}&quot;, applicationId.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +                LOG.info(&quot;current applicationId = {}&quot;, applicationId.toString());</span>
 144  
 145                  if (StringUtils.isEmpty(applicationId.toString())) {
 146                      throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 147                  }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +                isHighAvailability = config.getString(HIGH_AVAILABILITY, NODE).equals(ZOOKEEPER);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +                if (isHighAvailability &amp;&amp; config.getString(HA_CLUSTER_ID, null) == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +                    config.setString(HA_CLUSTER_ID, applicationId.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +                LOG.info(&quot;------------config params-------------------------&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +                config.toMap().forEach((key, value) -&gt; LOG.info(&quot;{}: {}&quot;, key, value));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +                LOG.info(&quot;-------------------------------------------&quot;);</span>
 158  
<abbr title=" 159                  AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 159                  AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinðŸ”µ</abbr>
 160                  ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 161                  clusterClient.setDetached(true);
 162                  return clusterClient;
 163              } catch (Exception e) {
 164                  throw new RuntimeException(e);
 165              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -        }else{</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +        } else {</span>
 168              throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 169          }
 170      }
 171  
 172  
 173      private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 174          ApplicationId applicationId = null;
 175  
 176          Set&lt;String&gt; set = new HashSet&lt;&gt;();
 177          set.add(&quot;Apache Flink&quot;);
 178          EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 179          enumSet.add(YarnApplicationState.RUNNING);
 180          List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 181  
 182          int maxMemory = -1;
 183          int maxCores = -1;
 184          for (ApplicationReport report : reportList) {
 185              if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 186                  continue;
 187              }
 188  
 189              if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 190                  continue;
 191              }
 192  
 193              int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
 194              int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();
 195              if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {
 196                  maxMemory = thisMemory;
 197                  maxCores = thisCores;
 198                  applicationId = report.getApplicationId();
 199              }
 200  
 201          }
 202  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -        if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +        if (applicationId == null || StringUtils.isEmpty(applicationId.toString())) {</span>
 205              throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 206          }
 207          return applicationId;
 208      }
 209  
 210      private static ApplicationId toApplicationId(String appIdStr) {
 211          Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
 212          if (!&quot;application&quot;.equals(it.next())) {
<abbr title=" 213              throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 213              throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicatðŸ”µ</abbr>
 214          } else {
 215              try {
 216                  return toApplicationId(it);
 217              } catch (NumberFormatException e) {
 218                  throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 219              }
 220          }
 221      }
 222  
 223      private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 224          return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 225      }
 226  
 227  }</pre></td>
                            <td><pre>   1  /**
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *

  10   * http://www.apache.org/licenses/LICENSE-2.0
  11   *

  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.launcher;
  20  
  21  import com.dtstack.flink.sql.enums.ClusterMode;
  22  import com.dtstack.flink.sql.option.Options;
  23  import com.dtstack.flink.sql.util.PluginUtil;
  24  import com.esotericsoftware.minlog.Log;
  25  import org.apache.commons.io.Charsets;
  26  import org.apache.commons.lang.StringUtils;
  27  import org.apache.flink.client.program.ClusterClient;
  28  import org.apache.flink.client.program.MiniClusterClient;

  29  import org.apache.flink.configuration.Configuration;
  30  import org.apache.flink.configuration.GlobalConfiguration;
  31  import org.apache.flink.configuration.JobManagerOptions;
  32  import org.apache.flink.core.fs.FileSystem;
  33  import org.apache.flink.runtime.akka.AkkaUtils;
  34  import org.apache.flink.runtime.minicluster.MiniCluster;
  35  import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;
  36  import org.apache.flink.runtime.util.LeaderConnectionInfo;
  37  import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  38  import org.apache.flink.yarn.YarnClusterDescriptor;
  39  import org.apache.hadoop.yarn.api.records.ApplicationId;
  40  import org.apache.hadoop.yarn.api.records.ApplicationReport;
  41  import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  42  import org.apache.hadoop.yarn.client.api.YarnClient;
  43  import org.apache.hadoop.yarn.conf.YarnConfiguration;
  44  import org.apache.hadoop.yarn.util.StringHelper;


  45  
  46  import java.net.InetSocketAddress;
  47  import java.net.URLDecoder;
  48  import java.util.EnumSet;
  49  import java.util.HashSet;
  50  import java.util.Iterator;

  51  import java.util.List;
  52  import java.util.Properties;
  53  import java.util.Set;

  54  
  55  /**
  56   * @author sishu.yss
  57   */
  58  public class ClusterClientFactory {












  59  
  60      public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  61          String mode = launcherOptions.getMode();
  62          if (mode.equals(ClusterMode.standalone.name())) {
  63              return createStandaloneClient(launcherOptions);
  64          } else if (mode.equals(ClusterMode.yarn.name())) {
  65              return createYarnSessionClient(launcherOptions);
  66          }
  67          throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  68      }
  69  
  70      public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  71          String flinkConfDir = launcherOptions.getFlinkconf();
  72          Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
  73          MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();
  74          configBuilder.setConfiguration(config);
  75          MiniCluster miniCluster = new MiniCluster(configBuilder.build());
  76          MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);






  77          LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
  78          InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());
  79          config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
  80          config.setInteger(JobManagerOptions.PORT, address.getPort());
  81          clusterClient.setDetached(true);
  82          return clusterClient;
  83      }
  84  
  85      public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title="  86          String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();">  86          String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkcðŸ”µ</abbr>
<abbr title="  87          Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);">  87          Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadCðŸ”µ</abbr>
  88          String yarnConfDir = launcherOptions.getYarnconf();
  89  
  90          if (StringUtils.isNotBlank(yarnConfDir)) {
  91              try {
  92                  config.setString(&quot;fs.hdfs.hadoopconf&quot;, yarnConfDir);



  93                  FileSystem.initialize(config);
  94  
  95                  YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
  96                  YarnClient yarnClient = YarnClient.createYarnClient();
  97                  yarnClient.init(yarnConf);
  98                  yarnClient.start();
  99                  ApplicationId applicationId = null;

 100  
 101                  String yarnSessionConf = launcherOptions.getYarnSessionConf();
 102                  yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 103                  Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 103                  Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.clasðŸ”µ</abbr>

 104                  Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 105  
 106                  if (null != yid) {
 107                      applicationId = toApplicationId(yid.toString());
 108                  } else {
 109                      applicationId = getYarnClusterApplicationId(yarnClient);
 110                  }
 111  
 112                  Log.info(&quot;applicationId={}&quot;, applicationId.toString());

 113  
 114                  if (StringUtils.isEmpty(applicationId.toString())) {
 115                      throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 116                  }










 117  
<abbr title=" 118                  AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 118                  AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinðŸ”µ</abbr>
 119                  ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 120                  clusterClient.setDetached(true);
 121                  return clusterClient;
 122              } catch (Exception e) {
 123                  throw new RuntimeException(e);
 124              }
 125          }else{

 126              throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 127          }
 128      }
 129  
 130  
 131      private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 132          ApplicationId applicationId = null;
 133  
 134          Set&lt;String&gt; set = new HashSet&lt;&gt;();
 135          set.add(&quot;Apache Flink&quot;);
 136          EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 137          enumSet.add(YarnApplicationState.RUNNING);
 138          List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 139  
 140          int maxMemory = -1;
 141          int maxCores = -1;
 142          for (ApplicationReport report : reportList) {
 143              if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 144                  continue;
 145              }
 146  
 147              if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 148                  continue;
 149              }
 150  
 151              int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
 152              int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();
 153              if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {
 154                  maxMemory = thisMemory;
 155                  maxCores = thisCores;
 156                  applicationId = report.getApplicationId();
 157              }
 158  
 159          }
 160  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -        if (StringUtils.isEmpty(applicationId.toString())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +        if (null == applicationId) {</span>
 163              throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 164          }
 165          return applicationId;
 166      }
 167  
 168      private static ApplicationId toApplicationId(String appIdStr) {
 169          Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
 170          if (!&quot;application&quot;.equals(it.next())) {
<abbr title=" 171              throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 171              throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicatðŸ”µ</abbr>
 172          } else {
 173              try {
 174                  return toApplicationId(it);
 175              } catch (NumberFormatException e) {
 176                  throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 177              }
 178          }
 179      }
 180  
 181      private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 182          return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 183      }
 184  
 185  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            