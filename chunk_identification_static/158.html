<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>158</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    158
                    <a href="157.html">prev</a>
                    <a href="159.html">next</a>
                    <a href="158_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_49fa8befbd7cfe6eb217aa321a7ab150b4119af6_Simplenote/src/main/java/com/automattic/simplenote/TagsListFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;49fa8befbd7cfe6eb217aa321a7ab150b4119af6:Simplenote/src/main/java/com/automattic/simplenote/TagsListFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;49fa8befbd7cfe6eb217aa321a7ab150b4119af6^1:Simplenote/src/main/java/com/automattic/simplenote/TagsListFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;49fa8befbd7cfe6eb217aa321a7ab150b4119af6^2:Simplenote/src/main/java/com/automattic/simplenote/TagsListFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;604432beb5628c170c1160ff7424a1816ec1a72d:Simplenote/src/main/java/com/automattic/simplenote/TagsListFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Fragment;
   4 import android.content.Context;
   5 import android.content.DialogInterface;
   6 import android.database.Cursor;
   7 import android.os.AsyncTask;
   8 import android.os.Bundle;
   9 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  10 import android.support.annotation.NonNull;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  11 import android.support.v7.app.AlertDialog;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  12 import android.support.v7.widget.DividerItemDecoration;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  13 import android.support.v7.widget.LinearLayoutManager;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  14 import android.support.v7.widget.RecyclerView;</span>
  15 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16 import android.support.annotation.NonNull;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17 import android.support.v7.app.AlertDialog;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18 import android.view.ActionMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19 import android.view.LayoutInflater;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 import android.view.Menu;</span>
  21 =======
  22 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  23 import android.view.ActionMode;
  24 import android.view.LayoutInflater;
  25 import android.view.Menu;
  26 import android.view.MenuInflater;
  27 import android.view.MenuItem;
  28 import android.view.View;
  29 import android.view.ViewGroup;
  30 import android.widget.EditText;
  31 import android.widget.ImageButton;
  32 import android.widget.LinearLayout;
  33 import android.widget.TextView;
  34 
  35 import androidx.annotation.NonNull;
  36 import androidx.appcompat.app.AlertDialog;
  37 
  38 import com.automattic.simplenote.analytics.AnalyticsTracker;
  39 import com.automattic.simplenote.models.Note;
  40 import com.automattic.simplenote.models.Tag;
  41 import com.automattic.simplenote.utils.BaseCursorAdapter;
  42 import com.automattic.simplenote.utils.HtmlCompat;
  43 import com.simperium.client.Bucket;
  44 import com.simperium.client.BucketObjectNameInvalid;
  45 import com.simperium.client.Query;
  46 
  47 import java.util.List;
  48 
  49 public class TagsListFragment extends Fragment implements ActionMode.Callback, Bucket.Listener&lt;Tag&gt; {
  50 
  51     private ActionMode mActionMode;
  52     private Bucket&lt;Tag&gt; mTagsBucket;
  53     private Bucket&lt;Note&gt; mNotesBucket;
  54     private TagsAdapter mTagsAdapter;
  55 
  56     /**
  57      * Mandatory empty constructor for the fragment manager to instantiate the
  58      * fragment (e.g. upon screen orientation changes).
  59      */
  60     public TagsListFragment() {
  61     }
  62 
  63     @Override
<abbr title="  64     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {">  64     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceSðŸ”µ</abbr>
  65         View view = inflater.inflate(R.layout.fragment_tags_list, container, false);
  66 
  67         TextView emptyTextView = view.findViewById(android.R.id.empty);
<abbr title="  68         emptyTextView.setText(HtmlCompat.fromHtml(&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found) + &quot;&lt;/strong&gt;&quot;));">  68         emptyTextView.setText(HtmlCompat.fromHtml(&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found) + &quot;&lt;/strðŸ”µ</abbr>
  69         return view;
  70     }
  71 
  72     @Override
  73     public void onActivityCreated(Bundle savedInstanceState) {
  74         super.onActivityCreated(savedInstanceState);
  75 
  76         setHasOptionsMenu(true);
  77 
  78         Simplenote application = (Simplenote) getActivity().getApplication();
  79         mTagsBucket = application.getTagsBucket();
  80         mNotesBucket = application.getNotesBucket();
  81 
  82         RecyclerView recyclerView = getActivity().findViewById(R.id.tagList);
  83         mTagsAdapter = new TagsAdapter();
  84         recyclerView.setAdapter(mTagsAdapter);
  85         recyclerView.setLayoutManager(new LinearLayoutManager(getActivity()));
<abbr title="  86         recyclerView.addItemDecoration(new DividerItemDecoration(recyclerView.getContext(), DividerItemDecoration.VERTICAL));">  86         recyclerView.addItemDecoration(new DividerItemDecoration(recyclerView.getContext(), DividerItemDeðŸ”µ</abbr>
  87 
  88         refreshTags();
  89     }
  90 
  91     @Override
  92     public void onResume() {
  93         super.onResume();
  94 
  95         mNotesBucket.start();
  96         mTagsBucket.start();
  97 
  98         mTagsBucket.addOnNetworkChangeListener(this);
  99         mTagsBucket.addOnSaveObjectListener(this);
 100         mTagsBucket.addOnDeleteObjectListener(this);
 101     }
 102 
 103     @Override
 104     public void onPause() {
 105         super.onPause();
 106 
 107         mTagsBucket.removeOnNetworkChangeListener(this);
 108         mTagsBucket.removeOnSaveObjectListener(this);
 109         mTagsBucket.removeOnDeleteObjectListener(this);
 110 
 111         mNotesBucket.stop();
 112         mTagsBucket.stop();
 113     }
 114 
 115     protected void refreshTags() {
<abbr title=" 116         Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAME);"> 116         Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAðŸ”µ</abbr>
 117         Bucket.ObjectCursor&lt;Tag&gt; cursor = tagQuery.execute();
 118         mTagsAdapter.swapCursor(cursor);
 119     }
 120 
 121     // TODO: Finish bulk editing
 122     @Override
 123     public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 124         MenuInflater inflater = actionMode.getMenuInflater();
 125         inflater.inflate(R.menu.bulk_edit, menu);
 126         mActionMode = actionMode;
 127         return true;
 128     }
 129 
 130     @Override
 131     public boolean onPrepareActionMode(ActionMode actionMode, Menu menu) {
 132         return false;
 133     }
 134 
 135     @Override
 136     public boolean onActionItemClicked(ActionMode actionMode, MenuItem menuItem) {
 137         if (menuItem.getItemId() == R.id.menu_delete) {
 138             actionMode.finish(); // Action picked, so close the CAB
 139             return true;
 140         }
 141         return false;
 142     }
 143 
 144     @Override
 145     public void onDestroyActionMode(ActionMode actionMode) {
 146         mActionMode = null;
 147     }
 148 
 149     @Override
 150     public boolean onOptionsItemSelected(MenuItem item) {
 151 
 152         if (item.getItemId() == android.R.id.home) {
 153             if (isAdded()) {
 154                 getActivity().finish();
 155                 return true;
 156             }
 157         }
 158 
 159         return super.onOptionsItemSelected(item);
 160     }
 161 
 162     // Tag Bucket listeners
 163     @Override
 164     public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 165         if (isAdded()) {
 166             getActivity().runOnUiThread(new Runnable() {
 167                 @Override
 168                 public void run() {
 169                     refreshTags();
 170                 }
 171             });
 172         }
 173     }
 174 
 175     @Override
 176     public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 177         if (isAdded()) {
 178             getActivity().runOnUiThread(new Runnable() {
 179                 @Override
 180                 public void run() {
 181                     refreshTags();
 182                 }
 183             });
 184         }
 185     }
 186 
 187     @Override
 188     public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 189         if (isAdded()) {
 190             getActivity().runOnUiThread(new Runnable() {
 191                 @Override
 192                 public void run() {
 193                     refreshTags();
 194                 }
 195             });
 196         }
 197     }
 198 
 199     @Override
 200     public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 201         // noop
 202     }
 203 
 204     private class removeTagFromNotesTask extends AsyncTask&lt;Tag, Void, Void&gt; {
 205 
 206         @Override
 207         protected Void doInBackground(Tag... removedTags) {
 208             Tag tag = removedTags[0];
 209             if (tag != null) {
 210                 Bucket.ObjectCursor&lt;Note&gt; notesCursor = tag.findNotes(mNotesBucket);
 211                 while (notesCursor.moveToNext()) {
 212                     Note note = notesCursor.getObject();
 213                     List&lt;String&gt; tags = note.getTags();
 214                     tags.remove(tag.getName());
 215                     note.setTags(tags);
 216                     note.save();
 217                 }
 218                 notesCursor.close();
 219             }
 220             return null;
 221         }
 222     }
 223 
 224     private class TagsAdapter extends BaseCursorAdapter&lt;TagsAdapter.ViewHolder&gt; {
 225 
 226         public class ViewHolder extends RecyclerView.ViewHolder implements View.OnClickListener {
 227 
 228             private TextView tagTitle;
 229             private TextView tagCountTextView;
 230             private ImageButton deleteButton;
 231 
 232             private ViewHolder(View itemView) {
 233                 super(itemView);
 234 
 235                 tagTitle = itemView.findViewById(R.id.tag_name);
 236                 tagCountTextView = itemView.findViewById(R.id.tag_count);
 237                 deleteButton = itemView.findViewById(R.id.tag_trash);
 238 
 239                 deleteButton.setOnClickListener(new View.OnClickListener() {
 240                     @Override
 241                     public void onClick(View view) {
 242                         if (!isAdded()) return;
 243 
<abbr title=" 244                         final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObject();"> 244                         final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObjeðŸ”µ</abbr>
<abbr title=" 245                         final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 245                         final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAðŸ”µ</abbr>
 246                         if (tagCount == 0) {
 247                             deleteTag(tag);
 248                         } else if (tagCount &gt; 0) {
 249                             AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());
 250                             alert.setTitle(R.string.delete_tag);
 251                             alert.setMessage(getString(R.string.confirm_delete_tag));
 252                             alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 253                                 public void onClick(DialogInterface dialog, int whichButton) {
 254                                     deleteTag(tag);
 255                                 }
 256                             });
 257                             alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 258                                 public void onClick(DialogInterface dialog, int whichButton) {
 259                                     // Do nothing, just closing the dialog
 260                                 }
 261                             });
 262                             alert.show();
 263                         }
 264                     }
 265                 });
 266 
 267                 itemView.setOnClickListener(this);
 268             }
 269 
 270             @Override
 271             public void onClick(View view) {
 272                 if (!isAdded()) return;
 273 
 274                 final AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());
<abbr title=" 275                 LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layout.edit_tag, null);"> 275                 LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layouðŸ”µ</abbr>
 276 
 277                 final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObject();
 278 
 279                 final EditText tagNameEditText = alertView.findViewById(R.id.tag_name_edit);
 280                 tagNameEditText.setText(tag.getName());
 281                 tagNameEditText.setSelection(tagNameEditText.length());
 282                 alert.setView(alertView);
 283                 alert.setTitle(R.string.rename_tag);
 284                 alert.setPositiveButton(R.string.save, new DialogInterface.OnClickListener() {
 285                     public void onClick(DialogInterface dialog, int whichButton) {
 286                         String value = tagNameEditText.getText().toString().trim();
 287                         try {
 288                             tag.renameTo(value, mNotesBucket);
 289                             AnalyticsTracker.track(
 290                                     AnalyticsTracker.Stat.TAG_EDITOR_ACCESSED,
 291                                     AnalyticsTracker.CATEGORY_TAG,
 292                                     &quot;tag_alert_edit_box&quot;
 293                             );
 294                         } catch (BucketObjectNameInvalid e) {
 295                             android.util.Log.e(Simplenote.TAG, &quot;Unable to rename tag&quot;, e);
 296                             // TODO: show user a message that new tag name is not ok
 297                         }
 298                     }
 299                 });
 300                 alert.setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() {
 301                     public void onClick(DialogInterface dialog, int whichButton) {
 302                         // Do nothing
 303                     }
 304                 });
 305                 alert.show();
 306             }
 307 
 308             private void deleteTag(Tag tag) {
 309                 tag.delete();
 310                 new removeTagFromNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, tag);
 311                 AnalyticsTracker.track(
 312                         AnalyticsTracker.Stat.TAG_MENU_DELETED,
 313                         AnalyticsTracker.CATEGORY_TAG,
 314                         &quot;list_trash_button&quot;
 315                 );
 316             }
 317         }
 318 
 319         private TagsAdapter() {
 320             super(null);
 321         }
 322 
 323         @NonNull
 324         @Override
 325         public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
 326             Context context = parent.getContext();
 327             LayoutInflater inflater = LayoutInflater.from(context);
 328 
 329             View contactView = inflater.inflate(R.layout.tags_list_row, parent, false);
 330 
 331             return new ViewHolder(contactView);
 332         }
 333 
 334         @Override
 335         public void onBindViewHolder(@NonNull ViewHolder holder, Cursor cursor) {
 336             Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)cursor).getObject();
 337 
 338             holder.tagTitle.setText(tag.getName());
<abbr title=" 339             final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 339             final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.geðŸ”µ</abbr>
 340             if (tagCount &gt; 0) {
 341                 holder.tagCountTextView.setText(String.valueOf(tagCount));
 342             } else {
 343                 holder.tagCountTextView.setText(&quot;&quot;);
 344             }
 345         }
 346 
 347         @Override
 348         public void swapCursor(Cursor newCursor) {
 349             super.swapCursor(newCursor);
 350         }
 351     }
 352 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Fragment;
   4 import android.content.Context;
   5 import android.content.DialogInterface;
   6 import android.database.Cursor;
   7 import android.os.AsyncTask;
   8 import android.os.Bundle;
   9 import android.support.v7.widget.DividerItemDecoration;
  10 import android.support.v7.widget.LinearLayoutManager;
  11 import android.support.v7.widget.RecyclerView;
  12 import android.view.ActionMode;
  13 import android.view.LayoutInflater;
  14 import android.view.Menu;
  15 import android.view.MenuInflater;
  16 import android.view.MenuItem;
  17 import android.view.View;
  18 import android.view.ViewGroup;
  19 import android.widget.EditText;
  20 import android.widget.ImageButton;
  21 import android.widget.LinearLayout;
  22 import android.widget.TextView;
  23 
  24 import androidx.annotation.NonNull;
  25 import androidx.appcompat.app.AlertDialog;
  26 
  27 import com.automattic.simplenote.analytics.AnalyticsTracker;
  28 import com.automattic.simplenote.models.Note;
  29 import com.automattic.simplenote.models.Tag;
  30 import com.automattic.simplenote.utils.BaseCursorAdapter;
  31 import com.automattic.simplenote.utils.HtmlCompat;
  32 import com.simperium.client.Bucket;
  33 import com.simperium.client.BucketObjectNameInvalid;
  34 import com.simperium.client.Query;
  35 
  36 import java.util.List;
  37 
  38 public class TagsListFragment extends Fragment implements ActionMode.Callback, Bucket.Listener&lt;Tag&gt; {
  39 
  40     private ActionMode mActionMode;
  41     private Bucket&lt;Tag&gt; mTagsBucket;
  42     private Bucket&lt;Note&gt; mNotesBucket;
  43     private TagsAdapter mTagsAdapter;
  44 
  45     /**
  46      * Mandatory empty constructor for the fragment manager to instantiate the
  47      * fragment (e.g. upon screen orientation changes).
  48      */
  49     public TagsListFragment() {
  50         }
  51 
  52     @Override
<abbr title="  53     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {">  53     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceSðŸ”µ</abbr>
  54         View view = inflater.inflate(R.layout.fragment_tags_list, container, false);
  55 
  56         TextView emptyTextView = view.findViewById(android.R.id.empty);
<abbr title="  57         emptyTextView.setText(HtmlCompat.fromHtml(&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found) + &quot;&lt;/strong&gt;&quot;));">  57         emptyTextView.setText(HtmlCompat.fromHtml(&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found) + &quot;&lt;/strðŸ”µ</abbr>
  58         return view;
  59     }
  60 
  61     @Override
  62     public void onActivityCreated(Bundle savedInstanceState) {
  63         super.onActivityCreated(savedInstanceState);
  64 
  65         setHasOptionsMenu(true);
  66 
  67         Simplenote application = (Simplenote) getActivity().getApplication();
  68         mTagsBucket = application.getTagsBucket();
  69         mNotesBucket = application.getNotesBucket();
  70 
  71         RecyclerView recyclerView = getActivity().findViewById(R.id.tagList);
  72         mTagsAdapter = new TagsAdapter();
  73         recyclerView.setAdapter(mTagsAdapter);
  74         recyclerView.setLayoutManager(new LinearLayoutManager(getActivity()));
<abbr title="  75         recyclerView.addItemDecoration(new DividerItemDecoration(recyclerView.getContext(), DividerItemDecoration.VERTICAL));">  75         recyclerView.addItemDecoration(new DividerItemDecoration(recyclerView.getContext(), DividerItemDeðŸ”µ</abbr>
  76 
  77         refreshTags();
  78     }
  79 
  80     @Override
  81     public void onResume() {
  82         super.onResume();
  83 
  84         mNotesBucket.start();
  85         mTagsBucket.start();
  86 
  87         mTagsBucket.addOnNetworkChangeListener(this);
  88         mTagsBucket.addOnSaveObjectListener(this);
  89         mTagsBucket.addOnDeleteObjectListener(this);
  90     }
  91 
  92     @Override
  93     public void onPause() {
  94         super.onPause();
  95 
  96         mTagsBucket.removeOnNetworkChangeListener(this);
  97         mTagsBucket.removeOnSaveObjectListener(this);
  98         mTagsBucket.removeOnDeleteObjectListener(this);
  99 
 100         mNotesBucket.stop();
 101         mTagsBucket.stop();
 102     }
 103 
 104     protected void refreshTags() {
<abbr title=" 105         Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAME);"> 105         Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAðŸ”µ</abbr>
 106         Bucket.ObjectCursor&lt;Tag&gt; cursor = tagQuery.execute();
 107         mTagsAdapter.swapCursor(cursor);
 108     }
 109 
 110     // TODO: Finish bulk editing
 111     @Override
 112     public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 113         MenuInflater inflater = actionMode.getMenuInflater();
 114         inflater.inflate(R.menu.bulk_edit, menu);
 115         mActionMode = actionMode;
 116         return true;
 117     }
 118 
 119     @Override
 120     public boolean onPrepareActionMode(ActionMode actionMode, Menu menu) {
 121         return false;
 122     }
 123 
 124     @Override
 125     public boolean onActionItemClicked(ActionMode actionMode, MenuItem menuItem) {
 126         if (menuItem.getItemId() == R.id.menu_delete) {
 127             actionMode.finish(); // Action picked, so close the CAB
 128             return true;
 129         }
 130         return false;
 131     }
 132 
 133     @Override
 134     public void onDestroyActionMode(ActionMode actionMode) {
 135         mActionMode = null;
 136     }
 137 
 138     @Override
 139     public boolean onOptionsItemSelected(MenuItem item) {
 140 
 141         if (item.getItemId() == android.R.id.home) {
 142             if (isAdded()) {
 143                 getActivity().finish();
 144                 return true;
 145             }
 146         }
 147 
 148         return super.onOptionsItemSelected(item);
 149     }
 150 
 151     // Tag Bucket listeners
 152     @Override
 153     public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 154         if (isAdded()) {
 155             getActivity().runOnUiThread(new Runnable() {
 156                 @Override
 157                 public void run() {
 158                     refreshTags();
 159                 }
 160             });
 161         }
 162     }
 163 
 164     @Override
 165     public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 166         if (isAdded()) {
 167             getActivity().runOnUiThread(new Runnable() {
 168                 @Override
 169                 public void run() {
 170                     refreshTags();
 171                 }
 172             });
 173         }
 174     }
 175 
 176     @Override
 177     public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 178         if (isAdded()) {
 179             getActivity().runOnUiThread(new Runnable() {
 180                 @Override
 181                 public void run() {
 182                     refreshTags();
 183                 }
 184             });
 185         }
 186     }
 187 
 188     @Override
 189     public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 190         // noop
 191     }
 192 
 193     private class TagsAdapter extends BaseCursorAdapter&lt;TagsAdapter.ViewHolder&gt; {
 194 
 195         public class ViewHolder extends RecyclerView.ViewHolder implements View.OnClickListener {
 196 
 197             private TextView tagTitle;
 198             private TextView tagCountTextView;
 199             private ImageButton deleteButton;
 200 
 201             private ViewHolder(View itemView) {
 202                 super(itemView);
 203 
 204                 tagTitle = itemView.findViewById(R.id.tag_name);
 205                 tagCountTextView = itemView.findViewById(R.id.tag_count);
 206                 deleteButton = itemView.findViewById(R.id.tag_trash);
 207 
 208                 deleteButton.setOnClickListener(new View.OnClickListener() {
 209                     @Override
 210                     public void onClick(View view) {
 211                         if (!isAdded()) return;
 212 
<abbr title=" 213                         final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObject();"> 213                         final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObjeðŸ”µ</abbr>
<abbr title=" 214                         final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 214                         final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAðŸ”µ</abbr>
 215                         if (tagCount == 0) {
 216                             deleteTag(tag);
 217                         } else if (tagCount &gt; 0) {
 218                             AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());
 219                             alert.setTitle(R.string.delete_tag);
 220                             alert.setMessage(getString(R.string.confirm_delete_tag));
 221                             alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 222                                 public void onClick(DialogInterface dialog, int whichButton) {
 223                                     deleteTag(tag);
 224                                 }
 225                             });
 226                             alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 227                                 public void onClick(DialogInterface dialog, int whichButton) {
 228                                     // Do nothing, just closing the dialog
 229                                 }
 230                             });
 231                             alert.show();
 232                         }
 233                     }
 234                 });
 235 
 236                 itemView.setOnClickListener(this);
 237             }
 238 
 239             @Override
 240             public void onClick(View view) {
 241                 if (!isAdded()) return;
 242 
 243                 final AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());
<abbr title=" 244                 LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layout.edit_tag, null);"> 244                 LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layouðŸ”µ</abbr>
 245 
 246                 final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObject();
 247 
 248                 final EditText tagNameEditText = alertView.findViewById(R.id.tag_name_edit);
 249                 tagNameEditText.setText(tag.getName());
 250                 tagNameEditText.setSelection(tagNameEditText.length());
 251                 alert.setView(alertView);
 252                 alert.setTitle(R.string.rename_tag);
 253                 alert.setPositiveButton(R.string.save, new DialogInterface.OnClickListener() {
 254                     public void onClick(DialogInterface dialog, int whichButton) {
 255                         String value = tagNameEditText.getText().toString().trim();
 256                         try {
 257                             tag.renameTo(value, mNotesBucket);
 258                             AnalyticsTracker.track(
 259                                     AnalyticsTracker.Stat.TAG_EDITOR_ACCESSED,
 260                                     AnalyticsTracker.CATEGORY_TAG,
 261                                     &quot;tag_alert_edit_box&quot;
 262                             );
 263                         } catch (BucketObjectNameInvalid e) {
 264                             android.util.Log.e(Simplenote.TAG, &quot;Unable to rename tag&quot;, e);
 265                             // TODO: show user a message that new tag name is not ok
 266                         }
 267                     }
 268                 });
 269                 alert.setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() {
 270                     public void onClick(DialogInterface dialog, int whichButton) {
 271                         // Do nothing
 272                     }
 273                 });
 274                 alert.show();
 275             }
 276 
 277             private void deleteTag(Tag tag) {
 278                 tag.delete();
 279                 new removeTagFromNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, tag);
 280                 AnalyticsTracker.track(
 281                         AnalyticsTracker.Stat.TAG_MENU_DELETED,
 282                         AnalyticsTracker.CATEGORY_TAG,
 283                         &quot;list_trash_button&quot;
 284                 );
 285             }
 286         }
 287 
 288         private TagsAdapter() {
 289             super(null);
 290         }
 291 
 292         @NonNull
 293         @Override
 294         public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
 295             Context context = parent.getContext();
 296             LayoutInflater inflater = LayoutInflater.from(context);
 297 
 298             View contactView = inflater.inflate(R.layout.tags_list_row, parent, false);
 299 
 300             return new ViewHolder(contactView);
 301         }
 302 
 303         @Override
 304         public void onBindViewHolder(@NonNull ViewHolder holder, Cursor cursor) {
 305             Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)cursor).getObject();
 306 
 307             holder.tagTitle.setText(tag.getName());
<abbr title=" 308             final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 308             final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.geðŸ”µ</abbr>
 309             if (tagCount &gt; 0) {
 310                 holder.tagCountTextView.setText(String.valueOf(tagCount));
 311             } else {
 312                 holder.tagCountTextView.setText(&quot;&quot;);
 313             }
 314         }
 315 
 316         @Override
 317         public void swapCursor(Cursor newCursor) {
 318             super.swapCursor(newCursor);
 319         }
 320     }
 321 
 322     private class removeTagFromNotesTask extends AsyncTask&lt;Tag, Void, Void&gt; {
 323 
 324         @Override
 325         protected Void doInBackground(Tag... removedTags) {
 326             Tag tag = removedTags[0];
 327             if (tag != null) {
 328                 Bucket.ObjectCursor&lt;Note&gt; notesCursor = tag.findNotes(mNotesBucket);
 329                 while (notesCursor.moveToNext()) {
 330                     Note note = notesCursor.getObject();
 331                     List&lt;String&gt; tags = note.getTags();
 332                     tags.remove(tag.getName());
 333                     note.setTags(tags);
 334                     note.save();
 335                 }
 336                 notesCursor.close();
 337             }
 338             return null;
 339         }
 340     }
 341 }
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Fragment;
   4 import android.content.Context;
   5 import android.content.DialogInterface;
   6 import android.database.Cursor;
   7 import android.os.AsyncTask;
   8 import android.os.Bundle;
   9 import android.support.v7.widget.DividerItemDecoration;
  10 import android.support.v7.widget.LinearLayoutManager;
  11 import android.support.v7.widget.RecyclerView;
  12 import android.view.ActionMode;
  13 import android.view.LayoutInflater;
  14 import android.view.Menu;
  15 import android.view.MenuInflater;
  16 import android.view.MenuItem;
  17 import android.view.View;
  18 import android.view.ViewGroup;
  19 import android.widget.EditText;
  20 import android.widget.ImageButton;
  21 import android.widget.LinearLayout;
  22 import android.widget.TextView;
  23 import androidx.annotation.NonNull;
  24 import androidx.appcompat.app.AlertDialog;
  25 import com.automattic.simplenote.analytics.AnalyticsTracker;
  26 import com.automattic.simplenote.models.Note;
  27 import com.automattic.simplenote.models.Tag;
  28 import com.automattic.simplenote.utils.BaseCursorAdapter;
  29 import com.automattic.simplenote.utils.HtmlCompat;
  30 import com.simperium.client.Bucket;
  31 import com.simperium.client.BucketObjectNameInvalid;
  32 import com.simperium.client.Query;
  33 import java.util.List;
  34 
  35 
  36 public class TagsListFragment extends Fragment implements ActionMode.Callback , Bucket.Listener&lt;Tag&gt; {
  37     private ActionMode mActionMode;
  38 
  39     private Bucket&lt;Tag&gt; mTagsBucket;
  40 
  41     private Bucket&lt;Note&gt; mNotesBucket;
  42 
  43     private TagsAdapter mTagsAdapter;
  44 
  45     /**
  46      * Mandatory empty constructor for the fragment manager to instantiate the
  47      * fragment (e.g. upon screen orientation changes).
  48      */
  49     public TagsListFragment() {
  50     }
  51 
  52     @Override
  53     public View onCreateView(@NonNull
  54     LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
  55         View view = inflater.inflate(R.layout.fragment_tags_list, container, false);
  56         TextView emptyTextView = view.findViewById(android.R.id.empty);
<abbr title="  57         emptyTextView.setText(HtmlCompat.fromHtml((&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found)) + &quot;&lt;/strong&gt;&quot;));">  57         emptyTextView.setText(HtmlCompat.fromHtml((&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found)) + &quot;&lt;/sðŸ”µ</abbr>
  58         return view;
  59     }
  60 
  61     @Override
  62     public void onActivityCreated(Bundle savedInstanceState) {
  63         super.onActivityCreated(savedInstanceState);
  64         setHasOptionsMenu(true);
  65         Simplenote application = ((Simplenote) (getActivity().getApplication()));
  66         mTagsBucket = application.getTagsBucket();
  67         mNotesBucket = application.getNotesBucket();
  68         RecyclerView recyclerView = getActivity().findViewById(R.id.tagList);
  69         mTagsAdapter = new TagsAdapter();
  70         recyclerView.setAdapter(mTagsAdapter);
  71         recyclerView.setLayoutManager(new LinearLayoutManager(getActivity()));
<abbr title="  72         recyclerView.addItemDecoration(new DividerItemDecoration(recyclerView.getContext(), DividerItemDecoration.VERTICAL));">  72         recyclerView.addItemDecoration(new DividerItemDecoration(recyclerView.getContext(), DividerItemDeðŸ”µ</abbr>
  73         refreshTags();
  74     }
  75 
  76     @Override
  77     public void onResume() {
  78         super.onResume();
  79         mNotesBucket.start();
  80         mTagsBucket.start();
  81         mTagsBucket.addOnNetworkChangeListener(this);
  82         mTagsBucket.addOnSaveObjectListener(this);
  83         mTagsBucket.addOnDeleteObjectListener(this);
  84     }
  85 
  86     @Override
  87     public void onPause() {
  88         super.onPause();
  89         mTagsBucket.removeOnNetworkChangeListener(this);
  90         mTagsBucket.removeOnSaveObjectListener(this);
  91         mTagsBucket.removeOnDeleteObjectListener(this);
  92         mNotesBucket.stop();
  93         mTagsBucket.stop();
  94     }
  95 
  96     protected void refreshTags() {
<abbr title="  97         Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAME);">  97         Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAðŸ”µ</abbr>
  98         Bucket.ObjectCursor&lt;Tag&gt; cursor = tagQuery.execute();
  99         mTagsAdapter.swapCursor(cursor);
 100     }
 101 
 102     // TODO: Finish bulk editing
 103     @Override
 104     public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 105         MenuInflater inflater = actionMode.getMenuInflater();
 106         inflater.inflate(R.menu.bulk_edit, menu);
 107         mActionMode = actionMode;
 108         return true;
 109     }
 110 
 111     @Override
 112     public boolean onPrepareActionMode(ActionMode actionMode, Menu menu) {
 113         return false;
 114     }
 115 
 116     @Override
 117     public boolean onActionItemClicked(ActionMode actionMode, MenuItem menuItem) {
 118         if (menuItem.getItemId() == R.id.menu_delete) {
 119             actionMode.finish(); // Action picked, so close the CAB
 120             return true;
 121         }
 122         return false;
 123     }
 124 
 125     @Override
 126     public void onDestroyActionMode(ActionMode actionMode) {
 127         mActionMode = null;
 128     }
 129 
 130     @Override
 131     public boolean onOptionsItemSelected(MenuItem item) {
 132         if (item.getItemId() == android.R.id.home) {
 133             if (isAdded()) {
 134                 getActivity().finish();
 135                 return true;
 136             }
 137         }
 138         return super.onOptionsItemSelected(item);
 139     }
 140 
 141     // Tag Bucket listeners
 142     @Override
 143     public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 144         if (isAdded()) {
 145             getActivity().runOnUiThread(new Runnable() {
 146                 @Override
 147                 public void run() {
 148                     refreshTags();
 149                 }
 150             });
 151         }
 152     }
 153 
 154     @Override
 155     public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 156         if (isAdded()) {
 157             getActivity().runOnUiThread(new Runnable() {
 158                 @Override
 159                 public void run() {
 160                     refreshTags();
 161                 }
 162             });
 163         }
 164     }
 165 
 166     @Override
 167     public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 168         if (isAdded()) {
 169             getActivity().runOnUiThread(new Runnable() {
 170                 @Override
 171                 public void run() {
 172                     refreshTags();
 173                 }
 174             });
 175         }
 176     }
 177 
 178     @Override
 179     public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 180         // noop
 181     }
 182 
 183     private class removeTagFromNotesTask extends AsyncTask&lt;Tag, Void, Void&gt; {
 184         @Override
 185         protected Void doInBackground(Tag... removedTags) {
 186             Tag tag = removedTags[0];
 187             if (tag != null) {
 188                 Bucket.ObjectCursor&lt;Note&gt; notesCursor = tag.findNotes(mNotesBucket);
 189                 while (notesCursor.moveToNext()) {
 190                     Note note = notesCursor.getObject();
 191                     List&lt;String&gt; tags = note.getTags();
 192                     tags.remove(tag.getName());
 193                     note.setTags(tags);
 194                     note.save();
 195                 }
 196                 notesCursor.close();
 197             }
 198             return null;
 199         }
 200     }
 201 
 202     private class TagsAdapter extends BaseCursorAdapter&lt;TagsAdapter.ViewHolder&gt; {
 203         public class ViewHolder extends RecyclerView.ViewHolder implements View.OnClickListener {
 204             private TextView tagTitle;
 205 
 206             private TextView tagCountTextView;
 207 
 208             private ImageButton deleteButton;
 209 
 210             private ViewHolder(View itemView) {
 211                 super(itemView);
 212                 tagTitle = itemView.findViewById(R.id.tag_name);
 213                 tagCountTextView = itemView.findViewById(R.id.tag_count);
 214                 deleteButton = itemView.findViewById(R.id.tag_trash);
 215                 deleteButton.setOnClickListener(new View.OnClickListener() {
 216                     @Override
 217                     public void onClick(View view) {
 218                         if (!isAdded()) {
 219                             return;
 220                         }
<abbr title=" 221                         final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;) (getItem(getAdapterPosition()))).getObject();"> 221                         final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;) (getItem(getAdapterPosition()))).getOðŸ”µ</abbr>
<abbr title=" 222                         final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 222                         final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAðŸ”µ</abbr>
 223                         if (tagCount == 0) {
 224                             deleteTag(tag);
 225                         } else if (tagCount &gt; 0) {
 226                             AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());
 227                             alert.setTitle(R.string.delete_tag);
 228                             alert.setMessage(getString(R.string.confirm_delete_tag));
 229                             alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 230                                 public void onClick(DialogInterface dialog, int whichButton) {
 231                                     deleteTag(tag);
 232                                 }
 233                             });
 234                             alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 235                                 public void onClick(DialogInterface dialog, int whichButton) {
 236                                     // Do nothing, just closing the dialog
 237                                 }
 238                             });
 239                             alert.show();
 240                         }
 241                     }
 242                 });
 243                 itemView.setOnClickListener(this);
 244             }
 245 
 246             @Override
 247             public void onClick(View view) {
 248                 if (!isAdded()) {
 249                     return;
 250                 }
<abbr title=" 251                 final AlertDialog.Builder alert = new android.support.v7.app.AlertDialog.Builder(getActivity());"> 251                 final AlertDialog.Builder alert = new android.support.v7.app.AlertDialog.Builder(getActivðŸ”µ</abbr>
<abbr title=" 252                 LinearLayout alertView = ((LinearLayout) (getActivity().getLayoutInflater().inflate(R.layout.edit_tag, null)));"> 252                 LinearLayout alertView = ((LinearLayout) (getActivity().getLayoutInflater().inflate(R.layðŸ”µ</abbr>
 253                 final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;) (getItem(getAdapterPosition()))).getObject();
 254                 final EditText tagNameEditText = alertView.findViewById(R.id.tag_name_edit);
 255                 tagNameEditText.setText(tag.getName());
 256                 tagNameEditText.setSelection(tagNameEditText.length());
 257                 alert.setView(alertView);
 258                 alert.setTitle(R.string.rename_tag);
 259                 alert.setPositiveButton(R.string.save, new DialogInterface.OnClickListener() {
 260                     public void onClick(DialogInterface dialog, int whichButton) {
 261                         String value = tagNameEditText.getText().toString().trim();
 262                         try {
 263                             tag.renameTo(value, mNotesBucket);
<abbr title=" 264                             AnalyticsTracker.track(AnalyticsTracker.Stat.TAG_EDITOR_ACCESSED, AnalyticsTracker.CATEGORY_TAG, &quot;tag_alert_edit_box&quot;);"> 264                             AnalyticsTracker.track(AnalyticsTracker.Stat.TAG_EDITOR_ACCESSED, AnalyticsTrðŸ”µ</abbr>
 265                         } catch (BucketObjectNameInvalid e) {
 266                             android.util.Log.e(Simplenote.TAG, &quot;Unable to rename tag&quot;, e);
 267                             // TODO: show user a message that new tag name is not ok
 268                         }
 269                     }
 270                 });
 271                 alert.setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() {
 272                     public void onClick(DialogInterface dialog, int whichButton) {
 273                         // Do nothing
 274                     }
 275                 });
 276                 alert.show();
 277             }
 278 
 279         private void deleteTag(Tag tag) {
 280             tag.delete();
 281             new removeTagFromNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, tag);
 282             AnalyticsTracker.track(
 283                     AnalyticsTracker.Stat.TAG_MENU_DELETED,
 284                     AnalyticsTracker.CATEGORY_TAG,
 285                     &quot;list_trash_button&quot;
 286             );
 287         }
 288         }
 289 
 290         private TagsAdapter() {
 291             super(null);
 292         }
 293 
 294         @NonNull
 295         @Override
 296         public ViewHolder onCreateViewHolder(@NonNull
 297         ViewGroup parent, int viewType) {
 298             Context context = parent.getContext();
 299             LayoutInflater inflater = LayoutInflater.from(context);
 300             View contactView = inflater.inflate(R.layout.tags_list_row, parent, false);
 301             return new ViewHolder(contactView);
 302         }
 303 
 304         @Override
 305         public void onBindViewHolder(@NonNull
 306         ViewHolder holder, Cursor cursor) {
 307             Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;) (cursor)).getObject();
 308             holder.tagTitle.setText(tag.getName());
<abbr title=" 309             final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 309             final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.geðŸ”µ</abbr>
 310             if (tagCount &gt; 0) {
 311                 holder.tagCountTextView.setText(String.valueOf(tagCount));
 312             } else {
 313                 holder.tagCountTextView.setText(&quot;&quot;);
 314             }
 315         }
 316 
 317         @Override
 318         public void swapCursor(Cursor newCursor) {
 319             super.swapCursor(newCursor);
 320         }
 321     }
 322 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 -import android.app.ListFragment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 +import android.app.Fragment;</span>
   5  import android.content.Context;
   6  import android.content.DialogInterface;
   7  import android.database.Cursor;
   8  import android.os.AsyncTask;
   9  import android.os.Bundle;
  10  import android.support.annotation.NonNull;
  11  import android.support.v7.app.AlertDialog;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 +import android.support.v7.widget.DividerItemDecoration;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 +import android.support.v7.widget.LinearLayoutManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 +import android.support.v7.widget.RecyclerView;</span>
  15  import android.view.ActionMode;
  16  import android.view.LayoutInflater;
  17  import android.view.Menu;
  18  import android.view.MenuInflater;
  19  import android.view.MenuItem;
  20  import android.view.View;
  21  import android.view.ViewGroup;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import android.widget.AbsListView;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import android.widget.AdapterView;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import android.widget.CursorAdapter;</span>
  25  import android.widget.EditText;
  26  import android.widget.ImageButton;
  27  import android.widget.LinearLayout;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import android.widget.ListView;</span>
  29  import android.widget.TextView;



  30  
  31  import com.automattic.simplenote.analytics.AnalyticsTracker;
  32  import com.automattic.simplenote.models.Note;
  33  import com.automattic.simplenote.models.Tag;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import com.automattic.simplenote.utils.BaseCursorAdapter;</span>
  35  import com.automattic.simplenote.utils.HtmlCompat;
  36  import com.simperium.client.Bucket;
  37  import com.simperium.client.BucketObjectNameInvalid;
  38  import com.simperium.client.Query;
  39  
  40  import java.util.List;
  41  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  42 -public class TagsListFragment extends ListFragment implements AdapterView.OnItemClickListener, ActionMode.Callback, AbsListView.MultiChoiceModeListener, AdapterView.OnItemLongClickListener, Bucket.Listener&lt;Tag&gt; {">  42 -public class TagsListFragment extends ListFragment implements AdapterView.OnItemClickListener, ActionMode.CallbackðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +public class TagsListFragment extends Fragment implements ActionMode.Callback, Bucket.Listener&lt;Tag&gt; {</span>
  44  
  45      private ActionMode mActionMode;
  46      private Bucket&lt;Tag&gt; mTagsBucket;
  47      private Bucket&lt;Note&gt; mNotesBucket;
  48      private TagsAdapter mTagsAdapter;
  49  
  50      /**
  51       * Mandatory empty constructor for the fragment manager to instantiate the
  52       * fragment (e.g. upon screen orientation changes).
  53       */
  54      public TagsListFragment() {
  55      }
  56  
  57      @Override
  58      public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
  59          View view = inflater.inflate(R.layout.fragment_tags_list, container, false);
  60  
  61          TextView emptyTextView = view.findViewById(android.R.id.empty);
  62          emptyTextView.setText(HtmlCompat.fromHtml(&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found) + &quot;&lt;/strong&gt;&quot;));
  63          return view;
  64      }
  65  
  66      @Override
  67      public void onActivityCreated(Bundle savedInstanceState) {
  68          super.onActivityCreated(savedInstanceState);
  69  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -        ListView listView = getListView();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -        listView.setMultiChoiceModeListener(this);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -        listView.setOnItemClickListener(this);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -        // Disabling long press CAB action for now since bulk deleting is incomplete</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -        // listView.setOnItemLongClickListener(this);</span>
  75          setHasOptionsMenu(true);
  76  
  77          Simplenote application = (Simplenote) getActivity().getApplication();
  78          mTagsBucket = application.getTagsBucket();
  79          mNotesBucket = application.getNotesBucket();
  80  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -        mTagsAdapter = new TagsAdapter(getActivity().getBaseContext(), null, 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -        setListAdapter(mTagsAdapter);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +        RecyclerView recyclerView = getActivity().findViewById(R.id.tagList);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +        mTagsAdapter = new TagsAdapter();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +        recyclerView.setAdapter(mTagsAdapter);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +        recyclerView.setLayoutManager(new LinearLayoutManager(getActivity()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  87 +        recyclerView.addItemDecoration(new DividerItemDecoration(recyclerView.getContext(), DividerItemDecoration.VERTICAL));">  87 +        recyclerView.addItemDecoration(new DividerItemDecoration(recyclerView.getContext(), DividerItemDecoration.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +</span>
  89          refreshTags();
  90      }
  91  
  92      @Override
  93      public void onResume() {
  94          super.onResume();
  95  
  96          mNotesBucket.start();
  97          mTagsBucket.start();
  98  
  99          mTagsBucket.addOnNetworkChangeListener(this);
 100          mTagsBucket.addOnSaveObjectListener(this);
 101          mTagsBucket.addOnDeleteObjectListener(this);
 102      }
 103  
 104      @Override
 105      public void onPause() {
 106          super.onPause();
 107  
 108          mTagsBucket.removeOnNetworkChangeListener(this);
 109          mTagsBucket.removeOnSaveObjectListener(this);
 110          mTagsBucket.removeOnDeleteObjectListener(this);
 111  
 112          mNotesBucket.stop();
 113          mTagsBucket.stop();
 114      }
 115  
 116      protected void refreshTags() {
 117          Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAME);
 118          Bucket.ObjectCursor&lt;Tag&gt; cursor = tagQuery.execute();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -        mTagsAdapter.changeCursor(cursor);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -    public void onItemClick(AdapterView&lt;?&gt; adapterView, View view, int row, long l) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -        if (!isAdded()) return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -        final AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 127 -        LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layout.edit_tag, null);"> 127 -        LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layout.edit_tag, null)ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -        final Tag tag = mTagsAdapter.getItem(row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -        final EditText tagNameEditText = alertView.findViewById(R.id.tag_name_edit);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        tagNameEditText.setText(tag.getName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -        tagNameEditText.setSelection(tagNameEditText.length());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -        alert.setView(alertView);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        alert.setTitle(R.string.rename_tag);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -        alert.setPositiveButton(R.string.save, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -            public void onClick(DialogInterface dialog, int whichButton) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -                String value = tagNameEditText.getText().toString().trim();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -                try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -                    tag.renameTo(value, mNotesBucket);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -                    AnalyticsTracker.track(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -                            AnalyticsTracker.Stat.TAG_EDITOR_ACCESSED,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -                            AnalyticsTracker.CATEGORY_TAG,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -                            &quot;tag_alert_edit_box&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -                    );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -                } catch (BucketObjectNameInvalid e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -                    android.util.Log.e(Simplenote.TAG, &quot;Unable to rename tag&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -                    // TODO: show user a message that new tag name is not ok</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -        alert.setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -            public void onClick(DialogInterface dialog, int whichButton) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -                // Do nothing</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -        alert.show();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +        mTagsAdapter.swapCursor(cursor);</span>
 160      }
 161  
 162      // TODO: Finish bulk editing
 163      @Override
 164      public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 165          MenuInflater inflater = actionMode.getMenuInflater();
 166          inflater.inflate(R.menu.bulk_edit, menu);
 167          mActionMode = actionMode;
 168          return true;
 169      }
 170  
 171      @Override
 172      public boolean onPrepareActionMode(ActionMode actionMode, Menu menu) {
 173          return false;
 174      }
 175  
 176      @Override
 177      public boolean onActionItemClicked(ActionMode actionMode, MenuItem menuItem) {
 178          if (menuItem.getItemId() == R.id.menu_delete) {
 179              actionMode.finish(); // Action picked, so close the CAB
 180              return true;
 181          }
 182          return false;
 183      }
 184  
 185      @Override
 186      public void onDestroyActionMode(ActionMode actionMode) {
 187          mActionMode = null;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -    public void onItemCheckedStateChanged(ActionMode actionMode, int i, long l, boolean b) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -        final int checkedCount = getListView().getCheckedItemCount();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -        switch (checkedCount) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -            case 0:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -                actionMode.setSubtitle(null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -            case 1:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -                actionMode.setSubtitle(&quot;One item selected&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -            default:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -                actionMode.setSubtitle(&quot;&quot; + checkedCount + &quot; items selected&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -    public boolean onItemLongClick(AdapterView&lt;?&gt; adapterView, View view, int position, long l) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -        getListView().setChoiceMode(ListView.CHOICE_MODE_MULTIPLE_MODAL);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -        getListView().setItemChecked(position, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -        if (isAdded() &amp;&amp; mActionMode == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -            getActivity().startActionMode(this);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -        //isCABDestroyed = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -        return false; // so this action does not consume the event!!!</span>
 215      }
 216  
 217      @Override
 218      public boolean onOptionsItemSelected(MenuItem item) {
 219  
 220          if (item.getItemId() == android.R.id.home) {
 221              if (isAdded()) {
 222                  getActivity().finish();
 223                  return true;
 224              }
 225          }
 226  
 227          return super.onOptionsItemSelected(item);
 228      }
 229  
 230      // Tag Bucket listeners
 231      @Override
 232      public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 233          if (isAdded()) {
 234              getActivity().runOnUiThread(new Runnable() {
 235                  @Override
 236                  public void run() {
 237                      refreshTags();
 238                  }
 239              });
 240          }
 241      }
 242  
 243      @Override
 244      public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 245          if (isAdded()) {
 246              getActivity().runOnUiThread(new Runnable() {
 247                  @Override
 248                  public void run() {
 249                      refreshTags();
 250                  }
 251              });
 252          }
 253      }
 254  
 255      @Override
 256      public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 257          if (isAdded()) {
 258              getActivity().runOnUiThread(new Runnable() {
 259                  @Override
 260                  public void run() {
 261                      refreshTags();
 262                  }
 263              });
 264          }
 265      }
 266  
 267      @Override
 268      public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 269          // noop
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -    private class TagsAdapter extends CursorAdapter {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -        private Bucket.ObjectCursor&lt;Tag&gt; mCursor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -        TagsAdapter(Context context, Bucket.ObjectCursor&lt;Tag&gt; c, int flags) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -            super(context, c, flags);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -            mCursor = c;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -        void changeCursor(Bucket.ObjectCursor&lt;Tag&gt; cursor) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -            super.changeCursor(cursor);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -            mCursor = cursor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -        public Tag getItem(int row) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -            super.getItem(row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -            return mCursor.getObject();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -        public View getView(final int position, View convertView, ViewGroup parent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -            mCursor.moveToPosition(position);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -            if (convertView == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -                convertView = getActivity().getLayoutInflater().inflate(R.layout.tags_list_row, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -            final Tag tag = mCursor.getObject();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -            convertView.setTag(tag.getSimperiumKey());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -            TextView tagTitle = convertView.findViewById(R.id.tag_name);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -            TextView tagCountTextView = convertView.findViewById(R.id.tag_count);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -            tagTitle.setText(tag.getName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 305 -            final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 305 -            final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -            if (tagCount &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -                tagCountTextView.setText(String.valueOf(tagCount));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -                tagCountTextView.setText(&quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -            ImageButton deleteButton = convertView.findViewById(R.id.tag_trash);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -            deleteButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -                @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -                public void onClick(View view) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 316 -                    if (!isAdded()) return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 317 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 318 -                    if (tagCount == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 319 -                        deleteTag(tag);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 320 -                    } else if (tagCount &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 321 -                        AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 322 -                        alert.setTitle(R.string.delete_tag);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 323 -                        alert.setMessage(getString(R.string.confirm_delete_tag));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 324 -                        alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 325 -                            public void onClick(DialogInterface dialog, int whichButton) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 326 -                                deleteTag(tag);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 327 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 328 -                        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 329 -                        alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 330 -                            public void onClick(DialogInterface dialog, int whichButton) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 331 -                                // Do nothing, just closing the dialog</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 332 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 333 -                        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 334 -                        alert.show();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -            });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 338 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 339 -            return convertView;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 341 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 342 -        private void deleteTag(Tag tag) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 343 -            tag.delete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 344 -            new removeTagFromNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, tag);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 345 -            AnalyticsTracker.track(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 346 -                    AnalyticsTracker.Stat.TAG_MENU_DELETED,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -                    AnalyticsTracker.CATEGORY_TAG,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 348 -                    &quot;list_trash_button&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 349 -            );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 350 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 351 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 352 -        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 353 -        public View newView(Context context, Cursor cursor, ViewGroup viewGroup) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 354 -            return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 356 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 357 -        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 358 -        public void bindView(View view, Context context, Cursor cursor) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 359 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -        }</span>
 361      }
 362  
 363      private class removeTagFromNotesTask extends AsyncTask&lt;Tag, Void, Void&gt; {
 364  
 365          @Override
 366          protected Void doInBackground(Tag... removedTags) {
 367              Tag tag = removedTags[0];
 368              if (tag != null) {
 369                  Bucket.ObjectCursor&lt;Note&gt; notesCursor = tag.findNotes(mNotesBucket);
 370                  while (notesCursor.moveToNext()) {
 371                      Note note = notesCursor.getObject();
 372                      List&lt;String&gt; tags = note.getTags();
 373                      tags.remove(tag.getName());
 374                      note.setTags(tags);
 375                      note.save();
 376                  }
 377                  notesCursor.close();
 378              }
 379              return null;
 380          }
 381      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 382 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +    private class TagsAdapter extends BaseCursorAdapter&lt;TagsAdapter.ViewHolder&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 384 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +        public class ViewHolder extends RecyclerView.ViewHolder implements View.OnClickListener {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +            private TextView tagTitle;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +            private TextView tagCountTextView;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +            private ImageButton deleteButton;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +            private ViewHolder(View itemView) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +                super(itemView);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +                tagTitle = itemView.findViewById(R.id.tag_name);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 395 +                tagCountTextView = itemView.findViewById(R.id.tag_count);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 396 +                deleteButton = itemView.findViewById(R.id.tag_trash);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 397 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 398 +                deleteButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 399 +                    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 400 +                    public void onClick(View view) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 401 +                        if (!isAdded()) return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 402 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 403 +                        final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObject();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 404 +                        final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 404 +                        final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tagðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 405 +                        if (tagCount == 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 406 +                            deleteTag(tag);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 407 +                        } else if (tagCount &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 408 +                            AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 409 +                            alert.setTitle(R.string.delete_tag);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 410 +                            alert.setMessage(getString(R.string.confirm_delete_tag));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 411 +                            alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 412 +                                public void onClick(DialogInterface dialog, int whichButton) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 413 +                                    deleteTag(tag);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 414 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 415 +                            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 416 +                            alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 417 +                                public void onClick(DialogInterface dialog, int whichButton) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +                                    // Do nothing, just closing the dialog</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 419 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 420 +                            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 421 +                            alert.show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 422 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 423 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 424 +                });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 425 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 426 +                itemView.setOnClickListener(this);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 427 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 428 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 429 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 430 +            public void onClick(View view) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 431 +                if (!isAdded()) return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 432 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 433 +                final AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 434 +                LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layout.edit_tag, null);"> 434 +                LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layout.edit_taðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 435 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 436 +                final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObject();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 437 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 438 +                final EditText tagNameEditText = alertView.findViewById(R.id.tag_name_edit);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 439 +                tagNameEditText.setText(tag.getName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 440 +                tagNameEditText.setSelection(tagNameEditText.length());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 441 +                alert.setView(alertView);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 442 +                alert.setTitle(R.string.rename_tag);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 443 +                alert.setPositiveButton(R.string.save, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 444 +                    public void onClick(DialogInterface dialog, int whichButton) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 445 +                        String value = tagNameEditText.getText().toString().trim();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 446 +                        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 447 +                            tag.renameTo(value, mNotesBucket);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 448 +                            AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 449 +                                    AnalyticsTracker.Stat.TAG_EDITOR_ACCESSED,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 450 +                                    AnalyticsTracker.CATEGORY_TAG,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 451 +                                    &quot;tag_alert_edit_box&quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 452 +                            );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 453 +                        } catch (BucketObjectNameInvalid e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 454 +                            android.util.Log.e(Simplenote.TAG, &quot;Unable to rename tag&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 455 +                            // TODO: show user a message that new tag name is not ok</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 456 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 457 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 458 +                });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 459 +                alert.setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 460 +                    public void onClick(DialogInterface dialog, int whichButton) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 461 +                        // Do nothing</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 462 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 463 +                });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 464 +                alert.show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 465 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 466 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 467 +            private void deleteTag(Tag tag) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 468 +                tag.delete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 469 +                new removeTagFromNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, tag);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 470 +                AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 471 +                        AnalyticsTracker.Stat.TAG_MENU_DELETED,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 472 +                        AnalyticsTracker.CATEGORY_TAG,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 473 +                        &quot;list_trash_button&quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 474 +                );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 475 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 476 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 477 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 478 +        private TagsAdapter() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 479 +            super(null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 480 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 481 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 482 +        @NonNull</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 483 +        @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 484 +        public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 485 +            Context context = parent.getContext();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 486 +            LayoutInflater inflater = LayoutInflater.from(context);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 487 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 488 +            View contactView = inflater.inflate(R.layout.tags_list_row, parent, false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 489 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 490 +            return new ViewHolder(contactView);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 491 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 492 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 493 +        @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 494 +        public void onBindViewHolder(@NonNull ViewHolder holder, Cursor cursor) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 495 +            Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)cursor).getObject();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 496 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 497 +            holder.tagTitle.setText(tag.getName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 498 +            final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 498 +            final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 499 +            if (tagCount &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 500 +                holder.tagCountTextView.setText(String.valueOf(tagCount));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 501 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 502 +                holder.tagCountTextView.setText(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 503 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 504 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 505 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 506 +        @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 507 +        public void swapCursor(Cursor newCursor) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 508 +            super.swapCursor(newCursor);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 509 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 510 +    }</span>
 511  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.ListFragment;

   4  import android.content.Context;
   5  import android.content.DialogInterface;
   6  import android.database.Cursor;
   7  import android.os.AsyncTask;
   8  import android.os.Bundle;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 -import android.support.annotation.NonNull;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 -import android.support.v7.app.AlertDialog;</span>



  11  import android.view.ActionMode;
  12  import android.view.LayoutInflater;
  13  import android.view.Menu;
  14  import android.view.MenuInflater;
  15  import android.view.MenuItem;
  16  import android.view.View;
  17  import android.view.ViewGroup;
  18  import android.widget.AbsListView;
  19  import android.widget.AdapterView;
  20  import android.widget.CursorAdapter;
  21  import android.widget.EditText;
  22  import android.widget.ImageButton;
  23  import android.widget.LinearLayout;
  24  import android.widget.ListView;
  25  import android.widget.TextView;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import androidx.annotation.NonNull;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import androidx.appcompat.app.AlertDialog;</span>
  29  
  30  import com.automattic.simplenote.analytics.AnalyticsTracker;
  31  import com.automattic.simplenote.models.Note;
  32  import com.automattic.simplenote.models.Tag;

  33  import com.automattic.simplenote.utils.HtmlCompat;
  34  import com.simperium.client.Bucket;
  35  import com.simperium.client.BucketObjectNameInvalid;
  36  import com.simperium.client.Query;
  37  
  38  import java.util.List;
  39  
<abbr title="  40  public class TagsListFragment extends ListFragment implements AdapterView.OnItemClickListener, ActionMode.Callback, AbsListView.MultiChoiceModeListener, AdapterView.OnItemLongClickListener, Bucket.Listener&lt;Tag&gt; {">  40  public class TagsListFragment extends ListFragment implements AdapterView.OnItemClickListener, ActionMode.CallbackðŸ”µ</abbr>

  41  
  42      private ActionMode mActionMode;
  43      private Bucket&lt;Tag&gt; mTagsBucket;
  44      private Bucket&lt;Note&gt; mNotesBucket;
  45      private TagsAdapter mTagsAdapter;
  46  
  47      /**
  48       * Mandatory empty constructor for the fragment manager to instantiate the
  49       * fragment (e.g. upon screen orientation changes).
  50       */
  51      public TagsListFragment() {
  52      }
  53  
  54      @Override
  55      public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
  56          View view = inflater.inflate(R.layout.fragment_tags_list, container, false);
  57  
  58          TextView emptyTextView = view.findViewById(android.R.id.empty);
  59          emptyTextView.setText(HtmlCompat.fromHtml(&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found) + &quot;&lt;/strong&gt;&quot;));
  60          return view;
  61      }
  62  
  63      @Override
  64      public void onActivityCreated(Bundle savedInstanceState) {
  65          super.onActivityCreated(savedInstanceState);
  66  
  67          ListView listView = getListView();
  68          listView.setMultiChoiceModeListener(this);
  69          listView.setOnItemClickListener(this);
  70          // Disabling long press CAB action for now since bulk deleting is incomplete
  71          // listView.setOnItemLongClickListener(this);
  72          setHasOptionsMenu(true);
  73  
  74          Simplenote application = (Simplenote) getActivity().getApplication();
  75          mTagsBucket = application.getTagsBucket();
  76          mNotesBucket = application.getNotesBucket();
  77  
  78          mTagsAdapter = new TagsAdapter(getActivity().getBaseContext(), null, 0);
  79          setListAdapter(mTagsAdapter);






  80          refreshTags();
  81      }
  82  
  83      @Override
  84      public void onResume() {
  85          super.onResume();
  86  
  87          mNotesBucket.start();
  88          mTagsBucket.start();
  89  
  90          mTagsBucket.addOnNetworkChangeListener(this);
  91          mTagsBucket.addOnSaveObjectListener(this);
  92          mTagsBucket.addOnDeleteObjectListener(this);
  93      }
  94  
  95      @Override
  96      public void onPause() {
  97          super.onPause();
  98  
  99          mTagsBucket.removeOnNetworkChangeListener(this);
 100          mTagsBucket.removeOnSaveObjectListener(this);
 101          mTagsBucket.removeOnDeleteObjectListener(this);
 102  
 103          mNotesBucket.stop();
 104          mTagsBucket.stop();
 105      }
 106  
 107      protected void refreshTags() {
 108          Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAME);
 109          Bucket.ObjectCursor&lt;Tag&gt; cursor = tagQuery.execute();
 110          mTagsAdapter.changeCursor(cursor);
 111      }
 112  
 113      @Override
 114      public void onItemClick(AdapterView&lt;?&gt; adapterView, View view, int row, long l) {
 115          if (!isAdded()) return;
 116  
 117          final AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());
<abbr title=" 118          LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layout.edit_tag, null);"> 118          LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layout.edit_tag, null)ðŸ”µ</abbr>
 119  
 120          final Tag tag = mTagsAdapter.getItem(row);
 121  
 122          final EditText tagNameEditText = alertView.findViewById(R.id.tag_name_edit);
 123          tagNameEditText.setText(tag.getName());
 124          tagNameEditText.setSelection(tagNameEditText.length());
 125          alert.setView(alertView);
 126          alert.setTitle(R.string.rename_tag);
 127          alert.setPositiveButton(R.string.save, new DialogInterface.OnClickListener() {
 128              public void onClick(DialogInterface dialog, int whichButton) {
 129                  String value = tagNameEditText.getText().toString().trim();
 130                  try {
 131                      tag.renameTo(value, mNotesBucket);
 132                      AnalyticsTracker.track(
 133                              AnalyticsTracker.Stat.TAG_EDITOR_ACCESSED,
 134                              AnalyticsTracker.CATEGORY_TAG,
 135                              &quot;tag_alert_edit_box&quot;
 136                      );
 137                  } catch (BucketObjectNameInvalid e) {
 138                      android.util.Log.e(Simplenote.TAG, &quot;Unable to rename tag&quot;, e);
 139                      // TODO: show user a message that new tag name is not ok
 140                  }
 141              }
 142          });
 143          alert.setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() {
 144              public void onClick(DialogInterface dialog, int whichButton) {
 145                  // Do nothing
 146              }
 147          });
 148          alert.show();
 149  

 150      }
 151  
 152      // TODO: Finish bulk editing
 153      @Override
 154      public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 155          MenuInflater inflater = actionMode.getMenuInflater();
 156          inflater.inflate(R.menu.bulk_edit, menu);
 157          mActionMode = actionMode;
 158          return true;
 159      }
 160  
 161      @Override
 162      public boolean onPrepareActionMode(ActionMode actionMode, Menu menu) {
 163          return false;
 164      }
 165  
 166      @Override
 167      public boolean onActionItemClicked(ActionMode actionMode, MenuItem menuItem) {
 168          if (menuItem.getItemId() == R.id.menu_delete) {
 169              actionMode.finish(); // Action picked, so close the CAB
 170              return true;
 171          }
 172          return false;
 173      }
 174  
 175      @Override
 176      public void onDestroyActionMode(ActionMode actionMode) {
 177          mActionMode = null;
 178      }
 179  
 180      @Override
 181      public void onItemCheckedStateChanged(ActionMode actionMode, int i, long l, boolean b) {
 182          final int checkedCount = getListView().getCheckedItemCount();
 183          switch (checkedCount) {
 184              case 0:
 185                  actionMode.setSubtitle(null);
 186                  break;
 187              case 1:
 188                  actionMode.setSubtitle(&quot;One item selected&quot;);
 189                  break;
 190              default:
 191                  actionMode.setSubtitle(&quot;&quot; + checkedCount + &quot; items selected&quot;);
 192                  break;
 193          }
 194      }
 195  
 196      @Override
 197      public boolean onItemLongClick(AdapterView&lt;?&gt; adapterView, View view, int position, long l) {
 198          getListView().setChoiceMode(ListView.CHOICE_MODE_MULTIPLE_MODAL);
 199          getListView().setItemChecked(position, true);
 200          if (isAdded() &amp;&amp; mActionMode == null) {
 201              getActivity().startActionMode(this);
 202          }
 203          //isCABDestroyed = false;
 204          return false; // so this action does not consume the event!!!
 205      }
 206  
 207      @Override
 208      public boolean onOptionsItemSelected(MenuItem item) {
 209  
 210          if (item.getItemId() == android.R.id.home) {
 211              if (isAdded()) {
 212                  getActivity().finish();
 213                  return true;
 214              }
 215          }
 216  
 217          return super.onOptionsItemSelected(item);
 218      }
 219  
 220      // Tag Bucket listeners
 221      @Override
 222      public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 223          if (isAdded()) {
 224              getActivity().runOnUiThread(new Runnable() {
 225                  @Override
 226                  public void run() {
 227                      refreshTags();
 228                  }
 229              });
 230          }
 231      }
 232  
 233      @Override
 234      public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 235          if (isAdded()) {
 236              getActivity().runOnUiThread(new Runnable() {
 237                  @Override
 238                  public void run() {
 239                      refreshTags();
 240                  }
 241              });
 242          }
 243      }
 244  
 245      @Override
 246      public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 247          if (isAdded()) {
 248              getActivity().runOnUiThread(new Runnable() {
 249                  @Override
 250                  public void run() {
 251                      refreshTags();
 252                  }
 253              });
 254          }
 255      }
 256  
 257      @Override
 258      public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 259          // noop
 260      }
 261  
 262      private class TagsAdapter extends CursorAdapter {
 263  
 264          private Bucket.ObjectCursor&lt;Tag&gt; mCursor;
 265  
 266          TagsAdapter(Context context, Bucket.ObjectCursor&lt;Tag&gt; c, int flags) {
 267              super(context, c, flags);
 268              mCursor = c;
 269          }
 270  
 271          void changeCursor(Bucket.ObjectCursor&lt;Tag&gt; cursor) {
 272              super.changeCursor(cursor);
 273              mCursor = cursor;
 274          }
 275  
 276          @Override
 277          public Tag getItem(int row) {
 278              super.getItem(row);
 279              return mCursor.getObject();
 280          }
 281  
 282          @Override
 283          public View getView(final int position, View convertView, ViewGroup parent) {
 284              mCursor.moveToPosition(position);
 285  
 286              if (convertView == null) {
 287                  convertView = getActivity().getLayoutInflater().inflate(R.layout.tags_list_row, null);
 288              }
 289              final Tag tag = mCursor.getObject();
 290              convertView.setTag(tag.getSimperiumKey());
 291  
 292              TextView tagTitle = convertView.findViewById(R.id.tag_name);
 293              TextView tagCountTextView = convertView.findViewById(R.id.tag_count);
 294              tagTitle.setText(tag.getName());
<abbr title=" 295              final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 295              final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).ðŸ”µ</abbr>
 296              if (tagCount &gt; 0) {
 297                  tagCountTextView.setText(String.valueOf(tagCount));
 298              } else {
 299                  tagCountTextView.setText(&quot;&quot;);
 300              }
 301  
 302              ImageButton deleteButton = convertView.findViewById(R.id.tag_trash);
 303              deleteButton.setOnClickListener(new View.OnClickListener() {
 304                  @Override
 305                  public void onClick(View view) {
 306                      if (!isAdded()) return;
 307  
 308                      if (tagCount == 0) {
 309                          deleteTag(tag);
 310                      } else if (tagCount &gt; 0) {
 311                          AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());
 312                          alert.setTitle(R.string.delete_tag);
 313                          alert.setMessage(getString(R.string.confirm_delete_tag));
 314                          alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 315                              public void onClick(DialogInterface dialog, int whichButton) {
 316                                  deleteTag(tag);
 317                              }
 318                          });
 319                          alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 320                              public void onClick(DialogInterface dialog, int whichButton) {
 321                                  // Do nothing, just closing the dialog
 322                              }
 323                          });
 324                          alert.show();
 325                      }
 326                  }
 327              });
 328  
 329              return convertView;
 330          }
 331  
 332          private void deleteTag(Tag tag) {
 333              tag.delete();
 334              new removeTagFromNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, tag);
 335              AnalyticsTracker.track(
 336                      AnalyticsTracker.Stat.TAG_MENU_DELETED,
 337                      AnalyticsTracker.CATEGORY_TAG,
 338                      &quot;list_trash_button&quot;
 339              );
 340          }
 341  
 342          @Override
 343          public View newView(Context context, Cursor cursor, ViewGroup viewGroup) {
 344              return null;
 345          }
 346  
 347          @Override
 348          public void bindView(View view, Context context, Cursor cursor) {
 349  
 350          }
 351      }
 352  
 353      private class removeTagFromNotesTask extends AsyncTask&lt;Tag, Void, Void&gt; {
 354  
 355          @Override
 356          protected Void doInBackground(Tag... removedTags) {
 357              Tag tag = removedTags[0];
 358              if (tag != null) {
 359                  Bucket.ObjectCursor&lt;Note&gt; notesCursor = tag.findNotes(mNotesBucket);
 360                  while (notesCursor.moveToNext()) {
 361                      Note note = notesCursor.getObject();
 362                      List&lt;String&gt; tags = note.getTags();
 363                      tags.remove(tag.getName());
 364                      note.setTags(tags);
 365                      note.save();
 366                  }
 367                  notesCursor.close();
 368              }
 369              return null;
 370          }
 371      }

































































































































 372  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            