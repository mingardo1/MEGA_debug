<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>190</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    190
                    <a href="189.html">prev</a>
                    <a href="191.html">next</a>
                    <a href="190_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_96271e385ed556be4f6025661bd77bd75dc63db6_Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;96271e385ed556be4f6025661bd77bd75dc63db6:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;96271e385ed556be4f6025661bd77bd75dc63db6^1:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;96271e385ed556be4f6025661bd77bd75dc63db6^2:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;f1565ff4668f5e2647304182eff295136b7153cf:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.content.DialogInterface;
   5 import android.content.Intent;
   6 import android.content.SharedPreferences;
   7 import android.content.res.ColorStateList;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.Handler;
  12 import android.text.TextUtils;
  13 import android.view.Menu;
  14 import android.view.MenuInflater;
  15 import android.view.MenuItem;
  16 import android.view.View;
  17 import android.widget.LinearLayout;
  18 import android.widget.ListView;
  19 import android.widget.ProgressBar;
  20 
  21 import androidx.annotation.NonNull;
  22 import androidx.appcompat.app.ActionBar;
  23 import androidx.appcompat.app.ActionBarDrawerToggle;
  24 import androidx.appcompat.app.AlertDialog;
  25 import androidx.appcompat.app.AppCompatActivity;
  26 import androidx.appcompat.view.ContextThemeWrapper;
  27 import androidx.appcompat.widget.SearchView;
  28 import androidx.appcompat.widget.Toolbar;
  29 import androidx.core.view.GravityCompat;
  30 import androidx.drawerlayout.widget.DrawerLayout;
  31 import androidx.fragment.app.FragmentManager;
  32 import androidx.fragment.app.FragmentTransaction;
  33 import androidx.preference.PreferenceManager;
  34 
  35 import com.automattic.simplenote.analytics.AnalyticsTracker;
  36 import com.automattic.simplenote.models.Note;
  37 import com.automattic.simplenote.models.Tag;
  38 import com.automattic.simplenote.utils.CrashUtils;
  39 import com.automattic.simplenote.utils.DisplayUtils;
  40 import com.automattic.simplenote.utils.DrawableUtils;
  41 import com.automattic.simplenote.utils.HtmlCompat;
  42 import com.automattic.simplenote.utils.PrefUtils;
  43 import com.automattic.simplenote.utils.StrUtils;
  44 import com.automattic.simplenote.utils.TagsAdapter;
  45 import com.automattic.simplenote.utils.ThemeUtils;
  46 import com.automattic.simplenote.utils.UndoBarController;
  47 import com.google.android.material.navigation.NavigationView;
  48 import com.simperium.Simperium;
  49 import com.simperium.client.Bucket;
  50 import com.simperium.client.BucketObjectMissingException;
  51 import com.simperium.client.BucketObjectNameInvalid;
  52 import com.simperium.client.Query;
  53 import com.simperium.client.User;
  54 
  55 import org.wordpress.passcodelock.AppLockManager;
  56 
  57 import java.util.ArrayList;
  58 import java.util.Calendar;
  59 import java.util.HashMap;
  60 import java.util.List;
  61 import java.util.Map;
  62 
  63 import static com.automattic.simplenote.NoteListFragment.TAG_PREFIX;
  64 import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  65 import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  66 import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  67 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  68 import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  69 import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  70 import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  71 import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  72 import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  73 import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  74 
  75 public class NotesActivity extends AppCompatActivity implements
<abbr title="  76         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  76         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  77         Bucket.Listener&lt;Note&gt; {
  78 
  79     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  80     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  81     protected Bucket&lt;Note&gt; mNotesBucket;
  82     protected Bucket&lt;Tag&gt; mTagsBucket;
  83     private boolean mIsShowingMarkdown;
  84     private boolean mShouldSelectNewNote;
  85     private boolean mIsSettingsClicked;
  86     private boolean mIsTabetFullscreen;
  87 
  88     private String mTabletSearchQuery;
  89     private UndoBarController mUndoBarController;
  90     private View mFragmentsContainer;
  91     private SearchView mSearchView;
  92     private MenuItem mSearchMenuItem;
  93     private NoteListFragment mNoteListFragment;
  94     private NoteEditorFragment mNoteEditorFragment;
  95     private Note mCurrentNote;
  96     private MenuItem mEmptyTrashMenuItem;
  97 
  98     // Menu drawer
  99     private static final int GROUP_PRIMARY = 100;
 100     private static final int GROUP_SECONDARY = 101;
 101     private static final int GROUP_TERTIARY = 102;
 102     private DrawerLayout mDrawerLayout;
 103     private Menu mNavigationMenu;
 104     private ActionBarDrawerToggle mDrawerToggle;
 105     private TagsAdapter mTagsAdapter;
 106     private TagsAdapter.TagMenuItem mSelectedTag;
 107     // Tags bucket listener
 108     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 109         void updateNavigationDrawer() {
 110             runOnUiThread(new Runnable() {
 111                 public void run() {
 112                     updateNavigationDrawerItems();
 113                 }
 114             });
 115         }
 116 
 117         @Override
 118         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 119             updateNavigationDrawer();
 120         }
 121 
 122         @Override
 123         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 124             updateNavigationDrawer();
 125         }
 126 
 127         @Override
 128         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 129             updateNavigationDrawer();
 130         }
 131 
 132         @Override
 133         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 134             // noop
 135         }
 136     };
 137 
 138     @Override
 139     protected void onCreate(Bundle savedInstanceState) {
 140         ThemeUtils.setTheme(this);
 141         super.onCreate(savedInstanceState);
 142 
 143         setContentView(R.layout.activity_notes);
 144 
 145         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 146 
 147         Simplenote currentApp = (Simplenote) getApplication();
 148         if (mNotesBucket == null) {
 149             mNotesBucket = currentApp.getNotesBucket();
 150         }
 151 
 152         if (mTagsBucket == null) {
 153             mTagsBucket = currentApp.getTagsBucket();
 154         }
 155 
 156         Toolbar toolbar = findViewById(R.id.toolbar);
 157         setSupportActionBar(toolbar);
 158         configureNavigationDrawer(toolbar);
 159 
 160         if (savedInstanceState == null) {
 161             mNoteListFragment = new NoteListFragment();
 162             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 163             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 164             fragmentTransaction.commit();
 165         } else {
<abbr title=" 166             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 166             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 167         }
 168         mIsTabetFullscreen = mNoteListFragment.isHidden();
 169 
 170         if (DisplayUtils.isLargeScreen(this)) {
 171             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 172                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 172                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 173             } else if (DisplayUtils.isLandscape(this)) {
 174                 addEditorFragment();
 175             }
 176         }
 177 
 178         // enable ActionBar app icon to behave as action to toggle nav drawer
 179         ActionBar actionBar = getSupportActionBar();
 180         if (actionBar != null) {
 181             actionBar.setDisplayHomeAsUpEnabled(true);
 182             actionBar.setHomeButtonEnabled(true);
 183 
 184             // Add loading indicator to show when indexing
<abbr title=" 185             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 185             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 186             actionBar.setDisplayShowCustomEnabled(true);
 187             actionBar.setCustomView(progressBar);
 188             setToolbarProgressVisibility(false);
 189         }
 190 
 191         mUndoBarController = new UndoBarController(this);
 192 
 193         // Creates &#x27;Welcome&#x27; note
 194         checkForFirstLaunch();
 195 
 196         checkForSharedContent();
 197 
 198         currentApp.getSimperium().setOnUserCreatedListener(this);
 199         currentApp.getSimperium().setUserStatusChangeListener(this);
 200     }
 201 
 202     @Override
 203     protected void onResume() {
 204         super.onResume();
 205 
 206         // Ensure user has valid authorization
 207         if (userAuthenticationIsInvalid()) {
 208             startLoginActivity(true);
 209             Intent intent = getIntent();
 210 
 211             if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 212                     intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 213                 AnalyticsTracker.track(
 214                         NOTE_WIDGET_SIGN_IN_TAPPED,
 215                         CATEGORY_WIDGET,
 216                         &quot;note_widget_sign_in_tapped&quot;
 217                 );
 218             }
 219         }
 220 
 221         disableScreenshotsIfLocked(this);
 222 
 223         mNotesBucket.start();
 224         mTagsBucket.start();
 225 
 226         mNotesBucket.addOnNetworkChangeListener(this);
 227         mNotesBucket.addOnSaveObjectListener(this);
 228         mNotesBucket.addOnDeleteObjectListener(this);
 229         mTagsBucket.addListener(mTagsMenuUpdater);
 230 
 231         updateNavigationDrawerItems();
 232 
 233         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 234         if (userIsUnauthorized()) {
 235             if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 236                 mSelectedTag = null;
 237                 mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 238             }
 239         }
 240 
 241         filterListBySelectedTag();
 242 
 243         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 244             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 244             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCuðŸ”µ</abbr>
 245             mShouldSelectNewNote = false;
 246         }
 247 
 248         if (mIsShowingMarkdown) {
 249             setMarkdownShowing(false);
 250         }
 251 
 252         FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 253         if(DisplayUtils.isLargeScreenLandscape(this)) {
 254             if (mIsTabetFullscreen) {
 255                 ft.hide(mNoteListFragment);
 256             } else {
 257                 ft.show(mNoteListFragment);
 258             }
 259         } else {
 260             ft.show(mNoteListFragment);
 261         }
 262         ft.commitNow();
 263     }
 264 
 265     @Override
 266     protected void onPause() {
 267         super.onPause();  // Always call the superclass method first
 268         mTagsBucket.removeListener(mTagsMenuUpdater);
 269         mTagsBucket.stop();
 270 
 271         mNotesBucket.removeOnNetworkChangeListener(this);
 272         mNotesBucket.removeOnSaveObjectListener(this);
 273         mNotesBucket.removeOnDeleteObjectListener(this);
 274         mNotesBucket.stop();
 275     }
 276 
 277     @Override
 278     public void setTitle(CharSequence title) {
 279         if (getSupportActionBar() != null) {
 280             getSupportActionBar().setTitle(title);
 281         }
 282     }
 283 
 284     @Override
 285     public void onBackPressed() {
 286         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 287             mDrawerLayout.closeDrawer(GravityCompat.START);
 288         } else {
 289             super.onBackPressed();
 290         }
 291     }
 292 
 293     @Override
 294     public void onActionModeCreated() {
 295         mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 296     }
 297 
 298     @Override
 299     public void onActionModeDestroyed() {
 300         if (mSearchMenuItem != null &amp;&amp; !mSearchMenuItem.isActionViewExpanded()) {
 301             mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 302         }
 303     }
 304 
 305     private ColorStateList getIconSelector() {
 306         int[][] states = new int[][] {
 307                 new int[] { android.R.attr.state_checked}, // checked
 308                 new int[] {-android.R.attr.state_checked}  // unchecked
 309         };
 310 
 311         int[] colors = new int[] {
 312                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 313                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.toolbarIconColor)
 314         };
 315 
 316         return new ColorStateList(states, colors);
 317     }
 318 
 319     private ColorStateList getTextSelector() {
 320         int[][] states = new int[][] {
 321             new int[] {-android.R.attr.state_enabled}, // disabled
 322             new int[] { android.R.attr.state_checked}, // checked
 323             new int[] {-android.R.attr.state_checked}  // unchecked
 324         };
 325 
 326         int[] colors = new int[] {
 327             getResources().getColor(R.color.text_title_disabled, getTheme()),
 328             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 329             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)
 330         };
 331 
 332         return new ColorStateList(states, colors);
 333     }
 334 
 335     private void configureNavigationDrawer(Toolbar toolbar) {
 336         ColorStateList iconSelector = getIconSelector();
 337         ColorStateList textSelector = getTextSelector();
 338         mDrawerLayout = findViewById(R.id.drawer_layout);
 339         NavigationView navigationView = findViewById(R.id.navigation_view);
 340         navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 341         navigationView.setItemIconTintList(iconSelector);
 342         navigationView.setItemTextColor(textSelector);
 343         navigationView.setNavigationItemSelectedListener(
 344             new NavigationView.OnNavigationItemSelectedListener() {
 345                 @Override
 346                 public boolean onNavigationItemSelected(@NonNull MenuItem item) {
 347                     mDrawerLayout.closeDrawer(GravityCompat.START);
 348 
 349                     if (item.getItemId() == SETTINGS_ID) {
 350                         AnalyticsTracker.track(
 351                                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 352                                 AnalyticsTracker.CATEGORY_TAG,
 353                                 &quot;selected_tag_in_navigation_drawer&quot;,
 354                                 new HashMap&lt;String, String&gt;(1){{put(&quot;tag&quot;, &quot;settings&quot;);}}
 355                         );
 356                         mIsSettingsClicked = true;
 357                         return false;
 358                     } else {
 359                         mSelectedTag = mTagsAdapter.getTagFromItem(item);
 360                         filterListBySelectedTag();
 361                         return true;
 362                     }
 363                 }
 364             }
 365         );
 366 
 367         mNavigationMenu = navigationView.getMenu();
<abbr title=" 368         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 368         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcoðŸ”µ</abbr>
<abbr title=" 369         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 369         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawðŸ”µ</abbr>
<abbr title=" 370         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 370         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(ðŸ”µ</abbr>
 371         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 372 
 373         if (mSelectedTag == null)
 374             mSelectedTag = mTagsAdapter.getDefaultItem();
 375 
 376         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 377                 R.string.close_drawer) {
 378             public void onDrawerClosed(View view) {
 379                 supportInvalidateOptionsMenu();
 380 
 381                 if (mIsSettingsClicked) {
 382                     Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 383                     startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 384                     mIsSettingsClicked = false;
 385                 }
 386             }
 387 
 388             public void onDrawerOpened(View drawerView) {
 389                 // noop
 390             }
 391 
 392             @Override
 393             public void onDrawerSlide(View drawerView, float slideOffset) {
 394                 super.onDrawerSlide(drawerView, 0f);
 395             }
 396         };
 397 
 398         mDrawerLayout.addDrawerListener(mDrawerToggle);
 399     }
 400 
 401     private void filterListBySelectedTag() {
 402         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 403 
 404         if (selectedMenuItem != null) {
 405             mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 406         } else {
 407             mSelectedTag = mTagsAdapter.getDefaultItem();
 408         }
 409 
 410         checkEmptyListText(mSearchMenuItem != null &amp;&amp; mSearchMenuItem.isActionViewExpanded());
 411 
 412         if (mNoteListFragment.isHidden()) {
 413             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 414             fragmentTransaction.show(mNoteListFragment);
 415             fragmentTransaction.commitNowAllowingStateLoss();
 416         }
 417 
 418         // Disable long press on notes when viewing Trash.
 419         if (mSelectedTag.id == TRASH_ID) {
 420             getNoteListFragment().getListView().setLongClickable(false);
 421         } else {
 422             getNoteListFragment().getListView().setLongClickable(true);
 423         }
 424 
 425         getNoteListFragment().refreshListFromNavSelect();
 426 
 427         Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 428 
 429         switch ((int) mSelectedTag.id) {
 430             case ALL_NOTES_ID:
 431                 properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 432                 break;
 433             case TRASH_ID:
 434                 properties.put(&quot;tag&quot;, &quot;trash&quot;);
 435                 break;
 436             case UNTAGGED_NOTES_ID:
 437                 properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 438                 break;
 439             default:
 440                 properties = null;
 441                 break;
 442         }
 443 
 444         AnalyticsTracker.track(
 445                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 446                 AnalyticsTracker.CATEGORY_TAG,
 447                 &quot;selected_tag_in_navigation_drawer&quot;,
 448                 properties
 449         );
 450 
 451         setSelectedTagActive();
 452     }
 453 
 454     private void checkForFirstLaunch() {
 455         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 456             // Create the welcome note
 457             try {
 458                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 459                 welcomeNote.setCreationDate(Calendar.getInstance());
 460                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 461                 welcomeNote.setContent(getString(R.string.welcome_note));
 462                 welcomeNote.getTitle();
 463                 welcomeNote.save();
 464             } catch (BucketObjectNameInvalid e) {
 465                 // this won&#x27;t happen because welcome-android is a valid name
 466             }
 467 
 468             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 469             SharedPreferences.Editor editor = preferences.edit();
 470             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 471             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 472             editor.apply();
 473         }
 474     }
 475 
 476     private void checkForSharedContent() {
 477         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 478             // Check share action
 479             Intent intent = getIntent();
 480             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 481             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 482 
<abbr title=" 483             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 483             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 484             String intentAction = StrUtils.notNullStr(intent.getAction());
 485             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 486             if (!TextUtils.isEmpty(text)) {
 487                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 488                     text = subject + &quot;\n\n&quot; + text;
 489                 }
 490                 Note note = mNotesBucket.newObject();
 491                 note.setCreationDate(Calendar.getInstance());
 492                 note.setModificationDate(note.getCreationDate());
 493                 note.setContent(text);
 494                 note.save();
 495                 setCurrentNote(note);
 496                 mShouldSelectNewNote = true;
 497 
 498                 AnalyticsTracker.track(
 499                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 500                         AnalyticsTracker.CATEGORY_NOTE,
 501                         &quot;external_share&quot;
 502                 );
 503 
 504                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 505                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 506                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 507                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 508                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 509                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 510                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 511                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 512                     }
 513                 }
 514             }
 515         }
 516     }
 517 
 518     private void updateNavigationDrawerItems() {
 519         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 520         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 521         if (isAlphaSort) {
 522             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 523         } else {
 524             tagCursor = Tag.allWithName(mTagsBucket).execute();
 525         }
 526 
 527         mTagsAdapter.changeCursor(tagCursor);
 528         mNavigationMenu.removeGroup(GROUP_SECONDARY);
 529         mNavigationMenu.removeGroup(GROUP_TERTIARY);
 530 
 531         if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 532             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 532             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionVðŸ”µ</abbr>
 533 
 534             for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 535                 String name = mTagsAdapter.getItem(i).name;
 536                 int id = (int) mTagsAdapter.getItem(i).id;
 537 
 538                 if (id &gt;= 0) { // Custom tags have a positive ID.
 539                     mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 540                 }
 541             }
 542 
<abbr title=" 543             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_untagged_24dp).setCheckable(true);"> 543             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untaggedðŸ”µ</abbr>
 544             setSelectedTagActive();
 545         }
 546     }
 547 
 548     public void launchEditTags(View view) {
 549         startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 550     }
 551 
 552     private void setSelectedTagActive() {
 553         if (mSelectedTag == null) {
 554             mSelectedTag = mTagsAdapter.getDefaultItem();
 555         }
 556 
 557         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 558 
 559         if (selectedMenuItem != null) {
 560             selectedMenuItem.setChecked(true);
 561         } else {
 562             mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 563         }
 564 
 565         setTitle(mSelectedTag.name);
 566     }
 567 
 568     public TagsAdapter.TagMenuItem getSelectedTag() {
 569         if (mSelectedTag == null) {
 570             mSelectedTag = mTagsAdapter.getDefaultItem();
 571         }
 572 
 573         return mSelectedTag;
 574     }
 575 
 576     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 577     public void updateTrashMenuItem() {
 578         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 579             return;
 580 
 581         // Disable the trash icon if there are no notes trashed.
 582         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 583         if (query.count() == 0) {
 584             mEmptyTrashMenuItem.setEnabled(false);
 585         } else {
 586             mEmptyTrashMenuItem.setEnabled(true);
 587         }
 588     }
 589 
 590     private void addEditorFragment() {
 591         FragmentManager fm = getSupportFragmentManager();
 592         FragmentTransaction ft = fm.beginTransaction();
 593         mNoteEditorFragment = new NoteEditorFragment();
 594         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 595         ft.commitAllowingStateLoss();
 596         fm.executePendingTransactions();
 597     }
 598 
 599     private boolean userAccountRequired() {
 600         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 601     }
 602 
 603     /**
 604      * Checks for a previously valid user that is now not authenticated
 605      * Also checks if user account is required (added in version 1.5.6)
 606      *
 607      * @return true if user has invalid authorization
 608      */
 609     private boolean userAuthenticationIsInvalid() {
 610         Simplenote currentApp = (Simplenote) getApplication();
 611         Simperium simperium = currentApp.getSimperium();
 612         User user = simperium.getUser();
 613         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 614         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 615                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 616     }
 617 
 618     public boolean userIsUnauthorized() {
 619         Simplenote currentApp = (Simplenote) getApplication();
 620         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 621     }
 622 
 623     public void setCurrentNote(Note note) {
 624         mCurrentNote = note;
 625     }
 626 
 627     public NoteListFragment getNoteListFragment() {
 628         return mNoteListFragment;
 629     }
 630 
 631     @Override
 632     public boolean onCreateOptionsMenu(final Menu menu) {
 633         super.onCreateOptionsMenu(menu);
 634         MenuInflater inflater = getMenuInflater();
 635         inflater.inflate(R.menu.notes_list, menu);
 636 
 637         // restore the search query if on a landscape tablet
 638         String searchQuery = null;
 639         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 640             searchQuery = mSearchView.getQuery().toString();
 641 
 642         mSearchMenuItem = menu.findItem(R.id.menu_search);
 643         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 644         LinearLayout searchEditFrame = mSearchView.findViewById(R.id.search_edit_frame);
 645         ((LinearLayout.LayoutParams) searchEditFrame.getLayoutParams()).leftMargin = 0;
 646 
 647         if (!TextUtils.isEmpty(searchQuery)) {
 648             mSearchView.setQuery(searchQuery, false);
 649             mSearchMenuItem.expandActionView();
 650         } else {
 651             // Workaround for setting the search placeholder text color
 652             @SuppressWarnings(&quot;ResourceType&quot;)
 653             String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
 654             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 655                     hintHexColor,
 656                     getString(R.string.search))));
 657         }
 658 
 659         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 660             @Override
 661             public boolean onQueryTextChange(String newText) {
 662                 if (mSearchMenuItem.isActionViewExpanded()) {
 663                     getNoteListFragment().searchNotes(newText, false);
 664                 }
 665 
 666                 return true;
 667             }
 668 
 669             @Override
 670             public boolean onQueryTextSubmit(String queryText) {
 671                 getNoteListFragment().searchNotes(queryText, true);
 672 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 673                 getNoteListFragment().addSearchItem(queryText, 0);</span>
 674 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 675                 return true;</span>
 676 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677                 checkEmptyListText(true);</span>
 678 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 679                 return true;
 680             }
 681         });
 682 
 683         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 684             @Override
 685             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 686                 mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 687                 getNoteListFragment().searchNotes(&quot;&quot;, false);
 688 
 689                 if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 690                     updateActionsForLargeLandscape(menu);
 691                 }
 692 
 693                 checkEmptyListText(true);
 694 
 695                 // Hide floating action button and list bottom padding.
 696                 if (mNoteListFragment != null) {
 697                     mNoteListFragment.setFloatingActionButtonVisible(false);
 698                     mNoteListFragment.showListPadding(false);
 699                 }
 700 
 701                 AnalyticsTracker.track(
 702                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 703                         AnalyticsTracker.CATEGORY_NOTE,
 704                         &quot;action_bar_search_tap&quot;
 705                 );
 706                 return true;
 707             }
 708 
 709             @Override
 710             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 711                 mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 712 
 713                 if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 714                     updateActionsForLargeLandscape(menu);
 715                 }
 716 
 717                 // Show floating action button and list bottom padding.
 718                 if (mNoteListFragment != null) {
 719                     mNoteListFragment.setFloatingActionButtonVisible(true);
 720                     mNoteListFragment.showListPadding(true);
 721                 }
 722 
 723                 mTabletSearchQuery = &quot;&quot;;
 724                 mSearchView.setQuery(&quot;&quot;, false);
 725                 checkEmptyListText(false);
 726                 getNoteListFragment().clearSearch();
 727                 return true;
 728             }
 729         });
 730 
 731         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 732             @Override
 733             public boolean onMenuItemClick(MenuItem item) {
 734                 if (!mSearchMenuItem.isActionViewExpanded())
 735                     showDetailPlaceholder();
 736                 return false;
 737             }
 738         });
 739 
 740         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 741         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 742             trashItem.setTitle(R.string.undelete);
 743             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 744         } else {
 745             trashItem.setTitle(R.string.delete);
 746             trashItem.setIcon(R.drawable.ic_trash_24dp);
 747         }
 748 
 749         if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 750             // Restore the search query on landscape tablets
 751             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 752                 mSearchMenuItem.expandActionView();
 753                 mSearchView.setQuery(mTabletSearchQuery, false);
 754                 mSearchView.clearFocus();
 755             }
 756 
 757             updateActionsForLargeLandscape(menu);
 758         } else {
 759             menu.findItem(R.id.menu_search).setVisible(true);
 760             menu.findItem(R.id.menu_share).setVisible(false);
 761             menu.findItem(R.id.menu_view_info).setVisible(false);
 762             menu.findItem(R.id.menu_checklist).setVisible(false);
 763             menu.findItem(R.id.menu_history).setVisible(false);
 764             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 765             menu.findItem(R.id.menu_sidebar).setVisible(false);
 766             trashItem.setVisible(false);
 767             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 768         }
 769 
 770         if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
 771             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 772             mEmptyTrashMenuItem.setVisible(true);
 773 
 774             updateTrashMenuItem();
 775 
 776             menu.findItem(R.id.menu_search).setVisible(false);
 777             menu.findItem(R.id.menu_share).setVisible(false);
 778             menu.findItem(R.id.menu_history).setVisible(false);
 779             menu.findItem(R.id.menu_checklist).setVisible(false);
 780         }
 781 
 782         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.toolbarIconColor);
 783 
 784         return true;
 785     }
 786 
 787     @Override
 788     public boolean onOptionsItemSelected(MenuItem item) {
 789         if (mDrawerToggle.onOptionsItemSelected(item)) {
 790             return true;
 791         }
 792         switch (item.getItemId()) {
 793             case R.id.menu_sidebar:
 794                 FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 795                 if (mNoteListFragment.isHidden()) {
 796                     ft.show(mNoteListFragment);
 797                 } else {
 798                     ft.hide(mNoteListFragment);
 799                 }
 800                 ft.commitNowAllowingStateLoss();
 801                 mIsTabetFullscreen = mNoteListFragment.isHidden();
 802                 return true;
 803             case R.id.menu_markdown_preview:
 804                 if (mIsShowingMarkdown) {
 805                     item.setIcon(R.drawable.ic_visibility_on_24dp);
 806                     item.setTitle(getString(R.string.markdown_show));
 807                     setMarkdownShowing(false);
 808                     mCurrentNote.setPreviewEnabled(false);
 809                 } else {
 810                     item.setIcon(R.drawable.ic_visibility_off_24dp);
 811                     item.setTitle(getString(R.string.markdown_hide));
 812                     setMarkdownShowing(true);
 813                     mCurrentNote.setPreviewEnabled(true);
 814                 }
 815 
 816                 mCurrentNote.save();
 817                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.toolbarIconColor);
 818 
 819                 return true;
 820             case R.id.menu_delete:
 821                 if (mNoteEditorFragment != null) {
 822                     if (mCurrentNote != null) {
 823                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 824                         mCurrentNote.setModificationDate(Calendar.getInstance());
 825                         mCurrentNote.save();
 826 
 827                         updateViewsAfterTrashAction(mCurrentNote);
 828                     }
 829                 }
 830                 return true;
 831             case R.id.menu_empty_trash:
<abbr title=" 832                 AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.style.Dialog));"> 832                 AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.styleðŸ”µ</abbr>
 833 
 834                 alert.setTitle(R.string.empty_trash);
 835                 alert.setMessage(R.string.confirm_empty_trash);
 836                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 837                     public void onClick(DialogInterface dialog, int whichButton) {
 838                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 839                         AnalyticsTracker.track(
 840                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 841                                 AnalyticsTracker.CATEGORY_NOTE,
 842                                 &quot;overflow_menu&quot;
 843                         );
 844                     }
 845                 });
 846                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 847                     public void onClick(DialogInterface dialog, int whichButton) {
 848                         // Do nothing, just closing the dialog
 849                     }
 850                 });
 851                 alert.show();
 852                 return true;
 853             case android.R.id.home:
 854                 invalidateOptionsMenu();
 855                 return true;
 856             default:
 857                 return super.onOptionsItemSelected(item);
 858         }
 859     }
 860 
 861     @Override
 862     public boolean onPrepareOptionsMenu(Menu menu) {
 863         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 864 
 865         if (mIsShowingMarkdown) {
 866             markdownItem.setIcon(R.drawable.ic_visibility_off_24dp);
 867             markdownItem.setTitle(getString(R.string.markdown_hide));
 868         } else {
 869             markdownItem.setIcon(R.drawable.ic_visibility_on_24dp);
 870             markdownItem.setTitle(getString(R.string.markdown_show));
 871         }
 872 
 873         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.toolbarIconColor);
 874 
 875         return super.onPrepareOptionsMenu(menu);
 876     }
 877 
 878     public void submitSearch(String selection) {
 879         if (mSearchView != null) {
 880             String query = mSearchView.getQuery().toString();
 881 
 882             if (query.endsWith(TAG_PREFIX)) {
<abbr title=" 883                 mSearchView.setQuery(query.substring(0, query.lastIndexOf(TAG_PREFIX)) + selection, true);"> 883                 mSearchView.setQuery(query.substring(0, query.lastIndexOf(TAG_PREFIX)) + selection, true)ðŸ”µ</abbr>
 884             } else {
 885                 mSearchView.setQuery(selection, true);
 886             }
 887         }
 888     }
 889 
 890     private void updateActionsForLargeLandscape(Menu menu) {
 891         if (mCurrentNote != null) {
 892             menu.findItem(R.id.menu_checklist).setVisible(true);
 893             menu.findItem(R.id.menu_delete).setVisible(true);
 894             menu.findItem(R.id.menu_history).setVisible(true);
 895             menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 896             menu.findItem(R.id.menu_share).setVisible(true);
 897             menu.findItem(R.id.menu_sidebar).setVisible(true);
 898             menu.findItem(R.id.menu_view_info).setVisible(true);
 899         } else {
 900             menu.findItem(R.id.menu_checklist).setVisible(false);
 901             menu.findItem(R.id.menu_delete).setVisible(false);
 902             menu.findItem(R.id.menu_history).setVisible(false);
 903             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 904             menu.findItem(R.id.menu_share).setVisible(false);
 905             menu.findItem(R.id.menu_sidebar).setVisible(false);
 906             menu.findItem(R.id.menu_view_info).setVisible(false);
 907         }
 908 
 909         menu.findItem(R.id.menu_empty_trash).setVisible(false);
 910     }
 911 
 912     public void updateViewsAfterTrashAction(Note note) {
 913         if (note == null || isFinishing()) {
 914             return;
 915         }
 916 
 917         if (note.isDeleted()) {
 918             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 919             deletedNoteIds.add(note.getSimperiumKey());
 920             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 921             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 922             AnalyticsTracker.track(
 923                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 924                     AnalyticsTracker.CATEGORY_NOTE,
 925                     &quot;overflow_menu&quot;
 926             );
 927         } else {
 928             AnalyticsTracker.track(
 929                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 930                     AnalyticsTracker.CATEGORY_NOTE,
 931                     &quot;overflow_menu&quot;
 932             );
 933         }
 934 
 935         // If we just deleted/restored the active note, show the placeholder
 936         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 937             showDetailPlaceholder();
 938         }
 939 
 940         NoteListFragment fragment = getNoteListFragment();
 941         if (fragment != null) {
 942             fragment.getPrefs();
 943             fragment.refreshList();
 944         }
 945 
 946         invalidateOptionsMenu();
 947     }
 948 
 949     public void setMarkdownShowing(boolean isMarkdownShowing) {
 950         mIsShowingMarkdown = isMarkdownShowing;
 951         if (mNoteEditorFragment != null) {
 952             if (isMarkdownShowing) {
 953                 mNoteEditorFragment.showMarkdown();
 954             } else {
 955                 mNoteEditorFragment.hideMarkdown();
 956             }
 957         }
 958         invalidateOptionsMenu();
 959     }
 960 
 961     /**
 962      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 963      * the item with the given ID was selected. Used for tablets only.
 964      */
 965     @Override
<abbr title=" 966     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 966     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 967         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 968             // Launch the editor activity
 969             Bundle arguments = new Bundle();
 970             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 971             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 972             arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 973 
 974             if (matchOffsets != null) {
 975                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 976             }
 977 
 978             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 979             editNoteIntent.putExtras(arguments);
 980             if (mNoteListFragment.isHidden()) {
 981                 editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 982             }
 983             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 984         } else {
 985             mNoteEditorFragment.setNote(noteID, matchOffsets);
 986             getNoteListFragment().setNoteSelected(noteID);
 987             setMarkdownShowing(isPreviewEnabled);
 988 
 989             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 990                 mTabletSearchQuery = mSearchView.getQuery().toString();
 991             }
 992 
 993             mNoteEditorFragment.clearMarkdown();
 994 
 995             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 996                 setMarkdownShowing(false);
 997             }
 998 
 999             invalidateOptionsMenu();
1000         }
1001 
1002         AnalyticsTracker.track(
1003                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
1004                 AnalyticsTracker.CATEGORY_NOTE,
1005                 &quot;note_list_row_tap&quot;
1006         );
1007     }
1008 
1009     @Override
1010     public void onUserCreated(User user) {
1011         // New account created
1012         AnalyticsTracker.track(
1013                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
1014                 AnalyticsTracker.CATEGORY_USER,
1015                 &quot;account_created_from_login_activity&quot;
1016         );
1017     }
1018 
1019     public void onUserStatusChange(User.Status status) {
1020         switch (status) {
1021             // successfully used access token to connect to simperium bucket
1022             case AUTHORIZED:
1023                 runOnUiThread(new Runnable() {
1024                     @Override
1025                     public void run() {
1026                         if (!mNotesBucket.hasChangeVersion()) {
1027                             setToolbarProgressVisibility(true);
1028                         }
1029                     }
1030                 });
1031                 break;
1032 
1033             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
1034             case NOT_AUTHORIZED:
1035                 runOnUiThread(new Runnable() {
1036                     @Override
1037                     public void run() {
1038                         startLoginActivity(true);
1039                     }
1040                 });
1041                 break;
1042 
<abbr title="1043             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything">1043             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
1044             case UNKNOWN:
1045                 break;
1046         }
1047     }
1048 
1049     private void setToolbarProgressVisibility(boolean isVisible) {
1050         if (getSupportActionBar() != null) {
1051             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1052         }
1053     }
1054 
1055     public void startLoginActivity(boolean signInFirst) {
1056         // Clear some account-specific prefs
1057         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
1058         editor.remove(PrefUtils.PREF_WP_TOKEN);
1059         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
1060         editor.apply();
1061 
1062         Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
1063         startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
1064     }
1065 
1066     @Override
1067     public void recreate() {
1068         Handler handler = new Handler();
1069         handler.post(new Runnable() {
1070             @Override
1071             public void run() {
1072                 NotesActivity.super.recreate();
1073             }
1074         });
1075     }
1076 
1077     @Override
1078     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1079         super.onActivityResult(requestCode, resultCode, data);
1080         switch (requestCode) {
1081             case Simplenote.INTENT_PREFERENCES:
<abbr title="1082                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1082                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
1083                 invalidateOptionsMenu();
1084                 NoteListFragment fragment = getNoteListFragment();
1085                 if (fragment != null) {
1086                     fragment.getPrefs();
1087                     fragment.refreshList();
1088                 }
1089 
1090                 break;
1091             case Simplenote.INTENT_EDIT_NOTE:
1092                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
1093                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1094                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1095                         if (noteId != null) {
1096                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1097                             deletedNoteIds.add(noteId);
1098                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title="1099                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));">1099                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
1100                         }
<abbr title="1101                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1101                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
1102                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1103                         mNoteListFragment.setNoteSelected(selectedNoteId);
1104                         if (mNoteEditorFragment != null) {
1105                             mNoteEditorFragment.setNote(selectedNoteId);
1106                         }
1107                     }
1108                 }
1109                 break;
1110             case Simperium.SIGNUP_SIGNIN_REQUEST:
1111                 invalidateOptionsMenu();
1112 
1113                 Simplenote app = (Simplenote) getApplication();
1114                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1115                 CrashUtils.setCurrentUser(app.getSimperium().getUser());
1116 
1117                 AnalyticsTracker.track(
1118                         AnalyticsTracker.Stat.USER_SIGNED_IN,
1119                         AnalyticsTracker.CATEGORY_USER,
1120                         &quot;signed_in_from_login_activity&quot;
1121                 );
1122 
1123                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1124                     finish();
1125                 }
1126 
1127                 break;
1128         }
1129     }
1130 
1131     @Override
1132     public void onUndo() {
1133         if (mUndoBarController == null) return;
1134 
1135         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1136         if (deletedNoteIds != null) {
1137             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1138                 Note deletedNote;
1139                 try {
1140                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1141                 } catch (BucketObjectMissingException e) {
1142                     return;
1143                 }
1144                 if (deletedNote != null) {
1145                     deletedNote.setDeleted(false);
1146                     deletedNote.setModificationDate(Calendar.getInstance());
1147                     deletedNote.save();
1148                     NoteListFragment fragment = getNoteListFragment();
1149                     if (fragment != null) {
1150                         fragment.getPrefs();
1151                         fragment.refreshList();
1152                     }
1153                 }
1154             }
1155         }
1156     }
1157 
1158     @Override
1159     protected void onPostCreate(Bundle savedInstanceState) {
1160         super.onPostCreate(savedInstanceState);
1161         // Sync the toggle state after onRestoreInstanceState has occurred.
1162         mDrawerToggle.syncState();
1163     }
1164 
1165     @Override
1166     public void onConfigurationChanged(@NonNull Configuration newConfig) {
1167         super.onConfigurationChanged(newConfig);
1168 
1169         mDrawerToggle.onConfigurationChanged(newConfig);
1170 
1171         if (DisplayUtils.isLargeScreen(this)) {
1172             mIsShowingMarkdown = false;
1173 
1174             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1175                 // Add the editor fragment
1176                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1177                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1177                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
1178                 } else if (DisplayUtils.isLandscape(this)) {
1179                     addEditorFragment();
1180                 }
1181 
1182                 if (mNoteListFragment != null) {
1183                     mNoteListFragment.setActivateOnItemClick(true);
1184                     mNoteListFragment.setDividerVisible(true);
1185                 }
1186 
1187                 // Select the current note on a tablet
1188                 if (mCurrentNote != null) {
<abbr title="1189                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1189                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
1190                 } else {
1191                     mNoteEditorFragment.setPlaceholderVisible(true);
1192                     mNoteListFragment.getListView().clearChoices();
1193                 }
1194 
1195                 invalidateOptionsMenu();
<abbr title="1196             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait">1196             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to poðŸ”µ</abbr>
1197             } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1198                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1198                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(),ðŸ”µ</abbr>
1199             }
1200         }
1201 
1202         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1203             // Remove the editor fragment when rotating back to portrait
1204             mCurrentNote = null;
1205             if (mNoteListFragment != null) {
1206                 mNoteListFragment.setActivateOnItemClick(false);
1207                 mNoteListFragment.setDividerVisible(false);
1208                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1209                 mNoteListFragment.refreshList();
1210             }
1211             FragmentManager fm = getSupportFragmentManager();
1212             FragmentTransaction ft = fm.beginTransaction();
1213             ft.remove(mNoteEditorFragment);
1214             mNoteEditorFragment = null;
1215             ft.commitAllowingStateLoss();
1216             fm.executePendingTransactions();
1217             invalidateOptionsMenu();
1218         }
1219     }
1220 
1221     public void checkEmptyListText(boolean isSearch) {
1222         if (isSearch) {
1223             if (DisplayUtils.isLandscape(this) &amp;&amp; !DisplayUtils.isLargeScreen(this)) {
1224                 getNoteListFragment().setEmptyListImage(-1);
1225             } else {
1226                 getNoteListFragment().setEmptyListImage(R.drawable.ic_search_24dp);
1227             }
1228 
1229             getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_search));
1230         } else if (mSelectedTag != null) {
1231             if (mSelectedTag.id == ALL_NOTES_ID) {
1232                 getNoteListFragment().setEmptyListImage(R.drawable.ic_notes_24dp);
1233                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_all));
1234             } else if (mSelectedTag.id == TRASH_ID) {
1235                 getNoteListFragment().setEmptyListImage(R.drawable.ic_trash_24dp);
1236                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_trash));
1237                 AnalyticsTracker.track(
1238                         AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1239                         AnalyticsTracker.CATEGORY_NOTE,
1240                         &quot;trash_filter_selected&quot;
1241                 );
1242             } else if (mSelectedTag.id == UNTAGGED_NOTES_ID) {
1243                 getNoteListFragment().setEmptyListImage(R.drawable.ic_untagged_24dp);
1244                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_untagged));
1245             } else {
1246                 getNoteListFragment().setEmptyListImage(R.drawable.ic_tag_24dp);
<abbr title="1247                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_tag, mSelectedTag.name));">1247                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_tag, mSelectedTaðŸ”µ</abbr>
1248             }
1249         } else {
1250             getNoteListFragment().setEmptyListImage(R.drawable.ic_notes_24dp);
1251             getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_all));
1252         }
1253     }
1254 
1255     public void showDetailPlaceholder() {
1256         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1257             mCurrentNote = null;
1258             mNoteEditorFragment.setPlaceholderVisible(true);
1259             mNoteEditorFragment.clearMarkdown();
1260             mNoteEditorFragment.hideMarkdown();
1261             mIsShowingMarkdown = false;
1262         }
1263     }
1264 
1265     public void stopListeningToNotesBucket() {
1266         mNotesBucket.removeOnNetworkChangeListener(this);
1267         mNotesBucket.removeOnSaveObjectListener(this);
1268         mNotesBucket.removeOnDeleteObjectListener(this);
1269     }
1270 
1271     // Returns the appropriate view to show the undo bar within
1272     private View getUndoView() {
1273         View undoView = mFragmentsContainer;
1274         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1275                 getNoteListFragment() != null &amp;&amp;
1276                 getNoteListFragment().getRootView() != null) {
1277             undoView = getNoteListFragment().getRootView();
1278         }
1279 
1280         return undoView;
1281     }
1282 
1283     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1284         if (mUndoBarController != null) {
1285             mUndoBarController.setDeletedNoteIds(noteIds);
1286             mUndoBarController.showUndoBar(
1287                     getUndoView(),
<abbr title="1288                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1288                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1289             );
1290         }
1291     }
1292 
1293     /* Simperium Bucket Listeners */
1294     // received a change from the network, refresh the list
1295     @Override
1296     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1297         runOnUiThread(new Runnable() {
1298             @Override
1299             public void run() {
1300                 if (type == Bucket.ChangeType.INDEX) {
1301                     setToolbarProgressVisibility(false);
1302                 }
1303                 mNoteListFragment.refreshList();
1304             }
1305         });
1306     }
1307 
1308     @Override
1309     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1310         runOnUiThread(new Runnable() {
1311             @Override
1312             public void run() {
1313                 mNoteListFragment.refreshList();
1314             }
1315         });
1316     }
1317 
1318     @Override
1319     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1320         runOnUiThread(new Runnable() {
1321             @Override
1322             public void run() {
1323                 mNoteListFragment.refreshList();
1324             }
1325         });
1326     }
1327 
1328     @Override
1329     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1330         // noop, NoteEditorFragment will handle this
1331     }
1332 
1333     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1334 
1335         @Override
1336         protected Void doInBackground(Void... voids) {
1337             if (mNotesBucket == null) return null;
1338 
1339             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1340             Bucket.ObjectCursor c = query.execute();
1341             while (c.moveToNext()) {
1342                 c.getObject().delete();
1343             }
1344 
1345             return null;
1346         }
1347 
1348         @Override
1349         protected void onPostExecute(Void nada) {
1350             showDetailPlaceholder();
1351         }
1352     }
1353 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.content.DialogInterface;
   5 import android.content.Intent;
   6 import android.content.SharedPreferences;
   7 import android.content.res.ColorStateList;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.Handler;
  12 import android.text.TextUtils;
  13 import android.view.Menu;
  14 import android.view.MenuInflater;
  15 import android.view.MenuItem;
  16 import android.view.View;
  17 import android.widget.LinearLayout;
  18 import android.widget.ListView;
  19 import android.widget.ProgressBar;
  20 
  21 import androidx.annotation.NonNull;
  22 import androidx.appcompat.app.ActionBar;
  23 import androidx.appcompat.app.ActionBarDrawerToggle;
  24 import androidx.appcompat.app.AlertDialog;
  25 import androidx.appcompat.app.AppCompatActivity;
  26 import androidx.appcompat.view.ContextThemeWrapper;
  27 import androidx.appcompat.widget.SearchView;
  28 import androidx.appcompat.widget.Toolbar;
  29 import androidx.core.view.GravityCompat;
  30 import androidx.drawerlayout.widget.DrawerLayout;
  31 import androidx.fragment.app.FragmentManager;
  32 import androidx.fragment.app.FragmentTransaction;
  33 import androidx.preference.PreferenceManager;
  34 
  35 import com.automattic.simplenote.analytics.AnalyticsTracker;
  36 import com.automattic.simplenote.models.Note;
  37 import com.automattic.simplenote.models.Tag;
  38 import com.automattic.simplenote.utils.CrashUtils;
  39 import com.automattic.simplenote.utils.DisplayUtils;
  40 import com.automattic.simplenote.utils.DrawableUtils;
  41 import com.automattic.simplenote.utils.HtmlCompat;
  42 import com.automattic.simplenote.utils.PrefUtils;
  43 import com.automattic.simplenote.utils.StrUtils;
  44 import com.automattic.simplenote.utils.TagsAdapter;
  45 import com.automattic.simplenote.utils.ThemeUtils;
  46 import com.automattic.simplenote.utils.UndoBarController;
  47 import com.google.android.material.navigation.NavigationView;
  48 import com.simperium.Simperium;
  49 import com.simperium.client.Bucket;
  50 import com.simperium.client.BucketObjectMissingException;
  51 import com.simperium.client.BucketObjectNameInvalid;
  52 import com.simperium.client.Query;
  53 import com.simperium.client.User;
  54 
  55 import org.wordpress.passcodelock.AppLockManager;
  56 
  57 import java.util.ArrayList;
  58 import java.util.Calendar;
  59 import java.util.HashMap;
  60 import java.util.List;
  61 import java.util.Map;
  62 
  63 import static com.automattic.simplenote.NoteListFragment.TAG_PREFIX;
  64 import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  65 import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  66 import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  67 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  68 import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  69 import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  70 import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  71 import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  72 import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  73 import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  74 
  75 public class NotesActivity extends AppCompatActivity implements
<abbr title="  76         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  76         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  77         Bucket.Listener&lt;Note&gt; {
  78 
  79     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  80     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  81     protected Bucket&lt;Note&gt; mNotesBucket;
  82     protected Bucket&lt;Tag&gt; mTagsBucket;
  83     private boolean mIsShowingMarkdown;
  84     private boolean mShouldSelectNewNote;
  85     private boolean mIsSettingsClicked;
  86     private boolean mIsTabetFullscreen;
  87 
  88     private String mTabletSearchQuery;
  89     private UndoBarController mUndoBarController;
  90     private View mFragmentsContainer;
  91     private SearchView mSearchView;
  92     private MenuItem mSearchMenuItem;
  93     private NoteListFragment mNoteListFragment;
  94     private NoteEditorFragment mNoteEditorFragment;
  95     private Note mCurrentNote;
  96     private MenuItem mEmptyTrashMenuItem;
  97 
  98     // Menu drawer
  99     private static final int GROUP_PRIMARY = 100;
 100     private static final int GROUP_SECONDARY = 101;
 101     private static final int GROUP_TERTIARY = 102;
 102     private DrawerLayout mDrawerLayout;
 103     private Menu mNavigationMenu;
 104     private ActionBarDrawerToggle mDrawerToggle;
 105     private TagsAdapter mTagsAdapter;
 106     private TagsAdapter.TagMenuItem mSelectedTag;
 107     // Tags bucket listener
 108     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 109         void updateNavigationDrawer() {
 110             runOnUiThread(new Runnable() {
 111                 public void run() {
 112                     updateNavigationDrawerItems();
 113                 }
 114             });
 115         }
 116 
 117         @Override
 118         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 119             updateNavigationDrawer();
 120         }
 121 
 122         @Override
 123         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 124             updateNavigationDrawer();
 125         }
 126 
 127         @Override
 128         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 129             updateNavigationDrawer();
 130         }
 131 
 132         @Override
 133         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 134             // noop
 135         }
 136     };
 137 
 138     @Override
 139     protected void onCreate(Bundle savedInstanceState) {
 140         ThemeUtils.setTheme(this);
 141         super.onCreate(savedInstanceState);
 142 
 143         setContentView(R.layout.activity_notes);
 144 
 145         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 146 
 147         Simplenote currentApp = (Simplenote) getApplication();
 148         if (mNotesBucket == null) {
 149             mNotesBucket = currentApp.getNotesBucket();
 150         }
 151 
 152         if (mTagsBucket == null) {
 153             mTagsBucket = currentApp.getTagsBucket();
 154         }
 155 
 156         Toolbar toolbar = findViewById(R.id.toolbar);
 157         setSupportActionBar(toolbar);
 158         configureNavigationDrawer(toolbar);
 159 
 160         if (savedInstanceState == null) {
 161             mNoteListFragment = new NoteListFragment();
 162             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 163             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 164             fragmentTransaction.commit();
 165         } else {
<abbr title=" 166             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 166             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 167         }
 168         mIsTabetFullscreen = mNoteListFragment.isHidden();
 169 
 170         if (DisplayUtils.isLargeScreen(this)) {
 171             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 172                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 172                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 173             } else if (DisplayUtils.isLandscape(this)) {
 174                 addEditorFragment();
 175             }
 176         }
 177 
 178         // enable ActionBar app icon to behave as action to toggle nav drawer
 179         ActionBar actionBar = getSupportActionBar();
 180         if (actionBar != null) {
 181             actionBar.setDisplayHomeAsUpEnabled(true);
 182             actionBar.setHomeButtonEnabled(true);
 183 
 184             // Add loading indicator to show when indexing
<abbr title=" 185             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 185             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 186             actionBar.setDisplayShowCustomEnabled(true);
 187             actionBar.setCustomView(progressBar);
 188             setToolbarProgressVisibility(false);
 189         }
 190 
 191         mUndoBarController = new UndoBarController(this);
 192 
 193         // Creates &#x27;Welcome&#x27; note
 194         checkForFirstLaunch();
 195 
 196         checkForSharedContent();
 197 
 198         currentApp.getSimperium().setOnUserCreatedListener(this);
 199         currentApp.getSimperium().setUserStatusChangeListener(this);
 200     }
 201 
 202     @Override
 203     protected void onResume() {
 204         super.onResume();
 205 
 206         // Ensure user has valid authorization
 207         if (userAuthenticationIsInvalid()) {
 208             startLoginActivity(true);
 209             Intent intent = getIntent();
 210 
 211             if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 212                     intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 213                 AnalyticsTracker.track(
 214                         NOTE_WIDGET_SIGN_IN_TAPPED,
 215                         CATEGORY_WIDGET,
 216                         &quot;note_widget_sign_in_tapped&quot;
 217                 );
 218             }
 219         }
 220 
 221         disableScreenshotsIfLocked(this);
 222 
 223         mNotesBucket.start();
 224         mTagsBucket.start();
 225 
 226         mNotesBucket.addOnNetworkChangeListener(this);
 227         mNotesBucket.addOnSaveObjectListener(this);
 228         mNotesBucket.addOnDeleteObjectListener(this);
 229         mTagsBucket.addListener(mTagsMenuUpdater);
 230 
 231         updateNavigationDrawerItems();
 232 
 233         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 234         if (userIsUnauthorized()) {
 235             if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 236                 mSelectedTag = null;
 237                 mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 238             }
 239         }
 240 
 241         filterListBySelectedTag();
 242 
 243         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 244             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 244             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCuðŸ”µ</abbr>
 245             mShouldSelectNewNote = false;
 246         }
 247 
 248         if (mIsShowingMarkdown) {
 249             setMarkdownShowing(false);
 250         }
 251 
 252         FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 253         if(DisplayUtils.isLargeScreenLandscape(this)) {
 254             if (mIsTabetFullscreen) {
 255                 ft.hide(mNoteListFragment);
 256             } else {
 257                 ft.show(mNoteListFragment);
 258             }
 259         } else {
 260             ft.show(mNoteListFragment);
 261         }
 262         ft.commitNow();
 263     }
 264 
 265     @Override
 266     protected void onPause() {
 267         super.onPause();  // Always call the superclass method first
 268         mTagsBucket.removeListener(mTagsMenuUpdater);
 269         mTagsBucket.stop();
 270 
 271         mNotesBucket.removeOnNetworkChangeListener(this);
 272         mNotesBucket.removeOnSaveObjectListener(this);
 273         mNotesBucket.removeOnDeleteObjectListener(this);
 274         mNotesBucket.stop();
 275     }
 276 
 277     @Override
 278     public void setTitle(CharSequence title) {
 279         if (getSupportActionBar() != null) {
 280             getSupportActionBar().setTitle(title);
 281         }
 282     }
 283 
 284     @Override
 285     public void onBackPressed() {
 286         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 287             mDrawerLayout.closeDrawer(GravityCompat.START);
 288         } else {
 289             super.onBackPressed();
 290         }
 291     }
 292 
 293     @Override
 294     public void onActionModeCreated() {
 295         mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 296     }
 297 
 298     @Override
 299     public void onActionModeDestroyed() {
 300         if (mSearchMenuItem != null &amp;&amp; !mSearchMenuItem.isActionViewExpanded()) {
 301             mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 302         }
 303     }
 304 
 305     private ColorStateList getIconSelector() {
 306         int[][] states = new int[][] {
 307                 new int[] { android.R.attr.state_checked}, // checked
 308                 new int[] {-android.R.attr.state_checked}  // unchecked
 309         };
 310 
 311         int[] colors = new int[] {
 312                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 313                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.toolbarIconColor)
 314         };
 315 
 316         return new ColorStateList(states, colors);
 317     }
 318 
 319     private ColorStateList getTextSelector() {
 320         int[][] states = new int[][] {
 321             new int[] {-android.R.attr.state_enabled}, // disabled
 322             new int[] { android.R.attr.state_checked}, // checked
 323             new int[] {-android.R.attr.state_checked}  // unchecked
 324         };
 325 
 326         int[] colors = new int[] {
 327             getResources().getColor(R.color.text_title_disabled, getTheme()),
 328             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 329             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)
 330         };
 331 
 332         return new ColorStateList(states, colors);
 333     }
 334 
 335     private void configureNavigationDrawer(Toolbar toolbar) {
 336         ColorStateList iconSelector = getIconSelector();
 337         ColorStateList textSelector = getTextSelector();
 338         mDrawerLayout = findViewById(R.id.drawer_layout);
 339         NavigationView navigationView = findViewById(R.id.navigation_view);
 340         navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 341         navigationView.setItemIconTintList(iconSelector);
 342         navigationView.setItemTextColor(textSelector);
 343         navigationView.setNavigationItemSelectedListener(
 344             new NavigationView.OnNavigationItemSelectedListener() {
 345                 @Override
 346                 public boolean onNavigationItemSelected(@NonNull MenuItem item) {
 347                     mDrawerLayout.closeDrawer(GravityCompat.START);
 348 
 349                     if (item.getItemId() == SETTINGS_ID) {
 350                         AnalyticsTracker.track(
 351                                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 352                                 AnalyticsTracker.CATEGORY_TAG,
 353                                 &quot;selected_tag_in_navigation_drawer&quot;,
 354                                 new HashMap&lt;String, String&gt;(1){{put(&quot;tag&quot;, &quot;settings&quot;);}}
 355                         );
 356                         mIsSettingsClicked = true;
 357                         return false;
 358                     } else {
 359                         mSelectedTag = mTagsAdapter.getTagFromItem(item);
 360                         filterListBySelectedTag();
 361                         return true;
 362                     }
 363                 }
 364             }
 365         );
 366 
 367         mNavigationMenu = navigationView.getMenu();
<abbr title=" 368         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 368         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcoðŸ”µ</abbr>
<abbr title=" 369         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 369         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawðŸ”µ</abbr>
<abbr title=" 370         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 370         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(ðŸ”µ</abbr>
 371         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 372 
 373         if (mSelectedTag == null)
 374             mSelectedTag = mTagsAdapter.getDefaultItem();
 375 
 376         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 377                 R.string.close_drawer) {
 378             public void onDrawerClosed(View view) {
 379                 supportInvalidateOptionsMenu();
 380 
 381                 if (mIsSettingsClicked) {
 382                     Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 383                     startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 384                     mIsSettingsClicked = false;
 385                 }
 386             }
 387 
 388             public void onDrawerOpened(View drawerView) {
 389                 // noop
 390             }
 391 
 392             @Override
 393             public void onDrawerSlide(View drawerView, float slideOffset) {
 394                 super.onDrawerSlide(drawerView, 0f);
 395             }
 396         };
 397 
 398         mDrawerLayout.addDrawerListener(mDrawerToggle);
 399     }
 400 
 401     private void filterListBySelectedTag() {
 402         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 403 
 404         if (selectedMenuItem != null) {
 405             mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 406         } else {
 407             mSelectedTag = mTagsAdapter.getDefaultItem();
 408         }
 409 
 410         checkEmptyListText(mSearchMenuItem != null &amp;&amp; mSearchMenuItem.isActionViewExpanded());
 411 
 412         if (mNoteListFragment.isHidden()) {
 413             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 414             fragmentTransaction.show(mNoteListFragment);
 415             fragmentTransaction.commitNowAllowingStateLoss();
 416         }
 417 
 418         // Disable long press on notes when viewing Trash.
 419         if (mSelectedTag.id == TRASH_ID) {
 420             getNoteListFragment().getListView().setLongClickable(false);
 421         } else {
 422             getNoteListFragment().getListView().setLongClickable(true);
 423         }
 424 
 425         getNoteListFragment().refreshListFromNavSelect();
 426 
 427         Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 428 
 429         switch ((int) mSelectedTag.id) {
 430             case ALL_NOTES_ID:
 431                 properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 432                 break;
 433             case TRASH_ID:
 434                 properties.put(&quot;tag&quot;, &quot;trash&quot;);
 435                 break;
 436             case UNTAGGED_NOTES_ID:
 437                 properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 438                 break;
 439             default:
 440                 properties = null;
 441                 break;
 442         }
 443 
 444         AnalyticsTracker.track(
 445                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 446                 AnalyticsTracker.CATEGORY_TAG,
 447                 &quot;selected_tag_in_navigation_drawer&quot;,
 448                 properties
 449         );
 450 
 451         setSelectedTagActive();
 452     }
 453 
 454     private void checkForFirstLaunch() {
 455         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 456             // Create the welcome note
 457             try {
 458                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 459                 welcomeNote.setCreationDate(Calendar.getInstance());
 460                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 461                 welcomeNote.setContent(getString(R.string.welcome_note));
 462                 welcomeNote.getTitle();
 463                 welcomeNote.save();
 464             } catch (BucketObjectNameInvalid e) {
 465                 // this won&#x27;t happen because welcome-android is a valid name
 466             }
 467 
 468             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 469             SharedPreferences.Editor editor = preferences.edit();
 470             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 471             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 472             editor.apply();
 473         }
 474     }
 475 
 476     private void checkForSharedContent() {
 477         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 478             // Check share action
 479             Intent intent = getIntent();
 480             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 481             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 482 
<abbr title=" 483             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 483             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 484             String intentAction = StrUtils.notNullStr(intent.getAction());
 485             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 486             if (!TextUtils.isEmpty(text)) {
 487                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 488                     text = subject + &quot;\n\n&quot; + text;
 489                 }
 490                 Note note = mNotesBucket.newObject();
 491                 note.setCreationDate(Calendar.getInstance());
 492                 note.setModificationDate(note.getCreationDate());
 493                 note.setContent(text);
 494                 note.save();
 495                 setCurrentNote(note);
 496                 mShouldSelectNewNote = true;
 497 
 498                 AnalyticsTracker.track(
 499                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 500                         AnalyticsTracker.CATEGORY_NOTE,
 501                         &quot;external_share&quot;
 502                 );
 503 
 504                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 505                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 506                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 507                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 508                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 509                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 510                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 511                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 512                     }
 513                 }
 514             }
 515         }
 516     }
 517 
 518     private void updateNavigationDrawerItems() {
 519         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 520         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 521         if (isAlphaSort) {
 522             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 523         } else {
 524             tagCursor = Tag.allWithName(mTagsBucket).execute();
 525         }
 526 
 527         mTagsAdapter.changeCursor(tagCursor);
 528         mNavigationMenu.removeGroup(GROUP_SECONDARY);
 529         mNavigationMenu.removeGroup(GROUP_TERTIARY);
 530 
 531         if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 532             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 532             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionVðŸ”µ</abbr>
 533 
 534             for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 535                 String name = mTagsAdapter.getItem(i).name;
 536                 int id = (int) mTagsAdapter.getItem(i).id;
 537 
 538                 if (id &gt;= 0) { // Custom tags have a positive ID.
 539                     mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 540                 }
 541             }
 542 
<abbr title=" 543             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_untagged_24dp).setCheckable(true);"> 543             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untaggedðŸ”µ</abbr>
 544             setSelectedTagActive();
 545         }
 546     }
 547 
 548     public void launchEditTags(View view) {
 549         startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 550     }
 551 
 552     private void setSelectedTagActive() {
 553         if (mSelectedTag == null) {
 554             mSelectedTag = mTagsAdapter.getDefaultItem();
 555         }
 556 
 557         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 558 
 559         if (selectedMenuItem != null) {
 560             selectedMenuItem.setChecked(true);
 561         } else {
 562             mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 563         }
 564 
 565         setTitle(mSelectedTag.name);
 566     }
 567 
 568     public TagsAdapter.TagMenuItem getSelectedTag() {
 569         if (mSelectedTag == null) {
 570             mSelectedTag = mTagsAdapter.getDefaultItem();
 571         }
 572 
 573         return mSelectedTag;
 574     }
 575 
 576     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 577     public void updateTrashMenuItem() {
 578         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 579             return;
 580 
 581         // Disable the trash icon if there are no notes trashed.
 582         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 583         if (query.count() == 0) {
 584             mEmptyTrashMenuItem.setEnabled(false);
 585         } else {
 586             mEmptyTrashMenuItem.setEnabled(true);
 587         }
 588     }
 589 
 590     private void addEditorFragment() {
 591         FragmentManager fm = getSupportFragmentManager();
 592         FragmentTransaction ft = fm.beginTransaction();
 593         mNoteEditorFragment = new NoteEditorFragment();
 594         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 595         ft.commitAllowingStateLoss();
 596         fm.executePendingTransactions();
 597     }
 598 
 599     private boolean userAccountRequired() {
 600         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 601     }
 602 
 603     /**
 604      * Checks for a previously valid user that is now not authenticated
 605      * Also checks if user account is required (added in version 1.5.6)
 606      *
 607      * @return true if user has invalid authorization
 608      */
 609     private boolean userAuthenticationIsInvalid() {
 610         Simplenote currentApp = (Simplenote) getApplication();
 611         Simperium simperium = currentApp.getSimperium();
 612         User user = simperium.getUser();
 613         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 614         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 615                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 616     }
 617 
 618     public boolean userIsUnauthorized() {
 619         Simplenote currentApp = (Simplenote) getApplication();
 620         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 621     }
 622 
 623     public void setCurrentNote(Note note) {
 624         mCurrentNote = note;
 625     }
 626 
 627     public NoteListFragment getNoteListFragment() {
 628         return mNoteListFragment;
 629     }
 630 
 631     @Override
 632     public boolean onCreateOptionsMenu(final Menu menu) {
 633         super.onCreateOptionsMenu(menu);
 634         MenuInflater inflater = getMenuInflater();
 635         inflater.inflate(R.menu.notes_list, menu);
 636 
 637         // restore the search query if on a landscape tablet
 638         String searchQuery = null;
 639         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 640             searchQuery = mSearchView.getQuery().toString();
 641 
 642         mSearchMenuItem = menu.findItem(R.id.menu_search);
 643         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 644         LinearLayout searchEditFrame = mSearchView.findViewById(R.id.search_edit_frame);
 645         ((LinearLayout.LayoutParams) searchEditFrame.getLayoutParams()).leftMargin = 0;
 646 
 647         if (!TextUtils.isEmpty(searchQuery)) {
 648             mSearchView.setQuery(searchQuery, false);
 649             mSearchMenuItem.expandActionView();
 650         } else {
 651             // Workaround for setting the search placeholder text color
 652             @SuppressWarnings(&quot;ResourceType&quot;)
 653             String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
 654             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 655                     hintHexColor,
 656                     getString(R.string.search))));
 657         }
 658 
 659         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 660             @Override
 661             public boolean onQueryTextChange(String newText) {
 662                 if (mSearchMenuItem.isActionViewExpanded()) {
 663                     getNoteListFragment().searchNotes(newText, false);
 664                 }
 665 
 666                 return true;
 667             }
 668 
 669             @Override
 670             public boolean onQueryTextSubmit(String queryText) {
 671                 getNoteListFragment().searchNotes(queryText, true);
 672 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 673                 getNoteListFragment().addSearchItem(queryText, 0);</span>
 674 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 675                 return true;</span>
 676 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677                 checkEmptyListText(true);</span>
 678 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 679                 return true;
 680             }
 681         });
 682 
 683         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 684             @Override
 685             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 686                 mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 687                 getNoteListFragment().searchNotes(&quot;&quot;, false);
 688 
 689                 if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 690                     updateActionsForLargeLandscape(menu);
 691                 }
 692 
 693                 checkEmptyListText(true);
 694 
 695                 // Hide floating action button and list bottom padding.
 696                 if (mNoteListFragment != null) {
 697                     mNoteListFragment.setFloatingActionButtonVisible(false);
 698                     mNoteListFragment.showListPadding(false);
 699                 }
 700 
 701                 AnalyticsTracker.track(
 702                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 703                         AnalyticsTracker.CATEGORY_NOTE,
 704                         &quot;action_bar_search_tap&quot;
 705                 );
 706                 return true;
 707             }
 708 
 709             @Override
 710             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 711                 mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 712 
 713                 if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 714                     updateActionsForLargeLandscape(menu);
 715                 }
 716 
 717                 // Show floating action button and list bottom padding.
 718                 if (mNoteListFragment != null) {
 719                     mNoteListFragment.setFloatingActionButtonVisible(true);
 720                     mNoteListFragment.showListPadding(true);
 721                 }
 722 
 723                 mTabletSearchQuery = &quot;&quot;;
 724                 mSearchView.setQuery(&quot;&quot;, false);
 725                 checkEmptyListText(false);
 726                 getNoteListFragment().clearSearch();
 727                 return true;
 728             }
 729         });
 730 
 731         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 732             @Override
 733             public boolean onMenuItemClick(MenuItem item) {
 734                 if (!mSearchMenuItem.isActionViewExpanded())
 735                     showDetailPlaceholder();
 736                 return false;
 737             }
 738         });
 739 
 740         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 741         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 742             trashItem.setTitle(R.string.undelete);
 743             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 744         } else {
 745             trashItem.setTitle(R.string.delete);
 746             trashItem.setIcon(R.drawable.ic_trash_24dp);
 747         }
 748 
 749         if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 750             // Restore the search query on landscape tablets
 751             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 752                 mSearchMenuItem.expandActionView();
 753                 mSearchView.setQuery(mTabletSearchQuery, false);
 754                 mSearchView.clearFocus();
 755             }
 756 
 757             updateActionsForLargeLandscape(menu);
 758         } else {
 759             menu.findItem(R.id.menu_search).setVisible(true);
 760             menu.findItem(R.id.menu_share).setVisible(false);
 761             menu.findItem(R.id.menu_view_info).setVisible(false);
 762             menu.findItem(R.id.menu_checklist).setVisible(false);
 763             menu.findItem(R.id.menu_history).setVisible(false);
 764             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 765             menu.findItem(R.id.menu_sidebar).setVisible(false);
 766             trashItem.setVisible(false);
 767             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 768         }
 769 
 770         if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
 771             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 772             mEmptyTrashMenuItem.setVisible(true);
 773 
 774             updateTrashMenuItem();
 775 
 776             menu.findItem(R.id.menu_search).setVisible(false);
 777             menu.findItem(R.id.menu_share).setVisible(false);
 778             menu.findItem(R.id.menu_history).setVisible(false);
 779             menu.findItem(R.id.menu_checklist).setVisible(false);
 780         }
 781 
 782         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.toolbarIconColor);
 783 
 784         return true;
 785     }
 786 
 787     @Override
 788     public boolean onOptionsItemSelected(MenuItem item) {
 789         if (mDrawerToggle.onOptionsItemSelected(item)) {
 790             return true;
 791         }
 792         switch (item.getItemId()) {
 793             case R.id.menu_sidebar:
 794                 FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 795                 if (mNoteListFragment.isHidden()) {
 796                     ft.show(mNoteListFragment);
 797                 } else {
 798                     ft.hide(mNoteListFragment);
 799                 }
 800                 ft.commitNowAllowingStateLoss();
 801                 mIsTabetFullscreen = mNoteListFragment.isHidden();
 802                 return true;
 803             case R.id.menu_markdown_preview:
 804                 if (mIsShowingMarkdown) {
 805                     item.setIcon(R.drawable.ic_visibility_on_24dp);
 806                     item.setTitle(getString(R.string.markdown_show));
 807                     setMarkdownShowing(false);
 808                     mCurrentNote.setPreviewEnabled(false);
 809                 } else {
 810                     item.setIcon(R.drawable.ic_visibility_off_24dp);
 811                     item.setTitle(getString(R.string.markdown_hide));
 812                     setMarkdownShowing(true);
 813                     mCurrentNote.setPreviewEnabled(true);
 814                 }
 815 
 816                 mCurrentNote.save();
 817                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.toolbarIconColor);
 818 
 819                 return true;
 820             case R.id.menu_delete:
 821                 if (mNoteEditorFragment != null) {
 822                     if (mCurrentNote != null) {
 823                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 824                         mCurrentNote.setModificationDate(Calendar.getInstance());
 825                         mCurrentNote.save();
 826 
 827                         updateViewsAfterTrashAction(mCurrentNote);
 828                     }
 829                 }
 830                 return true;
 831             case R.id.menu_empty_trash:
<abbr title=" 832                 AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.style.Dialog));"> 832                 AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.styleðŸ”µ</abbr>
 833 
 834                 alert.setTitle(R.string.empty_trash);
 835                 alert.setMessage(R.string.confirm_empty_trash);
 836                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 837                     public void onClick(DialogInterface dialog, int whichButton) {
 838                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 839                         AnalyticsTracker.track(
 840                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 841                                 AnalyticsTracker.CATEGORY_NOTE,
 842                                 &quot;overflow_menu&quot;
 843                         );
 844                     }
 845                 });
 846                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 847                     public void onClick(DialogInterface dialog, int whichButton) {
 848                         // Do nothing, just closing the dialog
 849                     }
 850                 });
 851                 alert.show();
 852                 return true;
 853             case android.R.id.home:
 854                 invalidateOptionsMenu();
 855                 return true;
 856             default:
 857                 return super.onOptionsItemSelected(item);
 858         }
 859     }
 860 
 861     @Override
 862     public boolean onPrepareOptionsMenu(Menu menu) {
 863         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 864 
 865         if (mIsShowingMarkdown) {
 866             markdownItem.setIcon(R.drawable.ic_visibility_off_24dp);
 867             markdownItem.setTitle(getString(R.string.markdown_hide));
 868         } else {
 869             markdownItem.setIcon(R.drawable.ic_visibility_on_24dp);
 870             markdownItem.setTitle(getString(R.string.markdown_show));
 871         }
 872 
 873         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.toolbarIconColor);
 874 
 875         return super.onPrepareOptionsMenu(menu);
 876     }
 877 
 878     public void submitSearch(String selection) {
 879         if (mSearchView != null) {
 880             String query = mSearchView.getQuery().toString();
 881 
 882             if (query.endsWith(TAG_PREFIX)) {
<abbr title=" 883                 mSearchView.setQuery(query.substring(0, query.lastIndexOf(TAG_PREFIX)) + selection, true);"> 883                 mSearchView.setQuery(query.substring(0, query.lastIndexOf(TAG_PREFIX)) + selection, true)ðŸ”µ</abbr>
 884             } else {
 885                 mSearchView.setQuery(selection, true);
 886             }
 887         }
 888     }
 889 
 890     private void updateActionsForLargeLandscape(Menu menu) {
 891         if (mCurrentNote != null) {
 892             menu.findItem(R.id.menu_checklist).setVisible(true);
 893             menu.findItem(R.id.menu_delete).setVisible(true);
 894             menu.findItem(R.id.menu_history).setVisible(true);
 895             menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 896             menu.findItem(R.id.menu_share).setVisible(true);
 897             menu.findItem(R.id.menu_sidebar).setVisible(true);
 898             menu.findItem(R.id.menu_view_info).setVisible(true);
 899         } else {
 900             menu.findItem(R.id.menu_checklist).setVisible(false);
 901             menu.findItem(R.id.menu_delete).setVisible(false);
 902             menu.findItem(R.id.menu_history).setVisible(false);
 903             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 904             menu.findItem(R.id.menu_share).setVisible(false);
 905             menu.findItem(R.id.menu_sidebar).setVisible(false);
 906             menu.findItem(R.id.menu_view_info).setVisible(false);
 907         }
 908 
 909         menu.findItem(R.id.menu_empty_trash).setVisible(false);
 910     }
 911 
 912     public void updateViewsAfterTrashAction(Note note) {
 913         if (note == null || isFinishing()) {
 914             return;
 915         }
 916 
 917         if (note.isDeleted()) {
 918             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 919             deletedNoteIds.add(note.getSimperiumKey());
 920             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 921             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 922             AnalyticsTracker.track(
 923                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 924                     AnalyticsTracker.CATEGORY_NOTE,
 925                     &quot;overflow_menu&quot;
 926             );
 927         } else {
 928             AnalyticsTracker.track(
 929                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 930                     AnalyticsTracker.CATEGORY_NOTE,
 931                     &quot;overflow_menu&quot;
 932             );
 933         }
 934 
 935         // If we just deleted/restored the active note, show the placeholder
 936         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 937             showDetailPlaceholder();
 938         }
 939 
 940         NoteListFragment fragment = getNoteListFragment();
 941         if (fragment != null) {
 942             fragment.getPrefs();
 943             fragment.refreshList();
 944         }
 945 
 946         invalidateOptionsMenu();
 947     }
 948 
 949     public void setMarkdownShowing(boolean isMarkdownShowing) {
 950         mIsShowingMarkdown = isMarkdownShowing;
 951         if (mNoteEditorFragment != null) {
 952             if (isMarkdownShowing) {
 953                 mNoteEditorFragment.showMarkdown();
 954             } else {
 955                 mNoteEditorFragment.hideMarkdown();
 956             }
 957         }
 958         invalidateOptionsMenu();
 959     }
 960 
 961     /**
 962      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 963      * the item with the given ID was selected. Used for tablets only.
 964      */
 965     @Override
<abbr title=" 966     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 966     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 967         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 968             // Launch the editor activity
 969             Bundle arguments = new Bundle();
 970             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 971             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 972             arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 973 
 974             if (matchOffsets != null) {
 975                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 976             }
 977 
 978             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 979             editNoteIntent.putExtras(arguments);
 980             if (mNoteListFragment.isHidden()) {
 981                 editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 982             }
 983             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 984         } else {
 985             mNoteEditorFragment.setNote(noteID, matchOffsets);
 986             getNoteListFragment().setNoteSelected(noteID);
 987             setMarkdownShowing(isPreviewEnabled);
 988 
 989             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 990                 mTabletSearchQuery = mSearchView.getQuery().toString();
 991             }
 992 
 993             mNoteEditorFragment.clearMarkdown();
 994 
 995             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 996                 setMarkdownShowing(false);
 997             }
 998 
 999             invalidateOptionsMenu();
1000         }
1001 
1002         AnalyticsTracker.track(
1003                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
1004                 AnalyticsTracker.CATEGORY_NOTE,
1005                 &quot;note_list_row_tap&quot;
1006         );
1007     }
1008 
1009     @Override
1010     public void onUserCreated(User user) {
1011         // New account created
1012         AnalyticsTracker.track(
1013                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
1014                 AnalyticsTracker.CATEGORY_USER,
1015                 &quot;account_created_from_login_activity&quot;
1016         );
1017     }
1018 
1019     public void onUserStatusChange(User.Status status) {
1020         switch (status) {
1021             // successfully used access token to connect to simperium bucket
1022             case AUTHORIZED:
1023                 runOnUiThread(new Runnable() {
1024                     @Override
1025                     public void run() {
1026                         if (!mNotesBucket.hasChangeVersion()) {
1027                             setToolbarProgressVisibility(true);
1028                         }
1029                     }
1030                 });
1031                 break;
1032 
1033             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
1034             case NOT_AUTHORIZED:
1035                 runOnUiThread(new Runnable() {
1036                     @Override
1037                     public void run() {
1038                         startLoginActivity(true);
1039                     }
1040                 });
1041                 break;
1042 
<abbr title="1043             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything">1043             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
1044             case UNKNOWN:
1045                 break;
1046         }
1047     }
1048 
1049     private void setToolbarProgressVisibility(boolean isVisible) {
1050         if (getSupportActionBar() != null) {
1051             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1052         }
1053     }
1054 
1055     public void startLoginActivity(boolean signInFirst) {
1056         // Clear some account-specific prefs
1057         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
1058         editor.remove(PrefUtils.PREF_WP_TOKEN);
1059         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
1060         editor.apply();
1061 
1062         Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
1063         startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
1064     }
1065 
1066     @Override
1067     public void recreate() {
1068         Handler handler = new Handler();
1069         handler.post(new Runnable() {
1070             @Override
1071             public void run() {
1072                 NotesActivity.super.recreate();
1073             }
1074         });
1075     }
1076 
1077     @Override
1078     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1079         super.onActivityResult(requestCode, resultCode, data);
1080         switch (requestCode) {
1081             case Simplenote.INTENT_PREFERENCES:
<abbr title="1082                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1082                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
1083                 invalidateOptionsMenu();
1084                 NoteListFragment fragment = getNoteListFragment();
1085                 if (fragment != null) {
1086                     fragment.getPrefs();
1087                     fragment.refreshList();
1088                 }
1089 
1090                 break;
1091             case Simplenote.INTENT_EDIT_NOTE:
1092                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
1093                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1094                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1095                         if (noteId != null) {
1096                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1097                             deletedNoteIds.add(noteId);
1098                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title="1099                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));">1099                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
1100                         }
<abbr title="1101                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1101                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
1102                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1103                         mNoteListFragment.setNoteSelected(selectedNoteId);
1104                         if (mNoteEditorFragment != null) {
1105                             mNoteEditorFragment.setNote(selectedNoteId);
1106                         }
1107                     }
1108                 }
1109                 break;
1110             case Simperium.SIGNUP_SIGNIN_REQUEST:
1111                 invalidateOptionsMenu();
1112 
1113                 Simplenote app = (Simplenote) getApplication();
1114                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1115                 CrashUtils.setCurrentUser(app.getSimperium().getUser());
1116 
1117                 AnalyticsTracker.track(
1118                         AnalyticsTracker.Stat.USER_SIGNED_IN,
1119                         AnalyticsTracker.CATEGORY_USER,
1120                         &quot;signed_in_from_login_activity&quot;
1121                 );
1122 
1123                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1124                     finish();
1125                 }
1126 
1127                 break;
1128         }
1129     }
1130 
1131     @Override
1132     public void onUndo() {
1133         if (mUndoBarController == null) return;
1134 
1135         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1136         if (deletedNoteIds != null) {
1137             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1138                 Note deletedNote;
1139                 try {
1140                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1141                 } catch (BucketObjectMissingException e) {
1142                     return;
1143                 }
1144                 if (deletedNote != null) {
1145                     deletedNote.setDeleted(false);
1146                     deletedNote.setModificationDate(Calendar.getInstance());
1147                     deletedNote.save();
1148                     NoteListFragment fragment = getNoteListFragment();
1149                     if (fragment != null) {
1150                         fragment.getPrefs();
1151                         fragment.refreshList();
1152                     }
1153                 }
1154             }
1155         }
1156     }
1157 
1158     @Override
1159     protected void onPostCreate(Bundle savedInstanceState) {
1160         super.onPostCreate(savedInstanceState);
1161         // Sync the toggle state after onRestoreInstanceState has occurred.
1162         mDrawerToggle.syncState();
1163     }
1164 
1165     @Override
1166     public void onConfigurationChanged(@NonNull Configuration newConfig) {
1167         super.onConfigurationChanged(newConfig);
1168 
1169         mDrawerToggle.onConfigurationChanged(newConfig);
1170 
1171         if (DisplayUtils.isLargeScreen(this)) {
1172             mIsShowingMarkdown = false;
1173 
1174             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1175                 // Add the editor fragment
1176                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1177                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1177                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
1178                 } else if (DisplayUtils.isLandscape(this)) {
1179                     addEditorFragment();
1180                 }
1181 
1182                 if (mNoteListFragment != null) {
1183                     mNoteListFragment.setActivateOnItemClick(true);
1184                     mNoteListFragment.setDividerVisible(true);
1185                 }
1186 
1187                 // Select the current note on a tablet
1188                 if (mCurrentNote != null) {
<abbr title="1189                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1189                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
1190                 } else {
1191                     mNoteEditorFragment.setPlaceholderVisible(true);
1192                     mNoteListFragment.getListView().clearChoices();
1193                 }
1194 
1195                 invalidateOptionsMenu();
<abbr title="1196             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait">1196             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to poðŸ”µ</abbr>
1197             } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1198                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1198                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(),ðŸ”µ</abbr>
1199             }
1200         }
1201 
1202         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1203             // Remove the editor fragment when rotating back to portrait
1204             mCurrentNote = null;
1205             if (mNoteListFragment != null) {
1206                 mNoteListFragment.setActivateOnItemClick(false);
1207                 mNoteListFragment.setDividerVisible(false);
1208                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1209                 mNoteListFragment.refreshList();
1210             }
1211             FragmentManager fm = getSupportFragmentManager();
1212             FragmentTransaction ft = fm.beginTransaction();
1213             ft.remove(mNoteEditorFragment);
1214             mNoteEditorFragment = null;
1215             ft.commitAllowingStateLoss();
1216             fm.executePendingTransactions();
1217             invalidateOptionsMenu();
1218         }
1219     }
1220 
1221     public void checkEmptyListText(boolean isSearch) {
1222         if (isSearch) {
1223             if (DisplayUtils.isLandscape(this) &amp;&amp; !DisplayUtils.isLargeScreen(this)) {
1224                 getNoteListFragment().setEmptyListImage(-1);
1225             } else {
1226                 getNoteListFragment().setEmptyListImage(R.drawable.ic_search_24dp);
1227             }
1228 
1229             getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_search));
1230         } else if (mSelectedTag != null) {
1231             if (mSelectedTag.id == ALL_NOTES_ID) {
1232                 getNoteListFragment().setEmptyListImage(R.drawable.ic_notes_24dp);
1233                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_all));
1234             } else if (mSelectedTag.id == TRASH_ID) {
1235                 getNoteListFragment().setEmptyListImage(R.drawable.ic_trash_24dp);
1236                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_trash));
1237             AnalyticsTracker.track(
1238                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1239                     AnalyticsTracker.CATEGORY_NOTE,
1240                     &quot;trash_filter_selected&quot;
1241             );
1242             } else if (mSelectedTag.id == UNTAGGED_NOTES_ID) {
1243                 getNoteListFragment().setEmptyListImage(R.drawable.ic_untagged_24dp);
1244                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_untagged));
1245         } else {
1246                 getNoteListFragment().setEmptyListImage(R.drawable.ic_tag_24dp);
<abbr title="1247                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_tag, mSelectedTag.name));">1247                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_tag, mSelectedTaðŸ”µ</abbr>
1248             }
1249         } else {
1250             getNoteListFragment().setEmptyListImage(R.drawable.ic_notes_24dp);
1251             getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_all));
1252         }
1253     }
1254 
1255     public void showDetailPlaceholder() {
1256         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1257             mCurrentNote = null;
1258             mNoteEditorFragment.setPlaceholderVisible(true);
1259             mNoteEditorFragment.clearMarkdown();
1260             mNoteEditorFragment.hideMarkdown();
1261             mIsShowingMarkdown = false;
1262         }
1263     }
1264 
1265     public void stopListeningToNotesBucket() {
1266         mNotesBucket.removeOnNetworkChangeListener(this);
1267         mNotesBucket.removeOnSaveObjectListener(this);
1268         mNotesBucket.removeOnDeleteObjectListener(this);
1269     }
1270 
1271     // Returns the appropriate view to show the undo bar within
1272     private View getUndoView() {
1273         View undoView = mFragmentsContainer;
1274         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1275                 getNoteListFragment() != null &amp;&amp;
1276                 getNoteListFragment().getRootView() != null) {
1277             undoView = getNoteListFragment().getRootView();
1278         }
1279 
1280         return undoView;
1281     }
1282 
1283     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1284         if (mUndoBarController != null) {
1285             mUndoBarController.setDeletedNoteIds(noteIds);
1286             mUndoBarController.showUndoBar(
1287                     getUndoView(),
<abbr title="1288                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1288                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1289             );
1290         }
1291     }
1292 
1293     /* Simperium Bucket Listeners */
1294     // received a change from the network, refresh the list
1295     @Override
1296     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1297         runOnUiThread(new Runnable() {
1298             @Override
1299             public void run() {
1300                 if (type == Bucket.ChangeType.INDEX) {
1301                     setToolbarProgressVisibility(false);
1302                 }
1303                 mNoteListFragment.refreshList();
1304             }
1305         });
1306     }
1307 
1308     @Override
1309     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1310         runOnUiThread(new Runnable() {
1311             @Override
1312             public void run() {
1313                 mNoteListFragment.refreshList();
1314             }
1315         });
1316     }
1317 
1318     @Override
1319     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1320         runOnUiThread(new Runnable() {
1321             @Override
1322             public void run() {
1323                 mNoteListFragment.refreshList();
1324             }
1325         });
1326     }
1327 
1328     @Override
1329     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1330         // noop, NoteEditorFragment will handle this
1331     }
1332 
1333     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1334 
1335         @Override
1336         protected Void doInBackground(Void... voids) {
1337             if (mNotesBucket == null) return null;
1338 
1339             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1340             Bucket.ObjectCursor c = query.execute();
1341             while (c.moveToNext()) {
1342                 c.getObject().delete();
1343             }
1344 
1345             return null;
1346         }
1347 
1348         @Override
1349         protected void onPostExecute(Void nada) {
1350             showDetailPlaceholder();
1351         }
1352     }
1353 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.content.DialogInterface;
   5 import android.content.Intent;
   6 import android.content.SharedPreferences;
   7 import android.content.res.ColorStateList;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.Handler;
  12 import android.text.TextUtils;
  13 import android.view.Menu;
  14 import android.view.MenuInflater;
  15 import android.view.MenuItem;
  16 import android.view.View;
  17 import android.widget.LinearLayout;
  18 import android.widget.ListView;
  19 import android.widget.ProgressBar;
  20 import androidx.annotation.NonNull;
  21 import androidx.appcompat.app.ActionBar;
  22 import androidx.appcompat.app.ActionBarDrawerToggle;
  23 import androidx.appcompat.app.AlertDialog;
  24 import androidx.appcompat.app.AppCompatActivity;
  25 import androidx.appcompat.view.ContextThemeWrapper;
  26 import androidx.appcompat.widget.SearchView;
  27 import androidx.appcompat.widget.Toolbar;
  28 import androidx.core.view.GravityCompat;
  29 import androidx.drawerlayout.widget.DrawerLayout;
  30 import androidx.fragment.app.FragmentManager;
  31 import androidx.fragment.app.FragmentTransaction;
  32 import androidx.preference.PreferenceManager;
  33 import com.automattic.simplenote.analytics.AnalyticsTracker;
  34 import com.automattic.simplenote.models.Note;
  35 import com.automattic.simplenote.models.Tag;
  36 import com.automattic.simplenote.utils.CrashUtils;
  37 import com.automattic.simplenote.utils.DisplayUtils;
  38 import com.automattic.simplenote.utils.DrawableUtils;
  39 import com.automattic.simplenote.utils.HtmlCompat;
  40 import com.automattic.simplenote.utils.PrefUtils;
  41 import com.automattic.simplenote.utils.StrUtils;
  42 import com.automattic.simplenote.utils.TagsAdapter;
  43 import com.automattic.simplenote.utils.ThemeUtils;
  44 import com.automattic.simplenote.utils.UndoBarController;
  45 import com.google.android.material.navigation.NavigationView;
  46 import com.simperium.Simperium;
  47 import com.simperium.client.Bucket;
  48 import com.simperium.client.BucketObjectMissingException;
  49 import com.simperium.client.BucketObjectNameInvalid;
  50 import com.simperium.client.Query;
  51 import com.simperium.client.User;
  52 import java.util.ArrayList;
  53 import java.util.Calendar;
  54 import java.util.HashMap;
  55 import java.util.List;
  56 import java.util.Map;
  57 import org.wordpress.passcodelock.AppLockManager;
  58 import static com.automattic.simplenote.NoteListFragment.TAG_PREFIX;
  59 import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  60 import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  61 import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  62 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  63 import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  64 import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  65 import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  66 import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  67 import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  68 import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  69 
  70 
<abbr title="  71 public class NotesActivity extends AppCompatActivity implements NoteListFragment.Callbacks , User.StatusChangeListener , Simperium.OnUserCreatedListener , UndoBarController.UndoListener , Bucket.Listener&lt;Note&gt; {">  71 public class NotesActivity extends AppCompatActivity implements NoteListFragment.Callbacks , User.StatusCðŸ”µ</abbr>
  72     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  73 
  74     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  75 
  76     protected Bucket&lt;Note&gt; mNotesBucket;
  77 
  78     protected Bucket&lt;Tag&gt; mTagsBucket;
  79 
  80     private boolean mIsShowingMarkdown;
  81 
  82     private boolean mShouldSelectNewNote;
  83 
  84     private boolean mIsSettingsClicked;
  85 
  86     private boolean mIsTabetFullscreen;
  87 
  88     private String mTabletSearchQuery;
  89 
  90     private UndoBarController mUndoBarController;
  91 
  92     private View mFragmentsContainer;
  93 
  94     private SearchView mSearchView;
  95 
  96     private MenuItem mSearchMenuItem;
  97 
  98     private NoteListFragment mNoteListFragment;
  99 
 100     private NoteEditorFragment mNoteEditorFragment;
 101 
 102     private Note mCurrentNote;
 103 
 104     private MenuItem mEmptyTrashMenuItem;
 105 
 106     // Menu drawer
 107     // Menu drawer
 108     private static final int GROUP_PRIMARY = 100;
 109 
 110     private static final int GROUP_SECONDARY = 101;
 111 
 112     private static final int GROUP_TERTIARY = 102;
 113 
 114     private DrawerLayout mDrawerLayout;
 115 
 116     private Menu mNavigationMenu;
 117 
 118     private ActionBarDrawerToggle mDrawerToggle;
 119 
 120     private TagsAdapter mTagsAdapter;
 121 
 122     private TagsAdapter.TagMenuItem mSelectedTag;
 123 
 124     // Tags bucket listener
 125     // Tags bucket listener
 126     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 127         void updateNavigationDrawer() {
 128             runOnUiThread(new Runnable() {
 129                 public void run() {
 130                     updateNavigationDrawerItems();
 131                 }
 132             });
 133         }
 134 
 135         @Override
 136         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 137             updateNavigationDrawer();
 138         }
 139 
 140         @Override
 141         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 142             updateNavigationDrawer();
 143         }
 144 
 145         @Override
 146         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 147             updateNavigationDrawer();
 148         }
 149 
 150         @Override
 151         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 152             // noop
 153         }
 154     };
 155 
 156     @Override
 157     protected void onCreate(Bundle savedInstanceState) {
 158         ThemeUtils.setTheme(this);
 159         super.onCreate(savedInstanceState);
 160 
 161         setContentView(R.layout.activity_notes);
 162 
 163         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 164 
 165         Simplenote currentApp = (Simplenote) getApplication();
 166         if (mNotesBucket == null) {
 167             mNotesBucket = currentApp.getNotesBucket();
 168         }
 169 
 170         if (mTagsBucket == null) {
 171             mTagsBucket = currentApp.getTagsBucket();
 172         }
 173 
 174         Toolbar toolbar = findViewById(R.id.toolbar);
 175         setSupportActionBar(toolbar);
 176         configureNavigationDrawer(toolbar);
 177 
 178         if (savedInstanceState == null) {
 179             mNoteListFragment = new NoteListFragment();
 180             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 181             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 182             fragmentTransaction.commit();
 183         } else {
<abbr title=" 184             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 184             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 185         }
 186         mIsTabetFullscreen = mNoteListFragment.isHidden();
 187 
 188         if (DisplayUtils.isLargeScreen(this)) {
 189             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 190                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 190                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 191             } else if (DisplayUtils.isLandscape(this)) {
 192                 addEditorFragment();
 193             }
 194         }
 195 
 196         // enable ActionBar app icon to behave as action to toggle nav drawer
 197         ActionBar actionBar = getSupportActionBar();
 198         if (actionBar != null) {
 199             actionBar.setDisplayHomeAsUpEnabled(true);
 200             actionBar.setHomeButtonEnabled(true);
 201 
 202             // Add loading indicator to show when indexing
<abbr title=" 203             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 203             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 204             actionBar.setDisplayShowCustomEnabled(true);
 205             actionBar.setCustomView(progressBar);
 206             setToolbarProgressVisibility(false);
 207         }
 208 
 209         mUndoBarController = new UndoBarController(this);
 210 
 211         // Creates &#x27;Welcome&#x27; note
 212         checkForFirstLaunch();
 213 
 214         checkForSharedContent();
 215 
 216         currentApp.getSimperium().setOnUserCreatedListener(this);
 217         currentApp.getSimperium().setUserStatusChangeListener(this);
 218     }
 219 
 220     @Override
 221     protected void onResume() {
 222         super.onResume();
 223 
 224         // Ensure user has valid authorization
 225         if (userAuthenticationIsInvalid()) {
 226             startLoginActivity(true);
 227             Intent intent = getIntent();
 228 
 229             if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 230                     intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 231                 AnalyticsTracker.track(
 232                         NOTE_WIDGET_SIGN_IN_TAPPED,
 233                         CATEGORY_WIDGET,
 234                         &quot;note_widget_sign_in_tapped&quot;
 235                 );
 236             }
 237         }
 238 
 239         disableScreenshotsIfLocked(this);
 240 
 241         mNotesBucket.start();
 242         mTagsBucket.start();
 243 
 244         mNotesBucket.addOnNetworkChangeListener(this);
 245         mNotesBucket.addOnSaveObjectListener(this);
 246         mNotesBucket.addOnDeleteObjectListener(this);
 247         mTagsBucket.addListener(mTagsMenuUpdater);
 248 
 249         updateNavigationDrawerItems();
 250 
 251         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 252         if (userIsUnauthorized()) {
 253             if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 254                 mSelectedTag = null;
 255                 mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 256             }
 257         }
 258 
 259         filterListBySelectedTag();
 260 
 261         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 262             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 262             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCuðŸ”µ</abbr>
 263             mShouldSelectNewNote = false;
 264         }
 265 
 266         if (mIsShowingMarkdown) {
 267             setMarkdownShowing(false);
 268         }
 269 
 270         FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 271         if(DisplayUtils.isLargeScreenLandscape(this)) {
 272             if (mIsTabetFullscreen) {
 273                 ft.hide(mNoteListFragment);
 274             } else {
 275                 ft.show(mNoteListFragment);
 276             }
 277         } else {
 278             ft.show(mNoteListFragment);
 279         }
 280         ft.commitNow();
 281     }
 282 
 283     @Override
 284     protected void onPause() {
 285         super.onPause();  // Always call the superclass method first
 286         mTagsBucket.removeListener(mTagsMenuUpdater);
 287         mTagsBucket.stop();
 288 
 289         mNotesBucket.removeOnNetworkChangeListener(this);
 290         mNotesBucket.removeOnSaveObjectListener(this);
 291         mNotesBucket.removeOnDeleteObjectListener(this);
 292         mNotesBucket.stop();
 293     }
 294 
 295     @Override
 296     public void setTitle(CharSequence title) {
 297         if (getSupportActionBar() != null) {
 298             getSupportActionBar().setTitle(title);
 299         }
 300     }
 301 
 302     @Override
 303     public void onBackPressed() {
 304         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 305             mDrawerLayout.closeDrawer(GravityCompat.START);
 306         } else {
 307             super.onBackPressed();
 308         }
 309     }
 310 
 311     @Override
 312     public void onActionModeCreated() {
 313         mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 314     }
 315 
 316     @Override
 317     public void onActionModeDestroyed() {
 318         if (mSearchMenuItem != null &amp;&amp; !mSearchMenuItem.isActionViewExpanded()) {
 319             mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 320         }
 321     }
 322 
 323     private ColorStateList getIconSelector() {
 324         int[][] states = new int[][] {
 325                 new int[] { android.R.attr.state_checked}, // checked
 326                 new int[] {-android.R.attr.state_checked}  // unchecked
 327         };
 328 
 329         int[] colors = new int[] {
 330                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 331                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.toolbarIconColor)
 332         };
 333 
 334         return new ColorStateList(states, colors);
 335     }
 336 
 337     private ColorStateList getTextSelector() {
 338         int[][] states = new int[][] {
 339             new int[] {-android.R.attr.state_enabled}, // disabled
 340             new int[] { android.R.attr.state_checked}, // checked
 341             new int[] {-android.R.attr.state_checked}  // unchecked
 342         };
 343 
 344         int[] colors = new int[] {
 345             getResources().getColor(R.color.text_title_disabled, getTheme()),
 346             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 347             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)
 348         };
 349 
 350         return new ColorStateList(states, colors);
 351     }
 352 
 353     private void configureNavigationDrawer(Toolbar toolbar) {
 354         ColorStateList iconSelector = getIconSelector();
 355         ColorStateList textSelector = getTextSelector();
 356         mDrawerLayout = findViewById(R.id.drawer_layout);
 357         NavigationView navigationView = findViewById(R.id.navigation_view);
 358         navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 359         navigationView.setItemIconTintList(iconSelector);
 360         navigationView.setItemTextColor(textSelector);
 361         navigationView.setNavigationItemSelectedListener(
 362             new NavigationView.OnNavigationItemSelectedListener() {
 363                 @Override
 364                 public boolean onNavigationItemSelected(@NonNull MenuItem item) {
 365                     mDrawerLayout.closeDrawer(GravityCompat.START);
 366 
 367                     if (item.getItemId() == SETTINGS_ID) {
 368                         AnalyticsTracker.track(
 369                                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 370                                 AnalyticsTracker.CATEGORY_TAG,
 371                                 &quot;selected_tag_in_navigation_drawer&quot;,
 372                                 new HashMap&lt;String, String&gt;(1){{put(&quot;tag&quot;, &quot;settings&quot;);}}
 373                         );
 374                         mIsSettingsClicked = true;
 375                         return false;
 376                     } else {
 377                         mSelectedTag = mTagsAdapter.getTagFromItem(item);
 378                         filterListBySelectedTag();
 379                         return true;
 380                     }
 381                 }
 382             }
 383         );
 384 
 385         mNavigationMenu = navigationView.getMenu();
<abbr title=" 386         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 386         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcoðŸ”µ</abbr>
<abbr title=" 387         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 387         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawðŸ”µ</abbr>
<abbr title=" 388         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 388         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(ðŸ”µ</abbr>
 389         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 390 
 391         if (mSelectedTag == null)
 392             mSelectedTag = mTagsAdapter.getDefaultItem();
 393 
 394         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 395                 R.string.close_drawer) {
 396             public void onDrawerClosed(View view) {
 397                 supportInvalidateOptionsMenu();
 398 
 399                 if (mIsSettingsClicked) {
 400                     Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 401                     startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 402                     mIsSettingsClicked = false;
 403                 }
 404             }
 405 
 406             public void onDrawerOpened(View drawerView) {
 407                 // noop
 408             }
 409 
 410             @Override
 411             public void onDrawerSlide(View drawerView, float slideOffset) {
 412                 super.onDrawerSlide(drawerView, 0f);
 413             }
 414         };
 415 
 416         mDrawerLayout.addDrawerListener(mDrawerToggle);
 417     }
 418 
 419     private void filterListBySelectedTag() {
 420         MenuItem selectedMenuItem = mNavigationMenu.findItem(((int) (mSelectedTag.id)));
 421         if (selectedMenuItem != null) {
 422             mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 423         } else {
 424             mSelectedTag = mTagsAdapter.getDefaultItem();
 425         }
 426         checkEmptyListText((mSearchMenuItem != null) &amp;&amp; mSearchMenuItem.isActionViewExpanded());
 427         if (mNoteListFragment.isHidden()) {
 428             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 429             fragmentTransaction.show(mNoteListFragment);
 430             fragmentTransaction.commitNowAllowingStateLoss();
 431         }
 432         // Disable long press on notes when viewing Trash.
 433         if (mSelectedTag.id == TRASH_ID) {
 434             getNoteListFragment().getListView().setLongClickable(false);
 435         } else {
 436             getNoteListFragment().getListView().setLongClickable(true);
 437         }
 438         getNoteListFragment().refreshListFromNavSelect();
 439         Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 440         switch (((int) (mSelectedTag.id))) {
 441             case ALL_NOTES_ID :
 442                 properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 443                 break;
 444             case TRASH_ID :
 445                 properties.put(&quot;tag&quot;, &quot;trash&quot;);
 446                 break;
 447             case UNTAGGED_NOTES_ID :
 448                 properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 449                 break;
 450             default :
 451                 properties = null;
 452                 break;
 453         }
<abbr title=" 454         AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TAG_VIEWED, AnalyticsTracker.CATEGORY_TAG, &quot;selected_tag_in_navigation_drawer&quot;, properties);"> 454         AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TAG_VIEWED, AnalyticsTracker.CATEGORY_TAG, &quot;selðŸ”µ</abbr>
 455         setSelectedTagActive();
 456     }
 457 
 458     private void checkForFirstLaunch() {
 459         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 460             // Create the welcome note
 461             try {
 462                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 463                 welcomeNote.setCreationDate(Calendar.getInstance());
 464                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 465                 welcomeNote.setContent(getString(R.string.welcome_note));
 466                 welcomeNote.getTitle();
 467                 welcomeNote.save();
 468             } catch (BucketObjectNameInvalid e) {
 469                 // this won&#x27;t happen because welcome-android is a valid name
 470             }
 471 
 472             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 473             SharedPreferences.Editor editor = preferences.edit();
 474             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 475             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 476             editor.apply();
 477         }
 478     }
 479 
 480     private void checkForSharedContent() {
 481         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 482             // Check share action
 483             Intent intent = getIntent();
 484             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 485             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 486 
<abbr title=" 487             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 487             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 488             String intentAction = StrUtils.notNullStr(intent.getAction());
 489             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 490             if (!TextUtils.isEmpty(text)) {
 491                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 492                     text = subject + &quot;\n\n&quot; + text;
 493                 }
 494                 Note note = mNotesBucket.newObject();
 495                 note.setCreationDate(Calendar.getInstance());
 496                 note.setModificationDate(note.getCreationDate());
 497                 note.setContent(text);
 498                 note.save();
 499                 setCurrentNote(note);
 500                 mShouldSelectNewNote = true;
 501 
 502                 AnalyticsTracker.track(
 503                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 504                         AnalyticsTracker.CATEGORY_NOTE,
 505                         &quot;external_share&quot;
 506                 );
 507 
 508                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 509                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 510                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 511                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 512                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 513                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 514                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 515                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 516                     }
 517                 }
 518             }
 519         }
 520     }
 521 
 522     private void updateNavigationDrawerItems() {
 523         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 524         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 525         if (isAlphaSort) {
 526             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 527         } else {
 528             tagCursor = Tag.allWithName(mTagsBucket).execute();
 529         }
 530 
 531         mTagsAdapter.changeCursor(tagCursor);
 532         mNavigationMenu.removeGroup(GROUP_SECONDARY);
 533         mNavigationMenu.removeGroup(GROUP_TERTIARY);
 534 
 535         if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 536             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 536             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionVðŸ”µ</abbr>
 537 
 538             for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 539                 String name = mTagsAdapter.getItem(i).name;
 540                 int id = (int) mTagsAdapter.getItem(i).id;
 541 
 542                 if (id &gt;= 0) { // Custom tags have a positive ID.
 543                     mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 544                 }
 545             }
 546 
<abbr title=" 547             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_untagged_24dp).setCheckable(true);"> 547             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untaggedðŸ”µ</abbr>
 548             setSelectedTagActive();
 549         }
 550     }
 551 
 552     public void launchEditTags(View view) {
 553         startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 554     }
 555 
 556     private void setSelectedTagActive() {
 557         if (mSelectedTag == null) {
 558             mSelectedTag = mTagsAdapter.getDefaultItem();
 559         }
 560 
 561         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 562 
 563         if (selectedMenuItem != null) {
 564             selectedMenuItem.setChecked(true);
 565         } else {
 566             mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 567         }
 568 
 569         setTitle(mSelectedTag.name);
 570     }
 571 
 572     public TagsAdapter.TagMenuItem getSelectedTag() {
 573         if (mSelectedTag == null) {
 574             mSelectedTag = mTagsAdapter.getDefaultItem();
 575         }
 576 
 577         return mSelectedTag;
 578     }
 579 
 580     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 581     public void updateTrashMenuItem() {
 582         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 583             return;
 584 
 585         // Disable the trash icon if there are no notes trashed.
 586         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 587         if (query.count() == 0) {
 588             mEmptyTrashMenuItem.setEnabled(false);
 589         } else {
 590             mEmptyTrashMenuItem.setEnabled(true);
 591         }
 592     }
 593 
 594     private void addEditorFragment() {
 595         FragmentManager fm = getSupportFragmentManager();
 596         FragmentTransaction ft = fm.beginTransaction();
 597         mNoteEditorFragment = new NoteEditorFragment();
 598         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 599         ft.commitAllowingStateLoss();
 600         fm.executePendingTransactions();
 601     }
 602 
 603     private boolean userAccountRequired() {
 604         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 605     }
 606 
 607     /**
 608      * Checks for a previously valid user that is now not authenticated
 609      * Also checks if user account is required (added in version 1.5.6)
 610      *
 611      * @return true if user has invalid authorization
 612      */
 613     private boolean userAuthenticationIsInvalid() {
 614         Simplenote currentApp = (Simplenote) getApplication();
 615         Simperium simperium = currentApp.getSimperium();
 616         User user = simperium.getUser();
 617         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 618         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 619                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 620     }
 621 
 622     public boolean userIsUnauthorized() {
 623         Simplenote currentApp = (Simplenote) getApplication();
 624         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 625     }
 626 
 627     public void setCurrentNote(Note note) {
 628         mCurrentNote = note;
 629     }
 630 
 631     public NoteListFragment getNoteListFragment() {
 632         return mNoteListFragment;
 633     }
 634 
 635     @Override
 636     public boolean onCreateOptionsMenu(final Menu menu) {
 637         super.onCreateOptionsMenu(menu);
 638         MenuInflater inflater = getMenuInflater();
 639         inflater.inflate(R.menu.notes_list, menu);
 640         // restore the search query if on a landscape tablet
 641         String searchQuery = null;
 642         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; (mSearchView != null)) {
 643             searchQuery = mSearchView.getQuery().toString();
 644         }
 645         mSearchMenuItem = menu.findItem(R.id.menu_search);
 646         mSearchView = ((SearchView) (mSearchMenuItem.getActionView()));
 647         LinearLayout searchEditFrame = mSearchView.findViewById(R.id.search_edit_frame);
 648         ((LinearLayout.LayoutParams) (searchEditFrame.getLayoutParams())).leftMargin = 0;
 649         if (!TextUtils.isEmpty(searchQuery)) {
 650             mSearchView.setQuery(searchQuery, false);
 651             mSearchMenuItem.expandActionView();
 652         } else {
 653             // Workaround for setting the search placeholder text color
 654             @SuppressWarnings(&quot;ResourceType&quot;)
 655             String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
<abbr title=" 656             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;, hintHexColor, getString(R.string.search))));"> 656             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;, hiðŸ”µ</abbr>
 657         }
 658         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 659             @Override
 660             public boolean onQueryTextChange(String newText) {
 661                 if (mSearchMenuItem.isActionViewExpanded()) {
 662                     getNoteListFragment().searchNotes(newText, false);
 663                 }
 664 
 665                 return true;
 666             }
 667 
 668             @Override
 669             public boolean onQueryTextSubmit(String queryText) {
 670                 getNoteListFragment().searchNotes(queryText, true);
 671 
 672 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 673                 getNoteListFragment().addSearchItem(queryText, 0);</span>
 674 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 675 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 675 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 676 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678                 checkEmptyListText(true);</span>
 679 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 680 
 681                 return true;
 682             }
 683         });
 684         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 685             @Override
 686             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 687                 mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 688                 getNoteListFragment().searchNotes(&quot;&quot;, false);
 689                 if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 690                     updateActionsForLargeLandscape(menu);
 691                 }
 692                 checkEmptyListText(true);
 693                 // Hide floating action button and list bottom padding.
 694                 if (mNoteListFragment != null) {
 695                     mNoteListFragment.setFloatingActionButtonVisible(false);
 696                     mNoteListFragment.showListPadding(false);
 697                 }
<abbr title=" 698                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_NOTES_SEARCHED, AnalyticsTracker.CATEGORY_NOTE, &quot;action_bar_search_tap&quot;);"> 698                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_NOTES_SEARCHED, AnalyticsTracker.CATEGOðŸ”µ</abbr>
 699                 return true;
 700             }
 701 
 702             @Override
 703             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 704                 mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 705                 if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 706                     updateActionsForLargeLandscape(menu);
 707                 }
 708                 // Show floating action button and list bottom padding.
 709                 if (mNoteListFragment != null) {
 710                     mNoteListFragment.setFloatingActionButtonVisible(true);
 711                     mNoteListFragment.showListPadding(true);
 712                 }
 713                 mTabletSearchQuery = &quot;&quot;;
 714                 mSearchView.setQuery(&quot;&quot;, false);
 715                 checkEmptyListText(false);
 716                 getNoteListFragment().clearSearch();
 717                 return true;
 718             }
 719         });
 720         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 721             @Override
 722             public boolean onMenuItemClick(MenuItem item) {
 723                 if (!mSearchMenuItem.isActionViewExpanded()) {
 724                     showDetailPlaceholder();
 725                 }
 726                 return false;
 727             }
 728         });
 729         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 730         if ((mCurrentNote != null) &amp;&amp; mCurrentNote.isDeleted()) {
 731             trashItem.setTitle(R.string.undelete);
 732             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 733         } else {
 734             trashItem.setTitle(R.string.delete);
 735             trashItem.setIcon(R.drawable.ic_trash_24dp);
 736         }
 737         if (DisplayUtils.isLargeScreenLandscape(this)) {
 738             // Restore the search query on landscape tablets
 739             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 740                 mSearchMenuItem.expandActionView();
 741                 mSearchView.setQuery(mTabletSearchQuery, false);
 742                 mSearchView.clearFocus();
 743             }
 744             updateActionsForLargeLandscape(menu);
 745         } else {
 746             menu.findItem(R.id.menu_search).setVisible(true);
 747             menu.findItem(R.id.menu_share).setVisible(false);
 748             menu.findItem(R.id.menu_view_info).setVisible(false);
 749             menu.findItem(R.id.menu_checklist).setVisible(false);
 750             menu.findItem(R.id.menu_history).setVisible(false);
 751             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 752             menu.findItem(R.id.menu_sidebar).setVisible(false);
 753             trashItem.setVisible(false);
 754             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 755         }
 756         if ((mSelectedTag != null) &amp;&amp; (mSelectedTag.id == TRASH_ID)) {
 757             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 758             mEmptyTrashMenuItem.setVisible(true);
 759             updateTrashMenuItem();
 760             menu.findItem(R.id.menu_search).setVisible(false);
 761             menu.findItem(R.id.menu_share).setVisible(false);
 762             menu.findItem(R.id.menu_history).setVisible(false);
 763             menu.findItem(R.id.menu_checklist).setVisible(false);
 764         }
 765         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.toolbarIconColor);
 766         return true;
 767     }
 768 
 769     @Override
 770     public boolean onOptionsItemSelected(MenuItem item) {
 771         if (mDrawerToggle.onOptionsItemSelected(item)) {
 772             return true;
 773         }
 774         switch (item.getItemId()) {
 775             case R.id.menu_sidebar:
 776                 FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 777                 if (mNoteListFragment.isHidden()) {
 778                     ft.show(mNoteListFragment);
 779                 } else {
 780                     ft.hide(mNoteListFragment);
 781                 }
 782                 ft.commitNowAllowingStateLoss();
 783                 mIsTabetFullscreen = mNoteListFragment.isHidden();
 784                 return true;
 785             case R.id.menu_markdown_preview:
 786                 if (mIsShowingMarkdown) {
 787                     item.setIcon(R.drawable.ic_visibility_on_24dp);
 788                     item.setTitle(getString(R.string.markdown_show));
 789                     setMarkdownShowing(false);
 790                     mCurrentNote.setPreviewEnabled(false);
 791                 } else {
 792                     item.setIcon(R.drawable.ic_visibility_off_24dp);
 793                     item.setTitle(getString(R.string.markdown_hide));
 794                     setMarkdownShowing(true);
 795                     mCurrentNote.setPreviewEnabled(true);
 796                 }
 797 
 798                 mCurrentNote.save();
 799                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.toolbarIconColor);
 800 
 801                 return true;
 802             case R.id.menu_delete:
 803                 if (mNoteEditorFragment != null) {
 804                     if (mCurrentNote != null) {
 805                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 806                         mCurrentNote.setModificationDate(Calendar.getInstance());
 807                         mCurrentNote.save();
 808 
 809                         updateViewsAfterTrashAction(mCurrentNote);
 810                     }
 811                 }
 812                 return true;
 813             case R.id.menu_empty_trash:
<abbr title=" 814                 AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.style.Dialog));"> 814                 AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.styleðŸ”µ</abbr>
 815 
 816                 alert.setTitle(R.string.empty_trash);
 817                 alert.setMessage(R.string.confirm_empty_trash);
 818                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 819                     public void onClick(DialogInterface dialog, int whichButton) {
 820                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 821                         AnalyticsTracker.track(
 822                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 823                                 AnalyticsTracker.CATEGORY_NOTE,
 824                                 &quot;overflow_menu&quot;
 825                         );
 826                     }
 827                 });
 828                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 829                     public void onClick(DialogInterface dialog, int whichButton) {
 830                         // Do nothing, just closing the dialog
 831                     }
 832                 });
 833                 alert.show();
 834                 return true;
 835             case android.R.id.home:
 836                 invalidateOptionsMenu();
 837                 return true;
 838             default:
 839                 return super.onOptionsItemSelected(item);
 840         }
 841     }
 842 
 843     @Override
 844     public boolean onPrepareOptionsMenu(Menu menu) {
 845         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 846 
 847         if (mIsShowingMarkdown) {
 848             markdownItem.setIcon(R.drawable.ic_visibility_off_24dp);
 849             markdownItem.setTitle(getString(R.string.markdown_hide));
 850         } else {
 851             markdownItem.setIcon(R.drawable.ic_visibility_on_24dp);
 852             markdownItem.setTitle(getString(R.string.markdown_show));
 853         }
 854 
 855         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.toolbarIconColor);
 856 
 857         return super.onPrepareOptionsMenu(menu);
 858     }
 859 
 860     public void submitSearch(String selection) {
 861         if (mSearchView != null) {
 862             String query = mSearchView.getQuery().toString();
 863 
 864             if (query.endsWith(TAG_PREFIX)) {
<abbr title=" 865                 mSearchView.setQuery(query.substring(0, query.lastIndexOf(TAG_PREFIX)) + selection, true);"> 865                 mSearchView.setQuery(query.substring(0, query.lastIndexOf(TAG_PREFIX)) + selection, true)ðŸ”µ</abbr>
 866             } else {
 867                 mSearchView.setQuery(selection, true);
 868             }
 869         }
 870     }
 871 
 872     private void updateActionsForLargeLandscape(Menu menu) {
 873         if (mCurrentNote != null) {
 874             menu.findItem(R.id.menu_checklist).setVisible(true);
 875             menu.findItem(R.id.menu_delete).setVisible(true);
 876             menu.findItem(R.id.menu_history).setVisible(true);
 877             menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 878             menu.findItem(R.id.menu_share).setVisible(true);
 879             menu.findItem(R.id.menu_sidebar).setVisible(true);
 880             menu.findItem(R.id.menu_view_info).setVisible(true);
 881         } else {
 882             menu.findItem(R.id.menu_checklist).setVisible(false);
 883             menu.findItem(R.id.menu_delete).setVisible(false);
 884             menu.findItem(R.id.menu_history).setVisible(false);
 885             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 886             menu.findItem(R.id.menu_share).setVisible(false);
 887             menu.findItem(R.id.menu_sidebar).setVisible(false);
 888             menu.findItem(R.id.menu_view_info).setVisible(false);
 889         }
 890 
 891         menu.findItem(R.id.menu_empty_trash).setVisible(false);
 892     }
 893 
 894     public void updateViewsAfterTrashAction(Note note) {
 895         if (note == null || isFinishing()) {
 896             return;
 897         }
 898 
 899         if (note.isDeleted()) {
 900             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 901             deletedNoteIds.add(note.getSimperiumKey());
 902             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 903             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 904             AnalyticsTracker.track(
 905                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 906                     AnalyticsTracker.CATEGORY_NOTE,
 907                     &quot;overflow_menu&quot;
 908             );
 909         } else {
 910             AnalyticsTracker.track(
 911                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 912                     AnalyticsTracker.CATEGORY_NOTE,
 913                     &quot;overflow_menu&quot;
 914             );
 915         }
 916 
 917         // If we just deleted/restored the active note, show the placeholder
 918         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 919             showDetailPlaceholder();
 920         }
 921 
 922         NoteListFragment fragment = getNoteListFragment();
 923         if (fragment != null) {
 924             fragment.getPrefs();
 925             fragment.refreshList();
 926         }
 927 
 928         invalidateOptionsMenu();
 929     }
 930 
 931     public void setMarkdownShowing(boolean isMarkdownShowing) {
 932         mIsShowingMarkdown = isMarkdownShowing;
 933         if (mNoteEditorFragment != null) {
 934             if (isMarkdownShowing) {
 935                 mNoteEditorFragment.showMarkdown();
 936             } else {
 937                 mNoteEditorFragment.hideMarkdown();
 938             }
 939         }
 940         invalidateOptionsMenu();
 941     }
 942 
 943     /**
 944      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 945      * the item with the given ID was selected. Used for tablets only.
 946      */
 947     @Override
<abbr title=" 948     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 948     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 949         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 950             // Launch the editor activity
 951             Bundle arguments = new Bundle();
 952             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 953             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 954             arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 955 
 956             if (matchOffsets != null) {
 957                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 958             }
 959 
 960             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 961             editNoteIntent.putExtras(arguments);
 962             if (mNoteListFragment.isHidden()) {
 963                 editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 964             }
 965             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 966         } else {
 967             mNoteEditorFragment.setNote(noteID, matchOffsets);
 968             getNoteListFragment().setNoteSelected(noteID);
 969             setMarkdownShowing(isPreviewEnabled);
 970 
 971             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 972                 mTabletSearchQuery = mSearchView.getQuery().toString();
 973             }
 974 
 975             mNoteEditorFragment.clearMarkdown();
 976 
 977             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 978                 setMarkdownShowing(false);
 979             }
 980 
 981             invalidateOptionsMenu();
 982         }
 983 
 984         AnalyticsTracker.track(
 985                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 986                 AnalyticsTracker.CATEGORY_NOTE,
 987                 &quot;note_list_row_tap&quot;
 988         );
 989     }
 990 
 991     @Override
 992     public void onUserCreated(User user) {
 993         // New account created
 994         AnalyticsTracker.track(
 995                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 996                 AnalyticsTracker.CATEGORY_USER,
 997                 &quot;account_created_from_login_activity&quot;
 998         );
 999     }
1000 
1001     public void onUserStatusChange(User.Status status) {
1002         switch (status) {
1003             // successfully used access token to connect to simperium bucket
1004             case AUTHORIZED:
1005                 runOnUiThread(new Runnable() {
1006                     @Override
1007                     public void run() {
1008                         if (!mNotesBucket.hasChangeVersion()) {
1009                             setToolbarProgressVisibility(true);
1010                         }
1011                     }
1012                 });
1013                 break;
1014 
1015             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
1016             case NOT_AUTHORIZED:
1017                 runOnUiThread(new Runnable() {
1018                     @Override
1019                     public void run() {
1020                         startLoginActivity(true);
1021                     }
1022                 });
1023                 break;
1024 
<abbr title="1025             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything">1025             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
1026             case UNKNOWN:
1027                 break;
1028         }
1029     }
1030 
1031     private void setToolbarProgressVisibility(boolean isVisible) {
1032         if (getSupportActionBar() != null) {
1033             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1034         }
1035     }
1036 
1037     public void startLoginActivity(boolean signInFirst) {
1038         // Clear some account-specific prefs
1039         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
1040         editor.remove(PrefUtils.PREF_WP_TOKEN);
1041         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
1042         editor.apply();
1043 
1044         Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
1045         startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
1046     }
1047 
1048     @Override
1049     public void recreate() {
1050         Handler handler = new Handler();
1051         handler.post(new Runnable() {
1052             @Override
1053             public void run() {
1054                 NotesActivity.super.recreate();
1055             }
1056         });
1057     }
1058 
1059     @Override
1060     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1061         super.onActivityResult(requestCode, resultCode, data);
1062         switch (requestCode) {
1063             case Simplenote.INTENT_PREFERENCES:
<abbr title="1064                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1064                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
1065                 invalidateOptionsMenu();
1066                 NoteListFragment fragment = getNoteListFragment();
1067                 if (fragment != null) {
1068                     fragment.getPrefs();
1069                     fragment.refreshList();
1070                 }
1071 
1072                 break;
1073             case Simplenote.INTENT_EDIT_NOTE:
1074                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
1075                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1076                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1077                         if (noteId != null) {
1078                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1079                             deletedNoteIds.add(noteId);
1080                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title="1081                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));">1081                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
1082                         }
<abbr title="1083                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1083                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
1084                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1085                         mNoteListFragment.setNoteSelected(selectedNoteId);
1086                         if (mNoteEditorFragment != null) {
1087                             mNoteEditorFragment.setNote(selectedNoteId);
1088                         }
1089                     }
1090                 }
1091                 break;
1092             case Simperium.SIGNUP_SIGNIN_REQUEST:
1093                 invalidateOptionsMenu();
1094 
1095                 Simplenote app = (Simplenote) getApplication();
1096                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1097                 CrashUtils.setCurrentUser(app.getSimperium().getUser());
1098 
1099                 AnalyticsTracker.track(
1100                         AnalyticsTracker.Stat.USER_SIGNED_IN,
1101                         AnalyticsTracker.CATEGORY_USER,
1102                         &quot;signed_in_from_login_activity&quot;
1103                 );
1104 
1105                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1106                     finish();
1107                 }
1108 
1109                 break;
1110         }
1111     }
1112 
1113     @Override
1114     public void onUndo() {
1115         if (mUndoBarController == null) return;
1116 
1117         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1118         if (deletedNoteIds != null) {
1119             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1120                 Note deletedNote;
1121                 try {
1122                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1123                 } catch (BucketObjectMissingException e) {
1124                     return;
1125                 }
1126                 if (deletedNote != null) {
1127                     deletedNote.setDeleted(false);
1128                     deletedNote.setModificationDate(Calendar.getInstance());
1129                     deletedNote.save();
1130                     NoteListFragment fragment = getNoteListFragment();
1131                     if (fragment != null) {
1132                         fragment.getPrefs();
1133                         fragment.refreshList();
1134                     }
1135                 }
1136             }
1137         }
1138     }
1139 
1140     @Override
1141     protected void onPostCreate(Bundle savedInstanceState) {
1142         super.onPostCreate(savedInstanceState);
1143         // Sync the toggle state after onRestoreInstanceState has occurred.
1144         mDrawerToggle.syncState();
1145     }
1146 
1147     @Override
1148     public void onConfigurationChanged(@NonNull Configuration newConfig) {
1149         super.onConfigurationChanged(newConfig);
1150 
1151         mDrawerToggle.onConfigurationChanged(newConfig);
1152 
1153         if (DisplayUtils.isLargeScreen(this)) {
1154             mIsShowingMarkdown = false;
1155 
1156             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1157                 // Add the editor fragment
1158                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1159                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1159                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
1160                 } else if (DisplayUtils.isLandscape(this)) {
1161                     addEditorFragment();
1162                 }
1163 
1164                 if (mNoteListFragment != null) {
1165                     mNoteListFragment.setActivateOnItemClick(true);
1166                     mNoteListFragment.setDividerVisible(true);
1167                 }
1168 
1169                 // Select the current note on a tablet
1170                 if (mCurrentNote != null) {
<abbr title="1171                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1171                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
1172                 } else {
1173                     mNoteEditorFragment.setPlaceholderVisible(true);
1174                     mNoteListFragment.getListView().clearChoices();
1175                 }
1176 
1177                 invalidateOptionsMenu();
<abbr title="1178             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait">1178             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to poðŸ”µ</abbr>
1179             } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1180                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1180                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(),ðŸ”µ</abbr>
1181             }
1182         }
1183 
1184         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1185             // Remove the editor fragment when rotating back to portrait
1186             mCurrentNote = null;
1187             if (mNoteListFragment != null) {
1188                 mNoteListFragment.setActivateOnItemClick(false);
1189                 mNoteListFragment.setDividerVisible(false);
1190                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1191                 mNoteListFragment.refreshList();
1192             }
1193             FragmentManager fm = getSupportFragmentManager();
1194             FragmentTransaction ft = fm.beginTransaction();
1195             ft.remove(mNoteEditorFragment);
1196             mNoteEditorFragment = null;
1197             ft.commitAllowingStateLoss();
1198             fm.executePendingTransactions();
1199             invalidateOptionsMenu();
1200         }
1201     }
1202 
1203     public void checkEmptyListText(boolean isSearch) {
1204         if (isSearch) {
1205             if (DisplayUtils.isLandscape(this) &amp;&amp; (!DisplayUtils.isLargeScreen(this))) {
1206                 getNoteListFragment().setEmptyListImage(-1);
1207             } else {
1208                 getNoteListFragment().setEmptyListImage(R.drawable.ic_search_24dp);
1209             }
1210             getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_search));
1211         } else if (mSelectedTag != null) {
1212             if (mSelectedTag.id == ALL_NOTES_ID) {
1213                 getNoteListFragment().setEmptyListImage(R.drawable.ic_notes_24dp);
1214                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_all));
1215             } else if (mSelectedTag.id == TRASH_ID) {
1216                 getNoteListFragment().setEmptyListImage(R.drawable.ic_trash_24dp);
1217                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_trash));
<abbr title="1218                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TRASH_VIEWED, AnalyticsTracker.CATEGORY_NOTE, &quot;trash_filter_selected&quot;);">1218                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TRASH_VIEWED, AnalyticsTracker.CATEGORYðŸ”µ</abbr>
1219             } else if (mSelectedTag.id == UNTAGGED_NOTES_ID) {
1220                 getNoteListFragment().setEmptyListImage(R.drawable.ic_untagged_24dp);
1221                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_untagged));
1222             } else {
1223                 getNoteListFragment().setEmptyListImage(R.drawable.ic_tag_24dp);
<abbr title="1224                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_tag, mSelectedTag.name));">1224                 getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_tag, mSelectedTaðŸ”µ</abbr>
1225             }
1226         } else {
1227             getNoteListFragment().setEmptyListImage(R.drawable.ic_notes_24dp);
1228             getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_all));
1229         }
1230     }
1231 
1232     public void showDetailPlaceholder() {
1233         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1234             mCurrentNote = null;
1235             mNoteEditorFragment.setPlaceholderVisible(true);
1236             mNoteEditorFragment.clearMarkdown();
1237             mNoteEditorFragment.hideMarkdown();
1238             mIsShowingMarkdown = false;
1239         }
1240     }
1241 
1242     public void stopListeningToNotesBucket() {
1243         mNotesBucket.removeOnNetworkChangeListener(this);
1244         mNotesBucket.removeOnSaveObjectListener(this);
1245         mNotesBucket.removeOnDeleteObjectListener(this);
1246     }
1247 
1248     // Returns the appropriate view to show the undo bar within
1249     private View getUndoView() {
1250         View undoView = mFragmentsContainer;
1251         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1252                 getNoteListFragment() != null &amp;&amp;
1253                 getNoteListFragment().getRootView() != null) {
1254             undoView = getNoteListFragment().getRootView();
1255         }
1256 
1257         return undoView;
1258     }
1259 
1260     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1261         if (mUndoBarController != null) {
1262             mUndoBarController.setDeletedNoteIds(noteIds);
1263             mUndoBarController.showUndoBar(
1264                     getUndoView(),
<abbr title="1265                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1265                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1266             );
1267         }
1268     }
1269 
1270     /* Simperium Bucket Listeners */
1271     // received a change from the network, refresh the list
1272     @Override
1273     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1274         runOnUiThread(new Runnable() {
1275             @Override
1276             public void run() {
1277                 if (type == Bucket.ChangeType.INDEX) {
1278                     setToolbarProgressVisibility(false);
1279                 }
1280                 mNoteListFragment.refreshList();
1281             }
1282         });
1283     }
1284 
1285     @Override
1286     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1287         runOnUiThread(new Runnable() {
1288             @Override
1289             public void run() {
1290                 mNoteListFragment.refreshList();
1291             }
1292         });
1293     }
1294 
1295     @Override
1296     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1297         runOnUiThread(new Runnable() {
1298             @Override
1299             public void run() {
1300                 mNoteListFragment.refreshList();
1301             }
1302         });
1303     }
1304 
1305     @Override
1306     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1307         // noop, NoteEditorFragment will handle this
1308     }
1309 
1310     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1311         @Override
1312         protected Void doInBackground(Void... voids) {
1313             if (mNotesBucket == null) {
1314                 return null;
1315             }
1316             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1317             Bucket.ObjectCursor c = query.execute();
1318             while (c.moveToNext()) {
1319                 c.getObject().delete();
1320             }
1321             return null;
1322         }
1323 
1324         @Override
1325         protected void onPostExecute(Void nada) {
1326             showDetailPlaceholder();
1327         }
1328     }
1329 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.content.DialogInterface;
   5  import android.content.Intent;
   6  import android.content.SharedPreferences;
   7  import android.content.res.ColorStateList;
   8  import android.content.res.Configuration;
   9  import android.os.AsyncTask;
  10  import android.os.Bundle;
  11  import android.os.Handler;
  12  import android.text.TextUtils;
  13  import android.view.Menu;
  14  import android.view.MenuInflater;
  15  import android.view.MenuItem;
  16  import android.view.View;
  17  import android.widget.LinearLayout;
  18  import android.widget.ListView;
  19  import android.widget.ProgressBar;
  20  
  21  import androidx.annotation.NonNull;
  22  import androidx.appcompat.app.ActionBar;
  23  import androidx.appcompat.app.ActionBarDrawerToggle;
  24  import androidx.appcompat.app.AlertDialog;
  25  import androidx.appcompat.app.AppCompatActivity;
  26  import androidx.appcompat.view.ContextThemeWrapper;
  27  import androidx.appcompat.widget.SearchView;
  28  import androidx.appcompat.widget.Toolbar;
  29  import androidx.core.view.GravityCompat;
  30  import androidx.drawerlayout.widget.DrawerLayout;
  31  import androidx.fragment.app.FragmentManager;
  32  import androidx.fragment.app.FragmentTransaction;
  33  import androidx.preference.PreferenceManager;
  34  
  35  import com.automattic.simplenote.analytics.AnalyticsTracker;
  36  import com.automattic.simplenote.models.Note;
  37  import com.automattic.simplenote.models.Tag;
  38  import com.automattic.simplenote.utils.CrashUtils;
  39  import com.automattic.simplenote.utils.DisplayUtils;
  40  import com.automattic.simplenote.utils.DrawableUtils;
  41  import com.automattic.simplenote.utils.HtmlCompat;
  42  import com.automattic.simplenote.utils.PrefUtils;
  43  import com.automattic.simplenote.utils.StrUtils;
  44  import com.automattic.simplenote.utils.TagsAdapter;
  45  import com.automattic.simplenote.utils.ThemeUtils;
  46  import com.automattic.simplenote.utils.UndoBarController;
  47  import com.google.android.material.navigation.NavigationView;
  48  import com.simperium.Simperium;
  49  import com.simperium.client.Bucket;
  50  import com.simperium.client.BucketObjectMissingException;
  51  import com.simperium.client.BucketObjectNameInvalid;
  52  import com.simperium.client.Query;
  53  import com.simperium.client.User;
  54  
  55  import org.wordpress.passcodelock.AppLockManager;
  56  
  57  import java.util.ArrayList;
  58  import java.util.Calendar;
  59  import java.util.HashMap;
  60  import java.util.List;
  61  import java.util.Map;
  62  
  63  import static com.automattic.simplenote.NoteListFragment.TAG_PREFIX;
  64  import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  65  import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  66  import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  67  import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  68  import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  69  import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  70  import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  71  import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  72  import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  73  import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  74  
  75  public class NotesActivity extends AppCompatActivity implements
<abbr title="  76          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  76          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  77          Bucket.Listener&lt;Note&gt; {
  78  
  79      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  80      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  81      protected Bucket&lt;Note&gt; mNotesBucket;
  82      protected Bucket&lt;Tag&gt; mTagsBucket;
  83      private boolean mIsShowingMarkdown;
  84      private boolean mShouldSelectNewNote;
  85      private boolean mIsSettingsClicked;
  86      private boolean mIsTabetFullscreen;
  87  
  88      private String mTabletSearchQuery;
  89      private UndoBarController mUndoBarController;
  90      private View mFragmentsContainer;
  91      private SearchView mSearchView;
  92      private MenuItem mSearchMenuItem;
  93      private NoteListFragment mNoteListFragment;
  94      private NoteEditorFragment mNoteEditorFragment;
  95      private Note mCurrentNote;
  96      private MenuItem mEmptyTrashMenuItem;
  97  
  98      // Menu drawer
  99      private static final int GROUP_PRIMARY = 100;
 100      private static final int GROUP_SECONDARY = 101;
 101      private static final int GROUP_TERTIARY = 102;
 102      private DrawerLayout mDrawerLayout;
 103      private Menu mNavigationMenu;
 104      private ActionBarDrawerToggle mDrawerToggle;
 105      private TagsAdapter mTagsAdapter;
 106      private TagsAdapter.TagMenuItem mSelectedTag;
 107      // Tags bucket listener
 108      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 109          void updateNavigationDrawer() {
 110              runOnUiThread(new Runnable() {
 111                  public void run() {
 112                      updateNavigationDrawerItems();
 113                  }
 114              });
 115          }
 116  
 117          @Override
 118          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 119              updateNavigationDrawer();
 120          }
 121  
 122          @Override
 123          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 124              updateNavigationDrawer();
 125          }
 126  
 127          @Override
 128          public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 129              updateNavigationDrawer();
 130          }
 131  
 132          @Override
 133          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 134              // noop
 135          }
 136      };
 137  
 138      @Override
 139      protected void onCreate(Bundle savedInstanceState) {
 140          ThemeUtils.setTheme(this);
 141          super.onCreate(savedInstanceState);
 142  
 143          setContentView(R.layout.activity_notes);
 144  
 145          mFragmentsContainer = findViewById(R.id.note_fragment_container);
 146  
 147          Simplenote currentApp = (Simplenote) getApplication();
 148          if (mNotesBucket == null) {
 149              mNotesBucket = currentApp.getNotesBucket();
 150          }
 151  
 152          if (mTagsBucket == null) {
 153              mTagsBucket = currentApp.getTagsBucket();
 154          }
 155  
 156          Toolbar toolbar = findViewById(R.id.toolbar);
 157          setSupportActionBar(toolbar);
 158          configureNavigationDrawer(toolbar);
 159  
 160          if (savedInstanceState == null) {
 161              mNoteListFragment = new NoteListFragment();
 162              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 163              fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 164              fragmentTransaction.commit();
 165          } else {
 166              mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 167          }
 168          mIsTabetFullscreen = mNoteListFragment.isHidden();
 169  
 170          if (DisplayUtils.isLargeScreen(this)) {
 171              if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 172                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 172                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_ðŸ”µ</abbr>
 173              } else if (DisplayUtils.isLandscape(this)) {
 174                  addEditorFragment();
 175              }
 176          }
 177  
 178          // enable ActionBar app icon to behave as action to toggle nav drawer
 179          ActionBar actionBar = getSupportActionBar();
 180          if (actionBar != null) {
 181              actionBar.setDisplayHomeAsUpEnabled(true);
 182              actionBar.setHomeButtonEnabled(true);
 183  
 184              // Add loading indicator to show when indexing
<abbr title=" 185              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 185              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, nullðŸ”µ</abbr>
 186              actionBar.setDisplayShowCustomEnabled(true);
 187              actionBar.setCustomView(progressBar);
 188              setToolbarProgressVisibility(false);
 189          }
 190  
 191          mUndoBarController = new UndoBarController(this);
 192  
 193          // Creates &#x27;Welcome&#x27; note
 194          checkForFirstLaunch();
 195  
 196          checkForSharedContent();
 197  
 198          currentApp.getSimperium().setOnUserCreatedListener(this);
 199          currentApp.getSimperium().setUserStatusChangeListener(this);
 200      }
 201  
 202      @Override
 203      protected void onResume() {
 204          super.onResume();
 205  
 206          // Ensure user has valid authorization
 207          if (userAuthenticationIsInvalid()) {
 208              startLoginActivity(true);
 209              Intent intent = getIntent();
 210  
 211              if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 212                      intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 213                  AnalyticsTracker.track(
 214                          NOTE_WIDGET_SIGN_IN_TAPPED,
 215                          CATEGORY_WIDGET,
 216                          &quot;note_widget_sign_in_tapped&quot;
 217                  );
 218              }
 219          }
 220  
 221          disableScreenshotsIfLocked(this);
 222  
 223          mNotesBucket.start();
 224          mTagsBucket.start();
 225  
 226          mNotesBucket.addOnNetworkChangeListener(this);
 227          mNotesBucket.addOnSaveObjectListener(this);
 228          mNotesBucket.addOnDeleteObjectListener(this);
 229          mTagsBucket.addListener(mTagsMenuUpdater);
 230  
 231          updateNavigationDrawerItems();
 232  
 233          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 234          if (userIsUnauthorized()) {
 235              if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 236                  mSelectedTag = null;
 237                  mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 238              }
 239          }
 240  
 241          filterListBySelectedTag();
 242  
 243          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 244              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 244              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNoteðŸ”µ</abbr>
 245              mShouldSelectNewNote = false;
 246          }
 247  
 248          if (mIsShowingMarkdown) {
 249              setMarkdownShowing(false);
 250          }
 251  
 252          FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 253          if(DisplayUtils.isLargeScreenLandscape(this)) {
 254              if (mIsTabetFullscreen) {
 255                  ft.hide(mNoteListFragment);
 256              } else {
 257                  ft.show(mNoteListFragment);
 258              }
 259          } else {
 260              ft.show(mNoteListFragment);
 261          }
 262          ft.commitNow();
 263      }
 264  
 265      @Override
 266      protected void onPause() {
 267          super.onPause();  // Always call the superclass method first
 268          mTagsBucket.removeListener(mTagsMenuUpdater);
 269          mTagsBucket.stop();
 270  
 271          mNotesBucket.removeOnNetworkChangeListener(this);
 272          mNotesBucket.removeOnSaveObjectListener(this);
 273          mNotesBucket.removeOnDeleteObjectListener(this);
 274          mNotesBucket.stop();
 275      }
 276  
 277      @Override
 278      public void setTitle(CharSequence title) {
 279          if (getSupportActionBar() != null) {
 280              getSupportActionBar().setTitle(title);
 281          }
 282      }
 283  
 284      @Override
 285      public void onBackPressed() {
 286          if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 287              mDrawerLayout.closeDrawer(GravityCompat.START);
 288          } else {
 289              super.onBackPressed();
 290          }
 291      }
 292  
 293      @Override
 294      public void onActionModeCreated() {
 295          mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 296      }
 297  
 298      @Override
 299      public void onActionModeDestroyed() {
 300          if (mSearchMenuItem != null &amp;&amp; !mSearchMenuItem.isActionViewExpanded()) {
 301              mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 302          }
 303      }
 304  
 305      private ColorStateList getIconSelector() {
 306          int[][] states = new int[][] {
 307                  new int[] { android.R.attr.state_checked}, // checked
 308                  new int[] {-android.R.attr.state_checked}  // unchecked
 309          };
 310  
 311          int[] colors = new int[] {
 312                  ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 313                  ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.toolbarIconColor)
 314          };
 315  
 316          return new ColorStateList(states, colors);
 317      }
 318  
 319      private ColorStateList getTextSelector() {
 320          int[][] states = new int[][] {
 321              new int[] {-android.R.attr.state_enabled}, // disabled
 322              new int[] { android.R.attr.state_checked}, // checked
 323              new int[] {-android.R.attr.state_checked}  // unchecked
 324          };
 325  
 326          int[] colors = new int[] {
 327              getResources().getColor(R.color.text_title_disabled, getTheme()),
 328              ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 329              ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)
 330          };
 331  
 332          return new ColorStateList(states, colors);
 333      }
 334  
 335      private void configureNavigationDrawer(Toolbar toolbar) {
 336          ColorStateList iconSelector = getIconSelector();
 337          ColorStateList textSelector = getTextSelector();
 338          mDrawerLayout = findViewById(R.id.drawer_layout);
 339          NavigationView navigationView = findViewById(R.id.navigation_view);
 340          navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 341          navigationView.setItemIconTintList(iconSelector);
 342          navigationView.setItemTextColor(textSelector);
 343          navigationView.setNavigationItemSelectedListener(
 344              new NavigationView.OnNavigationItemSelectedListener() {
 345                  @Override
 346                  public boolean onNavigationItemSelected(@NonNull MenuItem item) {
 347                      mDrawerLayout.closeDrawer(GravityCompat.START);
 348  
 349                      if (item.getItemId() == SETTINGS_ID) {
 350                          AnalyticsTracker.track(
 351                                  AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 352                                  AnalyticsTracker.CATEGORY_TAG,
 353                                  &quot;selected_tag_in_navigation_drawer&quot;,
 354                                  new HashMap&lt;String, String&gt;(1){{put(&quot;tag&quot;, &quot;settings&quot;);}}
 355                          );
 356                          mIsSettingsClicked = true;
 357                          return false;
 358                      } else {
 359                          mSelectedTag = mTagsAdapter.getTagFromItem(item);
 360                          filterListBySelectedTag();
 361                          return true;
 362                      }
 363                  }
 364              }
 365          );
 366  
 367          mNavigationMenu = navigationView.getMenu();
<abbr title=" 368          mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 368          mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawaðŸ”µ</abbr>
<abbr title=" 369          mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 369          mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_tðŸ”µ</abbr>
<abbr title=" 370          mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 370          mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawablðŸ”µ</abbr>
 371          mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 372  
 373          if (mSelectedTag == null)
 374              mSelectedTag = mTagsAdapter.getDefaultItem();
 375  
 376          mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 377                  R.string.close_drawer) {
 378              public void onDrawerClosed(View view) {
 379                  supportInvalidateOptionsMenu();
 380  
 381                  if (mIsSettingsClicked) {
 382                      Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 383                      startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 384                      mIsSettingsClicked = false;
 385                  }
 386              }
 387  
 388              public void onDrawerOpened(View drawerView) {
 389                  // noop
 390              }
 391  
 392              @Override
 393              public void onDrawerSlide(View drawerView, float slideOffset) {
 394                  super.onDrawerSlide(drawerView, 0f);
 395              }
 396          };
 397  
 398          mDrawerLayout.addDrawerListener(mDrawerToggle);
 399      }
 400  
 401      private void filterListBySelectedTag() {
 402          MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 403  
 404          if (selectedMenuItem != null) {
 405              mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 406          } else {
 407              mSelectedTag = mTagsAdapter.getDefaultItem();
 408          }
 409  
 410          checkEmptyListText(false);

 411  
 412          if (mNoteListFragment.isHidden()) {
 413              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 414              fragmentTransaction.show(mNoteListFragment);
 415              fragmentTransaction.commitNowAllowingStateLoss();
 416          }
 417  
 418          // Disable long press on notes when viewing Trash.
 419          if (mSelectedTag.id == TRASH_ID) {
 420              getNoteListFragment().getListView().setLongClickable(false);
 421          } else {
 422              getNoteListFragment().getListView().setLongClickable(true);
 423          }
 424  
 425          getNoteListFragment().refreshListFromNavSelect();
 426  
 427          Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 428  
 429          switch ((int) mSelectedTag.id) {
 430              case ALL_NOTES_ID:
 431                  properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 432                  break;
 433              case TRASH_ID:
 434                  properties.put(&quot;tag&quot;, &quot;trash&quot;);
 435                  break;
 436              case UNTAGGED_NOTES_ID:
 437                  properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 438                  break;
 439              default:
 440                  properties = null;
 441                  break;
 442          }
 443  
 444          AnalyticsTracker.track(
 445                  AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 446                  AnalyticsTracker.CATEGORY_TAG,
 447                  &quot;selected_tag_in_navigation_drawer&quot;,
 448                  properties
 449          );
 450  
 451          setSelectedTagActive();
 452      }
 453  
 454      private void checkForFirstLaunch() {
 455          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 456              // Create the welcome note
 457              try {
 458                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 459                  welcomeNote.setCreationDate(Calendar.getInstance());
 460                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 461                  welcomeNote.setContent(getString(R.string.welcome_note));
 462                  welcomeNote.getTitle();
 463                  welcomeNote.save();
 464              } catch (BucketObjectNameInvalid e) {
 465                  // this won&#x27;t happen because welcome-android is a valid name
 466              }
 467  
 468              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 469              SharedPreferences.Editor editor = preferences.edit();
 470              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 471              editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 472              editor.apply();
 473          }
 474      }
 475  
 476      private void checkForSharedContent() {
 477          if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 478              // Check share action
 479              Intent intent = getIntent();
 480              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 481              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 482  
 483              // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search
 484              String intentAction = StrUtils.notNullStr(intent.getAction());
 485              boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 486              if (!TextUtils.isEmpty(text)) {
 487                  if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 488                      text = subject + &quot;\n\n&quot; + text;
 489                  }
 490                  Note note = mNotesBucket.newObject();
 491                  note.setCreationDate(Calendar.getInstance());
 492                  note.setModificationDate(note.getCreationDate());
 493                  note.setContent(text);
 494                  note.save();
 495                  setCurrentNote(note);
 496                  mShouldSelectNewNote = true;
 497  
 498                  AnalyticsTracker.track(
 499                          AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 500                          AnalyticsTracker.CATEGORY_NOTE,
 501                          &quot;external_share&quot;
 502                  );
 503  
 504                  if (!DisplayUtils.isLargeScreenLandscape(this)) {
 505                      // Disable the lock screen when sharing content and opening NoteEditorActivity
 506                      // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 507                      if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 508                          AppLockManager.getInstance().getAppLock().setExemptActivities(
 509                                  new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 510                                          &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 511                          AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 512                      }
 513                  }
 514              }
 515          }
 516      }
 517  
 518      private void updateNavigationDrawerItems() {
 519          boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 520          Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 521          if (isAlphaSort) {
 522              tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 523          } else {
 524              tagCursor = Tag.allWithName(mTagsBucket).execute();
 525          }
 526  
 527          mTagsAdapter.changeCursor(tagCursor);
 528          mNavigationMenu.removeGroup(GROUP_SECONDARY);
 529          mNavigationMenu.removeGroup(GROUP_TERTIARY);
 530  
 531          if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 532              mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 532              mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layðŸ”µ</abbr>
 533  
 534              for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 535                  String name = mTagsAdapter.getItem(i).name;
 536                  int id = (int) mTagsAdapter.getItem(i).id;
 537  
 538                  if (id &gt;= 0) { // Custom tags have a positive ID.
 539                      mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 540                  }
 541              }
 542  
<abbr title=" 543              mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_untagged_24dp).setCheckable(true);"> 543              mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).ðŸ”µ</abbr>
 544              setSelectedTagActive();
 545          }
 546      }
 547  
 548      public void launchEditTags(View view) {
 549          startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 550      }
 551  
 552      private void setSelectedTagActive() {
 553          if (mSelectedTag == null) {
 554              mSelectedTag = mTagsAdapter.getDefaultItem();
 555          }
 556  
 557          MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 558  
 559          if (selectedMenuItem != null) {
 560              selectedMenuItem.setChecked(true);
 561          } else {
 562              mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 563          }
 564  
 565          setTitle(mSelectedTag.name);
 566      }
 567  
 568      public TagsAdapter.TagMenuItem getSelectedTag() {
 569          if (mSelectedTag == null) {
 570              mSelectedTag = mTagsAdapter.getDefaultItem();
 571          }
 572  
 573          return mSelectedTag;
 574      }
 575  
 576      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 577      public void updateTrashMenuItem() {
 578          if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 579              return;
 580  
 581          // Disable the trash icon if there are no notes trashed.
 582          Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 583          if (query.count() == 0) {
 584              mEmptyTrashMenuItem.setEnabled(false);
 585          } else {
 586              mEmptyTrashMenuItem.setEnabled(true);
 587          }
 588      }
 589  
 590      private void addEditorFragment() {
 591          FragmentManager fm = getSupportFragmentManager();
 592          FragmentTransaction ft = fm.beginTransaction();
 593          mNoteEditorFragment = new NoteEditorFragment();
 594          ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 595          ft.commitAllowingStateLoss();
 596          fm.executePendingTransactions();
 597      }
 598  
 599      private boolean userAccountRequired() {
 600          return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 601      }
 602  
 603      /**
 604       * Checks for a previously valid user that is now not authenticated
 605       * Also checks if user account is required (added in version 1.5.6)
 606       *
 607       * @return true if user has invalid authorization
 608       */
 609      private boolean userAuthenticationIsInvalid() {
 610          Simplenote currentApp = (Simplenote) getApplication();
 611          Simperium simperium = currentApp.getSimperium();
 612          User user = simperium.getUser();
 613          boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 614          return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 615                  (userAccountRequired() &amp;&amp; isNotAuthorized);
 616      }
 617  
 618      public boolean userIsUnauthorized() {
 619          Simplenote currentApp = (Simplenote) getApplication();
 620          return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 621      }
 622  
 623      public void setCurrentNote(Note note) {
 624          mCurrentNote = note;
 625      }
 626  
 627      public NoteListFragment getNoteListFragment() {
 628          return mNoteListFragment;
 629      }
 630  
 631      @Override
 632      public boolean onCreateOptionsMenu(final Menu menu) {
 633          super.onCreateOptionsMenu(menu);
 634          MenuInflater inflater = getMenuInflater();
 635          inflater.inflate(R.menu.notes_list, menu);
 636  
 637          // restore the search query if on a landscape tablet
 638          String searchQuery = null;
 639          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 640              searchQuery = mSearchView.getQuery().toString();
 641  
 642          mSearchMenuItem = menu.findItem(R.id.menu_search);
 643          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 644          LinearLayout searchEditFrame = mSearchView.findViewById(R.id.search_edit_frame);
 645          ((LinearLayout.LayoutParams) searchEditFrame.getLayoutParams()).leftMargin = 0;
 646  
 647          if (!TextUtils.isEmpty(searchQuery)) {
 648              mSearchView.setQuery(searchQuery, false);
 649              mSearchMenuItem.expandActionView();
 650          } else {
 651              // Workaround for setting the search placeholder text color
 652              @SuppressWarnings(&quot;ResourceType&quot;)
 653              String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
 654              mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 655                      hintHexColor,
 656                      getString(R.string.search))));
 657          }
 658  
 659          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 660              @Override
 661              public boolean onQueryTextChange(String newText) {
 662                  if (mSearchMenuItem.isActionViewExpanded()) {
 663                      getNoteListFragment().searchNotes(newText, false);
 664                  }
 665  
 666                  return true;
 667              }
 668  
 669              @Override
 670              public boolean onQueryTextSubmit(String queryText) {
 671                  getNoteListFragment().searchNotes(queryText, true);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 672 +                getNoteListFragment().addSearchItem(queryText, 0);</span>
 673                  return true;
 674              }
 675          });
 676  
 677          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 678              @Override
 679              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 680                  mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 681                  getNoteListFragment().searchNotes(&quot;&quot;, false);
 682  
 683                  if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 684                      updateActionsForLargeLandscape(menu);
 685                  }
 686  
 687                  checkEmptyListText(true);
 688  

 689                  if (mNoteListFragment != null) {
 690                      mNoteListFragment.setFloatingActionButtonVisible(false);

 691                  }
 692  
 693                  AnalyticsTracker.track(
 694                          AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 695                          AnalyticsTracker.CATEGORY_NOTE,
 696                          &quot;action_bar_search_tap&quot;
 697                  );
 698                  return true;
 699              }
 700  
 701              @Override
 702              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 703                  mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 704  
 705                  if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 706                      updateActionsForLargeLandscape(menu);
 707                  }
 708  
 709                  // Show all notes again

 710                  if (mNoteListFragment != null) {
 711                      mNoteListFragment.setFloatingActionButtonVisible(true);

 712                  }
 713  
 714                  mTabletSearchQuery = &quot;&quot;;
 715                  mSearchView.setQuery(&quot;&quot;, false);
 716                  checkEmptyListText(false);
 717                  getNoteListFragment().clearSearch();
 718                  return true;
 719              }
 720          });
 721  
 722          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 723              @Override
 724              public boolean onMenuItemClick(MenuItem item) {
 725                  if (!mSearchMenuItem.isActionViewExpanded())
 726                      showDetailPlaceholder();
 727                  return false;
 728              }
 729          });
 730  
 731          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 732          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 733              trashItem.setTitle(R.string.undelete);
 734              trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 735          } else {
 736              trashItem.setTitle(R.string.delete);
 737              trashItem.setIcon(R.drawable.ic_trash_24dp);
 738          }
 739  
 740          if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 741              // Restore the search query on landscape tablets
 742              if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 743                  mSearchMenuItem.expandActionView();
 744                  mSearchView.setQuery(mTabletSearchQuery, false);
 745                  mSearchView.clearFocus();
 746              }
 747  
 748              updateActionsForLargeLandscape(menu);
 749          } else {
 750              menu.findItem(R.id.menu_search).setVisible(true);
 751              menu.findItem(R.id.menu_share).setVisible(false);
 752              menu.findItem(R.id.menu_view_info).setVisible(false);
 753              menu.findItem(R.id.menu_checklist).setVisible(false);
 754              menu.findItem(R.id.menu_history).setVisible(false);
 755              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 756              menu.findItem(R.id.menu_sidebar).setVisible(false);
 757              trashItem.setVisible(false);
 758              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 759          }
 760  
 761          if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
 762              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 763              mEmptyTrashMenuItem.setVisible(true);
 764  
 765              updateTrashMenuItem();
 766  
 767              menu.findItem(R.id.menu_search).setVisible(false);
 768              menu.findItem(R.id.menu_share).setVisible(false);
 769              menu.findItem(R.id.menu_history).setVisible(false);
 770              menu.findItem(R.id.menu_checklist).setVisible(false);
 771          }
 772  
 773          DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.toolbarIconColor);
 774  
 775          return true;
 776      }
 777  
 778      @Override
 779      public boolean onOptionsItemSelected(MenuItem item) {
 780          if (mDrawerToggle.onOptionsItemSelected(item)) {
 781              return true;
 782          }
 783          switch (item.getItemId()) {
 784              case R.id.menu_sidebar:
 785                  FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 786                  if (mNoteListFragment.isHidden()) {
 787                      ft.show(mNoteListFragment);
 788                  } else {
 789                      ft.hide(mNoteListFragment);
 790                  }
 791                  ft.commitNowAllowingStateLoss();
 792                  mIsTabetFullscreen = mNoteListFragment.isHidden();
 793                  return true;
 794              case R.id.menu_markdown_preview:
 795                  if (mIsShowingMarkdown) {
 796                      item.setIcon(R.drawable.ic_visibility_on_24dp);
 797                      item.setTitle(getString(R.string.markdown_show));
 798                      setMarkdownShowing(false);
 799                      mCurrentNote.setPreviewEnabled(false);
 800                  } else {
 801                      item.setIcon(R.drawable.ic_visibility_off_24dp);
 802                      item.setTitle(getString(R.string.markdown_hide));
 803                      setMarkdownShowing(true);
 804                      mCurrentNote.setPreviewEnabled(true);
 805                  }
 806  
 807                  mCurrentNote.save();
 808                  DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.toolbarIconColor);
 809  
 810                  return true;
 811              case R.id.menu_delete:
 812                  if (mNoteEditorFragment != null) {
 813                      if (mCurrentNote != null) {
 814                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 815                          mCurrentNote.setModificationDate(Calendar.getInstance());
 816                          mCurrentNote.save();
 817  
 818                          updateViewsAfterTrashAction(mCurrentNote);
 819                      }
 820                  }
 821                  return true;
 822              case R.id.menu_empty_trash:
<abbr title=" 823                  AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.style.Dialog));"> 823                  AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.style.Dialog))ðŸ”µ</abbr>
 824  
 825                  alert.setTitle(R.string.empty_trash);
 826                  alert.setMessage(R.string.confirm_empty_trash);
 827                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 828                      public void onClick(DialogInterface dialog, int whichButton) {
 829                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 830                          AnalyticsTracker.track(
 831                                  AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 832                                  AnalyticsTracker.CATEGORY_NOTE,
 833                                  &quot;overflow_menu&quot;
 834                          );
 835                      }
 836                  });
 837                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 838                      public void onClick(DialogInterface dialog, int whichButton) {
 839                          // Do nothing, just closing the dialog
 840                      }
 841                  });
 842                  alert.show();
 843                  return true;
 844              case android.R.id.home:
 845                  invalidateOptionsMenu();
 846                  return true;
 847              default:
 848                  return super.onOptionsItemSelected(item);
 849          }
 850      }
 851  
 852      @Override
 853      public boolean onPrepareOptionsMenu(Menu menu) {
 854          MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 855  
 856          if (mIsShowingMarkdown) {
 857              markdownItem.setIcon(R.drawable.ic_visibility_off_24dp);
 858              markdownItem.setTitle(getString(R.string.markdown_hide));
 859          } else {
 860              markdownItem.setIcon(R.drawable.ic_visibility_on_24dp);
 861              markdownItem.setTitle(getString(R.string.markdown_show));
 862          }
 863  
 864          DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.toolbarIconColor);
 865  
 866          return super.onPrepareOptionsMenu(menu);
 867      }
 868  
 869      public void submitSearch(String selection) {
 870          if (mSearchView != null) {
 871              String query = mSearchView.getQuery().toString();
 872  
 873              if (query.endsWith(TAG_PREFIX)) {
 874                  mSearchView.setQuery(query.substring(0, query.lastIndexOf(TAG_PREFIX)) + selection, true);
 875              } else {
 876                  mSearchView.setQuery(selection, true);
 877              }
 878          }
 879      }
 880  
 881      private void updateActionsForLargeLandscape(Menu menu) {
 882          if (mCurrentNote != null) {
 883              menu.findItem(R.id.menu_checklist).setVisible(true);
 884              menu.findItem(R.id.menu_delete).setVisible(true);
 885              menu.findItem(R.id.menu_history).setVisible(true);
 886              menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 887              menu.findItem(R.id.menu_share).setVisible(true);
 888              menu.findItem(R.id.menu_sidebar).setVisible(true);
 889              menu.findItem(R.id.menu_view_info).setVisible(true);
 890          } else {
 891              menu.findItem(R.id.menu_checklist).setVisible(false);
 892              menu.findItem(R.id.menu_delete).setVisible(false);
 893              menu.findItem(R.id.menu_history).setVisible(false);
 894              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 895              menu.findItem(R.id.menu_share).setVisible(false);
 896              menu.findItem(R.id.menu_sidebar).setVisible(false);
 897              menu.findItem(R.id.menu_view_info).setVisible(false);
 898          }
 899  
 900          menu.findItem(R.id.menu_empty_trash).setVisible(false);
 901      }
 902  
 903      public void updateViewsAfterTrashAction(Note note) {
 904          if (note == null || isFinishing()) {
 905              return;
 906          }
 907  
 908          if (note.isDeleted()) {
 909              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 910              deletedNoteIds.add(note.getSimperiumKey());
 911              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 912              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 913              AnalyticsTracker.track(
 914                      AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 915                      AnalyticsTracker.CATEGORY_NOTE,
 916                      &quot;overflow_menu&quot;
 917              );
 918          } else {
 919              AnalyticsTracker.track(
 920                      AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 921                      AnalyticsTracker.CATEGORY_NOTE,
 922                      &quot;overflow_menu&quot;
 923              );
 924          }
 925  
 926          // If we just deleted/restored the active note, show the placeholder
 927          if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 928              showDetailPlaceholder();
 929          }
 930  
 931          NoteListFragment fragment = getNoteListFragment();
 932          if (fragment != null) {
 933              fragment.getPrefs();
 934              fragment.refreshList();
 935          }
 936  
 937          invalidateOptionsMenu();
 938      }
 939  
 940      public void setMarkdownShowing(boolean isMarkdownShowing) {
 941          mIsShowingMarkdown = isMarkdownShowing;
 942          if (mNoteEditorFragment != null) {
 943              if (isMarkdownShowing) {
 944                  mNoteEditorFragment.showMarkdown();
 945              } else {
 946                  mNoteEditorFragment.hideMarkdown();
 947              }
 948          }
 949          invalidateOptionsMenu();
 950      }
 951  
 952      /**
 953       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 954       * the item with the given ID was selected. Used for tablets only.
 955       */
 956      @Override
<abbr title=" 957      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 957      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, booleaðŸ”µ</abbr>
 958          if (!DisplayUtils.isLargeScreenLandscape(this)) {
 959              // Launch the editor activity
 960              Bundle arguments = new Bundle();
 961              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 962              arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 963              arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 964  
 965              if (matchOffsets != null) {
 966                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 967              }
 968  
 969              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 970              editNoteIntent.putExtras(arguments);
 971              if (mNoteListFragment.isHidden()) {
 972                  editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 973              }
 974              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 975          } else {
 976              mNoteEditorFragment.setNote(noteID, matchOffsets);
 977              getNoteListFragment().setNoteSelected(noteID);
 978              setMarkdownShowing(isPreviewEnabled);
 979  
 980              if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 981                  mTabletSearchQuery = mSearchView.getQuery().toString();
 982              }
 983  
 984              mNoteEditorFragment.clearMarkdown();
 985  
 986              if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 987                  setMarkdownShowing(false);
 988              }
 989  
 990              invalidateOptionsMenu();
 991          }
 992  
 993          AnalyticsTracker.track(
 994                  AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 995                  AnalyticsTracker.CATEGORY_NOTE,
 996                  &quot;note_list_row_tap&quot;
 997          );
 998      }
 999  
1000      @Override
1001      public void onUserCreated(User user) {
1002          // New account created
1003          AnalyticsTracker.track(
1004                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
1005                  AnalyticsTracker.CATEGORY_USER,
1006                  &quot;account_created_from_login_activity&quot;
1007          );
1008      }
1009  
1010      public void onUserStatusChange(User.Status status) {
1011          switch (status) {
1012              // successfully used access token to connect to simperium bucket
1013              case AUTHORIZED:
1014                  runOnUiThread(new Runnable() {
1015                      @Override
1016                      public void run() {
1017                          if (!mNotesBucket.hasChangeVersion()) {
1018                              setToolbarProgressVisibility(true);
1019                          }
1020                      }
1021                  });
1022                  break;
1023  
1024              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
1025              case NOT_AUTHORIZED:
1026                  runOnUiThread(new Runnable() {
1027                      @Override
1028                      public void run() {
1029                          startLoginActivity(true);
1030                      }
1031                  });
1032                  break;
1033  
<abbr title="1034              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything">1034              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
1035              case UNKNOWN:
1036                  break;
1037          }
1038      }
1039  
1040      private void setToolbarProgressVisibility(boolean isVisible) {
1041          if (getSupportActionBar() != null) {
1042              getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1043          }
1044      }
1045  
1046      public void startLoginActivity(boolean signInFirst) {
1047          // Clear some account-specific prefs
1048          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
1049          editor.remove(PrefUtils.PREF_WP_TOKEN);
1050          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
1051          editor.apply();
1052  
1053          Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
1054          startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
1055      }
1056  
1057      @Override
1058      public void recreate() {
1059          Handler handler = new Handler();
1060          handler.post(new Runnable() {
1061              @Override
1062              public void run() {
1063                  NotesActivity.super.recreate();
1064              }
1065          });
1066      }
1067  
1068      @Override
1069      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1070          super.onActivityResult(requestCode, resultCode, data);
1071          switch (requestCode) {
1072              case Simplenote.INTENT_PREFERENCES:
<abbr title="1073                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1073                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
1074                  invalidateOptionsMenu();
1075                  NoteListFragment fragment = getNoteListFragment();
1076                  if (fragment != null) {
1077                      fragment.getPrefs();
1078                      fragment.refreshList();
1079                  }
1080  
1081                  break;
1082              case Simplenote.INTENT_EDIT_NOTE:
1083                  if (resultCode == RESULT_OK &amp;&amp; data != null) {
1084                      if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1085                          String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1086                          if (noteId != null) {
1087                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1088                              deletedNoteIds.add(noteId);
1089                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
1090                              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
1091                          }
<abbr title="1092                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1092                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTEðŸ”µ</abbr>
1093                          String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1094                          mNoteListFragment.setNoteSelected(selectedNoteId);
1095                          if (mNoteEditorFragment != null) {
1096                              mNoteEditorFragment.setNote(selectedNoteId);
1097                          }
1098                      }
1099                  }
1100                  break;
1101              case Simperium.SIGNUP_SIGNIN_REQUEST:
1102                  invalidateOptionsMenu();
1103  
1104                  Simplenote app = (Simplenote) getApplication();
1105                  AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1106                  CrashUtils.setCurrentUser(app.getSimperium().getUser());
1107  
1108                  AnalyticsTracker.track(
1109                          AnalyticsTracker.Stat.USER_SIGNED_IN,
1110                          AnalyticsTracker.CATEGORY_USER,
1111                          &quot;signed_in_from_login_activity&quot;
1112                  );
1113  
1114                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1115                      finish();
1116                  }
1117  
1118                  break;
1119          }
1120      }
1121  
1122      @Override
1123      public void onUndo() {
1124          if (mUndoBarController == null) return;
1125  
1126          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1127          if (deletedNoteIds != null) {
1128              for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1129                  Note deletedNote;
1130                  try {
1131                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1132                  } catch (BucketObjectMissingException e) {
1133                      return;
1134                  }
1135                  if (deletedNote != null) {
1136                      deletedNote.setDeleted(false);
1137                      deletedNote.setModificationDate(Calendar.getInstance());
1138                      deletedNote.save();
1139                      NoteListFragment fragment = getNoteListFragment();
1140                      if (fragment != null) {
1141                          fragment.getPrefs();
1142                          fragment.refreshList();
1143                      }
1144                  }
1145              }
1146          }
1147      }
1148  
1149      @Override
1150      protected void onPostCreate(Bundle savedInstanceState) {
1151          super.onPostCreate(savedInstanceState);
1152          // Sync the toggle state after onRestoreInstanceState has occurred.
1153          mDrawerToggle.syncState();
1154      }
1155  
1156      @Override
1157      public void onConfigurationChanged(@NonNull Configuration newConfig) {
1158          super.onConfigurationChanged(newConfig);
1159  
1160          mDrawerToggle.onConfigurationChanged(newConfig);
1161  
1162          if (DisplayUtils.isLargeScreen(this)) {
1163              mIsShowingMarkdown = false;
1164  
1165              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1166                  // Add the editor fragment
1167                  if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1168                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1168                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NðŸ”µ</abbr>
1169                  } else if (DisplayUtils.isLandscape(this)) {
1170                      addEditorFragment();
1171                  }
1172  
1173                  if (mNoteListFragment != null) {
1174                      mNoteListFragment.setActivateOnItemClick(true);
1175                      mNoteListFragment.setDividerVisible(true);
1176                  }
1177  
1178                  // Select the current note on a tablet
1179                  if (mCurrentNote != null) {
<abbr title="1180                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1180                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurðŸ”µ</abbr>
1181                  } else {
1182                      mNoteEditorFragment.setPlaceholderVisible(true);
1183                      mNoteListFragment.getListView().clearChoices();
1184                  }
1185  
1186                  invalidateOptionsMenu();
1187              // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait
1188              } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1189                  onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1189                  onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentðŸ”µ</abbr>
1190              }
1191          }
1192  
1193          if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1194              // Remove the editor fragment when rotating back to portrait
1195              mCurrentNote = null;
1196              if (mNoteListFragment != null) {
1197                  mNoteListFragment.setActivateOnItemClick(false);
1198                  mNoteListFragment.setDividerVisible(false);
1199                  mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1200                  mNoteListFragment.refreshList();
1201              }
1202              FragmentManager fm = getSupportFragmentManager();
1203              FragmentTransaction ft = fm.beginTransaction();
1204              ft.remove(mNoteEditorFragment);
1205              mNoteEditorFragment = null;
1206              ft.commitAllowingStateLoss();
1207              fm.executePendingTransactions();
1208              invalidateOptionsMenu();
1209          }
1210      }
1211  
1212      public void checkEmptyListText(boolean isSearch) {
1213          if (isSearch) {
<abbr title="1214              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1214              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1215              getNoteListFragment().setEmptyListViewClickable(false);
1216          } else if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
<abbr title="1217              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1217              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1218              AnalyticsTracker.track(
1219                      AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1220                      AnalyticsTracker.CATEGORY_NOTE,
1221                      &quot;trash_filter_selected&quot;
1222              );
1223              getNoteListFragment().setEmptyListViewClickable(false);
1224          } else {
<abbr title="1225              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1225              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
1226              getNoteListFragment().setEmptyListViewClickable(true);





























1227          }
1228      }
1229  
1230      public void showDetailPlaceholder() {
1231          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1232              mCurrentNote = null;
1233              mNoteEditorFragment.setPlaceholderVisible(true);
1234              mNoteEditorFragment.clearMarkdown();
1235              mNoteEditorFragment.hideMarkdown();
1236              mIsShowingMarkdown = false;
1237          }
1238      }
1239  
1240      public void stopListeningToNotesBucket() {
1241          mNotesBucket.removeOnNetworkChangeListener(this);
1242          mNotesBucket.removeOnSaveObjectListener(this);
1243          mNotesBucket.removeOnDeleteObjectListener(this);
1244      }
1245  
1246      // Returns the appropriate view to show the undo bar within
1247      private View getUndoView() {
1248          View undoView = mFragmentsContainer;
1249          if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1250                  getNoteListFragment() != null &amp;&amp;
1251                  getNoteListFragment().getRootView() != null) {
1252              undoView = getNoteListFragment().getRootView();
1253          }
1254  
1255          return undoView;
1256      }
1257  
1258      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1259          if (mUndoBarController != null) {
1260              mUndoBarController.setDeletedNoteIds(noteIds);
1261              mUndoBarController.showUndoBar(
1262                      getUndoView(),
1263                      getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())
1264              );
1265          }
1266      }
1267  
1268      /* Simperium Bucket Listeners */
1269      // received a change from the network, refresh the list
1270      @Override
1271      public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1272          runOnUiThread(new Runnable() {
1273              @Override
1274              public void run() {
1275                  if (type == Bucket.ChangeType.INDEX) {
1276                      setToolbarProgressVisibility(false);
1277                  }
1278                  mNoteListFragment.refreshList();
1279              }
1280          });
1281      }
1282  
1283      @Override
1284      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1285          runOnUiThread(new Runnable() {
1286              @Override
1287              public void run() {
1288                  mNoteListFragment.refreshList();
1289              }
1290          });
1291      }
1292  
1293      @Override
1294      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1295          runOnUiThread(new Runnable() {
1296              @Override
1297              public void run() {
1298                  mNoteListFragment.refreshList();
1299              }
1300          });
1301      }
1302  
1303      @Override
1304      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1305          // noop, NoteEditorFragment will handle this
1306      }
1307  
1308      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1309  
1310          @Override
1311          protected Void doInBackground(Void... voids) {
1312              if (mNotesBucket == null) return null;
1313  
1314              Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1315              Bucket.ObjectCursor c = query.execute();
1316              while (c.moveToNext()) {
1317                  c.getObject().delete();
1318              }
1319  
1320              return null;
1321          }
1322  
1323          @Override
1324          protected void onPostExecute(Void nada) {
1325              showDetailPlaceholder();
1326          }
1327      }
1328  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.content.DialogInterface;
   5  import android.content.Intent;
   6  import android.content.SharedPreferences;
   7  import android.content.res.ColorStateList;
   8  import android.content.res.Configuration;
   9  import android.os.AsyncTask;
  10  import android.os.Bundle;
  11  import android.os.Handler;
  12  import android.text.TextUtils;
  13  import android.view.Menu;
  14  import android.view.MenuInflater;
  15  import android.view.MenuItem;
  16  import android.view.View;
  17  import android.widget.LinearLayout;
  18  import android.widget.ListView;
  19  import android.widget.ProgressBar;
  20  
  21  import androidx.annotation.NonNull;
  22  import androidx.appcompat.app.ActionBar;
  23  import androidx.appcompat.app.ActionBarDrawerToggle;
  24  import androidx.appcompat.app.AlertDialog;
  25  import androidx.appcompat.app.AppCompatActivity;
  26  import androidx.appcompat.view.ContextThemeWrapper;
  27  import androidx.appcompat.widget.SearchView;
  28  import androidx.appcompat.widget.Toolbar;
  29  import androidx.core.view.GravityCompat;
  30  import androidx.drawerlayout.widget.DrawerLayout;
  31  import androidx.fragment.app.FragmentManager;
  32  import androidx.fragment.app.FragmentTransaction;
  33  import androidx.preference.PreferenceManager;
  34  
  35  import com.automattic.simplenote.analytics.AnalyticsTracker;
  36  import com.automattic.simplenote.models.Note;
  37  import com.automattic.simplenote.models.Tag;
  38  import com.automattic.simplenote.utils.CrashUtils;
  39  import com.automattic.simplenote.utils.DisplayUtils;
  40  import com.automattic.simplenote.utils.DrawableUtils;
  41  import com.automattic.simplenote.utils.HtmlCompat;
  42  import com.automattic.simplenote.utils.PrefUtils;
  43  import com.automattic.simplenote.utils.StrUtils;
  44  import com.automattic.simplenote.utils.TagsAdapter;
  45  import com.automattic.simplenote.utils.ThemeUtils;
  46  import com.automattic.simplenote.utils.UndoBarController;
  47  import com.google.android.material.navigation.NavigationView;
  48  import com.simperium.Simperium;
  49  import com.simperium.client.Bucket;
  50  import com.simperium.client.BucketObjectMissingException;
  51  import com.simperium.client.BucketObjectNameInvalid;
  52  import com.simperium.client.Query;
  53  import com.simperium.client.User;
  54  
  55  import org.wordpress.passcodelock.AppLockManager;
  56  
  57  import java.util.ArrayList;
  58  import java.util.Calendar;
  59  import java.util.HashMap;
  60  import java.util.List;
  61  import java.util.Map;
  62  
  63  import static com.automattic.simplenote.NoteListFragment.TAG_PREFIX;
  64  import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  65  import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  66  import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  67  import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  68  import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  69  import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  70  import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  71  import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  72  import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  73  import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  74  
  75  public class NotesActivity extends AppCompatActivity implements
<abbr title="  76          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  76          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  77          Bucket.Listener&lt;Note&gt; {
  78  
  79      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  80      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  81      protected Bucket&lt;Note&gt; mNotesBucket;
  82      protected Bucket&lt;Tag&gt; mTagsBucket;
  83      private boolean mIsShowingMarkdown;
  84      private boolean mShouldSelectNewNote;
  85      private boolean mIsSettingsClicked;
  86      private boolean mIsTabetFullscreen;
  87  
  88      private String mTabletSearchQuery;
  89      private UndoBarController mUndoBarController;
  90      private View mFragmentsContainer;
  91      private SearchView mSearchView;
  92      private MenuItem mSearchMenuItem;
  93      private NoteListFragment mNoteListFragment;
  94      private NoteEditorFragment mNoteEditorFragment;
  95      private Note mCurrentNote;
  96      private MenuItem mEmptyTrashMenuItem;
  97  
  98      // Menu drawer
  99      private static final int GROUP_PRIMARY = 100;
 100      private static final int GROUP_SECONDARY = 101;
 101      private static final int GROUP_TERTIARY = 102;
 102      private DrawerLayout mDrawerLayout;
 103      private Menu mNavigationMenu;
 104      private ActionBarDrawerToggle mDrawerToggle;
 105      private TagsAdapter mTagsAdapter;
 106      private TagsAdapter.TagMenuItem mSelectedTag;
 107      // Tags bucket listener
 108      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 109          void updateNavigationDrawer() {
 110              runOnUiThread(new Runnable() {
 111                  public void run() {
 112                      updateNavigationDrawerItems();
 113                  }
 114              });
 115          }
 116  
 117          @Override
 118          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 119              updateNavigationDrawer();
 120          }
 121  
 122          @Override
 123          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 124              updateNavigationDrawer();
 125          }
 126  
 127          @Override
 128          public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 129              updateNavigationDrawer();
 130          }
 131  
 132          @Override
 133          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 134              // noop
 135          }
 136      };
 137  
 138      @Override
 139      protected void onCreate(Bundle savedInstanceState) {
 140          ThemeUtils.setTheme(this);
 141          super.onCreate(savedInstanceState);
 142  
 143          setContentView(R.layout.activity_notes);
 144  
 145          mFragmentsContainer = findViewById(R.id.note_fragment_container);
 146  
 147          Simplenote currentApp = (Simplenote) getApplication();
 148          if (mNotesBucket == null) {
 149              mNotesBucket = currentApp.getNotesBucket();
 150          }
 151  
 152          if (mTagsBucket == null) {
 153              mTagsBucket = currentApp.getTagsBucket();
 154          }
 155  
 156          Toolbar toolbar = findViewById(R.id.toolbar);
 157          setSupportActionBar(toolbar);
 158          configureNavigationDrawer(toolbar);
 159  
 160          if (savedInstanceState == null) {
 161              mNoteListFragment = new NoteListFragment();
 162              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 163              fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 164              fragmentTransaction.commit();
 165          } else {
 166              mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 167          }
 168          mIsTabetFullscreen = mNoteListFragment.isHidden();
 169  
 170          if (DisplayUtils.isLargeScreen(this)) {
 171              if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 172                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 172                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_ðŸ”µ</abbr>
 173              } else if (DisplayUtils.isLandscape(this)) {
 174                  addEditorFragment();
 175              }
 176          }
 177  
 178          // enable ActionBar app icon to behave as action to toggle nav drawer
 179          ActionBar actionBar = getSupportActionBar();
 180          if (actionBar != null) {
 181              actionBar.setDisplayHomeAsUpEnabled(true);
 182              actionBar.setHomeButtonEnabled(true);
 183  
 184              // Add loading indicator to show when indexing
<abbr title=" 185              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 185              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, nullðŸ”µ</abbr>
 186              actionBar.setDisplayShowCustomEnabled(true);
 187              actionBar.setCustomView(progressBar);
 188              setToolbarProgressVisibility(false);
 189          }
 190  
 191          mUndoBarController = new UndoBarController(this);
 192  
 193          // Creates &#x27;Welcome&#x27; note
 194          checkForFirstLaunch();
 195  
 196          checkForSharedContent();
 197  
 198          currentApp.getSimperium().setOnUserCreatedListener(this);
 199          currentApp.getSimperium().setUserStatusChangeListener(this);
 200      }
 201  
 202      @Override
 203      protected void onResume() {
 204          super.onResume();
 205  
 206          // Ensure user has valid authorization
 207          if (userAuthenticationIsInvalid()) {
 208              startLoginActivity(true);
 209              Intent intent = getIntent();
 210  
 211              if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 212                      intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 213                  AnalyticsTracker.track(
 214                          NOTE_WIDGET_SIGN_IN_TAPPED,
 215                          CATEGORY_WIDGET,
 216                          &quot;note_widget_sign_in_tapped&quot;
 217                  );
 218              }
 219          }
 220  
 221          disableScreenshotsIfLocked(this);
 222  
 223          mNotesBucket.start();
 224          mTagsBucket.start();
 225  
 226          mNotesBucket.addOnNetworkChangeListener(this);
 227          mNotesBucket.addOnSaveObjectListener(this);
 228          mNotesBucket.addOnDeleteObjectListener(this);
 229          mTagsBucket.addListener(mTagsMenuUpdater);
 230  
 231          updateNavigationDrawerItems();
 232  
 233          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 234          if (userIsUnauthorized()) {
 235              if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 236                  mSelectedTag = null;
 237                  mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 238              }
 239          }
 240  
 241          filterListBySelectedTag();
 242  
 243          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 244              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 244              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNoteðŸ”µ</abbr>
 245              mShouldSelectNewNote = false;
 246          }
 247  
 248          if (mIsShowingMarkdown) {
 249              setMarkdownShowing(false);
 250          }
 251  
 252          FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 253          if(DisplayUtils.isLargeScreenLandscape(this)) {
 254              if (mIsTabetFullscreen) {
 255                  ft.hide(mNoteListFragment);
 256              } else {
 257                  ft.show(mNoteListFragment);
 258              }
 259          } else {
 260              ft.show(mNoteListFragment);
 261          }
 262          ft.commitNow();
 263      }
 264  
 265      @Override
 266      protected void onPause() {
 267          super.onPause();  // Always call the superclass method first
 268          mTagsBucket.removeListener(mTagsMenuUpdater);
 269          mTagsBucket.stop();
 270  
 271          mNotesBucket.removeOnNetworkChangeListener(this);
 272          mNotesBucket.removeOnSaveObjectListener(this);
 273          mNotesBucket.removeOnDeleteObjectListener(this);
 274          mNotesBucket.stop();
 275      }
 276  
 277      @Override
 278      public void setTitle(CharSequence title) {
 279          if (getSupportActionBar() != null) {
 280              getSupportActionBar().setTitle(title);
 281          }
 282      }
 283  
 284      @Override
 285      public void onBackPressed() {
 286          if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 287              mDrawerLayout.closeDrawer(GravityCompat.START);
 288          } else {
 289              super.onBackPressed();
 290          }
 291      }
 292  
 293      @Override
 294      public void onActionModeCreated() {
 295          mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 296      }
 297  
 298      @Override
 299      public void onActionModeDestroyed() {
 300          if (mSearchMenuItem != null &amp;&amp; !mSearchMenuItem.isActionViewExpanded()) {
 301              mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 302          }
 303      }
 304  
 305      private ColorStateList getIconSelector() {
 306          int[][] states = new int[][] {
 307                  new int[] { android.R.attr.state_checked}, // checked
 308                  new int[] {-android.R.attr.state_checked}  // unchecked
 309          };
 310  
 311          int[] colors = new int[] {
 312                  ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 313                  ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.toolbarIconColor)
 314          };
 315  
 316          return new ColorStateList(states, colors);
 317      }
 318  
 319      private ColorStateList getTextSelector() {
 320          int[][] states = new int[][] {
 321              new int[] {-android.R.attr.state_enabled}, // disabled
 322              new int[] { android.R.attr.state_checked}, // checked
 323              new int[] {-android.R.attr.state_checked}  // unchecked
 324          };
 325  
 326          int[] colors = new int[] {
 327              getResources().getColor(R.color.text_title_disabled, getTheme()),
 328              ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 329              ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)
 330          };
 331  
 332          return new ColorStateList(states, colors);
 333      }
 334  
 335      private void configureNavigationDrawer(Toolbar toolbar) {
 336          ColorStateList iconSelector = getIconSelector();
 337          ColorStateList textSelector = getTextSelector();
 338          mDrawerLayout = findViewById(R.id.drawer_layout);
 339          NavigationView navigationView = findViewById(R.id.navigation_view);
 340          navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 341          navigationView.setItemIconTintList(iconSelector);
 342          navigationView.setItemTextColor(textSelector);
 343          navigationView.setNavigationItemSelectedListener(
 344              new NavigationView.OnNavigationItemSelectedListener() {
 345                  @Override
 346                  public boolean onNavigationItemSelected(@NonNull MenuItem item) {
 347                      mDrawerLayout.closeDrawer(GravityCompat.START);
 348  
 349                      if (item.getItemId() == SETTINGS_ID) {
 350                          AnalyticsTracker.track(
 351                                  AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 352                                  AnalyticsTracker.CATEGORY_TAG,
 353                                  &quot;selected_tag_in_navigation_drawer&quot;,
 354                                  new HashMap&lt;String, String&gt;(1){{put(&quot;tag&quot;, &quot;settings&quot;);}}
 355                          );
 356                          mIsSettingsClicked = true;
 357                          return false;
 358                      } else {
 359                          mSelectedTag = mTagsAdapter.getTagFromItem(item);
 360                          filterListBySelectedTag();
 361                          return true;
 362                      }
 363                  }
 364              }
 365          );
 366  
 367          mNavigationMenu = navigationView.getMenu();
<abbr title=" 368          mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 368          mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawaðŸ”µ</abbr>
<abbr title=" 369          mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 369          mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_tðŸ”µ</abbr>
<abbr title=" 370          mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 370          mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawablðŸ”µ</abbr>
 371          mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 372  
 373          if (mSelectedTag == null)
 374              mSelectedTag = mTagsAdapter.getDefaultItem();
 375  
 376          mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 377                  R.string.close_drawer) {
 378              public void onDrawerClosed(View view) {
 379                  supportInvalidateOptionsMenu();
 380  
 381                  if (mIsSettingsClicked) {
 382                      Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 383                      startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 384                      mIsSettingsClicked = false;
 385                  }
 386              }
 387  
 388              public void onDrawerOpened(View drawerView) {
 389                  // noop
 390              }
 391  
 392              @Override
 393              public void onDrawerSlide(View drawerView, float slideOffset) {
 394                  super.onDrawerSlide(drawerView, 0f);
 395              }
 396          };
 397  
 398          mDrawerLayout.addDrawerListener(mDrawerToggle);
 399      }
 400  
 401      private void filterListBySelectedTag() {
 402          MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 403  
 404          if (selectedMenuItem != null) {
 405              mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 406          } else {
 407              mSelectedTag = mTagsAdapter.getDefaultItem();
 408          }
 409  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -        checkEmptyListText(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 411 +        checkEmptyListText(mSearchMenuItem != null &amp;&amp; mSearchMenuItem.isActionViewExpanded());</span>
 412  
 413          if (mNoteListFragment.isHidden()) {
 414              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 415              fragmentTransaction.show(mNoteListFragment);
 416              fragmentTransaction.commitNowAllowingStateLoss();
 417          }
 418  
 419          // Disable long press on notes when viewing Trash.
 420          if (mSelectedTag.id == TRASH_ID) {
 421              getNoteListFragment().getListView().setLongClickable(false);
 422          } else {
 423              getNoteListFragment().getListView().setLongClickable(true);
 424          }
 425  
 426          getNoteListFragment().refreshListFromNavSelect();
 427  
 428          Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 429  
 430          switch ((int) mSelectedTag.id) {
 431              case ALL_NOTES_ID:
 432                  properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 433                  break;
 434              case TRASH_ID:
 435                  properties.put(&quot;tag&quot;, &quot;trash&quot;);
 436                  break;
 437              case UNTAGGED_NOTES_ID:
 438                  properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 439                  break;
 440              default:
 441                  properties = null;
 442                  break;
 443          }
 444  
 445          AnalyticsTracker.track(
 446                  AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 447                  AnalyticsTracker.CATEGORY_TAG,
 448                  &quot;selected_tag_in_navigation_drawer&quot;,
 449                  properties
 450          );
 451  
 452          setSelectedTagActive();
 453      }
 454  
 455      private void checkForFirstLaunch() {
 456          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 457              // Create the welcome note
 458              try {
 459                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 460                  welcomeNote.setCreationDate(Calendar.getInstance());
 461                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 462                  welcomeNote.setContent(getString(R.string.welcome_note));
 463                  welcomeNote.getTitle();
 464                  welcomeNote.save();
 465              } catch (BucketObjectNameInvalid e) {
 466                  // this won&#x27;t happen because welcome-android is a valid name
 467              }
 468  
 469              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 470              SharedPreferences.Editor editor = preferences.edit();
 471              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 472              editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 473              editor.apply();
 474          }
 475      }
 476  
 477      private void checkForSharedContent() {
 478          if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 479              // Check share action
 480              Intent intent = getIntent();
 481              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 482              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 483  
 484              // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search
 485              String intentAction = StrUtils.notNullStr(intent.getAction());
 486              boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 487              if (!TextUtils.isEmpty(text)) {
 488                  if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 489                      text = subject + &quot;\n\n&quot; + text;
 490                  }
 491                  Note note = mNotesBucket.newObject();
 492                  note.setCreationDate(Calendar.getInstance());
 493                  note.setModificationDate(note.getCreationDate());
 494                  note.setContent(text);
 495                  note.save();
 496                  setCurrentNote(note);
 497                  mShouldSelectNewNote = true;
 498  
 499                  AnalyticsTracker.track(
 500                          AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 501                          AnalyticsTracker.CATEGORY_NOTE,
 502                          &quot;external_share&quot;
 503                  );
 504  
 505                  if (!DisplayUtils.isLargeScreenLandscape(this)) {
 506                      // Disable the lock screen when sharing content and opening NoteEditorActivity
 507                      // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 508                      if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 509                          AppLockManager.getInstance().getAppLock().setExemptActivities(
 510                                  new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 511                                          &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 512                          AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 513                      }
 514                  }
 515              }
 516          }
 517      }
 518  
 519      private void updateNavigationDrawerItems() {
 520          boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 521          Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 522          if (isAlphaSort) {
 523              tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 524          } else {
 525              tagCursor = Tag.allWithName(mTagsBucket).execute();
 526          }
 527  
 528          mTagsAdapter.changeCursor(tagCursor);
 529          mNavigationMenu.removeGroup(GROUP_SECONDARY);
 530          mNavigationMenu.removeGroup(GROUP_TERTIARY);
 531  
 532          if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 533              mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 533              mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layðŸ”µ</abbr>
 534  
 535              for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 536                  String name = mTagsAdapter.getItem(i).name;
 537                  int id = (int) mTagsAdapter.getItem(i).id;
 538  
 539                  if (id &gt;= 0) { // Custom tags have a positive ID.
 540                      mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 541                  }
 542              }
 543  
<abbr title=" 544              mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_untagged_24dp).setCheckable(true);"> 544              mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).ðŸ”µ</abbr>
 545              setSelectedTagActive();
 546          }
 547      }
 548  
 549      public void launchEditTags(View view) {
 550          startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 551      }
 552  
 553      private void setSelectedTagActive() {
 554          if (mSelectedTag == null) {
 555              mSelectedTag = mTagsAdapter.getDefaultItem();
 556          }
 557  
 558          MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 559  
 560          if (selectedMenuItem != null) {
 561              selectedMenuItem.setChecked(true);
 562          } else {
 563              mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 564          }
 565  
 566          setTitle(mSelectedTag.name);
 567      }
 568  
 569      public TagsAdapter.TagMenuItem getSelectedTag() {
 570          if (mSelectedTag == null) {
 571              mSelectedTag = mTagsAdapter.getDefaultItem();
 572          }
 573  
 574          return mSelectedTag;
 575      }
 576  
 577      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 578      public void updateTrashMenuItem() {
 579          if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 580              return;
 581  
 582          // Disable the trash icon if there are no notes trashed.
 583          Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 584          if (query.count() == 0) {
 585              mEmptyTrashMenuItem.setEnabled(false);
 586          } else {
 587              mEmptyTrashMenuItem.setEnabled(true);
 588          }
 589      }
 590  
 591      private void addEditorFragment() {
 592          FragmentManager fm = getSupportFragmentManager();
 593          FragmentTransaction ft = fm.beginTransaction();
 594          mNoteEditorFragment = new NoteEditorFragment();
 595          ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 596          ft.commitAllowingStateLoss();
 597          fm.executePendingTransactions();
 598      }
 599  
 600      private boolean userAccountRequired() {
 601          return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 602      }
 603  
 604      /**
 605       * Checks for a previously valid user that is now not authenticated
 606       * Also checks if user account is required (added in version 1.5.6)
 607       *
 608       * @return true if user has invalid authorization
 609       */
 610      private boolean userAuthenticationIsInvalid() {
 611          Simplenote currentApp = (Simplenote) getApplication();
 612          Simperium simperium = currentApp.getSimperium();
 613          User user = simperium.getUser();
 614          boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 615          return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 616                  (userAccountRequired() &amp;&amp; isNotAuthorized);
 617      }
 618  
 619      public boolean userIsUnauthorized() {
 620          Simplenote currentApp = (Simplenote) getApplication();
 621          return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 622      }
 623  
 624      public void setCurrentNote(Note note) {
 625          mCurrentNote = note;
 626      }
 627  
 628      public NoteListFragment getNoteListFragment() {
 629          return mNoteListFragment;
 630      }
 631  
 632      @Override
 633      public boolean onCreateOptionsMenu(final Menu menu) {
 634          super.onCreateOptionsMenu(menu);
 635          MenuInflater inflater = getMenuInflater();
 636          inflater.inflate(R.menu.notes_list, menu);
 637  
 638          // restore the search query if on a landscape tablet
 639          String searchQuery = null;
 640          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 641              searchQuery = mSearchView.getQuery().toString();
 642  
 643          mSearchMenuItem = menu.findItem(R.id.menu_search);
 644          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 645          LinearLayout searchEditFrame = mSearchView.findViewById(R.id.search_edit_frame);
 646          ((LinearLayout.LayoutParams) searchEditFrame.getLayoutParams()).leftMargin = 0;
 647  
 648          if (!TextUtils.isEmpty(searchQuery)) {
 649              mSearchView.setQuery(searchQuery, false);
 650              mSearchMenuItem.expandActionView();
 651          } else {
 652              // Workaround for setting the search placeholder text color
 653              @SuppressWarnings(&quot;ResourceType&quot;)
 654              String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
 655              mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 656                      hintHexColor,
 657                      getString(R.string.search))));
 658          }
 659  
 660          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 661              @Override
 662              public boolean onQueryTextChange(String newText) {
 663                  if (mSearchMenuItem.isActionViewExpanded()) {
 664                      getNoteListFragment().searchNotes(newText, false);
 665                  }
 666  
 667                  return true;
 668              }
 669  
 670              @Override
 671              public boolean onQueryTextSubmit(String queryText) {
 672                  getNoteListFragment().searchNotes(queryText, true);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 673 +                checkEmptyListText(true);</span>
 674                  return true;
 675              }
 676          });
 677  
 678          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 679              @Override
 680              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 681                  mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 682                  getNoteListFragment().searchNotes(&quot;&quot;, false);
 683  
 684                  if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 685                      updateActionsForLargeLandscape(menu);
 686                  }
 687  
 688                  checkEmptyListText(true);
 689  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 690 +                // Hide floating action button and list bottom padding.</span>
 691                  if (mNoteListFragment != null) {
 692                      mNoteListFragment.setFloatingActionButtonVisible(false);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 693 +                    mNoteListFragment.showListPadding(false);</span>
 694                  }
 695  
 696                  AnalyticsTracker.track(
 697                          AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 698                          AnalyticsTracker.CATEGORY_NOTE,
 699                          &quot;action_bar_search_tap&quot;
 700                  );
 701                  return true;
 702              }
 703  
 704              @Override
 705              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 706                  mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 707  
 708                  if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 709                      updateActionsForLargeLandscape(menu);
 710                  }
 711  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 712 -                // Show all notes again</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 713 +                // Show floating action button and list bottom padding.</span>
 714                  if (mNoteListFragment != null) {
 715                      mNoteListFragment.setFloatingActionButtonVisible(true);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 716 +                    mNoteListFragment.showListPadding(true);</span>
 717                  }
 718  
 719                  mTabletSearchQuery = &quot;&quot;;
 720                  mSearchView.setQuery(&quot;&quot;, false);
 721                  checkEmptyListText(false);
 722                  getNoteListFragment().clearSearch();
 723                  return true;
 724              }
 725          });
 726  
 727          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 728              @Override
 729              public boolean onMenuItemClick(MenuItem item) {
 730                  if (!mSearchMenuItem.isActionViewExpanded())
 731                      showDetailPlaceholder();
 732                  return false;
 733              }
 734          });
 735  
 736          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 737          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 738              trashItem.setTitle(R.string.undelete);
 739              trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 740          } else {
 741              trashItem.setTitle(R.string.delete);
 742              trashItem.setIcon(R.drawable.ic_trash_24dp);
 743          }
 744  
 745          if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 746              // Restore the search query on landscape tablets
 747              if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 748                  mSearchMenuItem.expandActionView();
 749                  mSearchView.setQuery(mTabletSearchQuery, false);
 750                  mSearchView.clearFocus();
 751              }
 752  
 753              updateActionsForLargeLandscape(menu);
 754          } else {
 755              menu.findItem(R.id.menu_search).setVisible(true);
 756              menu.findItem(R.id.menu_share).setVisible(false);
 757              menu.findItem(R.id.menu_view_info).setVisible(false);
 758              menu.findItem(R.id.menu_checklist).setVisible(false);
 759              menu.findItem(R.id.menu_history).setVisible(false);
 760              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 761              menu.findItem(R.id.menu_sidebar).setVisible(false);
 762              trashItem.setVisible(false);
 763              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 764          }
 765  
 766          if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
 767              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 768              mEmptyTrashMenuItem.setVisible(true);
 769  
 770              updateTrashMenuItem();
 771  
 772              menu.findItem(R.id.menu_search).setVisible(false);
 773              menu.findItem(R.id.menu_share).setVisible(false);
 774              menu.findItem(R.id.menu_history).setVisible(false);
 775              menu.findItem(R.id.menu_checklist).setVisible(false);
 776          }
 777  
 778          DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.toolbarIconColor);
 779  
 780          return true;
 781      }
 782  
 783      @Override
 784      public boolean onOptionsItemSelected(MenuItem item) {
 785          if (mDrawerToggle.onOptionsItemSelected(item)) {
 786              return true;
 787          }
 788          switch (item.getItemId()) {
 789              case R.id.menu_sidebar:
 790                  FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 791                  if (mNoteListFragment.isHidden()) {
 792                      ft.show(mNoteListFragment);
 793                  } else {
 794                      ft.hide(mNoteListFragment);
 795                  }
 796                  ft.commitNowAllowingStateLoss();
 797                  mIsTabetFullscreen = mNoteListFragment.isHidden();
 798                  return true;
 799              case R.id.menu_markdown_preview:
 800                  if (mIsShowingMarkdown) {
 801                      item.setIcon(R.drawable.ic_visibility_on_24dp);
 802                      item.setTitle(getString(R.string.markdown_show));
 803                      setMarkdownShowing(false);
 804                      mCurrentNote.setPreviewEnabled(false);
 805                  } else {
 806                      item.setIcon(R.drawable.ic_visibility_off_24dp);
 807                      item.setTitle(getString(R.string.markdown_hide));
 808                      setMarkdownShowing(true);
 809                      mCurrentNote.setPreviewEnabled(true);
 810                  }
 811  
 812                  mCurrentNote.save();
 813                  DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.toolbarIconColor);
 814  
 815                  return true;
 816              case R.id.menu_delete:
 817                  if (mNoteEditorFragment != null) {
 818                      if (mCurrentNote != null) {
 819                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 820                          mCurrentNote.setModificationDate(Calendar.getInstance());
 821                          mCurrentNote.save();
 822  
 823                          updateViewsAfterTrashAction(mCurrentNote);
 824                      }
 825                  }
 826                  return true;
 827              case R.id.menu_empty_trash:
<abbr title=" 828                  AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.style.Dialog));"> 828                  AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.style.Dialog))ðŸ”µ</abbr>
 829  
 830                  alert.setTitle(R.string.empty_trash);
 831                  alert.setMessage(R.string.confirm_empty_trash);
 832                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 833                      public void onClick(DialogInterface dialog, int whichButton) {
 834                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 835                          AnalyticsTracker.track(
 836                                  AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 837                                  AnalyticsTracker.CATEGORY_NOTE,
 838                                  &quot;overflow_menu&quot;
 839                          );
 840                      }
 841                  });
 842                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 843                      public void onClick(DialogInterface dialog, int whichButton) {
 844                          // Do nothing, just closing the dialog
 845                      }
 846                  });
 847                  alert.show();
 848                  return true;
 849              case android.R.id.home:
 850                  invalidateOptionsMenu();
 851                  return true;
 852              default:
 853                  return super.onOptionsItemSelected(item);
 854          }
 855      }
 856  
 857      @Override
 858      public boolean onPrepareOptionsMenu(Menu menu) {
 859          MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 860  
 861          if (mIsShowingMarkdown) {
 862              markdownItem.setIcon(R.drawable.ic_visibility_off_24dp);
 863              markdownItem.setTitle(getString(R.string.markdown_hide));
 864          } else {
 865              markdownItem.setIcon(R.drawable.ic_visibility_on_24dp);
 866              markdownItem.setTitle(getString(R.string.markdown_show));
 867          }
 868  
 869          DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.toolbarIconColor);
 870  
 871          return super.onPrepareOptionsMenu(menu);
 872      }
 873  
 874      public void submitSearch(String selection) {
 875          if (mSearchView != null) {
 876              String query = mSearchView.getQuery().toString();
 877  
 878              if (query.endsWith(TAG_PREFIX)) {
 879                  mSearchView.setQuery(query.substring(0, query.lastIndexOf(TAG_PREFIX)) + selection, true);
 880              } else {
 881                  mSearchView.setQuery(selection, true);
 882              }
 883          }
 884      }
 885  
 886      private void updateActionsForLargeLandscape(Menu menu) {
 887          if (mCurrentNote != null) {
 888              menu.findItem(R.id.menu_checklist).setVisible(true);
 889              menu.findItem(R.id.menu_delete).setVisible(true);
 890              menu.findItem(R.id.menu_history).setVisible(true);
 891              menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 892              menu.findItem(R.id.menu_share).setVisible(true);
 893              menu.findItem(R.id.menu_sidebar).setVisible(true);
 894              menu.findItem(R.id.menu_view_info).setVisible(true);
 895          } else {
 896              menu.findItem(R.id.menu_checklist).setVisible(false);
 897              menu.findItem(R.id.menu_delete).setVisible(false);
 898              menu.findItem(R.id.menu_history).setVisible(false);
 899              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 900              menu.findItem(R.id.menu_share).setVisible(false);
 901              menu.findItem(R.id.menu_sidebar).setVisible(false);
 902              menu.findItem(R.id.menu_view_info).setVisible(false);
 903          }
 904  
 905          menu.findItem(R.id.menu_empty_trash).setVisible(false);
 906      }
 907  
 908      public void updateViewsAfterTrashAction(Note note) {
 909          if (note == null || isFinishing()) {
 910              return;
 911          }
 912  
 913          if (note.isDeleted()) {
 914              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 915              deletedNoteIds.add(note.getSimperiumKey());
 916              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 917              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 918              AnalyticsTracker.track(
 919                      AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 920                      AnalyticsTracker.CATEGORY_NOTE,
 921                      &quot;overflow_menu&quot;
 922              );
 923          } else {
 924              AnalyticsTracker.track(
 925                      AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 926                      AnalyticsTracker.CATEGORY_NOTE,
 927                      &quot;overflow_menu&quot;
 928              );
 929          }
 930  
 931          // If we just deleted/restored the active note, show the placeholder
 932          if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 933              showDetailPlaceholder();
 934          }
 935  
 936          NoteListFragment fragment = getNoteListFragment();
 937          if (fragment != null) {
 938              fragment.getPrefs();
 939              fragment.refreshList();
 940          }
 941  
 942          invalidateOptionsMenu();
 943      }
 944  
 945      public void setMarkdownShowing(boolean isMarkdownShowing) {
 946          mIsShowingMarkdown = isMarkdownShowing;
 947          if (mNoteEditorFragment != null) {
 948              if (isMarkdownShowing) {
 949                  mNoteEditorFragment.showMarkdown();
 950              } else {
 951                  mNoteEditorFragment.hideMarkdown();
 952              }
 953          }
 954          invalidateOptionsMenu();
 955      }
 956  
 957      /**
 958       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 959       * the item with the given ID was selected. Used for tablets only.
 960       */
 961      @Override
<abbr title=" 962      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 962      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, booleaðŸ”µ</abbr>
 963          if (!DisplayUtils.isLargeScreenLandscape(this)) {
 964              // Launch the editor activity
 965              Bundle arguments = new Bundle();
 966              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 967              arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 968              arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 969  
 970              if (matchOffsets != null) {
 971                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 972              }
 973  
 974              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 975              editNoteIntent.putExtras(arguments);
 976              if (mNoteListFragment.isHidden()) {
 977                  editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 978              }
 979              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 980          } else {
 981              mNoteEditorFragment.setNote(noteID, matchOffsets);
 982              getNoteListFragment().setNoteSelected(noteID);
 983              setMarkdownShowing(isPreviewEnabled);
 984  
 985              if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 986                  mTabletSearchQuery = mSearchView.getQuery().toString();
 987              }
 988  
 989              mNoteEditorFragment.clearMarkdown();
 990  
 991              if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 992                  setMarkdownShowing(false);
 993              }
 994  
 995              invalidateOptionsMenu();
 996          }
 997  
 998          AnalyticsTracker.track(
 999                  AnalyticsTracker.Stat.LIST_NOTE_OPENED,
1000                  AnalyticsTracker.CATEGORY_NOTE,
1001                  &quot;note_list_row_tap&quot;
1002          );
1003      }
1004  
1005      @Override
1006      public void onUserCreated(User user) {
1007          // New account created
1008          AnalyticsTracker.track(
1009                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
1010                  AnalyticsTracker.CATEGORY_USER,
1011                  &quot;account_created_from_login_activity&quot;
1012          );
1013      }
1014  
1015      public void onUserStatusChange(User.Status status) {
1016          switch (status) {
1017              // successfully used access token to connect to simperium bucket
1018              case AUTHORIZED:
1019                  runOnUiThread(new Runnable() {
1020                      @Override
1021                      public void run() {
1022                          if (!mNotesBucket.hasChangeVersion()) {
1023                              setToolbarProgressVisibility(true);
1024                          }
1025                      }
1026                  });
1027                  break;
1028  
1029              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
1030              case NOT_AUTHORIZED:
1031                  runOnUiThread(new Runnable() {
1032                      @Override
1033                      public void run() {
1034                          startLoginActivity(true);
1035                      }
1036                  });
1037                  break;
1038  
<abbr title="1039              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything">1039              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
1040              case UNKNOWN:
1041                  break;
1042          }
1043      }
1044  
1045      private void setToolbarProgressVisibility(boolean isVisible) {
1046          if (getSupportActionBar() != null) {
1047              getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1048          }
1049      }
1050  
1051      public void startLoginActivity(boolean signInFirst) {
1052          // Clear some account-specific prefs
1053          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
1054          editor.remove(PrefUtils.PREF_WP_TOKEN);
1055          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
1056          editor.apply();
1057  
1058          Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
1059          startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
1060      }
1061  
1062      @Override
1063      public void recreate() {
1064          Handler handler = new Handler();
1065          handler.post(new Runnable() {
1066              @Override
1067              public void run() {
1068                  NotesActivity.super.recreate();
1069              }
1070          });
1071      }
1072  
1073      @Override
1074      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1075          super.onActivityResult(requestCode, resultCode, data);
1076          switch (requestCode) {
1077              case Simplenote.INTENT_PREFERENCES:
<abbr title="1078                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1078                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
1079                  invalidateOptionsMenu();
1080                  NoteListFragment fragment = getNoteListFragment();
1081                  if (fragment != null) {
1082                      fragment.getPrefs();
1083                      fragment.refreshList();
1084                  }
1085  
1086                  break;
1087              case Simplenote.INTENT_EDIT_NOTE:
1088                  if (resultCode == RESULT_OK &amp;&amp; data != null) {
1089                      if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1090                          String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1091                          if (noteId != null) {
1092                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1093                              deletedNoteIds.add(noteId);
1094                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
1095                              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
1096                          }
<abbr title="1097                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1097                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTEðŸ”µ</abbr>
1098                          String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1099                          mNoteListFragment.setNoteSelected(selectedNoteId);
1100                          if (mNoteEditorFragment != null) {
1101                              mNoteEditorFragment.setNote(selectedNoteId);
1102                          }
1103                      }
1104                  }
1105                  break;
1106              case Simperium.SIGNUP_SIGNIN_REQUEST:
1107                  invalidateOptionsMenu();
1108  
1109                  Simplenote app = (Simplenote) getApplication();
1110                  AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1111                  CrashUtils.setCurrentUser(app.getSimperium().getUser());
1112  
1113                  AnalyticsTracker.track(
1114                          AnalyticsTracker.Stat.USER_SIGNED_IN,
1115                          AnalyticsTracker.CATEGORY_USER,
1116                          &quot;signed_in_from_login_activity&quot;
1117                  );
1118  
1119                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1120                      finish();
1121                  }
1122  
1123                  break;
1124          }
1125      }
1126  
1127      @Override
1128      public void onUndo() {
1129          if (mUndoBarController == null) return;
1130  
1131          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1132          if (deletedNoteIds != null) {
1133              for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1134                  Note deletedNote;
1135                  try {
1136                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1137                  } catch (BucketObjectMissingException e) {
1138                      return;
1139                  }
1140                  if (deletedNote != null) {
1141                      deletedNote.setDeleted(false);
1142                      deletedNote.setModificationDate(Calendar.getInstance());
1143                      deletedNote.save();
1144                      NoteListFragment fragment = getNoteListFragment();
1145                      if (fragment != null) {
1146                          fragment.getPrefs();
1147                          fragment.refreshList();
1148                      }
1149                  }
1150              }
1151          }
1152      }
1153  
1154      @Override
1155      protected void onPostCreate(Bundle savedInstanceState) {
1156          super.onPostCreate(savedInstanceState);
1157          // Sync the toggle state after onRestoreInstanceState has occurred.
1158          mDrawerToggle.syncState();
1159      }
1160  
1161      @Override
1162      public void onConfigurationChanged(@NonNull Configuration newConfig) {
1163          super.onConfigurationChanged(newConfig);
1164  
1165          mDrawerToggle.onConfigurationChanged(newConfig);
1166  
1167          if (DisplayUtils.isLargeScreen(this)) {
1168              mIsShowingMarkdown = false;
1169  
1170              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1171                  // Add the editor fragment
1172                  if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1173                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1173                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NðŸ”µ</abbr>
1174                  } else if (DisplayUtils.isLandscape(this)) {
1175                      addEditorFragment();
1176                  }
1177  
1178                  if (mNoteListFragment != null) {
1179                      mNoteListFragment.setActivateOnItemClick(true);
1180                      mNoteListFragment.setDividerVisible(true);
1181                  }
1182  
1183                  // Select the current note on a tablet
1184                  if (mCurrentNote != null) {
<abbr title="1185                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1185                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurðŸ”µ</abbr>
1186                  } else {
1187                      mNoteEditorFragment.setPlaceholderVisible(true);
1188                      mNoteListFragment.getListView().clearChoices();
1189                  }
1190  
1191                  invalidateOptionsMenu();
1192              // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait
1193              } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1194                  onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1194                  onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentðŸ”µ</abbr>
1195              }
1196          }
1197  
1198          if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1199              // Remove the editor fragment when rotating back to portrait
1200              mCurrentNote = null;
1201              if (mNoteListFragment != null) {
1202                  mNoteListFragment.setActivateOnItemClick(false);
1203                  mNoteListFragment.setDividerVisible(false);
1204                  mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1205                  mNoteListFragment.refreshList();
1206              }
1207              FragmentManager fm = getSupportFragmentManager();
1208              FragmentTransaction ft = fm.beginTransaction();
1209              ft.remove(mNoteEditorFragment);
1210              mNoteEditorFragment = null;
1211              ft.commitAllowingStateLoss();
1212              fm.executePendingTransactions();
1213              invalidateOptionsMenu();
1214          }
1215      }
1216  
1217      public void checkEmptyListText(boolean isSearch) {
1218          if (isSearch) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1219 -            getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1219 -            getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1220 -            getNoteListFragment().setEmptyListViewClickable(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1221 -        } else if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1222 -            getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1222 -            getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1223 -            AnalyticsTracker.track(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1224 -                    AnalyticsTracker.Stat.LIST_TRASH_VIEWED,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1225 -                    AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1226 -                    &quot;trash_filter_selected&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1227 -            );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1228 -            getNoteListFragment().setEmptyListViewClickable(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1229 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1230 -            getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1230 -            getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1231 -            getNoteListFragment().setEmptyListViewClickable(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1232 +            if (DisplayUtils.isLandscape(this) &amp;&amp; !DisplayUtils.isLargeScreen(this)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1233 +                getNoteListFragment().setEmptyListImage(-1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1234 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1235 +                getNoteListFragment().setEmptyListImage(R.drawable.ic_search_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1236 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1237 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1238 +            getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_search));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1239 +        } else if (mSelectedTag != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1240 +            if (mSelectedTag.id == ALL_NOTES_ID) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1241 +                getNoteListFragment().setEmptyListImage(R.drawable.ic_notes_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1242 +                getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_all));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1243 +            } else if (mSelectedTag.id == TRASH_ID) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1244 +                getNoteListFragment().setEmptyListImage(R.drawable.ic_trash_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1245 +                getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_trash));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1246 +                AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1247 +                        AnalyticsTracker.Stat.LIST_TRASH_VIEWED,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1248 +                        AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1249 +                        &quot;trash_filter_selected&quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1250 +                );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1251 +            } else if (mSelectedTag.id == UNTAGGED_NOTES_ID) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1252 +                getNoteListFragment().setEmptyListImage(R.drawable.ic_untagged_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1253 +                getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_untagged));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1254 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1255 +                getNoteListFragment().setEmptyListImage(R.drawable.ic_tag_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1256 +                getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_tag, mSelectedTag.name));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1257 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1258 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1259 +            getNoteListFragment().setEmptyListImage(R.drawable.ic_notes_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1260 +            getNoteListFragment().setEmptyListMessage(getString(R.string.empty_notes_all));</span>
1261          }
1262      }
1263  
1264      public void showDetailPlaceholder() {
1265          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1266              mCurrentNote = null;
1267              mNoteEditorFragment.setPlaceholderVisible(true);
1268              mNoteEditorFragment.clearMarkdown();
1269              mNoteEditorFragment.hideMarkdown();
1270              mIsShowingMarkdown = false;
1271          }
1272      }
1273  
1274      public void stopListeningToNotesBucket() {
1275          mNotesBucket.removeOnNetworkChangeListener(this);
1276          mNotesBucket.removeOnSaveObjectListener(this);
1277          mNotesBucket.removeOnDeleteObjectListener(this);
1278      }
1279  
1280      // Returns the appropriate view to show the undo bar within
1281      private View getUndoView() {
1282          View undoView = mFragmentsContainer;
1283          if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1284                  getNoteListFragment() != null &amp;&amp;
1285                  getNoteListFragment().getRootView() != null) {
1286              undoView = getNoteListFragment().getRootView();
1287          }
1288  
1289          return undoView;
1290      }
1291  
1292      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1293          if (mUndoBarController != null) {
1294              mUndoBarController.setDeletedNoteIds(noteIds);
1295              mUndoBarController.showUndoBar(
1296                      getUndoView(),
1297                      getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())
1298              );
1299          }
1300      }
1301  
1302      /* Simperium Bucket Listeners */
1303      // received a change from the network, refresh the list
1304      @Override
1305      public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1306          runOnUiThread(new Runnable() {
1307              @Override
1308              public void run() {
1309                  if (type == Bucket.ChangeType.INDEX) {
1310                      setToolbarProgressVisibility(false);
1311                  }
1312                  mNoteListFragment.refreshList();
1313              }
1314          });
1315      }
1316  
1317      @Override
1318      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1319          runOnUiThread(new Runnable() {
1320              @Override
1321              public void run() {
1322                  mNoteListFragment.refreshList();
1323              }
1324          });
1325      }
1326  
1327      @Override
1328      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1329          runOnUiThread(new Runnable() {
1330              @Override
1331              public void run() {
1332                  mNoteListFragment.refreshList();
1333              }
1334          });
1335      }
1336  
1337      @Override
1338      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1339          // noop, NoteEditorFragment will handle this
1340      }
1341  
1342      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1343  
1344          @Override
1345          protected Void doInBackground(Void... voids) {
1346              if (mNotesBucket == null) return null;
1347  
1348              Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1349              Bucket.ObjectCursor c = query.execute();
1350              while (c.moveToNext()) {
1351                  c.getObject().delete();
1352              }
1353  
1354              return null;
1355          }
1356  
1357          @Override
1358          protected void onPostExecute(Void nada) {
1359              showDetailPlaceholder();
1360          }
1361      }
1362  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            