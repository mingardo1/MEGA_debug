<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>235</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    235
                    <a href="234.html">prev</a>
                    <a href="236.html">next</a>
                    <a href="235_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_c29ab4ee6aa55818cc9b7e054fd7b105ce8f8f04_admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/admin/server/handler/StructuredContentTypeCustomPersistenceHandler.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c29ab4ee6aa55818cc9b7e054fd7b105ce8f8f04:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/admin/server/handler/StructuredContentTypeCustomPersistenceHandler.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c29ab4ee6aa55818cc9b7e054fd7b105ce8f8f04^1:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/admin/server/handler/StructuredContentTypeCustomPersistenceHandler.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c29ab4ee6aa55818cc9b7e054fd7b105ce8f8f04^2:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/admin/server/handler/StructuredContentTypeCustomPersistenceHandler.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;fbb881292e5e7b9b6509812938532600ac7bb32e:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/admin/server/handler/StructuredContentTypeCustomPersistenceHandler.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce CMS Module
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.cms.admin.server.handler;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.MapUtils;
  22 import org.apache.commons.logging.Log;
  23 import org.apache.commons.logging.LogFactory;
  24 import org.broadleafcommerce.cms.field.domain.FieldDefinition;
  25 import org.broadleafcommerce.cms.field.domain.FieldGroup;
  26 import org.broadleafcommerce.cms.structure.domain.StructuredContent;
  27 import org.broadleafcommerce.cms.structure.domain.StructuredContentField;
  28 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldImpl;
  29 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXref;
  30 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXrefImpl;
  31 import org.broadleafcommerce.cms.structure.domain.StructuredContentType;
  32 import org.broadleafcommerce.cms.structure.domain.StructuredContentTypeImpl;
  33 import org.broadleafcommerce.cms.structure.service.StructuredContentService;
  34 import org.broadleafcommerce.common.exception.ServiceException;
  35 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  36 import org.broadleafcommerce.openadmin.dto.ClassTree;
  37 import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  38 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  39 import org.broadleafcommerce.openadmin.dto.Entity;
  40 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  41 import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  42 import org.broadleafcommerce.openadmin.dto.Property;
  43 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  44 import org.broadleafcommerce.openadmin.server.service.ValidationException;
  45 import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  46 import org.broadleafcommerce.openadmin.server.service.handler.DynamicEntityRetriever;
  47 import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  48 import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  49 import org.springframework.stereotype.Component;
  50 
  51 import java.io.Serializable;
  52 import java.util.ArrayList;
  53 import java.util.Collections;
  54 import java.util.HashMap;
  55 import java.util.List;
  56 import java.util.Map;
  57 import java.util.Map.Entry;
  58 
  59 import javax.annotation.Resource;
  60 import javax.persistence.EntityManager;
  61 import javax.persistence.PersistenceContext;
  62 
  63 /**
  64  * Created by jfischer
  65  */
  66 @Component(&quot;blStructuredContentTypeCustomPersistenceHandler&quot;)
<abbr title="  67 public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implements DynamicEntityRetriever {">  67 public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implemðŸ”µ</abbr>
  68 
  69     private final Log LOG = LogFactory.getLog(StructuredContentTypeCustomPersistenceHandler.class);
  70 
  71     @Resource(name=&quot;blStructuredContentService&quot;)
  72     protected StructuredContentService structuredContentService;
  73 
  74     @Resource(name = &quot;blDynamicFieldPersistenceHandlerHelper&quot;)
  75     protected DynamicFieldPersistenceHandlerHelper dynamicFieldUtil;
  76 
  77     @PersistenceContext(unitName=&quot;blPU&quot;)
  78     protected EntityManager em;
  79 
  80     @Override
  81     public Boolean canHandleFetch(PersistencePackage persistencePackage) {
<abbr title="  82         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();">  82         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
  83         return
  84             StructuredContentType.class.getName().equals(ceilingEntityFullyQualifiedClassname) &amp;&amp;
  85             persistencePackage.getCustomCriteria() != null &amp;&amp;
  86             persistencePackage.getCustomCriteria().length &gt; 0 &amp;&amp;
  87             persistencePackage.getCustomCriteria()[0].equals(&quot;constructForm&quot;);
  88     }
  89 
  90     @Override
  91     public Boolean canHandleAdd(PersistencePackage persistencePackage) {
  92         return canHandleFetch(persistencePackage);
  93     }
  94 
  95     @Override
  96     public Boolean canHandleInspect(PersistencePackage persistencePackage) {
  97         return canHandleFetch(persistencePackage);
  98     }
  99 
 100     @Override
 101     public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 102         return false;
 103     }
 104 
 105     @Override
 106     public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 107         return canHandleFetch(persistencePackage);
 108     }
 109 
 110     @Override
<abbr title=" 111     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 111     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityðŸ”µ</abbr>
<abbr title=" 112         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 112         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 113         try {
 114             String structuredContentTypeId = persistencePackage.getCustomCriteria()[3];
<abbr title=" 115             StructuredContentType structuredContentType = structuredContentService.findStructuredContentTypeById(Long.valueOf(structuredContentTypeId));"> 115             StructuredContentType structuredContentType = structuredContentService.findStructuredContentTðŸ”µ</abbr>
 116             ClassMetadata metadata = new ClassMetadata();
 117             metadata.setCeilingType(StructuredContentType.class.getName());
 118             ClassTree entities = new ClassTree(StructuredContentTypeImpl.class.getName());
 119             metadata.setPolymorphicEntities(entities);
<abbr title=" 120             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentTypeImpl.class);"> 120             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStðŸ”µ</abbr>
 121             metadata.setProperties(properties);
 122             DynamicResultSet results = new DynamicResultSet(metadata);
 123 
 124             return results;
 125         } catch (Exception e) {
<abbr title=" 126             throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 126             throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiðŸ”µ</abbr>
 127         }
 128     }
 129 
 130 
 131     @Override
<abbr title=" 132     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 132     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynaðŸ”µ</abbr>
<abbr title=" 133         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 133         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 134         try {
 135             String structuredContentId = persistencePackage.getCustomCriteria()[1];
 136             Entity entity = fetchEntityBasedOnId(structuredContentId, null);
 137             DynamicResultSet results = new DynamicResultSet(new Entity[]{entity}, 1);
 138 
 139             return results;
 140         } catch (Exception e) {
<abbr title=" 141             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 141             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedðŸ”µ</abbr>
 142         }
 143     }
 144 
 145     @Override
<abbr title=" 146     public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws Exception {"> 146     public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws ExcepðŸ”µ</abbr>
<abbr title=" 147         StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 147         StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valðŸ”µ</abbr>
<abbr title=" 148         //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUpdate()"> 148         //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUðŸ”µ</abbr>
 149         em.refresh(structuredContent);
 150         return fetchDynamicEntity(structuredContent, dirtyFields, true);
 151     }
 152 
 153     @Override
 154     public String getFieldContainerClassName() {
 155         return StructuredContent.class.getName();
 156     }
 157 
 158     @Override
<abbr title=" 159     public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throws Exception {"> 159     public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throðŸ”µ</abbr>
 160         StructuredContent structuredContent = (StructuredContent) root;
<abbr title=" 161         Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructuredContentFieldXrefs();"> 161         Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructurðŸ”µ</abbr>
 162         Entity entity = new Entity();
 163         entity.setType(new String[]{StructuredContentType.class.getName()});
 164         List&lt;Property&gt; propertiesList = new ArrayList&lt;Property&gt;();
<abbr title=" 165         for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 165         for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieðŸ”µ</abbr>
 166             for (FieldDefinition def : fieldGroup.getFieldDefinitions()) {
 167                 Property property = new Property();
 168                 property.setName(def.getName());
 169                 String value = null;
 170                 if (!MapUtils.isEmpty(structuredContentFieldMap)) {
<abbr title=" 171                     StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.get(def.getName());"> 171                     StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.getðŸ”µ</abbr>
 172                     if (structuredContentFieldXref != null) {
<abbr title=" 173                         StructuredContentField structuredContentField = structuredContentFieldXref.getStructuredContentField();"> 173                         StructuredContentField structuredContentField = structuredContentFieldXref.getStrðŸ”µ</abbr>
 174                         if (structuredContentField != null) {
 175                             value = structuredContentField.getValue();
 176                         }
 177                     }
 178                 }
 179                 property.setValue(value);
 180                 if (!CollectionUtils.isEmpty(dirtyFields) &amp;&amp; dirtyFields.contains(property.getName())) {
 181                     property.setIsDirty(true);
 182                 }
 183 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 185                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; value != null) {"> 185                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; value != nullðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186                     // we need to look up the display value</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 187                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), value);"> 187                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), valðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188                     property.setDisplayValue(display);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189                 }</span>
 190 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                 property.setValue(value);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195                 if (!CollectionUtils.isEmpty(dirtyFields) &amp;&amp; dirtyFields.contains(property.getName())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196                     property.setIsDirty(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 199                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; StringUtils.isNotEmpty(value)) {"> 199                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; StringUtils.iðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200                     // we need to look up the display value</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 201                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), value);"> 201                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), valðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202                     property.setDisplayValue(display);</span>
 203 =======
 204 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 205                 propertiesList.add(property);
 206             }
 207         }
 208         if (includeId) {
 209             Property property = new Property();
 210             propertiesList.add(property);
 211             property.setName(&quot;id&quot;);
 212             property.setValue(String.valueOf(structuredContent.getId()));
 213         }
 214 
 215         entity.setProperties(propertiesList.toArray(new Property[]{}));
 216 
 217         return entity;
 218     }
 219 
 220     /**
<abbr title=" 221      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 221      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the struðŸ”µ</abbr>
 222      */
 223     @Override
<abbr title=" 224     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 224     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordðŸ”µ</abbr>
 225         return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 226     }
 227 
 228     /**
<abbr title=" 229      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 229      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the struðŸ”µ</abbr>
 230      */
 231     @Override
<abbr title=" 232     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 232     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelðŸ”µ</abbr>
 233         return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 234     }
 235 
<abbr title=" 236     protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 236     protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDaoðŸ”µ</abbr>
<abbr title=" 237         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 237         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 238         try {
 239             String structuredContentId = persistencePackage.getCustomCriteria()[1];
<abbr title=" 240             StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 240             StructuredContent structuredContent = structuredContentService.findStructuredContentById(LongðŸ”µ</abbr>
 241 
<abbr title=" 242             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentType.class);"> 242             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructðŸ”µ</abbr>
 243             Map&lt;String, FieldMetadata&gt; md = new HashMap&lt;String, FieldMetadata&gt;();
 244             for (Property property : properties) {
 245                 md.put(property.getName(), property.getMetadata());
 246             }
 247 
<abbr title=" 248             boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeImpl(), md);"> 248             boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeðŸ”µ</abbr>
 249             if (!validated) {
<abbr title=" 250                 throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamic fields failed validation&quot;);"> 250                 throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamicðŸ”µ</abbr>
 251             }
 252 
 253             List&lt;String&gt; templateFieldNames = new ArrayList&lt;String&gt;(20);
<abbr title=" 254             for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 254             for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFielðŸ”µ</abbr>
 255                 for (FieldDefinition def : group.getFieldDefinitions()) {
 256                     templateFieldNames.add(def.getName());
 257                 }
 258             }
 259             Map&lt;String, String&gt; dirtyFieldsOrigVals = new HashMap&lt;String, String&gt;();
 260             List&lt;String&gt; dirtyFields = new ArrayList&lt;String&gt;();
 261             Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap =
 262                     structuredContent.getStructuredContentFieldXrefs();
 263             for (Property property : persistencePackage.getEntity().getProperties()) {
 264                 if (property.getEnabled() &amp;&amp; templateFieldNames.contains(property.getName())) {
<abbr title=" 265                     StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName());"> 265                     StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName())ðŸ”µ</abbr>
 266                     if (scXref != null &amp;&amp; scXref.getStructuredContentField() != null) {
<abbr title=" 267                         StructuredContentField structuredContentField = scXref.getStructuredContentField();"> 267                         StructuredContentField structuredContentField = scXref.getStructuredContentField(ðŸ”µ</abbr>
<abbr title=" 268                         boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValue() != null) ||"> 268                         boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValueðŸ”µ</abbr>
<abbr title=" 269                                 (structuredContentField.getValue() != null &amp;&amp; property.getValue() == null);"> 269                                 (structuredContentField.getValue() != null &amp;&amp; property.getValue() == nullðŸ”µ</abbr>
<abbr title=" 270                         if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() != null &amp;&amp;"> 270                         if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() ðŸ”µ</abbr>
<abbr title=" 271                                 !structuredContentField.getValue().trim().equals(property.getValue().trim()))) {"> 271                                 !structuredContentField.getValue().trim().equals(property.getValue().trimðŸ”µ</abbr>
 272                             dirtyFields.add(property.getName());
<abbr title=" 273                             dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue());"> 273                             dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue()ðŸ”µ</abbr>
 274                             structuredContentField.setValue(property.getValue());
 275                             scXref = dynamicEntityDao.merge(scXref);
 276                         }
 277                     } else {
 278                         StructuredContentField structuredContentField = new StructuredContentFieldImpl();
 279                         structuredContentField.setFieldKey(property.getName());
 280                         structuredContentField.setValue(property.getValue());
 281 
 282                         StructuredContentFieldXref scfx = new StructuredContentFieldXrefImpl();
 283                         scfx.setStructuredContent(structuredContent);
 284                         scfx.setKey(property.getName());
 285                         scfx.setStrucuturedContentField(structuredContentField);
 286 
 287                         scfx = dynamicEntityDao.persist(scfx);
 288                         dirtyFields.add(property.getName());
 289                     }
 290                 }
 291             }
 292             List&lt;String&gt; removeItems = new ArrayList&lt;String&gt;();
 293             for (String key : structuredContentFieldMap.keySet()) {
 294                 if (persistencePackage.getEntity().findProperty(key)==null) {
 295                     removeItems.add(key);
 296                 }
 297             }
 298             if (removeItems.size() &gt; 0) {
 299                 for (String removeKey : removeItems) {
 300                     structuredContentFieldMap.remove(removeKey);
 301                 }
 302             }
 303 
 304             Collections.sort(dirtyFields);
 305             Entity entity = fetchEntityBasedOnId(structuredContentId, dirtyFields);
 306 
 307             for (Entry&lt;String, String&gt; entry : dirtyFieldsOrigVals.entrySet()) {
 308                 entity.getPMap().get(entry.getKey()).setOriginalValue(entry.getValue());
 309                 entity.getPMap().get(entry.getKey()).setOriginalDisplayValue(entry.getValue());
 310             }
 311 
 312             return entity;
 313         } catch (ValidationException e) {
 314             throw e;
 315         } catch (Exception e) {
<abbr title=" 316             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 316             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedðŸ”µ</abbr>
 317         }
 318     }
 319 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce CMS Module
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.cms.admin.server.handler;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.MapUtils;
  22 import org.apache.commons.logging.Log;
  23 import org.apache.commons.logging.LogFactory;
  24 import org.broadleafcommerce.cms.field.domain.FieldDefinition;
  25 import org.broadleafcommerce.cms.field.domain.FieldGroup;
  26 import org.broadleafcommerce.cms.structure.domain.StructuredContent;
  27 import org.broadleafcommerce.cms.structure.domain.StructuredContentField;
  28 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldImpl;
  29 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXref;
  30 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXrefImpl;
  31 import org.broadleafcommerce.cms.structure.domain.StructuredContentType;
  32 import org.broadleafcommerce.cms.structure.domain.StructuredContentTypeImpl;
  33 import org.broadleafcommerce.cms.structure.service.StructuredContentService;
  34 import org.broadleafcommerce.common.exception.ServiceException;
  35 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  36 import org.broadleafcommerce.openadmin.dto.ClassTree;
  37 import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  38 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  39 import org.broadleafcommerce.openadmin.dto.Entity;
  40 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  41 import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  42 import org.broadleafcommerce.openadmin.dto.Property;
  43 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  44 import org.broadleafcommerce.openadmin.server.service.ValidationException;
  45 import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  46 import org.broadleafcommerce.openadmin.server.service.handler.DynamicEntityRetriever;
  47 import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  48 import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  49 import org.springframework.stereotype.Component;
  50 
  51 import java.io.Serializable;
  52 import java.util.ArrayList;
  53 import java.util.Collections;
  54 import java.util.HashMap;
  55 import java.util.List;
  56 import java.util.Map;
  57 import java.util.Map.Entry;
  58 
  59 import javax.annotation.Resource;
  60 import javax.persistence.EntityManager;
  61 import javax.persistence.PersistenceContext;
  62 
  63 /**
  64  * Created by jfischer
  65  */
  66 @Component(&quot;blStructuredContentTypeCustomPersistenceHandler&quot;)
<abbr title="  67 public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implements DynamicEntityRetriever {">  67 public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implemðŸ”µ</abbr>
  68 
  69     private final Log LOG = LogFactory.getLog(StructuredContentTypeCustomPersistenceHandler.class);
  70 
  71     @Resource(name=&quot;blStructuredContentService&quot;)
  72     protected StructuredContentService structuredContentService;
  73 
  74     @Resource(name = &quot;blDynamicFieldPersistenceHandlerHelper&quot;)
  75     protected DynamicFieldPersistenceHandlerHelper dynamicFieldUtil;
  76 
  77     @PersistenceContext(unitName=&quot;blPU&quot;)
  78     protected EntityManager em;
  79 
  80     @Override
  81     public Boolean canHandleFetch(PersistencePackage persistencePackage) {
<abbr title="  82         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();">  82         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
  83         return
  84             StructuredContentType.class.getName().equals(ceilingEntityFullyQualifiedClassname) &amp;&amp;
  85             persistencePackage.getCustomCriteria() != null &amp;&amp;
  86             persistencePackage.getCustomCriteria().length &gt; 0 &amp;&amp;
  87             persistencePackage.getCustomCriteria()[0].equals(&quot;constructForm&quot;);
  88     }
  89 
  90     @Override
  91     public Boolean canHandleAdd(PersistencePackage persistencePackage) {
  92         return canHandleFetch(persistencePackage);
  93     }
  94 
  95     @Override
  96     public Boolean canHandleInspect(PersistencePackage persistencePackage) {
  97         return canHandleFetch(persistencePackage);
  98     }
  99 
 100     @Override
 101     public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 102         return false;
 103     }
 104 
 105     @Override
 106     public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 107         return canHandleFetch(persistencePackage);
 108     }
 109 
 110     @Override
<abbr title=" 111     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 111     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityðŸ”µ</abbr>
<abbr title=" 112         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 112         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 113         try {
 114             String structuredContentTypeId = persistencePackage.getCustomCriteria()[3];
<abbr title=" 115             StructuredContentType structuredContentType = structuredContentService.findStructuredContentTypeById(Long.valueOf(structuredContentTypeId));"> 115             StructuredContentType structuredContentType = structuredContentService.findStructuredContentTðŸ”µ</abbr>
 116             ClassMetadata metadata = new ClassMetadata();
 117             metadata.setCeilingType(StructuredContentType.class.getName());
 118             ClassTree entities = new ClassTree(StructuredContentTypeImpl.class.getName());
 119             metadata.setPolymorphicEntities(entities);
<abbr title=" 120             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentTypeImpl.class);"> 120             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStðŸ”µ</abbr>
 121             metadata.setProperties(properties);
 122             DynamicResultSet results = new DynamicResultSet(metadata);
 123 
 124             return results;
 125         } catch (Exception e) {
<abbr title=" 126             throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 126             throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiðŸ”µ</abbr>
 127         }
 128     }
 129 
 130 
 131     @Override
<abbr title=" 132     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 132     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynaðŸ”µ</abbr>
<abbr title=" 133         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 133         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 134         try {
 135             String structuredContentId = persistencePackage.getCustomCriteria()[1];
 136             Entity entity = fetchEntityBasedOnId(structuredContentId, null);
 137             DynamicResultSet results = new DynamicResultSet(new Entity[]{entity}, 1);
 138 
 139             return results;
 140         } catch (Exception e) {
<abbr title=" 141             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 141             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedðŸ”µ</abbr>
 142         }
 143     }
 144 
 145     @Override
<abbr title=" 146     public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws Exception {"> 146     public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws ExcepðŸ”µ</abbr>
<abbr title=" 147         StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 147         StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valðŸ”µ</abbr>
<abbr title=" 148         //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUpdate()"> 148         //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUðŸ”µ</abbr>
 149         em.refresh(structuredContent);
 150         return fetchDynamicEntity(structuredContent, dirtyFields, true);
 151     }
 152 
 153     @Override
 154     public String getFieldContainerClassName() {
 155         return StructuredContent.class.getName();
 156     }
 157 
 158     @Override
<abbr title=" 159     public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throws Exception {"> 159     public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throðŸ”µ</abbr>
 160         StructuredContent structuredContent = (StructuredContent) root;
<abbr title=" 161         Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructuredContentFieldXrefs();"> 161         Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructurðŸ”µ</abbr>
 162         Entity entity = new Entity();
 163         entity.setType(new String[]{StructuredContentType.class.getName()});
 164         List&lt;Property&gt; propertiesList = new ArrayList&lt;Property&gt;();
<abbr title=" 165         for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 165         for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieðŸ”µ</abbr>
 166             for (FieldDefinition def : fieldGroup.getFieldDefinitions()) {
 167                 Property property = new Property();
 168                 property.setName(def.getName());
 169                 String value = null;
 170                 if (!MapUtils.isEmpty(structuredContentFieldMap)) {
<abbr title=" 171                     StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.get(def.getName());"> 171                     StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.getðŸ”µ</abbr>
 172                     if (structuredContentFieldXref != null) {
<abbr title=" 173                         StructuredContentField structuredContentField = structuredContentFieldXref.getStructuredContentField();"> 173                         StructuredContentField structuredContentField = structuredContentFieldXref.getStrðŸ”µ</abbr>
 174                         if (structuredContentField != null) {
 175                             value = structuredContentField.getValue();
 176                         }
 177                     }
 178                 }
 179                 property.setValue(value);
 180                 if (!CollectionUtils.isEmpty(dirtyFields) &amp;&amp; dirtyFields.contains(property.getName())) {
 181                     property.setIsDirty(true);
 182                 }
 183 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 185                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; value != null) {"> 185                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; value != nullðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186                     // we need to look up the display value</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 187                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), value);"> 187                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), valðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188                     property.setDisplayValue(display);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189                 }</span>
 190 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 192                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; StringUtils.isNotEmpty(value)) {"> 192                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; StringUtils.iðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                     // we need to look up the display value</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 194                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), value);"> 194                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), valðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195                     property.setDisplayValue(display);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196                 }</span>
 197 =======
 198 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 199                 propertiesList.add(property);
 200             }
 201         }
 202         if (includeId) {
 203             Property property = new Property();
 204             propertiesList.add(property);
 205             property.setName(&quot;id&quot;);
 206             property.setValue(String.valueOf(structuredContent.getId()));
 207         }
 208 
 209         entity.setProperties(propertiesList.toArray(new Property[]{}));
 210 
 211         return entity;
 212     }
 213 
 214     /**
<abbr title=" 215      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 215      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the struðŸ”µ</abbr>
 216      */
 217     @Override
<abbr title=" 218     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 218     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordðŸ”µ</abbr>
 219         return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 220     }
 221 
 222     /**
<abbr title=" 223      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 223      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the struðŸ”µ</abbr>
 224      */
 225     @Override
<abbr title=" 226     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 226     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelðŸ”µ</abbr>
 227         return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 228     }
 229 
<abbr title=" 230     protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 230     protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDaoðŸ”µ</abbr>
<abbr title=" 231         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 231         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 232         try {
 233             String structuredContentId = persistencePackage.getCustomCriteria()[1];
<abbr title=" 234             StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 234             StructuredContent structuredContent = structuredContentService.findStructuredContentById(LongðŸ”µ</abbr>
 235 
<abbr title=" 236             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentType.class);"> 236             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructðŸ”µ</abbr>
 237             Map&lt;String, FieldMetadata&gt; md = new HashMap&lt;String, FieldMetadata&gt;();
 238             for (Property property : properties) {
 239                 md.put(property.getName(), property.getMetadata());
 240             }
 241 
<abbr title=" 242             boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeImpl(), md);"> 242             boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeðŸ”µ</abbr>
 243             if (!validated) {
<abbr title=" 244                 throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamic fields failed validation&quot;);"> 244                 throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamicðŸ”µ</abbr>
 245             }
 246 
 247             List&lt;String&gt; templateFieldNames = new ArrayList&lt;String&gt;(20);
<abbr title=" 248             for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 248             for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFielðŸ”µ</abbr>
 249                 for (FieldDefinition def : group.getFieldDefinitions()) {
 250                     templateFieldNames.add(def.getName());
 251                 }
 252             }
 253             Map&lt;String, String&gt; dirtyFieldsOrigVals = new HashMap&lt;String, String&gt;();
 254             List&lt;String&gt; dirtyFields = new ArrayList&lt;String&gt;();
 255             Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap =
 256                     structuredContent.getStructuredContentFieldXrefs();
 257             for (Property property : persistencePackage.getEntity().getProperties()) {
 258                 if (property.getEnabled() &amp;&amp; templateFieldNames.contains(property.getName())) {
<abbr title=" 259                     StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName());"> 259                     StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName())ðŸ”µ</abbr>
 260                     if (scXref != null &amp;&amp; scXref.getStructuredContentField() != null) {
<abbr title=" 261                         StructuredContentField structuredContentField = scXref.getStructuredContentField();"> 261                         StructuredContentField structuredContentField = scXref.getStructuredContentField(ðŸ”µ</abbr>
<abbr title=" 262                         boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValue() != null) ||"> 262                         boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValueðŸ”µ</abbr>
<abbr title=" 263                                 (structuredContentField.getValue() != null &amp;&amp; property.getValue() == null);"> 263                                 (structuredContentField.getValue() != null &amp;&amp; property.getValue() == nullðŸ”µ</abbr>
<abbr title=" 264                         if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() != null &amp;&amp;"> 264                         if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() ðŸ”µ</abbr>
<abbr title=" 265                                 !structuredContentField.getValue().trim().equals(property.getValue().trim()))) {"> 265                                 !structuredContentField.getValue().trim().equals(property.getValue().trimðŸ”µ</abbr>
 266                             dirtyFields.add(property.getName());
<abbr title=" 267                             dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue());"> 267                             dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue()ðŸ”µ</abbr>
 268                             structuredContentField.setValue(property.getValue());
 269                             scXref = dynamicEntityDao.merge(scXref);
 270                         }
 271                     } else {
 272                         StructuredContentField structuredContentField = new StructuredContentFieldImpl();
 273                         structuredContentField.setFieldKey(property.getName());
 274                         structuredContentField.setValue(property.getValue());
 275 
 276                         StructuredContentFieldXref scfx = new StructuredContentFieldXrefImpl();
 277                         scfx.setStructuredContent(structuredContent);
 278                         scfx.setKey(property.getName());
 279                         scfx.setStrucuturedContentField(structuredContentField);
 280 
 281                         scfx = dynamicEntityDao.persist(scfx);
 282                         dirtyFields.add(property.getName());
 283                     }
 284                 }
 285             }
 286             List&lt;String&gt; removeItems = new ArrayList&lt;String&gt;();
 287             for (String key : structuredContentFieldMap.keySet()) {
 288                 if (persistencePackage.getEntity().findProperty(key)==null) {
 289                     removeItems.add(key);
 290                 }
 291             }
 292             if (removeItems.size() &gt; 0) {
 293                 for (String removeKey : removeItems) {
 294                     structuredContentFieldMap.remove(removeKey);
 295                 }
 296             }
 297 
 298             Collections.sort(dirtyFields);
 299             Entity entity = fetchEntityBasedOnId(structuredContentId, dirtyFields);
 300 
 301             for (Entry&lt;String, String&gt; entry : dirtyFieldsOrigVals.entrySet()) {
 302                 entity.getPMap().get(entry.getKey()).setOriginalValue(entry.getValue());
 303                 entity.getPMap().get(entry.getKey()).setOriginalDisplayValue(entry.getValue());
 304             }
 305 
 306             return entity;
 307         } catch (ValidationException e) {
 308             throw e;
 309         } catch (Exception e) {
<abbr title=" 310             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 310             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedðŸ”µ</abbr>
 311         }
 312     }
 313 }
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce CMS Module
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.cms.admin.server.handler;
  19 
  20 import java.io.Serializable;
  21 import java.util.ArrayList;
  22 import java.util.Collections;
  23 import java.util.HashMap;
  24 import java.util.List;
  25 import java.util.Map.Entry;
  26 import java.util.Map;
  27 import javax.annotation.Resource;
  28 import javax.persistence.EntityManager;
  29 import javax.persistence.PersistenceContext;
  30 import org.apache.commons.collections.CollectionUtils;
  31 import org.apache.commons.collections.MapUtils;
  32 import org.apache.commons.logging.Log;
  33 import org.apache.commons.logging.LogFactory;
  34 import org.broadleafcommerce.cms.field.domain.FieldDefinition;
  35 import org.broadleafcommerce.cms.field.domain.FieldGroup;
  36 import org.broadleafcommerce.cms.structure.domain.StructuredContent;
  37 import org.broadleafcommerce.cms.structure.domain.StructuredContentField;
  38 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldImpl;
  39 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXref;
  40 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXrefImpl;
  41 import org.broadleafcommerce.cms.structure.domain.StructuredContentType;
  42 import org.broadleafcommerce.cms.structure.domain.StructuredContentTypeImpl;
  43 import org.broadleafcommerce.cms.structure.service.StructuredContentService;
  44 import org.broadleafcommerce.common.exception.ServiceException;
  45 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  46 import org.broadleafcommerce.openadmin.dto.ClassTree;
  47 import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  48 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  49 import org.broadleafcommerce.openadmin.dto.Entity;
  50 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  51 import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  52 import org.broadleafcommerce.openadmin.dto.Property;
  53 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  54 import org.broadleafcommerce.openadmin.server.service.ValidationException;
  55 import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  56 import org.broadleafcommerce.openadmin.server.service.handler.DynamicEntityRetriever;
  57 import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  58 import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  59 import org.springframework.stereotype.Component;
  60 
  61 
  62 /**
  63  * Created by jfischer
  64  */
  65 @Component(&quot;blStructuredContentTypeCustomPersistenceHandler&quot;)
<abbr title="  66 public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implements DynamicEntityRetriever {">  66 public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implemðŸ”µ</abbr>
  67     private final Log LOG = LogFactory.getLog(StructuredContentTypeCustomPersistenceHandler.class);
  68 
  69     @Resource(name=&quot;blStructuredContentService&quot;)
  70     protected StructuredContentService structuredContentService;
  71 
  72     @Resource(name = &quot;blDynamicFieldPersistenceHandlerHelper&quot;)
  73     protected DynamicFieldPersistenceHandlerHelper dynamicFieldUtil;
  74 
  75     @PersistenceContext(unitName=&quot;blPU&quot;)
  76     protected EntityManager em;
  77 
  78     @Override
  79     public Boolean canHandleFetch(PersistencePackage persistencePackage) {
<abbr title="  80         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();">  80         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
  81         return
  82             StructuredContentType.class.getName().equals(ceilingEntityFullyQualifiedClassname) &amp;&amp;
  83             persistencePackage.getCustomCriteria() != null &amp;&amp;
  84             persistencePackage.getCustomCriteria().length &gt; 0 &amp;&amp;
  85             persistencePackage.getCustomCriteria()[0].equals(&quot;constructForm&quot;);
  86     }
  87 
  88     @Override
  89     public Boolean canHandleAdd(PersistencePackage persistencePackage) {
  90         return canHandleFetch(persistencePackage);
  91     }
  92 
  93     @Override
  94     public Boolean canHandleInspect(PersistencePackage persistencePackage) {
  95         return canHandleFetch(persistencePackage);
  96     }
  97 
  98     @Override
  99     public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 100         return false;
 101     }
 102 
 103     @Override
 104     public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 105         return canHandleFetch(persistencePackage);
 106     }
 107 
 108     @Override
<abbr title=" 109     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 109     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityðŸ”µ</abbr>
<abbr title=" 110         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 110         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 111         try {
 112             String structuredContentTypeId = persistencePackage.getCustomCriteria()[3];
<abbr title=" 113             StructuredContentType structuredContentType = structuredContentService.findStructuredContentTypeById(Long.valueOf(structuredContentTypeId));"> 113             StructuredContentType structuredContentType = structuredContentService.findStructuredContentTðŸ”µ</abbr>
 114             ClassMetadata metadata = new ClassMetadata();
 115             metadata.setCeilingType(StructuredContentType.class.getName());
 116             ClassTree entities = new ClassTree(StructuredContentTypeImpl.class.getName());
 117             metadata.setPolymorphicEntities(entities);
<abbr title=" 118             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentTypeImpl.class);"> 118             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStðŸ”µ</abbr>
 119             metadata.setProperties(properties);
 120             DynamicResultSet results = new DynamicResultSet(metadata);
 121 
 122             return results;
 123         } catch (Exception e) {
<abbr title=" 124             throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 124             throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiðŸ”µ</abbr>
 125         }
 126     }
 127 
 128     @Override
<abbr title=" 129     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 129     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynaðŸ”µ</abbr>
<abbr title=" 130         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 130         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 131         try {
 132             String structuredContentId = persistencePackage.getCustomCriteria()[1];
 133             Entity entity = fetchEntityBasedOnId(structuredContentId, null);
 134             DynamicResultSet results = new DynamicResultSet(new Entity[]{entity}, 1);
 135 
 136             return results;
 137         } catch (Exception e) {
<abbr title=" 138             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 138             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedðŸ”µ</abbr>
 139         }
 140     }
 141 
 142     @Override
<abbr title=" 143     public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws Exception {"> 143     public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws ExcepðŸ”µ</abbr>
<abbr title=" 144         StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 144         StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valðŸ”µ</abbr>
<abbr title=" 145         //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUpdate()"> 145         //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUðŸ”µ</abbr>
 146         em.refresh(structuredContent);
 147         return fetchDynamicEntity(structuredContent, dirtyFields, true);
 148     }
 149 
 150     @Override
 151     public String getFieldContainerClassName() {
 152         return StructuredContent.class.getName();
 153     }
 154 
 155     @Override
<abbr title=" 156     public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throws Exception {"> 156     public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throðŸ”µ</abbr>
 157         StructuredContent structuredContent = ((StructuredContent) (root));
<abbr title=" 158         Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructuredContentFieldXrefs();"> 158         Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructurðŸ”µ</abbr>
 159         Entity entity = new Entity();
 160         entity.setType(new String[]{ StructuredContentType.class.getName() });
 161         List&lt;Property&gt; propertiesList = new ArrayList&lt;Property&gt;();
<abbr title=" 162         for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 162         for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieðŸ”µ</abbr>
 163             for (FieldDefinition def : fieldGroup.getFieldDefinitions()) {
 164                 Property property = new Property();
 165                 property.setName(def.getName());
 166                 String value = null;
 167                 if (!MapUtils.isEmpty(structuredContentFieldMap)) {
<abbr title=" 168                     StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.get(def.getName());"> 168                     StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.getðŸ”µ</abbr>
 169                     if (structuredContentFieldXref != null) {
<abbr title=" 170                         StructuredContentField structuredContentField = structuredContentFieldXref.getStructuredContentField();"> 170                         StructuredContentField structuredContentField = structuredContentFieldXref.getStrðŸ”µ</abbr>
 171                         if (structuredContentField != null) {
 172                             value = structuredContentField.getValue();
 173                         }
 174                     }
 175                 }
 176                 property.setValue(value);
<abbr title=" 177                 if ((!CollectionUtils.isEmpty(dirtyFields)) &amp;&amp; dirtyFields.contains(property.getName())) {"> 177                 if ((!CollectionUtils.isEmpty(dirtyFields)) &amp;&amp; dirtyFields.contains(property.getName())) ðŸ”µ</abbr>
 178                     property.setIsDirty(true);
 179                 }
 180                 propertiesList.add(property);
 181             }
 182         }
 183         if (includeId) {
 184             Property property = new Property();
 185             propertiesList.add(property);
 186             property.setName(&quot;id&quot;);
 187             property.setValue(String.valueOf(structuredContent.getId()));
 188         }
 189         entity.setProperties(propertiesList.toArray(new Property[]{  }));
 190         return entity;
 191     }
 192 
 193     /**
<abbr title=" 194      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 194      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the struðŸ”µ</abbr>
 195      */
 196     @Override
<abbr title=" 197     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 197     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordðŸ”µ</abbr>
 198         return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 199     }
 200 
 201     /**
<abbr title=" 202      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 202      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the struðŸ”µ</abbr>
 203      */
 204     @Override
<abbr title=" 205     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 205     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelðŸ”µ</abbr>
 206         return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 207     }
 208 
<abbr title=" 209     protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 209     protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDaoðŸ”µ</abbr>
<abbr title=" 210         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 210         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 211         try {
 212             String structuredContentId = persistencePackage.getCustomCriteria()[1];
<abbr title=" 213             StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 213             StructuredContent structuredContent = structuredContentService.findStructuredContentById(LongðŸ”µ</abbr>
 214 
<abbr title=" 215             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentType.class);"> 215             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructðŸ”µ</abbr>
 216             Map&lt;String, FieldMetadata&gt; md = new HashMap&lt;String, FieldMetadata&gt;();
 217             for (Property property : properties) {
 218                 md.put(property.getName(), property.getMetadata());
 219             }
 220 
<abbr title=" 221             boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeImpl(), md);"> 221             boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeðŸ”µ</abbr>
 222             if (!validated) {
<abbr title=" 223                 throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamic fields failed validation&quot;);"> 223                 throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamicðŸ”µ</abbr>
 224             }
 225 
 226             List&lt;String&gt; templateFieldNames = new ArrayList&lt;String&gt;(20);
<abbr title=" 227             for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 227             for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFielðŸ”µ</abbr>
 228                 for (FieldDefinition def : group.getFieldDefinitions()) {
 229                     templateFieldNames.add(def.getName());
 230                 }
 231             }
 232             Map&lt;String, String&gt; dirtyFieldsOrigVals = new HashMap&lt;String, String&gt;();
 233             List&lt;String&gt; dirtyFields = new ArrayList&lt;String&gt;();
 234             Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap =
 235                     structuredContent.getStructuredContentFieldXrefs();
 236             for (Property property : persistencePackage.getEntity().getProperties()) {
 237                 if (property.getEnabled() &amp;&amp; templateFieldNames.contains(property.getName())) {
<abbr title=" 238                     StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName());"> 238                     StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName())ðŸ”µ</abbr>
 239                     if (scXref != null &amp;&amp; scXref.getStructuredContentField() != null) {
<abbr title=" 240                         StructuredContentField structuredContentField = scXref.getStructuredContentField();"> 240                         StructuredContentField structuredContentField = scXref.getStructuredContentField(ðŸ”µ</abbr>
<abbr title=" 241                         boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValue() != null) ||"> 241                         boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValueðŸ”µ</abbr>
<abbr title=" 242                                 (structuredContentField.getValue() != null &amp;&amp; property.getValue() == null);"> 242                                 (structuredContentField.getValue() != null &amp;&amp; property.getValue() == nullðŸ”µ</abbr>
<abbr title=" 243                         if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() != null &amp;&amp;"> 243                         if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() ðŸ”µ</abbr>
<abbr title=" 244                                 !structuredContentField.getValue().trim().equals(property.getValue().trim()))) {"> 244                                 !structuredContentField.getValue().trim().equals(property.getValue().trimðŸ”µ</abbr>
 245                             dirtyFields.add(property.getName());
<abbr title=" 246                             dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue());"> 246                             dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue()ðŸ”µ</abbr>
 247                             structuredContentField.setValue(property.getValue());
 248                             scXref = dynamicEntityDao.merge(scXref);
 249                         }
 250                     } else {
 251                         StructuredContentField structuredContentField = new StructuredContentFieldImpl();
 252                         structuredContentField.setFieldKey(property.getName());
 253                         structuredContentField.setValue(property.getValue());
 254 
 255                         StructuredContentFieldXref scfx = new StructuredContentFieldXrefImpl();
 256                         scfx.setStructuredContent(structuredContent);
 257                         scfx.setKey(property.getName());
 258                         scfx.setStrucuturedContentField(structuredContentField);
 259 
 260                         scfx = dynamicEntityDao.persist(scfx);
 261                         dirtyFields.add(property.getName());
 262                     }
 263                 }
 264             }
 265             List&lt;String&gt; removeItems = new ArrayList&lt;String&gt;();
 266             for (String key : structuredContentFieldMap.keySet()) {
 267                 if (persistencePackage.getEntity().findProperty(key)==null) {
 268                     removeItems.add(key);
 269                 }
 270             }
 271             if (removeItems.size() &gt; 0) {
 272                 for (String removeKey : removeItems) {
 273                     structuredContentFieldMap.remove(removeKey);
 274                 }
 275             }
 276 
 277             Collections.sort(dirtyFields);
 278             Entity entity = fetchEntityBasedOnId(structuredContentId, dirtyFields);
 279 
 280             for (Entry&lt;String, String&gt; entry : dirtyFieldsOrigVals.entrySet()) {
 281                 entity.getPMap().get(entry.getKey()).setOriginalValue(entry.getValue());
 282                 entity.getPMap().get(entry.getKey()).setOriginalDisplayValue(entry.getValue());
 283             }
 284 
 285             return entity;
 286         } catch (ValidationException e) {
 287             throw e;
 288         } catch (Exception e) {
<abbr title=" 289             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 289             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedðŸ”µ</abbr>
 290         }
 291     }
 292 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce CMS Module
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.cms.admin.server.handler;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.MapUtils;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import org.apache.commons.lang3.StringUtils;</span>
  23  import org.apache.commons.logging.Log;
  24  import org.apache.commons.logging.LogFactory;
  25  import org.broadleafcommerce.cms.field.domain.FieldDefinition;
  26  import org.broadleafcommerce.cms.field.domain.FieldDefinitionImpl;
  27  import org.broadleafcommerce.cms.field.domain.FieldGroup;
  28  import org.broadleafcommerce.cms.structure.domain.StructuredContent;
  29  import org.broadleafcommerce.cms.structure.domain.StructuredContentField;
  30  import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldImpl;
  31  import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXref;
  32  import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXrefImpl;
  33  import org.broadleafcommerce.cms.structure.domain.StructuredContentType;
  34  import org.broadleafcommerce.cms.structure.domain.StructuredContentTypeImpl;
  35  import org.broadleafcommerce.cms.structure.service.StructuredContentService;
  36  import org.broadleafcommerce.common.exception.ServiceException;
  37  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  38  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  39  import org.broadleafcommerce.openadmin.dto.ClassTree;
  40  import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  41  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  42  import org.broadleafcommerce.openadmin.dto.Entity;
  43  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  44  import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  45  import org.broadleafcommerce.openadmin.dto.Property;
  46  import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  47  import org.broadleafcommerce.openadmin.server.service.AdminEntityService;
  48  import org.broadleafcommerce.openadmin.server.service.ValidationException;
  49  import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  50  import org.broadleafcommerce.openadmin.server.service.handler.DynamicEntityRetriever;
  51  import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  52  import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  53  import org.springframework.stereotype.Component;
  54  
  55  import java.io.Serializable;
  56  import java.util.ArrayList;
  57  import java.util.Collections;
  58  import java.util.HashMap;
  59  import java.util.List;
  60  import java.util.Map;
  61  import java.util.Map.Entry;
  62  
  63  import javax.annotation.Resource;
  64  import javax.persistence.EntityManager;
  65  import javax.persistence.PersistenceContext;
  66  
  67  /**
  68   * Created by jfischer
  69   */
  70  @Component(&quot;blStructuredContentTypeCustomPersistenceHandler&quot;)
<abbr title="  71  public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implements DynamicEntityRetriever {">  71  public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implements DynaðŸ”µ</abbr>
  72  
  73      private final Log LOG = LogFactory.getLog(StructuredContentTypeCustomPersistenceHandler.class);
  74  
  75      @Resource(name=&quot;blStructuredContentService&quot;)
  76      protected StructuredContentService structuredContentService;
  77  
  78      @Resource(name = &quot;blDynamicFieldPersistenceHandlerHelper&quot;)
  79      protected DynamicFieldPersistenceHandlerHelper dynamicFieldUtil;
  80  
  81      @PersistenceContext(unitName=&quot;blPU&quot;)
  82      protected EntityManager em;
  83  
  84      @Resource(name = &quot;blAdminEntityService&quot;)
  85      protected AdminEntityService service;
  86  
  87      @Override
  88      public Boolean canHandleFetch(PersistencePackage persistencePackage) {
<abbr title="  89          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();">  89          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
  90          return
  91              StructuredContentType.class.getName().equals(ceilingEntityFullyQualifiedClassname) &amp;&amp;
  92              persistencePackage.getCustomCriteria() != null &amp;&amp;
  93              persistencePackage.getCustomCriteria().length &gt; 0 &amp;&amp;
  94              persistencePackage.getCustomCriteria()[0].equals(&quot;constructForm&quot;);
  95      }
  96  
  97      @Override
  98      public Boolean canHandleAdd(PersistencePackage persistencePackage) {
  99          return canHandleFetch(persistencePackage);
 100      }
 101  
 102      @Override
 103      public Boolean canHandleInspect(PersistencePackage persistencePackage) {
 104          return canHandleFetch(persistencePackage);
 105      }
 106  
 107      @Override
 108      public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 109          return false;
 110      }
 111  
 112      @Override
 113      public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 114          return canHandleFetch(persistencePackage);
 115      }
 116  
 117      @Override
<abbr title=" 118      public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 118      public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspðŸ”µ</abbr>
<abbr title=" 119          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 119          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
 120          try {
 121              String structuredContentTypeId = persistencePackage.getCustomCriteria()[3];
<abbr title=" 122              StructuredContentType structuredContentType = structuredContentService.findStructuredContentTypeById(Long.valueOf(structuredContentTypeId));"> 122              StructuredContentType structuredContentType = structuredContentService.findStructuredContentTypeById(LðŸ”µ</abbr>
 123              ClassMetadata metadata = new ClassMetadata();
 124              metadata.setCeilingType(StructuredContentType.class.getName());
 125              ClassTree entities = new ClassTree(StructuredContentTypeImpl.class.getName());
 126              metadata.setPolymorphicEntities(entities);
<abbr title=" 127              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentTypeImpl.class);"> 127              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStructuredCðŸ”µ</abbr>
 128              metadata.setProperties(properties);
 129              DynamicResultSet results = new DynamicResultSet(metadata);
 130  
 131              return results;
 132          } catch (Exception e) {
<abbr title=" 133              throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 133              throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiedClassnaðŸ”µ</abbr>
 134          }
 135      }
 136  
 137  
 138      @Override
<abbr title=" 139      public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 139      public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityðŸ”µ</abbr>
<abbr title=" 140          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 140          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
 141          try {
 142              String structuredContentId = persistencePackage.getCustomCriteria()[1];
 143              Entity entity = fetchEntityBasedOnId(structuredContentId, null);
 144              DynamicResultSet results = new DynamicResultSet(new Entity[]{entity}, 1);
 145  
 146              return results;
 147          } catch (Exception e) {
<abbr title=" 148              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 148              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassnameðŸ”µ</abbr>
 149          }
 150      }
 151  
 152      @Override
 153      public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws Exception {
<abbr title=" 154          StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 154          StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(struðŸ”µ</abbr>
 155          //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUpdate()
 156          em.refresh(structuredContent);
 157          return fetchDynamicEntity(structuredContent, dirtyFields, true);
 158      }
 159  
 160      @Override
 161      public String getFieldContainerClassName() {
 162          return StructuredContent.class.getName();
 163      }
 164  
 165      @Override
<abbr title=" 166      public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throws Exception {"> 166      public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throws ExceptðŸ”µ</abbr>
 167          StructuredContent structuredContent = (StructuredContent) root;
<abbr title=" 168          Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructuredContentFieldXrefs();"> 168          Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructuredContentðŸ”µ</abbr>
 169          Entity entity = new Entity();
 170          entity.setType(new String[]{StructuredContentType.class.getName()});
 171          List&lt;Property&gt; propertiesList = new ArrayList&lt;Property&gt;();
<abbr title=" 172          for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 172          for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieldTemplatðŸ”µ</abbr>
 173              for (FieldDefinition def : fieldGroup.getFieldDefinitions()) {
 174                  Property property = new Property();
 175                  property.setName(def.getName());
 176                  String value = null;
 177                  if (!MapUtils.isEmpty(structuredContentFieldMap)) {
<abbr title=" 178                      StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.get(def.getName());"> 178                      StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.get(def.getNðŸ”µ</abbr>
 179                      if (structuredContentFieldXref != null) {
<abbr title=" 180                          StructuredContentField structuredContentField = structuredContentFieldXref.getStructuredContentField();"> 180                          StructuredContentField structuredContentField = structuredContentFieldXref.getStructuredCoðŸ”µ</abbr>
 181                          if (structuredContentField != null) {
 182                              value = structuredContentField.getValue();
 183                          }
 184                      }
 185                  }
 186                  property.setValue(value);
 187                  if (!CollectionUtils.isEmpty(dirtyFields) &amp;&amp; dirtyFields.contains(property.getName())) {
 188                      property.setIsDirty(true);
 189                  }
 190  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 191 -                if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; StringUtils.isNotEmpty(value)) {"> 191 -                if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; StringUtils.isNotEmptyðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +                if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; value != null) {</span>
 193                      // we need to look up the display value
 194                      String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), value);
 195                      property.setDisplayValue(display);
 196                  }
 197                  propertiesList.add(property);
 198              }
 199          }
 200          if (includeId) {
 201              Property property = new Property();
 202              propertiesList.add(property);
 203              property.setName(&quot;id&quot;);
 204              property.setValue(String.valueOf(structuredContent.getId()));
 205          }
 206  
 207          entity.setProperties(propertiesList.toArray(new Property[]{}));
 208  
 209          return entity;
 210      }
 211  
 212      /**
<abbr title=" 213       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 213       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured coðŸ”µ</abbr>
 214       */
 215      @Override
<abbr title=" 216      public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 216      public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper heðŸ”µ</abbr>
 217          return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 218      }
 219  
 220      /**
<abbr title=" 221       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 221       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured coðŸ”µ</abbr>
 222       */
 223      @Override
<abbr title=" 224      public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 224      public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helpeðŸ”µ</abbr>
 225          return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 226      }
 227  
<abbr title=" 228      protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 228      protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHðŸ”µ</abbr>
<abbr title=" 229          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 229          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
 230          try {
 231              String structuredContentId = persistencePackage.getCustomCriteria()[1];
<abbr title=" 232              StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 232              StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(ðŸ”µ</abbr>
 233  
<abbr title=" 234              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentType.class);"> 234              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructuredConteðŸ”µ</abbr>
 235              Map&lt;String, FieldMetadata&gt; md = new HashMap&lt;String, FieldMetadata&gt;();
 236              for (Property property : properties) {
 237                  md.put(property.getName(), property.getMetadata());
 238              }
 239  
<abbr title=" 240              boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeImpl(), md);"> 240              boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeImpl(), mðŸ”µ</abbr>
 241              if (!validated) {
<abbr title=" 242                  throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamic fields failed validation&quot;);"> 242                  throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamic fields fðŸ”µ</abbr>
 243              }
 244  
 245              List&lt;String&gt; templateFieldNames = new ArrayList&lt;String&gt;(20);
<abbr title=" 246              for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 246              for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFieldTemplateðŸ”µ</abbr>
 247                  for (FieldDefinition def : group.getFieldDefinitions()) {
 248                      templateFieldNames.add(def.getName());
 249                  }
 250              }
 251              Map&lt;String, String&gt; dirtyFieldsOrigVals = new HashMap&lt;String, String&gt;();
 252              List&lt;String&gt; dirtyFields = new ArrayList&lt;String&gt;();
 253              Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap =
 254                      structuredContent.getStructuredContentFieldXrefs();
 255              for (Property property : persistencePackage.getEntity().getProperties()) {
 256                  if (property.getEnabled() &amp;&amp; templateFieldNames.contains(property.getName())) {
 257                      StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName());
 258                      if (scXref != null &amp;&amp; scXref.getStructuredContentField() != null) {
 259                          StructuredContentField structuredContentField = scXref.getStructuredContentField();
<abbr title=" 260                          boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValue() != null) ||"> 260                          boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValue() != nulðŸ”µ</abbr>
 261                                  (structuredContentField.getValue() != null &amp;&amp; property.getValue() == null);
<abbr title=" 262                          if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() != null &amp;&amp;"> 262                          if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() != null &amp;ðŸ”µ</abbr>
 263                                  !structuredContentField.getValue().trim().equals(property.getValue().trim()))) {
 264                              dirtyFields.add(property.getName());
 265                              dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue());
 266                              structuredContentField.setValue(property.getValue());
 267                              scXref = dynamicEntityDao.merge(scXref);
 268                          }
 269                      } else {
 270                          StructuredContentField structuredContentField = new StructuredContentFieldImpl();
 271                          structuredContentField.setFieldKey(property.getName());
 272                          structuredContentField.setValue(property.getValue());
 273  
 274                          StructuredContentFieldXref scfx = new StructuredContentFieldXrefImpl();
 275                          scfx.setStructuredContent(structuredContent);
 276                          scfx.setKey(property.getName());
 277                          scfx.setStrucuturedContentField(structuredContentField);
 278  
 279                          scfx = dynamicEntityDao.persist(scfx);
 280                          dirtyFields.add(property.getName());
 281                      }
 282                  }
 283              }
 284              List&lt;String&gt; removeItems = new ArrayList&lt;String&gt;();
 285              for (String key : structuredContentFieldMap.keySet()) {
 286                  if (persistencePackage.getEntity().findProperty(key)==null) {
 287                      removeItems.add(key);
 288                  }
 289              }
 290              if (removeItems.size() &gt; 0) {
 291                  for (String removeKey : removeItems) {
 292                      structuredContentFieldMap.remove(removeKey);
 293                  }
 294              }
 295  
 296              Collections.sort(dirtyFields);
 297              Entity entity = fetchEntityBasedOnId(structuredContentId, dirtyFields);
 298  
 299              for (Entry&lt;String, String&gt; entry : dirtyFieldsOrigVals.entrySet()) {
 300                  entity.getPMap().get(entry.getKey()).setOriginalValue(entry.getValue());
 301                  entity.getPMap().get(entry.getKey()).setOriginalDisplayValue(entry.getValue());
 302              }
 303  
 304              return entity;
 305          } catch (ValidationException e) {
 306              throw e;
 307          } catch (Exception e) {
<abbr title=" 308              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 308              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassnameðŸ”µ</abbr>
 309          }
 310      }
 311  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce CMS Module
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.cms.admin.server.handler;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.MapUtils;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import org.apache.commons.lang3.StringUtils;</span>
  23  import org.apache.commons.logging.Log;
  24  import org.apache.commons.logging.LogFactory;
  25  import org.broadleafcommerce.cms.field.domain.FieldDefinition;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.broadleafcommerce.cms.field.domain.FieldDefinitionImpl;</span>
  27  import org.broadleafcommerce.cms.field.domain.FieldGroup;
  28  import org.broadleafcommerce.cms.structure.domain.StructuredContent;
  29  import org.broadleafcommerce.cms.structure.domain.StructuredContentField;
  30  import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldImpl;
  31  import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXref;
  32  import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXrefImpl;
  33  import org.broadleafcommerce.cms.structure.domain.StructuredContentType;
  34  import org.broadleafcommerce.cms.structure.domain.StructuredContentTypeImpl;
  35  import org.broadleafcommerce.cms.structure.service.StructuredContentService;
  36  import org.broadleafcommerce.common.exception.ServiceException;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import org.broadleafcommerce.common.presentation.client.SupportedFieldType;</span>
  38  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  39  import org.broadleafcommerce.openadmin.dto.ClassTree;
  40  import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  41  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  42  import org.broadleafcommerce.openadmin.dto.Entity;
  43  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  44  import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  45  import org.broadleafcommerce.openadmin.dto.Property;
  46  import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import org.broadleafcommerce.openadmin.server.service.AdminEntityService;</span>
  48  import org.broadleafcommerce.openadmin.server.service.ValidationException;
  49  import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  50  import org.broadleafcommerce.openadmin.server.service.handler.DynamicEntityRetriever;
  51  import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  52  import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  53  import org.springframework.stereotype.Component;
  54  
  55  import java.io.Serializable;
  56  import java.util.ArrayList;
  57  import java.util.Collections;
  58  import java.util.HashMap;
  59  import java.util.List;
  60  import java.util.Map;
  61  import java.util.Map.Entry;
  62  
  63  import javax.annotation.Resource;
  64  import javax.persistence.EntityManager;
  65  import javax.persistence.PersistenceContext;
  66  
  67  /**
  68   * Created by jfischer
  69   */
  70  @Component(&quot;blStructuredContentTypeCustomPersistenceHandler&quot;)
<abbr title="  71  public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implements DynamicEntityRetriever {">  71  public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implements DynaðŸ”µ</abbr>
  72  
  73      private final Log LOG = LogFactory.getLog(StructuredContentTypeCustomPersistenceHandler.class);
  74  
  75      @Resource(name=&quot;blStructuredContentService&quot;)
  76      protected StructuredContentService structuredContentService;
  77  
  78      @Resource(name = &quot;blDynamicFieldPersistenceHandlerHelper&quot;)
  79      protected DynamicFieldPersistenceHandlerHelper dynamicFieldUtil;
  80  
  81      @PersistenceContext(unitName=&quot;blPU&quot;)
  82      protected EntityManager em;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -    @Resource(name = &quot;blAdminEntityService&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -    protected AdminEntityService service;</span>
  86  
  87      @Override
  88      public Boolean canHandleFetch(PersistencePackage persistencePackage) {
<abbr title="  89          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();">  89          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
  90          return
  91              StructuredContentType.class.getName().equals(ceilingEntityFullyQualifiedClassname) &amp;&amp;
  92              persistencePackage.getCustomCriteria() != null &amp;&amp;
  93              persistencePackage.getCustomCriteria().length &gt; 0 &amp;&amp;
  94              persistencePackage.getCustomCriteria()[0].equals(&quot;constructForm&quot;);
  95      }
  96  
  97      @Override
  98      public Boolean canHandleAdd(PersistencePackage persistencePackage) {
  99          return canHandleFetch(persistencePackage);
 100      }
 101  
 102      @Override
 103      public Boolean canHandleInspect(PersistencePackage persistencePackage) {
 104          return canHandleFetch(persistencePackage);
 105      }
 106  
 107      @Override
 108      public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 109          return false;
 110      }
 111  
 112      @Override
 113      public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 114          return canHandleFetch(persistencePackage);
 115      }
 116  
 117      @Override
<abbr title=" 118      public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 118      public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspðŸ”µ</abbr>
<abbr title=" 119          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 119          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
 120          try {
 121              String structuredContentTypeId = persistencePackage.getCustomCriteria()[3];
<abbr title=" 122              StructuredContentType structuredContentType = structuredContentService.findStructuredContentTypeById(Long.valueOf(structuredContentTypeId));"> 122              StructuredContentType structuredContentType = structuredContentService.findStructuredContentTypeById(LðŸ”µ</abbr>
 123              ClassMetadata metadata = new ClassMetadata();
 124              metadata.setCeilingType(StructuredContentType.class.getName());
 125              ClassTree entities = new ClassTree(StructuredContentTypeImpl.class.getName());
 126              metadata.setPolymorphicEntities(entities);
<abbr title=" 127              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentTypeImpl.class);"> 127              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStructuredCðŸ”µ</abbr>
 128              metadata.setProperties(properties);
 129              DynamicResultSet results = new DynamicResultSet(metadata);
 130  
 131              return results;
 132          } catch (Exception e) {
<abbr title=" 133              throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 133              throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiedClassnaðŸ”µ</abbr>
 134          }
 135      }
 136  
 137  
 138      @Override
<abbr title=" 139      public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 139      public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityðŸ”µ</abbr>
<abbr title=" 140          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 140          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
 141          try {
 142              String structuredContentId = persistencePackage.getCustomCriteria()[1];
 143              Entity entity = fetchEntityBasedOnId(structuredContentId, null);
 144              DynamicResultSet results = new DynamicResultSet(new Entity[]{entity}, 1);
 145  
 146              return results;
 147          } catch (Exception e) {
<abbr title=" 148              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 148              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassnameðŸ”µ</abbr>
 149          }
 150      }
 151  
 152      @Override
 153      public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws Exception {
<abbr title=" 154          StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 154          StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(struðŸ”µ</abbr>
 155          //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUpdate()
 156          em.refresh(structuredContent);
 157          return fetchDynamicEntity(structuredContent, dirtyFields, true);
 158      }
 159  
 160      @Override
 161      public String getFieldContainerClassName() {
 162          return StructuredContent.class.getName();
 163      }
 164  
 165      @Override
<abbr title=" 166      public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throws Exception {"> 166      public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throws ExceptðŸ”µ</abbr>
 167          StructuredContent structuredContent = (StructuredContent) root;
<abbr title=" 168          Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructuredContentFieldXrefs();"> 168          Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructuredContentðŸ”µ</abbr>
 169          Entity entity = new Entity();
 170          entity.setType(new String[]{StructuredContentType.class.getName()});
 171          List&lt;Property&gt; propertiesList = new ArrayList&lt;Property&gt;();
<abbr title=" 172          for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 172          for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieldTemplatðŸ”µ</abbr>
 173              for (FieldDefinition def : fieldGroup.getFieldDefinitions()) {
 174                  Property property = new Property();
 175                  property.setName(def.getName());
 176                  String value = null;
 177                  if (!MapUtils.isEmpty(structuredContentFieldMap)) {
<abbr title=" 178                      StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.get(def.getName());"> 178                      StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.get(def.getNðŸ”µ</abbr>
 179                      if (structuredContentFieldXref != null) {
<abbr title=" 180                          StructuredContentField structuredContentField = structuredContentFieldXref.getStructuredContentField();"> 180                          StructuredContentField structuredContentField = structuredContentFieldXref.getStructuredCoðŸ”µ</abbr>
 181                          if (structuredContentField != null) {
 182                              value = structuredContentField.getValue();
 183                          }
 184                      }
 185                  }
 186                  property.setValue(value);
 187                  if (!CollectionUtils.isEmpty(dirtyFields) &amp;&amp; dirtyFields.contains(property.getName())) {
 188                      property.setIsDirty(true);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 191 -                if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; StringUtils.isNotEmpty(value)) {"> 191 -                if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; StringUtils.isNotEmptyðŸ”µ</abbr></span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -                    // we need to look up the display value</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -                    String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), value);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -                    property.setDisplayValue(display);</span>
 195                  }
 196                  propertiesList.add(property);
 197              }
 198          }
 199          if (includeId) {
 200              Property property = new Property();
 201              propertiesList.add(property);
 202              property.setName(&quot;id&quot;);
 203              property.setValue(String.valueOf(structuredContent.getId()));
 204          }
 205  
 206          entity.setProperties(propertiesList.toArray(new Property[]{}));
 207  
 208          return entity;
 209      }
 210  
 211      /**
<abbr title=" 212       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 212       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured coðŸ”µ</abbr>
 213       */
 214      @Override
<abbr title=" 215      public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 215      public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper heðŸ”µ</abbr>
 216          return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 217      }
 218  
 219      /**
<abbr title=" 220       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 220       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured coðŸ”µ</abbr>
 221       */
 222      @Override
<abbr title=" 223      public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 223      public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helpeðŸ”µ</abbr>
 224          return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 225      }
 226  
<abbr title=" 227      protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 227      protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHðŸ”µ</abbr>
<abbr title=" 228          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 228          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
 229          try {
 230              String structuredContentId = persistencePackage.getCustomCriteria()[1];
<abbr title=" 231              StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 231              StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(ðŸ”µ</abbr>
 232  
<abbr title=" 233              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentType.class);"> 233              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructuredConteðŸ”µ</abbr>
 234              Map&lt;String, FieldMetadata&gt; md = new HashMap&lt;String, FieldMetadata&gt;();
 235              for (Property property : properties) {
 236                  md.put(property.getName(), property.getMetadata());
 237              }
 238  
<abbr title=" 239              boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeImpl(), md);"> 239              boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeImpl(), mðŸ”µ</abbr>
 240              if (!validated) {
<abbr title=" 241                  throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamic fields failed validation&quot;);"> 241                  throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamic fields fðŸ”µ</abbr>
 242              }
 243  
 244              List&lt;String&gt; templateFieldNames = new ArrayList&lt;String&gt;(20);
<abbr title=" 245              for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 245              for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFieldTemplateðŸ”µ</abbr>
 246                  for (FieldDefinition def : group.getFieldDefinitions()) {
 247                      templateFieldNames.add(def.getName());
 248                  }
 249              }
 250              Map&lt;String, String&gt; dirtyFieldsOrigVals = new HashMap&lt;String, String&gt;();
 251              List&lt;String&gt; dirtyFields = new ArrayList&lt;String&gt;();
 252              Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap =
 253                      structuredContent.getStructuredContentFieldXrefs();
 254              for (Property property : persistencePackage.getEntity().getProperties()) {
 255                  if (property.getEnabled() &amp;&amp; templateFieldNames.contains(property.getName())) {
 256                      StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName());
 257                      if (scXref != null &amp;&amp; scXref.getStructuredContentField() != null) {
 258                          StructuredContentField structuredContentField = scXref.getStructuredContentField();
<abbr title=" 259                          boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValue() != null) ||"> 259                          boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValue() != nulðŸ”µ</abbr>
 260                                  (structuredContentField.getValue() != null &amp;&amp; property.getValue() == null);
<abbr title=" 261                          if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() != null &amp;&amp;"> 261                          if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() != null &amp;ðŸ”µ</abbr>
 262                                  !structuredContentField.getValue().trim().equals(property.getValue().trim()))) {
 263                              dirtyFields.add(property.getName());
 264                              dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue());
 265                              structuredContentField.setValue(property.getValue());
 266                              scXref = dynamicEntityDao.merge(scXref);
 267                          }
 268                      } else {
 269                          StructuredContentField structuredContentField = new StructuredContentFieldImpl();
 270                          structuredContentField.setFieldKey(property.getName());
 271                          structuredContentField.setValue(property.getValue());
 272  
 273                          StructuredContentFieldXref scfx = new StructuredContentFieldXrefImpl();
 274                          scfx.setStructuredContent(structuredContent);
 275                          scfx.setKey(property.getName());
 276                          scfx.setStrucuturedContentField(structuredContentField);
 277  
 278                          scfx = dynamicEntityDao.persist(scfx);
 279                          dirtyFields.add(property.getName());
 280                      }
 281                  }
 282              }
 283              List&lt;String&gt; removeItems = new ArrayList&lt;String&gt;();
 284              for (String key : structuredContentFieldMap.keySet()) {
 285                  if (persistencePackage.getEntity().findProperty(key)==null) {
 286                      removeItems.add(key);
 287                  }
 288              }
 289              if (removeItems.size() &gt; 0) {
 290                  for (String removeKey : removeItems) {
 291                      structuredContentFieldMap.remove(removeKey);
 292                  }
 293              }
 294  
 295              Collections.sort(dirtyFields);
 296              Entity entity = fetchEntityBasedOnId(structuredContentId, dirtyFields);
 297  
 298              for (Entry&lt;String, String&gt; entry : dirtyFieldsOrigVals.entrySet()) {
 299                  entity.getPMap().get(entry.getKey()).setOriginalValue(entry.getValue());
 300                  entity.getPMap().get(entry.getKey()).setOriginalDisplayValue(entry.getValue());
 301              }
 302  
 303              return entity;
 304          } catch (ValidationException e) {
 305              throw e;
 306          } catch (Exception e) {
<abbr title=" 307              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 307              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassnameðŸ”µ</abbr>
 308          }
 309      }
 310  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            