<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>123</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    123
                    <a href="122.html">prev</a>
                    <a href="124.html">next</a>
                    <a href="123_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_89e275c67fd74f0edf3ff03711c8c7a4a9610791_core/broadleaf-framework/src/test/java/org/broadleafcommerce/core/offer/service/processor/ItemOfferProcessorTest.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791:core/broadleaf-framework/src/test/java/org/broadleafcommerce/core/offer/service/processor/ItemOfferProcessorTest.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791^1:core/broadleaf-framework/src/test/java/org/broadleafcommerce/core/offer/service/processor/ItemOfferProcessorTest.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791^2:core/broadleaf-framework/src/test/java/org/broadleafcommerce/core/offer/service/processor/ItemOfferProcessorTest.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;a48cd6ca647e4a58cde4097171bd233ed3e8511d:core/broadleaf-framework/src/test/java/org/broadleafcommerce/core/offer/service/processor/ItemOfferProcessorTest.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [sbj], [bj]], subset: [[b], [sbj], [bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service.processor;
  19 
  20 import junit.framework.TestCase;
  21 
  22 import org.broadleafcommerce.common.money.Money;
  23 import org.broadleafcommerce.common.service.GenericEntityService;
  24 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  25 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  26 import org.broadleafcommerce.core.offer.dao.OfferDao;
  27 import org.broadleafcommerce.core.offer.domain.CandidateItemOffer;
  28 import org.broadleafcommerce.core.offer.domain.CandidateItemOfferImpl;
  29 import org.broadleafcommerce.core.offer.domain.Offer;
  30 import org.broadleafcommerce.core.offer.domain.OfferImpl;
  31 import org.broadleafcommerce.core.offer.domain.OfferQualifyingCriteriaXref;
  32 import org.broadleafcommerce.core.offer.domain.OfferTargetCriteriaXref;
  33 import org.broadleafcommerce.core.offer.domain.OrderItemAdjustment;
  34 import org.broadleafcommerce.core.offer.domain.OrderItemAdjustmentImpl;
  35 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  36 import org.broadleafcommerce.core.offer.service.OfferDataItemProvider;
  37 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  38 import org.broadleafcommerce.core.offer.service.OfferServiceUtilitiesImpl;
  39 import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  40 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactoryImpl;
  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;
  43 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtilityImpl;
  44 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  45 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  46 import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  47 import org.broadleafcommerce.core.offer.service.type.OfferItemRestrictionRuleType;
  48 import org.broadleafcommerce.core.order.dao.FulfillmentGroupItemDao;
  49 import org.broadleafcommerce.core.order.dao.OrderItemDao;
  50 import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;
  51 import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  52 import org.broadleafcommerce.core.order.domain.Order;
  53 import org.broadleafcommerce.core.order.domain.OrderItem;
  54 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  55 import org.broadleafcommerce.core.order.domain.OrderMultishipOption;
  56 import org.broadleafcommerce.core.order.service.FulfillmentGroupService;
  57 import org.broadleafcommerce.core.order.service.OrderItemService;
  58 import org.broadleafcommerce.core.order.service.OrderMultishipOptionService;
  59 import org.broadleafcommerce.core.order.service.OrderService;
  60 import org.broadleafcommerce.core.order.service.call.FulfillmentGroupItemRequest;
  61 import org.easymock.EasyMock;
  62 import org.easymock.IAnswer;
  63 import java.util.ArrayList;
  64 import java.util.List;
  65 import java.util.TimeZone;
  66 
  67 /**
  68  * 
  69  * @author jfischer
  70  *
  71  */
  72 public class ItemOfferProcessorTest extends TestCase {
  73 
  74     protected OfferDao offerDaoMock;
  75     protected OrderItemDao orderItemDaoMock;
  76     protected OrderService orderServiceMock;
  77     protected OfferServiceImpl offerService;
  78     protected OrderItemService orderItemServiceMock;
  79     protected FulfillmentGroupItemDao fgItemDaoMock;
  80     protected OfferDataItemProvider dataProvider = new OfferDataItemProvider();
  81     protected FulfillmentGroupService fgServiceMock;
  82     protected OrderMultishipOptionService multishipOptionServiceMock;
  83     protected OfferTimeZoneProcessor offerTimeZoneProcessorMock;
  84 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85     protected PromotableOfferUtility promotableOfferUtility;</span>
  86 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87     protected ItemOfferProcessorImpl itemProcessor;</span>
  88 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89     protected GenericEntityService genericEntityServiceMock;</span>
  90 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  91 
  92     protected ItemOfferProcessorImpl itemProcessor;
  93 
  94     @Override
  95     protected void setUp() throws Exception {
  96 
  97         CustomerOfferDao customerOfferDaoMock = EasyMock.createMock(CustomerOfferDao.class);
  98         OfferCodeDao offerCodeDaoMock = EasyMock.createMock(OfferCodeDao.class);
  99         offerDaoMock = EasyMock.createMock(OfferDao.class);
 100         orderItemDaoMock = EasyMock.createMock(OrderItemDao.class);
 101         orderServiceMock = EasyMock.createMock(OrderService.class);
 102         orderItemServiceMock = EasyMock.createMock(OrderItemService.class);
 103         fgItemDaoMock = EasyMock.createMock(FulfillmentGroupItemDao.class);
 104         fgServiceMock = EasyMock.createMock(FulfillmentGroupService.class);
 105         multishipOptionServiceMock = EasyMock.createMock(OrderMultishipOptionService.class);
 106         offerTimeZoneProcessorMock = EasyMock.createMock(OfferTimeZoneProcessor.class);
 107 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108         promotableOfferUtility = new PromotableOfferUtilityImpl();</span>
 109 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         offerServiceUtilities.setOfferDao(offerDaoMock);</span>
 111 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112         genericEntityServiceMock = EasyMock.createMock(GenericEntityService.class);</span>
 113 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 114 
 115 
<abbr title=" 116         OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl(promotableOfferUtility);"> 116         OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl(promotableOfferUtðŸ”µ</abbr>
 117         offerServiceUtilities.setOfferDao(offerDaoMock);
 118 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 119         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));"> 119         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtiliðŸ”µ</abbr></span>
 120 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121         itemProcessor.setOfferDao(offerDaoMock);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122         itemProcessor.setOrderItemDao(orderItemDaoMock);</span>
 123 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125         offerServiceUtilities.setGenericEntityService(genericEntityServiceMock);</span>
 126 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 127 
 128         itemProcessor = new ItemOfferProcessorImpl(promotableOfferUtility);
 129         itemProcessor.setOfferDao(offerDaoMock);
 130         itemProcessor.setOrderItemDao(orderItemDaoMock);
 131         itemProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
 132         itemProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 133         itemProcessor.setOfferServiceUtilities(offerServiceUtilities);
 134 
 135         offerService = new OfferServiceImpl();
 136 
 137         OrderOfferProcessorImpl orderProcessor = new OrderOfferProcessorImpl(promotableOfferUtility);
 138         orderProcessor.setOfferDao(offerDaoMock);
 139         orderProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 140         orderProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
 141         orderProcessor.setOrderItemDao(orderItemDaoMock);
 142         orderProcessor.setOfferServiceUtilities(offerServiceUtilities);
 143 
 144         offerService.setCustomerOfferDao(customerOfferDaoMock);
 145         offerService.setOfferCodeDao(offerCodeDaoMock);
 146         offerService.setOfferDao(offerDaoMock);
 147         offerService.setOrderOfferProcessor(orderProcessor);
 148         offerService.setItemOfferProcessor(itemProcessor);
 149         offerService.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 150         offerService.setOrderService(orderServiceMock);
 151     }
 152 
 153     public void replay() throws Exception {
<abbr title=" 154         EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAnswer()).anyTimes();"> 154         EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.geðŸ”µ</abbr>
<abbr title=" 155         EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCreateOrderItemQualifierAnswer()).anyTimes();"> 155         EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCðŸ”µ</abbr>
<abbr title=" 156         EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAdjustmentAnswer()).anyTimes();"> 156         EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProviðŸ”µ</abbr>
 157 
<abbr title=" 158         EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getAddItemToFulfillmentGroupAnswer()).anyTimes();"> 158         EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.ðŸ”µ</abbr>
<abbr title=" 159         EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getRemoveItemFromOrderAnswer()).anyTimes();"> 159         EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EðŸ”µ</abbr>
<abbr title=" 160         EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).andAnswer(OfferDataItemProvider.getSaveOrderAnswer()).anyTimes();"> 160         EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).anðŸ”µ</abbr>
 161 
 162         EasyMock.expect(orderServiceMock.getAutomaticallyMergeLikeItems()).andReturn(true).anyTimes();
 163 
<abbr title=" 164         EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OfferDataItemProvider.getSaveOrderItemAnswer()).anyTimes();"> 164         EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OffeðŸ”µ</abbr>
<abbr title=" 165         EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataItemProvider.getSaveFulfillmentGroupItemAnswer()).anyTimes();"> 165         EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataðŸ”µ</abbr>
 166 
<abbr title=" 167         EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;List&lt;OrderMultishipOption&gt;&gt;() {"> 167         EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).aðŸ”µ</abbr>
 168 
 169             @Override
 170             public List&lt;OrderMultishipOption&gt; answer() throws Throwable {
 171                 return new ArrayList&lt;OrderMultishipOption&gt;();
 172             }
 173         }).anyTimes();
 174 
 175         multishipOptionServiceMock.deleteAllOrderMultishipOptions(EasyMock.isA(Order.class));
 176         EasyMock.expectLastCall().anyTimes();
<abbr title=" 177         EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getSameOrderAnswer()).anyTimes();"> 177         EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EðŸ”µ</abbr>
<abbr title=" 178         EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupItemAnswer()).anyTimes();"> 178         EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupðŸ”µ</abbr>
 179         fgItemDaoMock.delete(EasyMock.isA(FulfillmentGroupItem.class));
 180         EasyMock.expectLastCall().anyTimes();
<abbr title=" 181         EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(TimeZone.getTimeZone(&quot;CST&quot;)).anyTimes();"> 181         EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(ðŸ”µ</abbr>
 182 
 183         EasyMock.replay(offerDaoMock);
 184         EasyMock.replay(orderItemDaoMock);
 185         EasyMock.replay(orderServiceMock);
 186         EasyMock.replay(orderItemServiceMock);
 187         EasyMock.replay(fgItemDaoMock);
 188         EasyMock.replay(fgServiceMock);
 189         EasyMock.replay(multishipOptionServiceMock);
 190         EasyMock.replay(offerTimeZoneProcessorMock);
 191     }
 192 
 193     public void verify() {
 194         EasyMock.verify(offerDaoMock);
 195         EasyMock.verify(orderItemDaoMock);
 196         EasyMock.verify(orderServiceMock);
 197         EasyMock.verify(orderItemServiceMock);
 198         EasyMock.verify(fgItemDaoMock);
 199         EasyMock.verify(fgServiceMock);
 200         EasyMock.verify(multishipOptionServiceMock);
 201         EasyMock.verify(offerTimeZoneProcessorMock);
 202     }
 203 
 204     public void testFilterItemLevelOffer() throws Exception {
 205         replay();
 206 
<abbr title=" 207         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 207         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;(ðŸ”µ</abbr>
 208         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 209             &quot;order.subTotal.getAmount()&gt;20&quot;,
 210                 OfferDiscountType.PERCENT_OFF,
 211             null,
 212             null
 213         );
 214 
 215         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 216         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 217 
 218         //test that the valid order item offer is included - legacy format - no qualifier
 219         //since there&#x27;s no qualifier, both items can apply
 220         // This line is commented out because we are no longer creating legacy offers.
<abbr title=" 221         //assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offers.get(0)));"> 221         //assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0ðŸ”µ</abbr>
 222 
 223         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 224         offers = dataProvider.createItemBasedOfferWithItemCriteria(
 225             &quot;order.subTotal.getAmount()&gt;20&quot;,
 226             OfferDiscountType.PERCENT_OFF,
<abbr title=" 227             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 227             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 228             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 228             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 229         );
 230         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 231 
 232         //test that the valid order item offer is included
<abbr title=" 233         //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be only one qualifier in the qualifiers map"> 233         //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be ðŸ”µ</abbr>
 234         //we don&#x27;t know the targets yet, so there&#x27;s only one CandidateItemOffer for now
<abbr title=" 235         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1);"> 235         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0))ðŸ”µ</abbr>
 236 
 237         // Add a subtotal requirement that will be met by the item offer.
 238         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 239         offers = dataProvider.createItemBasedOfferWithItemCriteria(
 240             &quot;order.subTotal.getAmount()&gt;20&quot;,
 241             OfferDiscountType.PERCENT_OFF,
<abbr title=" 242             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 242             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 243             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 243             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 244         );
 245 
 246         offers.get(0).setQualifyingItemSubTotal(new Money(1));
 247         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 248 
 249         //test that the valid order item offer is included
<abbr title=" 250         //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be only one qualifier in the qualifiers map"> 250         //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be ðŸ”µ</abbr>
 251         //we don&#x27;t know the targets yet, so there&#x27;s only one CandidateItemOffer for now
<abbr title=" 252         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1);"> 252         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0))ðŸ”µ</abbr>
 253 
 254 
 255         // Add a subtotal requirement that will not be met by the item offer.
 256         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 257         offers = dataProvider.createItemBasedOfferWithItemCriteria(
 258             &quot;order.subTotal.getAmount()&gt;20&quot;,
 259             OfferDiscountType.PERCENT_OFF,
<abbr title=" 260             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 260             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 261             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 261             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 262         );
 263 
 264         offers.get(0).setQualifyingItemSubTotal(new Money(99999));
 265         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 266 
 267         // Since the item qualification subTotal is not met, the qualified offer size should
 268         // be zero.
 269         assertTrue(qualifiedOffers.size() == 0);
 270 
 271 
 272         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 273         offers = dataProvider.createItemBasedOfferWithItemCriteria(
 274             &quot;order.subTotal.getAmount()&gt;20&quot;,
 275             OfferDiscountType.PERCENT_OFF,
<abbr title=" 276             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 276             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 277             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 277             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MðŸ”µ</abbr>
 278         );
 279         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 280 
 281         //test that the invalid order item offer is excluded
 282         assertTrue(qualifiedOffers.size() == 0);
 283 
 284         verify();
 285     }
 286 
 287     public void testCouldOfferApplyToOrder() throws Exception {
 288         replay();
 289 
 290         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 291         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 292             &quot;order.subTotal.getAmount()&gt;20&quot;,
 293             OfferDiscountType.PERCENT_OFF,
 294             null,
 295             null
 296         );
 297 
<abbr title=" 298         boolean couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrderItems().get(0), order.getFulfillmentGroups().get(0));"> 298         boolean couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountðŸ”µ</abbr>
 299         //test that the valid order item offer is included
 300         assertTrue(couldApply);
 301 
 302         offers = dataProvider.createItemBasedOfferWithItemCriteria(
 303             &quot;order.subTotal.getAmount()==0&quot;,
 304             OfferDiscountType.PERCENT_OFF,
 305             null,
 306             null
 307         );
<abbr title=" 308         couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrderItems().get(0), order.getFulfillmentGroups().get(0));"> 308         couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrdeðŸ”µ</abbr>
 309         //test that the invalid order item offer is excluded
 310         assertFalse(couldApply);
 311 
 312         verify();
 313     }
 314 
 315     public void testCouldOrderItemMeetOfferRequirement() throws Exception {
 316         replay();
 317 
 318         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 319         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 320             &quot;order.subTotal.getAmount()&gt;20&quot;,
 321             OfferDiscountType.PERCENT_OFF,
<abbr title=" 322             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 322             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 323             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 323             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 324         );
 325 
<abbr title=" 326         OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();"> 326         OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next(ðŸ”µ</abbr>
<abbr title=" 327         boolean couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 327         boolean couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria()ðŸ”µ</abbr>
 328         //test that the valid order item offer is included
 329         assertTrue(couldApply);
 330 
 331         offers = dataProvider.createItemBasedOfferWithItemCriteria(
 332             &quot;order.subTotal.getAmount()&gt;20&quot;,
 333             OfferDiscountType.PERCENT_OFF,
<abbr title=" 334             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 334             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 335             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 335             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MðŸ”µ</abbr>
 336         );
 337         xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();
<abbr title=" 338         couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 338         couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.ðŸ”µ</abbr>
 339         //test that the invalid order item offer is excluded
 340         assertFalse(couldApply);
 341 
 342         verify();
 343     }
 344 
 345     public void testCouldOfferApplyToOrderItems() throws Exception {
 346         replay();
 347 
 348         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 349         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 350             &quot;order.subTotal.getAmount()&gt;20&quot;,
 351             OfferDiscountType.PERCENT_OFF,
<abbr title=" 352             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 352             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 353             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 353             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 354         );
 355         List&lt;PromotableOrderItem&gt; orderItems = new ArrayList&lt;PromotableOrderItem&gt;();
 356         for (PromotableOrderItem orderItem : order.getDiscountableOrderItems()) {
 357             orderItems.add(orderItem);
 358         }
<abbr title=" 359         CandidatePromotionItems candidates = itemProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);"> 359         CandidatePromotionItems candidates = itemProcessor.couldOfferApplyToOrderItems(offers.get(0), ordðŸ”µ</abbr>
 360         //test that the valid order item offer is included
 361         //both cart items are valid for qualification and target
<abbr title=" 362         assertTrue(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1 &amp;&amp;"> 362         assertTrue(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1 ðŸ”µ</abbr>
 363                 candidates.getCandidateQualifiersMap().values().iterator().next().size() == 2 &amp;&amp;
 364                 candidates.isMatchedTarget() &amp;&amp; candidates.getCandidateTargetsMap().size() == 1 &amp;&amp;
 365                 candidates.getCandidateTargetsMap().values().iterator().next().size() == 2);
 366 
 367         offers = dataProvider.createItemBasedOfferWithItemCriteria(
 368             &quot;order.subTotal.getAmount()&gt;20&quot;,
 369             OfferDiscountType.PERCENT_OFF,
<abbr title=" 370             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 370             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 371             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 371             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MðŸ”µ</abbr>
 372         );
 373         candidates = itemProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);
 374         //test that the invalid order item offer is excluded because there are no qualifying items
<abbr title=" 375         assertFalse(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1);"> 375         assertFalse(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1ðŸ”µ</abbr>
 376 
 377         verify();
 378     }
 379 
 380     private int checkOrderItemOfferAppliedCount(Order order) {
 381         int count = 0;
 382         for (OrderItem item : order.getOrderItems()) {
 383             for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 384                 count = count + (detail.getOrderItemPriceDetailAdjustments().size() * detail.getQuantity());"> 384                 count = count + (detail.getOrderItemPriceDetailAdjustments().size() * detail.getQuantity(ðŸ”µ</abbr>
 385             }
 386         }
 387         return count;
 388     }
 389 
 390     private int checkOrderItemOfferAppliedQuantity(Order order, Offer offer) {
 391         int count = 0;
 392         for (OrderItem item : order.getOrderItems()) {
 393             for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 394                 for (OrderItemPriceDetailAdjustment adjustment : detail.getOrderItemPriceDetailAdjustments()) {"> 394                 for (OrderItemPriceDetailAdjustment adjustment : detail.getOrderItemPriceDetailAdjustmentðŸ”µ</abbr>
 395                     if (adjustment.getOffer().getId().equals(offer.getId())) {
 396                         count += detail.getQuantity();
 397                     }
 398                 }
 399             }
 400         }
 401         return count;
 402     }
 403 
 404     private int countPriceDetails(Order order) {
 405         int count = 0;
 406         for (OrderItem item : order.getOrderItems()) {
 407             count = count + item.getOrderItemPriceDetails().size();
 408         }
 409         return count;
 410     }
 411 
 412 
 413     public void testApplyAllItemOffers() throws Exception {
 414 
 415 
 416         replay();
 417 
 418         Order order = dataProvider.createBasicOrder();
 419 
 420         Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(
 421             &quot;order.subTotal.getAmount()&gt;20&quot;,
 422             OfferDiscountType.PERCENT_OFF,
<abbr title=" 423             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 423             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 424             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 424             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 425         ).get(0);
 426         offer1.setId(1L);
 427 
 428         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 429         offers.add(offer1);
 430 
<abbr title=" 431         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 431         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;(ðŸ”µ</abbr>
 432         order.updatePrices();
 433         offerService.applyAndSaveOffersToOrder(offers, order);
 434 
 435         assertTrue(order.getTotalAdjustmentsValue().getAmount().doubleValue() &gt; 0);
 436 
 437         order = dataProvider.createBasicOrder();
 438 
 439         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 440         offer1.setApplyDiscountToSalePrice(false);
 441         ((DiscreteOrderItem) order.getOrderItems().get(0)).getSku().setSalePrice(new Money(1D));
 442         ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(new Money(1D));
 443         order.updatePrices();
 444         offerService.applyAndSaveOffersToOrder(offers, order);
 445 
 446         assertTrue(order.getTotalAdjustmentsValue().getAmount().doubleValue() == 0);
 447 
 448         verify();
 449     }
 450 
 451     public void testApplyAdjustments() throws Exception {
 452         replay();
 453 
 454         Order order = dataProvider.createBasicOrder();
 455 
 456         Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(
 457             &quot;order.subTotal.getAmount()&gt;20&quot;,
 458             OfferDiscountType.PERCENT_OFF,
<abbr title=" 459             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 459             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 460             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 460             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 461         ).get(0);
 462         offer1.setId(1L);
 463         OfferQualifyingCriteriaXref xref = offer1.getQualifyingItemCriteriaXref().iterator().next();
 464         xref.getOfferItemCriteria().setQuantity(2);
 465         offer1.setCombinableWithOtherOffers(false);
 466         Offer offer2 = dataProvider.createItemBasedOfferWithItemCriteria(
 467             &quot;order.subTotal.getAmount()&gt;20&quot;,
 468             OfferDiscountType.PERCENT_OFF,
<abbr title=" 469             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 469             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 470             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 470             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 471         ).get(0);
 472         offer2.setId(2L);
 473 
 474         List&lt;Offer&gt; offerListWithOneOffer = new ArrayList&lt;Offer&gt;();
 475         offerListWithOneOffer.add(offer1);
 476 
 477         List&lt;Offer&gt; offerListWithTwoOffers = new ArrayList&lt;Offer&gt;();
 478         offerListWithTwoOffers.add(offer1);
 479         offerListWithTwoOffers.add(offer2);
 480         
 481         order.updatePrices();
 482         offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 483         assertTrue(checkOrderItemOfferAppliedCount(order) == 1);
 484         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 1);
 485 
 486         // Add the second offer.   The first was nonCombinable so it should still be 1
 487         order = dataProvider.createBasicOrder();
 488         order.updatePrices();
 489         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 490         assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 491         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 492         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 493 
 494 
 495         // Reset offer1 to combinable.   Now both should be applied.
 496         offer1.setCombinableWithOtherOffers(true);
 497         order = dataProvider.createBasicOrder();
 498         order.updatePrices();
 499         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 500         assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 501         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 502         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 503 
 504         // Offer 1 back to nonCombinable but don&#x27;t allow discount to the sale price
 505         // and make the sale price a better overall offer
 506         offer1.setCombinableWithOtherOffers(false);
 507         offer1.setApplyDiscountToSalePrice(false);
 508         order = dataProvider.createBasicOrder();
 509         ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(new Money(10D));
 510         order.updatePrices();
 511         offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 512         assertTrue(checkOrderItemOfferAppliedCount(order) == 0);
 513 
 514         // Try again with two offers.   The second should be applied.   
 515         order.updatePrices();
 516         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 517         assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 518 
 519         // Trying with 2nd offer as nonCombinable.
 520         offer1.setCombinableWithOtherOffers(true);
 521         ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(null);
 522         offer2.setCombinableWithOtherOffers(false);
 523 
 524         order.updatePrices();
 525         offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 526         assertTrue(checkOrderItemOfferAppliedCount(order) == 1);
 527 
 528         order.updatePrices();
 529         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 530         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 531         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 532 
 533         // Set qualifying criteria quantity to 1
 534         // Set qualifying target criteria to 2 
 535         order = dataProvider.createBasicOrder();
 536         xref = offer1.getQualifyingItemCriteriaXref().iterator().next();
 537         xref.getOfferItemCriteria().setQuantity(1);
 538 
 539         OfferTargetCriteriaXref targetXref = offer1.getTargetItemCriteriaXref().iterator().next();
 540         targetXref.getOfferItemCriteria().setQuantity(2);
 541         order.updatePrices();
 542         offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 543         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 2);
 544 
 545         // Reset both offers to combinable and the qualifiers as allowing duplicate QUALIFIERs
 546         // and Targets
 547         offer1.setCombinableWithOtherOffers(true);
 548         offer2.setCombinableWithOtherOffers(true);
 549         offer1.setOfferItemQualifierRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 550         offer1.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 551         offer2.setOfferItemQualifierRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 552         offer2.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 553         order = dataProvider.createBasicOrder();
 554         order.updatePrices();
 555         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 556         assertTrue(checkOrderItemOfferAppliedCount(order) == 4);
 557         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 558         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 2);
 559 
 560         verify();
 561     }
 562 
 563     public void testApplyItemQualifiersAndTargets() throws Exception {
 564         replay();
 565 
<abbr title=" 566         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 566         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;(ðŸ”µ</abbr>
 567         Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(
 568             &quot;order.subTotal.getAmount()&gt;20&quot;,
 569             OfferDiscountType.PERCENT_OFF,
<abbr title=" 570             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 570             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 571             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 571             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 572         ).get(0);
 573         offer1.setId(1L);
 574         Offer offer2 = dataProvider.createItemBasedOfferWithItemCriteria(
 575             &quot;order.subTotal.getAmount()&gt;20&quot;,
 576             OfferDiscountType.PERCENT_OFF,
<abbr title=" 577             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 577             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 578             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 578             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 579         ).get(0);
 580         offer2.setId(2L);
 581 
 582         OfferTargetCriteriaXref targetXref = offer2.getTargetItemCriteriaXref().iterator().next();
 583         targetXref.getOfferItemCriteria().setQuantity(4);
 584         offer2.getQualifyingItemCriteriaXref().clear();
 585         offer2.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.TARGET);
 586         Offer offer3 = dataProvider.createItemBasedOfferWithItemCriteria(
 587             &quot;order.subTotal.getAmount()&gt;20&quot;,
 588             OfferDiscountType.PERCENT_OFF,
<abbr title=" 589             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 589             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 590             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 590             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 591         ).get(0);
 592 
<abbr title=" 593         PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility);"> 593         PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility)ðŸ”µ</abbr>
 594         itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer1);
<abbr title=" 595         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offer1) &amp;&amp; qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1);"> 595         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offer1) &amp;&amp; quaðŸ”µ</abbr>
 596 
 597         itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer2);
<abbr title=" 598         assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offer2) &amp;&amp; qualifiedOffers.get(1).getCandidateQualifiersMap().size() == 0);"> 598         assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offer2) &amp;&amp; quaðŸ”µ</abbr>
 599 
 600         itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer3);
<abbr title=" 601         assertTrue(qualifiedOffers.size() == 3 &amp;&amp; qualifiedOffers.get(2).getOffer().equals(offer3) &amp;&amp; qualifiedOffers.get(2).getCandidateQualifiersMap().size() == 1);"> 601         assertTrue(qualifiedOffers.size() == 3 &amp;&amp; qualifiedOffers.get(2).getOffer().equals(offer3) &amp;&amp; quaðŸ”µ</abbr>
 602 
<abbr title=" 603         // Try with just the second offer.   Expect to get 4 targets based on the offer having no qualifiers required"> 603         // Try with just the second offer.   Expect to get 4 targets based on the offer having no qualifiðŸ”µ</abbr>
 604         // and targeting category test1 or test2 and that the offer requires 4 target criteria.
 605         Order order = dataProvider.createBasicOrder();
 606         List&lt;Offer&gt; offerList = new ArrayList&lt;Offer&gt;();
 607         offerList.add(offer2);
 608         offerService.applyAndSaveOffersToOrder(offerList, order);
 609         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 4);
 610         assertTrue(countPriceDetails(order) == 3);
 611 
<abbr title=" 612         // Now try with both offers.   Since the targets can be reused, we expect to have 4 targets on offer2 "> 612         // Now try with both offers.   Since the targets can be reused, we expect to have 4 targets on ofðŸ”µ</abbr>
 613         // and 1 target on offer1
 614         order = dataProvider.createBasicOrder();
 615         offerList.add(offer1); // add in second offer (which happens to be offer1)
 616 
 617         offerService.applyAndSaveOffersToOrder(offerList, order);
 618         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 4);
 619         assertTrue(countPriceDetails(order) == 3);
 620 
 621         // All three offers - offer 3 is now higher priority so the best offer (offer 2) won&#x27;t be applied
 622         order = dataProvider.createBasicOrder();
 623         offerList.add(offer3); // add in second offer (which happens to be offer1)  
 624         offer3.setPriority(-1);
 625         offerService.applyAndSaveOffersToOrder(offerList, order);
 626         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer3) == 2);
 627         assertTrue(countPriceDetails(order) == 4);
 628 
 629         verify();
 630     }
 631 
 632     public class Answer implements IAnswer&lt;CandidateItemOffer&gt; {
 633 
 634         @Override
 635         public CandidateItemOffer answer() throws Throwable {
 636             return new CandidateItemOfferImpl();
 637         }
 638 
 639     }
 640 
 641     public class Answer2 implements IAnswer&lt;OrderItemAdjustment&gt; {
 642 
 643         @Override
 644         public OrderItemAdjustment answer() throws Throwable {
 645             return new OrderItemAdjustmentImpl();
 646         }
 647 
 648     }
 649 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service.processor;
  19 
  20 import org.broadleafcommerce.common.money.Money;
  21 import org.broadleafcommerce.common.service.GenericEntityService;
  22 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  23 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  24 import org.broadleafcommerce.core.offer.dao.OfferDao;
  25 import org.broadleafcommerce.core.offer.domain.CandidateItemOffer;
  26 import org.broadleafcommerce.core.offer.domain.CandidateItemOfferImpl;
  27 import org.broadleafcommerce.core.offer.domain.Offer;
  28 import org.broadleafcommerce.core.offer.domain.OfferImpl;
  29 import org.broadleafcommerce.core.offer.domain.OfferQualifyingCriteriaXref;
  30 import org.broadleafcommerce.core.offer.domain.OfferTargetCriteriaXref;
  31 import org.broadleafcommerce.core.offer.domain.OrderItemAdjustment;
  32 import org.broadleafcommerce.core.offer.domain.OrderItemAdjustmentImpl;
  33 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  34 import org.broadleafcommerce.core.offer.service.OfferDataItemProvider;
  35 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  36 import org.broadleafcommerce.core.offer.service.OfferServiceUtilitiesImpl;
  37 import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  38 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  39 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactoryImpl;
  40 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;
  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtilityImpl;
  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  43 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  44 import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  45 import org.broadleafcommerce.core.offer.service.type.OfferItemRestrictionRuleType;
  46 import org.broadleafcommerce.core.order.dao.FulfillmentGroupItemDao;
  47 import org.broadleafcommerce.core.order.dao.OrderItemDao;
  48 import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;
  49 import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  50 import org.broadleafcommerce.core.order.domain.Order;
  51 import org.broadleafcommerce.core.order.domain.OrderItem;
  52 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  53 import org.broadleafcommerce.core.order.domain.OrderMultishipOption;
  54 import org.broadleafcommerce.core.order.service.FulfillmentGroupService;
  55 import org.broadleafcommerce.core.order.service.OrderItemService;
  56 import org.broadleafcommerce.core.order.service.OrderMultishipOptionService;
  57 import org.broadleafcommerce.core.order.service.OrderService;
  58 import org.broadleafcommerce.core.order.service.call.FulfillmentGroupItemRequest;
  59 import org.easymock.EasyMock;
  60 import org.easymock.IAnswer;
  61 import java.util.ArrayList;
  62 import java.util.List;
  63 import java.util.TimeZone;
  64 
  65 import junit.framework.TestCase;
  66 
  67 /**
  68  *
  69  * @author jfischer
  70  *
  71  */
  72 public class ItemOfferProcessorTest extends TestCase {
  73 
  74     protected OfferDao offerDaoMock;
  75     protected OrderItemDao orderItemDaoMock;
  76     protected OrderService orderServiceMock;
  77     protected OfferServiceImpl offerService;
  78     protected OrderItemService orderItemServiceMock;
  79     protected FulfillmentGroupItemDao fgItemDaoMock;
  80     protected OfferDataItemProvider dataProvider = new OfferDataItemProvider();
  81     protected FulfillmentGroupService fgServiceMock;
  82     protected OrderMultishipOptionService multishipOptionServiceMock;
  83     protected OfferTimeZoneProcessor offerTimeZoneProcessorMock;
  84     protected PromotableOfferUtility promotableOfferUtility;
  85     protected GenericEntityService genericEntityServiceMock;
  86 
  87     protected ItemOfferProcessorImpl itemProcessor;
  88 
  89     @Override
  90     protected void setUp() throws Exception {
  91 
  92         CustomerOfferDao customerOfferDaoMock = EasyMock.createMock(CustomerOfferDao.class);
  93         OfferCodeDao offerCodeDaoMock = EasyMock.createMock(OfferCodeDao.class);
  94         offerDaoMock = EasyMock.createMock(OfferDao.class);
  95         orderItemDaoMock = EasyMock.createMock(OrderItemDao.class);
  96         orderServiceMock = EasyMock.createMock(OrderService.class);
  97         orderItemServiceMock = EasyMock.createMock(OrderItemService.class);
  98         fgItemDaoMock = EasyMock.createMock(FulfillmentGroupItemDao.class);
  99         fgServiceMock = EasyMock.createMock(FulfillmentGroupService.class);
 100         multishipOptionServiceMock = EasyMock.createMock(OrderMultishipOptionService.class);
 101         offerTimeZoneProcessorMock = EasyMock.createMock(OfferTimeZoneProcessor.class);
 102 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         promotableOfferUtility = new PromotableOfferUtilityImpl();</span>
 104 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105 </span>
 106 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107         genericEntityServiceMock = EasyMock.createMock(GenericEntityService.class);</span>
 108 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 109 
 110 
<abbr title=" 111         OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl(promotableOfferUtility);"> 111         OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl(promotableOfferUtðŸ”µ</abbr>
 112         offerServiceUtilities.setOfferDao(offerDaoMock);
 113 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 114         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));"> 114         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtiliðŸ”µ</abbr></span>
 115 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117         itemProcessor = new ItemOfferProcessorImpl();</span>
 118 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120         offerServiceUtilities.setGenericEntityService(genericEntityServiceMock);</span>
 121 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 122 
 123         itemProcessor = new ItemOfferProcessorImpl(promotableOfferUtility);
 124         itemProcessor.setOfferDao(offerDaoMock);
 125         itemProcessor.setOrderItemDao(orderItemDaoMock);
 126         itemProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
 127         itemProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 128         itemProcessor.setOfferServiceUtilities(offerServiceUtilities);
 129 
 130         offerService = new OfferServiceImpl();
 131 
 132         OrderOfferProcessorImpl orderProcessor = new OrderOfferProcessorImpl(promotableOfferUtility);
 133         orderProcessor.setOfferDao(offerDaoMock);
 134         orderProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 135         orderProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
 136         orderProcessor.setOrderItemDao(orderItemDaoMock);
 137         orderProcessor.setOfferServiceUtilities(offerServiceUtilities);
 138 
 139         offerService.setCustomerOfferDao(customerOfferDaoMock);
 140         offerService.setOfferCodeDao(offerCodeDaoMock);
 141         offerService.setOfferDao(offerDaoMock);
 142         offerService.setOrderOfferProcessor(orderProcessor);
 143         offerService.setItemOfferProcessor(itemProcessor);
 144         offerService.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 145         offerService.setOrderService(orderServiceMock);
 146     }
 147 
 148     public void replay() throws Exception {
<abbr title=" 149         EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAnswer()).anyTimes();"> 149         EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.geðŸ”µ</abbr>
<abbr title=" 150         EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCreateOrderItemQualifierAnswer()).anyTimes();"> 150         EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCðŸ”µ</abbr>
<abbr title=" 151         EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAdjustmentAnswer()).anyTimes();"> 151         EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProviðŸ”µ</abbr>
 152 
<abbr title=" 153         EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getAddItemToFulfillmentGroupAnswer()).anyTimes();"> 153         EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.ðŸ”µ</abbr>
<abbr title=" 154         EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getRemoveItemFromOrderAnswer()).anyTimes();"> 154         EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EðŸ”µ</abbr>
<abbr title=" 155         EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).andAnswer(OfferDataItemProvider.getSaveOrderAnswer()).anyTimes();"> 155         EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).anðŸ”µ</abbr>
 156 
 157         EasyMock.expect(orderServiceMock.getAutomaticallyMergeLikeItems()).andReturn(true).anyTimes();
 158 
<abbr title=" 159         EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OfferDataItemProvider.getSaveOrderItemAnswer()).anyTimes();"> 159         EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OffeðŸ”µ</abbr>
<abbr title=" 160         EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataItemProvider.getSaveFulfillmentGroupItemAnswer()).anyTimes();"> 160         EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataðŸ”µ</abbr>
 161 
<abbr title=" 162         EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;List&lt;OrderMultishipOption&gt;&gt;() {"> 162         EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).aðŸ”µ</abbr>
 163 
 164             @Override
 165             public List&lt;OrderMultishipOption&gt; answer() throws Throwable {
 166                 return new ArrayList&lt;OrderMultishipOption&gt;();
 167             }
 168         }).anyTimes();
 169 
 170         multishipOptionServiceMock.deleteAllOrderMultishipOptions(EasyMock.isA(Order.class));
 171         EasyMock.expectLastCall().anyTimes();
<abbr title=" 172         EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getSameOrderAnswer()).anyTimes();"> 172         EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EðŸ”µ</abbr>
<abbr title=" 173         EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupItemAnswer()).anyTimes();"> 173         EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupðŸ”µ</abbr>
 174         fgItemDaoMock.delete(EasyMock.isA(FulfillmentGroupItem.class));
 175         EasyMock.expectLastCall().anyTimes();
<abbr title=" 176         EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(TimeZone.getTimeZone(&quot;CST&quot;)).anyTimes();"> 176         EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(ðŸ”µ</abbr>
 177 
 178         EasyMock.replay(offerDaoMock);
 179         EasyMock.replay(orderItemDaoMock);
 180         EasyMock.replay(orderServiceMock);
 181         EasyMock.replay(orderItemServiceMock);
 182         EasyMock.replay(fgItemDaoMock);
 183         EasyMock.replay(fgServiceMock);
 184         EasyMock.replay(multishipOptionServiceMock);
 185         EasyMock.replay(offerTimeZoneProcessorMock);
 186     }
 187 
 188     public void verify() {
 189         EasyMock.verify(offerDaoMock);
 190         EasyMock.verify(orderItemDaoMock);
 191         EasyMock.verify(orderServiceMock);
 192         EasyMock.verify(orderItemServiceMock);
 193         EasyMock.verify(fgItemDaoMock);
 194         EasyMock.verify(fgServiceMock);
 195         EasyMock.verify(multishipOptionServiceMock);
 196         EasyMock.verify(offerTimeZoneProcessorMock);
 197     }
 198 
 199     public void testFilterItemLevelOffer() throws Exception {
 200         replay();
 201 
<abbr title=" 202         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 202         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;(ðŸ”µ</abbr>
 203         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 204             &quot;order.subTotal.getAmount()&gt;20&quot;,
 205                 OfferDiscountType.PERCENT_OFF,
 206             null,
 207             null
 208         );
 209 
 210         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 211         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 212 
 213         //test that the valid order item offer is included - legacy format - no qualifier
 214         //since there&#x27;s no qualifier, both items can apply
 215         // This line is commented out because we are no longer creating legacy offers.
<abbr title=" 216         //assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offers.get(0)));"> 216         //assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0ðŸ”µ</abbr>
 217 
 218         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 219         offers = dataProvider.createItemBasedOfferWithItemCriteria(
 220             &quot;order.subTotal.getAmount()&gt;20&quot;,
 221             OfferDiscountType.PERCENT_OFF,
<abbr title=" 222             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 222             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 223             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 223             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 224         );
 225         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 226 
 227         //test that the valid order item offer is included
<abbr title=" 228         //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be only one qualifier in the qualifiers map"> 228         //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be ðŸ”µ</abbr>
 229         //we don&#x27;t know the targets yet, so there&#x27;s only one CandidateItemOffer for now
<abbr title=" 230         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1);"> 230         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0))ðŸ”µ</abbr>
 231 
 232         // Add a subtotal requirement that will be met by the item offer.
 233         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 234         offers = dataProvider.createItemBasedOfferWithItemCriteria(
 235             &quot;order.subTotal.getAmount()&gt;20&quot;,
 236             OfferDiscountType.PERCENT_OFF,
<abbr title=" 237             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 237             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 238             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 238             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 239         );
 240 
 241         offers.get(0).setQualifyingItemSubTotal(new Money(1));
 242         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 243 
 244         //test that the valid order item offer is included
<abbr title=" 245         //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be only one qualifier in the qualifiers map"> 245         //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be ðŸ”µ</abbr>
 246         //we don&#x27;t know the targets yet, so there&#x27;s only one CandidateItemOffer for now
<abbr title=" 247         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1);"> 247         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0))ðŸ”µ</abbr>
 248 
 249 
 250         // Add a subtotal requirement that will not be met by the item offer.
 251         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 252         offers = dataProvider.createItemBasedOfferWithItemCriteria(
 253             &quot;order.subTotal.getAmount()&gt;20&quot;,
 254             OfferDiscountType.PERCENT_OFF,
<abbr title=" 255             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 255             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 256             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 256             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 257         );
 258 
 259         offers.get(0).setQualifyingItemSubTotal(new Money(99999));
 260         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 261 
 262         // Since the item qualification subTotal is not met, the qualified offer size should
 263         // be zero.
 264         assertTrue(qualifiedOffers.size() == 0);
 265 
 266 
 267         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 268         offers = dataProvider.createItemBasedOfferWithItemCriteria(
 269             &quot;order.subTotal.getAmount()&gt;20&quot;,
 270             OfferDiscountType.PERCENT_OFF,
<abbr title=" 271             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 271             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 272             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 272             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MðŸ”µ</abbr>
 273         );
 274         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 275 
 276         //test that the invalid order item offer is excluded
 277         assertTrue(qualifiedOffers.size() == 0);
 278 
 279         verify();
 280     }
 281 
 282     public void testCouldOfferApplyToOrder() throws Exception {
 283         replay();
 284 
 285         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 286         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 287             &quot;order.subTotal.getAmount()&gt;20&quot;,
 288             OfferDiscountType.PERCENT_OFF,
 289             null,
 290             null
 291         );
 292 
<abbr title=" 293         boolean couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrderItems().get(0), order.getFulfillmentGroups().get(0));"> 293         boolean couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountðŸ”µ</abbr>
 294         //test that the valid order item offer is included
 295         assertTrue(couldApply);
 296 
 297         offers = dataProvider.createItemBasedOfferWithItemCriteria(
 298             &quot;order.subTotal.getAmount()==0&quot;,
 299             OfferDiscountType.PERCENT_OFF,
 300             null,
 301             null
 302         );
<abbr title=" 303         couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrderItems().get(0), order.getFulfillmentGroups().get(0));"> 303         couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrdeðŸ”µ</abbr>
 304         //test that the invalid order item offer is excluded
 305         assertFalse(couldApply);
 306 
 307         verify();
 308     }
 309 
 310     public void testCouldOrderItemMeetOfferRequirement() throws Exception {
 311         replay();
 312 
 313         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 314         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 315             &quot;order.subTotal.getAmount()&gt;20&quot;,
 316             OfferDiscountType.PERCENT_OFF,
<abbr title=" 317             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 317             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 318             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 318             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 319         );
 320 
<abbr title=" 321         OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();"> 321         OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next(ðŸ”µ</abbr>
<abbr title=" 322         boolean couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 322         boolean couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria()ðŸ”µ</abbr>
 323         //test that the valid order item offer is included
 324         assertTrue(couldApply);
 325 
 326         offers = dataProvider.createItemBasedOfferWithItemCriteria(
 327             &quot;order.subTotal.getAmount()&gt;20&quot;,
 328             OfferDiscountType.PERCENT_OFF,
<abbr title=" 329             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 329             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 330             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 330             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MðŸ”µ</abbr>
 331         );
 332         xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();
<abbr title=" 333         couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 333         couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.ðŸ”µ</abbr>
 334         //test that the invalid order item offer is excluded
 335         assertFalse(couldApply);
 336 
 337         verify();
 338     }
 339 
 340     public void testCouldOfferApplyToOrderItems() throws Exception {
 341         replay();
 342 
 343         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 344         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 345             &quot;order.subTotal.getAmount()&gt;20&quot;,
 346             OfferDiscountType.PERCENT_OFF,
<abbr title=" 347             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 347             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 348             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 348             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 349         );
 350         List&lt;PromotableOrderItem&gt; orderItems = new ArrayList&lt;PromotableOrderItem&gt;();
 351         for (PromotableOrderItem orderItem : order.getDiscountableOrderItems()) {
 352             orderItems.add(orderItem);
 353         }
<abbr title=" 354         CandidatePromotionItems candidates = itemProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);"> 354         CandidatePromotionItems candidates = itemProcessor.couldOfferApplyToOrderItems(offers.get(0), ordðŸ”µ</abbr>
 355         //test that the valid order item offer is included
 356         //both cart items are valid for qualification and target
<abbr title=" 357         assertTrue(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1 &amp;&amp;"> 357         assertTrue(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1 ðŸ”µ</abbr>
 358                 candidates.getCandidateQualifiersMap().values().iterator().next().size() == 2 &amp;&amp;
 359                 candidates.isMatchedTarget() &amp;&amp; candidates.getCandidateTargetsMap().size() == 1 &amp;&amp;
 360                 candidates.getCandidateTargetsMap().values().iterator().next().size() == 2);
 361 
 362         offers = dataProvider.createItemBasedOfferWithItemCriteria(
 363             &quot;order.subTotal.getAmount()&gt;20&quot;,
 364             OfferDiscountType.PERCENT_OFF,
<abbr title=" 365             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 365             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 366             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 366             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MðŸ”µ</abbr>
 367         );
 368         candidates = itemProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);
 369         //test that the invalid order item offer is excluded because there are no qualifying items
<abbr title=" 370         assertFalse(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1);"> 370         assertFalse(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1ðŸ”µ</abbr>
 371 
 372         verify();
 373     }
 374 
 375     private int checkOrderItemOfferAppliedCount(Order order) {
 376         int count = 0;
 377         for (OrderItem item : order.getOrderItems()) {
 378             for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 379                 count = count + (detail.getOrderItemPriceDetailAdjustments().size() * detail.getQuantity());"> 379                 count = count + (detail.getOrderItemPriceDetailAdjustments().size() * detail.getQuantity(ðŸ”µ</abbr>
 380             }
 381         }
 382         return count;
 383     }
 384 
 385     private int checkOrderItemOfferAppliedQuantity(Order order, Offer offer) {
 386         int count = 0;
 387         for (OrderItem item : order.getOrderItems()) {
 388             for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 389                 for (OrderItemPriceDetailAdjustment adjustment : detail.getOrderItemPriceDetailAdjustments()) {"> 389                 for (OrderItemPriceDetailAdjustment adjustment : detail.getOrderItemPriceDetailAdjustmentðŸ”µ</abbr>
 390                     if (adjustment.getOffer().getId().equals(offer.getId())) {
 391                         count += detail.getQuantity();
 392                     }
 393                 }
 394             }
 395         }
 396         return count;
 397     }
 398 
 399     private int countPriceDetails(Order order) {
 400         int count = 0;
 401         for (OrderItem item : order.getOrderItems()) {
 402             count = count + item.getOrderItemPriceDetails().size();
 403         }
 404         return count;
 405     }
 406 
 407 
 408     public void testApplyAllItemOffers() throws Exception {
 409 
 410 
 411         replay();
 412 
 413         Order order = dataProvider.createBasicOrder();
 414 
 415         Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(
 416             &quot;order.subTotal.getAmount()&gt;20&quot;,
 417             OfferDiscountType.PERCENT_OFF,
<abbr title=" 418             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 418             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 419             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 419             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 420         ).get(0);
 421         offer1.setId(1L);
 422 
 423         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 424         offers.add(offer1);
 425 
<abbr title=" 426         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 426         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;(ðŸ”µ</abbr>
 427         order.updatePrices();
 428         offerService.applyAndSaveOffersToOrder(offers, order);
 429 
 430         assertTrue(order.getTotalAdjustmentsValue().getAmount().doubleValue() &gt; 0);
 431 
 432         order = dataProvider.createBasicOrder();
 433 
 434         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 435         offer1.setApplyDiscountToSalePrice(false);
 436         ((DiscreteOrderItem) order.getOrderItems().get(0)).getSku().setSalePrice(new Money(1D));
 437         ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(new Money(1D));
 438         order.updatePrices();
 439         offerService.applyAndSaveOffersToOrder(offers, order);
 440 
 441         assertTrue(order.getTotalAdjustmentsValue().getAmount().doubleValue() == 0);
 442 
 443         verify();
 444     }
 445 
 446     public void testApplyAdjustments() throws Exception {
 447         replay();
 448 
 449         Order order = dataProvider.createBasicOrder();
 450 
 451         Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(
 452             &quot;order.subTotal.getAmount()&gt;20&quot;,
 453             OfferDiscountType.PERCENT_OFF,
<abbr title=" 454             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 454             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 455             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 455             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 456         ).get(0);
 457         offer1.setId(1L);
 458         OfferQualifyingCriteriaXref xref = offer1.getQualifyingItemCriteriaXref().iterator().next();
 459         xref.getOfferItemCriteria().setQuantity(2);
 460         offer1.setCombinableWithOtherOffers(false);
 461         Offer offer2 = dataProvider.createItemBasedOfferWithItemCriteria(
 462             &quot;order.subTotal.getAmount()&gt;20&quot;,
 463             OfferDiscountType.PERCENT_OFF,
<abbr title=" 464             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 464             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 465             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 465             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 466         ).get(0);
 467         offer2.setId(2L);
 468 
 469         List&lt;Offer&gt; offerListWithOneOffer = new ArrayList&lt;Offer&gt;();
 470         offerListWithOneOffer.add(offer1);
 471 
 472         List&lt;Offer&gt; offerListWithTwoOffers = new ArrayList&lt;Offer&gt;();
 473         offerListWithTwoOffers.add(offer1);
 474         offerListWithTwoOffers.add(offer2);
 475 
 476         order.updatePrices();
 477         offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 478         assertTrue(checkOrderItemOfferAppliedCount(order) == 1);
 479         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 1);
 480 
 481         // Add the second offer.   The first was nonCombinable so it should still be 1
 482         order = dataProvider.createBasicOrder();
 483         order.updatePrices();
 484         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 485         assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 486         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 487         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 488 
 489 
 490         // Reset offer1 to combinable.   Now both should be applied.
 491         offer1.setCombinableWithOtherOffers(true);
 492         order = dataProvider.createBasicOrder();
 493         order.updatePrices();
 494         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 495         assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 496         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 497         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 498 
 499         // Offer 1 back to nonCombinable but don&#x27;t allow discount to the sale price
 500         // and make the sale price a better overall offer
 501         offer1.setCombinableWithOtherOffers(false);
 502         offer1.setApplyDiscountToSalePrice(false);
 503         order = dataProvider.createBasicOrder();
 504         ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(new Money(10D));
 505         order.updatePrices();
 506         offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 507         assertTrue(checkOrderItemOfferAppliedCount(order) == 0);
 508 
 509         // Try again with two offers.   The second should be applied.
 510         order.updatePrices();
 511         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 512         assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 513 
 514         // Trying with 2nd offer as nonCombinable.
 515         offer1.setCombinableWithOtherOffers(true);
 516         ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(null);
 517         offer2.setCombinableWithOtherOffers(false);
 518 
 519         order.updatePrices();
 520         offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 521         assertTrue(checkOrderItemOfferAppliedCount(order) == 1);
 522 
 523         order.updatePrices();
 524         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 525         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 526         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 527 
 528         // Set qualifying criteria quantity to 1
 529         // Set qualifying target criteria to 2
 530         order = dataProvider.createBasicOrder();
 531         xref = offer1.getQualifyingItemCriteriaXref().iterator().next();
 532         xref.getOfferItemCriteria().setQuantity(1);
 533 
 534         OfferTargetCriteriaXref targetXref = offer1.getTargetItemCriteriaXref().iterator().next();
 535         targetXref.getOfferItemCriteria().setQuantity(2);
 536         order.updatePrices();
 537         offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 538         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 2);
 539 
 540         // Reset both offers to combinable and the qualifiers as allowing duplicate QUALIFIERs
 541         // and Targets
 542         offer1.setCombinableWithOtherOffers(true);
 543         offer2.setCombinableWithOtherOffers(true);
 544         offer1.setOfferItemQualifierRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 545         offer1.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 546         offer2.setOfferItemQualifierRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 547         offer2.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 548         order = dataProvider.createBasicOrder();
 549         order.updatePrices();
 550         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 551         assertTrue(checkOrderItemOfferAppliedCount(order) == 4);
 552         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 553         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 2);
 554 
 555         verify();
 556     }
 557 
 558     public void testApplyItemQualifiersAndTargets() throws Exception {
 559         replay();
 560 
<abbr title=" 561         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 561         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;(ðŸ”µ</abbr>
 562         Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(
 563             &quot;order.subTotal.getAmount()&gt;20&quot;,
 564             OfferDiscountType.PERCENT_OFF,
<abbr title=" 565             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 565             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 566             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 566             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 567         ).get(0);
 568         offer1.setId(1L);
 569         Offer offer2 = dataProvider.createItemBasedOfferWithItemCriteria(
 570             &quot;order.subTotal.getAmount()&gt;20&quot;,
 571             OfferDiscountType.PERCENT_OFF,
<abbr title=" 572             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 572             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 573             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 573             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 574         ).get(0);
 575         offer2.setId(2L);
 576 
 577         OfferTargetCriteriaXref targetXref = offer2.getTargetItemCriteriaXref().iterator().next();
 578         targetXref.getOfferItemCriteria().setQuantity(4);
 579         offer2.getQualifyingItemCriteriaXref().clear();
 580         offer2.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.TARGET);
 581         Offer offer3 = dataProvider.createItemBasedOfferWithItemCriteria(
 582             &quot;order.subTotal.getAmount()&gt;20&quot;,
 583             OfferDiscountType.PERCENT_OFF,
<abbr title=" 584             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 584             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 585             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 585             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 586         ).get(0);
 587 
<abbr title=" 588         PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility);"> 588         PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility)ðŸ”µ</abbr>
 589         itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer1);
<abbr title=" 590         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offer1) &amp;&amp; qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1);"> 590         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offer1) &amp;&amp; quaðŸ”µ</abbr>
 591 
 592         itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer2);
<abbr title=" 593         assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offer2) &amp;&amp; qualifiedOffers.get(1).getCandidateQualifiersMap().size() == 0);"> 593         assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offer2) &amp;&amp; quaðŸ”µ</abbr>
 594 
 595         itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer3);
<abbr title=" 596         assertTrue(qualifiedOffers.size() == 3 &amp;&amp; qualifiedOffers.get(2).getOffer().equals(offer3) &amp;&amp; qualifiedOffers.get(2).getCandidateQualifiersMap().size() == 1);"> 596         assertTrue(qualifiedOffers.size() == 3 &amp;&amp; qualifiedOffers.get(2).getOffer().equals(offer3) &amp;&amp; quaðŸ”µ</abbr>
 597 
<abbr title=" 598         // Try with just the second offer.   Expect to get 4 targets based on the offer having no qualifiers required"> 598         // Try with just the second offer.   Expect to get 4 targets based on the offer having no qualifiðŸ”µ</abbr>
 599         // and targeting category test1 or test2 and that the offer requires 4 target criteria.
 600         Order order = dataProvider.createBasicOrder();
 601         List&lt;Offer&gt; offerList = new ArrayList&lt;Offer&gt;();
 602         offerList.add(offer2);
 603         offerService.applyAndSaveOffersToOrder(offerList, order);
 604         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 4);
 605         assertTrue(countPriceDetails(order) == 3);
 606 
<abbr title=" 607         // Now try with both offers.   Since the targets can be reused, we expect to have 4 targets on offer2"> 607         // Now try with both offers.   Since the targets can be reused, we expect to have 4 targets on ofðŸ”µ</abbr>
 608         // and 1 target on offer1
 609         order = dataProvider.createBasicOrder();
 610         offerList.add(offer1); // add in second offer (which happens to be offer1)
 611 
 612         offerService.applyAndSaveOffersToOrder(offerList, order);
 613         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 4);
 614         assertTrue(countPriceDetails(order) == 3);
 615 
 616         // All three offers - offer 3 is now higher priority so the best offer (offer 2) won&#x27;t be applied
 617         order = dataProvider.createBasicOrder();
 618         offerList.add(offer3); // add in second offer (which happens to be offer1)
 619         offer3.setPriority(-1);
 620         offerService.applyAndSaveOffersToOrder(offerList, order);
 621         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer3) == 2);
 622         assertTrue(countPriceDetails(order) == 4);
 623 
 624         verify();
 625     }
 626 
 627     public class Answer implements IAnswer&lt;CandidateItemOffer&gt; {
 628 
 629         @Override
 630         public CandidateItemOffer answer() throws Throwable {
 631             return new CandidateItemOfferImpl();
 632         }
 633 
 634     }
 635 
 636     public class Answer2 implements IAnswer&lt;OrderItemAdjustment&gt; {
 637 
 638         @Override
 639         public OrderItemAdjustment answer() throws Throwable {
 640             return new OrderItemAdjustmentImpl();
 641         }
 642 
 643     }
 644 }
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service.processor;
  19 
  20 import java.util.ArrayList;
  21 import java.util.List;
  22 import java.util.TimeZone;
  23 import junit.framework.TestCase;
  24 import org.broadleafcommerce.common.money.Money;
  25 import org.broadleafcommerce.common.service.GenericEntityService;
  26 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  27 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  28 import org.broadleafcommerce.core.offer.dao.OfferDao;
  29 import org.broadleafcommerce.core.offer.domain.CandidateItemOffer;
  30 import org.broadleafcommerce.core.offer.domain.CandidateItemOfferImpl;
  31 import org.broadleafcommerce.core.offer.domain.Offer;
  32 import org.broadleafcommerce.core.offer.domain.OfferImpl;
  33 import org.broadleafcommerce.core.offer.domain.OfferQualifyingCriteriaXref;
  34 import org.broadleafcommerce.core.offer.domain.OfferTargetCriteriaXref;
  35 import org.broadleafcommerce.core.offer.domain.OrderItemAdjustment;
  36 import org.broadleafcommerce.core.offer.domain.OrderItemAdjustmentImpl;
  37 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  38 import org.broadleafcommerce.core.offer.service.OfferDataItemProvider;
  39 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  40 import org.broadleafcommerce.core.offer.service.OfferServiceUtilitiesImpl;
  41 import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  43 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactoryImpl;
  44 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;
  45 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtilityImpl;
  46 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  47 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  48 import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  49 import org.broadleafcommerce.core.offer.service.type.OfferItemRestrictionRuleType;
  50 import org.broadleafcommerce.core.order.dao.FulfillmentGroupItemDao;
  51 import org.broadleafcommerce.core.order.dao.OrderItemDao;
  52 import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;
  53 import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  54 import org.broadleafcommerce.core.order.domain.Order;
  55 import org.broadleafcommerce.core.order.domain.OrderItem;
  56 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  57 import org.broadleafcommerce.core.order.domain.OrderMultishipOption;
  58 import org.broadleafcommerce.core.order.service.FulfillmentGroupService;
  59 import org.broadleafcommerce.core.order.service.OrderItemService;
  60 import org.broadleafcommerce.core.order.service.OrderMultishipOptionService;
  61 import org.broadleafcommerce.core.order.service.OrderService;
  62 import org.broadleafcommerce.core.order.service.call.FulfillmentGroupItemRequest;
  63 import org.easymock.EasyMock;
  64 import org.easymock.IAnswer;
  65 
  66 
  67 /**
  68  *
  69  * @author jfischer
  70  *
  71  */
  72 public class ItemOfferProcessorTest extends TestCase {
  73     protected OfferDao offerDaoMock;
  74 
  75     protected OrderItemDao orderItemDaoMock;
  76 
  77     protected OrderService orderServiceMock;
  78 
  79     protected OfferServiceImpl offerService;
  80 
  81     protected OrderItemService orderItemServiceMock;
  82 
  83     protected FulfillmentGroupItemDao fgItemDaoMock;
  84 
  85     protected OfferDataItemProvider dataProvider = new OfferDataItemProvider();
  86 
  87     protected FulfillmentGroupService fgServiceMock;
  88 
  89     protected OrderMultishipOptionService multishipOptionServiceMock;
  90 
  91     protected OfferTimeZoneProcessor offerTimeZoneProcessorMock;
  92 
  93     protected PromotableOfferUtility promotableOfferUtility;
  94 
  95     protected GenericEntityService genericEntityServiceMock;
  96 
  97     protected ItemOfferProcessorImpl itemProcessor;
  98 
  99     @Override
 100     protected void setUp() throws Exception {
 101         CustomerOfferDao customerOfferDaoMock = EasyMock.createMock(CustomerOfferDao.class);
 102         OfferCodeDao offerCodeDaoMock = EasyMock.createMock(OfferCodeDao.class);
 103         offerDaoMock = EasyMock.createMock(OfferDao.class);
 104         orderItemDaoMock = EasyMock.createMock(OrderItemDao.class);
 105         orderServiceMock = EasyMock.createMock(OrderService.class);
 106         orderItemServiceMock = EasyMock.createMock(OrderItemService.class);
 107         fgItemDaoMock = EasyMock.createMock(FulfillmentGroupItemDao.class);
 108         fgServiceMock = EasyMock.createMock(FulfillmentGroupService.class);
 109         multishipOptionServiceMock = EasyMock.createMock(OrderMultishipOptionService.class);
 110         offerTimeZoneProcessorMock = EasyMock.createMock(OfferTimeZoneProcessor.class);
 111 
 112 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113         promotableOfferUtility = new PromotableOfferUtilityImpl();</span>
 114 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 115 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 115 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 116 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118         genericEntityServiceMock = EasyMock.createMock(GenericEntityService.class);</span>
 119 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 120 
<abbr title=" 121         OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl(promotableOfferUtility);"> 121         OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl(promotableOfferUtðŸ”µ</abbr>
 122         offerServiceUtilities.setOfferDao(offerDaoMock);
<abbr title=" 123         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));"> 123         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtiliðŸ”µ</abbr>
 124         offerServiceUtilities.setGenericEntityService(genericEntityServiceMock);
 125         itemProcessor = new ItemOfferProcessorImpl(promotableOfferUtility);
 126         itemProcessor.setOfferDao(offerDaoMock);
 127         itemProcessor.setOrderItemDao(orderItemDaoMock);
 128         itemProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
 129         itemProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 130         itemProcessor.setOfferServiceUtilities(offerServiceUtilities);
 131         offerService = new OfferServiceImpl();
 132         OrderOfferProcessorImpl orderProcessor = new OrderOfferProcessorImpl(promotableOfferUtility);
 133         orderProcessor.setOfferDao(offerDaoMock);
 134         orderProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 135         orderProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
 136         orderProcessor.setOrderItemDao(orderItemDaoMock);
 137         orderProcessor.setOfferServiceUtilities(offerServiceUtilities);
 138         offerService.setCustomerOfferDao(customerOfferDaoMock);
 139         offerService.setOfferCodeDao(offerCodeDaoMock);
 140         offerService.setOfferDao(offerDaoMock);
 141         offerService.setOrderOfferProcessor(orderProcessor);
 142         offerService.setItemOfferProcessor(itemProcessor);
 143         offerService.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 144         offerService.setOrderService(orderServiceMock);
 145     }
 146 
 147     public void replay() throws Exception {
<abbr title=" 148         EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAnswer()).anyTimes();"> 148         EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.geðŸ”µ</abbr>
<abbr title=" 149         EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCreateOrderItemQualifierAnswer()).anyTimes();"> 149         EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCðŸ”µ</abbr>
<abbr title=" 150         EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAdjustmentAnswer()).anyTimes();"> 150         EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProviðŸ”µ</abbr>
 151 
<abbr title=" 152         EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getAddItemToFulfillmentGroupAnswer()).anyTimes();"> 152         EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.ðŸ”µ</abbr>
<abbr title=" 153         EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getRemoveItemFromOrderAnswer()).anyTimes();"> 153         EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EðŸ”µ</abbr>
<abbr title=" 154         EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).andAnswer(OfferDataItemProvider.getSaveOrderAnswer()).anyTimes();"> 154         EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).anðŸ”µ</abbr>
 155 
 156         EasyMock.expect(orderServiceMock.getAutomaticallyMergeLikeItems()).andReturn(true).anyTimes();
 157 
<abbr title=" 158         EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OfferDataItemProvider.getSaveOrderItemAnswer()).anyTimes();"> 158         EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OffeðŸ”µ</abbr>
<abbr title=" 159         EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataItemProvider.getSaveFulfillmentGroupItemAnswer()).anyTimes();"> 159         EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataðŸ”µ</abbr>
 160 
<abbr title=" 161         EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;List&lt;OrderMultishipOption&gt;&gt;() {"> 161         EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).aðŸ”µ</abbr>
 162 
 163             @Override
 164             public List&lt;OrderMultishipOption&gt; answer() throws Throwable {
 165                 return new ArrayList&lt;OrderMultishipOption&gt;();
 166             }
 167         }).anyTimes();
 168 
 169         multishipOptionServiceMock.deleteAllOrderMultishipOptions(EasyMock.isA(Order.class));
 170         EasyMock.expectLastCall().anyTimes();
<abbr title=" 171         EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getSameOrderAnswer()).anyTimes();"> 171         EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EðŸ”µ</abbr>
<abbr title=" 172         EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupItemAnswer()).anyTimes();"> 172         EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupðŸ”µ</abbr>
 173         fgItemDaoMock.delete(EasyMock.isA(FulfillmentGroupItem.class));
 174         EasyMock.expectLastCall().anyTimes();
<abbr title=" 175         EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(TimeZone.getTimeZone(&quot;CST&quot;)).anyTimes();"> 175         EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(ðŸ”µ</abbr>
 176 
 177         EasyMock.replay(offerDaoMock);
 178         EasyMock.replay(orderItemDaoMock);
 179         EasyMock.replay(orderServiceMock);
 180         EasyMock.replay(orderItemServiceMock);
 181         EasyMock.replay(fgItemDaoMock);
 182         EasyMock.replay(fgServiceMock);
 183         EasyMock.replay(multishipOptionServiceMock);
 184         EasyMock.replay(offerTimeZoneProcessorMock);
 185     }
 186 
 187     public void verify() {
 188         EasyMock.verify(offerDaoMock);
 189         EasyMock.verify(orderItemDaoMock);
 190         EasyMock.verify(orderServiceMock);
 191         EasyMock.verify(orderItemServiceMock);
 192         EasyMock.verify(fgItemDaoMock);
 193         EasyMock.verify(fgServiceMock);
 194         EasyMock.verify(multishipOptionServiceMock);
 195         EasyMock.verify(offerTimeZoneProcessorMock);
 196     }
 197 
 198     public void testFilterItemLevelOffer() throws Exception {
 199         replay();
<abbr title=" 200         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 200         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;(ðŸ”µ</abbr>
<abbr title=" 201         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferDiscountType.PERCENT_OFF, null, null);"> 201         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount(ðŸ”µ</abbr>
 202         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 203         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 204         // test that the valid order item offer is included - legacy format - no qualifier
 205         // since there&#x27;s no qualifier, both items can apply
 206         // This line is commented out because we are no longer creating legacy offers.
<abbr title=" 207         // assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offers.get(0)));"> 207         // assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(ðŸ”µ</abbr>
 208         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
<abbr title=" 209         offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 209         offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferðŸ”µ</abbr>
 210         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 211         // test that the valid order item offer is included
<abbr title=" 212         // there is a qualifier and the item qualifying criteria requires only 1, therefore there will be only one qualifier in the qualifiers map"> 212         // there is a qualifier and the item qualifying criteria requires only 1, therefore there will beðŸ”µ</abbr>
 213         // we don&#x27;t know the targets yet, so there&#x27;s only one CandidateItemOffer for now
<abbr title=" 214         assertTrue(((qualifiedOffers.size() == 1) &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0))) &amp;&amp; (qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1));"> 214         assertTrue(((qualifiedOffers.size() == 1) &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(ðŸ”µ</abbr>
 215         // Add a subtotal requirement that will be met by the item offer.
 216         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
<abbr title=" 217         offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 217         offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferðŸ”µ</abbr>
 218         offers.get(0).setQualifyingItemSubTotal(new Money(1));
 219         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 220         // test that the valid order item offer is included
<abbr title=" 221         // there is a qualifier and the item qualifying criteria requires only 1, therefore there will be only one qualifier in the qualifiers map"> 221         // there is a qualifier and the item qualifying criteria requires only 1, therefore there will beðŸ”µ</abbr>
 222         // we don&#x27;t know the targets yet, so there&#x27;s only one CandidateItemOffer for now
<abbr title=" 223         assertTrue(((qualifiedOffers.size() == 1) &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0))) &amp;&amp; (qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1));"> 223         assertTrue(((qualifiedOffers.size() == 1) &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(ðŸ”µ</abbr>
 224         // Add a subtotal requirement that will not be met by the item offer.
 225         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
<abbr title=" 226         offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 226         offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferðŸ”µ</abbr>
 227         offers.get(0).setQualifyingItemSubTotal(new Money(99999));
 228         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 229         // Since the item qualification subTotal is not met, the qualified offer size should
 230         // be zero.
 231         assertTrue(qualifiedOffers.size() == 0);
 232         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
<abbr title=" 233         offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 233         offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferðŸ”µ</abbr>
 234         itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 235         // test that the invalid order item offer is excluded
 236         assertTrue(qualifiedOffers.size() == 0);
 237         verify();
 238     }
 239 
 240     public void testCouldOfferApplyToOrder() throws Exception {
 241         replay();
 242         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
<abbr title=" 243         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferDiscountType.PERCENT_OFF, null, null);"> 243         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount(ðŸ”µ</abbr>
<abbr title=" 244         boolean couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrderItems().get(0), order.getFulfillmentGroups().get(0));"> 244         boolean couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountðŸ”µ</abbr>
 245         // test that the valid order item offer is included
 246         assertTrue(couldApply);
<abbr title=" 247         offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()==0&quot;, OfferDiscountType.PERCENT_OFF, null, null);"> 247         offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()==0&quot;, OfferðŸ”µ</abbr>
<abbr title=" 248         couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrderItems().get(0), order.getFulfillmentGroups().get(0));"> 248         couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrdeðŸ”µ</abbr>
 249         // test that the invalid order item offer is excluded
 250         assertFalse(couldApply);
 251         verify();
 252     }
 253 
 254     public void testCouldOrderItemMeetOfferRequirement() throws Exception {
 255         replay();
 256         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
<abbr title=" 257         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 257         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount(ðŸ”µ</abbr>
<abbr title=" 258         OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();"> 258         OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next(ðŸ”µ</abbr>
<abbr title=" 259         boolean couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 259         boolean couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria()ðŸ”µ</abbr>
 260         // test that the valid order item offer is included
 261         assertTrue(couldApply);
<abbr title=" 262         offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 262         offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferðŸ”µ</abbr>
 263         xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();
<abbr title=" 264         couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 264         couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.ðŸ”µ</abbr>
 265         // test that the invalid order item offer is excluded
 266         assertFalse(couldApply);
 267         verify();
 268     }
 269 
 270     public void testCouldOfferApplyToOrderItems() throws Exception {
 271         replay();
 272         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
<abbr title=" 273         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 273         List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount(ðŸ”µ</abbr>
 274         List&lt;PromotableOrderItem&gt; orderItems = new ArrayList&lt;PromotableOrderItem&gt;();
 275         for (PromotableOrderItem orderItem : order.getDiscountableOrderItems()) {
 276             orderItems.add(orderItem);
 277         }
<abbr title=" 278         CandidatePromotionItems candidates = itemProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);"> 278         CandidatePromotionItems candidates = itemProcessor.couldOfferApplyToOrderItems(offers.get(0), ordðŸ”µ</abbr>
 279         // test that the valid order item offer is included
 280         // both cart items are valid for qualification and target
<abbr title=" 281         assertTrue(((((candidates.isMatchedQualifier() &amp;&amp; (candidates.getCandidateQualifiersMap().size() == 1)) &amp;&amp; (candidates.getCandidateQualifiersMap().values().iterator().next().size() == 2)) &amp;&amp; candidates.isMatchedTarget()) &amp;&amp; (candidates.getCandidateTargetsMap().size() == 1)) &amp;&amp; (candidates.getCandidateTargetsMap().values().iterator().next().size() == 2));"> 281         assertTrue(((((candidates.isMatchedQualifier() &amp;&amp; (candidates.getCandidateQualifiersMap().size() ðŸ”µ</abbr>
<abbr title=" 282         offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 282         offers = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferðŸ”µ</abbr>
 283         candidates = itemProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);
 284         // test that the invalid order item offer is excluded because there are no qualifying items
<abbr title=" 285         assertFalse(candidates.isMatchedQualifier() &amp;&amp; (candidates.getCandidateQualifiersMap().size() == 1));"> 285         assertFalse(candidates.isMatchedQualifier() &amp;&amp; (candidates.getCandidateQualifiersMap().size() == ðŸ”µ</abbr>
 286         verify();
 287     }
 288 
 289     private int checkOrderItemOfferAppliedCount(Order order) {
 290         int count = 0;
 291         for (OrderItem item : order.getOrderItems()) {
 292             for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 293                 count = count + (detail.getOrderItemPriceDetailAdjustments().size() * detail.getQuantity());"> 293                 count = count + (detail.getOrderItemPriceDetailAdjustments().size() * detail.getQuantity(ðŸ”µ</abbr>
 294             }
 295         }
 296         return count;
 297     }
 298 
 299     private int checkOrderItemOfferAppliedQuantity(Order order, Offer offer) {
 300         int count = 0;
 301         for (OrderItem item : order.getOrderItems()) {
 302             for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
<abbr title=" 303                 for (OrderItemPriceDetailAdjustment adjustment : detail.getOrderItemPriceDetailAdjustments()) {"> 303                 for (OrderItemPriceDetailAdjustment adjustment : detail.getOrderItemPriceDetailAdjustmentðŸ”µ</abbr>
 304                     if (adjustment.getOffer().getId().equals(offer.getId())) {
 305                         count += detail.getQuantity();
 306                     }
 307                 }
 308             }
 309         }
 310         return count;
 311     }
 312 
 313     private int countPriceDetails(Order order) {
 314         int count = 0;
 315         for (OrderItem item : order.getOrderItems()) {
 316             count = count + item.getOrderItemPriceDetails().size();
 317         }
 318         return count;
 319     }
 320 
 321     public void testApplyAllItemOffers() throws Exception {
 322 
 323 
 324         replay();
 325 
 326         Order order = dataProvider.createBasicOrder();
 327 
 328         Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(
 329             &quot;order.subTotal.getAmount()&gt;20&quot;,
 330             OfferDiscountType.PERCENT_OFF,
<abbr title=" 331             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 331             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 332             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 332             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 333         ).get(0);
 334         offer1.setId(1L);
 335 
 336         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 337         offers.add(offer1);
 338 
<abbr title=" 339         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 339         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;(ðŸ”µ</abbr>
 340         order.updatePrices();
 341         offerService.applyAndSaveOffersToOrder(offers, order);
 342 
 343         assertTrue(order.getTotalAdjustmentsValue().getAmount().doubleValue() &gt; 0);
 344 
 345         order = dataProvider.createBasicOrder();
 346 
 347         qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 348         offer1.setApplyDiscountToSalePrice(false);
 349         ((DiscreteOrderItem) order.getOrderItems().get(0)).getSku().setSalePrice(new Money(1D));
 350         ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(new Money(1D));
 351         order.updatePrices();
 352         offerService.applyAndSaveOffersToOrder(offers, order);
 353 
 354         assertTrue(order.getTotalAdjustmentsValue().getAmount().doubleValue() == 0);
 355 
 356         verify();
 357     }
 358 
 359     public void testApplyAdjustments() throws Exception {
 360         replay();
 361 
 362         Order order = dataProvider.createBasicOrder();
 363 
 364         Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(
 365             &quot;order.subTotal.getAmount()&gt;20&quot;,
 366             OfferDiscountType.PERCENT_OFF,
<abbr title=" 367             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 367             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 368             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 368             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 369         ).get(0);
 370         offer1.setId(1L);
 371         OfferQualifyingCriteriaXref xref = offer1.getQualifyingItemCriteriaXref().iterator().next();
 372         xref.getOfferItemCriteria().setQuantity(2);
 373         offer1.setCombinableWithOtherOffers(false);
 374         Offer offer2 = dataProvider.createItemBasedOfferWithItemCriteria(
 375             &quot;order.subTotal.getAmount()&gt;20&quot;,
 376             OfferDiscountType.PERCENT_OFF,
<abbr title=" 377             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 377             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
<abbr title=" 378             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 378             &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MðŸ”µ</abbr>
 379         ).get(0);
 380         offer2.setId(2L);
 381 
 382         List&lt;Offer&gt; offerListWithOneOffer = new ArrayList&lt;Offer&gt;();
 383         offerListWithOneOffer.add(offer1);
 384 
 385         List&lt;Offer&gt; offerListWithTwoOffers = new ArrayList&lt;Offer&gt;();
 386         offerListWithTwoOffers.add(offer1);
 387         offerListWithTwoOffers.add(offer2);
 388 
 389         order.updatePrices();
 390         offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 391         assertTrue(checkOrderItemOfferAppliedCount(order) == 1);
 392         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 1);
 393 
 394         // Add the second offer.   The first was nonCombinable so it should still be 1
 395         order = dataProvider.createBasicOrder();
 396         order.updatePrices();
 397         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 398         assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 399         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 400         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 401 
 402 
 403         // Reset offer1 to combinable.   Now both should be applied.
 404         offer1.setCombinableWithOtherOffers(true);
 405         order = dataProvider.createBasicOrder();
 406         order.updatePrices();
 407         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 408         assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 409         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 410         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 411 
 412         // Offer 1 back to nonCombinable but don&#x27;t allow discount to the sale price
 413         // and make the sale price a better overall offer
 414         offer1.setCombinableWithOtherOffers(false);
 415         offer1.setApplyDiscountToSalePrice(false);
 416         order = dataProvider.createBasicOrder();
 417         ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(new Money(10D));
 418         order.updatePrices();
 419         offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 420         assertTrue(checkOrderItemOfferAppliedCount(order) == 0);
 421 
 422         // Try again with two offers.   The second should be applied.
 423         order.updatePrices();
 424         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 425         assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 426 
 427         // Trying with 2nd offer as nonCombinable.
 428         offer1.setCombinableWithOtherOffers(true);
 429         ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(null);
 430         offer2.setCombinableWithOtherOffers(false);
 431 
 432         order.updatePrices();
 433         offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 434         assertTrue(checkOrderItemOfferAppliedCount(order) == 1);
 435 
 436         order.updatePrices();
 437         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 438         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 439         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 440 
 441         // Set qualifying criteria quantity to 1
 442         // Set qualifying target criteria to 2
 443         order = dataProvider.createBasicOrder();
 444         xref = offer1.getQualifyingItemCriteriaXref().iterator().next();
 445         xref.getOfferItemCriteria().setQuantity(1);
 446 
 447         OfferTargetCriteriaXref targetXref = offer1.getTargetItemCriteriaXref().iterator().next();
 448         targetXref.getOfferItemCriteria().setQuantity(2);
 449         order.updatePrices();
 450         offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 451         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 2);
 452 
 453         // Reset both offers to combinable and the qualifiers as allowing duplicate QUALIFIERs
 454         // and Targets
 455         offer1.setCombinableWithOtherOffers(true);
 456         offer2.setCombinableWithOtherOffers(true);
 457         offer1.setOfferItemQualifierRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 458         offer1.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 459         offer2.setOfferItemQualifierRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 460         offer2.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 461         order = dataProvider.createBasicOrder();
 462         order.updatePrices();
 463         offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 464         assertTrue(checkOrderItemOfferAppliedCount(order) == 4);
 465         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 466         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 2);
 467 
 468         verify();
 469     }
 470 
 471     public void testApplyItemQualifiersAndTargets() throws Exception {
 472         replay();
<abbr title=" 473         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 473         List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;(ðŸ”µ</abbr>
<abbr title=" 474         Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;).get(0);"> 474         Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;,ðŸ”µ</abbr>
 475         offer1.setId(1L);
<abbr title=" 476         Offer offer2 = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;).get(0);"> 476         Offer offer2 = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;,ðŸ”µ</abbr>
 477         offer2.setId(2L);
 478         OfferTargetCriteriaXref targetXref = offer2.getTargetItemCriteriaXref().iterator().next();
 479         targetXref.getOfferItemCriteria().setQuantity(4);
 480         offer2.getQualifyingItemCriteriaXref().clear();
 481         offer2.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.TARGET);
<abbr title=" 482         Offer offer3 = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;).get(0);"> 482         Offer offer3 = dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;,ðŸ”µ</abbr>
<abbr title=" 483         PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility);"> 483         PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility)ðŸ”µ</abbr>
 484         itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer1);
<abbr title=" 485         assertTrue(((qualifiedOffers.size() == 1) &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offer1)) &amp;&amp; (qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1));"> 485         assertTrue(((qualifiedOffers.size() == 1) &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offer1)) &amp;&amp;ðŸ”µ</abbr>
 486         itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer2);
<abbr title=" 487         assertTrue(((qualifiedOffers.size() == 2) &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offer2)) &amp;&amp; (qualifiedOffers.get(1).getCandidateQualifiersMap().size() == 0));"> 487         assertTrue(((qualifiedOffers.size() == 2) &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offer2)) &amp;&amp;ðŸ”µ</abbr>
 488         itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer3);
<abbr title=" 489         assertTrue(((qualifiedOffers.size() == 3) &amp;&amp; qualifiedOffers.get(2).getOffer().equals(offer3)) &amp;&amp; (qualifiedOffers.get(2).getCandidateQualifiersMap().size() == 1));"> 489         assertTrue(((qualifiedOffers.size() == 3) &amp;&amp; qualifiedOffers.get(2).getOffer().equals(offer3)) &amp;&amp;ðŸ”µ</abbr>
<abbr title=" 490         // Try with just the second offer.   Expect to get 4 targets based on the offer having no qualifiers required"> 490         // Try with just the second offer.   Expect to get 4 targets based on the offer having no qualifiðŸ”µ</abbr>
 491         // and targeting category test1 or test2 and that the offer requires 4 target criteria.
 492         Order order = dataProvider.createBasicOrder();
 493         List&lt;Offer&gt; offerList = new ArrayList&lt;Offer&gt;();
 494         offerList.add(offer2);
 495         offerService.applyAndSaveOffersToOrder(offerList, order);
 496         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 4);
 497         assertTrue(countPriceDetails(order) == 3);
<abbr title=" 498         // Now try with both offers.   Since the targets can be reused, we expect to have 4 targets on offer2"> 498         // Now try with both offers.   Since the targets can be reused, we expect to have 4 targets on ofðŸ”µ</abbr>
 499         // and 1 target on offer1
 500         order = dataProvider.createBasicOrder();
 501         offerList.add(offer1);// add in second offer (which happens to be offer1)
 502 
 503         offerService.applyAndSaveOffersToOrder(offerList, order);
 504         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 4);
 505         assertTrue(countPriceDetails(order) == 3);
 506         // All three offers - offer 3 is now higher priority so the best offer (offer 2) won&#x27;t be applied
 507         order = dataProvider.createBasicOrder();
 508         offerList.add(offer3);// add in second offer (which happens to be offer1)
 509 
 510         offer3.setPriority(-1);
 511         offerService.applyAndSaveOffersToOrder(offerList, order);
 512         assertTrue(checkOrderItemOfferAppliedQuantity(order, offer3) == 2);
 513         assertTrue(countPriceDetails(order) == 4);
 514         verify();
 515     }
 516 
 517     public class Answer implements IAnswer&lt;CandidateItemOffer&gt; {
 518         @Override
 519         public CandidateItemOffer answer() throws Throwable {
 520             return new CandidateItemOfferImpl();
 521         }
 522     }
 523 
 524     public class Answer2 implements IAnswer&lt;OrderItemAdjustment&gt; {
 525         @Override
 526         public OrderItemAdjustment answer() throws Throwable {
 527             return new OrderItemAdjustmentImpl();
 528         }
 529     }
 530 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.offer.service.processor;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import junit.framework.TestCase;</span>
  21  
  22  import org.broadleafcommerce.common.money.Money;

  23  import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  24  import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  25  import org.broadleafcommerce.core.offer.dao.OfferDao;
  26  import org.broadleafcommerce.core.offer.domain.CandidateItemOffer;
  27  import org.broadleafcommerce.core.offer.domain.CandidateItemOfferImpl;
  28  import org.broadleafcommerce.core.offer.domain.Offer;
  29  import org.broadleafcommerce.core.offer.domain.OfferImpl;
  30  import org.broadleafcommerce.core.offer.domain.OfferQualifyingCriteriaXref;
  31  import org.broadleafcommerce.core.offer.domain.OfferTargetCriteriaXref;
  32  import org.broadleafcommerce.core.offer.domain.OrderItemAdjustment;
  33  import org.broadleafcommerce.core.offer.domain.OrderItemAdjustmentImpl;
  34  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  35  import org.broadleafcommerce.core.offer.service.OfferDataItemProvider;
  36  import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  37  import org.broadleafcommerce.core.offer.service.OfferServiceUtilitiesImpl;
  38  import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  39  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactoryImpl;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtilityImpl;</span>
  43  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  44  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  45  import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  46  import org.broadleafcommerce.core.offer.service.type.OfferItemRestrictionRuleType;
  47  import org.broadleafcommerce.core.order.dao.FulfillmentGroupItemDao;
  48  import org.broadleafcommerce.core.order.dao.OrderItemDao;
  49  import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;
  50  import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  51  import org.broadleafcommerce.core.order.domain.Order;
  52  import org.broadleafcommerce.core.order.domain.OrderItem;
  53  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  54  import org.broadleafcommerce.core.order.domain.OrderMultishipOption;
  55  import org.broadleafcommerce.core.order.service.FulfillmentGroupService;
  56  import org.broadleafcommerce.core.order.service.OrderItemService;
  57  import org.broadleafcommerce.core.order.service.OrderMultishipOptionService;
  58  import org.broadleafcommerce.core.order.service.OrderService;
  59  import org.broadleafcommerce.core.order.service.call.FulfillmentGroupItemRequest;
  60  import org.easymock.EasyMock;
  61  import org.easymock.IAnswer;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -</span>
  63  import java.util.ArrayList;
  64  import java.util.List;
  65  import java.util.TimeZone;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -import junit.framework.TestCase;</span>
  68  
  69  /**
  70   *
  71   * @author jfischer
  72   *
  73   */
  74  public class ItemOfferProcessorTest extends TestCase {
  75  
  76      protected OfferDao offerDaoMock;
  77      protected OrderItemDao orderItemDaoMock;
  78      protected OrderService orderServiceMock;
  79      protected OfferServiceImpl offerService;
  80      protected OrderItemService orderItemServiceMock;
  81      protected FulfillmentGroupItemDao fgItemDaoMock;
  82      protected OfferDataItemProvider dataProvider = new OfferDataItemProvider();
  83      protected FulfillmentGroupService fgServiceMock;
  84      protected OrderMultishipOptionService multishipOptionServiceMock;
  85      protected OfferTimeZoneProcessor offerTimeZoneProcessorMock;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +    protected PromotableOfferUtility promotableOfferUtility;</span>
  87  
  88      protected ItemOfferProcessorImpl itemProcessor;
  89  
  90      @Override
  91      protected void setUp() throws Exception {
  92  
  93          CustomerOfferDao customerOfferDaoMock = EasyMock.createMock(CustomerOfferDao.class);
  94          OfferCodeDao offerCodeDaoMock = EasyMock.createMock(OfferCodeDao.class);
  95          offerDaoMock = EasyMock.createMock(OfferDao.class);
  96          orderItemDaoMock = EasyMock.createMock(OrderItemDao.class);
  97          orderServiceMock = EasyMock.createMock(OrderService.class);
  98          orderItemServiceMock = EasyMock.createMock(OrderItemService.class);
  99          fgItemDaoMock = EasyMock.createMock(FulfillmentGroupItemDao.class);
 100          fgServiceMock = EasyMock.createMock(FulfillmentGroupService.class);
 101          multishipOptionServiceMock = EasyMock.createMock(OrderMultishipOptionService.class);
 102          offerTimeZoneProcessorMock = EasyMock.createMock(OfferTimeZoneProcessor.class);

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +        promotableOfferUtility = new PromotableOfferUtilityImpl();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +        OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl(promotableOfferUtility);</span>
 109          offerServiceUtilities.setOfferDao(offerDaoMock);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -        offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -        itemProcessor = new ItemOfferProcessorImpl();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +        offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +        itemProcessor = new ItemOfferProcessorImpl(promotableOfferUtility);</span>
 116          itemProcessor.setOfferDao(offerDaoMock);
 117          itemProcessor.setOrderItemDao(orderItemDaoMock);
 118          itemProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -        itemProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +        itemProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));</span>
 121          itemProcessor.setOfferServiceUtilities(offerServiceUtilities);
 122  
 123          offerService = new OfferServiceImpl();
 124  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -        OrderOfferProcessorImpl orderProcessor = new OrderOfferProcessorImpl();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        OrderOfferProcessorImpl orderProcessor = new OrderOfferProcessorImpl(promotableOfferUtility);</span>
 127          orderProcessor.setOfferDao(offerDaoMock);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -        orderProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        orderProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));</span>
 130          orderProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
 131          orderProcessor.setOrderItemDao(orderItemDaoMock);
 132          orderProcessor.setOfferServiceUtilities(offerServiceUtilities);
 133  
 134          offerService.setCustomerOfferDao(customerOfferDaoMock);
 135          offerService.setOfferCodeDao(offerCodeDaoMock);
 136          offerService.setOfferDao(offerDaoMock);
 137          offerService.setOrderOfferProcessor(orderProcessor);
 138          offerService.setItemOfferProcessor(itemProcessor);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -        offerService.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +        offerService.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));</span>
 141          offerService.setOrderService(orderServiceMock);
 142      }
 143  
 144      public void replay() throws Exception {
<abbr title=" 145          EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAnswer()).anyTimes();"> 145          EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.getCreateOrðŸ”µ</abbr>
<abbr title=" 146          EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCreateOrderItemQualifierAnswer()).anyTimes();"> 146          EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCreateOrdeðŸ”µ</abbr>
<abbr title=" 147          EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAdjustmentAnswer()).anyTimes();"> 147          EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProvider.getCrðŸ”µ</abbr>
 148  
<abbr title=" 149          EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getAddItemToFulfillmentGroupAnswer()).anyTimes();"> 149          EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.class), EðŸ”µ</abbr>
<abbr title=" 150          EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getRemoveItemFromOrderAnswer()).anyTimes();"> 150          EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EasyMock.eðŸ”µ</abbr>
<abbr title=" 151          EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).andAnswer(OfferDataItemProvider.getSaveOrderAnswer()).anyTimes();"> 151          EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).andAnswer(OðŸ”µ</abbr>
 152  
 153          EasyMock.expect(orderServiceMock.getAutomaticallyMergeLikeItems()).andReturn(true).anyTimes();
 154  
<abbr title=" 155          EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OfferDataItemProvider.getSaveOrderItemAnswer()).anyTimes();"> 155          EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OfferDataItemðŸ”µ</abbr>
<abbr title=" 156          EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataItemProvider.getSaveFulfillmentGroupItemAnswer()).anyTimes();"> 156          EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataItemProviðŸ”µ</abbr>
 157  
<abbr title=" 158          EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;List&lt;OrderMultishipOption&gt;&gt;() {"> 158          EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).andAnswer(ðŸ”µ</abbr>
 159  
 160              @Override
 161              public List&lt;OrderMultishipOption&gt; answer() throws Throwable {
 162                  return new ArrayList&lt;OrderMultishipOption&gt;();
 163              }
 164          }).anyTimes();
 165  
 166          multishipOptionServiceMock.deleteAllOrderMultishipOptions(EasyMock.isA(Order.class));
 167          EasyMock.expectLastCall().anyTimes();
<abbr title=" 168          EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getSameOrderAnswer()).anyTimes();"> 168          EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EasyMock.eðŸ”µ</abbr>
<abbr title=" 169          EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupItemAnswer()).anyTimes();"> 169          EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupItemAnsweðŸ”µ</abbr>
 170          fgItemDaoMock.delete(EasyMock.isA(FulfillmentGroupItem.class));
 171          EasyMock.expectLastCall().anyTimes();
<abbr title=" 172          EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(TimeZone.getTimeZone(&quot;CST&quot;)).anyTimes();"> 172          EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(TimeZone.ðŸ”µ</abbr>
 173  
 174          EasyMock.replay(offerDaoMock);
 175          EasyMock.replay(orderItemDaoMock);
 176          EasyMock.replay(orderServiceMock);
 177          EasyMock.replay(orderItemServiceMock);
 178          EasyMock.replay(fgItemDaoMock);
 179          EasyMock.replay(fgServiceMock);
 180          EasyMock.replay(multishipOptionServiceMock);
 181          EasyMock.replay(offerTimeZoneProcessorMock);
 182      }
 183  
 184      public void verify() {
 185          EasyMock.verify(offerDaoMock);
 186          EasyMock.verify(orderItemDaoMock);
 187          EasyMock.verify(orderServiceMock);
 188          EasyMock.verify(orderItemServiceMock);
 189          EasyMock.verify(fgItemDaoMock);
 190          EasyMock.verify(fgServiceMock);
 191          EasyMock.verify(multishipOptionServiceMock);
 192          EasyMock.verify(offerTimeZoneProcessorMock);
 193      }
 194  
 195      public void testFilterItemLevelOffer() throws Exception {
 196          replay();
 197  
 198          List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 199          List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 200              &quot;order.subTotal.getAmount()&gt;20&quot;,
 201                  OfferDiscountType.PERCENT_OFF,
 202              null,
 203              null
 204          );
 205  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -        PromotableOrder order = dataProvider.createBasicPromotableOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +        PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);</span>
 208          itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 209  
 210          //test that the valid order item offer is included - legacy format - no qualifier
 211          //since there&#x27;s no qualifier, both items can apply
 212          // This line is commented out because we are no longer creating legacy offers.
<abbr title=" 213          //assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offers.get(0)));"> 213          //assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; quaðŸ”µ</abbr>
 214  
 215          qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 216          offers = dataProvider.createItemBasedOfferWithItemCriteria(
 217              &quot;order.subTotal.getAmount()&gt;20&quot;,
 218              OfferDiscountType.PERCENT_OFF,
<abbr title=" 219              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 219              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 220              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 220              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 221          );
 222          itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 223  
 224          //test that the valid order item offer is included
<abbr title=" 225          //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be only one qualifier in the qualifiers map"> 225          //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be only one ðŸ”µ</abbr>
 226          //we don&#x27;t know the targets yet, so there&#x27;s only one CandidateItemOffer for now
<abbr title=" 227          assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1);"> 227          assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualiðŸ”µ</abbr>
 228  
 229          // Add a subtotal requirement that will be met by the item offer.
 230          qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 231          offers = dataProvider.createItemBasedOfferWithItemCriteria(
 232              &quot;order.subTotal.getAmount()&gt;20&quot;,
 233              OfferDiscountType.PERCENT_OFF,
<abbr title=" 234              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 234              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 235              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 235              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 236          );
 237  
 238          offers.get(0).setQualifyingItemSubTotal(new Money(1));
 239          itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 240  
 241          //test that the valid order item offer is included
<abbr title=" 242          //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be only one qualifier in the qualifiers map"> 242          //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be only one ðŸ”µ</abbr>
 243          //we don&#x27;t know the targets yet, so there&#x27;s only one CandidateItemOffer for now
<abbr title=" 244          assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1);"> 244          assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualiðŸ”µ</abbr>
 245  
 246  
 247          // Add a subtotal requirement that will not be met by the item offer.
 248          qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 249          offers = dataProvider.createItemBasedOfferWithItemCriteria(
 250              &quot;order.subTotal.getAmount()&gt;20&quot;,
 251              OfferDiscountType.PERCENT_OFF,
<abbr title=" 252              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 252              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 253              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 253              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 254          );
 255  
 256          offers.get(0).setQualifyingItemSubTotal(new Money(99999));
 257          itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 258  
 259          // Since the item qualification subTotal is not met, the qualified offer size should
 260          // be zero.
 261          assertTrue(qualifiedOffers.size() == 0);
 262  
 263  
 264          qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 265          offers = dataProvider.createItemBasedOfferWithItemCriteria(
 266              &quot;order.subTotal.getAmount()&gt;20&quot;,
 267              OfferDiscountType.PERCENT_OFF,
<abbr title=" 268              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 268              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 269              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 269              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 270          );
 271          itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 272  
 273          //test that the invalid order item offer is excluded
 274          assertTrue(qualifiedOffers.size() == 0);
 275  
 276          verify();
 277      }
 278  
 279      public void testCouldOfferApplyToOrder() throws Exception {
 280          replay();
 281  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -        PromotableOrder order = dataProvider.createBasicPromotableOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +        PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);</span>
 284          List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 285              &quot;order.subTotal.getAmount()&gt;20&quot;,
 286              OfferDiscountType.PERCENT_OFF,
 287              null,
 288              null
 289          );
 290  
<abbr title=" 291          boolean couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrderItems().get(0), order.getFulfillmentGroups().get(0));"> 291          boolean couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrderðŸ”µ</abbr>
 292          //test that the valid order item offer is included
 293          assertTrue(couldApply);
 294  
 295          offers = dataProvider.createItemBasedOfferWithItemCriteria(
 296              &quot;order.subTotal.getAmount()==0&quot;,
 297              OfferDiscountType.PERCENT_OFF,
 298              null,
 299              null
 300          );
<abbr title=" 301          couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrderItems().get(0), order.getFulfillmentGroups().get(0));"> 301          couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrderItems().ðŸ”µ</abbr>
 302          //test that the invalid order item offer is excluded
 303          assertFalse(couldApply);
 304  
 305          verify();
 306      }
 307  
 308      public void testCouldOrderItemMeetOfferRequirement() throws Exception {
 309          replay();
 310  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -        PromotableOrder order = dataProvider.createBasicPromotableOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +        PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);</span>
 313          List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 314              &quot;order.subTotal.getAmount()&gt;20&quot;,
 315              OfferDiscountType.PERCENT_OFF,
<abbr title=" 316              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 316              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 317              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 317              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 318          );
 319  
 320          OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();
<abbr title=" 321          boolean couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 321          boolean couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.gðŸ”µ</abbr>
 322          //test that the valid order item offer is included
 323          assertTrue(couldApply);
 324  
 325          offers = dataProvider.createItemBasedOfferWithItemCriteria(
 326              &quot;order.subTotal.getAmount()&gt;20&quot;,
 327              OfferDiscountType.PERCENT_OFF,
<abbr title=" 328              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 328              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 329              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 329              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 330          );
 331          xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();
<abbr title=" 332          couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 332          couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscouðŸ”µ</abbr>
 333          //test that the invalid order item offer is excluded
 334          assertFalse(couldApply);
 335  
 336          verify();
 337      }
 338  
 339      public void testCouldOfferApplyToOrderItems() throws Exception {
 340          replay();
 341  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 342 -        PromotableOrder order = dataProvider.createBasicPromotableOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +        PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);</span>
 344          List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 345              &quot;order.subTotal.getAmount()&gt;20&quot;,
 346              OfferDiscountType.PERCENT_OFF,
<abbr title=" 347              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 347              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 348              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 348              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 349          );
 350          List&lt;PromotableOrderItem&gt; orderItems = new ArrayList&lt;PromotableOrderItem&gt;();
 351          for (PromotableOrderItem orderItem : order.getDiscountableOrderItems()) {
 352              orderItems.add(orderItem);
 353          }
 354          CandidatePromotionItems candidates = itemProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);
 355          //test that the valid order item offer is included
 356          //both cart items are valid for qualification and target
 357          assertTrue(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1 &amp;&amp;
 358                  candidates.getCandidateQualifiersMap().values().iterator().next().size() == 2 &amp;&amp;
 359                  candidates.isMatchedTarget() &amp;&amp; candidates.getCandidateTargetsMap().size() == 1 &amp;&amp;
 360                  candidates.getCandidateTargetsMap().values().iterator().next().size() == 2);
 361  
 362          offers = dataProvider.createItemBasedOfferWithItemCriteria(
 363              &quot;order.subTotal.getAmount()&gt;20&quot;,
 364              OfferDiscountType.PERCENT_OFF,
<abbr title=" 365              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 365              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 366              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 366              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 367          );
 368          candidates = itemProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);
 369          //test that the invalid order item offer is excluded because there are no qualifying items
 370          assertFalse(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1);
 371  
 372          verify();
 373      }
 374  
 375      private int checkOrderItemOfferAppliedCount(Order order) {
 376          int count = 0;
 377          for (OrderItem item : order.getOrderItems()) {
 378              for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
 379                  count = count + (detail.getOrderItemPriceDetailAdjustments().size() * detail.getQuantity());
 380              }
 381          }
 382          return count;
 383      }
 384  
 385      private int checkOrderItemOfferAppliedQuantity(Order order, Offer offer) {
 386          int count = 0;
 387          for (OrderItem item : order.getOrderItems()) {
 388              for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
 389                  for (OrderItemPriceDetailAdjustment adjustment : detail.getOrderItemPriceDetailAdjustments()) {
 390                      if (adjustment.getOffer().getId().equals(offer.getId())) {
 391                          count += detail.getQuantity();
 392                      }
 393                  }
 394              }
 395          }
 396          return count;
 397      }
 398  
 399      private int countPriceDetails(Order order) {
 400          int count = 0;
 401          for (OrderItem item : order.getOrderItems()) {
 402              count = count + item.getOrderItemPriceDetails().size();
 403          }
 404          return count;
 405      }
 406  
 407  
 408      public void testApplyAllItemOffers() throws Exception {
 409  
 410  
 411          replay();
 412  
 413          Order order = dataProvider.createBasicOrder();
 414  
 415          Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(
 416              &quot;order.subTotal.getAmount()&gt;20&quot;,
 417              OfferDiscountType.PERCENT_OFF,
<abbr title=" 418              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 418              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 419              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 419              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 420          ).get(0);
 421          offer1.setId(1L);
 422  
 423          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 424          offers.add(offer1);
 425  
 426          List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 427          order.updatePrices();
 428          offerService.applyAndSaveOffersToOrder(offers, order);
 429  
 430          assertTrue(order.getTotalAdjustmentsValue().getAmount().doubleValue() &gt; 0);
 431  
 432          order = dataProvider.createBasicOrder();
 433  
 434          qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 435          offer1.setApplyDiscountToSalePrice(false);
 436          ((DiscreteOrderItem) order.getOrderItems().get(0)).getSku().setSalePrice(new Money(1D));
 437          ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(new Money(1D));
 438          order.updatePrices();
 439          offerService.applyAndSaveOffersToOrder(offers, order);
 440  
 441          assertTrue(order.getTotalAdjustmentsValue().getAmount().doubleValue() == 0);
 442  
 443          verify();
 444      }
 445  
 446      public void testApplyAdjustments() throws Exception {
 447          replay();
 448  
 449          Order order = dataProvider.createBasicOrder();
 450  
 451          Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(
 452              &quot;order.subTotal.getAmount()&gt;20&quot;,
 453              OfferDiscountType.PERCENT_OFF,
<abbr title=" 454              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 454              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 455              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 455              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 456          ).get(0);
 457          offer1.setId(1L);
 458          OfferQualifyingCriteriaXref xref = offer1.getQualifyingItemCriteriaXref().iterator().next();
 459          xref.getOfferItemCriteria().setQuantity(2);
 460          offer1.setCombinableWithOtherOffers(false);
 461          Offer offer2 = dataProvider.createItemBasedOfferWithItemCriteria(
 462              &quot;order.subTotal.getAmount()&gt;20&quot;,
 463              OfferDiscountType.PERCENT_OFF,
<abbr title=" 464              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 464              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 465              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 465              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 466          ).get(0);
 467          offer2.setId(2L);
 468  
 469          List&lt;Offer&gt; offerListWithOneOffer = new ArrayList&lt;Offer&gt;();
 470          offerListWithOneOffer.add(offer1);
 471  
 472          List&lt;Offer&gt; offerListWithTwoOffers = new ArrayList&lt;Offer&gt;();
 473          offerListWithTwoOffers.add(offer1);
 474          offerListWithTwoOffers.add(offer2);
 475  
 476          order.updatePrices();
 477          offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 478          assertTrue(checkOrderItemOfferAppliedCount(order) == 1);
 479          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 1);
 480  
 481          // Add the second offer.   The first was nonCombinable so it should still be 1
 482          order = dataProvider.createBasicOrder();
 483          order.updatePrices();
 484          offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 485          assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 486          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 487          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 488  
 489  
 490          // Reset offer1 to combinable.   Now both should be applied.
 491          offer1.setCombinableWithOtherOffers(true);
 492          order = dataProvider.createBasicOrder();
 493          order.updatePrices();
 494          offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 495          assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 496          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 497          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 498  
 499          // Offer 1 back to nonCombinable but don&#x27;t allow discount to the sale price
 500          // and make the sale price a better overall offer
 501          offer1.setCombinableWithOtherOffers(false);
 502          offer1.setApplyDiscountToSalePrice(false);
 503          order = dataProvider.createBasicOrder();
 504          ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(new Money(10D));
 505          order.updatePrices();
 506          offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 507          assertTrue(checkOrderItemOfferAppliedCount(order) == 0);
 508  
 509          // Try again with two offers.   The second should be applied.
 510          order.updatePrices();
 511          offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 512          assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 513  
 514          // Trying with 2nd offer as nonCombinable.
 515          offer1.setCombinableWithOtherOffers(true);
 516          ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(null);
 517          offer2.setCombinableWithOtherOffers(false);
 518  
 519          order.updatePrices();
 520          offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 521          assertTrue(checkOrderItemOfferAppliedCount(order) == 1);
 522  
 523          order.updatePrices();
 524          offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 525          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 526          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 527  
 528          // Set qualifying criteria quantity to 1
 529          // Set qualifying target criteria to 2
 530          order = dataProvider.createBasicOrder();
 531          xref = offer1.getQualifyingItemCriteriaXref().iterator().next();
 532          xref.getOfferItemCriteria().setQuantity(1);
 533  
 534          OfferTargetCriteriaXref targetXref = offer1.getTargetItemCriteriaXref().iterator().next();
 535          targetXref.getOfferItemCriteria().setQuantity(2);
 536          order.updatePrices();
 537          offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 538          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 2);
 539  
 540          // Reset both offers to combinable and the qualifiers as allowing duplicate QUALIFIERs
 541          // and Targets
 542          offer1.setCombinableWithOtherOffers(true);
 543          offer2.setCombinableWithOtherOffers(true);
 544          offer1.setOfferItemQualifierRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 545          offer1.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 546          offer2.setOfferItemQualifierRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 547          offer2.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 548          order = dataProvider.createBasicOrder();
 549          order.updatePrices();
 550          offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 551          assertTrue(checkOrderItemOfferAppliedCount(order) == 4);
 552          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 553          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 2);
 554  
 555          verify();
 556      }
 557  
 558      public void testApplyItemQualifiersAndTargets() throws Exception {
 559          replay();
 560  
 561          List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 562          Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(
 563              &quot;order.subTotal.getAmount()&gt;20&quot;,
 564              OfferDiscountType.PERCENT_OFF,
<abbr title=" 565              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 565              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 566              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 566              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 567          ).get(0);
 568          offer1.setId(1L);
 569          Offer offer2 = dataProvider.createItemBasedOfferWithItemCriteria(
 570              &quot;order.subTotal.getAmount()&gt;20&quot;,
 571              OfferDiscountType.PERCENT_OFF,
<abbr title=" 572              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 572              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 573              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 573              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 574          ).get(0);
 575          offer2.setId(2L);
 576  
 577          OfferTargetCriteriaXref targetXref = offer2.getTargetItemCriteriaXref().iterator().next();
 578          targetXref.getOfferItemCriteria().setQuantity(4);
 579          offer2.getQualifyingItemCriteriaXref().clear();
 580          offer2.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.TARGET);
 581          Offer offer3 = dataProvider.createItemBasedOfferWithItemCriteria(
 582              &quot;order.subTotal.getAmount()&gt;20&quot;,
 583              OfferDiscountType.PERCENT_OFF,
<abbr title=" 584              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 584              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 585              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 585              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 586          ).get(0);
 587  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 588 -        PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 589 +        PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility);</span>
 590          itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer1);
<abbr title=" 591          assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offer1) &amp;&amp; qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1);"> 591          assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offer1) &amp;&amp; qualifiedOffðŸ”µ</abbr>
 592  
 593          itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer2);
<abbr title=" 594          assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offer2) &amp;&amp; qualifiedOffers.get(1).getCandidateQualifiersMap().size() == 0);"> 594          assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offer2) &amp;&amp; qualifiedOffðŸ”µ</abbr>
 595  
 596          itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer3);
<abbr title=" 597          assertTrue(qualifiedOffers.size() == 3 &amp;&amp; qualifiedOffers.get(2).getOffer().equals(offer3) &amp;&amp; qualifiedOffers.get(2).getCandidateQualifiersMap().size() == 1);"> 597          assertTrue(qualifiedOffers.size() == 3 &amp;&amp; qualifiedOffers.get(2).getOffer().equals(offer3) &amp;&amp; qualifiedOffðŸ”µ</abbr>
 598  
<abbr title=" 599          // Try with just the second offer.   Expect to get 4 targets based on the offer having no qualifiers required"> 599          // Try with just the second offer.   Expect to get 4 targets based on the offer having no qualifiers requiðŸ”µ</abbr>
 600          // and targeting category test1 or test2 and that the offer requires 4 target criteria.
 601          Order order = dataProvider.createBasicOrder();
 602          List&lt;Offer&gt; offerList = new ArrayList&lt;Offer&gt;();
 603          offerList.add(offer2);
 604          offerService.applyAndSaveOffersToOrder(offerList, order);
 605          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 4);
 606          assertTrue(countPriceDetails(order) == 3);
 607  
 608          // Now try with both offers.   Since the targets can be reused, we expect to have 4 targets on offer2
 609          // and 1 target on offer1
 610          order = dataProvider.createBasicOrder();
 611          offerList.add(offer1); // add in second offer (which happens to be offer1)
 612  
 613          offerService.applyAndSaveOffersToOrder(offerList, order);
 614          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 4);
 615          assertTrue(countPriceDetails(order) == 3);
 616  
 617          // All three offers - offer 3 is now higher priority so the best offer (offer 2) won&#x27;t be applied
 618          order = dataProvider.createBasicOrder();
 619          offerList.add(offer3); // add in second offer (which happens to be offer1)
 620          offer3.setPriority(-1);
 621          offerService.applyAndSaveOffersToOrder(offerList, order);
 622          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer3) == 2);
 623          assertTrue(countPriceDetails(order) == 4);
 624  
 625          verify();
 626      }
 627  
 628      public class Answer implements IAnswer&lt;CandidateItemOffer&gt; {
 629  
 630          @Override
 631          public CandidateItemOffer answer() throws Throwable {
 632              return new CandidateItemOfferImpl();
 633          }
 634  
 635      }
 636  
 637      public class Answer2 implements IAnswer&lt;OrderItemAdjustment&gt; {
 638  
 639          @Override
 640          public OrderItemAdjustment answer() throws Throwable {
 641              return new OrderItemAdjustmentImpl();
 642          }
 643  
 644      }
 645  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.offer.service.processor;


  19  
  20  import org.broadleafcommerce.common.money.Money;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import org.broadleafcommerce.common.service.GenericEntityService;</span>
  22  import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  23  import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  24  import org.broadleafcommerce.core.offer.dao.OfferDao;
  25  import org.broadleafcommerce.core.offer.domain.CandidateItemOffer;
  26  import org.broadleafcommerce.core.offer.domain.CandidateItemOfferImpl;
  27  import org.broadleafcommerce.core.offer.domain.Offer;
  28  import org.broadleafcommerce.core.offer.domain.OfferImpl;
  29  import org.broadleafcommerce.core.offer.domain.OfferQualifyingCriteriaXref;
  30  import org.broadleafcommerce.core.offer.domain.OfferTargetCriteriaXref;
  31  import org.broadleafcommerce.core.offer.domain.OrderItemAdjustment;
  32  import org.broadleafcommerce.core.offer.domain.OrderItemAdjustmentImpl;
  33  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  34  import org.broadleafcommerce.core.offer.service.OfferDataItemProvider;
  35  import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  36  import org.broadleafcommerce.core.offer.service.OfferServiceUtilitiesImpl;
  37  import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  38  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  39  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactoryImpl;


  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  42  import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  43  import org.broadleafcommerce.core.offer.service.type.OfferItemRestrictionRuleType;
  44  import org.broadleafcommerce.core.order.dao.FulfillmentGroupItemDao;
  45  import org.broadleafcommerce.core.order.dao.OrderItemDao;
  46  import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;
  47  import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  48  import org.broadleafcommerce.core.order.domain.Order;
  49  import org.broadleafcommerce.core.order.domain.OrderItem;
  50  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  51  import org.broadleafcommerce.core.order.domain.OrderMultishipOption;
  52  import org.broadleafcommerce.core.order.service.FulfillmentGroupService;
  53  import org.broadleafcommerce.core.order.service.OrderItemService;
  54  import org.broadleafcommerce.core.order.service.OrderMultishipOptionService;
  55  import org.broadleafcommerce.core.order.service.OrderService;
  56  import org.broadleafcommerce.core.order.service.call.FulfillmentGroupItemRequest;
  57  import org.easymock.EasyMock;
  58  import org.easymock.IAnswer;
  59  
  60  import java.util.ArrayList;
  61  import java.util.List;
  62  import java.util.TimeZone;
  63  
  64  import junit.framework.TestCase;
  65  
  66  /**
  67   *
  68   * @author jfischer
  69   *
  70   */
  71  public class ItemOfferProcessorTest extends TestCase {
  72  
  73      protected OfferDao offerDaoMock;
  74      protected OrderItemDao orderItemDaoMock;
  75      protected OrderService orderServiceMock;
  76      protected OfferServiceImpl offerService;
  77      protected OrderItemService orderItemServiceMock;
  78      protected FulfillmentGroupItemDao fgItemDaoMock;
  79      protected OfferDataItemProvider dataProvider = new OfferDataItemProvider();
  80      protected FulfillmentGroupService fgServiceMock;
  81      protected OrderMultishipOptionService multishipOptionServiceMock;
  82      protected OfferTimeZoneProcessor offerTimeZoneProcessorMock;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +    protected GenericEntityService genericEntityServiceMock;</span>
  84  
  85      protected ItemOfferProcessorImpl itemProcessor;
  86  
  87      @Override
  88      protected void setUp() throws Exception {
  89  
  90          CustomerOfferDao customerOfferDaoMock = EasyMock.createMock(CustomerOfferDao.class);
  91          OfferCodeDao offerCodeDaoMock = EasyMock.createMock(OfferCodeDao.class);
  92          offerDaoMock = EasyMock.createMock(OfferDao.class);
  93          orderItemDaoMock = EasyMock.createMock(OrderItemDao.class);
  94          orderServiceMock = EasyMock.createMock(OrderService.class);
  95          orderItemServiceMock = EasyMock.createMock(OrderItemService.class);
  96          fgItemDaoMock = EasyMock.createMock(FulfillmentGroupItemDao.class);
  97          fgServiceMock = EasyMock.createMock(FulfillmentGroupService.class);
  98          multishipOptionServiceMock = EasyMock.createMock(OrderMultishipOptionService.class);
  99          offerTimeZoneProcessorMock = EasyMock.createMock(OfferTimeZoneProcessor.class);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +        genericEntityServiceMock = EasyMock.createMock(GenericEntityService.class);</span>
 101  
 102          OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl();




 103          offerServiceUtilities.setOfferDao(offerDaoMock);
 104          offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl());
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +        offerServiceUtilities.setGenericEntityService(genericEntityServiceMock);</span>
 106  
 107          itemProcessor = new ItemOfferProcessorImpl();



 108          itemProcessor.setOfferDao(offerDaoMock);
 109          itemProcessor.setOrderItemDao(orderItemDaoMock);
 110          itemProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
 111          itemProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl());

 112          itemProcessor.setOfferServiceUtilities(offerServiceUtilities);
 113  
 114          offerService = new OfferServiceImpl();
 115  
 116          OrderOfferProcessorImpl orderProcessor = new OrderOfferProcessorImpl();

 117          orderProcessor.setOfferDao(offerDaoMock);
 118          orderProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl());

 119          orderProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
 120          orderProcessor.setOrderItemDao(orderItemDaoMock);
 121          orderProcessor.setOfferServiceUtilities(offerServiceUtilities);
 122  
 123          offerService.setCustomerOfferDao(customerOfferDaoMock);
 124          offerService.setOfferCodeDao(offerCodeDaoMock);
 125          offerService.setOfferDao(offerDaoMock);
 126          offerService.setOrderOfferProcessor(orderProcessor);
 127          offerService.setItemOfferProcessor(itemProcessor);
 128          offerService.setPromotableItemFactory(new PromotableItemFactoryImpl());

 129          offerService.setOrderService(orderServiceMock);
 130      }
 131  
 132      public void replay() throws Exception {
<abbr title=" 133          EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAnswer()).anyTimes();"> 133          EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.getCreateOrðŸ”µ</abbr>
<abbr title=" 134          EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCreateOrderItemQualifierAnswer()).anyTimes();"> 134          EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCreateOrdeðŸ”µ</abbr>
<abbr title=" 135          EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAdjustmentAnswer()).anyTimes();"> 135          EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProvider.getCrðŸ”µ</abbr>
 136  
<abbr title=" 137          EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getAddItemToFulfillmentGroupAnswer()).anyTimes();"> 137          EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.class), EðŸ”µ</abbr>
<abbr title=" 138          EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getRemoveItemFromOrderAnswer()).anyTimes();"> 138          EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EasyMock.eðŸ”µ</abbr>
<abbr title=" 139          EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).andAnswer(OfferDataItemProvider.getSaveOrderAnswer()).anyTimes();"> 139          EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).andAnswer(OðŸ”µ</abbr>
 140  
 141          EasyMock.expect(orderServiceMock.getAutomaticallyMergeLikeItems()).andReturn(true).anyTimes();
 142  
<abbr title=" 143          EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OfferDataItemProvider.getSaveOrderItemAnswer()).anyTimes();"> 143          EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OfferDataItemðŸ”µ</abbr>
<abbr title=" 144          EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataItemProvider.getSaveFulfillmentGroupItemAnswer()).anyTimes();"> 144          EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataItemProviðŸ”µ</abbr>
 145  
<abbr title=" 146          EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;List&lt;OrderMultishipOption&gt;&gt;() {"> 146          EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).andAnswer(ðŸ”µ</abbr>
 147  
 148              @Override
 149              public List&lt;OrderMultishipOption&gt; answer() throws Throwable {
 150                  return new ArrayList&lt;OrderMultishipOption&gt;();
 151              }
 152          }).anyTimes();
 153  
 154          multishipOptionServiceMock.deleteAllOrderMultishipOptions(EasyMock.isA(Order.class));
 155          EasyMock.expectLastCall().anyTimes();
<abbr title=" 156          EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getSameOrderAnswer()).anyTimes();"> 156          EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EasyMock.eðŸ”µ</abbr>
<abbr title=" 157          EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupItemAnswer()).anyTimes();"> 157          EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupItemAnsweðŸ”µ</abbr>
 158          fgItemDaoMock.delete(EasyMock.isA(FulfillmentGroupItem.class));
 159          EasyMock.expectLastCall().anyTimes();
<abbr title=" 160          EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(TimeZone.getTimeZone(&quot;CST&quot;)).anyTimes();"> 160          EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(TimeZone.ðŸ”µ</abbr>
 161  
 162          EasyMock.replay(offerDaoMock);
 163          EasyMock.replay(orderItemDaoMock);
 164          EasyMock.replay(orderServiceMock);
 165          EasyMock.replay(orderItemServiceMock);
 166          EasyMock.replay(fgItemDaoMock);
 167          EasyMock.replay(fgServiceMock);
 168          EasyMock.replay(multishipOptionServiceMock);
 169          EasyMock.replay(offerTimeZoneProcessorMock);
 170      }
 171  
 172      public void verify() {
 173          EasyMock.verify(offerDaoMock);
 174          EasyMock.verify(orderItemDaoMock);
 175          EasyMock.verify(orderServiceMock);
 176          EasyMock.verify(orderItemServiceMock);
 177          EasyMock.verify(fgItemDaoMock);
 178          EasyMock.verify(fgServiceMock);
 179          EasyMock.verify(multishipOptionServiceMock);
 180          EasyMock.verify(offerTimeZoneProcessorMock);
 181      }
 182  
 183      public void testFilterItemLevelOffer() throws Exception {
 184          replay();
 185  
 186          List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 187          List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 188              &quot;order.subTotal.getAmount()&gt;20&quot;,
 189                  OfferDiscountType.PERCENT_OFF,
 190              null,
 191              null
 192          );
 193  
 194          PromotableOrder order = dataProvider.createBasicPromotableOrder();

 195          itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 196  
 197          //test that the valid order item offer is included - legacy format - no qualifier
 198          //since there&#x27;s no qualifier, both items can apply
 199          // This line is commented out because we are no longer creating legacy offers.
<abbr title=" 200          //assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offers.get(0)));"> 200          //assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; quaðŸ”µ</abbr>
 201  
 202          qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 203          offers = dataProvider.createItemBasedOfferWithItemCriteria(
 204              &quot;order.subTotal.getAmount()&gt;20&quot;,
 205              OfferDiscountType.PERCENT_OFF,
<abbr title=" 206              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 206              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 207              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 207              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 208          );
 209          itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 210  
 211          //test that the valid order item offer is included
<abbr title=" 212          //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be only one qualifier in the qualifiers map"> 212          //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be only one ðŸ”µ</abbr>
 213          //we don&#x27;t know the targets yet, so there&#x27;s only one CandidateItemOffer for now
<abbr title=" 214          assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1);"> 214          assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualiðŸ”µ</abbr>
 215  
 216          // Add a subtotal requirement that will be met by the item offer.
 217          qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 218          offers = dataProvider.createItemBasedOfferWithItemCriteria(
 219              &quot;order.subTotal.getAmount()&gt;20&quot;,
 220              OfferDiscountType.PERCENT_OFF,
<abbr title=" 221              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 221              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 222              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 222              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 223          );
 224  
 225          offers.get(0).setQualifyingItemSubTotal(new Money(1));
 226          itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 227  
 228          //test that the valid order item offer is included
<abbr title=" 229          //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be only one qualifier in the qualifiers map"> 229          //there is a qualifier and the item qualifying criteria requires only 1, therefore there will be only one ðŸ”µ</abbr>
 230          //we don&#x27;t know the targets yet, so there&#x27;s only one CandidateItemOffer for now
<abbr title=" 231          assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1);"> 231          assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)) &amp;&amp; qualiðŸ”µ</abbr>
 232  
 233  
 234          // Add a subtotal requirement that will not be met by the item offer.
 235          qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 236          offers = dataProvider.createItemBasedOfferWithItemCriteria(
 237              &quot;order.subTotal.getAmount()&gt;20&quot;,
 238              OfferDiscountType.PERCENT_OFF,
<abbr title=" 239              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 239              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 240              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 240              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 241          );
 242  
 243          offers.get(0).setQualifyingItemSubTotal(new Money(99999));
 244          itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 245  
 246          // Since the item qualification subTotal is not met, the qualified offer size should
 247          // be zero.
 248          assertTrue(qualifiedOffers.size() == 0);
 249  
 250  
 251          qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 252          offers = dataProvider.createItemBasedOfferWithItemCriteria(
 253              &quot;order.subTotal.getAmount()&gt;20&quot;,
 254              OfferDiscountType.PERCENT_OFF,
<abbr title=" 255              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 255              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 256              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 256              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 257          );
 258          itemProcessor.filterItemLevelOffer(order, qualifiedOffers, offers.get(0));
 259  
 260          //test that the invalid order item offer is excluded
 261          assertTrue(qualifiedOffers.size() == 0);
 262  
 263          verify();
 264      }
 265  
 266      public void testCouldOfferApplyToOrder() throws Exception {
 267          replay();
 268  
 269          PromotableOrder order = dataProvider.createBasicPromotableOrder();

 270          List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 271              &quot;order.subTotal.getAmount()&gt;20&quot;,
 272              OfferDiscountType.PERCENT_OFF,
 273              null,
 274              null
 275          );
 276  
<abbr title=" 277          boolean couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrderItems().get(0), order.getFulfillmentGroups().get(0));"> 277          boolean couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrderðŸ”µ</abbr>
 278          //test that the valid order item offer is included
 279          assertTrue(couldApply);
 280  
 281          offers = dataProvider.createItemBasedOfferWithItemCriteria(
 282              &quot;order.subTotal.getAmount()==0&quot;,
 283              OfferDiscountType.PERCENT_OFF,
 284              null,
 285              null
 286          );
<abbr title=" 287          couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrderItems().get(0), order.getFulfillmentGroups().get(0));"> 287          couldApply = itemProcessor.couldOfferApplyToOrder(offers.get(0), order, order.getDiscountableOrderItems().ðŸ”µ</abbr>
 288          //test that the invalid order item offer is excluded
 289          assertFalse(couldApply);
 290  
 291          verify();
 292      }
 293  
 294      public void testCouldOrderItemMeetOfferRequirement() throws Exception {
 295          replay();
 296  
 297          PromotableOrder order = dataProvider.createBasicPromotableOrder();

 298          List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 299              &quot;order.subTotal.getAmount()&gt;20&quot;,
 300              OfferDiscountType.PERCENT_OFF,
<abbr title=" 301              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 301              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 302              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 302              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 303          );
 304  
 305          OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();
<abbr title=" 306          boolean couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 306          boolean couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.gðŸ”µ</abbr>
 307          //test that the valid order item offer is included
 308          assertTrue(couldApply);
 309  
 310          offers = dataProvider.createItemBasedOfferWithItemCriteria(
 311              &quot;order.subTotal.getAmount()&gt;20&quot;,
 312              OfferDiscountType.PERCENT_OFF,
<abbr title=" 313              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 313              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 314              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 314              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 315          );
 316          xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();
<abbr title=" 317          couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 317          couldApply = itemProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscouðŸ”µ</abbr>
 318          //test that the invalid order item offer is excluded
 319          assertFalse(couldApply);
 320  
 321          verify();
 322      }
 323  
 324      public void testCouldOfferApplyToOrderItems() throws Exception {
 325          replay();
 326  
 327          PromotableOrder order = dataProvider.createBasicPromotableOrder();

 328          List&lt;Offer&gt; offers = dataProvider.createItemBasedOfferWithItemCriteria(
 329              &quot;order.subTotal.getAmount()&gt;20&quot;,
 330              OfferDiscountType.PERCENT_OFF,
<abbr title=" 331              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 331              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 332              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 332              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 333          );
 334          List&lt;PromotableOrderItem&gt; orderItems = new ArrayList&lt;PromotableOrderItem&gt;();
 335          for (PromotableOrderItem orderItem : order.getDiscountableOrderItems()) {
 336              orderItems.add(orderItem);
 337          }
 338          CandidatePromotionItems candidates = itemProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);
 339          //test that the valid order item offer is included
 340          //both cart items are valid for qualification and target
 341          assertTrue(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1 &amp;&amp;
 342                  candidates.getCandidateQualifiersMap().values().iterator().next().size() == 2 &amp;&amp;
 343                  candidates.isMatchedTarget() &amp;&amp; candidates.getCandidateTargetsMap().size() == 1 &amp;&amp;
 344                  candidates.getCandidateTargetsMap().values().iterator().next().size() == 2);
 345  
 346          offers = dataProvider.createItemBasedOfferWithItemCriteria(
 347              &quot;order.subTotal.getAmount()&gt;20&quot;,
 348              OfferDiscountType.PERCENT_OFF,
<abbr title=" 349              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 349              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 350              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 350              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 351          );
 352          candidates = itemProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);
 353          //test that the invalid order item offer is excluded because there are no qualifying items
 354          assertFalse(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1);
 355  
 356          verify();
 357      }
 358  
 359      private int checkOrderItemOfferAppliedCount(Order order) {
 360          int count = 0;
 361          for (OrderItem item : order.getOrderItems()) {
 362              for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
 363                  count = count + (detail.getOrderItemPriceDetailAdjustments().size() * detail.getQuantity());
 364              }
 365          }
 366          return count;
 367      }
 368  
 369      private int checkOrderItemOfferAppliedQuantity(Order order, Offer offer) {
 370          int count = 0;
 371          for (OrderItem item : order.getOrderItems()) {
 372              for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
 373                  for (OrderItemPriceDetailAdjustment adjustment : detail.getOrderItemPriceDetailAdjustments()) {
 374                      if (adjustment.getOffer().getId().equals(offer.getId())) {
 375                          count += detail.getQuantity();
 376                      }
 377                  }
 378              }
 379          }
 380          return count;
 381      }
 382  
 383      private int countPriceDetails(Order order) {
 384          int count = 0;
 385          for (OrderItem item : order.getOrderItems()) {
 386              count = count + item.getOrderItemPriceDetails().size();
 387          }
 388          return count;
 389      }
 390  
 391  
 392      public void testApplyAllItemOffers() throws Exception {
 393  
 394  
 395          replay();
 396  
 397          Order order = dataProvider.createBasicOrder();
 398  
 399          Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(
 400              &quot;order.subTotal.getAmount()&gt;20&quot;,
 401              OfferDiscountType.PERCENT_OFF,
<abbr title=" 402              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 402              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 403              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 403              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 404          ).get(0);
 405          offer1.setId(1L);
 406  
 407          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();
 408          offers.add(offer1);
 409  
 410          List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 411          order.updatePrices();
 412          offerService.applyAndSaveOffersToOrder(offers, order);
 413  
 414          assertTrue(order.getTotalAdjustmentsValue().getAmount().doubleValue() &gt; 0);
 415  
 416          order = dataProvider.createBasicOrder();
 417  
 418          qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 419          offer1.setApplyDiscountToSalePrice(false);
 420          ((DiscreteOrderItem) order.getOrderItems().get(0)).getSku().setSalePrice(new Money(1D));
 421          ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(new Money(1D));
 422          order.updatePrices();
 423          offerService.applyAndSaveOffersToOrder(offers, order);
 424  
 425          assertTrue(order.getTotalAdjustmentsValue().getAmount().doubleValue() == 0);
 426  
 427          verify();
 428      }
 429  
 430      public void testApplyAdjustments() throws Exception {
 431          replay();
 432  
 433          Order order = dataProvider.createBasicOrder();
 434  
 435          Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(
 436              &quot;order.subTotal.getAmount()&gt;20&quot;,
 437              OfferDiscountType.PERCENT_OFF,
<abbr title=" 438              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 438              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 439              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 439              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 440          ).get(0);
 441          offer1.setId(1L);
 442          OfferQualifyingCriteriaXref xref = offer1.getQualifyingItemCriteriaXref().iterator().next();
 443          xref.getOfferItemCriteria().setQuantity(2);
 444          offer1.setCombinableWithOtherOffers(false);
 445          Offer offer2 = dataProvider.createItemBasedOfferWithItemCriteria(
 446              &quot;order.subTotal.getAmount()&gt;20&quot;,
 447              OfferDiscountType.PERCENT_OFF,
<abbr title=" 448              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 448              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 449              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 449              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 450          ).get(0);
 451          offer2.setId(2L);
 452  
 453          List&lt;Offer&gt; offerListWithOneOffer = new ArrayList&lt;Offer&gt;();
 454          offerListWithOneOffer.add(offer1);
 455  
 456          List&lt;Offer&gt; offerListWithTwoOffers = new ArrayList&lt;Offer&gt;();
 457          offerListWithTwoOffers.add(offer1);
 458          offerListWithTwoOffers.add(offer2);
 459  
 460          order.updatePrices();
 461          offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 462          assertTrue(checkOrderItemOfferAppliedCount(order) == 1);
 463          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 1);
 464  
 465          // Add the second offer.   The first was nonCombinable so it should still be 1
 466          order = dataProvider.createBasicOrder();
 467          order.updatePrices();
 468          offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 469          assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 470          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 471          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 472  
 473  
 474          // Reset offer1 to combinable.   Now both should be applied.
 475          offer1.setCombinableWithOtherOffers(true);
 476          order = dataProvider.createBasicOrder();
 477          order.updatePrices();
 478          offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 479          assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 480          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 481          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 482  
 483          // Offer 1 back to nonCombinable but don&#x27;t allow discount to the sale price
 484          // and make the sale price a better overall offer
 485          offer1.setCombinableWithOtherOffers(false);
 486          offer1.setApplyDiscountToSalePrice(false);
 487          order = dataProvider.createBasicOrder();
 488          ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(new Money(10D));
 489          order.updatePrices();
 490          offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 491          assertTrue(checkOrderItemOfferAppliedCount(order) == 0);
 492  
 493          // Try again with two offers.   The second should be applied.
 494          order.updatePrices();
 495          offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 496          assertTrue(checkOrderItemOfferAppliedCount(order) == 2);
 497  
 498          // Trying with 2nd offer as nonCombinable.
 499          offer1.setCombinableWithOtherOffers(true);
 500          ((DiscreteOrderItem) order.getOrderItems().get(1)).getSku().setSalePrice(null);
 501          offer2.setCombinableWithOtherOffers(false);
 502  
 503          order.updatePrices();
 504          offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 505          assertTrue(checkOrderItemOfferAppliedCount(order) == 1);
 506  
 507          order.updatePrices();
 508          offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 509          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 510          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 0);
 511  
 512          // Set qualifying criteria quantity to 1
 513          // Set qualifying target criteria to 2
 514          order = dataProvider.createBasicOrder();
 515          xref = offer1.getQualifyingItemCriteriaXref().iterator().next();
 516          xref.getOfferItemCriteria().setQuantity(1);
 517  
 518          OfferTargetCriteriaXref targetXref = offer1.getTargetItemCriteriaXref().iterator().next();
 519          targetXref.getOfferItemCriteria().setQuantity(2);
 520          order.updatePrices();
 521          offerService.applyAndSaveOffersToOrder(offerListWithOneOffer, order);
 522          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 2);
 523  
 524          // Reset both offers to combinable and the qualifiers as allowing duplicate QUALIFIERs
 525          // and Targets
 526          offer1.setCombinableWithOtherOffers(true);
 527          offer2.setCombinableWithOtherOffers(true);
 528          offer1.setOfferItemQualifierRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 529          offer1.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 530          offer2.setOfferItemQualifierRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 531          offer2.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.QUALIFIER_TARGET);
 532          order = dataProvider.createBasicOrder();
 533          order.updatePrices();
 534          offerService.applyAndSaveOffersToOrder(offerListWithTwoOffers, order);
 535          assertTrue(checkOrderItemOfferAppliedCount(order) == 4);
 536          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 2);
 537          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer1) == 2);
 538  
 539          verify();
 540      }
 541  
 542      public void testApplyItemQualifiersAndTargets() throws Exception {
 543          replay();
 544  
 545          List&lt;PromotableCandidateItemOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();
 546          Offer offer1 = dataProvider.createItemBasedOfferWithItemCriteria(
 547              &quot;order.subTotal.getAmount()&gt;20&quot;,
 548              OfferDiscountType.PERCENT_OFF,
<abbr title=" 549              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 549              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 550              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 550              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 551          ).get(0);
 552          offer1.setId(1L);
 553          Offer offer2 = dataProvider.createItemBasedOfferWithItemCriteria(
 554              &quot;order.subTotal.getAmount()&gt;20&quot;,
 555              OfferDiscountType.PERCENT_OFF,
<abbr title=" 556              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 556              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 557              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 557              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 558          ).get(0);
 559          offer2.setId(2L);
 560  
 561          OfferTargetCriteriaXref targetXref = offer2.getTargetItemCriteriaXref().iterator().next();
 562          targetXref.getOfferItemCriteria().setQuantity(4);
 563          offer2.getQualifyingItemCriteriaXref().clear();
 564          offer2.setOfferItemTargetRuleType(OfferItemRestrictionRuleType.TARGET);
 565          Offer offer3 = dataProvider.createItemBasedOfferWithItemCriteria(
 566              &quot;order.subTotal.getAmount()&gt;20&quot;,
 567              OfferDiscountType.PERCENT_OFF,
<abbr title=" 568              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 568              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
<abbr title=" 569              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 569              &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(ðŸ”µ</abbr>
 570          ).get(0);
 571  
 572          PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder();

 573          itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer1);
<abbr title=" 574          assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offer1) &amp;&amp; qualifiedOffers.get(0).getCandidateQualifiersMap().size() == 1);"> 574          assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offer1) &amp;&amp; qualifiedOffðŸ”µ</abbr>
 575  
 576          itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer2);
<abbr title=" 577          assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offer2) &amp;&amp; qualifiedOffers.get(1).getCandidateQualifiersMap().size() == 0);"> 577          assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(1).getOffer().equals(offer2) &amp;&amp; qualifiedOffðŸ”µ</abbr>
 578  
 579          itemProcessor.filterItemLevelOffer(promotableOrder, qualifiedOffers, offer3);
<abbr title=" 580          assertTrue(qualifiedOffers.size() == 3 &amp;&amp; qualifiedOffers.get(2).getOffer().equals(offer3) &amp;&amp; qualifiedOffers.get(2).getCandidateQualifiersMap().size() == 1);"> 580          assertTrue(qualifiedOffers.size() == 3 &amp;&amp; qualifiedOffers.get(2).getOffer().equals(offer3) &amp;&amp; qualifiedOffðŸ”µ</abbr>
 581  
<abbr title=" 582          // Try with just the second offer.   Expect to get 4 targets based on the offer having no qualifiers required"> 582          // Try with just the second offer.   Expect to get 4 targets based on the offer having no qualifiers requiðŸ”µ</abbr>
 583          // and targeting category test1 or test2 and that the offer requires 4 target criteria.
 584          Order order = dataProvider.createBasicOrder();
 585          List&lt;Offer&gt; offerList = new ArrayList&lt;Offer&gt;();
 586          offerList.add(offer2);
 587          offerService.applyAndSaveOffersToOrder(offerList, order);
 588          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 4);
 589          assertTrue(countPriceDetails(order) == 3);
 590  
 591          // Now try with both offers.   Since the targets can be reused, we expect to have 4 targets on offer2
 592          // and 1 target on offer1
 593          order = dataProvider.createBasicOrder();
 594          offerList.add(offer1); // add in second offer (which happens to be offer1)
 595  
 596          offerService.applyAndSaveOffersToOrder(offerList, order);
 597          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer2) == 4);
 598          assertTrue(countPriceDetails(order) == 3);
 599  
 600          // All three offers - offer 3 is now higher priority so the best offer (offer 2) won&#x27;t be applied
 601          order = dataProvider.createBasicOrder();
 602          offerList.add(offer3); // add in second offer (which happens to be offer1)
 603          offer3.setPriority(-1);
 604          offerService.applyAndSaveOffersToOrder(offerList, order);
 605          assertTrue(checkOrderItemOfferAppliedQuantity(order, offer3) == 2);
 606          assertTrue(countPriceDetails(order) == 4);
 607  
 608          verify();
 609      }
 610  
 611      public class Answer implements IAnswer&lt;CandidateItemOffer&gt; {
 612  
 613          @Override
 614          public CandidateItemOffer answer() throws Throwable {
 615              return new CandidateItemOfferImpl();
 616          }
 617  
 618      }
 619  
 620      public class Answer2 implements IAnswer&lt;OrderItemAdjustment&gt; {
 621  
 622          @Override
 623          public OrderItemAdjustment answer() throws Throwable {
 624              return new OrderItemAdjustmentImpl();
 625          }
 626  
 627      }
 628  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            