<!DOCTYPE html>
<html lang="en">
          <head>
            <meta charset="utf-8">
            <title>579 chunks</title>
                <style>
                    #top {
                        height: 48vh;
                        overflow-y: auto;
                    }
                    #bottom {
                        height: 48vh;
                        overflow-y: auto;
                    }
                </style>
          </head>
          <body>
            <pre>[[{&#x27;eq&#x27;: [{&#x27;CHUNK_OURS&#x27;: &#x27;import &#x27;
                         &#x27;nodomain.freeyourgadget.gadgetbridge.util.WebViewSingleton;\n&#x27;,
           &#x27;CHUNK_THEIRS&#x27;: &#x27;import &#x27;
                           &#x27;nodomain.freeyourgadget.gadgetbridge.util.PebbleUtils;\n&#x27;
                           &#x27;import &#x27;
                           &#x27;nodomain.freeyourgadget.gadgetbridge.util.Prefs;\n&#x27;}],
   &#x27;mergers&#x27;: {&#x27;baseline&#x27;}},
  {&#x27;eq&#x27;: [{&#x27;CHUNK_OURS&#x27;: &#x27;&#x27;,
           &#x27;CHUNK_THEIRS&#x27;: &#x27;    protected void onResume() {\n&#x27;
                           &#x27;        super.onResume();\n&#x27;
                           &#x27;        String queryString = &quot;&quot;;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        if (confUri != null) {\n&#x27;
                           &#x27;            //getting back with configuration &#x27;
                           &#x27;data\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;                appUuid = &#x27;
                           &#x27;UUID.fromString(confUri.getHost());\n&#x27;
                           &#x27;                queryString = &#x27;
                           &#x27;confUri.getEncodedQuery();\n&#x27;
                           &#x27;            } catch (IllegalArgumentException e) &#x27;
                           &#x27;{\n&#x27;
                           &#x27;                GB.toast(&quot;returned uri: &quot; + &#x27;
                           &#x27;confUri.toString(), Toast.LENGTH_LONG, GB.ERROR);\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            &#x27;
                           &#x27;myWebView.loadUrl(&quot;file:///android_asset/app_config/configure.html?&quot; &#x27;
                           &#x27;+ queryString);\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    private JSONObject getAppConfigurationKeys() &#x27;
                           &#x27;{\n&#x27;
                           &#x27;        try {\n&#x27;
                           &#x27;            File destDir = new &#x27;
                           &#x27;File(FileUtils.getExternalFilesDir() + &#x27;
                           &#x27;&quot;/pbw-cache&quot;);\n&#x27;
                           &#x27;            File configurationFile = new &#x27;
                           &#x27;File(destDir, appUuid.toString() + &quot;.json&quot;);\n&#x27;
                           &#x27;            if (configurationFile.exists()) {\n&#x27;
                           &#x27;                String jsonstring = &#x27;
                           &#x27;FileUtils.getStringFromFile(configurationFile);\n&#x27;
                           &#x27;                JSONObject json = new &#x27;
                           &#x27;JSONObject(jsonstring);\n&#x27;
                           &#x27;                return &#x27;
                           &#x27;json.getJSONObject(&quot;appKeys&quot;);\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;        } catch (IOException | JSONException e) {\n&#x27;
                           &#x27;            e.printStackTrace();\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;        return null;\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    private boolean isLocationEnabledForWatchApp() &#x27;
                           &#x27;{\n&#x27;
                           &quot;        return true; //as long as we don&#x27;t give &quot;
                           &quot;watchapp internet access it&#x27;s not a problem\n&quot;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    private class GBChromeClient extends &#x27;
                           &#x27;WebChromeClient {\n&#x27;
                           &#x27;        @Override\n&#x27;
                           &#x27;        public boolean &#x27;
                           &#x27;onConsoleMessage(ConsoleMessage consoleMessage) {\n&#x27;
                           &#x27;            if &#x27;
                           &#x27;(ConsoleMessage.MessageLevel.ERROR.equals(consoleMessage.messageLevel())) &#x27;
                           &#x27;{\n&#x27;
                           &#x27;                GB.toast(consoleMessage.message(), &#x27;
                           &#x27;Toast.LENGTH_LONG, GB.ERROR);\n&#x27;
                           &#x27;                //TODO: show error page\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            return &#x27;
                           &#x27;super.onConsoleMessage(consoleMessage);\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    private class GBWebClient extends &#x27;
                           &#x27;WebViewClient {\n&#x27;
                           &#x27;        @Override\n&#x27;
                           &#x27;        public boolean &#x27;
                           &#x27;shouldOverrideUrlLoading(WebView view, String url) &#x27;
                           &#x27;{\n&#x27;
                           &#x27;            if (url.startsWith(&quot;http://&quot;) || &#x27;
                           &#x27;url.startsWith(&quot;https://&quot;)) {\n&#x27;
                           &#x27;                Intent i = new &#x27;
                           &#x27;Intent(Intent.ACTION_VIEW, Uri.parse(url));\n&#x27;
                           &#x27;                &#x27;
                           &#x27;i.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK | &#x27;
                           &#x27;Intent.FLAG_ACTIVITY_NEW_TASK);\n&#x27;
                           &#x27;                startActivity(i);\n&#x27;
                           &#x27;            } else {\n&#x27;
                           &#x27;                url = &#x27;
                           &#x27;url.replaceFirst(&quot;^pebblejs://close#&quot;, &#x27;
                           &#x27;&quot;file:///android_asset/app_config/configure.html?config=true&amp;json=&quot;);\n&#x27;
                           &#x27;                view.loadUrl(url);\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;            return true;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    private class JSInterface {\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        Context mContext;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        public JSInterface(Context c) {\n&#x27;
                           &#x27;            mContext = c;\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public void gbLog(String msg) {\n&#x27;
                           &#x27;            Log.d(&quot;WEBVIEW&quot;, msg);\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public void sendAppMessage(String msg) {\n&#x27;
                           &#x27;            LOG.debug(&quot;from WEBVIEW: &quot; + msg);\n&#x27;
                           &#x27;            JSONObject knownKeys = &#x27;
                           &#x27;getAppConfigurationKeys();\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;                JSONObject in = new &#x27;
                           &#x27;JSONObject(msg);\n&#x27;
                           &#x27;                JSONObject out = new &#x27;
                           &#x27;JSONObject();\n&#x27;
                           &#x27;                String inKey, outKey;\n&#x27;
                           &#x27;                boolean passKey;\n&#x27;
                           &#x27;                for (Iterator&lt;String&gt; key = &#x27;
                           &#x27;in.keys(); key.hasNext(); ) {\n&#x27;
                           &#x27;                    passKey = false;\n&#x27;
                           &#x27;                    inKey = key.next();\n&#x27;
                           &#x27;                    outKey = null;\n&#x27;
                           &#x27;                    int pebbleAppIndex = &#x27;
                           &#x27;knownKeys.optInt(inKey, -1);\n&#x27;
                           &#x27;                    if (pebbleAppIndex != -1) {\n&#x27;
                           &#x27;                        passKey = true;\n&#x27;
                           &#x27;                        outKey = &#x27;
                           &#x27;String.valueOf(pebbleAppIndex);\n&#x27;
                           &#x27;                    } else {\n&#x27;
                           &#x27;                        //do not discard integer &#x27;
                           &#x27;keys (see &#x27;
                           &#x27;https://developer.pebble.com/guides/communication/using-pebblekit-js/ &#x27;
                           &#x27;)\n&#x27;
                           &#x27;                        Scanner scanner = new &#x27;
                           &#x27;Scanner(inKey);\n&#x27;
                           &#x27;                        if (scanner.hasNextInt() &#x27;
                           &#x27;&amp;&amp; inKey.equals(&quot;&quot; + scanner.nextInt())) {\n&#x27;
                           &#x27;                            passKey = true;\n&#x27;
                           &#x27;                            outKey = inKey;\n&#x27;
                           &#x27;                        }\n&#x27;
                           &#x27;                    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                    if (passKey) {\n&#x27;
                           &#x27;                        Object obj = &#x27;
                           &#x27;in.get(inKey);\n&#x27;
                           &#x27;                        if (obj instanceof &#x27;
                           &#x27;Boolean) {\n&#x27;
                           &#x27;                            obj = ((Boolean) obj) &#x27;
                           &#x27;? &quot;true&quot; : &quot;false&quot;;\n&#x27;
                           &#x27;                        }\n&#x27;
                           &#x27;                        out.put(outKey, obj);\n&#x27;
                           &#x27;                    } else {\n&#x27;
                           &#x27;                        GB.toast(&quot;Discarded key &quot; &#x27;
                           &#x27;+ inKey + &quot;, not found in the local configuration &#x27;
                           &#x27;and is not an integer key.&quot;, Toast.LENGTH_SHORT, &#x27;
                           &#x27;GB.WARN);\n&#x27;
                           &#x27;                    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                }\n&#x27;
                           &#x27;                LOG.info(out.toString());\n&#x27;
                           &#x27;                &#x27;
                           &#x27;GBApplication.deviceService().onAppConfiguration(appUuid, &#x27;
                           &#x27;out.toString());\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;            } catch (JSONException e) {\n&#x27;
                           &#x27;                e.printStackTrace();\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public String getActiveWatchInfo() {\n&#x27;
                           &#x27;            JSONObject wi = new JSONObject();\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;                wi.put(&quot;firmware&quot;, &#x27;
                           &#x27;mGBDevice.getFirmwareVersion());\n&#x27;
                           &#x27;                wi.put(&quot;platform&quot;, &#x27;
                           &#x27;PebbleUtils.getPlatformName(mGBDevice.getModel()));\n&#x27;
                           &#x27;                wi.put(&quot;model&quot;, &#x27;
                           &#x27;PebbleUtils.getModel(mGBDevice.getModel()));\n&#x27;
                           &#x27;                //TODO: use real info\n&#x27;
                           &#x27;                wi.put(&quot;language&quot;, &quot;en&quot;);\n&#x27;
                           &#x27;            } catch (JSONException e) {\n&#x27;
                           &#x27;                e.printStackTrace();\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            //Json not supported apparently, we &#x27;
                           &#x27;need to cast back and forth\n&#x27;
                           &#x27;            return wi.toString();\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public String getAppConfigurationFile() {\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;                File destDir = new &#x27;
                           &#x27;File(FileUtils.getExternalFilesDir() + &#x27;
                           &#x27;&quot;/pbw-cache&quot;);\n&#x27;
                           &#x27;                File configurationFile = new &#x27;
                           &#x27;File(destDir, appUuid.toString() + &quot;_config.js&quot;);\n&#x27;
                           &#x27;                if (configurationFile.exists()) {\n&#x27;
                           &#x27;                    return &quot;file:///&quot; + &#x27;
                           &#x27;configurationFile.getAbsolutePath();\n&#x27;
                           &#x27;                }\n&#x27;
                           &#x27;            } catch (IOException e) {\n&#x27;
                           &#x27;                e.printStackTrace();\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            return null;\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public String getAppStoredPreset() {\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;                File destDir = new &#x27;
                           &#x27;File(FileUtils.getExternalFilesDir() + &#x27;
                           &#x27;&quot;/pbw-cache&quot;);\n&#x27;
                           &#x27;                File configurationFile = new &#x27;
                           &#x27;File(destDir, appUuid.toString() + &#x27;
                           &#x27;&quot;_preset.json&quot;);\n&#x27;
                           &#x27;                if (configurationFile.exists()) {\n&#x27;
                           &#x27;                    return &#x27;
                           &#x27;FileUtils.getStringFromFile(configurationFile);\n&#x27;
                           &#x27;                }\n&#x27;
                           &#x27;            } catch (IOException e) {\n&#x27;
                           &#x27;                GB.toast(&quot;Error reading presets&quot;, &#x27;
                           &#x27;Toast.LENGTH_LONG, GB.ERROR);\n&#x27;
                           &#x27;                e.printStackTrace();\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            return null;\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public void saveAppStoredPreset(String &#x27;
                           &#x27;msg) {\n&#x27;
                           &#x27;            Writer writer;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;                File destDir = new &#x27;
                           &#x27;File(FileUtils.getExternalFilesDir() + &#x27;
                           &#x27;&quot;/pbw-cache&quot;);\n&#x27;
                           &#x27;                File presetsFile = new &#x27;
                           &#x27;File(destDir, appUuid.toString() + &#x27;
                           &#x27;&quot;_preset.json&quot;);\n&#x27;
                           &#x27;                writer = new BufferedWriter(new &#x27;
                           &#x27;FileWriter(presetsFile));\n&#x27;
                           &#x27;                writer.write(msg);\n&#x27;
                           &#x27;                writer.close();\n&#x27;
                           &#x27;                GB.toast(&quot;Presets stored&quot;, &#x27;
                           &#x27;Toast.LENGTH_SHORT, GB.INFO);\n&#x27;
                           &#x27;            } catch (IOException e) {\n&#x27;
                           &#x27;                GB.toast(&quot;Error storing presets&quot;, &#x27;
                           &#x27;Toast.LENGTH_LONG, GB.ERROR);\n&#x27;
                           &#x27;                e.printStackTrace();\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public String getAppUUID() {\n&#x27;
                           &#x27;            return appUuid.toString();\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public String getAppLocalstoragePrefix() &#x27;
                           &#x27;{\n&#x27;
                           &#x27;            String prefix = mGBDevice.getAddress() &#x27;
                           &#x27;+ appUuid.toString();\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;                MessageDigest digest = &#x27;
                           &#x27;MessageDigest.getInstance(&quot;SHA-1&quot;);\n&#x27;
                           &#x27;                byte[] bytes = &#x27;
                           &#x27;prefix.getBytes(&quot;UTF-8&quot;);\n&#x27;
                           &#x27;                digest.update(bytes, 0, &#x27;
                           &#x27;bytes.length);\n&#x27;
                           &#x27;                bytes = digest.digest();\n&#x27;
                           &#x27;                final StringBuilder sb = new &#x27;
                           &#x27;StringBuilder();\n&#x27;
                           &#x27;                for (int i = 0; i &lt; bytes.length; &#x27;
                           &#x27;i++) {\n&#x27;
                           &#x27;                    &#x27;
                           &#x27;sb.append(String.format(&quot;%02X&quot;, bytes[i]));\n&#x27;
                           &#x27;                }\n&#x27;
                           &#x27;                return &#x27;
                           &#x27;sb.toString().toLowerCase();\n&#x27;
                           &#x27;            } catch (NoSuchAlgorithmException | &#x27;
                           &#x27;UnsupportedEncodingException e) {\n&#x27;
                           &#x27;                e.printStackTrace();\n&#x27;
                           &#x27;                return prefix;\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public String getWatchToken() {\n&#x27;
                           &#x27;            //specification says: A string that is &#x27;
                           &#x27;guaranteed to be identical for each Pebble device &#x27;
                           &#x27;for the same app across different mobile devices. &#x27;
                           &#x27;The token is unique to your app and cannot be used &#x27;
                           &#x27;to track Pebble devices across applications. see &#x27;
                           &#x27;https://developer.pebble.com/docs/js/Pebble/\n&#x27;
                           &#x27;            return &quot;gb&quot; + appUuid.toString();\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public void closeActivity() {\n&#x27;
                           &#x27;            &#x27;
                           &#x27;NavUtils.navigateUpFromSameTask((ExternalPebbleJSActivity) &#x27;
                           &#x27;mContext);\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public String getCurrentPosition() {\n&#x27;
                           &#x27;            if (!isLocationEnabledForWatchApp()) &#x27;
                           &#x27;{\n&#x27;
                           &#x27;                return &quot;&quot;;\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            //we need to override this because the &#x27;
                           &#x27;coarse location is not enough for the android &#x27;
                           &#x27;webview, we should add the permission for fine &#x27;
                           &#x27;location.\n&#x27;
                           &#x27;            JSONObject geoPosition = new &#x27;
                           &#x27;JSONObject();\n&#x27;
                           &#x27;            JSONObject coords = new JSONObject();\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                Prefs prefs = &#x27;
                           &#x27;GBApplication.getPrefs();\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                geoPosition.put(&quot;timestamp&quot;, &#x27;
                           &#x27;(System.currentTimeMillis() / 1000) - 86400); &#x27;
                           &#x27;//let JS know this value is really old\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                coords.put(&quot;latitude&quot;, &#x27;
                           &#x27;prefs.getFloat(&quot;location_latitude&quot;, 0));\n&#x27;
                           &#x27;                coords.put(&quot;longitude&quot;, &#x27;
                           &#x27;prefs.getFloat(&quot;location_longitude&quot;, 0));\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                if &#x27;
                           &#x27;(ActivityCompat.checkSelfPermission(getApplicationContext(), &#x27;
                           &#x27;Manifest.permission.ACCESS_COARSE_LOCATION) == &#x27;
                           &#x27;PackageManager.PERMISSION_GRANTED &amp;&amp;\n&#x27;
                           &#x27;                        &#x27;
                           &#x27;prefs.getBoolean(&quot;use_updated_location_if_available&quot;, &#x27;
                           &#x27;false)) {\n&#x27;
                           &#x27;                    LocationManager &#x27;
                           &#x27;locationManager = (LocationManager) &#x27;
                           &#x27;getApplicationContext().getSystemService(Context.LOCATION_SERVICE);\n&#x27;
                           &#x27;                    Criteria criteria = new &#x27;
                           &#x27;Criteria();\n&#x27;
                           &#x27;                    String provider = &#x27;
                           &#x27;locationManager.getBestProvider(criteria, false);\n&#x27;
                           &#x27;                    if (provider != null) {\n&#x27;
                           &#x27;                        Location lastKnownLocation &#x27;
                           &#x27;= locationManager.getLastKnownLocation(provider);\n&#x27;
                           &#x27;                        if (lastKnownLocation != &#x27;
                           &#x27;null) {\n&#x27;
                           &#x27;                            &#x27;
                           &#x27;geoPosition.put(&quot;timestamp&quot;, &#x27;
                           &#x27;lastKnownLocation.getTime());\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                            coords.put(&quot;latitude&quot;, &#x27;
                           &#x27;(float) lastKnownLocation.getLatitude());\n&#x27;
                           &#x27;                            &#x27;
                           &#x27;coords.put(&quot;longitude&quot;, (float) &#x27;
                           &#x27;lastKnownLocation.getLongitude());\n&#x27;
                           &#x27;                            coords.put(&quot;accuracy&quot;, &#x27;
                           &#x27;lastKnownLocation.getAccuracy());\n&#x27;
                           &#x27;                            coords.put(&quot;altitude&quot;, &#x27;
                           &#x27;lastKnownLocation.getAltitude());\n&#x27;
                           &#x27;                            coords.put(&quot;speed&quot;, &#x27;
                           &#x27;lastKnownLocation.getSpeed());\n&#x27;
                           &#x27;                        }\n&#x27;
                           &#x27;                    }\n&#x27;
                           &#x27;                }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                geoPosition.put(&quot;coords&quot;, &#x27;
                           &#x27;coords);\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;            } catch (JSONException e) {\n&#x27;
                           &#x27;                e.printStackTrace();\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            return geoPosition.toString();\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @Override\n&#x27;}],
   &#x27;mergers&#x27;: {&#x27;baseline&#x27;}},
  {&#x27;eq&#x27;: [{&#x27;CHUNK_OURS&#x27;: &#x27;\n&#x27;,
           &#x27;CHUNK_THEIRS&#x27;: &#x27;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;  private class JSInterface {\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    Context mContext;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    public JSInterface(Context c) {\n&#x27;
                           &#x27;      mContext = c;\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public void gbLog(String msg) {\n&#x27;
                           &#x27;      Log.d(&quot;WEBVIEW&quot;, msg);\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public void sendAppMessage(String msg) {\n&#x27;
                           &#x27;      LOG.debug(&quot;from WEBVIEW: &quot; + msg);\n&#x27;
                           &#x27;      JSONObject knownKeys = &#x27;
                           &#x27;getAppConfigurationKeys();\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;      try {\n&#x27;
                           &#x27;        JSONObject in = new JSONObject(msg);\n&#x27;
                           &#x27;        JSONObject out = new JSONObject();\n&#x27;
                           &#x27;        String inKey, outKey;\n&#x27;
                           &#x27;        boolean passKey;\n&#x27;
                           &#x27;        for (Iterator&lt;String&gt; key = in.keys(); &#x27;
                           &#x27;key.hasNext(); ) {\n&#x27;
                           &#x27;          passKey = false;\n&#x27;
                           &#x27;          inKey = key.next();\n&#x27;
                           &#x27;          outKey = null;\n&#x27;
                           &#x27;          int pebbleAppIndex = &#x27;
                           &#x27;knownKeys.optInt(inKey, -1);\n&#x27;
                           &#x27;          if (pebbleAppIndex != -1) {\n&#x27;
                           &#x27;            passKey = true;\n&#x27;
                           &#x27;            outKey = &#x27;
                           &#x27;String.valueOf(pebbleAppIndex);\n&#x27;
                           &#x27;          } else {\n&#x27;
                           &#x27;            //do not discard integer keys (see &#x27;
                           &#x27;https://developer.pebble.com/guides/communication/using-pebblekit-js/ &#x27;
                           &#x27;)\n&#x27;
                           &#x27;            Scanner scanner = new Scanner(inKey);\n&#x27;
                           &#x27;            if (scanner.hasNextInt() &amp;&amp; &#x27;
                           &#x27;inKey.equals(&quot;&quot; + scanner.nextInt())) {\n&#x27;
                           &#x27;              passKey = true;\n&#x27;
                           &#x27;              outKey = inKey;\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;          }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;          if (passKey) {\n&#x27;
                           &#x27;            Object obj = in.get(inKey);\n&#x27;
                           &#x27;            if (obj instanceof Boolean) {\n&#x27;
                           &#x27;              obj = ((Boolean) obj) ? &quot;true&quot; : &#x27;
                           &#x27;&quot;false&quot;;\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            out.put(outKey, obj);\n&#x27;
                           &#x27;          } else {\n&#x27;
                           &#x27;            GB.toast(&quot;Discarded key &quot; + inKey + &quot;, &#x27;
                           &#x27;not found in the local configuration and is not an &#x27;
                           &#x27;integer key.&quot;, Toast.LENGTH_SHORT, GB.WARN);\n&#x27;
                           &#x27;          }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;        LOG.info(out.toString());\n&#x27;
                           &#x27;        &#x27;
                           &#x27;GBApplication.deviceService().onAppConfiguration(appUuid, &#x27;
                           &#x27;out.toString());\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;      } catch (JSONException e) {\n&#x27;
                           &#x27;        e.printStackTrace();\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public String getActiveWatchInfo() {\n&#x27;
                           &#x27;      JSONObject wi = new JSONObject();\n&#x27;
                           &#x27;      try {\n&#x27;
                           &#x27;        wi.put(&quot;firmware&quot;, &#x27;
                           &#x27;mGBDevice.getFirmwareVersion());\n&#x27;
                           &#x27;        wi.put(&quot;platform&quot;, &#x27;
                           &#x27;PebbleUtils.getPlatformName(mGBDevice.getModel()));\n&#x27;
                           &#x27;        wi.put(&quot;model&quot;, &#x27;
                           &#x27;PebbleUtils.getModel(mGBDevice.getModel()));\n&#x27;
                           &#x27;        //TODO: use real info\n&#x27;
                           &#x27;        wi.put(&quot;language&quot;, &quot;en&quot;);\n&#x27;
                           &#x27;      } catch (JSONException e) {\n&#x27;
                           &#x27;        e.printStackTrace();\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;      //Json not supported apparently, we need to &#x27;
                           &#x27;cast back and forth\n&#x27;
                           &#x27;      return wi.toString();\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public String getAppConfigurationFile() {\n&#x27;
                           &#x27;      try {\n&#x27;
                           &#x27;        File destDir = new &#x27;
                           &#x27;File(FileUtils.getExternalFilesDir() + &#x27;
                           &#x27;&quot;/pbw-cache&quot;);\n&#x27;
                           &#x27;        File configurationFile = new File(destDir, &#x27;
                           &#x27;appUuid.toString() + &quot;_config.js&quot;);\n&#x27;
                           &#x27;        if (configurationFile.exists()) {\n&#x27;
                           &#x27;          return &quot;file:///&quot; + &#x27;
                           &#x27;configurationFile.getAbsolutePath();\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;      } catch (IOException e) {\n&#x27;
                           &#x27;        e.printStackTrace();\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;      return null;\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public String getAppStoredPreset() {\n&#x27;
                           &#x27;      try {\n&#x27;
                           &#x27;        File destDir = new &#x27;
                           &#x27;File(FileUtils.getExternalFilesDir() + &#x27;
                           &#x27;&quot;/pbw-cache&quot;);\n&#x27;
                           &#x27;        File configurationFile = new File(destDir, &#x27;
                           &#x27;appUuid.toString() + &quot;_preset.json&quot;);\n&#x27;
                           &#x27;        if (configurationFile.exists()) {\n&#x27;
                           &#x27;          return &#x27;
                           &#x27;FileUtils.getStringFromFile(configurationFile);\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;      } catch (IOException e) {\n&#x27;
                           &#x27;        GB.toast(&quot;Error reading presets&quot;, &#x27;
                           &#x27;Toast.LENGTH_LONG, GB.ERROR);\n&#x27;
                           &#x27;        e.printStackTrace();\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;      return null;\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public void saveAppStoredPreset(String msg) {\n&#x27;
                           &#x27;      Writer writer;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;      try {\n&#x27;
                           &#x27;        File destDir = new &#x27;
                           &#x27;File(FileUtils.getExternalFilesDir() + &#x27;
                           &#x27;&quot;/pbw-cache&quot;);\n&#x27;
                           &#x27;        File presetsFile = new File(destDir, &#x27;
                           &#x27;appUuid.toString() + &quot;_preset.json&quot;);\n&#x27;
                           &#x27;        writer = new BufferedWriter(new &#x27;
                           &#x27;FileWriter(presetsFile));\n&#x27;
                           &#x27;        writer.write(msg);\n&#x27;
                           &#x27;        writer.close();\n&#x27;
                           &#x27;        GB.toast(&quot;Presets stored&quot;, &#x27;
                           &#x27;Toast.LENGTH_SHORT, GB.INFO);\n&#x27;
                           &#x27;      } catch (IOException e) {\n&#x27;
                           &#x27;        GB.toast(&quot;Error storing presets&quot;, &#x27;
                           &#x27;Toast.LENGTH_LONG, GB.ERROR);\n&#x27;
                           &#x27;        e.printStackTrace();\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public String getAppUUID() {\n&#x27;
                           &#x27;      return appUuid.toString();\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public String getAppLocalstoragePrefix() {\n&#x27;
                           &#x27;      String prefix = mGBDevice.getAddress() + &#x27;
                           &#x27;appUuid.toString();\n&#x27;
                           &#x27;      try {\n&#x27;
                           &#x27;        MessageDigest digest = &#x27;
                           &#x27;MessageDigest.getInstance(&quot;SHA-1&quot;);\n&#x27;
                           &#x27;        byte[] bytes = prefix.getBytes(&quot;UTF-8&quot;);\n&#x27;
                           &#x27;        digest.update(bytes, 0, bytes.length);\n&#x27;
                           &#x27;        bytes = digest.digest();\n&#x27;
                           &#x27;        final StringBuilder sb = new &#x27;
                           &#x27;StringBuilder();\n&#x27;
                           &#x27;        for (int i = 0; i &lt; bytes.length; i++) {\n&#x27;
                           &#x27;          sb.append(String.format(&quot;%02X&quot;, &#x27;
                           &#x27;bytes[i]));\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;        return sb.toString().toLowerCase();\n&#x27;
                           &#x27;      } catch (NoSuchAlgorithmException | &#x27;
                           &#x27;UnsupportedEncodingException e) {\n&#x27;
                           &#x27;        e.printStackTrace();\n&#x27;
                           &#x27;        return prefix;\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public String getWatchToken() {\n&#x27;
                           &#x27;      //specification says: A string that is &#x27;
                           &#x27;guaranteed to be identical for each Pebble device &#x27;
                           &#x27;for the same app across different mobile devices. &#x27;
                           &#x27;The token is unique to your app and cannot be used &#x27;
                           &#x27;to track Pebble devices across applications. see &#x27;
                           &#x27;https://developer.pebble.com/docs/js/Pebble/\n&#x27;
                           &#x27;      return &quot;gb&quot; + appUuid.toString();\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public void closeActivity() {\n&#x27;
                           &#x27;      &#x27;
                           &#x27;NavUtils.navigateUpFromSameTask((ExternalPebbleJSActivity) &#x27;
                           &#x27;mContext);\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public String getCurrentPosition() {\n&#x27;
                           &#x27;      if (!isLocationEnabledForWatchApp()) {\n&#x27;
                           &#x27;        return &quot;&quot;;\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;      //we need to override this because the &#x27;
                           &#x27;coarse location is not enough for the android &#x27;
                           &#x27;webview, we should add the permission for fine &#x27;
                           &#x27;location.\n&#x27;
                           &#x27;      JSONObject geoPosition = new JSONObject();\n&#x27;
                           &#x27;      JSONObject coords = new JSONObject();\n&#x27;
                           &#x27;      try {\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        Prefs prefs = GBApplication.getPrefs();\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        geoPosition.put(&quot;timestamp&quot;, &#x27;
                           &#x27;(System.currentTimeMillis() / 1000) - 86400); &#x27;
                           &#x27;//let JS know this value is really old\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        coords.put(&quot;latitude&quot;, &#x27;
                           &#x27;prefs.getFloat(&quot;location_latitude&quot;, 0));\n&#x27;
                           &#x27;        coords.put(&quot;longitude&quot;, &#x27;
                           &#x27;prefs.getFloat(&quot;location_longitude&quot;, 0));\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        if &#x27;
                           &#x27;(ActivityCompat.checkSelfPermission(getApplicationContext(), &#x27;
                           &#x27;Manifest.permission.ACCESS_COARSE_LOCATION) == &#x27;
                           &#x27;PackageManager.PERMISSION_GRANTED &amp;&amp;\n&#x27;
                           &#x27;            &#x27;
                           &#x27;prefs.getBoolean(&quot;use_updated_location_if_available&quot;, &#x27;
                           &#x27;false)) {\n&#x27;
                           &#x27;          LocationManager locationManager = &#x27;
                           &#x27;(LocationManager) &#x27;
                           &#x27;getApplicationContext().getSystemService(Context.LOCATION_SERVICE);\n&#x27;
                           &#x27;          Criteria criteria = new Criteria();\n&#x27;
                           &#x27;          String provider = &#x27;
                           &#x27;locationManager.getBestProvider(criteria, false);\n&#x27;
                           &#x27;          if (provider != null) {\n&#x27;
                           &#x27;            Location lastKnownLocation = &#x27;
                           &#x27;locationManager.getLastKnownLocation(provider);\n&#x27;
                           &#x27;            if (lastKnownLocation != null) {\n&#x27;
                           &#x27;              geoPosition.put(&quot;timestamp&quot;, &#x27;
                           &#x27;lastKnownLocation.getTime());\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;              coords.put(&quot;latitude&quot;, (float) &#x27;
                           &#x27;lastKnownLocation.getLatitude());\n&#x27;
                           &#x27;              coords.put(&quot;longitude&quot;, (float) &#x27;
                           &#x27;lastKnownLocation.getLongitude());\n&#x27;
                           &#x27;              coords.put(&quot;accuracy&quot;, &#x27;
                           &#x27;lastKnownLocation.getAccuracy());\n&#x27;
                           &#x27;              coords.put(&quot;altitude&quot;, &#x27;
                           &#x27;lastKnownLocation.getAltitude());\n&#x27;
                           &#x27;              coords.put(&quot;speed&quot;, &#x27;
                           &#x27;lastKnownLocation.getSpeed());\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;          }\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        geoPosition.put(&quot;coords&quot;, coords);\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;      } catch (JSONException e) {\n&#x27;
                           &#x27;        e.printStackTrace();\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;      return geoPosition.toString();\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;  }\n&#x27;}],
   &#x27;mergers&#x27;: {&#x27;jfstmerge&#x27;}}],
 [{&#x27;eq&#x27;: [{&#x27;CHUNK_OURS&#x27;: &#x27;import &#x27;
                         &#x27;nodomain.freeyourgadget.gadgetbridge.util.WebViewSingleton;\n&#x27;,
           &#x27;CHUNK_THEIRS&#x27;: &#x27;import &#x27;
                           &#x27;nodomain.freeyourgadget.gadgetbridge.util.PebbleUtils;\n&#x27;
                           &#x27;import &#x27;
                           &#x27;nodomain.freeyourgadget.gadgetbridge.util.Prefs;\n&#x27;}],
   &#x27;mergers&#x27;: {&#x27;baseline&#x27;}},
  {&#x27;eq&#x27;: [{&#x27;CHUNK_OURS&#x27;: &#x27;&#x27;,
           &#x27;CHUNK_THEIRS&#x27;: &#x27;    protected void onResume() {\n&#x27;
                           &#x27;        super.onResume();\n&#x27;
                           &#x27;        String queryString = &quot;&quot;;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        if (confUri != null) {\n&#x27;
                           &#x27;            //getting back with configuration &#x27;
                           &#x27;data\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;                appUuid = &#x27;
                           &#x27;UUID.fromString(confUri.getHost());\n&#x27;
                           &#x27;                queryString = &#x27;
                           &#x27;confUri.getEncodedQuery();\n&#x27;
                           &#x27;            } catch (IllegalArgumentException e) &#x27;
                           &#x27;{\n&#x27;
                           &#x27;                GB.toast(&quot;returned uri: &quot; + &#x27;
                           &#x27;confUri.toString(), Toast.LENGTH_LONG, GB.ERROR);\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            &#x27;
                           &#x27;myWebView.loadUrl(&quot;file:///android_asset/app_config/configure.html?&quot; &#x27;
                           &#x27;+ queryString);\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    private JSONObject getAppConfigurationKeys() &#x27;
                           &#x27;{\n&#x27;
                           &#x27;        try {\n&#x27;
                           &#x27;            File destDir = new &#x27;
                           &#x27;File(FileUtils.getExternalFilesDir() + &#x27;
                           &#x27;&quot;/pbw-cache&quot;);\n&#x27;
                           &#x27;            File configurationFile = new &#x27;
                           &#x27;File(destDir, appUuid.toString() + &quot;.json&quot;);\n&#x27;
                           &#x27;            if (configurationFile.exists()) {\n&#x27;
                           &#x27;                String jsonstring = &#x27;
                           &#x27;FileUtils.getStringFromFile(configurationFile);\n&#x27;
                           &#x27;                JSONObject json = new &#x27;
                           &#x27;JSONObject(jsonstring);\n&#x27;
                           &#x27;                return &#x27;
                           &#x27;json.getJSONObject(&quot;appKeys&quot;);\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;        } catch (IOException | JSONException e) {\n&#x27;
                           &#x27;            e.printStackTrace();\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;        return null;\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    private boolean isLocationEnabledForWatchApp() &#x27;
                           &#x27;{\n&#x27;
                           &quot;        return true; //as long as we don&#x27;t give &quot;
                           &quot;watchapp internet access it&#x27;s not a problem\n&quot;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    private class GBChromeClient extends &#x27;
                           &#x27;WebChromeClient {\n&#x27;
                           &#x27;        @Override\n&#x27;
                           &#x27;        public boolean &#x27;
                           &#x27;onConsoleMessage(ConsoleMessage consoleMessage) {\n&#x27;
                           &#x27;            if &#x27;
                           &#x27;(ConsoleMessage.MessageLevel.ERROR.equals(consoleMessage.messageLevel())) &#x27;
                           &#x27;{\n&#x27;
                           &#x27;                GB.toast(consoleMessage.message(), &#x27;
                           &#x27;Toast.LENGTH_LONG, GB.ERROR);\n&#x27;
                           &#x27;                //TODO: show error page\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            return &#x27;
                           &#x27;super.onConsoleMessage(consoleMessage);\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    private class GBWebClient extends &#x27;
                           &#x27;WebViewClient {\n&#x27;
                           &#x27;        @Override\n&#x27;
                           &#x27;        public boolean &#x27;
                           &#x27;shouldOverrideUrlLoading(WebView view, String url) &#x27;
                           &#x27;{\n&#x27;
                           &#x27;            if (url.startsWith(&quot;http://&quot;) || &#x27;
                           &#x27;url.startsWith(&quot;https://&quot;)) {\n&#x27;
                           &#x27;                Intent i = new &#x27;
                           &#x27;Intent(Intent.ACTION_VIEW, Uri.parse(url));\n&#x27;
                           &#x27;                &#x27;
                           &#x27;i.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK | &#x27;
                           &#x27;Intent.FLAG_ACTIVITY_NEW_TASK);\n&#x27;
                           &#x27;                startActivity(i);\n&#x27;
                           &#x27;            } else {\n&#x27;
                           &#x27;                url = &#x27;
                           &#x27;url.replaceFirst(&quot;^pebblejs://close#&quot;, &#x27;
                           &#x27;&quot;file:///android_asset/app_config/configure.html?config=true&amp;json=&quot;);\n&#x27;
                           &#x27;                view.loadUrl(url);\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;            return true;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    private class JSInterface {\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        Context mContext;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        public JSInterface(Context c) {\n&#x27;
                           &#x27;            mContext = c;\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public void gbLog(String msg) {\n&#x27;
                           &#x27;            Log.d(&quot;WEBVIEW&quot;, msg);\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public void sendAppMessage(String msg) {\n&#x27;
                           &#x27;            LOG.debug(&quot;from WEBVIEW: &quot; + msg);\n&#x27;
                           &#x27;            JSONObject knownKeys = &#x27;
                           &#x27;getAppConfigurationKeys();\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;                JSONObject in = new &#x27;
                           &#x27;JSONObject(msg);\n&#x27;
                           &#x27;                JSONObject out = new &#x27;
                           &#x27;JSONObject();\n&#x27;
                           &#x27;                String inKey, outKey;\n&#x27;
                           &#x27;                boolean passKey;\n&#x27;
                           &#x27;                for (Iterator&lt;String&gt; key = &#x27;
                           &#x27;in.keys(); key.hasNext(); ) {\n&#x27;
                           &#x27;                    passKey = false;\n&#x27;
                           &#x27;                    inKey = key.next();\n&#x27;
                           &#x27;                    outKey = null;\n&#x27;
                           &#x27;                    int pebbleAppIndex = &#x27;
                           &#x27;knownKeys.optInt(inKey, -1);\n&#x27;
                           &#x27;                    if (pebbleAppIndex != -1) {\n&#x27;
                           &#x27;                        passKey = true;\n&#x27;
                           &#x27;                        outKey = &#x27;
                           &#x27;String.valueOf(pebbleAppIndex);\n&#x27;
                           &#x27;                    } else {\n&#x27;
                           &#x27;                        //do not discard integer &#x27;
                           &#x27;keys (see &#x27;
                           &#x27;https://developer.pebble.com/guides/communication/using-pebblekit-js/ &#x27;
                           &#x27;)\n&#x27;
                           &#x27;                        Scanner scanner = new &#x27;
                           &#x27;Scanner(inKey);\n&#x27;
                           &#x27;                        if (scanner.hasNextInt() &#x27;
                           &#x27;&amp;&amp; inKey.equals(&quot;&quot; + scanner.nextInt())) {\n&#x27;
                           &#x27;                            passKey = true;\n&#x27;
                           &#x27;                            outKey = inKey;\n&#x27;
                           &#x27;                        }\n&#x27;
                           &#x27;                    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                    if (passKey) {\n&#x27;
                           &#x27;                        Object obj = &#x27;
                           &#x27;in.get(inKey);\n&#x27;
                           &#x27;                        if (obj instanceof &#x27;
                           &#x27;Boolean) {\n&#x27;
                           &#x27;                            obj = ((Boolean) obj) &#x27;
                           &#x27;? &quot;true&quot; : &quot;false&quot;;\n&#x27;
                           &#x27;                        }\n&#x27;
                           &#x27;                        out.put(outKey, obj);\n&#x27;
                           &#x27;                    } else {\n&#x27;
                           &#x27;                        GB.toast(&quot;Discarded key &quot; &#x27;
                           &#x27;+ inKey + &quot;, not found in the local configuration &#x27;
                           &#x27;and is not an integer key.&quot;, Toast.LENGTH_SHORT, &#x27;
                           &#x27;GB.WARN);\n&#x27;
                           &#x27;                    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                }\n&#x27;
                           &#x27;                LOG.info(out.toString());\n&#x27;
                           &#x27;                &#x27;
                           &#x27;GBApplication.deviceService().onAppConfiguration(appUuid, &#x27;
                           &#x27;out.toString());\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;            } catch (JSONException e) {\n&#x27;
                           &#x27;                e.printStackTrace();\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public String getActiveWatchInfo() {\n&#x27;
                           &#x27;            JSONObject wi = new JSONObject();\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;                wi.put(&quot;firmware&quot;, &#x27;
                           &#x27;mGBDevice.getFirmwareVersion());\n&#x27;
                           &#x27;                wi.put(&quot;platform&quot;, &#x27;
                           &#x27;PebbleUtils.getPlatformName(mGBDevice.getModel()));\n&#x27;
                           &#x27;                wi.put(&quot;model&quot;, &#x27;
                           &#x27;PebbleUtils.getModel(mGBDevice.getModel()));\n&#x27;
                           &#x27;                //TODO: use real info\n&#x27;
                           &#x27;                wi.put(&quot;language&quot;, &quot;en&quot;);\n&#x27;
                           &#x27;            } catch (JSONException e) {\n&#x27;
                           &#x27;                e.printStackTrace();\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            //Json not supported apparently, we &#x27;
                           &#x27;need to cast back and forth\n&#x27;
                           &#x27;            return wi.toString();\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public String getAppConfigurationFile() {\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;                File destDir = new &#x27;
                           &#x27;File(FileUtils.getExternalFilesDir() + &#x27;
                           &#x27;&quot;/pbw-cache&quot;);\n&#x27;
                           &#x27;                File configurationFile = new &#x27;
                           &#x27;File(destDir, appUuid.toString() + &quot;_config.js&quot;);\n&#x27;
                           &#x27;                if (configurationFile.exists()) {\n&#x27;
                           &#x27;                    return &quot;file:///&quot; + &#x27;
                           &#x27;configurationFile.getAbsolutePath();\n&#x27;
                           &#x27;                }\n&#x27;
                           &#x27;            } catch (IOException e) {\n&#x27;
                           &#x27;                e.printStackTrace();\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            return null;\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public String getAppStoredPreset() {\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;                File destDir = new &#x27;
                           &#x27;File(FileUtils.getExternalFilesDir() + &#x27;
                           &#x27;&quot;/pbw-cache&quot;);\n&#x27;
                           &#x27;                File configurationFile = new &#x27;
                           &#x27;File(destDir, appUuid.toString() + &#x27;
                           &#x27;&quot;_preset.json&quot;);\n&#x27;
                           &#x27;                if (configurationFile.exists()) {\n&#x27;
                           &#x27;                    return &#x27;
                           &#x27;FileUtils.getStringFromFile(configurationFile);\n&#x27;
                           &#x27;                }\n&#x27;
                           &#x27;            } catch (IOException e) {\n&#x27;
                           &#x27;                GB.toast(&quot;Error reading presets&quot;, &#x27;
                           &#x27;Toast.LENGTH_LONG, GB.ERROR);\n&#x27;
                           &#x27;                e.printStackTrace();\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            return null;\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public void saveAppStoredPreset(String &#x27;
                           &#x27;msg) {\n&#x27;
                           &#x27;            Writer writer;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;                File destDir = new &#x27;
                           &#x27;File(FileUtils.getExternalFilesDir() + &#x27;
                           &#x27;&quot;/pbw-cache&quot;);\n&#x27;
                           &#x27;                File presetsFile = new &#x27;
                           &#x27;File(destDir, appUuid.toString() + &#x27;
                           &#x27;&quot;_preset.json&quot;);\n&#x27;
                           &#x27;                writer = new BufferedWriter(new &#x27;
                           &#x27;FileWriter(presetsFile));\n&#x27;
                           &#x27;                writer.write(msg);\n&#x27;
                           &#x27;                writer.close();\n&#x27;
                           &#x27;                GB.toast(&quot;Presets stored&quot;, &#x27;
                           &#x27;Toast.LENGTH_SHORT, GB.INFO);\n&#x27;
                           &#x27;            } catch (IOException e) {\n&#x27;
                           &#x27;                GB.toast(&quot;Error storing presets&quot;, &#x27;
                           &#x27;Toast.LENGTH_LONG, GB.ERROR);\n&#x27;
                           &#x27;                e.printStackTrace();\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public String getAppUUID() {\n&#x27;
                           &#x27;            return appUuid.toString();\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public String getAppLocalstoragePrefix() &#x27;
                           &#x27;{\n&#x27;
                           &#x27;            String prefix = mGBDevice.getAddress() &#x27;
                           &#x27;+ appUuid.toString();\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;                MessageDigest digest = &#x27;
                           &#x27;MessageDigest.getInstance(&quot;SHA-1&quot;);\n&#x27;
                           &#x27;                byte[] bytes = &#x27;
                           &#x27;prefix.getBytes(&quot;UTF-8&quot;);\n&#x27;
                           &#x27;                digest.update(bytes, 0, &#x27;
                           &#x27;bytes.length);\n&#x27;
                           &#x27;                bytes = digest.digest();\n&#x27;
                           &#x27;                final StringBuilder sb = new &#x27;
                           &#x27;StringBuilder();\n&#x27;
                           &#x27;                for (int i = 0; i &lt; bytes.length; &#x27;
                           &#x27;i++) {\n&#x27;
                           &#x27;                    &#x27;
                           &#x27;sb.append(String.format(&quot;%02X&quot;, bytes[i]));\n&#x27;
                           &#x27;                }\n&#x27;
                           &#x27;                return &#x27;
                           &#x27;sb.toString().toLowerCase();\n&#x27;
                           &#x27;            } catch (NoSuchAlgorithmException | &#x27;
                           &#x27;UnsupportedEncodingException e) {\n&#x27;
                           &#x27;                e.printStackTrace();\n&#x27;
                           &#x27;                return prefix;\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public String getWatchToken() {\n&#x27;
                           &#x27;            //specification says: A string that is &#x27;
                           &#x27;guaranteed to be identical for each Pebble device &#x27;
                           &#x27;for the same app across different mobile devices. &#x27;
                           &#x27;The token is unique to your app and cannot be used &#x27;
                           &#x27;to track Pebble devices across applications. see &#x27;
                           &#x27;https://developer.pebble.com/docs/js/Pebble/\n&#x27;
                           &#x27;            return &quot;gb&quot; + appUuid.toString();\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public void closeActivity() {\n&#x27;
                           &#x27;            &#x27;
                           &#x27;NavUtils.navigateUpFromSameTask((ExternalPebbleJSActivity) &#x27;
                           &#x27;mContext);\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        @JavascriptInterface\n&#x27;
                           &#x27;        public String getCurrentPosition() {\n&#x27;
                           &#x27;            if (!isLocationEnabledForWatchApp()) &#x27;
                           &#x27;{\n&#x27;
                           &#x27;                return &quot;&quot;;\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            //we need to override this because the &#x27;
                           &#x27;coarse location is not enough for the android &#x27;
                           &#x27;webview, we should add the permission for fine &#x27;
                           &#x27;location.\n&#x27;
                           &#x27;            JSONObject geoPosition = new &#x27;
                           &#x27;JSONObject();\n&#x27;
                           &#x27;            JSONObject coords = new JSONObject();\n&#x27;
                           &#x27;            try {\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                Prefs prefs = &#x27;
                           &#x27;GBApplication.getPrefs();\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                geoPosition.put(&quot;timestamp&quot;, &#x27;
                           &#x27;(System.currentTimeMillis() / 1000) - 86400); &#x27;
                           &#x27;//let JS know this value is really old\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                coords.put(&quot;latitude&quot;, &#x27;
                           &#x27;prefs.getFloat(&quot;location_latitude&quot;, 0));\n&#x27;
                           &#x27;                coords.put(&quot;longitude&quot;, &#x27;
                           &#x27;prefs.getFloat(&quot;location_longitude&quot;, 0));\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                if &#x27;
                           &#x27;(ActivityCompat.checkSelfPermission(getApplicationContext(), &#x27;
                           &#x27;Manifest.permission.ACCESS_COARSE_LOCATION) == &#x27;
                           &#x27;PackageManager.PERMISSION_GRANTED &amp;&amp;\n&#x27;
                           &#x27;                        &#x27;
                           &#x27;prefs.getBoolean(&quot;use_updated_location_if_available&quot;, &#x27;
                           &#x27;false)) {\n&#x27;
                           &#x27;                    LocationManager &#x27;
                           &#x27;locationManager = (LocationManager) &#x27;
                           &#x27;getApplicationContext().getSystemService(Context.LOCATION_SERVICE);\n&#x27;
                           &#x27;                    Criteria criteria = new &#x27;
                           &#x27;Criteria();\n&#x27;
                           &#x27;                    String provider = &#x27;
                           &#x27;locationManager.getBestProvider(criteria, false);\n&#x27;
                           &#x27;                    if (provider != null) {\n&#x27;
                           &#x27;                        Location lastKnownLocation &#x27;
                           &#x27;= locationManager.getLastKnownLocation(provider);\n&#x27;
                           &#x27;                        if (lastKnownLocation != &#x27;
                           &#x27;null) {\n&#x27;
                           &#x27;                            &#x27;
                           &#x27;geoPosition.put(&quot;timestamp&quot;, &#x27;
                           &#x27;lastKnownLocation.getTime());\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                            coords.put(&quot;latitude&quot;, &#x27;
                           &#x27;(float) lastKnownLocation.getLatitude());\n&#x27;
                           &#x27;                            &#x27;
                           &#x27;coords.put(&quot;longitude&quot;, (float) &#x27;
                           &#x27;lastKnownLocation.getLongitude());\n&#x27;
                           &#x27;                            coords.put(&quot;accuracy&quot;, &#x27;
                           &#x27;lastKnownLocation.getAccuracy());\n&#x27;
                           &#x27;                            coords.put(&quot;altitude&quot;, &#x27;
                           &#x27;lastKnownLocation.getAltitude());\n&#x27;
                           &#x27;                            coords.put(&quot;speed&quot;, &#x27;
                           &#x27;lastKnownLocation.getSpeed());\n&#x27;
                           &#x27;                        }\n&#x27;
                           &#x27;                    }\n&#x27;
                           &#x27;                }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;                geoPosition.put(&quot;coords&quot;, &#x27;
                           &#x27;coords);\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;            } catch (JSONException e) {\n&#x27;
                           &#x27;                e.printStackTrace();\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            return geoPosition.toString();\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @Override\n&#x27;},
          {&#x27;CHUNK_OURS&#x27;: &#x27;\n&#x27;,
           &#x27;CHUNK_THEIRS&#x27;: &#x27;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;  private class JSInterface {\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    Context mContext;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    public JSInterface(Context c) {\n&#x27;
                           &#x27;      mContext = c;\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public void gbLog(String msg) {\n&#x27;
                           &#x27;      Log.d(&quot;WEBVIEW&quot;, msg);\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public void sendAppMessage(String msg) {\n&#x27;
                           &#x27;      LOG.debug(&quot;from WEBVIEW: &quot; + msg);\n&#x27;
                           &#x27;      JSONObject knownKeys = &#x27;
                           &#x27;getAppConfigurationKeys();\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;      try {\n&#x27;
                           &#x27;        JSONObject in = new JSONObject(msg);\n&#x27;
                           &#x27;        JSONObject out = new JSONObject();\n&#x27;
                           &#x27;        String inKey, outKey;\n&#x27;
                           &#x27;        boolean passKey;\n&#x27;
                           &#x27;        for (Iterator&lt;String&gt; key = in.keys(); &#x27;
                           &#x27;key.hasNext(); ) {\n&#x27;
                           &#x27;          passKey = false;\n&#x27;
                           &#x27;          inKey = key.next();\n&#x27;
                           &#x27;          outKey = null;\n&#x27;
                           &#x27;          int pebbleAppIndex = &#x27;
                           &#x27;knownKeys.optInt(inKey, -1);\n&#x27;
                           &#x27;          if (pebbleAppIndex != -1) {\n&#x27;
                           &#x27;            passKey = true;\n&#x27;
                           &#x27;            outKey = &#x27;
                           &#x27;String.valueOf(pebbleAppIndex);\n&#x27;
                           &#x27;          } else {\n&#x27;
                           &#x27;            //do not discard integer keys (see &#x27;
                           &#x27;https://developer.pebble.com/guides/communication/using-pebblekit-js/ &#x27;
                           &#x27;)\n&#x27;
                           &#x27;            Scanner scanner = new Scanner(inKey);\n&#x27;
                           &#x27;            if (scanner.hasNextInt() &amp;&amp; &#x27;
                           &#x27;inKey.equals(&quot;&quot; + scanner.nextInt())) {\n&#x27;
                           &#x27;              passKey = true;\n&#x27;
                           &#x27;              outKey = inKey;\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;          }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;          if (passKey) {\n&#x27;
                           &#x27;            Object obj = in.get(inKey);\n&#x27;
                           &#x27;            if (obj instanceof Boolean) {\n&#x27;
                           &#x27;              obj = ((Boolean) obj) ? &quot;true&quot; : &#x27;
                           &#x27;&quot;false&quot;;\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;            out.put(outKey, obj);\n&#x27;
                           &#x27;          } else {\n&#x27;
                           &#x27;            GB.toast(&quot;Discarded key &quot; + inKey + &quot;, &#x27;
                           &#x27;not found in the local configuration and is not an &#x27;
                           &#x27;integer key.&quot;, Toast.LENGTH_SHORT, GB.WARN);\n&#x27;
                           &#x27;          }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;        LOG.info(out.toString());\n&#x27;
                           &#x27;        &#x27;
                           &#x27;GBApplication.deviceService().onAppConfiguration(appUuid, &#x27;
                           &#x27;out.toString());\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;      } catch (JSONException e) {\n&#x27;
                           &#x27;        e.printStackTrace();\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public String getActiveWatchInfo() {\n&#x27;
                           &#x27;      JSONObject wi = new JSONObject();\n&#x27;
                           &#x27;      try {\n&#x27;
                           &#x27;        wi.put(&quot;firmware&quot;, &#x27;
                           &#x27;mGBDevice.getFirmwareVersion());\n&#x27;
                           &#x27;        wi.put(&quot;platform&quot;, &#x27;
                           &#x27;PebbleUtils.getPlatformName(mGBDevice.getModel()));\n&#x27;
                           &#x27;        wi.put(&quot;model&quot;, &#x27;
                           &#x27;PebbleUtils.getModel(mGBDevice.getModel()));\n&#x27;
                           &#x27;        //TODO: use real info\n&#x27;
                           &#x27;        wi.put(&quot;language&quot;, &quot;en&quot;);\n&#x27;
                           &#x27;      } catch (JSONException e) {\n&#x27;
                           &#x27;        e.printStackTrace();\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;      //Json not supported apparently, we need to &#x27;
                           &#x27;cast back and forth\n&#x27;
                           &#x27;      return wi.toString();\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public String getAppConfigurationFile() {\n&#x27;
                           &#x27;      try {\n&#x27;
                           &#x27;        File destDir = new &#x27;
                           &#x27;File(FileUtils.getExternalFilesDir() + &#x27;
                           &#x27;&quot;/pbw-cache&quot;);\n&#x27;
                           &#x27;        File configurationFile = new File(destDir, &#x27;
                           &#x27;appUuid.toString() + &quot;_config.js&quot;);\n&#x27;
                           &#x27;        if (configurationFile.exists()) {\n&#x27;
                           &#x27;          return &quot;file:///&quot; + &#x27;
                           &#x27;configurationFile.getAbsolutePath();\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;      } catch (IOException e) {\n&#x27;
                           &#x27;        e.printStackTrace();\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;      return null;\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public String getAppStoredPreset() {\n&#x27;
                           &#x27;      try {\n&#x27;
                           &#x27;        File destDir = new &#x27;
                           &#x27;File(FileUtils.getExternalFilesDir() + &#x27;
                           &#x27;&quot;/pbw-cache&quot;);\n&#x27;
                           &#x27;        File configurationFile = new File(destDir, &#x27;
                           &#x27;appUuid.toString() + &quot;_preset.json&quot;);\n&#x27;
                           &#x27;        if (configurationFile.exists()) {\n&#x27;
                           &#x27;          return &#x27;
                           &#x27;FileUtils.getStringFromFile(configurationFile);\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;      } catch (IOException e) {\n&#x27;
                           &#x27;        GB.toast(&quot;Error reading presets&quot;, &#x27;
                           &#x27;Toast.LENGTH_LONG, GB.ERROR);\n&#x27;
                           &#x27;        e.printStackTrace();\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;      return null;\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public void saveAppStoredPreset(String msg) {\n&#x27;
                           &#x27;      Writer writer;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;      try {\n&#x27;
                           &#x27;        File destDir = new &#x27;
                           &#x27;File(FileUtils.getExternalFilesDir() + &#x27;
                           &#x27;&quot;/pbw-cache&quot;);\n&#x27;
                           &#x27;        File presetsFile = new File(destDir, &#x27;
                           &#x27;appUuid.toString() + &quot;_preset.json&quot;);\n&#x27;
                           &#x27;        writer = new BufferedWriter(new &#x27;
                           &#x27;FileWriter(presetsFile));\n&#x27;
                           &#x27;        writer.write(msg);\n&#x27;
                           &#x27;        writer.close();\n&#x27;
                           &#x27;        GB.toast(&quot;Presets stored&quot;, &#x27;
                           &#x27;Toast.LENGTH_SHORT, GB.INFO);\n&#x27;
                           &#x27;      } catch (IOException e) {\n&#x27;
                           &#x27;        GB.toast(&quot;Error storing presets&quot;, &#x27;
                           &#x27;Toast.LENGTH_LONG, GB.ERROR);\n&#x27;
                           &#x27;        e.printStackTrace();\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public String getAppUUID() {\n&#x27;
                           &#x27;      return appUuid.toString();\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public String getAppLocalstoragePrefix() {\n&#x27;
                           &#x27;      String prefix = mGBDevice.getAddress() + &#x27;
                           &#x27;appUuid.toString();\n&#x27;
                           &#x27;      try {\n&#x27;
                           &#x27;        MessageDigest digest = &#x27;
                           &#x27;MessageDigest.getInstance(&quot;SHA-1&quot;);\n&#x27;
                           &#x27;        byte[] bytes = prefix.getBytes(&quot;UTF-8&quot;);\n&#x27;
                           &#x27;        digest.update(bytes, 0, bytes.length);\n&#x27;
                           &#x27;        bytes = digest.digest();\n&#x27;
                           &#x27;        final StringBuilder sb = new &#x27;
                           &#x27;StringBuilder();\n&#x27;
                           &#x27;        for (int i = 0; i &lt; bytes.length; i++) {\n&#x27;
                           &#x27;          sb.append(String.format(&quot;%02X&quot;, &#x27;
                           &#x27;bytes[i]));\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;        return sb.toString().toLowerCase();\n&#x27;
                           &#x27;      } catch (NoSuchAlgorithmException | &#x27;
                           &#x27;UnsupportedEncodingException e) {\n&#x27;
                           &#x27;        e.printStackTrace();\n&#x27;
                           &#x27;        return prefix;\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public String getWatchToken() {\n&#x27;
                           &#x27;      //specification says: A string that is &#x27;
                           &#x27;guaranteed to be identical for each Pebble device &#x27;
                           &#x27;for the same app across different mobile devices. &#x27;
                           &#x27;The token is unique to your app and cannot be used &#x27;
                           &#x27;to track Pebble devices across applications. see &#x27;
                           &#x27;https://developer.pebble.com/docs/js/Pebble/\n&#x27;
                           &#x27;      return &quot;gb&quot; + appUuid.toString();\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public void closeActivity() {\n&#x27;
                           &#x27;      &#x27;
                           &#x27;NavUtils.navigateUpFromSameTask((ExternalPebbleJSActivity) &#x27;
                           &#x27;mContext);\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;    @JavascriptInterface\n&#x27;
                           &#x27;    public String getCurrentPosition() {\n&#x27;
                           &#x27;      if (!isLocationEnabledForWatchApp()) {\n&#x27;
                           &#x27;        return &quot;&quot;;\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;      //we need to override this because the &#x27;
                           &#x27;coarse location is not enough for the android &#x27;
                           &#x27;webview, we should add the permission for fine &#x27;
                           &#x27;location.\n&#x27;
                           &#x27;      JSONObject geoPosition = new JSONObject();\n&#x27;
                           &#x27;      JSONObject coords = new JSONObject();\n&#x27;
                           &#x27;      try {\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        Prefs prefs = GBApplication.getPrefs();\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        geoPosition.put(&quot;timestamp&quot;, &#x27;
                           &#x27;(System.currentTimeMillis() / 1000) - 86400); &#x27;
                           &#x27;//let JS know this value is really old\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        coords.put(&quot;latitude&quot;, &#x27;
                           &#x27;prefs.getFloat(&quot;location_latitude&quot;, 0));\n&#x27;
                           &#x27;        coords.put(&quot;longitude&quot;, &#x27;
                           &#x27;prefs.getFloat(&quot;location_longitude&quot;, 0));\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        if &#x27;
                           &#x27;(ActivityCompat.checkSelfPermission(getApplicationContext(), &#x27;
                           &#x27;Manifest.permission.ACCESS_COARSE_LOCATION) == &#x27;
                           &#x27;PackageManager.PERMISSION_GRANTED &amp;&amp;\n&#x27;
                           &#x27;            &#x27;
                           &#x27;prefs.getBoolean(&quot;use_updated_location_if_available&quot;, &#x27;
                           &#x27;false)) {\n&#x27;
                           &#x27;          LocationManager locationManager = &#x27;
                           &#x27;(LocationManager) &#x27;
                           &#x27;getApplicationContext().getSystemService(Context.LOCATION_SERVICE);\n&#x27;
                           &#x27;          Criteria criteria = new Criteria();\n&#x27;
                           &#x27;          String provider = &#x27;
                           &#x27;locationManager.getBestProvider(criteria, false);\n&#x27;
                           &#x27;          if (provider != null) {\n&#x27;
                           &#x27;            Location lastKnownLocation = &#x27;
                           &#x27;locationManager.getLastKnownLocation(provider);\n&#x27;
                           &#x27;            if (lastKnownLocation != null) {\n&#x27;
                           &#x27;              geoPosition.put(&quot;timestamp&quot;, &#x27;
                           &#x27;lastKnownLocation.getTime());\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;              coords.put(&quot;latitude&quot;, (float) &#x27;
                           &#x27;lastKnownLocation.getLatitude());\n&#x27;
                           &#x27;              coords.put(&quot;longitude&quot;, (float) &#x27;
                           &#x27;lastKnownLocation.getLongitude());\n&#x27;
                           &#x27;              coords.put(&quot;accuracy&quot;, &#x27;
                           &#x27;lastKnownLocation.getAccuracy());\n&#x27;
                           &#x27;              coords.put(&quot;altitude&quot;, &#x27;
                           &#x27;lastKnownLocation.getAltitude());\n&#x27;
                           &#x27;              coords.put(&quot;speed&quot;, &#x27;
                           &#x27;lastKnownLocation.getSpeed());\n&#x27;
                           &#x27;            }\n&#x27;
                           &#x27;          }\n&#x27;
                           &#x27;        }\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;        geoPosition.put(&quot;coords&quot;, coords);\n&#x27;
                           &#x27;\n&#x27;
                           &#x27;      } catch (JSONException e) {\n&#x27;
                           &#x27;        e.printStackTrace();\n&#x27;
                           &#x27;      }\n&#x27;
                           &#x27;      return geoPosition.toString();\n&#x27;
                           &#x27;    }\n&#x27;
                           &#x27;  }\n&#x27;}],
   &#x27;mergers&#x27;: {&#x27;baseline&#x27;, &#x27;jfstmerge&#x27;}}]]</pre>
          </body>
        </html>
        