<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>210</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    210
                    <a href="209.html">prev</a>
                    <a href="211.html">next</a>
                    <a href="210_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_bf5cd5502f24a0f8a529769c227437509b0ec9f5_Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;bf5cd5502f24a0f8a529769c227437509b0ec9f5:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;bf5cd5502f24a0f8a529769c227437509b0ec9f5^1:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;bf5cd5502f24a0f8a529769c227437509b0ec9f5^2:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;15b2b25d8ceda8d613f23f9846fd7ddbea717acb:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.ClipData;
   6 import android.content.ClipboardManager;
   7 import android.content.Context;
   8 import android.content.Intent;
   9 import android.content.res.TypedArray;
  10 import android.database.Cursor;
  11 import android.graphics.drawable.ColorDrawable;
  12 import android.net.Uri;
  13 import android.os.AsyncTask;
  14 import android.os.Build;
  15 import android.os.Bundle;
  16 import android.os.Handler;
  17 import android.support.v4.app.ActivityCompat;
  18 import android.support.v7.view.ActionMode;
  19 import android.text.Editable;
  20 import android.text.Spanned;
  21 import android.text.TextWatcher;
  22 import android.text.style.RelativeSizeSpan;
  23 import android.text.style.URLSpan;
  24 import android.text.util.Linkify;
  25 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import android.util.TypedValue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import android.view.ActionMode;</span>
  28 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import android.view.ActionMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import android.view.LayoutInflater;</span>
  31 =======
  32 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  33 import android.view.LayoutInflater;
  34 import android.view.Menu;
  35 import android.view.MenuInflater;
  36 import android.view.MenuItem;
  37 import android.view.View;
  38 import android.view.ViewGroup;
  39 import android.view.WindowManager;
  40 import android.view.inputmethod.InputMethodManager;
  41 import android.widget.CursorAdapter;
  42 import android.widget.ImageButton;
  43 import android.widget.ImageView;
  44 import android.widget.LinearLayout;
  45 import android.widget.PopupWindow;
  46 import android.widget.TextView;
  47 import android.widget.Toast;
  48 import android.widget.ToggleButton;
  49 import android.widget.ViewSwitcher;
  50 
  51 import com.automattic.simplenote.models.Note;
  52 import com.automattic.simplenote.models.Tag;
  53 import com.automattic.simplenote.utils.AutoBullet;
  54 import com.automattic.simplenote.utils.DisplayUtils;
  55 import com.automattic.simplenote.utils.MatchOffsetHighlighter;
  56 import com.automattic.simplenote.utils.PrefUtils;
  57 import com.automattic.simplenote.utils.SpaceTokenizer;
  58 import com.automattic.simplenote.widgets.SimplenoteEditText;
  59 import com.automattic.simplenote.utils.SimplenoteLinkify;
  60 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  61 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  62 import com.automattic.simplenote.utils.TextHighlighter;
  63 import com.google.android.gms.analytics.HitBuilders;
  64 import com.google.android.gms.analytics.Tracker;
  65 import com.simperium.client.Bucket;
  66 import com.simperium.client.BucketObjectMissingException;
  67 import com.simperium.client.Query;
  68 
  69 import java.text.NumberFormat;
  70 import java.util.Calendar;
  71 
<abbr title="  72 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListener, View.OnFocusChangeListener, SimplenoteEditText.OnSelectionChangedListener {">  72 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddeðŸ”µ</abbr>
  73 
  74     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  75     public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  76     static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;
  77     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  78 
  79     private Note mNote;
  80     private Bucket&lt;Note&gt; mNotesBucket;
  81 
  82     private Tracker mTracker;
  83 
  84     private SimplenoteEditText mContentEditText;
  85     private TagsMultiAutoCompleteTextView mTagView;
  86     private PopupWindow mInfoPopupWindow;
  87     private ToggleButton mPinButton;
  88     private Handler mAutoSaveHandler;
  89     private Handler mPublishTimeoutHandler;
  90     private LinearLayout mPlaceholderView;
  91     private CursorAdapter mAutocompleteAdapter;
  92     private boolean mIsNewNote, mIsLoadingNote;
  93     private ActionMode mActionMode;
  94     private MenuItem mViewLinkMenuItem;
  95     private String mLinkUrl;
  96     private String mLinkText;
  97     private MatchOffsetHighlighter mHighlighter;
  98     private int mEmailIconResId, mWebIconResId, mMapIconResId, mCallIconResId;
  99     private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
 100     private String mMatchOffsets;
 101     private int mCurrentCursorPosition;
 102 
 103     /**
 104      * Mandatory empty constructor for the fragment manager to instantiate the
 105      * fragment (e.g. upon screen orientation changes).
 106      */
 107     public NoteEditorFragment() {
 108     }
 109 
 110     @Override
 111     public void onCreate(Bundle savedInstanceState) {
 112         super.onCreate(savedInstanceState);
 113 
 114         if (getActivity() != null) {
 115             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 116             mNotesBucket = currentApp.getNotesBucket();
 117             mTracker = currentApp.getTracker();
 118 
<abbr title=" 119             TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionBarIconWeb, R.attr.actionBarIconMap, R.attr.actionBarIconCall});"> 119             TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.atðŸ”µ</abbr>
 120             if (a != null) {
 121                 mEmailIconResId = a.getResourceId(0, 0);
 122                 mWebIconResId = a.getResourceId(1, 0);
 123                 mMapIconResId = a.getResourceId(2, 0);
 124                 mCallIconResId = a.getResourceId(3, 0);
 125                 a.recycle();
 126             }
 127         }
 128 
 129         mAutoSaveHandler = new Handler();
 130         mPublishTimeoutHandler = new Handler();
 131 
 132         mMatchHighlighter = new TextHighlighter(getActivity(),
<abbr title=" 133                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);"> 133                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor)ðŸ”µ</abbr>
 134         mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0){
 135 
 136             @Override
 137             public View newView(Context context, Cursor cursor, ViewGroup parent) {
 138                 Activity activity = (Activity) context;
 139                 if (activity == null) return null;
 140                 return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 141             }
 142 
 143             @Override
 144             public void bindView(View view, Context context, Cursor cursor) {
 145                 TextView textView = (TextView) view;
 146                 textView.setText(convertToString(cursor));
 147             }
 148 
 149             @Override
 150             public CharSequence convertToString(Cursor cursor){
 151                 return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 152             }
 153 
 154             @Override
 155             public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 156                 Activity activity = getActivity();
 157                 if (activity == null) return null;
 158                 Simplenote application = (Simplenote) activity.getApplication();
 159                 Query&lt;Tag&gt; query = application.getTagsBucket().query();
 160                 // make the tag name available to the cursor
 161                 query.include(Tag.NAME_PROPERTY);
 162                 // sort the tags by their names
 163                 query.order(Tag.NAME_PROPERTY);
 164                 // if there&#x27;s a filter string find only matching tag names
<abbr title=" 165                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 165                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.forðŸ”µ</abbr>
 166                 return query.execute();
 167             }
 168         };
 169     }
 170 
 171 
 172     @Override
 173     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 174         setHasOptionsMenu(true);
 175         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 176         mContentEditText = ((SimplenoteEditText) rootView.findViewById(R.id.note_content));
 177         mContentEditText.addOnSelectionChangedListener(this);
 178         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 179         mTagView.setTokenizer(new SpaceTokenizer());
 180         mTagView.setOnFocusChangeListener(this);
 181 
 182         mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 183 
 184         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
 185         mPinButton.setOnClickListener(new View.OnClickListener() {
 186             @Override
 187             public void onClick(View v) {
 188                 if (mPinButton.isChecked()) {
 189                     // Friendly message to the user as to what this button does.
 190                     Toast.makeText(getActivity(), R.string.note_pinned, Toast.LENGTH_SHORT).show();
 191                 }
 192             }
 193         });
 194 
 195         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
 196         if (DisplayUtils.isLargeLandscape(getActivity()) &amp;&amp; mNote == null) {
 197             mPlaceholderView.setVisibility(View.VISIBLE);
 198         }
 199 
 200         mTagView.setAdapter(mAutocompleteAdapter);
 201 
 202         // Load note if we were passed a note Id
 203         Bundle arguments = getArguments();
 204         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
 205             String key = arguments.getString(ARG_ITEM_ID);
 206             if (arguments.containsKey(ARG_MATCH_OFFSETS)) {
 207                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);
 208             }
 209             new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
 210             setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));
 211         }
 212 
 213 		return rootView;
 214 	}
 215 
 216     @Override
 217     public void onResume() {
 218         super.onResume();
 219         mNotesBucket.start();
 220         mNotesBucket.addListener(this);
 221 
 222         mTagView.setOnTagAddedListener(this);
 223 
 224         if (mContentEditText != null) {
<abbr title=" 225             mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_FONT_SIZE, 18));"> 225             mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), ðŸ”µ</abbr>
 226         }
 227     }
 228 
 229     @Override
 230     public void onPause() {
 231         mNotesBucket.removeListener(this);
 232         // Hide soft keyboard if it is showing...
 233         if (getActivity() != null) {
<abbr title=" 234             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 234             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(CðŸ”µ</abbr>
 235             if (inputMethodManager != null) {
 236                 inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 237             }
 238         }
 239 
 240         // Delete the note if it is new and has empty fields
 241         if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty()) {
 242             mNote.delete();
 243         } else {
 244             saveNote();
 245         }
 246 
 247         mTagView.setOnTagAddedListener(null);
 248 
 249         if (mAutoSaveHandler != null) {
 250             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 251         }
 252 
 253         if (mPublishTimeoutHandler != null) {
 254             mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 255         }
 256 
 257         mHighlighter.stop();
 258 
 259         super.onPause();
 260     }
 261 
 262     @Override
 263     public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 264         inflater.inflate(R.menu.note_editor, menu);
 265 
 266         if (mNote != null) {
 267             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_view_info);
 268             viewPublishedNoteItem.setVisible(true);
 269 
 270             MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 271             if (mNote.isDeleted())
 272                 trashItem.setTitle(R.string.undelete);
 273             else
 274                 trashItem.setTitle(R.string.delete);
 275         }
 276 
 277         super.onCreateOptionsMenu(menu, inflater);
 278     }
 279 
 280     @Override
 281     public boolean onOptionsItemSelected(MenuItem item) {
 282         switch (item.getItemId()) {
 283             case R.id.menu_view_info:
 284                 if (mNote != null) {
 285                     View menuItemView = getActivity().findViewById(R.id.menu_view_info);
 286                     showInfoPopup(menuItemView);
 287                 }
 288                 return true;
 289             case R.id.menu_share:
 290                 if (mNote != null) {
 291                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 292                     shareIntent.setType(&quot;text/plain&quot;);
 293                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mNote.getContent());
<abbr title=" 294                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 294                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
 295                     mTracker.send(
 296                             new HitBuilders.EventBuilder()
 297                             .setCategory(&quot;note&quot;)
 298                             .setAction(&quot;shared_note&quot;)
 299                             .setLabel(&quot;action_bar_share_button&quot;)
 300                             .build()
 301                     );
 302                 }
 303                 return true;
 304             case R.id.menu_delete:
 305                 if (mNote != null) {
 306                     mNote.setDeleted(!mNote.isDeleted());
 307                     mNote.setModificationDate(Calendar.getInstance());
 308                     mNote.save();
 309                     Intent resultIntent = new Intent();
 310                     if (mNote.isDeleted())
 311                         resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());
 312                     getActivity().setResult(Activity.RESULT_OK, resultIntent);
 313                 }
 314 
 315                 ActivityCompat.finishAfterTransition(getActivity());
 316                 return true;
 317             case android.R.id.home:
 318                 ActivityCompat.finishAfterTransition(getActivity());
 319                 return true;
 320             default:
 321                 return super.onOptionsItemSelected(item);
 322         }
 323     }
 324 
 325     // show a popup view from the info action bar item
 326     private void showInfoPopup(View view) {
 327         if (!isAdded() || view == null) return;
 328 
 329         if (mInfoPopupWindow == null) {
 330             mInfoPopupWindow = new PopupWindow(getActivity());
 331             mInfoPopupWindow.setWidth(WindowManager.LayoutParams.WRAP_CONTENT);
 332             mInfoPopupWindow.setHeight(WindowManager.LayoutParams.WRAP_CONTENT);
 333             mInfoPopupWindow.setBackgroundDrawable(new ColorDrawable(0));
 334             mInfoPopupWindow.setOutsideTouchable(true);
 335             mInfoPopupWindow.setFocusable(true);
 336 
 337             LayoutInflater inflater = LayoutInflater.from(getActivity());
 338             View popupView = inflater.inflate(R.layout.popup_info, null);
 339             mInfoPopupWindow.setContentView(popupView);
 340         }
 341 
 342         updateInfoPopup();
 343 
 344         mInfoPopupWindow.showAsDropDown(view);
 345     }
 346 
 347     // update the content of the popupview
 348     private void updateInfoPopup() {
 349         if (mInfoPopupWindow == null || mInfoPopupWindow.getContentView() == null) return;
 350 
 351         View popupView = mInfoPopupWindow.getContentView();
 352 
 353         View publishButton = popupView.findViewById(R.id.publish_note_button);
 354         TextView publishButtonTextView = (TextView)popupView.findViewById(R.id.publish_note_button_text);
 355         ImageView publishButtonIcon = (ImageView)popupView.findViewById(R.id.publish_note_button_icon);
 356         TextView publishTextView = (TextView) popupView.findViewById(R.id.publish_url_textview);
 357         TextView wordCountTextView = (TextView) popupView.findViewById(R.id.word_count);
 358         ImageButton publishCopyButton = (ImageButton) popupView.findViewById(R.id.publish_copy_url);
 359         ImageButton publishShareButton = (ImageButton) popupView.findViewById(R.id.publish_share_url);
 360         View actionsView = popupView.findViewById(R.id.publish_actions);
 361 
<abbr title=" 362         final ViewSwitcher viewSwitcher = (ViewSwitcher) popupView.findViewById(R.id.publish_view_switcher);"> 362         final ViewSwitcher viewSwitcher = (ViewSwitcher) popupView.findViewById(R.id.publish_view_switcheðŸ”µ</abbr>
 363 
 364         publishButton.setOnClickListener(new View.OnClickListener() {
 365             @Override
 366             public void onClick(View v) {
 367                 if (mNote != null) {
 368                     boolean newPublishedStatus = !mNote.isPublished();
 369                     mNote.setPublished(newPublishedStatus);
 370                     mNote.save();
 371 
 372                     if (viewSwitcher.getDisplayedChild() == 0) {
 373                         viewSwitcher.showNext();
 374                     }
 375 
 376                     // reset publish status in 20 seconds if we don&#x27;t hear back from Simperium
 377                     mPublishTimeoutHandler.postDelayed(mPublishTimeoutRunnable, 20000);
 378                 }
 379             }
 380         });
 381 
 382         publishTextView.setOnClickListener(new View.OnClickListener() {
 383             @Override
 384             public void onClick(View v) {
 385                 try {
 386                     startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(mNote.getPublishedUrl())));
 387                 } catch (Exception e) {
 388                     e.printStackTrace();
 389                 }
 390             }
 391         });
 392 
 393         publishCopyButton.setOnClickListener(new View.OnClickListener() {
 394             @Override
 395             public void onClick(View v) {
<abbr title=" 396                 ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 396                 ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLðŸ”µ</abbr>
<abbr title=" 397                 ClipData clip = ClipData.newPlainText(getString(R.string.app_name), mNote.getPublishedUrl());"> 397                 ClipData clip = ClipData.newPlainText(getString(R.string.app_name), mNote.getPublishedUrlðŸ”µ</abbr>
 398                 clipboard.setPrimaryClip(clip);
<abbr title=" 399                 Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();"> 399                 Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show()ðŸ”µ</abbr>
 400             }
 401         });
 402 
 403         publishShareButton.setOnClickListener(new View.OnClickListener() {
 404             @Override
 405             public void onClick(View v) {
 406                 Intent i = new Intent(Intent.ACTION_SEND);
 407                 i.setType(&quot;text/plain&quot;);
 408                 i.putExtra(Intent.EXTRA_TEXT, mNote.getPublishedUrl());
 409                 startActivity(Intent.createChooser(i, getString(R.string.share_url)));
 410             }
 411         });
 412 
 413         updateWordCount(wordCountTextView);
 414 
 415         if (mNote.isPublished()) {
 416             publishButtonTextView.setText(getString(R.string.published));
 417             publishButtonIcon.setVisibility(View.VISIBLE);
 418             publishTextView.setText(mNote.getPublishedUrl());
 419             actionsView.setVisibility(View.VISIBLE);
 420         } else {
 421             publishButtonTextView.setText(getString(R.string.publish));
 422             publishButtonIcon.setVisibility(View.GONE);
 423             actionsView.setVisibility(View.GONE);
 424         }
 425 
 426         Simplenote currentApp = (Simplenote) getActivity().getApplication();
 427         if (currentApp.getSimperium().needsAuthorization()) {
 428             viewSwitcher.setVisibility(View.GONE);
 429         } else {
 430             viewSwitcher.setVisibility(View.VISIBLE);
 431             if (viewSwitcher.getDisplayedChild() == 1) {
 432                 viewSwitcher.showPrevious();
 433             }
 434         }
 435     }
 436 
 437     private boolean noteIsEmpty() {
 438         return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 439     }
 440 
 441     public void setNote(String noteID){
 442         setNote(noteID, null);
 443     }
 444 
 445     public void setNote(String noteID, String matchOffsets) {
 446         if (mAutoSaveHandler != null)
 447             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 448 
 449         mPlaceholderView.setVisibility(View.GONE);
 450 
 451         if (matchOffsets != null)
 452             mMatchOffsets = matchOffsets;
 453 
 454         // If we have a note already (on a tablet in landscape), save the note.
 455         if (mNote != null) {
 456             if (mIsNewNote &amp;&amp; noteIsEmpty())
 457                 mNote.delete();
 458             else if (mNote != null)
 459                 saveNote();
 460         }
 461 
 462         new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 463     }
 464 
 465     public void updateNote(Note updatedNote) {
 466         // update note if network change arrived
 467         mNote = updatedNote;
 468         refreshContent(true);
 469     }
 470 
 471     public void refreshContent(boolean isNoteUpdate) {
 472         if (mNote != null) {
 473             // Restore the cursor position if possible.
 474 
<abbr title=" 475             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 475             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEdðŸ”µ</abbr>
 476 
 477             mContentEditText.setText(mNote.getContent());
 478 
 479             if (isNoteUpdate) {
 480                 // Save the note so any local changes get synced
 481                 mNote.save();
 482 
<abbr title=" 483                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) {"> 483                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) ðŸ”µ</abbr>
 484                     mContentEditText.setSelection(cursorPosition);
 485                 }
 486             }
 487 
 488             afterTextChanged(mContentEditText.getText());
 489 
 490             mPinButton.setChecked(mNote.isPinned());
 491 
 492             updateTagList();
 493         }
 494     }
 495 
 496     public void updateTagList() {
 497         Activity activity = getActivity();
 498         if (activity == null) return;
 499 
 500         // Populate this note&#x27;s tags in the tagView
 501         mTagView.setChips(mNote.getTagString());
 502     }
 503 
 504     int newCursorLocation(String newText, String oldText, int cursorLocation) {
 505         // Ported from the iOS app :)
 506         // Cases:
 507         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 508         // 1. Text was added after the cursor ==&gt; no change
 509         // 2. Text was added before the cursor ==&gt; location advances
 510         // 3. Text was removed after the cursor ==&gt; no change
 511         // 4. Text was removed before the cursor ==&gt; location retreats
 512         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 513 
 514         int newCursorLocation = cursorLocation;
 515 
 516         int deltaLength = newText.length() - oldText.length();
 517 
 518         // Case 0
 519         if (newText.length() &lt; cursorLocation)
 520             return newText.length();
 521 
 522         boolean beforeCursorMatches = false;
 523         boolean afterCursorMatches = false;
 524 
 525         try {
<abbr title=" 526             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 526             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorðŸ”µ</abbr>
<abbr title=" 527             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 527             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substðŸ”µ</abbr>
 528         } catch (Exception e) {
 529             e.printStackTrace();
 530         }
 531 
 532         // Cases 2 and 4
 533         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 534             newCursorLocation += deltaLength;
 535 
 536         // Cases 1, 3 and 5 have no change
 537         return newCursorLocation;
 538     }
 539 
 540     private Runnable mAutoSaveRunnable = new Runnable() {
 541         @Override
 542         public void run() {
 543             saveAndSyncNote();
 544         }
 545     };
 546 
 547     @Override
 548     public void onTagsChanged(String tagString) {
 549         if (mNote == null || !isAdded()) return;
 550 
 551         if (mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length()) {
 552             mTracker.send(
 553                     new HitBuilders.EventBuilder()
 554                             .setCategory(&quot;note&quot;)
 555                             .setAction(&quot;added_tag&quot;)
 556                             .setLabel(&quot;tag_added_to_note&quot;)
 557                             .build()
 558             );
 559         }
 560         else {
 561             mTracker.send(
 562                     new HitBuilders.EventBuilder()
 563                             .setCategory(&quot;note&quot;)
 564                             .setAction(&quot;removed_tag&quot;)
 565                             .setLabel(&quot;tag_removed_from_note&quot;)
 566                             .build()
 567             );
 568         }
 569 
 570         mNote.setTagString(tagString);
 571         mNote.setModificationDate(Calendar.getInstance());
 572         updateTagList();
 573         mNote.save();
 574     }
 575 
 576     @Override
 577     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 578         // Unused
 579     }
 580 
 581     @Override
 582     public void afterTextChanged(Editable editable) {
 583         setTitleSpan(editable);
 584         attemptAutoList(editable);
 585     }
 586 
 587     @Override
 588     public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 589 
 590         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 591         if (mAutoSaveHandler != null) {
 592             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 593             mAutoSaveHandler.postDelayed(mAutoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 594         }
 595 
 596         // Remove search highlight spans when note content changes
 597         if (mMatchOffsets != null) {
 598             mMatchOffsets = null;
 599             mHighlighter.removeMatches();
 600         }
 601     }
 602 
 603     private void setTitleSpan(Editable editable) {
 604         // Set the note title to be a larger size
 605         // Remove any existing size spans
 606         RelativeSizeSpan spans[] = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 607         for (RelativeSizeSpan span : spans) {
 608             editable.removeSpan(span);
 609         }
 610         int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 611         if (newLinePosition == 0)
 612             return;
<abbr title=" 613         editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 613         editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editaðŸ”µ</abbr>
 614     }
 615 
 616     private void attemptAutoList(Editable editable) {
 617         int oldCursorPosition = mCurrentCursorPosition;
 618         mCurrentCursorPosition = mContentEditText.getSelectionStart();
 619         AutoBullet.apply(editable, oldCursorPosition, mCurrentCursorPosition);
 620         mCurrentCursorPosition = mContentEditText.getSelectionStart();
 621         android.util.Log.d(&quot;Simplenote&quot;, &quot;==&gt; post cursor position:&quot; + mCurrentCursorPosition);
 622     }
 623 
 624     private void saveAndSyncNote() {
 625         if (mNote == null)
 626             return;
 627 
 628         new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 629     }
 630 
 631     public void setPlaceholderVisible(boolean isVisible) {
 632         if (isVisible) {
 633             mNote = null;
 634             mContentEditText.setText(&quot;&quot;);
 635             mTagView.setText(&quot;&quot;);
 636             if (mPlaceholderView != null)
 637                 mPlaceholderView.setVisibility(View.VISIBLE);
 638         } else {
 639             if (mPlaceholderView != null)
 640                 mPlaceholderView.setVisibility(View.GONE);
 641         }
 642     }
 643 
 644     public void setIsNewNote(boolean isNewNote) {
 645         this.mIsNewNote = isNewNote;
 646     }
 647 
 648     @Override
 649     public void onFocusChange(View v, boolean hasFocus) {
 650         if (!hasFocus) {
 651             String tagString = getNoteTagsString().trim();
 652             if (tagString.length() &gt; 0) {
 653                 mTagView.setChips(tagString);
 654             }
 655         }
 656     }
 657 
 658     public Note getNote() {
 659         return mNote;
 660     }
 661 
 662     public String getNoteContentString() {
 663         if (mContentEditText == null || mContentEditText.getText() == null) {
 664             return &quot;&quot;;
 665         } else {
 666             return mContentEditText.getText().toString();
 667         }
 668     }
 669 
 670     public String getNoteTagsString() {
 671         if (mTagView == null || mTagView.getText() == null) {
 672             return &quot;&quot;;
 673         } else {
 674             return mTagView.getText().toString();
 675         }
 676     }
 677 
 678     private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 679 
 680         @Override
 681         protected void onPreExecute() {
 682             mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 683             mIsLoadingNote = true;
 684         }
 685 
 686         @Override
 687         protected Void doInBackground(String... args) {
 688             if (getActivity() == null) {
 689                 return null;
 690             }
 691 
 692             String noteID = args[0];
 693             Simplenote application = (Simplenote) getActivity().getApplication();
 694             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 695             try {
 696                 mNote = notesBucket.get(noteID);
 697                 // Set the current note in NotesActivity when on a tablet
 698                 if (getActivity() instanceof NotesActivity) {
 699                     ((NotesActivity) getActivity()).setCurrentNote(mNote);
 700                 }
 701             } catch (BucketObjectMissingException e) {
 702                 // TODO: Handle a missing note
 703             }
 704             return null;
 705         }
 706 
 707         @Override
 708         protected void onPostExecute(Void nada) {
 709             if (getActivity() == null || getActivity().isFinishing())
 710                 return;
 711             refreshContent(false);
 712             if (mMatchOffsets != null) {
<abbr title=" 713                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);"> 713                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.COðŸ”µ</abbr>
 714                 mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
 715             }
 716             mContentEditText.addTextChangedListener(NoteEditorFragment.this);
 717             if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 718                 // Show soft keyboard
 719                 mContentEditText.requestFocus();
 720                 new Handler().postDelayed(new Runnable() {
 721                     @Override
 722                     public void run() {
<abbr title=" 723                         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 723                         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSysðŸ”µ</abbr>
 724                         if (inputMethodManager != null)
 725                             inputMethodManager.showSoftInput(mContentEditText, 0);
 726                     }
 727                 }, 100);
 728 
 729             }
 730 
 731             SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 732 
 733             mIsLoadingNote = false;
 734         }
 735     }
 736 
 737     private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
 738 
 739         @Override
 740         protected Void doInBackground(Void... args) {
 741             saveNote();
 742             return null;
 743         }
 744 
 745         @Override
 746         protected void onPostExecute(Void nada) {
 747             if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {
 748                 // Update links
 749                 SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 750             }
 751         }
 752     }
 753 
 754     private void saveNote() {
 755         if (mNote == null) {
 756             return;
 757         }
 758 
 759         String content = getNoteContentString();
 760         String tagString = getNoteTagsString();
 761         if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 762             mNote.setContent(content);
 763             mNote.setTagString(tagString);
 764             mNote.setModificationDate(Calendar.getInstance());
 765             // Send pinned event to google analytics if changed
 766             mNote.setPinned(mPinButton.isChecked());
 767             mNote.save();
 768             if (getActivity() != null) {
 769                 if (mNote.isPinned() != mPinButton.isChecked()) {
 770                     mTracker.send(
 771                             new HitBuilders.EventBuilder()
 772                                     .setCategory(&quot;note&quot;)
<abbr title=" 773                                     .setAction((mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;)"> 773                                     .setAction((mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;ðŸ”µ</abbr>
 774                                     .setLabel(&quot;pin_button&quot;)
 775                                     .build()
 776                     );
 777                 }
 778 
 779                 mTracker.send(
 780                         new HitBuilders.EventBuilder()
 781                                 .setCategory(&quot;note&quot;)
 782                                 .setAction(&quot;edited_note&quot;)
 783                                 .setLabel(&quot;editor_save&quot;)
 784                                 .build()
 785                 );
 786             }
 787         }
 788     }
 789 
 790     // Contextual action bar for dealing with links
 791     private ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
 792 
 793         // Called when the action mode is created; startActionMode() was called
 794         @Override
 795         public boolean onCreateActionMode(ActionMode mode, Menu menu) {
 796             // Inflate a menu resource providing context menu items
 797             MenuInflater inflater = mode.getMenuInflater();
 798             if (inflater != null){
 799                 inflater.inflate(R.menu.view_link, menu);
 800                 mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
 801                 mode.setTitle(getString(R.string.link));
 802                 if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
 803                     mode.setTitleOptionalHint(false);
 804                 }
 805             }
 806             return true;
 807         }
 808 
 809         // Called each time the action mode is shown. Always called after onCreateActionMode, but
 810         // may be called multiple times if the mode is invalidated.
 811         @Override
 812         public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 813             return false; // Return false if nothing is done
 814         }
 815 
 816         // Called when the user selects a contextual menu item
 817         @Override
 818         public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 819             switch (item.getItemId()) {
 820                 case R.id.menu_view_link:
 821                     if (mLinkUrl != null) {
 822                         try {
 823                             Uri uri = Uri.parse(mLinkUrl);
 824                             Intent i = new Intent(Intent.ACTION_VIEW);
 825                             i.setData(uri);
 826                             startActivity(i);
 827                         } catch (Exception e) {
 828                             e.printStackTrace();
 829                         }
 830                         mode.finish(); // Action picked, so close the CAB
 831                     }
 832                     return true;
 833                 case R.id.menu_copy:
 834                     if (mLinkText != null &amp;&amp; getActivity() != null) {
<abbr title=" 835                         ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 835                         ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(ConðŸ”µ</abbr>
 836                         ClipData clip = ClipData.newPlainText(getString(R.string.app_name),mLinkText);
 837                         clipboard.setPrimaryClip(clip);
<abbr title=" 838                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();"> 838                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORTðŸ”µ</abbr>
 839                         mode.finish();
 840                     }
 841                     return true;
 842                 case R.id.menu_share:
 843                     if (mLinkText != null) {
 844                         try {
 845                             Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 846                             shareIntent.setType(&quot;text/plain&quot;);
 847                             shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mLinkText);
<abbr title=" 848                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 848                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.stðŸ”µ</abbr>
 849                         } catch (Exception e) {
 850                             e.printStackTrace();
 851                         }
 852                         mode.finish();
 853                     }
 854                     return true;
 855                 default:
 856                     return false;
 857             }
 858         }
 859 
 860         // Called when the user exits the action mode
 861         @Override
 862         public void onDestroyActionMode(ActionMode mode) {
 863             mActionMode = null;
 864         }
 865     };
 866 
 867     // Checks if cursor is at a URL when the selection changes
 868     // If it is a URL, show the contextual action bar
 869     @Override
 870     public void onSelectionChanged(int selStart, int selEnd) {
 871         if (selStart == selEnd) {
 872             Editable noteContent = mContentEditText.getText();
 873             if (noteContent == null)
 874                 return;
 875 
 876             URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
 877             if (urlSpans.length &gt; 0) {
 878                 URLSpan urlSpan = urlSpans[0];
 879                 mLinkUrl = urlSpan.getURL();
<abbr title=" 880                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();"> 880                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpaðŸ”µ</abbr>
 881                 if (mActionMode != null) {
 882                     mActionMode.setSubtitle(mLinkText);
 883                     setLinkMenuItem();
 884                     return;
 885                 }
 886 
 887                 // Show the Contextual Action Bar
 888                 if (getActivity() != null) {
<abbr title=" 889                     mActionMode = ((NoteEditorActivity)getActivity()).startSupportActionMode(mActionModeCallback);"> 889                     mActionMode = ((NoteEditorActivity)getActivity()).startSupportActionMode(mActionModeCðŸ”µ</abbr>
 890                     if (mActionMode != null) {
 891                         mActionMode.setSubtitle(mLinkText);
 892                     }
 893 
 894                     setLinkMenuItem();
 895                 }
 896             } else if (mActionMode != null) {
 897                 mActionMode.finish();
 898                 mActionMode = null;
 899             }
 900         } else if (mActionMode != null) {
 901             mActionMode.finish();
 902             mActionMode = null;
 903         }
 904     }
 905 
 906     private void setLinkMenuItem() {
 907         if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
 908             if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
 909                 mViewLinkMenuItem.setIcon(mCallIconResId);
 910                 mViewLinkMenuItem.setTitle(getString(R.string.call));
 911             } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
 912                 mViewLinkMenuItem.setIcon(mEmailIconResId);
 913                 mViewLinkMenuItem.setTitle(getString(R.string.email));
 914             } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
 915                 mViewLinkMenuItem.setIcon(mMapIconResId);
 916                 mViewLinkMenuItem.setTitle(getString(R.string.view_map));
 917             } else {
 918                 mViewLinkMenuItem.setIcon(mWebIconResId);
 919                 mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
 920             }
 921         }
 922     }
 923 
 924     // Resets note publish status if Simperium never returned the new publish status
 925     private Runnable mPublishTimeoutRunnable = new Runnable() {
 926         @Override
 927         public void run() {
 928             if (!isAdded()) return;
 929 
 930             getActivity().runOnUiThread(new Runnable() {
 931                 @Override
 932                 public void run() {
 933                     Toast.makeText(
 934                             getActivity(),
 935                             mNote.isPublished() ? R.string.publish_error : R.string.unpublish_error,
 936                             Toast.LENGTH_SHORT
 937                     ).show();
 938 
 939                     mNote.setPublished(!mNote.isPublished());
 940                     mNote.save();
 941 
 942                     if (mInfoPopupWindow != null &amp;&amp; mInfoPopupWindow.isShowing()) {
<abbr title=" 943                         ViewSwitcher viewSwitcher = (ViewSwitcher)mInfoPopupWindow.getContentView().findViewById(R.id.publish_view_switcher);"> 943                         ViewSwitcher viewSwitcher = (ViewSwitcher)mInfoPopupWindow.getContentView().findVðŸ”µ</abbr>
 944                         if (viewSwitcher.getDisplayedChild() == 1) {
 945                             viewSwitcher.showPrevious();
 946                         }
 947                     }
 948                 }
 949             });
 950 
 951         }
 952     };
 953 
 954     private void updateWordCount(TextView textView) {
 955         String content = getNoteContentString();
 956 
 957         if (content == null || textView == null) return;
 958 
 959         int numWords = (content.trim().length() == 0) ? 0 : content.trim().split(&quot;([\\W]+)&quot;).length;
 960 
 961         String wordCountString = getResources().getQuantityString(R.plurals.word_count, numWords);
 962         String formattedWordCount = NumberFormat.getInstance().format(numWords);
 963 
 964         textView.setText(formattedWordCount + &quot; &quot; + wordCountString);
 965     }
 966 
 967     /**
 968      * Simperium listeners
 969      */
 970 
 971     @Override
 972     public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 973 
 974     }
 975 
 976     @Override
<abbr title=" 977     public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {"> 977     public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) ðŸ”µ</abbr>
 978         if (changeType == Bucket.ChangeType.MODIFY) {
 979             if (getNote() != null &amp;&amp; getNote().getSimperiumKey().equals(key)) {
 980                 try {
 981                     final Note updatedNote = mNotesBucket.get(key);
 982                     if (getActivity() != null) {
 983                         getActivity().runOnUiThread(new Runnable() {
 984                             @Override
 985                             public void run() {
 986                                 if (mPublishTimeoutHandler != null) {
 987                                     mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 988                                 }
 989 
 990                                 updateNote(updatedNote);
 991                                 updateInfoPopup();
 992                             }
 993                         });
 994                     }
 995                 } catch (BucketObjectMissingException e) {
 996                     e.printStackTrace();
 997                 }
 998             }
 999         }
1000     }
1001 
1002 
1003     @Override
1004     public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
1005         // noop
1006     }
1007 
1008     @Override
1009     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1010         // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
1011         if (mIsLoadingNote)
1012             return;
1013 
1014         Note openNote = getNote();
1015         if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
1016             return;
1017 
1018         note.setContent(getNoteContentString());
1019     }
1020 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.ClipData;
   6 import android.content.ClipboardManager;
   7 import android.content.Context;
   8 import android.content.Intent;
   9 import android.content.res.TypedArray;
  10 import android.database.Cursor;
  11 import android.graphics.drawable.ColorDrawable;
  12 import android.net.Uri;
  13 import android.os.AsyncTask;
  14 import android.os.Build;
  15 import android.os.Bundle;
  16 import android.os.Handler;
  17 import android.support.v4.app.ActivityCompat;
  18 import android.support.v7.view.ActionMode;
  19 import android.text.Editable;
  20 import android.text.Spanned;
  21 import android.text.TextWatcher;
  22 import android.text.style.RelativeSizeSpan;
  23 import android.text.style.URLSpan;
  24 import android.text.util.Linkify;
  25 import android.util.TypedValue;
  26 import android.view.LayoutInflater;
  27 import android.view.Menu;
  28 import android.view.MenuInflater;
  29 import android.view.MenuItem;
  30 import android.view.View;
  31 import android.view.ViewGroup;
  32 import android.view.WindowManager;
  33 import android.view.inputmethod.InputMethodManager;
  34 import android.widget.CursorAdapter;
  35 import android.widget.ImageButton;
  36 import android.widget.ImageView;
  37 import android.widget.LinearLayout;
  38 import android.widget.PopupWindow;
  39 import android.widget.TextView;
  40 import android.widget.Toast;
  41 import android.widget.ToggleButton;
  42 import android.widget.ViewSwitcher;
  43 
  44 import com.automattic.simplenote.models.Note;
  45 import com.automattic.simplenote.models.Tag;
  46 import com.automattic.simplenote.utils.AutoBullet;
  47 import com.automattic.simplenote.utils.DisplayUtils;
  48 import com.automattic.simplenote.utils.MatchOffsetHighlighter;
  49 import com.automattic.simplenote.utils.PrefUtils;
  50 import com.automattic.simplenote.utils.SpaceTokenizer;
  51 import com.automattic.simplenote.widgets.SimplenoteEditText;
  52 import com.automattic.simplenote.utils.SimplenoteLinkify;
  53 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  54 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  55 import com.automattic.simplenote.utils.TextHighlighter;
  56 import com.google.android.gms.analytics.HitBuilders;
  57 import com.google.android.gms.analytics.Tracker;
  58 import com.simperium.client.Bucket;
  59 import com.simperium.client.BucketObjectMissingException;
  60 import com.simperium.client.Query;
  61 
  62 import java.text.NumberFormat;
  63 import java.util.Calendar;
  64 
<abbr title="  65 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListener, View.OnFocusChangeListener, SimplenoteEditText.OnSelectionChangedListener {">  65 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddeðŸ”µ</abbr>
  66 
  67     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  68     public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  69     static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;
  70     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  71 
  72     private Note mNote;
  73     private Bucket&lt;Note&gt; mNotesBucket;
  74 
  75     private Tracker mTracker;
  76 
  77     private SimplenoteEditText mContentEditText;
  78     private TagsMultiAutoCompleteTextView mTagView;
  79     private PopupWindow mInfoPopupWindow;
  80     private ToggleButton mPinButton;
  81     private Handler mAutoSaveHandler;
  82     private Handler mPublishTimeoutHandler;
  83     private LinearLayout mPlaceholderView;
  84     private CursorAdapter mAutocompleteAdapter;
  85     private boolean mIsNewNote, mIsLoadingNote;
  86     private ActionMode mActionMode;
  87     private MenuItem mViewLinkMenuItem;
  88     private String mLinkUrl;
  89     private String mLinkText;
  90     private MatchOffsetHighlighter mHighlighter;
  91     private int mEmailIconResId, mWebIconResId, mMapIconResId, mCallIconResId;
  92     private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
  93     private String mMatchOffsets;
  94     private int mCurrentCursorPosition;
  95 
  96     /**
  97      * Mandatory empty constructor for the fragment manager to instantiate the
  98      * fragment (e.g. upon screen orientation changes).
  99      */
 100     public NoteEditorFragment() {
 101     }
 102 
 103     @Override
 104     public void onCreate(Bundle savedInstanceState) {
 105         super.onCreate(savedInstanceState);
 106 
 107         if (getActivity() != null) {
 108             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 109             mNotesBucket = currentApp.getNotesBucket();
 110             mTracker = currentApp.getTracker();
 111 
<abbr title=" 112             TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionBarIconWeb, R.attr.actionBarIconMap, R.attr.actionBarIconCall});"> 112             TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.atðŸ”µ</abbr>
 113             if (a != null) {
 114                 mEmailIconResId = a.getResourceId(0, 0);
 115                 mWebIconResId = a.getResourceId(1, 0);
 116                 mMapIconResId = a.getResourceId(2, 0);
 117                 mCallIconResId = a.getResourceId(3, 0);
 118                 a.recycle();
 119             }
 120         }
 121 
 122         mAutoSaveHandler = new Handler();
 123         mPublishTimeoutHandler = new Handler();
 124 
 125         mMatchHighlighter = new TextHighlighter(getActivity(),
<abbr title=" 126                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);"> 126                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor)ðŸ”µ</abbr>
 127         mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0){
 128 
 129             @Override
 130             public View newView(Context context, Cursor cursor, ViewGroup parent) {
 131                 Activity activity = (Activity) context;
 132                 if (activity == null) return null;
 133                 return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 134             }
 135 
 136             @Override
 137             public void bindView(View view, Context context, Cursor cursor) {
 138                 TextView textView = (TextView) view;
 139                 textView.setText(convertToString(cursor));
 140             }
 141 
 142             @Override
 143             public CharSequence convertToString(Cursor cursor){
 144                 return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 145             }
 146 
 147             @Override
 148             public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 149                 Activity activity = getActivity();
 150                 if (activity == null) return null;
 151                 Simplenote application = (Simplenote) activity.getApplication();
 152                 Query&lt;Tag&gt; query = application.getTagsBucket().query();
 153                 // make the tag name available to the cursor
 154                 query.include(Tag.NAME_PROPERTY);
 155                 // sort the tags by their names
 156                 query.order(Tag.NAME_PROPERTY);
 157                 // if there&#x27;s a filter string find only matching tag names
<abbr title=" 158                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 158                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.forðŸ”µ</abbr>
 159                 return query.execute();
 160             }
 161         };
 162     }
 163 
 164 
 165     @Override
 166     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 167         setHasOptionsMenu(true);
 168         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 169         mContentEditText = ((SimplenoteEditText) rootView.findViewById(R.id.note_content));
 170         mContentEditText.addOnSelectionChangedListener(this);
 171         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 172         mTagView.setTokenizer(new SpaceTokenizer());
 173         mTagView.setOnFocusChangeListener(this);
 174 
 175         mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 176 
 177         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
 178         mPinButton.setOnClickListener(new View.OnClickListener() {
 179             @Override
 180             public void onClick(View v) {
 181                 if (mPinButton.isChecked()) {
 182                     // Friendly message to the user as to what this button does.
 183                     Toast.makeText(getActivity(), R.string.note_pinned, Toast.LENGTH_SHORT).show();
 184                 }
 185             }
 186         });
 187 
 188         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
 189         if (DisplayUtils.isLargeLandscape(getActivity()) &amp;&amp; mNote == null) {
 190             mPlaceholderView.setVisibility(View.VISIBLE);
 191         }
 192 
 193         mTagView.setAdapter(mAutocompleteAdapter);
 194 
 195         // Load note if we were passed a note Id
 196         Bundle arguments = getArguments();
 197         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
 198             String key = arguments.getString(ARG_ITEM_ID);
 199             if (arguments.containsKey(ARG_MATCH_OFFSETS)) {
 200                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);
 201             }
 202             new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
 203             setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));
 204         }
 205 
 206 		return rootView;
 207 	}
 208 
 209     @Override
 210     public void onResume() {
 211         super.onResume();
 212         mNotesBucket.start();
 213         mNotesBucket.addListener(this);
 214 
 215         mTagView.setOnTagAddedListener(this);
 216 
 217         if (mContentEditText != null) {
<abbr title=" 218             mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_FONT_SIZE, 18));"> 218             mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), ðŸ”µ</abbr>
 219         }
 220     }
 221 
 222     @Override
 223     public void onPause() {
 224         mNotesBucket.removeListener(this);
 225         // Hide soft keyboard if it is showing...
 226         if (getActivity() != null) {
<abbr title=" 227             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 227             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(CðŸ”µ</abbr>
 228             if (inputMethodManager != null) {
 229                 inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 230             }
 231         }
 232 
 233         // Delete the note if it is new and has empty fields
 234         if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty()) {
 235             mNote.delete();
 236         } else {
 237             saveNote();
 238         }
 239 
 240         mTagView.setOnTagAddedListener(null);
 241 
 242         if (mAutoSaveHandler != null) {
 243             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 244         }
 245 
 246         if (mPublishTimeoutHandler != null) {
 247             mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 248         }
 249 
 250         mHighlighter.stop();
 251 
 252         super.onPause();
 253     }
 254 
 255     @Override
 256     public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 257         inflater.inflate(R.menu.note_editor, menu);
 258 
 259         if (mNote != null) {
 260             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_view_info);
 261             viewPublishedNoteItem.setVisible(true);
 262 
 263             MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 264             if (mNote.isDeleted())
 265                 trashItem.setTitle(R.string.undelete);
 266             else
 267                 trashItem.setTitle(R.string.delete);
 268         }
 269 
 270         super.onCreateOptionsMenu(menu, inflater);
 271     }
 272 
 273     @Override
 274     public boolean onOptionsItemSelected(MenuItem item) {
 275         switch (item.getItemId()) {
 276             case R.id.menu_view_info:
 277                 if (mNote != null) {
 278                     View menuItemView = getActivity().findViewById(R.id.menu_view_info);
 279                     showInfoPopup(menuItemView);
 280                 }
 281                 return true;
 282             case R.id.menu_share:
 283                 if (mNote != null) {
 284                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 285                     shareIntent.setType(&quot;text/plain&quot;);
 286                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mNote.getContent());
<abbr title=" 287                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 287                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
 288                     mTracker.send(
 289                             new HitBuilders.EventBuilder()
 290                             .setCategory(&quot;note&quot;)
 291                             .setAction(&quot;shared_note&quot;)
 292                             .setLabel(&quot;action_bar_share_button&quot;)
 293                             .build()
 294                     );
 295                 }
 296                 return true;
 297             case R.id.menu_delete:
 298                 if (mNote != null) {
 299                     mNote.setDeleted(!mNote.isDeleted());
 300                     mNote.setModificationDate(Calendar.getInstance());
 301                     mNote.save();
 302                     Intent resultIntent = new Intent();
 303                     if (mNote.isDeleted())
 304                         resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());
 305                     getActivity().setResult(Activity.RESULT_OK, resultIntent);
 306                 }
 307 
 308                 ActivityCompat.finishAfterTransition(getActivity());
 309                 return true;
 310             case android.R.id.home:
 311                 ActivityCompat.finishAfterTransition(getActivity());
 312                 return true;
 313             default:
 314                 return super.onOptionsItemSelected(item);
 315         }
 316     }
 317 
 318     // show a popup view from the info action bar item
 319     private void showInfoPopup(View view) {
 320         if (!isAdded() || view == null) return;
 321 
 322         if (mInfoPopupWindow == null) {
 323             mInfoPopupWindow = new PopupWindow(getActivity());
 324             mInfoPopupWindow.setWidth(WindowManager.LayoutParams.WRAP_CONTENT);
 325             mInfoPopupWindow.setHeight(WindowManager.LayoutParams.WRAP_CONTENT);
 326             mInfoPopupWindow.setBackgroundDrawable(new ColorDrawable(0));
 327             mInfoPopupWindow.setOutsideTouchable(true);
 328             mInfoPopupWindow.setFocusable(true);
 329 
 330             LayoutInflater inflater = LayoutInflater.from(getActivity());
 331             View popupView = inflater.inflate(R.layout.popup_info, null);
 332             mInfoPopupWindow.setContentView(popupView);
 333         }
 334 
 335         updateInfoPopup();
 336 
 337         mInfoPopupWindow.showAsDropDown(view);
 338     }
 339 
 340     // update the content of the popupview
 341     private void updateInfoPopup() {
 342         if (mInfoPopupWindow == null || mInfoPopupWindow.getContentView() == null) return;
 343 
 344         View popupView = mInfoPopupWindow.getContentView();
 345 
 346         View publishButton = popupView.findViewById(R.id.publish_note_button);
 347         TextView publishButtonTextView = (TextView)popupView.findViewById(R.id.publish_note_button_text);
 348         ImageView publishButtonIcon = (ImageView)popupView.findViewById(R.id.publish_note_button_icon);
 349         TextView publishTextView = (TextView) popupView.findViewById(R.id.publish_url_textview);
 350         TextView wordCountTextView = (TextView) popupView.findViewById(R.id.word_count);
 351         ImageButton publishCopyButton = (ImageButton) popupView.findViewById(R.id.publish_copy_url);
 352         ImageButton publishShareButton = (ImageButton) popupView.findViewById(R.id.publish_share_url);
 353         View actionsView = popupView.findViewById(R.id.publish_actions);
 354 
<abbr title=" 355         final ViewSwitcher viewSwitcher = (ViewSwitcher) popupView.findViewById(R.id.publish_view_switcher);"> 355         final ViewSwitcher viewSwitcher = (ViewSwitcher) popupView.findViewById(R.id.publish_view_switcheðŸ”µ</abbr>
 356 
 357         publishButton.setOnClickListener(new View.OnClickListener() {
 358             @Override
 359             public void onClick(View v) {
 360                 if (mNote != null) {
 361                     boolean newPublishedStatus = !mNote.isPublished();
 362                     mNote.setPublished(newPublishedStatus);
 363                     mNote.save();
 364 
 365                     if (viewSwitcher.getDisplayedChild() == 0) {
 366                         viewSwitcher.showNext();
 367                     }
 368 
 369                     // reset publish status in 20 seconds if we don&#x27;t hear back from Simperium
 370                     mPublishTimeoutHandler.postDelayed(mPublishTimeoutRunnable, 20000);
 371                 }
 372             }
 373         });
 374 
 375         publishTextView.setOnClickListener(new View.OnClickListener() {
 376             @Override
 377             public void onClick(View v) {
 378                 try {
 379                     startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(mNote.getPublishedUrl())));
 380                 } catch (Exception e) {
 381                     e.printStackTrace();
 382                 }
 383             }
 384         });
 385 
 386         publishCopyButton.setOnClickListener(new View.OnClickListener() {
 387             @Override
 388             public void onClick(View v) {
<abbr title=" 389                 ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 389                 ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLðŸ”µ</abbr>
<abbr title=" 390                 ClipData clip = ClipData.newPlainText(getString(R.string.app_name), mNote.getPublishedUrl());"> 390                 ClipData clip = ClipData.newPlainText(getString(R.string.app_name), mNote.getPublishedUrlðŸ”µ</abbr>
 391                 clipboard.setPrimaryClip(clip);
<abbr title=" 392                 Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();"> 392                 Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show()ðŸ”µ</abbr>
 393             }
 394         });
 395 
 396         publishShareButton.setOnClickListener(new View.OnClickListener() {
 397             @Override
 398             public void onClick(View v) {
 399                 Intent i = new Intent(Intent.ACTION_SEND);
 400                 i.setType(&quot;text/plain&quot;);
 401                 i.putExtra(Intent.EXTRA_TEXT, mNote.getPublishedUrl());
 402                 startActivity(Intent.createChooser(i, getString(R.string.share_url)));
 403             }
 404         });
 405 
 406         updateWordCount(wordCountTextView);
 407 
 408         if (mNote.isPublished()) {
 409             publishButtonTextView.setText(getString(R.string.published));
 410             publishButtonIcon.setVisibility(View.VISIBLE);
 411             publishTextView.setText(mNote.getPublishedUrl());
 412             actionsView.setVisibility(View.VISIBLE);
 413         } else {
 414             publishButtonTextView.setText(getString(R.string.publish));
 415             publishButtonIcon.setVisibility(View.GONE);
 416             actionsView.setVisibility(View.GONE);
 417         }
 418 
 419         Simplenote currentApp = (Simplenote) getActivity().getApplication();
 420         if (currentApp.getSimperium().needsAuthorization()) {
 421             viewSwitcher.setVisibility(View.GONE);
 422         } else {
 423             viewSwitcher.setVisibility(View.VISIBLE);
 424             if (viewSwitcher.getDisplayedChild() == 1) {
 425                 viewSwitcher.showPrevious();
 426             }
 427         }
 428     }
 429 
 430     private boolean noteIsEmpty() {
 431         return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 432     }
 433 
 434     public void setNote(String noteID){
 435         setNote(noteID, null);
 436     }
 437 
 438     public void setNote(String noteID, String matchOffsets) {
 439         if (mAutoSaveHandler != null)
 440             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 441 
 442         mPlaceholderView.setVisibility(View.GONE);
 443 
 444         if (matchOffsets != null)
 445             mMatchOffsets = matchOffsets;
 446 
 447         // If we have a note already (on a tablet in landscape), save the note.
 448         if (mNote != null) {
 449             if (mIsNewNote &amp;&amp; noteIsEmpty())
 450                 mNote.delete();
 451             else if (mNote != null)
 452                 saveNote();
 453         }
 454 
 455         new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 456     }
 457 
 458     public void updateNote(Note updatedNote) {
 459         // update note if network change arrived
 460         mNote = updatedNote;
 461         refreshContent(true);
 462     }
 463 
 464     public void refreshContent(boolean isNoteUpdate) {
 465         if (mNote != null) {
 466             // Restore the cursor position if possible.
 467 
<abbr title=" 468             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 468             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEdðŸ”µ</abbr>
 469 
 470             mContentEditText.setText(mNote.getContent());
 471 
 472             if (isNoteUpdate) {
 473                 // Save the note so any local changes get synced
 474                 mNote.save();
 475 
<abbr title=" 476                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) {"> 476                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) ðŸ”µ</abbr>
 477                     mContentEditText.setSelection(cursorPosition);
 478                 }
 479             }
 480 
 481             afterTextChanged(mContentEditText.getText());
 482 
 483             mPinButton.setChecked(mNote.isPinned());
 484 
 485             updateTagList();
 486         }
 487     }
 488 
 489     public void updateTagList() {
 490         Activity activity = getActivity();
 491         if (activity == null) return;
 492 
 493         // Populate this note&#x27;s tags in the tagView
 494         mTagView.setChips(mNote.getTagString());
 495     }
 496 
 497     int newCursorLocation(String newText, String oldText, int cursorLocation) {
 498         // Ported from the iOS app :)
 499         // Cases:
 500         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 501         // 1. Text was added after the cursor ==&gt; no change
 502         // 2. Text was added before the cursor ==&gt; location advances
 503         // 3. Text was removed after the cursor ==&gt; no change
 504         // 4. Text was removed before the cursor ==&gt; location retreats
 505         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 506 
 507         int newCursorLocation = cursorLocation;
 508 
 509         int deltaLength = newText.length() - oldText.length();
 510 
 511         // Case 0
 512         if (newText.length() &lt; cursorLocation)
 513             return newText.length();
 514 
 515         boolean beforeCursorMatches = false;
 516         boolean afterCursorMatches = false;
 517 
 518         try {
<abbr title=" 519             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 519             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorðŸ”µ</abbr>
<abbr title=" 520             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 520             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substðŸ”µ</abbr>
 521         } catch (Exception e) {
 522             e.printStackTrace();
 523         }
 524 
 525         // Cases 2 and 4
 526         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 527             newCursorLocation += deltaLength;
 528 
 529         // Cases 1, 3 and 5 have no change
 530         return newCursorLocation;
 531     }
 532 
 533     private Runnable mAutoSaveRunnable = new Runnable() {
 534         @Override
 535         public void run() {
 536             saveAndSyncNote();
 537         }
 538     };
 539 
 540     @Override
 541     public void onTagsChanged(String tagString) {
 542         if (mNote == null || !isAdded()) return;
 543 
 544         if (mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length()) {
 545             mTracker.send(
 546                     new HitBuilders.EventBuilder()
 547                             .setCategory(&quot;note&quot;)
 548                             .setAction(&quot;added_tag&quot;)
 549                             .setLabel(&quot;tag_added_to_note&quot;)
 550                             .build()
 551             );
 552         }
 553         else {
 554             mTracker.send(
 555                     new HitBuilders.EventBuilder()
 556                             .setCategory(&quot;note&quot;)
 557                             .setAction(&quot;removed_tag&quot;)
 558                             .setLabel(&quot;tag_removed_from_note&quot;)
 559                             .build()
 560             );
 561         }
 562 
 563         mNote.setTagString(tagString);
 564         mNote.setModificationDate(Calendar.getInstance());
 565         updateTagList();
 566         mNote.save();
 567     }
 568 
 569     @Override
 570     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 571         // Unused
 572     }
 573 
 574     @Override
 575     public void afterTextChanged(Editable editable) {
 576         setTitleSpan(editable);
 577         attemptAutoList(editable);
 578     }
 579 
 580     @Override
 581     public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 582 
 583         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 584         if (mAutoSaveHandler != null) {
 585             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 586             mAutoSaveHandler.postDelayed(mAutoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 587         }
 588 
 589         // Remove search highlight spans when note content changes
 590         if (mMatchOffsets != null) {
 591             mMatchOffsets = null;
 592             mHighlighter.removeMatches();
 593         }
 594     }
 595 
 596     private void setTitleSpan(Editable editable) {
 597         // Set the note title to be a larger size
 598         // Remove any existing size spans
 599         RelativeSizeSpan spans[] = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 600         for (RelativeSizeSpan span : spans) {
 601             editable.removeSpan(span);
 602         }
 603         int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 604         if (newLinePosition == 0)
 605             return;
<abbr title=" 606         editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 606         editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editaðŸ”µ</abbr>
 607     }
 608 
 609     private void attemptAutoList(Editable editable) {
 610         int oldCursorPosition = mCurrentCursorPosition;
 611         mCurrentCursorPosition = mContentEditText.getSelectionStart();
 612         AutoBullet.apply(editable, oldCursorPosition, mCurrentCursorPosition);
 613         mCurrentCursorPosition = mContentEditText.getSelectionStart();
 614         android.util.Log.d(&quot;Simplenote&quot;, &quot;==&gt; post cursor position:&quot; + mCurrentCursorPosition);
 615     }
 616 
 617     private void saveAndSyncNote() {
 618         if (mNote == null)
 619             return;
 620 
 621         new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 622     }
 623 
 624     public void setPlaceholderVisible(boolean isVisible) {
 625         if (isVisible) {
 626             mNote = null;
 627             mContentEditText.setText(&quot;&quot;);
 628             mTagView.setText(&quot;&quot;);
 629             if (mPlaceholderView != null)
 630                 mPlaceholderView.setVisibility(View.VISIBLE);
 631         } else {
 632             if (mPlaceholderView != null)
 633                 mPlaceholderView.setVisibility(View.GONE);
 634         }
 635     }
 636 
 637     public void setIsNewNote(boolean isNewNote) {
 638         this.mIsNewNote = isNewNote;
 639     }
 640 
 641     @Override
 642     public void onFocusChange(View v, boolean hasFocus) {
 643         if (!hasFocus) {
 644             String tagString = getNoteTagsString().trim();
 645             if (tagString.length() &gt; 0) {
 646                 mTagView.setChips(tagString);
 647             }
 648         }
 649     }
 650 
 651     public Note getNote() {
 652         return mNote;
 653     }
 654 
 655     public String getNoteContentString() {
 656         if (mContentEditText == null || mContentEditText.getText() == null) {
 657             return &quot;&quot;;
 658         } else {
 659             return mContentEditText.getText().toString();
 660         }
 661     }
 662 
 663     public String getNoteTagsString() {
 664         if (mTagView == null || mTagView.getText() == null) {
 665             return &quot;&quot;;
 666         } else {
 667             return mTagView.getText().toString();
 668         }
 669     }
 670 
 671     private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 672 
 673         @Override
 674         protected void onPreExecute() {
 675             mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 676             mIsLoadingNote = true;
 677         }
 678 
 679         @Override
 680         protected Void doInBackground(String... args) {
 681             if (getActivity() == null) {
 682                 return null;
 683             }
 684 
 685             String noteID = args[0];
 686             Simplenote application = (Simplenote) getActivity().getApplication();
 687             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 688             try {
 689                 mNote = notesBucket.get(noteID);
 690                 // Set the current note in NotesActivity when on a tablet
 691                 if (getActivity() instanceof NotesActivity) {
 692                     ((NotesActivity) getActivity()).setCurrentNote(mNote);
 693                 }
 694             } catch (BucketObjectMissingException e) {
 695                 // TODO: Handle a missing note
 696             }
 697             return null;
 698         }
 699 
 700         @Override
 701         protected void onPostExecute(Void nada) {
 702             if (getActivity() == null || getActivity().isFinishing())
 703                 return;
 704             refreshContent(false);
 705             if (mMatchOffsets != null) {
<abbr title=" 706                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);"> 706                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.COðŸ”µ</abbr>
 707                 mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
 708             }
 709             mContentEditText.addTextChangedListener(NoteEditorFragment.this);
 710             if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 711                 // Show soft keyboard
 712                 mContentEditText.requestFocus();
 713                 new Handler().postDelayed(new Runnable() {
 714                     @Override
 715                     public void run() {
<abbr title=" 716                         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 716                         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSysðŸ”µ</abbr>
 717                         if (inputMethodManager != null)
 718                             inputMethodManager.showSoftInput(mContentEditText, 0);
 719                     }
 720                 }, 100);
 721 
 722             }
 723 
 724             SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 725 
 726             mIsLoadingNote = false;
 727         }
 728     }
 729 
 730     private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
 731 
 732         @Override
 733         protected Void doInBackground(Void... args) {
 734             saveNote();
 735             return null;
 736         }
 737 
 738         @Override
 739         protected void onPostExecute(Void nada) {
 740             if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {
 741                 // Update links
 742                 SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 743             }
 744         }
 745     }
 746 
 747     private void saveNote() {
 748         if (mNote == null) {
 749             return;
 750         }
 751 
 752         String content = getNoteContentString();
 753         String tagString = getNoteTagsString();
 754         if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 755             mNote.setContent(content);
 756             mNote.setTagString(tagString);
 757             mNote.setModificationDate(Calendar.getInstance());
 758             // Send pinned event to google analytics if changed
 759             mNote.setPinned(mPinButton.isChecked());
 760             mNote.save();
 761             if (getActivity() != null) {
 762                 if (mNote.isPinned() != mPinButton.isChecked()) {
 763                     mTracker.send(
 764                             new HitBuilders.EventBuilder()
 765                                     .setCategory(&quot;note&quot;)
<abbr title=" 766                                     .setAction((mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;)"> 766                                     .setAction((mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;ðŸ”µ</abbr>
 767                                     .setLabel(&quot;pin_button&quot;)
 768                                     .build()
 769                     );
 770                 }
 771 
 772                 mTracker.send(
 773                         new HitBuilders.EventBuilder()
 774                                 .setCategory(&quot;note&quot;)
 775                                 .setAction(&quot;edited_note&quot;)
 776                                 .setLabel(&quot;editor_save&quot;)
 777                                 .build()
 778                 );
 779             }
 780         }
 781     }
 782 
 783     // Contextual action bar for dealing with links
 784     private ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
 785 
 786         // Called when the action mode is created; startActionMode() was called
 787         @Override
 788         public boolean onCreateActionMode(ActionMode mode, Menu menu) {
 789             // Inflate a menu resource providing context menu items
 790             MenuInflater inflater = mode.getMenuInflater();
 791             if (inflater != null){
 792                 inflater.inflate(R.menu.view_link, menu);
 793                 mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
 794                 mode.setTitle(getString(R.string.link));
 795                 if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
 796                     mode.setTitleOptionalHint(false);
 797                 }
 798             }
 799             return true;
 800         }
 801 
 802         // Called each time the action mode is shown. Always called after onCreateActionMode, but
 803         // may be called multiple times if the mode is invalidated.
 804         @Override
 805         public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 806             return false; // Return false if nothing is done
 807         }
 808 
 809         // Called when the user selects a contextual menu item
 810         @Override
 811         public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 812             switch (item.getItemId()) {
 813                 case R.id.menu_view_link:
 814                     if (mLinkUrl != null) {
 815                         try {
 816                             Uri uri = Uri.parse(mLinkUrl);
 817                             Intent i = new Intent(Intent.ACTION_VIEW);
 818                             i.setData(uri);
 819                             startActivity(i);
 820                         } catch (Exception e) {
 821                             e.printStackTrace();
 822                         }
 823                         mode.finish(); // Action picked, so close the CAB
 824                     }
 825                     return true;
 826                 case R.id.menu_copy:
 827                     if (mLinkText != null &amp;&amp; getActivity() != null) {
<abbr title=" 828                         ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 828                         ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(ConðŸ”µ</abbr>
 829                         ClipData clip = ClipData.newPlainText(getString(R.string.app_name),mLinkText);
 830                         clipboard.setPrimaryClip(clip);
<abbr title=" 831                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();"> 831                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORTðŸ”µ</abbr>
 832                         mode.finish();
 833                     }
 834                     return true;
 835                 case R.id.menu_share:
 836                     if (mLinkText != null) {
 837                         try {
 838                             Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 839                             shareIntent.setType(&quot;text/plain&quot;);
 840                             shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mLinkText);
<abbr title=" 841                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 841                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.stðŸ”µ</abbr>
 842                         } catch (Exception e) {
 843                             e.printStackTrace();
 844                         }
 845                         mode.finish();
 846                     }
 847                     return true;
 848                 default:
 849                     return false;
 850             }
 851         }
 852 
 853         // Called when the user exits the action mode
 854         @Override
 855         public void onDestroyActionMode(ActionMode mode) {
 856             mActionMode = null;
 857         }
 858     };
 859 
 860     // Checks if cursor is at a URL when the selection changes
 861     // If it is a URL, show the contextual action bar
 862     @Override
 863     public void onSelectionChanged(int selStart, int selEnd) {
 864         if (selStart == selEnd) {
 865             Editable noteContent = mContentEditText.getText();
 866             if (noteContent == null)
 867                 return;
 868 
 869             URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
 870             if (urlSpans.length &gt; 0) {
 871                 URLSpan urlSpan = urlSpans[0];
 872                 mLinkUrl = urlSpan.getURL();
<abbr title=" 873                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();"> 873                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpaðŸ”µ</abbr>
 874                 if (mActionMode != null) {
 875                     mActionMode.setSubtitle(mLinkText);
 876                     setLinkMenuItem();
 877                     return;
 878                 }
 879 
 880                 // Show the Contextual Action Bar
 881                 if (getActivity() != null) {
<abbr title=" 882                     mActionMode = ((NoteEditorActivity)getActivity()).startSupportActionMode(mActionModeCallback);"> 882                     mActionMode = ((NoteEditorActivity)getActivity()).startSupportActionMode(mActionModeCðŸ”µ</abbr>
 883                     if (mActionMode != null) {
 884                         mActionMode.setSubtitle(mLinkText);
 885                     }
 886 
 887                     setLinkMenuItem();
 888                 }
 889             } else if (mActionMode != null) {
 890                 mActionMode.finish();
 891                 mActionMode = null;
 892             }
 893         } else if (mActionMode != null) {
 894             mActionMode.finish();
 895             mActionMode = null;
 896         }
 897     }
 898 
 899     private void setLinkMenuItem() {
 900         if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
 901             if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
 902                 mViewLinkMenuItem.setIcon(mCallIconResId);
 903                 mViewLinkMenuItem.setTitle(getString(R.string.call));
 904             } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
 905                 mViewLinkMenuItem.setIcon(mEmailIconResId);
 906                 mViewLinkMenuItem.setTitle(getString(R.string.email));
 907             } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
 908                 mViewLinkMenuItem.setIcon(mMapIconResId);
 909                 mViewLinkMenuItem.setTitle(getString(R.string.view_map));
 910             } else {
 911                 mViewLinkMenuItem.setIcon(mWebIconResId);
 912                 mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
 913             }
 914         }
 915     }
 916 
 917     // Resets note publish status if Simperium never returned the new publish status
 918     private Runnable mPublishTimeoutRunnable = new Runnable() {
 919         @Override
 920         public void run() {
 921             if (!isAdded()) return;
 922 
 923             getActivity().runOnUiThread(new Runnable() {
 924                 @Override
 925                 public void run() {
 926                     Toast.makeText(
 927                             getActivity(),
 928                             mNote.isPublished() ? R.string.publish_error : R.string.unpublish_error,
 929                             Toast.LENGTH_SHORT
 930                     ).show();
 931 
 932                     mNote.setPublished(!mNote.isPublished());
 933                     mNote.save();
 934 
 935                     if (mInfoPopupWindow != null &amp;&amp; mInfoPopupWindow.isShowing()) {
<abbr title=" 936                         ViewSwitcher viewSwitcher = (ViewSwitcher)mInfoPopupWindow.getContentView().findViewById(R.id.publish_view_switcher);"> 936                         ViewSwitcher viewSwitcher = (ViewSwitcher)mInfoPopupWindow.getContentView().findVðŸ”µ</abbr>
 937                         if (viewSwitcher.getDisplayedChild() == 1) {
 938                             viewSwitcher.showPrevious();
 939                         }
 940                     }
 941                 }
 942             });
 943 
 944         }
 945     };
 946 
 947     private void updateWordCount(TextView textView) {
 948         String content = getNoteContentString();
 949 
 950         if (content == null || textView == null) return;
 951 
 952         int numWords = (content.trim().length() == 0) ? 0 : content.trim().split(&quot;([\\W]+)&quot;).length;
 953 
 954         String wordCountString = getResources().getQuantityString(R.plurals.word_count, numWords);
 955         String formattedWordCount = NumberFormat.getInstance().format(numWords);
 956 
 957         textView.setText(formattedWordCount + &quot; &quot; + wordCountString);
 958     }
 959 
 960     /**
 961      * Simperium listeners
 962      */
 963 
 964     @Override
 965     public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 966 
 967     }
 968 
 969     @Override
<abbr title=" 970     public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {"> 970     public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) ðŸ”µ</abbr>
 971         if (changeType == Bucket.ChangeType.MODIFY) {
 972             if (getNote() != null &amp;&amp; getNote().getSimperiumKey().equals(key)) {
 973                 try {
 974                     final Note updatedNote = mNotesBucket.get(key);
 975                     if (getActivity() != null) {
 976                         getActivity().runOnUiThread(new Runnable() {
 977                             @Override
 978                             public void run() {
 979                                 if (mPublishTimeoutHandler != null) {
 980                                     mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 981                                 }
 982 
 983                                 updateNote(updatedNote);
 984                                 updateInfoPopup();
 985                             }
 986                         });
 987                     }
 988                 } catch (BucketObjectMissingException e) {
 989                     e.printStackTrace();
 990                 }
 991             }
 992         }
 993     }
 994 
 995 
 996     @Override
 997     public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 998         // noop
 999     }
1000 
1001     @Override
1002     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1003         // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
1004         if (mIsLoadingNote)
1005             return;
1006 
1007         Note openNote = getNote();
1008         if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
1009             return;
1010 
1011         note.setContent(getNoteContentString());
1012     }
1013 }
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.ClipData;
   6 import android.content.ClipboardManager;
   7 import android.content.Context;
   8 import android.content.Intent;
   9 import android.content.res.TypedArray;
  10 import android.database.Cursor;
  11 import android.graphics.drawable.ColorDrawable;
  12 import android.net.Uri;
  13 import android.os.AsyncTask;
  14 import android.os.Build;
  15 import android.os.Bundle;
  16 import android.os.Handler;
  17 import android.support.v4.app.ActivityCompat;
  18 import android.support.v7.view.ActionMode;
  19 import android.text.Editable;
  20 import android.text.Spanned;
  21 import android.text.TextWatcher;
  22 import android.text.style.RelativeSizeSpan;
  23 import android.text.style.URLSpan;
  24 import android.text.util.Linkify;
  25 import android.util.TypedValue;
  26 import android.view.LayoutInflater;
  27 import android.view.Menu;
  28 import android.view.MenuInflater;
  29 import android.view.MenuItem;
  30 import android.view.View;
  31 import android.view.ViewGroup;
  32 import android.view.WindowManager;
  33 import android.view.inputmethod.InputMethodManager;
  34 import android.widget.CursorAdapter;
  35 import android.widget.ImageButton;
  36 import android.widget.ImageView;
  37 import android.widget.LinearLayout;
  38 import android.widget.PopupWindow;
  39 import android.widget.TextView;
  40 import android.widget.Toast;
  41 import android.widget.ToggleButton;
  42 import android.widget.ViewSwitcher;
  43 import com.automattic.simplenote.models.Note;
  44 import com.automattic.simplenote.models.Tag;
  45 import com.automattic.simplenote.utils.AutoBullet;
  46 import com.automattic.simplenote.utils.DisplayUtils;
  47 import com.automattic.simplenote.utils.MatchOffsetHighlighter;
  48 import com.automattic.simplenote.utils.PrefUtils;
  49 import com.automattic.simplenote.utils.SimplenoteLinkify;
  50 import com.automattic.simplenote.utils.SpaceTokenizer;
  51 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  52 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  53 import com.automattic.simplenote.utils.TextHighlighter;
  54 import com.automattic.simplenote.widgets.SimplenoteEditText;
  55 import com.google.android.gms.analytics.HitBuilders;
  56 import com.google.android.gms.analytics.Tracker;
  57 import com.simperium.client.Bucket;
  58 import com.simperium.client.BucketObjectMissingException;
  59 import com.simperium.client.Query;
  60 import java.text.NumberFormat;
  61 import java.util.Calendar;
  62 
  63 
<abbr title="  64 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt; , TextWatcher , OnTagAddedListener , View.OnFocusChangeListener , SimplenoteEditText.OnSelectionChangedListener {">  64 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt; , TextWatcher , OnTagAdðŸ”µ</abbr>
  65     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  66 
  67     public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  68 
  69     static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;
  70 
  71     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  72 
  73     private Note mNote;
  74 
  75     private Bucket&lt;Note&gt; mNotesBucket;
  76 
  77     private Tracker mTracker;
  78 
  79     private SimplenoteEditText mContentEditText;
  80 
  81     private TagsMultiAutoCompleteTextView mTagView;
  82 
  83     private PopupWindow mInfoPopupWindow;
  84 
  85     private ToggleButton mPinButton;
  86 
  87     private Handler mAutoSaveHandler;
  88 
  89     private Handler mPublishTimeoutHandler;
  90 
  91     private LinearLayout mPlaceholderView;
  92 
  93     private CursorAdapter mAutocompleteAdapter;
  94 
  95     private boolean mIsNewNote;
  96 
  97     private boolean mIsLoadingNote;
  98 
  99     private ActionMode mActionMode;
 100 
 101     private MenuItem mViewLinkMenuItem;
 102 
 103     private String mLinkUrl;
 104 
 105     private String mLinkText;
 106 
 107     private MatchOffsetHighlighter mHighlighter;
 108 
 109     private int mEmailIconResId;
 110 
 111     private int mWebIconResId;
 112 
 113     private int mMapIconResId;
 114 
 115     private int mCallIconResId;
 116 
 117     private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
 118 
 119     private String mMatchOffsets;
 120 
 121     private int mCurrentCursorPosition;
 122 
 123     /**
 124      * Mandatory empty constructor for the fragment manager to instantiate the
 125      * fragment (e.g. upon screen orientation changes).
 126      */
 127     public NoteEditorFragment() {
 128     }
 129 
 130     @Override
 131     public void onCreate(Bundle savedInstanceState) {
 132         super.onCreate(savedInstanceState);
 133 
 134         if (getActivity() != null) {
 135             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 136             mNotesBucket = currentApp.getNotesBucket();
 137             mTracker = currentApp.getTracker();
 138 
<abbr title=" 139             TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionBarIconWeb, R.attr.actionBarIconMap, R.attr.actionBarIconCall});"> 139             TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.atðŸ”µ</abbr>
 140             if (a != null) {
 141                 mEmailIconResId = a.getResourceId(0, 0);
 142                 mWebIconResId = a.getResourceId(1, 0);
 143                 mMapIconResId = a.getResourceId(2, 0);
 144                 mCallIconResId = a.getResourceId(3, 0);
 145                 a.recycle();
 146             }
 147         }
 148 
 149         mAutoSaveHandler = new Handler();
 150         mPublishTimeoutHandler = new Handler();
 151 
 152         mMatchHighlighter = new TextHighlighter(getActivity(),
<abbr title=" 153                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);"> 153                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor)ðŸ”µ</abbr>
 154         mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0){
 155 
 156             @Override
 157             public View newView(Context context, Cursor cursor, ViewGroup parent) {
 158                 Activity activity = (Activity) context;
 159                 if (activity == null) return null;
 160                 return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 161             }
 162 
 163             @Override
 164             public void bindView(View view, Context context, Cursor cursor) {
 165                 TextView textView = (TextView) view;
 166                 textView.setText(convertToString(cursor));
 167             }
 168 
 169             @Override
 170             public CharSequence convertToString(Cursor cursor){
 171                 return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 172             }
 173 
 174             @Override
 175             public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 176                 Activity activity = getActivity();
 177                 if (activity == null) return null;
 178                 Simplenote application = (Simplenote) activity.getApplication();
 179                 Query&lt;Tag&gt; query = application.getTagsBucket().query();
 180                 // make the tag name available to the cursor
 181                 query.include(Tag.NAME_PROPERTY);
 182                 // sort the tags by their names
 183                 query.order(Tag.NAME_PROPERTY);
 184                 // if there&#x27;s a filter string find only matching tag names
<abbr title=" 185                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 185                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.forðŸ”µ</abbr>
 186                 return query.execute();
 187             }
 188         };
 189     }
 190 
 191     @Override
 192     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 193         setHasOptionsMenu(true);
 194         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 195         mContentEditText = ((SimplenoteEditText) (rootView.findViewById(R.id.note_content)));
 196         mContentEditText.addOnSelectionChangedListener(this);
 197         mTagView = ((TagsMultiAutoCompleteTextView) (rootView.findViewById(R.id.tag_view)));
 198         mTagView.setTokenizer(new SpaceTokenizer());
 199         mTagView.setOnFocusChangeListener(this);
 200         mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 201         mPinButton = ((ToggleButton) (rootView.findViewById(R.id.pinButton)));
 202         mPinButton.setOnClickListener(new View.OnClickListener() {
 203             @Override
 204             public void onClick(View v) {
 205                 if (mPinButton.isChecked()) {
 206                     // Friendly message to the user as to what this button does.
 207                     Toast.makeText(getActivity(), R.string.note_pinned, Toast.LENGTH_SHORT).show();
 208                 }
 209             }
 210         });
 211         mPlaceholderView = ((LinearLayout) (rootView.findViewById(R.id.placeholder)));
 212         if (DisplayUtils.isLargeLandscape(getActivity()) &amp;&amp; (mNote == null)) {
 213             mPlaceholderView.setVisibility(View.VISIBLE);
 214         }
 215         mTagView.setAdapter(mAutocompleteAdapter);
 216         // Load note if we were passed a note Id
 217         Bundle arguments = getArguments();
 218         if ((arguments != null) &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
 219             String key = arguments.getString(ARG_ITEM_ID);
 220             if (arguments.containsKey(ARG_MATCH_OFFSETS)) {
 221                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);
 222             }
 223             new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
 224             setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));
 225         }
 226         return rootView;
 227     }
 228 
 229     @Override
 230     public void onResume() {
 231         super.onResume();
 232         mNotesBucket.start();
 233         mNotesBucket.addListener(this);
 234         mTagView.setOnTagAddedListener(this);
 235         if (mContentEditText != null) {
<abbr title=" 236             mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_FONT_SIZE, 18));"> 236             mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), ðŸ”µ</abbr>
 237         }
 238     }
 239 
 240     @Override
 241     public void onPause() {
 242         mNotesBucket.removeListener(this);
 243         // Hide soft keyboard if it is showing...
 244         if (getActivity() != null) {
<abbr title=" 245             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 245             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(CðŸ”µ</abbr>
 246             if (inputMethodManager != null) {
 247                 inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 248             }
 249         }
 250 
 251         // Delete the note if it is new and has empty fields
 252         if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty()) {
 253             mNote.delete();
 254         } else {
 255             saveNote();
 256         }
 257 
 258         mTagView.setOnTagAddedListener(null);
 259 
 260         if (mAutoSaveHandler != null) {
 261             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 262         }
 263 
 264         if (mPublishTimeoutHandler != null) {
 265             mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 266         }
 267 
 268         mHighlighter.stop();
 269 
 270         super.onPause();
 271     }
 272 
 273     @Override
 274     public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 275         inflater.inflate(R.menu.note_editor, menu);
 276 
 277         if (mNote != null) {
 278             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_view_info);
 279             viewPublishedNoteItem.setVisible(true);
 280 
 281             MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 282             if (mNote.isDeleted())
 283                 trashItem.setTitle(R.string.undelete);
 284             else
 285                 trashItem.setTitle(R.string.delete);
 286         }
 287 
 288         super.onCreateOptionsMenu(menu, inflater);
 289     }
 290 
 291     @Override
 292     public boolean onOptionsItemSelected(MenuItem item) {
 293         switch (item.getItemId()) {
 294             case R.id.menu_view_info :
 295                 if (mNote != null) {
 296                     View menuItemView = getActivity().findViewById(R.id.menu_view_info);
 297                     showInfoPopup(menuItemView);
 298                 }
 299                 return true;
 300             case R.id.menu_share :
 301                 if (mNote != null) {
 302                     Intent shareIntent = new Intent(Intent.ACTION_SEND);
 303                     shareIntent.setType(&quot;text/plain&quot;);
 304                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mNote.getContent());
<abbr title=" 305                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 305                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
<abbr title=" 306                     mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;shared_note&quot;).setLabel(&quot;action_bar_share_button&quot;).build());"> 306                     mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;shared_noðŸ”µ</abbr>
 307                 }
 308                 return true;
 309             case R.id.menu_delete :
 310                 if (mNote != null) {
 311                     mNote.setDeleted(!mNote.isDeleted());
 312                     mNote.setModificationDate(Calendar.getInstance());
 313                     mNote.save();
 314                     Intent resultIntent = new Intent();
 315                     if (mNote.isDeleted()) {
 316                         resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());
 317                     }
 318                     getActivity().setResult(Activity.RESULT_OK, resultIntent);
 319                 }
 320                 ActivityCompat.finishAfterTransition(getActivity());
 321                 return true;
 322             case android.R.id.home :
 323                 ActivityCompat.finishAfterTransition(getActivity());
 324                 return true;
 325             default :
 326                 return super.onOptionsItemSelected(item);
 327         }
 328     }
 329 
 330     // show a popup view from the info action bar item
 331     private void showInfoPopup(View view) {
 332         if (!isAdded() || view == null) return;
 333 
 334         if (mInfoPopupWindow == null) {
 335             mInfoPopupWindow = new PopupWindow(getActivity());
 336             mInfoPopupWindow.setWidth(WindowManager.LayoutParams.WRAP_CONTENT);
 337             mInfoPopupWindow.setHeight(WindowManager.LayoutParams.WRAP_CONTENT);
 338             mInfoPopupWindow.setBackgroundDrawable(new ColorDrawable(0));
 339             mInfoPopupWindow.setOutsideTouchable(true);
 340             mInfoPopupWindow.setFocusable(true);
 341 
 342             LayoutInflater inflater = LayoutInflater.from(getActivity());
 343             View popupView = inflater.inflate(R.layout.popup_info, null);
 344             mInfoPopupWindow.setContentView(popupView);
 345         }
 346 
 347         updateInfoPopup();
 348 
 349         mInfoPopupWindow.showAsDropDown(view);
 350     }
 351 
 352     // update the content of the popupview
 353     private void updateInfoPopup() {
 354         if (mInfoPopupWindow == null || mInfoPopupWindow.getContentView() == null) return;
 355 
 356         View popupView = mInfoPopupWindow.getContentView();
 357 
 358         View publishButton = popupView.findViewById(R.id.publish_note_button);
 359         TextView publishButtonTextView = (TextView)popupView.findViewById(R.id.publish_note_button_text);
 360         ImageView publishButtonIcon = (ImageView)popupView.findViewById(R.id.publish_note_button_icon);
 361         TextView publishTextView = (TextView) popupView.findViewById(R.id.publish_url_textview);
 362         TextView wordCountTextView = (TextView) popupView.findViewById(R.id.word_count);
 363         ImageButton publishCopyButton = (ImageButton) popupView.findViewById(R.id.publish_copy_url);
 364         ImageButton publishShareButton = (ImageButton) popupView.findViewById(R.id.publish_share_url);
 365         View actionsView = popupView.findViewById(R.id.publish_actions);
 366 
<abbr title=" 367         final ViewSwitcher viewSwitcher = (ViewSwitcher) popupView.findViewById(R.id.publish_view_switcher);"> 367         final ViewSwitcher viewSwitcher = (ViewSwitcher) popupView.findViewById(R.id.publish_view_switcheðŸ”µ</abbr>
 368 
 369         publishButton.setOnClickListener(new View.OnClickListener() {
 370             @Override
 371             public void onClick(View v) {
 372                 if (mNote != null) {
 373                     boolean newPublishedStatus = !mNote.isPublished();
 374                     mNote.setPublished(newPublishedStatus);
 375                     mNote.save();
 376 
 377                     if (viewSwitcher.getDisplayedChild() == 0) {
 378                         viewSwitcher.showNext();
 379                     }
 380 
 381                     // reset publish status in 20 seconds if we don&#x27;t hear back from Simperium
 382                     mPublishTimeoutHandler.postDelayed(mPublishTimeoutRunnable, 20000);
 383                 }
 384             }
 385         });
 386 
 387         publishTextView.setOnClickListener(new View.OnClickListener() {
 388             @Override
 389             public void onClick(View v) {
 390                 try {
 391                     startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(mNote.getPublishedUrl())));
 392                 } catch (Exception e) {
 393                     e.printStackTrace();
 394                 }
 395             }
 396         });
 397 
 398         publishCopyButton.setOnClickListener(new View.OnClickListener() {
 399             @Override
 400             public void onClick(View v) {
<abbr title=" 401                 ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 401                 ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLðŸ”µ</abbr>
<abbr title=" 402                 ClipData clip = ClipData.newPlainText(getString(R.string.app_name), mNote.getPublishedUrl());"> 402                 ClipData clip = ClipData.newPlainText(getString(R.string.app_name), mNote.getPublishedUrlðŸ”µ</abbr>
 403                 clipboard.setPrimaryClip(clip);
<abbr title=" 404                 Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();"> 404                 Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show()ðŸ”µ</abbr>
 405             }
 406         });
 407 
 408         publishShareButton.setOnClickListener(new View.OnClickListener() {
 409             @Override
 410             public void onClick(View v) {
 411                 Intent i = new Intent(Intent.ACTION_SEND);
 412                 i.setType(&quot;text/plain&quot;);
 413                 i.putExtra(Intent.EXTRA_TEXT, mNote.getPublishedUrl());
 414                 startActivity(Intent.createChooser(i, getString(R.string.share_url)));
 415             }
 416         });
 417 
 418         updateWordCount(wordCountTextView);
 419 
 420         if (mNote.isPublished()) {
 421             publishButtonTextView.setText(getString(R.string.published));
 422             publishButtonIcon.setVisibility(View.VISIBLE);
 423             publishTextView.setText(mNote.getPublishedUrl());
 424             actionsView.setVisibility(View.VISIBLE);
 425         } else {
 426             publishButtonTextView.setText(getString(R.string.publish));
 427             publishButtonIcon.setVisibility(View.GONE);
 428             actionsView.setVisibility(View.GONE);
 429         }
 430 
 431         Simplenote currentApp = (Simplenote) getActivity().getApplication();
 432         if (currentApp.getSimperium().needsAuthorization()) {
 433             viewSwitcher.setVisibility(View.GONE);
 434         } else {
 435             viewSwitcher.setVisibility(View.VISIBLE);
 436             if (viewSwitcher.getDisplayedChild() == 1) {
 437                 viewSwitcher.showPrevious();
 438             }
 439         }
 440     }
 441 
 442     private boolean noteIsEmpty() {
 443         return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 444     }
 445 
 446     public void setNote(String noteID){
 447         setNote(noteID, null);
 448     }
 449 
 450     public void setNote(String noteID, String matchOffsets) {
 451         if (mAutoSaveHandler != null)
 452             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 453 
 454         mPlaceholderView.setVisibility(View.GONE);
 455 
 456         if (matchOffsets != null)
 457             mMatchOffsets = matchOffsets;
 458 
 459         // If we have a note already (on a tablet in landscape), save the note.
 460         if (mNote != null) {
 461             if (mIsNewNote &amp;&amp; noteIsEmpty())
 462                 mNote.delete();
 463             else if (mNote != null)
 464                 saveNote();
 465         }
 466 
 467         new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 468     }
 469 
 470     public void updateNote(Note updatedNote) {
 471         // update note if network change arrived
 472         mNote = updatedNote;
 473         refreshContent(true);
 474     }
 475 
 476     public void refreshContent(boolean isNoteUpdate) {
 477         if (mNote != null) {
 478             // Restore the cursor position if possible.
 479 
<abbr title=" 480             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 480             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEdðŸ”µ</abbr>
 481 
 482             mContentEditText.setText(mNote.getContent());
 483 
 484             if (isNoteUpdate) {
 485                 // Save the note so any local changes get synced
 486                 mNote.save();
 487 
<abbr title=" 488                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) {"> 488                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) ðŸ”µ</abbr>
 489                     mContentEditText.setSelection(cursorPosition);
 490                 }
 491             }
 492 
 493             afterTextChanged(mContentEditText.getText());
 494 
 495             mPinButton.setChecked(mNote.isPinned());
 496 
 497             updateTagList();
 498         }
 499     }
 500 
 501     public void updateTagList() {
 502         Activity activity = getActivity();
 503         if (activity == null) return;
 504 
 505         // Populate this note&#x27;s tags in the tagView
 506         mTagView.setChips(mNote.getTagString());
 507     }
 508 
 509     int newCursorLocation(String newText, String oldText, int cursorLocation) {
 510         // Ported from the iOS app :)
 511         // Cases:
 512         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 513         // 1. Text was added after the cursor ==&gt; no change
 514         // 2. Text was added before the cursor ==&gt; location advances
 515         // 3. Text was removed after the cursor ==&gt; no change
 516         // 4. Text was removed before the cursor ==&gt; location retreats
 517         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 518 
 519         int newCursorLocation = cursorLocation;
 520 
 521         int deltaLength = newText.length() - oldText.length();
 522 
 523         // Case 0
 524         if (newText.length() &lt; cursorLocation)
 525             return newText.length();
 526 
 527         boolean beforeCursorMatches = false;
 528         boolean afterCursorMatches = false;
 529 
 530         try {
<abbr title=" 531             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 531             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorðŸ”µ</abbr>
<abbr title=" 532             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 532             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substðŸ”µ</abbr>
 533         } catch (Exception e) {
 534             e.printStackTrace();
 535         }
 536 
 537         // Cases 2 and 4
 538         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 539             newCursorLocation += deltaLength;
 540 
 541         // Cases 1, 3 and 5 have no change
 542         return newCursorLocation;
 543     }
 544 
 545     private Runnable mAutoSaveRunnable = new Runnable() {
 546         @Override
 547         public void run() {
 548             saveAndSyncNote();
 549         }
 550     };
 551 
 552     @Override
 553     public void onTagsChanged(String tagString) {
 554         if (mNote == null || !isAdded()) return;
 555 
 556         if (mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length()) {
 557             mTracker.send(
 558                     new HitBuilders.EventBuilder()
 559                             .setCategory(&quot;note&quot;)
 560                             .setAction(&quot;added_tag&quot;)
 561                             .setLabel(&quot;tag_added_to_note&quot;)
 562                             .build()
 563             );
 564         }
 565         else {
 566             mTracker.send(
 567                     new HitBuilders.EventBuilder()
 568                             .setCategory(&quot;note&quot;)
 569                             .setAction(&quot;removed_tag&quot;)
 570                             .setLabel(&quot;tag_removed_from_note&quot;)
 571                             .build()
 572             );
 573         }
 574 
 575         mNote.setTagString(tagString);
 576         mNote.setModificationDate(Calendar.getInstance());
 577         updateTagList();
 578         mNote.save();
 579     }
 580 
 581     @Override
 582     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 583         // Unused
 584     }
 585 
 586     @Override
 587     public void afterTextChanged(Editable editable) {
 588         setTitleSpan(editable);
 589         attemptAutoList(editable);
 590     }
 591 
 592     @Override
 593     public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 594 
 595         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 596         if (mAutoSaveHandler != null) {
 597             mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 598             mAutoSaveHandler.postDelayed(mAutoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 599         }
 600 
 601         // Remove search highlight spans when note content changes
 602         if (mMatchOffsets != null) {
 603             mMatchOffsets = null;
 604             mHighlighter.removeMatches();
 605         }
 606     }
 607 
 608     private void setTitleSpan(Editable editable) {
 609         // Set the note title to be a larger size
 610         // Remove any existing size spans
 611         RelativeSizeSpan[] spans = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 612         for (RelativeSizeSpan span : spans) {
 613             editable.removeSpan(span);
 614         }
 615         int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 616         if (newLinePosition == 0) {
 617             return;
 618         }
<abbr title=" 619         editable.setSpan(new RelativeSizeSpan(1.227F), 0, newLinePosition &gt; 0 ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 619         editable.setSpan(new RelativeSizeSpan(1.227F), 0, newLinePosition &gt; 0 ? newLinePosition : editablðŸ”µ</abbr>
 620     }
 621 
 622     private void attemptAutoList(Editable editable) {
 623         int oldCursorPosition = mCurrentCursorPosition;
 624         mCurrentCursorPosition = mContentEditText.getSelectionStart();
 625         AutoBullet.apply(editable, oldCursorPosition, mCurrentCursorPosition);
 626         mCurrentCursorPosition = mContentEditText.getSelectionStart();
 627         android.util.Log.d(&quot;Simplenote&quot;, &quot;==&gt; post cursor position:&quot; + mCurrentCursorPosition);
 628     }
 629 
 630     private void saveAndSyncNote() {
 631         if (mNote == null)
 632             return;
 633 
 634         new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 635     }
 636 
 637     public void setPlaceholderVisible(boolean isVisible) {
 638         if (isVisible) {
 639             mNote = null;
 640             mContentEditText.setText(&quot;&quot;);
 641             mTagView.setText(&quot;&quot;);
 642             if (mPlaceholderView != null)
 643                 mPlaceholderView.setVisibility(View.VISIBLE);
 644         } else {
 645             if (mPlaceholderView != null)
 646                 mPlaceholderView.setVisibility(View.GONE);
 647         }
 648     }
 649 
 650     public void setIsNewNote(boolean isNewNote) {
 651         this.mIsNewNote = isNewNote;
 652     }
 653 
 654     @Override
 655     public void onFocusChange(View v, boolean hasFocus) {
 656         if (!hasFocus) {
 657             String tagString = getNoteTagsString().trim();
 658             if (tagString.length() &gt; 0) {
 659                 mTagView.setChips(tagString);
 660             }
 661         }
 662     }
 663 
 664     public Note getNote() {
 665         return mNote;
 666     }
 667 
 668     public String getNoteContentString() {
 669         if (mContentEditText == null || mContentEditText.getText() == null) {
 670             return &quot;&quot;;
 671         } else {
 672             return mContentEditText.getText().toString();
 673         }
 674     }
 675 
 676     public String getNoteTagsString() {
 677         if (mTagView == null || mTagView.getText() == null) {
 678             return &quot;&quot;;
 679         } else {
 680             return mTagView.getText().toString();
 681         }
 682     }
 683 
 684     private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 685         @Override
 686         protected void onPreExecute() {
 687             mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 688             mIsLoadingNote = true;
 689         }
 690 
 691         @Override
 692         protected Void doInBackground(String... args) {
 693             if (getActivity() == null) {
 694                 return null;
 695             }
 696             String noteID = args[0];
 697             Simplenote application = ((Simplenote) (getActivity().getApplication()));
 698             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 699             try {
 700                 mNote = notesBucket.get(noteID);
 701                 // Set the current note in NotesActivity when on a tablet
 702                 if (getActivity() instanceof NotesActivity) {
 703                     ((NotesActivity) (getActivity())).setCurrentNote(mNote);
 704                 }
 705             } catch (BucketObjectMissingException e) {
 706                 // TODO: Handle a missing note
 707             }
 708             return null;
 709         }
 710 
 711         @Override
 712         protected void onPostExecute(Void nada) {
 713             if ((getActivity() == null) || getActivity().isFinishing()) {
 714                 return;
 715             }
 716             refreshContent(false);
 717             if (mMatchOffsets != null) {
<abbr title=" 718                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);"> 718                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.COðŸ”µ</abbr>
 719                 mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
 720             }
 721             mContentEditText.addTextChangedListener(NoteEditorFragment.this);
 722             if ((mNote != null) &amp;&amp; mNote.getContent().isEmpty()) {
 723                 // Show soft keyboard
 724                 mContentEditText.requestFocus();
 725                 new Handler().postDelayed(new Runnable() {
 726                     @Override
 727                     public void run() {
<abbr title=" 728                         InputMethodManager inputMethodManager = ((InputMethodManager) (getActivity().getSystemService(Context.INPUT_METHOD_SERVICE)));"> 728                         InputMethodManager inputMethodManager = ((InputMethodManager) (getActivity().getSðŸ”µ</abbr>
 729                         if (inputMethodManager != null) {
 730                             inputMethodManager.showSoftInput(mContentEditText, 0);
 731                         }
 732                     }
 733                 }, 100);
 734             }
 735             SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 736             mIsLoadingNote = false;
 737         }
 738     }
 739 
 740     private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
 741         @Override
 742         protected Void doInBackground(Void... args) {
 743             saveNote();
 744             return null;
 745         }
 746 
 747         @Override
 748         protected void onPostExecute(Void nada) {
 749             if ((getActivity() != null) &amp;&amp; (!getActivity().isFinishing())) {
 750                 // Update links
 751                 SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 752             }
 753         }
 754     }
 755 
 756     private void saveNote() {
 757         if (mNote == null) {
 758             return;
 759         }
 760 
 761         String content = getNoteContentString();
 762         String tagString = getNoteTagsString();
 763         if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 764             mNote.setContent(content);
 765             mNote.setTagString(tagString);
 766             mNote.setModificationDate(Calendar.getInstance());
 767             // Send pinned event to google analytics if changed
 768             mNote.setPinned(mPinButton.isChecked());
 769             mNote.save();
 770             if (getActivity() != null) {
 771                 if (mNote.isPinned() != mPinButton.isChecked()) {
 772                     mTracker.send(
 773                             new HitBuilders.EventBuilder()
 774                                     .setCategory(&quot;note&quot;)
<abbr title=" 775                                     .setAction((mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;)"> 775                                     .setAction((mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;ðŸ”µ</abbr>
 776                                     .setLabel(&quot;pin_button&quot;)
 777                                     .build()
 778                     );
 779                 }
 780 
 781                 mTracker.send(
 782                         new HitBuilders.EventBuilder()
 783                                 .setCategory(&quot;note&quot;)
 784                                 .setAction(&quot;edited_note&quot;)
 785                                 .setLabel(&quot;editor_save&quot;)
 786                                 .build()
 787                 );
 788             }
 789         }
 790     }
 791 
 792     // Contextual action bar for dealing with links
 793     private ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
 794         // Called when the action mode is created; startActionMode() was called
 795         @Override
 796         public boolean onCreateActionMode(ActionMode mode, Menu menu) {
 797             // Inflate a menu resource providing context menu items
 798             MenuInflater inflater = mode.getMenuInflater();
 799             if (inflater != null) {
 800                 inflater.inflate(R.menu.view_link, menu);
 801                 mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
 802                 mode.setTitle(getString(R.string.link));
 803                 if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
 804                     mode.setTitleOptionalHint(false);
 805                 }
 806             }
 807             return true;
 808         }
 809 
 810         // Called each time the action mode is shown. Always called after onCreateActionMode, but
 811         // may be called multiple times if the mode is invalidated.
 812         @Override
 813         public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 814             return false;// Return false if nothing is done
 815 
 816         }
 817 
 818         // Called when the user selects a contextual menu item
 819         @Override
 820         public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 821             switch (item.getItemId()) {
 822                 case R.id.menu_view_link :
 823                     if (mLinkUrl != null) {
 824                         try {
 825                             Uri uri = Uri.parse(mLinkUrl);
 826                             Intent i = new Intent(Intent.ACTION_VIEW);
 827                             i.setData(uri);
 828                             startActivity(i);
 829                         } catch (java.lang.Exception e) {
 830                             e.printStackTrace();
 831                         }
 832                         // Action picked, so close the CAB
 833                         mode.finish();
 834                     }
 835                     return true;
 836                 case R.id.menu_copy :
 837                     if ((mLinkText != null) &amp;&amp; (getActivity() != null)) {
<abbr title=" 838                         ClipboardManager clipboard = ((ClipboardManager) (getActivity().getSystemService(Context.CLIPBOARD_SERVICE)));"> 838                         ClipboardManager clipboard = ((ClipboardManager) (getActivity().getSystemService(ðŸ”µ</abbr>
 839                         ClipData clip = ClipData.newPlainText(getString(R.string.app_name), mLinkText);
 840                         clipboard.setPrimaryClip(clip);
<abbr title=" 841                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();"> 841                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORTðŸ”µ</abbr>
 842                         mode.finish();
 843                     }
 844                     return true;
 845                 case R.id.menu_share :
 846                     if (mLinkText != null) {
 847                         try {
 848                             Intent shareIntent = new Intent(Intent.ACTION_SEND);
 849                             shareIntent.setType(&quot;text/plain&quot;);
 850                             shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mLinkText);
<abbr title=" 851                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 851                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.stðŸ”µ</abbr>
 852                         } catch (java.lang.Exception e) {
 853                             e.printStackTrace();
 854                         }
 855                         mode.finish();
 856                     }
 857                     return true;
 858                 default :
 859                     return false;
 860             }
 861         }
 862 
 863         // Called when the user exits the action mode
 864         @Override
 865         public void onDestroyActionMode(ActionMode mode) {
 866             mActionMode = null;
 867         }
 868     };
 869 
 870     // Checks if cursor is at a URL when the selection changes
 871     // If it is a URL, show the contextual action bar
 872     @Override
 873     public void onSelectionChanged(int selStart, int selEnd) {
 874         if (selStart == selEnd) {
 875             Editable noteContent = mContentEditText.getText();
 876             if (noteContent == null) {
 877                 return;
 878             }
 879             URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
 880             if (urlSpans.length &gt; 0) {
 881                 URLSpan urlSpan = urlSpans[0];
 882                 mLinkUrl = urlSpan.getURL();
<abbr title=" 883                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();"> 883                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpaðŸ”µ</abbr>
 884                 if (mActionMode != null) {
 885                     mActionMode.setSubtitle(mLinkText);
 886                     setLinkMenuItem();
 887                     return;
 888                 }
 889                 // Show the Contextual Action Bar
 890                 if (getActivity() != null) {
<abbr title=" 891                     mActionMode = ((NoteEditorActivity) (getActivity())).startSupportActionMode(mActionModeCallback);"> 891                     mActionMode = ((NoteEditorActivity) (getActivity())).startSupportActionMode(mActionMoðŸ”µ</abbr>
 892                     if (mActionMode != null) {
 893                         mActionMode.setSubtitle(mLinkText);
 894                     }
 895                     setLinkMenuItem();
 896                 }
 897             } else if (mActionMode != null) {
 898                 mActionMode.finish();
 899                 mActionMode = null;
 900             }
 901         } else if (mActionMode != null) {
 902             mActionMode.finish();
 903             mActionMode = null;
 904         }
 905     }
 906 
 907     private void setLinkMenuItem() {
 908         if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
 909             if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
 910                 mViewLinkMenuItem.setIcon(mCallIconResId);
 911                 mViewLinkMenuItem.setTitle(getString(R.string.call));
 912             } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
 913                 mViewLinkMenuItem.setIcon(mEmailIconResId);
 914                 mViewLinkMenuItem.setTitle(getString(R.string.email));
 915             } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
 916                 mViewLinkMenuItem.setIcon(mMapIconResId);
 917                 mViewLinkMenuItem.setTitle(getString(R.string.view_map));
 918             } else {
 919                 mViewLinkMenuItem.setIcon(mWebIconResId);
 920                 mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
 921             }
 922         }
 923     }
 924 
 925     // Resets note publish status if Simperium never returned the new publish status
 926     // Resets note publish status if Simperium never returned the new publish status
 927     private Runnable mPublishTimeoutRunnable = new Runnable() {
 928         @Override
 929         public void run() {
 930             if (!isAdded()) return;
 931 
 932             getActivity().runOnUiThread(new Runnable() {
 933                 @Override
 934                 public void run() {
 935                     Toast.makeText(
 936                             getActivity(),
 937                             mNote.isPublished() ? R.string.publish_error : R.string.unpublish_error,
 938                             Toast.LENGTH_SHORT
 939                     ).show();
 940 
 941                     mNote.setPublished(!mNote.isPublished());
 942                     mNote.save();
 943 
 944                     if (mInfoPopupWindow != null &amp;&amp; mInfoPopupWindow.isShowing()) {
<abbr title=" 945                         ViewSwitcher viewSwitcher = (ViewSwitcher)mInfoPopupWindow.getContentView().findViewById(R.id.publish_view_switcher);"> 945                         ViewSwitcher viewSwitcher = (ViewSwitcher)mInfoPopupWindow.getContentView().findVðŸ”µ</abbr>
 946                         if (viewSwitcher.getDisplayedChild() == 1) {
 947                             viewSwitcher.showPrevious();
 948                         }
 949                     }
 950                 }
 951             });
 952 
 953         }
 954     };
 955 
 956     private void updateWordCount(TextView textView) {
 957         String content = getNoteContentString();
 958 
 959         if (content == null || textView == null) return;
 960 
 961         int numWords = (content.trim().length() == 0) ? 0 : content.trim().split(&quot;([\\W]+)&quot;).length;
 962 
 963         String wordCountString = getResources().getQuantityString(R.plurals.word_count, numWords);
 964         String formattedWordCount = NumberFormat.getInstance().format(numWords);
 965 
 966         textView.setText(formattedWordCount + &quot; &quot; + wordCountString);
 967     }
 968 
 969     /**
 970      * Simperium listeners
 971      */
 972 
 973     @Override
 974     public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 975 
 976     }
 977 
 978     @Override
<abbr title=" 979     public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {"> 979     public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) ðŸ”µ</abbr>
 980         if (changeType == Bucket.ChangeType.MODIFY) {
 981             if ((getNote() != null) &amp;&amp; getNote().getSimperiumKey().equals(key)) {
 982                 try {
 983                     final Note updatedNote = mNotesBucket.get(key);
 984                     if (getActivity() != null) {
 985                         getActivity().runOnUiThread(new Runnable() {
 986                             @Override
 987                             public void run() {
 988                                 if (mPublishTimeoutHandler != null) {
 989                                     mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 990                                 }
 991                                 updateNote(updatedNote);
 992                                 updateInfoPopup();
 993                             }
 994                         });
 995                     }
 996                 } catch (BucketObjectMissingException e) {
 997                     e.printStackTrace();
 998                 }
 999             }
1000         }
1001     }
1002 
1003     @Override
1004     public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
1005         // noop
1006     }
1007 
1008     @Override
1009     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1010         // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
1011         if (mIsLoadingNote)
1012             return;
1013 
1014         Note openNote = getNote();
1015         if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
1016             return;
1017 
1018         note.setContent(getNoteContentString());
1019     }
1020 }</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.Fragment;
   5  import android.content.ClipData;
   6  import android.content.ClipboardManager;
   7  import android.content.Context;
   8  import android.content.Intent;
   9  import android.content.res.TypedArray;
  10  import android.database.Cursor;
  11  import android.graphics.drawable.ColorDrawable;
  12  import android.net.Uri;
  13  import android.os.AsyncTask;
  14  import android.os.Build;
  15  import android.os.Bundle;
  16  import android.os.Handler;


  17  import android.text.Editable;
  18  import android.text.Spanned;
  19  import android.text.TextWatcher;
  20  import android.text.style.RelativeSizeSpan;
  21  import android.text.style.URLSpan;
  22  import android.text.util.Linkify;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import android.util.TypedValue;</span>
  24  import android.view.ActionMode;
  25  import android.view.LayoutInflater;
  26  import android.view.Menu;
  27  import android.view.MenuInflater;
  28  import android.view.MenuItem;
  29  import android.view.View;
  30  import android.view.ViewGroup;
  31  import android.view.WindowManager;
  32  import android.view.inputmethod.InputMethodManager;
  33  import android.widget.CursorAdapter;
  34  import android.widget.ImageButton;
  35  import android.widget.ImageView;
  36  import android.widget.LinearLayout;
  37  import android.widget.PopupWindow;
  38  import android.widget.TextView;
  39  import android.widget.Toast;
  40  import android.widget.ToggleButton;
  41  import android.widget.ViewSwitcher;
  42  
  43  import com.automattic.simplenote.models.Note;
  44  import com.automattic.simplenote.models.Tag;
  45  import com.automattic.simplenote.utils.AutoBullet;

  46  import com.automattic.simplenote.utils.MatchOffsetHighlighter;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import com.automattic.simplenote.utils.PrefUtils;</span>
  48  import com.automattic.simplenote.utils.SpaceTokenizer;
  49  import com.automattic.simplenote.widgets.SimplenoteEditText;
  50  import com.automattic.simplenote.utils.SimplenoteLinkify;
  51  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  52  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  53  import com.automattic.simplenote.utils.TextHighlighter;
  54  import com.google.android.gms.analytics.HitBuilders;
  55  import com.google.android.gms.analytics.Tracker;
  56  import com.simperium.client.Bucket;
  57  import com.simperium.client.BucketObjectMissingException;
  58  import com.simperium.client.Query;
  59  
  60  import java.text.NumberFormat;
  61  import java.util.Calendar;
  62  
<abbr title="  63  public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListener, View.OnFocusChangeListener, SimplenoteEditText.OnSelectionChangedListener {">  63  public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListenerðŸ”µ</abbr>
  64  
  65      public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  66      public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  67      static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;
  68      private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  69  
  70      private Note mNote;
  71      private Bucket&lt;Note&gt; mNotesBucket;
  72  
  73      private Tracker mTracker;
  74  
  75      private SimplenoteEditText mContentEditText;
  76      private TagsMultiAutoCompleteTextView mTagView;
  77      private PopupWindow mInfoPopupWindow;
  78      private ToggleButton mPinButton;
  79      private Handler mAutoSaveHandler;
  80      private Handler mPublishTimeoutHandler;
  81      private LinearLayout mPlaceholderView;
  82      private CursorAdapter mAutocompleteAdapter;
  83      private boolean mIsNewNote, mIsLoadingNote;
  84      private ActionMode mActionMode;
  85      private MenuItem mViewLinkMenuItem;
  86      private String mLinkUrl;
  87      private String mLinkText;
  88      private MatchOffsetHighlighter mHighlighter;
  89      private int mEmailIconResId, mWebIconResId, mMapIconResId, mCallIconResId;
  90      private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
  91      private String mMatchOffsets;
  92      private int mCurrentCursorPosition;
  93  
  94      /**
  95       * Mandatory empty constructor for the fragment manager to instantiate the
  96       * fragment (e.g. upon screen orientation changes).
  97       */
  98      public NoteEditorFragment() {
  99      }
 100  
 101      @Override
 102      public void onCreate(Bundle savedInstanceState) {
 103          super.onCreate(savedInstanceState);
 104  
 105          if (getActivity() != null) {
 106              Simplenote currentApp = (Simplenote) getActivity().getApplication();
 107              mNotesBucket = currentApp.getNotesBucket();
 108              mTracker = currentApp.getTracker();
 109  
<abbr title=" 110              TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionBarIconWeb, R.attr.actionBarIconMap, R.attr.actionBarIconCall});"> 110              TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionðŸ”µ</abbr>
 111              if (a != null) {
 112                  mEmailIconResId = a.getResourceId(0, 0);
 113                  mWebIconResId = a.getResourceId(1, 0);
 114                  mMapIconResId = a.getResourceId(2, 0);
 115                  mCallIconResId = a.getResourceId(3, 0);
 116                  a.recycle();
 117              }
 118          }
 119  
 120          mAutoSaveHandler = new Handler();
 121          mPublishTimeoutHandler = new Handler();
 122  
 123          mMatchHighlighter = new TextHighlighter(getActivity(),
 124                  R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);
 125          mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0){
 126  
 127              @Override
 128              public View newView(Context context, Cursor cursor, ViewGroup parent) {
 129                  Activity activity = (Activity) context;
 130                  if (activity == null) return null;
 131                  return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 132              }
 133  
 134              @Override
 135              public void bindView(View view, Context context, Cursor cursor) {
 136                  TextView textView = (TextView) view;
 137                  textView.setText(convertToString(cursor));
 138              }
 139  
 140              @Override
 141              public CharSequence convertToString(Cursor cursor){
 142                  return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 143              }
 144  
 145              @Override
 146              public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 147                  Activity activity = getActivity();
 148                  if (activity == null) return null;
 149                  Simplenote application = (Simplenote) activity.getApplication();
 150                  Query&lt;Tag&gt; query = application.getTagsBucket().query();
 151                  // make the tag name available to the cursor
 152                  query.include(Tag.NAME_PROPERTY);
 153                  // sort the tags by their names
 154                  query.order(Tag.NAME_PROPERTY);
 155                  // if there&#x27;s a filter string find only matching tag names
<abbr title=" 156                  if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 156                  if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%ðŸ”µ</abbr>
 157                  return query.execute();
 158              }
 159          };
 160      }
 161  
 162  
 163      @Override
 164      public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 165          setHasOptionsMenu(true);
 166          View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 167          mContentEditText = ((SimplenoteEditText) rootView.findViewById(R.id.note_content));
 168          mContentEditText.addOnSelectionChangedListener(this);
 169          mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 170          mTagView.setTokenizer(new SpaceTokenizer());
 171          mTagView.setOnFocusChangeListener(this);
 172  
 173          mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 174  
 175          mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
 176          mPinButton.setOnClickListener(new View.OnClickListener() {
 177              @Override
 178              public void onClick(View v) {
 179                  if (mPinButton.isChecked()) {
 180                      // Friendly message to the user as to what this button does.
 181                      Toast.makeText(getActivity(), R.string.note_pinned, Toast.LENGTH_SHORT).show();
 182                  }
 183              }
 184          });
 185  
 186          mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
<abbr title=" 187          if ((getActivity() instanceof NotesActivity) &amp;&amp; ((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;&amp; mNote == null)"> 187          if ((getActivity() instanceof NotesActivity) &amp;&amp; ((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;ðŸ”µ</abbr>

 188              mPlaceholderView.setVisibility(View.VISIBLE);

 189  
 190          mTagView.setAdapter(mAutocompleteAdapter);
 191  
 192          // Load note if we were passed a note Id
 193          Bundle arguments = getArguments();
 194          if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
 195              String key = arguments.getString(ARG_ITEM_ID);
 196              if (arguments.containsKey(ARG_MATCH_OFFSETS)) {
 197                  mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);
 198              }
 199              new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
 200              setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));
 201          }
 202  
 203  		return rootView;
 204  	}
 205  
 206      @Override
 207      public void onResume() {
 208          super.onResume();
 209          mNotesBucket.start();
 210          mNotesBucket.addListener(this);
 211  
 212          mTagView.setOnTagAddedListener(this);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +        if (mContentEditText != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 215 +            mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_FONT_SIZE, 18));"> 215 +            mContentEditText.setTextSize(TypedValue.COMPLEX_UNIT_SP, PrefUtils.getIntPref(getActivity(), PrefUtilsðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +        }</span>
 217      }
 218  
 219      @Override
 220      public void onPause() {
 221          mNotesBucket.removeListener(this);
 222          // Hide soft keyboard if it is showing...
 223          if (getActivity() != null) {
<abbr title=" 224              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 224              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INðŸ”µ</abbr>
 225              if (inputMethodManager != null) {
 226                  inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 227              }
 228          }
 229  
 230          // Delete the note if it is new and has empty fields
 231          if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty()) {
 232              mNote.delete();
 233          } else {
 234              saveNote();
 235          }
 236  
 237          mTagView.setOnTagAddedListener(null);
 238  
 239          if (mAutoSaveHandler != null) {
 240              mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 241          }
 242  
 243          if (mPublishTimeoutHandler != null) {
 244              mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 245          }
 246  
 247          mHighlighter.stop();
 248  
 249          super.onPause();
 250      }
 251  
 252      @Override
 253      public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 254          inflater.inflate(R.menu.note_editor, menu);
 255  
 256          if (mNote != null) {
 257              MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_view_info);
 258              viewPublishedNoteItem.setVisible(true);
 259  
 260              MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 261              if (mNote.isDeleted())
 262                  trashItem.setTitle(R.string.undelete);
 263              else
 264                  trashItem.setTitle(R.string.delete);
 265          }
 266  
 267          super.onCreateOptionsMenu(menu, inflater);
 268      }
 269  
 270      @Override
 271      public boolean onOptionsItemSelected(MenuItem item) {
 272          switch (item.getItemId()) {
 273              case R.id.menu_view_info:
 274                  if (mNote != null) {
 275                      View menuItemView = getActivity().findViewById(R.id.menu_view_info);
 276                      showInfoPopup(menuItemView);
 277                  }
 278                  return true;
 279              case R.id.menu_share:
 280                  if (mNote != null) {
 281                      Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 282                      shareIntent.setType(&quot;text/plain&quot;);
 283                      shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mNote.getContent());
<abbr title=" 284                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 284                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note))ðŸ”µ</abbr>
 285                      mTracker.send(
 286                              new HitBuilders.EventBuilder()
 287                              .setCategory(&quot;note&quot;)
 288                              .setAction(&quot;shared_note&quot;)
 289                              .setLabel(&quot;action_bar_share_button&quot;)
 290                              .build()
 291                      );
 292                  }
 293                  return true;
 294              case R.id.menu_delete:
 295                  if (mNote != null) {
 296                      mNote.setDeleted(!mNote.isDeleted());
 297                      mNote.setModificationDate(Calendar.getInstance());
 298                      mNote.save();
 299                      Intent resultIntent = new Intent();
 300                      if (mNote.isDeleted())
 301                          resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());
 302                      getActivity().setResult(Activity.RESULT_OK, resultIntent);
 303                  }
 304                  getActivity().finish();


 305                  return true;
 306              case android.R.id.home:
 307                  getActivity().finish();

 308                  return true;
 309              default:
 310                  return super.onOptionsItemSelected(item);
 311          }
 312      }
 313  
 314      // show a popup view from the info action bar item
 315      private void showInfoPopup(View view) {
 316          if (!isAdded() || view == null) return;
 317  
 318          if (mInfoPopupWindow == null) {
 319              mInfoPopupWindow = new PopupWindow(getActivity());
 320              mInfoPopupWindow.setWidth(WindowManager.LayoutParams.WRAP_CONTENT);
 321              mInfoPopupWindow.setHeight(WindowManager.LayoutParams.WRAP_CONTENT);
 322              mInfoPopupWindow.setBackgroundDrawable(new ColorDrawable(0));
 323              mInfoPopupWindow.setOutsideTouchable(true);
 324              mInfoPopupWindow.setFocusable(true);
 325  
 326              LayoutInflater inflater = LayoutInflater.from(getActivity());
 327              View popupView = inflater.inflate(R.layout.popup_info, null);
 328              mInfoPopupWindow.setContentView(popupView);
 329          }
 330  
 331          updateInfoPopup();
 332  
 333          mInfoPopupWindow.showAsDropDown(view);
 334      }
 335  
 336      // update the content of the popupview
 337      private void updateInfoPopup() {
 338          if (mInfoPopupWindow == null || mInfoPopupWindow.getContentView() == null) return;
 339  
 340          View popupView = mInfoPopupWindow.getContentView();
 341  
 342          View publishButton = popupView.findViewById(R.id.publish_note_button);
 343          TextView publishButtonTextView = (TextView)popupView.findViewById(R.id.publish_note_button_text);
 344          ImageView publishButtonIcon = (ImageView)popupView.findViewById(R.id.publish_note_button_icon);
 345          TextView publishTextView = (TextView) popupView.findViewById(R.id.publish_url_textview);
 346          TextView wordCountTextView = (TextView) popupView.findViewById(R.id.word_count);
 347          ImageButton publishCopyButton = (ImageButton) popupView.findViewById(R.id.publish_copy_url);
 348          ImageButton publishShareButton = (ImageButton) popupView.findViewById(R.id.publish_share_url);
 349          View actionsView = popupView.findViewById(R.id.publish_actions);
 350  
 351          final ViewSwitcher viewSwitcher = (ViewSwitcher) popupView.findViewById(R.id.publish_view_switcher);
 352  
 353          publishButton.setOnClickListener(new View.OnClickListener() {
 354              @Override
 355              public void onClick(View v) {
 356                  if (mNote != null) {
 357                      boolean newPublishedStatus = !mNote.isPublished();
 358                      mNote.setPublished(newPublishedStatus);
 359                      mNote.save();
 360  
 361                      if (viewSwitcher.getDisplayedChild() == 0) {
 362                          viewSwitcher.showNext();
 363                      }
 364  
 365                      // reset publish status in 20 seconds if we don&#x27;t hear back from Simperium
 366                      mPublishTimeoutHandler.postDelayed(mPublishTimeoutRunnable, 20000);
 367                  }
 368              }
 369          });
 370  
 371          publishTextView.setOnClickListener(new View.OnClickListener() {
 372              @Override
 373              public void onClick(View v) {
 374                  try {
 375                      startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(mNote.getPublishedUrl())));
 376                  } catch (Exception e) {
 377                      e.printStackTrace();
 378                  }
 379              }
 380          });
 381  
 382          publishCopyButton.setOnClickListener(new View.OnClickListener() {
 383              @Override
 384              public void onClick(View v) {
<abbr title=" 385                  ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 385                  ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SðŸ”µ</abbr>
 386                  ClipData clip = ClipData.newPlainText(getString(R.string.app_name), mNote.getPublishedUrl());
 387                  clipboard.setPrimaryClip(clip);
 388                  Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();
 389              }
 390          });
 391  
 392          publishShareButton.setOnClickListener(new View.OnClickListener() {
 393              @Override
 394              public void onClick(View v) {
 395                  Intent i = new Intent(Intent.ACTION_SEND);
 396                  i.setType(&quot;text/plain&quot;);
 397                  i.putExtra(Intent.EXTRA_TEXT, mNote.getPublishedUrl());
 398                  startActivity(Intent.createChooser(i, getString(R.string.share_url)));
 399              }
 400          });
 401  
 402          updateWordCount(wordCountTextView);
 403  
 404          if (mNote.isPublished()) {
 405              publishButtonTextView.setText(getString(R.string.published));
 406              publishButtonIcon.setVisibility(View.VISIBLE);
 407              publishTextView.setText(mNote.getPublishedUrl());
 408              actionsView.setVisibility(View.VISIBLE);
 409          } else {
 410              publishButtonTextView.setText(getString(R.string.publish));
 411              publishButtonIcon.setVisibility(View.GONE);
 412              actionsView.setVisibility(View.GONE);
 413          }
 414  
 415          Simplenote currentApp = (Simplenote) getActivity().getApplication();
 416          if (currentApp.getSimperium().needsAuthorization()) {
 417              viewSwitcher.setVisibility(View.GONE);
 418          } else {
 419              viewSwitcher.setVisibility(View.VISIBLE);
 420              if (viewSwitcher.getDisplayedChild() == 1) {
 421                  viewSwitcher.showPrevious();
 422              }
 423          }
 424      }
 425  
 426      private boolean noteIsEmpty() {
 427          return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 428      }
 429  
 430      public void setNote(String noteID){
 431          setNote(noteID, null);
 432      }
 433  
 434      public void setNote(String noteID, String matchOffsets) {
 435          if (mAutoSaveHandler != null)
 436              mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 437  
 438          mPlaceholderView.setVisibility(View.GONE);
 439  
 440          if (matchOffsets != null)
 441              mMatchOffsets = matchOffsets;
 442  
 443          // If we have a note already (on a tablet in landscape), save the note.
 444          if (mNote != null) {
 445              if (mIsNewNote &amp;&amp; noteIsEmpty())
 446                  mNote.delete();
 447              else if (mNote != null)
 448                  saveNote();
 449          }
 450  
 451          new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 452      }
 453  
 454      public void updateNote(Note updatedNote) {
 455          // update note if network change arrived
 456          mNote = updatedNote;
 457          refreshContent(true);
 458      }
 459  
 460      public void refreshContent(boolean isNoteUpdate) {
 461          if (mNote != null) {
 462              // Restore the cursor position if possible.
 463  
<abbr title=" 464              int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 464              int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.geðŸ”µ</abbr>
 465  
 466              mContentEditText.setText(mNote.getContent());
 467  
 468              if (isNoteUpdate) {
 469                  // Save the note so any local changes get synced
 470                  mNote.save();
 471  
 472                  if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) {
 473                      mContentEditText.setSelection(cursorPosition);
 474                  }
 475              }
 476  
 477              afterTextChanged(mContentEditText.getText());
 478  
 479              mPinButton.setChecked(mNote.isPinned());
 480  
 481              updateTagList();
 482          }
 483      }
 484  
 485      public void updateTagList() {
 486          Activity activity = getActivity();
 487          if (activity == null) return;
 488  
 489          // Populate this note&#x27;s tags in the tagView
 490          mTagView.setChips(mNote.getTagString());
 491      }
 492  
 493      int newCursorLocation(String newText, String oldText, int cursorLocation) {
 494          // Ported from the iOS app :)
 495          // Cases:
 496          // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 497          // 1. Text was added after the cursor ==&gt; no change
 498          // 2. Text was added before the cursor ==&gt; location advances
 499          // 3. Text was removed after the cursor ==&gt; no change
 500          // 4. Text was removed before the cursor ==&gt; location retreats
 501          // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 502  
 503          int newCursorLocation = cursorLocation;
 504  
 505          int deltaLength = newText.length() - oldText.length();
 506  
 507          // Case 0
 508          if (newText.length() &lt; cursorLocation)
 509              return newText.length();
 510  
 511          boolean beforeCursorMatches = false;
 512          boolean afterCursorMatches = false;
 513  
 514          try {
<abbr title=" 515              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 515              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation)ðŸ”µ</abbr>
<abbr title=" 516              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 516              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursðŸ”µ</abbr>
 517          } catch (Exception e) {
 518              e.printStackTrace();
 519          }
 520  
 521          // Cases 2 and 4
 522          if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 523              newCursorLocation += deltaLength;
 524  
 525          // Cases 1, 3 and 5 have no change
 526          return newCursorLocation;
 527      }
 528  
 529      private Runnable mAutoSaveRunnable = new Runnable() {
 530          @Override
 531          public void run() {
 532              saveAndSyncNote();
 533          }
 534      };
 535  
 536      @Override
 537      public void onTagsChanged(String tagString) {
 538          if (mNote == null || !isAdded()) return;
 539  
 540          if (mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length()) {
 541              mTracker.send(
 542                      new HitBuilders.EventBuilder()
 543                              .setCategory(&quot;note&quot;)
 544                              .setAction(&quot;added_tag&quot;)
 545                              .setLabel(&quot;tag_added_to_note&quot;)
 546                              .build()
 547              );
 548          }
 549          else {
 550              mTracker.send(
 551                      new HitBuilders.EventBuilder()
 552                              .setCategory(&quot;note&quot;)
 553                              .setAction(&quot;removed_tag&quot;)
 554                              .setLabel(&quot;tag_removed_from_note&quot;)
 555                              .build()
 556              );
 557          }
 558  
 559          mNote.setTagString(tagString);
 560          mNote.setModificationDate(Calendar.getInstance());
 561          updateTagList();
 562          mNote.save();
 563      }
 564  
 565      @Override
 566      public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 567          // Unused
 568      }
 569  
 570      @Override
 571      public void afterTextChanged(Editable editable) {
 572          setTitleSpan(editable);
 573          attemptAutoList(editable);
 574      }
 575  
 576      @Override
 577      public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 578  
 579          // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 580          if (mAutoSaveHandler != null) {
 581              mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 582              mAutoSaveHandler.postDelayed(mAutoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 583          }
 584  
 585          // Remove search highlight spans when note content changes
 586          if (mMatchOffsets != null) {
 587              mMatchOffsets = null;
 588              mHighlighter.removeMatches();
 589          }
 590      }
 591  
 592      private void setTitleSpan(Editable editable) {
 593          // Set the note title to be a larger size
 594          // Remove any existing size spans
 595          RelativeSizeSpan spans[] = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 596          for (RelativeSizeSpan span : spans) {
 597              editable.removeSpan(span);
 598          }
 599          int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 600          if (newLinePosition == 0)
 601              return;
<abbr title=" 602          editable.setSpan(new RelativeSizeSpan(1.222f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 602          editable.setSpan(new RelativeSizeSpan(1.222f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.lengtðŸ”µ</abbr>

 603      }
 604  
 605      private void attemptAutoList(Editable editable) {
 606          int oldCursorPosition = mCurrentCursorPosition;
 607          mCurrentCursorPosition = mContentEditText.getSelectionStart();
 608          AutoBullet.apply(editable, oldCursorPosition, mCurrentCursorPosition);
 609          mCurrentCursorPosition = mContentEditText.getSelectionStart();
 610          android.util.Log.d(&quot;Simplenote&quot;, &quot;==&gt; post cursor position:&quot; + mCurrentCursorPosition);
 611      }
 612  
 613      private void saveAndSyncNote() {
 614          if (mNote == null)
 615              return;
 616  
 617          new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 618      }
 619  
 620      public void setPlaceholderVisible(boolean isVisible) {
 621          if (isVisible) {
 622              mNote = null;
 623              mContentEditText.setText(&quot;&quot;);
 624              mTagView.setText(&quot;&quot;);
 625              if (mPlaceholderView != null)
 626                  mPlaceholderView.setVisibility(View.VISIBLE);
 627          } else {
 628              if (mPlaceholderView != null)
 629                  mPlaceholderView.setVisibility(View.GONE);
 630          }
 631      }
 632  
 633      public void setIsNewNote(boolean isNewNote) {
 634          this.mIsNewNote = isNewNote;
 635      }
 636  
 637      @Override
 638      public void onFocusChange(View v, boolean hasFocus) {
 639          if (!hasFocus) {
 640              String tagString = getNoteTagsString().trim();
 641              if (tagString.length() &gt; 0) {
 642                  mTagView.setChips(tagString);
 643              }
 644          }
 645      }
 646  
 647      public Note getNote() {
 648          return mNote;
 649      }
 650  
 651      public String getNoteContentString() {
 652          if (mContentEditText == null || mContentEditText.getText() == null) {
 653              return &quot;&quot;;
 654          } else {
 655              return mContentEditText.getText().toString();
 656          }
 657      }
 658  
 659      public String getNoteTagsString() {
 660          if (mTagView == null || mTagView.getText() == null) {
 661              return &quot;&quot;;
 662          } else {
 663              return mTagView.getText().toString();
 664          }
 665      }
 666  
 667      private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 668  
 669          @Override
 670          protected void onPreExecute() {
 671              mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 672              mIsLoadingNote = true;
 673          }
 674  
 675          @Override
 676          protected Void doInBackground(String... args) {
 677              if (getActivity() == null) {
 678                  return null;
 679              }
 680  
 681              String noteID = args[0];
 682              Simplenote application = (Simplenote) getActivity().getApplication();
 683              Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 684              try {
 685                  mNote = notesBucket.get(noteID);
 686                  // Set the current note in NotesActivity when on a tablet
 687                  if (getActivity() instanceof NotesActivity) {
 688                      ((NotesActivity) getActivity()).setCurrentNote(mNote);
 689                  }
 690              } catch (BucketObjectMissingException e) {
 691                  // TODO: Handle a missing note
 692              }
 693              return null;
 694          }
 695  
 696          @Override
 697          protected void onPostExecute(Void nada) {
 698              if (getActivity() == null || getActivity().isFinishing())
 699                  return;
 700              refreshContent(false);
 701              if (mMatchOffsets != null) {
<abbr title=" 702                  int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);"> 702                  int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROðŸ”µ</abbr>
 703                  mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
 704              }
 705              mContentEditText.addTextChangedListener(NoteEditorFragment.this);
 706              if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 707                  // Show soft keyboard
 708                  mContentEditText.requestFocus();
 709                  new Handler().postDelayed(new Runnable() {
 710                      @Override
 711                      public void run() {
<abbr title=" 712                          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 712                          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemServicðŸ”µ</abbr>
 713                          if (inputMethodManager != null)
 714                              inputMethodManager.showSoftInput(mContentEditText, 0);
 715                      }
 716                  }, 100);
 717  
 718              }
 719  
 720              SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 721  
 722              mIsLoadingNote = false;
 723          }
 724      }
 725  
 726      private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
 727  
 728          @Override
 729          protected Void doInBackground(Void... args) {
 730              saveNote();
 731              return null;
 732          }
 733  
 734          @Override
 735          protected void onPostExecute(Void nada) {
 736              if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {
 737                  // Update links
 738                  SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 739              }
 740          }
 741      }
 742  
 743      private void saveNote() {
 744          if (mNote == null) {
 745              return;
 746          }
 747  
 748          String content = getNoteContentString();
 749          String tagString = getNoteTagsString();
 750          if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 751              mNote.setContent(content);
 752              mNote.setTagString(tagString);
 753              mNote.setModificationDate(Calendar.getInstance());
 754              // Send pinned event to google analytics if changed
 755              mNote.setPinned(mPinButton.isChecked());
 756              mNote.save();
 757              if (getActivity() != null) {
 758                  if (mNote.isPinned() != mPinButton.isChecked()) {
 759                      mTracker.send(
 760                              new HitBuilders.EventBuilder()
 761                                      .setCategory(&quot;note&quot;)
 762                                      .setAction((mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;)
 763                                      .setLabel(&quot;pin_button&quot;)
 764                                      .build()
 765                      );
 766                  }
 767  
 768                  mTracker.send(
 769                          new HitBuilders.EventBuilder()
 770                                  .setCategory(&quot;note&quot;)
 771                                  .setAction(&quot;edited_note&quot;)
 772                                  .setLabel(&quot;editor_save&quot;)
 773                                  .build()
 774                  );
 775              }
 776          }
 777      }
 778  
 779      // Contextual action bar for dealing with links
 780      private ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
 781  
 782          // Called when the action mode is created; startActionMode() was called
 783          @Override
 784          public boolean onCreateActionMode(ActionMode mode, Menu menu) {
 785              // Inflate a menu resource providing context menu items
 786              MenuInflater inflater = mode.getMenuInflater();
 787              if (inflater != null){
 788                  inflater.inflate(R.menu.view_link, menu);
 789                  mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
 790                  mode.setTitle(getString(R.string.link));
 791                  if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
 792                      mode.setTitleOptionalHint(false);
 793                  }
 794              }
 795              return true;
 796          }
 797  
 798          // Called each time the action mode is shown. Always called after onCreateActionMode, but
 799          // may be called multiple times if the mode is invalidated.
 800          @Override
 801          public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 802              return false; // Return false if nothing is done
 803          }
 804  
 805          // Called when the user selects a contextual menu item
 806          @Override
 807          public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 808              switch (item.getItemId()) {
 809                  case R.id.menu_view_link:
 810                      if (mLinkUrl != null) {
 811                          try {
 812                              Uri uri = Uri.parse(mLinkUrl);
 813                              Intent i = new Intent(Intent.ACTION_VIEW);
 814                              i.setData(uri);
 815                              startActivity(i);
 816                          } catch (Exception e) {
 817                              e.printStackTrace();
 818                          }
 819                          mode.finish(); // Action picked, so close the CAB
 820                      }
 821                      return true;
 822                  case R.id.menu_copy:
 823                      if (mLinkText != null &amp;&amp; getActivity() != null) {
<abbr title=" 824                          ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 824                          ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPðŸ”µ</abbr>
 825                          ClipData clip = ClipData.newPlainText(getString(R.string.app_name),mLinkText);
 826                          clipboard.setPrimaryClip(clip);
 827                          Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();
 828                          mode.finish();
 829                      }
 830                      return true;
 831                  case R.id.menu_share:
 832                      if (mLinkText != null) {
 833                          try {
 834                              Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 835                              shareIntent.setType(&quot;text/plain&quot;);
 836                              shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mLinkText);
<abbr title=" 837                              startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 837                              startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.sharðŸ”µ</abbr>
 838                          } catch (Exception e) {
 839                              e.printStackTrace();
 840                          }
 841                          mode.finish();
 842                      }
 843                      return true;
 844                  default:
 845                      return false;
 846              }
 847          }
 848  
 849          // Called when the user exits the action mode
 850          @Override
 851          public void onDestroyActionMode(ActionMode mode) {
 852              mActionMode = null;
 853          }
 854      };
 855  
 856      // Checks if cursor is at a URL when the selection changes
 857      // If it is a URL, show the contextual action bar
 858      @Override
 859      public void onSelectionChanged(int selStart, int selEnd) {
 860          if (selStart == selEnd) {
 861              Editable noteContent = mContentEditText.getText();
 862              if (noteContent == null)
 863                  return;
 864  
 865              URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
 866              if (urlSpans.length &gt; 0) {
 867                  URLSpan urlSpan = urlSpans[0];
 868                  mLinkUrl = urlSpan.getURL();
<abbr title=" 869                  mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();"> 869                  mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSðŸ”µ</abbr>
 870                  if (mActionMode != null) {
 871                      mActionMode.setSubtitle(mLinkText);
 872                      setLinkMenuItem();
 873                      return;
 874                  }
 875  
 876                  // Show the Contextual Action Bar
 877                  if (getActivity() != null) {
 878                      mActionMode = getActivity().startActionMode(mActionModeCallback);

 879                      if (mActionMode != null) {
 880                          mActionMode.setSubtitle(mLinkText);
 881                      }

 882                      setLinkMenuItem();
 883                  }
 884              } else if (mActionMode != null) {
 885                  mActionMode.finish();
 886                  mActionMode = null;
 887              }
 888          } else if (mActionMode != null) {
 889              mActionMode.finish();
 890              mActionMode = null;
 891          }
 892      }
 893  
 894      private void setLinkMenuItem() {
 895          if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
 896              if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
 897                  mViewLinkMenuItem.setIcon(mCallIconResId);
 898                  mViewLinkMenuItem.setTitle(getString(R.string.call));
 899              } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
 900                  mViewLinkMenuItem.setIcon(mEmailIconResId);
 901                  mViewLinkMenuItem.setTitle(getString(R.string.email));
 902              } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
 903                  mViewLinkMenuItem.setIcon(mMapIconResId);
 904                  mViewLinkMenuItem.setTitle(getString(R.string.view_map));
 905              } else {
 906                  mViewLinkMenuItem.setIcon(mWebIconResId);
 907                  mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
 908              }
 909          }
 910      }
 911  
 912      // Resets note publish status if Simperium never returned the new publish status
 913      private Runnable mPublishTimeoutRunnable = new Runnable() {
 914          @Override
 915          public void run() {
 916              if (!isAdded()) return;
 917  
 918              getActivity().runOnUiThread(new Runnable() {
 919                  @Override
 920                  public void run() {
 921                      Toast.makeText(
 922                              getActivity(),
 923                              mNote.isPublished() ? R.string.publish_error : R.string.unpublish_error,
 924                              Toast.LENGTH_SHORT
 925                      ).show();
 926  
 927                      mNote.setPublished(!mNote.isPublished());
 928                      mNote.save();
 929  
 930                      if (mInfoPopupWindow != null &amp;&amp; mInfoPopupWindow.isShowing()) {
<abbr title=" 931                          ViewSwitcher viewSwitcher = (ViewSwitcher)mInfoPopupWindow.getContentView().findViewById(R.id.publish_view_switcher);"> 931                          ViewSwitcher viewSwitcher = (ViewSwitcher)mInfoPopupWindow.getContentView().findViewById(RðŸ”µ</abbr>
 932                          if (viewSwitcher.getDisplayedChild() == 1) {
 933                              viewSwitcher.showPrevious();
 934                          }
 935                      }
 936                  }
 937              });
 938  
 939          }
 940      };
 941  
 942      private void updateWordCount(TextView textView) {
 943          String content = getNoteContentString();
 944  
 945          if (content == null || textView == null) return;
 946  
 947          int numWords = (content.trim().length() == 0) ? 0 : content.trim().split(&quot;([\\W]+)&quot;).length;
 948  
 949          String wordCountString = getResources().getQuantityString(R.plurals.word_count, numWords);
 950          String formattedWordCount = NumberFormat.getInstance().format(numWords);
 951  
 952          textView.setText(formattedWordCount + &quot; &quot; + wordCountString);
 953      }
 954  
 955      /**
 956       * Simperium listeners
 957       */
 958  
 959      @Override
 960      public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 961  
 962      }
 963  
 964      @Override
 965      public void onChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {

 966          if (changeType == Bucket.ChangeType.MODIFY) {
 967              if (getNote() != null &amp;&amp; getNote().getSimperiumKey().equals(key)) {
 968                  try {
 969                      final Note updatedNote = mNotesBucket.get(key);
 970                      if (getActivity() != null) {
 971                          getActivity().runOnUiThread(new Runnable() {
 972                              @Override
 973                              public void run() {
 974                                  if (mPublishTimeoutHandler != null) {
 975                                      mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 976                                  }
 977  
 978                                  updateNote(updatedNote);
 979                                  updateInfoPopup();
 980                              }
 981                          });
 982                      }
 983                  } catch (BucketObjectMissingException e) {
 984                      e.printStackTrace();
 985                  }
 986              }
 987          }
 988      }
 989  
 990  
 991      @Override
 992      public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 993          // noop
 994      }
 995  
 996      @Override
 997      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 998          // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
 999          if (mIsLoadingNote)
1000              return;
1001  
1002          Note openNote = getNote();
1003          if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
1004              return;
1005  
1006          note.setContent(getNoteContentString());
1007      }
1008  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.Fragment;
   5  import android.content.ClipData;
   6  import android.content.ClipboardManager;
   7  import android.content.Context;
   8  import android.content.Intent;
   9  import android.content.res.TypedArray;
  10  import android.database.Cursor;
  11  import android.graphics.drawable.ColorDrawable;
  12  import android.net.Uri;
  13  import android.os.AsyncTask;
  14  import android.os.Build;
  15  import android.os.Bundle;
  16  import android.os.Handler;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 +import android.support.v4.app.ActivityCompat;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +import android.support.v7.view.ActionMode;</span>
  19  import android.text.Editable;
  20  import android.text.Spanned;
  21  import android.text.TextWatcher;
  22  import android.text.style.RelativeSizeSpan;
  23  import android.text.style.URLSpan;
  24  import android.text.util.Linkify;

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import android.view.ActionMode;</span>
  26  import android.view.LayoutInflater;
  27  import android.view.Menu;
  28  import android.view.MenuInflater;
  29  import android.view.MenuItem;
  30  import android.view.View;
  31  import android.view.ViewGroup;
  32  import android.view.WindowManager;
  33  import android.view.inputmethod.InputMethodManager;
  34  import android.widget.CursorAdapter;
  35  import android.widget.ImageButton;
  36  import android.widget.ImageView;
  37  import android.widget.LinearLayout;
  38  import android.widget.PopupWindow;
  39  import android.widget.TextView;
  40  import android.widget.Toast;
  41  import android.widget.ToggleButton;
  42  import android.widget.ViewSwitcher;
  43  
  44  import com.automattic.simplenote.models.Note;
  45  import com.automattic.simplenote.models.Tag;
  46  import com.automattic.simplenote.utils.AutoBullet;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import com.automattic.simplenote.utils.DisplayUtils;</span>
  48  import com.automattic.simplenote.utils.MatchOffsetHighlighter;

  49  import com.automattic.simplenote.utils.SpaceTokenizer;
  50  import com.automattic.simplenote.widgets.SimplenoteEditText;
  51  import com.automattic.simplenote.utils.SimplenoteLinkify;
  52  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  53  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  54  import com.automattic.simplenote.utils.TextHighlighter;
  55  import com.google.android.gms.analytics.HitBuilders;
  56  import com.google.android.gms.analytics.Tracker;
  57  import com.simperium.client.Bucket;
  58  import com.simperium.client.BucketObjectMissingException;
  59  import com.simperium.client.Query;
  60  
  61  import java.text.NumberFormat;
  62  import java.util.Calendar;
  63  
<abbr title="  64  public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListener, View.OnFocusChangeListener, SimplenoteEditText.OnSelectionChangedListener {">  64  public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListenerðŸ”µ</abbr>
  65  
  66      public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  67      public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  68      static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;
  69      private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  70  
  71      private Note mNote;
  72      private Bucket&lt;Note&gt; mNotesBucket;
  73  
  74      private Tracker mTracker;
  75  
  76      private SimplenoteEditText mContentEditText;
  77      private TagsMultiAutoCompleteTextView mTagView;
  78      private PopupWindow mInfoPopupWindow;
  79      private ToggleButton mPinButton;
  80      private Handler mAutoSaveHandler;
  81      private Handler mPublishTimeoutHandler;
  82      private LinearLayout mPlaceholderView;
  83      private CursorAdapter mAutocompleteAdapter;
  84      private boolean mIsNewNote, mIsLoadingNote;
  85      private ActionMode mActionMode;
  86      private MenuItem mViewLinkMenuItem;
  87      private String mLinkUrl;
  88      private String mLinkText;
  89      private MatchOffsetHighlighter mHighlighter;
  90      private int mEmailIconResId, mWebIconResId, mMapIconResId, mCallIconResId;
  91      private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
  92      private String mMatchOffsets;
  93      private int mCurrentCursorPosition;
  94  
  95      /**
  96       * Mandatory empty constructor for the fragment manager to instantiate the
  97       * fragment (e.g. upon screen orientation changes).
  98       */
  99      public NoteEditorFragment() {
 100      }
 101  
 102      @Override
 103      public void onCreate(Bundle savedInstanceState) {
 104          super.onCreate(savedInstanceState);
 105  
 106          if (getActivity() != null) {
 107              Simplenote currentApp = (Simplenote) getActivity().getApplication();
 108              mNotesBucket = currentApp.getNotesBucket();
 109              mTracker = currentApp.getTracker();
 110  
<abbr title=" 111              TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionBarIconWeb, R.attr.actionBarIconMap, R.attr.actionBarIconCall});"> 111              TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionðŸ”µ</abbr>
 112              if (a != null) {
 113                  mEmailIconResId = a.getResourceId(0, 0);
 114                  mWebIconResId = a.getResourceId(1, 0);
 115                  mMapIconResId = a.getResourceId(2, 0);
 116                  mCallIconResId = a.getResourceId(3, 0);
 117                  a.recycle();
 118              }
 119          }
 120  
 121          mAutoSaveHandler = new Handler();
 122          mPublishTimeoutHandler = new Handler();
 123  
 124          mMatchHighlighter = new TextHighlighter(getActivity(),
 125                  R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);
 126          mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0){
 127  
 128              @Override
 129              public View newView(Context context, Cursor cursor, ViewGroup parent) {
 130                  Activity activity = (Activity) context;
 131                  if (activity == null) return null;
 132                  return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 133              }
 134  
 135              @Override
 136              public void bindView(View view, Context context, Cursor cursor) {
 137                  TextView textView = (TextView) view;
 138                  textView.setText(convertToString(cursor));
 139              }
 140  
 141              @Override
 142              public CharSequence convertToString(Cursor cursor){
 143                  return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 144              }
 145  
 146              @Override
 147              public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 148                  Activity activity = getActivity();
 149                  if (activity == null) return null;
 150                  Simplenote application = (Simplenote) activity.getApplication();
 151                  Query&lt;Tag&gt; query = application.getTagsBucket().query();
 152                  // make the tag name available to the cursor
 153                  query.include(Tag.NAME_PROPERTY);
 154                  // sort the tags by their names
 155                  query.order(Tag.NAME_PROPERTY);
 156                  // if there&#x27;s a filter string find only matching tag names
<abbr title=" 157                  if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 157                  if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%ðŸ”µ</abbr>
 158                  return query.execute();
 159              }
 160          };
 161      }
 162  
 163  
 164      @Override
 165      public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 166          setHasOptionsMenu(true);
 167          View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 168          mContentEditText = ((SimplenoteEditText) rootView.findViewById(R.id.note_content));
 169          mContentEditText.addOnSelectionChangedListener(this);
 170          mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 171          mTagView.setTokenizer(new SpaceTokenizer());
 172          mTagView.setOnFocusChangeListener(this);
 173  
 174          mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 175  
 176          mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
 177          mPinButton.setOnClickListener(new View.OnClickListener() {
 178              @Override
 179              public void onClick(View v) {
 180                  if (mPinButton.isChecked()) {
 181                      // Friendly message to the user as to what this button does.
 182                      Toast.makeText(getActivity(), R.string.note_pinned, Toast.LENGTH_SHORT).show();
 183                  }
 184              }
 185          });
 186  
 187          mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 188 -        if ((getActivity() instanceof NotesActivity) &amp;&amp; ((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;&amp; mNote == null)"> 188 -        if ((getActivity() instanceof NotesActivity) &amp;&amp; ((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +        if (DisplayUtils.isLargeLandscape(getActivity()) &amp;&amp; mNote == null) {</span>
 190              mPlaceholderView.setVisibility(View.VISIBLE);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +        }</span>
 192  
 193          mTagView.setAdapter(mAutocompleteAdapter);
 194  
 195          // Load note if we were passed a note Id
 196          Bundle arguments = getArguments();
 197          if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
 198              String key = arguments.getString(ARG_ITEM_ID);
 199              if (arguments.containsKey(ARG_MATCH_OFFSETS)) {
 200                  mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);
 201              }
 202              new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
 203              setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));
 204          }
 205  
 206  		return rootView;
 207  	}
 208  
 209      @Override
 210      public void onResume() {
 211          super.onResume();
 212          mNotesBucket.start();
 213          mNotesBucket.addListener(this);
 214  
 215          mTagView.setOnTagAddedListener(this);




 216      }
 217  
 218      @Override
 219      public void onPause() {
 220          mNotesBucket.removeListener(this);
 221          // Hide soft keyboard if it is showing...
 222          if (getActivity() != null) {
<abbr title=" 223              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 223              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INðŸ”µ</abbr>
 224              if (inputMethodManager != null) {
 225                  inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 226              }
 227          }
 228  
 229          // Delete the note if it is new and has empty fields
 230          if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty()) {
 231              mNote.delete();
 232          } else {
 233              saveNote();
 234          }
 235  
 236          mTagView.setOnTagAddedListener(null);
 237  
 238          if (mAutoSaveHandler != null) {
 239              mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 240          }
 241  
 242          if (mPublishTimeoutHandler != null) {
 243              mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 244          }
 245  
 246          mHighlighter.stop();
 247  
 248          super.onPause();
 249      }
 250  
 251      @Override
 252      public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 253          inflater.inflate(R.menu.note_editor, menu);
 254  
 255          if (mNote != null) {
 256              MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_view_info);
 257              viewPublishedNoteItem.setVisible(true);
 258  
 259              MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 260              if (mNote.isDeleted())
 261                  trashItem.setTitle(R.string.undelete);
 262              else
 263                  trashItem.setTitle(R.string.delete);
 264          }
 265  
 266          super.onCreateOptionsMenu(menu, inflater);
 267      }
 268  
 269      @Override
 270      public boolean onOptionsItemSelected(MenuItem item) {
 271          switch (item.getItemId()) {
 272              case R.id.menu_view_info:
 273                  if (mNote != null) {
 274                      View menuItemView = getActivity().findViewById(R.id.menu_view_info);
 275                      showInfoPopup(menuItemView);
 276                  }
 277                  return true;
 278              case R.id.menu_share:
 279                  if (mNote != null) {
 280                      Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 281                      shareIntent.setType(&quot;text/plain&quot;);
 282                      shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mNote.getContent());
<abbr title=" 283                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 283                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note))ðŸ”µ</abbr>
 284                      mTracker.send(
 285                              new HitBuilders.EventBuilder()
 286                              .setCategory(&quot;note&quot;)
 287                              .setAction(&quot;shared_note&quot;)
 288                              .setLabel(&quot;action_bar_share_button&quot;)
 289                              .build()
 290                      );
 291                  }
 292                  return true;
 293              case R.id.menu_delete:
 294                  if (mNote != null) {
 295                      mNote.setDeleted(!mNote.isDeleted());
 296                      mNote.setModificationDate(Calendar.getInstance());
 297                      mNote.save();
 298                      Intent resultIntent = new Intent();
 299                      if (mNote.isDeleted())
 300                          resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());
 301                      getActivity().setResult(Activity.RESULT_OK, resultIntent);
 302                  }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -                getActivity().finish();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +                ActivityCompat.finishAfterTransition(getActivity());</span>
 306                  return true;
 307              case android.R.id.home:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -                getActivity().finish();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +                ActivityCompat.finishAfterTransition(getActivity());</span>
 310                  return true;
 311              default:
 312                  return super.onOptionsItemSelected(item);
 313          }
 314      }
 315  
 316      // show a popup view from the info action bar item
 317      private void showInfoPopup(View view) {
 318          if (!isAdded() || view == null) return;
 319  
 320          if (mInfoPopupWindow == null) {
 321              mInfoPopupWindow = new PopupWindow(getActivity());
 322              mInfoPopupWindow.setWidth(WindowManager.LayoutParams.WRAP_CONTENT);
 323              mInfoPopupWindow.setHeight(WindowManager.LayoutParams.WRAP_CONTENT);
 324              mInfoPopupWindow.setBackgroundDrawable(new ColorDrawable(0));
 325              mInfoPopupWindow.setOutsideTouchable(true);
 326              mInfoPopupWindow.setFocusable(true);
 327  
 328              LayoutInflater inflater = LayoutInflater.from(getActivity());
 329              View popupView = inflater.inflate(R.layout.popup_info, null);
 330              mInfoPopupWindow.setContentView(popupView);
 331          }
 332  
 333          updateInfoPopup();
 334  
 335          mInfoPopupWindow.showAsDropDown(view);
 336      }
 337  
 338      // update the content of the popupview
 339      private void updateInfoPopup() {
 340          if (mInfoPopupWindow == null || mInfoPopupWindow.getContentView() == null) return;
 341  
 342          View popupView = mInfoPopupWindow.getContentView();
 343  
 344          View publishButton = popupView.findViewById(R.id.publish_note_button);
 345          TextView publishButtonTextView = (TextView)popupView.findViewById(R.id.publish_note_button_text);
 346          ImageView publishButtonIcon = (ImageView)popupView.findViewById(R.id.publish_note_button_icon);
 347          TextView publishTextView = (TextView) popupView.findViewById(R.id.publish_url_textview);
 348          TextView wordCountTextView = (TextView) popupView.findViewById(R.id.word_count);
 349          ImageButton publishCopyButton = (ImageButton) popupView.findViewById(R.id.publish_copy_url);
 350          ImageButton publishShareButton = (ImageButton) popupView.findViewById(R.id.publish_share_url);
 351          View actionsView = popupView.findViewById(R.id.publish_actions);
 352  
 353          final ViewSwitcher viewSwitcher = (ViewSwitcher) popupView.findViewById(R.id.publish_view_switcher);
 354  
 355          publishButton.setOnClickListener(new View.OnClickListener() {
 356              @Override
 357              public void onClick(View v) {
 358                  if (mNote != null) {
 359                      boolean newPublishedStatus = !mNote.isPublished();
 360                      mNote.setPublished(newPublishedStatus);
 361                      mNote.save();
 362  
 363                      if (viewSwitcher.getDisplayedChild() == 0) {
 364                          viewSwitcher.showNext();
 365                      }
 366  
 367                      // reset publish status in 20 seconds if we don&#x27;t hear back from Simperium
 368                      mPublishTimeoutHandler.postDelayed(mPublishTimeoutRunnable, 20000);
 369                  }
 370              }
 371          });
 372  
 373          publishTextView.setOnClickListener(new View.OnClickListener() {
 374              @Override
 375              public void onClick(View v) {
 376                  try {
 377                      startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(mNote.getPublishedUrl())));
 378                  } catch (Exception e) {
 379                      e.printStackTrace();
 380                  }
 381              }
 382          });
 383  
 384          publishCopyButton.setOnClickListener(new View.OnClickListener() {
 385              @Override
 386              public void onClick(View v) {
<abbr title=" 387                  ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 387                  ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SðŸ”µ</abbr>
 388                  ClipData clip = ClipData.newPlainText(getString(R.string.app_name), mNote.getPublishedUrl());
 389                  clipboard.setPrimaryClip(clip);
 390                  Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();
 391              }
 392          });
 393  
 394          publishShareButton.setOnClickListener(new View.OnClickListener() {
 395              @Override
 396              public void onClick(View v) {
 397                  Intent i = new Intent(Intent.ACTION_SEND);
 398                  i.setType(&quot;text/plain&quot;);
 399                  i.putExtra(Intent.EXTRA_TEXT, mNote.getPublishedUrl());
 400                  startActivity(Intent.createChooser(i, getString(R.string.share_url)));
 401              }
 402          });
 403  
 404          updateWordCount(wordCountTextView);
 405  
 406          if (mNote.isPublished()) {
 407              publishButtonTextView.setText(getString(R.string.published));
 408              publishButtonIcon.setVisibility(View.VISIBLE);
 409              publishTextView.setText(mNote.getPublishedUrl());
 410              actionsView.setVisibility(View.VISIBLE);
 411          } else {
 412              publishButtonTextView.setText(getString(R.string.publish));
 413              publishButtonIcon.setVisibility(View.GONE);
 414              actionsView.setVisibility(View.GONE);
 415          }
 416  
 417          Simplenote currentApp = (Simplenote) getActivity().getApplication();
 418          if (currentApp.getSimperium().needsAuthorization()) {
 419              viewSwitcher.setVisibility(View.GONE);
 420          } else {
 421              viewSwitcher.setVisibility(View.VISIBLE);
 422              if (viewSwitcher.getDisplayedChild() == 1) {
 423                  viewSwitcher.showPrevious();
 424              }
 425          }
 426      }
 427  
 428      private boolean noteIsEmpty() {
 429          return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 430      }
 431  
 432      public void setNote(String noteID){
 433          setNote(noteID, null);
 434      }
 435  
 436      public void setNote(String noteID, String matchOffsets) {
 437          if (mAutoSaveHandler != null)
 438              mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 439  
 440          mPlaceholderView.setVisibility(View.GONE);
 441  
 442          if (matchOffsets != null)
 443              mMatchOffsets = matchOffsets;
 444  
 445          // If we have a note already (on a tablet in landscape), save the note.
 446          if (mNote != null) {
 447              if (mIsNewNote &amp;&amp; noteIsEmpty())
 448                  mNote.delete();
 449              else if (mNote != null)
 450                  saveNote();
 451          }
 452  
 453          new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 454      }
 455  
 456      public void updateNote(Note updatedNote) {
 457          // update note if network change arrived
 458          mNote = updatedNote;
 459          refreshContent(true);
 460      }
 461  
 462      public void refreshContent(boolean isNoteUpdate) {
 463          if (mNote != null) {
 464              // Restore the cursor position if possible.
 465  
<abbr title=" 466              int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 466              int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.geðŸ”µ</abbr>
 467  
 468              mContentEditText.setText(mNote.getContent());
 469  
 470              if (isNoteUpdate) {
 471                  // Save the note so any local changes get synced
 472                  mNote.save();
 473  
 474                  if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) {
 475                      mContentEditText.setSelection(cursorPosition);
 476                  }
 477              }
 478  
 479              afterTextChanged(mContentEditText.getText());
 480  
 481              mPinButton.setChecked(mNote.isPinned());
 482  
 483              updateTagList();
 484          }
 485      }
 486  
 487      public void updateTagList() {
 488          Activity activity = getActivity();
 489          if (activity == null) return;
 490  
 491          // Populate this note&#x27;s tags in the tagView
 492          mTagView.setChips(mNote.getTagString());
 493      }
 494  
 495      int newCursorLocation(String newText, String oldText, int cursorLocation) {
 496          // Ported from the iOS app :)
 497          // Cases:
 498          // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 499          // 1. Text was added after the cursor ==&gt; no change
 500          // 2. Text was added before the cursor ==&gt; location advances
 501          // 3. Text was removed after the cursor ==&gt; no change
 502          // 4. Text was removed before the cursor ==&gt; location retreats
 503          // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 504  
 505          int newCursorLocation = cursorLocation;
 506  
 507          int deltaLength = newText.length() - oldText.length();
 508  
 509          // Case 0
 510          if (newText.length() &lt; cursorLocation)
 511              return newText.length();
 512  
 513          boolean beforeCursorMatches = false;
 514          boolean afterCursorMatches = false;
 515  
 516          try {
<abbr title=" 517              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 517              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation)ðŸ”µ</abbr>
<abbr title=" 518              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 518              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursðŸ”µ</abbr>
 519          } catch (Exception e) {
 520              e.printStackTrace();
 521          }
 522  
 523          // Cases 2 and 4
 524          if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 525              newCursorLocation += deltaLength;
 526  
 527          // Cases 1, 3 and 5 have no change
 528          return newCursorLocation;
 529      }
 530  
 531      private Runnable mAutoSaveRunnable = new Runnable() {
 532          @Override
 533          public void run() {
 534              saveAndSyncNote();
 535          }
 536      };
 537  
 538      @Override
 539      public void onTagsChanged(String tagString) {
 540          if (mNote == null || !isAdded()) return;
 541  
 542          if (mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length()) {
 543              mTracker.send(
 544                      new HitBuilders.EventBuilder()
 545                              .setCategory(&quot;note&quot;)
 546                              .setAction(&quot;added_tag&quot;)
 547                              .setLabel(&quot;tag_added_to_note&quot;)
 548                              .build()
 549              );
 550          }
 551          else {
 552              mTracker.send(
 553                      new HitBuilders.EventBuilder()
 554                              .setCategory(&quot;note&quot;)
 555                              .setAction(&quot;removed_tag&quot;)
 556                              .setLabel(&quot;tag_removed_from_note&quot;)
 557                              .build()
 558              );
 559          }
 560  
 561          mNote.setTagString(tagString);
 562          mNote.setModificationDate(Calendar.getInstance());
 563          updateTagList();
 564          mNote.save();
 565      }
 566  
 567      @Override
 568      public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 569          // Unused
 570      }
 571  
 572      @Override
 573      public void afterTextChanged(Editable editable) {
 574          setTitleSpan(editable);
 575          attemptAutoList(editable);
 576      }
 577  
 578      @Override
 579      public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 580  
 581          // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 582          if (mAutoSaveHandler != null) {
 583              mAutoSaveHandler.removeCallbacks(mAutoSaveRunnable);
 584              mAutoSaveHandler.postDelayed(mAutoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 585          }
 586  
 587          // Remove search highlight spans when note content changes
 588          if (mMatchOffsets != null) {
 589              mMatchOffsets = null;
 590              mHighlighter.removeMatches();
 591          }
 592      }
 593  
 594      private void setTitleSpan(Editable editable) {
 595          // Set the note title to be a larger size
 596          // Remove any existing size spans
 597          RelativeSizeSpan spans[] = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 598          for (RelativeSizeSpan span : spans) {
 599              editable.removeSpan(span);
 600          }
 601          int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 602          if (newLinePosition == 0)
 603              return;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 604 -        editable.setSpan(new RelativeSizeSpan(1.222f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 604 -        editable.setSpan(new RelativeSizeSpan(1.222f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.lengtðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 605 +        editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 605 +        editable.setSpan(new RelativeSizeSpan(1.227f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.lengtðŸ”µ</abbr></span>
 606      }
 607  
 608      private void attemptAutoList(Editable editable) {
 609          int oldCursorPosition = mCurrentCursorPosition;
 610          mCurrentCursorPosition = mContentEditText.getSelectionStart();
 611          AutoBullet.apply(editable, oldCursorPosition, mCurrentCursorPosition);
 612          mCurrentCursorPosition = mContentEditText.getSelectionStart();
 613          android.util.Log.d(&quot;Simplenote&quot;, &quot;==&gt; post cursor position:&quot; + mCurrentCursorPosition);
 614      }
 615  
 616      private void saveAndSyncNote() {
 617          if (mNote == null)
 618              return;
 619  
 620          new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 621      }
 622  
 623      public void setPlaceholderVisible(boolean isVisible) {
 624          if (isVisible) {
 625              mNote = null;
 626              mContentEditText.setText(&quot;&quot;);
 627              mTagView.setText(&quot;&quot;);
 628              if (mPlaceholderView != null)
 629                  mPlaceholderView.setVisibility(View.VISIBLE);
 630          } else {
 631              if (mPlaceholderView != null)
 632                  mPlaceholderView.setVisibility(View.GONE);
 633          }
 634      }
 635  
 636      public void setIsNewNote(boolean isNewNote) {
 637          this.mIsNewNote = isNewNote;
 638      }
 639  
 640      @Override
 641      public void onFocusChange(View v, boolean hasFocus) {
 642          if (!hasFocus) {
 643              String tagString = getNoteTagsString().trim();
 644              if (tagString.length() &gt; 0) {
 645                  mTagView.setChips(tagString);
 646              }
 647          }
 648      }
 649  
 650      public Note getNote() {
 651          return mNote;
 652      }
 653  
 654      public String getNoteContentString() {
 655          if (mContentEditText == null || mContentEditText.getText() == null) {
 656              return &quot;&quot;;
 657          } else {
 658              return mContentEditText.getText().toString();
 659          }
 660      }
 661  
 662      public String getNoteTagsString() {
 663          if (mTagView == null || mTagView.getText() == null) {
 664              return &quot;&quot;;
 665          } else {
 666              return mTagView.getText().toString();
 667          }
 668      }
 669  
 670      private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 671  
 672          @Override
 673          protected void onPreExecute() {
 674              mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 675              mIsLoadingNote = true;
 676          }
 677  
 678          @Override
 679          protected Void doInBackground(String... args) {
 680              if (getActivity() == null) {
 681                  return null;
 682              }
 683  
 684              String noteID = args[0];
 685              Simplenote application = (Simplenote) getActivity().getApplication();
 686              Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 687              try {
 688                  mNote = notesBucket.get(noteID);
 689                  // Set the current note in NotesActivity when on a tablet
 690                  if (getActivity() instanceof NotesActivity) {
 691                      ((NotesActivity) getActivity()).setCurrentNote(mNote);
 692                  }
 693              } catch (BucketObjectMissingException e) {
 694                  // TODO: Handle a missing note
 695              }
 696              return null;
 697          }
 698  
 699          @Override
 700          protected void onPostExecute(Void nada) {
 701              if (getActivity() == null || getActivity().isFinishing())
 702                  return;
 703              refreshContent(false);
 704              if (mMatchOffsets != null) {
<abbr title=" 705                  int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);"> 705                  int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROðŸ”µ</abbr>
 706                  mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
 707              }
 708              mContentEditText.addTextChangedListener(NoteEditorFragment.this);
 709              if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 710                  // Show soft keyboard
 711                  mContentEditText.requestFocus();
 712                  new Handler().postDelayed(new Runnable() {
 713                      @Override
 714                      public void run() {
<abbr title=" 715                          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 715                          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemServicðŸ”µ</abbr>
 716                          if (inputMethodManager != null)
 717                              inputMethodManager.showSoftInput(mContentEditText, 0);
 718                      }
 719                  }, 100);
 720  
 721              }
 722  
 723              SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 724  
 725              mIsLoadingNote = false;
 726          }
 727      }
 728  
 729      private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
 730  
 731          @Override
 732          protected Void doInBackground(Void... args) {
 733              saveNote();
 734              return null;
 735          }
 736  
 737          @Override
 738          protected void onPostExecute(Void nada) {
 739              if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {
 740                  // Update links
 741                  SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 742              }
 743          }
 744      }
 745  
 746      private void saveNote() {
 747          if (mNote == null) {
 748              return;
 749          }
 750  
 751          String content = getNoteContentString();
 752          String tagString = getNoteTagsString();
 753          if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 754              mNote.setContent(content);
 755              mNote.setTagString(tagString);
 756              mNote.setModificationDate(Calendar.getInstance());
 757              // Send pinned event to google analytics if changed
 758              mNote.setPinned(mPinButton.isChecked());
 759              mNote.save();
 760              if (getActivity() != null) {
 761                  if (mNote.isPinned() != mPinButton.isChecked()) {
 762                      mTracker.send(
 763                              new HitBuilders.EventBuilder()
 764                                      .setCategory(&quot;note&quot;)
 765                                      .setAction((mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;)
 766                                      .setLabel(&quot;pin_button&quot;)
 767                                      .build()
 768                      );
 769                  }
 770  
 771                  mTracker.send(
 772                          new HitBuilders.EventBuilder()
 773                                  .setCategory(&quot;note&quot;)
 774                                  .setAction(&quot;edited_note&quot;)
 775                                  .setLabel(&quot;editor_save&quot;)
 776                                  .build()
 777                  );
 778              }
 779          }
 780      }
 781  
 782      // Contextual action bar for dealing with links
 783      private ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
 784  
 785          // Called when the action mode is created; startActionMode() was called
 786          @Override
 787          public boolean onCreateActionMode(ActionMode mode, Menu menu) {
 788              // Inflate a menu resource providing context menu items
 789              MenuInflater inflater = mode.getMenuInflater();
 790              if (inflater != null){
 791                  inflater.inflate(R.menu.view_link, menu);
 792                  mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
 793                  mode.setTitle(getString(R.string.link));
 794                  if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
 795                      mode.setTitleOptionalHint(false);
 796                  }
 797              }
 798              return true;
 799          }
 800  
 801          // Called each time the action mode is shown. Always called after onCreateActionMode, but
 802          // may be called multiple times if the mode is invalidated.
 803          @Override
 804          public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 805              return false; // Return false if nothing is done
 806          }
 807  
 808          // Called when the user selects a contextual menu item
 809          @Override
 810          public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 811              switch (item.getItemId()) {
 812                  case R.id.menu_view_link:
 813                      if (mLinkUrl != null) {
 814                          try {
 815                              Uri uri = Uri.parse(mLinkUrl);
 816                              Intent i = new Intent(Intent.ACTION_VIEW);
 817                              i.setData(uri);
 818                              startActivity(i);
 819                          } catch (Exception e) {
 820                              e.printStackTrace();
 821                          }
 822                          mode.finish(); // Action picked, so close the CAB
 823                      }
 824                      return true;
 825                  case R.id.menu_copy:
 826                      if (mLinkText != null &amp;&amp; getActivity() != null) {
<abbr title=" 827                          ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 827                          ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPðŸ”µ</abbr>
 828                          ClipData clip = ClipData.newPlainText(getString(R.string.app_name),mLinkText);
 829                          clipboard.setPrimaryClip(clip);
 830                          Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();
 831                          mode.finish();
 832                      }
 833                      return true;
 834                  case R.id.menu_share:
 835                      if (mLinkText != null) {
 836                          try {
 837                              Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 838                              shareIntent.setType(&quot;text/plain&quot;);
 839                              shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mLinkText);
<abbr title=" 840                              startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 840                              startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.sharðŸ”µ</abbr>
 841                          } catch (Exception e) {
 842                              e.printStackTrace();
 843                          }
 844                          mode.finish();
 845                      }
 846                      return true;
 847                  default:
 848                      return false;
 849              }
 850          }
 851  
 852          // Called when the user exits the action mode
 853          @Override
 854          public void onDestroyActionMode(ActionMode mode) {
 855              mActionMode = null;
 856          }
 857      };
 858  
 859      // Checks if cursor is at a URL when the selection changes
 860      // If it is a URL, show the contextual action bar
 861      @Override
 862      public void onSelectionChanged(int selStart, int selEnd) {
 863          if (selStart == selEnd) {
 864              Editable noteContent = mContentEditText.getText();
 865              if (noteContent == null)
 866                  return;
 867  
 868              URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
 869              if (urlSpans.length &gt; 0) {
 870                  URLSpan urlSpan = urlSpans[0];
 871                  mLinkUrl = urlSpan.getURL();
<abbr title=" 872                  mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();"> 872                  mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSðŸ”µ</abbr>
 873                  if (mActionMode != null) {
 874                      mActionMode.setSubtitle(mLinkText);
 875                      setLinkMenuItem();
 876                      return;
 877                  }
 878  
 879                  // Show the Contextual Action Bar
 880                  if (getActivity() != null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 881 -                    mActionMode = getActivity().startActionMode(mActionModeCallback);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 882 +                    mActionMode = ((NoteEditorActivity)getActivity()).startSupportActionMode(mActionModeCallback);</span>
 883                      if (mActionMode != null) {
 884                          mActionMode.setSubtitle(mLinkText);
 885                      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 886 +</span>
 887                      setLinkMenuItem();
 888                  }
 889              } else if (mActionMode != null) {
 890                  mActionMode.finish();
 891                  mActionMode = null;
 892              }
 893          } else if (mActionMode != null) {
 894              mActionMode.finish();
 895              mActionMode = null;
 896          }
 897      }
 898  
 899      private void setLinkMenuItem() {
 900          if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
 901              if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
 902                  mViewLinkMenuItem.setIcon(mCallIconResId);
 903                  mViewLinkMenuItem.setTitle(getString(R.string.call));
 904              } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
 905                  mViewLinkMenuItem.setIcon(mEmailIconResId);
 906                  mViewLinkMenuItem.setTitle(getString(R.string.email));
 907              } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
 908                  mViewLinkMenuItem.setIcon(mMapIconResId);
 909                  mViewLinkMenuItem.setTitle(getString(R.string.view_map));
 910              } else {
 911                  mViewLinkMenuItem.setIcon(mWebIconResId);
 912                  mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
 913              }
 914          }
 915      }
 916  
 917      // Resets note publish status if Simperium never returned the new publish status
 918      private Runnable mPublishTimeoutRunnable = new Runnable() {
 919          @Override
 920          public void run() {
 921              if (!isAdded()) return;
 922  
 923              getActivity().runOnUiThread(new Runnable() {
 924                  @Override
 925                  public void run() {
 926                      Toast.makeText(
 927                              getActivity(),
 928                              mNote.isPublished() ? R.string.publish_error : R.string.unpublish_error,
 929                              Toast.LENGTH_SHORT
 930                      ).show();
 931  
 932                      mNote.setPublished(!mNote.isPublished());
 933                      mNote.save();
 934  
 935                      if (mInfoPopupWindow != null &amp;&amp; mInfoPopupWindow.isShowing()) {
<abbr title=" 936                          ViewSwitcher viewSwitcher = (ViewSwitcher)mInfoPopupWindow.getContentView().findViewById(R.id.publish_view_switcher);"> 936                          ViewSwitcher viewSwitcher = (ViewSwitcher)mInfoPopupWindow.getContentView().findViewById(RðŸ”µ</abbr>
 937                          if (viewSwitcher.getDisplayedChild() == 1) {
 938                              viewSwitcher.showPrevious();
 939                          }
 940                      }
 941                  }
 942              });
 943  
 944          }
 945      };
 946  
 947      private void updateWordCount(TextView textView) {
 948          String content = getNoteContentString();
 949  
 950          if (content == null || textView == null) return;
 951  
 952          int numWords = (content.trim().length() == 0) ? 0 : content.trim().split(&quot;([\\W]+)&quot;).length;
 953  
 954          String wordCountString = getResources().getQuantityString(R.plurals.word_count, numWords);
 955          String formattedWordCount = NumberFormat.getInstance().format(numWords);
 956  
 957          textView.setText(formattedWordCount + &quot; &quot; + wordCountString);
 958      }
 959  
 960      /**
 961       * Simperium listeners
 962       */
 963  
 964      @Override
 965      public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 966  
 967      }
 968  
 969      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 970 -    public void onChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 971 +    public void onNetworkChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {</span>
 972          if (changeType == Bucket.ChangeType.MODIFY) {
 973              if (getNote() != null &amp;&amp; getNote().getSimperiumKey().equals(key)) {
 974                  try {
 975                      final Note updatedNote = mNotesBucket.get(key);
 976                      if (getActivity() != null) {
 977                          getActivity().runOnUiThread(new Runnable() {
 978                              @Override
 979                              public void run() {
 980                                  if (mPublishTimeoutHandler != null) {
 981                                      mPublishTimeoutHandler.removeCallbacks(mPublishTimeoutRunnable);
 982                                  }
 983  
 984                                  updateNote(updatedNote);
 985                                  updateInfoPopup();
 986                              }
 987                          });
 988                      }
 989                  } catch (BucketObjectMissingException e) {
 990                      e.printStackTrace();
 991                  }
 992              }
 993          }
 994      }
 995  
 996  
 997      @Override
 998      public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 999          // noop
1000      }
1001  
1002      @Override
1003      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1004          // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
1005          if (mIsLoadingNote)
1006              return;
1007  
1008          Note openNote = getNote();
1009          if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
1010              return;
1011  
1012          note.setContent(getNoteContentString());
1013      }
1014  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            