<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>436</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    436
                    <a href="435.html">prev</a>
                    <a href="437.html">next</a>
                    <a href="436_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_5553ee5c6410a412ab4ed61d9499805adee8995a_mongo/mongo-side/mongo-async-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAsyncReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;5553ee5c6410a412ab4ed61d9499805adee8995a:mongo/mongo-side/mongo-async-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAsyncReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;5553ee5c6410a412ab4ed61d9499805adee8995a^1:mongo/mongo-side/mongo-async-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAsyncReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;5553ee5c6410a412ab4ed61d9499805adee8995a^2:mongo/mongo-side/mongo-async-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAsyncReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e0a10435dcb243a911c0405daebc6aa667d5119d:mongo/mongo-side/mongo-async-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAsyncReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [bj]], subset: [[b], [bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.side.mongo;
  21 
  22 import com.dtstack.flink.sql.enums.ECacheContentType;
  23 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  24 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  25 import com.dtstack.flink.sql.side.FieldInfo;
  26 import com.dtstack.flink.sql.side.JoinInfo;
  27 import com.dtstack.flink.sql.side.cache.CacheObj;
  28 import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;
  29 import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;
  30 import com.dtstack.flink.sql.util.RowDataComplete;
  31 import com.google.common.collect.Lists;
  32 import com.mongodb.BasicDBObject;
  33 import com.mongodb.Block;
  34 import com.mongodb.ConnectionString;
  35 import com.mongodb.MongoClientSettings;
  36 import com.mongodb.async.SingleResultCallback;
  37 import com.mongodb.async.client.MongoClient;
  38 import com.mongodb.async.client.MongoClients;
  39 import com.mongodb.async.client.MongoCollection;
  40 import com.mongodb.async.client.MongoDatabase;
  41 import org.apache.commons.lang3.StringUtils;
  42 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  43 import org.apache.flink.configuration.Configuration;
  44 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  45 import org.apache.flink.table.dataformat.BaseRow;
  46 import org.apache.flink.types.Row;
  47 import org.bson.Document;
  48 import org.slf4j.Logger;
  49 import org.slf4j.LoggerFactory;
  50 
  51 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52 import java.util.Collections;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53 import java.util.List;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54 import java.util.Map;</span>
  55 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 import java.sql.Timestamp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 import java.util.Collection;</span>
  59 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60 import java.sql.Timestamp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61 import java.util.*;</span>
  62 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  63 import java.util.concurrent.atomic.AtomicInteger;
  64 
  65 /**
  66  * Reason:
  67  * Date: 2018/11/6
  68  *
  69  * @author xuqianjin
  70  */
  71 public class MongoAsyncReqRow extends BaseAsyncReqRow {
  72 
  73     private static final long serialVersionUID = -1183158242862673706L;
  74 
  75     private static final TimeZone LOCAL_TZ = TimeZone.getDefault();
  76 
  77     private static final Logger LOG = LoggerFactory.getLogger(MongoAsyncReqRow.class);
  78 
  79     private transient MongoClient mongoClient;
  80 
  81     private MongoDatabase db;
  82 
  83     private MongoSideTableInfo mongoSideTableInfo;
  84 
<abbr title="  85     public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  85     public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,üîµ</abbr>
  86         super(new MongoAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  87     }
  88 
  89     @Override
  90     public void open(Configuration parameters) throws Exception {
  91         super.open(parameters);
  92         mongoSideTableInfo = (MongoSideTableInfo) sideInfo.getSideTableInfo();
  93         connMongoDb();
  94     }
  95 
  96     public void connMongoDb() throws Exception {
<abbr title="  97         ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAddress(),">  97         ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAüîµ</abbr>
  98                 mongoSideTableInfo.getUserName(), mongoSideTableInfo.getPassword()));
  99         MongoClientSettings settings = MongoClientSettings.builder()
 100                 .applyConnectionString(connectionString)
 101                 .build();
 102         mongoClient = MongoClients.create(settings);
 103         db = mongoClient.getDatabase(mongoSideTableInfo.getDatabase());
 104     }
 105 
 106     @Override
<abbr title=" 107     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resultFuture) throws Exception {"> 107     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resulüîµ</abbr>
 108         Row inputCopy = Row.copy(input);
 109         BasicDBObject basicDbObject = new BasicDBObject();
 110         try {
 111             basicDbObject.putAll(inputParams);
 112             // Â°´ÂÖÖË∞ìËØç
 113             sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {
 114                 BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
 115                 if (null != filterCondition) {
 116                     basicDbObject.append(info.getFieldName(), filterCondition);
 117                 }
 118                 return info;
 119             }).count();
 120         } catch (Exception e) {
 121             LOG.info(&quot;add predicate infoes error &quot;, e);
 122         }
 123 
 124         String key = buildCacheKey(inputParams);
 125 
 126         AtomicInteger atomicInteger = new AtomicInteger(0);
<abbr title=" 127         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.class);"> 127         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.classüîµ</abbr>
 128         List&lt;Document&gt; cacheContent = Lists.newArrayList();
 129         Block&lt;Document&gt; printDocumentBlock = new Block&lt;Document&gt;() {
 130             @Override
 131             public void apply(final Document document) {
 132                 atomicInteger.incrementAndGet();
 133                 Row row = fillData(inputCopy, document);
 134                 if (openCache()) {
 135                     cacheContent.add(document);
 136                 }
 137                 RowDataComplete.completeRow(resultFuture, row);
 138             }
 139         };
 140         SingleResultCallback&lt;Void&gt; callbackWhenFinished = new SingleResultCallback&lt;Void&gt;() {
 141             @Override
 142             public void onResult(final Void result, final Throwable t) {
 143                 if (atomicInteger.get() &lt;= 0) {
 144                     LOG.warn(&quot;Cannot retrieve the data from the database&quot;);
 145                     resultFuture.complete(Collections.EMPTY_LIST);
 146                 } else {
 147                     if (openCache()) {
 148                         putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 149                     }
 150                 }
 151             }
 152         };
 153         dbCollection.find(basicDbObject).forEach(printDocumentBlock, callbackWhenFinished);
 154     }
 155 
 156     @Override
 157     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 158         StringBuilder sb = new StringBuilder();
 159         for (Object ele : inputParams.values()) {
 160             sb.append(ele.toString())
 161                     .append(&quot;_&quot;);
 162         }
 163 
 164         return sb.toString();
 165     }
 166 
 167     @Override
 168     public Row fillData(Row input, Object line) {
 169         Document doc = (Document) line;
 170         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 171         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 172             Object obj = input.getField(entry.getValue());
 173 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
 175 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176         Row row = new Row(sideInfo.getOutFieldInfoList().size());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             Object obj = input.getField(entry.getValue());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 179             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 179             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoüîµ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182                 obj = ((Timestamp) obj).getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185             row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186         }</span>
 187 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 188             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 188             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoüîµ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191                 obj = ((Timestamp) obj).getTime();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192                 //ÂéªÈô§‰∏ä‰∏ÄÂ±ÇOutputRowtimeProcessFunction Ë∞ÉÁî®Êó∂Âå∫ÂØºËá¥ÁöÑÂΩ±Âìç</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 193                 obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime());"> 193                 obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime())üîµ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195 </span>
 196 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 197             row.setField(entry.getKey(), obj);
 198         }
 199 
 200         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 201             if (doc == null) {
 202                 row.setField(entry.getKey(), null);
 203             } else {
<abbr title=" 204                 row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())));"> 204                 row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())üîµ</abbr>
 205             }
 206         }
 207 
 208         return row;
 209     }
 210 
 211     @Override
 212     public void close() throws Exception {
 213         super.close();
 214         try {
 215             if (mongoClient != null) {
 216                 mongoClient.close();
 217             }
 218         } catch (Exception e) {
 219             throw new RuntimeException(&quot;[closeMongoDB]:&quot; + e.getMessage());
 220         }
 221     }
 222 
 223     private String getConnectionUrl(String address, String userName, String password){
 224         if(address.startsWith(&quot;mongodb://&quot;) || address.startsWith(&quot;mongodb+srv://&quot;)){
 225             return  address;
 226         }
 227         if (StringUtils.isNotBlank(userName) &amp;&amp; StringUtils.isNotBlank(password)) {
 228             return String.format(&quot;mongodb://%s:%s@%s&quot;, userName, password, address);
 229         }
 230         return String.format(&quot;mongodb://%s&quot;, address);
 231     }
 232 
 233 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.side.mongo;
  21 import org.apache.commons.lang3.StringUtils;
  22 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  23 import org.apache.flink.configuration.Configuration;
  24 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  25 import org.apache.flink.table.dataformat.BaseRow;
  26 import org.apache.flink.types.Row;
  27 
  28 import com.dtstack.flink.sql.enums.ECacheContentType;
  29 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  30 import com.dtstack.flink.sql.side.FieldInfo;
  31 import com.dtstack.flink.sql.side.JoinInfo;
  32 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  33 import com.dtstack.flink.sql.side.cache.CacheObj;
  34 import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;
  35 import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;
  36 import com.dtstack.flink.sql.util.RowDataComplete;
  37 import com.google.common.collect.Lists;
  38 import com.mongodb.BasicDBObject;
  39 import com.mongodb.Block;
  40 import com.mongodb.ConnectionString;
  41 import com.mongodb.async.SingleResultCallback;
  42 import com.mongodb.async.client.MongoClient;
  43 import com.mongodb.MongoClientSettings;
  44 import com.mongodb.async.client.MongoClients;
  45 import com.mongodb.async.client.MongoCollection;
  46 import com.mongodb.async.client.MongoDatabase;
  47 import org.bson.Document;
  48 import org.slf4j.Logger;
  49 import org.slf4j.LoggerFactory;
  50 import java.util.*;
  51 import java.util.concurrent.atomic.AtomicInteger;
  52 
  53 /**
  54  * Reason:
  55  * Date: 2018/11/6
  56  *
  57  * @author xuqianjin
  58  */
  59 public class MongoAsyncReqRow extends BaseAsyncReqRow {
  60 
  61     private static final long serialVersionUID = -1183158242862673706L;
  62 
  63     private static final TimeZone LOCAL_TZ = TimeZone.getDefault();
  64 
  65     private static final Logger LOG = LoggerFactory.getLogger(MongoAsyncReqRow.class);
  66 
  67     private transient MongoClient mongoClient;
  68 
  69     private MongoDatabase db;
  70 
  71     private MongoSideTableInfo mongoSideTableInfo;
  72 
<abbr title="  73     public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  73     public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,üîµ</abbr>
  74         super(new MongoAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  75     }
  76 
  77     @Override
  78     public void open(Configuration parameters) throws Exception {
  79         super.open(parameters);
  80         mongoSideTableInfo = (MongoSideTableInfo) sideInfo.getSideTableInfo();
  81         connMongoDb();
  82     }
  83 
  84     public void connMongoDb() throws Exception {
<abbr title="  85         ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAddress(),">  85         ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAüîµ</abbr>
  86                 mongoSideTableInfo.getUserName(), mongoSideTableInfo.getPassword()));
  87         MongoClientSettings settings = MongoClientSettings.builder()
  88                 .applyConnectionString(connectionString)
  89                 .build();
  90         mongoClient = MongoClients.create(settings);
  91         db = mongoClient.getDatabase(mongoSideTableInfo.getDatabase());
  92     }
  93 
  94     @Override
<abbr title="  95     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resultFuture) throws Exception {">  95     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resulüîµ</abbr>
  96         Row inputCopy = Row.copy(input);
  97         BasicDBObject basicDbObject = new BasicDBObject();
  98         try {
  99             basicDbObject.putAll(inputParams);
 100             // Â°´ÂÖÖË∞ìËØç
 101             sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {
 102                 BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
 103                 if (null != filterCondition) {
 104                     basicDbObject.append(info.getFieldName(), filterCondition);
 105                 }
 106                 return info;
 107             }).count();
 108         } catch (Exception e) {
 109             LOG.info(&quot;add predicate infoes error &quot;, e);
 110         }
 111 
 112         String key = buildCacheKey(inputParams);
 113 
 114         AtomicInteger atomicInteger = new AtomicInteger(0);
<abbr title=" 115         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.class);"> 115         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.classüîµ</abbr>
 116         List&lt;Document&gt; cacheContent = Lists.newArrayList();
 117         Block&lt;Document&gt; printDocumentBlock = new Block&lt;Document&gt;() {
 118             @Override
 119             public void apply(final Document document) {
 120                 atomicInteger.incrementAndGet();
 121                 Row row = fillData(inputCopy, document);
 122                 if (openCache()) {
 123                     cacheContent.add(document);
 124                 }
 125                 RowDataComplete.completeRow(resultFuture, row);
 126             }
 127         };
 128         SingleResultCallback&lt;Void&gt; callbackWhenFinished = new SingleResultCallback&lt;Void&gt;() {
 129             @Override
 130             public void onResult(final Void result, final Throwable t) {
 131                 if (atomicInteger.get() &lt;= 0) {
 132                     LOG.warn(&quot;Cannot retrieve the data from the database&quot;);
 133                     resultFuture.complete(Collections.EMPTY_LIST);
 134                 } else {
 135                     if (openCache()) {
 136                         putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 137                     }
 138                 }
 139             }
 140         };
 141         dbCollection.find(basicDbObject).forEach(printDocumentBlock, callbackWhenFinished);
 142     }
 143 
 144     @Override
 145     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 146         StringBuilder sb = new StringBuilder();
 147         for (Object ele : inputParams.values()) {
 148             sb.append(ele.toString())
 149                     .append(&quot;_&quot;);
 150         }
 151 
 152         return sb.toString();
 153     }
 154 
 155     @Override
 156     public Row fillData(Row input, Object line) {
 157         Document doc = (Document) line;
 158         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 159         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 160             Object obj = input.getField(entry.getValue());
 161 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
 163 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 164             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 164             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoüîµ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167                 obj = ((Timestamp) obj).getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170             row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         }</span>
 172 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 173             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 173             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoüîµ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176                 obj = ((Timestamp) obj).getTime();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177                 //ÂéªÈô§‰∏ä‰∏ÄÂ±ÇOutputRowtimeProcessFunction Ë∞ÉÁî®Êó∂Âå∫ÂØºËá¥ÁöÑÂΩ±Âìç</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 178                 obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime());"> 178                 obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime())üîµ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180 </span>
 181 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 182             row.setField(entry.getKey(), obj);
 183         }
 184 
 185         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 186             if (doc == null) {
 187                 row.setField(entry.getKey(), null);
 188             } else {
<abbr title=" 189                 row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())));"> 189                 row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())üîµ</abbr>
 190             }
 191         }
 192 
 193         return row;
 194     }
 195 
 196     @Override
 197     public void close() throws Exception {
 198         super.close();
 199         try {
 200             if (mongoClient != null) {
 201                 mongoClient.close();
 202             }
 203         } catch (Exception e) {
 204             throw new RuntimeException(&quot;[closeMongoDB]:&quot; + e.getMessage());
 205         }
 206     }
 207 
 208     private String getConnectionUrl(String address, String userName, String password){
 209         if(address.startsWith(&quot;mongodb://&quot;) || address.startsWith(&quot;mongodb+srv://&quot;)){
 210             return  address;
 211         }
 212         if (StringUtils.isNotBlank(userName) &amp;&amp; StringUtils.isNotBlank(password)) {
 213             return String.format(&quot;mongodb://%s:%s@%s&quot;, userName, password, address);
 214         }
 215         return String.format(&quot;mongodb://%s&quot;, address);
 216     }
 217 
 218 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.mongo;
  19 
  20 import com.dtstack.flink.sql.enums.ECacheContentType;
  21 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  23 import com.dtstack.flink.sql.side.FieldInfo;
  24 import com.dtstack.flink.sql.side.JoinInfo;
  25 import com.dtstack.flink.sql.side.cache.CacheObj;
  26 import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;
  27 import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;
  28 import com.dtstack.flink.sql.util.RowDataComplete;
  29 import com.google.common.collect.Lists;
  30 import com.mongodb.BasicDBObject;
  31 import com.mongodb.Block;
  32 import com.mongodb.ConnectionString;
  33 import com.mongodb.MongoClientSettings;
  34 import com.mongodb.async.SingleResultCallback;
  35 import com.mongodb.async.client.MongoClient;
  36 import com.mongodb.async.client.MongoClients;
  37 import com.mongodb.async.client.MongoCollection;
  38 import com.mongodb.async.client.MongoDatabase;
  39 import java.util.*;
  40 import java.util.concurrent.atomic.AtomicInteger;
  41 import org.apache.commons.lang3.StringUtils;
  42 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  43 import org.apache.flink.configuration.Configuration;
  44 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  45 import org.apache.flink.table.dataformat.BaseRow;
  46 import org.apache.flink.types.Row;
  47 import org.bson.Document;
  48 import org.slf4j.Logger;
  49 import org.slf4j.LoggerFactory;
  50 
  51 
  52 /**
  53  * Reason:
  54  * Date: 2018/11/6
  55  *
  56  * @author xuqianjin
  57  */
  58 public class MongoAsyncReqRow extends BaseAsyncReqRow {
  59     private static final long serialVersionUID = -1183158242862673706L;
  60 
  61     private static final TimeZone LOCAL_TZ = TimeZone.getDefault();
  62 
  63     private static final Logger LOG = LoggerFactory.getLogger(MongoAsyncReqRow.class);
  64 
  65     private transient MongoClient mongoClient;
  66 
  67     private MongoDatabase db;
  68 
  69     private MongoSideTableInfo mongoSideTableInfo;
  70 
<abbr title="  71     public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  71     public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,üîµ</abbr>
  72         super(new MongoAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  73     }
  74 
  75     @Override
  76     public void open(Configuration parameters) throws Exception {
  77         super.open(parameters);
  78         mongoSideTableInfo = ((MongoSideTableInfo) (sideInfo.getSideTableInfo()));
  79         connMongoDb();
  80     }
  81 
  82     public void connMongoDb() throws Exception {
<abbr title="  83         ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAddress(),">  83         ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAüîµ</abbr>
  84                 mongoSideTableInfo.getUserName(), mongoSideTableInfo.getPassword()));
  85         MongoClientSettings settings = MongoClientSettings.builder()
  86                 .applyConnectionString(connectionString)
  87                 .build();
  88         mongoClient = MongoClients.create(settings);
  89         db = mongoClient.getDatabase(mongoSideTableInfo.getDatabase());
  90     }
  91 
  92     @Override
<abbr title="  93     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resultFuture) throws Exception {">  93     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resulüîµ</abbr>
  94         Row inputCopy = Row.copy(input);
  95         BasicDBObject basicDbObject = new BasicDBObject();
  96         try {
  97             basicDbObject.putAll(inputParams);
  98             // Â°´ÂÖÖË∞ìËØç
  99             sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(( info) -&gt; {
 100                 BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
 101                 if (null != filterCondition) {
 102                     basicDbObject.append(info.getFieldName(), filterCondition);
 103                 }
 104                 return info;
 105             }).count();
 106         } catch (java.lang.Exception e) {
 107             LOG.info(&quot;add predicate infoes error &quot;, e);
 108         }
 109         String key = buildCacheKey(inputParams);
 110         AtomicInteger atomicInteger = new AtomicInteger(0);
<abbr title=" 111         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.class);"> 111         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.classüîµ</abbr>
 112         List&lt;Document&gt; cacheContent = Lists.newArrayList();
 113         Block&lt;Document&gt; printDocumentBlock = new Block&lt;Document&gt;() {
 114             @Override
 115             public void apply(final Document document) {
 116                 atomicInteger.incrementAndGet();
 117                 Row row = fillData(inputCopy, document);
 118                 if (openCache()) {
 119                     cacheContent.add(document);
 120                 }
 121                 RowDataComplete.completeRow(resultFuture, row);
 122             }
 123         };
 124         SingleResultCallback&lt;Void&gt; callbackWhenFinished = new SingleResultCallback&lt;Void&gt;() {
 125             @Override
 126             public void onResult(final Void result, final Throwable t) {
 127                 if (atomicInteger.get() &lt;= 0) {
 128                     LOG.warn(&quot;Cannot retrieve the data from the database&quot;);
 129                     resultFuture.complete(Collections.EMPTY_LIST);
 130                 } else if (openCache()) {
 131                     putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 132                 }
 133             }
 134         };
 135         dbCollection.find(basicDbObject).forEach(printDocumentBlock, callbackWhenFinished);
 136     }
 137 
 138     @Override
 139     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 140         StringBuilder sb = new StringBuilder();
 141         for (Object ele : inputParams.values()) {
 142             sb.append(ele.toString())
 143                     .append(&quot;_&quot;);
 144         }
 145 
 146         return sb.toString();
 147     }
 148 
 149     @Override
 150     public Row fillData(Row input, Object line) {
 151         Document doc = ((Document) (line));
 152         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 153         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 154             Object obj = input.getField(entry.getValue());
 155             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 156             row.setField(entry.getKey(), obj);
 157         }
 158         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 159             if (doc == null) {
 160                 row.setField(entry.getKey(), null);
 161             } else {
<abbr title=" 162                 row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())));"> 162                 row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())üîµ</abbr>
 163             }
 164         }
 165         return row;
 166     }
 167 
 168     @Override
 169     public void close() throws Exception {
 170         super.close();
 171         try {
 172             if (mongoClient != null) {
 173                 mongoClient.close();
 174             }
 175         } catch (Exception e) {
 176             throw new RuntimeException(&quot;[closeMongoDB]:&quot; + e.getMessage());
 177         }
 178     }
 179 
 180     private String getConnectionUrl(String address, String userName, String password){
 181         if(address.startsWith(&quot;mongodb://&quot;) || address.startsWith(&quot;mongodb+srv://&quot;)){
 182             return  address;
 183         }
 184         if (StringUtils.isNotBlank(userName) &amp;&amp; StringUtils.isNotBlank(password)) {
 185             return String.format(&quot;mongodb://%s:%s@%s&quot;, userName, password, address);
 186         }
 187         return String.format(&quot;mongodb://%s&quot;, address);
 188     }
 189 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql.side.mongo;
  21  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import com.dtstack.flink.sql.enums.ECacheContentType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.dtstack.flink.sql.side.AbstractSideTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.dtstack.flink.sql.side.BaseAsyncReqRow;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import com.dtstack.flink.sql.side.FieldInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import com.dtstack.flink.sql.side.JoinInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import com.dtstack.flink.sql.side.cache.CacheObj;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import com.dtstack.flink.sql.util.RowDataComplete;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import com.mongodb.BasicDBObject;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import com.mongodb.Block;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import com.mongodb.ConnectionString;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import com.mongodb.MongoClientSettings;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import com.mongodb.async.SingleResultCallback;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +import com.mongodb.async.client.MongoClient;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import com.mongodb.async.client.MongoClients;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +import com.mongodb.async.client.MongoCollection;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import com.mongodb.async.client.MongoDatabase;</span>
  41  import org.apache.commons.lang3.StringUtils;
  42  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  43  import org.apache.flink.configuration.Configuration;
  44  import org.apache.flink.streaming.api.functions.async.ResultFuture;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import org.apache.flink.table.dataformat.BaseRow;</span>
  48  import org.apache.flink.types.Row;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import com.dtstack.flink.sql.enums.ECacheContentType;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -import com.dtstack.flink.sql.side.BaseAsyncReqRow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import com.dtstack.flink.sql.side.FieldInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -import com.dtstack.flink.sql.side.JoinInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -import com.dtstack.flink.sql.side.AbstractSideTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -import com.dtstack.flink.sql.side.cache.CacheObj;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -import com.mongodb.BasicDBObject;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -import com.mongodb.Block;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -import com.mongodb.ConnectionString;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -import com.mongodb.async.SingleResultCallback;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -import com.mongodb.async.client.MongoClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -import com.mongodb.MongoClientSettings;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -import com.mongodb.async.client.MongoClients;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -import com.mongodb.async.client.MongoCollection;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -import com.mongodb.async.client.MongoDatabase;</span>
  68  import org.bson.Document;
  69  import org.slf4j.Logger;
  70  import org.slf4j.LoggerFactory;
  71  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -import java.sql.Timestamp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -import java.util.Collection;</span>
  74  import java.util.Collections;
  75  import java.util.List;
  76  import java.util.Map;

  77  import java.util.concurrent.atomic.AtomicInteger;
  78  
  79  /**
  80   * Reason:
  81   * Date: 2018/11/6
  82   *
  83   * @author xuqianjin
  84   */
  85  public class MongoAsyncReqRow extends BaseAsyncReqRow {

  86      private static final long serialVersionUID = -1183158242862673706L;


  87  
  88      private static final Logger LOG = LoggerFactory.getLogger(MongoAsyncReqRow.class);
  89  
  90      private transient MongoClient mongoClient;
  91  
  92      private MongoDatabase db;
  93  
  94      private MongoSideTableInfo mongoSideTableInfo;
  95  
<abbr title="  96      public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  96      public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, Abstractüîµ</abbr>
  97          super(new MongoAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  98      }
  99  
 100      @Override
 101      public void open(Configuration parameters) throws Exception {
 102          super.open(parameters);
 103          mongoSideTableInfo = (MongoSideTableInfo) sideInfo.getSideTableInfo();
 104          connMongoDb();
 105      }
 106  
 107      public void connMongoDb() throws Exception {
 108          ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAddress(),
 109                  mongoSideTableInfo.getUserName(), mongoSideTableInfo.getPassword()));
 110          MongoClientSettings settings = MongoClientSettings.builder()
 111                  .applyConnectionString(connectionString)
 112                  .build();
 113          mongoClient = MongoClients.create(settings);
 114          db = mongoClient.getDatabase(mongoSideTableInfo.getDatabase());
 115      }
 116  
 117      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 118 -    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 118 -    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) thüîµ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -        CRow inputCopy = new CRow(Row.copy(input.row()), input.change());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 120 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resultFuture) throws Exception {"> 120 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resultFuture) üîµ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +        Row inputCopy = Row.copy(input);</span>
 122          BasicDBObject basicDbObject = new BasicDBObject();
 123          try {
 124              basicDbObject.putAll(inputParams);
 125              // Â°´ÂÖÖË∞ìËØç
 126              sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {
 127                  BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
 128                  if (null != filterCondition) {
 129                      basicDbObject.append(info.getFieldName(), filterCondition);
 130                  }
 131                  return info;
 132              }).count();
 133          } catch (Exception e) {
 134              LOG.info(&quot;add predicate infoes error &quot;, e);
 135          }
 136  
 137          String key = buildCacheKey(inputParams);
 138  
 139          AtomicInteger atomicInteger = new AtomicInteger(0);
 140          MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.class);
 141          List&lt;Document&gt; cacheContent = Lists.newArrayList();
 142          Block&lt;Document&gt; printDocumentBlock = new Block&lt;Document&gt;() {
 143              @Override
 144              public void apply(final Document document) {
 145                  atomicInteger.incrementAndGet();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -                Row row = fillData(inputCopy.row(), document);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +                Row row = fillData(inputCopy, document);</span>
 148                  if (openCache()) {
 149                      cacheContent.add(document);
 150                  }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -                resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +                RowDataComplete.completeRow(resultFuture, row);</span>
 153              }
 154          };
 155          SingleResultCallback&lt;Void&gt; callbackWhenFinished = new SingleResultCallback&lt;Void&gt;() {
 156              @Override
 157              public void onResult(final Void result, final Throwable t) {
 158                  if (atomicInteger.get() &lt;= 0) {
 159                      LOG.warn(&quot;Cannot retrieve the data from the database&quot;);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -                    resultFuture.complete(null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                    resultFuture.complete(Collections.EMPTY_LIST);</span>
 162                  } else {
 163                      if (openCache()) {
 164                          putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 165                      }
 166                  }
 167              }
 168          };
 169          dbCollection.find(basicDbObject).forEach(printDocumentBlock, callbackWhenFinished);
 170      }
 171  
 172      @Override
 173      public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 174          StringBuilder sb = new StringBuilder();
 175          for (Object ele : inputParams.values()) {
 176              sb.append(ele.toString())
 177                      .append(&quot;_&quot;);
 178          }
 179  
 180          return sb.toString();
 181      }
 182  
 183      @Override
 184      public Row fillData(Row input, Object line) {
 185          Document doc = (Document) line;
 186          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 187          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 188              Object obj = input.getField(entry.getValue());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 189 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 189 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoüîµ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -            if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -                obj = ((Timestamp) obj).getTime();</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +            obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
 196              row.setField(entry.getKey(), obj);
 197          }
 198  
 199          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 200              if (doc == null) {
 201                  row.setField(entry.getKey(), null);
 202              } else {
 203                  row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())));
 204              }
 205          }
 206  
 207          return row;
 208      }
 209  
 210      @Override
 211      public void close() throws Exception {
 212          super.close();
 213          try {
 214              if (mongoClient != null) {
 215                  mongoClient.close();
 216              }
 217          } catch (Exception e) {
 218              throw new RuntimeException(&quot;[closeMongoDB]:&quot; + e.getMessage());
 219          }
 220      }
 221  
 222      private String getConnectionUrl(String address, String userName, String password){
 223          if(address.startsWith(&quot;mongodb://&quot;) || address.startsWith(&quot;mongodb+srv://&quot;)){
 224              return  address;
 225          }
 226          if (StringUtils.isNotBlank(userName) &amp;&amp; StringUtils.isNotBlank(password)) {
 227              return String.format(&quot;mongodb://%s:%s@%s&quot;, userName, password, address);
 228          }
 229          return String.format(&quot;mongodb://%s&quot;, address);
 230      }
 231  
 232  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql.side.mongo;
  21  



















  22  import org.apache.commons.lang3.StringUtils;
  23  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  24  import org.apache.flink.configuration.Configuration;
  25  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  26  import org.apache.flink.table.runtime.types.CRow;
  27  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;

  28  import org.apache.flink.types.Row;
  29  
  30  import com.dtstack.flink.sql.enums.ECacheContentType;
  31  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  32  import com.dtstack.flink.sql.side.FieldInfo;
  33  import com.dtstack.flink.sql.side.JoinInfo;
  34  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  35  import com.dtstack.flink.sql.side.cache.CacheObj;
  36  import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;
  37  import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;
  38  import com.google.common.collect.Lists;
  39  import com.mongodb.BasicDBObject;
  40  import com.mongodb.Block;
  41  import com.mongodb.ConnectionString;
  42  import com.mongodb.async.SingleResultCallback;
  43  import com.mongodb.async.client.MongoClient;
  44  import com.mongodb.MongoClientSettings;
  45  import com.mongodb.async.client.MongoClients;
  46  import com.mongodb.async.client.MongoCollection;
  47  import com.mongodb.async.client.MongoDatabase;
  48  import org.bson.Document;
  49  import org.slf4j.Logger;
  50  import org.slf4j.LoggerFactory;
  51  
  52  import java.sql.Timestamp;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -import java.util.Collection;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -import java.util.Collections;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -import java.util.Map;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +import java.util.*;</span>
  58  import java.util.concurrent.atomic.AtomicInteger;
  59  
  60  /**
  61   * Reason:
  62   * Date: 2018/11/6
  63   *
  64   * @author xuqianjin
  65   */
  66  public class MongoAsyncReqRow extends BaseAsyncReqRow {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +</span>
  68      private static final long serialVersionUID = -1183158242862673706L;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +    private static final TimeZone LOCAL_TZ = TimeZone.getDefault();</span>
  71  
  72      private static final Logger LOG = LoggerFactory.getLogger(MongoAsyncReqRow.class);
  73  
  74      private transient MongoClient mongoClient;
  75  
  76      private MongoDatabase db;
  77  
  78      private MongoSideTableInfo mongoSideTableInfo;
  79  
<abbr title="  80      public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  80      public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, Abstractüîµ</abbr>
  81          super(new MongoAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  82      }
  83  
  84      @Override
  85      public void open(Configuration parameters) throws Exception {
  86          super.open(parameters);
  87          mongoSideTableInfo = (MongoSideTableInfo) sideInfo.getSideTableInfo();
  88          connMongoDb();
  89      }
  90  
  91      public void connMongoDb() throws Exception {
  92          ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAddress(),
  93                  mongoSideTableInfo.getUserName(), mongoSideTableInfo.getPassword()));
  94          MongoClientSettings settings = MongoClientSettings.builder()
  95                  .applyConnectionString(connectionString)
  96                  .build();
  97          mongoClient = MongoClients.create(settings);
  98          db = mongoClient.getDatabase(mongoSideTableInfo.getDatabase());
  99      }
 100  
 101      @Override
<abbr title=" 102      public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 102      public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) thüîµ</abbr>
 103          CRow inputCopy = new CRow(Row.copy(input.row()), input.change());


 104          BasicDBObject basicDbObject = new BasicDBObject();
 105          try {
 106              basicDbObject.putAll(inputParams);
 107              // Â°´ÂÖÖË∞ìËØç
 108              sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {
 109                  BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
 110                  if (null != filterCondition) {
 111                      basicDbObject.append(info.getFieldName(), filterCondition);
 112                  }
 113                  return info;
 114              }).count();
 115          } catch (Exception e) {
 116              LOG.info(&quot;add predicate infoes error &quot;, e);
 117          }
 118  
 119          String key = buildCacheKey(inputParams);
 120  
 121          AtomicInteger atomicInteger = new AtomicInteger(0);
 122          MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.class);
 123          List&lt;Document&gt; cacheContent = Lists.newArrayList();
 124          Block&lt;Document&gt; printDocumentBlock = new Block&lt;Document&gt;() {
 125              @Override
 126              public void apply(final Document document) {
 127                  atomicInteger.incrementAndGet();
 128                  Row row = fillData(inputCopy.row(), document);

 129                  if (openCache()) {
 130                      cacheContent.add(document);
 131                  }
 132                  resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));

 133              }
 134          };
 135          SingleResultCallback&lt;Void&gt; callbackWhenFinished = new SingleResultCallback&lt;Void&gt;() {
 136              @Override
 137              public void onResult(final Void result, final Throwable t) {
 138                  if (atomicInteger.get() &lt;= 0) {
 139                      LOG.warn(&quot;Cannot retrieve the data from the database&quot;);
 140                      resultFuture.complete(null);

 141                  } else {
 142                      if (openCache()) {
 143                          putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 144                      }
 145                  }
 146              }
 147          };
 148          dbCollection.find(basicDbObject).forEach(printDocumentBlock, callbackWhenFinished);
 149      }
 150  
 151      @Override
 152      public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 153          StringBuilder sb = new StringBuilder();
 154          for (Object ele : inputParams.values()) {
 155              sb.append(ele.toString())
 156                      .append(&quot;_&quot;);
 157          }
 158  
 159          return sb.toString();
 160      }
 161  
 162      @Override
 163      public Row fillData(Row input, Object line) {
 164          Document doc = (Document) line;
 165          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 166          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 167              Object obj = input.getField(entry.getValue());
<abbr title=" 168              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 168              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoüîµ</abbr>
 169  
 170              if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 171                  obj = ((Timestamp) obj).getTime();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +                //ÂéªÈô§‰∏ä‰∏ÄÂ±ÇOutputRowtimeProcessFunction Ë∞ÉÁî®Êó∂Âå∫ÂØºËá¥ÁöÑÂΩ±Âìç</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +                obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime());</span>
 174              }
 175  

 176              row.setField(entry.getKey(), obj);
 177          }
 178  
 179          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 180              if (doc == null) {
 181                  row.setField(entry.getKey(), null);
 182              } else {
 183                  row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())));
 184              }
 185          }
 186  
 187          return row;
 188      }
 189  
 190      @Override
 191      public void close() throws Exception {
 192          super.close();
 193          try {
 194              if (mongoClient != null) {
 195                  mongoClient.close();
 196              }
 197          } catch (Exception e) {
 198              throw new RuntimeException(&quot;[closeMongoDB]:&quot; + e.getMessage());
 199          }
 200      }
 201  
 202      private String getConnectionUrl(String address, String userName, String password){
 203          if(address.startsWith(&quot;mongodb://&quot;) || address.startsWith(&quot;mongodb+srv://&quot;)){
 204              return  address;
 205          }
 206          if (StringUtils.isNotBlank(userName) &amp;&amp; StringUtils.isNotBlank(password)) {
 207              return String.format(&quot;mongodb://%s:%s@%s&quot;, userName, password, address);
 208          }
 209          return String.format(&quot;mongodb://%s&quot;, address);
 210      }
 211  
 212  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            