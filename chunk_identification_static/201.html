<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>201</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    201
                    <a href="200.html">prev</a>
                    <a href="202.html">next</a>
                    <a href="201_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_b2a9625a2da1de433a00f59e3aa0231c7d90f5c1_common/src/main/java/org/broadleafcommerce/common/security/service/ExploitProtectionServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;b2a9625a2da1de433a00f59e3aa0231c7d90f5c1:common/src/main/java/org/broadleafcommerce/common/security/service/ExploitProtectionServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;b2a9625a2da1de433a00f59e3aa0231c7d90f5c1^1:common/src/main/java/org/broadleafcommerce/common/security/service/ExploitProtectionServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;b2a9625a2da1de433a00f59e3aa0231c7d90f5c1^2:common/src/main/java/org/broadleafcommerce/common/security/service/ExploitProtectionServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;8813443c29cdb73b52b415dd74478662f71f6324:common/src/main/java/org/broadleafcommerce/common/security/service/ExploitProtectionServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [s]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.security.service;
  19 
  20 import org.apache.commons.lang.StringUtils;
  21 import org.apache.commons.logging.Log;
  22 import org.apache.commons.logging.LogFactory;
  23 import org.broadleafcommerce.common.exception.ServiceException;
  24 import org.broadleafcommerce.common.security.RandomGenerator;
  25 import org.broadleafcommerce.common.util.BLCRequestUtils;
  26 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  27 import org.owasp.validator.html.AntiSamy;
  28 import org.owasp.validator.html.CleanResults;
  29 import org.owasp.validator.html.Policy;
  30 import org.springframework.beans.factory.annotation.Value;
  31 import org.springframework.stereotype.Service;
  32 import org.springframework.web.context.request.RequestContextHolder;
  33 import org.springframework.web.context.request.ServletRequestAttributes;
  34 import org.springframework.web.context.request.ServletWebRequest;
  35 import org.springframework.web.util.HtmlUtils;
  36 
  37 import java.io.IOException;
  38 import java.net.URL;
  39 import java.net.URLConnection;
  40 import java.net.URLStreamHandler;
  41 import java.security.NoSuchAlgorithmException;
  42 import java.util.regex.Matcher;
  43 import java.util.regex.Pattern;
  44 
  45 import javax.servlet.http.HttpServletRequest;
  46 import javax.servlet.http.HttpSession;
  47 
  48 /**
  49  * @author jfischer
  50  */
  51 @Service(&quot;blExploitProtectionService&quot;)
  52 public class ExploitProtectionServiceImpl implements ExploitProtectionService {
  53 
  54     private static final String CSRFTOKEN = &quot;csrfToken&quot;;
  55     private static final String CSRFTOKENPARAMETER = &quot;csrfToken&quot;;
  56     private static final Log LOG = LogFactory.getLog(ExploitProtectionServiceImpl.class);
  57     private static final String JAVASCRIPT = &quot;javascript&quot;;
  58 
  59     private static class Handler extends URLStreamHandler {
  60         @Override
  61         protected URLConnection openConnection(URL u) throws IOException {
  62             URL resourceUrl = getClass().getClassLoader().getResource(u.getPath());
  63             return resourceUrl.openConnection();
  64         }
  65     }
  66 
  67     private static Policy getAntiSamyPolicy(String policyFileLocation) {
  68         try {
  69             URL url = new URL(null, policyFileLocation, new Handler());
  70             return Policy.getInstance(url);
  71         } catch (Exception e) {
  72             throw new RuntimeException(&quot;Unable to create URL&quot;, e);
  73         }
  74     }
  75 
  76     private static final String DEFAULTANTISAMYPOLICYFILELOCATION = &quot;classpath:antisamy-myspace.xml&quot;;
  77 
  78     protected String antiSamyPolicyFileLocation = DEFAULTANTISAMYPOLICYFILELOCATION;
  79     //this is thread safe
  80     private Policy antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);
  81     //this is thread safe for the usage of scan()
  82     private final AntiSamy as = new AntiSamy();
  83 
  84     @Value(&quot;${exploitProtection.xsrfEnabled:true}&quot;)
  85     protected boolean xsrfProtectionEnabled;
  86     
  87     @Value(&quot;${exploitProtection.xssEnabled:true}&quot;)
  88     protected boolean xssProtectionEnabled;
  89 
  90     private static final String HTML_PATTERN = &quot;&lt;(\&quot;[^\&quot;]*\&quot;|&#x27;[^&#x27;]*&#x27;|[^&#x27;\&quot;&gt;])*&gt;&quot;;
  91     private Pattern pattern = Pattern.compile(HTML_PATTERN);
  92 
  93 
  94     @Override
  95     public String cleanString(String string) throws ServiceException {
  96         if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {
  97             return string;
  98         }
  99         try {
 100             CleanResults results = as.scan(string, antiSamyPolicy);
 101             return results.getCleanHTML();
 102         } catch (Exception e) {
 103             LOG.error(&quot;Unable to clean the passed in entity values&quot;, e);
 104             throw new ServiceException(&quot;Unable to clean the passed in entity values&quot;, e);
 105         }
 106     }
 107 
 108     @Override
 109     public String cleanStringWithResults(String string) throws ServiceException {
 110         if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {
 111             return string;
 112         }
 113         try {
 114             CleanResults results = as.scan(string, antiSamyPolicy);
 115             if (results.getNumberOfErrors() &gt; 0) {
 116                 throw new CleanStringException(results);
 117             }else{
<abbr title=" 118                 //ok no errors, but what if it has regular string with javascript:xxx and it possibly can be used to construct anchor link"> 118                 //ok no errors, but what if it has regular string with javascript:xxx and it possibly canðŸ”µ</abbr>
 119 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120                 if (string.toLowerCase().startsWith(&quot;javascript&quot;)) {</span>
 121 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122                 // let&#x27;s maybe try wrap string into &lt;a href=&quot;string&quot;&gt;qqq&lt;/a&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123                 if(!hasHTMLTags(string)){</span>
 124 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125                 if (string.toLowerCase().startsWith(JAVASCRIPT)) {</span>
 126 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 127                     throw new CleanStringException(results);
 128                 }
 129             }
 130             return results.getCleanHTML();
 131         } catch (CleanStringException e) {
 132             throw e;
 133         } catch (Exception e) {
 134             StringBuilder sb = new StringBuilder();
 135             sb.append(&quot;Unable to clean the passed in entity values&quot;);
 136             sb.append(&quot;\nNote - &quot;);
 137             sb.append(getAntiSamyPolicyFileLocation());
<abbr title=" 138             sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.&quot;);"> 138             sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.ðŸ”µ</abbr>
 139             LOG.error(sb.toString(), e);
 140             throw new ServiceException(sb.toString(), e);
 141         }
 142     }
 143 
 144 
 145     protected boolean hasHTMLTags(String text){
 146         Matcher matcher = pattern.matcher(text);
 147         return matcher.find();
 148     }
 149 
 150     @Override
 151     public void compareToken(String passedToken) throws ServiceException {
 152         if (xsrfProtectionEnabled) {
 153             if (!getCSRFToken().equals(passedToken)) {
<abbr title=" 154                 throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expired.&quot;);"> 154                 throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expðŸ”µ</abbr>
 155             } else {
 156                 LOG.debug(&quot;Validated CSRF token&quot;);
 157             }
 158         }
 159     }
 160 
 161     @Override
 162     public String getCSRFToken() throws ServiceException {
<abbr title=" 163         //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated instance."> 163         //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated ðŸ”µ</abbr>
 164         HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 165         if (request == null) {
<abbr title=" 166             //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holder"> 166             //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holdðŸ”µ</abbr>
<abbr title=" 167             request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();"> 167             request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequestðŸ”µ</abbr>
 168         }
 169 
 170         if (BLCRequestUtils.isOKtoUseSession(new ServletWebRequest(request))) {
 171             HttpSession session = request.getSession();
 172             String token = (String) session.getAttribute(CSRFTOKEN);
 173             if (StringUtils.isEmpty(token)) {
 174                 try {
 175                     token = RandomGenerator.generateRandomId(&quot;SHA1PRNG&quot;, 32);
 176                 } catch (NoSuchAlgorithmException e) {
 177                     LOG.error(&quot;Unable to generate random number&quot;, e);
 178                     throw new ServiceException(&quot;Unable to generate random number&quot;, e);
 179                 }
 180                 session.setAttribute(CSRFTOKEN, token);
 181             }
 182             return token;
 183         }
 184         return null;
 185     }
 186 
 187     @Override
 188     public String getAntiSamyPolicyFileLocation() {
 189         return antiSamyPolicyFileLocation;
 190     }
 191 
 192     @Override
 193     public void setAntiSamyPolicyFileLocation(String antiSamyPolicyFileLocation) {
 194         this.antiSamyPolicyFileLocation = antiSamyPolicyFileLocation;
 195         antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);
 196     }
 197 
 198     @Override
 199     public String getCsrfTokenParameter() {
 200         return CSRFTOKENPARAMETER;
 201     }
 202 
 203     public void setXssProtectionEnabled(boolean xssProtectionEnabled) {
 204         this.xssProtectionEnabled = xssProtectionEnabled;
 205     }
 206 }
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.security.service;
  19 
  20 import org.apache.commons.lang.StringUtils;
  21 import org.apache.commons.logging.Log;
  22 import org.apache.commons.logging.LogFactory;
  23 import org.broadleafcommerce.common.exception.ServiceException;
  24 import org.broadleafcommerce.common.security.RandomGenerator;
  25 import org.broadleafcommerce.common.util.BLCRequestUtils;
  26 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  27 import org.owasp.validator.html.AntiSamy;
  28 import org.owasp.validator.html.CleanResults;
  29 import org.owasp.validator.html.Policy;
  30 import org.springframework.beans.factory.annotation.Value;
  31 import org.springframework.stereotype.Service;
  32 import org.springframework.web.context.request.RequestContextHolder;
  33 import org.springframework.web.context.request.ServletRequestAttributes;
  34 import org.springframework.web.context.request.ServletWebRequest;
  35 import org.springframework.web.util.HtmlUtils;
  36 
  37 import java.io.IOException;
  38 import java.net.URL;
  39 import java.net.URLConnection;
  40 import java.net.URLStreamHandler;
  41 import java.security.NoSuchAlgorithmException;
  42 import java.util.regex.Matcher;
  43 import java.util.regex.Pattern;
  44 
  45 import javax.servlet.http.HttpServletRequest;
  46 import javax.servlet.http.HttpSession;
  47 
  48 /**
  49  * @author jfischer
  50  */
  51 @Service(&quot;blExploitProtectionService&quot;)
  52 public class ExploitProtectionServiceImpl implements ExploitProtectionService {
  53 
  54     private static final String CSRFTOKEN = &quot;csrfToken&quot;;
  55     private static final String CSRFTOKENPARAMETER = &quot;csrfToken&quot;;
  56     private static final Log LOG = LogFactory.getLog(ExploitProtectionServiceImpl.class);
  57     private static final String JAVASCRIPT = &quot;javascript&quot;;
  58 
  59     private static class Handler extends URLStreamHandler {
  60         @Override
  61         protected URLConnection openConnection(URL u) throws IOException {
  62             URL resourceUrl = getClass().getClassLoader().getResource(u.getPath());
  63             return resourceUrl.openConnection();
  64         }
  65     }
  66 
  67     private static Policy getAntiSamyPolicy(String policyFileLocation) {
  68         try {
  69             URL url = new URL(null, policyFileLocation, new Handler());
  70             return Policy.getInstance(url);
  71         } catch (Exception e) {
  72             throw new RuntimeException(&quot;Unable to create URL&quot;, e);
  73         }
  74     }
  75 
  76     private static final String DEFAULTANTISAMYPOLICYFILELOCATION = &quot;classpath:antisamy-myspace.xml&quot;;
  77 
  78     protected String antiSamyPolicyFileLocation = DEFAULTANTISAMYPOLICYFILELOCATION;
  79     //this is thread safe
  80     private Policy antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);
  81     //this is thread safe for the usage of scan()
  82     private final AntiSamy as = new AntiSamy();
  83 
  84     @Value(&quot;${exploitProtection.xsrfEnabled:true}&quot;)
  85     protected boolean xsrfProtectionEnabled;
  86 
  87     @Value(&quot;${exploitProtection.xssEnabled:true}&quot;)
  88     protected boolean xssProtectionEnabled;
  89 
  90     private static final String HTML_PATTERN = &quot;&lt;(\&quot;[^\&quot;]*\&quot;|&#x27;[^&#x27;]*&#x27;|[^&#x27;\&quot;&gt;])*&gt;&quot;;
  91     private Pattern pattern = Pattern.compile(HTML_PATTERN);
  92 
  93 
  94     @Override
  95     public String cleanString(String string) throws ServiceException {
  96         if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {
  97             return string;
  98         }
  99         try {
 100             CleanResults results = as.scan(string, antiSamyPolicy);
 101             return results.getCleanHTML();
 102         } catch (Exception e) {
 103             LOG.error(&quot;Unable to clean the passed in entity values&quot;, e);
 104             throw new ServiceException(&quot;Unable to clean the passed in entity values&quot;, e);
 105         }
 106     }
 107 
 108     @Override
 109     public String cleanStringWithResults(String string) throws ServiceException {
 110         if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {
 111             return string;
 112         }
 113         try {
 114             CleanResults results = as.scan(string, antiSamyPolicy);
 115             if (results.getNumberOfErrors() &gt; 0) {
 116                 throw new CleanStringException(results);
 117             }else{
<abbr title=" 118                 //ok no errors, but what if it has regular string with javascript:xxx and it possibly can be used to construct anchor link"> 118                 //ok no errors, but what if it has regular string with javascript:xxx and it possibly canðŸ”µ</abbr>
 119 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120                 if (string.toLowerCase().startsWith(&quot;javascript&quot;)) {</span>
 121 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122                 // let&#x27;s maybe try wrap string into &lt;a href=&quot;string&quot;&gt;qqq&lt;/a&gt;</span>
 123 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124                 if (string.toLowerCase().startsWith(JAVASCRIPT)) {</span>
 125 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 126                         throw new CleanStringException(results);
 127                     }
 128                 }
 129             return results.getCleanHTML();
 130         } catch (CleanStringException e) {
 131             throw e;
 132         } catch (Exception e) {
 133             StringBuilder sb = new StringBuilder();
 134             sb.append(&quot;Unable to clean the passed in entity values&quot;);
 135             sb.append(&quot;\nNote - &quot;);
 136             sb.append(getAntiSamyPolicyFileLocation());
<abbr title=" 137             sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.&quot;);"> 137             sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.ðŸ”µ</abbr>
 138             LOG.error(sb.toString(), e);
 139             throw new ServiceException(sb.toString(), e);
 140         }
 141     }
 142 
 143 
 144     protected boolean hasHTMLTags(String text){
 145         Matcher matcher = pattern.matcher(text);
 146         return matcher.find();
 147     }
 148 
 149     @Override
 150     public void compareToken(String passedToken) throws ServiceException {
 151         if (xsrfProtectionEnabled) {
 152             if (!getCSRFToken().equals(passedToken)) {
<abbr title=" 153                 throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expired.&quot;);"> 153                 throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expðŸ”µ</abbr>
 154             } else {
 155                 LOG.debug(&quot;Validated CSRF token&quot;);
 156             }
 157         }
 158     }
 159 
 160     @Override
 161     public String getCSRFToken() throws ServiceException {
<abbr title=" 162         //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated instance."> 162         //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated ðŸ”µ</abbr>
 163         HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 164         if (request == null) {
<abbr title=" 165             //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holder"> 165             //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holdðŸ”µ</abbr>
<abbr title=" 166             request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();"> 166             request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequestðŸ”µ</abbr>
 167         }
 168 
 169         if (BLCRequestUtils.isOKtoUseSession(new ServletWebRequest(request))) {
 170             HttpSession session = request.getSession();
 171             String token = (String) session.getAttribute(CSRFTOKEN);
 172             if (StringUtils.isEmpty(token)) {
 173                 try {
 174                     token = RandomGenerator.generateRandomId(&quot;SHA1PRNG&quot;, 32);
 175                 } catch (NoSuchAlgorithmException e) {
 176                     LOG.error(&quot;Unable to generate random number&quot;, e);
 177                     throw new ServiceException(&quot;Unable to generate random number&quot;, e);
 178                 }
 179                 session.setAttribute(CSRFTOKEN, token);
 180             }
 181             return token;
 182         }
 183         return null;
 184     }
 185 
 186     @Override
 187     public String getAntiSamyPolicyFileLocation() {
 188         return antiSamyPolicyFileLocation;
 189     }
 190 
 191     @Override
 192     public void setAntiSamyPolicyFileLocation(String antiSamyPolicyFileLocation) {
 193         this.antiSamyPolicyFileLocation = antiSamyPolicyFileLocation;
 194         antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);
 195     }
 196 
 197     @Override
 198     public String getCsrfTokenParameter() {
 199         return CSRFTOKENPARAMETER;
 200     }
 201 
 202     public void setXssProtectionEnabled(boolean xssProtectionEnabled) {
 203         this.xssProtectionEnabled = xssProtectionEnabled;
 204     }
 205 }
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.security.service;
  19 
  20 import java.io.IOException;
  21 import java.net.URL;
  22 import java.net.URLConnection;
  23 import java.net.URLStreamHandler;
  24 import java.security.NoSuchAlgorithmException;
  25 import java.util.regex.Matcher;
  26 import java.util.regex.Pattern;
  27 import javax.servlet.http.HttpServletRequest;
  28 import javax.servlet.http.HttpSession;
  29 import org.apache.commons.lang.StringUtils;
  30 import org.apache.commons.logging.Log;
  31 import org.apache.commons.logging.LogFactory;
  32 import org.broadleafcommerce.common.exception.ServiceException;
  33 import org.broadleafcommerce.common.security.RandomGenerator;
  34 import org.broadleafcommerce.common.util.BLCRequestUtils;
  35 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  36 import org.owasp.validator.html.AntiSamy;
  37 import org.owasp.validator.html.CleanResults;
  38 import org.owasp.validator.html.Policy;
  39 import org.springframework.beans.factory.annotation.Value;
  40 import org.springframework.stereotype.Service;
  41 import org.springframework.web.context.request.RequestContextHolder;
  42 import org.springframework.web.context.request.ServletRequestAttributes;
  43 import org.springframework.web.context.request.ServletWebRequest;
  44 import org.springframework.web.util.HtmlUtils;
  45 
  46 
  47 /**
  48  * @author jfischer
  49  */
  50 @Service(&quot;blExploitProtectionService&quot;)
  51 public class ExploitProtectionServiceImpl implements ExploitProtectionService {
  52     private static final String CSRFTOKEN = &quot;csrfToken&quot;;
  53 
  54     private static final String CSRFTOKENPARAMETER = &quot;csrfToken&quot;;
  55 
  56     private static final Log LOG = LogFactory.getLog(ExploitProtectionServiceImpl.class);
  57 
  58     private static final String JAVASCRIPT = &quot;javascript&quot;;
  59 
  60     private static class Handler extends URLStreamHandler {
  61         @Override
  62         protected URLConnection openConnection(URL u) throws IOException {
  63             URL resourceUrl = getClass().getClassLoader().getResource(u.getPath());
  64             return resourceUrl.openConnection();
  65         }
  66     }
  67 
  68     private static Policy getAntiSamyPolicy(String policyFileLocation) {
  69         try {
  70             URL url = new URL(null, policyFileLocation, new Handler());
  71             return Policy.getInstance(url);
  72         } catch (Exception e) {
  73             throw new RuntimeException(&quot;Unable to create URL&quot;, e);
  74         }
  75     }
  76 
  77     private static final String DEFAULTANTISAMYPOLICYFILELOCATION = &quot;classpath:antisamy-myspace.xml&quot;;
  78 
  79     protected String antiSamyPolicyFileLocation = DEFAULTANTISAMYPOLICYFILELOCATION;
  80 
  81     //this is thread safe
  82     //this is thread safe
  83     private Policy antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);
  84 
  85     //this is thread safe for the usage of scan()
  86     //this is thread safe for the usage of scan()
  87     private final AntiSamy as = new AntiSamy();
  88 
  89     @Value(&quot;${exploitProtection.xsrfEnabled:true}&quot;)
  90     protected boolean xsrfProtectionEnabled;
  91 
  92     @Value(&quot;${exploitProtection.xssEnabled:true}&quot;)
  93     protected boolean xssProtectionEnabled;
  94 
  95     private static final String HTML_PATTERN = &quot;&lt;(\&quot;[^\&quot;]*\&quot;|&#x27;[^&#x27;]*&#x27;|[^&#x27;\&quot;&gt;])*&gt;&quot;;
  96 
  97     private Pattern pattern = Pattern.compile(HTML_PATTERN);
  98 
  99     @Override
 100     public String cleanString(String string) throws ServiceException {
 101         if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {
 102             return string;
 103         }
 104         try {
 105             CleanResults results = as.scan(string, antiSamyPolicy);
 106             return results.getCleanHTML();
 107         } catch (Exception e) {
 108             LOG.error(&quot;Unable to clean the passed in entity values&quot;, e);
 109             throw new ServiceException(&quot;Unable to clean the passed in entity values&quot;, e);
 110         }
 111     }
 112 
 113     @Override
 114     public String cleanStringWithResults(String string) throws ServiceException {
 115         if ((!xssProtectionEnabled) || StringUtils.isEmpty(string)) {
 116             return string;
 117         }
 118         try {
 119             CleanResults results = as.scan(string, antiSamyPolicy);
 120             if (results.getNumberOfErrors() &gt; 0) {
 121                 throw new CleanStringException(results);
<abbr title=" 122             } else //ok no errors, but what if it has regular string with javascript:xxx and it possibly can be used to construct anchor link"> 122             } else //ok no errors, but what if it has regular string with javascript:xxx and it possibly ðŸ”µ</abbr>
 123             if (
 124 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125 string.toLowerCase().startsWith(&quot;javascript&quot;)</span>
 126 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 127 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 127 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 128 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130 string.toLowerCase().startsWith(JAVASCRIPT)</span>
 131 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 132             ) {
 133                 throw new CleanStringException(results);
 134             }
 135             return results.getCleanHTML();
 136         } catch (CleanStringException e) {
 137             throw e;
 138         } catch (java.lang.Exception e) {
 139             StringBuilder sb = new StringBuilder();
 140             sb.append(&quot;Unable to clean the passed in entity values&quot;);
 141             sb.append(&quot;\nNote - &quot;);
 142             sb.append(getAntiSamyPolicyFileLocation());
<abbr title=" 143             sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.&quot;);"> 143             sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.ðŸ”µ</abbr>
 144             LOG.error(sb.toString(), e);
 145             throw new ServiceException(sb.toString(), e);
 146         }
 147     }
 148 
 149     protected boolean hasHTMLTags(String text){
 150         Matcher matcher = pattern.matcher(text);
 151         return matcher.find();
 152     }
 153 
 154     @Override
 155     public void compareToken(String passedToken) throws ServiceException {
 156         if (xsrfProtectionEnabled) {
 157             if (!getCSRFToken().equals(passedToken)) {
<abbr title=" 158                 throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expired.&quot;);"> 158                 throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expðŸ”µ</abbr>
 159             } else {
 160                 LOG.debug(&quot;Validated CSRF token&quot;);
 161             }
 162         }
 163     }
 164 
 165     @Override
 166     public String getCSRFToken() throws ServiceException {
<abbr title=" 167         //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated instance."> 167         //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated ðŸ”µ</abbr>
 168         HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 169         if (request == null) {
<abbr title=" 170             //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holder"> 170             //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holdðŸ”µ</abbr>
<abbr title=" 171             request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();"> 171             request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequestðŸ”µ</abbr>
 172         }
 173 
 174         if (BLCRequestUtils.isOKtoUseSession(new ServletWebRequest(request))) {
 175             HttpSession session = request.getSession();
 176             String token = (String) session.getAttribute(CSRFTOKEN);
 177             if (StringUtils.isEmpty(token)) {
 178                 try {
 179                     token = RandomGenerator.generateRandomId(&quot;SHA1PRNG&quot;, 32);
 180                 } catch (NoSuchAlgorithmException e) {
 181                     LOG.error(&quot;Unable to generate random number&quot;, e);
 182                     throw new ServiceException(&quot;Unable to generate random number&quot;, e);
 183                 }
 184                 session.setAttribute(CSRFTOKEN, token);
 185             }
 186             return token;
 187         }
 188         return null;
 189     }
 190 
 191     @Override
 192     public String getAntiSamyPolicyFileLocation() {
 193         return antiSamyPolicyFileLocation;
 194     }
 195 
 196     @Override
 197     public void setAntiSamyPolicyFileLocation(String antiSamyPolicyFileLocation) {
 198         this.antiSamyPolicyFileLocation = antiSamyPolicyFileLocation;
 199         antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);
 200     }
 201 
 202     @Override
 203     public String getCsrfTokenParameter() {
 204         return CSRFTOKENPARAMETER;
 205     }
 206 
 207     public void setXssProtectionEnabled(boolean xssProtectionEnabled) {
 208         this.xssProtectionEnabled = xssProtectionEnabled;
 209     }
 210 }</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.security.service;
  19  
  20  import org.apache.commons.lang.StringUtils;
  21  import org.apache.commons.logging.Log;
  22  import org.apache.commons.logging.LogFactory;
  23  import org.broadleafcommerce.common.exception.ServiceException;
  24  import org.broadleafcommerce.common.security.RandomGenerator;
  25  import org.broadleafcommerce.common.util.BLCRequestUtils;
  26  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  27  import org.owasp.validator.html.AntiSamy;
  28  import org.owasp.validator.html.CleanResults;
  29  import org.owasp.validator.html.Policy;
  30  import org.springframework.beans.factory.annotation.Value;
  31  import org.springframework.stereotype.Service;
  32  import org.springframework.web.context.request.RequestContextHolder;
  33  import org.springframework.web.context.request.ServletRequestAttributes;
  34  import org.springframework.web.context.request.ServletWebRequest;
  35  import org.springframework.web.util.HtmlUtils;
  36  
  37  import java.io.IOException;
  38  import java.net.URL;
  39  import java.net.URLConnection;
  40  import java.net.URLStreamHandler;
  41  import java.security.NoSuchAlgorithmException;
  42  import java.util.regex.Matcher;
  43  import java.util.regex.Pattern;
  44  
  45  import javax.servlet.http.HttpServletRequest;
  46  import javax.servlet.http.HttpSession;
  47  
  48  /**
  49   * @author jfischer
  50   */
  51  @Service(&quot;blExploitProtectionService&quot;)
  52  public class ExploitProtectionServiceImpl implements ExploitProtectionService {
  53  
  54      private static final String CSRFTOKEN = &quot;csrfToken&quot;;
  55      private static final String CSRFTOKENPARAMETER = &quot;csrfToken&quot;;
  56      private static final Log LOG = LogFactory.getLog(ExploitProtectionServiceImpl.class);

  57  
  58      private static class Handler extends URLStreamHandler {
  59          @Override
  60          protected URLConnection openConnection(URL u) throws IOException {
  61              URL resourceUrl = getClass().getClassLoader().getResource(u.getPath());
  62              return resourceUrl.openConnection();
  63          }
  64      }
  65  
  66      private static Policy getAntiSamyPolicy(String policyFileLocation) {
  67          try {
  68              URL url = new URL(null, policyFileLocation, new Handler());
  69              return Policy.getInstance(url);
  70          } catch (Exception e) {
  71              throw new RuntimeException(&quot;Unable to create URL&quot;, e);
  72          }
  73      }
  74  
  75      private static final String DEFAULTANTISAMYPOLICYFILELOCATION = &quot;classpath:antisamy-myspace.xml&quot;;
  76  
  77      protected String antiSamyPolicyFileLocation = DEFAULTANTISAMYPOLICYFILELOCATION;
  78      //this is thread safe
  79      private Policy antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);
  80      //this is thread safe for the usage of scan()
  81      private final AntiSamy as = new AntiSamy();
  82  
  83      @Value(&quot;${exploitProtection.xsrfEnabled:true}&quot;)
  84      protected boolean xsrfProtectionEnabled;
  85  
  86      @Value(&quot;${exploitProtection.xssEnabled:true}&quot;)
  87      protected boolean xssProtectionEnabled;
  88  
  89      private static final String HTML_PATTERN = &quot;&lt;(\&quot;[^\&quot;]*\&quot;|&#x27;[^&#x27;]*&#x27;|[^&#x27;\&quot;&gt;])*&gt;&quot;;
  90      private Pattern pattern = Pattern.compile(HTML_PATTERN);
  91  
  92  
  93      @Override
  94      public String cleanString(String string) throws ServiceException {
  95          if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {
  96              return string;
  97          }
  98          try {
  99              CleanResults results = as.scan(string, antiSamyPolicy);
 100              return results.getCleanHTML();
 101          } catch (Exception e) {
 102              LOG.error(&quot;Unable to clean the passed in entity values&quot;, e);
 103              throw new ServiceException(&quot;Unable to clean the passed in entity values&quot;, e);
 104          }
 105      }
 106  
 107      @Override
 108      public String cleanStringWithResults(String string) throws ServiceException {
 109          if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {
 110              return string;
 111          }
 112          try {
 113              CleanResults results = as.scan(string, antiSamyPolicy);
 114              if (results.getNumberOfErrors() &gt; 0) {
 115                  throw new CleanStringException(results);
 116              }else{
<abbr title=" 117                  //ok no errors, but what if it has regular string with javascript:xxx and it possibly can be used to construct anchor link"> 117                  //ok no errors, but what if it has regular string with javascript:xxx and it possibly can be used ðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -                // let&#x27;s maybe try wrap string into &lt;a href=&quot;string&quot;&gt;qqq&lt;/a&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -                if(!hasHTMLTags(string)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 120 -                    CleanResults resultsTemp = as.scan(&quot;&lt;a href=\&quot;&quot; + HtmlUtils.htmlEscape(string) + &quot;\&quot;/&gt;tt&lt;/a&gt;&quot;, antiSamyPolicy);"> 120 -                    CleanResults resultsTemp = as.scan(&quot;&lt;a href=\&quot;&quot; + HtmlUtils.htmlEscape(string) + &quot;\&quot;/&gt;tt&lt;/a&gt;&quot;,ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -                    if (resultsTemp.getNumberOfErrors() &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -                        throw new CleanStringException(results);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +                if (string.toLowerCase().startsWith(&quot;javascript&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +                    throw new CleanStringException(results);</span>
 126                  }
 127              }
 128              return results.getCleanHTML();
 129          } catch (CleanStringException e) {
 130              throw e;
 131          } catch (Exception e) {
 132              StringBuilder sb = new StringBuilder();
 133              sb.append(&quot;Unable to clean the passed in entity values&quot;);
 134              sb.append(&quot;\nNote - &quot;);
 135              sb.append(getAntiSamyPolicyFileLocation());
 136              sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.&quot;);
 137              LOG.error(sb.toString(), e);
 138              throw new ServiceException(sb.toString(), e);
 139          }
 140      }
 141  
 142  
 143      protected boolean hasHTMLTags(String text){
 144          Matcher matcher = pattern.matcher(text);
 145          return matcher.find();
 146      }
 147  
 148      @Override
 149      public void compareToken(String passedToken) throws ServiceException {
 150          if (xsrfProtectionEnabled) {
 151              if (!getCSRFToken().equals(passedToken)) {
 152                  throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expired.&quot;);
 153              } else {
 154                  LOG.debug(&quot;Validated CSRF token&quot;);
 155              }
 156          }
 157      }
 158  
 159      @Override
 160      public String getCSRFToken() throws ServiceException {
 161          //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated instance.
 162          HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 163          if (request == null) {
 164              //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holder
 165              request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
 166          }
 167  
 168          if (BLCRequestUtils.isOKtoUseSession(new ServletWebRequest(request))) {
 169              HttpSession session = request.getSession();
 170              String token = (String) session.getAttribute(CSRFTOKEN);
 171              if (StringUtils.isEmpty(token)) {
 172                  try {
 173                      token = RandomGenerator.generateRandomId(&quot;SHA1PRNG&quot;, 32);
 174                  } catch (NoSuchAlgorithmException e) {
 175                      LOG.error(&quot;Unable to generate random number&quot;, e);
 176                      throw new ServiceException(&quot;Unable to generate random number&quot;, e);
 177                  }
 178                  session.setAttribute(CSRFTOKEN, token);
 179              }
 180              return token;
 181          }
 182          return null;
 183      }
 184  
 185      @Override
 186      public String getAntiSamyPolicyFileLocation() {
 187          return antiSamyPolicyFileLocation;
 188      }
 189  
 190      @Override
 191      public void setAntiSamyPolicyFileLocation(String antiSamyPolicyFileLocation) {
 192          this.antiSamyPolicyFileLocation = antiSamyPolicyFileLocation;
 193          antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);
 194      }
 195  
 196      @Override
 197      public String getCsrfTokenParameter() {
 198          return CSRFTOKENPARAMETER;
 199      }
 200  
 201      public void setXssProtectionEnabled(boolean xssProtectionEnabled) {
 202          this.xssProtectionEnabled = xssProtectionEnabled;
 203      }
 204  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.security.service;
  19  
  20  import org.apache.commons.lang.StringUtils;
  21  import org.apache.commons.logging.Log;
  22  import org.apache.commons.logging.LogFactory;
  23  import org.broadleafcommerce.common.exception.ServiceException;
  24  import org.broadleafcommerce.common.security.RandomGenerator;
  25  import org.broadleafcommerce.common.util.BLCRequestUtils;
  26  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  27  import org.owasp.validator.html.AntiSamy;
  28  import org.owasp.validator.html.CleanResults;
  29  import org.owasp.validator.html.Policy;
  30  import org.springframework.beans.factory.annotation.Value;
  31  import org.springframework.stereotype.Service;
  32  import org.springframework.web.context.request.RequestContextHolder;
  33  import org.springframework.web.context.request.ServletRequestAttributes;
  34  import org.springframework.web.context.request.ServletWebRequest;
  35  import org.springframework.web.util.HtmlUtils;
  36  
  37  import java.io.IOException;
  38  import java.net.URL;
  39  import java.net.URLConnection;
  40  import java.net.URLStreamHandler;
  41  import java.security.NoSuchAlgorithmException;
  42  import java.util.regex.Matcher;
  43  import java.util.regex.Pattern;
  44  
  45  import javax.servlet.http.HttpServletRequest;
  46  import javax.servlet.http.HttpSession;
  47  
  48  /**
  49   * @author jfischer
  50   */
  51  @Service(&quot;blExploitProtectionService&quot;)
  52  public class ExploitProtectionServiceImpl implements ExploitProtectionService {
  53  
  54      private static final String CSRFTOKEN = &quot;csrfToken&quot;;
  55      private static final String CSRFTOKENPARAMETER = &quot;csrfToken&quot;;
  56      private static final Log LOG = LogFactory.getLog(ExploitProtectionServiceImpl.class);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +    private static final String JAVASCRIPT = &quot;javascript&quot;;</span>
  58  
  59      private static class Handler extends URLStreamHandler {
  60          @Override
  61          protected URLConnection openConnection(URL u) throws IOException {
  62              URL resourceUrl = getClass().getClassLoader().getResource(u.getPath());
  63              return resourceUrl.openConnection();
  64          }
  65      }
  66  
  67      private static Policy getAntiSamyPolicy(String policyFileLocation) {
  68          try {
  69              URL url = new URL(null, policyFileLocation, new Handler());
  70              return Policy.getInstance(url);
  71          } catch (Exception e) {
  72              throw new RuntimeException(&quot;Unable to create URL&quot;, e);
  73          }
  74      }
  75  
  76      private static final String DEFAULTANTISAMYPOLICYFILELOCATION = &quot;classpath:antisamy-myspace.xml&quot;;
  77  
  78      protected String antiSamyPolicyFileLocation = DEFAULTANTISAMYPOLICYFILELOCATION;
  79      //this is thread safe
  80      private Policy antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);
  81      //this is thread safe for the usage of scan()
  82      private final AntiSamy as = new AntiSamy();
  83  
  84      @Value(&quot;${exploitProtection.xsrfEnabled:true}&quot;)
  85      protected boolean xsrfProtectionEnabled;
  86  
  87      @Value(&quot;${exploitProtection.xssEnabled:true}&quot;)
  88      protected boolean xssProtectionEnabled;
  89  
  90      private static final String HTML_PATTERN = &quot;&lt;(\&quot;[^\&quot;]*\&quot;|&#x27;[^&#x27;]*&#x27;|[^&#x27;\&quot;&gt;])*&gt;&quot;;
  91      private Pattern pattern = Pattern.compile(HTML_PATTERN);
  92  
  93  
  94      @Override
  95      public String cleanString(String string) throws ServiceException {
  96          if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {
  97              return string;
  98          }
  99          try {
 100              CleanResults results = as.scan(string, antiSamyPolicy);
 101              return results.getCleanHTML();
 102          } catch (Exception e) {
 103              LOG.error(&quot;Unable to clean the passed in entity values&quot;, e);
 104              throw new ServiceException(&quot;Unable to clean the passed in entity values&quot;, e);
 105          }
 106      }
 107  
 108      @Override
 109      public String cleanStringWithResults(String string) throws ServiceException {
 110          if (!xssProtectionEnabled || StringUtils.isEmpty(string)) {
 111              return string;
 112          }
 113          try {
 114              CleanResults results = as.scan(string, antiSamyPolicy);
 115              if (results.getNumberOfErrors() &gt; 0) {
 116                  throw new CleanStringException(results);
 117              }else{
<abbr title=" 118                  //ok no errors, but what if it has regular string with javascript:xxx and it possibly can be used to construct anchor link"> 118                  //ok no errors, but what if it has regular string with javascript:xxx and it possibly can be used ðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -                // let&#x27;s maybe try wrap string into &lt;a href=&quot;string&quot;&gt;qqq&lt;/a&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -                if(!hasHTMLTags(string)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 121 -                    CleanResults resultsTemp = as.scan(&quot;&lt;a href=\&quot;&quot; + HtmlUtils.htmlEscape(string) + &quot;\&quot;/&gt;tt&lt;/a&gt;&quot;, antiSamyPolicy);"> 121 -                    CleanResults resultsTemp = as.scan(&quot;&lt;a href=\&quot;&quot; + HtmlUtils.htmlEscape(string) + &quot;\&quot;/&gt;tt&lt;/a&gt;&quot;,ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -                    if (resultsTemp.getNumberOfErrors() &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -                        throw new CleanStringException(results);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +                if (string.toLowerCase().startsWith(JAVASCRIPT)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +                    throw new CleanStringException(results);</span>
 127                  }
 128              }
 129              return results.getCleanHTML();
 130          } catch (CleanStringException e) {
 131              throw e;
 132          } catch (Exception e) {
 133              StringBuilder sb = new StringBuilder();
 134              sb.append(&quot;Unable to clean the passed in entity values&quot;);
 135              sb.append(&quot;\nNote - &quot;);
 136              sb.append(getAntiSamyPolicyFileLocation());
 137              sb.append(&quot; policy in effect. Set a new policy file to modify validation behavior/strictness.&quot;);
 138              LOG.error(sb.toString(), e);
 139              throw new ServiceException(sb.toString(), e);
 140          }
 141      }
 142  
 143  
 144      protected boolean hasHTMLTags(String text){
 145          Matcher matcher = pattern.matcher(text);
 146          return matcher.find();
 147      }
 148  
 149      @Override
 150      public void compareToken(String passedToken) throws ServiceException {
 151          if (xsrfProtectionEnabled) {
 152              if (!getCSRFToken().equals(passedToken)) {
 153                  throw new ServiceException(&quot;XSRF token mismatch (&quot; + passedToken + &quot;). Session may be expired.&quot;);
 154              } else {
 155                  LOG.debug(&quot;Validated CSRF token&quot;);
 156              }
 157          }
 158      }
 159  
 160      @Override
 161      public String getCSRFToken() throws ServiceException {
 162          //If using any request wrapper (e.g. Spring Session) on site, we&#x27;ll need to return the decorated instance.
 163          HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 164          if (request == null) {
 165              //in the case of the admin, the brc is not used, so fallback to Spring&#x27;s request context holder
 166              request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
 167          }
 168  
 169          if (BLCRequestUtils.isOKtoUseSession(new ServletWebRequest(request))) {
 170              HttpSession session = request.getSession();
 171              String token = (String) session.getAttribute(CSRFTOKEN);
 172              if (StringUtils.isEmpty(token)) {
 173                  try {
 174                      token = RandomGenerator.generateRandomId(&quot;SHA1PRNG&quot;, 32);
 175                  } catch (NoSuchAlgorithmException e) {
 176                      LOG.error(&quot;Unable to generate random number&quot;, e);
 177                      throw new ServiceException(&quot;Unable to generate random number&quot;, e);
 178                  }
 179                  session.setAttribute(CSRFTOKEN, token);
 180              }
 181              return token;
 182          }
 183          return null;
 184      }
 185  
 186      @Override
 187      public String getAntiSamyPolicyFileLocation() {
 188          return antiSamyPolicyFileLocation;
 189      }
 190  
 191      @Override
 192      public void setAntiSamyPolicyFileLocation(String antiSamyPolicyFileLocation) {
 193          this.antiSamyPolicyFileLocation = antiSamyPolicyFileLocation;
 194          antiSamyPolicy = getAntiSamyPolicy(antiSamyPolicyFileLocation);
 195      }
 196  
 197      @Override
 198      public String getCsrfTokenParameter() {
 199          return CSRFTOKENPARAMETER;
 200      }
 201  
 202      public void setXssProtectionEnabled(boolean xssProtectionEnabled) {
 203          this.xssProtectionEnabled = xssProtectionEnabled;
 204      }
 205  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            