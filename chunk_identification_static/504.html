<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>504</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    504
                    <a href="503.html">prev</a>
                    <a href="505.html">next</a>
                    <a href="504_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_b33108525150e417d003328be87242cc626fe203_hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b33108525150e417d003328be87242cc626fe203:hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b33108525150e417d003328be87242cc626fe203^1:hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b33108525150e417d003328be87242cc626fe203^2:hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b59ef71c4aa3401fd523d61328334a6bac817e1c:hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [b], [b], [j]], subset: [[bj], [b], [b], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19  
  20 
  21 package com.dtstack.flink.sql.side.hbase;
  22 
  23 import com.dtstack.flink.sql.enums.ECacheContentType;
  24 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  25 import com.dtstack.flink.sql.side.FieldInfo;
  26 import com.dtstack.flink.sql.side.JoinInfo;
  27 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  28 import com.dtstack.flink.sql.side.cache.CacheObj;
  29 import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbstractRowKeyModeDealer;
  30 import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  31 import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  32 import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  33 import com.dtstack.flink.sql.factory.DTThreadFactory;
  34 import com.google.common.collect.Maps;
  35 import com.stumbleupon.async.Deferred;
  36 import org.apache.commons.lang3.StringUtils;
  37 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  38 import org.apache.flink.configuration.Configuration;
  39 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  40 import org.apache.flink.table.runtime.types.CRow;
  41 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  42 import org.apache.flink.types.Row;
  43 import org.hbase.async.HBaseClient;
  44 import org.slf4j.Logger;
  45 import org.slf4j.LoggerFactory;
  46 
  47 import java.sql.Timestamp;
  48 import java.util.Collections;
  49 import java.util.List;
  50 import java.util.Map;
  51 import java.util.concurrent.ExecutorService;
  52 import java.util.concurrent.LinkedBlockingQueue;
  53 import java.util.concurrent.ThreadPoolExecutor;
  54 import java.util.concurrent.TimeUnit;
  55 
  56 /**
  57  * Date: 2018/8/21
  58  * Company: www.dtstack.com
  59  * @author xuchao
  60  */
  61 
  62 public class HbaseAsyncReqRow extends BaseAsyncReqRow {
  63 
  64     private static final long serialVersionUID = 2098635104857937717L;
  65 
  66     private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  67 
  68     //match to the rule of netty3
  69     private static final int DEFAULT_BOSS_THREADS = 1;
  70 
  71     private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  72 
  73     private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  74 
  75     private transient HBaseClient hBaseClient;
  76 
  77     private transient AbstractRowKeyModeDealer rowKeyMode;
  78 
  79     private String tableName;
  80 
  81     private String[] colNames;
  82 
<abbr title="  83     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  83     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  84         super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  85 
  86         tableName = ((HbaseSideTableInfo)sideTableInfo).getTableName();
  87         colNames =  StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
  88     }
  89 
  90 
  91     @Override
  92     public void open(Configuration parameters) throws Exception {
  93 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94         AbstractSideTableInfo sideTableInfo = sideInfo.getSideTableInfo();</span>
  95 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96         SideTableInfo sideTableInfo = sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97         HbaseSideTableInfo hbaseSideTableInfo = (HbaseSideTableInfo) sideTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98         ExecutorService executorService =new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE,</span>
  99 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100         super.open(parameters);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101         SideTableInfo sideTableInfo = sideInfo.getSideTableInfo();</span>
 102 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 103         HbaseSideTableInfo hbaseSideTableInfo = (HbaseSideTableInfo) sideTableInfo;
 104         ExecutorService executorService =new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE,
 105                 0L, TimeUnit.MILLISECONDS,
 106                 new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));
 107 
<abbr title=" 108         hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), executorService);"> 108         hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), execuðŸ”µ</abbr>
 109 
 110         try {
 111             Deferred deferred = hBaseClient.ensureTableExists(tableName)
<abbr title=" 112                     .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()));"> 112                     .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toSðŸ”µ</abbr>
 113 
 114             CheckResult result = (CheckResult) deferred.join();
 115             if(!result.isConnect()){
 116                 throw new RuntimeException(result.getExceptionMsg());
 117             }
 118 
 119         } catch (Exception e) {
 120             throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
 121         }
 122 
 123         HbaseAsyncSideInfo hbaseAsyncSideInfo = (HbaseAsyncSideInfo) sideInfo;
 124         if(hbaseSideTableInfo.isPreRowKey()){
<abbr title=" 125             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,"> 125             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBasðŸ”µ</abbr>
 126                     openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 127                     sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 128         }else{
<abbr title=" 129             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,"> 129             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseCliðŸ”µ</abbr>
 130                     openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 131                     sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 132         }
 133     }
 134 
 135     @Override
 136 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 137     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 137     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 138         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache());"> 138         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139     }</span>
 140 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         Map&lt;String, Object&gt; refData = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146             Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151             refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154         String rowKeyStr = ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(refData);</span>
 155 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157         CRow inputCopy = new CRow(Row.copy(input.row()), input.change());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158         Map&lt;String, Object&gt; refData = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161             Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166             refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167         }</span>
 168 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 169 
 170 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173         return ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(inputParams);</span>
 174 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176             Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181             refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184         String rowKeyStr = ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(refData);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186         //get from cache</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188             CacheObj val = getFromCache(rowKeyStr);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 } else if (ECacheContentType.SingleLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195                         Row row = fillData(inputCopy.row(), val);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196                         resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202                         for (Object one : (List) val.getContent()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203                             Row row = fillData(inputCopy.row(), one);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 204                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));"> 204                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214         rowKeyMode.asyncGetData(tableName, rowKeyStr, inputCopy, resultFuture, sideInfo.getSideCache());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216 </span>
 217 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218         String rowKeyStr = ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(refData);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220         //get from cache</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222             CacheObj val = getFromCache(rowKeyStr);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226                     return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227                 } else if (ECacheContentType.SingleLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228                     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229                         Row row = fillData(inputCopy.row(), val.getContent());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230                         resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235                     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236                         for (Object one : (List) val.getContent()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237                             Row row = fillData(inputCopy.row(), one);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 238                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));"> 238                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248         rowKeyMode.asyncGetData(tableName, rowKeyStr, inputCopy, resultFuture, sideInfo.getSideCache());</span>
 249 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 250     }
 251 
 252     @Override
 253     public Row fillData(Row input, Object sideInput){
 254         List&lt;Object&gt; sideInputList = (List&lt;Object&gt;) sideInput;
 255         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 256         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()){
 257             Object obj = input.getField(entry.getValue());
<abbr title=" 258             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 258             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoðŸ”µ</abbr>
 259 
 260             if(obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo){
 261                 obj = ((Timestamp)obj).getTime();
 262             }
 263 
 264             row.setField(entry.getKey(), obj);
 265         }
 266 
 267         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()){
 268             if(sideInputList == null){
 269                 row.setField(entry.getKey(), null);
 270             }else{
 271                 row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 272             }
 273         }
 274 
 275         return row;
 276     }
 277 
 278     @Override
 279     public void close() throws Exception {
 280         super.close();
 281         hBaseClient.shutdown();
 282     }
 283 
 284 
 285     class CheckResult{
 286 
 287         private boolean connect;
 288 
 289         private String exceptionMsg;
 290 
 291         CheckResult(boolean connect, String msg){
 292             this.connect = connect;
 293             this.exceptionMsg = msg;
 294         }
 295 
 296         public boolean isConnect() {
 297             return connect;
 298         }
 299 
 300         public void setConnect(boolean connect) {
 301             this.connect = connect;
 302         }
 303 
 304         public String getExceptionMsg() {
 305             return exceptionMsg;
 306         }
 307 
 308         public void setExceptionMsg(String exceptionMsg) {
 309             this.exceptionMsg = exceptionMsg;
 310         }
 311     }
 312 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 
  21 package com.dtstack.flink.sql.side.hbase;
  22 
  23 import com.dtstack.flink.sql.enums.ECacheContentType;
  24 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  25 import com.dtstack.flink.sql.side.FieldInfo;
  26 import com.dtstack.flink.sql.side.JoinInfo;
  27 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  28 import com.dtstack.flink.sql.side.cache.CacheObj;
  29 import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbstractRowKeyModeDealer;
  30 import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  31 import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  32 import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  33 import com.dtstack.flink.sql.factory.DTThreadFactory;
  34 import com.google.common.collect.Maps;
  35 import com.stumbleupon.async.Deferred;
  36 import org.apache.commons.lang3.StringUtils;
  37 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  38 import org.apache.flink.configuration.Configuration;
  39 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  40 import org.apache.flink.table.runtime.types.CRow;
  41 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  42 import org.apache.flink.types.Row;
  43 import org.hbase.async.HBaseClient;
  44 import org.slf4j.Logger;
  45 import org.slf4j.LoggerFactory;
  46 
  47 import java.sql.Timestamp;
  48 import java.util.Collections;
  49 import java.util.List;
  50 import java.util.Map;
  51 import java.util.concurrent.ExecutorService;
  52 import java.util.concurrent.LinkedBlockingQueue;
  53 import java.util.concurrent.ThreadPoolExecutor;
  54 import java.util.concurrent.TimeUnit;
  55 
  56 /**
  57  * Date: 2018/8/21
  58  * Company: www.dtstack.com
  59  * @author xuchao
  60  */
  61 
  62 public class HbaseAsyncReqRow extends BaseAsyncReqRow {
  63 
  64     private static final long serialVersionUID = 2098635104857937717L;
  65 
  66     private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  67 
  68     //match to the rule of netty3
  69     private static final int DEFAULT_BOSS_THREADS = 1;
  70 
  71     private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  72 
  73     private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  74 
  75     private transient HBaseClient hBaseClient;
  76 
  77     private transient AbstractRowKeyModeDealer rowKeyMode;
  78 
  79     private String tableName;
  80 
  81     private String[] colNames;
  82 
<abbr title="  83     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  83     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  84         super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  85 
  86         tableName = ((HbaseSideTableInfo)sideTableInfo).getTableName();
  87         colNames =  StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
  88     }
  89 
  90 
  91     @Override
  92     public void open(Configuration parameters) throws Exception {
  93 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94         AbstractSideTableInfo sideTableInfo = sideInfo.getSideTableInfo();</span>
  95 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96         SideTableInfo sideTableInfo = sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97         HbaseSideTableInfo hbaseSideTableInfo = (HbaseSideTableInfo) sideTableInfo;</span>
  98 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99         super.open(parameters);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100         SideTableInfo sideTableInfo = sideInfo.getSideTableInfo();</span>
 101 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 102         HbaseSideTableInfo hbaseSideTableInfo = (HbaseSideTableInfo) sideTableInfo;
 103         ExecutorService executorService =new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE,
 104                 0L, TimeUnit.MILLISECONDS,
 105                 new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));
 106 
<abbr title=" 107         hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), executorService);"> 107         hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), execuðŸ”µ</abbr>
 108 
 109         try {
 110             Deferred deferred = hBaseClient.ensureTableExists(tableName)
<abbr title=" 111                     .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()));"> 111                     .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toSðŸ”µ</abbr>
 112 
 113             CheckResult result = (CheckResult) deferred.join();
 114             if(!result.isConnect()){
 115                 throw new RuntimeException(result.getExceptionMsg());
 116             }
 117 
 118         } catch (Exception e) {
 119             throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
 120         }
 121 
 122         HbaseAsyncSideInfo hbaseAsyncSideInfo = (HbaseAsyncSideInfo) sideInfo;
 123         if(hbaseSideTableInfo.isPreRowKey()){
<abbr title=" 124             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,"> 124             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBasðŸ”µ</abbr>
 125                     openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 126                     sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 127         }else{
<abbr title=" 128             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,"> 128             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseCliðŸ”µ</abbr>
 129                     openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 130                     sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 131         }
 132     }
 133 
 134     @Override
<abbr title=" 135     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 135     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr>
<abbr title=" 136         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache());"> 136         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSðŸ”µ</abbr>
 137     }
 138 
 139     @Override
 140     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 141         return ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(inputParams);
 142     }
 143 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 144 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145 @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147         CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148         Map&lt;String, Object&gt; refData = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151             Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156             refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159         String rowKeyStr = ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(refData);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161         //get from cache</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163             CacheObj val = getFromCache(rowKeyStr);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168                 } else if (ECacheContentType.SingleLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170                         Row row = fillData(inputCopy.row(), val);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171                         resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177                         for (Object one : (List) val.getContent()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178                             Row row = fillData(inputCopy.row(), one);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 179                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));"> 179                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189         rowKeyMode.asyncGetData(tableName, rowKeyStr, inputCopy, resultFuture, sideInfo.getSideCache());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190     }</span>
 191 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192 @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194         CRow inputCopy = new CRow(Row.copy(input.row()), input.change());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195         Map&lt;String, Object&gt; refData = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198             Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203             refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206         String rowKeyStr = ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(refData);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208         //get from cache</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210             CacheObj val = getFromCache(rowKeyStr);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214                     return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215                 } else if (ECacheContentType.SingleLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216                     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217                         Row row = fillData(inputCopy.row(), val.getContent());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218                         resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223                     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224                         for (Object one : (List) val.getContent()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225                             Row row = fillData(inputCopy.row(), one);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 226                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));"> 226                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236         rowKeyMode.asyncGetData(tableName, rowKeyStr, inputCopy, resultFuture, sideInfo.getSideCache());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237     }</span>
 238 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 239 
 240 
 241     @Override
 242     public Row fillData(Row input, Object sideInput){
 243         List&lt;Object&gt; sideInputList = (List&lt;Object&gt;) sideInput;
 244         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 245         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()){
 246             Object obj = input.getField(entry.getValue());
<abbr title=" 247             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 247             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoðŸ”µ</abbr>
 248 
 249             if(obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo){
 250                 obj = ((Timestamp)obj).getTime();
 251             }
 252 
 253             row.setField(entry.getKey(), obj);
 254         }
 255 
 256         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()){
 257             if(sideInputList == null){
 258                 row.setField(entry.getKey(), null);
 259             }else{
 260                 row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 261             }
 262         }
 263 
 264         return row;
 265     }
 266 
 267     @Override
 268     public void close() throws Exception {
 269         super.close();
 270         hBaseClient.shutdown();
 271     }
 272 
 273 
 274     class CheckResult{
 275 
 276         private boolean connect;
 277 
 278         private String exceptionMsg;
 279 
 280         CheckResult(boolean connect, String msg){
 281             this.connect = connect;
 282             this.exceptionMsg = msg;
 283         }
 284 
 285         public boolean isConnect() {
 286             return connect;
 287         }
 288 
 289         public void setConnect(boolean connect) {
 290             this.connect = connect;
 291         }
 292 
 293         public String getExceptionMsg() {
 294             return exceptionMsg;
 295         }
 296 
 297         public void setExceptionMsg(String exceptionMsg) {
 298             this.exceptionMsg = exceptionMsg;
 299         }
 300     }
 301 }
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.hbase;
  19 
  20 import com.dtstack.flink.sql.enums.ECacheContentType;
  21 import com.dtstack.flink.sql.factory.DTThreadFactory;
  22 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  23 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  24 import com.dtstack.flink.sql.side.FieldInfo;
  25 import com.dtstack.flink.sql.side.JoinInfo;
  26 import com.dtstack.flink.sql.side.cache.CacheObj;
  27 import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbstractRowKeyModeDealer;
  28 import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  29 import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  30 import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  31 import com.google.common.collect.Maps;
  32 import com.stumbleupon.async.Deferred;
  33 import java.sql.Timestamp;
  34 import java.util.Collections;
  35 import java.util.List;
  36 import java.util.Map;
  37 import java.util.concurrent.ExecutorService;
  38 import java.util.concurrent.LinkedBlockingQueue;
  39 import java.util.concurrent.ThreadPoolExecutor;
  40 import java.util.concurrent.TimeUnit;
  41 import org.apache.commons.lang3.StringUtils;
  42 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  43 import org.apache.flink.configuration.Configuration;
  44 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  45 import org.apache.flink.table.runtime.types.CRow;
  46 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  47 import org.apache.flink.types.Row;
  48 import org.hbase.async.HBaseClient;
  49 import org.slf4j.Logger;
  50 import org.slf4j.LoggerFactory;
  51 
  52 
  53 /**
  54  * Date: 2018/8/21
  55  * Company: www.dtstack.com
  56  * @author xuchao
  57  */
  58 public class HbaseAsyncReqRow extends BaseAsyncReqRow {
  59     private static final long serialVersionUID = 2098635104857937717L;
  60 
  61     private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  62 
  63     //match to the rule of netty3
  64     //match to the rule of netty3
  65     private static final int DEFAULT_BOSS_THREADS = 1;
  66 
  67     private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  68 
  69     private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  70 
  71     private transient HBaseClient hBaseClient;
  72 
  73     private transient AbstractRowKeyModeDealer rowKeyMode;
  74 
  75     private String tableName;
  76 
  77     private String[] colNames;
  78 
<abbr title="  79     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  79     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  80         super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  81         tableName = ((HbaseSideTableInfo) (sideTableInfo)).getTableName();
  82         colNames = StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
  83     }
  84 
  85     @Override
  86     public void open(Configuration parameters) throws Exception {
  87         super.open(parameters);
  88         AbstractSideTableInfo sideTableInfo = sideInfo.getSideTableInfo();
  89         HbaseSideTableInfo hbaseSideTableInfo = ((HbaseSideTableInfo) (sideTableInfo));
<abbr title="  90         ExecutorService executorService = new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));">  90         ExecutorService executorService = new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE, 0LðŸ”µ</abbr>
<abbr title="  91         hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), executorService);">  91         hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), execuðŸ”µ</abbr>
  92         try {
<abbr title="  93             Deferred deferred = hBaseClient.ensureTableExists(tableName).addCallbacks(( arg) -&gt; new CheckResult(true, &quot;&quot;), ( arg) -&gt; new CheckResult(false, arg.toString()));">  93             Deferred deferred = hBaseClient.ensureTableExists(tableName).addCallbacks(( arg) -&gt; new CheckðŸ”µ</abbr>
  94             CheckResult result = ((CheckResult) (deferred.join()));
  95             if (!result.isConnect()) {
  96                 throw new RuntimeException(result.getExceptionMsg());
  97             }
  98         } catch (java.lang.Exception e) {
  99             throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
 100         }
 101         HbaseAsyncSideInfo hbaseAsyncSideInfo = ((HbaseAsyncSideInfo) (sideInfo));
 102         if (hbaseSideTableInfo.isPreRowKey()) {
<abbr title=" 103             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient, openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(), sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());"> 103             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBasðŸ”µ</abbr>
 104         } else {
<abbr title=" 105             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient, openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(), sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());"> 105             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseCliðŸ”µ</abbr>
 106         }
 107     }
 108 
 109     @Override
<abbr title=" 110     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 110     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr>
<abbr title=" 111         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache());"> 111         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSðŸ”µ</abbr>
 112     }
 113 
 114     @Override
 115     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 116         return ((HbaseAsyncSideInfo) (sideInfo)).getRowKeyBuilder().getRowKey(inputParams);
 117     }
 118 
 119     @Override
 120     public Row fillData(Row input, Object sideInput){
 121 
 122         List&lt;Object&gt; sideInputList = (List&lt;Object&gt;) sideInput;
 123         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 124         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()){
 125             Object obj = input.getField(entry.getValue());
<abbr title=" 126             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 126             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoðŸ”µ</abbr>
 127 
 128             if(obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo){
 129                 obj = ((Timestamp)obj).getTime();
 130             }
 131 
 132             row.setField(entry.getKey(), obj);
 133         }
 134 
 135         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()){
 136             if(sideInputList == null){
 137                 row.setField(entry.getKey(), null);
 138             }else{
 139                 row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 140             }
 141         }
 142 
 143         return row;
 144     }
 145 
 146     @Override
 147     public void close() throws Exception {
 148         super.close();
 149         hBaseClient.shutdown();
 150     }
 151 
 152     class CheckResult {
 153         private boolean connect;
 154 
 155         private String exceptionMsg;
 156 
 157         CheckResult(boolean connect, String msg) {
 158             this.connect = connect;
 159             this.exceptionMsg = msg;
 160         }
 161 
 162         public boolean isConnect() {
 163             return connect;
 164         }
 165 
 166         public void setConnect(boolean connect) {
 167             this.connect = connect;
 168         }
 169 
 170         public String getExceptionMsg() {
 171             return exceptionMsg;
 172         }
 173 
 174         public void setExceptionMsg(String exceptionMsg) {
 175             this.exceptionMsg = exceptionMsg;
 176         }
 177     }
 178 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  
  21  package com.dtstack.flink.sql.side.hbase;
  22  
  23  import com.dtstack.flink.sql.enums.ECacheContentType;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.dtstack.flink.sql.side.AsyncReqRow;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import com.dtstack.flink.sql.side.BaseAsyncReqRow;</span>
  26  import com.dtstack.flink.sql.side.FieldInfo;
  27  import com.dtstack.flink.sql.side.JoinInfo;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import com.dtstack.flink.sql.side.SideTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import com.dtstack.flink.sql.side.AbstractSideTableInfo;</span>
  30  import com.dtstack.flink.sql.side.cache.CacheObj;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbsRowKeyModeDealer;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbstractRowKeyModeDealer;</span>
  33  import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  34  import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  35  import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  36  import com.dtstack.flink.sql.factory.DTThreadFactory;
  37  import com.google.common.collect.Maps;
  38  import com.stumbleupon.async.Deferred;

  39  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  40  import org.apache.flink.configuration.Configuration;
  41  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  42  import org.apache.flink.table.runtime.types.CRow;
  43  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  44  import org.apache.flink.types.Row;
  45  import org.hbase.async.HBaseClient;
  46  import org.slf4j.Logger;
  47  import org.slf4j.LoggerFactory;
  48  
  49  import java.sql.Timestamp;
  50  import java.util.Collections;
  51  import java.util.List;
  52  import java.util.Map;
  53  import java.util.concurrent.ExecutorService;
  54  import java.util.concurrent.LinkedBlockingQueue;
  55  import java.util.concurrent.ThreadPoolExecutor;
  56  import java.util.concurrent.TimeUnit;
  57  
  58  /**
  59   * Date: 2018/8/21
  60   * Company: www.dtstack.com
  61   * @author xuchao
  62   */
  63  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -public class HbaseAsyncReqRow extends AsyncReqRow {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +public class HbaseAsyncReqRow extends BaseAsyncReqRow {</span>
  66  
  67      private static final long serialVersionUID = 2098635104857937717L;
  68  
  69      private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  70  
  71      //match to the rule of netty3
  72      private static final int DEFAULT_BOSS_THREADS = 1;
  73  
  74      private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  75  
  76      private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  77  
  78      private transient HBaseClient hBaseClient;
  79  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -    private transient AbsRowKeyModeDealer rowKeyMode;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +    private transient AbstractRowKeyModeDealer rowKeyMode;</span>
  82  
  83      private String tableName;
  84  
  85      private String[] colNames;
  86  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  87 -    public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, SideTableInfo sideTableInfo) {">  87 -    public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, SideTablðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  88 +    public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  88 +    public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractðŸ”µ</abbr></span>
  89          super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  90  
  91          tableName = ((HbaseSideTableInfo)sideTableInfo).getTableName();
  92          colNames = ((HbaseSideTableInfo)sideTableInfo).getColumnRealNames();

  93      }
  94  
  95  
  96      @Override
  97      public void open(Configuration parameters) throws Exception {

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -        SideTableInfo sideTableInfo = sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +        AbstractSideTableInfo sideTableInfo = sideInfo.getSideTableInfo();</span>
 100          HbaseSideTableInfo hbaseSideTableInfo = (HbaseSideTableInfo) sideTableInfo;
 101          ExecutorService executorService =new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE,
 102                  0L, TimeUnit.MILLISECONDS,
 103                  new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));
 104  
<abbr title=" 105          hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), executorService);"> 105          hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), executorServicðŸ”µ</abbr>
 106  
 107          try {
 108              Deferred deferred = hBaseClient.ensureTableExists(tableName)
<abbr title=" 109                      .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()));"> 109                      .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()))ðŸ”µ</abbr>
 110  
 111              CheckResult result = (CheckResult) deferred.join();
 112              if(!result.isConnect()){
 113                  throw new RuntimeException(result.getExceptionMsg());
 114              }
 115  
 116          } catch (Exception e) {
 117              throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
 118          }
 119  
 120          HbaseAsyncSideInfo hbaseAsyncSideInfo = (HbaseAsyncSideInfo) sideInfo;
 121          if(hbaseSideTableInfo.isPreRowKey()){
 122              rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,
 123                      openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 124                      sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 125          }else{
 126              rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,
 127                      openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 128                      sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 129          }
 130      }
 131  
 132      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -        CRow inputCopy = new CRow(input.row(), input.change());</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        Map&lt;String, Object&gt; refData = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -        for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -            Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -            Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -            if(equalObj == null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -                dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -            refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 145 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 145 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) thðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 146 +        rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache());"> 146 +        rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache(ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +    }</span>
 148  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -        String rowKeyStr = ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(refData);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -        //get from cache</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -        if (openCache()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -            CacheObj val = getFromCache(rowKeyStr);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -            if (val != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -                if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -                    dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -                    return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -                } else if (ECacheContentType.SingleLine == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -                    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -                        Row row = fillData(inputCopy.row(), val);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -                        resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -                    } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -                        dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -                } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -                    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -                        for (Object one : (List) val.getContent()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -                            Row row = fillData(inputCopy.row(), one);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -                            resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -                    } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -                        dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -        rowKeyMode.asyncGetData(tableName, rowKeyStr, inputCopy, resultFuture, sideInfo.getSideCache());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +    public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +        return ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(inputParams);</span>
 183      }
 184  
 185      @Override
 186      public Row fillData(Row input, Object sideInput){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -</span>
 188          List&lt;Object&gt; sideInputList = (List&lt;Object&gt;) sideInput;
 189          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 190          for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()){
 191              Object obj = input.getField(entry.getValue());
<abbr title=" 192              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 192              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoðŸ”µ</abbr>
 193  
 194              if(obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo){
 195                  obj = ((Timestamp)obj).getTime();
 196              }
 197  
 198              row.setField(entry.getKey(), obj);
 199          }
 200  
 201          for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()){
 202              if(sideInputList == null){
 203                  row.setField(entry.getKey(), null);
 204              }else{
 205                  row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 206              }
 207          }
 208  
 209          return row;
 210      }
 211  
 212      @Override
 213      public void close() throws Exception {
 214          super.close();
 215          hBaseClient.shutdown();
 216      }
 217  
 218  
 219      class CheckResult{
 220  
 221          private boolean connect;
 222  
 223          private String exceptionMsg;
 224  
 225          CheckResult(boolean connect, String msg){
 226              this.connect = connect;
 227              this.exceptionMsg = msg;
 228          }
 229  
 230          public boolean isConnect() {
 231              return connect;
 232          }
 233  
 234          public void setConnect(boolean connect) {
 235              this.connect = connect;
 236          }
 237  
 238          public String getExceptionMsg() {
 239              return exceptionMsg;
 240          }
 241  
 242          public void setExceptionMsg(String exceptionMsg) {
 243              this.exceptionMsg = exceptionMsg;
 244          }
 245      }
 246  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  
  21  package com.dtstack.flink.sql.side.hbase;
  22  
  23  import com.dtstack.flink.sql.enums.ECacheContentType;
  24  import com.dtstack.flink.sql.side.AsyncReqRow;

  25  import com.dtstack.flink.sql.side.FieldInfo;
  26  import com.dtstack.flink.sql.side.JoinInfo;
  27  import com.dtstack.flink.sql.side.SideTableInfo;

  28  import com.dtstack.flink.sql.side.cache.CacheObj;
  29  import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbsRowKeyModeDealer;

  30  import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  31  import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  32  import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  33  import com.dtstack.flink.sql.factory.DTThreadFactory;
  34  import com.google.common.collect.Maps;
  35  import com.stumbleupon.async.Deferred;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import org.apache.commons.lang3.StringUtils;</span>
  37  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  38  import org.apache.flink.configuration.Configuration;
  39  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  40  import org.apache.flink.table.runtime.types.CRow;
  41  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  42  import org.apache.flink.types.Row;
  43  import org.hbase.async.HBaseClient;
  44  import org.slf4j.Logger;
  45  import org.slf4j.LoggerFactory;
  46  
  47  import java.sql.Timestamp;
  48  import java.util.Collections;
  49  import java.util.List;
  50  import java.util.Map;
  51  import java.util.concurrent.ExecutorService;
  52  import java.util.concurrent.LinkedBlockingQueue;
  53  import java.util.concurrent.ThreadPoolExecutor;
  54  import java.util.concurrent.TimeUnit;
  55  
  56  /**
  57   * Date: 2018/8/21
  58   * Company: www.dtstack.com
  59   * @author xuchao
  60   */
  61  
  62  public class HbaseAsyncReqRow extends AsyncReqRow {

  63  
  64      private static final long serialVersionUID = 2098635104857937717L;
  65  
  66      private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  67  
  68      //match to the rule of netty3
  69      private static final int DEFAULT_BOSS_THREADS = 1;
  70  
  71      private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  72  
  73      private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  74  
  75      private transient HBaseClient hBaseClient;
  76  
  77      private transient AbsRowKeyModeDealer rowKeyMode;

  78  
  79      private String tableName;
  80  
  81      private String[] colNames;
  82  
<abbr title="  83      public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, SideTableInfo sideTableInfo) {">  83      public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, SideTablðŸ”µ</abbr>

  84          super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  85  
  86          tableName = ((HbaseSideTableInfo)sideTableInfo).getTableName();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -        colNames = ((HbaseSideTableInfo)sideTableInfo).getColumnRealNames();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +        colNames =  StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);</span>
  89      }
  90  
  91  
  92      @Override
  93      public void open(Configuration parameters) throws Exception {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +        super.open(parameters);</span>
  95          SideTableInfo sideTableInfo = sideInfo.getSideTableInfo();

  96          HbaseSideTableInfo hbaseSideTableInfo = (HbaseSideTableInfo) sideTableInfo;
  97          ExecutorService executorService =new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE,
  98                  0L, TimeUnit.MILLISECONDS,
  99                  new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));
 100  
<abbr title=" 101          hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), executorService);"> 101          hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), executorServicðŸ”µ</abbr>
 102  
 103          try {
 104              Deferred deferred = hBaseClient.ensureTableExists(tableName)
<abbr title=" 105                      .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()));"> 105                      .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()))ðŸ”µ</abbr>
 106  
 107              CheckResult result = (CheckResult) deferred.join();
 108              if(!result.isConnect()){
 109                  throw new RuntimeException(result.getExceptionMsg());
 110              }
 111  
 112          } catch (Exception e) {
 113              throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
 114          }
 115  
 116          HbaseAsyncSideInfo hbaseAsyncSideInfo = (HbaseAsyncSideInfo) sideInfo;
 117          if(hbaseSideTableInfo.isPreRowKey()){
 118              rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,
 119                      openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 120                      sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 121          }else{
 122              rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,
 123                      openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 124                      sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 125          }
 126      }
 127  
 128      @Override
 129      public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -        CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        CRow inputCopy = new CRow(Row.copy(input.row()), input.change());</span>
 132          Map&lt;String, Object&gt; refData = Maps.newHashMap();
 133          for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {
 134              Integer conValIndex = sideInfo.getEqualValIndex().get(i);
 135              Object equalObj = inputCopy.row().getField(conValIndex);
 136              if(equalObj == null){
 137                  dealMissKey(inputCopy, resultFuture);
 138                  return;
 139              }
 140              refData.put(sideInfo.getEqualFieldList().get(i), equalObj);
 141          }



 142  
 143          String rowKeyStr = ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(refData);
 144  
 145          //get from cache
 146          if (openCache()) {
 147              CacheObj val = getFromCache(rowKeyStr);
 148              if (val != null) {
 149                  if (ECacheContentType.MissVal == val.getType()) {
 150                      dealMissKey(inputCopy, resultFuture);
 151                      return;
 152                  } else if (ECacheContentType.SingleLine == val.getType()) {
 153                      try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -                        Row row = fillData(inputCopy.row(), val);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +                        Row row = fillData(inputCopy.row(), val.getContent());</span>
 156                          resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));
 157                      } catch (Exception e) {
 158                          dealFillDataError(resultFuture, e, inputCopy);
 159                      }
 160                  } else if (ECacheContentType.MultiLine == val.getType()) {
 161                      try {
 162                          for (Object one : (List) val.getContent()) {
 163                              Row row = fillData(inputCopy.row(), one);
 164                              resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));
 165                          }
 166                      } catch (Exception e) {
 167                          dealFillDataError(resultFuture, e, inputCopy);
 168                      }
 169                  }
 170                  return;
 171              }
 172          }
 173  
 174          rowKeyMode.asyncGetData(tableName, rowKeyStr, inputCopy, resultFuture, sideInfo.getSideCache());



 175      }
 176  
 177      @Override
 178      public Row fillData(Row input, Object sideInput){
 179  
 180          List&lt;Object&gt; sideInputList = (List&lt;Object&gt;) sideInput;
 181          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 182          for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()){
 183              Object obj = input.getField(entry.getValue());
<abbr title=" 184              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 184              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoðŸ”µ</abbr>
 185  
 186              if(obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo){
 187                  obj = ((Timestamp)obj).getTime();
 188              }
 189  
 190              row.setField(entry.getKey(), obj);
 191          }
 192  
 193          for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()){
 194              if(sideInputList == null){
 195                  row.setField(entry.getKey(), null);
 196              }else{
 197                  row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 198              }
 199          }
 200  
 201          return row;
 202      }
 203  
 204      @Override
 205      public void close() throws Exception {
 206          super.close();
 207          hBaseClient.shutdown();
 208      }
 209  
 210  
 211      class CheckResult{
 212  
 213          private boolean connect;
 214  
 215          private String exceptionMsg;
 216  
 217          CheckResult(boolean connect, String msg){
 218              this.connect = connect;
 219              this.exceptionMsg = msg;
 220          }
 221  
 222          public boolean isConnect() {
 223              return connect;
 224          }
 225  
 226          public void setConnect(boolean connect) {
 227              this.connect = connect;
 228          }
 229  
 230          public String getExceptionMsg() {
 231              return exceptionMsg;
 232          }
 233  
 234          public void setExceptionMsg(String exceptionMsg) {
 235              this.exceptionMsg = exceptionMsg;
 236          }
 237      }
 238  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            