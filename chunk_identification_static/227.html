<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>227</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    227
                    <a href="226.html">prev</a>
                    <a href="228.html">next</a>
                    <a href="227_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_fd1394d8a0df0583b1f2c7c6fefa993051f65c10_common/src/main/java/org/broadleafcommerce/common/util/tenant/IdentityExecutionUtils.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;fd1394d8a0df0583b1f2c7c6fefa993051f65c10:common/src/main/java/org/broadleafcommerce/common/util/tenant/IdentityExecutionUtils.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;fd1394d8a0df0583b1f2c7c6fefa993051f65c10^1:common/src/main/java/org/broadleafcommerce/common/util/tenant/IdentityExecutionUtils.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;fd1394d8a0df0583b1f2c7c6fefa993051f65c10^2:common/src/main/java/org/broadleafcommerce/common/util/tenant/IdentityExecutionUtils.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;f40b9b4e9d4d9c82000944599b1a359d6f8adba4:common/src/main/java/org/broadleafcommerce/common/util/tenant/IdentityExecutionUtils.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [j], [j], [s], [s]], subset: [[b], [b], [j], [s], [s]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.util.tenant;
  19 
  20 import org.broadleafcommerce.common.site.domain.Catalog;
  21 import org.broadleafcommerce.common.site.domain.Site;
  22 import org.broadleafcommerce.common.util.TransactionUtils;
  23 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  24 import org.springframework.transaction.PlatformTransactionManager;
  25 import org.springframework.transaction.TransactionDefinition;
  26 import org.springframework.transaction.TransactionStatus;
  27 import org.springframework.transaction.support.TransactionSynchronizationManager;
  28 
  29 import java.util.HashMap;
  30 import java.util.Map;
  31 
  32 import javax.persistence.EntityManagerFactory;
  33 import javax.sql.DataSource;
  34 
  35 /**
<abbr title="  36  * The utility methods in this class provide a way to ignore the currently configured site/catalog contexts and instead">  36  * The utility methods in this class provide a way to ignore the currently configured site/catalog contexðŸ”µ</abbr>
  37  * explicitly run operations in the specified context.
  38  * 
  39  * @author Jeff Fischer
  40  */
  41 public class IdentityExecutionUtils {
  42 
<abbr title="  43     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog,">  43     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
<abbr title="  44                                                               PlatformTransactionManager transactionManager) throws G {">  44                                                               PlatformTransactionManager transactionManagðŸ”µ</abbr>
  45         
  46         IdentityUtilContext context = new IdentityUtilContext();
  47         context.setIdentifier(site);
  48         IdentityUtilContext.setUtilContext(context);
  49 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51         BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52         Site previousSite = brc.getSite();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53         Catalog previousCatalog = brc.getCurrentCatalog();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54         Site previousProfile = brc.getCurrentProfile();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55         </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56         boolean isNew = initRequestContext(site, profile, catalog);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57         </span>
  58 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59         IdentityUtilContext context = new IdentityUtilContext();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60         context.setIdentifier(site);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61         IdentityUtilContext.setUtilContext(context);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63         BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64         Site previousSite = brc.getSite();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65         Catalog previousCatalog = brc.getCurrentCatalog();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66         Site previousProfile = brc.getCurrentProfile();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67         </span>
  68 =======
  69 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  70         TransactionContainer container = null;
  71         boolean isError = false;
  72         Site previousSite = null;
  73         Catalog previousCatalog = null;
  74         Site previousProfile = null;
  75         Boolean previousIsIgnoringSite = false;
  76         
  77         BroadleafRequestContext originalBrc = BroadleafRequestContext.getBroadleafRequestContext(false);
  78         if (originalBrc != null) {
  79             previousSite = originalBrc.getNonPersistentSite();
  80             previousCatalog = originalBrc.getCurrentCatalog();
  81             previousProfile = originalBrc.getCurrentProfile();
  82             previousIsIgnoringSite = originalBrc.getIgnoreSite();
  83         }
  84         
  85         boolean isNew = initRequestContext(site, profile, catalog);
  86         
  87         try {
  88             activateSession();
  89             
  90             if (transactionManager != null) {
  91                 container = establishTransaction(transactionManager);
  92             }
  93             
  94             try {
  95                 return operation.execute();
  96             } catch (RuntimeException e) {
  97                 isError = true;
  98                 throw e;
  99             }
 100         } finally {
 101             try {
 102                 if (container != null) {
 103                     finalizeTransaction(transactionManager, container, isError);
 104                 }
 105             } finally {
 106                 IdentityUtilContext.setUtilContext(null);
 107                 if (isNew) {
 108                     BroadleafRequestContext.setBroadleafRequestContext(null);
 109                 } else {
<abbr title=" 110                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);"> 110                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringðŸ”µ</abbr>
<abbr title=" 111                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);"> 111                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSitðŸ”µ</abbr>
<abbr title=" 112                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);"> 112                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCataloðŸ”µ</abbr>
<abbr title=" 113                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);"> 113                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfilðŸ”µ</abbr>
 114                 }
 115             }
 116         }
 117     }
 118 
<abbr title=" 119     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Catalog catalog) throws G {"> 119     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
 120         return runOperationByIdentifier(operation, site, null, catalog, null);
 121     }
 122 
<abbr title=" 123     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog) throws G {"> 123     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
 124         return runOperationByIdentifier(operation, site, profile, catalog, null);
 125     }
 126 
<abbr title=" 127     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site) throws G {"> 127     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
 128         return runOperationByIdentifier(operation, site, null, null, null);
 129     }
 130 
<abbr title=" 131     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile) throws G {"> 131     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
 132         return runOperationByIdentifier(operation, site, profile, null);
 133     }
 134 
<abbr title=" 135     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) throws G {"> 135     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operðŸ”µ</abbr>
 136         return runOperationAndIgnoreIdentifier(operation, null);
 137     }
 138     
<abbr title=" 139     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation, "> 139     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operðŸ”µ</abbr>
 140             PlatformTransactionManager transactionManager) throws G {
 141         //Set up pre-existing state...
 142         BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext(false);
 143         Site previousSite = null;
 144         Catalog previousCatalog = null;
 145         Site previousProfile = null;
 146         Boolean previousIsIgnoringSite = false;
 147         
 148         if (brc != null) {
 149             previousSite = brc.getNonPersistentSite();
 150             previousCatalog = brc.getCurrentCatalog();
 151             previousProfile = brc.getCurrentProfile();
 152             previousIsIgnoringSite = brc.getIgnoreSite();
 153         }
 154         
<abbr title=" 155         //Initialize new state...  This will guaratee that a BroadleafRequestContext is available to this thread."> 155         //Initialize new state...  This will guaratee that a BroadleafRequestContext is available to thisðŸ”µ</abbr>
 156         boolean isNew = initRequestContext(null, null, null);
 157 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158         boolean isIgnoringSite = BroadleafRequestContext.getBroadleafRequestContext().getIgnoreSite();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159         BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);</span>
 160 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161         Catalog previousCatalog = brc.getCurrentCatalog();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162         Site previousProfile = brc.getCurrentProfile();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164         boolean isNew = initRequestContext(null, null, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         boolean isIgnoringSite = BroadleafRequestContext.getBroadleafRequestContext().getIgnoreSite();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166         BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168         activateSession();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170         TransactionContainer container = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         if (transactionManager != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172             container = establishTransaction(transactionManager);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174         boolean isError = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176             return operation.execute();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         } catch (RuntimeException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             isError = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179             throw e;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180         } finally {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181             if (container != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182                 finalizeTransaction(transactionManager, container, isError);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184             </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185             if (isNew) {</span>
 186 =======
 187 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 188         
 189         TransactionContainer container = null;
 190         
 191         boolean isError = false;
 192         try {
 193             BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);
 194 
 195             activateSession();
 196             if (transactionManager != null) {
 197                 container = establishTransaction(transactionManager);
 198             }
 199             
 200             return operation.execute();
 201         } catch (RuntimeException e) {
 202             isError = true;
 203             throw e;
 204         } finally {
 205             try {
 206                 if (container != null) {
 207                     finalizeTransaction(transactionManager, container, isError);
 208                 }
 209             } finally {
 210                 if (isNew) {
 211                     //We just created this, so don&#x27;t leave it lying around.
 212                     BroadleafRequestContext.setBroadleafRequestContext(null);
 213                 } else {
 214                     //Otherwise, reset pre-existing state.
<abbr title=" 215                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);"> 215                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringðŸ”µ</abbr>
<abbr title=" 216                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);"> 216                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSitðŸ”µ</abbr>
<abbr title=" 217                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);"> 217                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCataloðŸ”µ</abbr>
<abbr title=" 218                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);"> 218                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfilðŸ”µ</abbr>
 219                 }
 220             }
 221         }
 222     }
 223 
 224     private static boolean initRequestContext(Site site, Site profile, Catalog catalog) {
 225         boolean isNew = false;
<abbr title=" 226         BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext(false);"> 226         BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext(falseðŸ”µ</abbr>
 227 
 228         if (requestContext == null) {
 229             requestContext = new BroadleafRequestContext();
 230             BroadleafRequestContext.setBroadleafRequestContext(requestContext);
 231             isNew = true;
 232         }
 233 
 234         requestContext.setNonPersistentSite(site);
 235         requestContext.setCurrentCatalog(catalog);
 236         requestContext.setCurrentProfile(profile);
 237         
 238         if (site != null) {
 239             requestContext.setIgnoreSite(false);
 240         }
 241 
 242         return isNew;
 243     }
 244 
<abbr title=" 245     private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionContainer"> 245     private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionConðŸ”µ</abbr>
 246             container, boolean error) {
 247         TransactionUtils.finalizeTransaction(container.status, transactionManager, error);
 248         for (Map.Entry&lt;Object, Object&gt; entry : container.usedResources.entrySet()) {
 249             if (!TransactionSynchronizationManager.hasResource(entry.getKey())) {
 250                 TransactionSynchronizationManager.bindResource(entry.getKey(), entry.getValue());
 251             }
 252         }
 253     }
 254 
<abbr title=" 255     private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManager) {"> 255     private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManageðŸ”µ</abbr>
 256         Map&lt;Object, Object&gt; usedResources = new HashMap&lt;Object, Object&gt;();
 257         Map&lt;Object, Object&gt; resources = TransactionSynchronizationManager.getResourceMap();
 258         for (Map.Entry&lt;Object, Object&gt; entry : resources.entrySet()) {
<abbr title=" 259             if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource) &amp;&amp;"> 259             if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource)ðŸ”µ</abbr>
 260                     TransactionSynchronizationManager.hasResource(entry.getKey())) {
 261                 usedResources.put(entry.getKey(), entry.getValue());
 262             }
 263         }
 264         for (Map.Entry&lt;Object, Object&gt; entry : usedResources.entrySet()) {
 265             TransactionSynchronizationManager.unbindResource(entry.getKey());
 266         }
 267 
 268         TransactionStatus status;
 269         try {
 270             status = TransactionUtils.createTransaction(TransactionDefinition.PROPAGATION_REQUIRES_NEW,
 271                     transactionManager, false);
 272         } catch (RuntimeException e) {
 273             throw e;
 274         }
 275         return new TransactionContainer(status, usedResources);
 276     }
 277 
 278     private static class TransactionContainer {
 279         TransactionStatus status;
 280         Map&lt;Object, Object&gt; usedResources;
 281 
 282         private TransactionContainer(TransactionStatus status, Map&lt;Object, Object&gt; usedResources) {
 283             this.status = status;
 284             this.usedResources = usedResources;
 285         }
 286 
 287         public TransactionStatus getStatus() {
 288             return status;
 289         }
 290 
 291         public void setStatus(TransactionStatus status) {
 292             this.status = status;
 293         }
 294 
 295         public Map&lt;Object, Object&gt; getUsedResources() {
 296             return usedResources;
 297         }
 298 
 299         public void setUsedResources(Map&lt;Object, Object&gt; usedResources) {
 300             this.usedResources = usedResources;
 301         }
 302     }
 303 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.util.tenant;
  19 
  20 import org.broadleafcommerce.common.site.domain.Catalog;
  21 import org.broadleafcommerce.common.site.domain.Site;
  22 import org.broadleafcommerce.common.util.TransactionUtils;
  23 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  24 import org.springframework.transaction.PlatformTransactionManager;
  25 import org.springframework.transaction.TransactionDefinition;
  26 import org.springframework.transaction.TransactionStatus;
  27 import org.springframework.transaction.support.TransactionSynchronizationManager;
  28 
  29 import java.util.HashMap;
  30 import java.util.Map;
  31 
  32 import javax.persistence.EntityManagerFactory;
  33 import javax.sql.DataSource;
  34 
  35 /**
<abbr title="  36  * The utility methods in this class provide a way to ignore the currently configured site/catalog contexts and instead">  36  * The utility methods in this class provide a way to ignore the currently configured site/catalog contexðŸ”µ</abbr>
  37  * explicitly run operations in the specified context.
  38  *
  39  * @author Jeff Fischer
  40  */
  41 public class IdentityExecutionUtils {
  42 
<abbr title="  43     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog,">  43     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
<abbr title="  44                                                               PlatformTransactionManager transactionManager) throws G {">  44                                                               PlatformTransactionManager transactionManagðŸ”µ</abbr>
  45 
  46         IdentityUtilContext context = new IdentityUtilContext();
  47         context.setIdentifier(site);
  48         IdentityUtilContext.setUtilContext(context);
  49         TransactionContainer container = null;
  50         boolean isError = false;
  51         Site previousSite = null;
  52         Catalog previousCatalog = null;
  53         Site previousProfile = null;
  54         Boolean previousIsIgnoringSite = false;
  55 
  56         BroadleafRequestContext originalBrc = BroadleafRequestContext.getBroadleafRequestContext(false);
  57         if (originalBrc != null) {
  58             previousSite = originalBrc.getNonPersistentSite();
  59             previousCatalog = originalBrc.getCurrentCatalog();
  60             previousProfile = originalBrc.getCurrentProfile();
  61             previousIsIgnoringSite = originalBrc.getIgnoreSite();
  62         }
  63 
  64         boolean isNew = initRequestContext(site, profile, catalog);
  65 
  66 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67         TransactionContainer container = null;</span>
  68 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69         activateSession();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71         TransactionContainer container = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72         if (transactionManager != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73             container = establishTransaction(transactionManager);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         boolean isError = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78             return operation.execute();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         } catch (RuntimeException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80             isError = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81             throw e;</span>
  82 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84             activateSession();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85 </span>
  86 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  87         if (transactionManager != null) {
  88             container = establishTransaction(transactionManager);
  89         }
  90 
  91         try {
  92             return operation.execute();
  93         } catch (RuntimeException e) {
  94             isError = true;
  95             throw e;
  96             }
  97         } finally {
  98             try {
  99             if (container != null) {
 100                 finalizeTransaction(transactionManager, container, isError);
 101             }
 102             } finally {
 103             IdentityUtilContext.setUtilContext(null);
 104             if (isNew) {
 105                 BroadleafRequestContext.setBroadleafRequestContext(null);
 106                 } else {
<abbr title=" 107                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);"> 107                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringðŸ”µ</abbr>
<abbr title=" 108                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);"> 108                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSitðŸ”µ</abbr>
 109             BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);
 110             BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);
 111         }
 112     }
 113         }
 114     }
 115 
<abbr title=" 116     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Catalog catalog) throws G {"> 116     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
 117         return runOperationByIdentifier(operation, site, null, catalog, null);
 118     }
 119 
<abbr title=" 120     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog) throws G {"> 120     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
 121         return runOperationByIdentifier(operation, site, profile, catalog, null);
 122     }
 123 
<abbr title=" 124     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site) throws G {"> 124     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
 125         return runOperationByIdentifier(operation, site, null, null, null);
 126     }
 127 
<abbr title=" 128     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile) throws G {"> 128     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
 129         return runOperationByIdentifier(operation, site, profile, null);
 130     }
 131 
<abbr title=" 132     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) throws G {"> 132     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operðŸ”µ</abbr>
 133         return runOperationAndIgnoreIdentifier(operation, null);
 134     }
 135 
<abbr title=" 136     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation,"> 136     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operðŸ”µ</abbr>
 137             PlatformTransactionManager transactionManager) throws G {
 138         //Set up pre-existing state...
 139         BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext(false);
 140         Site previousSite = null;
 141         Catalog previousCatalog = null;
 142         Site previousProfile = null;
 143         Boolean previousIsIgnoringSite = false;
 144 
 145         if (brc != null) {
 146             previousSite = brc.getNonPersistentSite();
 147             previousCatalog = brc.getCurrentCatalog();
 148             previousProfile = brc.getCurrentProfile();
 149             previousIsIgnoringSite = brc.getIgnoreSite();
 150         }
 151 
<abbr title=" 152         //Initialize new state...  This will guaratee that a BroadleafRequestContext is available to this thread."> 152         //Initialize new state...  This will guaratee that a BroadleafRequestContext is available to thisðŸ”µ</abbr>
 153         boolean isNew = initRequestContext(null, null, null);
 154 
 155         TransactionContainer container = null;
 156 
 157         boolean isError = false;
 158         try {
 159         BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);
 160 
 161 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162         TransactionContainer container = null;</span>
 163 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164         activateSession();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166         TransactionContainer container = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         if (transactionManager != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168             container = establishTransaction(transactionManager);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170         boolean isError = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172             return operation.execute();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         } catch (RuntimeException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174             isError = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             throw e;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176         } finally {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177             if (container != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178                 finalizeTransaction(transactionManager, container, isError);</span>
 179 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180             activateSession();</span>
 181 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 182         if (transactionManager != null) {
 183             container = establishTransaction(transactionManager);
 184         }
 185 
 186             return operation.execute();
 187         } catch (RuntimeException e) {
 188             isError = true;
 189             throw e;
 190         } finally {
 191             try {
 192             if (container != null) {
 193                 finalizeTransaction(transactionManager, container, isError);
 194             }
 195             } finally {
 196             if (isNew) {
 197                     //We just created this, so don&#x27;t leave it lying around.
 198                 BroadleafRequestContext.setBroadleafRequestContext(null);
 199                 } else {
 200                     //Otherwise, reset pre-existing state.
<abbr title=" 201                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);"> 201                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringðŸ”µ</abbr>
<abbr title=" 202                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);"> 202                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSitðŸ”µ</abbr>
 203             BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);
 204             BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);
 205         }
 206     }
 207         }
 208     }
 209 
 210     private static boolean initRequestContext(Site site, Site profile, Catalog catalog) {
 211         boolean isNew = false;
<abbr title=" 212         BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext(false);"> 212         BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext(falseðŸ”µ</abbr>
 213 
 214         if (requestContext == null) {
 215             requestContext = new BroadleafRequestContext();
 216             BroadleafRequestContext.setBroadleafRequestContext(requestContext);
 217             isNew = true;
 218         }
 219 
 220         requestContext.setNonPersistentSite(site);
 221         requestContext.setCurrentCatalog(catalog);
 222         requestContext.setCurrentProfile(profile);
 223 
 224         if (site != null) {
 225             requestContext.setIgnoreSite(false);
 226         }
 227 
 228         return isNew;
 229     }
 230 
<abbr title=" 231     private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionContainer"> 231     private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionConðŸ”µ</abbr>
 232             container, boolean error) {
 233         TransactionUtils.finalizeTransaction(container.status, transactionManager, error);
 234         for (Map.Entry&lt;Object, Object&gt; entry : container.usedResources.entrySet()) {
 235             if (!TransactionSynchronizationManager.hasResource(entry.getKey())) {
 236                 TransactionSynchronizationManager.bindResource(entry.getKey(), entry.getValue());
 237             }
 238         }
 239     }
 240 
<abbr title=" 241     private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManager) {"> 241     private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManageðŸ”µ</abbr>
 242         Map&lt;Object, Object&gt; usedResources = new HashMap&lt;Object, Object&gt;();
 243         Map&lt;Object, Object&gt; resources = TransactionSynchronizationManager.getResourceMap();
 244         for (Map.Entry&lt;Object, Object&gt; entry : resources.entrySet()) {
<abbr title=" 245             if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource) &amp;&amp;"> 245             if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource)ðŸ”µ</abbr>
 246                     TransactionSynchronizationManager.hasResource(entry.getKey())) {
 247                 usedResources.put(entry.getKey(), entry.getValue());
 248             }
 249         }
 250         for (Map.Entry&lt;Object, Object&gt; entry : usedResources.entrySet()) {
 251             TransactionSynchronizationManager.unbindResource(entry.getKey());
 252         }
 253 
 254         TransactionStatus status;
 255         try {
 256             status = TransactionUtils.createTransaction(TransactionDefinition.PROPAGATION_REQUIRES_NEW,
 257                     transactionManager, false);
 258         } catch (RuntimeException e) {
 259             throw e;
 260         }
 261         return new TransactionContainer(status, usedResources);
 262     }
 263 
 264     private static class TransactionContainer {
 265         TransactionStatus status;
 266         Map&lt;Object, Object&gt; usedResources;
 267 
 268         private TransactionContainer(TransactionStatus status, Map&lt;Object, Object&gt; usedResources) {
 269             this.status = status;
 270             this.usedResources = usedResources;
 271         }
 272 
 273         public TransactionStatus getStatus() {
 274             return status;
 275         }
 276 
 277         public void setStatus(TransactionStatus status) {
 278             this.status = status;
 279         }
 280 
 281         public Map&lt;Object, Object&gt; getUsedResources() {
 282             return usedResources;
 283         }
 284 
 285         public void setUsedResources(Map&lt;Object, Object&gt; usedResources) {
 286             this.usedResources = usedResources;
 287         }
 288     }
 289 }
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.util.tenant;
  19 
  20 import java.util.HashMap;
  21 import java.util.Map;
  22 import javax.persistence.EntityManagerFactory;
  23 import javax.sql.DataSource;
  24 import org.broadleafcommerce.common.site.domain.Catalog;
  25 import org.broadleafcommerce.common.site.domain.Site;
  26 import org.broadleafcommerce.common.util.TransactionUtils;
  27 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  28 import org.springframework.transaction.PlatformTransactionManager;
  29 import org.springframework.transaction.TransactionDefinition;
  30 import org.springframework.transaction.TransactionStatus;
  31 import org.springframework.transaction.support.TransactionSynchronizationManager;
  32 
  33 
  34 /**
<abbr title="  35  * The utility methods in this class provide a way to ignore the currently configured site/catalog contexts and instead">  35  * The utility methods in this class provide a way to ignore the currently configured site/catalog contexðŸ”µ</abbr>
  36  * explicitly run operations in the specified context.
  37  *
  38  * @author Jeff Fischer
  39  */
  40 public class IdentityExecutionUtils {
<abbr title="  41     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog, PlatformTransactionManager transactionManager) throws G {">  41     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
  42 
<abbr title="  43                                                                     IdentityUtilContext context = new IdentityUtilContext();">  43                                                                     IdentityUtilContext context = new IdeðŸ”µ</abbr>
  44                                                                     context.setIdentifier(site);
<abbr title="  45                                                                     IdentityUtilContext.setUtilContext(context);">  45                                                                     IdentityUtilContext.setUtilContext(coðŸ”µ</abbr>
<abbr title="  46                                                                     TransactionContainer container = null;">  46                                                                     TransactionContainer container = nullðŸ”µ</abbr>
  47                                                                     boolean isError = false;
  48                                                                     Site previousSite = null;
  49                                                                     Catalog previousCatalog = null;
  50                                                                     Site previousProfile = null;
<abbr title="  51                                                                     Boolean previousIsIgnoringSite = false;">  51                                                                     Boolean previousIsIgnoringSite = falsðŸ”µ</abbr>
  52 
<abbr title="  53                                                                     BroadleafRequestContext originalBrc = BroadleafRequestContext.getBroadleafRequestContext(false);">  53                                                                     BroadleafRequestContext originalBrc =ðŸ”µ</abbr>
  54                                                                     if (originalBrc != null) {
<abbr title="  55                                                                         previousSite = originalBrc.getNonPersistentSite();">  55                                                                         previousSite = originalBrc.getNonðŸ”µ</abbr>
<abbr title="  56                                                                         previousCatalog = originalBrc.getCurrentCatalog();">  56                                                                         previousCatalog = originalBrc.getðŸ”µ</abbr>
<abbr title="  57                                                                         previousProfile = originalBrc.getCurrentProfile();">  57                                                                         previousProfile = originalBrc.getðŸ”µ</abbr>
<abbr title="  58                                                                         previousIsIgnoringSite = originalBrc.getIgnoreSite();">  58                                                                         previousIsIgnoringSite = originalðŸ”µ</abbr>
  59                                                                     }
  60 
<abbr title="  61                                                                     boolean isNew = initRequestContext(site, profile, catalog);">  61                                                                     boolean isNew = initRequestContext(siðŸ”µ</abbr>
  62 
  63 
  64 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  65                                                                     TransactionContainer container = null;">  65                                                                     TransactionContainer container = nullðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66                                                                     if (transactionManager != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  67                                                                         container = establishTransaction(transactionManager);">  67                                                                         container = establishTransaction(ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68                                                                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70                                                                     boolean isError = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71 </span>
  72 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  73 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  73 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
  74 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76 </span>
  77 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
  78                                                                     try {
  79                                                                         activateSession();
  80 
  81                                                                         if (transactionManager != null) {
<abbr title="  82                                                                             container = establishTransaction(transactionManager);">  82                                                                             container = establishTransactðŸ”µ</abbr>
  83                                                                         }
  84 
  85                                                                         try {
  86                                                                             return operation.execute();
  87                                                                         } catch (RuntimeException e) {
  88                                                                             isError = true;
  89                                                                             throw e;
  90                                                                         }
  91                                                                     } finally {
  92                                                                         try {
  93                                                                             if (container != null) {
<abbr title="  94                                                                                 finalizeTransaction(transactionManager, container, isError);">  94                                                                                 finalizeTransaction(transðŸ”µ</abbr>
  95                                                                             }
  96                                                                         } finally {
<abbr title="  97                                                                             IdentityUtilContext.setUtilContext(null);">  97                                                                             IdentityUtilContext.setUtilCoðŸ”µ</abbr>
  98                                                                             if (isNew) {
<abbr title="  99                                                                                 BroadleafRequestContext.setBroadleafRequestContext(null);">  99                                                                                 BroadleafRequestContext.sðŸ”µ</abbr>
 100                                                                             } else {
<abbr title=" 101                                                                                 BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);"> 101                                                                                 BroadleafRequestContext.gðŸ”µ</abbr>
<abbr title=" 102                                                                                 BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);"> 102                                                                                 BroadleafRequestContext.gðŸ”µ</abbr>
<abbr title=" 103                                                                                 BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);"> 103                                                                                 BroadleafRequestContext.gðŸ”µ</abbr>
<abbr title=" 104                                                                                 BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);"> 104                                                                                 BroadleafRequestContext.gðŸ”µ</abbr>
 105                                                                             }
 106                                                                         }
 107                                                                     }
 108                                                                 }
 109 
<abbr title=" 110     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Catalog catalog) throws G {"> 110     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
 111         return runOperationByIdentifier(operation, site, null, catalog, null);
 112     }
 113 
<abbr title=" 114     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog) throws G {"> 114     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
 115         return runOperationByIdentifier(operation, site, profile, catalog, null);
 116     }
 117 
<abbr title=" 118     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site) throws G {"> 118     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
 119         return runOperationByIdentifier(operation, site, null, null, null);
 120     }
 121 
<abbr title=" 122     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile) throws G {"> 122     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr>
 123         return runOperationByIdentifier(operation, site, profile, null);
 124     }
 125 
<abbr title=" 126     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) throws G {"> 126     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operðŸ”µ</abbr>
 127         return runOperationAndIgnoreIdentifier(operation, null);
 128     }
 129 
<abbr title=" 130     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation, PlatformTransactionManager transactionManager) throws G {"> 130     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operðŸ”µ</abbr>
 131         //Set up pre-existing state...
 132         BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext(false);
 133         Site previousSite = null;
 134         Catalog previousCatalog = null;
 135         Site previousProfile = null;
 136         Boolean previousIsIgnoringSite = false;
 137 
 138 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139         BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);</span>
 140 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 141 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 141 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 142 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144         boolean isNew = initRequestContext(null, null, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145         boolean isIgnoringSite = BroadleafRequestContext.getBroadleafRequestContext().getIgnoreSite();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146         BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148         activateSession();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150         TransactionContainer container = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151         if (transactionManager != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152             container = establishTransaction(transactionManager);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154         boolean isError = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156             return operation.execute();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157         } catch (RuntimeException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158             isError = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159             throw e;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160         } finally {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161             if (container != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162                 finalizeTransaction(transactionManager, container, isError);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165 </span>
 166 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 167 
 168         TransactionContainer container = null;
 169         boolean isError = false;
 170         try {
 171             BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);
 172             activateSession();
 173             if (transactionManager != null) {
 174                 container = establishTransaction(transactionManager);
 175             }
 176             return operation.execute();
 177         } catch (java.lang.RuntimeException e) {
 178             isError = true;
 179             throw e;
 180         } finally {
 181             try {
 182                 if (container != null) {
 183                     finalizeTransaction(transactionManager, container, isError);
 184                 }
 185             } finally {
 186                 if (isNew) {
 187                     //We just created this, so don&#x27;t leave it lying around.
 188                     BroadleafRequestContext.setBroadleafRequestContext(null);
 189                 } else {
 190                     //Otherwise, reset pre-existing state.
<abbr title=" 191                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);"> 191                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringðŸ”µ</abbr>
<abbr title=" 192                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);"> 192                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSitðŸ”µ</abbr>
<abbr title=" 193                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);"> 193                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCataloðŸ”µ</abbr>
<abbr title=" 194                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);"> 194                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfilðŸ”µ</abbr>
 195                 }
 196             }
 197         }
 198     }
 199 
 200     private static boolean initRequestContext(Site site, Site profile, Catalog catalog) {
 201         boolean isNew = false;
<abbr title=" 202         BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext(false);"> 202         BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext(falseðŸ”µ</abbr>
 203         if (requestContext == null) {
 204             requestContext = new BroadleafRequestContext();
 205             BroadleafRequestContext.setBroadleafRequestContext(requestContext);
 206             isNew = true;
 207         }
 208         requestContext.setNonPersistentSite(site);
 209         requestContext.setCurrentCatalog(catalog);
 210         requestContext.setCurrentProfile(profile);
 211         if (site != null) {
 212             requestContext.setIgnoreSite(false);
 213         }
 214         return isNew;
 215     }
 216 
<abbr title=" 217     private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionContainer"> 217     private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionConðŸ”µ</abbr>
 218             container, boolean error) {
 219         TransactionUtils.finalizeTransaction(container.status, transactionManager, error);
 220         for (Map.Entry&lt;Object, Object&gt; entry : container.usedResources.entrySet()) {
 221             if (!TransactionSynchronizationManager.hasResource(entry.getKey())) {
 222                 TransactionSynchronizationManager.bindResource(entry.getKey(), entry.getValue());
 223             }
 224         }
 225     }
 226 
<abbr title=" 227     private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManager) {"> 227     private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManageðŸ”µ</abbr>
 228         Map&lt;Object, Object&gt; usedResources = new HashMap&lt;Object, Object&gt;();
 229         Map&lt;Object, Object&gt; resources = TransactionSynchronizationManager.getResourceMap();
 230         for (Map.Entry&lt;Object, Object&gt; entry : resources.entrySet()) {
<abbr title=" 231             if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource) &amp;&amp;"> 231             if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource)ðŸ”µ</abbr>
 232                     TransactionSynchronizationManager.hasResource(entry.getKey())) {
 233                 usedResources.put(entry.getKey(), entry.getValue());
 234             }
 235         }
 236         for (Map.Entry&lt;Object, Object&gt; entry : usedResources.entrySet()) {
 237             TransactionSynchronizationManager.unbindResource(entry.getKey());
 238         }
 239 
 240         TransactionStatus status;
 241         try {
 242             status = TransactionUtils.createTransaction(TransactionDefinition.PROPAGATION_REQUIRES_NEW,
 243                     transactionManager, false);
 244         } catch (RuntimeException e) {
 245             throw e;
 246         }
 247         return new TransactionContainer(status, usedResources);
 248     }
 249 
 250     private static class TransactionContainer {
 251         TransactionStatus status;
 252 
 253         Map&lt;Object, Object&gt; usedResources;
 254 
 255         private TransactionContainer(TransactionStatus status, Map&lt;Object, Object&gt; usedResources) {
 256             this.status = status;
 257             this.usedResources = usedResources;
 258         }
 259 
 260         public TransactionStatus getStatus() {
 261             return status;
 262         }
 263 
 264         public void setStatus(TransactionStatus status) {
 265             this.status = status;
 266         }
 267 
 268         public Map&lt;Object, Object&gt; getUsedResources() {
 269             return usedResources;
 270         }
 271 
 272         public void setUsedResources(Map&lt;Object, Object&gt; usedResources) {
 273             this.usedResources = usedResources;
 274         }
 275     }
 276 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.util.tenant;
  19  
  20  import org.apache.commons.logging.Log;
  21  import org.apache.commons.logging.LogFactory;
  22  import org.broadleafcommerce.common.site.domain.Catalog;
  23  import org.broadleafcommerce.common.site.domain.Site;
  24  import org.broadleafcommerce.common.util.TransactionUtils;
  25  import org.broadleafcommerce.common.web.BroadleafRequestContext;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.hibernate.ejb.HibernateEntityManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import org.springframework.orm.jpa.EntityManagerHolder;</span>
  28  import org.springframework.transaction.PlatformTransactionManager;
  29  import org.springframework.transaction.TransactionDefinition;
  30  import org.springframework.transaction.TransactionStatus;
  31  import org.springframework.transaction.support.TransactionSynchronizationManager;
  32  
  33  import java.util.HashMap;
  34  import java.util.Map;
  35  
  36  import javax.persistence.EntityManagerFactory;
  37  import javax.sql.DataSource;
  38  
  39  /**
<abbr title="  40   * The utility methods in this class provide a way to ignore the currently configured site/catalog contexts and instead">  40   * The utility methods in this class provide a way to ignore the currently configured site/catalog contexts and inðŸ”µ</abbr>
  41   * explicitly run operations in the specified context.
  42   *
  43   * @author Jeff Fischer
  44   */
  45  public class IdentityExecutionUtils {
  46  
  47      private static final Log LOG = LogFactory.getLog(IdentityExecutionUtils.class);
  48  
<abbr title="  49      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog,">  49      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr>
<abbr title="  50                                                                PlatformTransactionManager transactionManager) throws G {">  50                                                                PlatformTransactionManager transactionManager) throwðŸ”µ</abbr>

  51          IdentityUtilContext context = new IdentityUtilContext();
  52          context.setIdentifier(site);
  53          IdentityUtilContext.setUtilContext(context);
  54  
  55          BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();
  56          Site previousSite = brc.getSite();
  57          Catalog previousCatalog = brc.getCurrentCatalog();
  58          Site previousProfile = brc.getCurrentProfile();














  59  
  60          boolean isNew = initRequestContext(site, profile, catalog);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -        activateSession();</span>






































































  63  
  64          TransactionContainer container = null;
  65          if (transactionManager != null) {
  66              container = establishTransaction(transactionManager);
  67          }
  68  
  69          boolean isError = false;
  70          try {







  71              return operation.execute();
  72          } catch (RuntimeException e) {
  73              isError = true;
  74              throw e;
  75          } finally {
  76              if (container != null) {
  77                  finalizeTransaction(transactionManager, container, isError);
  78              }
  79              IdentityUtilContext.setUtilContext(null);
  80              if (isNew) {
  81                  BroadleafRequestContext.setBroadleafRequestContext(null);
  82              }
  83              BroadleafRequestContext.getBroadleafRequestContext().setSite(previousSite);
  84              BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);
  85              BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);
  86          }
  87      }
  88  
<abbr title="  89      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Catalog catalog) throws G {">  89      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr>
  90          return runOperationByIdentifier(operation, site, null, catalog, null);
  91      }
  92  
<abbr title="  93      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog) throws G {">  93      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr>
  94          return runOperationByIdentifier(operation, site, profile, catalog, null);
  95      }
  96  
<abbr title="  97      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site) throws G {">  97      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr>
  98          return runOperationByIdentifier(operation, site, null, null, null);
  99      }
 100  
<abbr title=" 101      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile) throws G {"> 101      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr>
 102          return runOperationByIdentifier(operation, site, profile, null);
 103      }
 104  
<abbr title=" 105      public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) throws G {"> 105      public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) thðŸ”µ</abbr>
 106          return runOperationAndIgnoreIdentifier(operation, null);
 107      }
 108  
 109      public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation,
 110              PlatformTransactionManager transactionManager) throws G {
 111          BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();
 112          Site previousSite = brc.getSite();
 113          Catalog previousCatalog = brc.getCurrentCatalog();
 114          Site previousProfile = brc.getCurrentProfile();
 115  
 116          boolean isNew = initRequestContext(null, null, null);
 117          boolean isIgnoringSite = BroadleafRequestContext.getBroadleafRequestContext().getIgnoreSite();
 118          BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);
 119  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -        activateSession();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -</span>
 122          TransactionContainer container = null;
 123          if (transactionManager != null) {
 124              container = establishTransaction(transactionManager);
 125          }
 126          boolean isError = false;
 127          try {
 128              return operation.execute();
 129          } catch (RuntimeException e) {
 130              isError = true;
 131              throw e;
 132          } finally {
 133              if (container != null) {
 134                  finalizeTransaction(transactionManager, container, isError);
 135              }
 136  
 137              if (isNew) {
 138                  BroadleafRequestContext.setBroadleafRequestContext(null);
 139              }
 140              BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(isIgnoringSite);
 141              BroadleafRequestContext.getBroadleafRequestContext().setSite(previousSite);
 142              BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);
 143              BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);
















 144          }
 145      }
 146  
 147      private static boolean initRequestContext(Site site, Site profile, Catalog catalog) {
 148          boolean isNew = false;
 149          BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext();

 150  
 151          if (requestContext == null) {
 152              requestContext = new BroadleafRequestContext();
 153              BroadleafRequestContext.setBroadleafRequestContext(requestContext);
 154              isNew = true;
 155          }
 156  
 157          requestContext.setSite(site);

 158          requestContext.setCurrentCatalog(catalog);
 159          requestContext.setCurrentProfile(profile);
 160  
 161          if (site != null) {
 162              requestContext.setIgnoreSite(false);
 163          }
 164  
 165          return isNew;
 166      }
 167  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -    private static void activateSession() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -        Map&lt;Object, Object&gt; resourceMap = TransactionSynchronizationManager.getResourceMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -        for (Map.Entry&lt;Object, Object&gt; entry : resourceMap.entrySet()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 171 -            if (entry.getKey() instanceof EntityManagerFactory &amp;&amp; entry.getValue() instanceof EntityManagerHolder) {"> 171 -            if (entry.getKey() instanceof EntityManagerFactory &amp;&amp; entry.getValue() instanceof EntityManagerHolder)ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 172 -                ((HibernateEntityManager) ((EntityManagerHolder) entry.getValue()).getEntityManager()).getSession();"> 172 -                ((HibernateEntityManager) ((EntityManagerHolder) entry.getValue()).getEntityManager()).getSession(ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -</span>
 177      private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionContainer
 178              container, boolean error) {
 179          TransactionUtils.finalizeTransaction(container.status, transactionManager, error);
 180          for (Map.Entry&lt;Object, Object&gt; entry : container.usedResources.entrySet()) {
 181              if (!TransactionSynchronizationManager.hasResource(entry.getKey())) {
 182                  TransactionSynchronizationManager.bindResource(entry.getKey(), entry.getValue());
 183              }
 184          }
 185      }
 186  
 187      private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManager) {
 188          Map&lt;Object, Object&gt; usedResources = new HashMap&lt;Object, Object&gt;();
 189          Map&lt;Object, Object&gt; resources = TransactionSynchronizationManager.getResourceMap();
 190          for (Map.Entry&lt;Object, Object&gt; entry : resources.entrySet()) {
 191              if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource) &amp;&amp;
 192                      TransactionSynchronizationManager.hasResource(entry.getKey())) {
 193                  usedResources.put(entry.getKey(), entry.getValue());
 194              }
 195          }
 196          for (Map.Entry&lt;Object, Object&gt; entry : usedResources.entrySet()) {
 197              TransactionSynchronizationManager.unbindResource(entry.getKey());
 198          }
 199  
 200          TransactionStatus status;
 201          try {
 202              status = TransactionUtils.createTransaction(TransactionDefinition.PROPAGATION_REQUIRES_NEW,
 203                      transactionManager, false);
 204          } catch (RuntimeException e) {
 205              throw e;
 206          }
 207          return new TransactionContainer(status, usedResources);
 208      }
 209  
 210      private static class TransactionContainer {
 211          TransactionStatus status;
 212          Map&lt;Object, Object&gt; usedResources;
 213  
 214          private TransactionContainer(TransactionStatus status, Map&lt;Object, Object&gt; usedResources) {
 215              this.status = status;
 216              this.usedResources = usedResources;
 217          }
 218  
 219          public TransactionStatus getStatus() {
 220              return status;
 221          }
 222  
 223          public void setStatus(TransactionStatus status) {
 224              this.status = status;
 225          }
 226  
 227          public Map&lt;Object, Object&gt; getUsedResources() {
 228              return usedResources;
 229          }
 230  
 231          public void setUsedResources(Map&lt;Object, Object&gt; usedResources) {
 232              this.usedResources = usedResources;
 233          }
 234      }
 235  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.util.tenant;
  19  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import org.apache.commons.logging.LogFactory;</span>
  22  import org.broadleafcommerce.common.site.domain.Catalog;
  23  import org.broadleafcommerce.common.site.domain.Site;
  24  import org.broadleafcommerce.common.util.TransactionUtils;
  25  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  26  import org.hibernate.ejb.HibernateEntityManager;
  27  import org.springframework.orm.jpa.EntityManagerHolder;
  28  import org.springframework.transaction.PlatformTransactionManager;
  29  import org.springframework.transaction.TransactionDefinition;
  30  import org.springframework.transaction.TransactionStatus;
  31  import org.springframework.transaction.support.TransactionSynchronizationManager;
  32  
  33  import java.util.HashMap;
  34  import java.util.Map;
  35  
  36  import javax.persistence.EntityManagerFactory;
  37  import javax.sql.DataSource;
  38  
  39  /**
<abbr title="  40   * The utility methods in this class provide a way to ignore the currently configured site/catalog contexts and instead">  40   * The utility methods in this class provide a way to ignore the currently configured site/catalog contexts and inðŸ”µ</abbr>
  41   * explicitly run operations in the specified context.
  42   *
  43   * @author Jeff Fischer
  44   */
  45  public class IdentityExecutionUtils {
  46  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -    private static final Log LOG = LogFactory.getLog(IdentityExecutionUtils.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -</span>
<abbr title="  49      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog,">  49      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr>
<abbr title="  50                                                                PlatformTransactionManager transactionManager) throws G {">  50                                                                PlatformTransactionManager transactionManager) throwðŸ”µ</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +</span>
  52          IdentityUtilContext context = new IdentityUtilContext();
  53          context.setIdentifier(site);
  54          IdentityUtilContext.setUtilContext(context);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -        BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -        Site previousSite = brc.getSite();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -        Catalog previousCatalog = brc.getCurrentCatalog();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -        Site previousProfile = brc.getCurrentProfile();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +        TransactionContainer container = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +        boolean isError = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +        Site previousSite = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +        Catalog previousCatalog = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +        Site previousProfile = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +        Boolean previousIsIgnoringSite = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +        BroadleafRequestContext originalBrc = BroadleafRequestContext.getBroadleafRequestContext(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +        if (originalBrc != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +            previousSite = originalBrc.getNonPersistentSite();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +            previousCatalog = originalBrc.getCurrentCatalog();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +            previousProfile = originalBrc.getCurrentProfile();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +            previousIsIgnoringSite = originalBrc.getIgnoreSite();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +        }</span>
  74  
  75          boolean isNew = initRequestContext(site, profile, catalog);
  76  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -        activateSession();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +            activateSession();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +            if (transactionManager != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +                container = establishTransaction(transactionManager);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +                return operation.execute();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +            } catch (RuntimeException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +                isError = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +                throw e;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +        } finally {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +                if (container != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +                    finalizeTransaction(transactionManager, container, isError);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +            } finally {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +                IdentityUtilContext.setUtilContext(null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +                if (isNew) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +                    BroadleafRequestContext.setBroadleafRequestContext(null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +                    BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +                    BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +                    BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +                    BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 110 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Catalog catalog) throws G {"> 110 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +        return runOperationByIdentifier(operation, site, null, catalog, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 114 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog) throws G {"> 114 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +        return runOperationByIdentifier(operation, site, profile, catalog, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 118 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site) throws G {"> 118 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        return runOperationByIdentifier(operation, site, null, null, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 122 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile) throws G {"> 122 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +        return runOperationByIdentifier(operation, site, profile, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 126 +    public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) throws G {"> 126 +    public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) thðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +        return runOperationAndIgnoreIdentifier(operation, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +    public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +            PlatformTransactionManager transactionManager) throws G {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +        //Set up pre-existing state...</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +        BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +        Site previousSite = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +        Catalog previousCatalog = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +        Site previousProfile = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +        Boolean previousIsIgnoringSite = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +        if (brc != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +            previousSite = brc.getNonPersistentSite();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +            previousCatalog = brc.getCurrentCatalog();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +            previousProfile = brc.getCurrentProfile();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +            previousIsIgnoringSite = brc.getIgnoreSite();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +        //Initialize new state...  This will guaratee that a BroadleafRequestContext is available to this thread.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +        boolean isNew = initRequestContext(null, null, null);</span>
 148  
 149          TransactionContainer container = null;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -        if (transactionManager != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -            container = establishTransaction(transactionManager);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -        }</span>
 153  
 154          boolean isError = false;
 155          try {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +            BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +            activateSession();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +            if (transactionManager != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +                container = establishTransaction(transactionManager);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +</span>
 163              return operation.execute();
 164          } catch (RuntimeException e) {
 165              isError = true;
 166              throw e;
 167          } finally {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -            if (container != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -                finalizeTransaction(transactionManager, container, isError);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -            IdentityUtilContext.setUtilContext(null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -            if (isNew) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -                BroadleafRequestContext.setBroadleafRequestContext(null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -            BroadleafRequestContext.getBroadleafRequestContext().setSite(previousSite);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -            BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -            BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 181 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Catalog catalog) throws G {"> 181 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -        return runOperationByIdentifier(operation, site, null, catalog, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 185 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog) throws G {"> 185 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -        return runOperationByIdentifier(operation, site, profile, catalog, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 189 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site) throws G {"> 189 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -        return runOperationByIdentifier(operation, site, null, null, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 193 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile) throws G {"> 193 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -        return runOperationByIdentifier(operation, site, profile, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 197 -    public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) throws G {"> 197 -    public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) thðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -        return runOperationAndIgnoreIdentifier(operation, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -    public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -            PlatformTransactionManager transactionManager) throws G {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -        BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -        Site previousSite = brc.getSite();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -        Catalog previousCatalog = brc.getCurrentCatalog();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -        Site previousProfile = brc.getCurrentProfile();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -        boolean isNew = initRequestContext(null, null, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -        boolean isIgnoringSite = BroadleafRequestContext.getBroadleafRequestContext().getIgnoreSite();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -        BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -        activateSession();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -        TransactionContainer container = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -        if (transactionManager != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -            container = establishTransaction(transactionManager);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -        boolean isError = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -            return operation.execute();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -        } catch (RuntimeException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -            isError = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -            throw e;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -        } finally {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -            if (container != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -                finalizeTransaction(transactionManager, container, isError);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -            if (isNew) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -                BroadleafRequestContext.setBroadleafRequestContext(null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -            BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(isIgnoringSite);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -            BroadleafRequestContext.getBroadleafRequestContext().setSite(previousSite);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -            BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -            BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +                if (container != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +                    finalizeTransaction(transactionManager, container, isError);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +            } finally {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +                if (isNew) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +                    //We just created this, so don&#x27;t leave it lying around.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +                    BroadleafRequestContext.setBroadleafRequestContext(null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +                    //Otherwise, reset pre-existing state.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +                    BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +                    BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +                    BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +                    BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +            }</span>
 252          }
 253      }
 254  
 255      private static boolean initRequestContext(Site site, Site profile, Catalog catalog) {
 256          boolean isNew = false;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -        BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +        BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext(false);</span>
 259  
 260          if (requestContext == null) {
 261              requestContext = new BroadleafRequestContext();
 262              BroadleafRequestContext.setBroadleafRequestContext(requestContext);
 263              isNew = true;
 264          }
 265  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -        requestContext.setSite(site);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +        requestContext.setNonPersistentSite(site);</span>
 268          requestContext.setCurrentCatalog(catalog);
 269          requestContext.setCurrentProfile(profile);
 270  
 271          if (site != null) {
 272              requestContext.setIgnoreSite(false);
 273          }
 274  
 275          return isNew;
 276      }
 277  
 278      private static void activateSession() {
 279          Map&lt;Object, Object&gt; resourceMap = TransactionSynchronizationManager.getResourceMap();
 280          for (Map.Entry&lt;Object, Object&gt; entry : resourceMap.entrySet()) {
<abbr title=" 281              if (entry.getKey() instanceof EntityManagerFactory &amp;&amp; entry.getValue() instanceof EntityManagerHolder) {"> 281              if (entry.getKey() instanceof EntityManagerFactory &amp;&amp; entry.getValue() instanceof EntityManagerHolder)ðŸ”µ</abbr>
<abbr title=" 282                  ((HibernateEntityManager) ((EntityManagerHolder) entry.getValue()).getEntityManager()).getSession();"> 282                  ((HibernateEntityManager) ((EntityManagerHolder) entry.getValue()).getEntityManager()).getSession(ðŸ”µ</abbr>
 283              }
 284          }
 285      }
 286  
 287      private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionContainer
 288              container, boolean error) {
 289          TransactionUtils.finalizeTransaction(container.status, transactionManager, error);
 290          for (Map.Entry&lt;Object, Object&gt; entry : container.usedResources.entrySet()) {
 291              if (!TransactionSynchronizationManager.hasResource(entry.getKey())) {
 292                  TransactionSynchronizationManager.bindResource(entry.getKey(), entry.getValue());
 293              }
 294          }
 295      }
 296  
 297      private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManager) {
 298          Map&lt;Object, Object&gt; usedResources = new HashMap&lt;Object, Object&gt;();
 299          Map&lt;Object, Object&gt; resources = TransactionSynchronizationManager.getResourceMap();
 300          for (Map.Entry&lt;Object, Object&gt; entry : resources.entrySet()) {
 301              if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource) &amp;&amp;
 302                      TransactionSynchronizationManager.hasResource(entry.getKey())) {
 303                  usedResources.put(entry.getKey(), entry.getValue());
 304              }
 305          }
 306          for (Map.Entry&lt;Object, Object&gt; entry : usedResources.entrySet()) {
 307              TransactionSynchronizationManager.unbindResource(entry.getKey());
 308          }
 309  
 310          TransactionStatus status;
 311          try {
 312              status = TransactionUtils.createTransaction(TransactionDefinition.PROPAGATION_REQUIRES_NEW,
 313                      transactionManager, false);
 314          } catch (RuntimeException e) {
 315              throw e;
 316          }
 317          return new TransactionContainer(status, usedResources);
 318      }
 319  
 320      private static class TransactionContainer {
 321          TransactionStatus status;
 322          Map&lt;Object, Object&gt; usedResources;
 323  
 324          private TransactionContainer(TransactionStatus status, Map&lt;Object, Object&gt; usedResources) {
 325              this.status = status;
 326              this.usedResources = usedResources;
 327          }
 328  
 329          public TransactionStatus getStatus() {
 330              return status;
 331          }
 332  
 333          public void setStatus(TransactionStatus status) {
 334              this.status = status;
 335          }
 336  
 337          public Map&lt;Object, Object&gt; getUsedResources() {
 338              return usedResources;
 339          }
 340  
 341          public void setUsedResources(Map&lt;Object, Object&gt; usedResources) {
 342              this.usedResources = usedResources;
 343          }
 344      }
 345  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            