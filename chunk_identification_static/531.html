<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>531</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    531
                    <a href="530.html">prev</a>
                    <a href="532.html">next</a>
                    <a href="531_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_f389ba111b6d691ecd5b0f2b8c9c050a03e595ad_core/src/main/java/com/dtstack/flink/sql/Main.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;f389ba111b6d691ecd5b0f2b8c9c050a03e595ad:core/src/main/java/com/dtstack/flink/sql/Main.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;f389ba111b6d691ecd5b0f2b8c9c050a03e595ad^1:core/src/main/java/com/dtstack/flink/sql/Main.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;f389ba111b6d691ecd5b0f2b8c9c050a03e595ad^2:core/src/main/java/com/dtstack/flink/sql/Main.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;7c3f0a268d1fad776168ebb3b721653f7043ca97:core/src/main/java/com/dtstack/flink/sql/Main.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [b], [j], [j]], subset: [[b], [b], [b], [bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql;
  21 
  22 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 </span>
  25 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import com.dtstack.flink.sql.config.CalciteConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import com.dtstack.flink.sql.classloader.ClassLoaderManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import com.dtstack.flink.sql.enums.ECacheType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import com.dtstack.flink.sql.environment.StreamEnvConfigManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import com.dtstack.flink.sql.exec.FlinkSQLExec;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import com.dtstack.flink.sql.option.OptionParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import com.dtstack.flink.sql.parser.CreateFuncParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import com.dtstack.flink.sql.parser.CreateTmpTableParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import com.dtstack.flink.sql.parser.InsertSqlParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import com.dtstack.flink.sql.parser.SqlParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import com.dtstack.flink.sql.parser.SqlTree;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import com.dtstack.flink.sql.side.SideSqlExec;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import com.dtstack.flink.sql.side.SideTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import com.dtstack.flink.sql.table.SourceTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import com.dtstack.flink.sql.table.TableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import com.dtstack.flink.sql.table.TargetTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61 import org.apache.flink.streaming.api.datastream.DataStream;</span>
  62 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63 import com.dtstack.flink.sql.classloader.ClassLoaderManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64 import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65 import com.dtstack.flink.sql.enums.ECacheType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66 import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67 import com.dtstack.flink.sql.environment.StreamEnvConfigManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68 import com.dtstack.flink.sql.exec.FlinkSQLExec;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69 import com.dtstack.flink.sql.option.OptionParser;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70 import com.dtstack.flink.sql.parser.CreateFuncParser;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71 import com.dtstack.flink.sql.parser.CreateTmpTableParser;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72 import com.dtstack.flink.sql.parser.FlinkPlanner;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73 import com.dtstack.flink.sql.parser.InsertSqlParser;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74 import com.dtstack.flink.sql.parser.SqlParser;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75 import com.dtstack.flink.sql.parser.SqlTree;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76 import com.dtstack.flink.sql.side.SideSqlExec;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77 import com.dtstack.flink.sql.side.SideTableInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78 import com.dtstack.flink.sql.table.SourceTableInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79 import com.dtstack.flink.sql.table.TableInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80 import com.dtstack.flink.sql.table.TargetTableInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81 import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82 import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83 import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84 import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85 import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87 import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88 import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96 import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97 import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98 import org.apache.flink.streaming.api.datastream.DataStream;</span>
  99 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 100 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
 101 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103 import com.dtstack.flink.sql.exec.ExecuteProcessHelper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104 import com.dtstack.flink.sql.exec.ParamsInfo;</span>
 105 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106 import com.dtstack.flink.sql.enums.ECacheType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107 import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108 import com.dtstack.flink.sql.environment.StreamEnvConfigManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 import com.dtstack.flink.sql.exec.FlinkSQLExec;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110 import com.dtstack.flink.sql.option.OptionParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111 import com.dtstack.flink.sql.parser.CreateFuncParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112 import com.dtstack.flink.sql.parser.CreateTmpTableParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113 import com.dtstack.flink.sql.parser.InsertSqlParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114 import com.dtstack.flink.sql.parser.SqlParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 import com.dtstack.flink.sql.parser.SqlTree;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116 import com.dtstack.flink.sql.side.SideSqlExec;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117 import com.dtstack.flink.sql.side.SideTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118 import com.dtstack.flink.sql.table.SourceTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119 import com.dtstack.flink.sql.table.TableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120 import com.dtstack.flink.sql.table.TargetTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121 import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122 import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123 import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125 import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127 import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128 import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136 import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137 import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138 import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140 import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141 import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142 import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143 import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146 import org.slf4j.Logger;</span>
 147 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148 import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149 import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150 import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151 import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152 import org.apache.flink.table.calcite.FlinkPlannerImpl;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154 import org.apache.flink.types.Row;</span>
 155 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 156 import org.slf4j.Logger;
 157 import org.slf4j.LoggerFactory;
 158 
 159 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 160 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161 import com.dtstack.flink.sql.parser.CreateTmpTableParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 import com.dtstack.flink.sql.parser.InsertSqlParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163 import com.dtstack.flink.sql.parser.SqlParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164 import com.dtstack.flink.sql.parser.SqlTree;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165 import com.dtstack.flink.sql.side.SideSqlExec;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 import com.dtstack.flink.sql.side.SideTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167 import com.dtstack.flink.sql.table.SourceTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168 import com.dtstack.flink.sql.table.TableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169 import com.dtstack.flink.sql.table.TargetTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170 import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171 import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172 import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173 import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174 import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176 import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177 import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185 import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186 import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187 import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189 import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190 import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191 import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192 import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199 import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201 import java.net.URLClassLoader;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205 import java.util.Optional;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209 import com.dtstack.flink.sql.option.Options;</span>
 210 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214 import java.net.URLClassLoader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221 import com.dtstack.flink.sql.option.Options;</span>
 222 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 223 
 224 /**
 225  * Date: 2018/6/26
 226  * Company: www.dtstack.com
 227  * @author xuchao
 228  */
 229 
 230 public class Main {
 231     private static final Logger LOG = LoggerFactory.getLogger(Main.class);
 232 
 233     public static void main(String[] args) throws Exception {
 234 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235         ParamsInfo paramsInfo = ExecuteProcessHelper.parseParams(args);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExecution(paramsInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237         env.execute(paramsInfo.getName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238         LOG.info(&quot;program {} execution success&quot;, paramsInfo.getName());</span>
 239 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240 import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241 import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242 import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244 import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245 import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253 import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254 import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255 import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257 import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258 import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259 import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260 import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267 import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269 import java.net.URLClassLoader;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273 import java.util.Optional;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280  * Date: 2018/6/26</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285 public class Main {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287     private static final String CLASS_FILE_NAME_FMT = &quot;class_path_%d&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289     private static final ObjectMapper objMapper = new ObjectMapper();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291     private static final Logger LOG = LoggerFactory.getLogger(Main.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294     public static void main(String[] args) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296         OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297         Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298         String sql = options.getSql();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299         String name = options.getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300         String addJarListStr = options.getAddjar();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301         String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302         String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303         String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304         String deployMode = options.getMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305         String confProp = options.getConfProp();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307         sql = URLDecoder.decode(sql, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308         SqlParser.setLocalSqlPluginRoot(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310         List&lt;String&gt; addJarFileList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311         if (!Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312             addJarListStr = URLDecoder.decode(addJarListStr, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313             addJarFileList = objMapper.readValue(addJarListStr, List.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316         confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318         StreamExecutionEnvironment env = getStreamExeEnv(confProperties, deployMode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319         StreamTableEnvironment tableEnv =  StreamTableEnvironment.getTableEnvironment(env);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 320         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties);"> 320         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confP🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322         List&lt;URL&gt; jarURList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323         SqlTree sqlTree = SqlParser.parseSql(sql);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325         //Get External jar to load</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326         for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327             File tmpFile = new File(addJarPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328             jarURList.add(tmpFile.toURI().toURL());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331         Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332         Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334         //register udf</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335         registerUserDefinedFunction(sqlTree, jarURList, tableEnv);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336         //register table schema</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 337         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode, sideTableMap, registerTableCache);"> 337         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPlugi🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338         // cache classPathSets</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339         registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 341         sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 341         sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQue🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343         if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344             ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347         env.execute(name);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 350     private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,Map&lt;String, SideTableInfo&gt; sideTableMap,Map&lt;String, Table&gt; registerTableCache, StreamQueryConfig queryConfig) throws Exception {"> 350     private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351         SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352         sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353         for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 354             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result);"> 354             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357         for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359                 LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361             boolean isSide = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362             for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363                 if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364                     CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365                     String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 367                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 367                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConf🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368                     String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369                     tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 370                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tmp);"> 370                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryC🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372                     for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373                         if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374                             isSide = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378                     if (isSide) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379                         //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 380                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, null);"> 380                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache,🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381                     }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382                         System.out.println(&quot;----------exec sql without dimension join-----------&quot; );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383                         System.out.println(&quot;----------real sql exec is--------------------------&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384                         System.out.println(result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385                         FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386                         if(LOG.isInfoEnabled()){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387                             System.out.println();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388                             LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 399     private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEnv)"> 399     private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironmen🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400             throws IllegalAccessException, InvocationTargetException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401         // udf和tableEnv须由同一个类加载器加载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402         ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403         URLClassLoader classLoader = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404         List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405         for (CreateFuncParser.SqlParserResult funcInfo : funcList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406             //classloader</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407             if (classLoader == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 408                 classLoader = ClassLoaderManager.loadExtraJar(jarURList, (URLClassLoader) levelClassLoader);"> 408                 classLoader = ClassLoaderManager.loadExtraJar(jarURList, (URLClassLoader) levelClassLoade🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 410             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 410             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415      *    向Flink注册源表和结果表，返回执行时插件包的全路径</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416      * @param sqlTree</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417      * @param env</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418      * @param tableEnv</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419      * @param localSqlPluginPath</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420      * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421      * @param pluginLoadMode   插件加载模式 classpath or shipfile</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422      * @param sideTableMap</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423      * @param registerTableCache</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425      * @throws Exception</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 427     private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 427     private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnv🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 428                                           String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 428                                           String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429         Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430         WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431         for (TableInfo tableInfo : sqlTree.getTableInfoMap().values()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433             if (tableInfo instanceof SourceTableInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435                 SourceTableInfo sourceTableInfo = (SourceTableInfo) tableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 436                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 436                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSq🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437                 tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 438                 //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 438                 //Note --- parameter conversion function can not be used inside a function of the type of🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439                 //Create table in which the function is arranged only need adaptation sql</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 440                 String adaptSql = sourceTableInfo.getAdaptSelectSql();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441                 Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 443                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().getColumnNames());"> 443                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getS🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444                 DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445                         .filter((Tuple2&lt;Boolean, Row&gt; f0) -&gt; f0.f0)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446                         .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; f0.f1)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447                         .returns(typeInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449                 String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451                 if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 452                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);"> 452                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTabl🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453                     fields += &quot;,ROWTIME.ROWTIME&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455                     fields += &quot;,PROCTIME.PROCTIME&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458                 Table regTable = tableEnv.fromDataStream(adaptStream, fields);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459                 tableEnv.registerTable(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460                 if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461                     LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463                 registerTableCache.put(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 464 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 465                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 465                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(),🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466                 pluginClassPatshSets.add(sourceTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467             } else if (tableInfo instanceof TargetTableInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 468 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 469                 TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPath);"> 469                 TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSq🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 470                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());"> 470                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses()🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 471                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);"> 471                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableS🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 472 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 473                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 473                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), T🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474                 pluginClassPatshSets.add(sinkTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475             } else if (tableInfo instanceof SideTableInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 476                 String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 476                 String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheTy🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 477                 sideTableMap.put(tableInfo.getName(), (SideTableInfo) tableInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 478 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 479                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 479                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperat🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 480                 pluginClassPatshSets.add(sideTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 481             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482                 throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485         return pluginClassPatshSets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489      *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 490      * @param env</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 491      * @param classPathSet</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 492      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 493     private static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {"> 493     private static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathS🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 494         int i = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495         for (URL url : classPathSet) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496             String classFileName = String.format(CLASS_FILE_NAME_FMT, i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497             env.registerCachedFile(url.getPath(), classFileName, true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498             i++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 502     private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 502     private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMod🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 503         StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 504                 StreamExecutionEnvironment.getExecutionEnvironment() :</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505                 new MyLocalStreamEnvironment();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 506 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 507         StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 508         return env;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 509     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510 }</span>
 511 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513         OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514         Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515         String sql = options.getSql();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516         String name = options.getName();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517         String addJarListStr = options.getAddjar();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518         String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519         String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520         String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521         String deployMode = options.getMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522         String confProp = options.getConfProp();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524         sql = URLDecoder.decode(sql, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525         SqlParser.setLocalSqlPluginRoot(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527         List&lt;String&gt; addJarFileList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528         if (!Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529             addJarListStr = URLDecoder.decode(addJarListStr, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530             addJarFileList = objMapper.readValue(addJarListStr, List.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533         confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535         StreamExecutionEnvironment env = getStreamExeEnv(confProperties, deployMode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536         StreamTableEnvironment tableEnv =  StreamTableEnvironment.getTableEnvironment(env);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 537         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties);"> 537         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confP🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538         // init global flinkPlanner</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 539         FlinkPlanner.createFlinkPlanner(tableEnv.getFrameworkConfig(), tableEnv.getPlanner(), tableEnv.getTypeFactory());"> 539         FlinkPlanner.createFlinkPlanner(tableEnv.getFrameworkConfig(), tableEnv.getPlanner(), tableEnv.ge🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541         List&lt;URL&gt; jarURList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542         SqlTree sqlTree = SqlParser.parseSql(sql);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544         //Get External jar to load</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545         for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546             File tmpFile = new File(addJarPath);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547             jarURList.add(tmpFile.toURI().toURL());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550         Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551         Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553         //register udf</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554         registerUserDefinedFunction(sqlTree, jarURList, tableEnv);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555         //register table schema</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 556         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode, sideTableMap, registerTableCache);"> 556         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPlugi🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557         // cache classPathSets</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558         registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 560         sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 560         sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQue🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562         if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563             ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566         env.execute(name);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569     private static void sqlTranslation(String localSqlPluginPath,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570                                        StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571                                        SqlTree sqlTree,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572                                        Map&lt;String, SideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573                                        Map&lt;String, Table&gt; registerTableCache,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574                                        StreamQueryConfig queryConfig) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576         SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577         sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578         for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 579             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result);"> 579             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582         for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584                 LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586             boolean isSide = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587             for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588                 if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589                     CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590                     String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591                     FlinkPlannerImpl flinkPlanner = FlinkPlanner.getFlinkPlanner();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593                     SqlNode sqlNode = flinkPlanner.parse(realSql);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594                     String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595                     tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 596                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tmp);"> 596                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryC🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598                     for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599                         if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600                             isSide = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604                     if (isSide) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605                         //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 606                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, null);"> 606                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache,🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607                     }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608                         System.out.println(&quot;----------exec sql without dimension join-----------&quot; );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609                         System.out.println(&quot;----------real sql exec is--------------------------&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610                         System.out.println(result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611                         FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612                         if(LOG.isInfoEnabled()){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613                             System.out.println();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614                             LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 625     private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEnv)"> 625     private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironmen🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626             throws IllegalAccessException, InvocationTargetException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627         // udf和tableEnv须由同一个类加载器加载</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628         ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629         URLClassLoader classLoader = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630         List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631         for (CreateFuncParser.SqlParserResult funcInfo : funcList) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632             //classloader</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633             if (classLoader == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 634                 classLoader = ClassLoaderManager.loadExtraJar(jarURList, (URLClassLoader) levelClassLoader);"> 634                 classLoader = ClassLoaderManager.loadExtraJar(jarURList, (URLClassLoader) levelClassLoade🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 636             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 636             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641      *    向Flink注册源表和结果表，返回执行时插件包的全路径</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642      * @param sqlTree</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643      * @param env</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644      * @param tableEnv</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645      * @param localSqlPluginPath</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646      * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647      * @param pluginLoadMode   插件加载模式 classpath or shipfile</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648      * @param sideTableMap</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649      * @param registerTableCache</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650      * @return</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651      * @throws Exception</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 653     private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 653     private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnv🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 654                                           String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 654                                           String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655         Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656         WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657         for (TableInfo tableInfo : sqlTree.getTableInfoMap().values()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659             if (tableInfo instanceof SourceTableInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661                 SourceTableInfo sourceTableInfo = (SourceTableInfo) tableInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 662                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 662                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSq🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663                 tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 664                 //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 664                 //Note --- parameter conversion function can not be used inside a function of the type of🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665                 //Create table in which the function is arranged only need adaptation sql</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666                 String adaptSql = sourceTableInfo.getAdaptSelectSql();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667                 Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 669                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().getColumnNames());"> 669                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getS🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670                 DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671                         .filter((Tuple2&lt;Boolean, Row&gt; f0) -&gt; f0.f0)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672                         .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; f0.f1)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673                         .returns(typeInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675                 String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677                 if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 678                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);"> 678                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTabl🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679                     fields += &quot;,ROWTIME.ROWTIME&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681                     fields += &quot;,PROCTIME.PROCTIME&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684                 Table regTable = tableEnv.fromDataStream(adaptStream, fields);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685                 tableEnv.registerTable(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686                 if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687                     LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689                 registerTableCache.put(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 691                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 691                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(),🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692                 pluginClassPatshSets.add(sourceTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693             } else if (tableInfo instanceof TargetTableInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 695                 TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPath);"> 695                 TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSq🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 696                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());"> 696                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses()🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 697                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);"> 697                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableS🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 699                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 699                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), T🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700                 pluginClassPatshSets.add(sinkTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701             } else if (tableInfo instanceof SideTableInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 702                 String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 702                 String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheTy🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703                 sideTableMap.put(tableInfo.getName(), (SideTableInfo) tableInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 705                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 705                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperat🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706                 pluginClassPatshSets.add(sideTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708                 throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711         return pluginClassPatshSets;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715      *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716      * @param env</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717      * @param classPathSet</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 719     private static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {"> 719     private static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathS🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720         int i = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721         for (URL url : classPathSet) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722             String classFileName = String.format(CLASS_FILE_NAME_FMT, i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723             env.registerCachedFile(url.getPath(), classFileName, true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724             i++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 728     private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 728     private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMod🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729         StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730                 StreamExecutionEnvironment.getExecutionEnvironment() :</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731                 new MyLocalStreamEnvironment();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733         StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734         return env;</span>
 735 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 736     }
 737 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql;
  21 import com.dtstack.flink.sql.parser.FlinkPlanner;
  22 
  23 
  24 
  25 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
  26 
  27 import com.dtstack.flink.sql.exec.ExecuteProcessHelper;
  28 import com.dtstack.flink.sql.exec.ParamsInfo;
  29 import org.apache.flink.table.calcite.FlinkPlannerImpl;
  30 import org.slf4j.Logger;
  31 import org.slf4j.LoggerFactory;
  32 
  33 
  34 /**
  35  * Date: 2018/6/26
  36  * Company: www.dtstack.com
  37  * @author xuchao
  38  */
  39 
  40 public class Main {
  41     private static final Logger LOG = LoggerFactory.getLogger(Main.class);
  42 
  43     public static void main(String[] args) throws Exception {
  44 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45         ParamsInfo paramsInfo = ExecuteProcessHelper.parseParams(args);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExecution(paramsInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47         env.execute(paramsInfo.getName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48         LOG.info(&quot;program {} execution success&quot;, paramsInfo.getName());</span>
  49 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51         OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52         Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53         String sql = options.getSql();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54         String name = options.getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55         String addJarListStr = options.getAddjar();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56         String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57         String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58         String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59         String deployMode = options.getMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60         String confProp = options.getConfProp();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62         sql = URLDecoder.decode(sql, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63         SqlParser.setLocalSqlPluginRoot(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65         List&lt;String&gt; addJarFileList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66         if (!Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67             addJarListStr = URLDecoder.decode(addJarListStr, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68             addJarFileList = objMapper.readValue(addJarListStr, List.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71         confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73         StreamExecutionEnvironment env = getStreamExeEnv(confProperties, deployMode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74         StreamTableEnvironment tableEnv =  StreamTableEnvironment.getTableEnvironment(env);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  75         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties);">  75         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confP🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         List&lt;URL&gt; jarURList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78         SqlTree sqlTree = SqlParser.parseSql(sql);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80         //Get External jar to load</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81         for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82             File tmpFile = new File(addJarPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83             jarURList.add(tmpFile.toURI().toURL());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86         Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87         Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89         //register udf</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90         registerUserDefinedFunction(sqlTree, jarURList, tableEnv);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91         //register table schema</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  92         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode, sideTableMap, registerTableCache);">  92         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPlugi🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93         // cache classPathSets</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94         registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  96         sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);">  96         sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQue🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98         if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99             ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102         env.execute(name);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103     }</span>
 104 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106         OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107         Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108         String sql = options.getSql();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109         String name = options.getName();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110         String addJarListStr = options.getAddjar();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111         String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112         String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113         String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114         String deployMode = options.getMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115         String confProp = options.getConfProp();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117         sql = URLDecoder.decode(sql, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118         SqlParser.setLocalSqlPluginRoot(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120         List&lt;String&gt; addJarFileList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121         if (!Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122             addJarListStr = URLDecoder.decode(addJarListStr, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123             addJarFileList = objMapper.readValue(addJarListStr, List.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126         confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128         StreamExecutionEnvironment env = getStreamExeEnv(confProperties, deployMode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129         StreamTableEnvironment tableEnv =  StreamTableEnvironment.getTableEnvironment(env);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 130         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties);"> 130         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confP🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131         // init global flinkPlanner</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 132         FlinkPlanner.createFlinkPlanner(tableEnv.getFrameworkConfig(), tableEnv.getPlanner(), tableEnv.getTypeFactory());"> 132         FlinkPlanner.createFlinkPlanner(tableEnv.getFrameworkConfig(), tableEnv.getPlanner(), tableEnv.ge🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134         List&lt;URL&gt; jarURList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135         SqlTree sqlTree = SqlParser.parseSql(sql);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137         //Get External jar to load</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138         for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139             File tmpFile = new File(addJarPath);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140             jarURList.add(tmpFile.toURI().toURL());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143         Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144         Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146         //register udf</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147         registerUserDefinedFunction(sqlTree, jarURList, tableEnv);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148         //register table schema</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 149         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode, sideTableMap, registerTableCache);"> 149         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPlugi🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150         // cache classPathSets</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151         registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 153         sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 153         sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQue🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155         if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156             ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159         env.execute(name);</span>
 160 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 161     }
 162 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 163 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 164 private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,Map&lt;String, SideTableInfo&gt; sideTableMap,Map&lt;String, Table&gt; registerTableCache, StreamQueryConfig queryConfig) throws Exception {"> 164 private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sql🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166         sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 168             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result);"> 168             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173                 LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             boolean isSide = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176             for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177                 if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178                     CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179                     String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 181                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 181                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConf🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182                     String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183                     tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 184                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tmp);"> 184                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryC🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186                     for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187                         if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188                             isSide = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                     if (isSide) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                         //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 194                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, null);"> 194                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache,🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195                     }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196                         System.out.println(&quot;----------exec sql without dimension join-----------&quot; );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197                         System.out.println(&quot;----------real sql exec is--------------------------&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198                         System.out.println(result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199                         FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200                         if(LOG.isInfoEnabled()){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201                             System.out.println();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202                             LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210     }</span>
 211 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 private static void sqlTranslation(String localSqlPluginPath,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213                                        StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214                                        SqlTree sqlTree,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215                                        Map&lt;String, SideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216                                        Map&lt;String, Table&gt; registerTableCache,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217                                        StreamQueryConfig queryConfig) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219         SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220         sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221         for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 222             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result);"> 222             sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225         for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227                 LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229             boolean isSide = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230             for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231                 if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232                     CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233                     String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234                     FlinkPlannerImpl flinkPlanner = FlinkPlanner.getFlinkPlanner();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236                     SqlNode sqlNode = flinkPlanner.parse(realSql);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237                     String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238                     tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 239                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tmp);"> 239                     sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryC🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241                     for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242                         if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243                             isSide = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247                     if (isSide) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248                         //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 249                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, null);"> 249                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache,🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250                     }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251                         System.out.println(&quot;----------exec sql without dimension join-----------&quot; );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252                         System.out.println(&quot;----------real sql exec is--------------------------&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253                         System.out.println(result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254                         FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255                         if(LOG.isInfoEnabled()){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256                             System.out.println();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257                             LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265     }</span>
 266 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 267 
 268 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql;
  19 
  20 import com.dtstack.flink.sql.exec.ExecuteProcessHelper;
  21 import com.dtstack.flink.sql.exec.ParamsInfo;
  22 import com.dtstack.flink.sql.parser.FlinkPlanner;
  23 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
  24 import org.apache.flink.table.calcite.FlinkPlannerImpl;
  25 import org.slf4j.Logger;
  26 import org.slf4j.LoggerFactory;
  27 
  28 
  29 /**
  30  * Date: 2018/6/26
  31  * Company: www.dtstack.com
  32  * @author xuchao
  33  */
  34 public class Main {
  35     private static final Logger LOG = LoggerFactory.getLogger(Main.class);
  36 
  37     public static void main(String[] args) throws Exception {
  38         ParamsInfo paramsInfo = ExecuteProcessHelper.parseParams(args);
  39         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExecution(paramsInfo);
  40         env.execute(paramsInfo.getName());
  41         LOG.info(&quot;program {} execution success&quot;, paramsInfo.getName());
  42     }
  43 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql;
  21  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.dtstack.flink.sql.config.CalciteConfig;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.classloader.ClassLoaderManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import com.dtstack.flink.sql.enums.ECacheType;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import com.dtstack.flink.sql.environment.StreamEnvConfigManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import com.dtstack.flink.sql.exec.FlinkSQLExec;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import com.dtstack.flink.sql.option.OptionParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import com.dtstack.flink.sql.parser.CreateFuncParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import com.dtstack.flink.sql.parser.CreateTmpTableParser;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import com.dtstack.flink.sql.parser.InsertSqlParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import com.dtstack.flink.sql.parser.SqlParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import com.dtstack.flink.sql.parser.SqlTree;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import com.dtstack.flink.sql.side.SideSqlExec;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import com.dtstack.flink.sql.side.SideTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import com.dtstack.flink.sql.table.SourceTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import com.dtstack.flink.sql.table.TableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import com.dtstack.flink.sql.table.TargetTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import com.google.common.base.Strings;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +</span>
  60  import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -import org.apache.flink.table.api.java.StreamTableEnvironment;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +import com.dtstack.flink.sql.exec.ExecuteProcessHelper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +import com.dtstack.flink.sql.exec.ParamsInfo;</span>
  70  import org.slf4j.Logger;
  71  import org.slf4j.LoggerFactory;
  72  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -import java.io.File;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -import java.net.URL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -import java.net.URLClassLoader;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -import java.net.URLDecoder;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -import java.util.Map;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -import java.util.Optional;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -import java.util.Properties;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -import java.util.Set;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -import com.dtstack.flink.sql.option.Options;</span>
  85  
  86  /**
  87   * Date: 2018/6/26
  88   * Company: www.dtstack.com
  89   * @author xuchao
  90   */
  91  
  92  public class Main {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -    private static final String CLASS_FILE_NAME_FMT = &quot;class_path_%d&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -    private static final ObjectMapper objMapper = new ObjectMapper();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -</span>
  98      private static final Logger LOG = LoggerFactory.getLogger(Main.class);
  99  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -</span>
 101      public static void main(String[] args) throws Exception {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -        String sql = options.getSql();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -        String name = options.getName();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -        String addJarListStr = options.getAddjar();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -        String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -        String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -        String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        String deployMode = options.getMode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -        String confProp = options.getConfProp();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -        sql = URLDecoder.decode(sql, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -        SqlParser.setLocalSqlPluginRoot(localSqlPluginPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -        List&lt;String&gt; addJarFileList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -        if (!Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -            addJarListStr = URLDecoder.decode(addJarListStr, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -            addJarFileList = objMapper.readValue(addJarListStr, List.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -        confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -        Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -        StreamExecutionEnvironment env = getStreamExeEnv(confProperties, deployMode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -        StreamTableEnvironment tableEnv =  StreamTableEnvironment.getTableEnvironment(env);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 127 -        StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties);"> 127 -        StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties🔵</abbr></span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -        List&lt;URL&gt; jarURList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -        SqlTree sqlTree = SqlParser.parseSql(sql);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        //Get External jar to load</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -        for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -            File tmpFile = new File(addJarPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -            jarURList.add(tmpFile.toURI().toURL());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -        Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -        Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -        //register udf</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        registerUserDefinedFunction(sqlTree, jarURList, tableEnv);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -        //register table schema</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 144 -        Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode, sideTableMap, registerTableCache);"> 144 -        Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pl🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -        // cache classPathSets</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -        registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 148 -        sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 148 -        sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig)🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -        if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -            ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -        env.execute(name);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 157 -    private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,Map&lt;String, SideTableInfo&gt; sideTableMap,Map&lt;String, Table&gt; registerTableCache, StreamQueryConfig queryConfig) throws Exception {"> 157 -    private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,🔵</abbr></span>







<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -        SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -        sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -        for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 161 -            sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result);"> 161 -            sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result)🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -        for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -            if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -                LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -            boolean isSide = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -            for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -                if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -                    CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -                    String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 174 -                    SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 174 -                    SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_🔵</abbr></span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -                    String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -                    tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 177 -                    sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tmp);"> 177 -                    sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tm🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -                    for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -                        if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -                            isSide = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -                    if (isSide) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -                        //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 187 -                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, null);"> 187 -                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryCon🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -                    }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -                        System.out.println(&quot;----------exec sql without dimension join-----------&quot; );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -                        System.out.println(&quot;----------real sql exec is--------------------------&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -                        System.out.println(result.getExecSql());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -                        FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -                        if(LOG.isInfoEnabled()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -                            System.out.println();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -                            LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 206 -    private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEnv)"> 206 -    private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEn🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -            throws IllegalAccessException, InvocationTargetException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -        // udf和tableEnv须由同一个类加载器加载</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -        ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -        URLClassLoader classLoader = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -        List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -        for (CreateFuncParser.SqlParserResult funcInfo : funcList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -            //classloader</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -            if (classLoader == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -                classLoader = ClassLoaderManager.loadExtraJar(jarURList, (URLClassLoader) levelClassLoader);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 217 -            FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 217 -            FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv,🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -     *    向Flink注册源表和结果表，返回执行时插件包的全路径</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -     * @param sqlTree</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -     * @param env</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -     * @param tableEnv</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -     * @param localSqlPluginPath</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -     * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -     * @param pluginLoadMode   插件加载模式 classpath or shipfile</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -     * @param sideTableMap</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -     * @param registerTableCache</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -     * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -     * @throws Exception</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 234 -    private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 234 -    private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment 🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 235 -                                          String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 235 -                                          String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTable🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -        Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -        WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -        for (TableInfo tableInfo : sqlTree.getTableInfoMap().values()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -            if (tableInfo instanceof SourceTableInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -                SourceTableInfo sourceTableInfo = (SourceTableInfo) tableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 243 -                Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 243 -                Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPa🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -                tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 245 -                //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 245 -                //Note --- parameter conversion function can not be used inside a function of the type of polymeri🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -                //Create table in which the function is arranged only need adaptation sql</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -                String adaptSql = sourceTableInfo.getAdaptSelectSql();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -                Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 250 -                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().getColumnNames());"> 250 -                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().g🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -                DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -                        .filter((Tuple2&lt;Boolean, Row&gt; f0) -&gt; f0.f0)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -                        .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; f0.f1)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -                        .returns(typeInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -                String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -                if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -                    adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -                    fields += &quot;,ROWTIME.ROWTIME&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -                    fields += &quot;,PROCTIME.PROCTIME&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -                Table regTable = tableEnv.fromDataStream(adaptStream, fields);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -                tableEnv.registerTable(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -                if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -                    LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -                registerTableCache.put(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 272 -                URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 272 -                URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTa🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -                pluginClassPatshSets.add(sourceTablePathUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -            } else if (tableInfo instanceof TargetTableInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 276 -                TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPath);"> 276 -                TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPa🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -                TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -                tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 280 -                URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 280 -                URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTabl🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -                pluginClassPatshSets.add(sinkTablePathUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -            } else if (tableInfo instanceof SideTableInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 283 -                String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 283 -                String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -                sideTableMap.put(tableInfo.getName(), (SideTableInfo) tableInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 286 -                URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 286 -                URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideT🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -                pluginClassPatshSets.add(sideTablePathUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -                throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -        return pluginClassPatshSets;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -     *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -     * @param env</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -     * @param classPathSet</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -    private static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -        int i = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -        for (URL url : classPathSet) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -            String classFileName = String.format(CLASS_FILE_NAME_FMT, i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -            env.registerCachedFile(url.getPath(), classFileName, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 305 -            i++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 309 -    private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 309 -    private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -        StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -                StreamExecutionEnvironment.getExecutionEnvironment() :</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -                new MyLocalStreamEnvironment();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -        StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -        return env;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +        ParamsInfo paramsInfo = ExecuteProcessHelper.parseParams(args);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +        StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExecution(paramsInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +        env.execute(paramsInfo.getName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +        LOG.info(&quot;program {} execution success&quot;, paramsInfo.getName());</span>
 320      }
 321  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql;
  21  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.dtstack.flink.sql.config.CalciteConfig;</span>
  23  import com.dtstack.flink.sql.classloader.ClassLoaderManager;
  24  import com.dtstack.flink.sql.enums.ClusterMode;
  25  import com.dtstack.flink.sql.enums.ECacheType;
  26  import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;
  27  import com.dtstack.flink.sql.environment.StreamEnvConfigManager;
  28  import com.dtstack.flink.sql.exec.FlinkSQLExec;
  29  import com.dtstack.flink.sql.option.OptionParser;
  30  import com.dtstack.flink.sql.parser.CreateFuncParser;
  31  import com.dtstack.flink.sql.parser.CreateTmpTableParser;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import com.dtstack.flink.sql.parser.FlinkPlanner;</span>
  33  import com.dtstack.flink.sql.parser.InsertSqlParser;
  34  import com.dtstack.flink.sql.parser.SqlParser;
  35  import com.dtstack.flink.sql.parser.SqlTree;
  36  import com.dtstack.flink.sql.side.SideSqlExec;
  37  import com.dtstack.flink.sql.side.SideTableInfo;
  38  import com.dtstack.flink.sql.table.SourceTableInfo;
  39  import com.dtstack.flink.sql.table.TableInfo;
  40  import com.dtstack.flink.sql.table.TargetTableInfo;
  41  import com.dtstack.flink.sql.sink.StreamSinkFactory;
  42  import com.dtstack.flink.sql.source.StreamSourceFactory;
  43  import com.dtstack.flink.sql.util.DtStringUtil;
  44  import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;
  45  import com.dtstack.flink.sql.function.FunctionManager;
  46  import com.dtstack.flink.sql.util.PluginUtil;
  47  import org.apache.calcite.sql.SqlInsert;
  48  import org.apache.calcite.sql.SqlNode;
  49  import org.apache.commons.io.Charsets;
  50  import org.apache.flink.api.common.typeinfo.TypeInformation;
  51  import org.apache.flink.api.java.tuple.Tuple2;
  52  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  53  import com.google.common.base.Strings;
  54  import com.google.common.collect.Lists;
  55  import com.google.common.collect.Maps;
  56  import com.google.common.collect.Sets;
  57  import com.fasterxml.jackson.databind.ObjectMapper;
  58  import org.apache.flink.streaming.api.datastream.DataStream;


  59  import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
  60  import org.apache.flink.table.api.StreamQueryConfig;
  61  import org.apache.flink.table.api.Table;
  62  import org.apache.flink.table.api.TableEnvironment;
  63  import org.apache.flink.table.api.java.StreamTableEnvironment;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +import org.apache.flink.table.calcite.FlinkPlannerImpl;</span>
  65  import org.apache.flink.table.sinks.TableSink;
  66  import org.apache.flink.types.Row;



  67  import org.slf4j.Logger;
  68  import org.slf4j.LoggerFactory;
  69  
  70  import java.io.File;
  71  import java.lang.reflect.InvocationTargetException;
  72  import java.net.URL;
  73  import java.net.URLClassLoader;
  74  import java.net.URLDecoder;
  75  import java.util.List;
  76  import java.util.Map;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -import java.util.Optional;</span>
  78  import java.util.Properties;
  79  import java.util.Set;
  80  
  81  import com.dtstack.flink.sql.option.Options;
  82  
  83  /**
  84   * Date: 2018/6/26
  85   * Company: www.dtstack.com
  86   * @author xuchao
  87   */
  88  
  89  public class Main {
  90  
  91      private static final String CLASS_FILE_NAME_FMT = &quot;class_path_%d&quot;;
  92  
  93      private static final ObjectMapper objMapper = new ObjectMapper();
  94  
  95      private static final Logger LOG = LoggerFactory.getLogger(Main.class);
  96  
  97  
  98      public static void main(String[] args) throws Exception {
  99  
 100          OptionParser optionParser = new OptionParser(args);
 101          Options options = optionParser.getOptions();
 102          String sql = options.getSql();
 103          String name = options.getName();
 104          String addJarListStr = options.getAddjar();
 105          String localSqlPluginPath = options.getLocalSqlPluginPath();
 106          String remoteSqlPluginPath = options.getRemoteSqlPluginPath();
 107          String pluginLoadMode = options.getPluginLoadMode();
 108          String deployMode = options.getMode();
 109          String confProp = options.getConfProp();
 110  
 111          sql = URLDecoder.decode(sql, Charsets.UTF_8.name());
 112          SqlParser.setLocalSqlPluginRoot(localSqlPluginPath);
 113  
 114          List&lt;String&gt; addJarFileList = Lists.newArrayList();
 115          if (!Strings.isNullOrEmpty(addJarListStr)) {
 116              addJarListStr = URLDecoder.decode(addJarListStr, Charsets.UTF_8.name());
 117              addJarFileList = objMapper.readValue(addJarListStr, List.class);
 118          }
 119  
 120          confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());
 121          Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);
 122          StreamExecutionEnvironment env = getStreamExeEnv(confProperties, deployMode);
 123          StreamTableEnvironment tableEnv =  StreamTableEnvironment.getTableEnvironment(env);
<abbr title=" 124          StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties);"> 124          StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties🔵</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +        // init global flinkPlanner</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 126 +        FlinkPlanner.createFlinkPlanner(tableEnv.getFrameworkConfig(), tableEnv.getPlanner(), tableEnv.getTypeFactory());"> 126 +        FlinkPlanner.createFlinkPlanner(tableEnv.getFrameworkConfig(), tableEnv.getPlanner(), tableEnv.getTypeFact🔵</abbr></span>
 127  
 128          List&lt;URL&gt; jarURList = Lists.newArrayList();
 129          SqlTree sqlTree = SqlParser.parseSql(sql);
 130  
 131          //Get External jar to load
 132          for (String addJarPath : addJarFileList) {
 133              File tmpFile = new File(addJarPath);
 134              jarURList.add(tmpFile.toURI().toURL());
 135          }
 136  
 137          Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();
 138          Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();
 139  
 140          //register udf
 141          registerUserDefinedFunction(sqlTree, jarURList, tableEnv);
 142          //register table schema
<abbr title=" 143          Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode, sideTableMap, registerTableCache);"> 143          Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pl🔵</abbr>
 144          // cache classPathSets
 145          registerPluginUrlToCachedFile(env, classPathSets);
 146  
<abbr title=" 147          sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 147          sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig)🔵</abbr>
 148  
 149          if (env instanceof MyLocalStreamEnvironment) {
 150              ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());
 151          }
 152  
 153          env.execute(name);
 154      }
 155  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 156 -    private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,Map&lt;String, SideTableInfo&gt; sideTableMap,Map&lt;String, Table&gt; registerTableCache, StreamQueryConfig queryConfig) throws Exception {"> 156 -    private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +    private static void sqlTranslation(String localSqlPluginPath,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +                                       StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +                                       SqlTree sqlTree,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +                                       Map&lt;String, SideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                                       Map&lt;String, Table&gt; registerTableCache,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +                                       StreamQueryConfig queryConfig) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +</span>
 164          SideSqlExec sideSqlExec = new SideSqlExec();
 165          sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);
 166          for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {
<abbr title=" 167              sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result);"> 167              sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, result)🔵</abbr>
 168          }
 169  
 170          for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {
 171              if (LOG.isInfoEnabled()) {
 172                  LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());
 173              }
 174              boolean isSide = false;
 175              for (String tableName : result.getTargetTableList()) {
 176                  if (sqlTree.getTmpTableMap().containsKey(tableName)) {
 177                      CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);
 178                      String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 180 -                    SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 180 -                    SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +                    FlinkPlannerImpl flinkPlanner = FlinkPlanner.getFlinkPlanner();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +                    SqlNode sqlNode = flinkPlanner.parse(realSql);</span>
 184                      String tmpSql = ((SqlInsert) sqlNode).getSource().toString();
 185                      tmp.setExecSql(tmpSql);
<abbr title=" 186                      sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tmp);"> 186                      sideSqlExec.exec(tmp.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, tm🔵</abbr>
 187                  } else {
 188                      for (String sourceTable : result.getSourceTableList()) {
 189                          if (sideTableMap.containsKey(sourceTable)) {
 190                              isSide = true;
 191                              break;
 192                          }
 193                      }
 194                      if (isSide) {
 195                          //sql-dimensional table contains the dimension table of execution
<abbr title=" 196                          sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig, null);"> 196                          sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryCon🔵</abbr>
 197                      }else{
 198                          System.out.println(&quot;----------exec sql without dimension join-----------&quot; );
 199                          System.out.println(&quot;----------real sql exec is--------------------------&quot;);
 200                          System.out.println(result.getExecSql());
 201                          FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);
 202                          if(LOG.isInfoEnabled()){
 203                              System.out.println();
 204                              LOG.info(&quot;exec sql: &quot; + result.getExecSql());
 205                          }
 206                      }
 207                  }
 208              }
 209          }
 210  
 211  
 212      }
 213  
 214  
<abbr title=" 215      private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEnv)"> 215      private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEn🔵</abbr>
 216              throws IllegalAccessException, InvocationTargetException {
 217          // udf和tableEnv须由同一个类加载器加载
 218          ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();
 219          URLClassLoader classLoader = null;
 220          List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();
 221          for (CreateFuncParser.SqlParserResult funcInfo : funcList) {
 222              //classloader
 223              if (classLoader == null) {
 224                  classLoader = ClassLoaderManager.loadExtraJar(jarURList, (URLClassLoader) levelClassLoader);
 225              }
<abbr title=" 226              FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 226              FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv,🔵</abbr>
 227          }
 228      }
 229  
 230      /**
 231       *    向Flink注册源表和结果表，返回执行时插件包的全路径
 232       * @param sqlTree
 233       * @param env
 234       * @param tableEnv
 235       * @param localSqlPluginPath
 236       * @param remoteSqlPluginPath
 237       * @param pluginLoadMode   插件加载模式 classpath or shipfile
 238       * @param sideTableMap
 239       * @param registerTableCache
 240       * @return
 241       * @throws Exception
 242       */
<abbr title=" 243      private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 243      private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment 🔵</abbr>
<abbr title=" 244                                            String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 244                                            String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTable🔵</abbr>
 245          Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();
 246          WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();
 247          for (TableInfo tableInfo : sqlTree.getTableInfoMap().values()) {
 248  
 249              if (tableInfo instanceof SourceTableInfo) {
 250  
 251                  SourceTableInfo sourceTableInfo = (SourceTableInfo) tableInfo;
<abbr title=" 252                  Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 252                  Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPa🔵</abbr>
 253                  tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);
<abbr title=" 254                  //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 254                  //Note --- parameter conversion function can not be used inside a function of the type of polymeri🔵</abbr>
 255                  //Create table in which the function is arranged only need adaptation sql
 256                  String adaptSql = sourceTableInfo.getAdaptSelectSql();
 257                  Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);
 258  
<abbr title=" 259                  RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().getColumnNames());"> 259                  RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().g🔵</abbr>
 260                  DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)
 261                          .filter((Tuple2&lt;Boolean, Row&gt; f0) -&gt; f0.f0)
 262                          .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; f0.f1)
 263                          .returns(typeInfo);
 264  
 265                  String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());
 266  
 267                  if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {
 268                      adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);
 269                      fields += &quot;,ROWTIME.ROWTIME&quot;;
 270                  } else {
 271                      fields += &quot;,PROCTIME.PROCTIME&quot;;
 272                  }
 273  
 274                  Table regTable = tableEnv.fromDataStream(adaptStream, fields);
 275                  tableEnv.registerTable(tableInfo.getName(), regTable);
 276                  if (LOG.isInfoEnabled()) {
 277                      LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());
 278                  }
 279                  registerTableCache.put(tableInfo.getName(), regTable);
 280  
<abbr title=" 281                  URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 281                  URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTa🔵</abbr>
 282                  pluginClassPatshSets.add(sourceTablePathUrl);
 283              } else if (tableInfo instanceof TargetTableInfo) {
 284  
<abbr title=" 285                  TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPath);"> 285                  TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPa🔵</abbr>
 286                  TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());
 287                  tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);
 288  
<abbr title=" 289                  URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 289                  URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTabl🔵</abbr>
 290                  pluginClassPatshSets.add(sinkTablePathUrl);
 291              } else if (tableInfo instanceof SideTableInfo) {
<abbr title=" 292                  String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 292                  String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;🔵</abbr>
 293                  sideTableMap.put(tableInfo.getName(), (SideTableInfo) tableInfo);
 294  
<abbr title=" 295                  URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 295                  URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideT🔵</abbr>
 296                  pluginClassPatshSets.add(sideTablePathUrl);
 297              } else {
 298                  throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());
 299              }
 300          }
 301          return pluginClassPatshSets;
 302      }
 303  
 304      /**
 305       *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph
 306       * @param env
 307       * @param classPathSet
 308       */
 309      private static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {
 310          int i = 0;
 311          for (URL url : classPathSet) {
 312              String classFileName = String.format(CLASS_FILE_NAME_FMT, i);
 313              env.registerCachedFile(url.getPath(), classFileName, true);
 314              i++;
 315          }
 316      }
 317  
<abbr title=" 318      private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 318      private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws🔵</abbr>
 319          StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?
 320                  StreamExecutionEnvironment.getExecutionEnvironment() :
 321                  new MyLocalStreamEnvironment();
 322  
 323          StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);
 324          return env;




 325      }
 326  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            