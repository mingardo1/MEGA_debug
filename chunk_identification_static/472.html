<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>472</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    472
                    <a href="471.html">prev</a>
                    <a href="473.html">next</a>
                    <a href="472_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_e346a804d69c8cd0124b4eb3d35156cfb5cd0779_mongo/mongo-side/mongo-async-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAsyncReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779:mongo/mongo-side/mongo-async-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAsyncReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^1:mongo/mongo-side/mongo-async-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAsyncReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^2:mongo/mongo-side/mongo-async-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAsyncReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;6e351a99f6e8449c76ad55e517a5da6cbb108379:mongo/mongo-side/mongo-async-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAsyncReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [b], [j]], subset: [[b], [b], [bj], [b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.side.mongo;
  21 
  22 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import org.apache.flink.api.java.tuple.Tuple2;</span>
  24 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
  26 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import org.apache.commons.lang3.StringUtils;</span>
  28 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  29 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  30 import org.apache.flink.configuration.Configuration;
  31 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  32 import org.apache.flink.types.Row;
  33 
  34 import com.dtstack.flink.sql.enums.ECacheContentType;
  35 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  36 import com.dtstack.flink.sql.side.FieldInfo;
  37 import com.dtstack.flink.sql.side.JoinInfo;
  38 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  39 import com.dtstack.flink.sql.side.cache.CacheObj;
  40 import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;
  41 import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;
  42 import com.google.common.collect.Lists;
  43 import com.mongodb.BasicDBObject;
  44 import com.mongodb.Block;
  45 import com.mongodb.ConnectionString;
  46 import com.mongodb.async.SingleResultCallback;
  47 import com.mongodb.async.client.MongoClient;
  48 import com.mongodb.MongoClientSettings;
  49 import com.mongodb.async.client.MongoClients;
  50 import com.mongodb.async.client.MongoCollection;
  51 import com.mongodb.async.client.MongoDatabase;
  52 import org.bson.Document;
  53 import org.slf4j.Logger;
  54 import org.slf4j.LoggerFactory;
  55 
  56 import java.util.Collection;
  57 import java.util.Collections;
  58 import java.util.List;
  59 import java.util.Map;
  60 import java.util.concurrent.atomic.AtomicInteger;
  61 
  62 /**
  63  * Reason:
  64  * Date: 2018/11/6
  65  *
  66  * @author xuqianjin
  67  */
  68 public class MongoAsyncReqRow extends BaseAsyncReqRow {
  69     private static final long serialVersionUID = -1183158242862673706L;
  70 
  71     private static final Logger LOG = LoggerFactory.getLogger(MongoAsyncReqRow.class);
  72 
  73     private transient MongoClient mongoClient;
  74 
  75     private MongoDatabase db;
  76 
  77     private MongoSideTableInfo mongoSideTableInfo;
  78 
<abbr title="  79     public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  79     public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,üîµ</abbr>
  80         super(new MongoAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  81     }
  82 
  83     @Override
  84     public void open(Configuration parameters) throws Exception {
  85         super.open(parameters);
  86         mongoSideTableInfo = (MongoSideTableInfo) sideInfo.getSideTableInfo();
  87         connMongoDb();
  88     }
  89 
  90     public void connMongoDb() throws Exception {
<abbr title="  91         ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAddress(),">  91         ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAüîµ</abbr>
  92                 mongoSideTableInfo.getUserName(), mongoSideTableInfo.getPassword()));
  93         MongoClientSettings settings = MongoClientSettings.builder()
  94                 .applyConnectionString(connectionString)
  95                 .build();
  96         mongoClient = MongoClients.create(settings);
  97         db = mongoClient.getDatabase(mongoSideTableInfo.getDatabase());
  98     }
  99 
 100     @Override
 101 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 102     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {"> 102     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) thüîµ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         Tuple2&lt;Boolean, Row&gt; inputCopy = Tuple2.of(input.f0, input.f1);</span>
 104 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108         CRow inputCopy = new CRow(input.row(), input.change());</span>
 109 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 110     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 110     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFüîµ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111         CRow inputCopy = new CRow(Row.copy(input.row()), input.change());</span>
 112 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 113         BasicDBObject basicDbObject = new BasicDBObject();
 114 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115         for (int i = 0; i &lt; sideInfo.getEqualFieldList().size(); i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117             Object equalObj = inputCopy.f1.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118             if (equalObj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122             basicDbObject.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123         }</span>
 124 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         BasicDBObject basicDbObject = new BasicDBObject();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         for (int i = 0; i &lt; sideInfo.getEqualFieldList().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129             Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133             }</span>
 134 =======
 135 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 136         try {
 137             basicDbObject.putAll(inputParams);
 138             // Â°´ÂÖÖË∞ìËØç
 139             sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {
 140                 BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
 141                 if (null != filterCondition) {
 142                     basicDbObject.append(info.getFieldName(), filterCondition);
 143                 }
 144                 return info;
 145             }).count();
 146         } catch (Exception e) {
 147             LOG.info(&quot;add predicate infoes error &quot;, e);
 148         }
 149 
 150         String key = buildCacheKey(inputParams);
 151 
 152 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155                     return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157                     List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158                     for (Object jsonArray : (List) val.getContent()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159                         Row row = fillData(inputCopy.f1, jsonArray);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160                         rowList.add(Tuple2.of(inputCopy.f0, row));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162                     resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164                     throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168         }</span>
 169 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170                 return info;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171             }).count();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173             LOG.info(&quot;add predicate infoes error &quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176         String key = buildCacheKey(basicDbObject.values());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185                     List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186                     for (Object jsonArray : (List) val.getContent()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187                         Row row = fillData(inputCopy.row(), jsonArray);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188                         rowList.add(new CRow(row, inputCopy.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190                     resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                     throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                 return;</span>
 195 =======
 196 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 197         AtomicInteger atomicInteger = new AtomicInteger(0);
<abbr title=" 198         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.class);"> 198         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.classüîµ</abbr>
 199         List&lt;Document&gt; cacheContent = Lists.newArrayList();
 200         Block&lt;Document&gt; printDocumentBlock = new Block&lt;Document&gt;() {
 201             @Override
 202             public void apply(final Document document) {
 203                 atomicInteger.incrementAndGet();
 204                 Row row = fillData(inputCopy.f1, document);
 205                 if (openCache()) {
 206                     cacheContent.add(document);
 207                 }
 208                 resultFuture.complete(Collections.singleton(Tuple2.of(inputCopy.f0,row)));
 209             }
 210         };
 211         SingleResultCallback&lt;Void&gt; callbackWhenFinished = new SingleResultCallback&lt;Void&gt;() {
 212             @Override
 213             public void onResult(final Void result, final Throwable t) {
 214                 if (atomicInteger.get() &lt;= 0) {
 215                     LOG.warn(&quot;Cannot retrieve the data from the database&quot;);
 216                     resultFuture.complete(null);
 217                 } else {
 218                     if (openCache()) {
 219                         putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 220                     }
 221                 }
 222             }
 223         };
 224         dbCollection.find(basicDbObject).forEach(printDocumentBlock, callbackWhenFinished);
 225     }
 226 
 227     @Override
 228     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 229         StringBuilder sb = new StringBuilder();
 230         for (Object ele : inputParams.values()) {
 231             sb.append(ele.toString())
 232                     .append(&quot;_&quot;);
 233         }
 234 
 235         return sb.toString();
 236     }
 237 
 238     @Override
 239     public Row fillData(Row input, Object line) {
 240         Document doc = (Document) line;
 241         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 242         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 243             Object obj = input.getField(entry.getValue());
 244             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 245             row.setField(entry.getKey(), obj);
 246         }
 247 
 248         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 249             if (doc == null) {
 250                 row.setField(entry.getKey(), null);
 251             } else {
<abbr title=" 252                 row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())));"> 252                 row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())üîµ</abbr>
 253             }
 254         }
 255 
 256         return row;
 257     }
 258 
 259     @Override
 260     public void close() throws Exception {
 261         super.close();
 262         try {
 263             if (mongoClient != null) {
 264                 mongoClient.close();
 265             }
 266         } catch (Exception e) {
 267             throw new RuntimeException(&quot;[closeMongoDB]:&quot; + e.getMessage());
 268         }
 269     }
 270 
 271     private String getConnectionUrl(String address, String userName, String password){
 272         if(address.startsWith(&quot;mongodb://&quot;) || address.startsWith(&quot;mongodb+srv://&quot;)){
 273             return  address;
 274         }
 275         if (StringUtils.isNotBlank(userName) &amp;&amp; StringUtils.isNotBlank(password)) {
 276             return String.format(&quot;mongodb://%s:%s@%s&quot;, userName, password, address);
 277         }
 278         return String.format(&quot;mongodb://%s&quot;, address);
 279     }
 280 
 281 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.side.mongo;
  21 
  22 import org.apache.flink.api.java.tuple.Tuple2;
  23 
  24 import org.apache.commons.lang3.StringUtils;
  25 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  26 import org.apache.flink.configuration.Configuration;
  27 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  28 import org.apache.flink.types.Row;
  29 
  30 import com.dtstack.flink.sql.enums.ECacheContentType;
  31 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  32 import com.dtstack.flink.sql.side.FieldInfo;
  33 import com.dtstack.flink.sql.side.JoinInfo;
  34 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  35 import com.dtstack.flink.sql.side.cache.CacheObj;
  36 import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;
  37 import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;
  38 import com.google.common.collect.Lists;
  39 import com.mongodb.BasicDBObject;
  40 import com.mongodb.Block;
  41 import com.mongodb.ConnectionString;
  42 import com.mongodb.async.SingleResultCallback;
  43 import com.mongodb.async.client.MongoClient;
  44 import com.mongodb.MongoClientSettings;
  45 import com.mongodb.async.client.MongoClients;
  46 import com.mongodb.async.client.MongoCollection;
  47 import com.mongodb.async.client.MongoDatabase;
  48 import org.bson.Document;
  49 import org.slf4j.Logger;
  50 import org.slf4j.LoggerFactory;
  51 
  52 import java.util.Collection;
  53 import java.util.Collections;
  54 import java.util.List;
  55 import java.util.Map;
  56 import java.util.concurrent.atomic.AtomicInteger;
  57 
  58 /**
  59  * Reason:
  60  * Date: 2018/11/6
  61  *
  62  * @author xuqianjin
  63  */
  64 public class MongoAsyncReqRow extends BaseAsyncReqRow {
  65     private static final long serialVersionUID = -1183158242862673706L;
  66 
  67     private static final Logger LOG = LoggerFactory.getLogger(MongoAsyncReqRow.class);
  68 
  69     private transient MongoClient mongoClient;
  70 
  71     private MongoDatabase db;
  72 
  73     private MongoSideTableInfo mongoSideTableInfo;
  74 
<abbr title="  75     public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  75     public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,üîµ</abbr>
  76         super(new MongoAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  77     }
  78 
  79     @Override
  80     public void open(Configuration parameters) throws Exception {
  81         super.open(parameters);
  82         mongoSideTableInfo = (MongoSideTableInfo) sideInfo.getSideTableInfo();
  83         connMongoDb();
  84     }
  85 
  86     public void connMongoDb() throws Exception {
<abbr title="  87         ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAddress(),">  87         ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAüîµ</abbr>
  88                 mongoSideTableInfo.getUserName(), mongoSideTableInfo.getPassword()));
  89         MongoClientSettings settings = MongoClientSettings.builder()
  90                 .applyConnectionString(connectionString)
  91                 .build();
  92         mongoClient = MongoClients.create(settings);
  93         db = mongoClient.getDatabase(mongoSideTableInfo.getDatabase());
  94     }
  95 
  96 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  98     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {">  98     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) thüîµ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99         Tuple2&lt;Boolean, Row&gt; inputCopy = Tuple2.of(input.f0, input.f1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100         BasicDBObject basicDbObject = new BasicDBObject();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101         for (int i = 0; i &lt; sideInfo.getEqualFieldList().size(); i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103             Object equalObj = inputCopy.f1.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104             if (equalObj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108             basicDbObject.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110         try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111             // Â°´ÂÖÖË∞ìËØç</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112             sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113                 BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114                 if (null != filterCondition) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115                     basicDbObject.append(info.getFieldName(), filterCondition);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117                 return info;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118             }).count();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119         } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120             LOG.info(&quot;add predicate infoes error &quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123         String key = buildCacheKey(basicDbObject.values());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124         if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126             if (val != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130                     return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132                     List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133                     for (Object jsonArray : (List) val.getContent()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134                         Row row = fillData(inputCopy.f1, jsonArray);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135                         rowList.add(Tuple2.of(inputCopy.f0, row));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137                     resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139                     throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144         AtomicInteger atomicInteger = new AtomicInteger(0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 145         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.class);"> 145         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.classüîµ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146         List&lt;Document&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147         Block&lt;Document&gt; printDocumentBlock = new Block&lt;Document&gt;() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148             @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149             public void apply(final Document document) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150                 atomicInteger.incrementAndGet();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151                 Row row = fillData(inputCopy.f1, document);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152                 if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153                     cacheContent.add(document);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155                 resultFuture.complete(Collections.singleton(Tuple2.of(inputCopy.f0,row)));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157         };</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158         SingleResultCallback&lt;Void&gt; callbackWhenFinished = new SingleResultCallback&lt;Void&gt;() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159             @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160             public void onResult(final Void result, final Throwable t) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161                 if (atomicInteger.get() &lt;= 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162                     LOG.warn(&quot;Cannot retrieve the data from the database&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163                     resultFuture.complete(null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165                     if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166                         putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170         };</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171         dbCollection.find(basicDbObject).forEach(printDocumentBlock, callbackWhenFinished);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172     }</span>
 173 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176         CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         BasicDBObject basicDbObject = new BasicDBObject();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178         for (int i = 0; i &lt; sideInfo.getEqualFieldList().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180             Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185             basicDbObject.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188             // Â°´ÂÖÖË∞ìËØç</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189             sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190                 BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                 if (null != filterCondition) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                     basicDbObject.append(info.getFieldName(), filterCondition);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                 return info;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195             }).count();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197             LOG.info(&quot;add predicate infoes error &quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200         String key = buildCacheKey(basicDbObject.values());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209                     List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210                     for (Object jsonArray : (List) val.getContent()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211                         Row row = fillData(inputCopy.row(), jsonArray);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212                         rowList.add(new CRow(row, inputCopy.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214                     resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216                     throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221         AtomicInteger atomicInteger = new AtomicInteger(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 222         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.class);"> 222         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.classüîµ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223         List&lt;Document&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224         Block&lt;Document&gt; printDocumentBlock = new Block&lt;Document&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226             public void apply(final Document document) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227                 atomicInteger.incrementAndGet();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228                 Row row = fillData(inputCopy.row(), document);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229                 if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230                     cacheContent.add(document);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232                 resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234         };</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235         SingleResultCallback&lt;Void&gt; callbackWhenFinished = new SingleResultCallback&lt;Void&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237             public void onResult(final Void result, final Throwable t) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238                 if (atomicInteger.get() &lt;= 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239                     LOG.warn(&quot;Cannot retrieve the data from the database&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240                     resultFuture.complete(null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242                     if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243                         putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247         };</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248         dbCollection.find(basicDbObject).forEach(printDocumentBlock, callbackWhenFinished);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249     }</span>
 250 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251 </span>
 252 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 253 
 254     @Override
<abbr title=" 255     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 255     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFüîµ</abbr>
 256         CRow inputCopy = new CRow(Row.copy(input.row()), input.change());
 257         BasicDBObject basicDbObject = new BasicDBObject();
 258         try {
 259             basicDbObject.putAll(inputParams);
 260             // Â°´ÂÖÖË∞ìËØç
 261             sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {
 262                 BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
 263                 if (null != filterCondition) {
 264                     basicDbObject.append(info.getFieldName(), filterCondition);
 265                 }
 266                 return info;
 267             }).count();
 268         } catch (Exception e) {
 269             LOG.info(&quot;add predicate infoes error &quot;, e);
 270         }
 271 
 272         String key = buildCacheKey(inputParams);
 273 
 274         AtomicInteger atomicInteger = new AtomicInteger(0);
<abbr title=" 275         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.class);"> 275         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.classüîµ</abbr>
 276         List&lt;Document&gt; cacheContent = Lists.newArrayList();
 277         Block&lt;Document&gt; printDocumentBlock = new Block&lt;Document&gt;() {
 278             @Override
 279             public void apply(final Document document) {
 280                 atomicInteger.incrementAndGet();
 281                 Row row = fillData(inputCopy.row(), document);
 282                 if (openCache()) {
 283                     cacheContent.add(document);
 284                 }
 285                 resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));
 286             }
 287         };
 288         SingleResultCallback&lt;Void&gt; callbackWhenFinished = new SingleResultCallback&lt;Void&gt;() {
 289             @Override
 290             public void onResult(final Void result, final Throwable t) {
 291                 if (atomicInteger.get() &lt;= 0) {
 292                     LOG.warn(&quot;Cannot retrieve the data from the database&quot;);
 293                     resultFuture.complete(null);
 294                 } else {
 295                     if (openCache()) {
 296                         putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 297                     }
 298                 }
 299             }
 300         };
 301         dbCollection.find(basicDbObject).forEach(printDocumentBlock, callbackWhenFinished);
 302     }
 303 
 304     @Override
 305     public Row fillData(Row input, Object line) {
 306         Document doc = (Document) line;
 307         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 308         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 309             Object obj = input.getField(entry.getValue());
 310             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 311             row.setField(entry.getKey(), obj);
 312         }
 313 
 314         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 315             if (doc == null) {
 316                 row.setField(entry.getKey(), null);
 317             } else {
<abbr title=" 318                 row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())));"> 318                 row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())üîµ</abbr>
 319             }
 320         }
 321 
 322         return row;
 323     }
 324 
 325     @Override
 326     public void close() throws Exception {
 327         super.close();
 328         try {
 329             if (mongoClient != null) {
 330                 mongoClient.close();
 331             }
 332         } catch (Exception e) {
 333             throw new RuntimeException(&quot;[closeMongoDB]:&quot; + e.getMessage());
 334         }
 335     }
 336 
 337     @Override
 338     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 339         StringBuilder sb = new StringBuilder();
 340         for (Object ele : inputParams.values()) {
 341             sb.append(ele.toString())
 342                     .append(&quot;_&quot;);
 343         }
 344 
 345         return sb.toString();
 346     }
 347 
 348     private String getConnectionUrl(String address, String userName, String password){
 349         if(address.startsWith(&quot;mongodb://&quot;) || address.startsWith(&quot;mongodb+srv://&quot;)){
 350             return  address;
 351         }
 352         if (StringUtils.isNotBlank(userName) &amp;&amp; StringUtils.isNotBlank(password)) {
 353             return String.format(&quot;mongodb://%s:%s@%s&quot;, userName, password, address);
 354         }
 355         return String.format(&quot;mongodb://%s&quot;, address);
 356     }
 357 
 358 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.mongo;
  19 
  20 import com.dtstack.flink.sql.enums.ECacheContentType;
  21 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  23 import com.dtstack.flink.sql.side.FieldInfo;
  24 import com.dtstack.flink.sql.side.JoinInfo;
  25 import com.dtstack.flink.sql.side.cache.CacheObj;
  26 import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;
  27 import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;
  28 import com.google.common.collect.Lists;
  29 import com.mongodb.BasicDBObject;
  30 import com.mongodb.Block;
  31 import com.mongodb.ConnectionString;
  32 import com.mongodb.MongoClientSettings;
  33 import com.mongodb.async.SingleResultCallback;
  34 import com.mongodb.async.client.MongoClient;
  35 import com.mongodb.async.client.MongoClients;
  36 import com.mongodb.async.client.MongoCollection;
  37 import com.mongodb.async.client.MongoDatabase;
  38 import java.util.Collection;
  39 import java.util.Collections;
  40 import java.util.List;
  41 import java.util.Map;
  42 import java.util.concurrent.atomic.AtomicInteger;
  43 import org.apache.commons.lang3.StringUtils;
  44 import org.apache.flink.api.java.tuple.Tuple2;
  45 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  46 import org.apache.flink.configuration.Configuration;
  47 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  48 import org.apache.flink.types.Row;
  49 import org.bson.Document;
  50 import org.slf4j.Logger;
  51 import org.slf4j.LoggerFactory;
  52 
  53 
  54 /**
  55  * Reason:
  56  * Date: 2018/11/6
  57  *
  58  * @author xuqianjin
  59  */
  60 public class MongoAsyncReqRow extends BaseAsyncReqRow {
  61     private static final long serialVersionUID = -1183158242862673706L;
  62 
  63     private static final Logger LOG = LoggerFactory.getLogger(MongoAsyncReqRow.class);
  64 
  65     private transient MongoClient mongoClient;
  66 
  67     private MongoDatabase db;
  68 
  69     private MongoSideTableInfo mongoSideTableInfo;
  70 
<abbr title="  71     public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  71     public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,üîµ</abbr>
  72         super(new MongoAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  73     }
  74 
  75     @Override
  76     public void open(Configuration parameters) throws Exception {
  77         super.open(parameters);
  78         mongoSideTableInfo = (MongoSideTableInfo) sideInfo.getSideTableInfo();
  79         connMongoDb();
  80     }
  81 
  82     public void connMongoDb() throws Exception {
<abbr title="  83         ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAddress(), mongoSideTableInfo.getUserName(), mongoSideTableInfo.getPassword()));">  83         ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAüîµ</abbr>
<abbr title="  84         MongoClientSettings settings = MongoClientSettings.builder().applyConnectionString(connectionString).build();">  84         MongoClientSettings settings = MongoClientSettings.builder().applyConnectionString(connectionStriüîµ</abbr>
  85         mongoClient = MongoClients.create(settings);
  86         db = mongoClient.getDatabase(mongoSideTableInfo.getDatabase());
  87     }
  88 
  89     @Override
<abbr title="  90     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Tuple2&lt;Boolean, Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean, Row&gt;&gt; resultFuture) throws Exception {">  90     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Tuple2&lt;Boolean, Row&gt; input, ResultFutuüîµ</abbr>
  91         Tuple2&lt;Boolean, Row&gt; inputCopy = Tuple2.of(input.f0, input.f1);
  92         BasicDBObject basicDbObject = new BasicDBObject();
  93         try {
  94             basicDbObject.putAll(inputParams);
  95             // Â°´ÂÖÖË∞ìËØç
  96             sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(( info) -&gt; {
  97                 BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
  98                 if (null != filterCondition) {
  99                     basicDbObject.append(info.getFieldName(), filterCondition);
 100                 }
 101                 return info;
 102             }).count();
 103         } catch (java.lang.Exception e) {
 104             LOG.info(&quot;add predicate infoes error &quot;, e);
 105         }
 106         String key = buildCacheKey(inputParams);
 107         AtomicInteger atomicInteger = new AtomicInteger(0);
<abbr title=" 108         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.class);"> 108         MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.classüîµ</abbr>
 109         List&lt;Document&gt; cacheContent = Lists.newArrayList();
 110         Block&lt;Document&gt; printDocumentBlock = new Block&lt;Document&gt;() {
 111             @Override
 112             public void apply(final Document document) {
 113                 atomicInteger.incrementAndGet();
 114                 Row row = fillData(inputCopy.f1, document);
 115                 if (openCache()) {
 116                     cacheContent.add(document);
 117                 }
 118                 resultFuture.complete(Collections.singleton(Tuple2.of(inputCopy.f0, row)));
 119             }
 120         };
 121         SingleResultCallback&lt;Void&gt; callbackWhenFinished = new SingleResultCallback&lt;Void&gt;() {
 122             @Override
 123             public void onResult(final Void result, final Throwable t) {
 124                 if (atomicInteger.get() &lt;= 0) {
 125                     LOG.warn(&quot;Cannot retrieve the data from the database&quot;);
 126                     resultFuture.complete(null);
 127                 } else if (openCache()) {
 128                     putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 129                 }
 130             }
 131         };
 132         dbCollection.find(basicDbObject).forEach(printDocumentBlock, callbackWhenFinished);
 133     }
 134 
 135     @Override
 136     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 137         StringBuilder sb = new StringBuilder();
 138         for (Object ele : inputParams.values()) {
 139             sb.append(ele.toString()).append(&quot;_&quot;);
 140         }
 141         return sb.toString();
 142     }
 143 
 144     @Override
 145     public Row fillData(Row input, Object line) {
 146         Document doc = ((Document) (line));
 147         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 148         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 149             Object obj = input.getField(entry.getValue());
 150             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 151             row.setField(entry.getKey(), obj);
 152         }
 153         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 154             if (doc == null) {
 155                 row.setField(entry.getKey(), null);
 156             } else {
<abbr title=" 157                 row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())));"> 157                 row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())üîµ</abbr>
 158             }
 159         }
 160         return row;
 161     }
 162 
 163     @Override
 164     public void close() throws Exception {
 165         super.close();
 166         try {
 167             if (mongoClient != null) {
 168                 mongoClient.close();
 169             }
 170         } catch (Exception e) {
 171             throw new RuntimeException(&quot;[closeMongoDB]:&quot; + e.getMessage());
 172         }
 173     }
 174 
 175     private String getConnectionUrl(String address, String userName, String password){
 176         if(address.startsWith(&quot;mongodb://&quot;) || address.startsWith(&quot;mongodb+srv://&quot;)){
 177             return  address;
 178         }
 179         if (StringUtils.isNotBlank(userName) &amp;&amp; StringUtils.isNotBlank(password)) {
 180             return String.format(&quot;mongodb://%s:%s@%s&quot;, userName, password, address);
 181         }
 182         return String.format(&quot;mongodb://%s&quot;, address);
 183     }
 184 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql.side.mongo;
  21  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.apache.flink.api.java.tuple.Tuple2;</span>
  23  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  24  import org.apache.flink.configuration.Configuration;
  25  import org.apache.flink.streaming.api.functions.async.ResultFuture;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
  28  import org.apache.flink.types.Row;
  29  
  30  import com.dtstack.flink.sql.enums.ECacheContentType;
  31  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  32  import com.dtstack.flink.sql.side.FieldInfo;
  33  import com.dtstack.flink.sql.side.JoinInfo;
  34  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  35  import com.dtstack.flink.sql.side.cache.CacheObj;
  36  import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;
  37  import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;
  38  import com.google.common.collect.Lists;
  39  import com.mongodb.BasicDBObject;
  40  import com.mongodb.Block;
  41  import com.mongodb.ConnectionString;
  42  import com.mongodb.async.SingleResultCallback;
  43  import com.mongodb.async.client.MongoClient;
  44  import com.mongodb.MongoClientSettings;
  45  import com.mongodb.async.client.MongoClients;
  46  import com.mongodb.async.client.MongoCollection;
  47  import com.mongodb.async.client.MongoDatabase;
  48  import org.bson.Document;
  49  import org.slf4j.Logger;
  50  import org.slf4j.LoggerFactory;
  51  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import java.sql.Timestamp;</span>
  53  import java.util.Collection;
  54  import java.util.Collections;
  55  import java.util.List;
  56  import java.util.Map;
  57  import java.util.concurrent.atomic.AtomicInteger;
  58  
  59  /**
  60   * Reason:
  61   * Date: 2018/11/6
  62   *
  63   * @author xuqianjin
  64   */
  65  public class MongoAsyncReqRow extends BaseAsyncReqRow {
  66      private static final long serialVersionUID = -1183158242862673706L;
  67  
  68      private static final Logger LOG = LoggerFactory.getLogger(MongoAsyncReqRow.class);
  69  
  70      private transient MongoClient mongoClient;
  71  
  72      private MongoDatabase db;
  73  
  74      private MongoSideTableInfo mongoSideTableInfo;
  75  
<abbr title="  76      public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  76      public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, Abstractüîµ</abbr>
  77          super(new MongoAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  78      }
  79  
  80      @Override
  81      public void open(Configuration parameters) throws Exception {
  82          super.open(parameters);
  83          mongoSideTableInfo = (MongoSideTableInfo) sideInfo.getSideTableInfo();
  84          connMongoDb();
  85      }
  86  
  87      public void connMongoDb() throws Exception {
  88          String address = mongoSideTableInfo.getAddress();
  89          ConnectionString connectionString = new ConnectionString(address);
  90  


  91          MongoClientSettings settings = MongoClientSettings.builder()
  92                  .applyConnectionString(connectionString)
  93                  .build();
  94          mongoClient = MongoClients.create(settings);
  95          db = mongoClient.getDatabase(mongoSideTableInfo.getDatabase());
  96      }
  97  
  98      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -        CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 101 +    public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {"> 101 +    public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exceüîµ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +        Tuple2&lt;Boolean, Row&gt; inputCopy = Tuple2.of(input.f0, input.f1);</span>
 103          BasicDBObject basicDbObject = new BasicDBObject();
 104          for (int i = 0; i &lt; sideInfo.getEqualFieldList().size(); i++) {
 105              Integer conValIndex = sideInfo.getEqualValIndex().get(i);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -            Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +            Object equalObj = inputCopy.f1.getField(conValIndex);</span>
 108              if (equalObj == null) {
 109                  dealMissKey(inputCopy, resultFuture);
 110                  return;
 111              }
 112              basicDbObject.put(sideInfo.getEqualFieldList().get(i), equalObj);
 113          }
 114          try {

 115              // Â°´ÂÖÖË∞ìËØç
 116              sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {
 117                  BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
 118                  if (null != filterCondition) {
 119                      basicDbObject.append(info.getFieldName(), filterCondition);
 120                  }
 121                  return info;
 122              }).count();
 123          } catch (Exception e) {
 124              LOG.info(&quot;add predicate infoes error &quot;, e);
 125          }
 126  
 127          String key = buildCacheKey(basicDbObject.values());
 128          if (openCache()) {
 129              CacheObj val = getFromCache(key);
 130              if (val != null) {
 131  
 132                  if (ECacheContentType.MissVal == val.getType()) {
 133                      dealMissKey(inputCopy, resultFuture);
 134                      return;
 135                  } else if (ECacheContentType.MultiLine == val.getType()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -                    List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +                    List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();</span>
 138                      for (Object jsonArray : (List) val.getContent()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -                        Row row = fillData(inputCopy.row(), jsonArray);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -                        rowList.add(new CRow(row, inputCopy.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +                        Row row = fillData(inputCopy.f1, jsonArray);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +                        rowList.add(Tuple2.of(inputCopy.f0, row));</span>
 143                      }
 144                      resultFuture.complete(rowList);
 145                  } else {
 146                      throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());
 147                  }
 148                  return;
 149              }
 150          }


 151          AtomicInteger atomicInteger = new AtomicInteger(0);
 152          MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.class);
 153          List&lt;Document&gt; cacheContent = Lists.newArrayList();
 154          Block&lt;Document&gt; printDocumentBlock = new Block&lt;Document&gt;() {
 155              @Override
 156              public void apply(final Document document) {
 157                  atomicInteger.incrementAndGet();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -                Row row = fillData(inputCopy.row(), document);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +                Row row = fillData(inputCopy.f1, document);</span>
 160                  if (openCache()) {
 161                      cacheContent.add(document);
 162                  }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -                resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +                resultFuture.complete(Collections.singleton(Tuple2.of(inputCopy.f0,row)));</span>
 165              }
 166          };
 167          SingleResultCallback&lt;Void&gt; callbackWhenFinished = new SingleResultCallback&lt;Void&gt;() {
 168              @Override
 169              public void onResult(final Void result, final Throwable t) {
 170                  if (atomicInteger.get() &lt;= 0) {
 171                      LOG.warn(&quot;Cannot retrieve the data from the database&quot;);
 172                      resultFuture.complete(null);
 173                  } else {
 174                      if (openCache()) {
 175                          putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 176                      }
 177                  }
 178              }
 179          };
 180          dbCollection.find(basicDbObject).forEach(printDocumentBlock, callbackWhenFinished);
 181      }
 182  
 183      @Override











 184      public Row fillData(Row input, Object line) {
 185          Document doc = (Document) line;
 186          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 187          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 188              Object obj = input.getField(entry.getValue());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 189 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 189 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoüîµ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -            if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -                obj = ((Timestamp) obj).getTime();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +            obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
 196              row.setField(entry.getKey(), obj);
 197          }
 198  
 199          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 200              if (doc == null) {
 201                  row.setField(entry.getKey(), null);
 202              } else {
 203                  row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())));
 204              }
 205          }
 206  
 207          return row;
 208      }
 209  
 210      @Override
 211      public void close() throws Exception {
 212          super.close();
 213          try {
 214              if (mongoClient != null) {
 215                  mongoClient.close();
 216              }
 217          } catch (Exception e) {
 218              throw new RuntimeException(&quot;[closeMongoDB]:&quot; + e.getMessage());
 219          }
 220      }
 221  
 222      public String buildCacheKey(Collection collection) {
 223          StringBuilder sb = new StringBuilder();
 224          for (Object ele : collection) {
 225              sb.append(ele.toString())
 226                      .append(&quot;_&quot;);
 227          }
 228  
 229          return sb.toString();








 230      }
 231  
 232  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql.side.mongo;
  21  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.apache.commons.lang3.StringUtils;</span>
  23  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  24  import org.apache.flink.configuration.Configuration;
  25  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  26  import org.apache.flink.table.runtime.types.CRow;
  27  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  28  import org.apache.flink.types.Row;
  29  
  30  import com.dtstack.flink.sql.enums.ECacheContentType;
  31  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  32  import com.dtstack.flink.sql.side.FieldInfo;
  33  import com.dtstack.flink.sql.side.JoinInfo;
  34  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  35  import com.dtstack.flink.sql.side.cache.CacheObj;
  36  import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;
  37  import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;
  38  import com.google.common.collect.Lists;
  39  import com.mongodb.BasicDBObject;
  40  import com.mongodb.Block;
  41  import com.mongodb.ConnectionString;
  42  import com.mongodb.async.SingleResultCallback;
  43  import com.mongodb.async.client.MongoClient;
  44  import com.mongodb.MongoClientSettings;
  45  import com.mongodb.async.client.MongoClients;
  46  import com.mongodb.async.client.MongoCollection;
  47  import com.mongodb.async.client.MongoDatabase;
  48  import org.bson.Document;
  49  import org.slf4j.Logger;
  50  import org.slf4j.LoggerFactory;
  51  
  52  import java.sql.Timestamp;
  53  import java.util.Collection;
  54  import java.util.Collections;
  55  import java.util.List;
  56  import java.util.Map;
  57  import java.util.concurrent.atomic.AtomicInteger;
  58  
  59  /**
  60   * Reason:
  61   * Date: 2018/11/6
  62   *
  63   * @author xuqianjin
  64   */
  65  public class MongoAsyncReqRow extends BaseAsyncReqRow {
  66      private static final long serialVersionUID = -1183158242862673706L;
  67  
  68      private static final Logger LOG = LoggerFactory.getLogger(MongoAsyncReqRow.class);
  69  
  70      private transient MongoClient mongoClient;
  71  
  72      private MongoDatabase db;
  73  
  74      private MongoSideTableInfo mongoSideTableInfo;
  75  
<abbr title="  76      public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  76      public MongoAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, Abstractüîµ</abbr>
  77          super(new MongoAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  78      }
  79  
  80      @Override
  81      public void open(Configuration parameters) throws Exception {
  82          super.open(parameters);
  83          mongoSideTableInfo = (MongoSideTableInfo) sideInfo.getSideTableInfo();
  84          connMongoDb();
  85      }
  86  
  87      public void connMongoDb() throws Exception {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -        String address = mongoSideTableInfo.getAddress();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -        ConnectionString connectionString = new ConnectionString(address);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +        ConnectionString connectionString = new ConnectionString(getConnectionUrl(mongoSideTableInfo.getAddress(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +                mongoSideTableInfo.getUserName(), mongoSideTableInfo.getPassword()));</span>
  93          MongoClientSettings settings = MongoClientSettings.builder()
  94                  .applyConnectionString(connectionString)
  95                  .build();
  96          mongoClient = MongoClients.create(settings);
  97          db = mongoClient.getDatabase(mongoSideTableInfo.getDatabase());
  98      }
  99  
 100      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -        CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 103 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 103 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) thüîµ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        CRow inputCopy = new CRow(Row.copy(input.row()), input.change());</span>
 105          BasicDBObject basicDbObject = new BasicDBObject();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -        for (int i = 0; i &lt; sideInfo.getEqualFieldList().size(); i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -            Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -            Object equalObj = inputCopy.row().getField(conValIndex);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -            if (equalObj == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -                dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -            basicDbObject.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -        }</span>
 115          try {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +            basicDbObject.putAll(inputParams);</span>
 117              // Â°´ÂÖÖË∞ìËØç
 118              sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {
 119                  BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
 120                  if (null != filterCondition) {
 121                      basicDbObject.append(info.getFieldName(), filterCondition);
 122                  }
 123                  return info;
 124              }).count();
 125          } catch (Exception e) {
 126              LOG.info(&quot;add predicate infoes error &quot;, e);
 127          }
 128  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -        String key = buildCacheKey(basicDbObject.values());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -        if (openCache()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -            CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -            if (val != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -                if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -                    dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -                    return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -                } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -                    List&lt;CRow&gt; rowList = Lists.newArrayList();</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -                    for (Object jsonArray : (List) val.getContent()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -                        Row row = fillData(inputCopy.row(), jsonArray);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -                        rowList.add(new CRow(row, inputCopy.change()));</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -                    resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -                    throw new RuntimeException(&quot;not support cache obj type &quot; + val.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +        String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +</span>
 152          AtomicInteger atomicInteger = new AtomicInteger(0);
 153          MongoCollection dbCollection = db.getCollection(mongoSideTableInfo.getTableName(), Document.class);
 154          List&lt;Document&gt; cacheContent = Lists.newArrayList();
 155          Block&lt;Document&gt; printDocumentBlock = new Block&lt;Document&gt;() {
 156              @Override
 157              public void apply(final Document document) {
 158                  atomicInteger.incrementAndGet();
 159                  Row row = fillData(inputCopy.row(), document);

 160                  if (openCache()) {
 161                      cacheContent.add(document);
 162                  }
 163                  resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));

 164              }
 165          };
 166          SingleResultCallback&lt;Void&gt; callbackWhenFinished = new SingleResultCallback&lt;Void&gt;() {
 167              @Override
 168              public void onResult(final Void result, final Throwable t) {
 169                  if (atomicInteger.get() &lt;= 0) {
 170                      LOG.warn(&quot;Cannot retrieve the data from the database&quot;);
 171                      resultFuture.complete(null);
 172                  } else {
 173                      if (openCache()) {
 174                          putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 175                      }
 176                  }
 177              }
 178          };
 179          dbCollection.find(basicDbObject).forEach(printDocumentBlock, callbackWhenFinished);
 180      }
 181  
 182      @Override
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +    public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +        StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +        for (Object ele : inputParams.values()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +            sb.append(ele.toString())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +                    .append(&quot;_&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +        return sb.toString();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +    @Override</span>
 194      public Row fillData(Row input, Object line) {
 195          Document doc = (Document) line;
 196          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 197          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 198              Object obj = input.getField(entry.getValue());
<abbr title=" 199              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 199              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoüîµ</abbr>
 200  
 201              if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 202                  obj = ((Timestamp) obj).getTime();
 203              }
 204  

 205              row.setField(entry.getKey(), obj);
 206          }
 207  
 208          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 209              if (doc == null) {
 210                  row.setField(entry.getKey(), null);
 211              } else {
 212                  row.setField(entry.getKey(), doc.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())));
 213              }
 214          }
 215  
 216          return row;
 217      }
 218  
 219      @Override
 220      public void close() throws Exception {
 221          super.close();
 222          try {
 223              if (mongoClient != null) {
 224                  mongoClient.close();
 225              }
 226          } catch (Exception e) {
 227              throw new RuntimeException(&quot;[closeMongoDB]:&quot; + e.getMessage());
 228          }
 229      }
 230  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -    public String buildCacheKey(Collection collection) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -        StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -        for (Object ele : collection) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -            sb.append(ele.toString())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -                    .append(&quot;_&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -        return sb.toString();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +    private String getConnectionUrl(String address, String userName, String password){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +        if(address.startsWith(&quot;mongodb://&quot;) || address.startsWith(&quot;mongodb+srv://&quot;)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +            return  address;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +        if (StringUtils.isNotBlank(userName) &amp;&amp; StringUtils.isNotBlank(password)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +            return String.format(&quot;mongodb://%s:%s@%s&quot;, userName, password, address);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +        return String.format(&quot;mongodb://%s&quot;, address);</span>
 247      }
 248  
 249  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            