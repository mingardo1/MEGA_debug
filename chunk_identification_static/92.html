<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>92</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    92
                    <a href="91.html">prev</a>
                    <a href="93.html">next</a>
                    <a href="92_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_8885e871fe243487c84bc9a2eddf4493b4351628_Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;8885e871fe243487c84bc9a2eddf4493b4351628:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;8885e871fe243487c84bc9a2eddf4493b4351628^1:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;8885e871fe243487c84bc9a2eddf4493b4351628^2:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;962dd8af4b1d748b18498266bf9ffc5acbfbcb8d:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.ClipData;
   6 import android.content.ClipboardManager;
   7 import android.content.Context;
   8 import android.content.DialogInterface;
   9 import android.content.Intent;
  10 import android.content.SharedPreferences;
  11 import android.os.AsyncTask;
  12 import android.os.Bundle;
  13 import android.os.ParcelFileDescriptor;
  14 import android.provider.DocumentsContract;
  15 import android.widget.Toast;
  16 
  17 import androidx.appcompat.app.AlertDialog;
  18 import androidx.appcompat.view.ContextThemeWrapper;
  19 import androidx.preference.ListPreference;
  20 import androidx.preference.Preference;
  21 import androidx.preference.PreferenceFragmentCompat;
  22 import androidx.preference.PreferenceManager;
  23 import androidx.preference.SwitchPreferenceCompat;
  24 
  25 import com.automattic.simplenote.analytics.AnalyticsTracker;
  26 import com.automattic.simplenote.models.Note;
  27 import com.automattic.simplenote.models.Preferences;
  28 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import com.automattic.simplenote.models.Tag;</span>
  30 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import com.automattic.simplenote.models.Preferences;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import com.automattic.simplenote.utils.CrashUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import com.automattic.simplenote.utils.HtmlCompat;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import com.automattic.simplenote.utils.PrefUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import com.automattic.simplenote.utils.WidgetUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import com.simperium.Simperium;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import com.simperium.client.Bucket;</span>
  38 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39 import com.automattic.simplenote.utils.BrowserUtils;</span>
  40 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  41 import com.automattic.simplenote.utils.CrashUtils;
  42 import com.automattic.simplenote.utils.HtmlCompat;
  43 import com.automattic.simplenote.utils.PrefUtils;
  44 import com.automattic.simplenote.utils.WidgetUtils;
  45 import com.simperium.Simperium;
  46 import com.simperium.client.Bucket;
  47 import com.simperium.client.BucketObjectMissingException;
  48 import com.simperium.client.BucketObjectNameInvalid;
  49 import com.simperium.client.User;
  50 
  51 import org.json.JSONArray;
  52 import org.json.JSONObject;
  53 import org.wordpress.passcodelock.AppLockManager;
  54 
  55 import java.io.FileOutputStream;
  56 import java.lang.ref.WeakReference;
  57 
  58 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  59 
  60 /**
  61  * A simple {@link Fragment} subclass.
  62  */
  63 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener,
  64         Simperium.OnUserCreatedListener {
  65 
  66     private static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  67 
  68     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  69     private SwitchPreferenceCompat mAnalyticsSwitch;
  70 
  71     public PreferencesFragment() {
  72         // Required empty public constructor
  73     }
  74 
  75     @Override
  76     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  77         addPreferencesFromResource(R.xml.preferences);
  78     }
  79 
  80     @Override
  81     public void onActivityCreated(Bundle savedInstanceState) {
  82         super.onActivityCreated(savedInstanceState);
  83 
  84         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  85         Simplenote currentApp = (Simplenote) getActivity().getApplication();
  86         Simperium simperium = currentApp.getSimperium();
  87         simperium.setUserStatusChangeListener(this);
  88         simperium.setOnUserCreatedListener(this);
  89         mPreferencesBucket = currentApp.getPreferencesBucket();
  90         mPreferencesBucket.start();
  91 
  92         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  93         if (simperium.needsAuthorization()) {
  94             authenticatePreference.setTitle(R.string.log_in);
  95         } else {
  96             authenticatePreference.setTitle(R.string.log_out);
  97         }
  98 
  99         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 100             @Override
 101             public boolean onPreferenceClick(Preference preference) {
 102                 if (!isAdded()) {
 103                     return false;
 104                 }
 105 
 106                 Simplenote currentApp = (Simplenote) getActivity().getApplication();
 107                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 108                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);"> 108                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
 109                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 110                 } else {
 111                     new LogOutTask(PreferencesFragment.this).execute();
 112                 }
 113                 return true;
 114             }
 115         });
 116 
<abbr title=" 117         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 117         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
 118             @Override
 119             public boolean onPreferenceClick(Preference preference) {
 120                 try {
 121                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 122                 } catch (Exception e) {
<abbr title=" 123                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();"> 123                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show(ðŸ”µ</abbr>
 124                 }
 125                 return true;
 126             }
 127         });
 128 
<abbr title=" 129         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 129         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
 130             @Override
 131             public boolean onPreferenceClick(Preference preference) {
 132                 startActivity(new Intent(getActivity(), AboutActivity.class));
 133                 return true;
 134             }
 135         });
 136 
<abbr title=" 137         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 137         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 138             @Override
 139             public boolean onPreferenceClick(Preference preference) {
 140                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 141                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 142                 intent.setType(&quot;application/json&quot;);
 143                 intent.putExtra(Intent.EXTRA_TITLE, &quot;account.json&quot;);
 144 
 145                 startActivityForResult(intent, 1);
 146 
 147                 return true;
 148             }
 149         });
 150 
 151         final ListPreference themePreference = (ListPreference) findPreference(PrefUtils.PREF_THEME);
 152         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 153             @Override
 154             public boolean onPreferenceChange(Preference preference, Object newValue) {
 155                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 156                 return true;
 157             }
 158 
 159             private void updateTheme(Activity activity, int index) {
 160                 CharSequence[] entries = themePreference.getEntries();
 161                 themePreference.setSummary(entries[index]);
 162 
 163                 AnalyticsTracker.track(
 164                         AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 165                         AnalyticsTracker.CATEGORY_USER,
 166                         &quot;theme_preference&quot;
 167                 );
 168 
 169                 // recreate the activity so new theme is applied
 170                 activity.recreate();
 171             }
 172         });
 173 
 174         final ListPreference sortPreference = (ListPreference) findPreference(PrefUtils.PREF_SORT_ORDER);
 175         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 176             @Override
 177             public boolean onPreferenceChange(Preference preference, Object newValue) {
 178                 int index = Integer.parseInt(newValue.toString());
 179                 CharSequence[] entries = sortPreference.getEntries();
 180                 sortPreference.setSummary(entries[index]);
 181 
 182                 return true;
 183             }
 184         });
 185 
 186         Preference versionPref = findPreference(&quot;pref_key_build&quot;);
 187         versionPref.setSummary(PrefUtils.versionInfo());
 188 
<abbr title=" 189         SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_note_list&quot;);"> 189         SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condeðŸ”µ</abbr>
 190         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 191             @Override
 192             public boolean onPreferenceChange(Preference preference, Object o) {
 193                 if (((SwitchPreferenceCompat) preference).isChecked()) {
 194                     AnalyticsTracker.track(
 195                             AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 196                             AnalyticsTracker.CATEGORY_USER,
 197                             &quot;condensed_list_preference&quot;
 198                     );
 199                 }
 200 
 201                 return true;
 202             }
 203         });
 204 
 205         // Add the hyperlink to the analytics summary
 206         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 207         String formattedSummary = String.format(
 208                 getString(R.string.share_analytics_summary),
 209                 &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 210                 &quot;&lt;/a&gt;&quot;
 211         );
 212         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 213 
 214         mAnalyticsSwitch = (SwitchPreferenceCompat)findPreference(&quot;pref_key_analytics_switch&quot;);
 215         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 216             @Override
 217             public boolean onPreferenceChange(Preference preference, Object newValue) {
 218                 try {
 219                     boolean isChecked = (boolean)newValue;
 220                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 221                     prefs.setAnalyticsEnabled(isChecked);
 222                     prefs.save();
 223                 } catch (BucketObjectMissingException e) {
 224                     e.printStackTrace();
 225                 }
 226 
 227                 return true;
 228             }
 229         });
 230 
 231         updateAnalyticsSwitchState();
 232     }
 233 
 234     @Override
 235     public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 236         if (requestCode != 1 || resultCode != Activity.RESULT_OK || resultData == null) {
 237             return;
 238         }
 239 
 240         Uri uri = resultData.getData();
 241 
 242         Simplenote currentApp = (Simplenote) getActivity().getApplication();
 243         Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 244         Bucket&lt;Tag&gt; tagBucket = currentApp.getTagsBucket();
 245 
 246         JSONObject account = new JSONObject();
 247 
 248         Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 249 
 250         try {
 251             account.put(&quot;user&quot;, currentApp.getSimperium().getUser().getEmail());
 252 
 253             JSONArray notes = new JSONArray();
 254             while (cursor.moveToNext()) {
 255                 Note appNote = cursor.getObject();
 256                 JSONObject note = new JSONObject();
 257 
 258                 note.put(&quot;id&quot;, appNote.getSimperiumKey());
 259                 note.put(&quot;deleted&quot;, appNote.isDeleted());
 260                 note.put(&quot;content&quot;, appNote.getContent());
 261                 note.put(&quot;publishURL&quot;, appNote.getPublishedUrl());
 262                 note.put(&quot;tags&quot;, new JSONArray(appNote.getTags()));
 263                 note.put(&quot;systemTags&quot;, appNote.getSystemTags());
 264 
 265                 note.put(&quot;version&quot;, appNote.getVersion());
 266 
 267                 notes.put(note);
 268             }
 269             account.put(&quot;notes&quot;, notes);
 270 
 271             JSONArray tags = new JSONArray();
 272             Bucket.ObjectCursor&lt;Tag&gt; tagCursor = tagBucket.allObjects();
 273             while (tagCursor.moveToNext()) {
 274                 Tag appTag = tagCursor.getObject();
 275                 JSONObject tag = new JSONObject();
 276 
 277                 tag.put(&quot;id&quot;, appTag.getSimperiumKey());
 278                 tag.put(&quot;name&quot;, appTag.getName());
 279 
 280                 if (null != appTag.getIndex()) {
 281                     tag.put(&quot;index&quot;, appTag.getIndex());
 282                 }
 283 
 284                 tag.put(&quot;version&quot;, appTag.getVersion());
 285 
 286                 tags.put(tag);
 287             }
 288 
 289             account.put(&quot;tags&quot;, tags);
 290 
 291             ParcelFileDescriptor pfd = getActivity().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);
 292             FileOutputStream fileOutputStream = new FileOutputStream(pfd.getFileDescriptor());
 293             fileOutputStream.write(account.toString(2).getBytes());
 294             pfd.close();
 295         } catch (Exception e) {
 296             e.printStackTrace();
 297         }
 298     }
 299 
 300     @Override
 301     public void onPause() {
 302         super.onPause();
 303         mPreferencesBucket.stop();
 304     }
 305 
 306     private DialogInterface.OnClickListener logOutClickListener = new DialogInterface.OnClickListener() {
 307         @Override
 308         public void onClick(DialogInterface dialogInterface, int i) {
 309             logOut();
 310         }
 311     };
 312 
<abbr title=" 313     private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListener() {"> 313     private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListenerðŸ”µ</abbr>
 314         @Override
 315         public void onClick(DialogInterface dialogInterface, int i) {
 316             BrowserUtils.launchBrowserOrShowError(requireContext(), WEB_APP_URL);
 317         }
 318     };
 319 
 320     private boolean hasUnsyncedNotes() {
 321         Simplenote application = (Simplenote) getActivity().getApplication();
 322         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 323         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 324         while (notesCursor.moveToNext()) {
 325             Note note = notesCursor.getObject();
 326             if (note.isNew() || note.isModified()) {
 327                 return true;
 328             }
 329         }
 330 
 331         return false;
 332     }
 333 
 334     private void logOut() {
 335         Simplenote application = (Simplenote) getActivity().getApplication();
 336         application.getSimperium().deauthorizeUser();
 337 
 338         application.getNotesBucket().reset();
 339         application.getTagsBucket().reset();
 340         application.getPreferencesBucket().reset();
 341 
 342         application.getNotesBucket().stop();
 343         application.getTagsBucket().stop();
 344         application.getPreferencesBucket().stop();
 345 
 346         AnalyticsTracker.track(
 347                 AnalyticsTracker.Stat.USER_SIGNED_OUT,
 348                 AnalyticsTracker.CATEGORY_USER,
 349                 &quot;preferences_sign_out_button&quot;
 350         );
 351 
 352         // Resets analytics user back to &#x27;anon&#x27; type
 353         AnalyticsTracker.refreshMetadata(null);
 354         CrashUtils.clearCurrentUser();
 355 
 356         // Remove wp.com token
<abbr title=" 357         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();"> 357         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edðŸ”µ</abbr>
 358         editor.remove(PrefUtils.PREF_WP_TOKEN);
 359 
 360         // Remove WordPress sites
 361         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 362         editor.apply();
 363 
 364         // Remove Passcode Lock password
 365         AppLockManager.getInstance().getAppLock().setPassword(&quot;&quot;);
 366 
 367         WidgetUtils.updateNoteWidgets(requireActivity().getApplicationContext());
 368 
 369         getActivity().finish();
 370     }
 371 
 372     @Override
 373     public void onUserStatusChange(User.Status status) {
 374         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 375             // User signed in
 376             getActivity().runOnUiThread(new Runnable() {
 377                 public void run() {
 378                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 379                     authenticatePreference.setTitle(R.string.log_out);
 380                 }
 381             });
 382 
 383             Simplenote app = (Simplenote) getActivity().getApplication();
 384             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 385             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 386 
 387             AnalyticsTracker.track(
 388                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 389                     AnalyticsTracker.CATEGORY_USER,
 390                     &quot;signed_in_from_preferences_activity&quot;
 391             );
 392         }
 393     }
 394 
 395     @Override
 396     public void onUserCreated(User user) {
 397         AnalyticsTracker.track(
 398                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 399                 AnalyticsTracker.CATEGORY_USER,
 400                 &quot;account_created_from_preferences_activity&quot;
 401         );
 402     }
 403 
 404     private void updateAnalyticsSwitchState() {
 405         try {
 406             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 407             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 408         } catch (BucketObjectMissingException e) {
 409             // The preferences object doesn&#x27;t exist for this user yet, create it
 410             try {
 411                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 412                 prefs.setAnalyticsEnabled(true);
 413                 prefs.save();
 414             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 415                 bucketObjectNameInvalid.printStackTrace();
 416             }
 417         }
 418     }
 419 
 420     private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 421         private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 422 
 423         LogOutTask(PreferencesFragment fragment) {
 424             mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 425         }
 426 
 427         @Override
 428         protected Boolean doInBackground(Void... voids) {
 429             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 430             return fragment == null || fragment.hasUnsyncedNotes();
 431         }
 432 
 433         @Override
 434         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 435             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 436 
 437             if (fragment == null) {
 438                 return;
 439             }
 440 
 441             // Safety first! Check if any notes are unsynced and warn the user if so.
 442             if (hasUnsyncedNotes) {
<abbr title=" 443                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))"> 443                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 444                         .setTitle(R.string.unsynced_notes)
 445                         .setMessage(R.string.unsynced_notes_message)
 446                         .setPositiveButton(R.string.delete_notes, fragment.logOutClickListener)
 447                         .setNeutralButton(R.string.visit_web_app, fragment.loadWebAppClickListener)
 448                         .setNegativeButton(R.string.cancel, null)
 449                         .show();
 450             } else {
 451                 fragment.logOut();
 452             }
 453         }
 454     }
 455 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.ClipData;
   6 import android.content.ClipboardManager;
   7 import android.content.Context;
   8 import android.content.DialogInterface;
   9 import android.content.Intent;
  10 import android.content.SharedPreferences;
  11 import android.os.AsyncTask;
  12 import android.os.Bundle;
  13 import android.os.ParcelFileDescriptor;
  14 import android.provider.DocumentsContract;
  15 import android.widget.Toast;
  16 
  17 import androidx.appcompat.app.AlertDialog;
  18 import androidx.appcompat.view.ContextThemeWrapper;
  19 import androidx.preference.ListPreference;
  20 import androidx.preference.Preference;
  21 import androidx.preference.PreferenceFragmentCompat;
  22 import androidx.preference.PreferenceManager;
  23 import androidx.preference.SwitchPreferenceCompat;
  24 
  25 import com.automattic.simplenote.analytics.AnalyticsTracker;
  26 import com.automattic.simplenote.models.Note;
  27 import com.automattic.simplenote.models.Preferences;
  28 import com.automattic.simplenote.models.Tag;
  29 import com.automattic.simplenote.utils.BrowserUtils;
  30 import com.automattic.simplenote.utils.CrashUtils;
  31 import com.automattic.simplenote.utils.HtmlCompat;
  32 import com.automattic.simplenote.utils.PrefUtils;
  33 import com.automattic.simplenote.utils.WidgetUtils;
  34 import com.simperium.Simperium;
  35 import com.simperium.client.Bucket;
  36 import com.simperium.client.BucketObjectMissingException;
  37 import com.simperium.client.BucketObjectNameInvalid;
  38 import com.simperium.client.User;
  39 
  40 import org.json.JSONArray;
  41 import org.json.JSONObject;
  42 import org.wordpress.passcodelock.AppLockManager;
  43 
  44 import java.io.FileOutputStream;
  45 import java.lang.ref.WeakReference;
  46 
  47 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  48 
  49 /**
  50  * A simple {@link Fragment} subclass.
  51  */
  52 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener,
  53         Simperium.OnUserCreatedListener {
  54 
  55     private static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  56 
  57     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  58     private SwitchPreferenceCompat mAnalyticsSwitch;
  59 
  60     public PreferencesFragment() {
  61         // Required empty public constructor
  62     }
  63 
  64     @Override
  65     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  66         addPreferencesFromResource(R.xml.preferences);
  67     }
  68 
  69     @Override
  70     public void onActivityCreated(Bundle savedInstanceState) {
  71         super.onActivityCreated(savedInstanceState);
  72 
  73         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  74         Simplenote currentApp = (Simplenote) getActivity().getApplication();
  75         Simperium simperium = currentApp.getSimperium();
  76         simperium.setUserStatusChangeListener(this);
  77         simperium.setOnUserCreatedListener(this);
  78         mPreferencesBucket = currentApp.getPreferencesBucket();
  79         mPreferencesBucket.start();
  80 
  81         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  82         if (simperium.needsAuthorization()) {
  83             authenticatePreference.setTitle(R.string.log_in);
  84         } else {
  85             authenticatePreference.setTitle(R.string.log_out);
  86         }
  87 
  88         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
  89             @Override
  90             public boolean onPreferenceClick(Preference preference) {
  91                 if (!isAdded()) {
  92                     return false;
  93                 }
  94 
  95                 Simplenote currentApp = (Simplenote) getActivity().getApplication();
  96                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title="  97                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);">  97                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
  98                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
  99                 } else {
 100                     new LogOutTask(PreferencesFragment.this).execute();
 101                 }
 102                 return true;
 103             }
 104         });
 105 
<abbr title=" 106         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 106         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
 107             @Override
 108             public boolean onPreferenceClick(Preference preference) {
 109                 try {
 110                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 111                 } catch (Exception e) {
<abbr title=" 112                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();"> 112                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show(ðŸ”µ</abbr>
 113                 }
 114                 return true;
 115             }
 116         });
 117 
<abbr title=" 118         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 118         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
 119             @Override
 120             public boolean onPreferenceClick(Preference preference) {
 121                 startActivity(new Intent(getActivity(), AboutActivity.class));
 122                 return true;
 123             }
 124         });
 125 
<abbr title=" 126         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 126         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 127             @Override
 128             public boolean onPreferenceClick(Preference preference) {
 129                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 130                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 131                 intent.setType(&quot;application/json&quot;);
 132                 intent.putExtra(Intent.EXTRA_TITLE, &quot;account.json&quot;);
 133 
 134                 startActivityForResult(intent, 1);
 135 
 136                 return true;
 137             }
 138         });
 139 
 140         final ListPreference themePreference = (ListPreference) findPreference(PrefUtils.PREF_THEME);
 141         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 142             @Override
 143             public boolean onPreferenceChange(Preference preference, Object newValue) {
 144                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 145                 return true;
 146             }
 147 
 148             private void updateTheme(Activity activity, int index) {
 149                 CharSequence[] entries = themePreference.getEntries();
 150                 themePreference.setSummary(entries[index]);
 151 
 152                 AnalyticsTracker.track(
 153                         AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 154                         AnalyticsTracker.CATEGORY_USER,
 155                         &quot;theme_preference&quot;
 156                 );
 157 
 158                 // recreate the activity so new theme is applied
 159                 activity.recreate();
 160             }
 161         });
 162 
 163         final ListPreference sortPreference = (ListPreference) findPreference(PrefUtils.PREF_SORT_ORDER);
 164         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 165             @Override
 166             public boolean onPreferenceChange(Preference preference, Object newValue) {
 167                 int index = Integer.parseInt(newValue.toString());
 168                 CharSequence[] entries = sortPreference.getEntries();
 169                 sortPreference.setSummary(entries[index]);
 170 
 171                 return true;
 172             }
 173         });
 174 
 175         Preference versionPref = findPreference(&quot;pref_key_build&quot;);
 176         versionPref.setSummary(PrefUtils.versionInfo());
 177 
<abbr title=" 178         SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_note_list&quot;);"> 178         SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condeðŸ”µ</abbr>
 179         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 180             @Override
 181             public boolean onPreferenceChange(Preference preference, Object o) {
 182                 if (((SwitchPreferenceCompat) preference).isChecked()) {
 183                     AnalyticsTracker.track(
 184                             AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 185                             AnalyticsTracker.CATEGORY_USER,
 186                             &quot;condensed_list_preference&quot;
 187                     );
 188                 }
 189 
 190                 return true;
 191             }
 192         });
 193 
 194         // Add the hyperlink to the analytics summary
 195         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 196         String formattedSummary = String.format(
 197                 getString(R.string.share_analytics_summary),
 198                 &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 199                 &quot;&lt;/a&gt;&quot;
 200         );
 201         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 202 
 203         mAnalyticsSwitch = (SwitchPreferenceCompat)findPreference(&quot;pref_key_analytics_switch&quot;);
 204         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 205             @Override
 206             public boolean onPreferenceChange(Preference preference, Object newValue) {
 207                 try {
 208                     boolean isChecked = (boolean)newValue;
 209                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 210                     prefs.setAnalyticsEnabled(isChecked);
 211                     prefs.save();
 212                 } catch (BucketObjectMissingException e) {
 213                     e.printStackTrace();
 214                 }
 215 
 216                 return true;
 217             }
 218         });
 219 
 220         updateAnalyticsSwitchState();
 221     }
 222 
 223     @Override
 224     public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 225         if (requestCode != 1 || resultCode != Activity.RESULT_OK || resultData == null) {
 226             return;
 227         }
 228 
 229         Uri uri = resultData.getData();
 230 
 231         Simplenote currentApp = (Simplenote) getActivity().getApplication();
 232         Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 233         Bucket&lt;Tag&gt; tagBucket = currentApp.getTagsBucket();
 234 
 235         JSONObject account = new JSONObject();
 236 
 237         Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 238 
 239         try {
 240             account.put(&quot;user&quot;, currentApp.getSimperium().getUser().getEmail());
 241 
 242             JSONArray notes = new JSONArray();
 243             while (cursor.moveToNext()) {
 244                 Note appNote = cursor.getObject();
 245                 JSONObject note = new JSONObject();
 246 
 247                 note.put(&quot;id&quot;, appNote.getSimperiumKey());
 248                 note.put(&quot;deleted&quot;, appNote.isDeleted());
 249                 note.put(&quot;content&quot;, appNote.getContent());
 250                 note.put(&quot;publishURL&quot;, appNote.getPublishedUrl());
 251                 note.put(&quot;tags&quot;, new JSONArray(appNote.getTags()));
 252                 note.put(&quot;systemTags&quot;, appNote.getSystemTags());
 253 
 254                 note.put(&quot;version&quot;, appNote.getVersion());
 255 
 256                 notes.put(note);
 257             }
 258             account.put(&quot;notes&quot;, notes);
 259 
 260             JSONArray tags = new JSONArray();
 261             Bucket.ObjectCursor&lt;Tag&gt; tagCursor = tagBucket.allObjects();
 262             while (tagCursor.moveToNext()) {
 263                 Tag appTag = tagCursor.getObject();
 264                 JSONObject tag = new JSONObject();
 265 
 266                 tag.put(&quot;id&quot;, appTag.getSimperiumKey());
 267                 tag.put(&quot;name&quot;, appTag.getName());
 268 
 269                 if (null != appTag.getIndex()) {
 270                     tag.put(&quot;index&quot;, appTag.getIndex());
 271                 }
 272 
 273                 tag.put(&quot;version&quot;, appTag.getVersion());
 274 
 275                 tags.put(tag);
 276             }
 277 
 278             account.put(&quot;tags&quot;, tags);
 279 
 280             ParcelFileDescriptor pfd = getActivity().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);
 281             FileOutputStream fileOutputStream = new FileOutputStream(pfd.getFileDescriptor());
 282             fileOutputStream.write(account.toString(2).getBytes());
 283             pfd.close();
 284         } catch (Exception e) {
 285             e.printStackTrace();
 286         }
 287     }
 288 
 289     @Override
 290     public void onPause() {
 291         super.onPause();
 292         mPreferencesBucket.stop();
 293     }
 294 
 295     private DialogInterface.OnClickListener logOutClickListener = new DialogInterface.OnClickListener() {
 296         @Override
 297         public void onClick(DialogInterface dialogInterface, int i) {
 298             logOut();
 299         }
 300     };
 301 
<abbr title=" 302     private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListener() {"> 302     private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListenerðŸ”µ</abbr>
 303         @Override
 304         public void onClick(DialogInterface dialogInterface, int i) {
 305             BrowserUtils.launchBrowserOrShowError(requireContext(), WEB_APP_URL);
 306         }
 307     };
 308 
 309     private boolean hasUnsyncedNotes() {
 310         Simplenote application = (Simplenote) getActivity().getApplication();
 311         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 312         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 313         while (notesCursor.moveToNext()) {
 314             Note note = notesCursor.getObject();
 315             if (note.isNew() || note.isModified()) {
 316                 return true;
 317             }
 318         }
 319 
 320         return false;
 321     }
 322 
 323     private void logOut() {
 324         Simplenote application = (Simplenote) getActivity().getApplication();
 325         application.getSimperium().deauthorizeUser();
 326 
 327         application.getNotesBucket().reset();
 328         application.getTagsBucket().reset();
 329         application.getPreferencesBucket().reset();
 330 
 331         application.getNotesBucket().stop();
 332         application.getTagsBucket().stop();
 333         application.getPreferencesBucket().stop();
 334 
 335         AnalyticsTracker.track(
 336                 AnalyticsTracker.Stat.USER_SIGNED_OUT,
 337                 AnalyticsTracker.CATEGORY_USER,
 338                 &quot;preferences_sign_out_button&quot;
 339         );
 340 
 341         // Resets analytics user back to &#x27;anon&#x27; type
 342         AnalyticsTracker.refreshMetadata(null);
 343         CrashUtils.clearCurrentUser();
 344 
 345         // Remove wp.com token
<abbr title=" 346         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();"> 346         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edðŸ”µ</abbr>
 347         editor.remove(PrefUtils.PREF_WP_TOKEN);
 348 
 349         // Remove WordPress sites
 350         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 351         editor.apply();
 352 
 353         // Remove Passcode Lock password
 354         AppLockManager.getInstance().getAppLock().setPassword(&quot;&quot;);
 355 
 356         WidgetUtils.updateNoteWidgets(requireActivity().getApplicationContext());
 357 
 358         getActivity().finish();
 359     }
 360 
 361     @Override
 362     public void onUserStatusChange(User.Status status) {
 363         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 364             // User signed in
 365             getActivity().runOnUiThread(new Runnable() {
 366                 public void run() {
 367                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 368                     authenticatePreference.setTitle(R.string.log_out);
 369                 }
 370             });
 371 
 372             Simplenote app = (Simplenote) getActivity().getApplication();
 373             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 374             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 375 
 376             AnalyticsTracker.track(
 377                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 378                     AnalyticsTracker.CATEGORY_USER,
 379                     &quot;signed_in_from_preferences_activity&quot;
 380             );
 381         }
 382     }
 383 
 384     @Override
 385     public void onUserCreated(User user) {
 386         AnalyticsTracker.track(
 387                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 388                 AnalyticsTracker.CATEGORY_USER,
 389                 &quot;account_created_from_preferences_activity&quot;
 390         );
 391     }
 392 
 393     private void updateAnalyticsSwitchState() {
 394         try {
 395             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 396             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 397         } catch (BucketObjectMissingException e) {
 398             // The preferences object doesn&#x27;t exist for this user yet, create it
 399             try {
 400                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 401                 prefs.setAnalyticsEnabled(true);
 402                 prefs.save();
 403             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 404                 bucketObjectNameInvalid.printStackTrace();
 405             }
 406         }
 407     }
 408 
 409     private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 410         private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 411 
 412         LogOutTask(PreferencesFragment fragment) {
 413             mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 414         }
 415 
 416         @Override
 417         protected Boolean doInBackground(Void... voids) {
 418             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 419             return fragment == null || fragment.hasUnsyncedNotes();
 420         }
 421 
 422         @Override
 423         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 424             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 425 
 426             if (fragment == null) {
 427                 return;
 428             }
 429 
 430             // Safety first! Check if any notes are unsynced and warn the user if so.
 431             if (hasUnsyncedNotes) {
<abbr title=" 432                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))"> 432                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 433                         .setTitle(R.string.unsynced_notes)
 434                         .setMessage(R.string.unsynced_notes_message)
 435                         .setPositiveButton(R.string.delete_notes, fragment.logOutClickListener)
 436                         .setNeutralButton(R.string.visit_web_app, fragment.loadWebAppClickListener)
 437                         .setNegativeButton(R.string.cancel, null)
 438                         .show();
 439             } else {
 440                 fragment.logOut();
 441             }
 442         }
 443     }
 444 }
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.ClipData;
   6 import android.content.ClipboardManager;
   7 import android.content.Context;
   8 import android.content.DialogInterface;
   9 import android.content.Intent;
  10 import android.content.SharedPreferences;
  11 import android.os.AsyncTask;
  12 import android.os.Bundle;
  13 import android.os.ParcelFileDescriptor;
  14 import android.provider.DocumentsContract;
  15 import android.widget.Toast;
  16 import androidx.appcompat.app.AlertDialog;
  17 import androidx.appcompat.view.ContextThemeWrapper;
  18 import androidx.preference.ListPreference;
  19 import androidx.preference.Preference;
  20 import androidx.preference.PreferenceFragmentCompat;
  21 import androidx.preference.PreferenceManager;
  22 import androidx.preference.SwitchPreferenceCompat;
  23 import com.automattic.simplenote.analytics.AnalyticsTracker;
  24 import com.automattic.simplenote.models.Note;
  25 import com.automattic.simplenote.models.Preferences;
  26 import com.automattic.simplenote.models.Tag;
  27 import com.automattic.simplenote.utils.BrowserUtils;
  28 import com.automattic.simplenote.utils.CrashUtils;
  29 import com.automattic.simplenote.utils.HtmlCompat;
  30 import com.automattic.simplenote.utils.PrefUtils;
  31 import com.automattic.simplenote.utils.WidgetUtils;
  32 import com.simperium.Simperium;
  33 import com.simperium.client.Bucket;
  34 import com.simperium.client.BucketObjectMissingException;
  35 import com.simperium.client.BucketObjectNameInvalid;
  36 import com.simperium.client.User;
  37 import java.io.FileOutputStream;
  38 import java.lang.ref.WeakReference;
  39 import org.json.JSONArray;
  40 import org.json.JSONObject;
  41 import org.wordpress.passcodelock.AppLockManager;
  42 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  43 
  44 
  45 /**
  46  * A simple {@link Fragment} subclass.
  47  */
<abbr title="  48 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener , Simperium.OnUserCreatedListener {">  48 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener , ðŸ”µ</abbr>
  49     private static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  50 
  51     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  52 
  53     private SwitchPreferenceCompat mAnalyticsSwitch;
  54 
  55     public PreferencesFragment() {
  56         // Required empty public constructor
  57     }
  58 
  59     @Override
  60     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  61         addPreferencesFromResource(R.xml.preferences);
  62     }
  63 
  64     @Override
  65     public void onActivityCreated(Bundle savedInstanceState) {
  66         super.onActivityCreated(savedInstanceState);
  67         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  68         Simplenote currentApp = ((Simplenote) (getActivity().getApplication()));
  69         Simperium simperium = currentApp.getSimperium();
  70         simperium.setUserStatusChangeListener(this);
  71         simperium.setOnUserCreatedListener(this);
  72         mPreferencesBucket = currentApp.getPreferencesBucket();
  73         mPreferencesBucket.start();
  74         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  75         if (simperium.needsAuthorization()) {
  76             authenticatePreference.setTitle(R.string.log_in);
  77         } else {
  78             authenticatePreference.setTitle(R.string.log_out);
  79         }
  80         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
  81             @Override
  82             public boolean onPreferenceClick(Preference preference) {
  83                 if (!isAdded()) {
  84                     return false;
  85                 }
  86                 Simplenote currentApp = ((Simplenote) (getActivity().getApplication()));
  87                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title="  88                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);">  88                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
  89                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
  90                 } else {
  91                     new LogOutTask(PreferencesFragment.this).execute();
  92                 }
  93                 return true;
  94             }
  95         });
<abbr title="  96         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {">  96         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
  97             @Override
  98             public boolean onPreferenceClick(Preference preference) {
  99                 try {
 100                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 101                 } catch (java.lang.Exception e) {
<abbr title=" 102                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();"> 102                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show(ðŸ”µ</abbr>
 103                 }
 104                 return true;
 105             }
 106         });
<abbr title=" 107         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 107         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
 108             @Override
 109             public boolean onPreferenceClick(Preference preference) {
 110                 startActivity(new Intent(getActivity(), AboutActivity.class));
 111                 return true;
 112             }
 113         });
<abbr title=" 114         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 114         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 115             @Override
 116             public boolean onPreferenceClick(Preference preference) {
 117                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 118                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 119                 intent.setType(&quot;application/json&quot;);
 120                 intent.putExtra(Intent.EXTRA_TITLE, &quot;account.json&quot;);
 121                 startActivityForResult(intent, 1);
 122                 return true;
 123             }
 124         });
 125         final ListPreference themePreference = ((ListPreference) (findPreference(PrefUtils.PREF_THEME)));
 126         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 127             @Override
 128             public boolean onPreferenceChange(Preference preference, Object newValue) {
 129                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 130                 return true;
 131             }
 132 
 133             private void updateTheme(Activity activity, int index) {
 134                 CharSequence[] entries = themePreference.getEntries();
 135                 themePreference.setSummary(entries[index]);
<abbr title=" 136                 AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED, AnalyticsTracker.CATEGORY_USER, &quot;theme_preference&quot;);"> 136                 AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED, AnalyticsTracker.CATðŸ”µ</abbr>
 137                 // recreate the activity so new theme is applied
 138                 activity.recreate();
 139             }
 140         });
<abbr title=" 141         final ListPreference sortPreference = ((ListPreference) (findPreference(PrefUtils.PREF_SORT_ORDER)));"> 141         final ListPreference sortPreference = ((ListPreference) (findPreference(PrefUtils.PREF_SORT_ORDERðŸ”µ</abbr>
 142         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 143             @Override
 144             public boolean onPreferenceChange(Preference preference, Object newValue) {
 145                 int index = Integer.parseInt(newValue.toString());
 146                 CharSequence[] entries = sortPreference.getEntries();
 147                 sortPreference.setSummary(entries[index]);
 148                 return true;
 149             }
 150         });
 151         Preference versionPref = findPreference(&quot;pref_key_build&quot;);
 152         versionPref.setSummary(PrefUtils.versionInfo());
<abbr title=" 153         SwitchPreferenceCompat switchPreference = ((SwitchPreferenceCompat) (findPreference(&quot;pref_key_condensed_note_list&quot;)));"> 153         SwitchPreferenceCompat switchPreference = ((SwitchPreferenceCompat) (findPreference(&quot;pref_key_conðŸ”µ</abbr>
 154         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 155             @Override
 156             public boolean onPreferenceChange(Preference preference, Object o) {
 157                 if (((SwitchPreferenceCompat) (preference)).isChecked()) {
<abbr title=" 158                     AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED, AnalyticsTracker.CATEGORY_USER, &quot;condensed_list_preference&quot;);"> 158                     AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED, AnalytiðŸ”µ</abbr>
 159                 }
 160                 return true;
 161             }
 162         });
 163         // Add the hyperlink to the analytics summary
 164         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
<abbr title=" 165         String formattedSummary = String.format(getString(R.string.share_analytics_summary), &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;, &quot;&lt;/a&gt;&quot;);"> 165         String formattedSummary = String.format(getString(R.string.share_analytics_summary), &quot;&lt;a href=\&quot;hðŸ”µ</abbr>
 166         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 167         mAnalyticsSwitch = ((SwitchPreferenceCompat) (findPreference(&quot;pref_key_analytics_switch&quot;)));
 168         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 169             @Override
 170             public boolean onPreferenceChange(Preference preference, Object newValue) {
 171                 try {
 172                     boolean isChecked = ((boolean) (newValue));
 173                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 174                     prefs.setAnalyticsEnabled(isChecked);
 175                     prefs.save();
 176                 } catch (BucketObjectMissingException e) {
 177                     e.printStackTrace();
 178                 }
 179                 return true;
 180             }
 181         });
 182         updateAnalyticsSwitchState();
 183     }
 184 
 185     @Override
 186     public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 187         if (requestCode != 1 || resultCode != Activity.RESULT_OK || resultData == null) {
 188             return;
 189         }
 190 
 191         Uri uri = resultData.getData();
 192 
 193         Simplenote currentApp = (Simplenote) getActivity().getApplication();
 194         Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 195         Bucket&lt;Tag&gt; tagBucket = currentApp.getTagsBucket();
 196 
 197         JSONObject account = new JSONObject();
 198 
 199         Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 200 
 201         try {
 202             account.put(&quot;user&quot;, currentApp.getSimperium().getUser().getEmail());
 203 
 204             JSONArray notes = new JSONArray();
 205             while (cursor.moveToNext()) {
 206                 Note appNote = cursor.getObject();
 207                 JSONObject note = new JSONObject();
 208 
 209                 note.put(&quot;id&quot;, appNote.getSimperiumKey());
 210                 note.put(&quot;deleted&quot;, appNote.isDeleted());
 211                 note.put(&quot;content&quot;, appNote.getContent());
 212                 note.put(&quot;publishURL&quot;, appNote.getPublishedUrl());
 213                 note.put(&quot;tags&quot;, new JSONArray(appNote.getTags()));
 214                 note.put(&quot;systemTags&quot;, appNote.getSystemTags());
 215 
 216                 note.put(&quot;version&quot;, appNote.getVersion());
 217 
 218                 notes.put(note);
 219             }
 220             account.put(&quot;notes&quot;, notes);
 221 
 222             JSONArray tags = new JSONArray();
 223             Bucket.ObjectCursor&lt;Tag&gt; tagCursor = tagBucket.allObjects();
 224             while (tagCursor.moveToNext()) {
 225                 Tag appTag = tagCursor.getObject();
 226                 JSONObject tag = new JSONObject();
 227 
 228                 tag.put(&quot;id&quot;, appTag.getSimperiumKey());
 229                 tag.put(&quot;name&quot;, appTag.getName());
 230 
 231                 if (null != appTag.getIndex()) {
 232                     tag.put(&quot;index&quot;, appTag.getIndex());
 233                 }
 234 
 235                 tag.put(&quot;version&quot;, appTag.getVersion());
 236 
 237                 tags.put(tag);
 238             }
 239 
 240             account.put(&quot;tags&quot;, tags);
 241 
 242             ParcelFileDescriptor pfd = getActivity().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);
 243             FileOutputStream fileOutputStream = new FileOutputStream(pfd.getFileDescriptor());
 244             fileOutputStream.write(account.toString(2).getBytes());
 245             pfd.close();
 246         } catch (Exception e) {
 247             e.printStackTrace();
 248         }
 249     }
 250 
 251     @Override
 252     public void onPause() {
 253         super.onPause();
 254         mPreferencesBucket.stop();
 255     }
 256 
 257     private DialogInterface.OnClickListener logOutClickListener = new DialogInterface.OnClickListener() {
 258         @Override
 259         public void onClick(DialogInterface dialogInterface, int i) {
 260             logOut();
 261         }
 262     };
 263 
<abbr title=" 264     private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListener() {"> 264     private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListenerðŸ”µ</abbr>
 265         @Override
 266         public void onClick(DialogInterface dialogInterface, int i) {
 267             BrowserUtils.launchBrowserOrShowError(requireContext(), WEB_APP_URL);
 268         }
 269     };
 270 
 271     private boolean hasUnsyncedNotes() {
 272         Simplenote application = (Simplenote) getActivity().getApplication();
 273         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 274         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 275         while (notesCursor.moveToNext()) {
 276             Note note = notesCursor.getObject();
 277             if (note.isNew() || note.isModified()) {
 278                 return true;
 279             }
 280         }
 281 
 282         return false;
 283     }
 284 
 285     private void logOut() {
 286         Simplenote application = (Simplenote) getActivity().getApplication();
 287         application.getSimperium().deauthorizeUser();
 288 
 289         application.getNotesBucket().reset();
 290         application.getTagsBucket().reset();
 291         application.getPreferencesBucket().reset();
 292 
 293         application.getNotesBucket().stop();
 294         application.getTagsBucket().stop();
 295         application.getPreferencesBucket().stop();
 296 
 297         AnalyticsTracker.track(
 298                 AnalyticsTracker.Stat.USER_SIGNED_OUT,
 299                 AnalyticsTracker.CATEGORY_USER,
 300                 &quot;preferences_sign_out_button&quot;
 301         );
 302 
 303         // Resets analytics user back to &#x27;anon&#x27; type
 304         AnalyticsTracker.refreshMetadata(null);
 305         CrashUtils.clearCurrentUser();
 306 
 307         // Remove wp.com token
<abbr title=" 308         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();"> 308         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edðŸ”µ</abbr>
 309         editor.remove(PrefUtils.PREF_WP_TOKEN);
 310 
 311         // Remove WordPress sites
 312         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 313         editor.apply();
 314 
 315         // Remove Passcode Lock password
 316         AppLockManager.getInstance().getAppLock().setPassword(&quot;&quot;);
 317 
 318         WidgetUtils.updateNoteWidgets(requireActivity().getApplicationContext());
 319 
 320         getActivity().finish();
 321     }
 322 
 323     @Override
 324     public void onUserStatusChange(User.Status status) {
 325         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 326             // User signed in
 327             getActivity().runOnUiThread(new Runnable() {
 328                 public void run() {
 329                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 330                     authenticatePreference.setTitle(R.string.log_out);
 331                 }
 332             });
 333 
 334             Simplenote app = (Simplenote) getActivity().getApplication();
 335             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 336             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 337 
 338             AnalyticsTracker.track(
 339                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 340                     AnalyticsTracker.CATEGORY_USER,
 341                     &quot;signed_in_from_preferences_activity&quot;
 342             );
 343         }
 344     }
 345 
 346     @Override
 347     public void onUserCreated(User user) {
 348         AnalyticsTracker.track(
 349                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 350                 AnalyticsTracker.CATEGORY_USER,
 351                 &quot;account_created_from_preferences_activity&quot;
 352         );
 353     }
 354 
 355     private void updateAnalyticsSwitchState() {
 356         try {
 357             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 358             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 359         } catch (BucketObjectMissingException e) {
 360             // The preferences object doesn&#x27;t exist for this user yet, create it
 361             try {
 362                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 363                 prefs.setAnalyticsEnabled(true);
 364                 prefs.save();
 365             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 366                 bucketObjectNameInvalid.printStackTrace();
 367             }
 368         }
 369     }
 370 
 371     private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 372         private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 373 
 374         LogOutTask(PreferencesFragment fragment) {
 375             mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 376         }
 377 
 378         @Override
 379         protected Boolean doInBackground(Void... voids) {
 380             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 381             return (fragment == null) || fragment.hasUnsyncedNotes();
 382         }
 383 
 384         @Override
 385         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 386             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 387             if (fragment == null) {
 388                 return;
 389             }
 390             // Safety first! Check if any notes are unsynced and warn the user if so.
 391             if (hasUnsyncedNotes) {
<abbr title=" 392                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog)).setTitle(R.string.unsynced_notes).setMessage(R.string.unsynced_notes_message).setPositiveButton(R.string.delete_notes, fragment.logOutClickListener).setNeutralButton(R.string.visit_web_app, fragment.loadWebAppClickListener).setNegativeButton(R.string.cancel, null).show();"> 392                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 393             } else {
 394                 fragment.logOut();
 395             }
 396         }
 397     }
 398 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.Fragment;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 +import android.content.ClipData;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 +import android.content.ClipboardManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 +import android.content.Context;</span>
   8  import android.content.DialogInterface;
   9  import android.content.Intent;
  10  import android.content.SharedPreferences;
  11  import android.net.Uri;
  12  import android.os.AsyncTask;
  13  import android.os.Bundle;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 +import android.os.ParcelFileDescriptor;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 +import android.provider.DocumentsContract;</span>
  16  import android.widget.Toast;
  17  
  18  import androidx.appcompat.app.AlertDialog;
  19  import androidx.appcompat.view.ContextThemeWrapper;
  20  import androidx.preference.ListPreference;
  21  import androidx.preference.Preference;
  22  import androidx.preference.PreferenceFragmentCompat;
  23  import androidx.preference.PreferenceManager;
  24  import androidx.preference.SwitchPreferenceCompat;
  25  
  26  import com.automattic.simplenote.analytics.AnalyticsTracker;
  27  import com.automattic.simplenote.models.Note;
  28  import com.automattic.simplenote.models.Preferences;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import com.automattic.simplenote.models.Tag;</span>
  30  import com.automattic.simplenote.utils.CrashUtils;
  31  import com.automattic.simplenote.utils.HtmlCompat;
  32  import com.automattic.simplenote.utils.PrefUtils;
  33  import com.automattic.simplenote.utils.WidgetUtils;
  34  import com.simperium.Simperium;
  35  import com.simperium.client.Bucket;
  36  import com.simperium.client.BucketObjectMissingException;
  37  import com.simperium.client.BucketObjectNameInvalid;
  38  import com.simperium.client.User;
  39  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import org.json.JSONArray;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import org.json.JSONObject;</span>
  42  import org.wordpress.passcodelock.AppLockManager;
  43  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +import java.io.FileOutputStream;</span>
  45  import java.lang.ref.WeakReference;
  46  
  47  import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  48  
  49  /**
  50   * A simple {@link Fragment} subclass.
  51   */
  52  public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener,
  53          Simperium.OnUserCreatedListener {
  54  
  55      private static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  56  
  57      private Bucket&lt;Preferences&gt; mPreferencesBucket;
  58      private SwitchPreferenceCompat mAnalyticsSwitch;
  59  
  60      public PreferencesFragment() {
  61          // Required empty public constructor
  62      }
  63  
  64      @Override
  65      public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  66          addPreferencesFromResource(R.xml.preferences);
  67      }
  68  
  69      @Override
  70      public void onActivityCreated(Bundle savedInstanceState) {
  71          super.onActivityCreated(savedInstanceState);
  72  
  73          Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  74          Simplenote currentApp = (Simplenote) getActivity().getApplication();
  75          Simperium simperium = currentApp.getSimperium();
  76          simperium.setUserStatusChangeListener(this);
  77          simperium.setOnUserCreatedListener(this);
  78          mPreferencesBucket = currentApp.getPreferencesBucket();
  79          mPreferencesBucket.start();
  80  
  81          authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  82          if (simperium.needsAuthorization()) {
  83              authenticatePreference.setTitle(R.string.log_in);
  84          } else {
  85              authenticatePreference.setTitle(R.string.log_out);
  86          }
  87  
  88          authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
  89              @Override
  90              public boolean onPreferenceClick(Preference preference) {
  91                  if (!isAdded()) {
  92                      return false;
  93                  }
  94  
  95                  Simplenote currentApp = (Simplenote) getActivity().getApplication();
  96                  if (currentApp.getSimperium().needsAuthorization()) {
  97                      Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);
  98                      startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
  99                  } else {
 100                      new LogOutTask(PreferencesFragment.this).execute();
 101                  }
 102                  return true;
 103              }
 104          });
 105  
<abbr title=" 106          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 106          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener()ðŸ”µ</abbr>
 107              @Override
 108              public boolean onPreferenceClick(Preference preference) {
 109                  try {
 110                      startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(&quot;http://simplenote.com&quot;)));

 111                  } catch (Exception e) {
 112                      Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();
 113                  }
 114                  return true;
 115              }
 116          });
 117  
 118          findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 119              @Override
 120              public boolean onPreferenceClick(Preference preference) {
 121                  startActivity(new Intent(getActivity(), AboutActivity.class));
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 126 +        findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 126 +        findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +            public boolean onPreferenceClick(Preference preference) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +                Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +                intent.addCategory(Intent.CATEGORY_OPENABLE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +                intent.setType(&quot;application/json&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +                intent.putExtra(Intent.EXTRA_TITLE, &quot;account.json&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +                startActivityForResult(intent, 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +</span>
 136                  return true;
 137              }
 138          });
 139  
 140          final ListPreference themePreference = (ListPreference) findPreference(PrefUtils.PREF_THEME);
 141          themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 142              @Override
 143              public boolean onPreferenceChange(Preference preference, Object newValue) {
 144                  updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 145                  return true;
 146              }
 147  
 148              private void updateTheme(Activity activity, int index) {
 149                  CharSequence[] entries = themePreference.getEntries();
 150                  themePreference.setSummary(entries[index]);
 151  
 152                  AnalyticsTracker.track(
 153                          AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 154                          AnalyticsTracker.CATEGORY_USER,
 155                          &quot;theme_preference&quot;
 156                  );
 157  
 158                  // recreate the activity so new theme is applied
 159                  activity.recreate();
 160              }
 161          });
 162  
 163          final ListPreference sortPreference = (ListPreference) findPreference(PrefUtils.PREF_SORT_ORDER);
 164          sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 165              @Override
 166              public boolean onPreferenceChange(Preference preference, Object newValue) {
 167                  int index = Integer.parseInt(newValue.toString());
 168                  CharSequence[] entries = sortPreference.getEntries();
 169                  sortPreference.setSummary(entries[index]);
 170  
 171                  return true;
 172              }
 173          });
 174  
 175          Preference versionPref = findPreference(&quot;pref_key_build&quot;);
 176          versionPref.setSummary(PrefUtils.versionInfo());
 177  
<abbr title=" 178          SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_note_list&quot;);"> 178          SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_noteðŸ”µ</abbr>
 179          switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 180              @Override
 181              public boolean onPreferenceChange(Preference preference, Object o) {
 182                  if (((SwitchPreferenceCompat) preference).isChecked()) {
 183                      AnalyticsTracker.track(
 184                              AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 185                              AnalyticsTracker.CATEGORY_USER,
 186                              &quot;condensed_list_preference&quot;
 187                      );
 188                  }
 189  
 190                  return true;
 191              }
 192          });
 193  
 194          // Add the hyperlink to the analytics summary
 195          Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 196          String formattedSummary = String.format(
 197                  getString(R.string.share_analytics_summary),
 198                  &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 199                  &quot;&lt;/a&gt;&quot;
 200          );
 201          analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 202  
 203          mAnalyticsSwitch = (SwitchPreferenceCompat)findPreference(&quot;pref_key_analytics_switch&quot;);
 204          mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 205              @Override
 206              public boolean onPreferenceChange(Preference preference, Object newValue) {
 207                  try {
 208                      boolean isChecked = (boolean)newValue;
 209                      Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 210                      prefs.setAnalyticsEnabled(isChecked);
 211                      prefs.save();
 212                  } catch (BucketObjectMissingException e) {
 213                      e.printStackTrace();
 214                  }
 215  
 216                  return true;
 217              }
 218          });
 219  
 220          updateAnalyticsSwitchState();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +    public void onActivityResult(int requestCode, int resultCode, Intent resultData) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +        if (requestCode != 1 || resultCode != Activity.RESULT_OK || resultData == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +        Uri uri = resultData.getData();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +        Simplenote currentApp = (Simplenote) getActivity().getApplication();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +        Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +        Bucket&lt;Tag&gt; tagBucket = currentApp.getTagsBucket();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +        JSONObject account = new JSONObject();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +        Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +            account.put(&quot;user&quot;, currentApp.getSimperium().getUser().getEmail());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +            JSONArray notes = new JSONArray();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +            while (cursor.moveToNext()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +                Note appNote = cursor.getObject();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +                JSONObject note = new JSONObject();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +                note.put(&quot;id&quot;, appNote.getSimperiumKey());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +                note.put(&quot;deleted&quot;, appNote.isDeleted());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +                note.put(&quot;content&quot;, appNote.getContent());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +                note.put(&quot;publishURL&quot;, appNote.getPublishedUrl());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +                note.put(&quot;tags&quot;, new JSONArray(appNote.getTags()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +                note.put(&quot;systemTags&quot;, appNote.getSystemTags());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +                note.put(&quot;version&quot;, appNote.getVersion());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +                notes.put(note);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +            account.put(&quot;notes&quot;, notes);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +            JSONArray tags = new JSONArray();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +            Bucket.ObjectCursor&lt;Tag&gt; tagCursor = tagBucket.allObjects();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +            while (tagCursor.moveToNext()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +                Tag appTag = tagCursor.getObject();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +                JSONObject tag = new JSONObject();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +                tag.put(&quot;id&quot;, appTag.getSimperiumKey());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +                tag.put(&quot;name&quot;, appTag.getName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +                if (null != appTag.getIndex()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +                    tag.put(&quot;index&quot;, appTag.getIndex());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +                tag.put(&quot;version&quot;, appTag.getVersion());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +                tags.put(tag);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +            account.put(&quot;tags&quot;, tags);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +            ParcelFileDescriptor pfd = getActivity().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +            FileOutputStream fileOutputStream = new FileOutputStream(pfd.getFileDescriptor());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +            fileOutputStream.write(account.toString(2).getBytes());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +            pfd.close();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +        } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +            e.printStackTrace();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +        }</span>
 287      }
 288  
 289      @Override
 290      public void onPause() {
 291          super.onPause();
 292          mPreferencesBucket.stop();
 293      }
 294  
 295      private DialogInterface.OnClickListener logOutClickListener = new DialogInterface.OnClickListener() {
 296          @Override
 297          public void onClick(DialogInterface dialogInterface, int i) {
 298              logOut();
 299          }
 300      };
 301  
 302      private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListener() {
 303          @Override
 304          public void onClick(DialogInterface dialogInterface, int i) {
 305              startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(WEB_APP_URL)));

 306          }
 307      };
 308  
 309      private boolean hasUnsyncedNotes() {
 310          Simplenote application = (Simplenote) getActivity().getApplication();
 311          Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 312          Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 313          while (notesCursor.moveToNext()) {
 314              Note note = notesCursor.getObject();
 315              if (note.isNew() || note.isModified()) {
 316                  return true;
 317              }
 318          }
 319  
 320          return false;
 321      }
 322  
 323      private void logOut() {
 324          Simplenote application = (Simplenote) getActivity().getApplication();
 325          application.getSimperium().deauthorizeUser();
 326  
 327          application.getNotesBucket().reset();
 328          application.getTagsBucket().reset();
 329          application.getPreferencesBucket().reset();
 330  
 331          application.getNotesBucket().stop();
 332          application.getTagsBucket().stop();
 333          application.getPreferencesBucket().stop();
 334  
 335          AnalyticsTracker.track(
 336                  AnalyticsTracker.Stat.USER_SIGNED_OUT,
 337                  AnalyticsTracker.CATEGORY_USER,
 338                  &quot;preferences_sign_out_button&quot;
 339          );
 340  
 341          // Resets analytics user back to &#x27;anon&#x27; type
 342          AnalyticsTracker.refreshMetadata(null);
 343          CrashUtils.clearCurrentUser();
 344  
 345          // Remove wp.com token
 346          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();
 347          editor.remove(PrefUtils.PREF_WP_TOKEN);
 348  
 349          // Remove WordPress sites
 350          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 351          editor.apply();
 352  
 353          // Remove Passcode Lock password
 354          AppLockManager.getInstance().getAppLock().setPassword(&quot;&quot;);
 355  
 356          WidgetUtils.updateNoteWidgets(requireActivity().getApplicationContext());
 357  
 358          getActivity().finish();
 359      }
 360  
 361      @Override
 362      public void onUserStatusChange(User.Status status) {
 363          if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 364              // User signed in
 365              getActivity().runOnUiThread(new Runnable() {
 366                  public void run() {
 367                      Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 368                      authenticatePreference.setTitle(R.string.log_out);
 369                  }
 370              });
 371  
 372              Simplenote app = (Simplenote) getActivity().getApplication();
 373              AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 374              CrashUtils.setCurrentUser(app.getSimperium().getUser());
 375  
 376              AnalyticsTracker.track(
 377                      AnalyticsTracker.Stat.USER_SIGNED_IN,
 378                      AnalyticsTracker.CATEGORY_USER,
 379                      &quot;signed_in_from_preferences_activity&quot;
 380              );
 381          }
 382      }
 383  
 384      @Override
 385      public void onUserCreated(User user) {
 386          AnalyticsTracker.track(
 387                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 388                  AnalyticsTracker.CATEGORY_USER,
 389                  &quot;account_created_from_preferences_activity&quot;
 390          );
 391      }
 392  
 393      private void updateAnalyticsSwitchState() {
 394          try {
 395              Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 396              mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 397          } catch (BucketObjectMissingException e) {
 398              // The preferences object doesn&#x27;t exist for this user yet, create it
 399              try {
 400                  Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 401                  prefs.setAnalyticsEnabled(true);
 402                  prefs.save();
 403              } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 404                  bucketObjectNameInvalid.printStackTrace();
 405              }
 406          }
 407      }
 408  
 409      private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 410          private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 411  
 412          LogOutTask(PreferencesFragment fragment) {
 413              mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 414          }
 415  
 416          @Override
 417          protected Boolean doInBackground(Void... voids) {
 418              PreferencesFragment fragment = mPreferencesFragmentReference.get();
 419              return fragment == null || fragment.hasUnsyncedNotes();
 420          }
 421  
 422          @Override
 423          protected void onPostExecute(Boolean hasUnsyncedNotes) {
 424              PreferencesFragment fragment = mPreferencesFragmentReference.get();
 425  
 426              if (fragment == null) {
 427                  return;
 428              }
 429  
 430              // Safety first! Check if any notes are unsynced and warn the user if so.
 431              if (hasUnsyncedNotes) {
 432                  new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))
 433                          .setTitle(R.string.unsynced_notes)
 434                          .setMessage(R.string.unsynced_notes_message)
 435                          .setPositiveButton(R.string.delete_notes, fragment.logOutClickListener)
 436                          .setNeutralButton(R.string.visit_web_app, fragment.loadWebAppClickListener)
 437                          .setNegativeButton(R.string.cancel, null)
 438                          .show();
 439              } else {
 440                  fragment.logOut();
 441              }
 442          }
 443      }
 444  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.Fragment;



   5  import android.content.DialogInterface;
   6  import android.content.Intent;
   7  import android.content.SharedPreferences;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 -import android.net.Uri;</span>
   9  import android.os.AsyncTask;
  10  import android.os.Bundle;


  11  import android.widget.Toast;
  12  
  13  import androidx.appcompat.app.AlertDialog;
  14  import androidx.appcompat.view.ContextThemeWrapper;
  15  import androidx.preference.ListPreference;
  16  import androidx.preference.Preference;
  17  import androidx.preference.PreferenceFragmentCompat;
  18  import androidx.preference.PreferenceManager;
  19  import androidx.preference.SwitchPreferenceCompat;
  20  
  21  import com.automattic.simplenote.analytics.AnalyticsTracker;
  22  import com.automattic.simplenote.models.Note;
  23  import com.automattic.simplenote.models.Preferences;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.automattic.simplenote.utils.BrowserUtils;</span>
  25  import com.automattic.simplenote.utils.CrashUtils;
  26  import com.automattic.simplenote.utils.HtmlCompat;
  27  import com.automattic.simplenote.utils.PrefUtils;
  28  import com.automattic.simplenote.utils.WidgetUtils;
  29  import com.simperium.Simperium;
  30  import com.simperium.client.Bucket;
  31  import com.simperium.client.BucketObjectMissingException;
  32  import com.simperium.client.BucketObjectNameInvalid;
  33  import com.simperium.client.User;
  34  


  35  import org.wordpress.passcodelock.AppLockManager;
  36  

  37  import java.lang.ref.WeakReference;
  38  
  39  import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  40  
  41  /**
  42   * A simple {@link Fragment} subclass.
  43   */
  44  public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener,
  45          Simperium.OnUserCreatedListener {
  46  
  47      private static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  48  
  49      private Bucket&lt;Preferences&gt; mPreferencesBucket;
  50      private SwitchPreferenceCompat mAnalyticsSwitch;
  51  
  52      public PreferencesFragment() {
  53          // Required empty public constructor
  54      }
  55  
  56      @Override
  57      public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  58          addPreferencesFromResource(R.xml.preferences);
  59      }
  60  
  61      @Override
  62      public void onActivityCreated(Bundle savedInstanceState) {
  63          super.onActivityCreated(savedInstanceState);
  64  
  65          Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  66          Simplenote currentApp = (Simplenote) getActivity().getApplication();
  67          Simperium simperium = currentApp.getSimperium();
  68          simperium.setUserStatusChangeListener(this);
  69          simperium.setOnUserCreatedListener(this);
  70          mPreferencesBucket = currentApp.getPreferencesBucket();
  71          mPreferencesBucket.start();
  72  
  73          authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  74          if (simperium.needsAuthorization()) {
  75              authenticatePreference.setTitle(R.string.log_in);
  76          } else {
  77              authenticatePreference.setTitle(R.string.log_out);
  78          }
  79  
  80          authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
  81              @Override
  82              public boolean onPreferenceClick(Preference preference) {
  83                  if (!isAdded()) {
  84                      return false;
  85                  }
  86  
  87                  Simplenote currentApp = (Simplenote) getActivity().getApplication();
  88                  if (currentApp.getSimperium().needsAuthorization()) {
  89                      Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);
  90                      startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
  91                  } else {
  92                      new LogOutTask(PreferencesFragment.this).execute();
  93                  }
  94                  return true;
  95              }
  96          });
  97  
<abbr title="  98          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {">  98          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener()ðŸ”µ</abbr>
  99              @Override
 100              public boolean onPreferenceClick(Preference preference) {
 101                  try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -                    startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(&quot;http://simplenote.com&quot;)));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +                    BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);</span>
 104                  } catch (Exception e) {
 105                      Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();
 106                  }
 107                  return true;
 108              }
 109          });
 110  
 111          findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 112              @Override
 113              public boolean onPreferenceClick(Preference preference) {
 114                  startActivity(new Intent(getActivity(), AboutActivity.class));














 115                  return true;
 116              }
 117          });
 118  
 119          final ListPreference themePreference = (ListPreference) findPreference(PrefUtils.PREF_THEME);
 120          themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 121              @Override
 122              public boolean onPreferenceChange(Preference preference, Object newValue) {
 123                  updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 124                  return true;
 125              }
 126  
 127              private void updateTheme(Activity activity, int index) {
 128                  CharSequence[] entries = themePreference.getEntries();
 129                  themePreference.setSummary(entries[index]);
 130  
 131                  AnalyticsTracker.track(
 132                          AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 133                          AnalyticsTracker.CATEGORY_USER,
 134                          &quot;theme_preference&quot;
 135                  );
 136  
 137                  // recreate the activity so new theme is applied
 138                  activity.recreate();
 139              }
 140          });
 141  
 142          final ListPreference sortPreference = (ListPreference) findPreference(PrefUtils.PREF_SORT_ORDER);
 143          sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 144              @Override
 145              public boolean onPreferenceChange(Preference preference, Object newValue) {
 146                  int index = Integer.parseInt(newValue.toString());
 147                  CharSequence[] entries = sortPreference.getEntries();
 148                  sortPreference.setSummary(entries[index]);
 149  
 150                  return true;
 151              }
 152          });
 153  
 154          Preference versionPref = findPreference(&quot;pref_key_build&quot;);
 155          versionPref.setSummary(PrefUtils.versionInfo());
 156  
<abbr title=" 157          SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_note_list&quot;);"> 157          SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_noteðŸ”µ</abbr>
 158          switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 159              @Override
 160              public boolean onPreferenceChange(Preference preference, Object o) {
 161                  if (((SwitchPreferenceCompat) preference).isChecked()) {
 162                      AnalyticsTracker.track(
 163                              AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 164                              AnalyticsTracker.CATEGORY_USER,
 165                              &quot;condensed_list_preference&quot;
 166                      );
 167                  }
 168  
 169                  return true;
 170              }
 171          });
 172  
 173          // Add the hyperlink to the analytics summary
 174          Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 175          String formattedSummary = String.format(
 176                  getString(R.string.share_analytics_summary),
 177                  &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 178                  &quot;&lt;/a&gt;&quot;
 179          );
 180          analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 181  
 182          mAnalyticsSwitch = (SwitchPreferenceCompat)findPreference(&quot;pref_key_analytics_switch&quot;);
 183          mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 184              @Override
 185              public boolean onPreferenceChange(Preference preference, Object newValue) {
 186                  try {
 187                      boolean isChecked = (boolean)newValue;
 188                      Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 189                      prefs.setAnalyticsEnabled(isChecked);
 190                      prefs.save();
 191                  } catch (BucketObjectMissingException e) {
 192                      e.printStackTrace();
 193                  }
 194  
 195                  return true;
 196              }
 197          });
 198  
 199          updateAnalyticsSwitchState();


































































 200      }
 201  
 202      @Override
 203      public void onPause() {
 204          super.onPause();
 205          mPreferencesBucket.stop();
 206      }
 207  
 208      private DialogInterface.OnClickListener logOutClickListener = new DialogInterface.OnClickListener() {
 209          @Override
 210          public void onClick(DialogInterface dialogInterface, int i) {
 211              logOut();
 212          }
 213      };
 214  
 215      private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListener() {
 216          @Override
 217          public void onClick(DialogInterface dialogInterface, int i) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -            startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(WEB_APP_URL)));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +            BrowserUtils.launchBrowserOrShowError(requireContext(), WEB_APP_URL);</span>
 220          }
 221      };
 222  
 223      private boolean hasUnsyncedNotes() {
 224          Simplenote application = (Simplenote) getActivity().getApplication();
 225          Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 226          Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 227          while (notesCursor.moveToNext()) {
 228              Note note = notesCursor.getObject();
 229              if (note.isNew() || note.isModified()) {
 230                  return true;
 231              }
 232          }
 233  
 234          return false;
 235      }
 236  
 237      private void logOut() {
 238          Simplenote application = (Simplenote) getActivity().getApplication();
 239          application.getSimperium().deauthorizeUser();
 240  
 241          application.getNotesBucket().reset();
 242          application.getTagsBucket().reset();
 243          application.getPreferencesBucket().reset();
 244  
 245          application.getNotesBucket().stop();
 246          application.getTagsBucket().stop();
 247          application.getPreferencesBucket().stop();
 248  
 249          AnalyticsTracker.track(
 250                  AnalyticsTracker.Stat.USER_SIGNED_OUT,
 251                  AnalyticsTracker.CATEGORY_USER,
 252                  &quot;preferences_sign_out_button&quot;
 253          );
 254  
 255          // Resets analytics user back to &#x27;anon&#x27; type
 256          AnalyticsTracker.refreshMetadata(null);
 257          CrashUtils.clearCurrentUser();
 258  
 259          // Remove wp.com token
 260          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();
 261          editor.remove(PrefUtils.PREF_WP_TOKEN);
 262  
 263          // Remove WordPress sites
 264          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 265          editor.apply();
 266  
 267          // Remove Passcode Lock password
 268          AppLockManager.getInstance().getAppLock().setPassword(&quot;&quot;);
 269  
 270          WidgetUtils.updateNoteWidgets(requireActivity().getApplicationContext());
 271  
 272          getActivity().finish();
 273      }
 274  
 275      @Override
 276      public void onUserStatusChange(User.Status status) {
 277          if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 278              // User signed in
 279              getActivity().runOnUiThread(new Runnable() {
 280                  public void run() {
 281                      Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 282                      authenticatePreference.setTitle(R.string.log_out);
 283                  }
 284              });
 285  
 286              Simplenote app = (Simplenote) getActivity().getApplication();
 287              AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 288              CrashUtils.setCurrentUser(app.getSimperium().getUser());
 289  
 290              AnalyticsTracker.track(
 291                      AnalyticsTracker.Stat.USER_SIGNED_IN,
 292                      AnalyticsTracker.CATEGORY_USER,
 293                      &quot;signed_in_from_preferences_activity&quot;
 294              );
 295          }
 296      }
 297  
 298      @Override
 299      public void onUserCreated(User user) {
 300          AnalyticsTracker.track(
 301                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 302                  AnalyticsTracker.CATEGORY_USER,
 303                  &quot;account_created_from_preferences_activity&quot;
 304          );
 305      }
 306  
 307      private void updateAnalyticsSwitchState() {
 308          try {
 309              Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 310              mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 311          } catch (BucketObjectMissingException e) {
 312              // The preferences object doesn&#x27;t exist for this user yet, create it
 313              try {
 314                  Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 315                  prefs.setAnalyticsEnabled(true);
 316                  prefs.save();
 317              } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 318                  bucketObjectNameInvalid.printStackTrace();
 319              }
 320          }
 321      }
 322  
 323      private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 324          private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 325  
 326          LogOutTask(PreferencesFragment fragment) {
 327              mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 328          }
 329  
 330          @Override
 331          protected Boolean doInBackground(Void... voids) {
 332              PreferencesFragment fragment = mPreferencesFragmentReference.get();
 333              return fragment == null || fragment.hasUnsyncedNotes();
 334          }
 335  
 336          @Override
 337          protected void onPostExecute(Boolean hasUnsyncedNotes) {
 338              PreferencesFragment fragment = mPreferencesFragmentReference.get();
 339  
 340              if (fragment == null) {
 341                  return;
 342              }
 343  
 344              // Safety first! Check if any notes are unsynced and warn the user if so.
 345              if (hasUnsyncedNotes) {
 346                  new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))
 347                          .setTitle(R.string.unsynced_notes)
 348                          .setMessage(R.string.unsynced_notes_message)
 349                          .setPositiveButton(R.string.delete_notes, fragment.logOutClickListener)
 350                          .setNeutralButton(R.string.visit_web_app, fragment.loadWebAppClickListener)
 351                          .setNegativeButton(R.string.cancel, null)
 352                          .show();
 353              } else {
 354                  fragment.logOut();
 355              }
 356          }
 357      }
 358  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            