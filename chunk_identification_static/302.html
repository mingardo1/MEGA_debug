<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>302</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    302
                    <a href="301.html">prev</a>
                    <a href="303.html">next</a>
                    <a href="302_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_cd7cff12a798c3a68943ad44552e25fb0f98f8d1_core/broadleaf-profile/src/main/java/org/broadleafcommerce/profile/core/service/CustomerServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1:core/broadleaf-profile/src/main/java/org/broadleafcommerce/profile/core/service/CustomerServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1^1:core/broadleaf-profile/src/main/java/org/broadleafcommerce/profile/core/service/CustomerServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1^2:core/broadleaf-profile/src/main/java/org/broadleafcommerce/profile/core/service/CustomerServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;556ac57d12139326e76b29db4638956d93283fb1:core/broadleaf-profile/src/main/java/org/broadleafcommerce/profile/core/service/CustomerServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [sbj], [bs]], subset: [[b], [b], [b], [sbj], [bs]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Profile
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.profile.core.service;
  19 
  20 import org.apache.commons.collections4.CollectionUtils;
  21 import org.apache.commons.lang3.StringUtils;
  22 import org.apache.commons.logging.Log;
  23 import org.apache.commons.logging.LogFactory;
  24 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 import org.broadleafcommerce.common.email.service.EmailService;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import org.broadleafcommerce.common.email.service.info.EmailInfo;</span>
  27 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.broadleafcommerce.common.id.service.IdGenerationService;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.broadleafcommerce.profile.core.dto.CustomerRuleHolder;</span>
  31 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import org.broadleafcommerce.common.event.BroadleafApplicationEventPublisher;</span>
  33 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  34 import org.broadleafcommerce.common.id.service.IdGenerationService;
  35 import org.broadleafcommerce.common.rule.MvelHelper;
  36 import org.broadleafcommerce.common.security.util.PasswordChange;
  37 import org.broadleafcommerce.common.security.util.PasswordReset;
  38 import org.broadleafcommerce.common.security.util.PasswordUtils;
  39 import org.broadleafcommerce.common.service.GenericResponse;
  40 import org.broadleafcommerce.common.time.SystemTime;
  41 import org.broadleafcommerce.common.util.StringUtil;
  42 import org.broadleafcommerce.common.util.TransactionUtils;
  43 import org.broadleafcommerce.profile.core.dao.CustomerDao;
  44 import org.broadleafcommerce.profile.core.dao.CustomerForgotPasswordSecurityTokenDao;
  45 import org.broadleafcommerce.profile.core.dao.RoleDao;
  46 import org.broadleafcommerce.profile.core.domain.Customer;
  47 import org.broadleafcommerce.profile.core.domain.CustomerForgotPasswordSecurityToken;
  48 import org.broadleafcommerce.profile.core.domain.CustomerForgotPasswordSecurityTokenImpl;
  49 import org.broadleafcommerce.profile.core.domain.CustomerRole;
  50 import org.broadleafcommerce.profile.core.domain.CustomerRoleImpl;
  51 import org.broadleafcommerce.profile.core.domain.Role;
  52 import org.broadleafcommerce.profile.core.dto.CustomerRuleHolder;
  53 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  54 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 import org.broadleafcommerce.profile.core.domain.CustomerRoleImpl;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 import org.broadleafcommerce.profile.core.domain.Role;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 import org.broadleafcommerce.profile.core.service.handler.PasswordUpdatedHandler;</span>
  58 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59 import org.broadleafcommerce.profile.core.event.ForgotPasswordEvent;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60 import org.broadleafcommerce.profile.core.event.ForgotUsernameEvent;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61 import org.broadleafcommerce.profile.core.event.RegisterCustomerEvent;</span>
  62 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  63 import org.broadleafcommerce.profile.core.service.handler.PasswordUpdatedHandler;
  64 import org.broadleafcommerce.profile.core.service.listener.PostRegistrationObserver;
  65 import org.springframework.beans.factory.annotation.Value;
  66 import org.springframework.security.crypto.password.PasswordEncoder;
  67 import org.springframework.stereotype.Service;
  68 import org.springframework.transaction.annotation.Transactional;
  69 import java.util.ArrayList;
  70 import java.util.Date;
  71 import java.util.HashMap;
  72 import java.util.Iterator;
  73 import java.util.List;
  74 import java.util.Map;
  75 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76 </span>
  77 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78 import java.util.Date;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79 import java.util.HashMap;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80 import java.util.Iterator;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83 </span>
  84 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85 import javax.annotation.PostConstruct;</span>
  86 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  87 import javax.annotation.Resource;
  88 
  89 @Service(&quot;blCustomerService&quot;)
  90 public class CustomerServiceImpl implements CustomerService {
  91     private static final Log LOG = LogFactory.getLog(CustomerServiceImpl.class);
  92     private static final int PASSWORD_LENGTH = 16;
  93 
  94     @Autowired
  95     @Qualifier(&quot;blApplicationEventPublisher&quot;)
  96     protected BroadleafApplicationEventPublisher eventPublisher;
  97 
  98     @Resource(name=&quot;blCustomerDao&quot;)
  99     protected CustomerDao customerDao;
 100 
 101     @Resource(name = &quot;blIdGenerationService&quot;)
 102     protected IdGenerationService idGenerationService;
 103 
 104     @Resource(name = &quot;blCustomerForgotPasswordSecurityTokenDao&quot;)
 105     protected CustomerForgotPasswordSecurityTokenDao customerForgotPasswordSecurityTokenDao;
 106 
 107     /**
<abbr title=" 108      * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using the"> 108      * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;rðŸ”µ</abbr>
<abbr title=" 109      * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}"> 109      * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.eðŸ”µ</abbr>
 110      */
 111     @Resource(name = &quot;blPasswordEncoder&quot;)
 112     protected PasswordEncoder passwordEncoderBean;
 113 
 114     @Resource(name = &quot;blRoleDao&quot;)
 115     protected RoleDao roleDao;
 116 
 117     protected int tokenExpiredMinutes = 30;
 118     protected int passwordTokenLength = 20;
 119 
<abbr title=" 120     protected final List&lt;PostRegistrationObserver&gt; postRegisterListeners = new ArrayList&lt;PostRegistrationObserver&gt;();"> 120     protected final List&lt;PostRegistrationObserver&gt; postRegisterListeners = new ArrayList&lt;PostRegistrationðŸ”µ</abbr>
<abbr title=" 121     protected List&lt;PasswordUpdatedHandler&gt; passwordResetHandlers = new ArrayList&lt;PasswordUpdatedHandler&gt;();"> 121     protected List&lt;PasswordUpdatedHandler&gt; passwordResetHandlers = new ArrayList&lt;PasswordUpdatedHandler&gt;(ðŸ”µ</abbr>
<abbr title=" 122     protected List&lt;PasswordUpdatedHandler&gt; passwordChangedHandlers = new ArrayList&lt;PasswordUpdatedHandler&gt;();"> 122     protected List&lt;PasswordUpdatedHandler&gt; passwordChangedHandlers = new ArrayList&lt;PasswordUpdatedHandlerðŸ”µ</abbr>
 123 
 124     @Override
 125     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 126     public Customer saveCustomer(Customer customer) {
 127         return saveCustomer(customer, customer.isRegistered());
 128     }
 129 
 130     @Override
 131     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 132     public Customer saveCustomer(Customer customer, boolean register) {
 133         if (register &amp;&amp; !customer.isRegistered()) {
 134             customer.setRegistered(true);
 135         }
 136 
 137         if (customer.getUnencodedPassword() != null) {
 138             customer.setPassword(encodePassword(customer.getUnencodedPassword()));
 139         }
 140 
 141         // let&#x27;s make sure they entered a new challenge answer (we will populate
 142         // the password field with hashed values so check that they have changed
 143         // id
<abbr title=" 144         if (customer.getUnencodedChallengeAnswer() != null &amp;&amp; !customer.getUnencodedChallengeAnswer().equals(customer.getChallengeAnswer())) {"> 144         if (customer.getUnencodedChallengeAnswer() != null &amp;&amp; !customer.getUnencodedChallengeAnswer().equðŸ”µ</abbr>
 145             customer.setChallengeAnswer(encodePassword(customer.getUnencodedChallengeAnswer()));
 146         }
 147         return customerDao.save(customer);
 148     }
 149 
 150     protected String generateSecurePassword() {
 151         return PasswordUtils.generateSecurePassword(PASSWORD_LENGTH);
 152     }
 153 
 154     @Override
 155     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 156     public Customer registerCustomer(Customer customer, String password, String passwordConfirm) {
 157         customer.setRegistered(true);
 158 
 159         // When unencodedPassword is set the save() will encode it
 160         if (customer.getId() == null) {
 161             customer.setId(findNextCustomerId());
 162         }
 163         customer.setUnencodedPassword(password);
 164         Customer retCustomer = saveCustomer(customer);
 165         createRegisteredCustomerRoles(retCustomer);
 166         
 167         eventPublisher.publishEvent(new RegisterCustomerEvent(this, retCustomer.getId()));
 168         notifyPostRegisterListeners(retCustomer);
 169 
 170         return retCustomer;
 171     }
 172 
 173     @Override
 174     public void createRegisteredCustomerRoles(Customer customer) {
 175         Role role = roleDao.readRoleByName(&quot;ROLE_USER&quot;);
 176         CustomerRole customerRole = new CustomerRoleImpl();
 177         customerRole.setRole(role);
 178         customerRole.setCustomer(customer);
 179         roleDao.addRoleToCustomer(customerRole);
 180     }
 181 
 182     @Override
 183     public Customer readCustomerByEmail(String emailAddress) {
 184         return customerDao.readCustomerByEmail(emailAddress);
 185     }
 186 
 187     @Override
 188     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 189     public Customer changePassword(PasswordChange passwordChange) {
 190         Customer customer = readCustomerByUsername(passwordChange.getUsername());
 191         customer.setUnencodedPassword(passwordChange.getNewPassword());
 192         customer.setPasswordChangeRequired(passwordChange.getPasswordChangeRequired());
 193         customer = saveCustomer(customer);
 194 
 195         for (PasswordUpdatedHandler handler : passwordChangedHandlers) {
 196             handler.passwordChanged(passwordChange, customer, passwordChange.getNewPassword());
 197         }
 198 
 199         return customer;
 200     }
 201 
 202     @Override
 203     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 204     public Customer resetPassword(PasswordReset passwordReset) {
 205         Customer customer = readCustomerByUsername(passwordReset.getUsername());
 206         String newPassword = PasswordUtils.generateSecurePassword(passwordReset.getPasswordLength());
 207         customer.setUnencodedPassword(newPassword);
 208         customer.setPasswordChangeRequired(passwordReset.getPasswordChangeRequired());
 209         customer = saveCustomer(customer);
 210 
 211         for (PasswordUpdatedHandler handler : passwordResetHandlers) {
 212             handler.passwordChanged(passwordReset, customer, newPassword);
 213         }
 214 
 215         return customer;
 216     }
 217 
 218     @Override
 219     public void addPostRegisterListener(PostRegistrationObserver postRegisterListeners) {
 220         this.postRegisterListeners.add(postRegisterListeners);
 221     }
 222 
 223     @Override
 224     public void removePostRegisterListener(PostRegistrationObserver postRegisterListeners) {
 225         if (this.postRegisterListeners.contains(postRegisterListeners)) {
 226             this.postRegisterListeners.remove(postRegisterListeners);
 227         }
 228     }
 229 
 230     protected void notifyPostRegisterListeners(Customer customer) {
<abbr title=" 231         for (Iterator&lt;PostRegistrationObserver&gt; iter = postRegisterListeners.iterator(); iter.hasNext(); ) {"> 231         for (Iterator&lt;PostRegistrationObserver&gt; iter = postRegisterListeners.iterator(); iter.hasNext(); ðŸ”µ</abbr>
 232             PostRegistrationObserver listener = iter.next();
 233             listener.processRegistrationEvent(customer);
 234         }
 235     }
 236 
 237     @Override
 238     public Customer createCustomer() {
 239         return createCustomerFromId(null);
 240     }
 241 
 242     @Override
 243     public Customer createCustomerFromId(Long customerId) {
 244         Customer customer = customerId != null ? readCustomerById(customerId) : null;
 245         if (customer == null) {
 246             customer = customerDao.create();
 247             if (customerId != null) {
 248                 customer.setId(customerId);
 249             } else {
 250                 customer.setId(findNextCustomerId());
 251             }
 252         }
 253         return customer;
 254     }
 255 
 256     @Override
 257     public Long findNextCustomerId() {
 258         return idGenerationService.findNextId(Customer.class.getCanonicalName());
 259     }
 260 
 261     @Override
 262     public Customer createNewCustomer() {
 263         return createCustomerFromId(null);
 264     }
 265 
 266     @Override
 267     public void deleteCustomer(Customer customer) {
 268         roleDao.removeCustomerRolesByCustomerId(customer.getId());
 269         customerDao.delete(customer);
 270     }
 271 
 272     @Override
 273     public Customer readCustomerByUsername(String username) {
 274         return customerDao.readCustomerByUsername(username);
 275     }
 276 
 277     @Override
 278     public Customer readCustomerByUsername(String username, Boolean cacheable) {
 279         return customerDao.readCustomerByUsername(username, cacheable);
 280     }
 281 
 282     @Override
 283     public Customer readCustomerById(Long id) {
 284         return customerDao.readCustomerById(id);
 285     }
 286 
 287     @Override
 288     public Customer readCustomerByExternalId(String userExternalId) {
 289         return customerDao.readCustomerByExternalId(userExternalId);
 290     }
 291 
 292     public void setCustomerDao(CustomerDao customerDao) {
 293         this.customerDao = customerDao;
 294     }
 295 
 296     @Override
 297     public String encodePassword(String rawPassword) {
 298         return passwordEncoderBean.encode(rawPassword);
 299     }
 300 
 301     @Override
 302     public boolean isPasswordValid(String rawPassword, String encodedPassword) {
 303         return passwordEncoderBean.matches(rawPassword, encodedPassword);
 304     }
 305 
 306     @Override
 307     public boolean customerPassesCustomerRule(Customer customer, CustomerRuleHolder customerRuleHolder) {
 308         String customerRule = customerRuleHolder.getCustomerRule();
 309         Map&lt;String, Object&gt; ruleParams = buildCustomerRuleParams(customer);
 310         return customerRule == null || MvelHelper.evaluateRule(customerRule, ruleParams);
 311     }
 312 
 313     protected Map&lt;String, Object&gt; buildCustomerRuleParams(Customer customer) {
 314         HashMap&lt;String, Object&gt; vars = new HashMap&lt;&gt;();
 315         vars.put(&quot;customer&quot;, customer);
 316         return vars;
 317     }
 318 
 319     @Override
 320     public List&lt;PasswordUpdatedHandler&gt; getPasswordResetHandlers() {
 321         return passwordResetHandlers;
 322     }
 323 
 324     @Override
 325     public void setPasswordResetHandlers(List&lt;PasswordUpdatedHandler&gt; passwordResetHandlers) {
 326         this.passwordResetHandlers = passwordResetHandlers;
 327     }
 328 
 329     @Override
 330     public List&lt;PasswordUpdatedHandler&gt; getPasswordChangedHandlers() {
 331         return passwordChangedHandlers;
 332     }
 333 
 334     @Override
 335     public void setPasswordChangedHandlers(List&lt;PasswordUpdatedHandler&gt; passwordChangedHandlers) {
 336         this.passwordChangedHandlers = passwordChangedHandlers;
 337     }
 338 
 339     @Override
 340     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 341     public GenericResponse sendForgotUsernameNotification(String emailAddress) {
 342         GenericResponse response = new GenericResponse();
 343         List&lt;Customer&gt; customers = null;
 344         if (emailAddress != null) {
 345             customers = customerDao.readCustomersByEmail(emailAddress);
 346         }
 347 
 348         if (CollectionUtils.isEmpty(customers)) {
 349             response.addErrorCode(&quot;notFound&quot;);
 350         } else {
 351             List&lt;String&gt; activeUsernames = new ArrayList&lt;String&gt;();
 352             for (Customer customer : customers) {
 353                 if (!customer.isDeactivated()) {
 354                     activeUsernames.add(customer.getUsername());
 355                 }
 356             }
 357 
 358             if (activeUsernames.size() &gt; 0) {
<abbr title=" 359                 eventPublisher.publishEvent(new ForgotUsernameEvent(this, emailAddress, activeUsernames));"> 359                 eventPublisher.publishEvent(new ForgotUsernameEvent(this, emailAddress, activeUsernames))ðŸ”µ</abbr>
 360             } else {
 361                 // send inactive username found email.
 362                 response.addErrorCode(&quot;inactiveUser&quot;);
 363             }
 364         }
 365         return response;
 366     }
 367 
 368     @Override
 369     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 370     public GenericResponse sendForgotPasswordNotification(String username, String resetPasswordUrl) {
 371         GenericResponse response = new GenericResponse();
 372         Customer customer = null;
 373 
 374         if (username != null) {
 375             customer = customerDao.readCustomerByUsername(username);
 376         }
 377 
 378         checkCustomer(customer, response);
 379 
 380         if (!response.getHasErrors()) {
 381             String token = PasswordUtils.generateSecurePassword(getPasswordTokenLength());
 382             token = token.toLowerCase();
 383 
 384             CustomerForgotPasswordSecurityToken fpst = new CustomerForgotPasswordSecurityTokenImpl();
 385             fpst.setCustomerId(customer.getId());
 386             fpst.setToken(encodePassword(token));
 387             fpst.setCreateDate(SystemTime.asDate());
 388             customerForgotPasswordSecurityTokenDao.saveToken(fpst);
 389 
 390 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 391             HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 392             vars.put(&quot;token&quot;, token);</span>
 393 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395         return salt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 399      * Delegates to either the new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}."> 399      * Delegates to either the new {@link PasswordEncoder} or the deprecated {@link org.springframework.sðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401      * @param rawPassword the unencoded password</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402      * @param salt        the optional salt</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 404      * @deprecated the new {@link org.springframework.security.crypto.password.PasswordEncoder PasswordEncoder} handles salting internally, this will be removed in 4.2"> 404      * @deprecated the new {@link org.springframework.security.crypto.password.PasswordEncoder PasswordEnðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406     @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407     protected String encodePass(String rawPassword, Object salt) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408         if (usingDeprecatedPasswordEncoder()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409             return passwordEncoder.encodePassword(rawPassword, salt);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411             return encodePassword(rawPassword);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415     @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417     public String encodePassword(String rawPassword, Customer customer) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418         return encodePass(rawPassword, getSalt(customer, rawPassword));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422     public String encodePassword(String rawPassword) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423         return passwordEncoderNew.encode(rawPassword);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 427      * Delegates to either the new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}."> 427      * Delegates to either the new {@link PasswordEncoder} or the deprecated {@link org.springframework.sðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429      * @param rawPassword     the unencoded password</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430      * @param encodedPassword the encoded password to compare rawPassword against</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431      * @param salt            the optional salt</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 433      * @deprecated the new {@link org.springframework.security.crypto.password.PasswordEncoder PasswordEncoder} handles salting internally, this will be removed in 4.2"> 433      * @deprecated the new {@link org.springframework.security.crypto.password.PasswordEncoder PasswordEnðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435     @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436     protected boolean isPassValid(String rawPassword, String encodedPassword, Object salt) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437         if (usingDeprecatedPasswordEncoder()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438             return passwordEncoder.isPasswordValid(encodedPassword, rawPassword, salt);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 440             return isPasswordValid(rawPassword, encodedPassword);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444     @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446     public boolean isPasswordValid(String rawPassword, String encodedPassword, Customer customer) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447         return isPassValid(rawPassword, encodedPassword, getSalt(customer, rawPassword));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451     public boolean isPasswordValid(String rawPassword, String encodedPassword) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452         return passwordEncoderNew.matches(rawPassword, encodedPassword);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456     public boolean customerPassesCustomerRule(Customer customer, CustomerRuleHolder customerRuleHolder) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457         String customerRule = customerRuleHolder.getCustomerRule();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458         Map&lt;String, Object&gt; ruleParams = buildCustomerRuleParams(customer);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459         return customerRule == null || MvelHelper.evaluateRule(customerRule, ruleParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462     protected Map&lt;String, Object&gt; buildCustomerRuleParams(Customer customer) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463         HashMap&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 464         vars.put(&quot;customer&quot;, customer);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 465         return vars;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 468     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 469     @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 470     public String getSalt() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 471         return salt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 472     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 473 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475     @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 476     public void setSalt(String salt) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 477         this.salt = salt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 478     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 479 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 480     @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 481     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482     public SaltSource getSaltSource() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483         return saltSource;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486     @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488     public void setSaltSource(SaltSource saltSource) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489         this.saltSource = saltSource;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 490     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 491 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 492     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 493     public List&lt;PasswordUpdatedHandler&gt; getPasswordResetHandlers() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 494         return passwordResetHandlers;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498     public void setPasswordResetHandlers(List&lt;PasswordUpdatedHandler&gt; passwordResetHandlers) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499         this.passwordResetHandlers = passwordResetHandlers;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 502     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 503     public List&lt;PasswordUpdatedHandler&gt; getPasswordChangedHandlers() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 504         return passwordChangedHandlers;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 506 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 507     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 508     public void setPasswordChangedHandlers(List&lt;PasswordUpdatedHandler&gt; passwordChangedHandlers) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 509         this.passwordChangedHandlers = passwordChangedHandlers;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 511 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 512     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 513     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 514     public GenericResponse sendForgotUsernameNotification(String emailAddress) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 515         GenericResponse response = new GenericResponse();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 516         List&lt;Customer&gt; customers = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 517         if (emailAddress != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 518             customers = customerDao.readCustomersByEmail(emailAddress);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 519         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 520 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 521         if (CollectionUtils.isEmpty(customers)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 522             response.addErrorCode(&quot;notFound&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 523         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 524             List&lt;String&gt; activeUsernames = new ArrayList&lt;String&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525             for (Customer customer : customers) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526                 if (!customer.isDeactivated()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527                     activeUsernames.add(customer.getUsername());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 528                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531             if (activeUsernames.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532                 HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533                 vars.put(&quot;userNames&quot;, activeUsernames);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 534                 sendEmail(emailAddress, getForgotUsernameEmailInfo(), vars);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 535             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 536                 // send inactive username found email.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 537                 response.addErrorCode(&quot;inactiveUser&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 538             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 539         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 540         return response;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 541     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 542 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 543     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 544     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 545     public GenericResponse sendForgotPasswordNotification(String username, String resetPasswordUrl) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 546         GenericResponse response = new GenericResponse();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 547         Customer customer = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 548 </span>
 549 =======
 550 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 551             if (!StringUtils.isEmpty(resetPasswordUrl)) {
 552                 if (resetPasswordUrl.contains(&quot;?&quot;)) {
 553                     resetPasswordUrl = resetPasswordUrl+&quot;&amp;token=&quot;+token;
 554                 } else {
 555                     resetPasswordUrl = resetPasswordUrl+&quot;?token=&quot;+token;
 556                 }
 557             }
 558 
<abbr title=" 559             eventPublisher.publishEvent(new ForgotPasswordEvent(this, customer.getId(), token, resetPasswordUrl));"> 559             eventPublisher.publishEvent(new ForgotPasswordEvent(this, customer.getId(), token, resetPasswðŸ”µ</abbr>
 560         }
 561         return response;
 562     }
 563 
 564     @Override
 565     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
<abbr title=" 566     public GenericResponse sendForcedPasswordChangeNotification(String username, String resetPasswordUrl) {"> 566     public GenericResponse sendForcedPasswordChangeNotification(String username, String resetPasswordUrl)ðŸ”µ</abbr>
 567         return sendForgotPasswordNotification(username, resetPasswordUrl);
 568     }
 569 
 570     @Override
 571     public GenericResponse checkPasswordResetToken(String token, Customer customer) {
 572         GenericResponse response = new GenericResponse();
 573         checkPasswordResetToken(token, customer, response);
 574         return response;
 575     }
 576 
<abbr title=" 577     protected CustomerForgotPasswordSecurityToken checkPasswordResetToken(String token, Customer customer, GenericResponse response) {"> 577     protected CustomerForgotPasswordSecurityToken checkPasswordResetToken(String token, Customer customerðŸ”µ</abbr>
 578         if (StringUtils.isBlank(token)) {
 579             response.addErrorCode(&quot;invalidToken&quot;);
 580         }
 581 
 582         String rawToken = token;
 583 
 584         CustomerForgotPasswordSecurityToken fpst = null;
 585         if (!response.getHasErrors()) {
 586             if (customer == null) {
 587                 fpst = customerForgotPasswordSecurityTokenDao.readToken(encodePassword(token));
 588             } else {
<abbr title=" 589                 List&lt;CustomerForgotPasswordSecurityToken&gt; fpstoks = customerForgotPasswordSecurityTokenDao.readUnusedTokensByCustomerId(customer.getId());"> 589                 List&lt;CustomerForgotPasswordSecurityToken&gt; fpstoks = customerForgotPasswordSecurityTokenDaðŸ”µ</abbr>
 590                 for (CustomerForgotPasswordSecurityToken fpstok : fpstoks) {
 591                     if (isPasswordValid(rawToken, fpstok.getToken())) {
 592                         fpst = fpstok;
 593                         break;
 594                     }
 595                 }
 596             }
 597             if (fpst == null) {
 598                 response.addErrorCode(&quot;invalidToken&quot;);
 599             } else if (fpst.isTokenUsedFlag()) {
 600                 response.addErrorCode(&quot;tokenUsed&quot;);
 601             } else if (isTokenExpired(fpst)) {
 602                 response.addErrorCode(&quot;tokenExpired&quot;);
 603             }
 604         }
 605         return fpst;
 606     }
 607 
 608     @Override
 609     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
<abbr title=" 610     public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPassword) {"> 610     public GenericResponse resetPasswordUsingToken(String username, String token, String password, StringðŸ”µ</abbr>
 611         GenericResponse response = new GenericResponse();
 612         Customer customer = null;
 613         if (username != null) {
 614             customer = customerDao.readCustomerByUsername(username);
 615         }
 616         checkCustomer(customer, response);
 617         checkPassword(password, confirmPassword, response);
 618         CustomerForgotPasswordSecurityToken fpst = checkPasswordResetToken(token, customer, response);
 619 
 620         if (!response.getHasErrors()) {
 621             if (!customer.getId().equals(fpst.getCustomerId())) {
 622                 if (LOG.isWarnEnabled()) {
<abbr title=" 623                     LOG.warn(&quot;Password reset attempt tried with mismatched customer and token &quot; + customer.getId() + &quot;, &quot; + StringUtil.sanitize(token));"> 623                     LOG.warn(&quot;Password reset attempt tried with mismatched customer and token &quot; + customeðŸ”µ</abbr>
 624                 }
 625                 response.addErrorCode(&quot;invalidToken&quot;);
 626             }
 627         }
 628 
 629         if (!response.getHasErrors()) {
 630             customer.setUnencodedPassword(password);
 631             customer.setPasswordChangeRequired(false);
 632             saveCustomer(customer);
 633             invalidateAllTokensForCustomer(customer);
 634         }
 635 
 636         return response;
 637     }
 638 
 639     protected void invalidateAllTokensForCustomer(Customer customer) {
<abbr title=" 640         List&lt;CustomerForgotPasswordSecurityToken&gt; tokens = customerForgotPasswordSecurityTokenDao.readUnusedTokensByCustomerId(customer.getId());"> 640         List&lt;CustomerForgotPasswordSecurityToken&gt; tokens = customerForgotPasswordSecurityTokenDao.readUnuðŸ”µ</abbr>
 641         for (CustomerForgotPasswordSecurityToken token : tokens) {
 642             token.setTokenUsedFlag(true);
 643             customerForgotPasswordSecurityTokenDao.saveToken(token);
 644         }
 645     }
 646 
 647     protected void checkCustomer(Customer customer, GenericResponse response) {
 648         if (customer == null) {
 649             response.addErrorCode(&quot;invalidCustomer&quot;);
 650         } else if (StringUtils.isBlank(customer.getEmailAddress())) {
 651             response.addErrorCode(&quot;emailNotFound&quot;);
 652         } else if (customer.isDeactivated()) {
 653             response.addErrorCode(&quot;inactiveUser&quot;);
 654         }
 655     }
 656 
 657     protected void checkPassword(String password, String confirmPassword, GenericResponse response) {
 658         if (StringUtils.isBlank(password) || StringUtils.isBlank(confirmPassword)) {
 659             response.addErrorCode(&quot;invalidPassword&quot;);
 660         } else if (!password.equals(confirmPassword)) {
 661             response.addErrorCode(&quot;passwordMismatch&quot;);
 662         }
 663     }
 664 
 665     protected boolean isTokenExpired(CustomerForgotPasswordSecurityToken fpst) {
 666         Date now = SystemTime.asDate();
 667         long currentTimeInMillis = now.getTime();
 668         long tokenSaveTimeInMillis = fpst.getCreateDate().getTime();
 669         long minutesSinceSave = (currentTimeInMillis - tokenSaveTimeInMillis) / 60000;
 670         return minutesSinceSave &gt; tokenExpiredMinutes;
 671     }
 672 
 673     public int getTokenExpiredMinutes() {
 674         return tokenExpiredMinutes;
 675     }
 676 
 677     public void setTokenExpiredMinutes(int tokenExpiredMinutes) {
 678         this.tokenExpiredMinutes = tokenExpiredMinutes;
 679     }
 680 
 681     public int getPasswordTokenLength() {
 682         return passwordTokenLength;
 683     }
 684 
 685     public void setPasswordTokenLength(int passwordTokenLength) {
 686         this.passwordTokenLength = passwordTokenLength;
 687     }
 688 
 689 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 690 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 691     public EmailInfo getForgotPasswordEmailInfo() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 692         return forgotPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 693     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 694 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 695     public void setForgotPasswordEmailInfo(EmailInfo forgotPasswordEmailInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 696         this.forgotPasswordEmailInfo = forgotPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 697     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 698 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 699     public EmailInfo getForgotUsernameEmailInfo() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 700         return forgotUsernameEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 701     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 702 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 703     public void setForgotUsernameEmailInfo(EmailInfo forgotUsernameEmailInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 704         this.forgotUsernameEmailInfo = forgotUsernameEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 705     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 706 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 707     public EmailInfo getRegistrationEmailInfo() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 708         return registrationEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 709     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 710 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 711     public void setRegistrationEmailInfo(EmailInfo registrationEmailInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 712         this.registrationEmailInfo = registrationEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 713     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 714 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 715     public EmailInfo getChangePasswordEmailInfo() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 716         return changePasswordEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 717     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 718 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 719     public void setChangePasswordEmailInfo(EmailInfo changePasswordEmailInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 720         this.changePasswordEmailInfo = changePasswordEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 721     }</span>
 722 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 723             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 724         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 725         return response;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 726     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 727 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 728     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 729     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 730     public GenericResponse sendForgotPasswordNotification(String username, String resetPasswordUrl) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 731         GenericResponse response = new GenericResponse();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 732         Customer customer = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 733 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 734         if (username != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 735             customer = customerDao.readCustomerByUsername(username);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 736         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 737 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 738         checkCustomer(customer, response);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 739 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 740         if (!response.getHasErrors()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 741             String token = PasswordUtils.generateSecurePassword(getPasswordTokenLength());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 742             token = token.toLowerCase();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 743 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 744             Object salt = getSalt(customer, token);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 745 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 746             String saltString = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 747             if (salt != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 748                 saltString = Hex.encodeHexString(salt.toString().getBytes());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 749             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 750 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 751             CustomerForgotPasswordSecurityToken fpst = new CustomerForgotPasswordSecurityTokenImpl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 752             fpst.setCustomerId(customer.getId());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 753             fpst.setToken(encodePass(token, saltString));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 754             fpst.setCreateDate(SystemTime.asDate());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 755             customerForgotPasswordSecurityTokenDao.saveToken(fpst);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 756 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 757             if (usingDeprecatedPasswordEncoder() &amp;&amp; saltString != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 758                 token = token + &#x27;-&#x27; + saltString;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 759             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 760 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 761             HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 762             vars.put(&quot;token&quot;, token);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 763             if (!StringUtils.isEmpty(resetPasswordUrl)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 764                 if (resetPasswordUrl.contains(&quot;?&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 765                     resetPasswordUrl = resetPasswordUrl + &quot;&amp;token=&quot; + token;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 766                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 767                     resetPasswordUrl = resetPasswordUrl + &quot;?token=&quot; + token;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 768                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 769             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 770             vars.put(&quot;resetPasswordUrl&quot;, resetPasswordUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 771             sendEmail(customer.getEmailAddress(), getForgotPasswordEmailInfo(), vars);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 772         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 773         return response;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 774     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 775 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 776     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 777     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 778     public GenericResponse sendForcedPasswordChangeNotification(String username, String resetPasswordUrl) {"> 778     public GenericResponse sendForcedPasswordChangeNotification(String username, String resetPasswordUrl)ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 779         return sendForgotPasswordNotification(username, resetPasswordUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 780     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 781 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 782     @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 783     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 784     public GenericResponse checkPasswordResetToken(String token) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 785         if (!usingDeprecatedPasswordEncoder()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 786             // We cannot proceed without a Customer when using the new PasswordEncoder</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 787             throw new NoSuchBeanDefinitionException(&quot;This method requires the deprecated PasswordEncoder bean&quot;);"> 787             throw new NoSuchBeanDefinitionException(&quot;This method requires the deprecated PasswordEncoder ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 788         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 789         return checkPasswordResetToken(token, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 790     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 791 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 792     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 793     public GenericResponse checkPasswordResetToken(String token, Customer customer) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 794         GenericResponse response = new GenericResponse();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 795         checkPasswordResetToken(token, customer, response);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 796         return response;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 797     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 798 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 799     protected CustomerForgotPasswordSecurityToken checkPasswordResetToken(String token, Customer customer, GenericResponse response) {"> 799     protected CustomerForgotPasswordSecurityToken checkPasswordResetToken(String token, Customer customerðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 800         if (StringUtils.isBlank(token)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 801             response.addErrorCode(&quot;invalidToken&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 802         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 803 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 804         String rawToken = token;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 805         String salt = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 806 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 807         if (usingDeprecatedPasswordEncoder()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 808             String[] tokens = token.split(&quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 809             if (tokens.length &gt; 2) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 810                 response.addErrorCode(&quot;invalidToken&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 811             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 812                 rawToken = tokens[0].toLowerCase();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 813                 if (tokens.length == 2) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 814                     salt = tokens[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 815                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 816             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 817         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 818 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 819         CustomerForgotPasswordSecurityToken fpst = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 820         if (!response.getHasErrors()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 821             if (customer == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 822                 if (!usingDeprecatedPasswordEncoder()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 823                     // customer can only be null when supporting use of the legacy PasswordEncoder</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 824                     response.addErrorCode(&quot;invalidCustomer&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 825                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 826                     fpst = customerForgotPasswordSecurityTokenDao.readToken(passwordEncoder.encodePassword(rawToken, salt));"> 826                     fpst = customerForgotPasswordSecurityTokenDao.readToken(passwordEncoder.encodePassworðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 827                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 828             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 829                 List&lt;CustomerForgotPasswordSecurityToken&gt; fpstoks = customerForgotPasswordSecurityTokenDao.readUnusedTokensByCustomerId(customer.getId());"> 829                 List&lt;CustomerForgotPasswordSecurityToken&gt; fpstoks = customerForgotPasswordSecurityTokenDaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 830                 for (CustomerForgotPasswordSecurityToken fpstok : fpstoks) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 831                     if (isPassValid(rawToken, fpstok.getToken(), salt)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 832                         fpst = fpstok;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 833                         break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 834                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 835                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 836             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 837             if (fpst == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 838                 response.addErrorCode(&quot;invalidToken&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 839             } else if (fpst.isTokenUsedFlag()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 840                 response.addErrorCode(&quot;tokenUsed&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 841             } else if (isTokenExpired(fpst)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 842                 response.addErrorCode(&quot;tokenExpired&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 843             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 844         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 845         return fpst;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 846     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 847 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 848     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 849     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 850     public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPassword) {"> 850     public GenericResponse resetPasswordUsingToken(String username, String token, String password, StringðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 851         GenericResponse response = new GenericResponse();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 852         Customer customer = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 853         if (username != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 854             customer = customerDao.readCustomerByUsername(username);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 855         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 856         checkCustomer(customer, response);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 857         checkPassword(password, confirmPassword, response);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 858         CustomerForgotPasswordSecurityToken fpst = checkPasswordResetToken(token, customer, response);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 859 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 860         if (!response.getHasErrors()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 861             if (!customer.getId().equals(fpst.getCustomerId())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 862                 if (LOG.isWarnEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 863                     LOG.warn(&quot;Password reset attempt tried with mismatched customer and token &quot; + customer.getId() + &quot;, &quot; + StringUtil.sanitize(token));"> 863                     LOG.warn(&quot;Password reset attempt tried with mismatched customer and token &quot; + customeðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 864                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 865                 response.addErrorCode(&quot;invalidToken&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 866             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 867         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 868 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 869         if (!response.getHasErrors()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 870             customer.setUnencodedPassword(password);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 871             customer.setPasswordChangeRequired(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 872             saveCustomer(customer);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 873             invalidateAllTokensForCustomer(customer);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 874         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 875 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 876         return response;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 877     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 878 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 879     protected void invalidateAllTokensForCustomer(Customer customer) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 880         List&lt;CustomerForgotPasswordSecurityToken&gt; tokens = customerForgotPasswordSecurityTokenDao.readUnusedTokensByCustomerId(customer.getId());"> 880         List&lt;CustomerForgotPasswordSecurityToken&gt; tokens = customerForgotPasswordSecurityTokenDao.readUnuðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 881         for (CustomerForgotPasswordSecurityToken token : tokens) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 882             token.setTokenUsedFlag(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 883             customerForgotPasswordSecurityTokenDao.saveToken(token);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 884         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 885     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 886 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 887     protected void checkCustomer(Customer customer, GenericResponse response) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 888         if (customer == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 889             response.addErrorCode(&quot;invalidCustomer&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 890         } else if (StringUtils.isBlank(customer.getEmailAddress())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 891             response.addErrorCode(&quot;emailNotFound&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 892         } else if (customer.isDeactivated()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 893             response.addErrorCode(&quot;inactiveUser&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 894         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 895     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 896 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 897     protected void checkPassword(String password, String confirmPassword, GenericResponse response) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 898         if (StringUtils.isBlank(password) || StringUtils.isBlank(confirmPassword)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 899             response.addErrorCode(&quot;invalidPassword&quot;);</span>
 900 =======
 901 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 902 
 903     @Override
 904     public List&lt;Customer&gt; readBatchCustomers(int start, int pageSize) {
 905         return customerDao.readBatchCustomers(start, pageSize);
 906     }
 907 
 908     @Override
 909     public Long readNumberOfCustomers() {
 910         return customerDao.readNumberOfCustomers();
 911     }
 912 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Profile
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.profile.core.service;
  19 
  20 import org.apache.commons.collections4.CollectionUtils;
  21 import org.apache.commons.lang3.StringUtils;
  22 import org.apache.commons.logging.Log;
  23 import org.apache.commons.logging.LogFactory;
  24 import org.broadleafcommerce.common.event.BroadleafApplicationEventPublisher;
  25 import org.broadleafcommerce.common.id.service.IdGenerationService;
  26 import org.broadleafcommerce.common.rule.MvelHelper;
  27 import org.broadleafcommerce.common.security.util.PasswordChange;
  28 import org.broadleafcommerce.common.security.util.PasswordReset;
  29 import org.broadleafcommerce.common.security.util.PasswordUtils;
  30 import org.broadleafcommerce.common.service.GenericResponse;
  31 import org.broadleafcommerce.common.time.SystemTime;
  32 import org.broadleafcommerce.common.util.StringUtil;
  33 import org.broadleafcommerce.common.util.TransactionUtils;
  34 import org.broadleafcommerce.profile.core.dao.CustomerDao;
  35 import org.broadleafcommerce.profile.core.dao.CustomerForgotPasswordSecurityTokenDao;
  36 import org.broadleafcommerce.profile.core.dao.RoleDao;
  37 import org.broadleafcommerce.profile.core.domain.Customer;
  38 import org.broadleafcommerce.profile.core.domain.CustomerForgotPasswordSecurityToken;
  39 import org.broadleafcommerce.profile.core.domain.CustomerForgotPasswordSecurityTokenImpl;
  40 import org.broadleafcommerce.profile.core.domain.CustomerRole;
  41 import org.broadleafcommerce.profile.core.domain.CustomerRoleImpl;
  42 import org.broadleafcommerce.profile.core.domain.Role;
  43 import org.broadleafcommerce.profile.core.dto.CustomerRuleHolder;
  44 import org.broadleafcommerce.profile.core.event.ForgotPasswordEvent;
  45 import org.broadleafcommerce.profile.core.event.ForgotUsernameEvent;
  46 import org.broadleafcommerce.profile.core.event.RegisterCustomerEvent;
  47 import org.broadleafcommerce.profile.core.service.handler.PasswordUpdatedHandler;
  48 import org.broadleafcommerce.profile.core.service.listener.PostRegistrationObserver;
  49 import org.springframework.beans.factory.annotation.Value;
  50 import org.springframework.security.crypto.password.PasswordEncoder;
  51 import org.springframework.stereotype.Service;
  52 import org.springframework.transaction.annotation.Transactional;
  53 import java.util.ArrayList;
  54 import java.util.Date;
  55 import java.util.HashMap;
  56 import java.util.Iterator;
  57 import java.util.List;
  58 import java.util.Map;
  59 
  60 import javax.annotation.Resource;
  61 
  62 @Service(&quot;blCustomerService&quot;)
  63 public class CustomerServiceImpl implements CustomerService {
  64     private static final Log LOG = LogFactory.getLog(CustomerServiceImpl.class);
  65     private static final int PASSWORD_LENGTH = 16;
  66 
  67     @Autowired
  68     @Qualifier(&quot;blApplicationEventPublisher&quot;)
  69     protected BroadleafApplicationEventPublisher eventPublisher;
  70 
  71     @Resource(name = &quot;blCustomerDao&quot;)
  72     protected CustomerDao customerDao;
  73 
  74     @Resource(name = &quot;blIdGenerationService&quot;)
  75     protected IdGenerationService idGenerationService;
  76 
  77     @Resource(name = &quot;blCustomerForgotPasswordSecurityTokenDao&quot;)
  78     protected CustomerForgotPasswordSecurityTokenDao customerForgotPasswordSecurityTokenDao;
  79 
  80     /**
<abbr title="  81      * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using the">  81      * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;rðŸ”µ</abbr>
<abbr title="  82      * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}">  82      * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.eðŸ”µ</abbr>
  83      */
  84     @Resource(name = &quot;blPasswordEncoder&quot;)
  85     protected PasswordEncoder passwordEncoderBean;
  86 
  87     @Resource(name = &quot;blRoleDao&quot;)
  88     protected RoleDao roleDao;
  89 
  90     protected int tokenExpiredMinutes = 30;
  91     protected int passwordTokenLength = 20;
  92 
<abbr title="  93     protected final List&lt;PostRegistrationObserver&gt; postRegisterListeners = new ArrayList&lt;PostRegistrationObserver&gt;();">  93     protected final List&lt;PostRegistrationObserver&gt; postRegisterListeners = new ArrayList&lt;PostRegistrationðŸ”µ</abbr>
<abbr title="  94     protected List&lt;PasswordUpdatedHandler&gt; passwordResetHandlers = new ArrayList&lt;PasswordUpdatedHandler&gt;();">  94     protected List&lt;PasswordUpdatedHandler&gt; passwordResetHandlers = new ArrayList&lt;PasswordUpdatedHandler&gt;(ðŸ”µ</abbr>
<abbr title="  95     protected List&lt;PasswordUpdatedHandler&gt; passwordChangedHandlers = new ArrayList&lt;PasswordUpdatedHandler&gt;();">  95     protected List&lt;PasswordUpdatedHandler&gt; passwordChangedHandlers = new ArrayList&lt;PasswordUpdatedHandlerðŸ”µ</abbr>
  96 
  97     @Override
  98     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
  99     public Customer saveCustomer(Customer customer) {
 100         return saveCustomer(customer, customer.isRegistered());
 101     }
 102 
 103     @Override
 104     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 105     public Customer saveCustomer(Customer customer, boolean register) {
 106         if (register &amp;&amp; !customer.isRegistered()) {
 107             customer.setRegistered(true);
 108         }
 109 
 110         if (customer.getUnencodedPassword() != null) {
 111             customer.setPassword(encodePassword(customer.getUnencodedPassword()));
 112         }
 113 
 114         // let&#x27;s make sure they entered a new challenge answer (we will populate
 115         // the password field with hashed values so check that they have changed
 116         // id
<abbr title=" 117         if (customer.getUnencodedChallengeAnswer() != null &amp;&amp; !customer.getUnencodedChallengeAnswer().equals(customer.getChallengeAnswer())) {"> 117         if (customer.getUnencodedChallengeAnswer() != null &amp;&amp; !customer.getUnencodedChallengeAnswer().equðŸ”µ</abbr>
 118             customer.setChallengeAnswer(encodePassword(customer.getUnencodedChallengeAnswer()));
 119         }
 120         return customerDao.save(customer);
 121     }
 122 
 123     protected String generateSecurePassword() {
 124         return PasswordUtils.generateSecurePassword(PASSWORD_LENGTH);
 125     }
 126 
 127     @Override
 128     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 129     public Customer registerCustomer(Customer customer, String password, String passwordConfirm) {
 130         customer.setRegistered(true);
 131 
 132         // When unencodedPassword is set the save() will encode it
 133         if (customer.getId() == null) {
 134             customer.setId(findNextCustomerId());
 135         }
 136         customer.setUnencodedPassword(password);
 137         Customer retCustomer = saveCustomer(customer);
 138         createRegisteredCustomerRoles(retCustomer);
 139 
 140         eventPublisher.publishEvent(new RegisterCustomerEvent(this, retCustomer.getId()));
 141         notifyPostRegisterListeners(retCustomer);
 142 
 143         return retCustomer;
 144     }
 145 
 146     @Override
 147     public void createRegisteredCustomerRoles(Customer customer) {
 148         Role role = roleDao.readRoleByName(&quot;ROLE_USER&quot;);
 149         CustomerRole customerRole = new CustomerRoleImpl();
 150         customerRole.setRole(role);
 151         customerRole.setCustomer(customer);
 152         roleDao.addRoleToCustomer(customerRole);
 153     }
 154 
 155     @Override
 156     public Customer readCustomerByEmail(String emailAddress) {
 157         return customerDao.readCustomerByEmail(emailAddress);
 158     }
 159 
 160     @Override
 161     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 162     public Customer changePassword(PasswordChange passwordChange) {
 163         Customer customer = readCustomerByUsername(passwordChange.getUsername());
 164         customer.setUnencodedPassword(passwordChange.getNewPassword());
 165         customer.setPasswordChangeRequired(passwordChange.getPasswordChangeRequired());
 166         customer = saveCustomer(customer);
 167 
 168         for (PasswordUpdatedHandler handler : passwordChangedHandlers) {
 169             handler.passwordChanged(passwordChange, customer, passwordChange.getNewPassword());
 170         }
 171 
 172         return customer;
 173     }
 174 
 175     @Override
 176     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 177     public Customer resetPassword(PasswordReset passwordReset) {
 178         Customer customer = readCustomerByUsername(passwordReset.getUsername());
 179         String newPassword = PasswordUtils.generateSecurePassword(passwordReset.getPasswordLength());
 180         customer.setUnencodedPassword(newPassword);
 181         customer.setPasswordChangeRequired(passwordReset.getPasswordChangeRequired());
 182         customer = saveCustomer(customer);
 183 
 184         for (PasswordUpdatedHandler handler : passwordResetHandlers) {
 185             handler.passwordChanged(passwordReset, customer, newPassword);
 186         }
 187 
 188         return customer;
 189     }
 190 
 191     @Override
 192     public void addPostRegisterListener(PostRegistrationObserver postRegisterListeners) {
 193         this.postRegisterListeners.add(postRegisterListeners);
 194     }
 195 
 196     @Override
 197     public void removePostRegisterListener(PostRegistrationObserver postRegisterListeners) {
 198         if (this.postRegisterListeners.contains(postRegisterListeners)) {
 199             this.postRegisterListeners.remove(postRegisterListeners);
 200         }
 201     }
 202 
 203     protected void notifyPostRegisterListeners(Customer customer) {
<abbr title=" 204         for (Iterator&lt;PostRegistrationObserver&gt; iter = postRegisterListeners.iterator(); iter.hasNext(); ) {"> 204         for (Iterator&lt;PostRegistrationObserver&gt; iter = postRegisterListeners.iterator(); iter.hasNext(); ðŸ”µ</abbr>
 205             PostRegistrationObserver listener = iter.next();
 206             listener.processRegistrationEvent(customer);
 207         }
 208     }
 209 
 210     @Override
 211     public Customer createCustomer() {
 212         return createCustomerFromId(null);
 213     }
 214 
 215     @Override
 216     public Customer createCustomerFromId(Long customerId) {
 217         Customer customer = customerId != null ? readCustomerById(customerId) : null;
 218         if (customer == null) {
 219             customer = customerDao.create();
 220             if (customerId != null) {
 221                 customer.setId(customerId);
 222             } else {
 223                 customer.setId(findNextCustomerId());
 224             }
 225         }
 226         return customer;
 227     }
 228 
 229     @Override
 230     public Long findNextCustomerId() {
 231         return idGenerationService.findNextId(Customer.class.getCanonicalName());
 232     }
 233 
 234     @Override
 235     public Customer createNewCustomer() {
 236         return createCustomerFromId(null);
 237     }
 238 
 239     @Override
 240     public void deleteCustomer(Customer customer) {
 241         roleDao.removeCustomerRolesByCustomerId(customer.getId());
 242         customerDao.delete(customer);
 243     }
 244 
 245     @Override
 246     public Customer readCustomerByUsername(String username) {
 247         return customerDao.readCustomerByUsername(username);
 248     }
 249 
 250     @Override
 251     public Customer readCustomerByUsername(String username, Boolean cacheable) {
 252         return customerDao.readCustomerByUsername(username, cacheable);
 253     }
 254 
 255     @Override
 256     public Customer readCustomerById(Long id) {
 257         return customerDao.readCustomerById(id);
 258     }
 259 
 260     @Override
 261     public Customer readCustomerByExternalId(String userExternalId) {
 262             return customerDao.readCustomerByExternalId(userExternalId);
 263     }
 264 
 265     public void setCustomerDao(CustomerDao customerDao) {
 266         this.customerDao = customerDao;
 267     }
 268 
 269     @Override
 270     public String encodePassword(String rawPassword) {
 271         return passwordEncoderBean.encode(rawPassword);
 272     }
 273 
 274     @Override
 275     public boolean isPasswordValid(String rawPassword, String encodedPassword) {
 276         return passwordEncoderBean.matches(rawPassword, encodedPassword);
 277     }
 278 
 279     @Override
 280     public boolean customerPassesCustomerRule(Customer customer, CustomerRuleHolder customerRuleHolder) {
 281         String customerRule = customerRuleHolder.getCustomerRule();
 282         Map&lt;String, Object&gt; ruleParams = buildCustomerRuleParams(customer);
 283         return customerRule == null || MvelHelper.evaluateRule(customerRule, ruleParams);
 284     }
 285 
 286     protected Map&lt;String, Object&gt; buildCustomerRuleParams(Customer customer) {
 287         HashMap&lt;String, Object&gt; vars = new HashMap&lt;&gt;();
 288         vars.put(&quot;customer&quot;, customer);
 289         return vars;
 290     }
 291 
 292     @Override
 293     public List&lt;PasswordUpdatedHandler&gt; getPasswordResetHandlers() {
 294         return passwordResetHandlers;
 295     }
 296 
 297     @Override
 298     public void setPasswordResetHandlers(List&lt;PasswordUpdatedHandler&gt; passwordResetHandlers) {
 299         this.passwordResetHandlers = passwordResetHandlers;
 300     }
 301 
 302     @Override
 303     public List&lt;PasswordUpdatedHandler&gt; getPasswordChangedHandlers() {
 304         return passwordChangedHandlers;
 305     }
 306 
 307     @Override
 308     public void setPasswordChangedHandlers(List&lt;PasswordUpdatedHandler&gt; passwordChangedHandlers) {
 309         this.passwordChangedHandlers = passwordChangedHandlers;
 310     }
 311 
 312     @Override
 313     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 314     public GenericResponse sendForgotUsernameNotification(String emailAddress) {
 315         GenericResponse response = new GenericResponse();
 316         List&lt;Customer&gt; customers = null;
 317         if (emailAddress != null) {
 318             customers = customerDao.readCustomersByEmail(emailAddress);
 319         }
 320 
 321         if (CollectionUtils.isEmpty(customers)) {
 322             response.addErrorCode(&quot;notFound&quot;);
 323         } else {
 324             List&lt;String&gt; activeUsernames = new ArrayList&lt;String&gt;();
 325             for (Customer customer : customers) {
 326                 if (!customer.isDeactivated()) {
 327                     activeUsernames.add(customer.getUsername());
 328                 }
 329             }
 330 
 331             if (activeUsernames.size() &gt; 0) {
<abbr title=" 332                 eventPublisher.publishEvent(new ForgotUsernameEvent(this, emailAddress, activeUsernames));"> 332                 eventPublisher.publishEvent(new ForgotUsernameEvent(this, emailAddress, activeUsernames))ðŸ”µ</abbr>
 333             } else {
 334                 // send inactive username found email.
 335                 response.addErrorCode(&quot;inactiveUser&quot;);
 336             }
 337         }
 338         return response;
 339     }
 340 
 341     @Override
 342     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 343     public GenericResponse sendForgotPasswordNotification(String username, String resetPasswordUrl) {
 344         GenericResponse response = new GenericResponse();
 345         Customer customer = null;
 346 
 347         if (username != null) {
 348             customer = customerDao.readCustomerByUsername(username);
 349         }
 350 
 351         checkCustomer(customer, response);
 352 
 353         if (!response.getHasErrors()) {
 354             String token = PasswordUtils.generateSecurePassword(getPasswordTokenLength());
 355             token = token.toLowerCase();
 356 
 357             CustomerForgotPasswordSecurityToken fpst = new CustomerForgotPasswordSecurityTokenImpl();
 358             fpst.setCustomerId(customer.getId());
 359             fpst.setToken(encodePassword(token));
 360             fpst.setCreateDate(SystemTime.asDate());
 361             customerForgotPasswordSecurityTokenDao.saveToken(fpst);
 362 
 363 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 364             HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 365             vars.put(&quot;token&quot;, token);</span>
 366 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368             CustomerForgotPasswordSecurityToken fpst = new CustomerForgotPasswordSecurityTokenImpl();</span>
 369 =======
 370 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 371             if (!StringUtils.isEmpty(resetPasswordUrl)) {
 372                 if (resetPasswordUrl.contains(&quot;?&quot;)) {
 373                     resetPasswordUrl = resetPasswordUrl + &quot;&amp;token=&quot; + token;
 374                 } else {
 375                     resetPasswordUrl = resetPasswordUrl + &quot;?token=&quot; + token;
 376                 }
 377             }
 378 
<abbr title=" 379             eventPublisher.publishEvent(new ForgotPasswordEvent(this, customer.getId(), token, resetPasswordUrl));"> 379             eventPublisher.publishEvent(new ForgotPasswordEvent(this, customer.getId(), token, resetPasswðŸ”µ</abbr>
 380         }
 381         return response;
 382     }
 383 
 384     @Override
 385     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
<abbr title=" 386     public GenericResponse sendForcedPasswordChangeNotification(String username, String resetPasswordUrl) {"> 386     public GenericResponse sendForcedPasswordChangeNotification(String username, String resetPasswordUrl)ðŸ”µ</abbr>
 387         return sendForgotPasswordNotification(username, resetPasswordUrl);
 388     }
 389 
 390     @Override
 391     public GenericResponse checkPasswordResetToken(String token, Customer customer) {
 392         GenericResponse response = new GenericResponse();
 393         checkPasswordResetToken(token, customer, response);
 394         return response;
 395     }
 396 
<abbr title=" 397     protected CustomerForgotPasswordSecurityToken checkPasswordResetToken(String token, Customer customer, GenericResponse response) {"> 397     protected CustomerForgotPasswordSecurityToken checkPasswordResetToken(String token, Customer customerðŸ”µ</abbr>
 398         if (StringUtils.isBlank(token)) {
 399             response.addErrorCode(&quot;invalidToken&quot;);
 400         }
 401 
 402         String rawToken = token;
 403 
 404         CustomerForgotPasswordSecurityToken fpst = null;
 405         if (!response.getHasErrors()) {
 406             if (customer == null) {
 407                 fpst = customerForgotPasswordSecurityTokenDao.readToken(encodePassword(token));
 408             } else {
<abbr title=" 409                 List&lt;CustomerForgotPasswordSecurityToken&gt; fpstoks = customerForgotPasswordSecurityTokenDao.readUnusedTokensByCustomerId(customer.getId());"> 409                 List&lt;CustomerForgotPasswordSecurityToken&gt; fpstoks = customerForgotPasswordSecurityTokenDaðŸ”µ</abbr>
 410                 for (CustomerForgotPasswordSecurityToken fpstok : fpstoks) {
 411                     if (isPasswordValid(rawToken, fpstok.getToken())) {
 412                         fpst = fpstok;
 413                         break;
 414                     }
 415                 }
 416             }
 417             if (fpst == null) {
 418                 response.addErrorCode(&quot;invalidToken&quot;);
 419             } else if (fpst.isTokenUsedFlag()) {
 420                 response.addErrorCode(&quot;tokenUsed&quot;);
 421             } else if (isTokenExpired(fpst)) {
 422                 response.addErrorCode(&quot;tokenExpired&quot;);
 423             }
 424         }
 425         return fpst;
 426     }
 427 
 428     @Override
 429     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
<abbr title=" 430     public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPassword) {"> 430     public GenericResponse resetPasswordUsingToken(String username, String token, String password, StringðŸ”µ</abbr>
 431         GenericResponse response = new GenericResponse();
 432         Customer customer = null;
 433         if (username != null) {
 434             customer = customerDao.readCustomerByUsername(username);
 435         }
 436         checkCustomer(customer, response);
 437         checkPassword(password, confirmPassword, response);
 438         CustomerForgotPasswordSecurityToken fpst = checkPasswordResetToken(token, customer, response);
 439 
 440         if (!response.getHasErrors()) {
 441             if (!customer.getId().equals(fpst.getCustomerId())) {
 442                 if (LOG.isWarnEnabled()) {
<abbr title=" 443                     LOG.warn(&quot;Password reset attempt tried with mismatched customer and token &quot; + customer.getId() + &quot;, &quot; + StringUtil.sanitize(token));"> 443                     LOG.warn(&quot;Password reset attempt tried with mismatched customer and token &quot; + customeðŸ”µ</abbr>
 444                 }
 445                 response.addErrorCode(&quot;invalidToken&quot;);
 446             }
 447         }
 448 
 449         if (!response.getHasErrors()) {
 450             customer.setUnencodedPassword(password);
 451             customer.setPasswordChangeRequired(false);
 452             saveCustomer(customer);
 453             invalidateAllTokensForCustomer(customer);
 454         }
 455 
 456         return response;
 457     }
 458 
 459     protected void invalidateAllTokensForCustomer(Customer customer) {
<abbr title=" 460         List&lt;CustomerForgotPasswordSecurityToken&gt; tokens = customerForgotPasswordSecurityTokenDao.readUnusedTokensByCustomerId(customer.getId());"> 460         List&lt;CustomerForgotPasswordSecurityToken&gt; tokens = customerForgotPasswordSecurityTokenDao.readUnuðŸ”µ</abbr>
 461         for (CustomerForgotPasswordSecurityToken token : tokens) {
 462             token.setTokenUsedFlag(true);
 463             customerForgotPasswordSecurityTokenDao.saveToken(token);
 464         }
 465     }
 466 
 467     protected void checkCustomer(Customer customer, GenericResponse response) {
 468         if (customer == null) {
 469             response.addErrorCode(&quot;invalidCustomer&quot;);
 470         } else if (StringUtils.isBlank(customer.getEmailAddress())) {
 471             response.addErrorCode(&quot;emailNotFound&quot;);
 472         } else if (customer.isDeactivated()) {
 473             response.addErrorCode(&quot;inactiveUser&quot;);
 474         }
 475     }
 476 
 477     protected void checkPassword(String password, String confirmPassword, GenericResponse response) {
 478         if (StringUtils.isBlank(password) || StringUtils.isBlank(confirmPassword)) {
 479             response.addErrorCode(&quot;invalidPassword&quot;);
 480         } else if (!password.equals(confirmPassword)) {
 481             response.addErrorCode(&quot;passwordMismatch&quot;);
 482         }
 483     }
 484 
 485     protected boolean isTokenExpired(CustomerForgotPasswordSecurityToken fpst) {
 486         Date now = SystemTime.asDate();
 487         long currentTimeInMillis = now.getTime();
 488         long tokenSaveTimeInMillis = fpst.getCreateDate().getTime();
 489         long minutesSinceSave = (currentTimeInMillis - tokenSaveTimeInMillis) / 60000;
 490         return minutesSinceSave &gt; tokenExpiredMinutes;
 491     }
 492 
 493     public int getTokenExpiredMinutes() {
 494         return tokenExpiredMinutes;
 495     }
 496 
 497     public void setTokenExpiredMinutes(int tokenExpiredMinutes) {
 498         this.tokenExpiredMinutes = tokenExpiredMinutes;
 499     }
 500 
 501     public int getPasswordTokenLength() {
 502         return passwordTokenLength;
 503     }
 504 
 505     public void setPasswordTokenLength(int passwordTokenLength) {
 506         this.passwordTokenLength = passwordTokenLength;
 507     }
 508 
 509     @Override
 510     public List&lt;Customer&gt; readBatchCustomers(int start, int pageSize) {
 511         return customerDao.readBatchCustomers(start, pageSize);
 512     }
 513 
 514     @Override
 515     public Long readNumberOfCustomers() {
 516         return customerDao.readNumberOfCustomers();
 517     }
 518 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Profile
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.profile.core.service;
  19 
  20 import java.util.ArrayList;
  21 import java.util.Date;
  22 import java.util.HashMap;
  23 import java.util.Iterator;
  24 import java.util.List;
  25 import java.util.Map;
  26 import javax.annotation.Resource;
  27 import org.apache.commons.collections4.CollectionUtils;
  28 import org.apache.commons.lang3.StringUtils;
  29 import org.apache.commons.logging.Log;
  30 import org.apache.commons.logging.LogFactory;
  31 import org.broadleafcommerce.common.event.BroadleafApplicationEventPublisher;
  32 import org.broadleafcommerce.common.id.service.IdGenerationService;
  33 import org.broadleafcommerce.common.rule.MvelHelper;
  34 import org.broadleafcommerce.common.security.util.PasswordChange;
  35 import org.broadleafcommerce.common.security.util.PasswordReset;
  36 import org.broadleafcommerce.common.security.util.PasswordUtils;
  37 import org.broadleafcommerce.common.service.GenericResponse;
  38 import org.broadleafcommerce.common.time.SystemTime;
  39 import org.broadleafcommerce.common.util.StringUtil;
  40 import org.broadleafcommerce.common.util.TransactionUtils;
  41 import org.broadleafcommerce.profile.core.dao.CustomerDao;
  42 import org.broadleafcommerce.profile.core.dao.CustomerForgotPasswordSecurityTokenDao;
  43 import org.broadleafcommerce.profile.core.dao.RoleDao;
  44 import org.broadleafcommerce.profile.core.domain.Customer;
  45 import org.broadleafcommerce.profile.core.domain.CustomerForgotPasswordSecurityToken;
  46 import org.broadleafcommerce.profile.core.domain.CustomerForgotPasswordSecurityTokenImpl;
  47 import org.broadleafcommerce.profile.core.domain.CustomerRole;
  48 import org.broadleafcommerce.profile.core.domain.CustomerRoleImpl;
  49 import org.broadleafcommerce.profile.core.domain.Role;
  50 import org.broadleafcommerce.profile.core.dto.CustomerRuleHolder;
  51 import org.broadleafcommerce.profile.core.event.ForgotPasswordEvent;
  52 import org.broadleafcommerce.profile.core.event.ForgotUsernameEvent;
  53 import org.broadleafcommerce.profile.core.event.RegisterCustomerEvent;
  54 import org.broadleafcommerce.profile.core.service.handler.PasswordUpdatedHandler;
  55 import org.broadleafcommerce.profile.core.service.listener.PostRegistrationObserver;
  56 import org.springframework.beans.factory.annotation.Value;
  57 import org.springframework.security.crypto.password.PasswordEncoder;
  58 import org.springframework.stereotype.Service;
  59 import org.springframework.transaction.annotation.Transactional;
  60 
  61 
  62 @Service(&quot;blCustomerService&quot;)
  63 public class CustomerServiceImpl implements CustomerService {
  64     private static final Log LOG = LogFactory.getLog(CustomerServiceImpl.class);
  65     private static final int PASSWORD_LENGTH = 16;
  66 
  67     @Autowired
  68     @Qualifier(&quot;blApplicationEventPublisher&quot;)
  69     protected BroadleafApplicationEventPublisher eventPublisher;
  70 
  71     @Resource(name=&quot;blCustomerDao&quot;)
  72     protected CustomerDao customerDao;
  73 
  74     @Resource(name = &quot;blIdGenerationService&quot;)
  75     protected IdGenerationService idGenerationService;
  76 
  77     @Resource(name = &quot;blCustomerForgotPasswordSecurityTokenDao&quot;)
  78     protected CustomerForgotPasswordSecurityTokenDao customerForgotPasswordSecurityTokenDao;
  79 
  80     /**
<abbr title="  81      * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using the">  81      * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;rðŸ”µ</abbr>
<abbr title="  82      * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}">  82      * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.eðŸ”µ</abbr>
  83      */
  84     @Resource(name = &quot;blPasswordEncoder&quot;)
  85     protected PasswordEncoder passwordEncoderBean;
  86 
  87     @Resource(name = &quot;blRoleDao&quot;)
  88     protected RoleDao roleDao;
  89 
  90     protected int tokenExpiredMinutes = 30;
  91     protected int passwordTokenLength = 20;
  92 
<abbr title="  93     protected final List&lt;PostRegistrationObserver&gt; postRegisterListeners = new ArrayList&lt;PostRegistrationObserver&gt;();">  93     protected final List&lt;PostRegistrationObserver&gt; postRegisterListeners = new ArrayList&lt;PostRegistrationðŸ”µ</abbr>
<abbr title="  94     protected List&lt;PasswordUpdatedHandler&gt; passwordResetHandlers = new ArrayList&lt;PasswordUpdatedHandler&gt;();">  94     protected List&lt;PasswordUpdatedHandler&gt; passwordResetHandlers = new ArrayList&lt;PasswordUpdatedHandler&gt;(ðŸ”µ</abbr>
<abbr title="  95     protected List&lt;PasswordUpdatedHandler&gt; passwordChangedHandlers = new ArrayList&lt;PasswordUpdatedHandler&gt;();">  95     protected List&lt;PasswordUpdatedHandler&gt; passwordChangedHandlers = new ArrayList&lt;PasswordUpdatedHandlerðŸ”µ</abbr>
  96 
  97     @Override
  98     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
  99     public Customer saveCustomer(Customer customer) {
 100         return saveCustomer(customer, customer.isRegistered());
 101     }
 102 
 103     @Override
 104     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 105     public Customer saveCustomer(Customer customer, boolean register) {
 106         if (register &amp;&amp; !customer.isRegistered()) {
 107             customer.setRegistered(true);
 108         }
 109 
 110         if (customer.getUnencodedPassword() != null) {
 111             customer.setPassword(encodePassword(customer.getUnencodedPassword()));
 112         }
 113 
 114         // let&#x27;s make sure they entered a new challenge answer (we will populate
 115         // the password field with hashed values so check that they have changed
 116         // id
<abbr title=" 117         if (customer.getUnencodedChallengeAnswer() != null &amp;&amp; !customer.getUnencodedChallengeAnswer().equals(customer.getChallengeAnswer())) {"> 117         if (customer.getUnencodedChallengeAnswer() != null &amp;&amp; !customer.getUnencodedChallengeAnswer().equðŸ”µ</abbr>
 118             customer.setChallengeAnswer(encodePassword(customer.getUnencodedChallengeAnswer()));
 119         }
 120         return customerDao.save(customer);
 121     }
 122 
 123     protected String generateSecurePassword() {
 124         return PasswordUtils.generateSecurePassword(PASSWORD_LENGTH);
 125     }
 126 
 127     @Override
 128     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 129     public Customer registerCustomer(Customer customer, String password, String passwordConfirm) {
 130         customer.setRegistered(true);
 131 
 132         // When unencodedPassword is set the save() will encode it
 133         if (customer.getId() == null) {
 134             customer.setId(findNextCustomerId());
 135         }
 136         customer.setUnencodedPassword(password);
 137         Customer retCustomer = saveCustomer(customer);
 138         createRegisteredCustomerRoles(retCustomer);
 139 
 140         eventPublisher.publishEvent(new RegisterCustomerEvent(this, retCustomer.getId()));
 141         notifyPostRegisterListeners(retCustomer);
 142 
 143         return retCustomer;
 144     }
 145 
 146     @Override
 147     public void createRegisteredCustomerRoles(Customer customer) {
 148         Role role = roleDao.readRoleByName(&quot;ROLE_USER&quot;);
 149         CustomerRole customerRole = new CustomerRoleImpl();
 150         customerRole.setRole(role);
 151         customerRole.setCustomer(customer);
 152         roleDao.addRoleToCustomer(customerRole);
 153     }
 154 
 155     @Override
 156     public Customer readCustomerByEmail(String emailAddress) {
 157         return customerDao.readCustomerByEmail(emailAddress);
 158     }
 159 
 160     @Override
 161     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 162     public Customer changePassword(PasswordChange passwordChange) {
 163         Customer customer = readCustomerByUsername(passwordChange.getUsername());
 164         customer.setUnencodedPassword(passwordChange.getNewPassword());
 165         customer.setPasswordChangeRequired(passwordChange.getPasswordChangeRequired());
 166         customer = saveCustomer(customer);
 167 
 168         for (PasswordUpdatedHandler handler : passwordChangedHandlers) {
 169             handler.passwordChanged(passwordChange, customer, passwordChange.getNewPassword());
 170         }
 171 
 172         return customer;
 173     }
 174 
 175     @Override
 176     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 177     public Customer resetPassword(PasswordReset passwordReset) {
 178         Customer customer = readCustomerByUsername(passwordReset.getUsername());
 179         String newPassword = PasswordUtils.generateSecurePassword(passwordReset.getPasswordLength());
 180         customer.setUnencodedPassword(newPassword);
 181         customer.setPasswordChangeRequired(passwordReset.getPasswordChangeRequired());
 182         customer = saveCustomer(customer);
 183 
 184         for (PasswordUpdatedHandler handler : passwordResetHandlers) {
 185             handler.passwordChanged(passwordReset, customer, newPassword);
 186         }
 187 
 188         return customer;
 189     }
 190 
 191     @Override
 192     public void addPostRegisterListener(PostRegistrationObserver postRegisterListeners) {
 193         this.postRegisterListeners.add(postRegisterListeners);
 194     }
 195 
 196     @Override
 197     public void removePostRegisterListener(PostRegistrationObserver postRegisterListeners) {
 198         if (this.postRegisterListeners.contains(postRegisterListeners)) {
 199             this.postRegisterListeners.remove(postRegisterListeners);
 200         }
 201     }
 202 
 203     protected void notifyPostRegisterListeners(Customer customer) {
<abbr title=" 204         for (Iterator&lt;PostRegistrationObserver&gt; iter = postRegisterListeners.iterator(); iter.hasNext(); ) {"> 204         for (Iterator&lt;PostRegistrationObserver&gt; iter = postRegisterListeners.iterator(); iter.hasNext(); ðŸ”µ</abbr>
 205             PostRegistrationObserver listener = iter.next();
 206             listener.processRegistrationEvent(customer);
 207         }
 208     }
 209 
 210     @Override
 211     public Customer createCustomer() {
 212         return createCustomerFromId(null);
 213     }
 214 
 215     @Override
 216     public Customer createCustomerFromId(Long customerId) {
 217         Customer customer = customerId != null ? readCustomerById(customerId) : null;
 218         if (customer == null) {
 219             customer = customerDao.create();
 220             if (customerId != null) {
 221                 customer.setId(customerId);
 222             } else {
 223                 customer.setId(findNextCustomerId());
 224             }
 225         }
 226         return customer;
 227     }
 228 
 229     @Override
 230     public Long findNextCustomerId() {
 231         return idGenerationService.findNextId(Customer.class.getCanonicalName());
 232     }
 233 
 234     @Override
 235     public Customer createNewCustomer() {
 236         return createCustomerFromId(null);
 237     }
 238 
 239     @Override
 240     public void deleteCustomer(Customer customer) {
 241         roleDao.removeCustomerRolesByCustomerId(customer.getId());
 242         customerDao.delete(customer);
 243     }
 244 
 245     @Override
 246     public Customer readCustomerByUsername(String username) {
 247         return customerDao.readCustomerByUsername(username);
 248     }
 249 
 250     @Override
 251     public Customer readCustomerByUsername(String username, Boolean cacheable) {
 252         return customerDao.readCustomerByUsername(username, cacheable);
 253     }
 254 
 255     @Override
 256     public Customer readCustomerById(Long id) {
 257         return customerDao.readCustomerById(id);
 258     }
 259 
 260     @Override
 261     public Customer readCustomerByExternalId(String userExternalId) {
 262         return customerDao.readCustomerByExternalId(userExternalId);
 263     }
 264 
 265     public void setCustomerDao(CustomerDao customerDao) {
 266         this.customerDao = customerDao;
 267     }
 268 
 269     @Override
 270     public String encodePassword(String rawPassword) {
 271         return passwordEncoderBean.encode(rawPassword);
 272     }
 273 
 274     @Override
 275     public boolean isPasswordValid(String rawPassword, String encodedPassword) {
 276         return passwordEncoderBean.matches(rawPassword, encodedPassword);
 277     }
 278 
 279     @Override
 280     public boolean customerPassesCustomerRule(Customer customer, CustomerRuleHolder customerRuleHolder) {
 281         String customerRule = customerRuleHolder.getCustomerRule();
 282         Map&lt;String, Object&gt; ruleParams = buildCustomerRuleParams(customer);
 283         return customerRule == null || MvelHelper.evaluateRule(customerRule, ruleParams);
 284     }
 285 
 286     protected Map&lt;String, Object&gt; buildCustomerRuleParams(Customer customer) {
 287         HashMap&lt;String, Object&gt; vars = new HashMap&lt;&gt;();
 288         vars.put(&quot;customer&quot;, customer);
 289         return vars;
 290     }
 291 
 292     @Override
 293     public List&lt;PasswordUpdatedHandler&gt; getPasswordResetHandlers() {
 294         return passwordResetHandlers;
 295     }
 296 
 297     @Override
 298     public void setPasswordResetHandlers(List&lt;PasswordUpdatedHandler&gt; passwordResetHandlers) {
 299         this.passwordResetHandlers = passwordResetHandlers;
 300     }
 301 
 302     @Override
 303     public List&lt;PasswordUpdatedHandler&gt; getPasswordChangedHandlers() {
 304         return passwordChangedHandlers;
 305     }
 306 
 307     @Override
 308     public void setPasswordChangedHandlers(List&lt;PasswordUpdatedHandler&gt; passwordChangedHandlers) {
 309         this.passwordChangedHandlers = passwordChangedHandlers;
 310     }
 311 
 312     @Override
 313     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 314     public GenericResponse sendForgotUsernameNotification(String emailAddress) {
 315         GenericResponse response = new GenericResponse();
 316         List&lt;Customer&gt; customers = null;
 317         if (emailAddress != null) {
 318             customers = customerDao.readCustomersByEmail(emailAddress);
 319         }
 320 
 321         if (CollectionUtils.isEmpty(customers)) {
 322             response.addErrorCode(&quot;notFound&quot;);
 323         } else {
 324             List&lt;String&gt; activeUsernames = new ArrayList&lt;String&gt;();
 325             for (Customer customer : customers) {
 326                 if (!customer.isDeactivated()) {
 327                     activeUsernames.add(customer.getUsername());
 328                 }
 329             }
 330 
 331             if (activeUsernames.size() &gt; 0) {
<abbr title=" 332                 eventPublisher.publishEvent(new ForgotUsernameEvent(this, emailAddress, activeUsernames));"> 332                 eventPublisher.publishEvent(new ForgotUsernameEvent(this, emailAddress, activeUsernames))ðŸ”µ</abbr>
 333             } else {
 334                 // send inactive username found email.
 335                 response.addErrorCode(&quot;inactiveUser&quot;);
 336             }
 337         }
 338         return response;
 339     }
 340 
 341     @Override
 342     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 343     public GenericResponse sendForgotPasswordNotification(String username, String resetPasswordUrl) {
 344         GenericResponse response = new GenericResponse();
 345         Customer customer = null;
 346 
 347         if (username != null) {
 348             customer = customerDao.readCustomerByUsername(username);
 349         }
 350 
 351         checkCustomer(customer, response);
 352 
 353         if (!response.getHasErrors()) {
 354             String token = PasswordUtils.generateSecurePassword(getPasswordTokenLength());
 355             token = token.toLowerCase();
 356 
 357             CustomerForgotPasswordSecurityToken fpst = new CustomerForgotPasswordSecurityTokenImpl();
 358             fpst.setCustomerId(customer.getId());
 359             fpst.setToken(encodePassword(token));
 360             fpst.setCreateDate(SystemTime.asDate());
 361             customerForgotPasswordSecurityTokenDao.saveToken(fpst);
 362 
 363 
 364 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 365             HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 366             vars.put(&quot;token&quot;, token);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 367 </span>
 368 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 369 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 369 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 370 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372 </span>
 373 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 374             if (!StringUtils.isEmpty(resetPasswordUrl)) {
 375                 if (resetPasswordUrl.contains(&quot;?&quot;)) {
 376                     resetPasswordUrl = resetPasswordUrl+&quot;&amp;token=&quot;+token;
 377                 } else {
 378                     resetPasswordUrl = resetPasswordUrl+&quot;?token=&quot;+token;
 379                 }
 380             }
 381 
<abbr title=" 382             eventPublisher.publishEvent(new ForgotPasswordEvent(this, customer.getId(), token, resetPasswordUrl));"> 382             eventPublisher.publishEvent(new ForgotPasswordEvent(this, customer.getId(), token, resetPasswðŸ”µ</abbr>
 383         }
 384         return response;
 385     }
 386 
 387     @Override
 388     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
<abbr title=" 389     public GenericResponse sendForcedPasswordChangeNotification(String username, String resetPasswordUrl) {"> 389     public GenericResponse sendForcedPasswordChangeNotification(String username, String resetPasswordUrl)ðŸ”µ</abbr>
 390         return sendForgotPasswordNotification(username, resetPasswordUrl);
 391     }
 392 
 393     @Override
 394     public GenericResponse checkPasswordResetToken(String token, Customer customer) {
 395         GenericResponse response = new GenericResponse();
 396         checkPasswordResetToken(token, customer, response);
 397         return response;
 398     }
 399 
<abbr title=" 400     protected CustomerForgotPasswordSecurityToken checkPasswordResetToken(String token, Customer customer, GenericResponse response) {"> 400     protected CustomerForgotPasswordSecurityToken checkPasswordResetToken(String token, Customer customerðŸ”µ</abbr>
 401         if (StringUtils.isBlank(token)) {
 402             response.addErrorCode(&quot;invalidToken&quot;);
 403         }
 404 
 405         String rawToken = token;
 406 
 407         CustomerForgotPasswordSecurityToken fpst = null;
 408         if (!response.getHasErrors()) {
 409             if (customer == null) {
 410                 fpst = customerForgotPasswordSecurityTokenDao.readToken(encodePassword(token));
 411             } else {
<abbr title=" 412                 List&lt;CustomerForgotPasswordSecurityToken&gt; fpstoks = customerForgotPasswordSecurityTokenDao.readUnusedTokensByCustomerId(customer.getId());"> 412                 List&lt;CustomerForgotPasswordSecurityToken&gt; fpstoks = customerForgotPasswordSecurityTokenDaðŸ”µ</abbr>
 413                 for (CustomerForgotPasswordSecurityToken fpstok : fpstoks) {
 414                     if (isPasswordValid(rawToken, fpstok.getToken())) {
 415                         fpst = fpstok;
 416                         break;
 417                     }
 418                 }
 419             }
 420             if (fpst == null) {
 421                 response.addErrorCode(&quot;invalidToken&quot;);
 422             } else if (fpst.isTokenUsedFlag()) {
 423                 response.addErrorCode(&quot;tokenUsed&quot;);
 424             } else if (isTokenExpired(fpst)) {
 425                 response.addErrorCode(&quot;tokenExpired&quot;);
 426             }
 427         }
 428         return fpst;
 429     }
 430 
 431     @Override
 432     @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
<abbr title=" 433     public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPassword) {"> 433     public GenericResponse resetPasswordUsingToken(String username, String token, String password, StringðŸ”µ</abbr>
 434         GenericResponse response = new GenericResponse();
 435         Customer customer = null;
 436         if (username != null) {
 437             customer = customerDao.readCustomerByUsername(username);
 438         }
 439         checkCustomer(customer, response);
 440         checkPassword(password, confirmPassword, response);
 441         CustomerForgotPasswordSecurityToken fpst = checkPasswordResetToken(token, customer, response);
 442 
 443         if (!response.getHasErrors()) {
 444             if (!customer.getId().equals(fpst.getCustomerId())) {
 445                 if (LOG.isWarnEnabled()) {
<abbr title=" 446                     LOG.warn(&quot;Password reset attempt tried with mismatched customer and token &quot; + customer.getId() + &quot;, &quot; + StringUtil.sanitize(token));"> 446                     LOG.warn(&quot;Password reset attempt tried with mismatched customer and token &quot; + customeðŸ”µ</abbr>
 447                 }
 448                 response.addErrorCode(&quot;invalidToken&quot;);
 449             }
 450         }
 451 
 452         if (!response.getHasErrors()) {
 453             customer.setUnencodedPassword(password);
 454             customer.setPasswordChangeRequired(false);
 455             saveCustomer(customer);
 456             invalidateAllTokensForCustomer(customer);
 457         }
 458 
 459         return response;
 460     }
 461 
 462     protected void invalidateAllTokensForCustomer(Customer customer) {
<abbr title=" 463         List&lt;CustomerForgotPasswordSecurityToken&gt; tokens = customerForgotPasswordSecurityTokenDao.readUnusedTokensByCustomerId(customer.getId());"> 463         List&lt;CustomerForgotPasswordSecurityToken&gt; tokens = customerForgotPasswordSecurityTokenDao.readUnuðŸ”µ</abbr>
 464         for (CustomerForgotPasswordSecurityToken token : tokens) {
 465             token.setTokenUsedFlag(true);
 466             customerForgotPasswordSecurityTokenDao.saveToken(token);
 467         }
 468     }
 469 
 470     protected void checkCustomer(Customer customer, GenericResponse response) {
 471         if (customer == null) {
 472             response.addErrorCode(&quot;invalidCustomer&quot;);
 473         } else if (StringUtils.isBlank(customer.getEmailAddress())) {
 474             response.addErrorCode(&quot;emailNotFound&quot;);
 475         } else if (customer.isDeactivated()) {
 476             response.addErrorCode(&quot;inactiveUser&quot;);
 477         }
 478     }
 479 
 480     protected void checkPassword(String password, String confirmPassword, GenericResponse response) {
 481         if (StringUtils.isBlank(password) || StringUtils.isBlank(confirmPassword)) {
 482             response.addErrorCode(&quot;invalidPassword&quot;);
 483         } else if (!password.equals(confirmPassword)) {
 484             response.addErrorCode(&quot;passwordMismatch&quot;);
 485         }
 486     }
 487 
 488     protected boolean isTokenExpired(CustomerForgotPasswordSecurityToken fpst) {
 489         Date now = SystemTime.asDate();
 490         long currentTimeInMillis = now.getTime();
 491         long tokenSaveTimeInMillis = fpst.getCreateDate().getTime();
 492         long minutesSinceSave = (currentTimeInMillis - tokenSaveTimeInMillis) / 60000;
 493         return minutesSinceSave &gt; tokenExpiredMinutes;
 494     }
 495 
 496     public int getTokenExpiredMinutes() {
 497         return tokenExpiredMinutes;
 498     }
 499 
 500     public void setTokenExpiredMinutes(int tokenExpiredMinutes) {
 501         this.tokenExpiredMinutes = tokenExpiredMinutes;
 502     }
 503 
 504     public int getPasswordTokenLength() {
 505         return passwordTokenLength;
 506     }
 507 
 508     public void setPasswordTokenLength(int passwordTokenLength) {
 509         this.passwordTokenLength = passwordTokenLength;
 510     }
 511 
 512 
 513 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 514 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 515     public EmailInfo getForgotPasswordEmailInfo() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 516         return forgotPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 517     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 518 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 519     public void setForgotPasswordEmailInfo(EmailInfo forgotPasswordEmailInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 520         this.forgotPasswordEmailInfo = forgotPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 521     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 522 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 523     public EmailInfo getForgotUsernameEmailInfo() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 524         return forgotUsernameEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 525     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 526 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 527     public void setForgotUsernameEmailInfo(EmailInfo forgotUsernameEmailInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 528         this.forgotUsernameEmailInfo = forgotUsernameEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 529     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 530 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 531     public EmailInfo getRegistrationEmailInfo() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 532         return registrationEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 533     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 534 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 535     public void setRegistrationEmailInfo(EmailInfo registrationEmailInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 536         this.registrationEmailInfo = registrationEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 537     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 538 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 539     public EmailInfo getChangePasswordEmailInfo() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 540         return changePasswordEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 541     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 542 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 543     public void setChangePasswordEmailInfo(EmailInfo changePasswordEmailInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 544         this.changePasswordEmailInfo = changePasswordEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 545     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 546 </span>
 547 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 548 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 548 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 549 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551 </span>
 552 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 553 
 554     @Override
 555     public List&lt;Customer&gt; readBatchCustomers(int start, int pageSize) {
 556         return customerDao.readBatchCustomers(start, pageSize);
 557     }
 558 
 559     @Override
 560     public Long readNumberOfCustomers() {
 561         return customerDao.readNumberOfCustomers();
 562     }
 563 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Profile
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.profile.core.service;
  19  
  20  import org.apache.commons.codec.binary.Hex;
  21  import org.apache.commons.collections4.CollectionUtils;
  22  import org.apache.commons.lang3.StringUtils;
  23  import org.apache.commons.logging.Log;
  24  import org.apache.commons.logging.LogFactory;

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import org.broadleafcommerce.common.id.service.IdGenerationService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.broadleafcommerce.profile.core.dto.CustomerRuleHolder;</span>
  27  import org.broadleafcommerce.common.email.service.EmailService;
  28  import org.broadleafcommerce.common.email.service.info.EmailInfo;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import org.broadleafcommerce.common.id.service.IdGenerationService;</span>
  30  import org.broadleafcommerce.common.rule.MvelHelper;
  31  import org.broadleafcommerce.common.security.util.PasswordChange;
  32  import org.broadleafcommerce.common.security.util.PasswordReset;
  33  import org.broadleafcommerce.common.security.util.PasswordUtils;
  34  import org.broadleafcommerce.common.service.GenericResponse;
  35  import org.broadleafcommerce.common.time.SystemTime;
  36  import org.broadleafcommerce.common.util.StringUtil;
  37  import org.broadleafcommerce.common.util.TransactionUtils;
  38  import org.broadleafcommerce.profile.core.dao.CustomerDao;
  39  import org.broadleafcommerce.profile.core.dao.CustomerForgotPasswordSecurityTokenDao;
  40  import org.broadleafcommerce.profile.core.dao.RoleDao;
  41  import org.broadleafcommerce.profile.core.domain.Customer;
  42  import org.broadleafcommerce.profile.core.domain.CustomerForgotPasswordSecurityToken;
  43  import org.broadleafcommerce.profile.core.domain.CustomerForgotPasswordSecurityTokenImpl;
  44  import org.broadleafcommerce.profile.core.domain.CustomerRole;
  45  import org.broadleafcommerce.profile.core.domain.CustomerRoleImpl;
  46  import org.broadleafcommerce.profile.core.domain.Role;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import org.broadleafcommerce.profile.core.dto.CustomerRuleHolder;</span>



  48  import org.broadleafcommerce.profile.core.service.handler.PasswordUpdatedHandler;
  49  import org.broadleafcommerce.profile.core.service.listener.PostRegistrationObserver;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import org.springframework.beans.factory.NoSuchBeanDefinitionException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -import org.springframework.beans.factory.annotation.Autowired;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import org.springframework.beans.factory.annotation.Qualifier;</span>
  53  import org.springframework.beans.factory.annotation.Value;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -import org.springframework.security.authentication.dao.SaltSource;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -import org.springframework.security.core.GrantedAuthority;</span>
  56  import org.springframework.security.crypto.password.PasswordEncoder;
  57  import org.springframework.stereotype.Service;
  58  import org.springframework.transaction.annotation.Transactional;
  59  
  60  import java.util.ArrayList;
  61  import java.util.Date;
  62  import java.util.HashMap;
  63  import java.util.Iterator;
  64  import java.util.List;
  65  import java.util.Map;
  66  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -import javax.annotation.PostConstruct;</span>
  68  import javax.annotation.Resource;
  69  
  70  @Service(&quot;blCustomerService&quot;)
  71  public class CustomerServiceImpl implements CustomerService {
  72      private static final Log LOG = LogFactory.getLog(CustomerServiceImpl.class);
  73      private static final int PASSWORD_LENGTH = 16;
  74  
  75      @Resource(name = &quot;blCustomerDao&quot;)





  76      protected CustomerDao customerDao;
  77  
  78      @Resource(name = &quot;blIdGenerationService&quot;)
  79      protected IdGenerationService idGenerationService;
  80  
  81      @Resource(name = &quot;blCustomerForgotPasswordSecurityTokenDao&quot;)
  82      protected CustomerForgotPasswordSecurityTokenDao customerForgotPasswordSecurityTokenDao;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -     * &lt;p&gt;Set by {@link #setupPasswordEncoder()} if the blPasswordEncoder bean provided is the deprecated version.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -     * @deprecated Spring Security has deprecated this encoder interface, this will be removed in 4.2</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -    protected org.springframework.security.authentication.encoding.PasswordEncoder passwordEncoder;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -     * &lt;p&gt;Set by {@link #setupPasswordEncoder()} if the blPasswordEncoder bean provided is the new version.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -    protected PasswordEncoder passwordEncoderNew;</span>
  96  
  97      /**
<abbr title="  98       * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using the">  98       * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using tðŸ”µ</abbr>
<abbr title="  99       * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}">  99       * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PðŸ”µ</abbr>
 100       */
 101      @Resource(name = &quot;blPasswordEncoder&quot;)
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -    protected Object passwordEncoderBean;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -     * Optional password salt to be used with the passwordEncoder</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 107 -     * @deprecated utilize {@link #saltSource} instead so that it can be shared between this class as well as Spring&#x27;s"> 107 -     * @deprecated utilize {@link #saltSource} instead so that it can be shared between this class as well as SpriðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -     * authentication manager, this will be removed in 4.2</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -    protected String salt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -     * Use a Salt Source ONLY if there&#x27;s one configured</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -     * @deprecated the new {@link PasswordEncoder} handles salting internally, this will be removed in 4.2</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -    @Autowired(required = false)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -    @Qualifier(&quot;blSaltSource&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -    protected SaltSource saltSource;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +    protected PasswordEncoder passwordEncoderBean;</span>
 123  
 124      @Resource(name = &quot;blRoleDao&quot;)
 125      protected RoleDao roleDao;
 126  
 127      @Resource(name = &quot;blEmailService&quot;)
 128      protected EmailService emailService;
 129  
 130      @Resource(name = &quot;blForgotPasswordEmailInfo&quot;)
 131      protected EmailInfo forgotPasswordEmailInfo;
 132  
 133      @Resource(name = &quot;blForgotUsernameEmailInfo&quot;)
 134      protected EmailInfo forgotUsernameEmailInfo;
 135  
 136      @Resource(name = &quot;blRegistrationEmailInfo&quot;)
 137      protected EmailInfo registrationEmailInfo;
 138  
 139      @Resource(name = &quot;blChangePasswordEmailInfo&quot;)
 140      protected EmailInfo changePasswordEmailInfo;
 141  
 142      protected int tokenExpiredMinutes = 30;
 143      protected int passwordTokenLength = 20;
 144  
<abbr title=" 145      protected final List&lt;PostRegistrationObserver&gt; postRegisterListeners = new ArrayList&lt;PostRegistrationObserver&gt;();"> 145      protected final List&lt;PostRegistrationObserver&gt; postRegisterListeners = new ArrayList&lt;PostRegistrationObserver&gt;ðŸ”µ</abbr>
 146      protected List&lt;PasswordUpdatedHandler&gt; passwordResetHandlers = new ArrayList&lt;PasswordUpdatedHandler&gt;();
 147      protected List&lt;PasswordUpdatedHandler&gt; passwordChangedHandlers = new ArrayList&lt;PasswordUpdatedHandler&gt;();
 148  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -    //will be externalId field weaved to Customer entity or not</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -    @Value(&quot;${enable.weave.customer.externalId:false}&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -    protected boolean enableCustomerExternalId = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 155 -     * &lt;p&gt;Sets either {@link #passwordEncoder} or {@link #passwordEncoderNew} based on the type of {@link #passwordEncoderBean}"> 155 -     * &lt;p&gt;Sets either {@link #passwordEncoder} or {@link #passwordEncoderNew} based on the type of {@link #passworðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 156 -     * in order to provide bean configuration backwards compatibility with the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder} bean."> 156 -     * in order to provide bean configuration backwards compatibility with the deprecated {@link org.springframewoðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -     * &lt;p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 158 -     * &lt;p&gt;{@link #passwordEncoderBean} is set by the bean defined as &quot;blPasswordEncoder&quot; and can be changed with {@link #setPasswordEncoder(Object)}."> 158 -     * &lt;p&gt;{@link #passwordEncoderBean} is set by the bean defined as &quot;blPasswordEncoder&quot; and can be changed with {ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -     * &lt;p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 160 -     * &lt;p&gt;This class will utilize either the new or deprecated PasswordEncoder type depending on which is not null."> 160 -     * &lt;p&gt;This class will utilize either the new or deprecated PasswordEncoder type depending on which is not nullðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 162 -     * @throws NoSuchBeanDefinitionException if {@link #passwordEncoderBean} is null or not an instance of either PasswordEncoder"> 162 -     * @throws NoSuchBeanDefinitionException if {@link #passwordEncoderBean} is null or not an instance of either ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -    @PostConstruct</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -    protected void setupPasswordEncoder() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -        passwordEncoderNew = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -        passwordEncoder = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -        if (passwordEncoderBean instanceof PasswordEncoder) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -            passwordEncoderNew = (PasswordEncoder) passwordEncoderBean;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 170 -        } else if (passwordEncoderBean instanceof org.springframework.security.authentication.encoding.PasswordEncoder) {"> 170 -        } else if (passwordEncoderBean instanceof org.springframework.security.authentication.encoding.PasswordEncðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 171 -            passwordEncoder = (org.springframework.security.authentication.encoding.PasswordEncoder) passwordEncoderBean;"> 171 -            passwordEncoder = (org.springframework.security.authentication.encoding.PasswordEncoder) passwordEncodðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -            throw new NoSuchBeanDefinitionException(&quot;No PasswordEncoder bean is defined&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -</span>
 177      @Override
 178      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 179      public Customer saveCustomer(Customer customer) {
 180          return saveCustomer(customer, customer.isRegistered());
 181      }
 182  
 183      @Override
 184      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 185      public Customer saveCustomer(Customer customer, boolean register) {
 186          if (register &amp;&amp; !customer.isRegistered()) {
 187              customer.setRegistered(true);
 188          }
 189  
 190          if (customer.getUnencodedPassword() != null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -            customer.setPassword(encodePassword(customer.getUnencodedPassword(), customer));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +            customer.setPassword(encodePassword(customer.getUnencodedPassword()));</span>
 193          }
 194  
 195          // let&#x27;s make sure they entered a new challenge answer (we will populate
 196          // the password field with hashed values so check that they have changed
 197          // id
<abbr title=" 198          if (customer.getUnencodedChallengeAnswer() != null &amp;&amp; !customer.getUnencodedChallengeAnswer().equals(customer.getChallengeAnswer())) {"> 198          if (customer.getUnencodedChallengeAnswer() != null &amp;&amp; !customer.getUnencodedChallengeAnswer().equals(custoðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -            customer.setChallengeAnswer(encodePassword(customer.getUnencodedChallengeAnswer(), customer));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +            customer.setChallengeAnswer(encodePassword(customer.getUnencodedChallengeAnswer()));</span>
 201          }
 202          return customerDao.save(customer);
 203      }
 204  
 205      protected String generateSecurePassword() {
 206          return PasswordUtils.generateSecurePassword(PASSWORD_LENGTH);
 207      }
 208  
 209      @Override
 210      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 211      public Customer registerCustomer(Customer customer, String password, String passwordConfirm) {
 212          customer.setRegistered(true);
 213  
 214          // When unencodedPassword is set the save() will encode it
 215          if (customer.getId() == null) {
 216              customer.setId(findNextCustomerId());
 217          }
 218          customer.setUnencodedPassword(password);
 219          Customer retCustomer = saveCustomer(customer);
 220          createRegisteredCustomerRoles(retCustomer);
 221  
 222          HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();
 223          vars.put(&quot;customer&quot;, retCustomer);
 224  
 225          sendEmail(customer.getEmailAddress(), getRegistrationEmailInfo(), vars);

 226          notifyPostRegisterListeners(retCustomer);

 227          return retCustomer;
 228      }
 229  
 230      @Override
 231      public void createRegisteredCustomerRoles(Customer customer) {
 232          Role role = roleDao.readRoleByName(&quot;ROLE_USER&quot;);
 233          CustomerRole customerRole = new CustomerRoleImpl();
 234          customerRole.setRole(role);
 235          customerRole.setCustomer(customer);
 236          roleDao.addRoleToCustomer(customerRole);
 237      }
 238  
 239      @Override
 240      public Customer readCustomerByEmail(String emailAddress) {
 241          return customerDao.readCustomerByEmail(emailAddress);
 242      }
 243  
 244      @Override
 245      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 246      public Customer changePassword(PasswordChange passwordChange) {
 247          Customer customer = readCustomerByUsername(passwordChange.getUsername());
 248          customer.setUnencodedPassword(passwordChange.getNewPassword());
 249          customer.setPasswordChangeRequired(passwordChange.getPasswordChangeRequired());
 250          customer = saveCustomer(customer);
 251  
 252          for (PasswordUpdatedHandler handler : passwordChangedHandlers) {
 253              handler.passwordChanged(passwordChange, customer, passwordChange.getNewPassword());
 254          }
 255  
 256          return customer;
 257      }
 258  
 259      @Override
 260      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 261      public Customer resetPassword(PasswordReset passwordReset) {
 262          Customer customer = readCustomerByUsername(passwordReset.getUsername());
 263          String newPassword = PasswordUtils.generateSecurePassword(passwordReset.getPasswordLength());
 264          customer.setUnencodedPassword(newPassword);
 265          customer.setPasswordChangeRequired(passwordReset.getPasswordChangeRequired());
 266          customer = saveCustomer(customer);
 267  
 268          for (PasswordUpdatedHandler handler : passwordResetHandlers) {
 269              handler.passwordChanged(passwordReset, customer, newPassword);
 270          }
 271  
 272          return customer;
 273      }
 274  
 275      @Override
 276      public void addPostRegisterListener(PostRegistrationObserver postRegisterListeners) {
 277          this.postRegisterListeners.add(postRegisterListeners);
 278      }
 279  
 280      @Override
 281      public void removePostRegisterListener(PostRegistrationObserver postRegisterListeners) {
 282          if (this.postRegisterListeners.contains(postRegisterListeners)) {
 283              this.postRegisterListeners.remove(postRegisterListeners);
 284          }
 285      }
 286  
 287      protected void notifyPostRegisterListeners(Customer customer) {
 288          for (Iterator&lt;PostRegistrationObserver&gt; iter = postRegisterListeners.iterator(); iter.hasNext(); ) {
 289              PostRegistrationObserver listener = iter.next();
 290              listener.processRegistrationEvent(customer);
 291          }
 292      }
 293  
 294      @Override
 295      public Customer createCustomer() {
 296          return createCustomerFromId(null);
 297      }
 298  
 299      @Override
 300      public Customer createCustomerFromId(Long customerId) {
 301          Customer customer = customerId != null ? readCustomerById(customerId) : null;
 302          if (customer == null) {
 303              customer = customerDao.create();
 304              if (customerId != null) {
 305                  customer.setId(customerId);
 306              } else {
 307                  customer.setId(findNextCustomerId());
 308              }
 309          }
 310          return customer;
 311      }
 312  
 313      @Override
 314      public Long findNextCustomerId() {
 315          return idGenerationService.findNextId(Customer.class.getCanonicalName());
 316      }
 317  
 318      @Override
 319      public Customer createNewCustomer() {
 320          return createCustomerFromId(null);
 321      }
 322  
 323      @Override
 324      public void deleteCustomer(Customer customer) {
 325          roleDao.removeCustomerRolesByCustomerId(customer.getId());
 326          customerDao.delete(customer);
 327      }
 328  
 329      @Override
 330      public Customer readCustomerByUsername(String username) {
 331          return customerDao.readCustomerByUsername(username);
 332      }
 333  
 334      @Override
 335      public Customer readCustomerByUsername(String username, Boolean cacheable) {
 336          return customerDao.readCustomerByUsername(username, cacheable);
 337      }
 338  
 339      @Override
 340      public Customer readCustomerById(Long id) {
 341          return customerDao.readCustomerById(id);
 342      }
 343  
 344      @Override
 345      public Customer readCustomerByExternalId(String userExternalId) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 346 -        if (enableCustomerExternalId) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -            return customerDao.readCustomerByExternalId(userExternalId);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 348 -        }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 349 -            LOG.error(&quot;attempt to find customer by externalId while property enable.weave.customer.externalId is false. Import module is responsible for weaving externalId field to customer&quot;);"> 349 -            LOG.error(&quot;attempt to find customer by externalId while property enable.weave.customer.externalId is fðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 350 -            return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 351 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +        return customerDao.readCustomerByExternalId(userExternalId);</span>
 353      }
 354  
 355      public void setCustomerDao(CustomerDao customerDao) {
 356          this.customerDao = customerDao;
 357      }
 358  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 359 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -     * &lt;p&gt;Set the passwordEncoder to be used by this class.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -     * &lt;p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -     * &lt;p&gt;This method will indirectly set one of the two PasswordEncoder member variables, depending on its type</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -     * by calling {@link #setupPasswordEncoder()}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 365 -     * @param passwordEncoder Either Spring Security&#x27;s new {@link PasswordEncoder}, or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}"> 365 -     * @param passwordEncoder Either Spring Security&#x27;s new {@link PasswordEncoder}, or the deprecated {@link org.sðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 367 -    public void setPasswordEncoder(Object passwordEncoder) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -        this.passwordEncoderBean = passwordEncoder;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -        setupPasswordEncoder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -    public Object getSalt(Customer customer) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -        return getSalt(customer, &quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 377 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 378 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 379 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 380 -    public Object getSalt(Customer customer, String unencodedPassword) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 381 -        Object salt = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 382 -        if (saltSource != null &amp;&amp; customer != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 383 -            salt = saltSource.getSalt(new CustomerUserDetails(customer.getId(), customer.getUsername(), unencodedPassword, new ArrayList&lt;GrantedAuthority&gt;()));"> 383 -            salt = saltSource.getSalt(new CustomerUserDetails(customer.getId(), customer.getUsername(), unencodedPðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 384 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 385 -        return salt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 386 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 387 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 388 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 389 -     * Delegates to either the new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}."> 389 -     * Delegates to either the new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.aðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 390 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 391 -     * @param rawPassword the unencoded password</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 392 -     * @param salt        the optional salt</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 393 -     * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 394 -     * @deprecated the new {@link org.springframework.security.crypto.password.PasswordEncoder PasswordEncoder} handles salting internally, this will be removed in 4.2"> 394 -     * @deprecated the new {@link org.springframework.security.crypto.password.PasswordEncoder PasswordEncoder} haðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 395 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -    protected String encodePass(String rawPassword, Object salt) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -        if (usingDeprecatedPasswordEncoder()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -            return passwordEncoder.encodePassword(rawPassword, salt);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 401 -            return encodePassword(rawPassword);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 403 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -    public String encodePassword(String rawPassword, Customer customer) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -        return encodePass(rawPassword, getSalt(customer, rawPassword));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -</span>
 411      @Override
 412      public String encodePassword(String rawPassword) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -        return passwordEncoderNew.encode(rawPassword);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 417 -     * Delegates to either the new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}."> 417 -     * Delegates to either the new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.aðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 418 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 419 -     * @param rawPassword     the unencoded password</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 420 -     * @param encodedPassword the encoded password to compare rawPassword against</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 421 -     * @param salt            the optional salt</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 422 -     * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 423 -     * @deprecated the new {@link org.springframework.security.crypto.password.PasswordEncoder PasswordEncoder} handles salting internally, this will be removed in 4.2"> 423 -     * @deprecated the new {@link org.springframework.security.crypto.password.PasswordEncoder PasswordEncoder} haðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 424 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 425 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 426 -    protected boolean isPassValid(String rawPassword, String encodedPassword, Object salt) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 427 -        if (usingDeprecatedPasswordEncoder()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 428 -            return passwordEncoder.isPasswordValid(encodedPassword, rawPassword, salt);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 429 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 430 -            return isPasswordValid(rawPassword, encodedPassword);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 431 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 432 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 433 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 434 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 435 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 436 -    public boolean isPasswordValid(String rawPassword, String encodedPassword, Customer customer) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 437 -        return isPassValid(rawPassword, encodedPassword, getSalt(customer, rawPassword));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 438 +        return passwordEncoderBean.encode(rawPassword);</span>
 439      }
 440  
 441      @Override
 442      public boolean isPasswordValid(String rawPassword, String encodedPassword) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 443 -        return passwordEncoderNew.matches(rawPassword, encodedPassword);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 444 +        return passwordEncoderBean.matches(rawPassword, encodedPassword);</span>
 445      }
 446  
 447      @Override
 448      public boolean customerPassesCustomerRule(Customer customer, CustomerRuleHolder customerRuleHolder) {
 449          String customerRule = customerRuleHolder.getCustomerRule();
 450          Map&lt;String, Object&gt; ruleParams = buildCustomerRuleParams(customer);
 451          return customerRule == null || MvelHelper.evaluateRule(customerRule, ruleParams);
 452      }
 453  
 454      protected Map&lt;String, Object&gt; buildCustomerRuleParams(Customer customer) {
 455          HashMap&lt;String, Object&gt; vars = new HashMap&lt;&gt;();
 456          vars.put(&quot;customer&quot;, customer);
 457          return vars;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 458 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 459 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 460 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 461 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 462 -    public String getSalt() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 463 -        return salt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 464 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 465 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 466 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 467 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 468 -    public void setSalt(String salt) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 469 -        this.salt = salt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 470 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 471 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 472 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 473 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 474 -    public SaltSource getSaltSource() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 475 -        return saltSource;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 476 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 477 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 478 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 479 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 480 -    public void setSaltSource(SaltSource saltSource) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 481 -        this.saltSource = saltSource;</span>
 482      }
 483  
 484      @Override
 485      public List&lt;PasswordUpdatedHandler&gt; getPasswordResetHandlers() {
 486          return passwordResetHandlers;
 487      }
 488  
 489      @Override
 490      public void setPasswordResetHandlers(List&lt;PasswordUpdatedHandler&gt; passwordResetHandlers) {
 491          this.passwordResetHandlers = passwordResetHandlers;
 492      }
 493  
 494      @Override
 495      public List&lt;PasswordUpdatedHandler&gt; getPasswordChangedHandlers() {
 496          return passwordChangedHandlers;
 497      }
 498  
 499      @Override
 500      public void setPasswordChangedHandlers(List&lt;PasswordUpdatedHandler&gt; passwordChangedHandlers) {
 501          this.passwordChangedHandlers = passwordChangedHandlers;
 502      }
 503  
 504      @Override
 505      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 506      public GenericResponse sendForgotUsernameNotification(String emailAddress) {
 507          GenericResponse response = new GenericResponse();
 508          List&lt;Customer&gt; customers = null;
 509          if (emailAddress != null) {
 510              customers = customerDao.readCustomersByEmail(emailAddress);
 511          }
 512  
 513          if (CollectionUtils.isEmpty(customers)) {
 514              response.addErrorCode(&quot;notFound&quot;);
 515          } else {
 516              List&lt;String&gt; activeUsernames = new ArrayList&lt;String&gt;();
 517              for (Customer customer : customers) {
 518                  if (!customer.isDeactivated()) {
 519                      activeUsernames.add(customer.getUsername());
 520                  }
 521              }
 522  
 523              if (activeUsernames.size() &gt; 0) {
 524                  HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();
 525                  vars.put(&quot;userNames&quot;, activeUsernames);
 526                  sendEmail(emailAddress, getForgotUsernameEmailInfo(), vars);

 527              } else {
 528                  // send inactive username found email.
 529                  response.addErrorCode(&quot;inactiveUser&quot;);
 530              }
 531          }
 532          return response;
 533      }
 534  
 535      @Override
 536      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 537      public GenericResponse sendForgotPasswordNotification(String username, String resetPasswordUrl) {
 538          GenericResponse response = new GenericResponse();
 539          Customer customer = null;
 540  
 541          if (username != null) {
 542              customer = customerDao.readCustomerByUsername(username);
 543          }
 544  
 545          checkCustomer(customer, response);
 546  
 547          if (!response.getHasErrors()) {
 548              String token = PasswordUtils.generateSecurePassword(getPasswordTokenLength());
 549              token = token.toLowerCase();
 550  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 551 -            Object salt = getSalt(customer, token);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 552 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 553 -            String saltString = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 554 -            if (salt != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 555 -                saltString = Hex.encodeHexString(salt.toString().getBytes());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 556 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 557 -</span>
 558              CustomerForgotPasswordSecurityToken fpst = new CustomerForgotPasswordSecurityTokenImpl();
 559              fpst.setCustomerId(customer.getId());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 560 -            fpst.setToken(encodePass(token, saltString));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 561 +            fpst.setToken(encodePassword(token));</span>
 562              fpst.setCreateDate(SystemTime.asDate());
 563              customerForgotPasswordSecurityTokenDao.saveToken(fpst);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 564 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 565 -            if (usingDeprecatedPasswordEncoder() &amp;&amp; saltString != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 566 -                token = token + &#x27;-&#x27; + saltString;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 567 -            }</span>
 568  
 569              HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();
 570              vars.put(&quot;token&quot;, token);
 571              if (!StringUtils.isEmpty(resetPasswordUrl)) {
 572                  if (resetPasswordUrl.contains(&quot;?&quot;)) {
 573                      resetPasswordUrl = resetPasswordUrl + &quot;&amp;token=&quot; + token;

 574                  } else {
 575                      resetPasswordUrl = resetPasswordUrl + &quot;?token=&quot; + token;

 576                  }
 577              }
 578              vars.put(&quot;resetPasswordUrl&quot;, resetPasswordUrl);
 579              sendEmail(customer.getEmailAddress(), getForgotPasswordEmailInfo(), vars);


 580          }
 581          return response;
 582      }
 583  
 584      @Override
 585      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 586      public GenericResponse sendForcedPasswordChangeNotification(String username, String resetPasswordUrl) {
 587          return sendForgotPasswordNotification(username, resetPasswordUrl);
 588      }
 589  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 590 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 591 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 592 -    public GenericResponse checkPasswordResetToken(String token) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 593 -        if (!usingDeprecatedPasswordEncoder()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 594 -            // We cannot proceed without a Customer when using the new PasswordEncoder</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 595 -            throw new NoSuchBeanDefinitionException(&quot;This method requires the deprecated PasswordEncoder bean&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 596 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 597 -        return checkPasswordResetToken(token, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 598 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 599 -</span>
 600      @Override
 601      public GenericResponse checkPasswordResetToken(String token, Customer customer) {
 602          GenericResponse response = new GenericResponse();
 603          checkPasswordResetToken(token, customer, response);
 604          return response;
 605      }
 606  
<abbr title=" 607      protected CustomerForgotPasswordSecurityToken checkPasswordResetToken(String token, Customer customer, GenericResponse response) {"> 607      protected CustomerForgotPasswordSecurityToken checkPasswordResetToken(String token, Customer customer, GenericðŸ”µ</abbr>
 608          if (StringUtils.isBlank(token)) {
 609              response.addErrorCode(&quot;invalidToken&quot;);
 610          }
 611  
 612          String rawToken = token;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 613 -        String salt = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 614 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 615 -        if (usingDeprecatedPasswordEncoder()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 616 -            String[] tokens = token.split(&quot;-&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 617 -            if (tokens.length &gt; 2) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 618 -                response.addErrorCode(&quot;invalidToken&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 619 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 620 -                rawToken = tokens[0].toLowerCase();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 621 -                if (tokens.length == 2) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 622 -                    salt = tokens[1];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 623 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 624 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 625 -        }</span>
 626  
 627          CustomerForgotPasswordSecurityToken fpst = null;
 628          if (!response.getHasErrors()) {
 629              if (customer == null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 630 -                if (!usingDeprecatedPasswordEncoder()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 631 -                    // customer can only be null when supporting use of the legacy PasswordEncoder</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 632 -                    response.addErrorCode(&quot;invalidCustomer&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 633 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 634 -                    fpst = customerForgotPasswordSecurityTokenDao.readToken(passwordEncoder.encodePassword(rawToken, salt));"> 634 -                    fpst = customerForgotPasswordSecurityTokenDao.readToken(passwordEncoder.encodePassword(rawTokeðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 635 -                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 636 +                fpst = customerForgotPasswordSecurityTokenDao.readToken(encodePassword(token));</span>
 637              } else {
<abbr title=" 638                  List&lt;CustomerForgotPasswordSecurityToken&gt; fpstoks = customerForgotPasswordSecurityTokenDao.readUnusedTokensByCustomerId(customer.getId());"> 638                  List&lt;CustomerForgotPasswordSecurityToken&gt; fpstoks = customerForgotPasswordSecurityTokenDao.readUnuðŸ”µ</abbr>
 639                  for (CustomerForgotPasswordSecurityToken fpstok : fpstoks) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 640 -                    if (isPassValid(rawToken, fpstok.getToken(), salt)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 641 +                    if (isPasswordValid(rawToken, fpstok.getToken())) {</span>
 642                          fpst = fpstok;
 643                          break;
 644                      }
 645                  }
 646              }
 647              if (fpst == null) {
 648                  response.addErrorCode(&quot;invalidToken&quot;);
 649              } else if (fpst.isTokenUsedFlag()) {
 650                  response.addErrorCode(&quot;tokenUsed&quot;);
 651              } else if (isTokenExpired(fpst)) {
 652                  response.addErrorCode(&quot;tokenExpired&quot;);
 653              }
 654          }
 655          return fpst;
 656      }
 657  
 658      @Override
 659      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
<abbr title=" 660      public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPassword) {"> 660      public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPðŸ”µ</abbr>
 661          GenericResponse response = new GenericResponse();
 662          Customer customer = null;
 663          if (username != null) {
 664              customer = customerDao.readCustomerByUsername(username);
 665          }
 666          checkCustomer(customer, response);
 667          checkPassword(password, confirmPassword, response);
 668          CustomerForgotPasswordSecurityToken fpst = checkPasswordResetToken(token, customer, response);
 669  
 670          if (!response.getHasErrors()) {
 671              if (!customer.getId().equals(fpst.getCustomerId())) {
 672                  if (LOG.isWarnEnabled()) {
<abbr title=" 673                      LOG.warn(&quot;Password reset attempt tried with mismatched customer and token &quot; + customer.getId() + &quot;, &quot; + StringUtil.sanitize(token));"> 673                      LOG.warn(&quot;Password reset attempt tried with mismatched customer and token &quot; + customer.getId()ðŸ”µ</abbr>
 674                  }
 675                  response.addErrorCode(&quot;invalidToken&quot;);
 676              }
 677          }
 678  
 679          if (!response.getHasErrors()) {
 680              customer.setUnencodedPassword(password);
 681              customer.setPasswordChangeRequired(false);
 682              saveCustomer(customer);
 683              invalidateAllTokensForCustomer(customer);
 684          }
 685  
 686          return response;
 687      }
 688  
 689      protected void invalidateAllTokensForCustomer(Customer customer) {
<abbr title=" 690          List&lt;CustomerForgotPasswordSecurityToken&gt; tokens = customerForgotPasswordSecurityTokenDao.readUnusedTokensByCustomerId(customer.getId());"> 690          List&lt;CustomerForgotPasswordSecurityToken&gt; tokens = customerForgotPasswordSecurityTokenDao.readUnusedTokensðŸ”µ</abbr>
 691          for (CustomerForgotPasswordSecurityToken token : tokens) {
 692              token.setTokenUsedFlag(true);
 693              customerForgotPasswordSecurityTokenDao.saveToken(token);
 694          }
 695      }
 696  
 697      protected void checkCustomer(Customer customer, GenericResponse response) {
 698          if (customer == null) {
 699              response.addErrorCode(&quot;invalidCustomer&quot;);
 700          } else if (StringUtils.isBlank(customer.getEmailAddress())) {
 701              response.addErrorCode(&quot;emailNotFound&quot;);
 702          } else if (customer.isDeactivated()) {
 703              response.addErrorCode(&quot;inactiveUser&quot;);
 704          }
 705      }
 706  
 707      protected void checkPassword(String password, String confirmPassword, GenericResponse response) {
 708          if (StringUtils.isBlank(password) || StringUtils.isBlank(confirmPassword)) {
 709              response.addErrorCode(&quot;invalidPassword&quot;);
 710          } else if (!password.equals(confirmPassword)) {
 711              response.addErrorCode(&quot;passwordMismatch&quot;);
 712          }
 713      }
 714  
 715      protected boolean isTokenExpired(CustomerForgotPasswordSecurityToken fpst) {
 716          Date now = SystemTime.asDate();
 717          long currentTimeInMillis = now.getTime();
 718          long tokenSaveTimeInMillis = fpst.getCreateDate().getTime();
 719          long minutesSinceSave = (currentTimeInMillis - tokenSaveTimeInMillis) / 60000;
 720          return minutesSinceSave &gt; tokenExpiredMinutes;
 721      }
 722  
 723      protected void sendEmail(String emailAddress, EmailInfo emailInfo, Map&lt;String, Object&gt; props) {
 724          emailService.sendTemplateEmail(emailAddress, emailInfo, props);
 725      }
 726  
 727      public int getTokenExpiredMinutes() {
 728          return tokenExpiredMinutes;
 729      }
 730  
 731      public void setTokenExpiredMinutes(int tokenExpiredMinutes) {
 732          this.tokenExpiredMinutes = tokenExpiredMinutes;
 733      }
 734  
 735      public int getPasswordTokenLength() {
 736          return passwordTokenLength;
 737      }
 738  
 739      public void setPasswordTokenLength(int passwordTokenLength) {
 740          this.passwordTokenLength = passwordTokenLength;
 741      }
 742  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 743 +</span>
 744      public EmailInfo getForgotPasswordEmailInfo() {
 745          return forgotPasswordEmailInfo;
 746      }
 747  
 748      public void setForgotPasswordEmailInfo(EmailInfo forgotPasswordEmailInfo) {
 749          this.forgotPasswordEmailInfo = forgotPasswordEmailInfo;
 750      }
 751  
 752      public EmailInfo getForgotUsernameEmailInfo() {
 753          return forgotUsernameEmailInfo;
 754      }
 755  
 756      public void setForgotUsernameEmailInfo(EmailInfo forgotUsernameEmailInfo) {
 757          this.forgotUsernameEmailInfo = forgotUsernameEmailInfo;
 758      }
 759  
 760      public EmailInfo getRegistrationEmailInfo() {
 761          return registrationEmailInfo;
 762      }
 763  
 764      public void setRegistrationEmailInfo(EmailInfo registrationEmailInfo) {
 765          this.registrationEmailInfo = registrationEmailInfo;
 766      }
 767  
 768      public EmailInfo getChangePasswordEmailInfo() {
 769          return changePasswordEmailInfo;
 770      }
 771  
 772      public void setChangePasswordEmailInfo(EmailInfo changePasswordEmailInfo) {
 773          this.changePasswordEmailInfo = changePasswordEmailInfo;
 774      }
 775  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 776 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 777 -    protected boolean usingDeprecatedPasswordEncoder() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 778 -        return passwordEncoder != null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 779 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 780 -</span>
 781      @Override
 782      public List&lt;Customer&gt; readBatchCustomers(int start, int pageSize) {
 783          return customerDao.readBatchCustomers(start, pageSize);
 784      }
 785  
 786      @Override
 787      public Long readNumberOfCustomers() {
 788          return customerDao.readNumberOfCustomers();
 789      }
 790  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Profile
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.profile.core.service;
  19  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -import org.apache.commons.codec.binary.Hex;</span>
  21  import org.apache.commons.collections4.CollectionUtils;
  22  import org.apache.commons.lang3.StringUtils;
  23  import org.apache.commons.logging.Log;
  24  import org.apache.commons.logging.LogFactory;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import org.broadleafcommerce.common.event.BroadleafApplicationEventPublisher;</span>
  26  import org.broadleafcommerce.common.id.service.IdGenerationService;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import org.broadleafcommerce.profile.core.dto.CustomerRuleHolder;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import org.broadleafcommerce.common.email.service.EmailService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import org.broadleafcommerce.common.email.service.info.EmailInfo;</span>

  30  import org.broadleafcommerce.common.rule.MvelHelper;
  31  import org.broadleafcommerce.common.security.util.PasswordChange;
  32  import org.broadleafcommerce.common.security.util.PasswordReset;
  33  import org.broadleafcommerce.common.security.util.PasswordUtils;
  34  import org.broadleafcommerce.common.service.GenericResponse;
  35  import org.broadleafcommerce.common.time.SystemTime;
  36  import org.broadleafcommerce.common.util.StringUtil;
  37  import org.broadleafcommerce.common.util.TransactionUtils;
  38  import org.broadleafcommerce.profile.core.dao.CustomerDao;
  39  import org.broadleafcommerce.profile.core.dao.CustomerForgotPasswordSecurityTokenDao;
  40  import org.broadleafcommerce.profile.core.dao.RoleDao;
  41  import org.broadleafcommerce.profile.core.domain.Customer;
  42  import org.broadleafcommerce.profile.core.domain.CustomerForgotPasswordSecurityToken;
  43  import org.broadleafcommerce.profile.core.domain.CustomerForgotPasswordSecurityTokenImpl;
  44  import org.broadleafcommerce.profile.core.domain.CustomerRole;
  45  import org.broadleafcommerce.profile.core.domain.CustomerRoleImpl;
  46  import org.broadleafcommerce.profile.core.domain.Role;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import org.broadleafcommerce.profile.core.dto.CustomerRuleHolder;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +import org.broadleafcommerce.profile.core.event.ForgotPasswordEvent;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +import org.broadleafcommerce.profile.core.event.ForgotUsernameEvent;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +import org.broadleafcommerce.profile.core.event.RegisterCustomerEvent;</span>
  51  import org.broadleafcommerce.profile.core.service.handler.PasswordUpdatedHandler;
  52  import org.broadleafcommerce.profile.core.service.listener.PostRegistrationObserver;
  53  import org.springframework.beans.factory.NoSuchBeanDefinitionException;
  54  import org.springframework.beans.factory.annotation.Autowired;
  55  import org.springframework.beans.factory.annotation.Qualifier;
  56  import org.springframework.beans.factory.annotation.Value;
  57  import org.springframework.security.authentication.dao.SaltSource;
  58  import org.springframework.security.core.GrantedAuthority;
  59  import org.springframework.security.crypto.password.PasswordEncoder;
  60  import org.springframework.stereotype.Service;
  61  import org.springframework.transaction.annotation.Transactional;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -</span>
  63  import java.util.ArrayList;
  64  import java.util.Date;
  65  import java.util.HashMap;
  66  import java.util.Iterator;
  67  import java.util.List;
  68  import java.util.Map;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -</span>
  70  import javax.annotation.PostConstruct;
  71  import javax.annotation.Resource;
  72  
  73  @Service(&quot;blCustomerService&quot;)
  74  public class CustomerServiceImpl implements CustomerService {
  75      private static final Log LOG = LogFactory.getLog(CustomerServiceImpl.class);
  76      private static final int PASSWORD_LENGTH = 16;
  77  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -    @Resource(name = &quot;blCustomerDao&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +    @Autowired</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +    @Qualifier(&quot;blApplicationEventPublisher&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +    protected BroadleafApplicationEventPublisher eventPublisher;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +    @Resource(name=&quot;blCustomerDao&quot;)</span>
  84      protected CustomerDao customerDao;
  85  
  86      @Resource(name = &quot;blIdGenerationService&quot;)
  87      protected IdGenerationService idGenerationService;
  88  
  89      @Resource(name = &quot;blCustomerForgotPasswordSecurityTokenDao&quot;)
  90      protected CustomerForgotPasswordSecurityTokenDao customerForgotPasswordSecurityTokenDao;
  91  
  92      /**
  93       * &lt;p&gt;Set by {@link #setupPasswordEncoder()} if the blPasswordEncoder bean provided is the deprecated version.
  94       *
  95       * @deprecated Spring Security has deprecated this encoder interface, this will be removed in 4.2
  96       */
  97      @Deprecated
  98      protected org.springframework.security.authentication.encoding.PasswordEncoder passwordEncoder;
  99  
 100      /**
 101       * &lt;p&gt;Set by {@link #setupPasswordEncoder()} if the blPasswordEncoder bean provided is the new version.
 102       */
 103      protected PasswordEncoder passwordEncoderNew;
 104  
 105      /**
<abbr title=" 106       * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using the"> 106       * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using tðŸ”µ</abbr>
<abbr title=" 107       * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}"> 107       * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PðŸ”µ</abbr>
 108       */
 109      @Resource(name = &quot;blPasswordEncoder&quot;)
 110      protected Object passwordEncoderBean;
 111  
 112      /**
 113       * Optional password salt to be used with the passwordEncoder
 114       *
<abbr title=" 115       * @deprecated utilize {@link #saltSource} instead so that it can be shared between this class as well as Spring&#x27;s"> 115       * @deprecated utilize {@link #saltSource} instead so that it can be shared between this class as well as SpriðŸ”µ</abbr>
 116       * authentication manager, this will be removed in 4.2
 117       */
 118      @Deprecated
 119      protected String salt;
 120  
 121      /**
 122       * Use a Salt Source ONLY if there&#x27;s one configured
 123       *
 124       * @deprecated the new {@link PasswordEncoder} handles salting internally, this will be removed in 4.2
 125       */
 126      @Deprecated
 127      @Autowired(required = false)
 128      @Qualifier(&quot;blSaltSource&quot;)
 129      protected SaltSource saltSource;

 130  
 131      @Resource(name = &quot;blRoleDao&quot;)
 132      protected RoleDao roleDao;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -    @Resource(name = &quot;blEmailService&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -    protected EmailService emailService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -    @Resource(name = &quot;blForgotPasswordEmailInfo&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -    protected EmailInfo forgotPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -    @Resource(name = &quot;blForgotUsernameEmailInfo&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -    protected EmailInfo forgotUsernameEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -    @Resource(name = &quot;blRegistrationEmailInfo&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -    protected EmailInfo registrationEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -    @Resource(name = &quot;blChangePasswordEmailInfo&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -    protected EmailInfo changePasswordEmailInfo;</span>
 148  
 149      protected int tokenExpiredMinutes = 30;
 150      protected int passwordTokenLength = 20;
 151  
<abbr title=" 152      protected final List&lt;PostRegistrationObserver&gt; postRegisterListeners = new ArrayList&lt;PostRegistrationObserver&gt;();"> 152      protected final List&lt;PostRegistrationObserver&gt; postRegisterListeners = new ArrayList&lt;PostRegistrationObserver&gt;ðŸ”µ</abbr>
 153      protected List&lt;PasswordUpdatedHandler&gt; passwordResetHandlers = new ArrayList&lt;PasswordUpdatedHandler&gt;();
 154      protected List&lt;PasswordUpdatedHandler&gt; passwordChangedHandlers = new ArrayList&lt;PasswordUpdatedHandler&gt;();
 155  
 156      //will be externalId field weaved to Customer entity or not
 157      @Value(&quot;${enable.weave.customer.externalId:false}&quot;)
 158      protected boolean enableCustomerExternalId = false;
 159  
 160  
 161      /**
<abbr title=" 162       * &lt;p&gt;Sets either {@link #passwordEncoder} or {@link #passwordEncoderNew} based on the type of {@link #passwordEncoderBean}"> 162       * &lt;p&gt;Sets either {@link #passwordEncoder} or {@link #passwordEncoderNew} based on the type of {@link #passworðŸ”µ</abbr>
<abbr title=" 163       * in order to provide bean configuration backwards compatibility with the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder} bean."> 163       * in order to provide bean configuration backwards compatibility with the deprecated {@link org.springframewoðŸ”µ</abbr>
 164       * &lt;p&gt;
<abbr title=" 165       * &lt;p&gt;{@link #passwordEncoderBean} is set by the bean defined as &quot;blPasswordEncoder&quot; and can be changed with {@link #setPasswordEncoder(Object)}."> 165       * &lt;p&gt;{@link #passwordEncoderBean} is set by the bean defined as &quot;blPasswordEncoder&quot; and can be changed with {ðŸ”µ</abbr>
 166       * &lt;p&gt;
<abbr title=" 167       * &lt;p&gt;This class will utilize either the new or deprecated PasswordEncoder type depending on which is not null."> 167       * &lt;p&gt;This class will utilize either the new or deprecated PasswordEncoder type depending on which is not nullðŸ”µ</abbr>
 168       *
<abbr title=" 169       * @throws NoSuchBeanDefinitionException if {@link #passwordEncoderBean} is null or not an instance of either PasswordEncoder"> 169       * @throws NoSuchBeanDefinitionException if {@link #passwordEncoderBean} is null or not an instance of either ðŸ”µ</abbr>
 170       */
 171      @PostConstruct
 172      protected void setupPasswordEncoder() {
 173          passwordEncoderNew = null;
 174          passwordEncoder = null;
 175          if (passwordEncoderBean instanceof PasswordEncoder) {
 176              passwordEncoderNew = (PasswordEncoder) passwordEncoderBean;
<abbr title=" 177          } else if (passwordEncoderBean instanceof org.springframework.security.authentication.encoding.PasswordEncoder) {"> 177          } else if (passwordEncoderBean instanceof org.springframework.security.authentication.encoding.PasswordEncðŸ”µ</abbr>
<abbr title=" 178              passwordEncoder = (org.springframework.security.authentication.encoding.PasswordEncoder) passwordEncoderBean;"> 178              passwordEncoder = (org.springframework.security.authentication.encoding.PasswordEncoder) passwordEncodðŸ”µ</abbr>
 179          } else {
 180              throw new NoSuchBeanDefinitionException(&quot;No PasswordEncoder bean is defined&quot;);
 181          }
 182      }
 183  
 184      @Override
 185      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 186      public Customer saveCustomer(Customer customer) {
 187          return saveCustomer(customer, customer.isRegistered());
 188      }
 189  
 190      @Override
 191      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 192      public Customer saveCustomer(Customer customer, boolean register) {
 193          if (register &amp;&amp; !customer.isRegistered()) {
 194              customer.setRegistered(true);
 195          }
 196  
 197          if (customer.getUnencodedPassword() != null) {
 198              customer.setPassword(encodePassword(customer.getUnencodedPassword(), customer));

 199          }
 200  
 201          // let&#x27;s make sure they entered a new challenge answer (we will populate
 202          // the password field with hashed values so check that they have changed
 203          // id
<abbr title=" 204          if (customer.getUnencodedChallengeAnswer() != null &amp;&amp; !customer.getUnencodedChallengeAnswer().equals(customer.getChallengeAnswer())) {"> 204          if (customer.getUnencodedChallengeAnswer() != null &amp;&amp; !customer.getUnencodedChallengeAnswer().equals(custoðŸ”µ</abbr>
 205              customer.setChallengeAnswer(encodePassword(customer.getUnencodedChallengeAnswer(), customer));

 206          }
 207          return customerDao.save(customer);
 208      }
 209  
 210      protected String generateSecurePassword() {
 211          return PasswordUtils.generateSecurePassword(PASSWORD_LENGTH);
 212      }
 213  
 214      @Override
 215      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 216      public Customer registerCustomer(Customer customer, String password, String passwordConfirm) {
 217          customer.setRegistered(true);
 218  
 219          // When unencodedPassword is set the save() will encode it
 220          if (customer.getId() == null) {
 221              customer.setId(findNextCustomerId());
 222          }
 223          customer.setUnencodedPassword(password);
 224          Customer retCustomer = saveCustomer(customer);
 225          createRegisteredCustomerRoles(retCustomer);
 226  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -        HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -        vars.put(&quot;customer&quot;, retCustomer);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -        sendEmail(customer.getEmailAddress(), getRegistrationEmailInfo(), vars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +        eventPublisher.publishEvent(new RegisterCustomerEvent(this, retCustomer.getId()));</span>
 232          notifyPostRegisterListeners(retCustomer);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +</span>
 234          return retCustomer;
 235      }
 236  
 237      @Override
 238      public void createRegisteredCustomerRoles(Customer customer) {
 239          Role role = roleDao.readRoleByName(&quot;ROLE_USER&quot;);
 240          CustomerRole customerRole = new CustomerRoleImpl();
 241          customerRole.setRole(role);
 242          customerRole.setCustomer(customer);
 243          roleDao.addRoleToCustomer(customerRole);
 244      }
 245  
 246      @Override
 247      public Customer readCustomerByEmail(String emailAddress) {
 248          return customerDao.readCustomerByEmail(emailAddress);
 249      }
 250  
 251      @Override
 252      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 253      public Customer changePassword(PasswordChange passwordChange) {
 254          Customer customer = readCustomerByUsername(passwordChange.getUsername());
 255          customer.setUnencodedPassword(passwordChange.getNewPassword());
 256          customer.setPasswordChangeRequired(passwordChange.getPasswordChangeRequired());
 257          customer = saveCustomer(customer);
 258  
 259          for (PasswordUpdatedHandler handler : passwordChangedHandlers) {
 260              handler.passwordChanged(passwordChange, customer, passwordChange.getNewPassword());
 261          }
 262  
 263          return customer;
 264      }
 265  
 266      @Override
 267      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 268      public Customer resetPassword(PasswordReset passwordReset) {
 269          Customer customer = readCustomerByUsername(passwordReset.getUsername());
 270          String newPassword = PasswordUtils.generateSecurePassword(passwordReset.getPasswordLength());
 271          customer.setUnencodedPassword(newPassword);
 272          customer.setPasswordChangeRequired(passwordReset.getPasswordChangeRequired());
 273          customer = saveCustomer(customer);
 274  
 275          for (PasswordUpdatedHandler handler : passwordResetHandlers) {
 276              handler.passwordChanged(passwordReset, customer, newPassword);
 277          }
 278  
 279          return customer;
 280      }
 281  
 282      @Override
 283      public void addPostRegisterListener(PostRegistrationObserver postRegisterListeners) {
 284          this.postRegisterListeners.add(postRegisterListeners);
 285      }
 286  
 287      @Override
 288      public void removePostRegisterListener(PostRegistrationObserver postRegisterListeners) {
 289          if (this.postRegisterListeners.contains(postRegisterListeners)) {
 290              this.postRegisterListeners.remove(postRegisterListeners);
 291          }
 292      }
 293  
 294      protected void notifyPostRegisterListeners(Customer customer) {
 295          for (Iterator&lt;PostRegistrationObserver&gt; iter = postRegisterListeners.iterator(); iter.hasNext(); ) {
 296              PostRegistrationObserver listener = iter.next();
 297              listener.processRegistrationEvent(customer);
 298          }
 299      }
 300  
 301      @Override
 302      public Customer createCustomer() {
 303          return createCustomerFromId(null);
 304      }
 305  
 306      @Override
 307      public Customer createCustomerFromId(Long customerId) {
 308          Customer customer = customerId != null ? readCustomerById(customerId) : null;
 309          if (customer == null) {
 310              customer = customerDao.create();
 311              if (customerId != null) {
 312                  customer.setId(customerId);
 313              } else {
 314                  customer.setId(findNextCustomerId());
 315              }
 316          }
 317          return customer;
 318      }
 319  
 320      @Override
 321      public Long findNextCustomerId() {
 322          return idGenerationService.findNextId(Customer.class.getCanonicalName());
 323      }
 324  
 325      @Override
 326      public Customer createNewCustomer() {
 327          return createCustomerFromId(null);
 328      }
 329  
 330      @Override
 331      public void deleteCustomer(Customer customer) {
 332          roleDao.removeCustomerRolesByCustomerId(customer.getId());
 333          customerDao.delete(customer);
 334      }
 335  
 336      @Override
 337      public Customer readCustomerByUsername(String username) {
 338          return customerDao.readCustomerByUsername(username);
 339      }
 340  
 341      @Override
 342      public Customer readCustomerByUsername(String username, Boolean cacheable) {
 343          return customerDao.readCustomerByUsername(username, cacheable);
 344      }
 345  
 346      @Override
 347      public Customer readCustomerById(Long id) {
 348          return customerDao.readCustomerById(id);
 349      }
 350  
 351      @Override
 352      public Customer readCustomerByExternalId(String userExternalId) {
 353          if (enableCustomerExternalId) {
 354              return customerDao.readCustomerByExternalId(userExternalId);
 355          }else{
<abbr title=" 356              LOG.error(&quot;attempt to find customer by externalId while property enable.weave.customer.externalId is false. Import module is responsible for weaving externalId field to customer&quot;);"> 356              LOG.error(&quot;attempt to find customer by externalId while property enable.weave.customer.externalId is fðŸ”µ</abbr>
 357              return null;
 358          }

 359      }
 360  
 361      public void setCustomerDao(CustomerDao customerDao) {
 362          this.customerDao = customerDao;
 363      }
 364  
 365      /**
 366       * &lt;p&gt;Set the passwordEncoder to be used by this class.
 367       * &lt;p&gt;
 368       * &lt;p&gt;This method will indirectly set one of the two PasswordEncoder member variables, depending on its type
 369       * by calling {@link #setupPasswordEncoder()}
 370       *
<abbr title=" 371       * @param passwordEncoder Either Spring Security&#x27;s new {@link PasswordEncoder}, or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}"> 371       * @param passwordEncoder Either Spring Security&#x27;s new {@link PasswordEncoder}, or the deprecated {@link org.sðŸ”µ</abbr>
 372       */
 373      public void setPasswordEncoder(Object passwordEncoder) {
 374          this.passwordEncoderBean = passwordEncoder;
 375          setupPasswordEncoder();
 376      }
 377  
 378      @Deprecated
 379      @Override
 380      public Object getSalt(Customer customer) {
 381          return getSalt(customer, &quot;&quot;);
 382      }
 383  
 384      @Deprecated
 385      @Override
 386      public Object getSalt(Customer customer, String unencodedPassword) {
 387          Object salt = null;
 388          if (saltSource != null &amp;&amp; customer != null) {
<abbr title=" 389              salt = saltSource.getSalt(new CustomerUserDetails(customer.getId(), customer.getUsername(), unencodedPassword, new ArrayList&lt;GrantedAuthority&gt;()));"> 389              salt = saltSource.getSalt(new CustomerUserDetails(customer.getId(), customer.getUsername(), unencodedPðŸ”µ</abbr>
 390          }
 391          return salt;
 392      }
 393  
 394      /**
<abbr title=" 395       * Delegates to either the new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}."> 395       * Delegates to either the new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.aðŸ”µ</abbr>
 396       *
 397       * @param rawPassword the unencoded password
 398       * @param salt        the optional salt
 399       * @return
<abbr title=" 400       * @deprecated the new {@link org.springframework.security.crypto.password.PasswordEncoder PasswordEncoder} handles salting internally, this will be removed in 4.2"> 400       * @deprecated the new {@link org.springframework.security.crypto.password.PasswordEncoder PasswordEncoder} haðŸ”µ</abbr>
 401       */
 402      @Deprecated
 403      protected String encodePass(String rawPassword, Object salt) {
 404          if (usingDeprecatedPasswordEncoder()) {
 405              return passwordEncoder.encodePassword(rawPassword, salt);
 406          } else {
 407              return encodePassword(rawPassword);
 408          }
 409      }
 410  
 411      @Deprecated
 412      @Override
 413      public String encodePassword(String rawPassword, Customer customer) {
 414          return encodePass(rawPassword, getSalt(customer, rawPassword));
 415      }
 416  
 417      @Override
 418      public String encodePassword(String rawPassword) {
 419          return passwordEncoderNew.encode(rawPassword);
 420      }
 421  
 422      /**
<abbr title=" 423       * Delegates to either the new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}."> 423       * Delegates to either the new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.aðŸ”µ</abbr>
 424       *
 425       * @param rawPassword     the unencoded password
 426       * @param encodedPassword the encoded password to compare rawPassword against
 427       * @param salt            the optional salt
 428       * @return
<abbr title=" 429       * @deprecated the new {@link org.springframework.security.crypto.password.PasswordEncoder PasswordEncoder} handles salting internally, this will be removed in 4.2"> 429       * @deprecated the new {@link org.springframework.security.crypto.password.PasswordEncoder PasswordEncoder} haðŸ”µ</abbr>
 430       */
 431      @Deprecated
 432      protected boolean isPassValid(String rawPassword, String encodedPassword, Object salt) {
 433          if (usingDeprecatedPasswordEncoder()) {
 434              return passwordEncoder.isPasswordValid(encodedPassword, rawPassword, salt);
 435          } else {
 436              return isPasswordValid(rawPassword, encodedPassword);
 437          }
 438      }
 439  
 440      @Deprecated
 441      @Override
 442      public boolean isPasswordValid(String rawPassword, String encodedPassword, Customer customer) {
 443          return isPassValid(rawPassword, encodedPassword, getSalt(customer, rawPassword));

 444      }
 445  
 446      @Override
 447      public boolean isPasswordValid(String rawPassword, String encodedPassword) {
 448          return passwordEncoderNew.matches(rawPassword, encodedPassword);

 449      }
 450  
 451      @Override
 452      public boolean customerPassesCustomerRule(Customer customer, CustomerRuleHolder customerRuleHolder) {
 453          String customerRule = customerRuleHolder.getCustomerRule();
 454          Map&lt;String, Object&gt; ruleParams = buildCustomerRuleParams(customer);
 455          return customerRule == null || MvelHelper.evaluateRule(customerRule, ruleParams);
 456      }
 457  
 458      protected Map&lt;String, Object&gt; buildCustomerRuleParams(Customer customer) {
 459          HashMap&lt;String, Object&gt; vars = new HashMap&lt;&gt;();
 460          vars.put(&quot;customer&quot;, customer);
 461          return vars;
 462      }
 463  
 464      @Override
 465      @Deprecated
 466      public String getSalt() {
 467          return salt;
 468      }
 469  
 470      @Override
 471      @Deprecated
 472      public void setSalt(String salt) {
 473          this.salt = salt;
 474      }
 475  
 476      @Deprecated
 477      @Override
 478      public SaltSource getSaltSource() {
 479          return saltSource;
 480      }
 481  
 482      @Deprecated
 483      @Override
 484      public void setSaltSource(SaltSource saltSource) {
 485          this.saltSource = saltSource;
 486      }
 487  
 488      @Override
 489      public List&lt;PasswordUpdatedHandler&gt; getPasswordResetHandlers() {
 490          return passwordResetHandlers;
 491      }
 492  
 493      @Override
 494      public void setPasswordResetHandlers(List&lt;PasswordUpdatedHandler&gt; passwordResetHandlers) {
 495          this.passwordResetHandlers = passwordResetHandlers;
 496      }
 497  
 498      @Override
 499      public List&lt;PasswordUpdatedHandler&gt; getPasswordChangedHandlers() {
 500          return passwordChangedHandlers;
 501      }
 502  
 503      @Override
 504      public void setPasswordChangedHandlers(List&lt;PasswordUpdatedHandler&gt; passwordChangedHandlers) {
 505          this.passwordChangedHandlers = passwordChangedHandlers;
 506      }
 507  
 508      @Override
 509      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 510      public GenericResponse sendForgotUsernameNotification(String emailAddress) {
 511          GenericResponse response = new GenericResponse();
 512          List&lt;Customer&gt; customers = null;
 513          if (emailAddress != null) {
 514              customers = customerDao.readCustomersByEmail(emailAddress);
 515          }
 516  
 517          if (CollectionUtils.isEmpty(customers)) {
 518              response.addErrorCode(&quot;notFound&quot;);
 519          } else {
 520              List&lt;String&gt; activeUsernames = new ArrayList&lt;String&gt;();
 521              for (Customer customer : customers) {
 522                  if (!customer.isDeactivated()) {
 523                      activeUsernames.add(customer.getUsername());
 524                  }
 525              }
 526  
 527              if (activeUsernames.size() &gt; 0) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 528 -                HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 529 -                vars.put(&quot;userNames&quot;, activeUsernames);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 530 -                sendEmail(emailAddress, getForgotUsernameEmailInfo(), vars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 531 +                eventPublisher.publishEvent(new ForgotUsernameEvent(this, emailAddress, activeUsernames));</span>
 532              } else {
 533                  // send inactive username found email.
 534                  response.addErrorCode(&quot;inactiveUser&quot;);
 535              }
 536          }
 537          return response;
 538      }
 539  
 540      @Override
 541      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 542      public GenericResponse sendForgotPasswordNotification(String username, String resetPasswordUrl) {
 543          GenericResponse response = new GenericResponse();
 544          Customer customer = null;
 545  
 546          if (username != null) {
 547              customer = customerDao.readCustomerByUsername(username);
 548          }
 549  
 550          checkCustomer(customer, response);
 551  
 552          if (!response.getHasErrors()) {
 553              String token = PasswordUtils.generateSecurePassword(getPasswordTokenLength());
 554              token = token.toLowerCase();
 555  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 556 -            Object salt = getSalt(customer, token);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 557 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 558 -            String saltString = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 559 -            if (salt != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 560 -                saltString = Hex.encodeHexString(salt.toString().getBytes());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 561 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 562 -</span>
 563              CustomerForgotPasswordSecurityToken fpst = new CustomerForgotPasswordSecurityTokenImpl();
 564              fpst.setCustomerId(customer.getId());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 565 -            fpst.setToken(encodePass(token, saltString));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 566 +            fpst.setToken(encodePassword(token));</span>
 567              fpst.setCreateDate(SystemTime.asDate());
 568              customerForgotPasswordSecurityTokenDao.saveToken(fpst);
 569  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 570 -            if (usingDeprecatedPasswordEncoder() &amp;&amp; saltString != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 571 -                token = token + &#x27;-&#x27; + saltString;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 572 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 573 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 574 -            HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 575 -            vars.put(&quot;token&quot;, token);</span>
 576              if (!StringUtils.isEmpty(resetPasswordUrl)) {
 577                  if (resetPasswordUrl.contains(&quot;?&quot;)) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 578 -                    resetPasswordUrl = resetPasswordUrl + &quot;&amp;token=&quot; + token;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 579 +                    resetPasswordUrl = resetPasswordUrl+&quot;&amp;token=&quot;+token;</span>
 580                  } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 581 -                    resetPasswordUrl = resetPasswordUrl + &quot;?token=&quot; + token;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 582 +                    resetPasswordUrl = resetPasswordUrl+&quot;?token=&quot;+token;</span>
 583                  }
 584              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 585 -            vars.put(&quot;resetPasswordUrl&quot;, resetPasswordUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 586 -            sendEmail(customer.getEmailAddress(), getForgotPasswordEmailInfo(), vars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 587 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 588 +            eventPublisher.publishEvent(new ForgotPasswordEvent(this, customer.getId(), token, resetPasswordUrl));</span>
 589          }
 590          return response;
 591      }
 592  
 593      @Override
 594      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
 595      public GenericResponse sendForcedPasswordChangeNotification(String username, String resetPasswordUrl) {
 596          return sendForgotPasswordNotification(username, resetPasswordUrl);
 597      }
 598  
 599      @Deprecated
 600      @Override
 601      public GenericResponse checkPasswordResetToken(String token) {
 602          if (!usingDeprecatedPasswordEncoder()) {
 603              // We cannot proceed without a Customer when using the new PasswordEncoder
 604              throw new NoSuchBeanDefinitionException(&quot;This method requires the deprecated PasswordEncoder bean&quot;);
 605          }
 606          return checkPasswordResetToken(token, null);
 607      }
 608  
 609      @Override
 610      public GenericResponse checkPasswordResetToken(String token, Customer customer) {
 611          GenericResponse response = new GenericResponse();
 612          checkPasswordResetToken(token, customer, response);
 613          return response;
 614      }
 615  
<abbr title=" 616      protected CustomerForgotPasswordSecurityToken checkPasswordResetToken(String token, Customer customer, GenericResponse response) {"> 616      protected CustomerForgotPasswordSecurityToken checkPasswordResetToken(String token, Customer customer, GenericðŸ”µ</abbr>
 617          if (StringUtils.isBlank(token)) {
 618              response.addErrorCode(&quot;invalidToken&quot;);
 619          }
 620  
 621          String rawToken = token;
 622          String salt = null;
 623  
 624          if (usingDeprecatedPasswordEncoder()) {
 625              String[] tokens = token.split(&quot;-&quot;);
 626              if (tokens.length &gt; 2) {
 627                  response.addErrorCode(&quot;invalidToken&quot;);
 628              } else {
 629                  rawToken = tokens[0].toLowerCase();
 630                  if (tokens.length == 2) {
 631                      salt = tokens[1];
 632                  }
 633              }
 634          }
 635  
 636          CustomerForgotPasswordSecurityToken fpst = null;
 637          if (!response.getHasErrors()) {
 638              if (customer == null) {
 639                  if (!usingDeprecatedPasswordEncoder()) {
 640                      // customer can only be null when supporting use of the legacy PasswordEncoder
 641                      response.addErrorCode(&quot;invalidCustomer&quot;);
 642                  } else {
<abbr title=" 643                      fpst = customerForgotPasswordSecurityTokenDao.readToken(passwordEncoder.encodePassword(rawToken, salt));"> 643                      fpst = customerForgotPasswordSecurityTokenDao.readToken(passwordEncoder.encodePassword(rawTokeðŸ”µ</abbr>
 644                  }

 645              } else {
<abbr title=" 646                  List&lt;CustomerForgotPasswordSecurityToken&gt; fpstoks = customerForgotPasswordSecurityTokenDao.readUnusedTokensByCustomerId(customer.getId());"> 646                  List&lt;CustomerForgotPasswordSecurityToken&gt; fpstoks = customerForgotPasswordSecurityTokenDao.readUnuðŸ”µ</abbr>
 647                  for (CustomerForgotPasswordSecurityToken fpstok : fpstoks) {
 648                      if (isPassValid(rawToken, fpstok.getToken(), salt)) {

 649                          fpst = fpstok;
 650                          break;
 651                      }
 652                  }
 653              }
 654              if (fpst == null) {
 655                  response.addErrorCode(&quot;invalidToken&quot;);
 656              } else if (fpst.isTokenUsedFlag()) {
 657                  response.addErrorCode(&quot;tokenUsed&quot;);
 658              } else if (isTokenExpired(fpst)) {
 659                  response.addErrorCode(&quot;tokenExpired&quot;);
 660              }
 661          }
 662          return fpst;
 663      }
 664  
 665      @Override
 666      @Transactional(TransactionUtils.DEFAULT_TRANSACTION_MANAGER)
<abbr title=" 667      public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPassword) {"> 667      public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPðŸ”µ</abbr>
 668          GenericResponse response = new GenericResponse();
 669          Customer customer = null;
 670          if (username != null) {
 671              customer = customerDao.readCustomerByUsername(username);
 672          }
 673          checkCustomer(customer, response);
 674          checkPassword(password, confirmPassword, response);
 675          CustomerForgotPasswordSecurityToken fpst = checkPasswordResetToken(token, customer, response);
 676  
 677          if (!response.getHasErrors()) {
 678              if (!customer.getId().equals(fpst.getCustomerId())) {
 679                  if (LOG.isWarnEnabled()) {
<abbr title=" 680                      LOG.warn(&quot;Password reset attempt tried with mismatched customer and token &quot; + customer.getId() + &quot;, &quot; + StringUtil.sanitize(token));"> 680                      LOG.warn(&quot;Password reset attempt tried with mismatched customer and token &quot; + customer.getId()ðŸ”µ</abbr>
 681                  }
 682                  response.addErrorCode(&quot;invalidToken&quot;);
 683              }
 684          }
 685  
 686          if (!response.getHasErrors()) {
 687              customer.setUnencodedPassword(password);
 688              customer.setPasswordChangeRequired(false);
 689              saveCustomer(customer);
 690              invalidateAllTokensForCustomer(customer);
 691          }
 692  
 693          return response;
 694      }
 695  
 696      protected void invalidateAllTokensForCustomer(Customer customer) {
<abbr title=" 697          List&lt;CustomerForgotPasswordSecurityToken&gt; tokens = customerForgotPasswordSecurityTokenDao.readUnusedTokensByCustomerId(customer.getId());"> 697          List&lt;CustomerForgotPasswordSecurityToken&gt; tokens = customerForgotPasswordSecurityTokenDao.readUnusedTokensðŸ”µ</abbr>
 698          for (CustomerForgotPasswordSecurityToken token : tokens) {
 699              token.setTokenUsedFlag(true);
 700              customerForgotPasswordSecurityTokenDao.saveToken(token);
 701          }
 702      }
 703  
 704      protected void checkCustomer(Customer customer, GenericResponse response) {
 705          if (customer == null) {
 706              response.addErrorCode(&quot;invalidCustomer&quot;);
 707          } else if (StringUtils.isBlank(customer.getEmailAddress())) {
 708              response.addErrorCode(&quot;emailNotFound&quot;);
 709          } else if (customer.isDeactivated()) {
 710              response.addErrorCode(&quot;inactiveUser&quot;);
 711          }
 712      }
 713  
 714      protected void checkPassword(String password, String confirmPassword, GenericResponse response) {
 715          if (StringUtils.isBlank(password) || StringUtils.isBlank(confirmPassword)) {
 716              response.addErrorCode(&quot;invalidPassword&quot;);
 717          } else if (!password.equals(confirmPassword)) {
 718              response.addErrorCode(&quot;passwordMismatch&quot;);
 719          }
 720      }
 721  
 722      protected boolean isTokenExpired(CustomerForgotPasswordSecurityToken fpst) {
 723          Date now = SystemTime.asDate();
 724          long currentTimeInMillis = now.getTime();
 725          long tokenSaveTimeInMillis = fpst.getCreateDate().getTime();
 726          long minutesSinceSave = (currentTimeInMillis - tokenSaveTimeInMillis) / 60000;
 727          return minutesSinceSave &gt; tokenExpiredMinutes;
 728      }
 729  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 730 -    protected void sendEmail(String emailAddress, EmailInfo emailInfo, Map&lt;String, Object&gt; props) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 731 -        emailService.sendTemplateEmail(emailAddress, emailInfo, props);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 732 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 733 -</span>
 734      public int getTokenExpiredMinutes() {
 735          return tokenExpiredMinutes;
 736      }
 737  
 738      public void setTokenExpiredMinutes(int tokenExpiredMinutes) {
 739          this.tokenExpiredMinutes = tokenExpiredMinutes;
 740      }
 741  
 742      public int getPasswordTokenLength() {
 743          return passwordTokenLength;
 744      }
 745  
 746      public void setPasswordTokenLength(int passwordTokenLength) {
 747          this.passwordTokenLength = passwordTokenLength;
 748      }
 749  

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 750 -    public EmailInfo getForgotPasswordEmailInfo() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 751 -        return forgotPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 752 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 753 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 754 -    public void setForgotPasswordEmailInfo(EmailInfo forgotPasswordEmailInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 755 -        this.forgotPasswordEmailInfo = forgotPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 756 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 757 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 758 -    public EmailInfo getForgotUsernameEmailInfo() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 759 -        return forgotUsernameEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 760 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 761 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 762 -    public void setForgotUsernameEmailInfo(EmailInfo forgotUsernameEmailInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 763 -        this.forgotUsernameEmailInfo = forgotUsernameEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 764 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 765 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 766 -    public EmailInfo getRegistrationEmailInfo() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 767 -        return registrationEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 768 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 769 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 770 -    public void setRegistrationEmailInfo(EmailInfo registrationEmailInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 771 -        this.registrationEmailInfo = registrationEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 772 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 773 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 774 -    public EmailInfo getChangePasswordEmailInfo() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 775 -        return changePasswordEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 776 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 777 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 778 -    public void setChangePasswordEmailInfo(EmailInfo changePasswordEmailInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 779 -        this.changePasswordEmailInfo = changePasswordEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 780 -    }</span>
 781  
 782      @Deprecated
 783      protected boolean usingDeprecatedPasswordEncoder() {
 784          return passwordEncoder != null;
 785      }
 786  
 787      @Override
 788      public List&lt;Customer&gt; readBatchCustomers(int start, int pageSize) {
 789          return customerDao.readBatchCustomers(start, pageSize);
 790      }
 791  
 792      @Override
 793      public Long readNumberOfCustomers() {
 794          return customerDao.readNumberOfCustomers();
 795      }
 796  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            