<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>135</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    135
                    <a href="134.html">prev</a>
                    <a href="136.html">next</a>
                    <a href="135_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_7428c4d038363290d1a1a253552b709df5d5ebcb_Simplenote/src/main/java/com/automattic/simplenote/NoteMarkdownFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;7428c4d038363290d1a1a253552b709df5d5ebcb:Simplenote/src/main/java/com/automattic/simplenote/NoteMarkdownFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;7428c4d038363290d1a1a253552b709df5d5ebcb^1:Simplenote/src/main/java/com/automattic/simplenote/NoteMarkdownFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;7428c4d038363290d1a1a253552b709df5d5ebcb^2:Simplenote/src/main/java/com/automattic/simplenote/NoteMarkdownFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;e1d7aa5181efabb67e0c3c0de85f788cc7efcfcf:Simplenote/src/main/java/com/automattic/simplenote/NoteMarkdownFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.os.AsyncTask;
   4 import android.os.Bundle;
   5 import android.view.LayoutInflater;
   6 import android.view.Menu;
   7 import android.view.MenuInflater;
   8 import android.view.MenuItem;
   9 import android.view.View;
  10 import android.view.ViewGroup;
  11 import android.webkit.WebResourceRequest;
  12 import android.webkit.WebView;
  13 import android.webkit.WebViewClient;
  14 
  15 import androidx.annotation.NonNull;
  16 import androidx.core.view.MenuCompat;
  17 import androidx.fragment.app.Fragment;
  18 import androidx.fragment.app.FragmentActivity;
  19 
  20 import com.automattic.simplenote.models.Note;
  21 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import com.automattic.simplenote.utils.BrowserUtils;</span>
  23 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import com.automattic.simplenote.utils.ContextUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import com.automattic.simplenote.utils.DrawableUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import com.automattic.simplenote.utils.NoteUtils;</span>
  27 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import com.automattic.simplenote.utils.AppLog;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import com.automattic.simplenote.utils.AppLog.Type;</span>
  30 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  31 import com.automattic.simplenote.utils.ContextUtils;
  32 import com.automattic.simplenote.utils.DrawableUtils;
  33 import com.automattic.simplenote.utils.NetworkUtils;
  34 import com.automattic.simplenote.utils.NoteUtils;
  35 import com.automattic.simplenote.utils.SimplenoteLinkify;
  36 import com.automattic.simplenote.utils.ThemeUtils;
  37 import com.commonsware.cwac.anddown.AndDown;
  38 import com.google.android.material.snackbar.Snackbar;
  39 import com.simperium.client.Bucket;
  40 import com.simperium.client.BucketObjectMissingException;
  41 
  42 import java.lang.ref.SoftReference;
  43 
  44 import static com.automattic.simplenote.utils.SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX;
  45 
  46 public class NoteMarkdownFragment extends Fragment implements Bucket.Listener&lt;Note&gt; {
  47     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  48 
  49     private Bucket&lt;Note&gt; mNotesBucket;
  50     private Note mNote;
  51     private String mCss;
  52     private WebView mMarkdown;
  53     private boolean mIsLoadingNote;
  54 
  55     @Override
  56     public void onCreateOptionsMenu(@NonNull Menu menu, @NonNull MenuInflater inflater) {
  57         inflater.inflate(R.menu.note_markdown, menu);
  58         MenuCompat.setGroupDividerEnabled(menu, true);
  59 
  60         DrawableUtils.tintMenuWithAttribute(
  61             requireContext(),
  62             menu,
  63             R.attr.toolbarIconColor
  64         );
  65 
  66         for (int i = 0; i &lt; menu.size(); i++) {
  67             MenuItem item = menu.getItem(i);
  68             DrawableUtils.setMenuItemAlpha(item, 0.3);  // 0.3 is 30% opacity.
  69         }
  70 
  71         if (mNote != null) {
  72             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_info);
  73             viewPublishedNoteItem.setVisible(true);
  74             MenuItem trashItem = menu.findItem(R.id.menu_trash);
  75 
  76             if (mNote.isDeleted()) {
  77                 trashItem.setTitle(R.string.restore);
  78             } else {
  79                 trashItem.setTitle(R.string.trash);
  80             }
  81 
  82             DrawableUtils.tintMenuItemWithAttribute(getActivity(), trashItem, R.attr.toolbarIconColor);
  83         }
  84 
  85         super.onCreateOptionsMenu(menu, inflater);
  86     }
  87 
  88     @Override
<abbr title="  89     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {">  89     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceSðŸ”µ</abbr>
  90         AppLog.add(Type.SCREEN, &quot;Created (NoteMarkdownFragment)&quot;);
  91         mNotesBucket = ((Simplenote) requireActivity().getApplication()).getNotesBucket();
  92 
  93         // Load note if we were passed an ID.
  94         Bundle arguments = getArguments();
  95 
  96         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
  97             String key = arguments.getString(ARG_ITEM_ID);
  98             new LoadNoteTask(this).executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
  99         }
 100 
 101         setHasOptionsMenu(true);
 102         View layout = inflater.inflate(R.layout.fragment_note_markdown, container, false);
 103         mMarkdown = layout.findViewById(R.id.markdown);
 104         mMarkdown.setWebViewClient(
 105             new WebViewClient() {
 106                 @Override
 107                 public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request){
 108                     String url = request.getUrl().toString();
 109 
 110                     if (url.startsWith(SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX)){
<abbr title=" 111                         SimplenoteLinkify.openNote(requireActivity(), url.replace(SIMPLENOTE_LINK_PREFIX, &quot;&quot;));"> 111                         SimplenoteLinkify.openNote(requireActivity(), url.replace(SIMPLENOTE_LINK_PREFIX,ðŸ”µ</abbr>
 112                     } else {
 113                         BrowserUtils.launchBrowserOrShowError(requireContext(), url);
 114                     }
 115 
 116                     return true;
 117                 }
 118             }
 119         );
 120         mCss = ThemeUtils.isLightTheme(requireContext())
 121             ? ContextUtils.readCssFile(requireContext(), &quot;light.css&quot;)
 122             : ContextUtils.readCssFile(requireContext(), &quot;dark.css&quot;);
 123         return layout;
 124     }
 125 
 126     @Override
 127     public boolean onOptionsItemSelected(@NonNull MenuItem item) {
 128         switch (item.getItemId()) {
 129             case android.R.id.home:
 130                 if (!isAdded()) {
 131                     return false;
 132                 }
 133 
 134                 requireActivity().finish();
 135                 return true;
 136             case R.id.menu_trash:
 137                 if (!isAdded()) {
 138                     return false;
 139                 }
 140 
 141                 deleteNote();
 142                 return true;
 143             case R.id.menu_copy_internal:
 144                 if (!isAdded()) {
 145                     return false;
 146                 }
 147 
<abbr title=" 148                 if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitle(mNote.getTitle(), mNote.getSimperiumKey()))) {"> 148                 if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitleðŸ”µ</abbr>
 149                     Snackbar.make(mMarkdown, R.string.link_copied, Snackbar.LENGTH_SHORT).show();
 150                 } else {
 151                     Snackbar.make(mMarkdown, R.string.link_copied_failure, Snackbar.LENGTH_SHORT).show();
 152                 }
 153 
 154                 return true;
 155             default:
 156                 return super.onOptionsItemSelected(item);
 157         }
 158     }
 159 
 160     private void deleteNote() {
 161         NoteUtils.deleteNote(mNote, getActivity());
 162         requireActivity().finish();
 163     }
 164 
 165     @Override
 166     public void onPrepareOptionsMenu(@NonNull Menu menu) {
 167         // Disable share and delete actions until note is loaded.
 168         if (mIsLoadingNote) {
 169             menu.findItem(R.id.menu_trash).setEnabled(false);
 170         } else {
 171             menu.findItem(R.id.menu_trash).setEnabled(true);
 172         }
 173 
 174         MenuItem pinItem = menu.findItem(R.id.menu_pin);
 175         MenuItem publishItem = menu.findItem(R.id.menu_publish);
 176         MenuItem copyLinkItem = menu.findItem(R.id.menu_copy);
 177         MenuItem markdownItem = menu.findItem(R.id.menu_markdown);
 178         MenuItem copyLinkInternalItem = menu.findItem(R.id.menu_copy_internal);
 179 
 180         if (mNote != null) {
 181             pinItem.setChecked(mNote.isPinned());
 182             publishItem.setChecked(mNote.isPublished());
 183             markdownItem.setChecked(mNote.isMarkdownEnabled());
 184         }
 185 
 186         pinItem.setEnabled(false);
 187         publishItem.setEnabled(false);
 188         copyLinkItem.setEnabled(false);
 189         markdownItem.setEnabled(false);
 190         copyLinkInternalItem.setEnabled(true);
 191 
 192         super.onPrepareOptionsMenu(menu);
 193     }
 194 
 195     @Override
 196     public void onDestroy() {
 197         super.onDestroy();
 198         mNotesBucket.removeListener(this);
 199         mNotesBucket.stop();
 200         AppLog.add(Type.SYNC, &quot;Stopped note bucket (NoteMarkdownFragment)&quot;);
 201         AppLog.add(Type.SCREEN, &quot;Destroyed (NoteMarkdownFragment)&quot;);
 202     }
 203 
 204     @Override
 205     public void onResume() {
 206         super.onResume();
 207         mNotesBucket.start();
 208         AppLog.add(Type.SYNC, &quot;Started note bucket (NoteMarkdownFragment)&quot;);
 209         mNotesBucket.addListener(this);
 210         AppLog.add(Type.NETWORK, NetworkUtils.getNetworkInfo(requireContext()));
 211         AppLog.add(Type.SCREEN, &quot;Resumed (NoteMarkdownFragment)&quot;);
 212     }
 213 
 214     @Override
 215     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 216     }
 217 
 218     @Override
 219     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note note) {
 220     }
 221 
 222     @Override
 223     public void onNetworkChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 224     }
 225 
 226     @Override
 227     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note note) {
 228         if (note.equals(mNote)) {
 229             mNote = note;
 230             requireActivity().invalidateOptionsMenu();
 231         }
 232 
 233         AppLog.add(
 234             Type.SYNC,
 235             &quot;Saved note callback in NoteMarkdownFragment (ID: &quot; + note.getSimperiumKey() +
 236                 &quot; / Title: &quot; + note.getTitle() +
 237                 &quot; / Characters: &quot; + NoteUtils.getCharactersCount(note.getContent()) +
 238                 &quot; / Words: &quot; + NoteUtils.getWordCount(note.getContent()) + &quot;)&quot;
 239         );
 240     }
 241 
 242     public void updateMarkdown(String text) {
<abbr title=" 243         mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;, null);"> 243         mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;ðŸ”µ</abbr>
 244     }
 245 
 246     public static String getMarkdownFormattedContent(String cssContent, String sourceContent) {
 247         String header = &quot;&lt;html&gt;&lt;head&gt;&quot; +
 248                 &quot;&lt;link href=\&quot;https://fonts.googleapis.com/css?family=Noto+Serif\&quot; rel=\&quot;stylesheet\&quot;&gt;&quot; +
 249                 cssContent + &quot;&lt;/head&gt;&lt;body&gt;&quot;;
 250 
 251         String parsedMarkdown = new AndDown().markdownToHtml(
 252                 sourceContent,
 253                 AndDown.HOEDOWN_EXT_STRIKETHROUGH | AndDown.HOEDOWN_EXT_FENCED_CODE |
 254                         AndDown.HOEDOWN_EXT_QUOTE | AndDown.HOEDOWN_EXT_TABLES,
 255                 AndDown.HOEDOWN_HTML_ESCAPE
 256         );
 257 
 258         // Set auto alignment for lists, tables, and quotes based on language of start.
 259         parsedMarkdown = parsedMarkdown
 260                 .replaceAll(&quot;&lt;ol&gt;&quot;, &quot;&lt;ol dir=\&quot;auto\&quot;&gt;&quot;)
 261                 .replaceAll(&quot;&lt;ul&gt;&quot;, &quot;&lt;ul dir=\&quot;auto\&quot;&gt;&quot;)
 262                 .replaceAll(&quot;&lt;table&gt;&quot;, &quot;&lt;table dir=\&quot;auto\&quot;&gt;&quot;)
 263                 .replaceAll(&quot;&lt;blockquote&gt;&quot;, &quot;&lt;blockquote dir=\&quot;auto\&quot;&gt;&quot;);
 264 
 265         return header + &quot;&lt;div class=\&quot;note-detail-markdown\&quot;&gt;&quot; + parsedMarkdown +
 266                 &quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
 267     }
 268 
 269     private static class LoadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 270         private SoftReference&lt;NoteMarkdownFragment&gt; mNoteMarkdownFragmentReference;
 271 
 272         private LoadNoteTask(NoteMarkdownFragment context) {
 273             mNoteMarkdownFragmentReference = new SoftReference&lt;&gt;(context);
 274         }
 275 
 276         @Override
 277         protected void onPreExecute() {
 278             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 279             fragment.mIsLoadingNote = true;
 280         }
 281 
 282         @Override
 283         protected Void doInBackground(String... args) {
 284             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 285             FragmentActivity activity = fragment.getActivity();
 286 
 287             if (activity == null) {
 288                 return null;
 289             }
 290 
 291             String noteID = args[0];
 292             Simplenote application = (Simplenote) activity.getApplication();
 293             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 294 
 295             try {
 296                 fragment.mNote = notesBucket.get(noteID);
 297             } catch (BucketObjectMissingException exception) {
 298                 // TODO: Handle a missing note
 299             }
 300 
 301             return null;
 302         }
 303 
 304         @Override
 305         protected void onPostExecute(Void nada) {
 306             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 307             fragment.mIsLoadingNote = false;
 308             fragment.requireActivity().invalidateOptionsMenu();
 309         }
 310     }
 311 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.os.AsyncTask;
   4 import android.os.Bundle;
   5 import android.view.LayoutInflater;
   6 import android.view.Menu;
   7 import android.view.MenuInflater;
   8 import android.view.MenuItem;
   9 import android.view.View;
  10 import android.view.ViewGroup;
  11 import android.webkit.WebResourceRequest;
  12 import android.webkit.WebView;
  13 import android.webkit.WebViewClient;
  14 
  15 import androidx.annotation.NonNull;
  16 import androidx.core.view.MenuCompat;
  17 import androidx.fragment.app.Fragment;
  18 import androidx.fragment.app.FragmentActivity;
  19 
  20 import com.automattic.simplenote.models.Note;
  21 import com.automattic.simplenote.utils.BrowserUtils;
  22 import com.automattic.simplenote.utils.AppLog;
  23 import com.automattic.simplenote.utils.AppLog.Type;
  24 import com.automattic.simplenote.utils.ContextUtils;
  25 import com.automattic.simplenote.utils.DrawableUtils;
  26 import com.automattic.simplenote.utils.NetworkUtils;
  27 import com.automattic.simplenote.utils.NoteUtils;
  28 import com.automattic.simplenote.utils.SimplenoteLinkify;
  29 import com.automattic.simplenote.utils.ThemeUtils;
  30 import com.commonsware.cwac.anddown.AndDown;
  31 import com.google.android.material.snackbar.Snackbar;
  32 import com.simperium.client.Bucket;
  33 import com.simperium.client.BucketObjectMissingException;
  34 
  35 import java.lang.ref.SoftReference;
  36 
  37 import static com.automattic.simplenote.utils.SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX;
  38 
  39 public class NoteMarkdownFragment extends Fragment implements Bucket.Listener&lt;Note&gt; {
  40     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  41 
  42     private Bucket&lt;Note&gt; mNotesBucket;
  43     private Note mNote;
  44     private String mCss;
  45     private WebView mMarkdown;
  46     private boolean mIsLoadingNote;
  47 
  48     @Override
  49     public void onCreateOptionsMenu(@NonNull Menu menu, @NonNull MenuInflater inflater) {
  50         inflater.inflate(R.menu.note_markdown, menu);
  51         MenuCompat.setGroupDividerEnabled(menu, true);
  52 
  53         DrawableUtils.tintMenuWithAttribute(
  54             requireContext(),
  55             menu,
  56             R.attr.toolbarIconColor
  57         );
  58 
  59         for (int i = 0; i &lt; menu.size(); i++) {
  60             MenuItem item = menu.getItem(i);
  61             DrawableUtils.setMenuItemAlpha(item, 0.3);  // 0.3 is 30% opacity.
  62         }
  63 
  64         if (mNote != null) {
  65             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_info);
  66             viewPublishedNoteItem.setVisible(true);
  67             MenuItem trashItem = menu.findItem(R.id.menu_trash);
  68 
  69             if (mNote.isDeleted()) {
  70                 trashItem.setTitle(R.string.restore);
  71             } else {
  72                 trashItem.setTitle(R.string.trash);
  73             }
  74 
  75             DrawableUtils.tintMenuItemWithAttribute(getActivity(), trashItem, R.attr.toolbarIconColor);
  76         }
  77 
  78         super.onCreateOptionsMenu(menu, inflater);
  79     }
  80 
  81     @Override
<abbr title="  82     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {">  82     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceSðŸ”µ</abbr>
  83         AppLog.add(Type.SCREEN, &quot;Created (NoteMarkdownFragment)&quot;);
  84         mNotesBucket = ((Simplenote) requireActivity().getApplication()).getNotesBucket();
  85 
  86         // Load note if we were passed an ID.
  87         Bundle arguments = getArguments();
  88 
  89         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
  90             String key = arguments.getString(ARG_ITEM_ID);
  91             new LoadNoteTask(this).executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
  92         }
  93 
  94         setHasOptionsMenu(true);
  95         View layout = inflater.inflate(R.layout.fragment_note_markdown, container, false);
  96         mMarkdown = layout.findViewById(R.id.markdown);
  97         mMarkdown.setWebViewClient(
  98             new WebViewClient() {
  99                 @Override
 100                 public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request){
 101                     String url = request.getUrl().toString();
 102 
 103                     if (url.startsWith(SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX)){
<abbr title=" 104                         SimplenoteLinkify.openNote(requireActivity(), url.replace(SIMPLENOTE_LINK_PREFIX, &quot;&quot;));"> 104                         SimplenoteLinkify.openNote(requireActivity(), url.replace(SIMPLENOTE_LINK_PREFIX,ðŸ”µ</abbr>
 105                     } else {
 106                         BrowserUtils.launchBrowserOrShowError(requireContext(), url);
 107                     }
 108 
 109                     return true;
 110                 }
 111             }
 112         );
 113         mCss = ThemeUtils.isLightTheme(requireContext())
 114                 ? ContextUtils.readCssFile(requireContext(), &quot;light.css&quot;)
 115                 : ContextUtils.readCssFile(requireContext(), &quot;dark.css&quot;);
 116         return layout;
 117     }
 118 
 119     @Override
 120     public boolean onOptionsItemSelected(@NonNull MenuItem item) {
 121         switch (item.getItemId()) {
 122             case android.R.id.home:
 123                 if (!isAdded()) {
 124                     return false;
 125                 }
 126 
 127                 requireActivity().finish();
 128                 return true;
 129             case R.id.menu_trash:
 130                 if (!isAdded()) {
 131                     return false;
 132                 }
 133 
 134                 deleteNote();
 135                 return true;
 136             case R.id.menu_copy_internal:
 137                 if (!isAdded()) {
 138                     return false;
 139                 }
 140 
<abbr title=" 141                 if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitle(mNote.getTitle(), mNote.getSimperiumKey()))) {"> 141                 if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitleðŸ”µ</abbr>
 142                     Snackbar.make(mMarkdown, R.string.link_copied, Snackbar.LENGTH_SHORT).show();
 143                 } else {
 144                     Snackbar.make(mMarkdown, R.string.link_copied_failure, Snackbar.LENGTH_SHORT).show();
 145                 }
 146 
 147                 return true;
 148             default:
 149                 return super.onOptionsItemSelected(item);
 150         }
 151     }
 152 
 153     private void deleteNote() {
 154         NoteUtils.deleteNote(mNote, getActivity());
 155         requireActivity().finish();
 156     }
 157 
 158     @Override
 159     public void onPrepareOptionsMenu(@NonNull Menu menu) {
 160         // Disable share and delete actions until note is loaded.
 161         if (mIsLoadingNote) {
 162             menu.findItem(R.id.menu_trash).setEnabled(false);
 163         } else {
 164             menu.findItem(R.id.menu_trash).setEnabled(true);
 165         }
 166 
 167         MenuItem pinItem = menu.findItem(R.id.menu_pin);
 168         MenuItem publishItem = menu.findItem(R.id.menu_publish);
 169         MenuItem copyLinkItem = menu.findItem(R.id.menu_copy);
 170         MenuItem markdownItem = menu.findItem(R.id.menu_markdown);
 171         MenuItem copyLinkInternalItem = menu.findItem(R.id.menu_copy_internal);
 172 
 173         if (mNote != null) {
 174             pinItem.setChecked(mNote.isPinned());
 175             publishItem.setChecked(mNote.isPublished());
 176             markdownItem.setChecked(mNote.isMarkdownEnabled());
 177         }
 178 
 179         pinItem.setEnabled(false);
 180         publishItem.setEnabled(false);
 181         copyLinkItem.setEnabled(false);
 182         markdownItem.setEnabled(false);
 183         copyLinkInternalItem.setEnabled(true);
 184 
 185         super.onPrepareOptionsMenu(menu);
 186     }
 187 
 188     @Override
 189     public void onDestroy() {
 190         super.onDestroy();
 191         mNotesBucket.removeListener(this);
 192         mNotesBucket.stop();
 193         AppLog.add(Type.SYNC, &quot;Stopped note bucket (NoteMarkdownFragment)&quot;);
 194         AppLog.add(Type.SCREEN, &quot;Destroyed (NoteMarkdownFragment)&quot;);
 195     }
 196 
 197     @Override
 198     public void onResume() {
 199         super.onResume();
 200         mNotesBucket.start();
 201         AppLog.add(Type.SYNC, &quot;Started note bucket (NoteMarkdownFragment)&quot;);
 202         mNotesBucket.addListener(this);
 203         AppLog.add(Type.NETWORK, NetworkUtils.getNetworkInfo(requireContext()));
 204         AppLog.add(Type.SCREEN, &quot;Resumed (NoteMarkdownFragment)&quot;);
 205     }
 206 
 207     @Override
 208     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 209     }
 210 
 211     @Override
 212     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note note) {
 213     }
 214 
 215     @Override
 216     public void onNetworkChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 217     }
 218 
 219     @Override
 220     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note note) {
 221         if (note.equals(mNote)) {
 222             mNote = note;
 223             requireActivity().invalidateOptionsMenu();
 224         }
 225 
 226         AppLog.add(
 227             Type.SYNC,
 228             &quot;Saved note callback in NoteMarkdownFragment (ID: &quot; + note.getSimperiumKey() +
 229                 &quot; / Title: &quot; + note.getTitle() +
 230                 &quot; / Characters: &quot; + NoteUtils.getCharactersCount(note.getContent()) +
 231                 &quot; / Words: &quot; + NoteUtils.getWordCount(note.getContent()) + &quot;)&quot;
 232         );
 233     }
 234 
 235     public void updateMarkdown(String text) {
<abbr title=" 236         mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;, null);"> 236         mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;ðŸ”µ</abbr>
 237     }
 238 
 239     public static String getMarkdownFormattedContent(String cssContent, String sourceContent) {
 240         String header = &quot;&lt;html&gt;&lt;head&gt;&quot; +
 241                 &quot;&lt;link href=\&quot;https://fonts.googleapis.com/css?family=Noto+Serif\&quot; rel=\&quot;stylesheet\&quot;&gt;&quot; +
 242                 cssContent + &quot;&lt;/head&gt;&lt;body&gt;&quot;;
 243 
 244         String parsedMarkdown = new AndDown().markdownToHtml(
 245                 sourceContent,
 246                 AndDown.HOEDOWN_EXT_STRIKETHROUGH | AndDown.HOEDOWN_EXT_FENCED_CODE |
 247                         AndDown.HOEDOWN_EXT_QUOTE | AndDown.HOEDOWN_EXT_TABLES,
 248                 AndDown.HOEDOWN_HTML_ESCAPE
 249         );
 250 
 251         // Set auto alignment for lists, tables, and quotes based on language of start.
 252         parsedMarkdown = parsedMarkdown
 253                 .replaceAll(&quot;&lt;ol&gt;&quot;, &quot;&lt;ol dir=\&quot;auto\&quot;&gt;&quot;)
 254                 .replaceAll(&quot;&lt;ul&gt;&quot;, &quot;&lt;ul dir=\&quot;auto\&quot;&gt;&quot;)
 255                 .replaceAll(&quot;&lt;table&gt;&quot;, &quot;&lt;table dir=\&quot;auto\&quot;&gt;&quot;)
 256                 .replaceAll(&quot;&lt;blockquote&gt;&quot;, &quot;&lt;blockquote dir=\&quot;auto\&quot;&gt;&quot;);
 257 
 258         return header + &quot;&lt;div class=\&quot;note-detail-markdown\&quot;&gt;&quot; + parsedMarkdown +
 259                 &quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
 260     }
 261 
 262     private static class LoadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 263         private SoftReference&lt;NoteMarkdownFragment&gt; mNoteMarkdownFragmentReference;
 264 
 265         private LoadNoteTask(NoteMarkdownFragment context) {
 266             mNoteMarkdownFragmentReference = new SoftReference&lt;&gt;(context);
 267         }
 268 
 269         @Override
 270         protected void onPreExecute() {
 271             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 272             fragment.mIsLoadingNote = true;
 273         }
 274 
 275         @Override
 276         protected Void doInBackground(String... args) {
 277             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 278             FragmentActivity activity = fragment.getActivity();
 279 
 280             if (activity == null) {
 281                 return null;
 282             }
 283 
 284             String noteID = args[0];
 285             Simplenote application = (Simplenote) activity.getApplication();
 286             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 287 
 288             try {
 289                 fragment.mNote = notesBucket.get(noteID);
 290             } catch (BucketObjectMissingException exception) {
 291                 // TODO: Handle a missing note
 292             }
 293 
 294             return null;
 295         }
 296 
 297         @Override
 298         protected void onPostExecute(Void nada) {
 299             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 300             fragment.mIsLoadingNote = false;
 301             fragment.requireActivity().invalidateOptionsMenu();
 302         }
 303     }
 304 }
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.os.AsyncTask;
   4 import android.os.Bundle;
   5 import android.view.LayoutInflater;
   6 import android.view.Menu;
   7 import android.view.MenuInflater;
   8 import android.view.MenuItem;
   9 import android.view.View;
  10 import android.view.ViewGroup;
  11 import android.webkit.WebResourceRequest;
  12 import android.webkit.WebView;
  13 import android.webkit.WebViewClient;
  14 import androidx.annotation.NonNull;
  15 import androidx.core.view.MenuCompat;
  16 import androidx.fragment.app.Fragment;
  17 import androidx.fragment.app.FragmentActivity;
  18 import com.automattic.simplenote.models.Note;
  19 import com.automattic.simplenote.utils.AppLog.Type;
  20 import com.automattic.simplenote.utils.AppLog;
  21 import com.automattic.simplenote.utils.BrowserUtils;
  22 import com.automattic.simplenote.utils.ContextUtils;
  23 import com.automattic.simplenote.utils.DrawableUtils;
  24 import com.automattic.simplenote.utils.NetworkUtils;
  25 import com.automattic.simplenote.utils.NoteUtils;
  26 import com.automattic.simplenote.utils.SimplenoteLinkify;
  27 import com.automattic.simplenote.utils.ThemeUtils;
  28 import com.commonsware.cwac.anddown.AndDown;
  29 import com.google.android.material.snackbar.Snackbar;
  30 import com.simperium.client.Bucket;
  31 import com.simperium.client.BucketObjectMissingException;
  32 import java.lang.ref.SoftReference;
  33 import static com.automattic.simplenote.utils.SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX;
  34 
  35 
  36 public class NoteMarkdownFragment extends Fragment implements Bucket.Listener&lt;Note&gt; {
  37     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  38 
  39     private Bucket&lt;Note&gt; mNotesBucket;
  40 
  41     private Note mNote;
  42 
  43     private String mCss;
  44 
  45     private WebView mMarkdown;
  46 
  47     private boolean mIsLoadingNote;
  48 
  49     @Override
  50     public void onCreateOptionsMenu(@NonNull Menu menu, @NonNull MenuInflater inflater) {
  51         inflater.inflate(R.menu.note_markdown, menu);
  52         MenuCompat.setGroupDividerEnabled(menu, true);
  53 
  54         DrawableUtils.tintMenuWithAttribute(
  55             requireContext(),
  56             menu,
  57             R.attr.toolbarIconColor
  58         );
  59 
  60         for (int i = 0; i &lt; menu.size(); i++) {
  61             MenuItem item = menu.getItem(i);
  62             DrawableUtils.setMenuItemAlpha(item, 0.3);  // 0.3 is 30% opacity.
  63         }
  64 
  65         if (mNote != null) {
  66             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_info);
  67             viewPublishedNoteItem.setVisible(true);
  68             MenuItem trashItem = menu.findItem(R.id.menu_trash);
  69 
  70             if (mNote.isDeleted()) {
  71                 trashItem.setTitle(R.string.restore);
  72             } else {
  73                 trashItem.setTitle(R.string.trash);
  74             }
  75 
  76             DrawableUtils.tintMenuItemWithAttribute(getActivity(), trashItem, R.attr.toolbarIconColor);
  77         }
  78 
  79         super.onCreateOptionsMenu(menu, inflater);
  80     }
  81 
  82     @Override
  83     public View onCreateView(@NonNull
  84     LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
  85         AppLog.add(Type.SCREEN, &quot;Created (NoteMarkdownFragment)&quot;);
  86         mNotesBucket = ((Simplenote) (requireActivity().getApplication())).getNotesBucket();
  87         // Load note if we were passed an ID.
  88         Bundle arguments = getArguments();
  89         if ((arguments != null) &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
  90             String key = arguments.getString(ARG_ITEM_ID);
  91             new LoadNoteTask(this).executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
  92         }
  93         setHasOptionsMenu(true);
  94         View layout = inflater.inflate(R.layout.fragment_note_markdown, container, false);
  95         mMarkdown = layout.findViewById(R.id.markdown);
  96         mMarkdown.setWebViewClient(new WebViewClient() {
  97             @Override
  98             public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
  99                 String url = request.getUrl().toString();
 100                 if (url.startsWith(SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX)) {
<abbr title=" 101                     SimplenoteLinkify.openNote(requireActivity(), url.replace(SIMPLENOTE_LINK_PREFIX, &quot;&quot;));"> 101                     SimplenoteLinkify.openNote(requireActivity(), url.replace(SIMPLENOTE_LINK_PREFIX, &quot;&quot;)ðŸ”µ</abbr>
 102                 } else {
 103                     BrowserUtils.launchBrowserOrShowError(requireContext(), url);
 104                 }
 105                 return true;
 106             }
 107         });
<abbr title=" 108         mCss = (ThemeUtils.isLightTheme(requireContext())) ? ContextUtils.readCssFile(requireContext(), &quot;light.css&quot;) : ContextUtils.readCssFile(requireContext(), &quot;dark.css&quot;);"> 108         mCss = (ThemeUtils.isLightTheme(requireContext())) ? ContextUtils.readCssFile(requireContext(), &quot;ðŸ”µ</abbr>
 109         return layout;
 110     }
 111 
 112     @Override
 113     public boolean onOptionsItemSelected(@NonNull
 114     MenuItem item) {
 115         switch (item.getItemId()) {
 116             case android.R.id.home :
 117                 if (!isAdded()) {
 118                     return false;
 119                 }
 120                 requireActivity().finish();
 121                 return true;
 122             case R.id.menu_trash :
 123                 if (!isAdded()) {
 124                     return false;
 125                 }
 126                 deleteNote();
 127                 return true;
 128             case R.id.menu_copy_internal :
 129                 if (!isAdded()) {
 130                     return false;
 131                 }
<abbr title=" 132                 if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitle(mNote.getTitle(), mNote.getSimperiumKey()))) {"> 132                 if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitleðŸ”µ</abbr>
 133                     Snackbar.make(mMarkdown, R.string.link_copied, Snackbar.LENGTH_SHORT).show();
 134                 } else {
 135                     Snackbar.make(mMarkdown, R.string.link_copied_failure, Snackbar.LENGTH_SHORT).show();
 136                 }
 137                 return true;
 138             default :
 139                 return super.onOptionsItemSelected(item);
 140         }
 141     }
 142 
 143     private void deleteNote() {
 144         NoteUtils.deleteNote(mNote, getActivity());
 145         requireActivity().finish();
 146     }
 147 
 148     @Override
 149     public void onPrepareOptionsMenu(@NonNull
 150     Menu menu) {
 151         // Disable share and delete actions until note is loaded.
 152         if (mIsLoadingNote) {
 153             menu.findItem(R.id.menu_trash).setEnabled(false);
 154         } else {
 155             menu.findItem(R.id.menu_trash).setEnabled(true);
 156         }
 157         MenuItem pinItem = menu.findItem(R.id.menu_pin);
 158         MenuItem publishItem = menu.findItem(R.id.menu_publish);
 159         MenuItem copyLinkItem = menu.findItem(R.id.menu_copy);
 160         MenuItem markdownItem = menu.findItem(R.id.menu_markdown);
 161         MenuItem copyLinkInternalItem = menu.findItem(R.id.menu_copy_internal);
 162         if (mNote != null) {
 163             pinItem.setChecked(mNote.isPinned());
 164             publishItem.setChecked(mNote.isPublished());
 165             markdownItem.setChecked(mNote.isMarkdownEnabled());
 166         }
 167         pinItem.setEnabled(false);
 168         publishItem.setEnabled(false);
 169         copyLinkItem.setEnabled(false);
 170         markdownItem.setEnabled(false);
 171         copyLinkInternalItem.setEnabled(true);
 172         super.onPrepareOptionsMenu(menu);
 173     }
 174 
 175     @Override
 176     public void onDestroy() {
 177         super.onDestroy();
 178         mNotesBucket.removeListener(this);
 179         mNotesBucket.stop();
 180         AppLog.add(Type.SYNC, &quot;Stopped note bucket (NoteMarkdownFragment)&quot;);
 181         AppLog.add(Type.SCREEN, &quot;Destroyed (NoteMarkdownFragment)&quot;);
 182     }
 183 
 184     @Override
 185     public void onResume() {
 186         super.onResume();
 187         mNotesBucket.start();
 188         AppLog.add(Type.SYNC, &quot;Started note bucket (NoteMarkdownFragment)&quot;);
 189         mNotesBucket.addListener(this);
 190         AppLog.add(Type.NETWORK, NetworkUtils.getNetworkInfo(requireContext()));
 191         AppLog.add(Type.SCREEN, &quot;Resumed (NoteMarkdownFragment)&quot;);
 192     }
 193 
 194     @Override
 195     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 196     }
 197 
 198     @Override
 199     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note note) {
 200     }
 201 
 202     @Override
 203     public void onNetworkChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 204     }
 205 
 206     @Override
 207     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note note) {
 208         if (note.equals(mNote)) {
 209             mNote = note;
 210             requireActivity().invalidateOptionsMenu();
 211         }
<abbr title=" 212         AppLog.add(Type.SYNC, (((((((&quot;Saved note callback in NoteMarkdownFragment (ID: &quot; + note.getSimperiumKey()) + &quot; / Title: &quot;) + note.getTitle()) + &quot; / Characters: &quot;) + NoteUtils.getCharactersCount(note.getContent())) + &quot; / Words: &quot;) + NoteUtils.getWordCount(note.getContent())) + &quot;)&quot;);"> 212         AppLog.add(Type.SYNC, (((((((&quot;Saved note callback in NoteMarkdownFragment (ID: &quot; + note.getSimperðŸ”µ</abbr>
 213     }
 214 
 215     public void updateMarkdown(String text) {
<abbr title=" 216         mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;, null);"> 216         mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;ðŸ”µ</abbr>
 217     }
 218 
 219     public static String getMarkdownFormattedContent(String cssContent, String sourceContent) {
 220         String header = &quot;&lt;html&gt;&lt;head&gt;&quot; +
 221                 &quot;&lt;link href=\&quot;https://fonts.googleapis.com/css?family=Noto+Serif\&quot; rel=\&quot;stylesheet\&quot;&gt;&quot; +
 222                 cssContent + &quot;&lt;/head&gt;&lt;body&gt;&quot;;
 223 
 224         String parsedMarkdown = new AndDown().markdownToHtml(
 225                 sourceContent,
 226                 AndDown.HOEDOWN_EXT_STRIKETHROUGH | AndDown.HOEDOWN_EXT_FENCED_CODE |
 227                         AndDown.HOEDOWN_EXT_QUOTE | AndDown.HOEDOWN_EXT_TABLES,
 228                 AndDown.HOEDOWN_HTML_ESCAPE
 229         );
 230 
 231         // Set auto alignment for lists, tables, and quotes based on language of start.
 232         parsedMarkdown = parsedMarkdown
 233                 .replaceAll(&quot;&lt;ol&gt;&quot;, &quot;&lt;ol dir=\&quot;auto\&quot;&gt;&quot;)
 234                 .replaceAll(&quot;&lt;ul&gt;&quot;, &quot;&lt;ul dir=\&quot;auto\&quot;&gt;&quot;)
 235                 .replaceAll(&quot;&lt;table&gt;&quot;, &quot;&lt;table dir=\&quot;auto\&quot;&gt;&quot;)
 236                 .replaceAll(&quot;&lt;blockquote&gt;&quot;, &quot;&lt;blockquote dir=\&quot;auto\&quot;&gt;&quot;);
 237 
 238         return header + &quot;&lt;div class=\&quot;note-detail-markdown\&quot;&gt;&quot; + parsedMarkdown +
 239                 &quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
 240     }
 241 
 242     private static class LoadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 243         private SoftReference&lt;NoteMarkdownFragment&gt; mNoteMarkdownFragmentReference;
 244 
 245         private LoadNoteTask(NoteMarkdownFragment context) {
 246             mNoteMarkdownFragmentReference = new SoftReference&lt;&gt;(context);
 247         }
 248 
 249         @Override
 250         protected void onPreExecute() {
 251             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 252             fragment.mIsLoadingNote = true;
 253         }
 254 
 255         @Override
 256         protected Void doInBackground(String... args) {
 257             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 258             FragmentActivity activity = fragment.getActivity();
 259             if (activity == null) {
 260                 return null;
 261             }
 262             String noteID = args[0];
 263             Simplenote application = ((Simplenote) (activity.getApplication()));
 264             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 265             try {
 266                 fragment.mNote = notesBucket.get(noteID);
 267             } catch (BucketObjectMissingException exception) {
 268                 // TODO: Handle a missing note
 269             }
 270             return null;
 271         }
 272 
 273         @Override
 274         protected void onPostExecute(Void nada) {
 275             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 276             fragment.mIsLoadingNote = false;
 277             fragment.requireActivity().invalidateOptionsMenu();
 278         }
 279     }
 280 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.os.AsyncTask;
   4  import android.os.Bundle;
   5  import android.view.LayoutInflater;
   6  import android.view.Menu;
   7  import android.view.MenuInflater;
   8  import android.view.MenuItem;
   9  import android.view.View;
  10  import android.view.ViewGroup;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 +import android.webkit.WebResourceRequest;</span>
  12  import android.webkit.WebView;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 +import android.webkit.WebViewClient;</span>
  14  
  15  import androidx.annotation.NonNull;
  16  import androidx.core.view.MenuCompat;
  17  import androidx.fragment.app.Fragment;
  18  import androidx.fragment.app.FragmentActivity;
  19  
  20  import com.automattic.simplenote.models.Note;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import com.automattic.simplenote.utils.BrowserUtils;</span>

  22  import com.automattic.simplenote.utils.ContextUtils;
  23  import com.automattic.simplenote.utils.DrawableUtils;

  24  import com.automattic.simplenote.utils.NoteUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import com.automattic.simplenote.utils.SimplenoteLinkify;</span>
  26  import com.automattic.simplenote.utils.ThemeUtils;
  27  import com.commonsware.cwac.anddown.AndDown;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import com.google.android.material.snackbar.Snackbar;</span>
  29  import com.simperium.client.Bucket;
  30  import com.simperium.client.BucketObjectMissingException;
  31  
  32  import java.lang.ref.SoftReference;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import static com.automattic.simplenote.utils.SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX;</span>
  35  
  36  public class NoteMarkdownFragment extends Fragment implements Bucket.Listener&lt;Note&gt; {
  37      public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  38  
  39      private Bucket&lt;Note&gt; mNotesBucket;
  40      private Note mNote;
  41      private String mCss;
  42      private WebView mMarkdown;
  43      private boolean mIsLoadingNote;
  44  
  45      @Override
  46      public void onCreateOptionsMenu(@NonNull Menu menu, @NonNull MenuInflater inflater) {
  47          inflater.inflate(R.menu.note_markdown, menu);
  48          MenuCompat.setGroupDividerEnabled(menu, true);
  49  
  50          DrawableUtils.tintMenuWithAttribute(
  51              requireContext(),
  52              menu,
  53              R.attr.toolbarIconColor
  54          );
  55  
  56          for (int i = 0; i &lt; menu.size(); i++) {
  57              MenuItem item = menu.getItem(i);
  58              DrawableUtils.setMenuItemAlpha(item, 0.3);  // 0.3 is 30% opacity.
  59          }
  60  
  61          if (mNote != null) {
  62              MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_info);
  63              viewPublishedNoteItem.setVisible(true);
  64              MenuItem trashItem = menu.findItem(R.id.menu_trash);
  65  
  66              if (mNote.isDeleted()) {
  67                  trashItem.setTitle(R.string.restore);
  68              } else {
  69                  trashItem.setTitle(R.string.trash);
  70              }
  71  
  72              DrawableUtils.tintMenuItemWithAttribute(getActivity(), trashItem, R.attr.toolbarIconColor);
  73          }
  74  
  75          super.onCreateOptionsMenu(menu, inflater);
  76      }
  77  
  78      @Override
  79      public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {

  80          mNotesBucket = ((Simplenote) requireActivity().getApplication()).getNotesBucket();
  81  
  82          // Load note if we were passed an ID.
  83          Bundle arguments = getArguments();
  84  
  85          if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
  86              String key = arguments.getString(ARG_ITEM_ID);
  87              new LoadNoteTask(this).executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
  88          }
  89  
  90          setHasOptionsMenu(true);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -        mCss = ThemeUtils.isLightTheme(requireContext())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -                ? ContextUtils.readCssFile(requireContext(), &quot;light.css&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -                : ContextUtils.readCssFile(requireContext(), &quot;dark.css&quot;);</span>
  94          View layout = inflater.inflate(R.layout.fragment_note_markdown, container, false);
  95          mMarkdown = layout.findViewById(R.id.markdown);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +        mMarkdown.setWebViewClient(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +            new WebViewClient() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +                @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +                public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +                    String url = request.getUrl().toString();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +                    if (url.startsWith(SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +                        SimplenoteLinkify.openNote(requireActivity(), url.replace(SIMPLENOTE_LINK_PREFIX, &quot;&quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +                    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +                        BrowserUtils.launchBrowserOrShowError(requireContext(), url);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +                    return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +        );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +        mCss = ThemeUtils.isLightTheme(requireContext())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +            ? ContextUtils.readCssFile(requireContext(), &quot;light.css&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +            : ContextUtils.readCssFile(requireContext(), &quot;dark.css&quot;);</span>
 115          return layout;
 116      }
 117  
 118      @Override
 119      public boolean onOptionsItemSelected(@NonNull MenuItem item) {
 120          switch (item.getItemId()) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +            case android.R.id.home:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +                if (!isAdded()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +                    return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +                requireActivity().finish();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +                return true;</span>
 128              case R.id.menu_trash:
 129                  if (!isAdded()) {
 130                      return false;
 131                  }
 132  
 133                  deleteNote();
 134                  return true;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -            case android.R.id.home:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +            case R.id.menu_copy_internal:</span>
 137                  if (!isAdded()) {
 138                      return false;
 139                  }
 140  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -                requireActivity().finish();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 142 +                if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitle(mNote.getTitle(), mNote.getSimperiumKey()))) {"> 142 +                if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitle(mNote.geðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +                    Snackbar.make(mMarkdown, R.string.link_copied, Snackbar.LENGTH_SHORT).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +                    Snackbar.make(mMarkdown, R.string.link_copied_failure, Snackbar.LENGTH_SHORT).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +</span>
 148                  return true;
 149              default:
 150                  return super.onOptionsItemSelected(item);
 151          }
 152      }
 153  
 154      private void deleteNote() {
 155          NoteUtils.deleteNote(mNote, getActivity());
 156          requireActivity().finish();
 157      }
 158  
 159      @Override
 160      public void onPrepareOptionsMenu(@NonNull Menu menu) {
 161          // Disable share and delete actions until note is loaded.
 162          if (mIsLoadingNote) {
 163              menu.findItem(R.id.menu_trash).setEnabled(false);
 164          } else {
 165              menu.findItem(R.id.menu_trash).setEnabled(true);
 166          }
 167  
 168          MenuItem pinItem = menu.findItem(R.id.menu_pin);
 169          MenuItem publishItem = menu.findItem(R.id.menu_publish);
 170          MenuItem copyLinkItem = menu.findItem(R.id.menu_copy);
 171          MenuItem markdownItem = menu.findItem(R.id.menu_markdown);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +        MenuItem copyLinkInternalItem = menu.findItem(R.id.menu_copy_internal);</span>
 173  
 174          if (mNote != null) {
 175              pinItem.setChecked(mNote.isPinned());
 176              publishItem.setChecked(mNote.isPublished());
 177              markdownItem.setChecked(mNote.isMarkdownEnabled());
 178          }
 179  
 180          pinItem.setEnabled(false);
 181          publishItem.setEnabled(false);
 182          copyLinkItem.setEnabled(false);
 183          markdownItem.setEnabled(false);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +        copyLinkInternalItem.setEnabled(true);</span>
 185  
 186          super.onPrepareOptionsMenu(menu);
 187      }
 188  
 189      @Override
 190      public void onDestroy() {
 191          super.onDestroy();
 192          mNotesBucket.removeListener(this);
 193          mNotesBucket.stop();


 194      }
 195  
 196      @Override
 197      public void onResume() {
 198          super.onResume();
 199          mNotesBucket.start();

 200          mNotesBucket.addListener(this);


 201      }
 202  
 203      @Override
 204      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 205      }
 206  
 207      @Override
 208      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note note) {
 209      }
 210  
 211      @Override
 212      public void onNetworkChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 213      }
 214  
 215      @Override
 216      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note note) {
 217          if (note.equals(mNote)) {
 218              mNote = note;
 219              requireActivity().invalidateOptionsMenu();
 220          }








 221      }
 222  
 223      public void updateMarkdown(String text) {
 224          mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;, null);
 225      }
 226  
 227      public static String getMarkdownFormattedContent(String cssContent, String sourceContent) {
 228          String header = &quot;&lt;html&gt;&lt;head&gt;&quot; +
 229                  &quot;&lt;link href=\&quot;https://fonts.googleapis.com/css?family=Noto+Serif\&quot; rel=\&quot;stylesheet\&quot;&gt;&quot; +
 230                  cssContent + &quot;&lt;/head&gt;&lt;body&gt;&quot;;
 231  
 232          String parsedMarkdown = new AndDown().markdownToHtml(
 233                  sourceContent,
 234                  AndDown.HOEDOWN_EXT_STRIKETHROUGH | AndDown.HOEDOWN_EXT_FENCED_CODE |
 235                          AndDown.HOEDOWN_EXT_QUOTE | AndDown.HOEDOWN_EXT_TABLES,
 236                  AndDown.HOEDOWN_HTML_ESCAPE
 237          );
 238  
 239          // Set auto alignment for lists, tables, and quotes based on language of start.
 240          parsedMarkdown = parsedMarkdown
 241                  .replaceAll(&quot;&lt;ol&gt;&quot;, &quot;&lt;ol dir=\&quot;auto\&quot;&gt;&quot;)
 242                  .replaceAll(&quot;&lt;ul&gt;&quot;, &quot;&lt;ul dir=\&quot;auto\&quot;&gt;&quot;)
 243                  .replaceAll(&quot;&lt;table&gt;&quot;, &quot;&lt;table dir=\&quot;auto\&quot;&gt;&quot;)
 244                  .replaceAll(&quot;&lt;blockquote&gt;&quot;, &quot;&lt;blockquote dir=\&quot;auto\&quot;&gt;&quot;);
 245  
 246          return header + &quot;&lt;div class=\&quot;note-detail-markdown\&quot;&gt;&quot; + parsedMarkdown +
 247                  &quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
 248      }
 249  
 250      private static class LoadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 251          private SoftReference&lt;NoteMarkdownFragment&gt; mNoteMarkdownFragmentReference;
 252  
 253          private LoadNoteTask(NoteMarkdownFragment context) {
 254              mNoteMarkdownFragmentReference = new SoftReference&lt;&gt;(context);
 255          }
 256  
 257          @Override
 258          protected void onPreExecute() {
 259              NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 260              fragment.mIsLoadingNote = true;
 261          }
 262  
 263          @Override
 264          protected Void doInBackground(String... args) {
 265              NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 266              FragmentActivity activity = fragment.getActivity();
 267  
 268              if (activity == null) {
 269                  return null;
 270              }
 271  
 272              String noteID = args[0];
 273              Simplenote application = (Simplenote) activity.getApplication();
 274              Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 275  
 276              try {
 277                  fragment.mNote = notesBucket.get(noteID);
 278              } catch (BucketObjectMissingException exception) {
 279                  // TODO: Handle a missing note
 280              }
 281  
 282              return null;
 283          }
 284  
 285          @Override
 286          protected void onPostExecute(Void nada) {
 287              NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 288              fragment.mIsLoadingNote = false;
 289              fragment.requireActivity().invalidateOptionsMenu();
 290          }
 291      }
 292  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.os.AsyncTask;
   4  import android.os.Bundle;
   5  import android.view.LayoutInflater;
   6  import android.view.Menu;
   7  import android.view.MenuInflater;
   8  import android.view.MenuItem;
   9  import android.view.View;
  10  import android.view.ViewGroup;

  11  import android.webkit.WebView;

  12  
  13  import androidx.annotation.NonNull;
  14  import androidx.core.view.MenuCompat;
  15  import androidx.fragment.app.Fragment;
  16  import androidx.fragment.app.FragmentActivity;
  17  
  18  import com.automattic.simplenote.models.Note;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +import com.automattic.simplenote.utils.AppLog;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import com.automattic.simplenote.utils.AppLog.Type;</span>
  21  import com.automattic.simplenote.utils.ContextUtils;
  22  import com.automattic.simplenote.utils.DrawableUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.automattic.simplenote.utils.NetworkUtils;</span>
  24  import com.automattic.simplenote.utils.NoteUtils;

  25  import com.automattic.simplenote.utils.ThemeUtils;
  26  import com.commonsware.cwac.anddown.AndDown;

  27  import com.simperium.client.Bucket;
  28  import com.simperium.client.BucketObjectMissingException;
  29  
  30  import java.lang.ref.SoftReference;


  31  
  32  public class NoteMarkdownFragment extends Fragment implements Bucket.Listener&lt;Note&gt; {
  33      public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  34  
  35      private Bucket&lt;Note&gt; mNotesBucket;
  36      private Note mNote;
  37      private String mCss;
  38      private WebView mMarkdown;
  39      private boolean mIsLoadingNote;
  40  
  41      @Override
  42      public void onCreateOptionsMenu(@NonNull Menu menu, @NonNull MenuInflater inflater) {
  43          inflater.inflate(R.menu.note_markdown, menu);
  44          MenuCompat.setGroupDividerEnabled(menu, true);
  45  
  46          DrawableUtils.tintMenuWithAttribute(
  47              requireContext(),
  48              menu,
  49              R.attr.toolbarIconColor
  50          );
  51  
  52          for (int i = 0; i &lt; menu.size(); i++) {
  53              MenuItem item = menu.getItem(i);
  54              DrawableUtils.setMenuItemAlpha(item, 0.3);  // 0.3 is 30% opacity.
  55          }
  56  
  57          if (mNote != null) {
  58              MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_info);
  59              viewPublishedNoteItem.setVisible(true);
  60              MenuItem trashItem = menu.findItem(R.id.menu_trash);
  61  
  62              if (mNote.isDeleted()) {
  63                  trashItem.setTitle(R.string.restore);
  64              } else {
  65                  trashItem.setTitle(R.string.trash);
  66              }
  67  
  68              DrawableUtils.tintMenuItemWithAttribute(getActivity(), trashItem, R.attr.toolbarIconColor);
  69          }
  70  
  71          super.onCreateOptionsMenu(menu, inflater);
  72      }
  73  
  74      @Override
  75      public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +        AppLog.add(Type.SCREEN, &quot;Created (NoteMarkdownFragment)&quot;);</span>
  77          mNotesBucket = ((Simplenote) requireActivity().getApplication()).getNotesBucket();
  78  
  79          // Load note if we were passed an ID.
  80          Bundle arguments = getArguments();
  81  
  82          if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
  83              String key = arguments.getString(ARG_ITEM_ID);
  84              new LoadNoteTask(this).executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
  85          }
  86  
  87          setHasOptionsMenu(true);
  88          mCss = ThemeUtils.isLightTheme(requireContext())
  89                  ? ContextUtils.readCssFile(requireContext(), &quot;light.css&quot;)
  90                  : ContextUtils.readCssFile(requireContext(), &quot;dark.css&quot;);
  91          View layout = inflater.inflate(R.layout.fragment_note_markdown, container, false);
  92          mMarkdown = layout.findViewById(R.id.markdown);



















  93          return layout;
  94      }
  95  
  96      @Override
  97      public boolean onOptionsItemSelected(@NonNull MenuItem item) {
  98          switch (item.getItemId()) {







  99              case R.id.menu_trash:
 100                  if (!isAdded()) {
 101                      return false;
 102                  }
 103  
 104                  deleteNote();
 105                  return true;
 106              case android.R.id.home:

 107                  if (!isAdded()) {
 108                      return false;
 109                  }
 110  
 111                  requireActivity().finish();






 112                  return true;
 113              default:
 114                  return super.onOptionsItemSelected(item);
 115          }
 116      }
 117  
 118      private void deleteNote() {
 119          NoteUtils.deleteNote(mNote, getActivity());
 120          requireActivity().finish();
 121      }
 122  
 123      @Override
 124      public void onPrepareOptionsMenu(@NonNull Menu menu) {
 125          // Disable share and delete actions until note is loaded.
 126          if (mIsLoadingNote) {
 127              menu.findItem(R.id.menu_trash).setEnabled(false);
 128          } else {
 129              menu.findItem(R.id.menu_trash).setEnabled(true);
 130          }
 131  
 132          MenuItem pinItem = menu.findItem(R.id.menu_pin);
 133          MenuItem publishItem = menu.findItem(R.id.menu_publish);
 134          MenuItem copyLinkItem = menu.findItem(R.id.menu_copy);
 135          MenuItem markdownItem = menu.findItem(R.id.menu_markdown);

 136  
 137          if (mNote != null) {
 138              pinItem.setChecked(mNote.isPinned());
 139              publishItem.setChecked(mNote.isPublished());
 140              markdownItem.setChecked(mNote.isMarkdownEnabled());
 141          }
 142  
 143          pinItem.setEnabled(false);
 144          publishItem.setEnabled(false);
 145          copyLinkItem.setEnabled(false);
 146          markdownItem.setEnabled(false);

 147  
 148          super.onPrepareOptionsMenu(menu);
 149      }
 150  
 151      @Override
 152      public void onDestroy() {
 153          super.onDestroy();
 154          mNotesBucket.removeListener(this);
 155          mNotesBucket.stop();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +        AppLog.add(Type.SYNC, &quot;Stopped note bucket (NoteMarkdownFragment)&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +        AppLog.add(Type.SCREEN, &quot;Destroyed (NoteMarkdownFragment)&quot;);</span>
 158      }
 159  
 160      @Override
 161      public void onResume() {
 162          super.onResume();
 163          mNotesBucket.start();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +        AppLog.add(Type.SYNC, &quot;Started note bucket (NoteMarkdownFragment)&quot;);</span>
 165          mNotesBucket.addListener(this);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +        AppLog.add(Type.NETWORK, NetworkUtils.getNetworkInfo(requireContext()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +        AppLog.add(Type.SCREEN, &quot;Resumed (NoteMarkdownFragment)&quot;);</span>
 168      }
 169  
 170      @Override
 171      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 172      }
 173  
 174      @Override
 175      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note note) {
 176      }
 177  
 178      @Override
 179      public void onNetworkChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 180      }
 181  
 182      @Override
 183      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note note) {
 184          if (note.equals(mNote)) {
 185              mNote = note;
 186              requireActivity().invalidateOptionsMenu();
 187          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +        AppLog.add(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +            Type.SYNC,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +            &quot;Saved note callback in NoteMarkdownFragment (ID: &quot; + note.getSimperiumKey() +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +                &quot; / Title: &quot; + note.getTitle() +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +                &quot; / Characters: &quot; + NoteUtils.getCharactersCount(note.getContent()) +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +                &quot; / Words: &quot; + NoteUtils.getWordCount(note.getContent()) + &quot;)&quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +        );</span>
 196      }
 197  
 198      public void updateMarkdown(String text) {
 199          mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;, null);
 200      }
 201  
 202      public static String getMarkdownFormattedContent(String cssContent, String sourceContent) {
 203          String header = &quot;&lt;html&gt;&lt;head&gt;&quot; +
 204                  &quot;&lt;link href=\&quot;https://fonts.googleapis.com/css?family=Noto+Serif\&quot; rel=\&quot;stylesheet\&quot;&gt;&quot; +
 205                  cssContent + &quot;&lt;/head&gt;&lt;body&gt;&quot;;
 206  
 207          String parsedMarkdown = new AndDown().markdownToHtml(
 208                  sourceContent,
 209                  AndDown.HOEDOWN_EXT_STRIKETHROUGH | AndDown.HOEDOWN_EXT_FENCED_CODE |
 210                          AndDown.HOEDOWN_EXT_QUOTE | AndDown.HOEDOWN_EXT_TABLES,
 211                  AndDown.HOEDOWN_HTML_ESCAPE
 212          );
 213  
 214          // Set auto alignment for lists, tables, and quotes based on language of start.
 215          parsedMarkdown = parsedMarkdown
 216                  .replaceAll(&quot;&lt;ol&gt;&quot;, &quot;&lt;ol dir=\&quot;auto\&quot;&gt;&quot;)
 217                  .replaceAll(&quot;&lt;ul&gt;&quot;, &quot;&lt;ul dir=\&quot;auto\&quot;&gt;&quot;)
 218                  .replaceAll(&quot;&lt;table&gt;&quot;, &quot;&lt;table dir=\&quot;auto\&quot;&gt;&quot;)
 219                  .replaceAll(&quot;&lt;blockquote&gt;&quot;, &quot;&lt;blockquote dir=\&quot;auto\&quot;&gt;&quot;);
 220  
 221          return header + &quot;&lt;div class=\&quot;note-detail-markdown\&quot;&gt;&quot; + parsedMarkdown +
 222                  &quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
 223      }
 224  
 225      private static class LoadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 226          private SoftReference&lt;NoteMarkdownFragment&gt; mNoteMarkdownFragmentReference;
 227  
 228          private LoadNoteTask(NoteMarkdownFragment context) {
 229              mNoteMarkdownFragmentReference = new SoftReference&lt;&gt;(context);
 230          }
 231  
 232          @Override
 233          protected void onPreExecute() {
 234              NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 235              fragment.mIsLoadingNote = true;
 236          }
 237  
 238          @Override
 239          protected Void doInBackground(String... args) {
 240              NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 241              FragmentActivity activity = fragment.getActivity();
 242  
 243              if (activity == null) {
 244                  return null;
 245              }
 246  
 247              String noteID = args[0];
 248              Simplenote application = (Simplenote) activity.getApplication();
 249              Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 250  
 251              try {
 252                  fragment.mNote = notesBucket.get(noteID);
 253              } catch (BucketObjectMissingException exception) {
 254                  // TODO: Handle a missing note
 255              }
 256  
 257              return null;
 258          }
 259  
 260          @Override
 261          protected void onPostExecute(Void nada) {
 262              NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 263              fragment.mIsLoadingNote = false;
 264              fragment.requireActivity().invalidateOptionsMenu();
 265          }
 266      }
 267  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            