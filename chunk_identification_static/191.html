<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>191</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    191
                    <a href="190.html">prev</a>
                    <a href="192.html">next</a>
                    <a href="191_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_89e275c67fd74f0edf3ff03711c8c7a4a9610791_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceUtilitiesImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceUtilitiesImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceUtilitiesImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceUtilitiesImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;a48cd6ca647e4a58cde4097171bd233ed3e8511d:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceUtilitiesImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b]], subset: [[b], [b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18 package org.broadleafcommerce.core.offer.service;                                                        </span>
<span  style="">  19                                                                                                          </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  22 import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                     </span>
<span class="-274639712180431568" onmouseenter="enter('-274639712180431568');" onmouseout="out('-274639712180431568');" style="">  23 import org.broadleafcommerce.common.money.Money;                                                         </span>
<span class="-1492144387614747576" onmouseenter="enter('-1492144387614747576');" onmouseout="out('-1492144387614747576');" style="">  24 import org.broadleafcommerce.common.service.GenericEntityService;                                        </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  25 import org.broadleafcommerce.core.offer.dao.OfferDao;                                                    </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  26 import org.broadleafcommerce.core.offer.domain.Offer;                                                    </span>
<span class="-6494010243902923492" onmouseenter="enter('-6494010243902923492');" onmouseout="out('-6494010243902923492');" style="">  27 import org.broadleafcommerce.core.offer.domain.OfferItemCriteria;                                        </span>
<span class="278382103026396276" onmouseenter="enter('278382103026396276');" onmouseout="out('278382103026396276');" style="">  28 import org.broadleafcommerce.core.offer.domain.OfferPriceData;                                           </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  29 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                           </span>
<span class="6002542247348180004" onmouseenter="enter('6002542247348180004');" onmouseout="out('6002542247348180004');" style="">  30 import org.broadleafcommerce.core.offer.service.discount.PromotionDiscount;                              </span>
<span class="180286745313216238" onmouseenter="enter('180286745313216238');" onmouseout="out('180286745313216238');" style="">  31 import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;                             </span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  32 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;            </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  33 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                   </span>
<span class="5738750158392070" onmouseenter="enter('5738750158392070');" onmouseout="out('5738750158392070');" style="">  34 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;                  </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  35 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                         </span>
<span class="-7733804833771661823" onmouseenter="enter('-7733804833771661823');" onmouseout="out('-7733804833771661823');" style="">  36 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;                     </span>
<span class="2677462620955414718" onmouseenter="enter('2677462620955414718');" onmouseout="out('2677462620955414718');" style="">  37 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;          </span>
<span class="-5097841332942556730" onmouseenter="enter('-5097841332942556730');" onmouseout="out('-5097841332942556730');" style="">  38 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;</span>
<span class="6922194440736558195" onmouseenter="enter('6922194440736558195');" onmouseout="out('6922194440736558195');" style="">  39 import org.broadleafcommerce.core.offer.service.processor.ItemOfferMarkTargets;                          </span>
<span class="-4077086760777187101" onmouseenter="enter('-4077086760777187101');" onmouseout="out('-4077086760777187101');" style="">  40 import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;                                        </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  41 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  42 import org.broadleafcommerce.core.order.domain.OrderItem;                                                </span>
<span class="-1764233193646247473" onmouseenter="enter('-1764233193646247473');" onmouseout="out('-1764233193646247473');" style="">  43 import org.broadleafcommerce.core.order.domain.OrderItemContainer;                                       </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  44 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                     </span>
<span class="573363609456981556" onmouseenter="enter('573363609456981556');" onmouseout="out('573363609456981556');" style="">  45 import org.broadleafcommerce.core.order.domain.OrderItemQualifier;                                       </span>
<span class="-3230016162556687469" onmouseenter="enter('-3230016162556687469');" onmouseout="out('-3230016162556687469');" style="">  46 import org.broadleafcommerce.core.order.domain.dto.OrderItemHolder;                                      </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  47 import org.springframework.stereotype.Service;                                                           </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">  48 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style="">  49 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import java.util.ArrayList;                                                                              </span>
<span class="2187055016371707860" onmouseenter="enter('2187055016371707860');" onmouseout="out('2187055016371707860');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import java.util.Collections;                                                                            </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  52 =======                                                                                                  </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53                                                                                                          </span>
<span class="2075466404860203191" onmouseenter="enter('2075466404860203191');" onmouseout="out('2075466404860203191');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54 import java.math.BigDecimal;                                                                             </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style="">  55 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  56 import java.util.ArrayList;                                                                              </span>
<span class="2187055016371707860" onmouseenter="enter('2187055016371707860');" onmouseout="out('2187055016371707860');" style="">  57 import java.util.Collections;                                                                            </span>
<span class="4561244361960433187" onmouseenter="enter('4561244361960433187');" onmouseout="out('4561244361960433187');" style="">  58 import java.util.Comparator;                                                                             </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  59 import java.util.HashMap;                                                                                </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  60 import java.util.Iterator;                                                                               </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  61 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  62 import java.util.Map;                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  63 import javax.annotation.Resource;                                                                        </span>
<span  style="">  64                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  65 /**                                                                                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  66  *                                                                                                       </span>
<span class="3680448680235302484" onmouseenter="enter('3680448680235302484');" onmouseout="out('3680448680235302484');" style="">  67  * @author bpolster                                                                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  68  *                                                                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  69  */                                                                                                      </span>
<span class="-7533628443457811418" onmouseenter="enter('-7533628443457811418');" onmouseout="out('-7533628443457811418');" style="">  70 @Service(&quot;blOfferServiceUtilities&quot;)                                                                      </span>
<span class="6914343992633091500" onmouseenter="enter('6914343992633091500');" onmouseout="out('6914343992633091500');" style="">  71 public class OfferServiceUtilitiesImpl implements OfferServiceUtilities {                                </span>
<span class="-7057195126687856185" onmouseenter="enter('-7057195126687856185');" onmouseout="out('-7057195126687856185');" style="">  72     protected static final Log LOG = LogFactory.getLog(OfferServiceUtilitiesImpl.class);                 </span>
<span  style="">  73                                                                                                          </span>
<span class="5938907043749528173" onmouseenter="enter('5938907043749528173');" onmouseout="out('5938907043749528173');" style="">  74     @Resource(name = &quot;blPromotableItemFactory&quot;)                                                          </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style="">  75     protected PromotableItemFactory promotableItemFactory;                                               </span>
<span  style="">  76                                                                                                          </span>
<span class="5779429748772127951" onmouseenter="enter('5779429748772127951');" onmouseout="out('5779429748772127951');" style="">  77     @Resource(name = &quot;blOfferDao&quot;)                                                                       </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  78     protected OfferDao offerDao;                                                                         </span>
<span  style="">  79                                                                                                          </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style="">  80     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                   </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style="">  81     protected OfferServiceExtensionManager extensionManager;                                             </span>
<span  style="">  82                                                                                                          </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">  83 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="-5969569842164006358" onmouseenter="enter('-5969569842164006358');" onmouseout="out('-5969569842164006358');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84     protected final PromotableOfferUtility promotableOfferUtility;                                       </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85                                                                                                          </span>
<span class="-3896079782246475371" onmouseenter="enter('-3896079782246475371');" onmouseout="out('-3896079782246475371');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86     public OfferServiceUtilitiesImpl(PromotableOfferUtility promotableOfferUtility) {                    </span>
<span class="-7394468295291059120" onmouseenter="enter('-7394468295291059120');" onmouseout="out('-7394468295291059120');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87         this.promotableOfferUtility = promotableOfferUtility;                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88     }                                                                                                    </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style="">  89 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90     @Override                                                                                            </span>
<span class="6223480568976573314" onmouseenter="enter('6223480568976573314');" onmouseout="out('6223480568976573314');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  91     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  91     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applðŸ”µ</abbr></span>
<span class="7055525017697292208" onmouseenter="enter('7055525017697292208');" onmouseout="out('7055525017697292208');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92         Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94                                                                                                          </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  95 =======                                                                                                  </span>
<span class="2258512980686044159" onmouseenter="enter('2258512980686044159');" onmouseout="out('2258512980686044159');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96     @Resource(name = &quot;blGenericEntityService&quot;)                                                           </span>
<span class="5310520372352255538" onmouseenter="enter('5310520372352255538');" onmouseout="out('5310520372352255538');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97     protected GenericEntityService entityService;                                                        </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style="">  98 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span  style="">  99                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 100     @Override                                                                                            </span>
<span class="6223480568976573314" onmouseenter="enter('6223480568976573314');" onmouseout="out('6223480568976573314');" style=""><abbr title=" 101     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {"> 101     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applðŸ”µ</abbr></span>
<span class="7055525017697292208" onmouseenter="enter('7055525017697292208');" onmouseout="out('7055525017697292208');" style=""> 102         Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 103     }                                                                                                    </span>
<span  style=""> 104                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 105     @Override                                                                                            </span>
<span class="-4185121765520276478" onmouseenter="enter('-4185121765520276478');" onmouseout="out('-4185121765520276478');" style=""><abbr title=" 106     public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {"> 106     public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean aðŸ”µ</abbr></span>
<span class="7055525017697292208" onmouseenter="enter('7055525017697292208');" onmouseout="out('7055525017697292208');" style=""> 107         Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 108     }                                                                                                    </span>
<span  style=""> 109                                                                                                          </span>
<span class="8076072330480389618" onmouseenter="enter('8076072330480389618');" onmouseout="out('8076072330480389618');" style=""><abbr title=" 110     protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyToSalePrice) {"> 110     protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyTðŸ”µ</abbr></span>
<span class="3297095837477520472" onmouseenter="enter('3297095837477520472');" onmouseout="out('3297095837477520472');" style=""> 111         return new Comparator&lt;PromotableOrderItemPriceDetail&gt;() {                                        </span>
<span  style=""> 112                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 113             @Override                                                                                    </span>
<span class="-2961106138566190059" onmouseenter="enter('-2961106138566190059');" onmouseout="out('-2961106138566190059');" style=""> 114             public int compare(PromotableOrderItemPriceDetail o1, PromotableOrderItemPriceDetail o2) {   </span>
<span class="7675869656754073027" onmouseenter="enter('7675869656754073027');" onmouseout="out('7675869656754073027');" style=""> 115                 Money price = o1.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);   </span>
<span class="-2386281537779196104" onmouseenter="enter('-2386281537779196104');" onmouseout="out('-2386281537779196104');" style=""> 116                 Money price2 = o2.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);  </span>
<span  style=""> 117                                                                                                          </span>
<span class="-7980156687270114839" onmouseenter="enter('-7980156687270114839');" onmouseout="out('-7980156687270114839');" style=""> 118                 // highest amount first                                                                  </span>
<span class="-5413989484138410778" onmouseenter="enter('-5413989484138410778');" onmouseout="out('-5413989484138410778');" style=""> 119                 return price2.compareTo(price);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 120             }                                                                                            </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 121         };                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122     }                                                                                                    </span>
<span  style=""> 123                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 124     @Override                                                                                            </span>
<span class="-6633188601276085642" onmouseenter="enter('-6633188601276085642');" onmouseout="out('-6633188601276085642');" style=""> 125     public OrderItem findRelatedQualifierRoot(OrderItem relatedQualifier) {                              </span>
<span class="1807144252798273266" onmouseenter="enter('1807144252798273266');" onmouseout="out('1807144252798273266');" style=""> 126         OrderItem relatedQualifierRoot = null;                                                           </span>
<span class="-5368473621929304561" onmouseenter="enter('-5368473621929304561');" onmouseout="out('-5368473621929304561');" style=""> 127         if (relatedQualifier != null) {                                                                  </span>
<span class="-5398594526726109873" onmouseenter="enter('-5398594526726109873');" onmouseout="out('-5398594526726109873');" style=""> 128             relatedQualifierRoot = relatedQualifier;                                                     </span>
<span class="7824588639878219390" onmouseenter="enter('7824588639878219390');" onmouseout="out('7824588639878219390');" style=""> 129             while (relatedQualifierRoot.getParentOrderItem() != null) {                                  </span>
<span class="-2176101432970038375" onmouseenter="enter('-2176101432970038375');" onmouseout="out('-2176101432970038375');" style=""> 130                 relatedQualifierRoot = relatedQualifierRoot.getParentOrderItem();                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 131             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 132         }                                                                                                </span>
<span class="-6121768564377108608" onmouseenter="enter('-6121768564377108608');" onmouseout="out('-6121768564377108608');" style=""> 133         return relatedQualifierRoot;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 134     }                                                                                                    </span>
<span  style=""> 135                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 136     @Override                                                                                            </span>
<span class="8600807536713378155" onmouseenter="enter('8600807536713378155');" onmouseout="out('8600807536713378155');" style=""><abbr title=" 137     public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; details) {"> 137     public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemðŸ”µ</abbr></span>
<span  style=""> 138                                                                                                          </span>
<span class="-4790953179105551104" onmouseenter="enter('-4790953179105551104');" onmouseout="out('-4790953179105551104');" style=""> 139         for (PromotableOrderItemPriceDetail detail : details) {                                          </span>
<span class="1975158128642033085" onmouseenter="enter('1975158128642033085');" onmouseout="out('1975158128642033085');" style=""><abbr title=" 140             for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustments()) {"> 140             for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustmentsðŸ”µ</abbr></span>
<span class="30696373439585907" onmouseenter="enter('30696373439585907');" onmouseout="out('30696373439585907');" style=""> 141                 if (adjustment.isTotalitarian() || itemOffer.getOffer().isTotalitarianOffer()) {         </span>
<span class="-7120250698956357960" onmouseenter="enter('-7120250698956357960');" onmouseout="out('-7120250698956357960');" style=""> 142                     // A totalitarian offer has already been applied or this offer is totalitarian       </span>
<span class="-7934044302077364434" onmouseenter="enter('-7934044302077364434');" onmouseout="out('-7934044302077364434');" style=""> 143                     // and another offer was already applied.                                            </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 144                     return false;                                                                        </span>
<span class="5154499828715066004" onmouseenter="enter('5154499828715066004');" onmouseout="out('5154499828715066004');" style=""><abbr title=" 145                 } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 145                 } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOfferðŸ”µ</abbr></span>
<span class="721506122397233060" onmouseenter="enter('721506122397233060');" onmouseout="out('721506122397233060');" style=""> 146                     // A nonCombinable offer has been applied or this is a non-combinable offer          </span>
<span class="1625719735315035531" onmouseenter="enter('1625719735315035531');" onmouseout="out('1625719735315035531');" style=""> 147                     // and adjustments have already been applied.                                        </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 148                     return false;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 149                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 150             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 151         }                                                                                                </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 152         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 153     }                                                                                                    </span>
<span  style=""> 154                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 155     @Override                                                                                            </span>
<span class="-3713458578644525384" onmouseenter="enter('-3713458578644525384');" onmouseout="out('-3713458578644525384');" style=""><abbr title=" 156     public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCriteria,"> 156     public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCrðŸ”µ</abbr></span>
<span class="-9206127464517457513" onmouseenter="enter('-9206127464517457513');" onmouseout="out('-9206127464517457513');" style=""> 157             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {                                         </span>
<span  style=""> 158                                                                                                          </span>
<span class="1399559222284052069" onmouseenter="enter('1399559222284052069');" onmouseout="out('1399559222284052069');" style=""> 159         sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());      </span>
<span  style=""> 160                                                                                                          </span>
<span class="-2005578619141057452" onmouseenter="enter('-2005578619141057452');" onmouseout="out('-2005578619141057452');" style=""> 161         // Calculate the number of qualifiers needed that will not receive the promotion.                </span>
<span class="-7642725860669587391" onmouseenter="enter('-7642725860669587391');" onmouseout="out('-7642725860669587391');" style=""> 162         // These will be reserved first before the target is assigned.                                   </span>
<span class="-5221545606159729582" onmouseenter="enter('-5221545606159729582');" onmouseout="out('-5221545606159729582');" style=""> 163         int qualifierQtyNeeded = itemCriteria.getQuantity();                                             </span>
<span  style=""> 164                                                                                                          </span>
<span class="-389357445740262218" onmouseenter="enter('-389357445740262218');" onmouseout="out('-389357445740262218');" style=""> 165         for (PromotableOrderItemPriceDetail detail : priceDetails) {                                     </span>
<span  style=""> 166                                                                                                          </span>
<span class="-7196228531210809782" onmouseenter="enter('-7196228531210809782');" onmouseout="out('-7196228531210809782');" style=""> 167             // Mark Qualifiers                                                                           </span>
<span class="7203543687533075574" onmouseenter="enter('7203543687533075574');" onmouseout="out('7203543687533075574');" style=""> 168             if (qualifierQtyNeeded &gt; 0) {                                                                </span>
<span class="4739725621440457335" onmouseenter="enter('4739725621440457335');" onmouseout="out('4739725621440457335');" style=""><abbr title=" 169                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 169                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(ðŸ”µ</abbr></span>
<span class="118721626032663442" onmouseenter="enter('118721626032663442');" onmouseout="out('118721626032663442');" style=""> 170                 if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {                                           </span>
<span class="156141582657617565" onmouseenter="enter('156141582657617565');" onmouseout="out('156141582657617565');" style=""><abbr title=" 171                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);"> 171                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQuaðŸ”µ</abbr></span>
<span class="-4684084580161696213" onmouseenter="enter('-4684084580161696213');" onmouseout="out('-4684084580161696213');" style=""> 172                     qualifierQtyNeeded -= qtyToMarkAsQualifier;                                          </span>
<span class="-5539919712790669425" onmouseenter="enter('-5539919712790669425');" onmouseout="out('-5539919712790669425');" style=""> 173                     detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 174                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 175             }                                                                                            </span>
<span  style=""> 176                                                                                                          </span>
<span class="8517154315660472641" onmouseenter="enter('8517154315660472641');" onmouseout="out('8517154315660472641');" style=""> 177             if (qualifierQtyNeeded == 0) {                                                               </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 178                 break;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180         }                                                                                                </span>
<span class="-4850383672896867816" onmouseenter="enter('-4850383672896867816');" onmouseout="out('-4850383672896867816');" style=""> 181         return qualifierQtyNeeded;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 182     }                                                                                                    </span>
<span  style=""> 183                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 184     @Override                                                                                            </span>
<span class="-690144452707146894" onmouseenter="enter('-690144452707146894');" onmouseout="out('-690144452707146894');" style=""> 185     public int markTargetsForCriteria(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,</span>
<span class="-7065312759813139704" onmouseenter="enter('-7065312759813139704');" onmouseout="out('-7065312759813139704');" style=""><abbr title=" 186             boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriteria,"> 186             boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriðŸ”µ</abbr></span>
<span class="2702959100637307406" onmouseenter="enter('2702959100637307406');" onmouseout="out('2702959100637307406');" style=""> 187             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, int targetQtyNeeded) {                    </span>
<span class="2114191821955736127" onmouseenter="enter('2114191821955736127');" onmouseout="out('2114191821955736127');" style=""> 188         for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {                                </span>
<span class="-5368473621929304561" onmouseenter="enter('-5368473621929304561');" onmouseout="out('-5368473621929304561');" style=""> 189             if (relatedQualifier != null) {                                                              </span>
<span class="8141493125634490263" onmouseenter="enter('8141493125634490263');" onmouseout="out('8141493125634490263');" style=""><abbr title=" 190                 // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 190                 // We need to make sure that this item is either a parent, child, or the same as the qualðŸ”µ</abbr></span>
<span class="1857856063926056091" onmouseenter="enter('1857856063926056091');" onmouseout="out('1857856063926056091');" style=""> 191                 OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();                </span>
<span class="-3127297900577673654" onmouseenter="enter('-3127297900577673654');" onmouseout="out('-3127297900577673654');" style=""><abbr title=" 192                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;"> 192                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierðŸ”µ</abbr></span>
<span class="3862062312907446706" onmouseenter="enter('3862062312907446706');" onmouseout="out('3862062312907446706');" style=""> 193                         !thisItem.equals(relatedQualifierRoot)) {                                        </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 194                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 195                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 196             }                                                                                            </span>
<span  style=""> 197                                                                                                          </span>
<span class="-3899808772905023528" onmouseenter="enter('-3899808772905023528');" onmouseout="out('-3899808772905023528');" style=""><abbr title=" 198             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);"> 198             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOðŸ”µ</abbr></span>
<span class="1240759488807976542" onmouseenter="enter('1240759488807976542');" onmouseout="out('1240759488807976542');" style=""> 199             if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {                                                  </span>
<span class="-2152892838174945575" onmouseenter="enter('-2152892838174945575');" onmouseout="out('-2152892838174945575');" style=""><abbr title=" 200                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 200                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOðŸ”µ</abbr></span>
<span class="-5766015035856187988" onmouseenter="enter('-5766015035856187988');" onmouseout="out('-5766015035856187988');" style=""> 201                     int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget); </span>
<span class="-182485827533192502" onmouseenter="enter('-182485827533192502');" onmouseout="out('-182485827533192502');" style=""> 202                     targetQtyNeeded -= qtyToMarkAsTarget;                                                </span>
<span class="-4172322390128575169" onmouseenter="enter('-4172322390128575169');" onmouseout="out('-4172322390128575169');" style=""> 203                     if (!checkOnly) {                                                                    </span>
<span class="5603549919531530635" onmouseenter="enter('5603549919531530635');" onmouseout="out('5603549919531530635');" style=""> 204                         priceDetail.addPromotionDiscount(itemOffer, itemCriteria, qtyToMarkAsTarget);    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 205                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 206                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 207             }                                                                                            </span>
<span  style=""> 208                                                                                                          </span>
<span class="5358835008623854271" onmouseenter="enter('5358835008623854271');" onmouseout="out('5358835008623854271');" style=""> 209             if (targetQtyNeeded == 0) {                                                                  </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 210                 break;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 211             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 212         }                                                                                                </span>
<span class="6491342130615381336" onmouseenter="enter('6491342130615381336');" onmouseout="out('6491342130615381336');" style=""> 213         return targetQtyNeeded;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 214     }                                                                                                    </span>
<span  style=""> 215                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 216     @Override                                                                                            </span>
<span class="1242791052414669567" onmouseenter="enter('1242791052414669567');" onmouseout="out('1242791052414669567');" style=""><abbr title=" 217     public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,"> 217     public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedðŸ”µ</abbr></span>
<span class="6750137376595998298" onmouseenter="enter('6750137376595998298');" onmouseout="out('6750137376595998298');" style=""><abbr title=" 218                                                 boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferPriceData offerPriceData,"> 218                                                 boolean checkOnly, Offer promotion, OrderItem relatedQualðŸ”µ</abbr></span>
<span class="-9206127464517457513" onmouseenter="enter('-9206127464517457513');" onmouseout="out('-9206127464517457513');" style=""> 219                                                 List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {     </span>
<span class="3726836708123429329" onmouseenter="enter('3726836708123429329');" onmouseout="out('3726836708123429329');" style=""> 220         int targetQtyNeeded = offerPriceData.getQuantity();                                              </span>
<span class="-7840883515604062637" onmouseenter="enter('-7840883515604062637');" onmouseout="out('-7840883515604062637');" style=""> 221         int minRequiredTargetQuantity = itemOffer.getMinimumRequiredTargetQuantity();                    </span>
<span class="6262197857819165625" onmouseenter="enter('6262197857819165625');" onmouseout="out('6262197857819165625');" style=""> 222         if (minRequiredTargetQuantity &gt; 1 &amp;&amp; minRequiredTargetQuantity &gt; targetQtyNeeded) {              </span>
<span class="-3324197007536454949" onmouseenter="enter('-3324197007536454949');" onmouseout="out('-3324197007536454949');" style=""> 223             targetQtyNeeded = minRequiredTargetQuantity;                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 224         }                                                                                                </span>
<span  style=""> 225                                                                                                          </span>
<span class="2114191821955736127" onmouseenter="enter('2114191821955736127');" onmouseout="out('2114191821955736127');" style=""> 226         for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {                                </span>
<span class="-5368473621929304561" onmouseenter="enter('-5368473621929304561');" onmouseout="out('-5368473621929304561');" style=""> 227             if (relatedQualifier != null) {                                                              </span>
<span class="8141493125634490263" onmouseenter="enter('8141493125634490263');" onmouseout="out('8141493125634490263');" style=""><abbr title=" 228                 // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 228                 // We need to make sure that this item is either a parent, child, or the same as the qualðŸ”µ</abbr></span>
<span class="1857856063926056091" onmouseenter="enter('1857856063926056091');" onmouseout="out('1857856063926056091');" style=""> 229                 OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();                </span>
<span class="-3127297900577673654" onmouseenter="enter('-3127297900577673654');" onmouseout="out('-3127297900577673654');" style=""><abbr title=" 230                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;"> 230                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierðŸ”µ</abbr></span>
<span class="3862062312907446706" onmouseenter="enter('3862062312907446706');" onmouseout="out('3862062312907446706');" style=""> 231                         !thisItem.equals(relatedQualifierRoot)) {                                        </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 232                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 233                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 234             }                                                                                            </span>
<span  style=""> 235                                                                                                          </span>
<span class="-3899808772905023528" onmouseenter="enter('-3899808772905023528');" onmouseout="out('-3899808772905023528');" style=""><abbr title=" 236             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);"> 236             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOðŸ”µ</abbr></span>
<span class="1240759488807976542" onmouseenter="enter('1240759488807976542');" onmouseout="out('1240759488807976542');" style=""> 237             if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {                                                  </span>
<span class="-2152892838174945575" onmouseenter="enter('-2152892838174945575');" onmouseout="out('-2152892838174945575');" style=""><abbr title=" 238                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 238                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOðŸ”µ</abbr></span>
<span class="-5766015035856187988" onmouseenter="enter('-5766015035856187988');" onmouseout="out('-5766015035856187988');" style=""> 239                     int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget); </span>
<span class="-182485827533192502" onmouseenter="enter('-182485827533192502');" onmouseout="out('-182485827533192502');" style=""> 240                     targetQtyNeeded -= qtyToMarkAsTarget;                                                </span>
<span class="-4172322390128575169" onmouseenter="enter('-4172322390128575169');" onmouseout="out('-4172322390128575169');" style=""> 241                     if (!checkOnly) {                                                                    </span>
<span class="6581474656927369870" onmouseenter="enter('6581474656927369870');" onmouseout="out('6581474656927369870');" style=""> 242                         priceDetail.addPromotionDiscount(itemOffer, null, qtyToMarkAsTarget);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 243                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 244                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 245             }                                                                                            </span>
<span  style=""> 246                                                                                                          </span>
<span class="5358835008623854271" onmouseenter="enter('5358835008623854271');" onmouseout="out('5358835008623854271');" style=""> 247             if (targetQtyNeeded == 0) {                                                                  </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 248                 break;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 249             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 250         }                                                                                                </span>
<span class="7942109921366184597" onmouseenter="enter('7942109921366184597');" onmouseout="out('7942109921366184597');" style=""> 251         return targetQtyNeeded == 0;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 252     }                                                                                                    </span>
<span  style=""> 253                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 254     @Override                                                                                            </span>
<span class="-5374453289617781014" onmouseenter="enter('-5374453289617781014');" onmouseout="out('-5374453289617781014');" style=""><abbr title=" 255     public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, PromotableOrder order,"> 255     public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, ProðŸ”µ</abbr></span>
<span class="-45453231322119310" onmouseenter="enter('-45453231322119310');" onmouseout="out('-45453231322119310');" style=""> 256             OrderItemHolder orderItemHolder, OfferItemCriteria itemCriteria,                             </span>
<span class="-532102448020563017" onmouseenter="enter('-532102448020563017');" onmouseout="out('-532102448020563017');" style=""><abbr title=" 257             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets) {"> 257             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets)ðŸ”µ</abbr></span>
<span class="1399559222284052069" onmouseenter="enter('1399559222284052069');" onmouseout="out('1399559222284052069');" style=""> 258         sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());      </span>
<span  style=""> 259                                                                                                          </span>
<span class="-2005578619141057452" onmouseenter="enter('-2005578619141057452');" onmouseout="out('-2005578619141057452');" style=""> 260         // Calculate the number of qualifiers needed that will not receive the promotion.                </span>
<span class="-7642725860669587391" onmouseenter="enter('-7642725860669587391');" onmouseout="out('-7642725860669587391');" style=""> 261         // These will be reserved first before the target is assigned.                                   </span>
<span class="-5221545606159729582" onmouseenter="enter('-5221545606159729582');" onmouseout="out('-5221545606159729582');" style=""> 262         int qualifierQtyNeeded = itemCriteria.getQuantity();                                             </span>
<span  style=""> 263                                                                                                          </span>
<span class="-389357445740262218" onmouseenter="enter('-389357445740262218');" onmouseout="out('-389357445740262218');" style=""> 264         for (PromotableOrderItemPriceDetail detail : priceDetails) {                                     </span>
<span class="-317635885918930708" onmouseenter="enter('-317635885918930708');" onmouseout="out('-317635885918930708');" style=""> 265             OrderItem oi = detail.getPromotableOrderItem().getOrderItem();                               </span>
<span  style=""> 266                                                                                                          </span>
<span class="7203543687533075574" onmouseenter="enter('7203543687533075574');" onmouseout="out('7203543687533075574');" style=""> 267             if (qualifierQtyNeeded &gt; 0) {                                                                </span>
<span class="4739725621440457335" onmouseenter="enter('4739725621440457335');" onmouseout="out('4739725621440457335');" style=""><abbr title=" 268                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 268                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(ðŸ”µ</abbr></span>
<span class="118721626032663442" onmouseenter="enter('118721626032663442');" onmouseout="out('118721626032663442');" style=""> 269                 if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {                                           </span>
<span class="-1004810985579465662" onmouseenter="enter('-1004810985579465662');" onmouseout="out('-1004810985579465662');" style=""><abbr title=" 270                     // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some state that we "> 270                     // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some sðŸ”µ</abbr></span>
<span class="8185689978075296148" onmouseenter="enter('8185689978075296148');" onmouseout="out('8185689978075296148');" style=""> 271                     // might need in the future.                                                         </span>
<span class="-1081050306738024693" onmouseenter="enter('-1081050306738024693');" onmouseout="out('-1081050306738024693');" style=""> 272                     OfferItemCriteria previousQualifierCriteria = null;                                  </span>
<span class="-8553070012108320907" onmouseenter="enter('-8553070012108320907');" onmouseout="out('-8553070012108320907');" style=""> 273                     for (PromotionQualifier possibleQualifier : detail.getPromotionQualifiers()) {       </span>
<span class="-4722657733023489778" onmouseenter="enter('-4722657733023489778');" onmouseout="out('-4722657733023489778');" style=""> 274                         if (possibleQualifier.getPromotion().equals(itemOffer.getOffer())) {             </span>
<span class="-3028735657089400229" onmouseenter="enter('-3028735657089400229');" onmouseout="out('-3028735657089400229');" style=""> 275                             previousQualifierCriteria = possibleQualifier.getItemCriteria();             </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 276                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 277                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 278                     }                                                                                    </span>
<span  style=""> 279                                                                                                          </span>
<span class="1008214769590136048" onmouseenter="enter('1008214769590136048');" onmouseout="out('1008214769590136048');" style=""> 280                     // Go ahead and mark this item as a qualifier                                        </span>
<span class="156141582657617565" onmouseenter="enter('156141582657617565');" onmouseout="out('156141582657617565');" style=""><abbr title=" 281                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);"> 281                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQuaðŸ”µ</abbr></span>
<span class="-4684084580161696213" onmouseenter="enter('-4684084580161696213');" onmouseout="out('-4684084580161696213');" style=""> 282                     qualifierQtyNeeded -= qtyToMarkAsQualifier;                                          </span>
<span class="2797159826704329425" onmouseenter="enter('2797159826704329425');" onmouseout="out('2797159826704329425');" style=""><abbr title=" 283                     PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);"> 283                     PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMaðŸ”µ</abbr></span>
<span class="-7100200875909405519" onmouseenter="enter('-7100200875909405519');" onmouseout="out('-7100200875909405519');" style=""><abbr title=" 284                     pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOffer().getApplyDiscountToSalePrice()));"> 284                     pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOfðŸ”µ</abbr></span>
<span  style=""> 285                                                                                                          </span>
<span class="6012497254282640402" onmouseenter="enter('6012497254282640402');" onmouseout="out('6012497254282640402');" style=""><abbr title=" 286                     // Now, we need to see if there exists a target(s) that is suitable for this qualifier due to"> 286                     // Now, we need to see if there exists a target(s) that is suitable for this qualifieðŸ”µ</abbr></span>
<span class="-1151958798348543907" onmouseenter="enter('-1151958798348543907');" onmouseout="out('-1151958798348543907');" style=""><abbr title=" 287                     // the relationship flag. If we are on the last qualifier required for this offer, we want to "> 287                     // the relationship flag. If we are on the last qualifier required for this offer, weðŸ”µ</abbr></span>
<span class="3987909966354550925" onmouseenter="enter('3987909966354550925');" onmouseout="out('3987909966354550925');" style=""><abbr title=" 288                     // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just want to check "> 288                     // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just wantðŸ”µ</abbr></span>
<span class="4959301888820404945" onmouseenter="enter('4959301888820404945');" onmouseout="out('4959301888820404945');" style=""> 289                     // that there is an eligible target(s) and continue on.                              </span>
<span class="-5256242047209748696" onmouseenter="enter('-5256242047209748696');" onmouseout="out('-5256242047209748696');" style=""> 290                     if (itemOfferMarkTargets.markTargets(itemOffer, order, oi, true)) {                  </span>
<span class="-297796406415044190" onmouseenter="enter('-297796406415044190');" onmouseout="out('-297796406415044190');" style=""><abbr title=" 291                         // We found a target. Let&#x27;s save this related order item used as the qualifier in case"> 291                         // We found a target. Let&#x27;s save this related order item used as the qualifier inðŸ”µ</abbr></span>
<span class="6348154252416536055" onmouseenter="enter('6348154252416536055');" onmouseout="out('6348154252416536055');" style=""> 292                         // we succeed                                                                    </span>
<span class="-6098537281436011553" onmouseenter="enter('-6098537281436011553');" onmouseout="out('-6098537281436011553');" style=""> 293                         orderItemHolder.setOrderItem(oi);                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 294                     } else {                                                                             </span>
<span class="1831842559835648517" onmouseenter="enter('1831842559835648517');" onmouseout="out('1831842559835648517');" style=""><abbr title=" 295                         // If we didn&#x27;t find a target, we need to roll back how we marked this item as a qualifier."> 295                         // If we didn&#x27;t find a target, we need to roll back how we marked this item as a ðŸ”µ</abbr></span>
<span class="-1853870893725774252" onmouseenter="enter('-1853870893725774252');" onmouseout="out('-1853870893725774252');" style=""> 296                         qualifierQtyNeeded += qtyToMarkAsQualifier;                                      </span>
<span class="-8128593861119500077" onmouseenter="enter('-8128593861119500077');" onmouseout="out('-8128593861119500077');" style=""> 297                         if (pq.getQuantity() == qtyToMarkAsQualifier) {                                  </span>
<span class="-6954079035160286378" onmouseenter="enter('-6954079035160286378');" onmouseout="out('-6954079035160286378');" style=""> 298                             detail.getPromotionQualifiers().remove(pq);                                  </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 299                         } else {                                                                         </span>
<span class="6626310861157345131" onmouseenter="enter('6626310861157345131');" onmouseout="out('6626310861157345131');" style=""> 300                             pq.setItemCriteria(previousQualifierCriteria);                               </span>
<span class="2348238745962483804" onmouseenter="enter('2348238745962483804');" onmouseout="out('2348238745962483804');" style=""> 301                             pq.setQuantity(pq.getQuantity() - qtyToMarkAsQualifier);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 302                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 303                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 304                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 305             }                                                                                            </span>
<span  style=""> 306                                                                                                          </span>
<span class="8517154315660472641" onmouseenter="enter('8517154315660472641');" onmouseout="out('8517154315660472641');" style=""> 307             if (qualifierQtyNeeded == 0) {                                                               </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 308                 break;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 309             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 310         }                                                                                                </span>
<span class="-4850383672896867816" onmouseenter="enter('-4850383672896867816');" onmouseout="out('-4850383672896867816');" style=""> 311         return qualifierQtyNeeded;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 312     }                                                                                                    </span>
<span  style=""> 313                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 314     @Override                                                                                            </span>
<span class="-5508403457222384501" onmouseenter="enter('-5508403457222384501');" onmouseout="out('-5508403457222384501');" style=""><abbr title=" 315     public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails) {"> 315     public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotabðŸ”µ</abbr></span>
<span class="-1180947180176660619" onmouseenter="enter('-1180947180176660619');" onmouseout="out('-1180947180176660619');" style=""> 316         for (PromotableOrderItemPriceDetail itemPriceDetail : itemPriceDetails) {                        </span>
<span class="-669978432390486383" onmouseenter="enter('-669978432390486383');" onmouseout="out('-669978432390486383');" style=""> 317             for (PromotionDiscount discount : itemPriceDetail.getPromotionDiscounts()) {                 </span>
<span class="-4320063668461010504" onmouseenter="enter('-4320063668461010504');" onmouseout="out('-4320063668461010504');" style=""> 318                 if (discount.getPromotion().equals(itemOffer.getOffer())) {                              </span>
<span class="-8948799313684021645" onmouseenter="enter('-8948799313684021645');" onmouseout="out('-8948799313684021645');" style=""><abbr title=" 319                     if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 319                     if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWðŸ”µ</abbr></span>
<span class="8050394734563130560" onmouseenter="enter('8050394734563130560');" onmouseout="out('8050394734563130560');" style=""> 320                         // We&#x27;ve decided to apply this adjustment but if it doesn&#x27;t actually reduce      </span>
<span class="-7936715023008804819" onmouseenter="enter('-7936715023008804819');" onmouseout="out('-7936715023008804819');" style=""> 321                         // the value of the item                                                         </span>
<span class="7229649304367309721" onmouseenter="enter('7229649304367309721');" onmouseout="out('7229649304367309721');" style=""> 322                         if (adjustmentIsNotGoodEnoughToBeApplied(itemOffer, itemPriceDetail)) {          </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 323                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 324                         }                                                                                </span>
<span  style=""> 325                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 326                     }                                                                                    </span>
<span class="-4859405226118818324" onmouseenter="enter('-4859405226118818324');" onmouseout="out('-4859405226118818324');" style=""> 327                     OrderItem orderItem = itemPriceDetail.getPromotableOrderItem().getOrderItem();       </span>
<span class="-7036726360330387930" onmouseenter="enter('-7036726360330387930');" onmouseout="out('-7036726360330387930');" style=""> 328                     Boolean offerCanApplyToChildOrderItems = itemOffer.getOffer().getApplyToChildItems();</span>
<span class="5319718821501044453" onmouseenter="enter('5319718821501044453');" onmouseout="out('5319718821501044453');" style=""> 329                     if (isAddOnOrderItem(orderItem) &amp;&amp; !offerCanApplyToChildOrderItems) {                </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 330                         break;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 331                     }                                                                                    </span>
<span class="-2464330301917486275" onmouseenter="enter('-2464330301917486275');" onmouseout="out('-2464330301917486275');" style=""> 332                     applyOrderItemAdjustment(itemOffer, itemPriceDetail);                                </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 333                     break;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 334                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 335             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 336         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 337     }                                                                                                    </span>
<span  style=""> 338                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 339     @Override                                                                                            </span>
<span class="5703716165905853432" onmouseenter="enter('5703716165905853432');" onmouseout="out('5703716165905853432');" style=""> 340     public boolean isAddOnOrderItem(OrderItem orderItem) {                                               </span>
<span class="-915100238682069401" onmouseenter="enter('-915100238682069401');" onmouseout="out('-915100238682069401');" style=""> 341         if (DiscreteOrderItem.class.isAssignableFrom(orderItem.getClass())) {                            </span>
<span class="-9161979270697696061" onmouseenter="enter('-9161979270697696061');" onmouseout="out('-9161979270697696061');" style=""> 342             DiscreteOrderItem discreteOrderItem = (DiscreteOrderItem) orderItem;                         </span>
<span  style=""> 343                                                                                                          </span>
<span class="-5356075907008875039" onmouseenter="enter('-5356075907008875039');" onmouseout="out('-5356075907008875039');" style=""> 344             Map&lt;String, String&gt; attributes = discreteOrderItem.getAdditionalAttributes();                </span>
<span class="-4907356983337991835" onmouseenter="enter('-4907356983337991835');" onmouseout="out('-4907356983337991835');" style=""> 345             boolean isAddOnOrderItem = attributes.containsKey(&quot;addOnXrefId&quot;);                            </span>
<span class="4227157952965713451" onmouseenter="enter('4227157952965713451');" onmouseout="out('4227157952965713451');" style=""> 346             boolean isChildOrderItem = discreteOrderItem.isChildOrderItem();                             </span>
<span  style=""> 347                                                                                                          </span>
<span class="8373226173169122886" onmouseenter="enter('8373226173169122886');" onmouseout="out('8373226173169122886');" style=""> 348             return isChildOrderItem &amp;&amp; isAddOnOrderItem;                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 349         }                                                                                                </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 350         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 351     }                                                                                                    </span>
<span  style=""> 352                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 353     /**                                                                                                  </span>
<span class="7835653502933924919" onmouseenter="enter('7835653502933924919');" onmouseout="out('7835653502933924919');" style=""> 354      * The adjustment might not be better than the sale price.                                           </span>
<span class="-123895333908918857" onmouseenter="enter('-123895333908918857');" onmouseout="out('-123895333908918857');" style=""> 355      * @param itemOffer                                                                                  </span>
<span class="4317834721456676207" onmouseenter="enter('4317834721456676207');" onmouseout="out('4317834721456676207');" style=""> 356      * @param detail                                                                                     </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 357      * @return                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 358      */                                                                                                  </span>
<span class="8886963584830850852" onmouseenter="enter('8886963584830850852');" onmouseout="out('8886963584830850852');" style=""> 359     protected boolean adjustmentIsNotGoodEnoughToBeApplied(PromotableCandidateItemOffer itemOffer,       </span>
<span class="-5789972309208145824" onmouseenter="enter('-5789972309208145824');" onmouseout="out('-5789972309208145824');" style=""> 360             PromotableOrderItemPriceDetail detail) {                                                     </span>
<span class="5404670390791397495" onmouseenter="enter('5404670390791397495');" onmouseout="out('5404670390791397495');" style=""> 361         if (!itemOffer.getOffer().getApplyDiscountToSalePrice()) {                                       </span>
<span class="2444901768581949268" onmouseenter="enter('2444901768581949268');" onmouseout="out('2444901768581949268');" style=""> 362             Money salePrice = detail.getPromotableOrderItem().getSalePriceBeforeAdjustments();           </span>
<span class="5875272574250045376" onmouseenter="enter('5875272574250045376');" onmouseout="out('5875272574250045376');" style=""> 363             Money retailPrice = detail.getPromotableOrderItem().getRetailPriceBeforeAdjustments();       </span>
<span class="833194282646119023" onmouseenter="enter('833194282646119023');" onmouseout="out('833194282646119023');" style=""><abbr title=" 364             Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromotableOrderItem(), 1);"> 364             Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromðŸ”µ</abbr></span>
<span class="-3042742338309722510" onmouseenter="enter('-3042742338309722510');" onmouseout="out('-3042742338309722510');" style=""> 365             if (salePrice != null) {                                                                     </span>
<span class="4776635754548450658" onmouseenter="enter('4776635754548450658');" onmouseout="out('4776635754548450658');" style=""> 366                 if (salePrice.lessThan(retailPrice.subtract(savings))) {                                 </span>
<span class="5206565982893115863" onmouseenter="enter('5206565982893115863');" onmouseout="out('5206565982893115863');" style=""> 367                     // Not good enough                                                                   </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 368                     return true;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 369                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 370             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 371         }                                                                                                </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 372         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 373     }                                                                                                    </span>
<span  style=""> 374                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 375     @Override                                                                                            </span>
<span class="-3274580905325891597" onmouseenter="enter('-3274580905325891597');" onmouseout="out('-3274580905325891597');" style=""> 376     public void applyOrderItemAdjustment(PromotableCandidateItemOffer itemOffer,                         </span>
<span class="-8798183871686674116" onmouseenter="enter('-8798183871686674116');" onmouseout="out('-8798183871686674116');" style=""> 377             PromotableOrderItemPriceDetail itemPriceDetail) {                                            </span>
<span class="-2791625561543308737" onmouseenter="enter('-2791625561543308737');" onmouseout="out('-2791625561543308737');" style=""> 378         PromotableOrderItemPriceDetailAdjustment promotableOrderItemPriceDetailAdjustment =              </span>
<span class="-1963732814850126206" onmouseenter="enter('-1963732814850126206');" onmouseout="out('-1963732814850126206');" style=""><abbr title=" 379                 promotableItemFactory.createPromotableOrderItemPriceDetailAdjustment(itemOffer, itemPriceDetail);"> 379                 promotableItemFactory.createPromotableOrderItemPriceDetailAdjustment(itemOffer, itemPriceðŸ”µ</abbr></span>
<span class="2431499017104838762" onmouseenter="enter('2431499017104838762');" onmouseout="out('2431499017104838762');" style=""> 380         //don&#x27;t want to have negative adjustments                                                        </span>
<span class="-6618345538058051679" onmouseenter="enter('-6618345538058051679');" onmouseout="out('-6618345538058051679');" style=""><abbr title=" 381         if(promotableOrderItemPriceDetailAdjustment.getRetailAdjustmentValue().lessThan(BigDecimal.ZERO) ||"> 381         if(promotableOrderItemPriceDetailAdjustment.getRetailAdjustmentValue().lessThan(BigDecimal.ZERO) ðŸ”µ</abbr></span>
<span class="7927443701435766406" onmouseenter="enter('7927443701435766406');" onmouseout="out('7927443701435766406');" style=""><abbr title=" 382                 promotableOrderItemPriceDetailAdjustment.getSaleAdjustmentValue().lessThan(BigDecimal.ZERO)){"> 382                 promotableOrderItemPriceDetailAdjustment.getSaleAdjustmentValue().lessThan(BigDecimal.ZERðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 383             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 384         }                                                                                                </span>
<span class="-452752185035923989" onmouseenter="enter('-452752185035923989');" onmouseout="out('-452752185035923989');" style=""> 385         itemPriceDetail.addCandidateItemPriceDetailAdjustment(promotableOrderItemPriceDetailAdjustment); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 386     }                                                                                                    </span>
<span  style=""> 387                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 388     @Override                                                                                            </span>
<span class="-361580458958843386" onmouseenter="enter('-361580458958843386');" onmouseout="out('-361580458958843386');" style=""> 389     public List&lt;OrderItem&gt; buildOrderItemList(Order order) {                                             </span>
<span class="4933536323910912844" onmouseenter="enter('4933536323910912844');" onmouseout="out('4933536323910912844');" style=""> 390         List&lt;OrderItem&gt; orderItemList = new ArrayList&lt;OrderItem&gt;();                                      </span>
<span class="4435196443097834597" onmouseenter="enter('4435196443097834597');" onmouseout="out('4435196443097834597');" style=""> 391         for (OrderItem currentItem : order.getOrderItems()) {                                            </span>
<span class="-2966775259995926277" onmouseenter="enter('-2966775259995926277');" onmouseout="out('-2966775259995926277');" style=""> 392             if (currentItem instanceof OrderItemContainer) {                                             </span>
<span class="5137067544827715705" onmouseenter="enter('5137067544827715705');" onmouseout="out('5137067544827715705');" style=""> 393                 OrderItemContainer container = (OrderItemContainer) currentItem;                         </span>
<span class="4382484490734880847" onmouseenter="enter('4382484490734880847');" onmouseout="out('4382484490734880847');" style=""> 394                 if (container.isPricingAtContainerLevel()) {                                             </span>
<span class="-2270489982917990854" onmouseenter="enter('-2270489982917990854');" onmouseout="out('-2270489982917990854');" style=""> 395                     orderItemList.add(currentItem);                                                      </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 396                 } else {                                                                                 </span>
<span class="112302786623021779" onmouseenter="enter('112302786623021779');" onmouseout="out('112302786623021779');" style=""> 397                     for (OrderItem containedItem : container.getOrderItems()) {                          </span>
<span class="533266059764191893" onmouseenter="enter('533266059764191893');" onmouseout="out('533266059764191893');" style=""> 398                         orderItemList.add(containedItem);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 399                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 400                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 401             } else {                                                                                     </span>
<span class="-2270489982917990854" onmouseenter="enter('-2270489982917990854');" onmouseout="out('-2270489982917990854');" style=""> 402                 orderItemList.add(currentItem);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 403             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 404         }                                                                                                </span>
<span  style=""> 405                                                                                                          </span>
<span class="1499720353589212944" onmouseenter="enter('1499720353589212944');" onmouseout="out('1499720353589212944');" style=""> 406         return orderItemList;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 407     }                                                                                                    </span>
<span  style=""> 408                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 409     @Override                                                                                            </span>
<span class="-8956803960090910177" onmouseenter="enter('-8956803960090910177');" onmouseout="out('-8956803960090910177');" style=""> 410     public Map&lt;OrderItem, PromotableOrderItem&gt; buildPromotableItemMap(PromotableOrder promotableOrder) { </span>
<span class="-2911482928816722705" onmouseenter="enter('-2911482928816722705');" onmouseout="out('-2911482928816722705');" style=""><abbr title=" 411         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderItem&gt;();"> 411         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderIteðŸ”µ</abbr></span>
<span class="4206403965644457797" onmouseenter="enter('4206403965644457797');" onmouseout="out('4206403965644457797');" style=""> 412         for (PromotableOrderItem item : promotableOrder.getAllOrderItems()) {                            </span>
<span class="-3870195952016518221" onmouseenter="enter('-3870195952016518221');" onmouseout="out('-3870195952016518221');" style=""> 413             promotableItemMap.put(item.getOrderItem(), item);                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 414         }                                                                                                </span>
<span class="8963770174585233491" onmouseenter="enter('8963770174585233491');" onmouseout="out('8963770174585233491');" style=""> 415         return promotableItemMap;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 416     }                                                                                                    </span>
<span  style=""> 417                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 418     @Override                                                                                            </span>
<span class="-8575715219777406772" onmouseenter="enter('-8575715219777406772');" onmouseout="out('-8575715219777406772');" style=""><abbr title=" 419     public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itemDetail) {"> 419     public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itðŸ”µ</abbr></span>
<span class="7467828794567286984" onmouseenter="enter('7467828794567286984');" onmouseout="out('7467828794567286984');" style=""><abbr title=" 420         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 420         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetðŸ”µ</abbr></span>
<span  style=""> 421                                                                                                          </span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 422         List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 422         List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjuðŸ”µ</abbr></span>
<span class="-1371106512285082048" onmouseenter="enter('-1371106512285082048');" onmouseout="out('-1371106512285082048');" style=""><abbr title=" 423         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {"> 423         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments())ðŸ”µ</abbr></span>
<span class="-1262630258018644876" onmouseenter="enter('-1262630258018644876');" onmouseout="out('-1262630258018644876');" style=""> 424             if (itemAdjustmentMap.containsKey(adjustment.getOffer().getId())) {                          </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 425                 if (LOG.isDebugEnabled()) {                                                              </span>
<span class="5365687806736453142" onmouseenter="enter('5365687806736453142');" onmouseout="out('5365687806736453142');" style=""><abbr title=" 426                     StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with ids &quot;)"> 426                     StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with iðŸ”µ</abbr></span>
<span class="5769765961448228869" onmouseenter="enter('5769765961448228869');" onmouseout="out('5769765961448228869');" style=""> 427                         .append(itemAdjustmentMap.get(adjustment.getOffer().getId()).getId())            </span>
<span class="7312533819175146387" onmouseenter="enter('7312533819175146387');" onmouseout="out('7312533819175146387');" style=""> 428                         .append(&quot; and &quot;)                                                                 </span>
<span class="-7531978261873044464" onmouseenter="enter('-7531978261873044464');" onmouseout="out('-7531978261873044464');" style=""> 429                         .append(adjustment.getId());                                                     </span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 430                     LOG.debug(sb.toString());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 431                 }                                                                                        </span>
<span class="5304290905678094245" onmouseenter="enter('5304290905678094245');" onmouseout="out('5304290905678094245');" style=""> 432                 adjustmentsToRemove.add(adjustment);                                                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 433             } else {                                                                                     </span>
<span class="-2602676027025933258" onmouseenter="enter('-2602676027025933258');" onmouseout="out('-2602676027025933258');" style=""> 434                 itemAdjustmentMap.put(adjustment.getOffer().getId(), adjustment);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 435             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 436         }                                                                                                </span>
<span  style=""> 437                                                                                                          </span>
<span class="-6749489598586186680" onmouseenter="enter('-6749489598586186680');" onmouseout="out('-6749489598586186680');" style=""> 438         for (OrderItemPriceDetailAdjustment adjustment : adjustmentsToRemove) {                          </span>
<span class="170302329650885695" onmouseenter="enter('170302329650885695');" onmouseout="out('170302329650885695');" style=""> 439             itemDetail.getOrderItemPriceDetailAdjustments().remove(adjustment);                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 440         }                                                                                                </span>
<span  style=""> 441                                                                                                          </span>
<span class="-1848478302592739813" onmouseenter="enter('-1848478302592739813');" onmouseout="out('-1848478302592739813');" style=""> 442         return itemAdjustmentMap;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 443     }                                                                                                    </span>
<span  style=""> 444                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 445     @Override                                                                                            </span>
<span class="7034544881417042941" onmouseenter="enter('7034544881417042941');" onmouseout="out('7034544881417042941');" style=""> 446     public void updatePriceDetail(OrderItemPriceDetail itemDetail,                                       </span>
<span class="-1090177046597316726" onmouseenter="enter('-1090177046597316726');" onmouseout="out('-1090177046597316726');" style=""> 447             PromotableOrderItemPriceDetail promotableDetail) {                                           </span>
<span class="3894635813711687840" onmouseenter="enter('3894635813711687840');" onmouseout="out('3894635813711687840');" style=""> 448         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =                                    </span>
<span class="7785105538478960936" onmouseenter="enter('7785105538478960936');" onmouseout="out('7785105538478960936');" style=""> 449                 buildItemDetailAdjustmentMap(itemDetail);                                                </span>
<span  style=""> 450                                                                                                          </span>
<span class="8052115462234529390" onmouseenter="enter('8052115462234529390');" onmouseout="out('8052115462234529390');" style=""> 451         if (itemDetail.getQuantity() != promotableDetail.getQuantity()) {                                </span>
<span class="8615443511774170500" onmouseenter="enter('8615443511774170500');" onmouseout="out('8615443511774170500');" style=""> 452             itemDetail.setQuantity(promotableDetail.getQuantity());                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 453         }                                                                                                </span>
<span  style=""> 454                                                                                                          </span>
<span class="-7750740315935940052" onmouseenter="enter('-7750740315935940052');" onmouseout="out('-7750740315935940052');" style=""> 455         if (promotableDetail.isAdjustmentsFinalized()) {                                                 </span>
<span class="8693299076047883645" onmouseenter="enter('8693299076047883645');" onmouseout="out('8693299076047883645');" style=""> 456             itemDetail.setUseSalePrice(promotableDetail.useSaleAdjustments());                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 457         }                                                                                                </span>
<span  style=""> 458                                                                                                          </span>
<span class="-200913113255250114" onmouseenter="enter('-200913113255250114');" onmouseout="out('-200913113255250114');" style=""><abbr title=" 459         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjustments()) {"> 459         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjusðŸ”µ</abbr></span>
<span class="6578727718670889454" onmouseenter="enter('6578727718670889454');" onmouseout="out('6578727718670889454');" style=""><abbr title=" 460             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferId());"> 460             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferIðŸ”µ</abbr></span>
<span class="-5676819544918869237" onmouseenter="enter('-5676819544918869237');" onmouseout="out('-5676819544918869237');" style=""> 461             if (itemAdjustment != null) {                                                                </span>
<span class="2095963063095688848" onmouseenter="enter('2095963063095688848');" onmouseout="out('2095963063095688848');" style=""> 462                 // Update existing adjustment                                                            </span>
<span class="4997906471413856597" onmouseenter="enter('4997906471413856597');" onmouseout="out('4997906471413856597');" style=""> 463                 if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {                </span>
<span class="-7190567157504063803" onmouseenter="enter('-7190567157504063803');" onmouseout="out('-7190567157504063803');" style=""> 464                     updateItemAdjustment(itemAdjustment, adjustment);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 465                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 466             } else {                                                                                     </span>
<span class="-3662936612993896923" onmouseenter="enter('-3662936612993896923');" onmouseout="out('-3662936612993896923');" style=""> 467                 // Add a new adjustment                                                                  </span>
<span class="6730722799913825373" onmouseenter="enter('6730722799913825373');" onmouseout="out('6730722799913825373');" style=""> 468                 final OrderItemPriceDetailAdjustment newItemAdjustment;                                  </span>
<span class="-3180324819813272445" onmouseenter="enter('-3180324819813272445');" onmouseout="out('-3180324819813272445');" style=""> 469                 ExtensionResultHolder resultHolder = new ExtensionResultHolder();                        </span>
<span  style=""> 470                                                                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 471                 if (extensionManager != null) {                                                          </span>
<span class="4841855343164111630" onmouseenter="enter('4841855343164111630');" onmouseout="out('4841855343164111630');" style=""> 472                     extensionManager.createOrderItemPriceDetailAdjustment(resultHolder, itemDetail);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 473                 }                                                                                        </span>
<span class="3886522200438865522" onmouseenter="enter('3886522200438865522');" onmouseout="out('3886522200438865522');" style=""><abbr title=" 474                 if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetailAdjustment&quot;)) {"> 474                 if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetaiðŸ”µ</abbr></span>
<span class="-3287798826483764260" onmouseenter="enter('-3287798826483764260');" onmouseout="out('-3287798826483764260');" style=""><abbr title=" 475                     newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().get(&quot;OrderItemPriceDetailAdjustment&quot;);"> 475                     newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().getðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 476                 } else {                                                                                 </span>
<span class="3374546574285123670" onmouseenter="enter('3374546574285123670');" onmouseout="out('3374546574285123670');" style=""> 477                     newItemAdjustment = offerDao.createOrderItemPriceDetailAdjustment();                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 478                 }                                                                                        </span>
<span class="6434193420407019930" onmouseenter="enter('6434193420407019930');" onmouseout="out('6434193420407019930');" style=""> 479                 newItemAdjustment.init(itemDetail, adjustment.getOffer(), null);                         </span>
<span class="2527816204760883975" onmouseenter="enter('2527816204760883975');" onmouseout="out('2527816204760883975');" style=""> 480                 updateItemAdjustment(newItemAdjustment, adjustment);                                     </span>
<span class="280404668024484347" onmouseenter="enter('280404668024484347');" onmouseout="out('280404668024484347');" style=""> 481                 itemDetail.getOrderItemPriceDetailAdjustments().add(newItemAdjustment);                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 482             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 483         }                                                                                                </span>
<span  style=""> 484                                                                                                          </span>
<span class="2716703745442399701" onmouseenter="enter('2716703745442399701');" onmouseout="out('2716703745442399701');" style=""> 485         if (itemAdjustmentMap.size() &gt; 0) {                                                              </span>
<span class="7320812723157924979" onmouseenter="enter('7320812723157924979');" onmouseout="out('7320812723157924979');" style=""> 486             // Remove adjustments that were on the order item but no longer needed.                      </span>
<span class="-1869846822270594411" onmouseenter="enter('-1869846822270594411');" onmouseout="out('-1869846822270594411');" style=""> 487             List&lt;Long&gt; adjustmentIdsToRemove = new ArrayList&lt;Long&gt;();                                    </span>
<span class="8226461738127611440" onmouseenter="enter('8226461738127611440');" onmouseout="out('8226461738127611440');" style=""> 488             for (OrderItemPriceDetailAdjustment adjustmentToRemove : itemAdjustmentMap.values()) {       </span>
<span class="-5089858163100858042" onmouseenter="enter('-5089858163100858042');" onmouseout="out('-5089858163100858042');" style=""> 489                 adjustmentIdsToRemove.add(adjustmentToRemove.getOffer().getId());                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 490             }                                                                                            </span>
<span  style=""> 491                                                                                                          </span>
<span class="-713707707098991740" onmouseenter="enter('-713707707098991740');" onmouseout="out('-713707707098991740');" style=""><abbr title=" 492             Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustments().iterator();"> 492             Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustmðŸ”µ</abbr></span>
<span class="977968488612897428" onmouseenter="enter('977968488612897428');" onmouseout="out('977968488612897428');" style=""> 493             while (iterator.hasNext()) {                                                                 </span>
<span class="-6499043821118944641" onmouseenter="enter('-6499043821118944641');" onmouseout="out('-6499043821118944641');" style=""> 494                 OrderItemPriceDetailAdjustment adj = iterator.next();                                    </span>
<span class="-3830175641101683618" onmouseenter="enter('-3830175641101683618');" onmouseout="out('-3830175641101683618');" style=""> 495                 if (adjustmentIdsToRemove.contains(adj.getOffer().getId())) {                            </span>
<span class="-6215380074365660212" onmouseenter="enter('-6215380074365660212');" onmouseout="out('-6215380074365660212');" style=""> 496                     iterator.remove();                                                                   </span>
<span class="-7443090736167231390" onmouseenter="enter('-7443090736167231390');" onmouseout="out('-7443090736167231390');" style=""> 497                     entityService.remove(adj);                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 498                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 499             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 500         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 501     }                                                                                                    </span>
<span  style=""> 502                                                                                                          </span>
<span class="-2179044478542157534" onmouseenter="enter('-2179044478542157534');" onmouseout="out('-2179044478542157534');" style=""> 503     protected void updateItemAdjustment(OrderItemPriceDetailAdjustment itemAdjustment,                   </span>
<span class="-2091009272129273931" onmouseenter="enter('-2091009272129273931');" onmouseout="out('-2091009272129273931');" style=""> 504             PromotableOrderItemPriceDetailAdjustment promotableAdjustment) {                             </span>
<span class="8984388188384789298" onmouseenter="enter('8984388188384789298');" onmouseout="out('8984388188384789298');" style=""> 505         itemAdjustment.setValue(promotableAdjustment.getAdjustmentValue());                              </span>
<span class="-1504764115388345009" onmouseenter="enter('-1504764115388345009');" onmouseout="out('-1504764115388345009');" style=""> 506         itemAdjustment.setSalesPriceValue(promotableAdjustment.getSaleAdjustmentValue());                </span>
<span class="8159218742886391276" onmouseenter="enter('8159218742886391276');" onmouseout="out('8159218742886391276');" style=""> 507         itemAdjustment.setRetailPriceValue(promotableAdjustment.getRetailAdjustmentValue());             </span>
<span class="-6000420337005117738" onmouseenter="enter('-6000420337005117738');" onmouseout="out('-6000420337005117738');" style=""> 508         itemAdjustment.setAppliedToSalePrice(promotableAdjustment.isAppliedToSalePrice());               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 509     }                                                                                                    </span>
<span  style=""> 510                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 511     @Override                                                                                            </span>
<span class="-313570815421854700" onmouseenter="enter('-313570815421854700');" onmouseout="out('-313570815421854700');" style=""><abbr title=" 512     public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMap,"> 512     public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMapðŸ”µ</abbr></span>
<span class="-3281550581325801818" onmouseenter="enter('-3281550581325801818');" onmouseout="out('-3281550581325801818');" style=""> 513             Iterator&lt;? extends OrderItemPriceDetail&gt; pdIterator) {                                       </span>
<span class="5054006045083210855" onmouseenter="enter('5054006045083210855');" onmouseout="out('5054006045083210855');" style=""> 514         while (pdIterator.hasNext()) {                                                                   </span>
<span class="3750310726725232966" onmouseenter="enter('3750310726725232966');" onmouseout="out('3750310726725232966');" style=""> 515             OrderItemPriceDetail currentDetail = pdIterator.next();                                      </span>
<span class="6581958837024527183" onmouseenter="enter('6581958837024527183');" onmouseout="out('6581958837024527183');" style=""> 516             if (unmatchedDetailsMap.containsKey(currentDetail.getId())) {                                </span>
<span class="-6186712185724981265" onmouseenter="enter('-6186712185724981265');" onmouseout="out('-6186712185724981265');" style=""> 517                 pdIterator.remove();                                                                     </span>
<span class="-4950660564716836933" onmouseenter="enter('-4950660564716836933');" onmouseout="out('-4950660564716836933');" style=""> 518                 entityService.remove(currentDetail);                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 519             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 520         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 521     }                                                                                                    </span>
<span  style=""> 522                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 523     @Override                                                                                            </span>
<span class="8034359428831826315" onmouseenter="enter('8034359428831826315');" onmouseout="out('8034359428831826315');" style=""> 524     public void removeUnmatchedQualifiers(Map&lt;Long, ? extends OrderItemQualifier&gt; unmatchedQualifiersMap,</span>
<span class="-2169714322041971999" onmouseenter="enter('-2169714322041971999');" onmouseout="out('-2169714322041971999');" style=""> 525             Iterator&lt;? extends OrderItemQualifier&gt; qIterator) {                                          </span>
<span class="2447020288494192331" onmouseenter="enter('2447020288494192331');" onmouseout="out('2447020288494192331');" style=""> 526         while (qIterator.hasNext()) {                                                                    </span>
<span class="-6005719546303323499" onmouseenter="enter('-6005719546303323499');" onmouseout="out('-6005719546303323499');" style=""> 527             OrderItemQualifier currentQualifier = qIterator.next();                                      </span>
<span class="662385347998037693" onmouseenter="enter('662385347998037693');" onmouseout="out('662385347998037693');" style=""> 528             if (unmatchedQualifiersMap.containsKey(currentQualifier.getId())) {                          </span>
<span class="-5446309343821913287" onmouseenter="enter('-5446309343821913287');" onmouseout="out('-5446309343821913287');" style=""> 529                 qIterator.remove();                                                                      </span>
<span class="-863522997969238164" onmouseenter="enter('-863522997969238164');" onmouseout="out('-863522997969238164');" style=""> 530                 entityService.remove(currentQualifier);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 531             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 532         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 533     }                                                                                                    </span>
<span  style=""> 534                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 535     @Override                                                                                            </span>
<span class="-4444436672341398789" onmouseenter="enter('-4444436672341398789');" onmouseout="out('-4444436672341398789');" style=""><abbr title=" 536     public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; qualifiersMap) {"> 536     public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OðŸ”µ</abbr></span>
<span class="5670547093193511713" onmouseenter="enter('5670547093193511713');" onmouseout="out('5670547093193511713');" style=""> 537         Money qualifyingItemSubTotal = offer.getQualifyingItemSubTotal();                                </span>
<span class="-5062121077129985722" onmouseenter="enter('-5062121077129985722');" onmouseout="out('-5062121077129985722');" style=""> 538         if (qualifyingItemSubTotal == null || qualifyingItemSubTotal.lessThanOrEqual(Money.ZERO)) {      </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 539             return true;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 540         }                                                                                                </span>
<span class="-7755694615807420902" onmouseenter="enter('-7755694615807420902');" onmouseout="out('-7755694615807420902');" style=""> 541         return orderMeetsProvidedSubtotalRequirement(offer, qualifiersMap, qualifyingItemSubTotal);      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 542     }                                                                                                    </span>
<span  style=""> 543                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 544     @Override                                                                                            </span>
<span class="-5677301022020811119" onmouseenter="enter('-5677301022020811119');" onmouseout="out('-5677301022020811119');" style=""><abbr title=" 545     public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; targetsMap) {"> 545     public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferðŸ”µ</abbr></span>
<span class="6988724665629485016" onmouseenter="enter('6988724665629485016');" onmouseout="out('6988724665629485016');" style=""> 546         Money targetMinSubTotal = offer.getTargetMinSubTotal();                                          </span>
<span class="-1489567751755997812" onmouseenter="enter('-1489567751755997812');" onmouseout="out('-1489567751755997812');" style=""> 547         if (targetMinSubTotal == null || targetMinSubTotal.lessThanOrEqual(Money.ZERO)) {                </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 548             return true;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 549         }                                                                                                </span>
<span class="7580465799834058252" onmouseenter="enter('7580465799834058252');" onmouseout="out('7580465799834058252');" style=""> 550         return orderMeetsProvidedSubtotalRequirement(offer, targetsMap, targetMinSubTotal);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 551     }                                                                                                    </span>
<span  style=""> 552                                                                                                          </span>
<span class="8829500236577947895" onmouseenter="enter('8829500236577947895');" onmouseout="out('8829500236577947895');" style=""><abbr title=" 553     protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; promotableOrderItems, Money minSubTotal) {"> 553     protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;ðŸ”µ</abbr></span>
<span class="-6106353390255483233" onmouseenter="enter('-6106353390255483233');" onmouseout="out('-6106353390255483233');" style=""> 554         Money subtotal = Money.ZERO;                                                                     </span>
<span  style=""> 555                                                                                                          </span>
<span class="1373302773933084970" onmouseenter="enter('1373302773933084970');" onmouseout="out('1373302773933084970');" style=""> 556         for (OfferItemCriteria itemCriteria : promotableOrderItems.keySet()) {                           </span>
<span class="-419579307951366052" onmouseenter="enter('-419579307951366052');" onmouseout="out('-419579307951366052');" style=""> 557             List&lt;PromotableOrderItem&gt; promotableItems = promotableOrderItems.get(itemCriteria);          </span>
<span  style=""> 558                                                                                                          </span>
<span class="-1903041170653165047" onmouseenter="enter('-1903041170653165047');" onmouseout="out('-1903041170653165047');" style=""> 559             for (PromotableOrderItem item : promotableItems) {                                           </span>
<span class="7600253327963384600" onmouseenter="enter('7600253327963384600');" onmouseout="out('7600253327963384600');" style=""> 560                 boolean shouldApplyDiscountToSalePrice = offer.getApplyDiscountToSalePrice();            </span>
<span class="779941574682415153" onmouseenter="enter('779941574682415153');" onmouseout="out('779941574682415153');" style=""><abbr title=" 561                 Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrice);"> 561                 Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrðŸ”µ</abbr></span>
<span class="215414280986961901" onmouseenter="enter('215414280986961901');" onmouseout="out('215414280986961901');" style=""> 562                 int quantity = item.getQuantity();                                                       </span>
<span  style=""> 563                                                                                                          </span>
<span class="-2934463286963984250" onmouseenter="enter('-2934463286963984250');" onmouseout="out('-2934463286963984250');" style=""> 564                 Money lineItemAmount = priceBeforeAdjustments.multiply(quantity);                        </span>
<span class="-3511635498964788361" onmouseenter="enter('-3511635498964788361');" onmouseout="out('-3511635498964788361');" style=""> 565                 subtotal = subtotal.add(lineItemAmount);                                                 </span>
<span class="-2129121979744538843" onmouseenter="enter('-2129121979744538843');" onmouseout="out('-2129121979744538843');" style=""> 566                 if (subtotal.greaterThanOrEqual(minSubTotal)) {                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 567                     return true;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 568                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 569             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 570         }                                                                                                </span>
<span  style=""> 571                                                                                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 572         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 573     }                                                                                                    </span>
<span  style=""> 574                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 575     @Override                                                                                            </span>
<span class="6911813483912566048" onmouseenter="enter('6911813483912566048');" onmouseout="out('6911813483912566048');" style=""> 576     public boolean orderMeetsSubtotalRequirements(PromotableOrder order, Offer offer) {                  </span>
<span class="8114201548143186402" onmouseenter="enter('8114201548143186402');" onmouseout="out('8114201548143186402');" style=""> 577         Money orderMinSubTotal = offer.getOrderMinSubTotal();                                            </span>
<span class="5846170175083841610" onmouseenter="enter('5846170175083841610');" onmouseout="out('5846170175083841610');" style=""> 578         return orderMinSubTotal == null                                                                  </span>
<span class="774150812299602505" onmouseenter="enter('774150812299602505');" onmouseout="out('774150812299602505');" style=""> 579                 || orderMinSubTotal.lessThanOrEqual(Money.ZERO)                                          </span>
<span class="722443493012604709" onmouseenter="enter('722443493012604709');" onmouseout="out('722443493012604709');" style=""> 580                 || orderMinSubTotal.lessThanOrEqual(order.getOrder().getSubTotal());                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 581     }                                                                                                    </span>
<span  style=""> 582                                                                                                          </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 583     public PromotableItemFactory getPromotableItemFactory() {                                            </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 584         return promotableItemFactory;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 585     }                                                                                                    </span>
<span  style=""> 586                                                                                                          </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 587     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                  </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 588         this.promotableItemFactory = promotableItemFactory;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 589     }                                                                                                    </span>
<span  style=""> 590                                                                                                          </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 591     public OfferDao getOfferDao() {                                                                      </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 592         return offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 593     }                                                                                                    </span>
<span  style=""> 594                                                                                                          </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 595     public void setOfferDao(OfferDao offerDao) {                                                         </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 596         this.offerDao = offerDao;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 597     }                                                                                                    </span>
<span  style=""> 598                                                                                                          </span>
<span class="1819436800301003916" onmouseenter="enter('1819436800301003916');" onmouseout="out('1819436800301003916');" style=""> 599     public GenericEntityService getGenericEntityService() {                                              </span>
<span class="7308888892573915137" onmouseenter="enter('7308888892573915137');" onmouseout="out('7308888892573915137');" style=""> 600         return entityService;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 601     }                                                                                                    </span>
<span  style=""> 602                                                                                                          </span>
<span class="-2936727373443336006" onmouseenter="enter('-2936727373443336006');" onmouseout="out('-2936727373443336006');" style=""> 603     public void setGenericEntityService(GenericEntityService entityService) {                            </span>
<span class="8545056668351819980" onmouseenter="enter('8545056668351819980');" onmouseout="out('8545056668351819980');" style=""> 604         this.entityService = entityService;                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 605     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 606 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18 package org.broadleafcommerce.core.offer.service;                                                        </span>
<span  style="">  19                                                                                                          </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  22 import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                     </span>
<span class="-274639712180431568" onmouseenter="enter('-274639712180431568');" onmouseout="out('-274639712180431568');" style="">  23 import org.broadleafcommerce.common.money.Money;                                                         </span>
<span class="-1492144387614747576" onmouseenter="enter('-1492144387614747576');" onmouseout="out('-1492144387614747576');" style="">  24 import org.broadleafcommerce.common.service.GenericEntityService;                                        </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  25 import org.broadleafcommerce.core.offer.dao.OfferDao;                                                    </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  26 import org.broadleafcommerce.core.offer.domain.Offer;                                                    </span>
<span class="-6494010243902923492" onmouseenter="enter('-6494010243902923492');" onmouseout="out('-6494010243902923492');" style="">  27 import org.broadleafcommerce.core.offer.domain.OfferItemCriteria;                                        </span>
<span class="278382103026396276" onmouseenter="enter('278382103026396276');" onmouseout="out('278382103026396276');" style="">  28 import org.broadleafcommerce.core.offer.domain.OfferPriceData;                                           </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  29 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                           </span>
<span class="6002542247348180004" onmouseenter="enter('6002542247348180004');" onmouseout="out('6002542247348180004');" style="">  30 import org.broadleafcommerce.core.offer.service.discount.PromotionDiscount;                              </span>
<span class="180286745313216238" onmouseenter="enter('180286745313216238');" onmouseout="out('180286745313216238');" style="">  31 import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;                             </span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  32 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;            </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  33 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                   </span>
<span class="5738750158392070" onmouseenter="enter('5738750158392070');" onmouseout="out('5738750158392070');" style="">  34 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;                  </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  35 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                         </span>
<span class="-7733804833771661823" onmouseenter="enter('-7733804833771661823');" onmouseout="out('-7733804833771661823');" style="">  36 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;                     </span>
<span class="2677462620955414718" onmouseenter="enter('2677462620955414718');" onmouseout="out('2677462620955414718');" style="">  37 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;          </span>
<span class="-5097841332942556730" onmouseenter="enter('-5097841332942556730');" onmouseout="out('-5097841332942556730');" style="">  38 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;</span>
<span class="6922194440736558195" onmouseenter="enter('6922194440736558195');" onmouseout="out('6922194440736558195');" style="">  39 import org.broadleafcommerce.core.offer.service.processor.ItemOfferMarkTargets;                          </span>
<span class="-4077086760777187101" onmouseenter="enter('-4077086760777187101');" onmouseout="out('-4077086760777187101');" style="">  40 import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;                                        </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  41 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  42 import org.broadleafcommerce.core.order.domain.OrderItem;                                                </span>
<span class="-1764233193646247473" onmouseenter="enter('-1764233193646247473');" onmouseout="out('-1764233193646247473');" style="">  43 import org.broadleafcommerce.core.order.domain.OrderItemContainer;                                       </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  44 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                     </span>
<span class="573363609456981556" onmouseenter="enter('573363609456981556');" onmouseout="out('573363609456981556');" style="">  45 import org.broadleafcommerce.core.order.domain.OrderItemQualifier;                                       </span>
<span class="-3230016162556687469" onmouseenter="enter('-3230016162556687469');" onmouseout="out('-3230016162556687469');" style="">  46 import org.broadleafcommerce.core.order.domain.dto.OrderItemHolder;                                      </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  47 import org.springframework.stereotype.Service;                                                           </span>
<span  style="">  48                                                                                                          </span>
<span class="2075466404860203191" onmouseenter="enter('2075466404860203191');" onmouseout="out('2075466404860203191');" style="">  49 import java.math.BigDecimal;                                                                             </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  50 import java.util.ArrayList;                                                                              </span>
<span class="2187055016371707860" onmouseenter="enter('2187055016371707860');" onmouseout="out('2187055016371707860');" style="">  51 import java.util.Collections;                                                                            </span>
<span class="4561244361960433187" onmouseenter="enter('4561244361960433187');" onmouseout="out('4561244361960433187');" style="">  52 import java.util.Comparator;                                                                             </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  53 import java.util.HashMap;                                                                                </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  54 import java.util.Iterator;                                                                               </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  55 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  56 import java.util.Map;                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  57 import javax.annotation.Resource;                                                                        </span>
<span  style="">  58                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  59 /**                                                                                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  60  *                                                                                                       </span>
<span class="3680448680235302484" onmouseenter="enter('3680448680235302484');" onmouseout="out('3680448680235302484');" style="">  61  * @author bpolster                                                                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  62  *                                                                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  63  */                                                                                                      </span>
<span class="-7533628443457811418" onmouseenter="enter('-7533628443457811418');" onmouseout="out('-7533628443457811418');" style="">  64 @Service(&quot;blOfferServiceUtilities&quot;)                                                                      </span>
<span class="6914343992633091500" onmouseenter="enter('6914343992633091500');" onmouseout="out('6914343992633091500');" style="">  65 public class OfferServiceUtilitiesImpl implements OfferServiceUtilities {                                </span>
<span class="-7057195126687856185" onmouseenter="enter('-7057195126687856185');" onmouseout="out('-7057195126687856185');" style="">  66     protected static final Log LOG = LogFactory.getLog(OfferServiceUtilitiesImpl.class);                 </span>
<span  style="">  67                                                                                                          </span>
<span class="5938907043749528173" onmouseenter="enter('5938907043749528173');" onmouseout="out('5938907043749528173');" style="">  68     @Resource(name = &quot;blPromotableItemFactory&quot;)                                                          </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style="">  69     protected PromotableItemFactory promotableItemFactory;                                               </span>
<span  style="">  70                                                                                                          </span>
<span class="5779429748772127951" onmouseenter="enter('5779429748772127951');" onmouseout="out('5779429748772127951');" style="">  71     @Resource(name = &quot;blOfferDao&quot;)                                                                       </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  72     protected OfferDao offerDao;                                                                         </span>
<span  style="">  73                                                                                                          </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style="">  74     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                   </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style="">  75     protected OfferServiceExtensionManager extensionManager;                                             </span>
<span  style="">  76                                                                                                          </span>
<span class="-5969569842164006358" onmouseenter="enter('-5969569842164006358');" onmouseout="out('-5969569842164006358');" style="">  77     protected final PromotableOfferUtility promotableOfferUtility;                                       </span>
<span  style="">  78                                                                                                          </span>
<span class="-3896079782246475371" onmouseenter="enter('-3896079782246475371');" onmouseout="out('-3896079782246475371');" style="">  79     public OfferServiceUtilitiesImpl(PromotableOfferUtility promotableOfferUtility) {                    </span>
<span class="-7394468295291059120" onmouseenter="enter('-7394468295291059120');" onmouseout="out('-7394468295291059120');" style="">  80         this.promotableOfferUtility = promotableOfferUtility;                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  81     }                                                                                                    </span>
<span  style="">  82                                                                                                          </span>
<span class="2258512980686044159" onmouseenter="enter('2258512980686044159');" onmouseout="out('2258512980686044159');" style="">  83     @Resource(name = &quot;blGenericEntityService&quot;)                                                           </span>
<span class="5310520372352255538" onmouseenter="enter('5310520372352255538');" onmouseout="out('5310520372352255538');" style="">  84     protected GenericEntityService entityService;                                                        </span>
<span  style="">  85                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  86     @Override                                                                                            </span>
<span class="6223480568976573314" onmouseenter="enter('6223480568976573314');" onmouseout="out('6223480568976573314');" style=""><abbr title="  87     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  87     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applðŸ”µ</abbr></span>
<span class="7055525017697292208" onmouseenter="enter('7055525017697292208');" onmouseout="out('7055525017697292208');" style="">  88         Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  89     }                                                                                                    </span>
<span  style="">  90                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  91     @Override                                                                                            </span>
<span class="-4185121765520276478" onmouseenter="enter('-4185121765520276478');" onmouseout="out('-4185121765520276478');" style=""><abbr title="  92     public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  92     public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean aðŸ”µ</abbr></span>
<span class="7055525017697292208" onmouseenter="enter('7055525017697292208');" onmouseout="out('7055525017697292208');" style="">  93         Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  94     }                                                                                                    </span>
<span  style="">  95                                                                                                          </span>
<span class="8076072330480389618" onmouseenter="enter('8076072330480389618');" onmouseout="out('8076072330480389618');" style=""><abbr title="  96     protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyToSalePrice) {">  96     protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyTðŸ”µ</abbr></span>
<span class="3297095837477520472" onmouseenter="enter('3297095837477520472');" onmouseout="out('3297095837477520472');" style="">  97         return new Comparator&lt;PromotableOrderItemPriceDetail&gt;() {                                        </span>
<span  style="">  98                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  99             @Override                                                                                    </span>
<span class="-2961106138566190059" onmouseenter="enter('-2961106138566190059');" onmouseout="out('-2961106138566190059');" style=""> 100             public int compare(PromotableOrderItemPriceDetail o1, PromotableOrderItemPriceDetail o2) {   </span>
<span class="7675869656754073027" onmouseenter="enter('7675869656754073027');" onmouseout="out('7675869656754073027');" style=""> 101                 Money price = o1.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);   </span>
<span class="-2386281537779196104" onmouseenter="enter('-2386281537779196104');" onmouseout="out('-2386281537779196104');" style=""> 102                 Money price2 = o2.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);  </span>
<span  style=""> 103                                                                                                          </span>
<span class="-7980156687270114839" onmouseenter="enter('-7980156687270114839');" onmouseout="out('-7980156687270114839');" style=""> 104                 // highest amount first                                                                  </span>
<span class="-5413989484138410778" onmouseenter="enter('-5413989484138410778');" onmouseout="out('-5413989484138410778');" style=""> 105                 return price2.compareTo(price);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 106             }                                                                                            </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 107         };                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 108     }                                                                                                    </span>
<span  style=""> 109                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 110     @Override                                                                                            </span>
<span class="-6633188601276085642" onmouseenter="enter('-6633188601276085642');" onmouseout="out('-6633188601276085642');" style=""> 111     public OrderItem findRelatedQualifierRoot(OrderItem relatedQualifier) {                              </span>
<span class="1807144252798273266" onmouseenter="enter('1807144252798273266');" onmouseout="out('1807144252798273266');" style=""> 112         OrderItem relatedQualifierRoot = null;                                                           </span>
<span class="-5368473621929304561" onmouseenter="enter('-5368473621929304561');" onmouseout="out('-5368473621929304561');" style=""> 113         if (relatedQualifier != null) {                                                                  </span>
<span class="-5398594526726109873" onmouseenter="enter('-5398594526726109873');" onmouseout="out('-5398594526726109873');" style=""> 114             relatedQualifierRoot = relatedQualifier;                                                     </span>
<span class="7824588639878219390" onmouseenter="enter('7824588639878219390');" onmouseout="out('7824588639878219390');" style=""> 115             while (relatedQualifierRoot.getParentOrderItem() != null) {                                  </span>
<span class="-2176101432970038375" onmouseenter="enter('-2176101432970038375');" onmouseout="out('-2176101432970038375');" style=""> 116                 relatedQualifierRoot = relatedQualifierRoot.getParentOrderItem();                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 117             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 118         }                                                                                                </span>
<span class="-6121768564377108608" onmouseenter="enter('-6121768564377108608');" onmouseout="out('-6121768564377108608');" style=""> 119         return relatedQualifierRoot;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 120     }                                                                                                    </span>
<span  style=""> 121                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 122     @Override                                                                                            </span>
<span class="8600807536713378155" onmouseenter="enter('8600807536713378155');" onmouseout="out('8600807536713378155');" style=""><abbr title=" 123     public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; details) {"> 123     public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemðŸ”µ</abbr></span>
<span  style=""> 124                                                                                                          </span>
<span class="-4790953179105551104" onmouseenter="enter('-4790953179105551104');" onmouseout="out('-4790953179105551104');" style=""> 125         for (PromotableOrderItemPriceDetail detail : details) {                                          </span>
<span class="1975158128642033085" onmouseenter="enter('1975158128642033085');" onmouseout="out('1975158128642033085');" style=""><abbr title=" 126             for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustments()) {"> 126             for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustmentsðŸ”µ</abbr></span>
<span class="30696373439585907" onmouseenter="enter('30696373439585907');" onmouseout="out('30696373439585907');" style=""> 127                 if (adjustment.isTotalitarian() || itemOffer.getOffer().isTotalitarianOffer()) {         </span>
<span class="-7120250698956357960" onmouseenter="enter('-7120250698956357960');" onmouseout="out('-7120250698956357960');" style=""> 128                     // A totalitarian offer has already been applied or this offer is totalitarian       </span>
<span class="-7934044302077364434" onmouseenter="enter('-7934044302077364434');" onmouseout="out('-7934044302077364434');" style=""> 129                     // and another offer was already applied.                                            </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 130                     return false;                                                                        </span>
<span class="5154499828715066004" onmouseenter="enter('5154499828715066004');" onmouseout="out('5154499828715066004');" style=""><abbr title=" 131                 } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 131                 } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOfferðŸ”µ</abbr></span>
<span class="721506122397233060" onmouseenter="enter('721506122397233060');" onmouseout="out('721506122397233060');" style=""> 132                     // A nonCombinable offer has been applied or this is a non-combinable offer          </span>
<span class="1625719735315035531" onmouseenter="enter('1625719735315035531');" onmouseout="out('1625719735315035531');" style=""> 133                     // and adjustments have already been applied.                                        </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 134                     return false;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 135                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 136             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137         }                                                                                                </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 138         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 139     }                                                                                                    </span>
<span  style=""> 140                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 141     @Override                                                                                            </span>
<span class="-3713458578644525384" onmouseenter="enter('-3713458578644525384');" onmouseout="out('-3713458578644525384');" style=""><abbr title=" 142     public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCriteria,"> 142     public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCrðŸ”µ</abbr></span>
<span class="-9206127464517457513" onmouseenter="enter('-9206127464517457513');" onmouseout="out('-9206127464517457513');" style=""> 143             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {                                         </span>
<span  style=""> 144                                                                                                          </span>
<span class="1399559222284052069" onmouseenter="enter('1399559222284052069');" onmouseout="out('1399559222284052069');" style=""> 145         sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());      </span>
<span  style=""> 146                                                                                                          </span>
<span class="-2005578619141057452" onmouseenter="enter('-2005578619141057452');" onmouseout="out('-2005578619141057452');" style=""> 147         // Calculate the number of qualifiers needed that will not receive the promotion.                </span>
<span class="-7642725860669587391" onmouseenter="enter('-7642725860669587391');" onmouseout="out('-7642725860669587391');" style=""> 148         // These will be reserved first before the target is assigned.                                   </span>
<span class="-5221545606159729582" onmouseenter="enter('-5221545606159729582');" onmouseout="out('-5221545606159729582');" style=""> 149         int qualifierQtyNeeded = itemCriteria.getQuantity();                                             </span>
<span  style=""> 150                                                                                                          </span>
<span class="-389357445740262218" onmouseenter="enter('-389357445740262218');" onmouseout="out('-389357445740262218');" style=""> 151         for (PromotableOrderItemPriceDetail detail : priceDetails) {                                     </span>
<span  style=""> 152                                                                                                          </span>
<span class="-7196228531210809782" onmouseenter="enter('-7196228531210809782');" onmouseout="out('-7196228531210809782');" style=""> 153             // Mark Qualifiers                                                                           </span>
<span class="7203543687533075574" onmouseenter="enter('7203543687533075574');" onmouseout="out('7203543687533075574');" style=""> 154             if (qualifierQtyNeeded &gt; 0) {                                                                </span>
<span class="4739725621440457335" onmouseenter="enter('4739725621440457335');" onmouseout="out('4739725621440457335');" style=""><abbr title=" 155                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 155                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(ðŸ”µ</abbr></span>
<span class="118721626032663442" onmouseenter="enter('118721626032663442');" onmouseout="out('118721626032663442');" style=""> 156                 if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {                                           </span>
<span class="156141582657617565" onmouseenter="enter('156141582657617565');" onmouseout="out('156141582657617565');" style=""><abbr title=" 157                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);"> 157                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQuaðŸ”µ</abbr></span>
<span class="-4684084580161696213" onmouseenter="enter('-4684084580161696213');" onmouseout="out('-4684084580161696213');" style=""> 158                     qualifierQtyNeeded -= qtyToMarkAsQualifier;                                          </span>
<span class="-5539919712790669425" onmouseenter="enter('-5539919712790669425');" onmouseout="out('-5539919712790669425');" style=""> 159                     detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 160                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161             }                                                                                            </span>
<span  style=""> 162                                                                                                          </span>
<span class="8517154315660472641" onmouseenter="enter('8517154315660472641');" onmouseout="out('8517154315660472641');" style=""> 163             if (qualifierQtyNeeded == 0) {                                                               </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 164                 break;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 165             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 166         }                                                                                                </span>
<span class="-4850383672896867816" onmouseenter="enter('-4850383672896867816');" onmouseout="out('-4850383672896867816');" style=""> 167         return qualifierQtyNeeded;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 168     }                                                                                                    </span>
<span  style=""> 169                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 170     @Override                                                                                            </span>
<span class="-690144452707146894" onmouseenter="enter('-690144452707146894');" onmouseout="out('-690144452707146894');" style=""> 171     public int markTargetsForCriteria(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,</span>
<span class="-7065312759813139704" onmouseenter="enter('-7065312759813139704');" onmouseout="out('-7065312759813139704');" style=""><abbr title=" 172             boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriteria,"> 172             boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriðŸ”µ</abbr></span>
<span class="2702959100637307406" onmouseenter="enter('2702959100637307406');" onmouseout="out('2702959100637307406');" style=""> 173             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, int targetQtyNeeded) {                    </span>
<span class="2114191821955736127" onmouseenter="enter('2114191821955736127');" onmouseout="out('2114191821955736127');" style=""> 174         for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {                                </span>
<span class="-5368473621929304561" onmouseenter="enter('-5368473621929304561');" onmouseout="out('-5368473621929304561');" style=""> 175             if (relatedQualifier != null) {                                                              </span>
<span class="8141493125634490263" onmouseenter="enter('8141493125634490263');" onmouseout="out('8141493125634490263');" style=""><abbr title=" 176                 // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 176                 // We need to make sure that this item is either a parent, child, or the same as the qualðŸ”µ</abbr></span>
<span class="1857856063926056091" onmouseenter="enter('1857856063926056091');" onmouseout="out('1857856063926056091');" style=""> 177                 OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();                </span>
<span class="-3127297900577673654" onmouseenter="enter('-3127297900577673654');" onmouseout="out('-3127297900577673654');" style=""><abbr title=" 178                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;"> 178                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierðŸ”µ</abbr></span>
<span class="3862062312907446706" onmouseenter="enter('3862062312907446706');" onmouseout="out('3862062312907446706');" style=""> 179                         !thisItem.equals(relatedQualifierRoot)) {                                        </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 180                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 182             }                                                                                            </span>
<span  style=""> 183                                                                                                          </span>
<span class="-3899808772905023528" onmouseenter="enter('-3899808772905023528');" onmouseout="out('-3899808772905023528');" style=""><abbr title=" 184             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);"> 184             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOðŸ”µ</abbr></span>
<span class="1240759488807976542" onmouseenter="enter('1240759488807976542');" onmouseout="out('1240759488807976542');" style=""> 185             if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {                                                  </span>
<span class="-2152892838174945575" onmouseenter="enter('-2152892838174945575');" onmouseout="out('-2152892838174945575');" style=""><abbr title=" 186                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 186                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOðŸ”µ</abbr></span>
<span class="-5766015035856187988" onmouseenter="enter('-5766015035856187988');" onmouseout="out('-5766015035856187988');" style=""> 187                     int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget); </span>
<span class="-182485827533192502" onmouseenter="enter('-182485827533192502');" onmouseout="out('-182485827533192502');" style=""> 188                     targetQtyNeeded -= qtyToMarkAsTarget;                                                </span>
<span class="-4172322390128575169" onmouseenter="enter('-4172322390128575169');" onmouseout="out('-4172322390128575169');" style=""> 189                     if (!checkOnly) {                                                                    </span>
<span class="5603549919531530635" onmouseenter="enter('5603549919531530635');" onmouseout="out('5603549919531530635');" style=""> 190                         priceDetail.addPromotionDiscount(itemOffer, itemCriteria, qtyToMarkAsTarget);    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 191                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 192                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 193             }                                                                                            </span>
<span  style=""> 194                                                                                                          </span>
<span class="5358835008623854271" onmouseenter="enter('5358835008623854271');" onmouseout="out('5358835008623854271');" style=""> 195             if (targetQtyNeeded == 0) {                                                                  </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 196                 break;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 197             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 198         }                                                                                                </span>
<span class="6491342130615381336" onmouseenter="enter('6491342130615381336');" onmouseout="out('6491342130615381336');" style=""> 199         return targetQtyNeeded;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 200     }                                                                                                    </span>
<span  style=""> 201                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 202     @Override                                                                                            </span>
<span class="1242791052414669567" onmouseenter="enter('1242791052414669567');" onmouseout="out('1242791052414669567');" style=""><abbr title=" 203     public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,"> 203     public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedðŸ”µ</abbr></span>
<span class="6750137376595998298" onmouseenter="enter('6750137376595998298');" onmouseout="out('6750137376595998298');" style=""><abbr title=" 204                                                 boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferPriceData offerPriceData,"> 204                                                 boolean checkOnly, Offer promotion, OrderItem relatedQualðŸ”µ</abbr></span>
<span class="-9206127464517457513" onmouseenter="enter('-9206127464517457513');" onmouseout="out('-9206127464517457513');" style=""> 205                                                 List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {     </span>
<span class="3726836708123429329" onmouseenter="enter('3726836708123429329');" onmouseout="out('3726836708123429329');" style=""> 206         int targetQtyNeeded = offerPriceData.getQuantity();                                              </span>
<span class="-7840883515604062637" onmouseenter="enter('-7840883515604062637');" onmouseout="out('-7840883515604062637');" style=""> 207         int minRequiredTargetQuantity = itemOffer.getMinimumRequiredTargetQuantity();                    </span>
<span class="6262197857819165625" onmouseenter="enter('6262197857819165625');" onmouseout="out('6262197857819165625');" style=""> 208         if (minRequiredTargetQuantity &gt; 1 &amp;&amp; minRequiredTargetQuantity &gt; targetQtyNeeded) {              </span>
<span class="-3324197007536454949" onmouseenter="enter('-3324197007536454949');" onmouseout="out('-3324197007536454949');" style=""> 209             targetQtyNeeded = minRequiredTargetQuantity;                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 210         }                                                                                                </span>
<span  style=""> 211                                                                                                          </span>
<span class="2114191821955736127" onmouseenter="enter('2114191821955736127');" onmouseout="out('2114191821955736127');" style=""> 212         for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {                                </span>
<span class="-5368473621929304561" onmouseenter="enter('-5368473621929304561');" onmouseout="out('-5368473621929304561');" style=""> 213             if (relatedQualifier != null) {                                                              </span>
<span class="8141493125634490263" onmouseenter="enter('8141493125634490263');" onmouseout="out('8141493125634490263');" style=""><abbr title=" 214                 // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 214                 // We need to make sure that this item is either a parent, child, or the same as the qualðŸ”µ</abbr></span>
<span class="1857856063926056091" onmouseenter="enter('1857856063926056091');" onmouseout="out('1857856063926056091');" style=""> 215                 OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();                </span>
<span class="-3127297900577673654" onmouseenter="enter('-3127297900577673654');" onmouseout="out('-3127297900577673654');" style=""><abbr title=" 216                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;"> 216                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierðŸ”µ</abbr></span>
<span class="3862062312907446706" onmouseenter="enter('3862062312907446706');" onmouseout="out('3862062312907446706');" style=""> 217                         !thisItem.equals(relatedQualifierRoot)) {                                        </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 218                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 219                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 220             }                                                                                            </span>
<span  style=""> 221                                                                                                          </span>
<span class="-3899808772905023528" onmouseenter="enter('-3899808772905023528');" onmouseout="out('-3899808772905023528');" style=""><abbr title=" 222             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);"> 222             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOðŸ”µ</abbr></span>
<span class="1240759488807976542" onmouseenter="enter('1240759488807976542');" onmouseout="out('1240759488807976542');" style=""> 223             if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {                                                  </span>
<span class="-2152892838174945575" onmouseenter="enter('-2152892838174945575');" onmouseout="out('-2152892838174945575');" style=""><abbr title=" 224                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 224                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOðŸ”µ</abbr></span>
<span class="-5766015035856187988" onmouseenter="enter('-5766015035856187988');" onmouseout="out('-5766015035856187988');" style=""> 225                     int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget); </span>
<span class="-182485827533192502" onmouseenter="enter('-182485827533192502');" onmouseout="out('-182485827533192502');" style=""> 226                     targetQtyNeeded -= qtyToMarkAsTarget;                                                </span>
<span class="-4172322390128575169" onmouseenter="enter('-4172322390128575169');" onmouseout="out('-4172322390128575169');" style=""> 227                     if (!checkOnly) {                                                                    </span>
<span class="6581474656927369870" onmouseenter="enter('6581474656927369870');" onmouseout="out('6581474656927369870');" style=""> 228                         priceDetail.addPromotionDiscount(itemOffer, null, qtyToMarkAsTarget);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 229                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 230                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 231             }                                                                                            </span>
<span  style=""> 232                                                                                                          </span>
<span class="5358835008623854271" onmouseenter="enter('5358835008623854271');" onmouseout="out('5358835008623854271');" style=""> 233             if (targetQtyNeeded == 0) {                                                                  </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 234                 break;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 235             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 236         }                                                                                                </span>
<span class="7942109921366184597" onmouseenter="enter('7942109921366184597');" onmouseout="out('7942109921366184597');" style=""> 237         return targetQtyNeeded == 0;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 238     }                                                                                                    </span>
<span  style=""> 239                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 240     @Override                                                                                            </span>
<span class="-5374453289617781014" onmouseenter="enter('-5374453289617781014');" onmouseout="out('-5374453289617781014');" style=""><abbr title=" 241     public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, PromotableOrder order,"> 241     public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, ProðŸ”µ</abbr></span>
<span class="-45453231322119310" onmouseenter="enter('-45453231322119310');" onmouseout="out('-45453231322119310');" style=""> 242             OrderItemHolder orderItemHolder, OfferItemCriteria itemCriteria,                             </span>
<span class="-532102448020563017" onmouseenter="enter('-532102448020563017');" onmouseout="out('-532102448020563017');" style=""><abbr title=" 243             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets) {"> 243             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets)ðŸ”µ</abbr></span>
<span class="1399559222284052069" onmouseenter="enter('1399559222284052069');" onmouseout="out('1399559222284052069');" style=""> 244         sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());      </span>
<span  style=""> 245                                                                                                          </span>
<span class="-2005578619141057452" onmouseenter="enter('-2005578619141057452');" onmouseout="out('-2005578619141057452');" style=""> 246         // Calculate the number of qualifiers needed that will not receive the promotion.                </span>
<span class="-7642725860669587391" onmouseenter="enter('-7642725860669587391');" onmouseout="out('-7642725860669587391');" style=""> 247         // These will be reserved first before the target is assigned.                                   </span>
<span class="-5221545606159729582" onmouseenter="enter('-5221545606159729582');" onmouseout="out('-5221545606159729582');" style=""> 248         int qualifierQtyNeeded = itemCriteria.getQuantity();                                             </span>
<span  style=""> 249                                                                                                          </span>
<span class="-389357445740262218" onmouseenter="enter('-389357445740262218');" onmouseout="out('-389357445740262218');" style=""> 250         for (PromotableOrderItemPriceDetail detail : priceDetails) {                                     </span>
<span class="-317635885918930708" onmouseenter="enter('-317635885918930708');" onmouseout="out('-317635885918930708');" style=""> 251             OrderItem oi = detail.getPromotableOrderItem().getOrderItem();                               </span>
<span  style=""> 252                                                                                                          </span>
<span class="7203543687533075574" onmouseenter="enter('7203543687533075574');" onmouseout="out('7203543687533075574');" style=""> 253             if (qualifierQtyNeeded &gt; 0) {                                                                </span>
<span class="4739725621440457335" onmouseenter="enter('4739725621440457335');" onmouseout="out('4739725621440457335');" style=""><abbr title=" 254                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 254                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(ðŸ”µ</abbr></span>
<span class="118721626032663442" onmouseenter="enter('118721626032663442');" onmouseout="out('118721626032663442');" style=""> 255                 if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {                                           </span>
<span class="-1004810985579465662" onmouseenter="enter('-1004810985579465662');" onmouseout="out('-1004810985579465662');" style=""><abbr title=" 256                     // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some state that we"> 256                     // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some sðŸ”µ</abbr></span>
<span class="8185689978075296148" onmouseenter="enter('8185689978075296148');" onmouseout="out('8185689978075296148');" style=""> 257                     // might need in the future.                                                         </span>
<span class="-1081050306738024693" onmouseenter="enter('-1081050306738024693');" onmouseout="out('-1081050306738024693');" style=""> 258                     OfferItemCriteria previousQualifierCriteria = null;                                  </span>
<span class="-8553070012108320907" onmouseenter="enter('-8553070012108320907');" onmouseout="out('-8553070012108320907');" style=""> 259                     for (PromotionQualifier possibleQualifier : detail.getPromotionQualifiers()) {       </span>
<span class="-4722657733023489778" onmouseenter="enter('-4722657733023489778');" onmouseout="out('-4722657733023489778');" style=""> 260                         if (possibleQualifier.getPromotion().equals(itemOffer.getOffer())) {             </span>
<span class="-3028735657089400229" onmouseenter="enter('-3028735657089400229');" onmouseout="out('-3028735657089400229');" style=""> 261                             previousQualifierCriteria = possibleQualifier.getItemCriteria();             </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 262                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 263                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 264                     }                                                                                    </span>
<span  style=""> 265                                                                                                          </span>
<span class="1008214769590136048" onmouseenter="enter('1008214769590136048');" onmouseout="out('1008214769590136048');" style=""> 266                     // Go ahead and mark this item as a qualifier                                        </span>
<span class="156141582657617565" onmouseenter="enter('156141582657617565');" onmouseout="out('156141582657617565');" style=""><abbr title=" 267                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);"> 267                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQuaðŸ”µ</abbr></span>
<span class="-4684084580161696213" onmouseenter="enter('-4684084580161696213');" onmouseout="out('-4684084580161696213');" style=""> 268                     qualifierQtyNeeded -= qtyToMarkAsQualifier;                                          </span>
<span class="2797159826704329425" onmouseenter="enter('2797159826704329425');" onmouseout="out('2797159826704329425');" style=""><abbr title=" 269                     PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);"> 269                     PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMaðŸ”µ</abbr></span>
<span class="-7100200875909405519" onmouseenter="enter('-7100200875909405519');" onmouseout="out('-7100200875909405519');" style=""><abbr title=" 270                     pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOffer().getApplyDiscountToSalePrice()));"> 270                     pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOfðŸ”µ</abbr></span>
<span  style=""> 271                                                                                                          </span>
<span class="6012497254282640402" onmouseenter="enter('6012497254282640402');" onmouseout="out('6012497254282640402');" style=""><abbr title=" 272                     // Now, we need to see if there exists a target(s) that is suitable for this qualifier due to"> 272                     // Now, we need to see if there exists a target(s) that is suitable for this qualifieðŸ”µ</abbr></span>
<span class="-1151958798348543907" onmouseenter="enter('-1151958798348543907');" onmouseout="out('-1151958798348543907');" style=""><abbr title=" 273                     // the relationship flag. If we are on the last qualifier required for this offer, we want to"> 273                     // the relationship flag. If we are on the last qualifier required for this offer, weðŸ”µ</abbr></span>
<span class="3987909966354550925" onmouseenter="enter('3987909966354550925');" onmouseout="out('3987909966354550925');" style=""><abbr title=" 274                     // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just want to check"> 274                     // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just wantðŸ”µ</abbr></span>
<span class="4959301888820404945" onmouseenter="enter('4959301888820404945');" onmouseout="out('4959301888820404945');" style=""> 275                     // that there is an eligible target(s) and continue on.                              </span>
<span class="-5256242047209748696" onmouseenter="enter('-5256242047209748696');" onmouseout="out('-5256242047209748696');" style=""> 276                     if (itemOfferMarkTargets.markTargets(itemOffer, order, oi, true)) {                  </span>
<span class="-297796406415044190" onmouseenter="enter('-297796406415044190');" onmouseout="out('-297796406415044190');" style=""><abbr title=" 277                         // We found a target. Let&#x27;s save this related order item used as the qualifier in case"> 277                         // We found a target. Let&#x27;s save this related order item used as the qualifier inðŸ”µ</abbr></span>
<span class="6348154252416536055" onmouseenter="enter('6348154252416536055');" onmouseout="out('6348154252416536055');" style=""> 278                         // we succeed                                                                    </span>
<span class="-6098537281436011553" onmouseenter="enter('-6098537281436011553');" onmouseout="out('-6098537281436011553');" style=""> 279                         orderItemHolder.setOrderItem(oi);                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 280                     } else {                                                                             </span>
<span class="1831842559835648517" onmouseenter="enter('1831842559835648517');" onmouseout="out('1831842559835648517');" style=""><abbr title=" 281                         // If we didn&#x27;t find a target, we need to roll back how we marked this item as a qualifier."> 281                         // If we didn&#x27;t find a target, we need to roll back how we marked this item as a ðŸ”µ</abbr></span>
<span class="-1853870893725774252" onmouseenter="enter('-1853870893725774252');" onmouseout="out('-1853870893725774252');" style=""> 282                         qualifierQtyNeeded += qtyToMarkAsQualifier;                                      </span>
<span class="-8128593861119500077" onmouseenter="enter('-8128593861119500077');" onmouseout="out('-8128593861119500077');" style=""> 283                         if (pq.getQuantity() == qtyToMarkAsQualifier) {                                  </span>
<span class="-6954079035160286378" onmouseenter="enter('-6954079035160286378');" onmouseout="out('-6954079035160286378');" style=""> 284                             detail.getPromotionQualifiers().remove(pq);                                  </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 285                         } else {                                                                         </span>
<span class="6626310861157345131" onmouseenter="enter('6626310861157345131');" onmouseout="out('6626310861157345131');" style=""> 286                             pq.setItemCriteria(previousQualifierCriteria);                               </span>
<span class="2348238745962483804" onmouseenter="enter('2348238745962483804');" onmouseout="out('2348238745962483804');" style=""> 287                             pq.setQuantity(pq.getQuantity() - qtyToMarkAsQualifier);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 288                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 289                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 290                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 291             }                                                                                            </span>
<span  style=""> 292                                                                                                          </span>
<span class="8517154315660472641" onmouseenter="enter('8517154315660472641');" onmouseout="out('8517154315660472641');" style=""> 293             if (qualifierQtyNeeded == 0) {                                                               </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 294                 break;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 295             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 296         }                                                                                                </span>
<span class="-4850383672896867816" onmouseenter="enter('-4850383672896867816');" onmouseout="out('-4850383672896867816');" style=""> 297         return qualifierQtyNeeded;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 298     }                                                                                                    </span>
<span  style=""> 299                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 300     @Override                                                                                            </span>
<span class="-5508403457222384501" onmouseenter="enter('-5508403457222384501');" onmouseout="out('-5508403457222384501');" style=""><abbr title=" 301     public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails) {"> 301     public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotabðŸ”µ</abbr></span>
<span class="-1180947180176660619" onmouseenter="enter('-1180947180176660619');" onmouseout="out('-1180947180176660619');" style=""> 302         for (PromotableOrderItemPriceDetail itemPriceDetail : itemPriceDetails) {                        </span>
<span class="-669978432390486383" onmouseenter="enter('-669978432390486383');" onmouseout="out('-669978432390486383');" style=""> 303             for (PromotionDiscount discount : itemPriceDetail.getPromotionDiscounts()) {                 </span>
<span class="-4320063668461010504" onmouseenter="enter('-4320063668461010504');" onmouseout="out('-4320063668461010504');" style=""> 304                 if (discount.getPromotion().equals(itemOffer.getOffer())) {                              </span>
<span class="-8948799313684021645" onmouseenter="enter('-8948799313684021645');" onmouseout="out('-8948799313684021645');" style=""><abbr title=" 305                     if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 305                     if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWðŸ”µ</abbr></span>
<span class="8050394734563130560" onmouseenter="enter('8050394734563130560');" onmouseout="out('8050394734563130560');" style=""> 306                         // We&#x27;ve decided to apply this adjustment but if it doesn&#x27;t actually reduce      </span>
<span class="-7936715023008804819" onmouseenter="enter('-7936715023008804819');" onmouseout="out('-7936715023008804819');" style=""> 307                         // the value of the item                                                         </span>
<span class="7229649304367309721" onmouseenter="enter('7229649304367309721');" onmouseout="out('7229649304367309721');" style=""> 308                         if (adjustmentIsNotGoodEnoughToBeApplied(itemOffer, itemPriceDetail)) {          </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 309                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 310                         }                                                                                </span>
<span  style=""> 311                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 312                     }                                                                                    </span>
<span class="-4859405226118818324" onmouseenter="enter('-4859405226118818324');" onmouseout="out('-4859405226118818324');" style=""> 313                     OrderItem orderItem = itemPriceDetail.getPromotableOrderItem().getOrderItem();       </span>
<span class="-7036726360330387930" onmouseenter="enter('-7036726360330387930');" onmouseout="out('-7036726360330387930');" style=""> 314                     Boolean offerCanApplyToChildOrderItems = itemOffer.getOffer().getApplyToChildItems();</span>
<span class="5319718821501044453" onmouseenter="enter('5319718821501044453');" onmouseout="out('5319718821501044453');" style=""> 315                     if (isAddOnOrderItem(orderItem) &amp;&amp; !offerCanApplyToChildOrderItems) {                </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 316                         break;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 317                     }                                                                                    </span>
<span class="-2464330301917486275" onmouseenter="enter('-2464330301917486275');" onmouseout="out('-2464330301917486275');" style=""> 318                     applyOrderItemAdjustment(itemOffer, itemPriceDetail);                                </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 319                     break;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 320                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 321             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 322         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 323     }                                                                                                    </span>
<span  style=""> 324                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 325     @Override                                                                                            </span>
<span class="5703716165905853432" onmouseenter="enter('5703716165905853432');" onmouseout="out('5703716165905853432');" style=""> 326     public boolean isAddOnOrderItem(OrderItem orderItem) {                                               </span>
<span class="-915100238682069401" onmouseenter="enter('-915100238682069401');" onmouseout="out('-915100238682069401');" style=""> 327         if (DiscreteOrderItem.class.isAssignableFrom(orderItem.getClass())) {                            </span>
<span class="-9161979270697696061" onmouseenter="enter('-9161979270697696061');" onmouseout="out('-9161979270697696061');" style=""> 328             DiscreteOrderItem discreteOrderItem = (DiscreteOrderItem) orderItem;                         </span>
<span  style=""> 329                                                                                                          </span>
<span class="-5356075907008875039" onmouseenter="enter('-5356075907008875039');" onmouseout="out('-5356075907008875039');" style=""> 330             Map&lt;String, String&gt; attributes = discreteOrderItem.getAdditionalAttributes();                </span>
<span class="-4907356983337991835" onmouseenter="enter('-4907356983337991835');" onmouseout="out('-4907356983337991835');" style=""> 331             boolean isAddOnOrderItem = attributes.containsKey(&quot;addOnXrefId&quot;);                            </span>
<span class="4227157952965713451" onmouseenter="enter('4227157952965713451');" onmouseout="out('4227157952965713451');" style=""> 332             boolean isChildOrderItem = discreteOrderItem.isChildOrderItem();                             </span>
<span  style=""> 333                                                                                                          </span>
<span class="8373226173169122886" onmouseenter="enter('8373226173169122886');" onmouseout="out('8373226173169122886');" style=""> 334             return isChildOrderItem &amp;&amp; isAddOnOrderItem;                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 335         }                                                                                                </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 336         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 337     }                                                                                                    </span>
<span  style=""> 338                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 339     /**                                                                                                  </span>
<span class="7835653502933924919" onmouseenter="enter('7835653502933924919');" onmouseout="out('7835653502933924919');" style=""> 340      * The adjustment might not be better than the sale price.                                           </span>
<span class="-123895333908918857" onmouseenter="enter('-123895333908918857');" onmouseout="out('-123895333908918857');" style=""> 341      * @param itemOffer                                                                                  </span>
<span class="4317834721456676207" onmouseenter="enter('4317834721456676207');" onmouseout="out('4317834721456676207');" style=""> 342      * @param detail                                                                                     </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 343      * @return                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 344      */                                                                                                  </span>
<span class="8886963584830850852" onmouseenter="enter('8886963584830850852');" onmouseout="out('8886963584830850852');" style=""> 345     protected boolean adjustmentIsNotGoodEnoughToBeApplied(PromotableCandidateItemOffer itemOffer,       </span>
<span class="-5789972309208145824" onmouseenter="enter('-5789972309208145824');" onmouseout="out('-5789972309208145824');" style=""> 346             PromotableOrderItemPriceDetail detail) {                                                     </span>
<span class="5404670390791397495" onmouseenter="enter('5404670390791397495');" onmouseout="out('5404670390791397495');" style=""> 347         if (!itemOffer.getOffer().getApplyDiscountToSalePrice()) {                                       </span>
<span class="2444901768581949268" onmouseenter="enter('2444901768581949268');" onmouseout="out('2444901768581949268');" style=""> 348             Money salePrice = detail.getPromotableOrderItem().getSalePriceBeforeAdjustments();           </span>
<span class="5875272574250045376" onmouseenter="enter('5875272574250045376');" onmouseout="out('5875272574250045376');" style=""> 349             Money retailPrice = detail.getPromotableOrderItem().getRetailPriceBeforeAdjustments();       </span>
<span class="833194282646119023" onmouseenter="enter('833194282646119023');" onmouseout="out('833194282646119023');" style=""><abbr title=" 350             Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromotableOrderItem(), 1);"> 350             Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromðŸ”µ</abbr></span>
<span class="-3042742338309722510" onmouseenter="enter('-3042742338309722510');" onmouseout="out('-3042742338309722510');" style=""> 351             if (salePrice != null) {                                                                     </span>
<span class="4776635754548450658" onmouseenter="enter('4776635754548450658');" onmouseout="out('4776635754548450658');" style=""> 352                 if (salePrice.lessThan(retailPrice.subtract(savings))) {                                 </span>
<span class="5206565982893115863" onmouseenter="enter('5206565982893115863');" onmouseout="out('5206565982893115863');" style=""> 353                     // Not good enough                                                                   </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 354                     return true;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 355                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 356             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 357         }                                                                                                </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 358         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 359     }                                                                                                    </span>
<span  style=""> 360                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 361     @Override                                                                                            </span>
<span class="-3274580905325891597" onmouseenter="enter('-3274580905325891597');" onmouseout="out('-3274580905325891597');" style=""> 362     public void applyOrderItemAdjustment(PromotableCandidateItemOffer itemOffer,                         </span>
<span class="-8798183871686674116" onmouseenter="enter('-8798183871686674116');" onmouseout="out('-8798183871686674116');" style=""> 363             PromotableOrderItemPriceDetail itemPriceDetail) {                                            </span>
<span class="-2791625561543308737" onmouseenter="enter('-2791625561543308737');" onmouseout="out('-2791625561543308737');" style=""> 364         PromotableOrderItemPriceDetailAdjustment promotableOrderItemPriceDetailAdjustment =              </span>
<span class="-1963732814850126206" onmouseenter="enter('-1963732814850126206');" onmouseout="out('-1963732814850126206');" style=""><abbr title=" 365                 promotableItemFactory.createPromotableOrderItemPriceDetailAdjustment(itemOffer, itemPriceDetail);"> 365                 promotableItemFactory.createPromotableOrderItemPriceDetailAdjustment(itemOffer, itemPriceðŸ”µ</abbr></span>
<span class="2431499017104838762" onmouseenter="enter('2431499017104838762');" onmouseout="out('2431499017104838762');" style=""> 366         //don&#x27;t want to have negative adjustments                                                        </span>
<span class="-6618345538058051679" onmouseenter="enter('-6618345538058051679');" onmouseout="out('-6618345538058051679');" style=""><abbr title=" 367         if(promotableOrderItemPriceDetailAdjustment.getRetailAdjustmentValue().lessThan(BigDecimal.ZERO) ||"> 367         if(promotableOrderItemPriceDetailAdjustment.getRetailAdjustmentValue().lessThan(BigDecimal.ZERO) ðŸ”µ</abbr></span>
<span class="7927443701435766406" onmouseenter="enter('7927443701435766406');" onmouseout="out('7927443701435766406');" style=""><abbr title=" 368                 promotableOrderItemPriceDetailAdjustment.getSaleAdjustmentValue().lessThan(BigDecimal.ZERO)){"> 368                 promotableOrderItemPriceDetailAdjustment.getSaleAdjustmentValue().lessThan(BigDecimal.ZERðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 369             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 370         }                                                                                                </span>
<span class="-452752185035923989" onmouseenter="enter('-452752185035923989');" onmouseout="out('-452752185035923989');" style=""> 371         itemPriceDetail.addCandidateItemPriceDetailAdjustment(promotableOrderItemPriceDetailAdjustment); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 372     }                                                                                                    </span>
<span  style=""> 373                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 374     @Override                                                                                            </span>
<span class="-361580458958843386" onmouseenter="enter('-361580458958843386');" onmouseout="out('-361580458958843386');" style=""> 375     public List&lt;OrderItem&gt; buildOrderItemList(Order order) {                                             </span>
<span class="4933536323910912844" onmouseenter="enter('4933536323910912844');" onmouseout="out('4933536323910912844');" style=""> 376         List&lt;OrderItem&gt; orderItemList = new ArrayList&lt;OrderItem&gt;();                                      </span>
<span class="4435196443097834597" onmouseenter="enter('4435196443097834597');" onmouseout="out('4435196443097834597');" style=""> 377         for (OrderItem currentItem : order.getOrderItems()) {                                            </span>
<span class="-2966775259995926277" onmouseenter="enter('-2966775259995926277');" onmouseout="out('-2966775259995926277');" style=""> 378             if (currentItem instanceof OrderItemContainer) {                                             </span>
<span class="5137067544827715705" onmouseenter="enter('5137067544827715705');" onmouseout="out('5137067544827715705');" style=""> 379                 OrderItemContainer container = (OrderItemContainer) currentItem;                         </span>
<span class="4382484490734880847" onmouseenter="enter('4382484490734880847');" onmouseout="out('4382484490734880847');" style=""> 380                 if (container.isPricingAtContainerLevel()) {                                             </span>
<span class="-2270489982917990854" onmouseenter="enter('-2270489982917990854');" onmouseout="out('-2270489982917990854');" style=""> 381                     orderItemList.add(currentItem);                                                      </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 382                 } else {                                                                                 </span>
<span class="112302786623021779" onmouseenter="enter('112302786623021779');" onmouseout="out('112302786623021779');" style=""> 383                     for (OrderItem containedItem : container.getOrderItems()) {                          </span>
<span class="533266059764191893" onmouseenter="enter('533266059764191893');" onmouseout="out('533266059764191893');" style=""> 384                         orderItemList.add(containedItem);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 385                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 386                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 387             } else {                                                                                     </span>
<span class="-2270489982917990854" onmouseenter="enter('-2270489982917990854');" onmouseout="out('-2270489982917990854');" style=""> 388                 orderItemList.add(currentItem);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 389             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 390         }                                                                                                </span>
<span  style=""> 391                                                                                                          </span>
<span class="1499720353589212944" onmouseenter="enter('1499720353589212944');" onmouseout="out('1499720353589212944');" style=""> 392         return orderItemList;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 393     }                                                                                                    </span>
<span  style=""> 394                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 395     @Override                                                                                            </span>
<span class="-8956803960090910177" onmouseenter="enter('-8956803960090910177');" onmouseout="out('-8956803960090910177');" style=""> 396     public Map&lt;OrderItem, PromotableOrderItem&gt; buildPromotableItemMap(PromotableOrder promotableOrder) { </span>
<span class="-2911482928816722705" onmouseenter="enter('-2911482928816722705');" onmouseout="out('-2911482928816722705');" style=""><abbr title=" 397         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderItem&gt;();"> 397         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderIteðŸ”µ</abbr></span>
<span class="4206403965644457797" onmouseenter="enter('4206403965644457797');" onmouseout="out('4206403965644457797');" style=""> 398         for (PromotableOrderItem item : promotableOrder.getAllOrderItems()) {                            </span>
<span class="-3870195952016518221" onmouseenter="enter('-3870195952016518221');" onmouseout="out('-3870195952016518221');" style=""> 399             promotableItemMap.put(item.getOrderItem(), item);                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 400         }                                                                                                </span>
<span class="8963770174585233491" onmouseenter="enter('8963770174585233491');" onmouseout="out('8963770174585233491');" style=""> 401         return promotableItemMap;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 402     }                                                                                                    </span>
<span  style=""> 403                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 404     @Override                                                                                            </span>
<span class="-8575715219777406772" onmouseenter="enter('-8575715219777406772');" onmouseout="out('-8575715219777406772');" style=""><abbr title=" 405     public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itemDetail) {"> 405     public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itðŸ”µ</abbr></span>
<span class="7467828794567286984" onmouseenter="enter('7467828794567286984');" onmouseout="out('7467828794567286984');" style=""><abbr title=" 406         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 406         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetðŸ”µ</abbr></span>
<span  style=""> 407                                                                                                          </span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 408         List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 408         List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjuðŸ”µ</abbr></span>
<span class="-1371106512285082048" onmouseenter="enter('-1371106512285082048');" onmouseout="out('-1371106512285082048');" style=""><abbr title=" 409         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {"> 409         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments())ðŸ”µ</abbr></span>
<span class="-1262630258018644876" onmouseenter="enter('-1262630258018644876');" onmouseout="out('-1262630258018644876');" style=""> 410             if (itemAdjustmentMap.containsKey(adjustment.getOffer().getId())) {                          </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 411                 if (LOG.isDebugEnabled()) {                                                              </span>
<span class="5365687806736453142" onmouseenter="enter('5365687806736453142');" onmouseout="out('5365687806736453142');" style=""><abbr title=" 412                     StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with ids &quot;)"> 412                     StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with iðŸ”µ</abbr></span>
<span class="5769765961448228869" onmouseenter="enter('5769765961448228869');" onmouseout="out('5769765961448228869');" style=""> 413                         .append(itemAdjustmentMap.get(adjustment.getOffer().getId()).getId())            </span>
<span class="7312533819175146387" onmouseenter="enter('7312533819175146387');" onmouseout="out('7312533819175146387');" style=""> 414                         .append(&quot; and &quot;)                                                                 </span>
<span class="-7531978261873044464" onmouseenter="enter('-7531978261873044464');" onmouseout="out('-7531978261873044464');" style=""> 415                         .append(adjustment.getId());                                                     </span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 416                     LOG.debug(sb.toString());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 417                 }                                                                                        </span>
<span class="5304290905678094245" onmouseenter="enter('5304290905678094245');" onmouseout="out('5304290905678094245');" style=""> 418                 adjustmentsToRemove.add(adjustment);                                                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 419             } else {                                                                                     </span>
<span class="-2602676027025933258" onmouseenter="enter('-2602676027025933258');" onmouseout="out('-2602676027025933258');" style=""> 420                 itemAdjustmentMap.put(adjustment.getOffer().getId(), adjustment);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 421             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 422         }                                                                                                </span>
<span  style=""> 423                                                                                                          </span>
<span class="-6749489598586186680" onmouseenter="enter('-6749489598586186680');" onmouseout="out('-6749489598586186680');" style=""> 424         for (OrderItemPriceDetailAdjustment adjustment : adjustmentsToRemove) {                          </span>
<span class="170302329650885695" onmouseenter="enter('170302329650885695');" onmouseout="out('170302329650885695');" style=""> 425             itemDetail.getOrderItemPriceDetailAdjustments().remove(adjustment);                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 426         }                                                                                                </span>
<span  style=""> 427                                                                                                          </span>
<span class="-1848478302592739813" onmouseenter="enter('-1848478302592739813');" onmouseout="out('-1848478302592739813');" style=""> 428         return itemAdjustmentMap;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 429     }                                                                                                    </span>
<span  style=""> 430                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 431     @Override                                                                                            </span>
<span class="7034544881417042941" onmouseenter="enter('7034544881417042941');" onmouseout="out('7034544881417042941');" style=""> 432     public void updatePriceDetail(OrderItemPriceDetail itemDetail,                                       </span>
<span class="-1090177046597316726" onmouseenter="enter('-1090177046597316726');" onmouseout="out('-1090177046597316726');" style=""> 433             PromotableOrderItemPriceDetail promotableDetail) {                                           </span>
<span class="3894635813711687840" onmouseenter="enter('3894635813711687840');" onmouseout="out('3894635813711687840');" style=""> 434         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =                                    </span>
<span class="7785105538478960936" onmouseenter="enter('7785105538478960936');" onmouseout="out('7785105538478960936');" style=""> 435                 buildItemDetailAdjustmentMap(itemDetail);                                                </span>
<span  style=""> 436                                                                                                          </span>
<span class="8052115462234529390" onmouseenter="enter('8052115462234529390');" onmouseout="out('8052115462234529390');" style=""> 437         if (itemDetail.getQuantity() != promotableDetail.getQuantity()) {                                </span>
<span class="8615443511774170500" onmouseenter="enter('8615443511774170500');" onmouseout="out('8615443511774170500');" style=""> 438             itemDetail.setQuantity(promotableDetail.getQuantity());                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 439         }                                                                                                </span>
<span  style=""> 440                                                                                                          </span>
<span class="-7750740315935940052" onmouseenter="enter('-7750740315935940052');" onmouseout="out('-7750740315935940052');" style=""> 441         if (promotableDetail.isAdjustmentsFinalized()) {                                                 </span>
<span class="8693299076047883645" onmouseenter="enter('8693299076047883645');" onmouseout="out('8693299076047883645');" style=""> 442             itemDetail.setUseSalePrice(promotableDetail.useSaleAdjustments());                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 443         }                                                                                                </span>
<span  style=""> 444                                                                                                          </span>
<span class="-200913113255250114" onmouseenter="enter('-200913113255250114');" onmouseout="out('-200913113255250114');" style=""><abbr title=" 445         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjustments()) {"> 445         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjusðŸ”µ</abbr></span>
<span class="6578727718670889454" onmouseenter="enter('6578727718670889454');" onmouseout="out('6578727718670889454');" style=""><abbr title=" 446             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferId());"> 446             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferIðŸ”µ</abbr></span>
<span class="-5676819544918869237" onmouseenter="enter('-5676819544918869237');" onmouseout="out('-5676819544918869237');" style=""> 447             if (itemAdjustment != null) {                                                                </span>
<span class="2095963063095688848" onmouseenter="enter('2095963063095688848');" onmouseout="out('2095963063095688848');" style=""> 448                 // Update existing adjustment                                                            </span>
<span class="4997906471413856597" onmouseenter="enter('4997906471413856597');" onmouseout="out('4997906471413856597');" style=""> 449                 if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {                </span>
<span class="-7190567157504063803" onmouseenter="enter('-7190567157504063803');" onmouseout="out('-7190567157504063803');" style=""> 450                     updateItemAdjustment(itemAdjustment, adjustment);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 451                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 452             } else {                                                                                     </span>
<span class="-3662936612993896923" onmouseenter="enter('-3662936612993896923');" onmouseout="out('-3662936612993896923');" style=""> 453                 // Add a new adjustment                                                                  </span>
<span class="6730722799913825373" onmouseenter="enter('6730722799913825373');" onmouseout="out('6730722799913825373');" style=""> 454                 final OrderItemPriceDetailAdjustment newItemAdjustment;                                  </span>
<span class="-3180324819813272445" onmouseenter="enter('-3180324819813272445');" onmouseout="out('-3180324819813272445');" style=""> 455                 ExtensionResultHolder resultHolder = new ExtensionResultHolder();                        </span>
<span  style=""> 456                                                                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 457                 if (extensionManager != null) {                                                          </span>
<span class="4841855343164111630" onmouseenter="enter('4841855343164111630');" onmouseout="out('4841855343164111630');" style=""> 458                     extensionManager.createOrderItemPriceDetailAdjustment(resultHolder, itemDetail);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 459                 }                                                                                        </span>
<span class="3886522200438865522" onmouseenter="enter('3886522200438865522');" onmouseout="out('3886522200438865522');" style=""><abbr title=" 460                 if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetailAdjustment&quot;)) {"> 460                 if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetaiðŸ”µ</abbr></span>
<span class="-3287798826483764260" onmouseenter="enter('-3287798826483764260');" onmouseout="out('-3287798826483764260');" style=""><abbr title=" 461                     newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().get(&quot;OrderItemPriceDetailAdjustment&quot;);"> 461                     newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().getðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 462                 } else {                                                                                 </span>
<span class="3374546574285123670" onmouseenter="enter('3374546574285123670');" onmouseout="out('3374546574285123670');" style=""> 463                     newItemAdjustment = offerDao.createOrderItemPriceDetailAdjustment();                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 464                 }                                                                                        </span>
<span class="6434193420407019930" onmouseenter="enter('6434193420407019930');" onmouseout="out('6434193420407019930');" style=""> 465                 newItemAdjustment.init(itemDetail, adjustment.getOffer(), null);                         </span>
<span class="2527816204760883975" onmouseenter="enter('2527816204760883975');" onmouseout="out('2527816204760883975');" style=""> 466                 updateItemAdjustment(newItemAdjustment, adjustment);                                     </span>
<span class="280404668024484347" onmouseenter="enter('280404668024484347');" onmouseout="out('280404668024484347');" style=""> 467                 itemDetail.getOrderItemPriceDetailAdjustments().add(newItemAdjustment);                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 468             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 469         }                                                                                                </span>
<span  style=""> 470                                                                                                          </span>
<span class="2716703745442399701" onmouseenter="enter('2716703745442399701');" onmouseout="out('2716703745442399701');" style=""> 471         if (itemAdjustmentMap.size() &gt; 0) {                                                              </span>
<span class="7320812723157924979" onmouseenter="enter('7320812723157924979');" onmouseout="out('7320812723157924979');" style=""> 472             // Remove adjustments that were on the order item but no longer needed.                      </span>
<span class="-1869846822270594411" onmouseenter="enter('-1869846822270594411');" onmouseout="out('-1869846822270594411');" style=""> 473             List&lt;Long&gt; adjustmentIdsToRemove = new ArrayList&lt;Long&gt;();                                    </span>
<span class="8226461738127611440" onmouseenter="enter('8226461738127611440');" onmouseout="out('8226461738127611440');" style=""> 474             for (OrderItemPriceDetailAdjustment adjustmentToRemove : itemAdjustmentMap.values()) {       </span>
<span class="-5089858163100858042" onmouseenter="enter('-5089858163100858042');" onmouseout="out('-5089858163100858042');" style=""> 475                 adjustmentIdsToRemove.add(adjustmentToRemove.getOffer().getId());                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 476             }                                                                                            </span>
<span  style=""> 477                                                                                                          </span>
<span class="-713707707098991740" onmouseenter="enter('-713707707098991740');" onmouseout="out('-713707707098991740');" style=""><abbr title=" 478             Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustments().iterator();"> 478             Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustmðŸ”µ</abbr></span>
<span class="977968488612897428" onmouseenter="enter('977968488612897428');" onmouseout="out('977968488612897428');" style=""> 479             while (iterator.hasNext()) {                                                                 </span>
<span class="-6499043821118944641" onmouseenter="enter('-6499043821118944641');" onmouseout="out('-6499043821118944641');" style=""> 480                 OrderItemPriceDetailAdjustment adj = iterator.next();                                    </span>
<span class="-3830175641101683618" onmouseenter="enter('-3830175641101683618');" onmouseout="out('-3830175641101683618');" style=""> 481                 if (adjustmentIdsToRemove.contains(adj.getOffer().getId())) {                            </span>
<span class="-6215380074365660212" onmouseenter="enter('-6215380074365660212');" onmouseout="out('-6215380074365660212');" style=""> 482                     iterator.remove();                                                                   </span>
<span class="-7443090736167231390" onmouseenter="enter('-7443090736167231390');" onmouseout="out('-7443090736167231390');" style=""> 483                     entityService.remove(adj);                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 484                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 485             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 486         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 487     }                                                                                                    </span>
<span  style=""> 488                                                                                                          </span>
<span class="-2179044478542157534" onmouseenter="enter('-2179044478542157534');" onmouseout="out('-2179044478542157534');" style=""> 489     protected void updateItemAdjustment(OrderItemPriceDetailAdjustment itemAdjustment,                   </span>
<span class="-2091009272129273931" onmouseenter="enter('-2091009272129273931');" onmouseout="out('-2091009272129273931');" style=""> 490             PromotableOrderItemPriceDetailAdjustment promotableAdjustment) {                             </span>
<span class="8984388188384789298" onmouseenter="enter('8984388188384789298');" onmouseout="out('8984388188384789298');" style=""> 491         itemAdjustment.setValue(promotableAdjustment.getAdjustmentValue());                              </span>
<span class="-1504764115388345009" onmouseenter="enter('-1504764115388345009');" onmouseout="out('-1504764115388345009');" style=""> 492         itemAdjustment.setSalesPriceValue(promotableAdjustment.getSaleAdjustmentValue());                </span>
<span class="8159218742886391276" onmouseenter="enter('8159218742886391276');" onmouseout="out('8159218742886391276');" style=""> 493         itemAdjustment.setRetailPriceValue(promotableAdjustment.getRetailAdjustmentValue());             </span>
<span class="-6000420337005117738" onmouseenter="enter('-6000420337005117738');" onmouseout="out('-6000420337005117738');" style=""> 494         itemAdjustment.setAppliedToSalePrice(promotableAdjustment.isAppliedToSalePrice());               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 495     }                                                                                                    </span>
<span  style=""> 496                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 497     @Override                                                                                            </span>
<span class="-313570815421854700" onmouseenter="enter('-313570815421854700');" onmouseout="out('-313570815421854700');" style=""><abbr title=" 498     public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMap,"> 498     public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMapðŸ”µ</abbr></span>
<span class="-3281550581325801818" onmouseenter="enter('-3281550581325801818');" onmouseout="out('-3281550581325801818');" style=""> 499             Iterator&lt;? extends OrderItemPriceDetail&gt; pdIterator) {                                       </span>
<span class="5054006045083210855" onmouseenter="enter('5054006045083210855');" onmouseout="out('5054006045083210855');" style=""> 500         while (pdIterator.hasNext()) {                                                                   </span>
<span class="3750310726725232966" onmouseenter="enter('3750310726725232966');" onmouseout="out('3750310726725232966');" style=""> 501             OrderItemPriceDetail currentDetail = pdIterator.next();                                      </span>
<span class="6581958837024527183" onmouseenter="enter('6581958837024527183');" onmouseout="out('6581958837024527183');" style=""> 502             if (unmatchedDetailsMap.containsKey(currentDetail.getId())) {                                </span>
<span class="-6186712185724981265" onmouseenter="enter('-6186712185724981265');" onmouseout="out('-6186712185724981265');" style=""> 503                 pdIterator.remove();                                                                     </span>
<span class="-4950660564716836933" onmouseenter="enter('-4950660564716836933');" onmouseout="out('-4950660564716836933');" style=""> 504                 entityService.remove(currentDetail);                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 505             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 506         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 507     }                                                                                                    </span>
<span  style=""> 508                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 509     @Override                                                                                            </span>
<span class="8034359428831826315" onmouseenter="enter('8034359428831826315');" onmouseout="out('8034359428831826315');" style=""> 510     public void removeUnmatchedQualifiers(Map&lt;Long, ? extends OrderItemQualifier&gt; unmatchedQualifiersMap,</span>
<span class="-2169714322041971999" onmouseenter="enter('-2169714322041971999');" onmouseout="out('-2169714322041971999');" style=""> 511             Iterator&lt;? extends OrderItemQualifier&gt; qIterator) {                                          </span>
<span class="2447020288494192331" onmouseenter="enter('2447020288494192331');" onmouseout="out('2447020288494192331');" style=""> 512         while (qIterator.hasNext()) {                                                                    </span>
<span class="-6005719546303323499" onmouseenter="enter('-6005719546303323499');" onmouseout="out('-6005719546303323499');" style=""> 513             OrderItemQualifier currentQualifier = qIterator.next();                                      </span>
<span class="662385347998037693" onmouseenter="enter('662385347998037693');" onmouseout="out('662385347998037693');" style=""> 514             if (unmatchedQualifiersMap.containsKey(currentQualifier.getId())) {                          </span>
<span class="-5446309343821913287" onmouseenter="enter('-5446309343821913287');" onmouseout="out('-5446309343821913287');" style=""> 515                 qIterator.remove();                                                                      </span>
<span class="-863522997969238164" onmouseenter="enter('-863522997969238164');" onmouseout="out('-863522997969238164');" style=""> 516                 entityService.remove(currentQualifier);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 517             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 518         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 519     }                                                                                                    </span>
<span  style=""> 520                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 521     @Override                                                                                            </span>
<span class="-4444436672341398789" onmouseenter="enter('-4444436672341398789');" onmouseout="out('-4444436672341398789');" style=""><abbr title=" 522     public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; qualifiersMap) {"> 522     public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OðŸ”µ</abbr></span>
<span class="5670547093193511713" onmouseenter="enter('5670547093193511713');" onmouseout="out('5670547093193511713');" style=""> 523         Money qualifyingItemSubTotal = offer.getQualifyingItemSubTotal();                                </span>
<span class="-5062121077129985722" onmouseenter="enter('-5062121077129985722');" onmouseout="out('-5062121077129985722');" style=""> 524         if (qualifyingItemSubTotal == null || qualifyingItemSubTotal.lessThanOrEqual(Money.ZERO)) {      </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 525             return true;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 526         }                                                                                                </span>
<span class="-7755694615807420902" onmouseenter="enter('-7755694615807420902');" onmouseout="out('-7755694615807420902');" style=""> 527         return orderMeetsProvidedSubtotalRequirement(offer, qualifiersMap, qualifyingItemSubTotal);      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 528     }                                                                                                    </span>
<span  style=""> 529                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 530     @Override                                                                                            </span>
<span class="-5677301022020811119" onmouseenter="enter('-5677301022020811119');" onmouseout="out('-5677301022020811119');" style=""><abbr title=" 531     public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; targetsMap) {"> 531     public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferðŸ”µ</abbr></span>
<span class="6988724665629485016" onmouseenter="enter('6988724665629485016');" onmouseout="out('6988724665629485016');" style=""> 532         Money targetMinSubTotal = offer.getTargetMinSubTotal();                                          </span>
<span class="-1489567751755997812" onmouseenter="enter('-1489567751755997812');" onmouseout="out('-1489567751755997812');" style=""> 533         if (targetMinSubTotal == null || targetMinSubTotal.lessThanOrEqual(Money.ZERO)) {                </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 534             return true;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 535         }                                                                                                </span>
<span class="7580465799834058252" onmouseenter="enter('7580465799834058252');" onmouseout="out('7580465799834058252');" style=""> 536         return orderMeetsProvidedSubtotalRequirement(offer, targetsMap, targetMinSubTotal);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 537     }                                                                                                    </span>
<span  style=""> 538                                                                                                          </span>
<span class="8829500236577947895" onmouseenter="enter('8829500236577947895');" onmouseout="out('8829500236577947895');" style=""><abbr title=" 539     protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; promotableOrderItems, Money minSubTotal) {"> 539     protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;ðŸ”µ</abbr></span>
<span class="-6106353390255483233" onmouseenter="enter('-6106353390255483233');" onmouseout="out('-6106353390255483233');" style=""> 540         Money subtotal = Money.ZERO;                                                                     </span>
<span  style=""> 541                                                                                                          </span>
<span class="1373302773933084970" onmouseenter="enter('1373302773933084970');" onmouseout="out('1373302773933084970');" style=""> 542         for (OfferItemCriteria itemCriteria : promotableOrderItems.keySet()) {                           </span>
<span class="-419579307951366052" onmouseenter="enter('-419579307951366052');" onmouseout="out('-419579307951366052');" style=""> 543             List&lt;PromotableOrderItem&gt; promotableItems = promotableOrderItems.get(itemCriteria);          </span>
<span  style=""> 544                                                                                                          </span>
<span class="-1903041170653165047" onmouseenter="enter('-1903041170653165047');" onmouseout="out('-1903041170653165047');" style=""> 545             for (PromotableOrderItem item : promotableItems) {                                           </span>
<span class="7600253327963384600" onmouseenter="enter('7600253327963384600');" onmouseout="out('7600253327963384600');" style=""> 546                 boolean shouldApplyDiscountToSalePrice = offer.getApplyDiscountToSalePrice();            </span>
<span class="779941574682415153" onmouseenter="enter('779941574682415153');" onmouseout="out('779941574682415153');" style=""><abbr title=" 547                 Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrice);"> 547                 Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrðŸ”µ</abbr></span>
<span class="215414280986961901" onmouseenter="enter('215414280986961901');" onmouseout="out('215414280986961901');" style=""> 548                 int quantity = item.getQuantity();                                                       </span>
<span  style=""> 549                                                                                                          </span>
<span class="-2934463286963984250" onmouseenter="enter('-2934463286963984250');" onmouseout="out('-2934463286963984250');" style=""> 550                 Money lineItemAmount = priceBeforeAdjustments.multiply(quantity);                        </span>
<span class="-3511635498964788361" onmouseenter="enter('-3511635498964788361');" onmouseout="out('-3511635498964788361');" style=""> 551                 subtotal = subtotal.add(lineItemAmount);                                                 </span>
<span class="-2129121979744538843" onmouseenter="enter('-2129121979744538843');" onmouseout="out('-2129121979744538843');" style=""> 552                 if (subtotal.greaterThanOrEqual(minSubTotal)) {                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 553                     return true;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 554                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 555             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 556         }                                                                                                </span>
<span  style=""> 557                                                                                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 558         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 559     }                                                                                                    </span>
<span  style=""> 560                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 561     @Override                                                                                            </span>
<span class="6911813483912566048" onmouseenter="enter('6911813483912566048');" onmouseout="out('6911813483912566048');" style=""> 562     public boolean orderMeetsSubtotalRequirements(PromotableOrder order, Offer offer) {                  </span>
<span class="8114201548143186402" onmouseenter="enter('8114201548143186402');" onmouseout="out('8114201548143186402');" style=""> 563         Money orderMinSubTotal = offer.getOrderMinSubTotal();                                            </span>
<span class="5846170175083841610" onmouseenter="enter('5846170175083841610');" onmouseout="out('5846170175083841610');" style=""> 564         return orderMinSubTotal == null                                                                  </span>
<span class="774150812299602505" onmouseenter="enter('774150812299602505');" onmouseout="out('774150812299602505');" style=""> 565                 || orderMinSubTotal.lessThanOrEqual(Money.ZERO)                                          </span>
<span class="722443493012604709" onmouseenter="enter('722443493012604709');" onmouseout="out('722443493012604709');" style=""> 566                 || orderMinSubTotal.lessThanOrEqual(order.getOrder().getSubTotal());                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 567     }                                                                                                    </span>
<span  style=""> 568                                                                                                          </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 569     public PromotableItemFactory getPromotableItemFactory() {                                            </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 570         return promotableItemFactory;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 571     }                                                                                                    </span>
<span  style=""> 572                                                                                                          </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 573     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                  </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 574         this.promotableItemFactory = promotableItemFactory;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 575     }                                                                                                    </span>
<span  style=""> 576                                                                                                          </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 577     public OfferDao getOfferDao() {                                                                      </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 578         return offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 579     }                                                                                                    </span>
<span  style=""> 580                                                                                                          </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 581     public void setOfferDao(OfferDao offerDao) {                                                         </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 582         this.offerDao = offerDao;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 583     }                                                                                                    </span>
<span  style=""> 584                                                                                                          </span>
<span class="1819436800301003916" onmouseenter="enter('1819436800301003916');" onmouseout="out('1819436800301003916');" style=""> 585     public GenericEntityService getGenericEntityService() {                                              </span>
<span class="7308888892573915137" onmouseenter="enter('7308888892573915137');" onmouseout="out('7308888892573915137');" style=""> 586         return entityService;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 587     }                                                                                                    </span>
<span  style=""> 588                                                                                                          </span>
<span class="-2936727373443336006" onmouseenter="enter('-2936727373443336006');" onmouseout="out('-2936727373443336006');" style=""> 589     public void setGenericEntityService(GenericEntityService entityService) {                            </span>
<span class="8545056668351819980" onmouseenter="enter('8545056668351819980');" onmouseout="out('8545056668351819980');" style=""> 590         this.entityService = entityService;                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 591     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 592 }                                                                                                        </span>












</pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18 package org.broadleafcommerce.core.offer.service;                                                        </span>
<span  style="">  19                                                                                                          </span>
<span class="2075466404860203191" onmouseenter="enter('2075466404860203191');" onmouseout="out('2075466404860203191');" style="">  20 import java.math.BigDecimal;                                                                             </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  21 import java.util.ArrayList;                                                                              </span>
<span class="2187055016371707860" onmouseenter="enter('2187055016371707860');" onmouseout="out('2187055016371707860');" style="">  22 import java.util.Collections;                                                                            </span>
<span class="4561244361960433187" onmouseenter="enter('4561244361960433187');" onmouseout="out('4561244361960433187');" style="">  23 import java.util.Comparator;                                                                             </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  24 import java.util.HashMap;                                                                                </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  25 import java.util.Iterator;                                                                               </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  26 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  27 import java.util.Map;                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  28 import javax.annotation.Resource;                                                                        </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  29 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  30 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  31 import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                     </span>
<span class="-274639712180431568" onmouseenter="enter('-274639712180431568');" onmouseout="out('-274639712180431568');" style="">  32 import org.broadleafcommerce.common.money.Money;                                                         </span>
<span class="-1492144387614747576" onmouseenter="enter('-1492144387614747576');" onmouseout="out('-1492144387614747576');" style="">  33 import org.broadleafcommerce.common.service.GenericEntityService;                                        </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  34 import org.broadleafcommerce.core.offer.dao.OfferDao;                                                    </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  35 import org.broadleafcommerce.core.offer.domain.Offer;                                                    </span>
<span class="-6494010243902923492" onmouseenter="enter('-6494010243902923492');" onmouseout="out('-6494010243902923492');" style="">  36 import org.broadleafcommerce.core.offer.domain.OfferItemCriteria;                                        </span>
<span class="278382103026396276" onmouseenter="enter('278382103026396276');" onmouseout="out('278382103026396276');" style="">  37 import org.broadleafcommerce.core.offer.domain.OfferPriceData;                                           </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  38 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                           </span>
<span class="6002542247348180004" onmouseenter="enter('6002542247348180004');" onmouseout="out('6002542247348180004');" style="">  39 import org.broadleafcommerce.core.offer.service.discount.PromotionDiscount;                              </span>
<span class="180286745313216238" onmouseenter="enter('180286745313216238');" onmouseout="out('180286745313216238');" style="">  40 import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;                             </span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;            </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                   </span>
<span class="5738750158392070" onmouseenter="enter('5738750158392070');" onmouseout="out('5738750158392070');" style="">  43 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;                  </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  44 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                         </span>
<span class="-7733804833771661823" onmouseenter="enter('-7733804833771661823');" onmouseout="out('-7733804833771661823');" style="">  45 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;                     </span>
<span class="2677462620955414718" onmouseenter="enter('2677462620955414718');" onmouseout="out('2677462620955414718');" style="">  46 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;          </span>
<span class="-5097841332942556730" onmouseenter="enter('-5097841332942556730');" onmouseout="out('-5097841332942556730');" style="">  47 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;</span>
<span class="6922194440736558195" onmouseenter="enter('6922194440736558195');" onmouseout="out('6922194440736558195');" style="">  48 import org.broadleafcommerce.core.offer.service.processor.ItemOfferMarkTargets;                          </span>
<span class="-4077086760777187101" onmouseenter="enter('-4077086760777187101');" onmouseout="out('-4077086760777187101');" style="">  49 import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;                                        </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  50 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  51 import org.broadleafcommerce.core.order.domain.OrderItem;                                                </span>
<span class="-1764233193646247473" onmouseenter="enter('-1764233193646247473');" onmouseout="out('-1764233193646247473');" style="">  52 import org.broadleafcommerce.core.order.domain.OrderItemContainer;                                       </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  53 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                     </span>
<span class="573363609456981556" onmouseenter="enter('573363609456981556');" onmouseout="out('573363609456981556');" style="">  54 import org.broadleafcommerce.core.order.domain.OrderItemQualifier;                                       </span>
<span class="-3230016162556687469" onmouseenter="enter('-3230016162556687469');" onmouseout="out('-3230016162556687469');" style="">  55 import org.broadleafcommerce.core.order.domain.dto.OrderItemHolder;                                      </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  56 import org.springframework.stereotype.Service;                                                           </span>
<span  style="">  57                                                                                                          </span>
<span  style="">  58                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  59 /**                                                                                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  60  *                                                                                                       </span>
<span class="3680448680235302484" onmouseenter="enter('3680448680235302484');" onmouseout="out('3680448680235302484');" style="">  61  * @author bpolster                                                                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  62  *                                                                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  63  */                                                                                                      </span>
<span class="-7533628443457811418" onmouseenter="enter('-7533628443457811418');" onmouseout="out('-7533628443457811418');" style="">  64 @Service(&quot;blOfferServiceUtilities&quot;)                                                                      </span>
<span class="6914343992633091500" onmouseenter="enter('6914343992633091500');" onmouseout="out('6914343992633091500');" style="">  65 public class OfferServiceUtilitiesImpl implements OfferServiceUtilities {                                </span>
<span class="-7057195126687856185" onmouseenter="enter('-7057195126687856185');" onmouseout="out('-7057195126687856185');" style="">  66     protected static final Log LOG = LogFactory.getLog(OfferServiceUtilitiesImpl.class);                 </span>
<span  style="">  67                                                                                                          </span>
<span class="5938907043749528173" onmouseenter="enter('5938907043749528173');" onmouseout="out('5938907043749528173');" style="">  68     @Resource(name = &quot;blPromotableItemFactory&quot;)                                                          </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style="">  69     protected PromotableItemFactory promotableItemFactory;                                               </span>
<span  style="">  70                                                                                                          </span>
<span class="5779429748772127951" onmouseenter="enter('5779429748772127951');" onmouseout="out('5779429748772127951');" style="">  71     @Resource(name = &quot;blOfferDao&quot;)                                                                       </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  72     protected OfferDao offerDao;                                                                         </span>
<span  style="">  73                                                                                                          </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style="">  74     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                   </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style="">  75     protected OfferServiceExtensionManager extensionManager;                                             </span>
<span  style="">  76                                                                                                          </span>
<span class="-5969569842164006358" onmouseenter="enter('-5969569842164006358');" onmouseout="out('-5969569842164006358');" style="">  77     protected final PromotableOfferUtility promotableOfferUtility;                                       </span>
<span  style="">  78                                                                                                          </span>
<span class="-3896079782246475371" onmouseenter="enter('-3896079782246475371');" onmouseout="out('-3896079782246475371');" style="">  79     public OfferServiceUtilitiesImpl(PromotableOfferUtility promotableOfferUtility) {                    </span>
<span class="-7394468295291059120" onmouseenter="enter('-7394468295291059120');" onmouseout="out('-7394468295291059120');" style="">  80         this.promotableOfferUtility = promotableOfferUtility;                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  81     }                                                                                                    </span>
<span  style="">  82                                                                                                          </span>
<span class="2258512980686044159" onmouseenter="enter('2258512980686044159');" onmouseout="out('2258512980686044159');" style="">  83     @Resource(name = &quot;blGenericEntityService&quot;)                                                           </span>
<span class="5310520372352255538" onmouseenter="enter('5310520372352255538');" onmouseout="out('5310520372352255538');" style="">  84     protected GenericEntityService entityService;                                                        </span>
<span  style="">  85                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  86     @Override                                                                                            </span>
<span class="6223480568976573314" onmouseenter="enter('6223480568976573314');" onmouseout="out('6223480568976573314');" style=""><abbr title="  87     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  87     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applðŸ”µ</abbr></span>
<span class="7055525017697292208" onmouseenter="enter('7055525017697292208');" onmouseout="out('7055525017697292208');" style="">  88         Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  89     }                                                                                                    </span>
<span  style="">  90                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  91     @Override                                                                                            </span>
<span class="-4185121765520276478" onmouseenter="enter('-4185121765520276478');" onmouseout="out('-4185121765520276478');" style=""><abbr title="  92     public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  92     public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean aðŸ”µ</abbr></span>
<span class="7055525017697292208" onmouseenter="enter('7055525017697292208');" onmouseout="out('7055525017697292208');" style="">  93         Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  94     }                                                                                                    </span>
<span  style="">  95                                                                                                          </span>
<span class="8076072330480389618" onmouseenter="enter('8076072330480389618');" onmouseout="out('8076072330480389618');" style=""><abbr title="  96     protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyToSalePrice) {">  96     protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyTðŸ”µ</abbr></span>
<span class="3297095837477520472" onmouseenter="enter('3297095837477520472');" onmouseout="out('3297095837477520472');" style="">  97         return new Comparator&lt;PromotableOrderItemPriceDetail&gt;() {                                        </span>
<span  style="">  98                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  99             @Override                                                                                    </span>
<span class="-2961106138566190059" onmouseenter="enter('-2961106138566190059');" onmouseout="out('-2961106138566190059');" style=""> 100             public int compare(PromotableOrderItemPriceDetail o1, PromotableOrderItemPriceDetail o2) {   </span>
<span class="7675869656754073027" onmouseenter="enter('7675869656754073027');" onmouseout="out('7675869656754073027');" style=""> 101                 Money price = o1.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);   </span>
<span class="-2386281537779196104" onmouseenter="enter('-2386281537779196104');" onmouseout="out('-2386281537779196104');" style=""> 102                 Money price2 = o2.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);  </span>
<span  style=""> 103                                                                                                          </span>
<span class="-7980156687270114839" onmouseenter="enter('-7980156687270114839');" onmouseout="out('-7980156687270114839');" style=""> 104                 // highest amount first                                                                  </span>
<span class="-5413989484138410778" onmouseenter="enter('-5413989484138410778');" onmouseout="out('-5413989484138410778');" style=""> 105                 return price2.compareTo(price);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 106             }                                                                                            </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 107         };                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 108     }                                                                                                    </span>
<span  style=""> 109                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 110     @Override                                                                                            </span>
<span class="-6633188601276085642" onmouseenter="enter('-6633188601276085642');" onmouseout="out('-6633188601276085642');" style=""> 111     public OrderItem findRelatedQualifierRoot(OrderItem relatedQualifier) {                              </span>
<span class="1807144252798273266" onmouseenter="enter('1807144252798273266');" onmouseout="out('1807144252798273266');" style=""> 112         OrderItem relatedQualifierRoot = null;                                                           </span>
<span class="-5368473621929304561" onmouseenter="enter('-5368473621929304561');" onmouseout="out('-5368473621929304561');" style=""> 113         if (relatedQualifier != null) {                                                                  </span>
<span class="-5398594526726109873" onmouseenter="enter('-5398594526726109873');" onmouseout="out('-5398594526726109873');" style=""> 114             relatedQualifierRoot = relatedQualifier;                                                     </span>
<span class="7824588639878219390" onmouseenter="enter('7824588639878219390');" onmouseout="out('7824588639878219390');" style=""> 115             while (relatedQualifierRoot.getParentOrderItem() != null) {                                  </span>
<span class="-2176101432970038375" onmouseenter="enter('-2176101432970038375');" onmouseout="out('-2176101432970038375');" style=""> 116                 relatedQualifierRoot = relatedQualifierRoot.getParentOrderItem();                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 117             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 118         }                                                                                                </span>
<span class="-6121768564377108608" onmouseenter="enter('-6121768564377108608');" onmouseout="out('-6121768564377108608');" style=""> 119         return relatedQualifierRoot;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 120     }                                                                                                    </span>
<span  style=""> 121                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 122     @Override                                                                                            </span>
<span class="8600807536713378155" onmouseenter="enter('8600807536713378155');" onmouseout="out('8600807536713378155');" style=""><abbr title=" 123     public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; details) {"> 123     public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemðŸ”µ</abbr></span>
<span  style=""> 124                                                                                                          </span>
<span class="-4790953179105551104" onmouseenter="enter('-4790953179105551104');" onmouseout="out('-4790953179105551104');" style=""> 125         for (PromotableOrderItemPriceDetail detail : details) {                                          </span>
<span class="1975158128642033085" onmouseenter="enter('1975158128642033085');" onmouseout="out('1975158128642033085');" style=""><abbr title=" 126             for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustments()) {"> 126             for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustmentsðŸ”µ</abbr></span>
<span class="30696373439585907" onmouseenter="enter('30696373439585907');" onmouseout="out('30696373439585907');" style=""> 127                 if (adjustment.isTotalitarian() || itemOffer.getOffer().isTotalitarianOffer()) {         </span>
<span class="-7120250698956357960" onmouseenter="enter('-7120250698956357960');" onmouseout="out('-7120250698956357960');" style=""> 128                     // A totalitarian offer has already been applied or this offer is totalitarian       </span>
<span class="-7934044302077364434" onmouseenter="enter('-7934044302077364434');" onmouseout="out('-7934044302077364434');" style=""> 129                     // and another offer was already applied.                                            </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 130                     return false;                                                                        </span>
<span class="5154499828715066004" onmouseenter="enter('5154499828715066004');" onmouseout="out('5154499828715066004');" style=""><abbr title=" 131                 } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 131                 } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOfferðŸ”µ</abbr></span>
<span class="721506122397233060" onmouseenter="enter('721506122397233060');" onmouseout="out('721506122397233060');" style=""> 132                     // A nonCombinable offer has been applied or this is a non-combinable offer          </span>
<span class="1625719735315035531" onmouseenter="enter('1625719735315035531');" onmouseout="out('1625719735315035531');" style=""> 133                     // and adjustments have already been applied.                                        </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 134                     return false;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 135                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 136             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137         }                                                                                                </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 138         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 139     }                                                                                                    </span>
<span  style=""> 140                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 141     @Override                                                                                            </span>
<span class="-3713458578644525384" onmouseenter="enter('-3713458578644525384');" onmouseout="out('-3713458578644525384');" style=""><abbr title=" 142     public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCriteria,"> 142     public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCrðŸ”µ</abbr></span>
<span class="-9206127464517457513" onmouseenter="enter('-9206127464517457513');" onmouseout="out('-9206127464517457513');" style=""> 143             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {                                         </span>
<span  style=""> 144                                                                                                          </span>
<span class="1399559222284052069" onmouseenter="enter('1399559222284052069');" onmouseout="out('1399559222284052069');" style=""> 145         sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());      </span>
<span  style=""> 146                                                                                                          </span>
<span class="-2005578619141057452" onmouseenter="enter('-2005578619141057452');" onmouseout="out('-2005578619141057452');" style=""> 147         // Calculate the number of qualifiers needed that will not receive the promotion.                </span>
<span class="-7642725860669587391" onmouseenter="enter('-7642725860669587391');" onmouseout="out('-7642725860669587391');" style=""> 148         // These will be reserved first before the target is assigned.                                   </span>
<span class="-5221545606159729582" onmouseenter="enter('-5221545606159729582');" onmouseout="out('-5221545606159729582');" style=""> 149         int qualifierQtyNeeded = itemCriteria.getQuantity();                                             </span>
<span  style=""> 150                                                                                                          </span>
<span class="-389357445740262218" onmouseenter="enter('-389357445740262218');" onmouseout="out('-389357445740262218');" style=""> 151         for (PromotableOrderItemPriceDetail detail : priceDetails) {                                     </span>
<span  style=""> 152                                                                                                          </span>
<span class="-7196228531210809782" onmouseenter="enter('-7196228531210809782');" onmouseout="out('-7196228531210809782');" style=""> 153             // Mark Qualifiers                                                                           </span>
<span class="7203543687533075574" onmouseenter="enter('7203543687533075574');" onmouseout="out('7203543687533075574');" style=""> 154             if (qualifierQtyNeeded &gt; 0) {                                                                </span>
<span class="4739725621440457335" onmouseenter="enter('4739725621440457335');" onmouseout="out('4739725621440457335');" style=""><abbr title=" 155                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 155                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(ðŸ”µ</abbr></span>
<span class="118721626032663442" onmouseenter="enter('118721626032663442');" onmouseout="out('118721626032663442');" style=""> 156                 if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {                                           </span>
<span class="156141582657617565" onmouseenter="enter('156141582657617565');" onmouseout="out('156141582657617565');" style=""><abbr title=" 157                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);"> 157                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQuaðŸ”µ</abbr></span>
<span class="-4684084580161696213" onmouseenter="enter('-4684084580161696213');" onmouseout="out('-4684084580161696213');" style=""> 158                     qualifierQtyNeeded -= qtyToMarkAsQualifier;                                          </span>
<span class="-5539919712790669425" onmouseenter="enter('-5539919712790669425');" onmouseout="out('-5539919712790669425');" style=""> 159                     detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 160                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161             }                                                                                            </span>
<span  style=""> 162                                                                                                          </span>
<span class="8517154315660472641" onmouseenter="enter('8517154315660472641');" onmouseout="out('8517154315660472641');" style=""> 163             if (qualifierQtyNeeded == 0) {                                                               </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 164                 break;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 165             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 166         }                                                                                                </span>
<span class="-4850383672896867816" onmouseenter="enter('-4850383672896867816');" onmouseout="out('-4850383672896867816');" style=""> 167         return qualifierQtyNeeded;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 168     }                                                                                                    </span>
<span  style=""> 169                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 170     @Override                                                                                            </span>
<span class="-690144452707146894" onmouseenter="enter('-690144452707146894');" onmouseout="out('-690144452707146894');" style=""> 171     public int markTargetsForCriteria(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,</span>
<span class="-7065312759813139704" onmouseenter="enter('-7065312759813139704');" onmouseout="out('-7065312759813139704');" style=""><abbr title=" 172             boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriteria,"> 172             boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriðŸ”µ</abbr></span>
<span class="2702959100637307406" onmouseenter="enter('2702959100637307406');" onmouseout="out('2702959100637307406');" style=""> 173             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, int targetQtyNeeded) {                    </span>
<span class="2114191821955736127" onmouseenter="enter('2114191821955736127');" onmouseout="out('2114191821955736127');" style=""> 174         for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {                                </span>
<span class="-5368473621929304561" onmouseenter="enter('-5368473621929304561');" onmouseout="out('-5368473621929304561');" style=""> 175             if (relatedQualifier != null) {                                                              </span>
<span class="8141493125634490263" onmouseenter="enter('8141493125634490263');" onmouseout="out('8141493125634490263');" style=""><abbr title=" 176                 // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 176                 // We need to make sure that this item is either a parent, child, or the same as the qualðŸ”µ</abbr></span>
<span class="1857856063926056091" onmouseenter="enter('1857856063926056091');" onmouseout="out('1857856063926056091');" style=""> 177                 OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();                </span>
<span class="-3127297900577673654" onmouseenter="enter('-3127297900577673654');" onmouseout="out('-3127297900577673654');" style=""><abbr title=" 178                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;"> 178                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierðŸ”µ</abbr></span>
<span class="3862062312907446706" onmouseenter="enter('3862062312907446706');" onmouseout="out('3862062312907446706');" style=""> 179                         !thisItem.equals(relatedQualifierRoot)) {                                        </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 180                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 182             }                                                                                            </span>
<span  style=""> 183                                                                                                          </span>
<span class="-3899808772905023528" onmouseenter="enter('-3899808772905023528');" onmouseout="out('-3899808772905023528');" style=""><abbr title=" 184             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);"> 184             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOðŸ”µ</abbr></span>
<span class="1240759488807976542" onmouseenter="enter('1240759488807976542');" onmouseout="out('1240759488807976542');" style=""> 185             if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {                                                  </span>
<span class="-2152892838174945575" onmouseenter="enter('-2152892838174945575');" onmouseout="out('-2152892838174945575');" style=""><abbr title=" 186                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 186                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOðŸ”µ</abbr></span>
<span class="-5766015035856187988" onmouseenter="enter('-5766015035856187988');" onmouseout="out('-5766015035856187988');" style=""> 187                     int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget); </span>
<span class="-182485827533192502" onmouseenter="enter('-182485827533192502');" onmouseout="out('-182485827533192502');" style=""> 188                     targetQtyNeeded -= qtyToMarkAsTarget;                                                </span>
<span class="-4172322390128575169" onmouseenter="enter('-4172322390128575169');" onmouseout="out('-4172322390128575169');" style=""> 189                     if (!checkOnly) {                                                                    </span>
<span class="5603549919531530635" onmouseenter="enter('5603549919531530635');" onmouseout="out('5603549919531530635');" style=""> 190                         priceDetail.addPromotionDiscount(itemOffer, itemCriteria, qtyToMarkAsTarget);    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 191                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 192                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 193             }                                                                                            </span>
<span  style=""> 194                                                                                                          </span>
<span class="5358835008623854271" onmouseenter="enter('5358835008623854271');" onmouseout="out('5358835008623854271');" style=""> 195             if (targetQtyNeeded == 0) {                                                                  </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 196                 break;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 197             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 198         }                                                                                                </span>
<span class="6491342130615381336" onmouseenter="enter('6491342130615381336');" onmouseout="out('6491342130615381336');" style=""> 199         return targetQtyNeeded;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 200     }                                                                                                    </span>
<span  style=""> 201                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 202     @Override                                                                                            </span>
<span class="1242791052414669567" onmouseenter="enter('1242791052414669567');" onmouseout="out('1242791052414669567');" style=""><abbr title=" 203     public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,"> 203     public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedðŸ”µ</abbr></span>
<span class="6750137376595998298" onmouseenter="enter('6750137376595998298');" onmouseout="out('6750137376595998298');" style=""><abbr title=" 204                                                 boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferPriceData offerPriceData,"> 204                                                 boolean checkOnly, Offer promotion, OrderItem relatedQualðŸ”µ</abbr></span>
<span class="-9206127464517457513" onmouseenter="enter('-9206127464517457513');" onmouseout="out('-9206127464517457513');" style=""> 205                                                 List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {     </span>
<span class="3726836708123429329" onmouseenter="enter('3726836708123429329');" onmouseout="out('3726836708123429329');" style=""> 206         int targetQtyNeeded = offerPriceData.getQuantity();                                              </span>
<span class="-7840883515604062637" onmouseenter="enter('-7840883515604062637');" onmouseout="out('-7840883515604062637');" style=""> 207         int minRequiredTargetQuantity = itemOffer.getMinimumRequiredTargetQuantity();                    </span>
<span class="6262197857819165625" onmouseenter="enter('6262197857819165625');" onmouseout="out('6262197857819165625');" style=""> 208         if (minRequiredTargetQuantity &gt; 1 &amp;&amp; minRequiredTargetQuantity &gt; targetQtyNeeded) {              </span>
<span class="-3324197007536454949" onmouseenter="enter('-3324197007536454949');" onmouseout="out('-3324197007536454949');" style=""> 209             targetQtyNeeded = minRequiredTargetQuantity;                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 210         }                                                                                                </span>
<span  style=""> 211                                                                                                          </span>
<span class="2114191821955736127" onmouseenter="enter('2114191821955736127');" onmouseout="out('2114191821955736127');" style=""> 212         for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {                                </span>
<span class="-5368473621929304561" onmouseenter="enter('-5368473621929304561');" onmouseout="out('-5368473621929304561');" style=""> 213             if (relatedQualifier != null) {                                                              </span>
<span class="8141493125634490263" onmouseenter="enter('8141493125634490263');" onmouseout="out('8141493125634490263');" style=""><abbr title=" 214                 // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 214                 // We need to make sure that this item is either a parent, child, or the same as the qualðŸ”µ</abbr></span>
<span class="1857856063926056091" onmouseenter="enter('1857856063926056091');" onmouseout="out('1857856063926056091');" style=""> 215                 OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();                </span>
<span class="-3127297900577673654" onmouseenter="enter('-3127297900577673654');" onmouseout="out('-3127297900577673654');" style=""><abbr title=" 216                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;"> 216                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierðŸ”µ</abbr></span>
<span class="3862062312907446706" onmouseenter="enter('3862062312907446706');" onmouseout="out('3862062312907446706');" style=""> 217                         !thisItem.equals(relatedQualifierRoot)) {                                        </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 218                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 219                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 220             }                                                                                            </span>
<span  style=""> 221                                                                                                          </span>
<span class="-3899808772905023528" onmouseenter="enter('-3899808772905023528');" onmouseout="out('-3899808772905023528');" style=""><abbr title=" 222             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);"> 222             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOðŸ”µ</abbr></span>
<span class="1240759488807976542" onmouseenter="enter('1240759488807976542');" onmouseout="out('1240759488807976542');" style=""> 223             if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {                                                  </span>
<span class="-2152892838174945575" onmouseenter="enter('-2152892838174945575');" onmouseout="out('-2152892838174945575');" style=""><abbr title=" 224                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 224                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOðŸ”µ</abbr></span>
<span class="-5766015035856187988" onmouseenter="enter('-5766015035856187988');" onmouseout="out('-5766015035856187988');" style=""> 225                     int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget); </span>
<span class="-182485827533192502" onmouseenter="enter('-182485827533192502');" onmouseout="out('-182485827533192502');" style=""> 226                     targetQtyNeeded -= qtyToMarkAsTarget;                                                </span>
<span class="-4172322390128575169" onmouseenter="enter('-4172322390128575169');" onmouseout="out('-4172322390128575169');" style=""> 227                     if (!checkOnly) {                                                                    </span>
<span class="6581474656927369870" onmouseenter="enter('6581474656927369870');" onmouseout="out('6581474656927369870');" style=""> 228                         priceDetail.addPromotionDiscount(itemOffer, null, qtyToMarkAsTarget);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 229                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 230                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 231             }                                                                                            </span>
<span  style=""> 232                                                                                                          </span>
<span class="5358835008623854271" onmouseenter="enter('5358835008623854271');" onmouseout="out('5358835008623854271');" style=""> 233             if (targetQtyNeeded == 0) {                                                                  </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 234                 break;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 235             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 236         }                                                                                                </span>
<span class="7942109921366184597" onmouseenter="enter('7942109921366184597');" onmouseout="out('7942109921366184597');" style=""> 237         return targetQtyNeeded == 0;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 238     }                                                                                                    </span>
<span  style=""> 239                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 240     @Override                                                                                            </span>
<span class="-5374453289617781014" onmouseenter="enter('-5374453289617781014');" onmouseout="out('-5374453289617781014');" style=""><abbr title=" 241     public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, PromotableOrder order,"> 241     public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, ProðŸ”µ</abbr></span>
<span class="-45453231322119310" onmouseenter="enter('-45453231322119310');" onmouseout="out('-45453231322119310');" style=""> 242             OrderItemHolder orderItemHolder, OfferItemCriteria itemCriteria,                             </span>
<span class="-532102448020563017" onmouseenter="enter('-532102448020563017');" onmouseout="out('-532102448020563017');" style=""><abbr title=" 243             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets) {"> 243             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets)ðŸ”µ</abbr></span>
<span class="1399559222284052069" onmouseenter="enter('1399559222284052069');" onmouseout="out('1399559222284052069');" style=""> 244         sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());      </span>
<span  style=""> 245                                                                                                          </span>
<span class="-2005578619141057452" onmouseenter="enter('-2005578619141057452');" onmouseout="out('-2005578619141057452');" style=""> 246         // Calculate the number of qualifiers needed that will not receive the promotion.                </span>
<span class="-7642725860669587391" onmouseenter="enter('-7642725860669587391');" onmouseout="out('-7642725860669587391');" style=""> 247         // These will be reserved first before the target is assigned.                                   </span>
<span class="-5221545606159729582" onmouseenter="enter('-5221545606159729582');" onmouseout="out('-5221545606159729582');" style=""> 248         int qualifierQtyNeeded = itemCriteria.getQuantity();                                             </span>
<span  style=""> 249                                                                                                          </span>
<span class="-389357445740262218" onmouseenter="enter('-389357445740262218');" onmouseout="out('-389357445740262218');" style=""> 250         for (PromotableOrderItemPriceDetail detail : priceDetails) {                                     </span>
<span class="-317635885918930708" onmouseenter="enter('-317635885918930708');" onmouseout="out('-317635885918930708');" style=""> 251             OrderItem oi = detail.getPromotableOrderItem().getOrderItem();                               </span>
<span  style=""> 252                                                                                                          </span>
<span class="7203543687533075574" onmouseenter="enter('7203543687533075574');" onmouseout="out('7203543687533075574');" style=""> 253             if (qualifierQtyNeeded &gt; 0) {                                                                </span>
<span class="4739725621440457335" onmouseenter="enter('4739725621440457335');" onmouseout="out('4739725621440457335');" style=""><abbr title=" 254                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 254                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(ðŸ”µ</abbr></span>
<span class="118721626032663442" onmouseenter="enter('118721626032663442');" onmouseout="out('118721626032663442');" style=""> 255                 if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {                                           </span>
<span class="-1004810985579465662" onmouseenter="enter('-1004810985579465662');" onmouseout="out('-1004810985579465662');" style=""><abbr title=" 256                     // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some state that we"> 256                     // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some sðŸ”µ</abbr></span>
<span class="8185689978075296148" onmouseenter="enter('8185689978075296148');" onmouseout="out('8185689978075296148');" style=""> 257                     // might need in the future.                                                         </span>
<span class="-1081050306738024693" onmouseenter="enter('-1081050306738024693');" onmouseout="out('-1081050306738024693');" style=""> 258                     OfferItemCriteria previousQualifierCriteria = null;                                  </span>
<span class="-8553070012108320907" onmouseenter="enter('-8553070012108320907');" onmouseout="out('-8553070012108320907');" style=""> 259                     for (PromotionQualifier possibleQualifier : detail.getPromotionQualifiers()) {       </span>
<span class="-4722657733023489778" onmouseenter="enter('-4722657733023489778');" onmouseout="out('-4722657733023489778');" style=""> 260                         if (possibleQualifier.getPromotion().equals(itemOffer.getOffer())) {             </span>
<span class="-3028735657089400229" onmouseenter="enter('-3028735657089400229');" onmouseout="out('-3028735657089400229');" style=""> 261                             previousQualifierCriteria = possibleQualifier.getItemCriteria();             </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 262                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 263                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 264                     }                                                                                    </span>
<span  style=""> 265                                                                                                          </span>
<span class="1008214769590136048" onmouseenter="enter('1008214769590136048');" onmouseout="out('1008214769590136048');" style=""> 266                     // Go ahead and mark this item as a qualifier                                        </span>
<span class="156141582657617565" onmouseenter="enter('156141582657617565');" onmouseout="out('156141582657617565');" style=""><abbr title=" 267                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);"> 267                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQuaðŸ”µ</abbr></span>
<span class="-4684084580161696213" onmouseenter="enter('-4684084580161696213');" onmouseout="out('-4684084580161696213');" style=""> 268                     qualifierQtyNeeded -= qtyToMarkAsQualifier;                                          </span>
<span class="2797159826704329425" onmouseenter="enter('2797159826704329425');" onmouseout="out('2797159826704329425');" style=""><abbr title=" 269                     PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);"> 269                     PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMaðŸ”µ</abbr></span>
<span class="-7100200875909405519" onmouseenter="enter('-7100200875909405519');" onmouseout="out('-7100200875909405519');" style=""><abbr title=" 270                     pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOffer().getApplyDiscountToSalePrice()));"> 270                     pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOfðŸ”µ</abbr></span>
<span  style=""> 271                                                                                                          </span>
<span class="6012497254282640402" onmouseenter="enter('6012497254282640402');" onmouseout="out('6012497254282640402');" style=""><abbr title=" 272                     // Now, we need to see if there exists a target(s) that is suitable for this qualifier due to"> 272                     // Now, we need to see if there exists a target(s) that is suitable for this qualifieðŸ”µ</abbr></span>
<span class="-1151958798348543907" onmouseenter="enter('-1151958798348543907');" onmouseout="out('-1151958798348543907');" style=""><abbr title=" 273                     // the relationship flag. If we are on the last qualifier required for this offer, we want to"> 273                     // the relationship flag. If we are on the last qualifier required for this offer, weðŸ”µ</abbr></span>
<span class="3987909966354550925" onmouseenter="enter('3987909966354550925');" onmouseout="out('3987909966354550925');" style=""><abbr title=" 274                     // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just want to check"> 274                     // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just wantðŸ”µ</abbr></span>
<span class="4959301888820404945" onmouseenter="enter('4959301888820404945');" onmouseout="out('4959301888820404945');" style=""> 275                     // that there is an eligible target(s) and continue on.                              </span>
<span class="-5256242047209748696" onmouseenter="enter('-5256242047209748696');" onmouseout="out('-5256242047209748696');" style=""> 276                     if (itemOfferMarkTargets.markTargets(itemOffer, order, oi, true)) {                  </span>
<span class="-297796406415044190" onmouseenter="enter('-297796406415044190');" onmouseout="out('-297796406415044190');" style=""><abbr title=" 277                         // We found a target. Let&#x27;s save this related order item used as the qualifier in case"> 277                         // We found a target. Let&#x27;s save this related order item used as the qualifier inðŸ”µ</abbr></span>
<span class="6348154252416536055" onmouseenter="enter('6348154252416536055');" onmouseout="out('6348154252416536055');" style=""> 278                         // we succeed                                                                    </span>
<span class="-6098537281436011553" onmouseenter="enter('-6098537281436011553');" onmouseout="out('-6098537281436011553');" style=""> 279                         orderItemHolder.setOrderItem(oi);                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 280                     } else {                                                                             </span>
<span class="1831842559835648517" onmouseenter="enter('1831842559835648517');" onmouseout="out('1831842559835648517');" style=""><abbr title=" 281                         // If we didn&#x27;t find a target, we need to roll back how we marked this item as a qualifier."> 281                         // If we didn&#x27;t find a target, we need to roll back how we marked this item as a ðŸ”µ</abbr></span>
<span class="-1853870893725774252" onmouseenter="enter('-1853870893725774252');" onmouseout="out('-1853870893725774252');" style=""> 282                         qualifierQtyNeeded += qtyToMarkAsQualifier;                                      </span>
<span class="-8128593861119500077" onmouseenter="enter('-8128593861119500077');" onmouseout="out('-8128593861119500077');" style=""> 283                         if (pq.getQuantity() == qtyToMarkAsQualifier) {                                  </span>
<span class="-6954079035160286378" onmouseenter="enter('-6954079035160286378');" onmouseout="out('-6954079035160286378');" style=""> 284                             detail.getPromotionQualifiers().remove(pq);                                  </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 285                         } else {                                                                         </span>
<span class="6626310861157345131" onmouseenter="enter('6626310861157345131');" onmouseout="out('6626310861157345131');" style=""> 286                             pq.setItemCriteria(previousQualifierCriteria);                               </span>
<span class="2348238745962483804" onmouseenter="enter('2348238745962483804');" onmouseout="out('2348238745962483804');" style=""> 287                             pq.setQuantity(pq.getQuantity() - qtyToMarkAsQualifier);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 288                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 289                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 290                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 291             }                                                                                            </span>
<span  style=""> 292                                                                                                          </span>
<span class="8517154315660472641" onmouseenter="enter('8517154315660472641');" onmouseout="out('8517154315660472641');" style=""> 293             if (qualifierQtyNeeded == 0) {                                                               </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 294                 break;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 295             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 296         }                                                                                                </span>
<span class="-4850383672896867816" onmouseenter="enter('-4850383672896867816');" onmouseout="out('-4850383672896867816');" style=""> 297         return qualifierQtyNeeded;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 298     }                                                                                                    </span>
<span  style=""> 299                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 300     @Override                                                                                            </span>
<span class="-5508403457222384501" onmouseenter="enter('-5508403457222384501');" onmouseout="out('-5508403457222384501');" style=""><abbr title=" 301     public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails) {"> 301     public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotabðŸ”µ</abbr></span>
<span class="-1180947180176660619" onmouseenter="enter('-1180947180176660619');" onmouseout="out('-1180947180176660619');" style=""> 302         for (PromotableOrderItemPriceDetail itemPriceDetail : itemPriceDetails) {                        </span>
<span class="-669978432390486383" onmouseenter="enter('-669978432390486383');" onmouseout="out('-669978432390486383');" style=""> 303             for (PromotionDiscount discount : itemPriceDetail.getPromotionDiscounts()) {                 </span>
<span class="-4320063668461010504" onmouseenter="enter('-4320063668461010504');" onmouseout="out('-4320063668461010504');" style=""> 304                 if (discount.getPromotion().equals(itemOffer.getOffer())) {                              </span>
<span class="-8948799313684021645" onmouseenter="enter('-8948799313684021645');" onmouseout="out('-8948799313684021645');" style=""><abbr title=" 305                     if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 305                     if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWðŸ”µ</abbr></span>
<span class="8050394734563130560" onmouseenter="enter('8050394734563130560');" onmouseout="out('8050394734563130560');" style=""> 306                         // We&#x27;ve decided to apply this adjustment but if it doesn&#x27;t actually reduce      </span>
<span class="-7936715023008804819" onmouseenter="enter('-7936715023008804819');" onmouseout="out('-7936715023008804819');" style=""> 307                         // the value of the item                                                         </span>
<span class="7229649304367309721" onmouseenter="enter('7229649304367309721');" onmouseout="out('7229649304367309721');" style=""> 308                         if (adjustmentIsNotGoodEnoughToBeApplied(itemOffer, itemPriceDetail)) {          </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 309                             break;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 310                         }                                                                                </span>
<span  style=""> 311                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 312                     }                                                                                    </span>
<span class="-4859405226118818324" onmouseenter="enter('-4859405226118818324');" onmouseout="out('-4859405226118818324');" style=""> 313                     OrderItem orderItem = itemPriceDetail.getPromotableOrderItem().getOrderItem();       </span>
<span class="-7036726360330387930" onmouseenter="enter('-7036726360330387930');" onmouseout="out('-7036726360330387930');" style=""> 314                     Boolean offerCanApplyToChildOrderItems = itemOffer.getOffer().getApplyToChildItems();</span>
<span class="5319718821501044453" onmouseenter="enter('5319718821501044453');" onmouseout="out('5319718821501044453');" style=""> 315                     if (isAddOnOrderItem(orderItem) &amp;&amp; !offerCanApplyToChildOrderItems) {                </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 316                         break;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 317                     }                                                                                    </span>
<span class="-2464330301917486275" onmouseenter="enter('-2464330301917486275');" onmouseout="out('-2464330301917486275');" style=""> 318                     applyOrderItemAdjustment(itemOffer, itemPriceDetail);                                </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 319                     break;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 320                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 321             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 322         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 323     }                                                                                                    </span>
<span  style=""> 324                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 325     @Override                                                                                            </span>
<span class="5703716165905853432" onmouseenter="enter('5703716165905853432');" onmouseout="out('5703716165905853432');" style=""> 326     public boolean isAddOnOrderItem(OrderItem orderItem) {                                               </span>
<span class="-915100238682069401" onmouseenter="enter('-915100238682069401');" onmouseout="out('-915100238682069401');" style=""> 327         if (DiscreteOrderItem.class.isAssignableFrom(orderItem.getClass())) {                            </span>
<span class="-9161979270697696061" onmouseenter="enter('-9161979270697696061');" onmouseout="out('-9161979270697696061');" style=""> 328             DiscreteOrderItem discreteOrderItem = (DiscreteOrderItem) orderItem;                         </span>
<span  style=""> 329                                                                                                          </span>
<span class="-5356075907008875039" onmouseenter="enter('-5356075907008875039');" onmouseout="out('-5356075907008875039');" style=""> 330             Map&lt;String, String&gt; attributes = discreteOrderItem.getAdditionalAttributes();                </span>
<span class="-4907356983337991835" onmouseenter="enter('-4907356983337991835');" onmouseout="out('-4907356983337991835');" style=""> 331             boolean isAddOnOrderItem = attributes.containsKey(&quot;addOnXrefId&quot;);                            </span>
<span class="4227157952965713451" onmouseenter="enter('4227157952965713451');" onmouseout="out('4227157952965713451');" style=""> 332             boolean isChildOrderItem = discreteOrderItem.isChildOrderItem();                             </span>
<span  style=""> 333                                                                                                          </span>
<span class="8373226173169122886" onmouseenter="enter('8373226173169122886');" onmouseout="out('8373226173169122886');" style=""> 334             return isChildOrderItem &amp;&amp; isAddOnOrderItem;                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 335         }                                                                                                </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 336         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 337     }                                                                                                    </span>
<span  style=""> 338                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 339     /**                                                                                                  </span>
<span class="7835653502933924919" onmouseenter="enter('7835653502933924919');" onmouseout="out('7835653502933924919');" style=""> 340      * The adjustment might not be better than the sale price.                                           </span>
<span class="-123895333908918857" onmouseenter="enter('-123895333908918857');" onmouseout="out('-123895333908918857');" style=""> 341      * @param itemOffer                                                                                  </span>
<span class="4317834721456676207" onmouseenter="enter('4317834721456676207');" onmouseout="out('4317834721456676207');" style=""> 342      * @param detail                                                                                     </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 343      * @return                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 344      */                                                                                                  </span>
<span class="-641565271289851611" onmouseenter="enter('-641565271289851611');" onmouseout="out('-641565271289851611');" style=""><abbr title=" 345     protected boolean adjustmentIsNotGoodEnoughToBeApplied(PromotableCandidateItemOffer itemOffer, PromotableOrderItemPriceDetail detail) {"> 345     protected boolean adjustmentIsNotGoodEnoughToBeApplied(PromotableCandidateItemOffer itemOffer, PromotðŸ”µ</abbr></span>
<span class="5404670390791397495" onmouseenter="enter('5404670390791397495');" onmouseout="out('5404670390791397495');" style=""> 346         if (!itemOffer.getOffer().getApplyDiscountToSalePrice()) {                                       </span>
<span class="2444901768581949268" onmouseenter="enter('2444901768581949268');" onmouseout="out('2444901768581949268');" style=""> 347             Money salePrice = detail.getPromotableOrderItem().getSalePriceBeforeAdjustments();           </span>
<span class="5875272574250045376" onmouseenter="enter('5875272574250045376');" onmouseout="out('5875272574250045376');" style=""> 348             Money retailPrice = detail.getPromotableOrderItem().getRetailPriceBeforeAdjustments();       </span>
<span class="833194282646119023" onmouseenter="enter('833194282646119023');" onmouseout="out('833194282646119023');" style=""><abbr title=" 349             Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromotableOrderItem(), 1);"> 349             Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromðŸ”µ</abbr></span>
<span class="-3042742338309722510" onmouseenter="enter('-3042742338309722510');" onmouseout="out('-3042742338309722510');" style=""> 350             if (salePrice != null) {                                                                     </span>
<span class="4776635754548450658" onmouseenter="enter('4776635754548450658');" onmouseout="out('4776635754548450658');" style=""> 351                 if (salePrice.lessThan(retailPrice.subtract(savings))) {                                 </span>
<span class="5206565982893115863" onmouseenter="enter('5206565982893115863');" onmouseout="out('5206565982893115863');" style=""> 352                     // Not good enough                                                                   </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 353                     return true;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 354                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 355             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 356         }                                                                                                </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 357         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 358     }                                                                                                    </span>
<span  style=""> 359                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 360     @Override                                                                                            </span>
<span class="-8251263254921909411" onmouseenter="enter('-8251263254921909411');" onmouseout="out('-8251263254921909411');" style=""><abbr title=" 361     public void applyOrderItemAdjustment(PromotableCandidateItemOffer itemOffer, PromotableOrderItemPriceDetail itemPriceDetail) {"> 361     public void applyOrderItemAdjustment(PromotableCandidateItemOffer itemOffer, PromotableOrderItemPriceðŸ”µ</abbr></span>
<span class="5407628957063551727" onmouseenter="enter('5407628957063551727');" onmouseout="out('5407628957063551727');" style=""><abbr title=" 362         PromotableOrderItemPriceDetailAdjustment promotableOrderItemPriceDetailAdjustment = promotableItemFactory.createPromotableOrderItemPriceDetailAdjustment(itemOffer, itemPriceDetail);"> 362         PromotableOrderItemPriceDetailAdjustment promotableOrderItemPriceDetailAdjustment = promotableIteðŸ”µ</abbr></span>
<span class="-8789226029922697968" onmouseenter="enter('-8789226029922697968');" onmouseout="out('-8789226029922697968');" style=""> 363         // don&#x27;t want to have negative adjustments                                                       </span>
<span class="1172174012335389054" onmouseenter="enter('1172174012335389054');" onmouseout="out('1172174012335389054');" style=""><abbr title=" 364         if (promotableOrderItemPriceDetailAdjustment.getRetailAdjustmentValue().lessThan(BigDecimal.ZERO) || promotableOrderItemPriceDetailAdjustment.getSaleAdjustmentValue().lessThan(BigDecimal.ZERO)) {"> 364         if (promotableOrderItemPriceDetailAdjustment.getRetailAdjustmentValue().lessThan(BigDecimal.ZERO)ðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 365             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 366         }                                                                                                </span>
<span class="-452752185035923989" onmouseenter="enter('-452752185035923989');" onmouseout="out('-452752185035923989');" style=""> 367         itemPriceDetail.addCandidateItemPriceDetailAdjustment(promotableOrderItemPriceDetailAdjustment); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 368     }                                                                                                    </span>
<span  style=""> 369                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 370     @Override                                                                                            </span>
<span class="-361580458958843386" onmouseenter="enter('-361580458958843386');" onmouseout="out('-361580458958843386');" style=""> 371     public List&lt;OrderItem&gt; buildOrderItemList(Order order) {                                             </span>
<span class="4933536323910912844" onmouseenter="enter('4933536323910912844');" onmouseout="out('4933536323910912844');" style=""> 372         List&lt;OrderItem&gt; orderItemList = new ArrayList&lt;OrderItem&gt;();                                      </span>
<span class="4435196443097834597" onmouseenter="enter('4435196443097834597');" onmouseout="out('4435196443097834597');" style=""> 373         for (OrderItem currentItem : order.getOrderItems()) {                                            </span>
<span class="-2966775259995926277" onmouseenter="enter('-2966775259995926277');" onmouseout="out('-2966775259995926277');" style=""> 374             if (currentItem instanceof OrderItemContainer) {                                             </span>
<span class="5137067544827715705" onmouseenter="enter('5137067544827715705');" onmouseout="out('5137067544827715705');" style=""> 375                 OrderItemContainer container = (OrderItemContainer) currentItem;                         </span>
<span class="4382484490734880847" onmouseenter="enter('4382484490734880847');" onmouseout="out('4382484490734880847');" style=""> 376                 if (container.isPricingAtContainerLevel()) {                                             </span>
<span class="-2270489982917990854" onmouseenter="enter('-2270489982917990854');" onmouseout="out('-2270489982917990854');" style=""> 377                     orderItemList.add(currentItem);                                                      </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 378                 } else {                                                                                 </span>
<span class="112302786623021779" onmouseenter="enter('112302786623021779');" onmouseout="out('112302786623021779');" style=""> 379                     for (OrderItem containedItem : container.getOrderItems()) {                          </span>
<span class="533266059764191893" onmouseenter="enter('533266059764191893');" onmouseout="out('533266059764191893');" style=""> 380                         orderItemList.add(containedItem);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 381                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 382                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 383             } else {                                                                                     </span>
<span class="-2270489982917990854" onmouseenter="enter('-2270489982917990854');" onmouseout="out('-2270489982917990854');" style=""> 384                 orderItemList.add(currentItem);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 385             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 386         }                                                                                                </span>
<span  style=""> 387                                                                                                          </span>
<span class="1499720353589212944" onmouseenter="enter('1499720353589212944');" onmouseout="out('1499720353589212944');" style=""> 388         return orderItemList;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 389     }                                                                                                    </span>
<span  style=""> 390                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 391     @Override                                                                                            </span>
<span class="-8956803960090910177" onmouseenter="enter('-8956803960090910177');" onmouseout="out('-8956803960090910177');" style=""> 392     public Map&lt;OrderItem, PromotableOrderItem&gt; buildPromotableItemMap(PromotableOrder promotableOrder) { </span>
<span class="-2911482928816722705" onmouseenter="enter('-2911482928816722705');" onmouseout="out('-2911482928816722705');" style=""><abbr title=" 393         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderItem&gt;();"> 393         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderIteðŸ”µ</abbr></span>
<span class="4206403965644457797" onmouseenter="enter('4206403965644457797');" onmouseout="out('4206403965644457797');" style=""> 394         for (PromotableOrderItem item : promotableOrder.getAllOrderItems()) {                            </span>
<span class="-3870195952016518221" onmouseenter="enter('-3870195952016518221');" onmouseout="out('-3870195952016518221');" style=""> 395             promotableItemMap.put(item.getOrderItem(), item);                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 396         }                                                                                                </span>
<span class="8963770174585233491" onmouseenter="enter('8963770174585233491');" onmouseout="out('8963770174585233491');" style=""> 397         return promotableItemMap;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 398     }                                                                                                    </span>
<span  style=""> 399                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 400     @Override                                                                                            </span>
<span class="-8575715219777406772" onmouseenter="enter('-8575715219777406772');" onmouseout="out('-8575715219777406772');" style=""><abbr title=" 401     public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itemDetail) {"> 401     public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itðŸ”µ</abbr></span>
<span class="7467828794567286984" onmouseenter="enter('7467828794567286984');" onmouseout="out('7467828794567286984');" style=""><abbr title=" 402         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 402         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetðŸ”µ</abbr></span>
<span  style=""> 403                                                                                                          </span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 404         List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 404         List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjuðŸ”µ</abbr></span>
<span class="-1371106512285082048" onmouseenter="enter('-1371106512285082048');" onmouseout="out('-1371106512285082048');" style=""><abbr title=" 405         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {"> 405         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments())ðŸ”µ</abbr></span>
<span class="-1262630258018644876" onmouseenter="enter('-1262630258018644876');" onmouseout="out('-1262630258018644876');" style=""> 406             if (itemAdjustmentMap.containsKey(adjustment.getOffer().getId())) {                          </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 407                 if (LOG.isDebugEnabled()) {                                                              </span>
<span class="5365687806736453142" onmouseenter="enter('5365687806736453142');" onmouseout="out('5365687806736453142');" style=""><abbr title=" 408                     StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with ids &quot;)"> 408                     StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with iðŸ”µ</abbr></span>
<span class="5769765961448228869" onmouseenter="enter('5769765961448228869');" onmouseout="out('5769765961448228869');" style=""> 409                         .append(itemAdjustmentMap.get(adjustment.getOffer().getId()).getId())            </span>
<span class="7312533819175146387" onmouseenter="enter('7312533819175146387');" onmouseout="out('7312533819175146387');" style=""> 410                         .append(&quot; and &quot;)                                                                 </span>
<span class="-7531978261873044464" onmouseenter="enter('-7531978261873044464');" onmouseout="out('-7531978261873044464');" style=""> 411                         .append(adjustment.getId());                                                     </span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 412                     LOG.debug(sb.toString());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 413                 }                                                                                        </span>
<span class="5304290905678094245" onmouseenter="enter('5304290905678094245');" onmouseout="out('5304290905678094245');" style=""> 414                 adjustmentsToRemove.add(adjustment);                                                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 415             } else {                                                                                     </span>
<span class="-2602676027025933258" onmouseenter="enter('-2602676027025933258');" onmouseout="out('-2602676027025933258');" style=""> 416                 itemAdjustmentMap.put(adjustment.getOffer().getId(), adjustment);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 417             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 418         }                                                                                                </span>
<span  style=""> 419                                                                                                          </span>
<span class="-6749489598586186680" onmouseenter="enter('-6749489598586186680');" onmouseout="out('-6749489598586186680');" style=""> 420         for (OrderItemPriceDetailAdjustment adjustment : adjustmentsToRemove) {                          </span>
<span class="170302329650885695" onmouseenter="enter('170302329650885695');" onmouseout="out('170302329650885695');" style=""> 421             itemDetail.getOrderItemPriceDetailAdjustments().remove(adjustment);                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 422         }                                                                                                </span>
<span  style=""> 423                                                                                                          </span>
<span class="-1848478302592739813" onmouseenter="enter('-1848478302592739813');" onmouseout="out('-1848478302592739813');" style=""> 424         return itemAdjustmentMap;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 425     }                                                                                                    </span>
<span  style=""> 426                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 427     @Override                                                                                            </span>
<span class="-613663003693139483" onmouseenter="enter('-613663003693139483');" onmouseout="out('-613663003693139483');" style=""><abbr title=" 428     public void updatePriceDetail(OrderItemPriceDetail itemDetail, PromotableOrderItemPriceDetail promotableDetail) {"> 428     public void updatePriceDetail(OrderItemPriceDetail itemDetail, PromotableOrderItemPriceDetail promotaðŸ”µ</abbr></span>
<span class="-2150536652660172007" onmouseenter="enter('-2150536652660172007');" onmouseout="out('-2150536652660172007');" style=""><abbr title=" 429         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = buildItemDetailAdjustmentMap(itemDetail);"> 429         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = buildItemDetailAdjustmentMap(itemDeðŸ”µ</abbr></span>
<span class="8052115462234529390" onmouseenter="enter('8052115462234529390');" onmouseout="out('8052115462234529390');" style=""> 430         if (itemDetail.getQuantity() != promotableDetail.getQuantity()) {                                </span>
<span class="8615443511774170500" onmouseenter="enter('8615443511774170500');" onmouseout="out('8615443511774170500');" style=""> 431             itemDetail.setQuantity(promotableDetail.getQuantity());                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 432         }                                                                                                </span>
<span class="-7750740315935940052" onmouseenter="enter('-7750740315935940052');" onmouseout="out('-7750740315935940052');" style=""> 433         if (promotableDetail.isAdjustmentsFinalized()) {                                                 </span>
<span class="8693299076047883645" onmouseenter="enter('8693299076047883645');" onmouseout="out('8693299076047883645');" style=""> 434             itemDetail.setUseSalePrice(promotableDetail.useSaleAdjustments());                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 435         }                                                                                                </span>
<span class="-200913113255250114" onmouseenter="enter('-200913113255250114');" onmouseout="out('-200913113255250114');" style=""><abbr title=" 436         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjustments()) {"> 436         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjusðŸ”µ</abbr></span>
<span class="6578727718670889454" onmouseenter="enter('6578727718670889454');" onmouseout="out('6578727718670889454');" style=""><abbr title=" 437             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferId());"> 437             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferIðŸ”µ</abbr></span>
<span class="-5676819544918869237" onmouseenter="enter('-5676819544918869237');" onmouseout="out('-5676819544918869237');" style=""> 438             if (itemAdjustment != null) {                                                                </span>
<span class="2095963063095688848" onmouseenter="enter('2095963063095688848');" onmouseout="out('2095963063095688848');" style=""> 439                 // Update existing adjustment                                                            </span>
<span class="4997906471413856597" onmouseenter="enter('4997906471413856597');" onmouseout="out('4997906471413856597');" style=""> 440                 if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {                </span>
<span class="-7190567157504063803" onmouseenter="enter('-7190567157504063803');" onmouseout="out('-7190567157504063803');" style=""> 441                     updateItemAdjustment(itemAdjustment, adjustment);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 442                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 443             } else {                                                                                     </span>
<span class="-3662936612993896923" onmouseenter="enter('-3662936612993896923');" onmouseout="out('-3662936612993896923');" style=""> 444                 // Add a new adjustment                                                                  </span>
<span class="6730722799913825373" onmouseenter="enter('6730722799913825373');" onmouseout="out('6730722799913825373');" style=""> 445                 final OrderItemPriceDetailAdjustment newItemAdjustment;                                  </span>
<span class="-3180324819813272445" onmouseenter="enter('-3180324819813272445');" onmouseout="out('-3180324819813272445');" style=""> 446                 ExtensionResultHolder resultHolder = new ExtensionResultHolder();                        </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 447                 if (extensionManager != null) {                                                          </span>
<span class="4841855343164111630" onmouseenter="enter('4841855343164111630');" onmouseout="out('4841855343164111630');" style=""> 448                     extensionManager.createOrderItemPriceDetailAdjustment(resultHolder, itemDetail);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 449                 }                                                                                        </span>
<span class="654166076296765709" onmouseenter="enter('654166076296765709');" onmouseout="out('654166076296765709');" style=""><abbr title=" 450                 if ((resultHolder != null) &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetailAdjustment&quot;)) {"> 450                 if ((resultHolder != null) &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetðŸ”µ</abbr></span>
<span class="8955091055916014215" onmouseenter="enter('8955091055916014215');" onmouseout="out('8955091055916014215');" style=""><abbr title=" 451                     newItemAdjustment = ((OrderItemPriceDetailAdjustment) (resultHolder.getContextMap().get(&quot;OrderItemPriceDetailAdjustment&quot;)));"> 451                     newItemAdjustment = ((OrderItemPriceDetailAdjustment) (resultHolder.getContextMap().gðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 452                 } else {                                                                                 </span>
<span class="3374546574285123670" onmouseenter="enter('3374546574285123670');" onmouseout="out('3374546574285123670');" style=""> 453                     newItemAdjustment = offerDao.createOrderItemPriceDetailAdjustment();                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 454                 }                                                                                        </span>
<span class="6434193420407019930" onmouseenter="enter('6434193420407019930');" onmouseout="out('6434193420407019930');" style=""> 455                 newItemAdjustment.init(itemDetail, adjustment.getOffer(), null);                         </span>
<span class="2527816204760883975" onmouseenter="enter('2527816204760883975');" onmouseout="out('2527816204760883975');" style=""> 456                 updateItemAdjustment(newItemAdjustment, adjustment);                                     </span>
<span class="280404668024484347" onmouseenter="enter('280404668024484347');" onmouseout="out('280404668024484347');" style=""> 457                 itemDetail.getOrderItemPriceDetailAdjustments().add(newItemAdjustment);                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 458             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 459         }                                                                                                </span>
<span class="2716703745442399701" onmouseenter="enter('2716703745442399701');" onmouseout="out('2716703745442399701');" style=""> 460         if (itemAdjustmentMap.size() &gt; 0) {                                                              </span>
<span class="7320812723157924979" onmouseenter="enter('7320812723157924979');" onmouseout="out('7320812723157924979');" style=""> 461             // Remove adjustments that were on the order item but no longer needed.                      </span>
<span class="-1869846822270594411" onmouseenter="enter('-1869846822270594411');" onmouseout="out('-1869846822270594411');" style=""> 462             List&lt;Long&gt; adjustmentIdsToRemove = new ArrayList&lt;Long&gt;();                                    </span>
<span class="8226461738127611440" onmouseenter="enter('8226461738127611440');" onmouseout="out('8226461738127611440');" style=""> 463             for (OrderItemPriceDetailAdjustment adjustmentToRemove : itemAdjustmentMap.values()) {       </span>
<span class="-5089858163100858042" onmouseenter="enter('-5089858163100858042');" onmouseout="out('-5089858163100858042');" style=""> 464                 adjustmentIdsToRemove.add(adjustmentToRemove.getOffer().getId());                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 465             }                                                                                            </span>
<span class="-713707707098991740" onmouseenter="enter('-713707707098991740');" onmouseout="out('-713707707098991740');" style=""><abbr title=" 466             Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustments().iterator();"> 466             Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustmðŸ”µ</abbr></span>
<span class="977968488612897428" onmouseenter="enter('977968488612897428');" onmouseout="out('977968488612897428');" style=""> 467             while (iterator.hasNext()) {                                                                 </span>
<span class="-6499043821118944641" onmouseenter="enter('-6499043821118944641');" onmouseout="out('-6499043821118944641');" style=""> 468                 OrderItemPriceDetailAdjustment adj = iterator.next();                                    </span>
<span class="-3830175641101683618" onmouseenter="enter('-3830175641101683618');" onmouseout="out('-3830175641101683618');" style=""> 469                 if (adjustmentIdsToRemove.contains(adj.getOffer().getId())) {                            </span>
<span class="-6215380074365660212" onmouseenter="enter('-6215380074365660212');" onmouseout="out('-6215380074365660212');" style=""> 470                     iterator.remove();                                                                   </span>
<span class="-7443090736167231390" onmouseenter="enter('-7443090736167231390');" onmouseout="out('-7443090736167231390');" style=""> 471                     entityService.remove(adj);                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 472                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 473             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 474         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 475     }                                                                                                    </span>
<span  style=""> 476                                                                                                          </span>
<span class="-2179044478542157534" onmouseenter="enter('-2179044478542157534');" onmouseout="out('-2179044478542157534');" style=""> 477     protected void updateItemAdjustment(OrderItemPriceDetailAdjustment itemAdjustment,                   </span>
<span class="-2091009272129273931" onmouseenter="enter('-2091009272129273931');" onmouseout="out('-2091009272129273931');" style=""> 478             PromotableOrderItemPriceDetailAdjustment promotableAdjustment) {                             </span>
<span class="8984388188384789298" onmouseenter="enter('8984388188384789298');" onmouseout="out('8984388188384789298');" style=""> 479         itemAdjustment.setValue(promotableAdjustment.getAdjustmentValue());                              </span>
<span class="-1504764115388345009" onmouseenter="enter('-1504764115388345009');" onmouseout="out('-1504764115388345009');" style=""> 480         itemAdjustment.setSalesPriceValue(promotableAdjustment.getSaleAdjustmentValue());                </span>
<span class="8159218742886391276" onmouseenter="enter('8159218742886391276');" onmouseout="out('8159218742886391276');" style=""> 481         itemAdjustment.setRetailPriceValue(promotableAdjustment.getRetailAdjustmentValue());             </span>
<span class="-6000420337005117738" onmouseenter="enter('-6000420337005117738');" onmouseout="out('-6000420337005117738');" style=""> 482         itemAdjustment.setAppliedToSalePrice(promotableAdjustment.isAppliedToSalePrice());               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 483     }                                                                                                    </span>
<span  style=""> 484                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 485     @Override                                                                                            </span>
<span class="960113845441470732" onmouseenter="enter('960113845441470732');" onmouseout="out('960113845441470732');" style=""><abbr title=" 486     public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMap, Iterator&lt;? extends OrderItemPriceDetail&gt; pdIterator) {"> 486     public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMapðŸ”µ</abbr></span>
<span class="5054006045083210855" onmouseenter="enter('5054006045083210855');" onmouseout="out('5054006045083210855');" style=""> 487         while (pdIterator.hasNext()) {                                                                   </span>
<span class="3750310726725232966" onmouseenter="enter('3750310726725232966');" onmouseout="out('3750310726725232966');" style=""> 488             OrderItemPriceDetail currentDetail = pdIterator.next();                                      </span>
<span class="6581958837024527183" onmouseenter="enter('6581958837024527183');" onmouseout="out('6581958837024527183');" style=""> 489             if (unmatchedDetailsMap.containsKey(currentDetail.getId())) {                                </span>
<span class="-6186712185724981265" onmouseenter="enter('-6186712185724981265');" onmouseout="out('-6186712185724981265');" style=""> 490                 pdIterator.remove();                                                                     </span>
<span class="-4950660564716836933" onmouseenter="enter('-4950660564716836933');" onmouseout="out('-4950660564716836933');" style=""> 491                 entityService.remove(currentDetail);                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 492             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 493         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 494     }                                                                                                    </span>
<span  style=""> 495                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 496     @Override                                                                                            </span>
<span class="-4616317615752828128" onmouseenter="enter('-4616317615752828128');" onmouseout="out('-4616317615752828128');" style=""><abbr title=" 497     public void removeUnmatchedQualifiers(Map&lt;Long, ? extends OrderItemQualifier&gt; unmatchedQualifiersMap, Iterator&lt;? extends OrderItemQualifier&gt; qIterator) {"> 497     public void removeUnmatchedQualifiers(Map&lt;Long, ? extends OrderItemQualifier&gt; unmatchedQualifiersMap,ðŸ”µ</abbr></span>
<span class="2447020288494192331" onmouseenter="enter('2447020288494192331');" onmouseout="out('2447020288494192331');" style=""> 498         while (qIterator.hasNext()) {                                                                    </span>
<span class="-6005719546303323499" onmouseenter="enter('-6005719546303323499');" onmouseout="out('-6005719546303323499');" style=""> 499             OrderItemQualifier currentQualifier = qIterator.next();                                      </span>
<span class="662385347998037693" onmouseenter="enter('662385347998037693');" onmouseout="out('662385347998037693');" style=""> 500             if (unmatchedQualifiersMap.containsKey(currentQualifier.getId())) {                          </span>
<span class="-5446309343821913287" onmouseenter="enter('-5446309343821913287');" onmouseout="out('-5446309343821913287');" style=""> 501                 qIterator.remove();                                                                      </span>
<span class="-863522997969238164" onmouseenter="enter('-863522997969238164');" onmouseout="out('-863522997969238164');" style=""> 502                 entityService.remove(currentQualifier);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 503             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 504         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 505     }                                                                                                    </span>
<span  style=""> 506                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 507     @Override                                                                                            </span>
<span class="-4444436672341398789" onmouseenter="enter('-4444436672341398789');" onmouseout="out('-4444436672341398789');" style=""><abbr title=" 508     public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; qualifiersMap) {"> 508     public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OðŸ”µ</abbr></span>
<span class="5670547093193511713" onmouseenter="enter('5670547093193511713');" onmouseout="out('5670547093193511713');" style=""> 509         Money qualifyingItemSubTotal = offer.getQualifyingItemSubTotal();                                </span>
<span class="-5062121077129985722" onmouseenter="enter('-5062121077129985722');" onmouseout="out('-5062121077129985722');" style=""> 510         if (qualifyingItemSubTotal == null || qualifyingItemSubTotal.lessThanOrEqual(Money.ZERO)) {      </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 511             return true;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 512         }                                                                                                </span>
<span class="-7755694615807420902" onmouseenter="enter('-7755694615807420902');" onmouseout="out('-7755694615807420902');" style=""> 513         return orderMeetsProvidedSubtotalRequirement(offer, qualifiersMap, qualifyingItemSubTotal);      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 514     }                                                                                                    </span>
<span  style=""> 515                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 516     @Override                                                                                            </span>
<span class="-5677301022020811119" onmouseenter="enter('-5677301022020811119');" onmouseout="out('-5677301022020811119');" style=""><abbr title=" 517     public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; targetsMap) {"> 517     public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferðŸ”µ</abbr></span>
<span class="6988724665629485016" onmouseenter="enter('6988724665629485016');" onmouseout="out('6988724665629485016');" style=""> 518         Money targetMinSubTotal = offer.getTargetMinSubTotal();                                          </span>
<span class="-1489567751755997812" onmouseenter="enter('-1489567751755997812');" onmouseout="out('-1489567751755997812');" style=""> 519         if (targetMinSubTotal == null || targetMinSubTotal.lessThanOrEqual(Money.ZERO)) {                </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 520             return true;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 521         }                                                                                                </span>
<span class="7580465799834058252" onmouseenter="enter('7580465799834058252');" onmouseout="out('7580465799834058252');" style=""> 522         return orderMeetsProvidedSubtotalRequirement(offer, targetsMap, targetMinSubTotal);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 523     }                                                                                                    </span>
<span  style=""> 524                                                                                                          </span>
<span class="8829500236577947895" onmouseenter="enter('8829500236577947895');" onmouseout="out('8829500236577947895');" style=""><abbr title=" 525     protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; promotableOrderItems, Money minSubTotal) {"> 525     protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;ðŸ”µ</abbr></span>
<span class="-6106353390255483233" onmouseenter="enter('-6106353390255483233');" onmouseout="out('-6106353390255483233');" style=""> 526         Money subtotal = Money.ZERO;                                                                     </span>
<span  style=""> 527                                                                                                          </span>
<span class="1373302773933084970" onmouseenter="enter('1373302773933084970');" onmouseout="out('1373302773933084970');" style=""> 528         for (OfferItemCriteria itemCriteria : promotableOrderItems.keySet()) {                           </span>
<span class="-419579307951366052" onmouseenter="enter('-419579307951366052');" onmouseout="out('-419579307951366052');" style=""> 529             List&lt;PromotableOrderItem&gt; promotableItems = promotableOrderItems.get(itemCriteria);          </span>
<span  style=""> 530                                                                                                          </span>
<span class="-1903041170653165047" onmouseenter="enter('-1903041170653165047');" onmouseout="out('-1903041170653165047');" style=""> 531             for (PromotableOrderItem item : promotableItems) {                                           </span>
<span class="7600253327963384600" onmouseenter="enter('7600253327963384600');" onmouseout="out('7600253327963384600');" style=""> 532                 boolean shouldApplyDiscountToSalePrice = offer.getApplyDiscountToSalePrice();            </span>
<span class="779941574682415153" onmouseenter="enter('779941574682415153');" onmouseout="out('779941574682415153');" style=""><abbr title=" 533                 Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrice);"> 533                 Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrðŸ”µ</abbr></span>
<span class="215414280986961901" onmouseenter="enter('215414280986961901');" onmouseout="out('215414280986961901');" style=""> 534                 int quantity = item.getQuantity();                                                       </span>
<span  style=""> 535                                                                                                          </span>
<span class="-2934463286963984250" onmouseenter="enter('-2934463286963984250');" onmouseout="out('-2934463286963984250');" style=""> 536                 Money lineItemAmount = priceBeforeAdjustments.multiply(quantity);                        </span>
<span class="-3511635498964788361" onmouseenter="enter('-3511635498964788361');" onmouseout="out('-3511635498964788361');" style=""> 537                 subtotal = subtotal.add(lineItemAmount);                                                 </span>
<span class="-2129121979744538843" onmouseenter="enter('-2129121979744538843');" onmouseout="out('-2129121979744538843');" style=""> 538                 if (subtotal.greaterThanOrEqual(minSubTotal)) {                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 539                     return true;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 540                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 541             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 542         }                                                                                                </span>
<span  style=""> 543                                                                                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 544         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 545     }                                                                                                    </span>
<span  style=""> 546                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 547     @Override                                                                                            </span>
<span class="6911813483912566048" onmouseenter="enter('6911813483912566048');" onmouseout="out('6911813483912566048');" style=""> 548     public boolean orderMeetsSubtotalRequirements(PromotableOrder order, Offer offer) {                  </span>
<span class="8114201548143186402" onmouseenter="enter('8114201548143186402');" onmouseout="out('8114201548143186402');" style=""> 549         Money orderMinSubTotal = offer.getOrderMinSubTotal();                                            </span>
<span class="5846170175083841610" onmouseenter="enter('5846170175083841610');" onmouseout="out('5846170175083841610');" style=""> 550         return orderMinSubTotal == null                                                                  </span>
<span class="774150812299602505" onmouseenter="enter('774150812299602505');" onmouseout="out('774150812299602505');" style=""> 551                 || orderMinSubTotal.lessThanOrEqual(Money.ZERO)                                          </span>
<span class="722443493012604709" onmouseenter="enter('722443493012604709');" onmouseout="out('722443493012604709');" style=""> 552                 || orderMinSubTotal.lessThanOrEqual(order.getOrder().getSubTotal());                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 553     }                                                                                                    </span>
<span  style=""> 554                                                                                                          </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 555     public PromotableItemFactory getPromotableItemFactory() {                                            </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 556         return promotableItemFactory;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 557     }                                                                                                    </span>
<span  style=""> 558                                                                                                          </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 559     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                  </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 560         this.promotableItemFactory = promotableItemFactory;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 561     }                                                                                                    </span>
<span  style=""> 562                                                                                                          </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 563     public OfferDao getOfferDao() {                                                                      </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 564         return offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 565     }                                                                                                    </span>
<span  style=""> 566                                                                                                          </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 567     public void setOfferDao(OfferDao offerDao) {                                                         </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 568         this.offerDao = offerDao;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 569     }                                                                                                    </span>
<span  style=""> 570                                                                                                          </span>
<span class="1819436800301003916" onmouseenter="enter('1819436800301003916');" onmouseout="out('1819436800301003916');" style=""> 571     public GenericEntityService getGenericEntityService() {                                              </span>
<span class="7308888892573915137" onmouseenter="enter('7308888892573915137');" onmouseout="out('7308888892573915137');" style=""> 572         return entityService;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 573     }                                                                                                    </span>
<span  style=""> 574                                                                                                          </span>
<span class="-2936727373443336006" onmouseenter="enter('-2936727373443336006');" onmouseout="out('-2936727373443336006');" style=""> 575     public void setGenericEntityService(GenericEntityService entityService) {                            </span>
<span class="8545056668351819980" onmouseenter="enter('8545056668351819980');" onmouseout="out('8545056668351819980');" style=""> 576         this.entityService = entityService;                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 577     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 578 }                                                                                                        </span>


























</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3   * BroadleafCommerce Framework                                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18  package org.broadleafcommerce.core.offer.service;                                                                 </span>
<span  style="">  19                                                                                                                    </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  22  import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                              </span>
<span class="-274639712180431568" onmouseenter="enter('-274639712180431568');" onmouseout="out('-274639712180431568');" style="">  23  import org.broadleafcommerce.common.money.Money;                                                                  </span>

<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  24  import org.broadleafcommerce.core.offer.dao.OfferDao;                                                             </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  25  import org.broadleafcommerce.core.offer.domain.Offer;                                                             </span>
<span class="-6494010243902923492" onmouseenter="enter('-6494010243902923492');" onmouseout="out('-6494010243902923492');" style="">  26  import org.broadleafcommerce.core.offer.domain.OfferItemCriteria;                                                 </span>
<span class="278382103026396276" onmouseenter="enter('278382103026396276');" onmouseout="out('278382103026396276');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import org.broadleafcommerce.core.offer.domain.OfferPriceData;                                                    </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  28  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                                    </span>
<span class="6002542247348180004" onmouseenter="enter('6002542247348180004');" onmouseout="out('6002542247348180004');" style="">  29  import org.broadleafcommerce.core.offer.service.discount.PromotionDiscount;                                       </span>
<span class="180286745313216238" onmouseenter="enter('180286745313216238');" onmouseout="out('180286745313216238');" style="">  30  import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;                                      </span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  31  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;                     </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  32  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                            </span>
<span class="5738750158392070" onmouseenter="enter('5738750158392070');" onmouseout="out('5738750158392070');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;                           </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  34  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                                  </span>
<span class="-7733804833771661823" onmouseenter="enter('-7733804833771661823');" onmouseout="out('-7733804833771661823');" style="">  35  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;                              </span>
<span class="2677462620955414718" onmouseenter="enter('2677462620955414718');" onmouseout="out('2677462620955414718');" style="">  36  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;                   </span>
<span class="-5097841332942556730" onmouseenter="enter('-5097841332942556730');" onmouseout="out('-5097841332942556730');" style="">  37  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;         </span>
<span class="6922194440736558195" onmouseenter="enter('6922194440736558195');" onmouseout="out('6922194440736558195');" style="">  38  import org.broadleafcommerce.core.offer.service.processor.ItemOfferMarkTargets;                                   </span>
<span class="-4077086760777187101" onmouseenter="enter('-4077086760777187101');" onmouseout="out('-4077086760777187101');" style="">  39  import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;                                                 </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  40  import org.broadleafcommerce.core.order.domain.Order;                                                             </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  41  import org.broadleafcommerce.core.order.domain.OrderItem;                                                         </span>
<span class="-1764233193646247473" onmouseenter="enter('-1764233193646247473');" onmouseout="out('-1764233193646247473');" style="">  42  import org.broadleafcommerce.core.order.domain.OrderItemContainer;                                                </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  43  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                              </span>
<span class="573363609456981556" onmouseenter="enter('573363609456981556');" onmouseout="out('573363609456981556');" style="">  44  import org.broadleafcommerce.core.order.domain.OrderItemQualifier;                                                </span>
<span class="-3230016162556687469" onmouseenter="enter('-3230016162556687469');" onmouseout="out('-3230016162556687469');" style="">  45  import org.broadleafcommerce.core.order.domain.dto.OrderItemHolder;                                               </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  46  import org.springframework.stereotype.Service;                                                                    </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  47 -                                                                                                                  </span>

<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  48  import java.util.ArrayList;                                                                                       </span>
<span class="2187055016371707860" onmouseenter="enter('2187055016371707860');" onmouseout="out('2187055016371707860');" style="">  49  import java.util.Collections;                                                                                     </span>
<span class="4561244361960433187" onmouseenter="enter('4561244361960433187');" onmouseout="out('4561244361960433187');" style="">  50  import java.util.Comparator;                                                                                      </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  51  import java.util.HashMap;                                                                                         </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  52  import java.util.Iterator;                                                                                        </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  53  import java.util.List;                                                                                            </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  54  import java.util.Map;                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  55 -                                                                                                                  </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  56  import javax.annotation.Resource;                                                                                 </span>
<span  style="">  57                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  58  /**                                                                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  59   *                                                                                                                </span>
<span class="3680448680235302484" onmouseenter="enter('3680448680235302484');" onmouseout="out('3680448680235302484');" style="">  60   * @author bpolster                                                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  61   *                                                                                                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  62   */                                                                                                               </span>
<span class="-7533628443457811418" onmouseenter="enter('-7533628443457811418');" onmouseout="out('-7533628443457811418');" style="">  63  @Service(&quot;blOfferServiceUtilities&quot;)                                                                               </span>
<span class="6914343992633091500" onmouseenter="enter('6914343992633091500');" onmouseout="out('6914343992633091500');" style="">  64  public class OfferServiceUtilitiesImpl implements OfferServiceUtilities {                                         </span>
<span class="-7057195126687856185" onmouseenter="enter('-7057195126687856185');" onmouseout="out('-7057195126687856185');" style="">  65      protected static final Log LOG = LogFactory.getLog(OfferServiceUtilitiesImpl.class);                          </span>
<span  style="">  66                                                                                                                    </span>
<span class="5938907043749528173" onmouseenter="enter('5938907043749528173');" onmouseout="out('5938907043749528173');" style="">  67      @Resource(name = &quot;blPromotableItemFactory&quot;)                                                                   </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style="">  68      protected PromotableItemFactory promotableItemFactory;                                                        </span>
<span  style="">  69                                                                                                                    </span>
<span class="5779429748772127951" onmouseenter="enter('5779429748772127951');" onmouseout="out('5779429748772127951');" style="">  70      @Resource(name = &quot;blOfferDao&quot;)                                                                                </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  71      protected OfferDao offerDao;                                                                                  </span>
<span  style="">  72                                                                                                                    </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style="">  73      @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                            </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style="">  74      protected OfferServiceExtensionManager extensionManager;                                                      </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +                                                                                                                  </span>
<span class="-5969569842164006358" onmouseenter="enter('-5969569842164006358');" onmouseout="out('-5969569842164006358');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +    protected final PromotableOfferUtility promotableOfferUtility;                                                </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +                                                                                                                  </span>
<span class="-3896079782246475371" onmouseenter="enter('-3896079782246475371');" onmouseout="out('-3896079782246475371');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +    public OfferServiceUtilitiesImpl(PromotableOfferUtility promotableOfferUtility) {                             </span>
<span class="-7394468295291059120" onmouseenter="enter('-7394468295291059120');" onmouseout="out('-7394468295291059120');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +        this.promotableOfferUtility = promotableOfferUtility;                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +    }                                                                                                             </span>
<span  style="">  81                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  82      @Override                                                                                                     </span>
<span class="6223480568976573314" onmouseenter="enter('6223480568976573314');" onmouseout="out('6223480568976573314');" style=""><abbr title="  83      public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  83      public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrðŸ”µ</abbr></span>
<span class="7055525017697292208" onmouseenter="enter('7055525017697292208');" onmouseout="out('7055525017697292208');" style="">  84          Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  85      }                                                                                                             </span>
<span  style="">  86                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  87      @Override                                                                                                     </span>
<span class="-4185121765520276478" onmouseenter="enter('-4185121765520276478');" onmouseout="out('-4185121765520276478');" style=""><abbr title="  88      public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  88      public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalðŸ”µ</abbr></span>
<span class="7055525017697292208" onmouseenter="enter('7055525017697292208');" onmouseout="out('7055525017697292208');" style="">  89          Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  90      }                                                                                                             </span>
<span  style="">  91                                                                                                                    </span>
<span class="8076072330480389618" onmouseenter="enter('8076072330480389618');" onmouseout="out('8076072330480389618');" style=""><abbr title="  92      protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyToSalePrice) {">  92      protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyToSalePricðŸ”µ</abbr></span>
<span class="3297095837477520472" onmouseenter="enter('3297095837477520472');" onmouseout="out('3297095837477520472');" style="">  93          return new Comparator&lt;PromotableOrderItemPriceDetail&gt;() {                                                 </span>
<span  style="">  94                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  95              @Override                                                                                             </span>
<span class="-2961106138566190059" onmouseenter="enter('-2961106138566190059');" onmouseout="out('-2961106138566190059');" style="">  96              public int compare(PromotableOrderItemPriceDetail o1, PromotableOrderItemPriceDetail o2) {            </span>
<span class="7675869656754073027" onmouseenter="enter('7675869656754073027');" onmouseout="out('7675869656754073027');" style="">  97                  Money price = o1.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);            </span>
<span class="-2386281537779196104" onmouseenter="enter('-2386281537779196104');" onmouseout="out('-2386281537779196104');" style="">  98                  Money price2 = o2.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);           </span>
<span  style="">  99                                                                                                                    </span>
<span class="-7980156687270114839" onmouseenter="enter('-7980156687270114839');" onmouseout="out('-7980156687270114839');" style=""> 100                  // highest amount first                                                                           </span>
<span class="-5413989484138410778" onmouseenter="enter('-5413989484138410778');" onmouseout="out('-5413989484138410778');" style=""> 101                  return price2.compareTo(price);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 102              }                                                                                                     </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 103          };                                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 104      }                                                                                                             </span>
<span  style=""> 105                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 106      @Override                                                                                                     </span>
<span class="-6633188601276085642" onmouseenter="enter('-6633188601276085642');" onmouseout="out('-6633188601276085642');" style=""> 107      public OrderItem findRelatedQualifierRoot(OrderItem relatedQualifier) {                                       </span>
<span class="1807144252798273266" onmouseenter="enter('1807144252798273266');" onmouseout="out('1807144252798273266');" style=""> 108          OrderItem relatedQualifierRoot = null;                                                                    </span>
<span class="-5368473621929304561" onmouseenter="enter('-5368473621929304561');" onmouseout="out('-5368473621929304561');" style=""> 109          if (relatedQualifier != null) {                                                                           </span>
<span class="-5398594526726109873" onmouseenter="enter('-5398594526726109873');" onmouseout="out('-5398594526726109873');" style=""> 110              relatedQualifierRoot = relatedQualifier;                                                              </span>
<span class="7824588639878219390" onmouseenter="enter('7824588639878219390');" onmouseout="out('7824588639878219390');" style=""> 111              while (relatedQualifierRoot.getParentOrderItem() != null) {                                           </span>
<span class="-2176101432970038375" onmouseenter="enter('-2176101432970038375');" onmouseout="out('-2176101432970038375');" style=""> 112                  relatedQualifierRoot = relatedQualifierRoot.getParentOrderItem();                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 113              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 114          }                                                                                                         </span>
<span class="-6121768564377108608" onmouseenter="enter('-6121768564377108608');" onmouseout="out('-6121768564377108608');" style=""> 115          return relatedQualifierRoot;                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 116      }                                                                                                             </span>
<span  style=""> 117                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 118      @Override                                                                                                     </span>
<span class="8600807536713378155" onmouseenter="enter('8600807536713378155');" onmouseout="out('8600807536713378155');" style=""><abbr title=" 119      public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; details) {"> 119      public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetaðŸ”µ</abbr></span>
<span  style=""> 120                                                                                                                    </span>
<span class="-4790953179105551104" onmouseenter="enter('-4790953179105551104');" onmouseout="out('-4790953179105551104');" style=""> 121          for (PromotableOrderItemPriceDetail detail : details) {                                                   </span>
<span class="1975158128642033085" onmouseenter="enter('1975158128642033085');" onmouseout="out('1975158128642033085');" style=""> 122              for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustments()) {    </span>
<span class="30696373439585907" onmouseenter="enter('30696373439585907');" onmouseout="out('30696373439585907');" style=""> 123                  if (adjustment.isTotalitarian() || itemOffer.getOffer().isTotalitarianOffer()) {                  </span>
<span class="-7120250698956357960" onmouseenter="enter('-7120250698956357960');" onmouseout="out('-7120250698956357960');" style=""> 124                      // A totalitarian offer has already been applied or this offer is totalitarian                </span>
<span class="-7934044302077364434" onmouseenter="enter('-7934044302077364434');" onmouseout="out('-7934044302077364434');" style=""> 125                      // and another offer was already applied.                                                     </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 126                      return false;                                                                                 </span>
<span class="5154499828715066004" onmouseenter="enter('5154499828715066004');" onmouseout="out('5154499828715066004');" style=""> 127                  } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {   </span>
<span class="721506122397233060" onmouseenter="enter('721506122397233060');" onmouseout="out('721506122397233060');" style=""> 128                      // A nonCombinable offer has been applied or this is a non-combinable offer                   </span>
<span class="1625719735315035531" onmouseenter="enter('1625719735315035531');" onmouseout="out('1625719735315035531');" style=""> 129                      // and adjustments have already been applied.                                                 </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 130                      return false;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 131                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 132              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 133          }                                                                                                         </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 134          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 135      }                                                                                                             </span>
<span  style=""> 136                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 137      @Override                                                                                                     </span>
<span class="-3713458578644525384" onmouseenter="enter('-3713458578644525384');" onmouseout="out('-3713458578644525384');" style=""> 138      public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCriteria,  </span>
<span class="-9206127464517457513" onmouseenter="enter('-9206127464517457513');" onmouseout="out('-9206127464517457513');" style=""> 139              List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {                                                  </span>
<span  style=""> 140                                                                                                                    </span>
<span class="1399559222284052069" onmouseenter="enter('1399559222284052069');" onmouseout="out('1399559222284052069');" style=""> 141          sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());               </span>
<span  style=""> 142                                                                                                                    </span>
<span class="-2005578619141057452" onmouseenter="enter('-2005578619141057452');" onmouseout="out('-2005578619141057452');" style=""> 143          // Calculate the number of qualifiers needed that will not receive the promotion.                         </span>
<span class="-7642725860669587391" onmouseenter="enter('-7642725860669587391');" onmouseout="out('-7642725860669587391');" style=""> 144          // These will be reserved first before the target is assigned.                                            </span>
<span class="-5221545606159729582" onmouseenter="enter('-5221545606159729582');" onmouseout="out('-5221545606159729582');" style=""> 145          int qualifierQtyNeeded = itemCriteria.getQuantity();                                                      </span>
<span  style=""> 146                                                                                                                    </span>
<span class="-389357445740262218" onmouseenter="enter('-389357445740262218');" onmouseout="out('-389357445740262218');" style=""> 147          for (PromotableOrderItemPriceDetail detail : priceDetails) {                                              </span>
<span  style=""> 148                                                                                                                    </span>
<span class="-7196228531210809782" onmouseenter="enter('-7196228531210809782');" onmouseout="out('-7196228531210809782');" style=""> 149              // Mark Qualifiers                                                                                    </span>
<span class="7203543687533075574" onmouseenter="enter('7203543687533075574');" onmouseout="out('7203543687533075574');" style=""> 150              if (qualifierQtyNeeded &gt; 0) {                                                                         </span>
<span class="4739725621440457335" onmouseenter="enter('4739725621440457335');" onmouseout="out('4739725621440457335');" style=""><abbr title=" 151                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 151                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOfferðŸ”µ</abbr></span>
<span class="118721626032663442" onmouseenter="enter('118721626032663442');" onmouseout="out('118721626032663442');" style=""> 152                  if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {                                                    </span>
<span class="156141582657617565" onmouseenter="enter('156141582657617565');" onmouseout="out('156141582657617565');" style=""> 153                      int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier); </span>
<span class="-4684084580161696213" onmouseenter="enter('-4684084580161696213');" onmouseout="out('-4684084580161696213');" style=""> 154                      qualifierQtyNeeded -= qtyToMarkAsQualifier;                                                   </span>
<span class="-5539919712790669425" onmouseenter="enter('-5539919712790669425');" onmouseout="out('-5539919712790669425');" style=""> 155                      detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 156                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 157              }                                                                                                     </span>
<span  style=""> 158                                                                                                                    </span>
<span class="8517154315660472641" onmouseenter="enter('8517154315660472641');" onmouseout="out('8517154315660472641');" style=""> 159              if (qualifierQtyNeeded == 0) {                                                                        </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 160                  break;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 162          }                                                                                                         </span>
<span class="-4850383672896867816" onmouseenter="enter('-4850383672896867816');" onmouseout="out('-4850383672896867816');" style=""> 163          return qualifierQtyNeeded;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 164      }                                                                                                             </span>
<span  style=""> 165                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 166      @Override                                                                                                     </span>
<span class="-690144452707146894" onmouseenter="enter('-690144452707146894');" onmouseout="out('-690144452707146894');" style=""> 167      public int markTargetsForCriteria(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,         </span>
<span class="-7065312759813139704" onmouseenter="enter('-7065312759813139704');" onmouseout="out('-7065312759813139704');" style=""> 168              boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriteria,   </span>
<span class="2702959100637307406" onmouseenter="enter('2702959100637307406');" onmouseout="out('2702959100637307406');" style=""> 169              List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, int targetQtyNeeded) {                             </span>
<span class="2114191821955736127" onmouseenter="enter('2114191821955736127');" onmouseout="out('2114191821955736127');" style=""> 170          for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {                                         </span>
<span class="-5368473621929304561" onmouseenter="enter('-5368473621929304561');" onmouseout="out('-5368473621929304561');" style=""> 171              if (relatedQualifier != null) {                                                                       </span>
<span class="8141493125634490263" onmouseenter="enter('8141493125634490263');" onmouseout="out('8141493125634490263');" style=""><abbr title=" 172                  // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 172                  // We need to make sure that this item is either a parent, child, or the same as the qualifier rooðŸ”µ</abbr></span>
<span class="1857856063926056091" onmouseenter="enter('1857856063926056091');" onmouseout="out('1857856063926056091');" style=""> 173                  OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();                         </span>
<span class="-3127297900577673654" onmouseenter="enter('-3127297900577673654');" onmouseout="out('-3127297900577673654');" style=""> 174                  if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp; </span>
<span class="3862062312907446706" onmouseenter="enter('3862062312907446706');" onmouseout="out('3862062312907446706');" style=""> 175                          !thisItem.equals(relatedQualifierRoot)) {                                                 </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 176                      continue;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 177                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 178              }                                                                                                     </span>
<span  style=""> 179                                                                                                                    </span>
<span class="-3899808772905023528" onmouseenter="enter('-3899808772905023528');" onmouseout="out('-3899808772905023528');" style=""> 180              int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);   </span>
<span class="1240759488807976542" onmouseenter="enter('1240759488807976542');" onmouseout="out('1240759488807976542');" style=""> 181              if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {                                                           </span>
<span class="-2152892838174945575" onmouseenter="enter('-2152892838174945575');" onmouseout="out('-2152892838174945575');" style=""><abbr title=" 182                  if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 182                  if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) ðŸ”µ</abbr></span>
<span class="-5766015035856187988" onmouseenter="enter('-5766015035856187988');" onmouseout="out('-5766015035856187988');" style=""> 183                      int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget);          </span>
<span class="-182485827533192502" onmouseenter="enter('-182485827533192502');" onmouseout="out('-182485827533192502');" style=""> 184                      targetQtyNeeded -= qtyToMarkAsTarget;                                                         </span>
<span class="-4172322390128575169" onmouseenter="enter('-4172322390128575169');" onmouseout="out('-4172322390128575169');" style=""> 185                      if (!checkOnly) {                                                                             </span>
<span class="5603549919531530635" onmouseenter="enter('5603549919531530635');" onmouseout="out('5603549919531530635');" style=""> 186                          priceDetail.addPromotionDiscount(itemOffer, itemCriteria, qtyToMarkAsTarget);             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 187                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 188                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189              }                                                                                                     </span>
<span  style=""> 190                                                                                                                    </span>
<span class="5358835008623854271" onmouseenter="enter('5358835008623854271');" onmouseout="out('5358835008623854271');" style=""> 191              if (targetQtyNeeded == 0) {                                                                           </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 192                  break;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 193              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 194          }                                                                                                         </span>
<span class="6491342130615381336" onmouseenter="enter('6491342130615381336');" onmouseout="out('6491342130615381336');" style=""> 195          return targetQtyNeeded;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +                                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +    @Override                                                                                                     </span>
<span class="1242791052414669567" onmouseenter="enter('1242791052414669567');" onmouseout="out('1242791052414669567');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 199 +    public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,"> 199 +    public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifierðŸ”µ</abbr></span>
<span class="6750137376595998298" onmouseenter="enter('6750137376595998298');" onmouseout="out('6750137376595998298');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 200 +                                                boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferPriceData offerPriceData,"> 200 +                                                boolean checkOnly, Offer promotion, OrderItem relatedQualifierRootðŸ”µ</abbr></span>
<span class="-9206127464517457513" onmouseenter="enter('-9206127464517457513');" onmouseout="out('-9206127464517457513');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +                                                List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {              </span>
<span class="3726836708123429329" onmouseenter="enter('3726836708123429329');" onmouseout="out('3726836708123429329');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +        int targetQtyNeeded = offerPriceData.getQuantity();                                                       </span>
<span class="-7840883515604062637" onmouseenter="enter('-7840883515604062637');" onmouseout="out('-7840883515604062637');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +        int minRequiredTargetQuantity = itemOffer.getMinimumRequiredTargetQuantity();                             </span>
<span class="6262197857819165625" onmouseenter="enter('6262197857819165625');" onmouseout="out('6262197857819165625');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +        if (minRequiredTargetQuantity &gt; 1 &amp;&amp; minRequiredTargetQuantity &gt; targetQtyNeeded) {                       </span>
<span class="-3324197007536454949" onmouseenter="enter('-3324197007536454949');" onmouseout="out('-3324197007536454949');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +            targetQtyNeeded = minRequiredTargetQuantity;                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +        }                                                                                                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +                                                                                                                  </span>
<span class="2114191821955736127" onmouseenter="enter('2114191821955736127');" onmouseout="out('2114191821955736127');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +        for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {                                         </span>
<span class="-5368473621929304561" onmouseenter="enter('-5368473621929304561');" onmouseout="out('-5368473621929304561');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +            if (relatedQualifier != null) {                                                                       </span>
<span class="8141493125634490263" onmouseenter="enter('8141493125634490263');" onmouseout="out('8141493125634490263');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 210 +                // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 210 +                // We need to make sure that this item is either a parent, child, or the same as the qualifier rooðŸ”µ</abbr></span>
<span class="1857856063926056091" onmouseenter="enter('1857856063926056091');" onmouseout="out('1857856063926056091');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +                OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();                         </span>
<span class="-3127297900577673654" onmouseenter="enter('-3127297900577673654');" onmouseout="out('-3127297900577673654');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +                if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp; </span>
<span class="3862062312907446706" onmouseenter="enter('3862062312907446706');" onmouseout="out('3862062312907446706');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +                        !thisItem.equals(relatedQualifierRoot)) {                                                 </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +                    continue;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +                }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +            }                                                                                                     </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +                                                                                                                  </span>
<span class="-3899808772905023528" onmouseenter="enter('-3899808772905023528');" onmouseout="out('-3899808772905023528');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +            int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);   </span>
<span class="1240759488807976542" onmouseenter="enter('1240759488807976542');" onmouseout="out('1240759488807976542');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +            if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {                                                           </span>
<span class="-2152892838174945575" onmouseenter="enter('-2152892838174945575');" onmouseout="out('-2152892838174945575');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 220 +                if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 220 +                if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) ðŸ”µ</abbr></span>
<span class="-5766015035856187988" onmouseenter="enter('-5766015035856187988');" onmouseout="out('-5766015035856187988');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +                    int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget);          </span>
<span class="-182485827533192502" onmouseenter="enter('-182485827533192502');" onmouseout="out('-182485827533192502');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +                    targetQtyNeeded -= qtyToMarkAsTarget;                                                         </span>
<span class="-4172322390128575169" onmouseenter="enter('-4172322390128575169');" onmouseout="out('-4172322390128575169');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +                    if (!checkOnly) {                                                                             </span>
<span class="6581474656927369870" onmouseenter="enter('6581474656927369870');" onmouseout="out('6581474656927369870');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +                        priceDetail.addPromotionDiscount(itemOffer, null, qtyToMarkAsTarget);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +                    }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +                }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +            }                                                                                                     </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +                                                                                                                  </span>
<span class="5358835008623854271" onmouseenter="enter('5358835008623854271');" onmouseout="out('5358835008623854271');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +            if (targetQtyNeeded == 0) {                                                                           </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +                break;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +            }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +        }                                                                                                         </span>
<span class="7942109921366184597" onmouseenter="enter('7942109921366184597');" onmouseout="out('7942109921366184597');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +        return targetQtyNeeded == 0;                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 234      }                                                                                                             </span>
<span  style=""> 235                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 236      @Override                                                                                                     </span>
<span class="-5374453289617781014" onmouseenter="enter('-5374453289617781014');" onmouseout="out('-5374453289617781014');" style=""><abbr title=" 237      public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, PromotableOrder order,"> 237      public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, PromotableOrðŸ”µ</abbr></span>
<span class="-45453231322119310" onmouseenter="enter('-45453231322119310');" onmouseout="out('-45453231322119310');" style=""> 238              OrderItemHolder orderItemHolder, OfferItemCriteria itemCriteria,                                      </span>
<span class="-532102448020563017" onmouseenter="enter('-532102448020563017');" onmouseout="out('-532102448020563017');" style=""> 239              List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets) {       </span>
<span class="1399559222284052069" onmouseenter="enter('1399559222284052069');" onmouseout="out('1399559222284052069');" style=""> 240          sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());               </span>
<span  style=""> 241                                                                                                                    </span>
<span class="-2005578619141057452" onmouseenter="enter('-2005578619141057452');" onmouseout="out('-2005578619141057452');" style=""> 242          // Calculate the number of qualifiers needed that will not receive the promotion.                         </span>
<span class="-7642725860669587391" onmouseenter="enter('-7642725860669587391');" onmouseout="out('-7642725860669587391');" style=""> 243          // These will be reserved first before the target is assigned.                                            </span>
<span class="-5221545606159729582" onmouseenter="enter('-5221545606159729582');" onmouseout="out('-5221545606159729582');" style=""> 244          int qualifierQtyNeeded = itemCriteria.getQuantity();                                                      </span>
<span  style=""> 245                                                                                                                    </span>
<span class="-389357445740262218" onmouseenter="enter('-389357445740262218');" onmouseout="out('-389357445740262218');" style=""> 246          for (PromotableOrderItemPriceDetail detail : priceDetails) {                                              </span>
<span class="-317635885918930708" onmouseenter="enter('-317635885918930708');" onmouseout="out('-317635885918930708');" style=""> 247              OrderItem oi = detail.getPromotableOrderItem().getOrderItem();                                        </span>
<span  style=""> 248                                                                                                                    </span>
<span class="7203543687533075574" onmouseenter="enter('7203543687533075574');" onmouseout="out('7203543687533075574');" style=""> 249              if (qualifierQtyNeeded &gt; 0) {                                                                         </span>
<span class="4739725621440457335" onmouseenter="enter('4739725621440457335');" onmouseout="out('4739725621440457335');" style=""><abbr title=" 250                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 250                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOfferðŸ”µ</abbr></span>
<span class="118721626032663442" onmouseenter="enter('118721626032663442');" onmouseout="out('118721626032663442');" style=""> 251                  if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {                                                    </span>
<span class="-1004810985579465662" onmouseenter="enter('-1004810985579465662');" onmouseout="out('-1004810985579465662');" style=""><abbr title=" 252                      // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some state that we"> 252                      // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some state thatðŸ”µ</abbr></span>
<span class="8185689978075296148" onmouseenter="enter('8185689978075296148');" onmouseout="out('8185689978075296148');" style=""> 253                      // might need in the future.                                                                  </span>
<span class="-1081050306738024693" onmouseenter="enter('-1081050306738024693');" onmouseout="out('-1081050306738024693');" style=""> 254                      OfferItemCriteria previousQualifierCriteria = null;                                           </span>
<span class="-8553070012108320907" onmouseenter="enter('-8553070012108320907');" onmouseout="out('-8553070012108320907');" style=""> 255                      for (PromotionQualifier possibleQualifier : detail.getPromotionQualifiers()) {                </span>
<span class="-4722657733023489778" onmouseenter="enter('-4722657733023489778');" onmouseout="out('-4722657733023489778');" style=""> 256                          if (possibleQualifier.getPromotion().equals(itemOffer.getOffer())) {                      </span>
<span class="-3028735657089400229" onmouseenter="enter('-3028735657089400229');" onmouseout="out('-3028735657089400229');" style=""> 257                              previousQualifierCriteria = possibleQualifier.getItemCriteria();                      </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 258                              break;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 259                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 260                      }                                                                                             </span>
<span  style=""> 261                                                                                                                    </span>
<span class="1008214769590136048" onmouseenter="enter('1008214769590136048');" onmouseout="out('1008214769590136048');" style=""> 262                      // Go ahead and mark this item as a qualifier                                                 </span>
<span class="156141582657617565" onmouseenter="enter('156141582657617565');" onmouseout="out('156141582657617565');" style=""> 263                      int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier); </span>
<span class="-4684084580161696213" onmouseenter="enter('-4684084580161696213');" onmouseout="out('-4684084580161696213');" style=""> 264                      qualifierQtyNeeded -= qtyToMarkAsQualifier;                                                   </span>
<span class="2797159826704329425" onmouseenter="enter('2797159826704329425');" onmouseout="out('2797159826704329425');" style=""><abbr title=" 265                      PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);"> 265                      PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualiðŸ”µ</abbr></span>
<span class="-7100200875909405519" onmouseenter="enter('-7100200875909405519');" onmouseout="out('-7100200875909405519');" style=""><abbr title=" 266                      pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOffer().getApplyDiscountToSalePrice()));"> 266                      pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOffer().getðŸ”µ</abbr></span>
<span  style=""> 267                                                                                                                    </span>
<span class="6012497254282640402" onmouseenter="enter('6012497254282640402');" onmouseout="out('6012497254282640402');" style=""> 268                      // Now, we need to see if there exists a target(s) that is suitable for this qualifier due to </span>
<span class="-1151958798348543907" onmouseenter="enter('-1151958798348543907');" onmouseout="out('-1151958798348543907');" style=""> 269                      // the relationship flag. If we are on the last qualifier required for this offer, we want to </span>
<span class="3987909966354550925" onmouseenter="enter('3987909966354550925');" onmouseout="out('3987909966354550925');" style=""> 270                      // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just want to check</span>
<span class="4959301888820404945" onmouseenter="enter('4959301888820404945');" onmouseout="out('4959301888820404945');" style=""> 271                      // that there is an eligible target(s) and continue on.                                       </span>
<span class="-5256242047209748696" onmouseenter="enter('-5256242047209748696');" onmouseout="out('-5256242047209748696');" style=""> 272                      if (itemOfferMarkTargets.markTargets(itemOffer, order, oi, true)) {                           </span>
<span class="-297796406415044190" onmouseenter="enter('-297796406415044190');" onmouseout="out('-297796406415044190');" style=""> 273                          // We found a target. Let&#x27;s save this related order item used as the qualifier in case    </span>
<span class="6348154252416536055" onmouseenter="enter('6348154252416536055');" onmouseout="out('6348154252416536055');" style=""> 274                          // we succeed                                                                             </span>
<span class="-6098537281436011553" onmouseenter="enter('-6098537281436011553');" onmouseout="out('-6098537281436011553');" style=""> 275                          orderItemHolder.setOrderItem(oi);                                                         </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 276                      } else {                                                                                      </span>
<span class="1831842559835648517" onmouseenter="enter('1831842559835648517');" onmouseout="out('1831842559835648517');" style=""><abbr title=" 277                          // If we didn&#x27;t find a target, we need to roll back how we marked this item as a qualifier."> 277                          // If we didn&#x27;t find a target, we need to roll back how we marked this item as a qualifierðŸ”µ</abbr></span>
<span class="-1853870893725774252" onmouseenter="enter('-1853870893725774252');" onmouseout="out('-1853870893725774252');" style=""> 278                          qualifierQtyNeeded += qtyToMarkAsQualifier;                                               </span>
<span class="-8128593861119500077" onmouseenter="enter('-8128593861119500077');" onmouseout="out('-8128593861119500077');" style=""> 279                          if (pq.getQuantity() == qtyToMarkAsQualifier) {                                           </span>
<span class="-6954079035160286378" onmouseenter="enter('-6954079035160286378');" onmouseout="out('-6954079035160286378');" style=""> 280                              detail.getPromotionQualifiers().remove(pq);                                           </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 281                          } else {                                                                                  </span>
<span class="6626310861157345131" onmouseenter="enter('6626310861157345131');" onmouseout="out('6626310861157345131');" style=""> 282                              pq.setItemCriteria(previousQualifierCriteria);                                        </span>
<span class="2348238745962483804" onmouseenter="enter('2348238745962483804');" onmouseout="out('2348238745962483804');" style=""> 283                              pq.setQuantity(pq.getQuantity() - qtyToMarkAsQualifier);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 284                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 285                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 286                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 287              }                                                                                                     </span>
<span  style=""> 288                                                                                                                    </span>
<span class="8517154315660472641" onmouseenter="enter('8517154315660472641');" onmouseout="out('8517154315660472641');" style=""> 289              if (qualifierQtyNeeded == 0) {                                                                        </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 290                  break;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 291              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 292          }                                                                                                         </span>
<span class="-4850383672896867816" onmouseenter="enter('-4850383672896867816');" onmouseout="out('-4850383672896867816');" style=""> 293          return qualifierQtyNeeded;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 294      }                                                                                                             </span>
<span  style=""> 295                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 296      @Override                                                                                                     </span>
<span class="-5508403457222384501" onmouseenter="enter('-5508403457222384501');" onmouseout="out('-5508403457222384501');" style=""><abbr title=" 297      public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails) {"> 297      public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItðŸ”µ</abbr></span>
<span class="-1180947180176660619" onmouseenter="enter('-1180947180176660619');" onmouseout="out('-1180947180176660619');" style=""> 298          for (PromotableOrderItemPriceDetail itemPriceDetail : itemPriceDetails) {                                 </span>
<span class="-669978432390486383" onmouseenter="enter('-669978432390486383');" onmouseout="out('-669978432390486383');" style=""> 299              for (PromotionDiscount discount : itemPriceDetail.getPromotionDiscounts()) {                          </span>
<span class="-4320063668461010504" onmouseenter="enter('-4320063668461010504');" onmouseout="out('-4320063668461010504');" style=""> 300                  if (discount.getPromotion().equals(itemOffer.getOffer())) {                                       </span>
<span class="-8948799313684021645" onmouseenter="enter('-8948799313684021645');" onmouseout="out('-8948799313684021645');" style=""><abbr title=" 301                      if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 301                      if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWithOtherOðŸ”µ</abbr></span>
<span class="8050394734563130560" onmouseenter="enter('8050394734563130560');" onmouseout="out('8050394734563130560');" style=""> 302                          // We&#x27;ve decided to apply this adjustment but if it doesn&#x27;t actually reduce               </span>
<span class="-7936715023008804819" onmouseenter="enter('-7936715023008804819');" onmouseout="out('-7936715023008804819');" style=""> 303                          // the value of the item                                                                  </span>
<span class="7229649304367309721" onmouseenter="enter('7229649304367309721');" onmouseout="out('7229649304367309721');" style=""> 304                          if (adjustmentIsNotGoodEnoughToBeApplied(itemOffer, itemPriceDetail)) {                   </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 305                              break;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 306                          }                                                                                         </span>
<span  style=""> 307                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 308                      }                                                                                             </span>
<span class="-4859405226118818324" onmouseenter="enter('-4859405226118818324');" onmouseout="out('-4859405226118818324');" style=""> 309                      OrderItem orderItem = itemPriceDetail.getPromotableOrderItem().getOrderItem();                </span>
<span class="-7036726360330387930" onmouseenter="enter('-7036726360330387930');" onmouseout="out('-7036726360330387930');" style=""> 310                      Boolean offerCanApplyToChildOrderItems = itemOffer.getOffer().getApplyToChildItems();         </span>
<span class="5319718821501044453" onmouseenter="enter('5319718821501044453');" onmouseout="out('5319718821501044453');" style=""> 311                      if (isAddOnOrderItem(orderItem) &amp;&amp; !offerCanApplyToChildOrderItems) {                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 312                          break;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 313                      }                                                                                             </span>
<span class="-2464330301917486275" onmouseenter="enter('-2464330301917486275');" onmouseout="out('-2464330301917486275');" style=""> 314                      applyOrderItemAdjustment(itemOffer, itemPriceDetail);                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 315                      break;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 316                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 317              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 318          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 319      }                                                                                                             </span>
<span  style=""> 320                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 321      @Override                                                                                                     </span>
<span class="5703716165905853432" onmouseenter="enter('5703716165905853432');" onmouseout="out('5703716165905853432');" style=""> 322      public boolean isAddOnOrderItem(OrderItem orderItem) {                                                        </span>
<span class="-915100238682069401" onmouseenter="enter('-915100238682069401');" onmouseout="out('-915100238682069401');" style=""> 323          if (DiscreteOrderItem.class.isAssignableFrom(orderItem.getClass())) {                                     </span>
<span class="-9161979270697696061" onmouseenter="enter('-9161979270697696061');" onmouseout="out('-9161979270697696061');" style=""> 324              DiscreteOrderItem discreteOrderItem = (DiscreteOrderItem) orderItem;                                  </span>
<span  style=""> 325                                                                                                                    </span>
<span class="-5356075907008875039" onmouseenter="enter('-5356075907008875039');" onmouseout="out('-5356075907008875039');" style=""> 326              Map&lt;String, String&gt; attributes = discreteOrderItem.getAdditionalAttributes();                         </span>
<span class="-4907356983337991835" onmouseenter="enter('-4907356983337991835');" onmouseout="out('-4907356983337991835');" style=""> 327              boolean isAddOnOrderItem = attributes.containsKey(&quot;addOnXrefId&quot;);                                     </span>
<span class="4227157952965713451" onmouseenter="enter('4227157952965713451');" onmouseout="out('4227157952965713451');" style=""> 328              boolean isChildOrderItem = discreteOrderItem.isChildOrderItem();                                      </span>
<span  style=""> 329                                                                                                                    </span>
<span class="8373226173169122886" onmouseenter="enter('8373226173169122886');" onmouseout="out('8373226173169122886');" style=""> 330              return isChildOrderItem &amp;&amp; isAddOnOrderItem;                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 331          }                                                                                                         </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 332          return false;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 333      }                                                                                                             </span>
<span  style=""> 334                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 335      /**                                                                                                           </span>
<span class="7835653502933924919" onmouseenter="enter('7835653502933924919');" onmouseout="out('7835653502933924919');" style=""> 336       * The adjustment might not be better than the sale price.                                                    </span>
<span class="-123895333908918857" onmouseenter="enter('-123895333908918857');" onmouseout="out('-123895333908918857');" style=""> 337       * @param itemOffer                                                                                           </span>
<span class="4317834721456676207" onmouseenter="enter('4317834721456676207');" onmouseout="out('4317834721456676207');" style=""> 338       * @param detail                                                                                              </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 339       * @return                                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 340       */                                                                                                           </span>
<span class="8886963584830850852" onmouseenter="enter('8886963584830850852');" onmouseout="out('8886963584830850852');" style=""> 341      protected boolean adjustmentIsNotGoodEnoughToBeApplied(PromotableCandidateItemOffer itemOffer,                </span>
<span class="-5789972309208145824" onmouseenter="enter('-5789972309208145824');" onmouseout="out('-5789972309208145824');" style=""> 342              PromotableOrderItemPriceDetail detail) {                                                              </span>
<span class="5404670390791397495" onmouseenter="enter('5404670390791397495');" onmouseout="out('5404670390791397495');" style=""> 343          if (!itemOffer.getOffer().getApplyDiscountToSalePrice()) {                                                </span>
<span class="2444901768581949268" onmouseenter="enter('2444901768581949268');" onmouseout="out('2444901768581949268');" style=""> 344              Money salePrice = detail.getPromotableOrderItem().getSalePriceBeforeAdjustments();                    </span>
<span class="5875272574250045376" onmouseenter="enter('5875272574250045376');" onmouseout="out('5875272574250045376');" style=""> 345              Money retailPrice = detail.getPromotableOrderItem().getRetailPriceBeforeAdjustments();                </span>
<span class="-7752206275348171601" onmouseenter="enter('-7752206275348171601');" onmouseout="out('-7752206275348171601');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 346 -            Money savings = itemOffer.calculateSavingsForOrderItem(detail.getPromotableOrderItem(), 1);           </span>
<span class="833194282646119023" onmouseenter="enter('833194282646119023');" onmouseout="out('833194282646119023');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 347 +            Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromotableOrderItem(), 1);"> 347 +            Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromotableOrdðŸ”µ</abbr></span>
<span class="-3042742338309722510" onmouseenter="enter('-3042742338309722510');" onmouseout="out('-3042742338309722510');" style=""> 348              if (salePrice != null) {                                                                              </span>
<span class="4776635754548450658" onmouseenter="enter('4776635754548450658');" onmouseout="out('4776635754548450658');" style=""> 349                  if (salePrice.lessThan(retailPrice.subtract(savings))) {                                          </span>
<span class="5206565982893115863" onmouseenter="enter('5206565982893115863');" onmouseout="out('5206565982893115863');" style=""> 350                      // Not good enough                                                                            </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 351                      return true;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 352                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 353              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 354          }                                                                                                         </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 355          return false;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 356      }                                                                                                             </span>
<span  style=""> 357                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 358      @Override                                                                                                     </span>
<span class="-3274580905325891597" onmouseenter="enter('-3274580905325891597');" onmouseout="out('-3274580905325891597');" style=""> 359      public void applyOrderItemAdjustment(PromotableCandidateItemOffer itemOffer,                                  </span>
<span class="-8798183871686674116" onmouseenter="enter('-8798183871686674116');" onmouseout="out('-8798183871686674116');" style=""> 360              PromotableOrderItemPriceDetail itemPriceDetail) {                                                     </span>
<span class="-2791625561543308737" onmouseenter="enter('-2791625561543308737');" onmouseout="out('-2791625561543308737');" style=""> 361          PromotableOrderItemPriceDetailAdjustment promotableOrderItemPriceDetailAdjustment =                       </span>
<span class="-1963732814850126206" onmouseenter="enter('-1963732814850126206');" onmouseout="out('-1963732814850126206');" style=""> 362                  promotableItemFactory.createPromotableOrderItemPriceDetailAdjustment(itemOffer, itemPriceDetail); </span>





<span class="-452752185035923989" onmouseenter="enter('-452752185035923989');" onmouseout="out('-452752185035923989');" style=""> 363          itemPriceDetail.addCandidateItemPriceDetailAdjustment(promotableOrderItemPriceDetailAdjustment);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 364      }                                                                                                             </span>
<span  style=""> 365                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 366      @Override                                                                                                     </span>
<span class="-361580458958843386" onmouseenter="enter('-361580458958843386');" onmouseout="out('-361580458958843386');" style=""> 367      public List&lt;OrderItem&gt; buildOrderItemList(Order order) {                                                      </span>
<span class="4933536323910912844" onmouseenter="enter('4933536323910912844');" onmouseout="out('4933536323910912844');" style=""> 368          List&lt;OrderItem&gt; orderItemList = new ArrayList&lt;OrderItem&gt;();                                               </span>
<span class="4435196443097834597" onmouseenter="enter('4435196443097834597');" onmouseout="out('4435196443097834597');" style=""> 369          for (OrderItem currentItem : order.getOrderItems()) {                                                     </span>
<span class="-2966775259995926277" onmouseenter="enter('-2966775259995926277');" onmouseout="out('-2966775259995926277');" style=""> 370              if (currentItem instanceof OrderItemContainer) {                                                      </span>
<span class="5137067544827715705" onmouseenter="enter('5137067544827715705');" onmouseout="out('5137067544827715705');" style=""> 371                  OrderItemContainer container = (OrderItemContainer) currentItem;                                  </span>
<span class="4382484490734880847" onmouseenter="enter('4382484490734880847');" onmouseout="out('4382484490734880847');" style=""> 372                  if (container.isPricingAtContainerLevel()) {                                                      </span>
<span class="-2270489982917990854" onmouseenter="enter('-2270489982917990854');" onmouseout="out('-2270489982917990854');" style=""> 373                      orderItemList.add(currentItem);                                                               </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 374                  } else {                                                                                          </span>
<span class="112302786623021779" onmouseenter="enter('112302786623021779');" onmouseout="out('112302786623021779');" style=""> 375                      for (OrderItem containedItem : container.getOrderItems()) {                                   </span>
<span class="533266059764191893" onmouseenter="enter('533266059764191893');" onmouseout="out('533266059764191893');" style=""> 376                          orderItemList.add(containedItem);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 377                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 378                  }                                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 379              } else {                                                                                              </span>
<span class="-2270489982917990854" onmouseenter="enter('-2270489982917990854');" onmouseout="out('-2270489982917990854');" style=""> 380                  orderItemList.add(currentItem);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 381              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 382          }                                                                                                         </span>
<span  style=""> 383                                                                                                                    </span>
<span class="1499720353589212944" onmouseenter="enter('1499720353589212944');" onmouseout="out('1499720353589212944');" style=""> 384          return orderItemList;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 385      }                                                                                                             </span>
<span  style=""> 386                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 387      @Override                                                                                                     </span>
<span class="-8956803960090910177" onmouseenter="enter('-8956803960090910177');" onmouseout="out('-8956803960090910177');" style=""> 388      public Map&lt;OrderItem, PromotableOrderItem&gt; buildPromotableItemMap(PromotableOrder promotableOrder) {          </span>
<span class="-2911482928816722705" onmouseenter="enter('-2911482928816722705');" onmouseout="out('-2911482928816722705');" style=""> 389          Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderItem&gt;();    </span>
<span class="4206403965644457797" onmouseenter="enter('4206403965644457797');" onmouseout="out('4206403965644457797');" style=""> 390          for (PromotableOrderItem item : promotableOrder.getAllOrderItems()) {                                     </span>
<span class="-3870195952016518221" onmouseenter="enter('-3870195952016518221');" onmouseout="out('-3870195952016518221');" style=""> 391              promotableItemMap.put(item.getOrderItem(), item);                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 392          }                                                                                                         </span>
<span class="8963770174585233491" onmouseenter="enter('8963770174585233491');" onmouseout="out('8963770174585233491');" style=""> 393          return promotableItemMap;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 394      }                                                                                                             </span>
<span  style=""> 395                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 396      @Override                                                                                                     </span>
<span class="-8575715219777406772" onmouseenter="enter('-8575715219777406772');" onmouseout="out('-8575715219777406772');" style=""><abbr title=" 397      public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itemDetail) {"> 397      public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itemDetail)ðŸ”µ</abbr></span>
<span class="7467828794567286984" onmouseenter="enter('7467828794567286984');" onmouseout="out('7467828794567286984');" style=""><abbr title=" 398          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 398          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetailAdjustðŸ”µ</abbr></span>
<span  style=""> 399                                                                                                                    </span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 400          List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 400          List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;()ðŸ”µ</abbr></span>
<span class="-1371106512285082048" onmouseenter="enter('-1371106512285082048');" onmouseout="out('-1371106512285082048');" style=""> 401          for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {       </span>
<span class="-1262630258018644876" onmouseenter="enter('-1262630258018644876');" onmouseout="out('-1262630258018644876');" style=""> 402              if (itemAdjustmentMap.containsKey(adjustment.getOffer().getId())) {                                   </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 403                  if (LOG.isDebugEnabled()) {                                                                       </span>
<span class="5365687806736453142" onmouseenter="enter('5365687806736453142');" onmouseout="out('5365687806736453142');" style=""> 404                      StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with ids &quot;)    </span>
<span class="5769765961448228869" onmouseenter="enter('5769765961448228869');" onmouseout="out('5769765961448228869');" style=""> 405                          .append(itemAdjustmentMap.get(adjustment.getOffer().getId()).getId())                     </span>
<span class="7312533819175146387" onmouseenter="enter('7312533819175146387');" onmouseout="out('7312533819175146387');" style=""> 406                          .append(&quot; and &quot;)                                                                          </span>
<span class="-7531978261873044464" onmouseenter="enter('-7531978261873044464');" onmouseout="out('-7531978261873044464');" style=""> 407                          .append(adjustment.getId());                                                              </span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 408                      LOG.debug(sb.toString());                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 409                  }                                                                                                 </span>
<span class="5304290905678094245" onmouseenter="enter('5304290905678094245');" onmouseout="out('5304290905678094245');" style=""> 410                  adjustmentsToRemove.add(adjustment);                                                              </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 411              } else {                                                                                              </span>
<span class="-2602676027025933258" onmouseenter="enter('-2602676027025933258');" onmouseout="out('-2602676027025933258');" style=""> 412                  itemAdjustmentMap.put(adjustment.getOffer().getId(), adjustment);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 413              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 414          }                                                                                                         </span>
<span  style=""> 415                                                                                                                    </span>
<span class="-6749489598586186680" onmouseenter="enter('-6749489598586186680');" onmouseout="out('-6749489598586186680');" style=""> 416          for (OrderItemPriceDetailAdjustment adjustment : adjustmentsToRemove) {                                   </span>
<span class="170302329650885695" onmouseenter="enter('170302329650885695');" onmouseout="out('170302329650885695');" style=""> 417              itemDetail.getOrderItemPriceDetailAdjustments().remove(adjustment);                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 418          }                                                                                                         </span>
<span  style=""> 419                                                                                                                    </span>
<span class="-1848478302592739813" onmouseenter="enter('-1848478302592739813');" onmouseout="out('-1848478302592739813');" style=""> 420          return itemAdjustmentMap;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 421      }                                                                                                             </span>
<span  style=""> 422                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 423      @Override                                                                                                     </span>
<span class="7034544881417042941" onmouseenter="enter('7034544881417042941');" onmouseout="out('7034544881417042941');" style=""> 424      public void updatePriceDetail(OrderItemPriceDetail itemDetail,                                                </span>
<span class="-1090177046597316726" onmouseenter="enter('-1090177046597316726');" onmouseout="out('-1090177046597316726');" style=""> 425              PromotableOrderItemPriceDetail promotableDetail) {                                                    </span>
<span class="3894635813711687840" onmouseenter="enter('3894635813711687840');" onmouseout="out('3894635813711687840');" style=""> 426          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =                                             </span>
<span class="7785105538478960936" onmouseenter="enter('7785105538478960936');" onmouseout="out('7785105538478960936');" style=""> 427                  buildItemDetailAdjustmentMap(itemDetail);                                                         </span>
<span  style=""> 428                                                                                                                    </span>
<span class="8052115462234529390" onmouseenter="enter('8052115462234529390');" onmouseout="out('8052115462234529390');" style=""> 429          if (itemDetail.getQuantity() != promotableDetail.getQuantity()) {                                         </span>
<span class="8615443511774170500" onmouseenter="enter('8615443511774170500');" onmouseout="out('8615443511774170500');" style=""> 430              itemDetail.setQuantity(promotableDetail.getQuantity());                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 431          }                                                                                                         </span>
<span  style=""> 432                                                                                                                    </span>
<span class="-7750740315935940052" onmouseenter="enter('-7750740315935940052');" onmouseout="out('-7750740315935940052');" style=""> 433          if (promotableDetail.isAdjustmentsFinalized()) {                                                          </span>
<span class="8693299076047883645" onmouseenter="enter('8693299076047883645');" onmouseout="out('8693299076047883645');" style=""> 434              itemDetail.setUseSalePrice(promotableDetail.useSaleAdjustments());                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 435          }                                                                                                         </span>
<span  style=""> 436                                                                                                                    </span>
<span class="-200913113255250114" onmouseenter="enter('-200913113255250114');" onmouseout="out('-200913113255250114');" style=""><abbr title=" 437          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjustments()) {"> 437          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjustments())ðŸ”µ</abbr></span>
<span class="6578727718670889454" onmouseenter="enter('6578727718670889454');" onmouseout="out('6578727718670889454');" style=""> 438              OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferId());    </span>
<span class="-5676819544918869237" onmouseenter="enter('-5676819544918869237');" onmouseout="out('-5676819544918869237');" style=""> 439              if (itemAdjustment != null) {                                                                         </span>
<span class="2095963063095688848" onmouseenter="enter('2095963063095688848');" onmouseout="out('2095963063095688848');" style=""> 440                  // Update existing adjustment                                                                     </span>
<span class="4997906471413856597" onmouseenter="enter('4997906471413856597');" onmouseout="out('4997906471413856597');" style=""> 441                  if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {                         </span>
<span class="-7190567157504063803" onmouseenter="enter('-7190567157504063803');" onmouseout="out('-7190567157504063803');" style=""> 442                      updateItemAdjustment(itemAdjustment, adjustment);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 443                  }                                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 444              } else {                                                                                              </span>
<span class="-3662936612993896923" onmouseenter="enter('-3662936612993896923');" onmouseout="out('-3662936612993896923');" style=""> 445                  // Add a new adjustment                                                                           </span>
<span class="6730722799913825373" onmouseenter="enter('6730722799913825373');" onmouseout="out('6730722799913825373');" style=""> 446                  final OrderItemPriceDetailAdjustment newItemAdjustment;                                           </span>
<span class="-3180324819813272445" onmouseenter="enter('-3180324819813272445');" onmouseout="out('-3180324819813272445');" style=""> 447                  ExtensionResultHolder resultHolder = new ExtensionResultHolder();                                 </span>
<span  style=""> 448                                                                                                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 449                  if (extensionManager != null) {                                                                   </span>
<span class="4841855343164111630" onmouseenter="enter('4841855343164111630');" onmouseout="out('4841855343164111630');" style=""> 450                      extensionManager.createOrderItemPriceDetailAdjustment(resultHolder, itemDetail);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 451                  }                                                                                                 </span>
<span class="3886522200438865522" onmouseenter="enter('3886522200438865522');" onmouseout="out('3886522200438865522');" style=""><abbr title=" 452                  if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetailAdjustment&quot;)) {"> 452                  if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetailAdjustmeðŸ”µ</abbr></span>
<span class="-3287798826483764260" onmouseenter="enter('-3287798826483764260');" onmouseout="out('-3287798826483764260');" style=""><abbr title=" 453                      newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().get(&quot;OrderItemPriceDetailAdjustment&quot;);"> 453                      newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().get(&quot;OrderItðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 454                  } else {                                                                                          </span>
<span class="3374546574285123670" onmouseenter="enter('3374546574285123670');" onmouseout="out('3374546574285123670');" style=""> 455                      newItemAdjustment = offerDao.createOrderItemPriceDetailAdjustment();                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 456                  }                                                                                                 </span>
<span class="6434193420407019930" onmouseenter="enter('6434193420407019930');" onmouseout="out('6434193420407019930');" style=""> 457                  newItemAdjustment.init(itemDetail, adjustment.getOffer(), null);                                  </span>
<span class="2527816204760883975" onmouseenter="enter('2527816204760883975');" onmouseout="out('2527816204760883975');" style=""> 458                  updateItemAdjustment(newItemAdjustment, adjustment);                                              </span>
<span class="280404668024484347" onmouseenter="enter('280404668024484347');" onmouseout="out('280404668024484347');" style=""> 459                  itemDetail.getOrderItemPriceDetailAdjustments().add(newItemAdjustment);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 460              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 461          }                                                                                                         </span>
<span  style=""> 462                                                                                                                    </span>
<span class="2716703745442399701" onmouseenter="enter('2716703745442399701');" onmouseout="out('2716703745442399701');" style=""> 463          if (itemAdjustmentMap.size() &gt; 0) {                                                                       </span>
<span class="7320812723157924979" onmouseenter="enter('7320812723157924979');" onmouseout="out('7320812723157924979');" style=""> 464              // Remove adjustments that were on the order item but no longer needed.                               </span>
<span class="-1869846822270594411" onmouseenter="enter('-1869846822270594411');" onmouseout="out('-1869846822270594411');" style=""> 465              List&lt;Long&gt; adjustmentIdsToRemove = new ArrayList&lt;Long&gt;();                                             </span>
<span class="8226461738127611440" onmouseenter="enter('8226461738127611440');" onmouseout="out('8226461738127611440');" style=""> 466              for (OrderItemPriceDetailAdjustment adjustmentToRemove : itemAdjustmentMap.values()) {                </span>
<span class="-5089858163100858042" onmouseenter="enter('-5089858163100858042');" onmouseout="out('-5089858163100858042');" style=""> 467                  adjustmentIdsToRemove.add(adjustmentToRemove.getOffer().getId());                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 468              }                                                                                                     </span>
<span  style=""> 469                                                                                                                    </span>
<span class="-713707707098991740" onmouseenter="enter('-713707707098991740');" onmouseout="out('-713707707098991740');" style=""><abbr title=" 470              Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustments().iterator();"> 470              Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustments().itðŸ”µ</abbr></span>
<span class="977968488612897428" onmouseenter="enter('977968488612897428');" onmouseout="out('977968488612897428');" style=""> 471              while (iterator.hasNext()) {                                                                          </span>
<span class="-6499043821118944641" onmouseenter="enter('-6499043821118944641');" onmouseout="out('-6499043821118944641');" style=""> 472                  OrderItemPriceDetailAdjustment adj = iterator.next();                                             </span>
<span class="-3830175641101683618" onmouseenter="enter('-3830175641101683618');" onmouseout="out('-3830175641101683618');" style=""> 473                  if (adjustmentIdsToRemove.contains(adj.getOffer().getId())) {                                     </span>
<span class="-6215380074365660212" onmouseenter="enter('-6215380074365660212');" onmouseout="out('-6215380074365660212');" style=""> 474                      iterator.remove();                                                                            </span>

<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 475                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 476              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 477          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 478      }                                                                                                             </span>
<span  style=""> 479                                                                                                                    </span>
<span class="-2179044478542157534" onmouseenter="enter('-2179044478542157534');" onmouseout="out('-2179044478542157534');" style=""> 480      protected void updateItemAdjustment(OrderItemPriceDetailAdjustment itemAdjustment,                            </span>
<span class="-2091009272129273931" onmouseenter="enter('-2091009272129273931');" onmouseout="out('-2091009272129273931');" style=""> 481              PromotableOrderItemPriceDetailAdjustment promotableAdjustment) {                                      </span>
<span class="8984388188384789298" onmouseenter="enter('8984388188384789298');" onmouseout="out('8984388188384789298');" style=""> 482          itemAdjustment.setValue(promotableAdjustment.getAdjustmentValue());                                       </span>
<span class="-1504764115388345009" onmouseenter="enter('-1504764115388345009');" onmouseout="out('-1504764115388345009');" style=""> 483          itemAdjustment.setSalesPriceValue(promotableAdjustment.getSaleAdjustmentValue());                         </span>
<span class="8159218742886391276" onmouseenter="enter('8159218742886391276');" onmouseout="out('8159218742886391276');" style=""> 484          itemAdjustment.setRetailPriceValue(promotableAdjustment.getRetailAdjustmentValue());                      </span>
<span class="-6000420337005117738" onmouseenter="enter('-6000420337005117738');" onmouseout="out('-6000420337005117738');" style=""> 485          itemAdjustment.setAppliedToSalePrice(promotableAdjustment.isAppliedToSalePrice());                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 486      }                                                                                                             </span>
<span  style=""> 487                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 488      @Override                                                                                                     </span>
<span class="-313570815421854700" onmouseenter="enter('-313570815421854700');" onmouseout="out('-313570815421854700');" style=""> 489      public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMap,        </span>
<span class="-3281550581325801818" onmouseenter="enter('-3281550581325801818');" onmouseout="out('-3281550581325801818');" style=""> 490              Iterator&lt;? extends OrderItemPriceDetail&gt; pdIterator) {                                                </span>
<span class="5054006045083210855" onmouseenter="enter('5054006045083210855');" onmouseout="out('5054006045083210855');" style=""> 491          while (pdIterator.hasNext()) {                                                                            </span>
<span class="3750310726725232966" onmouseenter="enter('3750310726725232966');" onmouseout="out('3750310726725232966');" style=""> 492              OrderItemPriceDetail currentDetail = pdIterator.next();                                               </span>
<span class="6581958837024527183" onmouseenter="enter('6581958837024527183');" onmouseout="out('6581958837024527183');" style=""> 493              if (unmatchedDetailsMap.containsKey(currentDetail.getId())) {                                         </span>
<span class="-6186712185724981265" onmouseenter="enter('-6186712185724981265');" onmouseout="out('-6186712185724981265');" style=""> 494                  pdIterator.remove();                                                                              </span>

<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 495              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 496          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 497      }                                                                                                             </span>
<span  style=""> 498                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 499      @Override                                                                                                     </span>
<span class="8034359428831826315" onmouseenter="enter('8034359428831826315');" onmouseout="out('8034359428831826315');" style=""> 500      public void removeUnmatchedQualifiers(Map&lt;Long, ? extends OrderItemQualifier&gt; unmatchedQualifiersMap,         </span>
<span class="-2169714322041971999" onmouseenter="enter('-2169714322041971999');" onmouseout="out('-2169714322041971999');" style=""> 501              Iterator&lt;? extends OrderItemQualifier&gt; qIterator) {                                                   </span>
<span class="2447020288494192331" onmouseenter="enter('2447020288494192331');" onmouseout="out('2447020288494192331');" style=""> 502          while (qIterator.hasNext()) {                                                                             </span>
<span class="-6005719546303323499" onmouseenter="enter('-6005719546303323499');" onmouseout="out('-6005719546303323499');" style=""> 503              OrderItemQualifier currentQualifier = qIterator.next();                                               </span>
<span class="662385347998037693" onmouseenter="enter('662385347998037693');" onmouseout="out('662385347998037693');" style=""> 504              if (unmatchedQualifiersMap.containsKey(currentQualifier.getId())) {                                   </span>
<span class="-5446309343821913287" onmouseenter="enter('-5446309343821913287');" onmouseout="out('-5446309343821913287');" style=""> 505                  qIterator.remove();                                                                               </span>

<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 506              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 507          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 508      }                                                                                                             </span>
<span  style=""> 509                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 510      @Override                                                                                                     </span>
<span class="-4444436672341398789" onmouseenter="enter('-4444436672341398789');" onmouseout="out('-4444436672341398789');" style=""><abbr title=" 511      public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; qualifiersMap) {"> 511      public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCðŸ”µ</abbr></span>
<span class="5670547093193511713" onmouseenter="enter('5670547093193511713');" onmouseout="out('5670547093193511713');" style=""> 512          Money qualifyingItemSubTotal = offer.getQualifyingItemSubTotal();                                         </span>
<span class="-5062121077129985722" onmouseenter="enter('-5062121077129985722');" onmouseout="out('-5062121077129985722');" style=""> 513          if (qualifyingItemSubTotal == null || qualifyingItemSubTotal.lessThanOrEqual(Money.ZERO)) {               </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 514              return true;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 515          }                                                                                                         </span>
<span class="-7755694615807420902" onmouseenter="enter('-7755694615807420902');" onmouseout="out('-7755694615807420902');" style=""> 516          return orderMeetsProvidedSubtotalRequirement(offer, qualifiersMap, qualifyingItemSubTotal);               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 517      }                                                                                                             </span>
<span  style=""> 518                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 519      @Override                                                                                                     </span>
<span class="-5677301022020811119" onmouseenter="enter('-5677301022020811119');" onmouseout="out('-5677301022020811119');" style=""><abbr title=" 520      public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; targetsMap) {"> 520      public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteðŸ”µ</abbr></span>
<span class="6988724665629485016" onmouseenter="enter('6988724665629485016');" onmouseout="out('6988724665629485016');" style=""> 521          Money targetMinSubTotal = offer.getTargetMinSubTotal();                                                   </span>
<span class="-1489567751755997812" onmouseenter="enter('-1489567751755997812');" onmouseout="out('-1489567751755997812');" style=""> 522          if (targetMinSubTotal == null || targetMinSubTotal.lessThanOrEqual(Money.ZERO)) {                         </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 523              return true;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 524          }                                                                                                         </span>
<span class="7580465799834058252" onmouseenter="enter('7580465799834058252');" onmouseout="out('7580465799834058252');" style=""> 525          return orderMeetsProvidedSubtotalRequirement(offer, targetsMap, targetMinSubTotal);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 526      }                                                                                                             </span>
<span  style=""> 527                                                                                                                    </span>
<span class="8829500236577947895" onmouseenter="enter('8829500236577947895');" onmouseout="out('8829500236577947895');" style=""><abbr title=" 528      protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; promotableOrderItems, Money minSubTotal) {"> 528      protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotablðŸ”µ</abbr></span>
<span class="-6106353390255483233" onmouseenter="enter('-6106353390255483233');" onmouseout="out('-6106353390255483233');" style=""> 529          Money subtotal = Money.ZERO;                                                                              </span>
<span  style=""> 530                                                                                                                    </span>
<span class="1373302773933084970" onmouseenter="enter('1373302773933084970');" onmouseout="out('1373302773933084970');" style=""> 531          for (OfferItemCriteria itemCriteria : promotableOrderItems.keySet()) {                                    </span>
<span class="-419579307951366052" onmouseenter="enter('-419579307951366052');" onmouseout="out('-419579307951366052');" style=""> 532              List&lt;PromotableOrderItem&gt; promotableItems = promotableOrderItems.get(itemCriteria);                   </span>
<span  style=""> 533                                                                                                                    </span>
<span class="-1903041170653165047" onmouseenter="enter('-1903041170653165047');" onmouseout="out('-1903041170653165047');" style=""> 534              for (PromotableOrderItem item : promotableItems) {                                                    </span>
<span class="7600253327963384600" onmouseenter="enter('7600253327963384600');" onmouseout="out('7600253327963384600');" style=""> 535                  boolean shouldApplyDiscountToSalePrice = offer.getApplyDiscountToSalePrice();                     </span>
<span class="779941574682415153" onmouseenter="enter('779941574682415153');" onmouseout="out('779941574682415153');" style=""> 536                  Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrice);    </span>
<span class="215414280986961901" onmouseenter="enter('215414280986961901');" onmouseout="out('215414280986961901');" style=""> 537                  int quantity = item.getQuantity();                                                                </span>
<span  style=""> 538                                                                                                                    </span>
<span class="-2934463286963984250" onmouseenter="enter('-2934463286963984250');" onmouseout="out('-2934463286963984250');" style=""> 539                  Money lineItemAmount = priceBeforeAdjustments.multiply(quantity);                                 </span>
<span class="-3511635498964788361" onmouseenter="enter('-3511635498964788361');" onmouseout="out('-3511635498964788361');" style=""> 540                  subtotal = subtotal.add(lineItemAmount);                                                          </span>
<span class="-2129121979744538843" onmouseenter="enter('-2129121979744538843');" onmouseout="out('-2129121979744538843');" style=""> 541                  if (subtotal.greaterThanOrEqual(minSubTotal)) {                                                   </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 542                      return true;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 543                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 544              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 545          }                                                                                                         </span>
<span  style=""> 546                                                                                                                    </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 547          return false;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 548      }                                                                                                             </span>
<span  style=""> 549                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 550      @Override                                                                                                     </span>
<span class="6911813483912566048" onmouseenter="enter('6911813483912566048');" onmouseout="out('6911813483912566048');" style=""> 551      public boolean orderMeetsSubtotalRequirements(PromotableOrder order, Offer offer) {                           </span>
<span class="8114201548143186402" onmouseenter="enter('8114201548143186402');" onmouseout="out('8114201548143186402');" style=""> 552          Money orderMinSubTotal = offer.getOrderMinSubTotal();                                                     </span>
<span class="5846170175083841610" onmouseenter="enter('5846170175083841610');" onmouseout="out('5846170175083841610');" style=""> 553          return orderMinSubTotal == null                                                                           </span>
<span class="774150812299602505" onmouseenter="enter('774150812299602505');" onmouseout="out('774150812299602505');" style=""> 554                  || orderMinSubTotal.lessThanOrEqual(Money.ZERO)                                                   </span>
<span class="722443493012604709" onmouseenter="enter('722443493012604709');" onmouseout="out('722443493012604709');" style=""> 555                  || orderMinSubTotal.lessThanOrEqual(order.getOrder().getSubTotal());                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 556      }                                                                                                             </span>
<span  style=""> 557                                                                                                                    </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 558      public PromotableItemFactory getPromotableItemFactory() {                                                     </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 559          return promotableItemFactory;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 560      }                                                                                                             </span>
<span  style=""> 561                                                                                                                    </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 562      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                           </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 563          this.promotableItemFactory = promotableItemFactory;                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 564      }                                                                                                             </span>
<span  style=""> 565                                                                                                                    </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 566      public OfferDao getOfferDao() {                                                                               </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 567          return offerDao;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 568      }                                                                                                             </span>
<span  style=""> 569                                                                                                                    </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 570      public void setOfferDao(OfferDao offerDao) {                                                                  </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 571          this.offerDao = offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 572      }                                                                                                             </span>
<span  style=""> 573                                                                                                                    </span>







<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 574  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3   * BroadleafCommerce Framework                                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18  package org.broadleafcommerce.core.offer.service;                                                                 </span>
<span  style="">  19                                                                                                                    </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  22  import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                              </span>
<span class="-274639712180431568" onmouseenter="enter('-274639712180431568');" onmouseout="out('-274639712180431568');" style="">  23  import org.broadleafcommerce.common.money.Money;                                                                  </span>
<span class="-1492144387614747576" onmouseenter="enter('-1492144387614747576');" onmouseout="out('-1492144387614747576');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import org.broadleafcommerce.common.service.GenericEntityService;                                                 </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  25  import org.broadleafcommerce.core.offer.dao.OfferDao;                                                             </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  26  import org.broadleafcommerce.core.offer.domain.Offer;                                                             </span>
<span class="-6494010243902923492" onmouseenter="enter('-6494010243902923492');" onmouseout="out('-6494010243902923492');" style="">  27  import org.broadleafcommerce.core.offer.domain.OfferItemCriteria;                                                 </span>

<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  28  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                                    </span>
<span class="6002542247348180004" onmouseenter="enter('6002542247348180004');" onmouseout="out('6002542247348180004');" style="">  29  import org.broadleafcommerce.core.offer.service.discount.PromotionDiscount;                                       </span>
<span class="180286745313216238" onmouseenter="enter('180286745313216238');" onmouseout="out('180286745313216238');" style="">  30  import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;                                      </span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  31  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;                     </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  32  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                            </span>

<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  33  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                                  </span>
<span class="-7733804833771661823" onmouseenter="enter('-7733804833771661823');" onmouseout="out('-7733804833771661823');" style="">  34  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;                              </span>
<span class="2677462620955414718" onmouseenter="enter('2677462620955414718');" onmouseout="out('2677462620955414718');" style="">  35  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;                   </span>
<span class="-5097841332942556730" onmouseenter="enter('-5097841332942556730');" onmouseout="out('-5097841332942556730');" style="">  36  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;         </span>
<span class="6922194440736558195" onmouseenter="enter('6922194440736558195');" onmouseout="out('6922194440736558195');" style="">  37  import org.broadleafcommerce.core.offer.service.processor.ItemOfferMarkTargets;                                   </span>
<span class="-4077086760777187101" onmouseenter="enter('-4077086760777187101');" onmouseout="out('-4077086760777187101');" style="">  38  import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;                                                 </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  39  import org.broadleafcommerce.core.order.domain.Order;                                                             </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  40  import org.broadleafcommerce.core.order.domain.OrderItem;                                                         </span>
<span class="-1764233193646247473" onmouseenter="enter('-1764233193646247473');" onmouseout="out('-1764233193646247473');" style="">  41  import org.broadleafcommerce.core.order.domain.OrderItemContainer;                                                </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  42  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                              </span>
<span class="573363609456981556" onmouseenter="enter('573363609456981556');" onmouseout="out('573363609456981556');" style="">  43  import org.broadleafcommerce.core.order.domain.OrderItemQualifier;                                                </span>
<span class="-3230016162556687469" onmouseenter="enter('-3230016162556687469');" onmouseout="out('-3230016162556687469');" style="">  44  import org.broadleafcommerce.core.order.domain.dto.OrderItemHolder;                                               </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  45  import org.springframework.stereotype.Service;                                                                    </span>
<span  style="">  46                                                                                                                    </span>
<span class="2075466404860203191" onmouseenter="enter('2075466404860203191');" onmouseout="out('2075466404860203191');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import java.math.BigDecimal;                                                                                      </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  48  import java.util.ArrayList;                                                                                       </span>
<span class="2187055016371707860" onmouseenter="enter('2187055016371707860');" onmouseout="out('2187055016371707860');" style="">  49  import java.util.Collections;                                                                                     </span>
<span class="4561244361960433187" onmouseenter="enter('4561244361960433187');" onmouseout="out('4561244361960433187');" style="">  50  import java.util.Comparator;                                                                                      </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  51  import java.util.HashMap;                                                                                         </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  52  import java.util.Iterator;                                                                                        </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  53  import java.util.List;                                                                                            </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  54  import java.util.Map;                                                                                             </span>
<span  style="">  55                                                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  56  import javax.annotation.Resource;                                                                                 </span>
<span  style="">  57                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  58  /**                                                                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  59   *                                                                                                                </span>
<span class="3680448680235302484" onmouseenter="enter('3680448680235302484');" onmouseout="out('3680448680235302484');" style="">  60   * @author bpolster                                                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  61   *                                                                                                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  62   */                                                                                                               </span>
<span class="-7533628443457811418" onmouseenter="enter('-7533628443457811418');" onmouseout="out('-7533628443457811418');" style="">  63  @Service(&quot;blOfferServiceUtilities&quot;)                                                                               </span>
<span class="6914343992633091500" onmouseenter="enter('6914343992633091500');" onmouseout="out('6914343992633091500');" style="">  64  public class OfferServiceUtilitiesImpl implements OfferServiceUtilities {                                         </span>
<span class="-7057195126687856185" onmouseenter="enter('-7057195126687856185');" onmouseout="out('-7057195126687856185');" style="">  65      protected static final Log LOG = LogFactory.getLog(OfferServiceUtilitiesImpl.class);                          </span>
<span  style="">  66                                                                                                                    </span>
<span class="5938907043749528173" onmouseenter="enter('5938907043749528173');" onmouseout="out('5938907043749528173');" style="">  67      @Resource(name = &quot;blPromotableItemFactory&quot;)                                                                   </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style="">  68      protected PromotableItemFactory promotableItemFactory;                                                        </span>
<span  style="">  69                                                                                                                    </span>
<span class="5779429748772127951" onmouseenter="enter('5779429748772127951');" onmouseout="out('5779429748772127951');" style="">  70      @Resource(name = &quot;blOfferDao&quot;)                                                                                </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  71      protected OfferDao offerDao;                                                                                  </span>
<span  style="">  72                                                                                                                    </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style="">  73      @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                            </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style="">  74      protected OfferServiceExtensionManager extensionManager;                                                      </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +                                                                                                                  </span>
<span class="2258512980686044159" onmouseenter="enter('2258512980686044159');" onmouseout="out('2258512980686044159');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +    @Resource(name = &quot;blGenericEntityService&quot;)                                                                    </span>
<span class="5310520372352255538" onmouseenter="enter('5310520372352255538');" onmouseout="out('5310520372352255538');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +    protected GenericEntityService entityService;                                                                 </span>



<span  style="">  78                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  79      @Override                                                                                                     </span>
<span class="6223480568976573314" onmouseenter="enter('6223480568976573314');" onmouseout="out('6223480568976573314');" style=""><abbr title="  80      public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  80      public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrðŸ”µ</abbr></span>
<span class="7055525017697292208" onmouseenter="enter('7055525017697292208');" onmouseout="out('7055525017697292208');" style="">  81          Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  82      }                                                                                                             </span>
<span  style="">  83                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  84      @Override                                                                                                     </span>
<span class="-4185121765520276478" onmouseenter="enter('-4185121765520276478');" onmouseout="out('-4185121765520276478');" style=""><abbr title="  85      public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  85      public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalðŸ”µ</abbr></span>
<span class="7055525017697292208" onmouseenter="enter('7055525017697292208');" onmouseout="out('7055525017697292208');" style="">  86          Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  87      }                                                                                                             </span>
<span  style="">  88                                                                                                                    </span>
<span class="8076072330480389618" onmouseenter="enter('8076072330480389618');" onmouseout="out('8076072330480389618');" style=""><abbr title="  89      protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyToSalePrice) {">  89      protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyToSalePricðŸ”µ</abbr></span>
<span class="3297095837477520472" onmouseenter="enter('3297095837477520472');" onmouseout="out('3297095837477520472');" style="">  90          return new Comparator&lt;PromotableOrderItemPriceDetail&gt;() {                                                 </span>
<span  style="">  91                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  92              @Override                                                                                             </span>
<span class="-2961106138566190059" onmouseenter="enter('-2961106138566190059');" onmouseout="out('-2961106138566190059');" style="">  93              public int compare(PromotableOrderItemPriceDetail o1, PromotableOrderItemPriceDetail o2) {            </span>
<span class="7675869656754073027" onmouseenter="enter('7675869656754073027');" onmouseout="out('7675869656754073027');" style="">  94                  Money price = o1.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);            </span>
<span class="-2386281537779196104" onmouseenter="enter('-2386281537779196104');" onmouseout="out('-2386281537779196104');" style="">  95                  Money price2 = o2.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);           </span>
<span  style="">  96                                                                                                                    </span>
<span class="-7980156687270114839" onmouseenter="enter('-7980156687270114839');" onmouseout="out('-7980156687270114839');" style="">  97                  // highest amount first                                                                           </span>
<span class="-5413989484138410778" onmouseenter="enter('-5413989484138410778');" onmouseout="out('-5413989484138410778');" style="">  98                  return price2.compareTo(price);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  99              }                                                                                                     </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 100          };                                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 101      }                                                                                                             </span>
<span  style=""> 102                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 103      @Override                                                                                                     </span>
<span class="-6633188601276085642" onmouseenter="enter('-6633188601276085642');" onmouseout="out('-6633188601276085642');" style=""> 104      public OrderItem findRelatedQualifierRoot(OrderItem relatedQualifier) {                                       </span>
<span class="1807144252798273266" onmouseenter="enter('1807144252798273266');" onmouseout="out('1807144252798273266');" style=""> 105          OrderItem relatedQualifierRoot = null;                                                                    </span>
<span class="-5368473621929304561" onmouseenter="enter('-5368473621929304561');" onmouseout="out('-5368473621929304561');" style=""> 106          if (relatedQualifier != null) {                                                                           </span>
<span class="-5398594526726109873" onmouseenter="enter('-5398594526726109873');" onmouseout="out('-5398594526726109873');" style=""> 107              relatedQualifierRoot = relatedQualifier;                                                              </span>
<span class="7824588639878219390" onmouseenter="enter('7824588639878219390');" onmouseout="out('7824588639878219390');" style=""> 108              while (relatedQualifierRoot.getParentOrderItem() != null) {                                           </span>
<span class="-2176101432970038375" onmouseenter="enter('-2176101432970038375');" onmouseout="out('-2176101432970038375');" style=""> 109                  relatedQualifierRoot = relatedQualifierRoot.getParentOrderItem();                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 110              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 111          }                                                                                                         </span>
<span class="-6121768564377108608" onmouseenter="enter('-6121768564377108608');" onmouseout="out('-6121768564377108608');" style=""> 112          return relatedQualifierRoot;                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 113      }                                                                                                             </span>
<span  style=""> 114                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 115      @Override                                                                                                     </span>
<span class="8600807536713378155" onmouseenter="enter('8600807536713378155');" onmouseout="out('8600807536713378155');" style=""><abbr title=" 116      public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; details) {"> 116      public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetaðŸ”µ</abbr></span>
<span  style=""> 117                                                                                                                    </span>
<span class="-4790953179105551104" onmouseenter="enter('-4790953179105551104');" onmouseout="out('-4790953179105551104');" style=""> 118          for (PromotableOrderItemPriceDetail detail : details) {                                                   </span>
<span class="1975158128642033085" onmouseenter="enter('1975158128642033085');" onmouseout="out('1975158128642033085');" style=""> 119              for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustments()) {    </span>
<span class="30696373439585907" onmouseenter="enter('30696373439585907');" onmouseout="out('30696373439585907');" style=""> 120                  if (adjustment.isTotalitarian() || itemOffer.getOffer().isTotalitarianOffer()) {                  </span>
<span class="-7120250698956357960" onmouseenter="enter('-7120250698956357960');" onmouseout="out('-7120250698956357960');" style=""> 121                      // A totalitarian offer has already been applied or this offer is totalitarian                </span>
<span class="-7934044302077364434" onmouseenter="enter('-7934044302077364434');" onmouseout="out('-7934044302077364434');" style=""> 122                      // and another offer was already applied.                                                     </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 123                      return false;                                                                                 </span>
<span class="5154499828715066004" onmouseenter="enter('5154499828715066004');" onmouseout="out('5154499828715066004');" style=""> 124                  } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {   </span>
<span class="721506122397233060" onmouseenter="enter('721506122397233060');" onmouseout="out('721506122397233060');" style=""> 125                      // A nonCombinable offer has been applied or this is a non-combinable offer                   </span>
<span class="1625719735315035531" onmouseenter="enter('1625719735315035531');" onmouseout="out('1625719735315035531');" style=""> 126                      // and adjustments have already been applied.                                                 </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 127                      return false;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 128                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 129              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 130          }                                                                                                         </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 131          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 132      }                                                                                                             </span>
<span  style=""> 133                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 134      @Override                                                                                                     </span>
<span class="-3713458578644525384" onmouseenter="enter('-3713458578644525384');" onmouseout="out('-3713458578644525384');" style=""> 135      public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCriteria,  </span>
<span class="-9206127464517457513" onmouseenter="enter('-9206127464517457513');" onmouseout="out('-9206127464517457513');" style=""> 136              List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {                                                  </span>
<span  style=""> 137                                                                                                                    </span>
<span class="1399559222284052069" onmouseenter="enter('1399559222284052069');" onmouseout="out('1399559222284052069');" style=""> 138          sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());               </span>
<span  style=""> 139                                                                                                                    </span>
<span class="-2005578619141057452" onmouseenter="enter('-2005578619141057452');" onmouseout="out('-2005578619141057452');" style=""> 140          // Calculate the number of qualifiers needed that will not receive the promotion.                         </span>
<span class="-7642725860669587391" onmouseenter="enter('-7642725860669587391');" onmouseout="out('-7642725860669587391');" style=""> 141          // These will be reserved first before the target is assigned.                                            </span>
<span class="-5221545606159729582" onmouseenter="enter('-5221545606159729582');" onmouseout="out('-5221545606159729582');" style=""> 142          int qualifierQtyNeeded = itemCriteria.getQuantity();                                                      </span>
<span  style=""> 143                                                                                                                    </span>
<span class="-389357445740262218" onmouseenter="enter('-389357445740262218');" onmouseout="out('-389357445740262218');" style=""> 144          for (PromotableOrderItemPriceDetail detail : priceDetails) {                                              </span>
<span  style=""> 145                                                                                                                    </span>
<span class="-7196228531210809782" onmouseenter="enter('-7196228531210809782');" onmouseout="out('-7196228531210809782');" style=""> 146              // Mark Qualifiers                                                                                    </span>
<span class="7203543687533075574" onmouseenter="enter('7203543687533075574');" onmouseout="out('7203543687533075574');" style=""> 147              if (qualifierQtyNeeded &gt; 0) {                                                                         </span>
<span class="4739725621440457335" onmouseenter="enter('4739725621440457335');" onmouseout="out('4739725621440457335');" style=""><abbr title=" 148                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 148                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOfferðŸ”µ</abbr></span>
<span class="118721626032663442" onmouseenter="enter('118721626032663442');" onmouseout="out('118721626032663442');" style=""> 149                  if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {                                                    </span>
<span class="156141582657617565" onmouseenter="enter('156141582657617565');" onmouseout="out('156141582657617565');" style=""> 150                      int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier); </span>
<span class="-4684084580161696213" onmouseenter="enter('-4684084580161696213');" onmouseout="out('-4684084580161696213');" style=""> 151                      qualifierQtyNeeded -= qtyToMarkAsQualifier;                                                   </span>
<span class="-5539919712790669425" onmouseenter="enter('-5539919712790669425');" onmouseout="out('-5539919712790669425');" style=""> 152                      detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 153                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 154              }                                                                                                     </span>
<span  style=""> 155                                                                                                                    </span>
<span class="8517154315660472641" onmouseenter="enter('8517154315660472641');" onmouseout="out('8517154315660472641');" style=""> 156              if (qualifierQtyNeeded == 0) {                                                                        </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 157                  break;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 158              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 159          }                                                                                                         </span>
<span class="-4850383672896867816" onmouseenter="enter('-4850383672896867816');" onmouseout="out('-4850383672896867816');" style=""> 160          return qualifierQtyNeeded;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161      }                                                                                                             </span>
<span  style=""> 162                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 163      @Override                                                                                                     </span>
<span class="-690144452707146894" onmouseenter="enter('-690144452707146894');" onmouseout="out('-690144452707146894');" style=""> 164      public int markTargetsForCriteria(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,         </span>
<span class="-7065312759813139704" onmouseenter="enter('-7065312759813139704');" onmouseout="out('-7065312759813139704');" style=""> 165              boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriteria,   </span>
<span class="2702959100637307406" onmouseenter="enter('2702959100637307406');" onmouseout="out('2702959100637307406');" style=""> 166              List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, int targetQtyNeeded) {                             </span>
<span class="2114191821955736127" onmouseenter="enter('2114191821955736127');" onmouseout="out('2114191821955736127');" style=""> 167          for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {                                         </span>
<span class="-5368473621929304561" onmouseenter="enter('-5368473621929304561');" onmouseout="out('-5368473621929304561');" style=""> 168              if (relatedQualifier != null) {                                                                       </span>
<span class="8141493125634490263" onmouseenter="enter('8141493125634490263');" onmouseout="out('8141493125634490263');" style=""><abbr title=" 169                  // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 169                  // We need to make sure that this item is either a parent, child, or the same as the qualifier rooðŸ”µ</abbr></span>
<span class="1857856063926056091" onmouseenter="enter('1857856063926056091');" onmouseout="out('1857856063926056091');" style=""> 170                  OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();                         </span>
<span class="-3127297900577673654" onmouseenter="enter('-3127297900577673654');" onmouseout="out('-3127297900577673654');" style=""> 171                  if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp; </span>
<span class="3862062312907446706" onmouseenter="enter('3862062312907446706');" onmouseout="out('3862062312907446706');" style=""> 172                          !thisItem.equals(relatedQualifierRoot)) {                                                 </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 173                      continue;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 174                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 175              }                                                                                                     </span>
<span  style=""> 176                                                                                                                    </span>
<span class="-3899808772905023528" onmouseenter="enter('-3899808772905023528');" onmouseout="out('-3899808772905023528');" style=""> 177              int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);   </span>
<span class="1240759488807976542" onmouseenter="enter('1240759488807976542');" onmouseout="out('1240759488807976542');" style=""> 178              if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {                                                           </span>
<span class="-2152892838174945575" onmouseenter="enter('-2152892838174945575');" onmouseout="out('-2152892838174945575');" style=""><abbr title=" 179                  if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 179                  if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) ðŸ”µ</abbr></span>
<span class="-5766015035856187988" onmouseenter="enter('-5766015035856187988');" onmouseout="out('-5766015035856187988');" style=""> 180                      int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget);          </span>
<span class="-182485827533192502" onmouseenter="enter('-182485827533192502');" onmouseout="out('-182485827533192502');" style=""> 181                      targetQtyNeeded -= qtyToMarkAsTarget;                                                         </span>
<span class="-4172322390128575169" onmouseenter="enter('-4172322390128575169');" onmouseout="out('-4172322390128575169');" style=""> 182                      if (!checkOnly) {                                                                             </span>
<span class="5603549919531530635" onmouseenter="enter('5603549919531530635');" onmouseout="out('5603549919531530635');" style=""> 183                          priceDetail.addPromotionDiscount(itemOffer, itemCriteria, qtyToMarkAsTarget);             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 184                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 185                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 186              }                                                                                                     </span>
<span  style=""> 187                                                                                                                    </span>
<span class="5358835008623854271" onmouseenter="enter('5358835008623854271');" onmouseout="out('5358835008623854271');" style=""> 188              if (targetQtyNeeded == 0) {                                                                           </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 189                  break;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 190              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 191          }                                                                                                         </span>
<span class="6491342130615381336" onmouseenter="enter('6491342130615381336');" onmouseout="out('6491342130615381336');" style=""> 192          return targetQtyNeeded;                                                                                   </span>






































<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 193      }                                                                                                             </span>
<span  style=""> 194                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 195      @Override                                                                                                     </span>
<span class="-5374453289617781014" onmouseenter="enter('-5374453289617781014');" onmouseout="out('-5374453289617781014');" style=""><abbr title=" 196      public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, PromotableOrder order,"> 196      public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, PromotableOrðŸ”µ</abbr></span>
<span class="-45453231322119310" onmouseenter="enter('-45453231322119310');" onmouseout="out('-45453231322119310');" style=""> 197              OrderItemHolder orderItemHolder, OfferItemCriteria itemCriteria,                                      </span>
<span class="-532102448020563017" onmouseenter="enter('-532102448020563017');" onmouseout="out('-532102448020563017');" style=""> 198              List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets) {       </span>
<span class="1399559222284052069" onmouseenter="enter('1399559222284052069');" onmouseout="out('1399559222284052069');" style=""> 199          sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());               </span>
<span  style=""> 200                                                                                                                    </span>
<span class="-2005578619141057452" onmouseenter="enter('-2005578619141057452');" onmouseout="out('-2005578619141057452');" style=""> 201          // Calculate the number of qualifiers needed that will not receive the promotion.                         </span>
<span class="-7642725860669587391" onmouseenter="enter('-7642725860669587391');" onmouseout="out('-7642725860669587391');" style=""> 202          // These will be reserved first before the target is assigned.                                            </span>
<span class="-5221545606159729582" onmouseenter="enter('-5221545606159729582');" onmouseout="out('-5221545606159729582');" style=""> 203          int qualifierQtyNeeded = itemCriteria.getQuantity();                                                      </span>
<span  style=""> 204                                                                                                                    </span>
<span class="-389357445740262218" onmouseenter="enter('-389357445740262218');" onmouseout="out('-389357445740262218');" style=""> 205          for (PromotableOrderItemPriceDetail detail : priceDetails) {                                              </span>
<span class="-317635885918930708" onmouseenter="enter('-317635885918930708');" onmouseout="out('-317635885918930708');" style=""> 206              OrderItem oi = detail.getPromotableOrderItem().getOrderItem();                                        </span>
<span  style=""> 207                                                                                                                    </span>
<span class="7203543687533075574" onmouseenter="enter('7203543687533075574');" onmouseout="out('7203543687533075574');" style=""> 208              if (qualifierQtyNeeded &gt; 0) {                                                                         </span>
<span class="4739725621440457335" onmouseenter="enter('4739725621440457335');" onmouseout="out('4739725621440457335');" style=""><abbr title=" 209                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 209                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOfferðŸ”µ</abbr></span>
<span class="118721626032663442" onmouseenter="enter('118721626032663442');" onmouseout="out('118721626032663442');" style=""> 210                  if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {                                                    </span>
<span class="-1004810985579465662" onmouseenter="enter('-1004810985579465662');" onmouseout="out('-1004810985579465662');" style=""><abbr title=" 211                      // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some state that we"> 211                      // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some state thatðŸ”µ</abbr></span>
<span class="8185689978075296148" onmouseenter="enter('8185689978075296148');" onmouseout="out('8185689978075296148');" style=""> 212                      // might need in the future.                                                                  </span>
<span class="-1081050306738024693" onmouseenter="enter('-1081050306738024693');" onmouseout="out('-1081050306738024693');" style=""> 213                      OfferItemCriteria previousQualifierCriteria = null;                                           </span>
<span class="-8553070012108320907" onmouseenter="enter('-8553070012108320907');" onmouseout="out('-8553070012108320907');" style=""> 214                      for (PromotionQualifier possibleQualifier : detail.getPromotionQualifiers()) {                </span>
<span class="-4722657733023489778" onmouseenter="enter('-4722657733023489778');" onmouseout="out('-4722657733023489778');" style=""> 215                          if (possibleQualifier.getPromotion().equals(itemOffer.getOffer())) {                      </span>
<span class="-3028735657089400229" onmouseenter="enter('-3028735657089400229');" onmouseout="out('-3028735657089400229');" style=""> 216                              previousQualifierCriteria = possibleQualifier.getItemCriteria();                      </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 217                              break;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 218                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 219                      }                                                                                             </span>
<span  style=""> 220                                                                                                                    </span>
<span class="1008214769590136048" onmouseenter="enter('1008214769590136048');" onmouseout="out('1008214769590136048');" style=""> 221                      // Go ahead and mark this item as a qualifier                                                 </span>
<span class="156141582657617565" onmouseenter="enter('156141582657617565');" onmouseout="out('156141582657617565');" style=""> 222                      int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier); </span>
<span class="-4684084580161696213" onmouseenter="enter('-4684084580161696213');" onmouseout="out('-4684084580161696213');" style=""> 223                      qualifierQtyNeeded -= qtyToMarkAsQualifier;                                                   </span>
<span class="2797159826704329425" onmouseenter="enter('2797159826704329425');" onmouseout="out('2797159826704329425');" style=""><abbr title=" 224                      PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);"> 224                      PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualiðŸ”µ</abbr></span>
<span class="-7100200875909405519" onmouseenter="enter('-7100200875909405519');" onmouseout="out('-7100200875909405519');" style=""><abbr title=" 225                      pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOffer().getApplyDiscountToSalePrice()));"> 225                      pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOffer().getðŸ”µ</abbr></span>
<span  style=""> 226                                                                                                                    </span>
<span class="6012497254282640402" onmouseenter="enter('6012497254282640402');" onmouseout="out('6012497254282640402');" style=""> 227                      // Now, we need to see if there exists a target(s) that is suitable for this qualifier due to </span>
<span class="-1151958798348543907" onmouseenter="enter('-1151958798348543907');" onmouseout="out('-1151958798348543907');" style=""> 228                      // the relationship flag. If we are on the last qualifier required for this offer, we want to </span>
<span class="3987909966354550925" onmouseenter="enter('3987909966354550925');" onmouseout="out('3987909966354550925');" style=""> 229                      // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just want to check</span>
<span class="4959301888820404945" onmouseenter="enter('4959301888820404945');" onmouseout="out('4959301888820404945');" style=""> 230                      // that there is an eligible target(s) and continue on.                                       </span>
<span class="-5256242047209748696" onmouseenter="enter('-5256242047209748696');" onmouseout="out('-5256242047209748696');" style=""> 231                      if (itemOfferMarkTargets.markTargets(itemOffer, order, oi, true)) {                           </span>
<span class="-297796406415044190" onmouseenter="enter('-297796406415044190');" onmouseout="out('-297796406415044190');" style=""> 232                          // We found a target. Let&#x27;s save this related order item used as the qualifier in case    </span>
<span class="6348154252416536055" onmouseenter="enter('6348154252416536055');" onmouseout="out('6348154252416536055');" style=""> 233                          // we succeed                                                                             </span>
<span class="-6098537281436011553" onmouseenter="enter('-6098537281436011553');" onmouseout="out('-6098537281436011553');" style=""> 234                          orderItemHolder.setOrderItem(oi);                                                         </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 235                      } else {                                                                                      </span>
<span class="1831842559835648517" onmouseenter="enter('1831842559835648517');" onmouseout="out('1831842559835648517');" style=""><abbr title=" 236                          // If we didn&#x27;t find a target, we need to roll back how we marked this item as a qualifier."> 236                          // If we didn&#x27;t find a target, we need to roll back how we marked this item as a qualifierðŸ”µ</abbr></span>
<span class="-1853870893725774252" onmouseenter="enter('-1853870893725774252');" onmouseout="out('-1853870893725774252');" style=""> 237                          qualifierQtyNeeded += qtyToMarkAsQualifier;                                               </span>
<span class="-8128593861119500077" onmouseenter="enter('-8128593861119500077');" onmouseout="out('-8128593861119500077');" style=""> 238                          if (pq.getQuantity() == qtyToMarkAsQualifier) {                                           </span>
<span class="-6954079035160286378" onmouseenter="enter('-6954079035160286378');" onmouseout="out('-6954079035160286378');" style=""> 239                              detail.getPromotionQualifiers().remove(pq);                                           </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 240                          } else {                                                                                  </span>
<span class="6626310861157345131" onmouseenter="enter('6626310861157345131');" onmouseout="out('6626310861157345131');" style=""> 241                              pq.setItemCriteria(previousQualifierCriteria);                                        </span>
<span class="2348238745962483804" onmouseenter="enter('2348238745962483804');" onmouseout="out('2348238745962483804');" style=""> 242                              pq.setQuantity(pq.getQuantity() - qtyToMarkAsQualifier);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 243                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 244                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 245                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 246              }                                                                                                     </span>
<span  style=""> 247                                                                                                                    </span>
<span class="8517154315660472641" onmouseenter="enter('8517154315660472641');" onmouseout="out('8517154315660472641');" style=""> 248              if (qualifierQtyNeeded == 0) {                                                                        </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 249                  break;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 250              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251          }                                                                                                         </span>
<span class="-4850383672896867816" onmouseenter="enter('-4850383672896867816');" onmouseout="out('-4850383672896867816');" style=""> 252          return qualifierQtyNeeded;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 253      }                                                                                                             </span>
<span  style=""> 254                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 255      @Override                                                                                                     </span>
<span class="-5508403457222384501" onmouseenter="enter('-5508403457222384501');" onmouseout="out('-5508403457222384501');" style=""><abbr title=" 256      public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails) {"> 256      public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItðŸ”µ</abbr></span>
<span class="-1180947180176660619" onmouseenter="enter('-1180947180176660619');" onmouseout="out('-1180947180176660619');" style=""> 257          for (PromotableOrderItemPriceDetail itemPriceDetail : itemPriceDetails) {                                 </span>
<span class="-669978432390486383" onmouseenter="enter('-669978432390486383');" onmouseout="out('-669978432390486383');" style=""> 258              for (PromotionDiscount discount : itemPriceDetail.getPromotionDiscounts()) {                          </span>
<span class="-4320063668461010504" onmouseenter="enter('-4320063668461010504');" onmouseout="out('-4320063668461010504');" style=""> 259                  if (discount.getPromotion().equals(itemOffer.getOffer())) {                                       </span>
<span class="-8948799313684021645" onmouseenter="enter('-8948799313684021645');" onmouseout="out('-8948799313684021645');" style=""><abbr title=" 260                      if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 260                      if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWithOtherOðŸ”µ</abbr></span>
<span class="8050394734563130560" onmouseenter="enter('8050394734563130560');" onmouseout="out('8050394734563130560');" style=""> 261                          // We&#x27;ve decided to apply this adjustment but if it doesn&#x27;t actually reduce               </span>
<span class="-7936715023008804819" onmouseenter="enter('-7936715023008804819');" onmouseout="out('-7936715023008804819');" style=""> 262                          // the value of the item                                                                  </span>
<span class="7229649304367309721" onmouseenter="enter('7229649304367309721');" onmouseout="out('7229649304367309721');" style=""> 263                          if (adjustmentIsNotGoodEnoughToBeApplied(itemOffer, itemPriceDetail)) {                   </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 264                              break;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 265                          }                                                                                         </span>
<span  style=""> 266                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 267                      }                                                                                             </span>
<span class="-4859405226118818324" onmouseenter="enter('-4859405226118818324');" onmouseout="out('-4859405226118818324');" style=""> 268                      OrderItem orderItem = itemPriceDetail.getPromotableOrderItem().getOrderItem();                </span>
<span class="-7036726360330387930" onmouseenter="enter('-7036726360330387930');" onmouseout="out('-7036726360330387930');" style=""> 269                      Boolean offerCanApplyToChildOrderItems = itemOffer.getOffer().getApplyToChildItems();         </span>
<span class="5319718821501044453" onmouseenter="enter('5319718821501044453');" onmouseout="out('5319718821501044453');" style=""> 270                      if (isAddOnOrderItem(orderItem) &amp;&amp; !offerCanApplyToChildOrderItems) {                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 271                          break;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 272                      }                                                                                             </span>
<span class="-2464330301917486275" onmouseenter="enter('-2464330301917486275');" onmouseout="out('-2464330301917486275');" style=""> 273                      applyOrderItemAdjustment(itemOffer, itemPriceDetail);                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 274                      break;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 275                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 276              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 277          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 278      }                                                                                                             </span>
<span  style=""> 279                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 280      @Override                                                                                                     </span>
<span class="5703716165905853432" onmouseenter="enter('5703716165905853432');" onmouseout="out('5703716165905853432');" style=""> 281      public boolean isAddOnOrderItem(OrderItem orderItem) {                                                        </span>
<span class="-915100238682069401" onmouseenter="enter('-915100238682069401');" onmouseout="out('-915100238682069401');" style=""> 282          if (DiscreteOrderItem.class.isAssignableFrom(orderItem.getClass())) {                                     </span>
<span class="-9161979270697696061" onmouseenter="enter('-9161979270697696061');" onmouseout="out('-9161979270697696061');" style=""> 283              DiscreteOrderItem discreteOrderItem = (DiscreteOrderItem) orderItem;                                  </span>
<span  style=""> 284                                                                                                                    </span>
<span class="-5356075907008875039" onmouseenter="enter('-5356075907008875039');" onmouseout="out('-5356075907008875039');" style=""> 285              Map&lt;String, String&gt; attributes = discreteOrderItem.getAdditionalAttributes();                         </span>
<span class="-4907356983337991835" onmouseenter="enter('-4907356983337991835');" onmouseout="out('-4907356983337991835');" style=""> 286              boolean isAddOnOrderItem = attributes.containsKey(&quot;addOnXrefId&quot;);                                     </span>
<span class="4227157952965713451" onmouseenter="enter('4227157952965713451');" onmouseout="out('4227157952965713451');" style=""> 287              boolean isChildOrderItem = discreteOrderItem.isChildOrderItem();                                      </span>
<span  style=""> 288                                                                                                                    </span>
<span class="8373226173169122886" onmouseenter="enter('8373226173169122886');" onmouseout="out('8373226173169122886');" style=""> 289              return isChildOrderItem &amp;&amp; isAddOnOrderItem;                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 290          }                                                                                                         </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 291          return false;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 292      }                                                                                                             </span>
<span  style=""> 293                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 294      /**                                                                                                           </span>
<span class="7835653502933924919" onmouseenter="enter('7835653502933924919');" onmouseout="out('7835653502933924919');" style=""> 295       * The adjustment might not be better than the sale price.                                                    </span>
<span class="-123895333908918857" onmouseenter="enter('-123895333908918857');" onmouseout="out('-123895333908918857');" style=""> 296       * @param itemOffer                                                                                           </span>
<span class="4317834721456676207" onmouseenter="enter('4317834721456676207');" onmouseout="out('4317834721456676207');" style=""> 297       * @param detail                                                                                              </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 298       * @return                                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 299       */                                                                                                           </span>
<span class="8886963584830850852" onmouseenter="enter('8886963584830850852');" onmouseout="out('8886963584830850852');" style=""> 300      protected boolean adjustmentIsNotGoodEnoughToBeApplied(PromotableCandidateItemOffer itemOffer,                </span>
<span class="-5789972309208145824" onmouseenter="enter('-5789972309208145824');" onmouseout="out('-5789972309208145824');" style=""> 301              PromotableOrderItemPriceDetail detail) {                                                              </span>
<span class="5404670390791397495" onmouseenter="enter('5404670390791397495');" onmouseout="out('5404670390791397495');" style=""> 302          if (!itemOffer.getOffer().getApplyDiscountToSalePrice()) {                                                </span>
<span class="2444901768581949268" onmouseenter="enter('2444901768581949268');" onmouseout="out('2444901768581949268');" style=""> 303              Money salePrice = detail.getPromotableOrderItem().getSalePriceBeforeAdjustments();                    </span>
<span class="5875272574250045376" onmouseenter="enter('5875272574250045376');" onmouseout="out('5875272574250045376');" style=""> 304              Money retailPrice = detail.getPromotableOrderItem().getRetailPriceBeforeAdjustments();                </span>
<span class="-7752206275348171601" onmouseenter="enter('-7752206275348171601');" onmouseout="out('-7752206275348171601');" style=""> 305              Money savings = itemOffer.calculateSavingsForOrderItem(detail.getPromotableOrderItem(), 1);           </span>

<span class="-3042742338309722510" onmouseenter="enter('-3042742338309722510');" onmouseout="out('-3042742338309722510');" style=""> 306              if (salePrice != null) {                                                                              </span>
<span class="4776635754548450658" onmouseenter="enter('4776635754548450658');" onmouseout="out('4776635754548450658');" style=""> 307                  if (salePrice.lessThan(retailPrice.subtract(savings))) {                                          </span>
<span class="5206565982893115863" onmouseenter="enter('5206565982893115863');" onmouseout="out('5206565982893115863');" style=""> 308                      // Not good enough                                                                            </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 309                      return true;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 310                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 311              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 312          }                                                                                                         </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 313          return false;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 314      }                                                                                                             </span>
<span  style=""> 315                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 316      @Override                                                                                                     </span>
<span class="-3274580905325891597" onmouseenter="enter('-3274580905325891597');" onmouseout="out('-3274580905325891597');" style=""> 317      public void applyOrderItemAdjustment(PromotableCandidateItemOffer itemOffer,                                  </span>
<span class="-8798183871686674116" onmouseenter="enter('-8798183871686674116');" onmouseout="out('-8798183871686674116');" style=""> 318              PromotableOrderItemPriceDetail itemPriceDetail) {                                                     </span>
<span class="-2791625561543308737" onmouseenter="enter('-2791625561543308737');" onmouseout="out('-2791625561543308737');" style=""> 319          PromotableOrderItemPriceDetailAdjustment promotableOrderItemPriceDetailAdjustment =                       </span>
<span class="-1963732814850126206" onmouseenter="enter('-1963732814850126206');" onmouseout="out('-1963732814850126206');" style=""> 320                  promotableItemFactory.createPromotableOrderItemPriceDetailAdjustment(itemOffer, itemPriceDetail); </span>
<span class="2431499017104838762" onmouseenter="enter('2431499017104838762');" onmouseout="out('2431499017104838762');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +        //don&#x27;t want to have negative adjustments                                                                 </span>
<span class="-6618345538058051679" onmouseenter="enter('-6618345538058051679');" onmouseout="out('-6618345538058051679');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +        if(promotableOrderItemPriceDetailAdjustment.getRetailAdjustmentValue().lessThan(BigDecimal.ZERO) ||       </span>
<span class="7927443701435766406" onmouseenter="enter('7927443701435766406');" onmouseout="out('7927443701435766406');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +                promotableOrderItemPriceDetailAdjustment.getSaleAdjustmentValue().lessThan(BigDecimal.ZERO)){     </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +            return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +        }                                                                                                         </span>
<span class="-452752185035923989" onmouseenter="enter('-452752185035923989');" onmouseout="out('-452752185035923989');" style=""> 326          itemPriceDetail.addCandidateItemPriceDetailAdjustment(promotableOrderItemPriceDetailAdjustment);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 327      }                                                                                                             </span>
<span  style=""> 328                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 329      @Override                                                                                                     </span>
<span class="-361580458958843386" onmouseenter="enter('-361580458958843386');" onmouseout="out('-361580458958843386');" style=""> 330      public List&lt;OrderItem&gt; buildOrderItemList(Order order) {                                                      </span>
<span class="4933536323910912844" onmouseenter="enter('4933536323910912844');" onmouseout="out('4933536323910912844');" style=""> 331          List&lt;OrderItem&gt; orderItemList = new ArrayList&lt;OrderItem&gt;();                                               </span>
<span class="4435196443097834597" onmouseenter="enter('4435196443097834597');" onmouseout="out('4435196443097834597');" style=""> 332          for (OrderItem currentItem : order.getOrderItems()) {                                                     </span>
<span class="-2966775259995926277" onmouseenter="enter('-2966775259995926277');" onmouseout="out('-2966775259995926277');" style=""> 333              if (currentItem instanceof OrderItemContainer) {                                                      </span>
<span class="5137067544827715705" onmouseenter="enter('5137067544827715705');" onmouseout="out('5137067544827715705');" style=""> 334                  OrderItemContainer container = (OrderItemContainer) currentItem;                                  </span>
<span class="4382484490734880847" onmouseenter="enter('4382484490734880847');" onmouseout="out('4382484490734880847');" style=""> 335                  if (container.isPricingAtContainerLevel()) {                                                      </span>
<span class="-2270489982917990854" onmouseenter="enter('-2270489982917990854');" onmouseout="out('-2270489982917990854');" style=""> 336                      orderItemList.add(currentItem);                                                               </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 337                  } else {                                                                                          </span>
<span class="112302786623021779" onmouseenter="enter('112302786623021779');" onmouseout="out('112302786623021779');" style=""> 338                      for (OrderItem containedItem : container.getOrderItems()) {                                   </span>
<span class="533266059764191893" onmouseenter="enter('533266059764191893');" onmouseout="out('533266059764191893');" style=""> 339                          orderItemList.add(containedItem);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 340                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 341                  }                                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 342              } else {                                                                                              </span>
<span class="-2270489982917990854" onmouseenter="enter('-2270489982917990854');" onmouseout="out('-2270489982917990854');" style=""> 343                  orderItemList.add(currentItem);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 344              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 345          }                                                                                                         </span>
<span  style=""> 346                                                                                                                    </span>
<span class="1499720353589212944" onmouseenter="enter('1499720353589212944');" onmouseout="out('1499720353589212944');" style=""> 347          return orderItemList;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 348      }                                                                                                             </span>
<span  style=""> 349                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 350      @Override                                                                                                     </span>
<span class="-8956803960090910177" onmouseenter="enter('-8956803960090910177');" onmouseout="out('-8956803960090910177');" style=""> 351      public Map&lt;OrderItem, PromotableOrderItem&gt; buildPromotableItemMap(PromotableOrder promotableOrder) {          </span>
<span class="-2911482928816722705" onmouseenter="enter('-2911482928816722705');" onmouseout="out('-2911482928816722705');" style=""> 352          Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderItem&gt;();    </span>
<span class="4206403965644457797" onmouseenter="enter('4206403965644457797');" onmouseout="out('4206403965644457797');" style=""> 353          for (PromotableOrderItem item : promotableOrder.getAllOrderItems()) {                                     </span>
<span class="-3870195952016518221" onmouseenter="enter('-3870195952016518221');" onmouseout="out('-3870195952016518221');" style=""> 354              promotableItemMap.put(item.getOrderItem(), item);                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 355          }                                                                                                         </span>
<span class="8963770174585233491" onmouseenter="enter('8963770174585233491');" onmouseout="out('8963770174585233491');" style=""> 356          return promotableItemMap;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 357      }                                                                                                             </span>
<span  style=""> 358                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 359      @Override                                                                                                     </span>
<span class="-8575715219777406772" onmouseenter="enter('-8575715219777406772');" onmouseout="out('-8575715219777406772');" style=""><abbr title=" 360      public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itemDetail) {"> 360      public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itemDetail)ðŸ”µ</abbr></span>
<span class="7467828794567286984" onmouseenter="enter('7467828794567286984');" onmouseout="out('7467828794567286984');" style=""><abbr title=" 361          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 361          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetailAdjustðŸ”µ</abbr></span>
<span  style=""> 362                                                                                                                    </span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 363          List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 363          List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;()ðŸ”µ</abbr></span>
<span class="-1371106512285082048" onmouseenter="enter('-1371106512285082048');" onmouseout="out('-1371106512285082048');" style=""> 364          for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {       </span>
<span class="-1262630258018644876" onmouseenter="enter('-1262630258018644876');" onmouseout="out('-1262630258018644876');" style=""> 365              if (itemAdjustmentMap.containsKey(adjustment.getOffer().getId())) {                                   </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 366                  if (LOG.isDebugEnabled()) {                                                                       </span>
<span class="5365687806736453142" onmouseenter="enter('5365687806736453142');" onmouseout="out('5365687806736453142');" style=""> 367                      StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with ids &quot;)    </span>
<span class="5769765961448228869" onmouseenter="enter('5769765961448228869');" onmouseout="out('5769765961448228869');" style=""> 368                          .append(itemAdjustmentMap.get(adjustment.getOffer().getId()).getId())                     </span>
<span class="7312533819175146387" onmouseenter="enter('7312533819175146387');" onmouseout="out('7312533819175146387');" style=""> 369                          .append(&quot; and &quot;)                                                                          </span>
<span class="-7531978261873044464" onmouseenter="enter('-7531978261873044464');" onmouseout="out('-7531978261873044464');" style=""> 370                          .append(adjustment.getId());                                                              </span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 371                      LOG.debug(sb.toString());                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 372                  }                                                                                                 </span>
<span class="5304290905678094245" onmouseenter="enter('5304290905678094245');" onmouseout="out('5304290905678094245');" style=""> 373                  adjustmentsToRemove.add(adjustment);                                                              </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 374              } else {                                                                                              </span>
<span class="-2602676027025933258" onmouseenter="enter('-2602676027025933258');" onmouseout="out('-2602676027025933258');" style=""> 375                  itemAdjustmentMap.put(adjustment.getOffer().getId(), adjustment);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 376              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 377          }                                                                                                         </span>
<span  style=""> 378                                                                                                                    </span>
<span class="-6749489598586186680" onmouseenter="enter('-6749489598586186680');" onmouseout="out('-6749489598586186680');" style=""> 379          for (OrderItemPriceDetailAdjustment adjustment : adjustmentsToRemove) {                                   </span>
<span class="170302329650885695" onmouseenter="enter('170302329650885695');" onmouseout="out('170302329650885695');" style=""> 380              itemDetail.getOrderItemPriceDetailAdjustments().remove(adjustment);                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 381          }                                                                                                         </span>
<span  style=""> 382                                                                                                                    </span>
<span class="-1848478302592739813" onmouseenter="enter('-1848478302592739813');" onmouseout="out('-1848478302592739813');" style=""> 383          return itemAdjustmentMap;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 384      }                                                                                                             </span>
<span  style=""> 385                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 386      @Override                                                                                                     </span>
<span class="7034544881417042941" onmouseenter="enter('7034544881417042941');" onmouseout="out('7034544881417042941');" style=""> 387      public void updatePriceDetail(OrderItemPriceDetail itemDetail,                                                </span>
<span class="-1090177046597316726" onmouseenter="enter('-1090177046597316726');" onmouseout="out('-1090177046597316726');" style=""> 388              PromotableOrderItemPriceDetail promotableDetail) {                                                    </span>
<span class="3894635813711687840" onmouseenter="enter('3894635813711687840');" onmouseout="out('3894635813711687840');" style=""> 389          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =                                             </span>
<span class="7785105538478960936" onmouseenter="enter('7785105538478960936');" onmouseout="out('7785105538478960936');" style=""> 390                  buildItemDetailAdjustmentMap(itemDetail);                                                         </span>
<span  style=""> 391                                                                                                                    </span>
<span class="8052115462234529390" onmouseenter="enter('8052115462234529390');" onmouseout="out('8052115462234529390');" style=""> 392          if (itemDetail.getQuantity() != promotableDetail.getQuantity()) {                                         </span>
<span class="8615443511774170500" onmouseenter="enter('8615443511774170500');" onmouseout="out('8615443511774170500');" style=""> 393              itemDetail.setQuantity(promotableDetail.getQuantity());                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 394          }                                                                                                         </span>
<span  style=""> 395                                                                                                                    </span>
<span class="-7750740315935940052" onmouseenter="enter('-7750740315935940052');" onmouseout="out('-7750740315935940052');" style=""> 396          if (promotableDetail.isAdjustmentsFinalized()) {                                                          </span>
<span class="8693299076047883645" onmouseenter="enter('8693299076047883645');" onmouseout="out('8693299076047883645');" style=""> 397              itemDetail.setUseSalePrice(promotableDetail.useSaleAdjustments());                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 398          }                                                                                                         </span>
<span  style=""> 399                                                                                                                    </span>
<span class="-200913113255250114" onmouseenter="enter('-200913113255250114');" onmouseout="out('-200913113255250114');" style=""><abbr title=" 400          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjustments()) {"> 400          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjustments())ðŸ”µ</abbr></span>
<span class="6578727718670889454" onmouseenter="enter('6578727718670889454');" onmouseout="out('6578727718670889454');" style=""> 401              OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferId());    </span>
<span class="-5676819544918869237" onmouseenter="enter('-5676819544918869237');" onmouseout="out('-5676819544918869237');" style=""> 402              if (itemAdjustment != null) {                                                                         </span>
<span class="2095963063095688848" onmouseenter="enter('2095963063095688848');" onmouseout="out('2095963063095688848');" style=""> 403                  // Update existing adjustment                                                                     </span>
<span class="4997906471413856597" onmouseenter="enter('4997906471413856597');" onmouseout="out('4997906471413856597');" style=""> 404                  if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {                         </span>
<span class="-7190567157504063803" onmouseenter="enter('-7190567157504063803');" onmouseout="out('-7190567157504063803');" style=""> 405                      updateItemAdjustment(itemAdjustment, adjustment);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 406                  }                                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 407              } else {                                                                                              </span>
<span class="-3662936612993896923" onmouseenter="enter('-3662936612993896923');" onmouseout="out('-3662936612993896923');" style=""> 408                  // Add a new adjustment                                                                           </span>
<span class="6730722799913825373" onmouseenter="enter('6730722799913825373');" onmouseout="out('6730722799913825373');" style=""> 409                  final OrderItemPriceDetailAdjustment newItemAdjustment;                                           </span>
<span class="-3180324819813272445" onmouseenter="enter('-3180324819813272445');" onmouseout="out('-3180324819813272445');" style=""> 410                  ExtensionResultHolder resultHolder = new ExtensionResultHolder();                                 </span>
<span  style=""> 411                                                                                                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 412                  if (extensionManager != null) {                                                                   </span>
<span class="4841855343164111630" onmouseenter="enter('4841855343164111630');" onmouseout="out('4841855343164111630');" style=""> 413                      extensionManager.createOrderItemPriceDetailAdjustment(resultHolder, itemDetail);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 414                  }                                                                                                 </span>
<span class="3886522200438865522" onmouseenter="enter('3886522200438865522');" onmouseout="out('3886522200438865522');" style=""><abbr title=" 415                  if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetailAdjustment&quot;)) {"> 415                  if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetailAdjustmeðŸ”µ</abbr></span>
<span class="-3287798826483764260" onmouseenter="enter('-3287798826483764260');" onmouseout="out('-3287798826483764260');" style=""><abbr title=" 416                      newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().get(&quot;OrderItemPriceDetailAdjustment&quot;);"> 416                      newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().get(&quot;OrderItðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 417                  } else {                                                                                          </span>
<span class="3374546574285123670" onmouseenter="enter('3374546574285123670');" onmouseout="out('3374546574285123670');" style=""> 418                      newItemAdjustment = offerDao.createOrderItemPriceDetailAdjustment();                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 419                  }                                                                                                 </span>
<span class="6434193420407019930" onmouseenter="enter('6434193420407019930');" onmouseout="out('6434193420407019930');" style=""> 420                  newItemAdjustment.init(itemDetail, adjustment.getOffer(), null);                                  </span>
<span class="2527816204760883975" onmouseenter="enter('2527816204760883975');" onmouseout="out('2527816204760883975');" style=""> 421                  updateItemAdjustment(newItemAdjustment, adjustment);                                              </span>
<span class="280404668024484347" onmouseenter="enter('280404668024484347');" onmouseout="out('280404668024484347');" style=""> 422                  itemDetail.getOrderItemPriceDetailAdjustments().add(newItemAdjustment);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 423              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 424          }                                                                                                         </span>
<span  style=""> 425                                                                                                                    </span>
<span class="2716703745442399701" onmouseenter="enter('2716703745442399701');" onmouseout="out('2716703745442399701');" style=""> 426          if (itemAdjustmentMap.size() &gt; 0) {                                                                       </span>
<span class="7320812723157924979" onmouseenter="enter('7320812723157924979');" onmouseout="out('7320812723157924979');" style=""> 427              // Remove adjustments that were on the order item but no longer needed.                               </span>
<span class="-1869846822270594411" onmouseenter="enter('-1869846822270594411');" onmouseout="out('-1869846822270594411');" style=""> 428              List&lt;Long&gt; adjustmentIdsToRemove = new ArrayList&lt;Long&gt;();                                             </span>
<span class="8226461738127611440" onmouseenter="enter('8226461738127611440');" onmouseout="out('8226461738127611440');" style=""> 429              for (OrderItemPriceDetailAdjustment adjustmentToRemove : itemAdjustmentMap.values()) {                </span>
<span class="-5089858163100858042" onmouseenter="enter('-5089858163100858042');" onmouseout="out('-5089858163100858042');" style=""> 430                  adjustmentIdsToRemove.add(adjustmentToRemove.getOffer().getId());                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 431              }                                                                                                     </span>
<span  style=""> 432                                                                                                                    </span>
<span class="-713707707098991740" onmouseenter="enter('-713707707098991740');" onmouseout="out('-713707707098991740');" style=""><abbr title=" 433              Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustments().iterator();"> 433              Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustments().itðŸ”µ</abbr></span>
<span class="977968488612897428" onmouseenter="enter('977968488612897428');" onmouseout="out('977968488612897428');" style=""> 434              while (iterator.hasNext()) {                                                                          </span>
<span class="-6499043821118944641" onmouseenter="enter('-6499043821118944641');" onmouseout="out('-6499043821118944641');" style=""> 435                  OrderItemPriceDetailAdjustment adj = iterator.next();                                             </span>
<span class="-3830175641101683618" onmouseenter="enter('-3830175641101683618');" onmouseout="out('-3830175641101683618');" style=""> 436                  if (adjustmentIdsToRemove.contains(adj.getOffer().getId())) {                                     </span>
<span class="-6215380074365660212" onmouseenter="enter('-6215380074365660212');" onmouseout="out('-6215380074365660212');" style=""> 437                      iterator.remove();                                                                            </span>
<span class="-7443090736167231390" onmouseenter="enter('-7443090736167231390');" onmouseout="out('-7443090736167231390');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 438 +                    entityService.remove(adj);                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 439                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 440              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 441          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 442      }                                                                                                             </span>
<span  style=""> 443                                                                                                                    </span>
<span class="-2179044478542157534" onmouseenter="enter('-2179044478542157534');" onmouseout="out('-2179044478542157534');" style=""> 444      protected void updateItemAdjustment(OrderItemPriceDetailAdjustment itemAdjustment,                            </span>
<span class="-2091009272129273931" onmouseenter="enter('-2091009272129273931');" onmouseout="out('-2091009272129273931');" style=""> 445              PromotableOrderItemPriceDetailAdjustment promotableAdjustment) {                                      </span>
<span class="8984388188384789298" onmouseenter="enter('8984388188384789298');" onmouseout="out('8984388188384789298');" style=""> 446          itemAdjustment.setValue(promotableAdjustment.getAdjustmentValue());                                       </span>
<span class="-1504764115388345009" onmouseenter="enter('-1504764115388345009');" onmouseout="out('-1504764115388345009');" style=""> 447          itemAdjustment.setSalesPriceValue(promotableAdjustment.getSaleAdjustmentValue());                         </span>
<span class="8159218742886391276" onmouseenter="enter('8159218742886391276');" onmouseout="out('8159218742886391276');" style=""> 448          itemAdjustment.setRetailPriceValue(promotableAdjustment.getRetailAdjustmentValue());                      </span>
<span class="-6000420337005117738" onmouseenter="enter('-6000420337005117738');" onmouseout="out('-6000420337005117738');" style=""> 449          itemAdjustment.setAppliedToSalePrice(promotableAdjustment.isAppliedToSalePrice());                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 450      }                                                                                                             </span>
<span  style=""> 451                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 452      @Override                                                                                                     </span>
<span class="-313570815421854700" onmouseenter="enter('-313570815421854700');" onmouseout="out('-313570815421854700');" style=""> 453      public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMap,        </span>
<span class="-3281550581325801818" onmouseenter="enter('-3281550581325801818');" onmouseout="out('-3281550581325801818');" style=""> 454              Iterator&lt;? extends OrderItemPriceDetail&gt; pdIterator) {                                                </span>
<span class="5054006045083210855" onmouseenter="enter('5054006045083210855');" onmouseout="out('5054006045083210855');" style=""> 455          while (pdIterator.hasNext()) {                                                                            </span>
<span class="3750310726725232966" onmouseenter="enter('3750310726725232966');" onmouseout="out('3750310726725232966');" style=""> 456              OrderItemPriceDetail currentDetail = pdIterator.next();                                               </span>
<span class="6581958837024527183" onmouseenter="enter('6581958837024527183');" onmouseout="out('6581958837024527183');" style=""> 457              if (unmatchedDetailsMap.containsKey(currentDetail.getId())) {                                         </span>
<span class="-6186712185724981265" onmouseenter="enter('-6186712185724981265');" onmouseout="out('-6186712185724981265');" style=""> 458                  pdIterator.remove();                                                                              </span>
<span class="-4950660564716836933" onmouseenter="enter('-4950660564716836933');" onmouseout="out('-4950660564716836933');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 459 +                entityService.remove(currentDetail);                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 460              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 461          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 462      }                                                                                                             </span>
<span  style=""> 463                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 464      @Override                                                                                                     </span>
<span class="8034359428831826315" onmouseenter="enter('8034359428831826315');" onmouseout="out('8034359428831826315');" style=""> 465      public void removeUnmatchedQualifiers(Map&lt;Long, ? extends OrderItemQualifier&gt; unmatchedQualifiersMap,         </span>
<span class="-2169714322041971999" onmouseenter="enter('-2169714322041971999');" onmouseout="out('-2169714322041971999');" style=""> 466              Iterator&lt;? extends OrderItemQualifier&gt; qIterator) {                                                   </span>
<span class="2447020288494192331" onmouseenter="enter('2447020288494192331');" onmouseout="out('2447020288494192331');" style=""> 467          while (qIterator.hasNext()) {                                                                             </span>
<span class="-6005719546303323499" onmouseenter="enter('-6005719546303323499');" onmouseout="out('-6005719546303323499');" style=""> 468              OrderItemQualifier currentQualifier = qIterator.next();                                               </span>
<span class="662385347998037693" onmouseenter="enter('662385347998037693');" onmouseout="out('662385347998037693');" style=""> 469              if (unmatchedQualifiersMap.containsKey(currentQualifier.getId())) {                                   </span>
<span class="-5446309343821913287" onmouseenter="enter('-5446309343821913287');" onmouseout="out('-5446309343821913287');" style=""> 470                  qIterator.remove();                                                                               </span>
<span class="-863522997969238164" onmouseenter="enter('-863522997969238164');" onmouseout="out('-863522997969238164');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 471 +                entityService.remove(currentQualifier);                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 472              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 473          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 474      }                                                                                                             </span>
<span  style=""> 475                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 476      @Override                                                                                                     </span>
<span class="-4444436672341398789" onmouseenter="enter('-4444436672341398789');" onmouseout="out('-4444436672341398789');" style=""><abbr title=" 477      public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; qualifiersMap) {"> 477      public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCðŸ”µ</abbr></span>
<span class="5670547093193511713" onmouseenter="enter('5670547093193511713');" onmouseout="out('5670547093193511713');" style=""> 478          Money qualifyingItemSubTotal = offer.getQualifyingItemSubTotal();                                         </span>
<span class="-5062121077129985722" onmouseenter="enter('-5062121077129985722');" onmouseout="out('-5062121077129985722');" style=""> 479          if (qualifyingItemSubTotal == null || qualifyingItemSubTotal.lessThanOrEqual(Money.ZERO)) {               </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 480              return true;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 481          }                                                                                                         </span>
<span class="-7755694615807420902" onmouseenter="enter('-7755694615807420902');" onmouseout="out('-7755694615807420902');" style=""> 482          return orderMeetsProvidedSubtotalRequirement(offer, qualifiersMap, qualifyingItemSubTotal);               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 483      }                                                                                                             </span>
<span  style=""> 484                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 485      @Override                                                                                                     </span>
<span class="-5677301022020811119" onmouseenter="enter('-5677301022020811119');" onmouseout="out('-5677301022020811119');" style=""><abbr title=" 486      public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; targetsMap) {"> 486      public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteðŸ”µ</abbr></span>
<span class="6988724665629485016" onmouseenter="enter('6988724665629485016');" onmouseout="out('6988724665629485016');" style=""> 487          Money targetMinSubTotal = offer.getTargetMinSubTotal();                                                   </span>
<span class="-1489567751755997812" onmouseenter="enter('-1489567751755997812');" onmouseout="out('-1489567751755997812');" style=""> 488          if (targetMinSubTotal == null || targetMinSubTotal.lessThanOrEqual(Money.ZERO)) {                         </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 489              return true;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 490          }                                                                                                         </span>
<span class="7580465799834058252" onmouseenter="enter('7580465799834058252');" onmouseout="out('7580465799834058252');" style=""> 491          return orderMeetsProvidedSubtotalRequirement(offer, targetsMap, targetMinSubTotal);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 492      }                                                                                                             </span>
<span  style=""> 493                                                                                                                    </span>
<span class="8829500236577947895" onmouseenter="enter('8829500236577947895');" onmouseout="out('8829500236577947895');" style=""><abbr title=" 494      protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; promotableOrderItems, Money minSubTotal) {"> 494      protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotablðŸ”µ</abbr></span>
<span class="-6106353390255483233" onmouseenter="enter('-6106353390255483233');" onmouseout="out('-6106353390255483233');" style=""> 495          Money subtotal = Money.ZERO;                                                                              </span>
<span  style=""> 496                                                                                                                    </span>
<span class="1373302773933084970" onmouseenter="enter('1373302773933084970');" onmouseout="out('1373302773933084970');" style=""> 497          for (OfferItemCriteria itemCriteria : promotableOrderItems.keySet()) {                                    </span>
<span class="-419579307951366052" onmouseenter="enter('-419579307951366052');" onmouseout="out('-419579307951366052');" style=""> 498              List&lt;PromotableOrderItem&gt; promotableItems = promotableOrderItems.get(itemCriteria);                   </span>
<span  style=""> 499                                                                                                                    </span>
<span class="-1903041170653165047" onmouseenter="enter('-1903041170653165047');" onmouseout="out('-1903041170653165047');" style=""> 500              for (PromotableOrderItem item : promotableItems) {                                                    </span>
<span class="7600253327963384600" onmouseenter="enter('7600253327963384600');" onmouseout="out('7600253327963384600');" style=""> 501                  boolean shouldApplyDiscountToSalePrice = offer.getApplyDiscountToSalePrice();                     </span>
<span class="779941574682415153" onmouseenter="enter('779941574682415153');" onmouseout="out('779941574682415153');" style=""> 502                  Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrice);    </span>
<span class="215414280986961901" onmouseenter="enter('215414280986961901');" onmouseout="out('215414280986961901');" style=""> 503                  int quantity = item.getQuantity();                                                                </span>
<span  style=""> 504                                                                                                                    </span>
<span class="-2934463286963984250" onmouseenter="enter('-2934463286963984250');" onmouseout="out('-2934463286963984250');" style=""> 505                  Money lineItemAmount = priceBeforeAdjustments.multiply(quantity);                                 </span>
<span class="-3511635498964788361" onmouseenter="enter('-3511635498964788361');" onmouseout="out('-3511635498964788361');" style=""> 506                  subtotal = subtotal.add(lineItemAmount);                                                          </span>
<span class="-2129121979744538843" onmouseenter="enter('-2129121979744538843');" onmouseout="out('-2129121979744538843');" style=""> 507                  if (subtotal.greaterThanOrEqual(minSubTotal)) {                                                   </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 508                      return true;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 509                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 510              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 511          }                                                                                                         </span>
<span  style=""> 512                                                                                                                    </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 513          return false;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 514      }                                                                                                             </span>
<span  style=""> 515                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 516      @Override                                                                                                     </span>
<span class="6911813483912566048" onmouseenter="enter('6911813483912566048');" onmouseout="out('6911813483912566048');" style=""> 517      public boolean orderMeetsSubtotalRequirements(PromotableOrder order, Offer offer) {                           </span>
<span class="8114201548143186402" onmouseenter="enter('8114201548143186402');" onmouseout="out('8114201548143186402');" style=""> 518          Money orderMinSubTotal = offer.getOrderMinSubTotal();                                                     </span>
<span class="5846170175083841610" onmouseenter="enter('5846170175083841610');" onmouseout="out('5846170175083841610');" style=""> 519          return orderMinSubTotal == null                                                                           </span>
<span class="774150812299602505" onmouseenter="enter('774150812299602505');" onmouseout="out('774150812299602505');" style=""> 520                  || orderMinSubTotal.lessThanOrEqual(Money.ZERO)                                                   </span>
<span class="722443493012604709" onmouseenter="enter('722443493012604709');" onmouseout="out('722443493012604709');" style=""> 521                  || orderMinSubTotal.lessThanOrEqual(order.getOrder().getSubTotal());                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 522      }                                                                                                             </span>
<span  style=""> 523                                                                                                                    </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 524      public PromotableItemFactory getPromotableItemFactory() {                                                     </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 525          return promotableItemFactory;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 526      }                                                                                                             </span>
<span  style=""> 527                                                                                                                    </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 528      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                           </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 529          this.promotableItemFactory = promotableItemFactory;                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 530      }                                                                                                             </span>
<span  style=""> 531                                                                                                                    </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 532      public OfferDao getOfferDao() {                                                                               </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 533          return offerDao;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 534      }                                                                                                             </span>
<span  style=""> 535                                                                                                                    </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 536      public void setOfferDao(OfferDao offerDao) {                                                                  </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 537          this.offerDao = offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 538      }                                                                                                             </span>
<span  style=""> 539                                                                                                                    </span>
<span class="1819436800301003916" onmouseenter="enter('1819436800301003916');" onmouseout="out('1819436800301003916');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 540 +    public GenericEntityService getGenericEntityService() {                                                       </span>
<span class="7308888892573915137" onmouseenter="enter('7308888892573915137');" onmouseout="out('7308888892573915137');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 541 +        return entityService;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 542 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 543 +                                                                                                                  </span>
<span class="-2936727373443336006" onmouseenter="enter('-2936727373443336006');" onmouseout="out('-2936727373443336006');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 544 +    public void setGenericEntityService(GenericEntityService entityService) {                                     </span>
<span class="8545056668351819980" onmouseenter="enter('8545056668351819980');" onmouseout="out('8545056668351819980');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 545 +        this.entityService = entityService;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 546 +    }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 547  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            