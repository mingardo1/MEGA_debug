<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>191</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    191
                    <a href="190.html">prev</a>
                    <a href="192.html">next</a>
                    <a href="191_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_89e275c67fd74f0edf3ff03711c8c7a4a9610791_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceUtilitiesImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceUtilitiesImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceUtilitiesImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceUtilitiesImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;a48cd6ca647e4a58cde4097171bd233ed3e8511d:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceUtilitiesImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b]], subset: [[b], [b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service;
  19 
  20 import org.apache.commons.logging.Log;
  21 import org.apache.commons.logging.LogFactory;
  22 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  23 import org.broadleafcommerce.common.money.Money;
  24 import org.broadleafcommerce.common.service.GenericEntityService;
  25 import org.broadleafcommerce.core.offer.dao.OfferDao;
  26 import org.broadleafcommerce.core.offer.domain.Offer;
  27 import org.broadleafcommerce.core.offer.domain.OfferItemCriteria;
  28 import org.broadleafcommerce.core.offer.domain.OfferPriceData;
  29 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  30 import org.broadleafcommerce.core.offer.service.discount.PromotionDiscount;
  31 import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;
  32 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  33 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  34 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;
  35 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  36 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  37 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;
  38 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;
  39 import org.broadleafcommerce.core.offer.service.processor.ItemOfferMarkTargets;
  40 import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;
  41 import org.broadleafcommerce.core.order.domain.Order;
  42 import org.broadleafcommerce.core.order.domain.OrderItem;
  43 import org.broadleafcommerce.core.order.domain.OrderItemContainer;
  44 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  45 import org.broadleafcommerce.core.order.domain.OrderItemQualifier;
  46 import org.broadleafcommerce.core.order.domain.dto.OrderItemHolder;
  47 import org.springframework.stereotype.Service;
  48 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  49 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import java.util.Collections;</span>
  52 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54 import java.math.BigDecimal;</span>
  55 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  56 import java.util.ArrayList;
  57 import java.util.Collections;
  58 import java.util.Comparator;
  59 import java.util.HashMap;
  60 import java.util.Iterator;
  61 import java.util.List;
  62 import java.util.Map;
  63 import javax.annotation.Resource;
  64 
  65 /**
  66  * 
  67  * @author bpolster
  68  *
  69  */
  70 @Service(&quot;blOfferServiceUtilities&quot;)
  71 public class OfferServiceUtilitiesImpl implements OfferServiceUtilities {
  72     protected static final Log LOG = LogFactory.getLog(OfferServiceUtilitiesImpl.class);
  73 
  74     @Resource(name = &quot;blPromotableItemFactory&quot;)
  75     protected PromotableItemFactory promotableItemFactory;
  76 
  77     @Resource(name = &quot;blOfferDao&quot;)
  78     protected OfferDao offerDao;
  79 
  80     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
  81     protected OfferServiceExtensionManager extensionManager;
  82 
  83 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84     protected final PromotableOfferUtility promotableOfferUtility;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86     public OfferServiceUtilitiesImpl(PromotableOfferUtility promotableOfferUtility) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87         this.promotableOfferUtility = promotableOfferUtility;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88     }</span>
  89 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  91     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  91     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92         Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94 </span>
  95 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96     @Resource(name = &quot;blGenericEntityService&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97     protected GenericEntityService entityService;</span>
  98 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  99 
 100     @Override
<abbr title=" 101     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {"> 101     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applðŸ”µ</abbr>
 102         Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));
 103     }
 104 
 105     @Override
<abbr title=" 106     public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {"> 106     public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean aðŸ”µ</abbr>
 107         Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));
 108     }
 109 
<abbr title=" 110     protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyToSalePrice) {"> 110     protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyTðŸ”µ</abbr>
 111         return new Comparator&lt;PromotableOrderItemPriceDetail&gt;() {
 112 
 113             @Override
 114             public int compare(PromotableOrderItemPriceDetail o1, PromotableOrderItemPriceDetail o2) {
 115                 Money price = o1.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);
 116                 Money price2 = o2.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);
 117 
 118                 // highest amount first
 119                 return price2.compareTo(price);
 120             }
 121         };
 122     }
 123 
 124     @Override
 125     public OrderItem findRelatedQualifierRoot(OrderItem relatedQualifier) {
 126         OrderItem relatedQualifierRoot = null;
 127         if (relatedQualifier != null) {
 128             relatedQualifierRoot = relatedQualifier;
 129             while (relatedQualifierRoot.getParentOrderItem() != null) {
 130                 relatedQualifierRoot = relatedQualifierRoot.getParentOrderItem();
 131             }
 132         }
 133         return relatedQualifierRoot;
 134     }
 135 
 136     @Override
<abbr title=" 137     public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; details) {"> 137     public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemðŸ”µ</abbr>
 138 
 139         for (PromotableOrderItemPriceDetail detail : details) {
<abbr title=" 140             for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustments()) {"> 140             for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustmentsðŸ”µ</abbr>
 141                 if (adjustment.isTotalitarian() || itemOffer.getOffer().isTotalitarianOffer()) {
 142                     // A totalitarian offer has already been applied or this offer is totalitarian
 143                     // and another offer was already applied.
 144                     return false;
<abbr title=" 145                 } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 145                 } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOfferðŸ”µ</abbr>
 146                     // A nonCombinable offer has been applied or this is a non-combinable offer
 147                     // and adjustments have already been applied.
 148                     return false;
 149                 }
 150             }
 151         }
 152         return true;
 153     }
 154 
 155     @Override
<abbr title=" 156     public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCriteria,"> 156     public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCrðŸ”µ</abbr>
 157             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {
 158 
 159         sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());
 160 
 161         // Calculate the number of qualifiers needed that will not receive the promotion.  
 162         // These will be reserved first before the target is assigned.
 163         int qualifierQtyNeeded = itemCriteria.getQuantity();
 164 
 165         for (PromotableOrderItemPriceDetail detail : priceDetails) {
 166 
 167             // Mark Qualifiers
 168             if (qualifierQtyNeeded &gt; 0) {
<abbr title=" 169                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 169                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(ðŸ”µ</abbr>
 170                 if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {
<abbr title=" 171                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);"> 171                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQuaðŸ”µ</abbr>
 172                     qualifierQtyNeeded -= qtyToMarkAsQualifier;
 173                     detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);
 174                 }
 175             }
 176 
 177             if (qualifierQtyNeeded == 0) {
 178                 break;
 179             }
 180         }
 181         return qualifierQtyNeeded;
 182     }
 183 
 184     @Override
 185     public int markTargetsForCriteria(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,
<abbr title=" 186             boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriteria,"> 186             boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriðŸ”µ</abbr>
 187             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, int targetQtyNeeded) {
 188         for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {
 189             if (relatedQualifier != null) {
<abbr title=" 190                 // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 190                 // We need to make sure that this item is either a parent, child, or the same as the qualðŸ”µ</abbr>
 191                 OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();
<abbr title=" 192                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;"> 192                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierðŸ”µ</abbr>
 193                         !thisItem.equals(relatedQualifierRoot)) {
 194                     continue;
 195                 }
 196             }
 197 
<abbr title=" 198             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);"> 198             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOðŸ”µ</abbr>
 199             if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {
<abbr title=" 200                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 200                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOðŸ”µ</abbr>
 201                     int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget);
 202                     targetQtyNeeded -= qtyToMarkAsTarget;
 203                     if (!checkOnly) {
 204                         priceDetail.addPromotionDiscount(itemOffer, itemCriteria, qtyToMarkAsTarget);
 205                     }
 206                 }
 207             }
 208 
 209             if (targetQtyNeeded == 0) {
 210                 break;
 211             }
 212         }
 213         return targetQtyNeeded;
 214     }
 215 
 216     @Override
<abbr title=" 217     public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,"> 217     public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedðŸ”µ</abbr>
<abbr title=" 218                                                 boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferPriceData offerPriceData,"> 218                                                 boolean checkOnly, Offer promotion, OrderItem relatedQualðŸ”µ</abbr>
 219                                                 List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {
 220         int targetQtyNeeded = offerPriceData.getQuantity();
 221         int minRequiredTargetQuantity = itemOffer.getMinimumRequiredTargetQuantity();
 222         if (minRequiredTargetQuantity &gt; 1 &amp;&amp; minRequiredTargetQuantity &gt; targetQtyNeeded) {
 223             targetQtyNeeded = minRequiredTargetQuantity;
 224         }
 225 
 226         for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {
 227             if (relatedQualifier != null) {
<abbr title=" 228                 // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 228                 // We need to make sure that this item is either a parent, child, or the same as the qualðŸ”µ</abbr>
 229                 OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();
<abbr title=" 230                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;"> 230                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierðŸ”µ</abbr>
 231                         !thisItem.equals(relatedQualifierRoot)) {
 232                     continue;
 233                 }
 234             }
 235 
<abbr title=" 236             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);"> 236             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOðŸ”µ</abbr>
 237             if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {
<abbr title=" 238                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 238                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOðŸ”µ</abbr>
 239                     int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget);
 240                     targetQtyNeeded -= qtyToMarkAsTarget;
 241                     if (!checkOnly) {
 242                         priceDetail.addPromotionDiscount(itemOffer, null, qtyToMarkAsTarget);
 243                     }
 244                 }
 245             }
 246 
 247             if (targetQtyNeeded == 0) {
 248                 break;
 249             }
 250         }
 251         return targetQtyNeeded == 0;
 252     }
 253 
 254     @Override
<abbr title=" 255     public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, PromotableOrder order,"> 255     public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, ProðŸ”µ</abbr>
 256             OrderItemHolder orderItemHolder, OfferItemCriteria itemCriteria,
<abbr title=" 257             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets) {"> 257             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets)ðŸ”µ</abbr>
 258         sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());
 259 
 260         // Calculate the number of qualifiers needed that will not receive the promotion.  
 261         // These will be reserved first before the target is assigned.
 262         int qualifierQtyNeeded = itemCriteria.getQuantity();
 263 
 264         for (PromotableOrderItemPriceDetail detail : priceDetails) {
 265             OrderItem oi = detail.getPromotableOrderItem().getOrderItem();
 266 
 267             if (qualifierQtyNeeded &gt; 0) {
<abbr title=" 268                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 268                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(ðŸ”µ</abbr>
 269                 if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {
<abbr title=" 270                     // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some state that we "> 270                     // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some sðŸ”µ</abbr>
 271                     // might need in the future.
 272                     OfferItemCriteria previousQualifierCriteria = null;
 273                     for (PromotionQualifier possibleQualifier : detail.getPromotionQualifiers()) {
 274                         if (possibleQualifier.getPromotion().equals(itemOffer.getOffer())) {
 275                             previousQualifierCriteria = possibleQualifier.getItemCriteria();
 276                             break;
 277                         }
 278                     }
 279 
 280                     // Go ahead and mark this item as a qualifier
<abbr title=" 281                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);"> 281                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQuaðŸ”µ</abbr>
 282                     qualifierQtyNeeded -= qtyToMarkAsQualifier;
<abbr title=" 283                     PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);"> 283                     PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMaðŸ”µ</abbr>
<abbr title=" 284                     pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOffer().getApplyDiscountToSalePrice()));"> 284                     pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOfðŸ”µ</abbr>
 285 
<abbr title=" 286                     // Now, we need to see if there exists a target(s) that is suitable for this qualifier due to"> 286                     // Now, we need to see if there exists a target(s) that is suitable for this qualifieðŸ”µ</abbr>
<abbr title=" 287                     // the relationship flag. If we are on the last qualifier required for this offer, we want to "> 287                     // the relationship flag. If we are on the last qualifier required for this offer, weðŸ”µ</abbr>
<abbr title=" 288                     // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just want to check "> 288                     // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just wantðŸ”µ</abbr>
 289                     // that there is an eligible target(s) and continue on.
 290                     if (itemOfferMarkTargets.markTargets(itemOffer, order, oi, true)) {
<abbr title=" 291                         // We found a target. Let&#x27;s save this related order item used as the qualifier in case"> 291                         // We found a target. Let&#x27;s save this related order item used as the qualifier inðŸ”µ</abbr>
 292                         // we succeed
 293                         orderItemHolder.setOrderItem(oi);
 294                     } else {
<abbr title=" 295                         // If we didn&#x27;t find a target, we need to roll back how we marked this item as a qualifier."> 295                         // If we didn&#x27;t find a target, we need to roll back how we marked this item as a ðŸ”µ</abbr>
 296                         qualifierQtyNeeded += qtyToMarkAsQualifier;
 297                         if (pq.getQuantity() == qtyToMarkAsQualifier) {
 298                             detail.getPromotionQualifiers().remove(pq);
 299                         } else {
 300                             pq.setItemCriteria(previousQualifierCriteria);
 301                             pq.setQuantity(pq.getQuantity() - qtyToMarkAsQualifier);
 302                         }
 303                     }
 304                 }
 305             }
 306 
 307             if (qualifierQtyNeeded == 0) {
 308                 break;
 309             }
 310         }
 311         return qualifierQtyNeeded;
 312     }
 313 
 314     @Override
<abbr title=" 315     public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails) {"> 315     public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotabðŸ”µ</abbr>
 316         for (PromotableOrderItemPriceDetail itemPriceDetail : itemPriceDetails) {
 317             for (PromotionDiscount discount : itemPriceDetail.getPromotionDiscounts()) {
 318                 if (discount.getPromotion().equals(itemOffer.getOffer())) {
<abbr title=" 319                     if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 319                     if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWðŸ”µ</abbr>
 320                         // We&#x27;ve decided to apply this adjustment but if it doesn&#x27;t actually reduce
 321                         // the value of the item
 322                         if (adjustmentIsNotGoodEnoughToBeApplied(itemOffer, itemPriceDetail)) {
 323                             break;
 324                         }
 325 
 326                     }
 327                     OrderItem orderItem = itemPriceDetail.getPromotableOrderItem().getOrderItem();
 328                     Boolean offerCanApplyToChildOrderItems = itemOffer.getOffer().getApplyToChildItems();
 329                     if (isAddOnOrderItem(orderItem) &amp;&amp; !offerCanApplyToChildOrderItems) {
 330                         break;
 331                     }
 332                     applyOrderItemAdjustment(itemOffer, itemPriceDetail);
 333                     break;
 334                 }
 335             }
 336         }
 337     }
 338 
 339     @Override
 340     public boolean isAddOnOrderItem(OrderItem orderItem) {
 341         if (DiscreteOrderItem.class.isAssignableFrom(orderItem.getClass())) {
 342             DiscreteOrderItem discreteOrderItem = (DiscreteOrderItem) orderItem;
 343 
 344             Map&lt;String, String&gt; attributes = discreteOrderItem.getAdditionalAttributes();
 345             boolean isAddOnOrderItem = attributes.containsKey(&quot;addOnXrefId&quot;);
 346             boolean isChildOrderItem = discreteOrderItem.isChildOrderItem();
 347 
 348             return isChildOrderItem &amp;&amp; isAddOnOrderItem;
 349         }
 350         return false;
 351     }
 352 
 353     /**
 354      * The adjustment might not be better than the sale price.
 355      * @param itemOffer
 356      * @param detail
 357      * @return
 358      */
 359     protected boolean adjustmentIsNotGoodEnoughToBeApplied(PromotableCandidateItemOffer itemOffer,
 360             PromotableOrderItemPriceDetail detail) {
 361         if (!itemOffer.getOffer().getApplyDiscountToSalePrice()) {
 362             Money salePrice = detail.getPromotableOrderItem().getSalePriceBeforeAdjustments();
 363             Money retailPrice = detail.getPromotableOrderItem().getRetailPriceBeforeAdjustments();
<abbr title=" 364             Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromotableOrderItem(), 1);"> 364             Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromðŸ”µ</abbr>
 365             if (salePrice != null) {
 366                 if (salePrice.lessThan(retailPrice.subtract(savings))) {
 367                     // Not good enough
 368                     return true;
 369                 }
 370             }
 371         }
 372         return false;
 373     }
 374 
 375     @Override
 376     public void applyOrderItemAdjustment(PromotableCandidateItemOffer itemOffer,
 377             PromotableOrderItemPriceDetail itemPriceDetail) {
 378         PromotableOrderItemPriceDetailAdjustment promotableOrderItemPriceDetailAdjustment =
<abbr title=" 379                 promotableItemFactory.createPromotableOrderItemPriceDetailAdjustment(itemOffer, itemPriceDetail);"> 379                 promotableItemFactory.createPromotableOrderItemPriceDetailAdjustment(itemOffer, itemPriceðŸ”µ</abbr>
 380         //don&#x27;t want to have negative adjustments
<abbr title=" 381         if(promotableOrderItemPriceDetailAdjustment.getRetailAdjustmentValue().lessThan(BigDecimal.ZERO) ||"> 381         if(promotableOrderItemPriceDetailAdjustment.getRetailAdjustmentValue().lessThan(BigDecimal.ZERO) ðŸ”µ</abbr>
<abbr title=" 382                 promotableOrderItemPriceDetailAdjustment.getSaleAdjustmentValue().lessThan(BigDecimal.ZERO)){"> 382                 promotableOrderItemPriceDetailAdjustment.getSaleAdjustmentValue().lessThan(BigDecimal.ZERðŸ”µ</abbr>
 383             return;
 384         }
 385         itemPriceDetail.addCandidateItemPriceDetailAdjustment(promotableOrderItemPriceDetailAdjustment);
 386     }
 387 
 388     @Override
 389     public List&lt;OrderItem&gt; buildOrderItemList(Order order) {
 390         List&lt;OrderItem&gt; orderItemList = new ArrayList&lt;OrderItem&gt;();
 391         for (OrderItem currentItem : order.getOrderItems()) {
 392             if (currentItem instanceof OrderItemContainer) {
 393                 OrderItemContainer container = (OrderItemContainer) currentItem;
 394                 if (container.isPricingAtContainerLevel()) {
 395                     orderItemList.add(currentItem);
 396                 } else {
 397                     for (OrderItem containedItem : container.getOrderItems()) {
 398                         orderItemList.add(containedItem);
 399                     }
 400                 }
 401             } else {
 402                 orderItemList.add(currentItem);
 403             }
 404         }
 405 
 406         return orderItemList;
 407     }
 408 
 409     @Override
 410     public Map&lt;OrderItem, PromotableOrderItem&gt; buildPromotableItemMap(PromotableOrder promotableOrder) {
<abbr title=" 411         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderItem&gt;();"> 411         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderIteðŸ”µ</abbr>
 412         for (PromotableOrderItem item : promotableOrder.getAllOrderItems()) {
 413             promotableItemMap.put(item.getOrderItem(), item);
 414         }
 415         return promotableItemMap;
 416     }
 417 
 418     @Override
<abbr title=" 419     public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itemDetail) {"> 419     public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itðŸ”µ</abbr>
<abbr title=" 420         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 420         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetðŸ”µ</abbr>
 421         
<abbr title=" 422         List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 422         List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjuðŸ”µ</abbr>
<abbr title=" 423         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {"> 423         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments())ðŸ”µ</abbr>
 424             if (itemAdjustmentMap.containsKey(adjustment.getOffer().getId())) {
 425                 if (LOG.isDebugEnabled()) {
<abbr title=" 426                     StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with ids &quot;)"> 426                     StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with iðŸ”µ</abbr>
 427                         .append(itemAdjustmentMap.get(adjustment.getOffer().getId()).getId())
 428                         .append(&quot; and &quot;)
 429                         .append(adjustment.getId());
 430                     LOG.debug(sb.toString());
 431                 }
 432                 adjustmentsToRemove.add(adjustment);
 433             } else {
 434                 itemAdjustmentMap.put(adjustment.getOffer().getId(), adjustment);
 435             }
 436         }
 437         
 438         for (OrderItemPriceDetailAdjustment adjustment : adjustmentsToRemove) {
 439             itemDetail.getOrderItemPriceDetailAdjustments().remove(adjustment);
 440         }
 441         
 442         return itemAdjustmentMap;
 443     }
 444 
 445     @Override
 446     public void updatePriceDetail(OrderItemPriceDetail itemDetail,
 447             PromotableOrderItemPriceDetail promotableDetail) {
 448         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =
 449                 buildItemDetailAdjustmentMap(itemDetail);
 450 
 451         if (itemDetail.getQuantity() != promotableDetail.getQuantity()) {
 452             itemDetail.setQuantity(promotableDetail.getQuantity());
 453         }
 454 
 455         if (promotableDetail.isAdjustmentsFinalized()) {
 456             itemDetail.setUseSalePrice(promotableDetail.useSaleAdjustments());
 457         }
 458 
<abbr title=" 459         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjustments()) {"> 459         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjusðŸ”µ</abbr>
<abbr title=" 460             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferId());"> 460             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferIðŸ”µ</abbr>
 461             if (itemAdjustment != null) {
 462                 // Update existing adjustment
 463                 if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {
 464                     updateItemAdjustment(itemAdjustment, adjustment);
 465                 }
 466             } else {
 467                 // Add a new adjustment
 468                 final OrderItemPriceDetailAdjustment newItemAdjustment;
 469                 ExtensionResultHolder resultHolder = new ExtensionResultHolder();
 470 
 471                 if (extensionManager != null) {
 472                     extensionManager.createOrderItemPriceDetailAdjustment(resultHolder, itemDetail);
 473                 }
<abbr title=" 474                 if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetailAdjustment&quot;)) {"> 474                 if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetaiðŸ”µ</abbr>
<abbr title=" 475                     newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().get(&quot;OrderItemPriceDetailAdjustment&quot;);"> 475                     newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().getðŸ”µ</abbr>
 476                 } else {
 477                     newItemAdjustment = offerDao.createOrderItemPriceDetailAdjustment();
 478                 }
 479                 newItemAdjustment.init(itemDetail, adjustment.getOffer(), null);
 480                 updateItemAdjustment(newItemAdjustment, adjustment);
 481                 itemDetail.getOrderItemPriceDetailAdjustments().add(newItemAdjustment);
 482             }
 483         }
 484 
 485         if (itemAdjustmentMap.size() &gt; 0) {
 486             // Remove adjustments that were on the order item but no longer needed.
 487             List&lt;Long&gt; adjustmentIdsToRemove = new ArrayList&lt;Long&gt;();
 488             for (OrderItemPriceDetailAdjustment adjustmentToRemove : itemAdjustmentMap.values()) {
 489                 adjustmentIdsToRemove.add(adjustmentToRemove.getOffer().getId());
 490             }
 491 
<abbr title=" 492             Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustments().iterator();"> 492             Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustmðŸ”µ</abbr>
 493             while (iterator.hasNext()) {
 494                 OrderItemPriceDetailAdjustment adj = iterator.next();
 495                 if (adjustmentIdsToRemove.contains(adj.getOffer().getId())) {
 496                     iterator.remove();
 497                     entityService.remove(adj);
 498                 }
 499             }
 500         }
 501     }
 502 
 503     protected void updateItemAdjustment(OrderItemPriceDetailAdjustment itemAdjustment,
 504             PromotableOrderItemPriceDetailAdjustment promotableAdjustment) {
 505         itemAdjustment.setValue(promotableAdjustment.getAdjustmentValue());
 506         itemAdjustment.setSalesPriceValue(promotableAdjustment.getSaleAdjustmentValue());
 507         itemAdjustment.setRetailPriceValue(promotableAdjustment.getRetailAdjustmentValue());
 508         itemAdjustment.setAppliedToSalePrice(promotableAdjustment.isAppliedToSalePrice());
 509     }
 510 
 511     @Override
<abbr title=" 512     public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMap,"> 512     public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMapðŸ”µ</abbr>
 513             Iterator&lt;? extends OrderItemPriceDetail&gt; pdIterator) {
 514         while (pdIterator.hasNext()) {
 515             OrderItemPriceDetail currentDetail = pdIterator.next();
 516             if (unmatchedDetailsMap.containsKey(currentDetail.getId())) {
 517                 pdIterator.remove();
 518                 entityService.remove(currentDetail);
 519             }
 520         }
 521     }
 522 
 523     @Override
 524     public void removeUnmatchedQualifiers(Map&lt;Long, ? extends OrderItemQualifier&gt; unmatchedQualifiersMap,
 525             Iterator&lt;? extends OrderItemQualifier&gt; qIterator) {
 526         while (qIterator.hasNext()) {
 527             OrderItemQualifier currentQualifier = qIterator.next();
 528             if (unmatchedQualifiersMap.containsKey(currentQualifier.getId())) {
 529                 qIterator.remove();
 530                 entityService.remove(currentQualifier);
 531             }
 532         }
 533     }
 534 
 535     @Override
<abbr title=" 536     public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; qualifiersMap) {"> 536     public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OðŸ”µ</abbr>
 537         Money qualifyingItemSubTotal = offer.getQualifyingItemSubTotal();
 538         if (qualifyingItemSubTotal == null || qualifyingItemSubTotal.lessThanOrEqual(Money.ZERO)) {
 539             return true;
 540         }
 541         return orderMeetsProvidedSubtotalRequirement(offer, qualifiersMap, qualifyingItemSubTotal);
 542     }
 543 
 544     @Override
<abbr title=" 545     public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; targetsMap) {"> 545     public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferðŸ”µ</abbr>
 546         Money targetMinSubTotal = offer.getTargetMinSubTotal();
 547         if (targetMinSubTotal == null || targetMinSubTotal.lessThanOrEqual(Money.ZERO)) {
 548             return true;
 549         }
 550         return orderMeetsProvidedSubtotalRequirement(offer, targetsMap, targetMinSubTotal);
 551     }
 552 
<abbr title=" 553     protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; promotableOrderItems, Money minSubTotal) {"> 553     protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;ðŸ”µ</abbr>
 554         Money subtotal = Money.ZERO;
 555 
 556         for (OfferItemCriteria itemCriteria : promotableOrderItems.keySet()) {
 557             List&lt;PromotableOrderItem&gt; promotableItems = promotableOrderItems.get(itemCriteria);
 558 
 559             for (PromotableOrderItem item : promotableItems) {
 560                 boolean shouldApplyDiscountToSalePrice = offer.getApplyDiscountToSalePrice();
<abbr title=" 561                 Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrice);"> 561                 Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrðŸ”µ</abbr>
 562                 int quantity = item.getQuantity();
 563 
 564                 Money lineItemAmount = priceBeforeAdjustments.multiply(quantity);
 565                 subtotal = subtotal.add(lineItemAmount);
 566                 if (subtotal.greaterThanOrEqual(minSubTotal)) {
 567                     return true;
 568                 }
 569             }
 570         }
 571 
 572         return false;
 573     }
 574 
 575     @Override
 576     public boolean orderMeetsSubtotalRequirements(PromotableOrder order, Offer offer) {
 577         Money orderMinSubTotal = offer.getOrderMinSubTotal();
 578         return orderMinSubTotal == null
 579                 || orderMinSubTotal.lessThanOrEqual(Money.ZERO)
 580                 || orderMinSubTotal.lessThanOrEqual(order.getOrder().getSubTotal());
 581     }
 582 
 583     public PromotableItemFactory getPromotableItemFactory() {
 584         return promotableItemFactory;
 585     }
 586 
 587     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 588         this.promotableItemFactory = promotableItemFactory;
 589     }
 590 
 591     public OfferDao getOfferDao() {
 592         return offerDao;
 593     }
 594 
 595     public void setOfferDao(OfferDao offerDao) {
 596         this.offerDao = offerDao;
 597     }
 598 
 599     public GenericEntityService getGenericEntityService() {
 600         return entityService;
 601     }
 602 
 603     public void setGenericEntityService(GenericEntityService entityService) {
 604         this.entityService = entityService;
 605     }
 606 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service;
  19 
  20 import org.apache.commons.logging.Log;
  21 import org.apache.commons.logging.LogFactory;
  22 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  23 import org.broadleafcommerce.common.money.Money;
  24 import org.broadleafcommerce.common.service.GenericEntityService;
  25 import org.broadleafcommerce.core.offer.dao.OfferDao;
  26 import org.broadleafcommerce.core.offer.domain.Offer;
  27 import org.broadleafcommerce.core.offer.domain.OfferItemCriteria;
  28 import org.broadleafcommerce.core.offer.domain.OfferPriceData;
  29 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  30 import org.broadleafcommerce.core.offer.service.discount.PromotionDiscount;
  31 import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;
  32 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  33 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  34 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;
  35 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  36 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  37 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;
  38 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;
  39 import org.broadleafcommerce.core.offer.service.processor.ItemOfferMarkTargets;
  40 import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;
  41 import org.broadleafcommerce.core.order.domain.Order;
  42 import org.broadleafcommerce.core.order.domain.OrderItem;
  43 import org.broadleafcommerce.core.order.domain.OrderItemContainer;
  44 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  45 import org.broadleafcommerce.core.order.domain.OrderItemQualifier;
  46 import org.broadleafcommerce.core.order.domain.dto.OrderItemHolder;
  47 import org.springframework.stereotype.Service;
  48 
  49 import java.math.BigDecimal;
  50 import java.util.ArrayList;
  51 import java.util.Collections;
  52 import java.util.Comparator;
  53 import java.util.HashMap;
  54 import java.util.Iterator;
  55 import java.util.List;
  56 import java.util.Map;
  57 import javax.annotation.Resource;
  58 
  59 /**
  60  *
  61  * @author bpolster
  62  *
  63  */
  64 @Service(&quot;blOfferServiceUtilities&quot;)
  65 public class OfferServiceUtilitiesImpl implements OfferServiceUtilities {
  66     protected static final Log LOG = LogFactory.getLog(OfferServiceUtilitiesImpl.class);
  67 
  68     @Resource(name = &quot;blPromotableItemFactory&quot;)
  69     protected PromotableItemFactory promotableItemFactory;
  70 
  71     @Resource(name = &quot;blOfferDao&quot;)
  72     protected OfferDao offerDao;
  73 
  74     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
  75     protected OfferServiceExtensionManager extensionManager;
  76 
  77     protected final PromotableOfferUtility promotableOfferUtility;
  78 
  79     public OfferServiceUtilitiesImpl(PromotableOfferUtility promotableOfferUtility) {
  80         this.promotableOfferUtility = promotableOfferUtility;
  81     }
  82 
  83     @Resource(name = &quot;blGenericEntityService&quot;)
  84     protected GenericEntityService entityService;
  85 
  86     @Override
<abbr title="  87     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  87     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applðŸ”µ</abbr>
  88         Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));
  89     }
  90 
  91     @Override
<abbr title="  92     public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  92     public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean aðŸ”µ</abbr>
  93         Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));
  94     }
  95 
<abbr title="  96     protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyToSalePrice) {">  96     protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyTðŸ”µ</abbr>
  97         return new Comparator&lt;PromotableOrderItemPriceDetail&gt;() {
  98 
  99             @Override
 100             public int compare(PromotableOrderItemPriceDetail o1, PromotableOrderItemPriceDetail o2) {
 101                 Money price = o1.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);
 102                 Money price2 = o2.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);
 103 
 104                 // highest amount first
 105                 return price2.compareTo(price);
 106             }
 107         };
 108     }
 109 
 110     @Override
 111     public OrderItem findRelatedQualifierRoot(OrderItem relatedQualifier) {
 112         OrderItem relatedQualifierRoot = null;
 113         if (relatedQualifier != null) {
 114             relatedQualifierRoot = relatedQualifier;
 115             while (relatedQualifierRoot.getParentOrderItem() != null) {
 116                 relatedQualifierRoot = relatedQualifierRoot.getParentOrderItem();
 117             }
 118         }
 119         return relatedQualifierRoot;
 120     }
 121 
 122     @Override
<abbr title=" 123     public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; details) {"> 123     public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemðŸ”µ</abbr>
 124 
 125         for (PromotableOrderItemPriceDetail detail : details) {
<abbr title=" 126             for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustments()) {"> 126             for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustmentsðŸ”µ</abbr>
 127                 if (adjustment.isTotalitarian() || itemOffer.getOffer().isTotalitarianOffer()) {
 128                     // A totalitarian offer has already been applied or this offer is totalitarian
 129                     // and another offer was already applied.
 130                     return false;
<abbr title=" 131                 } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 131                 } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOfferðŸ”µ</abbr>
 132                     // A nonCombinable offer has been applied or this is a non-combinable offer
 133                     // and adjustments have already been applied.
 134                     return false;
 135                 }
 136             }
 137         }
 138         return true;
 139     }
 140 
 141     @Override
<abbr title=" 142     public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCriteria,"> 142     public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCrðŸ”µ</abbr>
 143             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {
 144 
 145         sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());
 146 
 147         // Calculate the number of qualifiers needed that will not receive the promotion.
 148         // These will be reserved first before the target is assigned.
 149         int qualifierQtyNeeded = itemCriteria.getQuantity();
 150 
 151         for (PromotableOrderItemPriceDetail detail : priceDetails) {
 152 
 153             // Mark Qualifiers
 154             if (qualifierQtyNeeded &gt; 0) {
<abbr title=" 155                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 155                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(ðŸ”µ</abbr>
 156                 if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {
<abbr title=" 157                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);"> 157                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQuaðŸ”µ</abbr>
 158                     qualifierQtyNeeded -= qtyToMarkAsQualifier;
 159                     detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);
 160                 }
 161             }
 162 
 163             if (qualifierQtyNeeded == 0) {
 164                 break;
 165             }
 166         }
 167         return qualifierQtyNeeded;
 168     }
 169 
 170     @Override
 171     public int markTargetsForCriteria(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,
<abbr title=" 172             boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriteria,"> 172             boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriðŸ”µ</abbr>
 173             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, int targetQtyNeeded) {
 174         for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {
 175             if (relatedQualifier != null) {
<abbr title=" 176                 // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 176                 // We need to make sure that this item is either a parent, child, or the same as the qualðŸ”µ</abbr>
 177                 OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();
<abbr title=" 178                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;"> 178                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierðŸ”µ</abbr>
 179                         !thisItem.equals(relatedQualifierRoot)) {
 180                     continue;
 181                 }
 182             }
 183 
<abbr title=" 184             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);"> 184             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOðŸ”µ</abbr>
 185             if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {
<abbr title=" 186                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 186                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOðŸ”µ</abbr>
 187                     int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget);
 188                     targetQtyNeeded -= qtyToMarkAsTarget;
 189                     if (!checkOnly) {
 190                         priceDetail.addPromotionDiscount(itemOffer, itemCriteria, qtyToMarkAsTarget);
 191                     }
 192                 }
 193             }
 194 
 195             if (targetQtyNeeded == 0) {
 196                 break;
 197             }
 198         }
 199         return targetQtyNeeded;
 200     }
 201 
 202     @Override
<abbr title=" 203     public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,"> 203     public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedðŸ”µ</abbr>
<abbr title=" 204                                                 boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferPriceData offerPriceData,"> 204                                                 boolean checkOnly, Offer promotion, OrderItem relatedQualðŸ”µ</abbr>
 205                                                 List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {
 206         int targetQtyNeeded = offerPriceData.getQuantity();
 207         int minRequiredTargetQuantity = itemOffer.getMinimumRequiredTargetQuantity();
 208         if (minRequiredTargetQuantity &gt; 1 &amp;&amp; minRequiredTargetQuantity &gt; targetQtyNeeded) {
 209             targetQtyNeeded = minRequiredTargetQuantity;
 210         }
 211 
 212         for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {
 213             if (relatedQualifier != null) {
<abbr title=" 214                 // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 214                 // We need to make sure that this item is either a parent, child, or the same as the qualðŸ”µ</abbr>
 215                 OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();
<abbr title=" 216                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;"> 216                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierðŸ”µ</abbr>
 217                         !thisItem.equals(relatedQualifierRoot)) {
 218                     continue;
 219                 }
 220             }
 221 
<abbr title=" 222             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);"> 222             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOðŸ”µ</abbr>
 223             if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {
<abbr title=" 224                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 224                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOðŸ”µ</abbr>
 225                     int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget);
 226                     targetQtyNeeded -= qtyToMarkAsTarget;
 227                     if (!checkOnly) {
 228                         priceDetail.addPromotionDiscount(itemOffer, null, qtyToMarkAsTarget);
 229                     }
 230                 }
 231             }
 232 
 233             if (targetQtyNeeded == 0) {
 234                 break;
 235             }
 236         }
 237         return targetQtyNeeded == 0;
 238     }
 239 
 240     @Override
<abbr title=" 241     public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, PromotableOrder order,"> 241     public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, ProðŸ”µ</abbr>
 242             OrderItemHolder orderItemHolder, OfferItemCriteria itemCriteria,
<abbr title=" 243             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets) {"> 243             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets)ðŸ”µ</abbr>
 244         sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());
 245 
 246         // Calculate the number of qualifiers needed that will not receive the promotion.
 247         // These will be reserved first before the target is assigned.
 248         int qualifierQtyNeeded = itemCriteria.getQuantity();
 249 
 250         for (PromotableOrderItemPriceDetail detail : priceDetails) {
 251             OrderItem oi = detail.getPromotableOrderItem().getOrderItem();
 252 
 253             if (qualifierQtyNeeded &gt; 0) {
<abbr title=" 254                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 254                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(ðŸ”µ</abbr>
 255                 if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {
<abbr title=" 256                     // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some state that we"> 256                     // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some sðŸ”µ</abbr>
 257                     // might need in the future.
 258                     OfferItemCriteria previousQualifierCriteria = null;
 259                     for (PromotionQualifier possibleQualifier : detail.getPromotionQualifiers()) {
 260                         if (possibleQualifier.getPromotion().equals(itemOffer.getOffer())) {
 261                             previousQualifierCriteria = possibleQualifier.getItemCriteria();
 262                             break;
 263                         }
 264                     }
 265 
 266                     // Go ahead and mark this item as a qualifier
<abbr title=" 267                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);"> 267                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQuaðŸ”µ</abbr>
 268                     qualifierQtyNeeded -= qtyToMarkAsQualifier;
<abbr title=" 269                     PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);"> 269                     PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMaðŸ”µ</abbr>
<abbr title=" 270                     pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOffer().getApplyDiscountToSalePrice()));"> 270                     pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOfðŸ”µ</abbr>
 271 
<abbr title=" 272                     // Now, we need to see if there exists a target(s) that is suitable for this qualifier due to"> 272                     // Now, we need to see if there exists a target(s) that is suitable for this qualifieðŸ”µ</abbr>
<abbr title=" 273                     // the relationship flag. If we are on the last qualifier required for this offer, we want to"> 273                     // the relationship flag. If we are on the last qualifier required for this offer, weðŸ”µ</abbr>
<abbr title=" 274                     // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just want to check"> 274                     // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just wantðŸ”µ</abbr>
 275                     // that there is an eligible target(s) and continue on.
 276                     if (itemOfferMarkTargets.markTargets(itemOffer, order, oi, true)) {
<abbr title=" 277                         // We found a target. Let&#x27;s save this related order item used as the qualifier in case"> 277                         // We found a target. Let&#x27;s save this related order item used as the qualifier inðŸ”µ</abbr>
 278                         // we succeed
 279                         orderItemHolder.setOrderItem(oi);
 280                     } else {
<abbr title=" 281                         // If we didn&#x27;t find a target, we need to roll back how we marked this item as a qualifier."> 281                         // If we didn&#x27;t find a target, we need to roll back how we marked this item as a ðŸ”µ</abbr>
 282                         qualifierQtyNeeded += qtyToMarkAsQualifier;
 283                         if (pq.getQuantity() == qtyToMarkAsQualifier) {
 284                             detail.getPromotionQualifiers().remove(pq);
 285                         } else {
 286                             pq.setItemCriteria(previousQualifierCriteria);
 287                             pq.setQuantity(pq.getQuantity() - qtyToMarkAsQualifier);
 288                         }
 289                     }
 290                 }
 291             }
 292 
 293             if (qualifierQtyNeeded == 0) {
 294                 break;
 295             }
 296         }
 297         return qualifierQtyNeeded;
 298     }
 299 
 300     @Override
<abbr title=" 301     public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails) {"> 301     public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotabðŸ”µ</abbr>
 302         for (PromotableOrderItemPriceDetail itemPriceDetail : itemPriceDetails) {
 303             for (PromotionDiscount discount : itemPriceDetail.getPromotionDiscounts()) {
 304                 if (discount.getPromotion().equals(itemOffer.getOffer())) {
<abbr title=" 305                     if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 305                     if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWðŸ”µ</abbr>
 306                         // We&#x27;ve decided to apply this adjustment but if it doesn&#x27;t actually reduce
 307                         // the value of the item
 308                         if (adjustmentIsNotGoodEnoughToBeApplied(itemOffer, itemPriceDetail)) {
 309                             break;
 310                         }
 311 
 312                     }
 313                     OrderItem orderItem = itemPriceDetail.getPromotableOrderItem().getOrderItem();
 314                     Boolean offerCanApplyToChildOrderItems = itemOffer.getOffer().getApplyToChildItems();
 315                     if (isAddOnOrderItem(orderItem) &amp;&amp; !offerCanApplyToChildOrderItems) {
 316                         break;
 317                     }
 318                     applyOrderItemAdjustment(itemOffer, itemPriceDetail);
 319                     break;
 320                 }
 321             }
 322         }
 323     }
 324 
 325     @Override
 326     public boolean isAddOnOrderItem(OrderItem orderItem) {
 327         if (DiscreteOrderItem.class.isAssignableFrom(orderItem.getClass())) {
 328             DiscreteOrderItem discreteOrderItem = (DiscreteOrderItem) orderItem;
 329 
 330             Map&lt;String, String&gt; attributes = discreteOrderItem.getAdditionalAttributes();
 331             boolean isAddOnOrderItem = attributes.containsKey(&quot;addOnXrefId&quot;);
 332             boolean isChildOrderItem = discreteOrderItem.isChildOrderItem();
 333 
 334             return isChildOrderItem &amp;&amp; isAddOnOrderItem;
 335         }
 336         return false;
 337     }
 338 
 339     /**
 340      * The adjustment might not be better than the sale price.
 341      * @param itemOffer
 342      * @param detail
 343      * @return
 344      */
 345     protected boolean adjustmentIsNotGoodEnoughToBeApplied(PromotableCandidateItemOffer itemOffer,
 346             PromotableOrderItemPriceDetail detail) {
 347         if (!itemOffer.getOffer().getApplyDiscountToSalePrice()) {
 348             Money salePrice = detail.getPromotableOrderItem().getSalePriceBeforeAdjustments();
 349             Money retailPrice = detail.getPromotableOrderItem().getRetailPriceBeforeAdjustments();
<abbr title=" 350             Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromotableOrderItem(), 1);"> 350             Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromðŸ”µ</abbr>
 351             if (salePrice != null) {
 352                 if (salePrice.lessThan(retailPrice.subtract(savings))) {
 353                     // Not good enough
 354                     return true;
 355                 }
 356             }
 357         }
 358         return false;
 359     }
 360 
 361     @Override
 362     public void applyOrderItemAdjustment(PromotableCandidateItemOffer itemOffer,
 363             PromotableOrderItemPriceDetail itemPriceDetail) {
 364         PromotableOrderItemPriceDetailAdjustment promotableOrderItemPriceDetailAdjustment =
<abbr title=" 365                 promotableItemFactory.createPromotableOrderItemPriceDetailAdjustment(itemOffer, itemPriceDetail);"> 365                 promotableItemFactory.createPromotableOrderItemPriceDetailAdjustment(itemOffer, itemPriceðŸ”µ</abbr>
 366         //don&#x27;t want to have negative adjustments
<abbr title=" 367         if(promotableOrderItemPriceDetailAdjustment.getRetailAdjustmentValue().lessThan(BigDecimal.ZERO) ||"> 367         if(promotableOrderItemPriceDetailAdjustment.getRetailAdjustmentValue().lessThan(BigDecimal.ZERO) ðŸ”µ</abbr>
<abbr title=" 368                 promotableOrderItemPriceDetailAdjustment.getSaleAdjustmentValue().lessThan(BigDecimal.ZERO)){"> 368                 promotableOrderItemPriceDetailAdjustment.getSaleAdjustmentValue().lessThan(BigDecimal.ZERðŸ”µ</abbr>
 369             return;
 370         }
 371         itemPriceDetail.addCandidateItemPriceDetailAdjustment(promotableOrderItemPriceDetailAdjustment);
 372     }
 373 
 374     @Override
 375     public List&lt;OrderItem&gt; buildOrderItemList(Order order) {
 376         List&lt;OrderItem&gt; orderItemList = new ArrayList&lt;OrderItem&gt;();
 377         for (OrderItem currentItem : order.getOrderItems()) {
 378             if (currentItem instanceof OrderItemContainer) {
 379                 OrderItemContainer container = (OrderItemContainer) currentItem;
 380                 if (container.isPricingAtContainerLevel()) {
 381                     orderItemList.add(currentItem);
 382                 } else {
 383                     for (OrderItem containedItem : container.getOrderItems()) {
 384                         orderItemList.add(containedItem);
 385                     }
 386                 }
 387             } else {
 388                 orderItemList.add(currentItem);
 389             }
 390         }
 391 
 392         return orderItemList;
 393     }
 394 
 395     @Override
 396     public Map&lt;OrderItem, PromotableOrderItem&gt; buildPromotableItemMap(PromotableOrder promotableOrder) {
<abbr title=" 397         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderItem&gt;();"> 397         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderIteðŸ”µ</abbr>
 398         for (PromotableOrderItem item : promotableOrder.getAllOrderItems()) {
 399             promotableItemMap.put(item.getOrderItem(), item);
 400         }
 401         return promotableItemMap;
 402     }
 403 
 404     @Override
<abbr title=" 405     public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itemDetail) {"> 405     public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itðŸ”µ</abbr>
<abbr title=" 406         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 406         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetðŸ”µ</abbr>
 407 
<abbr title=" 408         List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 408         List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjuðŸ”µ</abbr>
<abbr title=" 409         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {"> 409         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments())ðŸ”µ</abbr>
 410             if (itemAdjustmentMap.containsKey(adjustment.getOffer().getId())) {
 411                 if (LOG.isDebugEnabled()) {
<abbr title=" 412                     StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with ids &quot;)"> 412                     StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with iðŸ”µ</abbr>
 413                         .append(itemAdjustmentMap.get(adjustment.getOffer().getId()).getId())
 414                         .append(&quot; and &quot;)
 415                         .append(adjustment.getId());
 416                     LOG.debug(sb.toString());
 417                 }
 418                 adjustmentsToRemove.add(adjustment);
 419             } else {
 420                 itemAdjustmentMap.put(adjustment.getOffer().getId(), adjustment);
 421             }
 422         }
 423 
 424         for (OrderItemPriceDetailAdjustment adjustment : adjustmentsToRemove) {
 425             itemDetail.getOrderItemPriceDetailAdjustments().remove(adjustment);
 426         }
 427 
 428         return itemAdjustmentMap;
 429     }
 430 
 431     @Override
 432     public void updatePriceDetail(OrderItemPriceDetail itemDetail,
 433             PromotableOrderItemPriceDetail promotableDetail) {
 434         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =
 435                 buildItemDetailAdjustmentMap(itemDetail);
 436 
 437         if (itemDetail.getQuantity() != promotableDetail.getQuantity()) {
 438             itemDetail.setQuantity(promotableDetail.getQuantity());
 439         }
 440 
 441         if (promotableDetail.isAdjustmentsFinalized()) {
 442             itemDetail.setUseSalePrice(promotableDetail.useSaleAdjustments());
 443         }
 444 
<abbr title=" 445         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjustments()) {"> 445         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjusðŸ”µ</abbr>
<abbr title=" 446             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferId());"> 446             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferIðŸ”µ</abbr>
 447             if (itemAdjustment != null) {
 448                 // Update existing adjustment
 449                 if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {
 450                     updateItemAdjustment(itemAdjustment, adjustment);
 451                 }
 452             } else {
 453                 // Add a new adjustment
 454                 final OrderItemPriceDetailAdjustment newItemAdjustment;
 455                 ExtensionResultHolder resultHolder = new ExtensionResultHolder();
 456 
 457                 if (extensionManager != null) {
 458                     extensionManager.createOrderItemPriceDetailAdjustment(resultHolder, itemDetail);
 459                 }
<abbr title=" 460                 if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetailAdjustment&quot;)) {"> 460                 if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetaiðŸ”µ</abbr>
<abbr title=" 461                     newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().get(&quot;OrderItemPriceDetailAdjustment&quot;);"> 461                     newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().getðŸ”µ</abbr>
 462                 } else {
 463                     newItemAdjustment = offerDao.createOrderItemPriceDetailAdjustment();
 464                 }
 465                 newItemAdjustment.init(itemDetail, adjustment.getOffer(), null);
 466                 updateItemAdjustment(newItemAdjustment, adjustment);
 467                 itemDetail.getOrderItemPriceDetailAdjustments().add(newItemAdjustment);
 468             }
 469         }
 470 
 471         if (itemAdjustmentMap.size() &gt; 0) {
 472             // Remove adjustments that were on the order item but no longer needed.
 473             List&lt;Long&gt; adjustmentIdsToRemove = new ArrayList&lt;Long&gt;();
 474             for (OrderItemPriceDetailAdjustment adjustmentToRemove : itemAdjustmentMap.values()) {
 475                 adjustmentIdsToRemove.add(adjustmentToRemove.getOffer().getId());
 476             }
 477 
<abbr title=" 478             Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustments().iterator();"> 478             Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustmðŸ”µ</abbr>
 479             while (iterator.hasNext()) {
 480                 OrderItemPriceDetailAdjustment adj = iterator.next();
 481                 if (adjustmentIdsToRemove.contains(adj.getOffer().getId())) {
 482                     iterator.remove();
 483                     entityService.remove(adj);
 484                 }
 485             }
 486         }
 487     }
 488 
 489     protected void updateItemAdjustment(OrderItemPriceDetailAdjustment itemAdjustment,
 490             PromotableOrderItemPriceDetailAdjustment promotableAdjustment) {
 491         itemAdjustment.setValue(promotableAdjustment.getAdjustmentValue());
 492         itemAdjustment.setSalesPriceValue(promotableAdjustment.getSaleAdjustmentValue());
 493         itemAdjustment.setRetailPriceValue(promotableAdjustment.getRetailAdjustmentValue());
 494         itemAdjustment.setAppliedToSalePrice(promotableAdjustment.isAppliedToSalePrice());
 495     }
 496 
 497     @Override
<abbr title=" 498     public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMap,"> 498     public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMapðŸ”µ</abbr>
 499             Iterator&lt;? extends OrderItemPriceDetail&gt; pdIterator) {
 500         while (pdIterator.hasNext()) {
 501             OrderItemPriceDetail currentDetail = pdIterator.next();
 502             if (unmatchedDetailsMap.containsKey(currentDetail.getId())) {
 503                 pdIterator.remove();
 504                 entityService.remove(currentDetail);
 505             }
 506         }
 507     }
 508 
 509     @Override
 510     public void removeUnmatchedQualifiers(Map&lt;Long, ? extends OrderItemQualifier&gt; unmatchedQualifiersMap,
 511             Iterator&lt;? extends OrderItemQualifier&gt; qIterator) {
 512         while (qIterator.hasNext()) {
 513             OrderItemQualifier currentQualifier = qIterator.next();
 514             if (unmatchedQualifiersMap.containsKey(currentQualifier.getId())) {
 515                 qIterator.remove();
 516                 entityService.remove(currentQualifier);
 517             }
 518         }
 519     }
 520 
 521     @Override
<abbr title=" 522     public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; qualifiersMap) {"> 522     public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OðŸ”µ</abbr>
 523         Money qualifyingItemSubTotal = offer.getQualifyingItemSubTotal();
 524         if (qualifyingItemSubTotal == null || qualifyingItemSubTotal.lessThanOrEqual(Money.ZERO)) {
 525             return true;
 526         }
 527         return orderMeetsProvidedSubtotalRequirement(offer, qualifiersMap, qualifyingItemSubTotal);
 528     }
 529 
 530     @Override
<abbr title=" 531     public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; targetsMap) {"> 531     public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferðŸ”µ</abbr>
 532         Money targetMinSubTotal = offer.getTargetMinSubTotal();
 533         if (targetMinSubTotal == null || targetMinSubTotal.lessThanOrEqual(Money.ZERO)) {
 534             return true;
 535         }
 536         return orderMeetsProvidedSubtotalRequirement(offer, targetsMap, targetMinSubTotal);
 537     }
 538 
<abbr title=" 539     protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; promotableOrderItems, Money minSubTotal) {"> 539     protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;ðŸ”µ</abbr>
 540         Money subtotal = Money.ZERO;
 541 
 542         for (OfferItemCriteria itemCriteria : promotableOrderItems.keySet()) {
 543             List&lt;PromotableOrderItem&gt; promotableItems = promotableOrderItems.get(itemCriteria);
 544 
 545             for (PromotableOrderItem item : promotableItems) {
 546                 boolean shouldApplyDiscountToSalePrice = offer.getApplyDiscountToSalePrice();
<abbr title=" 547                 Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrice);"> 547                 Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrðŸ”µ</abbr>
 548                 int quantity = item.getQuantity();
 549 
 550                 Money lineItemAmount = priceBeforeAdjustments.multiply(quantity);
 551                 subtotal = subtotal.add(lineItemAmount);
 552                 if (subtotal.greaterThanOrEqual(minSubTotal)) {
 553                     return true;
 554                 }
 555             }
 556         }
 557 
 558         return false;
 559     }
 560 
 561     @Override
 562     public boolean orderMeetsSubtotalRequirements(PromotableOrder order, Offer offer) {
 563         Money orderMinSubTotal = offer.getOrderMinSubTotal();
 564         return orderMinSubTotal == null
 565                 || orderMinSubTotal.lessThanOrEqual(Money.ZERO)
 566                 || orderMinSubTotal.lessThanOrEqual(order.getOrder().getSubTotal());
 567     }
 568 
 569     public PromotableItemFactory getPromotableItemFactory() {
 570         return promotableItemFactory;
 571     }
 572 
 573     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 574         this.promotableItemFactory = promotableItemFactory;
 575     }
 576 
 577     public OfferDao getOfferDao() {
 578         return offerDao;
 579     }
 580 
 581     public void setOfferDao(OfferDao offerDao) {
 582         this.offerDao = offerDao;
 583     }
 584 
 585     public GenericEntityService getGenericEntityService() {
 586         return entityService;
 587     }
 588 
 589     public void setGenericEntityService(GenericEntityService entityService) {
 590         this.entityService = entityService;
 591     }
 592 }
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service;
  19 
  20 import java.math.BigDecimal;
  21 import java.util.ArrayList;
  22 import java.util.Collections;
  23 import java.util.Comparator;
  24 import java.util.HashMap;
  25 import java.util.Iterator;
  26 import java.util.List;
  27 import java.util.Map;
  28 import javax.annotation.Resource;
  29 import org.apache.commons.logging.Log;
  30 import org.apache.commons.logging.LogFactory;
  31 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  32 import org.broadleafcommerce.common.money.Money;
  33 import org.broadleafcommerce.common.service.GenericEntityService;
  34 import org.broadleafcommerce.core.offer.dao.OfferDao;
  35 import org.broadleafcommerce.core.offer.domain.Offer;
  36 import org.broadleafcommerce.core.offer.domain.OfferItemCriteria;
  37 import org.broadleafcommerce.core.offer.domain.OfferPriceData;
  38 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  39 import org.broadleafcommerce.core.offer.service.discount.PromotionDiscount;
  40 import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;
  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  43 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;
  44 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  45 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  46 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;
  47 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;
  48 import org.broadleafcommerce.core.offer.service.processor.ItemOfferMarkTargets;
  49 import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;
  50 import org.broadleafcommerce.core.order.domain.Order;
  51 import org.broadleafcommerce.core.order.domain.OrderItem;
  52 import org.broadleafcommerce.core.order.domain.OrderItemContainer;
  53 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  54 import org.broadleafcommerce.core.order.domain.OrderItemQualifier;
  55 import org.broadleafcommerce.core.order.domain.dto.OrderItemHolder;
  56 import org.springframework.stereotype.Service;
  57 
  58 
  59 /**
  60  *
  61  * @author bpolster
  62  *
  63  */
  64 @Service(&quot;blOfferServiceUtilities&quot;)
  65 public class OfferServiceUtilitiesImpl implements OfferServiceUtilities {
  66     protected static final Log LOG = LogFactory.getLog(OfferServiceUtilitiesImpl.class);
  67 
  68     @Resource(name = &quot;blPromotableItemFactory&quot;)
  69     protected PromotableItemFactory promotableItemFactory;
  70 
  71     @Resource(name = &quot;blOfferDao&quot;)
  72     protected OfferDao offerDao;
  73 
  74     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
  75     protected OfferServiceExtensionManager extensionManager;
  76 
  77     protected final PromotableOfferUtility promotableOfferUtility;
  78 
  79     public OfferServiceUtilitiesImpl(PromotableOfferUtility promotableOfferUtility) {
  80         this.promotableOfferUtility = promotableOfferUtility;
  81     }
  82 
  83     @Resource(name = &quot;blGenericEntityService&quot;)
  84     protected GenericEntityService entityService;
  85 
  86     @Override
<abbr title="  87     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  87     public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applðŸ”µ</abbr>
  88         Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));
  89     }
  90 
  91     @Override
<abbr title="  92     public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  92     public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean aðŸ”µ</abbr>
  93         Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));
  94     }
  95 
<abbr title="  96     protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyToSalePrice) {">  96     protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyTðŸ”µ</abbr>
  97         return new Comparator&lt;PromotableOrderItemPriceDetail&gt;() {
  98 
  99             @Override
 100             public int compare(PromotableOrderItemPriceDetail o1, PromotableOrderItemPriceDetail o2) {
 101                 Money price = o1.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);
 102                 Money price2 = o2.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);
 103 
 104                 // highest amount first
 105                 return price2.compareTo(price);
 106             }
 107         };
 108     }
 109 
 110     @Override
 111     public OrderItem findRelatedQualifierRoot(OrderItem relatedQualifier) {
 112         OrderItem relatedQualifierRoot = null;
 113         if (relatedQualifier != null) {
 114             relatedQualifierRoot = relatedQualifier;
 115             while (relatedQualifierRoot.getParentOrderItem() != null) {
 116                 relatedQualifierRoot = relatedQualifierRoot.getParentOrderItem();
 117             }
 118         }
 119         return relatedQualifierRoot;
 120     }
 121 
 122     @Override
<abbr title=" 123     public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; details) {"> 123     public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemðŸ”µ</abbr>
 124 
 125         for (PromotableOrderItemPriceDetail detail : details) {
<abbr title=" 126             for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustments()) {"> 126             for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustmentsðŸ”µ</abbr>
 127                 if (adjustment.isTotalitarian() || itemOffer.getOffer().isTotalitarianOffer()) {
 128                     // A totalitarian offer has already been applied or this offer is totalitarian
 129                     // and another offer was already applied.
 130                     return false;
<abbr title=" 131                 } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 131                 } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOfferðŸ”µ</abbr>
 132                     // A nonCombinable offer has been applied or this is a non-combinable offer
 133                     // and adjustments have already been applied.
 134                     return false;
 135                 }
 136             }
 137         }
 138         return true;
 139     }
 140 
 141     @Override
<abbr title=" 142     public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCriteria,"> 142     public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCrðŸ”µ</abbr>
 143             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {
 144 
 145         sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());
 146 
 147         // Calculate the number of qualifiers needed that will not receive the promotion.
 148         // These will be reserved first before the target is assigned.
 149         int qualifierQtyNeeded = itemCriteria.getQuantity();
 150 
 151         for (PromotableOrderItemPriceDetail detail : priceDetails) {
 152 
 153             // Mark Qualifiers
 154             if (qualifierQtyNeeded &gt; 0) {
<abbr title=" 155                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 155                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(ðŸ”µ</abbr>
 156                 if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {
<abbr title=" 157                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);"> 157                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQuaðŸ”µ</abbr>
 158                     qualifierQtyNeeded -= qtyToMarkAsQualifier;
 159                     detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);
 160                 }
 161             }
 162 
 163             if (qualifierQtyNeeded == 0) {
 164                 break;
 165             }
 166         }
 167         return qualifierQtyNeeded;
 168     }
 169 
 170     @Override
 171     public int markTargetsForCriteria(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,
<abbr title=" 172             boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriteria,"> 172             boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriðŸ”µ</abbr>
 173             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, int targetQtyNeeded) {
 174         for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {
 175             if (relatedQualifier != null) {
<abbr title=" 176                 // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 176                 // We need to make sure that this item is either a parent, child, or the same as the qualðŸ”µ</abbr>
 177                 OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();
<abbr title=" 178                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;"> 178                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierðŸ”µ</abbr>
 179                         !thisItem.equals(relatedQualifierRoot)) {
 180                     continue;
 181                 }
 182             }
 183 
<abbr title=" 184             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);"> 184             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOðŸ”µ</abbr>
 185             if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {
<abbr title=" 186                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 186                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOðŸ”µ</abbr>
 187                     int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget);
 188                     targetQtyNeeded -= qtyToMarkAsTarget;
 189                     if (!checkOnly) {
 190                         priceDetail.addPromotionDiscount(itemOffer, itemCriteria, qtyToMarkAsTarget);
 191                     }
 192                 }
 193             }
 194 
 195             if (targetQtyNeeded == 0) {
 196                 break;
 197             }
 198         }
 199         return targetQtyNeeded;
 200     }
 201 
 202     @Override
<abbr title=" 203     public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,"> 203     public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedðŸ”µ</abbr>
<abbr title=" 204                                                 boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferPriceData offerPriceData,"> 204                                                 boolean checkOnly, Offer promotion, OrderItem relatedQualðŸ”µ</abbr>
 205                                                 List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {
 206         int targetQtyNeeded = offerPriceData.getQuantity();
 207         int minRequiredTargetQuantity = itemOffer.getMinimumRequiredTargetQuantity();
 208         if (minRequiredTargetQuantity &gt; 1 &amp;&amp; minRequiredTargetQuantity &gt; targetQtyNeeded) {
 209             targetQtyNeeded = minRequiredTargetQuantity;
 210         }
 211 
 212         for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {
 213             if (relatedQualifier != null) {
<abbr title=" 214                 // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 214                 // We need to make sure that this item is either a parent, child, or the same as the qualðŸ”µ</abbr>
 215                 OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();
<abbr title=" 216                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;"> 216                 if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierðŸ”µ</abbr>
 217                         !thisItem.equals(relatedQualifierRoot)) {
 218                     continue;
 219                 }
 220             }
 221 
<abbr title=" 222             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);"> 222             int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOðŸ”µ</abbr>
 223             if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {
<abbr title=" 224                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 224                 if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOðŸ”µ</abbr>
 225                     int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget);
 226                     targetQtyNeeded -= qtyToMarkAsTarget;
 227                     if (!checkOnly) {
 228                         priceDetail.addPromotionDiscount(itemOffer, null, qtyToMarkAsTarget);
 229                     }
 230                 }
 231             }
 232 
 233             if (targetQtyNeeded == 0) {
 234                 break;
 235             }
 236         }
 237         return targetQtyNeeded == 0;
 238     }
 239 
 240     @Override
<abbr title=" 241     public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, PromotableOrder order,"> 241     public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, ProðŸ”µ</abbr>
 242             OrderItemHolder orderItemHolder, OfferItemCriteria itemCriteria,
<abbr title=" 243             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets) {"> 243             List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets)ðŸ”µ</abbr>
 244         sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());
 245 
 246         // Calculate the number of qualifiers needed that will not receive the promotion.
 247         // These will be reserved first before the target is assigned.
 248         int qualifierQtyNeeded = itemCriteria.getQuantity();
 249 
 250         for (PromotableOrderItemPriceDetail detail : priceDetails) {
 251             OrderItem oi = detail.getPromotableOrderItem().getOrderItem();
 252 
 253             if (qualifierQtyNeeded &gt; 0) {
<abbr title=" 254                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 254                 int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(ðŸ”µ</abbr>
 255                 if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {
<abbr title=" 256                     // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some state that we"> 256                     // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some sðŸ”µ</abbr>
 257                     // might need in the future.
 258                     OfferItemCriteria previousQualifierCriteria = null;
 259                     for (PromotionQualifier possibleQualifier : detail.getPromotionQualifiers()) {
 260                         if (possibleQualifier.getPromotion().equals(itemOffer.getOffer())) {
 261                             previousQualifierCriteria = possibleQualifier.getItemCriteria();
 262                             break;
 263                         }
 264                     }
 265 
 266                     // Go ahead and mark this item as a qualifier
<abbr title=" 267                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);"> 267                     int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQuaðŸ”µ</abbr>
 268                     qualifierQtyNeeded -= qtyToMarkAsQualifier;
<abbr title=" 269                     PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);"> 269                     PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMaðŸ”µ</abbr>
<abbr title=" 270                     pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOffer().getApplyDiscountToSalePrice()));"> 270                     pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOfðŸ”µ</abbr>
 271 
<abbr title=" 272                     // Now, we need to see if there exists a target(s) that is suitable for this qualifier due to"> 272                     // Now, we need to see if there exists a target(s) that is suitable for this qualifieðŸ”µ</abbr>
<abbr title=" 273                     // the relationship flag. If we are on the last qualifier required for this offer, we want to"> 273                     // the relationship flag. If we are on the last qualifier required for this offer, weðŸ”µ</abbr>
<abbr title=" 274                     // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just want to check"> 274                     // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just wantðŸ”µ</abbr>
 275                     // that there is an eligible target(s) and continue on.
 276                     if (itemOfferMarkTargets.markTargets(itemOffer, order, oi, true)) {
<abbr title=" 277                         // We found a target. Let&#x27;s save this related order item used as the qualifier in case"> 277                         // We found a target. Let&#x27;s save this related order item used as the qualifier inðŸ”µ</abbr>
 278                         // we succeed
 279                         orderItemHolder.setOrderItem(oi);
 280                     } else {
<abbr title=" 281                         // If we didn&#x27;t find a target, we need to roll back how we marked this item as a qualifier."> 281                         // If we didn&#x27;t find a target, we need to roll back how we marked this item as a ðŸ”µ</abbr>
 282                         qualifierQtyNeeded += qtyToMarkAsQualifier;
 283                         if (pq.getQuantity() == qtyToMarkAsQualifier) {
 284                             detail.getPromotionQualifiers().remove(pq);
 285                         } else {
 286                             pq.setItemCriteria(previousQualifierCriteria);
 287                             pq.setQuantity(pq.getQuantity() - qtyToMarkAsQualifier);
 288                         }
 289                     }
 290                 }
 291             }
 292 
 293             if (qualifierQtyNeeded == 0) {
 294                 break;
 295             }
 296         }
 297         return qualifierQtyNeeded;
 298     }
 299 
 300     @Override
<abbr title=" 301     public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails) {"> 301     public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotabðŸ”µ</abbr>
 302         for (PromotableOrderItemPriceDetail itemPriceDetail : itemPriceDetails) {
 303             for (PromotionDiscount discount : itemPriceDetail.getPromotionDiscounts()) {
 304                 if (discount.getPromotion().equals(itemOffer.getOffer())) {
<abbr title=" 305                     if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 305                     if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWðŸ”µ</abbr>
 306                         // We&#x27;ve decided to apply this adjustment but if it doesn&#x27;t actually reduce
 307                         // the value of the item
 308                         if (adjustmentIsNotGoodEnoughToBeApplied(itemOffer, itemPriceDetail)) {
 309                             break;
 310                         }
 311 
 312                     }
 313                     OrderItem orderItem = itemPriceDetail.getPromotableOrderItem().getOrderItem();
 314                     Boolean offerCanApplyToChildOrderItems = itemOffer.getOffer().getApplyToChildItems();
 315                     if (isAddOnOrderItem(orderItem) &amp;&amp; !offerCanApplyToChildOrderItems) {
 316                         break;
 317                     }
 318                     applyOrderItemAdjustment(itemOffer, itemPriceDetail);
 319                     break;
 320                 }
 321             }
 322         }
 323     }
 324 
 325     @Override
 326     public boolean isAddOnOrderItem(OrderItem orderItem) {
 327         if (DiscreteOrderItem.class.isAssignableFrom(orderItem.getClass())) {
 328             DiscreteOrderItem discreteOrderItem = (DiscreteOrderItem) orderItem;
 329 
 330             Map&lt;String, String&gt; attributes = discreteOrderItem.getAdditionalAttributes();
 331             boolean isAddOnOrderItem = attributes.containsKey(&quot;addOnXrefId&quot;);
 332             boolean isChildOrderItem = discreteOrderItem.isChildOrderItem();
 333 
 334             return isChildOrderItem &amp;&amp; isAddOnOrderItem;
 335         }
 336         return false;
 337     }
 338 
 339     /**
 340      * The adjustment might not be better than the sale price.
 341      * @param itemOffer
 342      * @param detail
 343      * @return
 344      */
<abbr title=" 345     protected boolean adjustmentIsNotGoodEnoughToBeApplied(PromotableCandidateItemOffer itemOffer, PromotableOrderItemPriceDetail detail) {"> 345     protected boolean adjustmentIsNotGoodEnoughToBeApplied(PromotableCandidateItemOffer itemOffer, PromotðŸ”µ</abbr>
 346         if (!itemOffer.getOffer().getApplyDiscountToSalePrice()) {
 347             Money salePrice = detail.getPromotableOrderItem().getSalePriceBeforeAdjustments();
 348             Money retailPrice = detail.getPromotableOrderItem().getRetailPriceBeforeAdjustments();
<abbr title=" 349             Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromotableOrderItem(), 1);"> 349             Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromðŸ”µ</abbr>
 350             if (salePrice != null) {
 351                 if (salePrice.lessThan(retailPrice.subtract(savings))) {
 352                     // Not good enough
 353                     return true;
 354                 }
 355             }
 356         }
 357         return false;
 358     }
 359 
 360     @Override
<abbr title=" 361     public void applyOrderItemAdjustment(PromotableCandidateItemOffer itemOffer, PromotableOrderItemPriceDetail itemPriceDetail) {"> 361     public void applyOrderItemAdjustment(PromotableCandidateItemOffer itemOffer, PromotableOrderItemPriceðŸ”µ</abbr>
<abbr title=" 362         PromotableOrderItemPriceDetailAdjustment promotableOrderItemPriceDetailAdjustment = promotableItemFactory.createPromotableOrderItemPriceDetailAdjustment(itemOffer, itemPriceDetail);"> 362         PromotableOrderItemPriceDetailAdjustment promotableOrderItemPriceDetailAdjustment = promotableIteðŸ”µ</abbr>
 363         // don&#x27;t want to have negative adjustments
<abbr title=" 364         if (promotableOrderItemPriceDetailAdjustment.getRetailAdjustmentValue().lessThan(BigDecimal.ZERO) || promotableOrderItemPriceDetailAdjustment.getSaleAdjustmentValue().lessThan(BigDecimal.ZERO)) {"> 364         if (promotableOrderItemPriceDetailAdjustment.getRetailAdjustmentValue().lessThan(BigDecimal.ZERO)ðŸ”µ</abbr>
 365             return;
 366         }
 367         itemPriceDetail.addCandidateItemPriceDetailAdjustment(promotableOrderItemPriceDetailAdjustment);
 368     }
 369 
 370     @Override
 371     public List&lt;OrderItem&gt; buildOrderItemList(Order order) {
 372         List&lt;OrderItem&gt; orderItemList = new ArrayList&lt;OrderItem&gt;();
 373         for (OrderItem currentItem : order.getOrderItems()) {
 374             if (currentItem instanceof OrderItemContainer) {
 375                 OrderItemContainer container = (OrderItemContainer) currentItem;
 376                 if (container.isPricingAtContainerLevel()) {
 377                     orderItemList.add(currentItem);
 378                 } else {
 379                     for (OrderItem containedItem : container.getOrderItems()) {
 380                         orderItemList.add(containedItem);
 381                     }
 382                 }
 383             } else {
 384                 orderItemList.add(currentItem);
 385             }
 386         }
 387 
 388         return orderItemList;
 389     }
 390 
 391     @Override
 392     public Map&lt;OrderItem, PromotableOrderItem&gt; buildPromotableItemMap(PromotableOrder promotableOrder) {
<abbr title=" 393         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderItem&gt;();"> 393         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderIteðŸ”µ</abbr>
 394         for (PromotableOrderItem item : promotableOrder.getAllOrderItems()) {
 395             promotableItemMap.put(item.getOrderItem(), item);
 396         }
 397         return promotableItemMap;
 398     }
 399 
 400     @Override
<abbr title=" 401     public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itemDetail) {"> 401     public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itðŸ”µ</abbr>
<abbr title=" 402         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 402         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetðŸ”µ</abbr>
 403 
<abbr title=" 404         List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 404         List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjuðŸ”µ</abbr>
<abbr title=" 405         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {"> 405         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments())ðŸ”µ</abbr>
 406             if (itemAdjustmentMap.containsKey(adjustment.getOffer().getId())) {
 407                 if (LOG.isDebugEnabled()) {
<abbr title=" 408                     StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with ids &quot;)"> 408                     StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with iðŸ”µ</abbr>
 409                         .append(itemAdjustmentMap.get(adjustment.getOffer().getId()).getId())
 410                         .append(&quot; and &quot;)
 411                         .append(adjustment.getId());
 412                     LOG.debug(sb.toString());
 413                 }
 414                 adjustmentsToRemove.add(adjustment);
 415             } else {
 416                 itemAdjustmentMap.put(adjustment.getOffer().getId(), adjustment);
 417             }
 418         }
 419 
 420         for (OrderItemPriceDetailAdjustment adjustment : adjustmentsToRemove) {
 421             itemDetail.getOrderItemPriceDetailAdjustments().remove(adjustment);
 422         }
 423 
 424         return itemAdjustmentMap;
 425     }
 426 
 427     @Override
<abbr title=" 428     public void updatePriceDetail(OrderItemPriceDetail itemDetail, PromotableOrderItemPriceDetail promotableDetail) {"> 428     public void updatePriceDetail(OrderItemPriceDetail itemDetail, PromotableOrderItemPriceDetail promotaðŸ”µ</abbr>
<abbr title=" 429         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = buildItemDetailAdjustmentMap(itemDetail);"> 429         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = buildItemDetailAdjustmentMap(itemDeðŸ”µ</abbr>
 430         if (itemDetail.getQuantity() != promotableDetail.getQuantity()) {
 431             itemDetail.setQuantity(promotableDetail.getQuantity());
 432         }
 433         if (promotableDetail.isAdjustmentsFinalized()) {
 434             itemDetail.setUseSalePrice(promotableDetail.useSaleAdjustments());
 435         }
<abbr title=" 436         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjustments()) {"> 436         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjusðŸ”µ</abbr>
<abbr title=" 437             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferId());"> 437             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferIðŸ”µ</abbr>
 438             if (itemAdjustment != null) {
 439                 // Update existing adjustment
 440                 if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {
 441                     updateItemAdjustment(itemAdjustment, adjustment);
 442                 }
 443             } else {
 444                 // Add a new adjustment
 445                 final OrderItemPriceDetailAdjustment newItemAdjustment;
 446                 ExtensionResultHolder resultHolder = new ExtensionResultHolder();
 447                 if (extensionManager != null) {
 448                     extensionManager.createOrderItemPriceDetailAdjustment(resultHolder, itemDetail);
 449                 }
<abbr title=" 450                 if ((resultHolder != null) &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetailAdjustment&quot;)) {"> 450                 if ((resultHolder != null) &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetðŸ”µ</abbr>
<abbr title=" 451                     newItemAdjustment = ((OrderItemPriceDetailAdjustment) (resultHolder.getContextMap().get(&quot;OrderItemPriceDetailAdjustment&quot;)));"> 451                     newItemAdjustment = ((OrderItemPriceDetailAdjustment) (resultHolder.getContextMap().gðŸ”µ</abbr>
 452                 } else {
 453                     newItemAdjustment = offerDao.createOrderItemPriceDetailAdjustment();
 454                 }
 455                 newItemAdjustment.init(itemDetail, adjustment.getOffer(), null);
 456                 updateItemAdjustment(newItemAdjustment, adjustment);
 457                 itemDetail.getOrderItemPriceDetailAdjustments().add(newItemAdjustment);
 458             }
 459         }
 460         if (itemAdjustmentMap.size() &gt; 0) {
 461             // Remove adjustments that were on the order item but no longer needed.
 462             List&lt;Long&gt; adjustmentIdsToRemove = new ArrayList&lt;Long&gt;();
 463             for (OrderItemPriceDetailAdjustment adjustmentToRemove : itemAdjustmentMap.values()) {
 464                 adjustmentIdsToRemove.add(adjustmentToRemove.getOffer().getId());
 465             }
<abbr title=" 466             Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustments().iterator();"> 466             Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustmðŸ”µ</abbr>
 467             while (iterator.hasNext()) {
 468                 OrderItemPriceDetailAdjustment adj = iterator.next();
 469                 if (adjustmentIdsToRemove.contains(adj.getOffer().getId())) {
 470                     iterator.remove();
 471                     entityService.remove(adj);
 472                 }
 473             }
 474         }
 475     }
 476 
 477     protected void updateItemAdjustment(OrderItemPriceDetailAdjustment itemAdjustment,
 478             PromotableOrderItemPriceDetailAdjustment promotableAdjustment) {
 479         itemAdjustment.setValue(promotableAdjustment.getAdjustmentValue());
 480         itemAdjustment.setSalesPriceValue(promotableAdjustment.getSaleAdjustmentValue());
 481         itemAdjustment.setRetailPriceValue(promotableAdjustment.getRetailAdjustmentValue());
 482         itemAdjustment.setAppliedToSalePrice(promotableAdjustment.isAppliedToSalePrice());
 483     }
 484 
 485     @Override
<abbr title=" 486     public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMap, Iterator&lt;? extends OrderItemPriceDetail&gt; pdIterator) {"> 486     public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMapðŸ”µ</abbr>
 487         while (pdIterator.hasNext()) {
 488             OrderItemPriceDetail currentDetail = pdIterator.next();
 489             if (unmatchedDetailsMap.containsKey(currentDetail.getId())) {
 490                 pdIterator.remove();
 491                 entityService.remove(currentDetail);
 492             }
 493         }
 494     }
 495 
 496     @Override
<abbr title=" 497     public void removeUnmatchedQualifiers(Map&lt;Long, ? extends OrderItemQualifier&gt; unmatchedQualifiersMap, Iterator&lt;? extends OrderItemQualifier&gt; qIterator) {"> 497     public void removeUnmatchedQualifiers(Map&lt;Long, ? extends OrderItemQualifier&gt; unmatchedQualifiersMap,ðŸ”µ</abbr>
 498         while (qIterator.hasNext()) {
 499             OrderItemQualifier currentQualifier = qIterator.next();
 500             if (unmatchedQualifiersMap.containsKey(currentQualifier.getId())) {
 501                 qIterator.remove();
 502                 entityService.remove(currentQualifier);
 503             }
 504         }
 505     }
 506 
 507     @Override
<abbr title=" 508     public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; qualifiersMap) {"> 508     public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OðŸ”µ</abbr>
 509         Money qualifyingItemSubTotal = offer.getQualifyingItemSubTotal();
 510         if (qualifyingItemSubTotal == null || qualifyingItemSubTotal.lessThanOrEqual(Money.ZERO)) {
 511             return true;
 512         }
 513         return orderMeetsProvidedSubtotalRequirement(offer, qualifiersMap, qualifyingItemSubTotal);
 514     }
 515 
 516     @Override
<abbr title=" 517     public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; targetsMap) {"> 517     public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferðŸ”µ</abbr>
 518         Money targetMinSubTotal = offer.getTargetMinSubTotal();
 519         if (targetMinSubTotal == null || targetMinSubTotal.lessThanOrEqual(Money.ZERO)) {
 520             return true;
 521         }
 522         return orderMeetsProvidedSubtotalRequirement(offer, targetsMap, targetMinSubTotal);
 523     }
 524 
<abbr title=" 525     protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; promotableOrderItems, Money minSubTotal) {"> 525     protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;ðŸ”µ</abbr>
 526         Money subtotal = Money.ZERO;
 527 
 528         for (OfferItemCriteria itemCriteria : promotableOrderItems.keySet()) {
 529             List&lt;PromotableOrderItem&gt; promotableItems = promotableOrderItems.get(itemCriteria);
 530 
 531             for (PromotableOrderItem item : promotableItems) {
 532                 boolean shouldApplyDiscountToSalePrice = offer.getApplyDiscountToSalePrice();
<abbr title=" 533                 Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrice);"> 533                 Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrðŸ”µ</abbr>
 534                 int quantity = item.getQuantity();
 535 
 536                 Money lineItemAmount = priceBeforeAdjustments.multiply(quantity);
 537                 subtotal = subtotal.add(lineItemAmount);
 538                 if (subtotal.greaterThanOrEqual(minSubTotal)) {
 539                     return true;
 540                 }
 541             }
 542         }
 543 
 544         return false;
 545     }
 546 
 547     @Override
 548     public boolean orderMeetsSubtotalRequirements(PromotableOrder order, Offer offer) {
 549         Money orderMinSubTotal = offer.getOrderMinSubTotal();
 550         return orderMinSubTotal == null
 551                 || orderMinSubTotal.lessThanOrEqual(Money.ZERO)
 552                 || orderMinSubTotal.lessThanOrEqual(order.getOrder().getSubTotal());
 553     }
 554 
 555     public PromotableItemFactory getPromotableItemFactory() {
 556         return promotableItemFactory;
 557     }
 558 
 559     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 560         this.promotableItemFactory = promotableItemFactory;
 561     }
 562 
 563     public OfferDao getOfferDao() {
 564         return offerDao;
 565     }
 566 
 567     public void setOfferDao(OfferDao offerDao) {
 568         this.offerDao = offerDao;
 569     }
 570 
 571     public GenericEntityService getGenericEntityService() {
 572         return entityService;
 573     }
 574 
 575     public void setGenericEntityService(GenericEntityService entityService) {
 576         this.entityService = entityService;
 577     }
 578 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.offer.service;
  19  
  20  import org.apache.commons.logging.Log;
  21  import org.apache.commons.logging.LogFactory;
  22  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  23  import org.broadleafcommerce.common.money.Money;

  24  import org.broadleafcommerce.core.offer.dao.OfferDao;
  25  import org.broadleafcommerce.core.offer.domain.Offer;
  26  import org.broadleafcommerce.core.offer.domain.OfferItemCriteria;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import org.broadleafcommerce.core.offer.domain.OfferPriceData;</span>
  28  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  29  import org.broadleafcommerce.core.offer.service.discount.PromotionDiscount;
  30  import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;
  31  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  32  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;</span>
  34  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  35  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  36  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;
  37  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;
  38  import org.broadleafcommerce.core.offer.service.processor.ItemOfferMarkTargets;
  39  import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;
  40  import org.broadleafcommerce.core.order.domain.Order;
  41  import org.broadleafcommerce.core.order.domain.OrderItem;
  42  import org.broadleafcommerce.core.order.domain.OrderItemContainer;
  43  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  44  import org.broadleafcommerce.core.order.domain.OrderItemQualifier;
  45  import org.broadleafcommerce.core.order.domain.dto.OrderItemHolder;
  46  import org.springframework.stereotype.Service;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -</span>

  48  import java.util.ArrayList;
  49  import java.util.Collections;
  50  import java.util.Comparator;
  51  import java.util.HashMap;
  52  import java.util.Iterator;
  53  import java.util.List;
  54  import java.util.Map;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -</span>
  56  import javax.annotation.Resource;
  57  
  58  /**
  59   *
  60   * @author bpolster
  61   *
  62   */
  63  @Service(&quot;blOfferServiceUtilities&quot;)
  64  public class OfferServiceUtilitiesImpl implements OfferServiceUtilities {
  65      protected static final Log LOG = LogFactory.getLog(OfferServiceUtilitiesImpl.class);
  66  
  67      @Resource(name = &quot;blPromotableItemFactory&quot;)
  68      protected PromotableItemFactory promotableItemFactory;
  69  
  70      @Resource(name = &quot;blOfferDao&quot;)
  71      protected OfferDao offerDao;
  72  
  73      @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
  74      protected OfferServiceExtensionManager extensionManager;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +    protected final PromotableOfferUtility promotableOfferUtility;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +    public OfferServiceUtilitiesImpl(PromotableOfferUtility promotableOfferUtility) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +        this.promotableOfferUtility = promotableOfferUtility;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +    }</span>
  81  
  82      @Override
<abbr title="  83      public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  83      public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrðŸ”µ</abbr>
  84          Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));
  85      }
  86  
  87      @Override
<abbr title="  88      public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  88      public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalðŸ”µ</abbr>
  89          Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));
  90      }
  91  
<abbr title="  92      protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyToSalePrice) {">  92      protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyToSalePricðŸ”µ</abbr>
  93          return new Comparator&lt;PromotableOrderItemPriceDetail&gt;() {
  94  
  95              @Override
  96              public int compare(PromotableOrderItemPriceDetail o1, PromotableOrderItemPriceDetail o2) {
  97                  Money price = o1.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);
  98                  Money price2 = o2.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);
  99  
 100                  // highest amount first
 101                  return price2.compareTo(price);
 102              }
 103          };
 104      }
 105  
 106      @Override
 107      public OrderItem findRelatedQualifierRoot(OrderItem relatedQualifier) {
 108          OrderItem relatedQualifierRoot = null;
 109          if (relatedQualifier != null) {
 110              relatedQualifierRoot = relatedQualifier;
 111              while (relatedQualifierRoot.getParentOrderItem() != null) {
 112                  relatedQualifierRoot = relatedQualifierRoot.getParentOrderItem();
 113              }
 114          }
 115          return relatedQualifierRoot;
 116      }
 117  
 118      @Override
<abbr title=" 119      public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; details) {"> 119      public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetaðŸ”µ</abbr>
 120  
 121          for (PromotableOrderItemPriceDetail detail : details) {
 122              for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustments()) {
 123                  if (adjustment.isTotalitarian() || itemOffer.getOffer().isTotalitarianOffer()) {
 124                      // A totalitarian offer has already been applied or this offer is totalitarian
 125                      // and another offer was already applied.
 126                      return false;
 127                  } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {
 128                      // A nonCombinable offer has been applied or this is a non-combinable offer
 129                      // and adjustments have already been applied.
 130                      return false;
 131                  }
 132              }
 133          }
 134          return true;
 135      }
 136  
 137      @Override
 138      public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCriteria,
 139              List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {
 140  
 141          sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());
 142  
 143          // Calculate the number of qualifiers needed that will not receive the promotion.
 144          // These will be reserved first before the target is assigned.
 145          int qualifierQtyNeeded = itemCriteria.getQuantity();
 146  
 147          for (PromotableOrderItemPriceDetail detail : priceDetails) {
 148  
 149              // Mark Qualifiers
 150              if (qualifierQtyNeeded &gt; 0) {
<abbr title=" 151                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 151                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOfferðŸ”µ</abbr>
 152                  if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {
 153                      int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);
 154                      qualifierQtyNeeded -= qtyToMarkAsQualifier;
 155                      detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);
 156                  }
 157              }
 158  
 159              if (qualifierQtyNeeded == 0) {
 160                  break;
 161              }
 162          }
 163          return qualifierQtyNeeded;
 164      }
 165  
 166      @Override
 167      public int markTargetsForCriteria(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,
 168              boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriteria,
 169              List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, int targetQtyNeeded) {
 170          for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {
 171              if (relatedQualifier != null) {
<abbr title=" 172                  // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 172                  // We need to make sure that this item is either a parent, child, or the same as the qualifier rooðŸ”µ</abbr>
 173                  OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();
 174                  if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;
 175                          !thisItem.equals(relatedQualifierRoot)) {
 176                      continue;
 177                  }
 178              }
 179  
 180              int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);
 181              if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {
<abbr title=" 182                  if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 182                  if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) ðŸ”µ</abbr>
 183                      int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget);
 184                      targetQtyNeeded -= qtyToMarkAsTarget;
 185                      if (!checkOnly) {
 186                          priceDetail.addPromotionDiscount(itemOffer, itemCriteria, qtyToMarkAsTarget);
 187                      }
 188                  }
 189              }
 190  
 191              if (targetQtyNeeded == 0) {
 192                  break;
 193              }
 194          }
 195          return targetQtyNeeded;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 199 +    public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,"> 199 +    public boolean markTargetsForOfferPriceData(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifierðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 200 +                                                boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferPriceData offerPriceData,"> 200 +                                                boolean checkOnly, Offer promotion, OrderItem relatedQualifierRootðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +                                                List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +        int targetQtyNeeded = offerPriceData.getQuantity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +        int minRequiredTargetQuantity = itemOffer.getMinimumRequiredTargetQuantity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +        if (minRequiredTargetQuantity &gt; 1 &amp;&amp; minRequiredTargetQuantity &gt; targetQtyNeeded) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +            targetQtyNeeded = minRequiredTargetQuantity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +        for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +            if (relatedQualifier != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 210 +                // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 210 +                // We need to make sure that this item is either a parent, child, or the same as the qualifier rooðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +                OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +                if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +                        !thisItem.equals(relatedQualifierRoot)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +                    continue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +            int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +            if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 220 +                if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 220 +                if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +                    int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +                    targetQtyNeeded -= qtyToMarkAsTarget;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +                    if (!checkOnly) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +                        priceDetail.addPromotionDiscount(itemOffer, null, qtyToMarkAsTarget);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +            if (targetQtyNeeded == 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +        return targetQtyNeeded == 0;</span>
 234      }
 235  
 236      @Override
<abbr title=" 237      public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, PromotableOrder order,"> 237      public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, PromotableOrðŸ”µ</abbr>
 238              OrderItemHolder orderItemHolder, OfferItemCriteria itemCriteria,
 239              List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets) {
 240          sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());
 241  
 242          // Calculate the number of qualifiers needed that will not receive the promotion.
 243          // These will be reserved first before the target is assigned.
 244          int qualifierQtyNeeded = itemCriteria.getQuantity();
 245  
 246          for (PromotableOrderItemPriceDetail detail : priceDetails) {
 247              OrderItem oi = detail.getPromotableOrderItem().getOrderItem();
 248  
 249              if (qualifierQtyNeeded &gt; 0) {
<abbr title=" 250                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 250                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOfferðŸ”µ</abbr>
 251                  if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {
<abbr title=" 252                      // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some state that we"> 252                      // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some state thatðŸ”µ</abbr>
 253                      // might need in the future.
 254                      OfferItemCriteria previousQualifierCriteria = null;
 255                      for (PromotionQualifier possibleQualifier : detail.getPromotionQualifiers()) {
 256                          if (possibleQualifier.getPromotion().equals(itemOffer.getOffer())) {
 257                              previousQualifierCriteria = possibleQualifier.getItemCriteria();
 258                              break;
 259                          }
 260                      }
 261  
 262                      // Go ahead and mark this item as a qualifier
 263                      int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);
 264                      qualifierQtyNeeded -= qtyToMarkAsQualifier;
<abbr title=" 265                      PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);"> 265                      PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualiðŸ”µ</abbr>
<abbr title=" 266                      pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOffer().getApplyDiscountToSalePrice()));"> 266                      pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOffer().getðŸ”µ</abbr>
 267  
 268                      // Now, we need to see if there exists a target(s) that is suitable for this qualifier due to
 269                      // the relationship flag. If we are on the last qualifier required for this offer, we want to
 270                      // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just want to check
 271                      // that there is an eligible target(s) and continue on.
 272                      if (itemOfferMarkTargets.markTargets(itemOffer, order, oi, true)) {
 273                          // We found a target. Let&#x27;s save this related order item used as the qualifier in case
 274                          // we succeed
 275                          orderItemHolder.setOrderItem(oi);
 276                      } else {
<abbr title=" 277                          // If we didn&#x27;t find a target, we need to roll back how we marked this item as a qualifier."> 277                          // If we didn&#x27;t find a target, we need to roll back how we marked this item as a qualifierðŸ”µ</abbr>
 278                          qualifierQtyNeeded += qtyToMarkAsQualifier;
 279                          if (pq.getQuantity() == qtyToMarkAsQualifier) {
 280                              detail.getPromotionQualifiers().remove(pq);
 281                          } else {
 282                              pq.setItemCriteria(previousQualifierCriteria);
 283                              pq.setQuantity(pq.getQuantity() - qtyToMarkAsQualifier);
 284                          }
 285                      }
 286                  }
 287              }
 288  
 289              if (qualifierQtyNeeded == 0) {
 290                  break;
 291              }
 292          }
 293          return qualifierQtyNeeded;
 294      }
 295  
 296      @Override
<abbr title=" 297      public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails) {"> 297      public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItðŸ”µ</abbr>
 298          for (PromotableOrderItemPriceDetail itemPriceDetail : itemPriceDetails) {
 299              for (PromotionDiscount discount : itemPriceDetail.getPromotionDiscounts()) {
 300                  if (discount.getPromotion().equals(itemOffer.getOffer())) {
<abbr title=" 301                      if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 301                      if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWithOtherOðŸ”µ</abbr>
 302                          // We&#x27;ve decided to apply this adjustment but if it doesn&#x27;t actually reduce
 303                          // the value of the item
 304                          if (adjustmentIsNotGoodEnoughToBeApplied(itemOffer, itemPriceDetail)) {
 305                              break;
 306                          }
 307  
 308                      }
 309                      OrderItem orderItem = itemPriceDetail.getPromotableOrderItem().getOrderItem();
 310                      Boolean offerCanApplyToChildOrderItems = itemOffer.getOffer().getApplyToChildItems();
 311                      if (isAddOnOrderItem(orderItem) &amp;&amp; !offerCanApplyToChildOrderItems) {
 312                          break;
 313                      }
 314                      applyOrderItemAdjustment(itemOffer, itemPriceDetail);
 315                      break;
 316                  }
 317              }
 318          }
 319      }
 320  
 321      @Override
 322      public boolean isAddOnOrderItem(OrderItem orderItem) {
 323          if (DiscreteOrderItem.class.isAssignableFrom(orderItem.getClass())) {
 324              DiscreteOrderItem discreteOrderItem = (DiscreteOrderItem) orderItem;
 325  
 326              Map&lt;String, String&gt; attributes = discreteOrderItem.getAdditionalAttributes();
 327              boolean isAddOnOrderItem = attributes.containsKey(&quot;addOnXrefId&quot;);
 328              boolean isChildOrderItem = discreteOrderItem.isChildOrderItem();
 329  
 330              return isChildOrderItem &amp;&amp; isAddOnOrderItem;
 331          }
 332          return false;
 333      }
 334  
 335      /**
 336       * The adjustment might not be better than the sale price.
 337       * @param itemOffer
 338       * @param detail
 339       * @return
 340       */
 341      protected boolean adjustmentIsNotGoodEnoughToBeApplied(PromotableCandidateItemOffer itemOffer,
 342              PromotableOrderItemPriceDetail detail) {
 343          if (!itemOffer.getOffer().getApplyDiscountToSalePrice()) {
 344              Money salePrice = detail.getPromotableOrderItem().getSalePriceBeforeAdjustments();
 345              Money retailPrice = detail.getPromotableOrderItem().getRetailPriceBeforeAdjustments();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 346 -            Money savings = itemOffer.calculateSavingsForOrderItem(detail.getPromotableOrderItem(), 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 347 +            Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromotableOrderItem(), 1);"> 347 +            Money savings = promotableOfferUtility.calculateSavingsForOrderItem(itemOffer, detail.getPromotableOrdðŸ”µ</abbr></span>
 348              if (salePrice != null) {
 349                  if (salePrice.lessThan(retailPrice.subtract(savings))) {
 350                      // Not good enough
 351                      return true;
 352                  }
 353              }
 354          }
 355          return false;
 356      }
 357  
 358      @Override
 359      public void applyOrderItemAdjustment(PromotableCandidateItemOffer itemOffer,
 360              PromotableOrderItemPriceDetail itemPriceDetail) {
 361          PromotableOrderItemPriceDetailAdjustment promotableOrderItemPriceDetailAdjustment =
 362                  promotableItemFactory.createPromotableOrderItemPriceDetailAdjustment(itemOffer, itemPriceDetail);





 363          itemPriceDetail.addCandidateItemPriceDetailAdjustment(promotableOrderItemPriceDetailAdjustment);
 364      }
 365  
 366      @Override
 367      public List&lt;OrderItem&gt; buildOrderItemList(Order order) {
 368          List&lt;OrderItem&gt; orderItemList = new ArrayList&lt;OrderItem&gt;();
 369          for (OrderItem currentItem : order.getOrderItems()) {
 370              if (currentItem instanceof OrderItemContainer) {
 371                  OrderItemContainer container = (OrderItemContainer) currentItem;
 372                  if (container.isPricingAtContainerLevel()) {
 373                      orderItemList.add(currentItem);
 374                  } else {
 375                      for (OrderItem containedItem : container.getOrderItems()) {
 376                          orderItemList.add(containedItem);
 377                      }
 378                  }
 379              } else {
 380                  orderItemList.add(currentItem);
 381              }
 382          }
 383  
 384          return orderItemList;
 385      }
 386  
 387      @Override
 388      public Map&lt;OrderItem, PromotableOrderItem&gt; buildPromotableItemMap(PromotableOrder promotableOrder) {
 389          Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderItem&gt;();
 390          for (PromotableOrderItem item : promotableOrder.getAllOrderItems()) {
 391              promotableItemMap.put(item.getOrderItem(), item);
 392          }
 393          return promotableItemMap;
 394      }
 395  
 396      @Override
<abbr title=" 397      public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itemDetail) {"> 397      public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itemDetail)ðŸ”µ</abbr>
<abbr title=" 398          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 398          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetailAdjustðŸ”µ</abbr>
 399  
<abbr title=" 400          List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 400          List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;()ðŸ”µ</abbr>
 401          for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {
 402              if (itemAdjustmentMap.containsKey(adjustment.getOffer().getId())) {
 403                  if (LOG.isDebugEnabled()) {
 404                      StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with ids &quot;)
 405                          .append(itemAdjustmentMap.get(adjustment.getOffer().getId()).getId())
 406                          .append(&quot; and &quot;)
 407                          .append(adjustment.getId());
 408                      LOG.debug(sb.toString());
 409                  }
 410                  adjustmentsToRemove.add(adjustment);
 411              } else {
 412                  itemAdjustmentMap.put(adjustment.getOffer().getId(), adjustment);
 413              }
 414          }
 415  
 416          for (OrderItemPriceDetailAdjustment adjustment : adjustmentsToRemove) {
 417              itemDetail.getOrderItemPriceDetailAdjustments().remove(adjustment);
 418          }
 419  
 420          return itemAdjustmentMap;
 421      }
 422  
 423      @Override
 424      public void updatePriceDetail(OrderItemPriceDetail itemDetail,
 425              PromotableOrderItemPriceDetail promotableDetail) {
 426          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =
 427                  buildItemDetailAdjustmentMap(itemDetail);
 428  
 429          if (itemDetail.getQuantity() != promotableDetail.getQuantity()) {
 430              itemDetail.setQuantity(promotableDetail.getQuantity());
 431          }
 432  
 433          if (promotableDetail.isAdjustmentsFinalized()) {
 434              itemDetail.setUseSalePrice(promotableDetail.useSaleAdjustments());
 435          }
 436  
<abbr title=" 437          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjustments()) {"> 437          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjustments())ðŸ”µ</abbr>
 438              OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferId());
 439              if (itemAdjustment != null) {
 440                  // Update existing adjustment
 441                  if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {
 442                      updateItemAdjustment(itemAdjustment, adjustment);
 443                  }
 444              } else {
 445                  // Add a new adjustment
 446                  final OrderItemPriceDetailAdjustment newItemAdjustment;
 447                  ExtensionResultHolder resultHolder = new ExtensionResultHolder();
 448  
 449                  if (extensionManager != null) {
 450                      extensionManager.createOrderItemPriceDetailAdjustment(resultHolder, itemDetail);
 451                  }
<abbr title=" 452                  if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetailAdjustment&quot;)) {"> 452                  if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetailAdjustmeðŸ”µ</abbr>
<abbr title=" 453                      newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().get(&quot;OrderItemPriceDetailAdjustment&quot;);"> 453                      newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().get(&quot;OrderItðŸ”µ</abbr>
 454                  } else {
 455                      newItemAdjustment = offerDao.createOrderItemPriceDetailAdjustment();
 456                  }
 457                  newItemAdjustment.init(itemDetail, adjustment.getOffer(), null);
 458                  updateItemAdjustment(newItemAdjustment, adjustment);
 459                  itemDetail.getOrderItemPriceDetailAdjustments().add(newItemAdjustment);
 460              }
 461          }
 462  
 463          if (itemAdjustmentMap.size() &gt; 0) {
 464              // Remove adjustments that were on the order item but no longer needed.
 465              List&lt;Long&gt; adjustmentIdsToRemove = new ArrayList&lt;Long&gt;();
 466              for (OrderItemPriceDetailAdjustment adjustmentToRemove : itemAdjustmentMap.values()) {
 467                  adjustmentIdsToRemove.add(adjustmentToRemove.getOffer().getId());
 468              }
 469  
<abbr title=" 470              Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustments().iterator();"> 470              Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustments().itðŸ”µ</abbr>
 471              while (iterator.hasNext()) {
 472                  OrderItemPriceDetailAdjustment adj = iterator.next();
 473                  if (adjustmentIdsToRemove.contains(adj.getOffer().getId())) {
 474                      iterator.remove();

 475                  }
 476              }
 477          }
 478      }
 479  
 480      protected void updateItemAdjustment(OrderItemPriceDetailAdjustment itemAdjustment,
 481              PromotableOrderItemPriceDetailAdjustment promotableAdjustment) {
 482          itemAdjustment.setValue(promotableAdjustment.getAdjustmentValue());
 483          itemAdjustment.setSalesPriceValue(promotableAdjustment.getSaleAdjustmentValue());
 484          itemAdjustment.setRetailPriceValue(promotableAdjustment.getRetailAdjustmentValue());
 485          itemAdjustment.setAppliedToSalePrice(promotableAdjustment.isAppliedToSalePrice());
 486      }
 487  
 488      @Override
 489      public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMap,
 490              Iterator&lt;? extends OrderItemPriceDetail&gt; pdIterator) {
 491          while (pdIterator.hasNext()) {
 492              OrderItemPriceDetail currentDetail = pdIterator.next();
 493              if (unmatchedDetailsMap.containsKey(currentDetail.getId())) {
 494                  pdIterator.remove();

 495              }
 496          }
 497      }
 498  
 499      @Override
 500      public void removeUnmatchedQualifiers(Map&lt;Long, ? extends OrderItemQualifier&gt; unmatchedQualifiersMap,
 501              Iterator&lt;? extends OrderItemQualifier&gt; qIterator) {
 502          while (qIterator.hasNext()) {
 503              OrderItemQualifier currentQualifier = qIterator.next();
 504              if (unmatchedQualifiersMap.containsKey(currentQualifier.getId())) {
 505                  qIterator.remove();

 506              }
 507          }
 508      }
 509  
 510      @Override
<abbr title=" 511      public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; qualifiersMap) {"> 511      public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCðŸ”µ</abbr>
 512          Money qualifyingItemSubTotal = offer.getQualifyingItemSubTotal();
 513          if (qualifyingItemSubTotal == null || qualifyingItemSubTotal.lessThanOrEqual(Money.ZERO)) {
 514              return true;
 515          }
 516          return orderMeetsProvidedSubtotalRequirement(offer, qualifiersMap, qualifyingItemSubTotal);
 517      }
 518  
 519      @Override
<abbr title=" 520      public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; targetsMap) {"> 520      public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteðŸ”µ</abbr>
 521          Money targetMinSubTotal = offer.getTargetMinSubTotal();
 522          if (targetMinSubTotal == null || targetMinSubTotal.lessThanOrEqual(Money.ZERO)) {
 523              return true;
 524          }
 525          return orderMeetsProvidedSubtotalRequirement(offer, targetsMap, targetMinSubTotal);
 526      }
 527  
<abbr title=" 528      protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; promotableOrderItems, Money minSubTotal) {"> 528      protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotablðŸ”µ</abbr>
 529          Money subtotal = Money.ZERO;
 530  
 531          for (OfferItemCriteria itemCriteria : promotableOrderItems.keySet()) {
 532              List&lt;PromotableOrderItem&gt; promotableItems = promotableOrderItems.get(itemCriteria);
 533  
 534              for (PromotableOrderItem item : promotableItems) {
 535                  boolean shouldApplyDiscountToSalePrice = offer.getApplyDiscountToSalePrice();
 536                  Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrice);
 537                  int quantity = item.getQuantity();
 538  
 539                  Money lineItemAmount = priceBeforeAdjustments.multiply(quantity);
 540                  subtotal = subtotal.add(lineItemAmount);
 541                  if (subtotal.greaterThanOrEqual(minSubTotal)) {
 542                      return true;
 543                  }
 544              }
 545          }
 546  
 547          return false;
 548      }
 549  
 550      @Override
 551      public boolean orderMeetsSubtotalRequirements(PromotableOrder order, Offer offer) {
 552          Money orderMinSubTotal = offer.getOrderMinSubTotal();
 553          return orderMinSubTotal == null
 554                  || orderMinSubTotal.lessThanOrEqual(Money.ZERO)
 555                  || orderMinSubTotal.lessThanOrEqual(order.getOrder().getSubTotal());
 556      }
 557  
 558      public PromotableItemFactory getPromotableItemFactory() {
 559          return promotableItemFactory;
 560      }
 561  
 562      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 563          this.promotableItemFactory = promotableItemFactory;
 564      }
 565  
 566      public OfferDao getOfferDao() {
 567          return offerDao;
 568      }
 569  
 570      public void setOfferDao(OfferDao offerDao) {
 571          this.offerDao = offerDao;
 572      }
 573  







 574  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.offer.service;
  19  
  20  import org.apache.commons.logging.Log;
  21  import org.apache.commons.logging.LogFactory;
  22  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  23  import org.broadleafcommerce.common.money.Money;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import org.broadleafcommerce.common.service.GenericEntityService;</span>
  25  import org.broadleafcommerce.core.offer.dao.OfferDao;
  26  import org.broadleafcommerce.core.offer.domain.Offer;
  27  import org.broadleafcommerce.core.offer.domain.OfferItemCriteria;

  28  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  29  import org.broadleafcommerce.core.offer.service.discount.PromotionDiscount;
  30  import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;
  31  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;
  32  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;

  33  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  34  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  35  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;
  36  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;
  37  import org.broadleafcommerce.core.offer.service.processor.ItemOfferMarkTargets;
  38  import org.broadleafcommerce.core.order.domain.DiscreteOrderItem;
  39  import org.broadleafcommerce.core.order.domain.Order;
  40  import org.broadleafcommerce.core.order.domain.OrderItem;
  41  import org.broadleafcommerce.core.order.domain.OrderItemContainer;
  42  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  43  import org.broadleafcommerce.core.order.domain.OrderItemQualifier;
  44  import org.broadleafcommerce.core.order.domain.dto.OrderItemHolder;
  45  import org.springframework.stereotype.Service;
  46  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import java.math.BigDecimal;</span>
  48  import java.util.ArrayList;
  49  import java.util.Collections;
  50  import java.util.Comparator;
  51  import java.util.HashMap;
  52  import java.util.Iterator;
  53  import java.util.List;
  54  import java.util.Map;
  55  
  56  import javax.annotation.Resource;
  57  
  58  /**
  59   *
  60   * @author bpolster
  61   *
  62   */
  63  @Service(&quot;blOfferServiceUtilities&quot;)
  64  public class OfferServiceUtilitiesImpl implements OfferServiceUtilities {
  65      protected static final Log LOG = LogFactory.getLog(OfferServiceUtilitiesImpl.class);
  66  
  67      @Resource(name = &quot;blPromotableItemFactory&quot;)
  68      protected PromotableItemFactory promotableItemFactory;
  69  
  70      @Resource(name = &quot;blOfferDao&quot;)
  71      protected OfferDao offerDao;
  72  
  73      @Resource(name = &quot;blOfferServiceExtensionManager&quot;)
  74      protected OfferServiceExtensionManager extensionManager;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +    @Resource(name = &quot;blGenericEntityService&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +    protected GenericEntityService entityService;</span>



  78  
  79      @Override
<abbr title="  80      public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  80      public void sortTargetItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrðŸ”µ</abbr>
  81          Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));
  82      }
  83  
  84      @Override
<abbr title="  85      public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalePrice) {">  85      public void sortQualifierItemDetails(List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails, boolean applyToSalðŸ”µ</abbr>
  86          Collections.sort(itemPriceDetails, getPromotableItemComparator(applyToSalePrice));
  87      }
  88  
<abbr title="  89      protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyToSalePrice) {">  89      protected Comparator&lt;PromotableOrderItemPriceDetail&gt; getPromotableItemComparator(final boolean applyToSalePricðŸ”µ</abbr>
  90          return new Comparator&lt;PromotableOrderItemPriceDetail&gt;() {
  91  
  92              @Override
  93              public int compare(PromotableOrderItemPriceDetail o1, PromotableOrderItemPriceDetail o2) {
  94                  Money price = o1.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);
  95                  Money price2 = o2.getPromotableOrderItem().getPriceBeforeAdjustments(applyToSalePrice);
  96  
  97                  // highest amount first
  98                  return price2.compareTo(price);
  99              }
 100          };
 101      }
 102  
 103      @Override
 104      public OrderItem findRelatedQualifierRoot(OrderItem relatedQualifier) {
 105          OrderItem relatedQualifierRoot = null;
 106          if (relatedQualifier != null) {
 107              relatedQualifierRoot = relatedQualifier;
 108              while (relatedQualifierRoot.getParentOrderItem() != null) {
 109                  relatedQualifierRoot = relatedQualifierRoot.getParentOrderItem();
 110              }
 111          }
 112          return relatedQualifierRoot;
 113      }
 114  
 115      @Override
<abbr title=" 116      public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; details) {"> 116      public boolean itemOfferCanBeApplied(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetaðŸ”µ</abbr>
 117  
 118          for (PromotableOrderItemPriceDetail detail : details) {
 119              for (PromotableOrderItemPriceDetailAdjustment adjustment : detail.getCandidateItemAdjustments()) {
 120                  if (adjustment.isTotalitarian() || itemOffer.getOffer().isTotalitarianOffer()) {
 121                      // A totalitarian offer has already been applied or this offer is totalitarian
 122                      // and another offer was already applied.
 123                      return false;
 124                  } else if (!adjustment.isCombinable() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {
 125                      // A nonCombinable offer has been applied or this is a non-combinable offer
 126                      // and adjustments have already been applied.
 127                      return false;
 128                  }
 129              }
 130          }
 131          return true;
 132      }
 133  
 134      @Override
 135      public int markQualifiersForCriteria(PromotableCandidateItemOffer itemOffer, OfferItemCriteria itemCriteria,
 136              List&lt;PromotableOrderItemPriceDetail&gt; priceDetails) {
 137  
 138          sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());
 139  
 140          // Calculate the number of qualifiers needed that will not receive the promotion.
 141          // These will be reserved first before the target is assigned.
 142          int qualifierQtyNeeded = itemCriteria.getQuantity();
 143  
 144          for (PromotableOrderItemPriceDetail detail : priceDetails) {
 145  
 146              // Mark Qualifiers
 147              if (qualifierQtyNeeded &gt; 0) {
<abbr title=" 148                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 148                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOfferðŸ”µ</abbr>
 149                  if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {
 150                      int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);
 151                      qualifierQtyNeeded -= qtyToMarkAsQualifier;
 152                      detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);
 153                  }
 154              }
 155  
 156              if (qualifierQtyNeeded == 0) {
 157                  break;
 158              }
 159          }
 160          return qualifierQtyNeeded;
 161      }
 162  
 163      @Override
 164      public int markTargetsForCriteria(PromotableCandidateItemOffer itemOffer, OrderItem relatedQualifier,
 165              boolean checkOnly, Offer promotion, OrderItem relatedQualifierRoot, OfferItemCriteria itemCriteria,
 166              List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, int targetQtyNeeded) {
 167          for (PromotableOrderItemPriceDetail priceDetail : priceDetails) {
 168              if (relatedQualifier != null) {
<abbr title=" 169                  // We need to make sure that this item is either a parent, child, or the same as the qualifier root"> 169                  // We need to make sure that this item is either a parent, child, or the same as the qualifier rooðŸ”µ</abbr>
 170                  OrderItem thisItem = priceDetail.getPromotableOrderItem().getOrderItem();
 171                  if (!relatedQualifierRoot.isAParentOf(thisItem) &amp;&amp; !thisItem.isAParentOf(relatedQualifierRoot) &amp;&amp;
 172                          !thisItem.equals(relatedQualifierRoot)) {
 173                      continue;
 174                  }
 175              }
 176  
 177              int itemQtyAvailableToBeUsedAsTarget = priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);
 178              if (itemQtyAvailableToBeUsedAsTarget &gt; 0) {
<abbr title=" 179                  if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) {"> 179                  if (promotion.isUnlimitedUsePerOrder() || (itemOffer.getUses() &lt; promotion.getMaxUsesPerOrder())) ðŸ”µ</abbr>
 180                      int qtyToMarkAsTarget = Math.min(targetQtyNeeded, itemQtyAvailableToBeUsedAsTarget);
 181                      targetQtyNeeded -= qtyToMarkAsTarget;
 182                      if (!checkOnly) {
 183                          priceDetail.addPromotionDiscount(itemOffer, itemCriteria, qtyToMarkAsTarget);
 184                      }
 185                  }
 186              }
 187  
 188              if (targetQtyNeeded == 0) {
 189                  break;
 190              }
 191          }
 192          return targetQtyNeeded;






































 193      }
 194  
 195      @Override
<abbr title=" 196      public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, PromotableOrder order,"> 196      public int markRelatedQualifiersAndTargetsForItemCriteria(PromotableCandidateItemOffer itemOffer, PromotableOrðŸ”µ</abbr>
 197              OrderItemHolder orderItemHolder, OfferItemCriteria itemCriteria,
 198              List&lt;PromotableOrderItemPriceDetail&gt; priceDetails, ItemOfferMarkTargets itemOfferMarkTargets) {
 199          sortQualifierItemDetails(priceDetails, itemOffer.getOffer().getApplyDiscountToSalePrice());
 200  
 201          // Calculate the number of qualifiers needed that will not receive the promotion.
 202          // These will be reserved first before the target is assigned.
 203          int qualifierQtyNeeded = itemCriteria.getQuantity();
 204  
 205          for (PromotableOrderItemPriceDetail detail : priceDetails) {
 206              OrderItem oi = detail.getPromotableOrderItem().getOrderItem();
 207  
 208              if (qualifierQtyNeeded &gt; 0) {
<abbr title=" 209                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOffer);"> 209                  int itemQtyAvailableToBeUsedAsQualifier = detail.getQuantityAvailableToBeUsedAsQualifier(itemOfferðŸ”µ</abbr>
 210                  if (itemQtyAvailableToBeUsedAsQualifier &gt; 0) {
<abbr title=" 211                      // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some state that we"> 211                      // We have found a qualifier that meets this offer criteria. First, we&#x27;ll save some state thatðŸ”µ</abbr>
 212                      // might need in the future.
 213                      OfferItemCriteria previousQualifierCriteria = null;
 214                      for (PromotionQualifier possibleQualifier : detail.getPromotionQualifiers()) {
 215                          if (possibleQualifier.getPromotion().equals(itemOffer.getOffer())) {
 216                              previousQualifierCriteria = possibleQualifier.getItemCriteria();
 217                              break;
 218                          }
 219                      }
 220  
 221                      // Go ahead and mark this item as a qualifier
 222                      int qtyToMarkAsQualifier = Math.min(qualifierQtyNeeded, itemQtyAvailableToBeUsedAsQualifier);
 223                      qualifierQtyNeeded -= qtyToMarkAsQualifier;
<abbr title=" 224                      PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualifier);"> 224                      PromotionQualifier pq = detail.addPromotionQualifier(itemOffer, itemCriteria, qtyToMarkAsQualiðŸ”µ</abbr>
<abbr title=" 225                      pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOffer().getApplyDiscountToSalePrice()));"> 225                      pq.setPrice(detail.getPromotableOrderItem().getPriceBeforeAdjustments(itemOffer.getOffer().getðŸ”µ</abbr>
 226  
 227                      // Now, we need to see if there exists a target(s) that is suitable for this qualifier due to
 228                      // the relationship flag. If we are on the last qualifier required for this offer, we want to
 229                      // actually go ahead and mark the target that we&#x27;ll be using. Otherwise, we just want to check
 230                      // that there is an eligible target(s) and continue on.
 231                      if (itemOfferMarkTargets.markTargets(itemOffer, order, oi, true)) {
 232                          // We found a target. Let&#x27;s save this related order item used as the qualifier in case
 233                          // we succeed
 234                          orderItemHolder.setOrderItem(oi);
 235                      } else {
<abbr title=" 236                          // If we didn&#x27;t find a target, we need to roll back how we marked this item as a qualifier."> 236                          // If we didn&#x27;t find a target, we need to roll back how we marked this item as a qualifierðŸ”µ</abbr>
 237                          qualifierQtyNeeded += qtyToMarkAsQualifier;
 238                          if (pq.getQuantity() == qtyToMarkAsQualifier) {
 239                              detail.getPromotionQualifiers().remove(pq);
 240                          } else {
 241                              pq.setItemCriteria(previousQualifierCriteria);
 242                              pq.setQuantity(pq.getQuantity() - qtyToMarkAsQualifier);
 243                          }
 244                      }
 245                  }
 246              }
 247  
 248              if (qualifierQtyNeeded == 0) {
 249                  break;
 250              }
 251          }
 252          return qualifierQtyNeeded;
 253      }
 254  
 255      @Override
<abbr title=" 256      public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItemPriceDetail&gt; itemPriceDetails) {"> 256      public void applyAdjustmentsForItemPriceDetails(PromotableCandidateItemOffer itemOffer, List&lt;PromotableOrderItðŸ”µ</abbr>
 257          for (PromotableOrderItemPriceDetail itemPriceDetail : itemPriceDetails) {
 258              for (PromotionDiscount discount : itemPriceDetail.getPromotionDiscounts()) {
 259                  if (discount.getPromotion().equals(itemOffer.getOffer())) {
<abbr title=" 260                      if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWithOtherOffers()) {"> 260                      if (itemOffer.getOffer().isTotalitarianOffer() || !itemOffer.getOffer().isCombinableWithOtherOðŸ”µ</abbr>
 261                          // We&#x27;ve decided to apply this adjustment but if it doesn&#x27;t actually reduce
 262                          // the value of the item
 263                          if (adjustmentIsNotGoodEnoughToBeApplied(itemOffer, itemPriceDetail)) {
 264                              break;
 265                          }
 266  
 267                      }
 268                      OrderItem orderItem = itemPriceDetail.getPromotableOrderItem().getOrderItem();
 269                      Boolean offerCanApplyToChildOrderItems = itemOffer.getOffer().getApplyToChildItems();
 270                      if (isAddOnOrderItem(orderItem) &amp;&amp; !offerCanApplyToChildOrderItems) {
 271                          break;
 272                      }
 273                      applyOrderItemAdjustment(itemOffer, itemPriceDetail);
 274                      break;
 275                  }
 276              }
 277          }
 278      }
 279  
 280      @Override
 281      public boolean isAddOnOrderItem(OrderItem orderItem) {
 282          if (DiscreteOrderItem.class.isAssignableFrom(orderItem.getClass())) {
 283              DiscreteOrderItem discreteOrderItem = (DiscreteOrderItem) orderItem;
 284  
 285              Map&lt;String, String&gt; attributes = discreteOrderItem.getAdditionalAttributes();
 286              boolean isAddOnOrderItem = attributes.containsKey(&quot;addOnXrefId&quot;);
 287              boolean isChildOrderItem = discreteOrderItem.isChildOrderItem();
 288  
 289              return isChildOrderItem &amp;&amp; isAddOnOrderItem;
 290          }
 291          return false;
 292      }
 293  
 294      /**
 295       * The adjustment might not be better than the sale price.
 296       * @param itemOffer
 297       * @param detail
 298       * @return
 299       */
 300      protected boolean adjustmentIsNotGoodEnoughToBeApplied(PromotableCandidateItemOffer itemOffer,
 301              PromotableOrderItemPriceDetail detail) {
 302          if (!itemOffer.getOffer().getApplyDiscountToSalePrice()) {
 303              Money salePrice = detail.getPromotableOrderItem().getSalePriceBeforeAdjustments();
 304              Money retailPrice = detail.getPromotableOrderItem().getRetailPriceBeforeAdjustments();
 305              Money savings = itemOffer.calculateSavingsForOrderItem(detail.getPromotableOrderItem(), 1);

 306              if (salePrice != null) {
 307                  if (salePrice.lessThan(retailPrice.subtract(savings))) {
 308                      // Not good enough
 309                      return true;
 310                  }
 311              }
 312          }
 313          return false;
 314      }
 315  
 316      @Override
 317      public void applyOrderItemAdjustment(PromotableCandidateItemOffer itemOffer,
 318              PromotableOrderItemPriceDetail itemPriceDetail) {
 319          PromotableOrderItemPriceDetailAdjustment promotableOrderItemPriceDetailAdjustment =
 320                  promotableItemFactory.createPromotableOrderItemPriceDetailAdjustment(itemOffer, itemPriceDetail);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +        //don&#x27;t want to have negative adjustments</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +        if(promotableOrderItemPriceDetailAdjustment.getRetailAdjustmentValue().lessThan(BigDecimal.ZERO) ||</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +                promotableOrderItemPriceDetailAdjustment.getSaleAdjustmentValue().lessThan(BigDecimal.ZERO)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +        }</span>
 326          itemPriceDetail.addCandidateItemPriceDetailAdjustment(promotableOrderItemPriceDetailAdjustment);
 327      }
 328  
 329      @Override
 330      public List&lt;OrderItem&gt; buildOrderItemList(Order order) {
 331          List&lt;OrderItem&gt; orderItemList = new ArrayList&lt;OrderItem&gt;();
 332          for (OrderItem currentItem : order.getOrderItems()) {
 333              if (currentItem instanceof OrderItemContainer) {
 334                  OrderItemContainer container = (OrderItemContainer) currentItem;
 335                  if (container.isPricingAtContainerLevel()) {
 336                      orderItemList.add(currentItem);
 337                  } else {
 338                      for (OrderItem containedItem : container.getOrderItems()) {
 339                          orderItemList.add(containedItem);
 340                      }
 341                  }
 342              } else {
 343                  orderItemList.add(currentItem);
 344              }
 345          }
 346  
 347          return orderItemList;
 348      }
 349  
 350      @Override
 351      public Map&lt;OrderItem, PromotableOrderItem&gt; buildPromotableItemMap(PromotableOrder promotableOrder) {
 352          Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = new HashMap&lt;OrderItem, PromotableOrderItem&gt;();
 353          for (PromotableOrderItem item : promotableOrder.getAllOrderItems()) {
 354              promotableItemMap.put(item.getOrderItem(), item);
 355          }
 356          return promotableItemMap;
 357      }
 358  
 359      @Override
<abbr title=" 360      public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itemDetail) {"> 360      public Map&lt;Long, OrderItemPriceDetailAdjustment&gt; buildItemDetailAdjustmentMap(OrderItemPriceDetail itemDetail)ðŸ”µ</abbr>
<abbr title=" 361          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 361          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap = new HashMap&lt;Long, OrderItemPriceDetailAdjustðŸ”µ</abbr>
 362  
<abbr title=" 363          List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 363          List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;()ðŸ”µ</abbr>
 364          for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {
 365              if (itemAdjustmentMap.containsKey(adjustment.getOffer().getId())) {
 366                  if (LOG.isDebugEnabled()) {
 367                      StringBuilder sb = new StringBuilder(&quot;Detected collisions for item adjustments with ids &quot;)
 368                          .append(itemAdjustmentMap.get(adjustment.getOffer().getId()).getId())
 369                          .append(&quot; and &quot;)
 370                          .append(adjustment.getId());
 371                      LOG.debug(sb.toString());
 372                  }
 373                  adjustmentsToRemove.add(adjustment);
 374              } else {
 375                  itemAdjustmentMap.put(adjustment.getOffer().getId(), adjustment);
 376              }
 377          }
 378  
 379          for (OrderItemPriceDetailAdjustment adjustment : adjustmentsToRemove) {
 380              itemDetail.getOrderItemPriceDetailAdjustments().remove(adjustment);
 381          }
 382  
 383          return itemAdjustmentMap;
 384      }
 385  
 386      @Override
 387      public void updatePriceDetail(OrderItemPriceDetail itemDetail,
 388              PromotableOrderItemPriceDetail promotableDetail) {
 389          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =
 390                  buildItemDetailAdjustmentMap(itemDetail);
 391  
 392          if (itemDetail.getQuantity() != promotableDetail.getQuantity()) {
 393              itemDetail.setQuantity(promotableDetail.getQuantity());
 394          }
 395  
 396          if (promotableDetail.isAdjustmentsFinalized()) {
 397              itemDetail.setUseSalePrice(promotableDetail.useSaleAdjustments());
 398          }
 399  
<abbr title=" 400          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjustments()) {"> 400          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableDetail.getCandidateItemAdjustments())ðŸ”µ</abbr>
 401              OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.remove(adjustment.getOfferId());
 402              if (itemAdjustment != null) {
 403                  // Update existing adjustment
 404                  if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {
 405                      updateItemAdjustment(itemAdjustment, adjustment);
 406                  }
 407              } else {
 408                  // Add a new adjustment
 409                  final OrderItemPriceDetailAdjustment newItemAdjustment;
 410                  ExtensionResultHolder resultHolder = new ExtensionResultHolder();
 411  
 412                  if (extensionManager != null) {
 413                      extensionManager.createOrderItemPriceDetailAdjustment(resultHolder, itemDetail);
 414                  }
<abbr title=" 415                  if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetailAdjustment&quot;)) {"> 415                  if (resultHolder != null &amp;&amp; resultHolder.getContextMap().containsKey(&quot;OrderItemPriceDetailAdjustmeðŸ”µ</abbr>
<abbr title=" 416                      newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().get(&quot;OrderItemPriceDetailAdjustment&quot;);"> 416                      newItemAdjustment = (OrderItemPriceDetailAdjustment) resultHolder.getContextMap().get(&quot;OrderItðŸ”µ</abbr>
 417                  } else {
 418                      newItemAdjustment = offerDao.createOrderItemPriceDetailAdjustment();
 419                  }
 420                  newItemAdjustment.init(itemDetail, adjustment.getOffer(), null);
 421                  updateItemAdjustment(newItemAdjustment, adjustment);
 422                  itemDetail.getOrderItemPriceDetailAdjustments().add(newItemAdjustment);
 423              }
 424          }
 425  
 426          if (itemAdjustmentMap.size() &gt; 0) {
 427              // Remove adjustments that were on the order item but no longer needed.
 428              List&lt;Long&gt; adjustmentIdsToRemove = new ArrayList&lt;Long&gt;();
 429              for (OrderItemPriceDetailAdjustment adjustmentToRemove : itemAdjustmentMap.values()) {
 430                  adjustmentIdsToRemove.add(adjustmentToRemove.getOffer().getId());
 431              }
 432  
<abbr title=" 433              Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustments().iterator();"> 433              Iterator&lt;OrderItemPriceDetailAdjustment&gt; iterator = itemDetail.getOrderItemPriceDetailAdjustments().itðŸ”µ</abbr>
 434              while (iterator.hasNext()) {
 435                  OrderItemPriceDetailAdjustment adj = iterator.next();
 436                  if (adjustmentIdsToRemove.contains(adj.getOffer().getId())) {
 437                      iterator.remove();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 438 +                    entityService.remove(adj);</span>
 439                  }
 440              }
 441          }
 442      }
 443  
 444      protected void updateItemAdjustment(OrderItemPriceDetailAdjustment itemAdjustment,
 445              PromotableOrderItemPriceDetailAdjustment promotableAdjustment) {
 446          itemAdjustment.setValue(promotableAdjustment.getAdjustmentValue());
 447          itemAdjustment.setSalesPriceValue(promotableAdjustment.getSaleAdjustmentValue());
 448          itemAdjustment.setRetailPriceValue(promotableAdjustment.getRetailAdjustmentValue());
 449          itemAdjustment.setAppliedToSalePrice(promotableAdjustment.isAppliedToSalePrice());
 450      }
 451  
 452      @Override
 453      public void removeUnmatchedPriceDetails(Map&lt;Long, ? extends OrderItemPriceDetail&gt; unmatchedDetailsMap,
 454              Iterator&lt;? extends OrderItemPriceDetail&gt; pdIterator) {
 455          while (pdIterator.hasNext()) {
 456              OrderItemPriceDetail currentDetail = pdIterator.next();
 457              if (unmatchedDetailsMap.containsKey(currentDetail.getId())) {
 458                  pdIterator.remove();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 459 +                entityService.remove(currentDetail);</span>
 460              }
 461          }
 462      }
 463  
 464      @Override
 465      public void removeUnmatchedQualifiers(Map&lt;Long, ? extends OrderItemQualifier&gt; unmatchedQualifiersMap,
 466              Iterator&lt;? extends OrderItemQualifier&gt; qIterator) {
 467          while (qIterator.hasNext()) {
 468              OrderItemQualifier currentQualifier = qIterator.next();
 469              if (unmatchedQualifiersMap.containsKey(currentQualifier.getId())) {
 470                  qIterator.remove();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 471 +                entityService.remove(currentQualifier);</span>
 472              }
 473          }
 474      }
 475  
 476      @Override
<abbr title=" 477      public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; qualifiersMap) {"> 477      public boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCðŸ”µ</abbr>
 478          Money qualifyingItemSubTotal = offer.getQualifyingItemSubTotal();
 479          if (qualifyingItemSubTotal == null || qualifyingItemSubTotal.lessThanOrEqual(Money.ZERO)) {
 480              return true;
 481          }
 482          return orderMeetsProvidedSubtotalRequirement(offer, qualifiersMap, qualifyingItemSubTotal);
 483      }
 484  
 485      @Override
<abbr title=" 486      public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; targetsMap) {"> 486      public boolean orderMeetsTargetSubtotalRequirements(PromotableOrder order, Offer offer, HashMap&lt;OfferItemCriteðŸ”µ</abbr>
 487          Money targetMinSubTotal = offer.getTargetMinSubTotal();
 488          if (targetMinSubTotal == null || targetMinSubTotal.lessThanOrEqual(Money.ZERO)) {
 489              return true;
 490          }
 491          return orderMeetsProvidedSubtotalRequirement(offer, targetsMap, targetMinSubTotal);
 492      }
 493  
<abbr title=" 494      protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotableOrderItem&gt;&gt; promotableOrderItems, Money minSubTotal) {"> 494      protected boolean orderMeetsProvidedSubtotalRequirement(Offer offer, HashMap&lt;OfferItemCriteria, List&lt;PromotablðŸ”µ</abbr>
 495          Money subtotal = Money.ZERO;
 496  
 497          for (OfferItemCriteria itemCriteria : promotableOrderItems.keySet()) {
 498              List&lt;PromotableOrderItem&gt; promotableItems = promotableOrderItems.get(itemCriteria);
 499  
 500              for (PromotableOrderItem item : promotableItems) {
 501                  boolean shouldApplyDiscountToSalePrice = offer.getApplyDiscountToSalePrice();
 502                  Money priceBeforeAdjustments = item.getPriceBeforeAdjustments(shouldApplyDiscountToSalePrice);
 503                  int quantity = item.getQuantity();
 504  
 505                  Money lineItemAmount = priceBeforeAdjustments.multiply(quantity);
 506                  subtotal = subtotal.add(lineItemAmount);
 507                  if (subtotal.greaterThanOrEqual(minSubTotal)) {
 508                      return true;
 509                  }
 510              }
 511          }
 512  
 513          return false;
 514      }
 515  
 516      @Override
 517      public boolean orderMeetsSubtotalRequirements(PromotableOrder order, Offer offer) {
 518          Money orderMinSubTotal = offer.getOrderMinSubTotal();
 519          return orderMinSubTotal == null
 520                  || orderMinSubTotal.lessThanOrEqual(Money.ZERO)
 521                  || orderMinSubTotal.lessThanOrEqual(order.getOrder().getSubTotal());
 522      }
 523  
 524      public PromotableItemFactory getPromotableItemFactory() {
 525          return promotableItemFactory;
 526      }
 527  
 528      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 529          this.promotableItemFactory = promotableItemFactory;
 530      }
 531  
 532      public OfferDao getOfferDao() {
 533          return offerDao;
 534      }
 535  
 536      public void setOfferDao(OfferDao offerDao) {
 537          this.offerDao = offerDao;
 538      }
 539  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 540 +    public GenericEntityService getGenericEntityService() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 541 +        return entityService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 542 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 543 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 544 +    public void setGenericEntityService(GenericEntityService entityService) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 545 +        this.entityService = entityService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 546 +    }</span>
 547  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            