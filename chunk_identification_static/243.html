<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>243</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    243
                    <a href="242.html">prev</a>
                    <a href="244.html">next</a>
                    <a href="243_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_bd01ec244a4deb5017acbb8fcaa766701c0c8cac_common/src/main/java/org/broadleafcommerce/common/i18n/service/TranslationServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;bd01ec244a4deb5017acbb8fcaa766701c0c8cac:common/src/main/java/org/broadleafcommerce/common/i18n/service/TranslationServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;bd01ec244a4deb5017acbb8fcaa766701c0c8cac^1:common/src/main/java/org/broadleafcommerce/common/i18n/service/TranslationServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;bd01ec244a4deb5017acbb8fcaa766701c0c8cac^2:common/src/main/java/org/broadleafcommerce/common/i18n/service/TranslationServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;27fb8aeb76208048099aab14c546c94639b2a4ef:common/src/main/java/org/broadleafcommerce/common/i18n/service/TranslationServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [s]], subset: [[bj], [s]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.i18n.service;
  19 
  20 import org.apache.commons.lang3.StringUtils;
  21 import org.apache.commons.logging.Log;
  22 import org.apache.commons.logging.LogFactory;
  23 import org.broadleafcommerce.common.cache.StatisticsService;
  24 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  25 import org.broadleafcommerce.common.extension.ItemStatus;
  26 import org.broadleafcommerce.common.extension.ResultType;
  27 import org.broadleafcommerce.common.extension.StandardCacheItem;
  28 import org.broadleafcommerce.common.i18n.dao.TranslationDao;
  29 import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  30 import org.broadleafcommerce.common.i18n.domain.Translation;
  31 import org.broadleafcommerce.common.i18n.domain.TranslationImpl;
  32 import org.broadleafcommerce.common.locale.service.LocaleService;
  33 import org.broadleafcommerce.common.locale.util.LocaleUtil;
  34 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  35 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  36 import org.springframework.beans.factory.annotation.Value;
  37 import org.springframework.stereotype.Service;
  38 import org.springframework.transaction.annotation.Transactional;
  39 
  40 import java.util.ArrayList;
  41 import java.util.List;
  42 import java.util.Locale;
  43 import java.util.Map;
  44 import java.util.Map.Entry;
  45 
  46 import javax.annotation.Resource;
  47 import javax.cache.Cache;
  48 import javax.cache.CacheManager;
  49 
  50 @Service(&quot;blTranslationService&quot;)
  51 public class TranslationServiceImpl implements TranslationService, TranslationSupport {
  52 
  53     protected static final Log LOG = LogFactory.getLog(TranslationServiceImpl.class);
  54     private static final Translation DELETED_TRANSLATION = new TranslationImpl();
  55     private static final String TRANSLATION_CACHE_NAME = &quot;blTranslationElements&quot;;
  56     
  57     @Resource(name = &quot;blTranslationDao&quot;)
  58     protected TranslationDao dao;
  59 
  60     @Resource(name=&quot;blStatisticsService&quot;)
  61     protected StatisticsService statisticsService;
  62 
  63     @Resource(name=&quot;blSandBoxHelper&quot;)
  64     protected SandBoxHelper sandBoxHelper;
  65     
  66     @Resource(name=&quot;blTranslationServiceExtensionManager&quot;)
  67     protected TranslationServiceExtensionManager extensionManager;
  68 
  69     /**
  70      * The default is 1000. Use the &#x27;translation.thresholdForFullCache&#x27; to change the value.
  71      */
  72     @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  73     protected int thresholdForFullCache;
  74 
  75     /**
  76      * The default is 1000. This property also uses &#x27;translation.thresholdForFullCache&#x27; for
  77      * backwards compatibility. If you wish to change this value, you&#x27;ll need to extend
<abbr title="  78      * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholdForFullCache()}">  78      * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholðŸ”µ</abbr>
  79      */
  80     @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  81     protected int templateThresholdForFullCache;
  82 
  83     @Value(&quot;${returnBlankTranslationForNotDefaultLocale:false}&quot;)
  84     protected boolean returnBlankTranslationForNotDefaultLocale;
  85 
  86     @Resource(name = &quot;blTranslationExceptionProperties&quot;)
  87     protected List&lt;String&gt; translationExceptionProperties = new ArrayList&lt;String&gt;();
  88 
  89     @Resource(name = &quot;blLocaleService&quot;)
  90     protected LocaleService localeService;
  91 
  92     @Resource
  93     protected List&lt;TranslationOverrideStrategy&gt; strategies;
  94     
  95     @Resource(name = &quot;blCacheManager&quot;)
  96     protected CacheManager cacheManager;
  97     
  98     protected Cache&lt;String, Object&gt; cache;
  99     
 100     @Override
 101     @Transactional(&quot;blTransactionManager&quot;)
 102     public Translation save(Translation translation) {
 103         return dao.save(translation);
 104     }
 105     
 106     @Override
 107     @Transactional(&quot;blTransactionManager&quot;)
 108     public Translation save(String entityType, String entityId, String fieldName, String localeCode, 
 109             String translatedValue) {
 110         TranslatedEntity te = getAssignableEntityType(entityType);
 111         
 112         Translation translation = getTranslation(te, entityId, fieldName, localeCode);
 113         
 114         if (translation == null) {
 115             translation = dao.create();
 116             translation.setEntityType(te);
 117             translation.setEntityId(entityId);
 118             translation.setFieldName(fieldName);
 119             translation.setLocaleCode(localeCode);
 120         }
 121         
 122         translation.setTranslatedValue(translatedValue);
 123         return save(translation);
 124     }
 125 
 126     @Override
 127     public Translation findTranslationById(Long id) {
 128         return dao.readTranslationById(id);
 129     }
 130     
 131     @Override
 132     @Transactional(&quot;blTransactionManager&quot;)
 133     public Translation update(Long translationId, String localeCode, String translatedValue) {
 134         Translation t = dao.readTranslationById(translationId);
 135         
<abbr title=" 136         // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it if it exists"> 136         // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it ifðŸ”µ</abbr>
<abbr title=" 137         Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeCode);"> 137         Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeðŸ”µ</abbr>
 138         if (t2 != null &amp;&amp; t != t2) {
 139             dao.delete(t2);
 140         }
 141         
 142         t.setLocaleCode(localeCode);
 143         t.setTranslatedValue(translatedValue);
 144         return save(t);
 145     }
 146     
 147     @Override
 148     @Transactional(&quot;blTransactionManager&quot;)
 149     public void deleteTranslationById(Long translationId) {
 150         Translation t = dao.readTranslationById(translationId);
 151         dao.delete(t);
 152     }
 153     
 154     @Override
<abbr title=" 155     public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String localeCode) {"> 155     public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String ðŸ”µ</abbr>
 156         return dao.readTranslation(entity, entityId, fieldName, localeCode);
 157     }
 158     
 159     @Override
<abbr title=" 160     public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String property) {"> 160     public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String propeðŸ”µ</abbr>
 161         TranslatedEntity entityType = getAssignableEntityType(ceilingEntityClassname);
 162         return dao.readTranslations(entityType, entityId, property);
 163     }
 164 
 165     @Override
 166     public Cache&lt;String, Object&gt; getCache() {
 167         if (cache == null) {
 168             synchronized (this) {
 169                 if (cache == null) {
 170                     cache = cacheManager.getCache(getCacheName());
 171                 }
 172             }
 173         }
 174         return cache;
 175     }
 176 
 177     protected String getCacheName() {
 178         return TRANSLATION_CACHE_NAME;
 179     }
 180 
 181     @Override
 182     public String getTranslatedValue(Object entity, String property, Locale locale) {
 183         String localeCode = locale.getLanguage();
 184         String localeCountryCode = localeCode;
 185         if (StringUtils.isNotBlank(locale.getCountry())) {
 186             localeCountryCode += &quot;_&quot; + locale.getCountry();
 187         }
 188 
 189         if (!shouldTranslateLocale(localeCountryCode)) {
 190             return null;
 191         }
 192 
 193         TranslatedEntity entityType = getEntityType(entity);
 194         String entityId = dao.getEntityId(entityType, entity);
 195         
 196         if (TranslationBatchReadCache.hasCache()) {
<abbr title=" 197             Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, property, localeCountryCode);"> 197             Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, properðŸ”µ</abbr>
 198             if (translation != null) {
 199                 return translation.getTranslatedValue();
 200             } else {
 201                 // There is no translation for this entity if it is not in the cache
 202                 return null;
 203             }
 204         }
 205         
 206         boolean isValidForCache = false;
 207         if (extensionManager != null) {
 208             ExtensionResultHolder&lt;Boolean&gt; response = new ExtensionResultHolder&lt;Boolean&gt;();
 209             response.setResult(false);
 210             extensionManager.getProxy().isValidState(response);
 211             isValidForCache = response.getResult();
 212         }
<abbr title=" 213         if (!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox() || !isValidForCache) {"> 213         if (!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox() || !isValidForCacðŸ”µ</abbr>
<abbr title=" 214             Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, localeCountryCode,"> 214             Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, locðŸ”µ</abbr>
 215                     ResultType.CATALOG_ONLY);
 216             if (translation != null) {
 217                 return translation.getTranslatedValue();
 218             } else {
 219                 return null;
 220             }
 221         }
 222 
 223         return getOverrideTranslatedValue(property, entityType, entityId, localeCode, localeCountryCode);
 224     }
 225 
 226     /**
 227      * Whether translations should be gathered for the provided locale.
 228      *
 229      * @param localeCode
 230      * @return Whether translations should be gathered for the provided locale.
 231      */
 232     protected boolean shouldTranslateLocale(String localeCode) {
<abbr title=" 233         org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCode);"> 233         org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCðŸ”µ</abbr>
 234 
 235         if (locale == null) {
 236 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 237             throw new IllegalArgumentException(&quot;A locale could not be found for the provided localeCode: &quot;+ localeCode);"> 237             throw new IllegalArgumentException(&quot;A locale could not be found for the provided localeCode: ðŸ”µ</abbr></span>
 238 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 239                             getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType());"> 239                             getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType())ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240                     for (String key: cacheKeysList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241                         LOG.debug(&quot;Removing key [&quot; + key + &quot;] for TEMPLATE site&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242                         getCache().remove(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249     protected String getOverrideTranslatedValue(String property, TranslatedEntity entityType,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 250                                                 String entityId, String localeCode, String localeCountryCode) {"> 250                                                 String entityId, String localeCode, String localeCountryCðŸ”µ</abbr></span>
 251 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252             LOG.warn(&quot;A locale could not be found for the provided localeCode: &quot;+ localeCode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253             return true;</span>
 254 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 255         }
 256 
 257         return !locale.getDefaultFlag();
 258     }
 259 
 260     @Override
 261     public void removeTranslationFromCache(Translation translation) {
 262         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 263             ResultType resultType = ResultType.STANDARD;
 264             if (extensionManager != null) {
 265                 ExtensionResultHolder&lt;ResultType&gt; response = new ExtensionResultHolder&lt;ResultType&gt;();
 266                 extensionManager.getProxy().getResultType(translation, response);
 267                 resultType = response.getResult();
 268                 if (ResultType.STANDARD == resultType) {
 269                     String key = getCacheKey(resultType, translation.getEntityType());
 270                     LOG.debug(&quot;Removing key [&quot; + key + &quot;] for STANDARD site&quot;);
 271                     getCache().remove(key);
 272                 } else {
 273                     List&lt;String&gt; cacheKeysList =
<abbr title=" 274                             getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType());"> 274                             getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType())ðŸ”µ</abbr>
 275                     for (String key: cacheKeysList) {
 276                         LOG.debug(&quot;Removing key [&quot; + key + &quot;] for TEMPLATE site&quot;);
 277                         getCache().remove(key);
 278                     }
 279                 }
 280             }
 281         }
 282     }
 283 
 284     protected String getOverrideTranslatedValue(String property, TranslatedEntity entityType,
<abbr title=" 285                                                 String entityId, String localeCode, String localeCountryCode) {"> 285                                                 String entityId, String localeCode, String localeCountryCðŸ”µ</abbr>
 286         boolean specificTranslationDeleted = false;
 287         boolean generalTranslationDeleted = false;
 288         StandardCacheItem specificTranslation = null;
 289         StandardCacheItem generalTranslation = null;
 290         String specificPropertyKey = property + &quot;_&quot; + localeCountryCode;
 291         String generalPropertyKey = property + &quot;_&quot; + localeCode;
 292         String response = null;
 293         String cacheKey = getCacheKey(ResultType.STANDARD, entityType);
 294         LocalePair override = null;
 295         for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 296             override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeCountryCode, cacheKey);"> 296             override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeðŸ”µ</abbr>
 297             if(override != null) {
 298                 specificTranslation = override.getSpecificItem();
 299                 generalTranslation = override.getGeneralItem();
 300                 break;
 301             }
 302         }
 303         if (override == null) {
<abbr title=" 304             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 304             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return ðŸ”µ</abbr>
 305         }
 306 
 307         if (specificTranslation != null) {
 308             if (ItemStatus.DELETED.equals(specificTranslation.getItemStatus())) {
 309                 specificTranslationDeleted = true;
 310             } else {
 311                 if (specificTranslation.getCacheItem() instanceof Translation) {
 312                     response = ((Translation) specificTranslation.getCacheItem()).getTranslatedValue();
 313                 } else {
 314                     response = (String) specificTranslation.getCacheItem();
 315                 }
 316                 return replaceEmptyWithNullResponse(response);
 317             }
 318         }
 319 
 320         if (generalTranslation != null) {
 321             if (ItemStatus.DELETED.equals(generalTranslation.getItemStatus())) {
 322                 generalTranslationDeleted = true;
 323                 //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 324                 //If the general translation is override deleted and we&#x27;ve only got a general local code - we&#x27;re done"> 324                 //If the general translation is override deleted and we&#x27;ve only got a general local code ðŸ”µ</abbr>
 325                 if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 326                     return null;
 327                 }
 328             } else {
 329                 if (generalTranslation.getCacheItem() instanceof Translation) {
 330                     response = ((Translation) generalTranslation.getCacheItem()).getTranslatedValue();
 331                 } else {
 332                     response = (String) generalTranslation.getCacheItem();
 333                 }
 334                 //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 335                 //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re done"> 335                 //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re ðŸ”µ</abbr>
 336                 if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 337                     return replaceEmptyWithNullResponse(response);
 338                 }
 339                 //We have a valid general override - don&#x27;t check for general template value
 340                 generalTranslationDeleted = true;
 341             }
 342         }
 343 
 344         // Check for a Template Match
 345         if (specificTranslationDeleted) {
<abbr title=" 346             // only check general properties since we explicitly deleted specific properties at standard (site) level"> 346             // only check general properties since we explicitly deleted specific properties at standard ðŸ”µ</abbr>
 347             specificPropertyKey = generalPropertyKey;
 348         } else if (generalTranslationDeleted) {
<abbr title=" 349             // only check specific properties since we explicitly deleted general properties at standard (site) level"> 349             // only check specific properties since we explicitly deleted general properties at standard ðŸ”µ</abbr>
 350             generalPropertyKey = specificPropertyKey;
 351         }
 352 
<abbr title=" 353         String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, localeCode,"> 353         String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, loðŸ”µ</abbr>
 354                     localeCountryCode, specificPropertyKey, generalPropertyKey);
 355         if (templateResponse != null) {
 356             response = templateResponse;
 357         }
 358         return response;
 359     }
 360 
 361     protected String replaceEmptyWithNullResponse(String response) {
 362         if (!StringUtils.isEmpty(response)) {
 363             return response;
 364         }
 365         return null;
 366     }
 367 
<abbr title=" 368     protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntity entityType,"> 368     protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntitðŸ”µ</abbr>
<abbr title=" 369                         String entityId, String localeCode, String localeCountryCode, String specificPropertyKey, String generalPropertyKey) {"> 369                         String entityId, String localeCode, String localeCountryCode, String specificPropðŸ”µ</abbr>
 370         String cacheKey = getCacheKey(ResultType.TEMPLATE, entityType);
 371         StandardCacheItem translation = null;
 372         LocalePair override = null;
 373         for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 374             override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, localeCode, localeCountryCode, specificPropertyKey, generalPropertyKey);"> 374             override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, locðŸ”µ</abbr>
 375             if(override != null) {
 376                 translation = override.getSpecificItem();
 377                 if (!strategy.validateTemplateProcessing(standardCacheKey, cacheKey)) {
 378                     return null;
 379                 }
 380                 break;
 381             }
 382         }
 383         if (override == null) {
<abbr title=" 384             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 384             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return ðŸ”µ</abbr>
 385         }
<abbr title=" 386         return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheItem()).getTranslatedValue());"> 386         return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheIteðŸ”µ</abbr>
 387     }
 388 
 389     @Override
 390     public StandardCacheItem lookupTranslationFromMap(String key,
 391             Map&lt;String, Map&lt;String, StandardCacheItem&gt;&gt; propertyTranslationMap, String entityId) {
 392 
 393         StandardCacheItem cacheItem = null;
 394         if (propertyTranslationMap.containsKey(key)) {
 395             Map&lt;String, StandardCacheItem&gt; byEntity = propertyTranslationMap.get(key);
 396             cacheItem = byEntity.get(entityId);
 397         }
 398         return cacheItem;
 399     }
 400 
 401     @Override
<abbr title=" 402     public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey, Map&lt;String, Map&lt;String, Translation&gt;&gt; propertyTranslationMap, String entityId) {"> 402     public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey,ðŸ”µ</abbr>
 403         Translation translation = null;
 404         if (propertyTranslationMap.containsKey(specificPropertyKey)) {
 405             Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(specificPropertyKey);
 406             translation = byEntity.get(entityId);
 407         }
 408         if (translation == null &amp;&amp; propertyTranslationMap.containsKey(generalPropertyKey)) {
 409             Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(generalPropertyKey);
 410             translation = byEntity.get(entityId);
 411         }
 412         return translation;
 413     }
 414     
 415     protected TranslatedEntity getEntityType(Class&lt;?&gt; entityClass) {
 416         for (Entry&lt;String, TranslatedEntity&gt; entry : TranslatedEntity.getTypes().entrySet()) {
 417             try {
 418                 Class&lt;?&gt; clazz = Class.forName(entry.getKey());
 419                 if (clazz.isAssignableFrom(entityClass)) {
 420                     return entry.getValue();
 421                 }
 422             } catch (ClassNotFoundException e) {
<abbr title=" 423                 throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, e);"> 423                 throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, ðŸ”µ</abbr>
 424             }
 425         }
 426         throw new IllegalArgumentException(entityClass.getName() + &quot; is not a known translatable class&quot;);
 427     }
 428     
 429     protected TranslatedEntity getEntityType(Object entity) {
 430         return getEntityType(entity.getClass());
 431     }
 432     
 433     @Override
 434     public TranslatedEntity getAssignableEntityType(String className) {
 435         try {
 436             Class&lt;?&gt; clazz = Class.forName(className);
 437             return getEntityType(clazz);
 438         } catch (ClassNotFoundException e) {
 439             throw new IllegalArgumentException(className + &quot; is not a known translatable class&quot;);
 440         }
 441     }
 442 
 443     @Override
 444     public String getCacheKey(ResultType resultType, TranslatedEntity entityType) {
 445         String cacheKey = StringUtils.join(new String[] { entityType.getFriendlyType()}, &quot;|&quot;);
 446         if (extensionManager != null) {
 447             ExtensionResultHolder&lt;String&gt; result = new ExtensionResultHolder&lt;String&gt;();
 448             extensionManager.getProxy().getCacheKey(cacheKey, resultType, result);
 449             if (result.getResult() != null) {
 450                 cacheKey = result.getResult();
 451             }
 452         }
 453         return cacheKey;
 454     }
 455 
 456     @Override
 457     public List&lt;String&gt; getCacheKeyListForTemplateSite(String propertyName) {
 458         List&lt;String&gt; cacheKeyList = new ArrayList&lt;&gt;();
 459         String cacheKey = StringUtils.join(new String[] {propertyName}, &quot;|&quot;);
 460         if (extensionManager != null) {
 461             ExtensionResultHolder&lt;List&lt;String&gt;&gt; result = new ExtensionResultHolder&lt;List&lt;String&gt;&gt;();
 462             extensionManager.getProxy().getCacheKeyListForTemplateSite(cacheKey, result);
 463             if (result.getResult() != null) {
 464                 cacheKeyList = result.getResult();
 465             }
 466         }
 467         return cacheKeyList;
 468     }
 469 
 470     @Override
 471     public int getThresholdForFullCache() {
 472         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 473             return thresholdForFullCache;
 474         } else {
 475             // don&#x27;t cache when not in a SandBox
 476             return -1;
 477         }
 478     }
 479 
 480     @Override
 481     public void setThresholdForFullCache(int thresholdForFullCache) {
 482         this.thresholdForFullCache = thresholdForFullCache;
 483     }
 484 
 485     @Override
 486     public int getTemplateThresholdForFullCache() {
 487         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 488             return templateThresholdForFullCache;
 489         } else {
 490             // don&#x27;t cache when not in a SandBox
 491             return -1;
 492         }
 493     }
 494 
 495     @Override
 496     public void setTemplateThresholdForFullCache(int templateThresholdForFullCache) {
 497         this.templateThresholdForFullCache = templateThresholdForFullCache;
 498     }
 499 
 500     @Override
 501     public String getDefaultTranslationValue(Object entity, String property, Locale locale,
 502             String requestedDefaultValue) {
 503 
 504         if (returnBlankTranslationForNotDefaultLocale
 505                 &amp;&amp; !localeMatchesDefaultLocale(locale)
 506                 &amp;&amp; !propertyInDefaultLocaleExceptionList(entity, property)) {
 507             return &quot;&quot;;
 508         }
 509 
 510         return requestedDefaultValue;
 511     }
 512 
 513     @Override
<abbr title=" 514     public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType standard, List&lt;String&gt; entityIds) {"> 514     public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType stanðŸ”µ</abbr>
 515         return dao.readAllTranslationEntries(translatedEntity, standard, entityIds);
 516     }
 517 
 518     /**
 519      * Returns true if the passed in entity / property combination is in the defaultLocaleExceptionList
 520      * 
 521      * The default implementation checks the &quot;translationExceptionProperties&quot; list to see if the
 522      * property matches one of the regularExpressions in that list.
 523      * 
 524      * Implementors are expected to override this method for implementation specific needs. 
 525      * 
 526      * @param entity
 527      * @param property
 528      * @return
 529      */
 530     protected boolean propertyInDefaultLocaleExceptionList(Object entity, String property) {
 531         TranslatedEntity entityType = getEntityType(entity);
 532         if (entityType != null &amp;&amp; entityType.getFriendlyType() != null) {
 533             for (String exceptionProperty : translationExceptionProperties) {
 534                 if (property.matches(exceptionProperty)) {
 535                     return true;
 536                 }
 537             }
 538         }
 539         return false;
 540     }
 541 
 542     /**
 543      * Returns true if the passed in locale&#x27;s language matches the Broadleaf default locale.
 544      * @param locale
 545      * @return
 546      */
 547     protected boolean localeMatchesDefaultLocale(Locale locale) {
 548         String defaultLanguage = LocaleUtil.findLanguageCode(localeService.findDefaultLocale());
 549 
 550         if (defaultLanguage != null &amp;&amp; locale != null) {
 551             return defaultLanguage.equals(locale.getLanguage());
 552         }
 553         return false;
 554     }
 555 
 556 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.i18n.service;
  19 
  20 import org.apache.commons.lang3.StringUtils;
  21 import org.apache.commons.logging.Log;
  22 import org.apache.commons.logging.LogFactory;
  23 import org.broadleafcommerce.common.cache.StatisticsService;
  24 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  25 import org.broadleafcommerce.common.extension.ItemStatus;
  26 import org.broadleafcommerce.common.extension.ResultType;
  27 import org.broadleafcommerce.common.extension.StandardCacheItem;
  28 import org.broadleafcommerce.common.i18n.dao.TranslationDao;
  29 import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  30 import org.broadleafcommerce.common.i18n.domain.Translation;
  31 import org.broadleafcommerce.common.i18n.domain.TranslationImpl;
  32 import org.broadleafcommerce.common.locale.service.LocaleService;
  33 import org.broadleafcommerce.common.locale.util.LocaleUtil;
  34 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  35 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  36 import org.springframework.beans.factory.annotation.Value;
  37 import org.springframework.stereotype.Service;
  38 import org.springframework.transaction.annotation.Transactional;
  39 
  40 import java.util.ArrayList;
  41 import java.util.List;
  42 import java.util.Locale;
  43 import java.util.Map;
  44 import java.util.Map.Entry;
  45 
  46 import javax.annotation.Resource;
  47 import javax.cache.Cache;
  48 import javax.cache.CacheManager;
  49 
  50 @Service(&quot;blTranslationService&quot;)
  51 public class TranslationServiceImpl implements TranslationService, TranslationSupport {
  52 
  53     protected static final Log LOG = LogFactory.getLog(TranslationServiceImpl.class);
  54     private static final Translation DELETED_TRANSLATION = new TranslationImpl();
  55     private static final String TRANSLATION_CACHE_NAME = &quot;blTranslationElements&quot;;
  56 
  57     @Resource(name = &quot;blTranslationDao&quot;)
  58     protected TranslationDao dao;
  59 
  60     @Resource(name=&quot;blStatisticsService&quot;)
  61     protected StatisticsService statisticsService;
  62 
  63     @Resource(name=&quot;blSandBoxHelper&quot;)
  64     protected SandBoxHelper sandBoxHelper;
  65 
  66     protected Cache&lt;String, Object&gt; cache;
  67 
  68     @Resource(name=&quot;blTranslationServiceExtensionManager&quot;)
  69     protected TranslationServiceExtensionManager extensionManager;
  70 
  71     /**
  72      * The default is 1000. Use the &#x27;translation.thresholdForFullCache&#x27; to change the value.
  73      */
  74     @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  75     protected int thresholdForFullCache;
  76 
  77     /**
  78      * The default is 1000. This property also uses &#x27;translation.thresholdForFullCache&#x27; for
  79      * backwards compatibility. If you wish to change this value, you&#x27;ll need to extend
<abbr title="  80      * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholdForFullCache()}">  80      * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholðŸ”µ</abbr>
  81      */
  82     @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  83     protected int templateThresholdForFullCache;
  84 
  85     @Value(&quot;${returnBlankTranslationForNotDefaultLocale:false}&quot;)
  86     protected boolean returnBlankTranslationForNotDefaultLocale;
  87 
  88     @Resource(name = &quot;blTranslationExceptionProperties&quot;)
  89     protected List&lt;String&gt; translationExceptionProperties = new ArrayList&lt;String&gt;();
  90 
  91     @Resource(name = &quot;blLocaleService&quot;)
  92     protected LocaleService localeService;
  93 
  94     @Resource
  95     protected List&lt;TranslationOverrideStrategy&gt; strategies;
  96 
  97     @Resource(name = &quot;blCacheManager&quot;)
  98     protected CacheManager cacheManager;
  99 
 100     @Override
 101     @Transactional(&quot;blTransactionManager&quot;)
 102     public Translation save(Translation translation) {
 103         return dao.save(translation);
 104     }
 105 
 106     @Override
 107     @Transactional(&quot;blTransactionManager&quot;)
 108     public Translation save(String entityType, String entityId, String fieldName, String localeCode,
 109             String translatedValue) {
 110         TranslatedEntity te = getAssignableEntityType(entityType);
 111 
 112         Translation translation = getTranslation(te, entityId, fieldName, localeCode);
 113 
 114         if (translation == null) {
 115             translation = dao.create();
 116             translation.setEntityType(te);
 117             translation.setEntityId(entityId);
 118             translation.setFieldName(fieldName);
 119             translation.setLocaleCode(localeCode);
 120         }
 121 
 122         translation.setTranslatedValue(translatedValue);
 123         return save(translation);
 124     }
 125 
 126     @Override
 127     public Translation findTranslationById(Long id) {
 128         return dao.readTranslationById(id);
 129     }
 130 
 131     @Override
 132     @Transactional(&quot;blTransactionManager&quot;)
 133     public Translation update(Long translationId, String localeCode, String translatedValue) {
 134         Translation t = dao.readTranslationById(translationId);
 135 
<abbr title=" 136         // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it if it exists"> 136         // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it ifðŸ”µ</abbr>
<abbr title=" 137         Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeCode);"> 137         Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeðŸ”µ</abbr>
 138         if (t2 != null &amp;&amp; t != t2) {
 139             dao.delete(t2);
 140         }
 141 
 142         t.setLocaleCode(localeCode);
 143         t.setTranslatedValue(translatedValue);
 144         return save(t);
 145     }
 146 
 147     @Override
 148     @Transactional(&quot;blTransactionManager&quot;)
 149     public void deleteTranslationById(Long translationId) {
 150         Translation t = dao.readTranslationById(translationId);
 151         dao.delete(t);
 152     }
 153 
 154     @Override
<abbr title=" 155     public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String localeCode) {"> 155     public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String ðŸ”µ</abbr>
 156         return dao.readTranslation(entity, entityId, fieldName, localeCode);
 157     }
 158 
 159     @Override
<abbr title=" 160     public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String property) {"> 160     public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String propeðŸ”µ</abbr>
 161         TranslatedEntity entityType = getAssignableEntityType(ceilingEntityClassname);
 162         return dao.readTranslations(entityType, entityId, property);
 163     }
 164 
 165     @Override
 166     public Cache&lt;String, Object&gt; getCache() {
 167         if (cache == null) {
 168             synchronized (this) {
 169                 if (cache == null) {
 170                     cache = cacheManager.getCache(getCacheName());
 171                 }
 172             }
 173         }
 174         return cache;
 175     }
 176 
 177     protected String getCacheName() {
 178         return TRANSLATION_CACHE_NAME;
 179     }
 180 
 181     @Override
 182     public String getTranslatedValue(Object entity, String property, Locale locale) {
 183         String localeCode = locale.getLanguage();
 184         String localeCountryCode = localeCode;
 185         if (StringUtils.isNotBlank(locale.getCountry())) {
 186             localeCountryCode += &quot;_&quot; + locale.getCountry();
 187         }
 188 
 189         if (!shouldTranslateLocale(localeCountryCode)) {
 190             return null;
 191         }
 192 
 193         TranslatedEntity entityType = getEntityType(entity);
 194         String entityId = dao.getEntityId(entityType, entity);
 195 
 196         if (TranslationBatchReadCache.hasCache()) {
<abbr title=" 197             Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, property, localeCountryCode);"> 197             Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, properðŸ”µ</abbr>
 198             if (translation != null) {
 199                 return translation.getTranslatedValue();
 200             } else {
 201                 // There is no translation for this entity if it is not in the cache
 202                 return null;
 203             }
 204         }
 205 
 206         boolean isValidForCache = false;
 207         if (extensionManager != null) {
 208             ExtensionResultHolder&lt;Boolean&gt; response = new ExtensionResultHolder&lt;Boolean&gt;();
 209             response.setResult(false);
 210             extensionManager.getProxy().isValidState(response);
 211             isValidForCache = response.getResult();
 212         }
<abbr title=" 213         if (!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox() || !isValidForCache) {"> 213         if (!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox() || !isValidForCacðŸ”µ</abbr>
<abbr title=" 214             Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, localeCountryCode,"> 214             Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, locðŸ”µ</abbr>
 215                     ResultType.CATALOG_ONLY);
 216             if (translation != null) {
 217                 return translation.getTranslatedValue();
 218             } else {
 219                 return null;
 220             }
 221         }
 222 
 223         return getOverrideTranslatedValue(property, entityType, entityId, localeCode, localeCountryCode);
 224     }
 225 
 226     /**
 227      * Whether translations should be gathered for the provided locale.
 228      *
 229      * @param localeCode
 230      * @return Whether translations should be gathered for the provided locale.
 231      */
 232     protected boolean shouldTranslateLocale(String localeCode) {
<abbr title=" 233         org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCode);"> 233         org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCðŸ”µ</abbr>
 234 
 235         if (locale == null) {
 236 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 237             throw new IllegalArgumentException(&quot;A locale could not be found for the provided localeCode: &quot;+ localeCode);"> 237             throw new IllegalArgumentException(&quot;A locale could not be found for the provided localeCode: ðŸ”µ</abbr></span>
 238 ||||||| BASE
 239 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240             LOG.warn(&quot;A locale could not be found for the provided localeCode: &quot;+ localeCode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241             return true;</span>
 242 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 243         }
 244 
 245         return !locale.getDefaultFlag();
 246     }
 247 
 248     @Override
 249     public void removeTranslationFromCache(Translation translation) {
 250         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 251             ResultType resultType = ResultType.STANDARD;
 252             if (extensionManager != null) {
 253                 ExtensionResultHolder&lt;ResultType&gt; response = new ExtensionResultHolder&lt;ResultType&gt;();
 254                 extensionManager.getProxy().getResultType(translation, response);
 255                 resultType = response.getResult();
 256                 if (ResultType.STANDARD == resultType) {
 257                     String key = getCacheKey(resultType, translation.getEntityType());
 258                     LOG.debug(&quot;Removing key [&quot; + key + &quot;] for STANDARD site&quot;);
 259                     getCache().remove(key);
 260                 } else {
 261                     List&lt;String&gt; cacheKeysList =
<abbr title=" 262                             getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType());"> 262                             getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType())ðŸ”µ</abbr>
 263                     for (String key: cacheKeysList) {
 264                         LOG.debug(&quot;Removing key [&quot; + key + &quot;] for TEMPLATE site&quot;);
 265                         getCache().remove(key);
 266                     }
 267                 }
 268             }
 269         }
 270     }
 271 
 272     protected String getOverrideTranslatedValue(String property, TranslatedEntity entityType,
<abbr title=" 273                                                 String entityId, String localeCode, String localeCountryCode) {"> 273                                                 String entityId, String localeCode, String localeCountryCðŸ”µ</abbr>
 274         boolean specificTranslationDeleted = false;
 275         boolean generalTranslationDeleted = false;
 276         StandardCacheItem specificTranslation = null;
 277         StandardCacheItem generalTranslation = null;
 278         String specificPropertyKey = property + &quot;_&quot; + localeCountryCode;
 279         String generalPropertyKey = property + &quot;_&quot; + localeCode;
 280         String response = null;
 281         String cacheKey = getCacheKey(ResultType.STANDARD, entityType);
 282         LocalePair override = null;
 283         for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 284             override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeCountryCode, cacheKey);"> 284             override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeðŸ”µ</abbr>
 285             if(override != null) {
 286                 specificTranslation = override.getSpecificItem();
 287                 generalTranslation = override.getGeneralItem();
 288                 break;
 289             }
 290         }
 291         if (override == null) {
<abbr title=" 292             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 292             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return ðŸ”µ</abbr>
 293         }
 294 
 295         if (specificTranslation != null) {
 296             if (ItemStatus.DELETED.equals(specificTranslation.getItemStatus())) {
 297                 specificTranslationDeleted = true;
 298             } else {
 299                 if (specificTranslation.getCacheItem() instanceof Translation) {
 300                     response = ((Translation) specificTranslation.getCacheItem()).getTranslatedValue();
 301                 } else {
 302                     response = (String) specificTranslation.getCacheItem();
 303                 }
 304                 return replaceEmptyWithNullResponse(response);
 305             }
 306         }
 307 
 308         if (generalTranslation != null) {
 309             if (ItemStatus.DELETED.equals(generalTranslation.getItemStatus())) {
 310                 generalTranslationDeleted = true;
 311                 //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 312                 //If the general translation is override deleted and we&#x27;ve only got a general local code - we&#x27;re done"> 312                 //If the general translation is override deleted and we&#x27;ve only got a general local code ðŸ”µ</abbr>
 313                 if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 314                     return null;
 315                 }
 316             } else {
 317                 if (generalTranslation.getCacheItem() instanceof Translation) {
 318                     response = ((Translation) generalTranslation.getCacheItem()).getTranslatedValue();
 319                 } else {
 320                     response = (String) generalTranslation.getCacheItem();
 321                 }
 322                 //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 323                 //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re done"> 323                 //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re ðŸ”µ</abbr>
 324                 if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 325                     return replaceEmptyWithNullResponse(response);
 326                 }
 327                 //We have a valid general override - don&#x27;t check for general template value
 328                 generalTranslationDeleted = true;
 329             }
 330         }
 331 
 332         // Check for a Template Match
 333         if (specificTranslationDeleted) {
<abbr title=" 334             // only check general properties since we explicitly deleted specific properties at standard (site) level"> 334             // only check general properties since we explicitly deleted specific properties at standard ðŸ”µ</abbr>
 335             specificPropertyKey = generalPropertyKey;
 336         } else if (generalTranslationDeleted) {
<abbr title=" 337             // only check specific properties since we explicitly deleted general properties at standard (site) level"> 337             // only check specific properties since we explicitly deleted general properties at standard ðŸ”µ</abbr>
 338             generalPropertyKey = specificPropertyKey;
 339         }
 340 
<abbr title=" 341         String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, localeCode,"> 341         String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, loðŸ”µ</abbr>
 342                     localeCountryCode, specificPropertyKey, generalPropertyKey);
 343         if (templateResponse != null) {
 344             response = templateResponse;
 345         }
 346         return response;
 347     }
 348 
 349     protected String replaceEmptyWithNullResponse(String response) {
 350         if (!StringUtils.isEmpty(response)) {
 351             return response;
 352         }
 353         return null;
 354     }
 355 
<abbr title=" 356     protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntity entityType,"> 356     protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntitðŸ”µ</abbr>
<abbr title=" 357                         String entityId, String localeCode, String localeCountryCode, String specificPropertyKey, String generalPropertyKey) {"> 357                         String entityId, String localeCode, String localeCountryCode, String specificPropðŸ”µ</abbr>
 358         String cacheKey = getCacheKey(ResultType.TEMPLATE, entityType);
 359         StandardCacheItem translation = null;
 360         LocalePair override = null;
 361         for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 362             override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, localeCode, localeCountryCode, specificPropertyKey, generalPropertyKey);"> 362             override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, locðŸ”µ</abbr>
 363             if(override != null) {
 364                 translation = override.getSpecificItem();
 365                 if (!strategy.validateTemplateProcessing(standardCacheKey, cacheKey)) {
 366                     return null;
 367                 }
 368                 break;
 369             }
 370         }
 371         if (override == null) {
<abbr title=" 372             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 372             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return ðŸ”µ</abbr>
 373         }
<abbr title=" 374         return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheItem()).getTranslatedValue());"> 374         return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheIteðŸ”µ</abbr>
 375     }
 376 
 377     @Override
 378     public StandardCacheItem lookupTranslationFromMap(String key,
 379             Map&lt;String, Map&lt;String, StandardCacheItem&gt;&gt; propertyTranslationMap, String entityId) {
 380 
 381         StandardCacheItem cacheItem = null;
 382         if (propertyTranslationMap.containsKey(key)) {
 383             Map&lt;String, StandardCacheItem&gt; byEntity = propertyTranslationMap.get(key);
 384             cacheItem = byEntity.get(entityId);
 385         }
 386         return cacheItem;
 387     }
 388 
 389     @Override
<abbr title=" 390     public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey, Map&lt;String, Map&lt;String, Translation&gt;&gt; propertyTranslationMap, String entityId) {"> 390     public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey,ðŸ”µ</abbr>
 391         Translation translation = null;
 392         if (propertyTranslationMap.containsKey(specificPropertyKey)) {
 393             Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(specificPropertyKey);
 394             translation = byEntity.get(entityId);
 395         }
 396         if (translation == null &amp;&amp; propertyTranslationMap.containsKey(generalPropertyKey)) {
 397             Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(generalPropertyKey);
 398             translation = byEntity.get(entityId);
 399         }
 400         return translation;
 401     }
 402 
 403     protected TranslatedEntity getEntityType(Class&lt;?&gt; entityClass) {
 404         for (Entry&lt;String, TranslatedEntity&gt; entry : TranslatedEntity.getTypes().entrySet()) {
 405             try {
 406                 Class&lt;?&gt; clazz = Class.forName(entry.getKey());
 407                 if (clazz.isAssignableFrom(entityClass)) {
 408                     return entry.getValue();
 409                 }
 410             } catch (ClassNotFoundException e) {
<abbr title=" 411                 throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, e);"> 411                 throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, ðŸ”µ</abbr>
 412             }
 413         }
 414         throw new IllegalArgumentException(entityClass.getName() + &quot; is not a known translatable class&quot;);
 415     }
 416 
 417     protected TranslatedEntity getEntityType(Object entity) {
 418         return getEntityType(entity.getClass());
 419     }
 420 
 421     @Override
 422 public TranslatedEntity getAssignableEntityType(String className) {
 423         try {
 424             Class&lt;?&gt; clazz = Class.forName(className);
 425             return getEntityType(clazz);
 426         } catch (ClassNotFoundException e) {
 427             throw new IllegalArgumentException(className + &quot; is not a known translatable class&quot;);
 428         }
 429     }
 430 
 431     @Override
 432     public String getCacheKey(ResultType resultType, TranslatedEntity entityType) {
 433         String cacheKey = StringUtils.join(new String[] { entityType.getFriendlyType()}, &quot;|&quot;);
 434         if (extensionManager != null) {
 435             ExtensionResultHolder&lt;String&gt; result = new ExtensionResultHolder&lt;String&gt;();
 436             extensionManager.getProxy().getCacheKey(cacheKey, resultType, result);
 437             if (result.getResult() != null) {
 438                 cacheKey = result.getResult();
 439             }
 440         }
 441         return cacheKey;
 442     }
 443 
 444     @Override
 445     public List&lt;String&gt; getCacheKeyListForTemplateSite(String propertyName) {
 446         List&lt;String&gt; cacheKeyList = new ArrayList&lt;&gt;();
 447         String cacheKey = StringUtils.join(new String[] {propertyName}, &quot;|&quot;);
 448         if (extensionManager != null) {
 449             ExtensionResultHolder&lt;List&lt;String&gt;&gt; result = new ExtensionResultHolder&lt;List&lt;String&gt;&gt;();
 450             extensionManager.getProxy().getCacheKeyListForTemplateSite(cacheKey, result);
 451             if (result.getResult() != null) {
 452                 cacheKeyList = result.getResult();
 453             }
 454         }
 455         return cacheKeyList;
 456     }
 457 
 458     @Override
 459     public int getThresholdForFullCache() {
 460         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 461             return thresholdForFullCache;
 462         } else {
 463             // don&#x27;t cache when not in a SandBox
 464             return -1;
 465         }
 466     }
 467 
 468     @Override
 469     public void setThresholdForFullCache(int thresholdForFullCache) {
 470         this.thresholdForFullCache = thresholdForFullCache;
 471     }
 472 
 473     @Override
 474     public int getTemplateThresholdForFullCache() {
 475         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 476             return templateThresholdForFullCache;
 477         } else {
 478             // don&#x27;t cache when not in a SandBox
 479             return -1;
 480         }
 481     }
 482 
 483     @Override
 484     public void setTemplateThresholdForFullCache(int templateThresholdForFullCache) {
 485         this.templateThresholdForFullCache = templateThresholdForFullCache;
 486     }
 487 
 488     @Override
 489     public String getDefaultTranslationValue(Object entity, String property, Locale locale,
 490             String requestedDefaultValue) {
 491 
 492         if (returnBlankTranslationForNotDefaultLocale
 493                 &amp;&amp; !localeMatchesDefaultLocale(locale)
 494                 &amp;&amp; !propertyInDefaultLocaleExceptionList(entity, property)) {
 495             return &quot;&quot;;
 496         }
 497 
 498         return requestedDefaultValue;
 499     }
 500 
 501     @Override
<abbr title=" 502     public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType standard, List&lt;String&gt; entityIds) {"> 502     public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType stanðŸ”µ</abbr>
 503         return dao.readAllTranslationEntries(translatedEntity, standard, entityIds);
 504     }
 505 
 506     /**
 507      * Returns true if the passed in entity / property combination is in the defaultLocaleExceptionList
 508      *
 509      * The default implementation checks the &quot;translationExceptionProperties&quot; list to see if the
 510      * property matches one of the regularExpressions in that list.
 511      *
 512      * Implementors are expected to override this method for implementation specific needs.
 513      *
 514      * @param entity
 515      * @param property
 516      * @return
 517      */
 518     protected boolean propertyInDefaultLocaleExceptionList(Object entity, String property) {
 519         TranslatedEntity entityType = getEntityType(entity);
 520         if (entityType != null &amp;&amp; entityType.getFriendlyType() != null) {
 521             for (String exceptionProperty : translationExceptionProperties) {
 522                 if (property.matches(exceptionProperty)) {
 523                     return true;
 524                 }
 525             }
 526         }
 527         return false;
 528     }
 529 
 530     /**
 531      * Returns true if the passed in locale&#x27;s language matches the Broadleaf default locale.
 532      * @param locale
 533      * @return
 534      */
 535     protected boolean localeMatchesDefaultLocale(Locale locale) {
 536         String defaultLanguage = LocaleUtil.findLanguageCode(localeService.findDefaultLocale());
 537 
 538         if (defaultLanguage != null &amp;&amp; locale != null) {
 539             return defaultLanguage.equals(locale.getLanguage());
 540         }
 541         return false;
 542     }
 543 
 544 }
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.i18n.service;
  19 
  20 import java.util.ArrayList;
  21 import java.util.List;
  22 import java.util.Locale;
  23 import java.util.Map.Entry;
  24 import java.util.Map;
  25 import javax.annotation.Resource;
  26 import javax.cache.Cache;
  27 import javax.cache.CacheManager;
  28 import org.apache.commons.lang3.StringUtils;
  29 import org.apache.commons.logging.Log;
  30 import org.apache.commons.logging.LogFactory;
  31 import org.broadleafcommerce.common.cache.StatisticsService;
  32 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  33 import org.broadleafcommerce.common.extension.ItemStatus;
  34 import org.broadleafcommerce.common.extension.ResultType;
  35 import org.broadleafcommerce.common.extension.StandardCacheItem;
  36 import org.broadleafcommerce.common.i18n.dao.TranslationDao;
  37 import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  38 import org.broadleafcommerce.common.i18n.domain.Translation;
  39 import org.broadleafcommerce.common.i18n.domain.TranslationImpl;
  40 import org.broadleafcommerce.common.locale.service.LocaleService;
  41 import org.broadleafcommerce.common.locale.util.LocaleUtil;
  42 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  43 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  44 import org.springframework.beans.factory.annotation.Value;
  45 import org.springframework.stereotype.Service;
  46 import org.springframework.transaction.annotation.Transactional;
  47 
  48 
  49 @Service(&quot;blTranslationService&quot;)
  50 public class TranslationServiceImpl implements TranslationService , TranslationSupport {
  51     protected static final Log LOG = LogFactory.getLog(TranslationServiceImpl.class);
  52 
  53     private static final Translation DELETED_TRANSLATION = new TranslationImpl();
  54 
  55     private static final String TRANSLATION_CACHE_NAME = &quot;blTranslationElements&quot;;
  56 
  57     @Resource(name = &quot;blTranslationDao&quot;)
  58     protected TranslationDao dao;
  59 
  60     @Resource(name=&quot;blStatisticsService&quot;)
  61     protected StatisticsService statisticsService;
  62 
  63     @Resource(name=&quot;blSandBoxHelper&quot;)
  64     protected SandBoxHelper sandBoxHelper;
  65 
  66     @Resource(name=&quot;blTranslationServiceExtensionManager&quot;)
  67     protected TranslationServiceExtensionManager extensionManager;
  68 
  69     /**
  70      * The default is 1000. Use the &#x27;translation.thresholdForFullCache&#x27; to change the value.
  71      */
  72     @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  73     protected int thresholdForFullCache;
  74 
  75     /**
  76      * The default is 1000. This property also uses &#x27;translation.thresholdForFullCache&#x27; for
  77      * backwards compatibility. If you wish to change this value, you&#x27;ll need to extend
<abbr title="  78      * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholdForFullCache()}">  78      * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholðŸ”µ</abbr>
  79      */
  80     @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  81     protected int templateThresholdForFullCache;
  82 
  83     @Value(&quot;${returnBlankTranslationForNotDefaultLocale:false}&quot;)
  84     protected boolean returnBlankTranslationForNotDefaultLocale;
  85 
  86     @Resource(name = &quot;blTranslationExceptionProperties&quot;)
  87     protected List&lt;String&gt; translationExceptionProperties = new ArrayList&lt;String&gt;();
  88 
  89     @Resource(name = &quot;blLocaleService&quot;)
  90     protected LocaleService localeService;
  91 
  92     @Resource
  93     protected List&lt;TranslationOverrideStrategy&gt; strategies;
  94 
  95     @Resource(name = &quot;blCacheManager&quot;)
  96     protected CacheManager cacheManager;
  97 
  98     protected Cache&lt;String, Object&gt; cache;
  99 
 100     @Override
 101     @Transactional(&quot;blTransactionManager&quot;)
 102     public Translation save(Translation translation) {
 103         return dao.save(translation);
 104     }
 105 
 106     @Override
 107     @Transactional(&quot;blTransactionManager&quot;)
 108     public Translation save(String entityType, String entityId, String fieldName, String localeCode,
 109             String translatedValue) {
 110         TranslatedEntity te = getAssignableEntityType(entityType);
 111 
 112         Translation translation = getTranslation(te, entityId, fieldName, localeCode);
 113 
 114         if (translation == null) {
 115             translation = dao.create();
 116             translation.setEntityType(te);
 117             translation.setEntityId(entityId);
 118             translation.setFieldName(fieldName);
 119             translation.setLocaleCode(localeCode);
 120         }
 121 
 122         translation.setTranslatedValue(translatedValue);
 123         return save(translation);
 124     }
 125 
 126     @Override
 127     public Translation findTranslationById(Long id) {
 128         return dao.readTranslationById(id);
 129     }
 130 
 131     @Override
 132     @Transactional(&quot;blTransactionManager&quot;)
 133     public Translation update(Long translationId, String localeCode, String translatedValue) {
 134         Translation t = dao.readTranslationById(translationId);
 135 
<abbr title=" 136         // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it if it exists"> 136         // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it ifðŸ”µ</abbr>
<abbr title=" 137         Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeCode);"> 137         Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeðŸ”µ</abbr>
 138         if (t2 != null &amp;&amp; t != t2) {
 139             dao.delete(t2);
 140         }
 141 
 142         t.setLocaleCode(localeCode);
 143         t.setTranslatedValue(translatedValue);
 144         return save(t);
 145     }
 146 
 147     @Override
 148     @Transactional(&quot;blTransactionManager&quot;)
 149     public void deleteTranslationById(Long translationId) {
 150         Translation t = dao.readTranslationById(translationId);
 151         dao.delete(t);
 152     }
 153 
 154     @Override
<abbr title=" 155     public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String localeCode) {"> 155     public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String ðŸ”µ</abbr>
 156         return dao.readTranslation(entity, entityId, fieldName, localeCode);
 157     }
 158 
 159     @Override
<abbr title=" 160     public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String property) {"> 160     public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String propeðŸ”µ</abbr>
 161         TranslatedEntity entityType = getAssignableEntityType(ceilingEntityClassname);
 162         return dao.readTranslations(entityType, entityId, property);
 163     }
 164 
 165     @Override
 166     public Cache&lt;String, Object&gt; getCache() {
 167         if (cache == null) {
 168             synchronized(this) {
 169                 if (cache == null) {
 170                     cache = cacheManager.getCache(getCacheName());
 171                 }
 172             }
 173         }
 174         return cache;
 175     }
 176 
 177     protected String getCacheName() {
 178         return TRANSLATION_CACHE_NAME;
 179     }
 180 
 181     @Override
 182     public String getTranslatedValue(Object entity, String property, Locale locale) {
 183         String localeCode = locale.getLanguage();
 184         String localeCountryCode = localeCode;
 185         if (StringUtils.isNotBlank(locale.getCountry())) {
 186             localeCountryCode += &quot;_&quot; + locale.getCountry();
 187         }
 188         if (!shouldTranslateLocale(localeCountryCode)) {
 189             return null;
 190         }
 191         TranslatedEntity entityType = getEntityType(entity);
 192         String entityId = dao.getEntityId(entityType, entity);
 193         if (TranslationBatchReadCache.hasCache()) {
<abbr title=" 194             Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, property, localeCountryCode);"> 194             Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, properðŸ”µ</abbr>
 195             if (translation != null) {
 196                 return translation.getTranslatedValue();
 197             } else {
 198                 // There is no translation for this entity if it is not in the cache
 199                 return null;
 200             }
 201         }
 202         boolean isValidForCache = false;
 203         if (extensionManager != null) {
 204             ExtensionResultHolder&lt;Boolean&gt; response = new ExtensionResultHolder&lt;Boolean&gt;();
 205             response.setResult(false);
 206             extensionManager.getProxy().isValidState(response);
 207             isValidForCache = response.getResult();
 208         }
<abbr title=" 209         if ((!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) || (!isValidForCache)) {"> 209         if ((!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) || (!isValidForðŸ”µ</abbr>
<abbr title=" 210             Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, localeCountryCode, ResultType.CATALOG_ONLY);"> 210             Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, locðŸ”µ</abbr>
 211             if (translation != null) {
 212                 return translation.getTranslatedValue();
 213             } else {
 214                 return null;
 215             }
 216         }
 217         return getOverrideTranslatedValue(property, entityType, entityId, localeCode, localeCountryCode);
 218     }
 219 
 220     @Override
 221     public void removeTranslationFromCache(Translation translation) {
 222         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 223             ResultType resultType = ResultType.STANDARD;
 224             if (extensionManager != null) {
 225                 ExtensionResultHolder&lt;ResultType&gt; response = new ExtensionResultHolder&lt;ResultType&gt;();
 226                 extensionManager.getProxy().getResultType(translation, response);
 227                 resultType = response.getResult();
 228                 if (ResultType.STANDARD == resultType) {
 229                     String key = getCacheKey(resultType, translation.getEntityType());
 230                     LOG.debug((&quot;Removing key [&quot; + key) + &quot;] for STANDARD site&quot;);
 231                     getCache().remove(key);
 232                 } else {
<abbr title=" 233                     List&lt;String&gt; cacheKeysList = getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType());"> 233                     List&lt;String&gt; cacheKeysList = getCacheKeyListForTemplateSite(translation.getEntityTypeðŸ”µ</abbr>
 234                     for (String key : cacheKeysList) {
 235                         LOG.debug((&quot;Removing key [&quot; + key) + &quot;] for TEMPLATE site&quot;);
 236                         getCache().remove(key);
 237                     }
 238                 }
 239             }
 240         }
 241     }
 242 
 243     protected String getOverrideTranslatedValue(String property, TranslatedEntity entityType,
<abbr title=" 244                                                 String entityId, String localeCode, String localeCountryCode) {"> 244                                                 String entityId, String localeCode, String localeCountryCðŸ”µ</abbr>
 245         boolean specificTranslationDeleted = false;
 246         boolean generalTranslationDeleted = false;
 247         StandardCacheItem specificTranslation = null;
 248         StandardCacheItem generalTranslation = null;
 249         String specificPropertyKey = property + &quot;_&quot; + localeCountryCode;
 250         String generalPropertyKey = property + &quot;_&quot; + localeCode;
 251         String response = null;
 252         String cacheKey = getCacheKey(ResultType.STANDARD, entityType);
 253         LocalePair override = null;
 254         for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 255             override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeCountryCode, cacheKey);"> 255             override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeðŸ”µ</abbr>
 256             if(override != null) {
 257                 specificTranslation = override.getSpecificItem();
 258                 generalTranslation = override.getGeneralItem();
 259                 break;
 260             }
 261         }
 262         if (override == null) {
<abbr title=" 263             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 263             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return ðŸ”µ</abbr>
 264         }
 265 
 266         if (specificTranslation != null) {
 267             if (ItemStatus.DELETED.equals(specificTranslation.getItemStatus())) {
 268                 specificTranslationDeleted = true;
 269             } else {
 270                 if (specificTranslation.getCacheItem() instanceof Translation) {
 271                     response = ((Translation) specificTranslation.getCacheItem()).getTranslatedValue();
 272                 } else {
 273                     response = (String) specificTranslation.getCacheItem();
 274                 }
 275                 return replaceEmptyWithNullResponse(response);
 276             }
 277         }
 278 
 279         if (generalTranslation != null) {
 280             if (ItemStatus.DELETED.equals(generalTranslation.getItemStatus())) {
 281                 generalTranslationDeleted = true;
 282                 //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 283                 //If the general translation is override deleted and we&#x27;ve only got a general local code - we&#x27;re done"> 283                 //If the general translation is override deleted and we&#x27;ve only got a general local code ðŸ”µ</abbr>
 284                 if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 285                     return null;
 286                 }
 287             } else {
 288                 if (generalTranslation.getCacheItem() instanceof Translation) {
 289                     response = ((Translation) generalTranslation.getCacheItem()).getTranslatedValue();
 290                 } else {
 291                     response = (String) generalTranslation.getCacheItem();
 292                 }
 293                 //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 294                 //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re done"> 294                 //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re ðŸ”µ</abbr>
 295                 if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 296                     return replaceEmptyWithNullResponse(response);
 297                 }
 298                 //We have a valid general override - don&#x27;t check for general template value
 299                 generalTranslationDeleted = true;
 300             }
 301         }
 302 
 303         // Check for a Template Match
 304         if (specificTranslationDeleted) {
<abbr title=" 305             // only check general properties since we explicitly deleted specific properties at standard (site) level"> 305             // only check general properties since we explicitly deleted specific properties at standard ðŸ”µ</abbr>
 306             specificPropertyKey = generalPropertyKey;
 307         } else if (generalTranslationDeleted) {
<abbr title=" 308             // only check specific properties since we explicitly deleted general properties at standard (site) level"> 308             // only check specific properties since we explicitly deleted general properties at standard ðŸ”µ</abbr>
 309             generalPropertyKey = specificPropertyKey;
 310         }
 311 
<abbr title=" 312         String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, localeCode,"> 312         String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, loðŸ”µ</abbr>
 313                     localeCountryCode, specificPropertyKey, generalPropertyKey);
 314         if (templateResponse != null) {
 315             response = templateResponse;
 316         }
 317         return response;
 318     }
 319 
 320     protected String replaceEmptyWithNullResponse(String response) {
 321         if (!StringUtils.isEmpty(response)) {
 322             return response;
 323         }
 324         return null;
 325     }
 326 
<abbr title=" 327     protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntity entityType,"> 327     protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntitðŸ”µ</abbr>
<abbr title=" 328                         String entityId, String localeCode, String localeCountryCode, String specificPropertyKey, String generalPropertyKey) {"> 328                         String entityId, String localeCode, String localeCountryCode, String specificPropðŸ”µ</abbr>
 329         String cacheKey = getCacheKey(ResultType.TEMPLATE, entityType);
 330         StandardCacheItem translation = null;
 331         LocalePair override = null;
 332         for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 333             override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, localeCode, localeCountryCode, specificPropertyKey, generalPropertyKey);"> 333             override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, locðŸ”µ</abbr>
 334             if(override != null) {
 335                 translation = override.getSpecificItem();
 336                 if (!strategy.validateTemplateProcessing(standardCacheKey, cacheKey)) {
 337                     return null;
 338                 }
 339                 break;
 340             }
 341         }
 342         if (override == null) {
<abbr title=" 343             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 343             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return ðŸ”µ</abbr>
 344         }
<abbr title=" 345         return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheItem()).getTranslatedValue());"> 345         return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheIteðŸ”µ</abbr>
 346     }
 347 
 348     @Override
 349     public StandardCacheItem lookupTranslationFromMap(String key,
 350             Map&lt;String, Map&lt;String, StandardCacheItem&gt;&gt; propertyTranslationMap, String entityId) {
 351 
 352         StandardCacheItem cacheItem = null;
 353         if (propertyTranslationMap.containsKey(key)) {
 354             Map&lt;String, StandardCacheItem&gt; byEntity = propertyTranslationMap.get(key);
 355             cacheItem = byEntity.get(entityId);
 356         }
 357         return cacheItem;
 358     }
 359 
 360     @Override
<abbr title=" 361     public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey, Map&lt;String, Map&lt;String, Translation&gt;&gt; propertyTranslationMap, String entityId) {"> 361     public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey,ðŸ”µ</abbr>
 362         Translation translation = null;
 363         if (propertyTranslationMap.containsKey(specificPropertyKey)) {
 364             Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(specificPropertyKey);
 365             translation = byEntity.get(entityId);
 366         }
 367         if (translation == null &amp;&amp; propertyTranslationMap.containsKey(generalPropertyKey)) {
 368             Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(generalPropertyKey);
 369             translation = byEntity.get(entityId);
 370         }
 371         return translation;
 372     }
 373 
 374     protected TranslatedEntity getEntityType(Class&lt;?&gt; entityClass) {
 375         for (Entry&lt;String, TranslatedEntity&gt; entry : TranslatedEntity.getTypes().entrySet()) {
 376             try {
 377                 Class&lt;?&gt; clazz = Class.forName(entry.getKey());
 378                 if (clazz.isAssignableFrom(entityClass)) {
 379                     return entry.getValue();
 380                 }
 381             } catch (ClassNotFoundException e) {
<abbr title=" 382                 throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, e);"> 382                 throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, ðŸ”µ</abbr>
 383             }
 384         }
 385         throw new IllegalArgumentException(entityClass.getName() + &quot; is not a known translatable class&quot;);
 386     }
 387 
 388     protected TranslatedEntity getEntityType(Object entity) {
 389         return getEntityType(entity.getClass());
 390     }
 391 
 392     @Override
 393     public TranslatedEntity getAssignableEntityType(String className) {
 394         try {
 395             Class&lt;?&gt; clazz = Class.forName(className);
 396             return getEntityType(clazz);
 397         } catch (java.lang.ClassNotFoundException e) {
 398             throw new IllegalArgumentException(className + &quot; is not a known translatable class&quot;);
 399         }
 400     }
 401 
 402     @Override
 403     public String getCacheKey(ResultType resultType, TranslatedEntity entityType) {
 404         String cacheKey = StringUtils.join(new String[] { entityType.getFriendlyType()}, &quot;|&quot;);
 405         if (extensionManager != null) {
 406             ExtensionResultHolder&lt;String&gt; result = new ExtensionResultHolder&lt;String&gt;();
 407             extensionManager.getProxy().getCacheKey(cacheKey, resultType, result);
 408             if (result.getResult() != null) {
 409                 cacheKey = result.getResult();
 410             }
 411         }
 412         return cacheKey;
 413     }
 414 
 415     @Override
 416     public List&lt;String&gt; getCacheKeyListForTemplateSite(String propertyName) {
 417         List&lt;String&gt; cacheKeyList = new ArrayList&lt;&gt;();
 418         String cacheKey = StringUtils.join(new String[] {propertyName}, &quot;|&quot;);
 419         if (extensionManager != null) {
 420             ExtensionResultHolder&lt;List&lt;String&gt;&gt; result = new ExtensionResultHolder&lt;List&lt;String&gt;&gt;();
 421             extensionManager.getProxy().getCacheKeyListForTemplateSite(cacheKey, result);
 422             if (result.getResult() != null) {
 423                 cacheKeyList = result.getResult();
 424             }
 425         }
 426         return cacheKeyList;
 427     }
 428 
 429     @Override
 430     public int getThresholdForFullCache() {
 431         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 432             return thresholdForFullCache;
 433         } else {
 434             // don&#x27;t cache when not in a SandBox
 435             return -1;
 436         }
 437     }
 438 
 439     @Override
 440     public void setThresholdForFullCache(int thresholdForFullCache) {
 441         this.thresholdForFullCache = thresholdForFullCache;
 442     }
 443 
 444     @Override
 445     public int getTemplateThresholdForFullCache() {
 446         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 447             return templateThresholdForFullCache;
 448         } else {
 449             // don&#x27;t cache when not in a SandBox
 450             return -1;
 451         }
 452     }
 453 
 454     @Override
 455     public void setTemplateThresholdForFullCache(int templateThresholdForFullCache) {
 456         this.templateThresholdForFullCache = templateThresholdForFullCache;
 457     }
 458 
 459     @Override
 460     public String getDefaultTranslationValue(Object entity, String property, Locale locale,
 461             String requestedDefaultValue) {
 462 
<abbr title=" 463         if (returnBlankTranslationForNotDefaultLocale &amp;&amp; !localeMatchesDefaultLocale(locale) &amp;&amp; !propertyInDefaultLocaleExceptionList(entity, property)) {"> 463         if (returnBlankTranslationForNotDefaultLocale &amp;&amp; !localeMatchesDefaultLocale(locale) &amp;&amp; !propertyðŸ”µ</abbr>
 464             return &quot;&quot;;
 465         }
 466 
 467         return requestedDefaultValue;
 468     }
 469 
 470     @Override
<abbr title=" 471     public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType standard, List&lt;String&gt; entityIds) {"> 471     public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType stanðŸ”µ</abbr>
 472         return dao.readAllTranslationEntries(translatedEntity, standard, entityIds);
 473     }
 474 
 475     /**
 476      * Returns true if the passed in entity / property combination is in the defaultLocaleExceptionList
 477      *
 478      * The default implementation checks the &quot;translationExceptionProperties&quot; list to see if the
 479      * property matches one of the regularExpressions in that list.
 480      *
 481      * Implementors are expected to override this method for implementation specific needs.
 482      *
 483      * @param entity
 484      * @param property
 485      * @return
 486      */
 487     protected boolean propertyInDefaultLocaleExceptionList(Object entity, String property) {
 488         TranslatedEntity entityType = getEntityType(entity);
 489         if (entityType != null &amp;&amp; entityType.getFriendlyType() != null) {
 490             for (String exceptionProperty : translationExceptionProperties) {
 491                 if (property.matches(exceptionProperty)) {
 492                     return true;
 493                 }
 494             }
 495         }
 496         return false;
 497     }
 498 
 499     /**
 500      * Returns true if the passed in locale&#x27;s language matches the Broadleaf default locale.
 501      * @param locale
 502      * @return
 503      */
 504     protected boolean localeMatchesDefaultLocale(Locale locale) {
 505         String defaultLanguage = LocaleUtil.findLanguageCode(localeService.findDefaultLocale());
 506 
 507         if (defaultLanguage != null &amp;&amp; locale != null) {
 508             return defaultLanguage.equals(locale.getLanguage());
 509         }
 510         return false;
 511     }
 512 
 513     /**
 514      * Whether translations should be gathered for the provided locale.
 515      *
 516      * @param localeCode
 517      *
 518      * @return Whether translations should be gathered for the provided locale.
 519      */
 520     protected boolean shouldTranslateLocale(String localeCode) {
<abbr title=" 521         org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCode);"> 521         org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCðŸ”µ</abbr>
 522         if (locale == null) {
 523 
 524 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 525             LOG.warn(&quot;A locale could not be found for the provided localeCode: &quot;+ localeCode);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 526             return true;</span>
 527 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 528 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 528 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 529 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 531             throw new IllegalArgumentException(&quot;A locale could not be found for the provided localeCode: &quot;+ localeCode);"> 531             throw new IllegalArgumentException(&quot;A locale could not be found for the provided localeCode: ðŸ”µ</abbr></span>
 532 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 533 
 534         }
 535         return !locale.getDefaultFlag();
 536     }
 537 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.i18n.service;
  19  
  20  import org.apache.commons.lang3.StringUtils;
  21  import org.apache.commons.logging.Log;
  22  import org.apache.commons.logging.LogFactory;
  23  import org.broadleafcommerce.common.cache.StatisticsService;
  24  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  25  import org.broadleafcommerce.common.extension.ItemStatus;
  26  import org.broadleafcommerce.common.extension.ResultType;
  27  import org.broadleafcommerce.common.extension.StandardCacheItem;
  28  import org.broadleafcommerce.common.i18n.dao.TranslationDao;
  29  import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  30  import org.broadleafcommerce.common.i18n.domain.Translation;
  31  import org.broadleafcommerce.common.i18n.domain.TranslationImpl;
  32  import org.broadleafcommerce.common.locale.service.LocaleService;
  33  import org.broadleafcommerce.common.locale.util.LocaleUtil;
  34  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  35  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  36  import org.springframework.beans.factory.annotation.Value;
  37  import org.springframework.stereotype.Service;
  38  import org.springframework.transaction.annotation.Transactional;
  39  
  40  import java.util.ArrayList;
  41  import java.util.List;
  42  import java.util.Locale;
  43  import java.util.Map;
  44  import java.util.Map.Entry;
  45  
  46  import javax.annotation.Resource;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import net.sf.ehcache.Cache;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -import net.sf.ehcache.CacheManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +import javax.cache.Cache;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +import javax.cache.CacheManager;</span>
  52  
  53  @Service(&quot;blTranslationService&quot;)
  54  public class TranslationServiceImpl implements TranslationService, TranslationSupport {
  55  
  56      protected static final Log LOG = LogFactory.getLog(TranslationServiceImpl.class);
  57      private static final Translation DELETED_TRANSLATION = new TranslationImpl();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +    private static final String TRANSLATION_CACHE_NAME = &quot;blTranslationElements&quot;;</span>
  59  
  60      @Resource(name = &quot;blTranslationDao&quot;)
  61      protected TranslationDao dao;
  62  
  63      @Resource(name=&quot;blStatisticsService&quot;)
  64      protected StatisticsService statisticsService;
  65  
  66      @Resource(name=&quot;blSandBoxHelper&quot;)
  67      protected SandBoxHelper sandBoxHelper;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -    protected Cache cache;</span>
  70  
  71      @Resource(name=&quot;blTranslationServiceExtensionManager&quot;)
  72      protected TranslationServiceExtensionManager extensionManager;
  73  
  74      /**
  75       * The default is 1000. Use the &#x27;translation.thresholdForFullCache&#x27; to change the value.
  76       */
  77      @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  78      protected int thresholdForFullCache;
  79  
  80      /**
  81       * The default is 1000. This property also uses &#x27;translation.thresholdForFullCache&#x27; for
  82       * backwards compatibility. If you wish to change this value, you&#x27;ll need to extend
<abbr title="  83       * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholdForFullCache()}">  83       * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholdForFullCðŸ”µ</abbr>
  84       */
  85      @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  86      protected int templateThresholdForFullCache;
  87  
  88      @Value(&quot;${returnBlankTranslationForNotDefaultLocale:false}&quot;)
  89      protected boolean returnBlankTranslationForNotDefaultLocale;
  90  
  91      @Resource(name = &quot;blTranslationExceptionProperties&quot;)
  92      protected List&lt;String&gt; translationExceptionProperties = new ArrayList&lt;String&gt;();
  93  
  94      @Resource(name = &quot;blLocaleService&quot;)
  95      protected LocaleService localeService;
  96  
  97      @Resource
  98      protected List&lt;TranslationOverrideStrategy&gt; strategies;
  99  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +    @Resource(name = &quot;blCacheManager&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +    protected CacheManager cacheManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +    protected Cache&lt;String, Object&gt; cache;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +</span>
 105      @Override
 106      @Transactional(&quot;blTransactionManager&quot;)
 107      public Translation save(Translation translation) {
 108          return dao.save(translation);
 109      }
 110  
 111      @Override
 112      @Transactional(&quot;blTransactionManager&quot;)
 113      public Translation save(String entityType, String entityId, String fieldName, String localeCode,
 114              String translatedValue) {
 115          TranslatedEntity te = getAssignableEntityType(entityType);
 116  
 117          Translation translation = getTranslation(te, entityId, fieldName, localeCode);
 118  
 119          if (translation == null) {
 120              translation = dao.create();
 121              translation.setEntityType(te);
 122              translation.setEntityId(entityId);
 123              translation.setFieldName(fieldName);
 124              translation.setLocaleCode(localeCode);
 125          }
 126  
 127          translation.setTranslatedValue(translatedValue);
 128          return save(translation);
 129      }
 130  
 131      @Override
 132      public Translation findTranslationById(Long id) {
 133          return dao.readTranslationById(id);
 134      }
 135  
 136      @Override
 137      @Transactional(&quot;blTransactionManager&quot;)
 138      public Translation update(Long translationId, String localeCode, String translatedValue) {
 139          Translation t = dao.readTranslationById(translationId);
 140  
<abbr title=" 141          // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it if it exists"> 141          // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it if it existðŸ”µ</abbr>
 142          Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeCode);
 143          if (t2 != null &amp;&amp; t != t2) {
 144              dao.delete(t2);
 145          }
 146  
 147          t.setLocaleCode(localeCode);
 148          t.setTranslatedValue(translatedValue);
 149          return save(t);
 150      }
 151  
 152      @Override
 153      @Transactional(&quot;blTransactionManager&quot;)
 154      public void deleteTranslationById(Long translationId) {
 155          Translation t = dao.readTranslationById(translationId);
 156          dao.delete(t);
 157      }
 158  
 159      @Override
<abbr title=" 160      public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String localeCode) {"> 160      public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String localeCodðŸ”µ</abbr>
 161          return dao.readTranslation(entity, entityId, fieldName, localeCode);
 162      }
 163  
 164      @Override
 165      public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String property) {
 166          TranslatedEntity entityType = getAssignableEntityType(ceilingEntityClassname);
 167          return dao.readTranslations(entityType, entityId, property);
 168      }
 169  
 170      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -    public Cache getCache() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +    public Cache&lt;String, Object&gt; getCache() {</span>
 173          if (cache == null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -            cache = CacheManager.getInstance().getCache(&quot;blTranslationElements&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +            synchronized (this) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +                if (cache == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +                    cache = cacheManager.getCache(getCacheName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +            }</span>
 180          }
 181          return cache;
 182      }
 183  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +    protected String getCacheName() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +        return TRANSLATION_CACHE_NAME;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +</span>
 188      @Override
 189      public String getTranslatedValue(Object entity, String property, Locale locale) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -        TranslatedEntity entityType = getEntityType(entity);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -        String entityId = dao.getEntityId(entityType, entity);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -</span>
 193          String localeCode = locale.getLanguage();
 194          String localeCountryCode = localeCode;
 195          if (StringUtils.isNotBlank(locale.getCountry())) {
 196              localeCountryCode += &quot;_&quot; + locale.getCountry();
 197          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +        if (!shouldTranslateLocale(localeCountryCode)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +            return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +        TranslatedEntity entityType = getEntityType(entity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +        String entityId = dao.getEntityId(entityType, entity);</span>
 205  
 206          if (TranslationBatchReadCache.hasCache()) {
<abbr title=" 207              Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, property, localeCountryCode);"> 207              Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, property, localðŸ”µ</abbr>
 208              if (translation != null) {
 209                  return translation.getTranslatedValue();
 210              } else {
 211                  // There is no translation for this entity if it is not in the cache
 212                  return null;
 213              }
 214          }
 215  
 216          boolean isValidForCache = false;
 217          if (extensionManager != null) {
 218              ExtensionResultHolder&lt;Boolean&gt; response = new ExtensionResultHolder&lt;Boolean&gt;();
 219              response.setResult(false);
 220              extensionManager.getProxy().isValidState(response);
 221              isValidForCache = response.getResult();
 222          }
 223          if (!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox() || !isValidForCache) {
<abbr title=" 224              Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, localeCountryCode,"> 224              Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, localeCountrðŸ”µ</abbr>
 225                      ResultType.CATALOG_ONLY);
 226              if (translation != null) {
 227                  return translation.getTranslatedValue();
 228              } else {
 229                  return null;
 230              }
 231          }
 232  
 233          return getOverrideTranslatedValue(property, entityType, entityId, localeCode, localeCountryCode);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +     * Whether translations should be gathered for the provided locale.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +     * @param localeCode</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +     * @return Whether translations should be gathered for the provided locale.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +    protected boolean shouldTranslateLocale(String localeCode) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +        org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +        if (locale == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 246 +            throw new IllegalArgumentException(&quot;A locale could not be found for the provided localeCode: &quot;+ localeCode);"> 246 +            throw new IllegalArgumentException(&quot;A locale could not be found for the provided localeCode: &quot;+ localeðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +        return !locale.getDefaultFlag();</span>

 250      }
 251  
 252      @Override
 253      public void removeTranslationFromCache(Translation translation) {
 254          if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 255              ResultType resultType = ResultType.STANDARD;
 256              if (extensionManager != null) {
 257                  ExtensionResultHolder&lt;ResultType&gt; response = new ExtensionResultHolder&lt;ResultType&gt;();
 258                  extensionManager.getProxy().getResultType(translation, response);
 259                  resultType = response.getResult();
 260                  if (ResultType.STANDARD == resultType) {
 261                      String key = getCacheKey(resultType, translation.getEntityType());
 262                      LOG.debug(&quot;Removing key [&quot; + key + &quot;] for STANDARD site&quot;);
 263                      getCache().remove(key);
 264                  } else {
 265                      List&lt;String&gt; cacheKeysList =
 266                              getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType());
 267                      for (String key: cacheKeysList) {
 268                          LOG.debug(&quot;Removing key [&quot; + key + &quot;] for TEMPLATE site&quot;);
 269                          getCache().remove(key);
 270                      }
 271                  }
 272              }
 273          }
 274      }
 275  
 276      protected String getOverrideTranslatedValue(String property, TranslatedEntity entityType,
 277                                                  String entityId, String localeCode, String localeCountryCode) {
 278          boolean specificTranslationDeleted = false;
 279          boolean generalTranslationDeleted = false;
 280          StandardCacheItem specificTranslation = null;
 281          StandardCacheItem generalTranslation = null;
 282          String specificPropertyKey = property + &quot;_&quot; + localeCountryCode;
 283          String generalPropertyKey = property + &quot;_&quot; + localeCode;
 284          String response = null;
 285          String cacheKey = getCacheKey(ResultType.STANDARD, entityType);
 286          LocalePair override = null;
 287          for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 288              override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeCountryCode, cacheKey);"> 288              override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeCountryCoðŸ”µ</abbr>
 289              if(override != null) {
 290                  specificTranslation = override.getSpecificItem();
 291                  generalTranslation = override.getGeneralItem();
 292                  break;
 293              }
 294          }
 295          if (override == null) {
<abbr title=" 296              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 296              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid vðŸ”µ</abbr>
 297          }
 298  
 299          if (specificTranslation != null) {
 300              if (ItemStatus.DELETED.equals(specificTranslation.getItemStatus())) {
 301                  specificTranslationDeleted = true;
 302              } else {
 303                  if (specificTranslation.getCacheItem() instanceof Translation) {
 304                      response = ((Translation) specificTranslation.getCacheItem()).getTranslatedValue();
 305                  } else {
 306                      response = (String) specificTranslation.getCacheItem();
 307                  }
 308                  return replaceEmptyWithNullResponse(response);
 309              }
 310          }
 311  
 312          if (generalTranslation != null) {
 313              if (ItemStatus.DELETED.equals(generalTranslation.getItemStatus())) {
 314                  generalTranslationDeleted = true;
 315                  //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 316                  //If the general translation is override deleted and we&#x27;ve only got a general local code - we&#x27;re done"> 316                  //If the general translation is override deleted and we&#x27;ve only got a general local code - we&#x27;re dðŸ”µ</abbr>
 317                  if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 318                      return null;
 319                  }
 320              } else {
 321                  if (generalTranslation.getCacheItem() instanceof Translation) {
 322                      response = ((Translation) generalTranslation.getCacheItem()).getTranslatedValue();
 323                  } else {
 324                      response = (String) generalTranslation.getCacheItem();
 325                  }
 326                  //If the specific translation is override deleted as well, we&#x27;re done
 327                  //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re done
 328                  if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 329                      return replaceEmptyWithNullResponse(response);
 330                  }
 331                  //We have a valid general override - don&#x27;t check for general template value
 332                  generalTranslationDeleted = true;
 333              }
 334          }
 335  
 336          // Check for a Template Match
 337          if (specificTranslationDeleted) {
<abbr title=" 338              // only check general properties since we explicitly deleted specific properties at standard (site) level"> 338              // only check general properties since we explicitly deleted specific properties at standard (site) leðŸ”µ</abbr>
 339              specificPropertyKey = generalPropertyKey;
 340          } else if (generalTranslationDeleted) {
<abbr title=" 341              // only check specific properties since we explicitly deleted general properties at standard (site) level"> 341              // only check specific properties since we explicitly deleted general properties at standard (site) leðŸ”µ</abbr>
 342              generalPropertyKey = specificPropertyKey;
 343          }
 344  
 345          String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, localeCode,
 346                      localeCountryCode, specificPropertyKey, generalPropertyKey);
 347          if (templateResponse != null) {
 348              response = templateResponse;
 349          }
 350          return response;
 351      }
 352  
 353      protected String replaceEmptyWithNullResponse(String response) {
 354          if (!StringUtils.isEmpty(response)) {
 355              return response;
 356          }
 357          return null;
 358      }
 359  
<abbr title=" 360      protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntity entityType,"> 360      protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntity entityTðŸ”µ</abbr>
<abbr title=" 361                          String entityId, String localeCode, String localeCountryCode, String specificPropertyKey, String generalPropertyKey) {"> 361                          String entityId, String localeCode, String localeCountryCode, String specificPropertyKey, ðŸ”µ</abbr>
 362          String cacheKey = getCacheKey(ResultType.TEMPLATE, entityType);
 363          StandardCacheItem translation = null;
 364          LocalePair override = null;
 365          for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 366              override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, localeCode, localeCountryCode, specificPropertyKey, generalPropertyKey);"> 366              override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, localeCode, ðŸ”µ</abbr>
 367              if(override != null) {
 368                  translation = override.getSpecificItem();
 369                  if (!strategy.validateTemplateProcessing(standardCacheKey, cacheKey)) {
 370                      return null;
 371                  }
 372                  break;
 373              }
 374          }
 375          if (override == null) {
<abbr title=" 376              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 376              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid vðŸ”µ</abbr>
 377          }
<abbr title=" 378          return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheItem()).getTranslatedValue());"> 378          return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheItem()).getTðŸ”µ</abbr>
 379      }
 380  
 381      @Override
 382      public StandardCacheItem lookupTranslationFromMap(String key,
 383              Map&lt;String, Map&lt;String, StandardCacheItem&gt;&gt; propertyTranslationMap, String entityId) {
 384  
 385          StandardCacheItem cacheItem = null;
 386          if (propertyTranslationMap.containsKey(key)) {
 387              Map&lt;String, StandardCacheItem&gt; byEntity = propertyTranslationMap.get(key);
 388              cacheItem = byEntity.get(entityId);
 389          }
 390          return cacheItem;
 391      }
 392  
 393      @Override
<abbr title=" 394      public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey, Map&lt;String, Map&lt;String, Translation&gt;&gt; propertyTranslationMap, String entityId) {"> 394      public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey, Map&lt;StriðŸ”µ</abbr>
 395          Translation translation = null;
 396          if (propertyTranslationMap.containsKey(specificPropertyKey)) {
 397              Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(specificPropertyKey);
 398              translation = byEntity.get(entityId);
 399          }
 400          if (translation == null &amp;&amp; propertyTranslationMap.containsKey(generalPropertyKey)) {
 401              Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(generalPropertyKey);
 402              translation = byEntity.get(entityId);
 403          }
 404          return translation;
 405      }
 406  
 407      protected TranslatedEntity getEntityType(Class&lt;?&gt; entityClass) {
 408          for (Entry&lt;String, TranslatedEntity&gt; entry : TranslatedEntity.getTypes().entrySet()) {
 409              try {
 410                  Class&lt;?&gt; clazz = Class.forName(entry.getKey());
 411                  if (clazz.isAssignableFrom(entityClass)) {
 412                      return entry.getValue();
 413                  }
 414              } catch (ClassNotFoundException e) {
 415                  throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, e);
 416              }
 417          }
 418          throw new IllegalArgumentException(entityClass.getName() + &quot; is not a known translatable class&quot;);
 419      }
 420  
 421      protected TranslatedEntity getEntityType(Object entity) {
 422          return getEntityType(entity.getClass());
 423      }
 424  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 425 +    @Override</span>
 426      public TranslatedEntity getAssignableEntityType(String className) {
 427          try {
 428              Class&lt;?&gt; clazz = Class.forName(className);
 429              return getEntityType(clazz);
 430          } catch (ClassNotFoundException e) {
 431              throw new IllegalArgumentException(className + &quot; is not a known translatable class&quot;);
 432          }
 433      }
 434  
 435      @Override
 436      public String getCacheKey(ResultType resultType, TranslatedEntity entityType) {
 437          String cacheKey = StringUtils.join(new String[] { entityType.getFriendlyType()}, &quot;|&quot;);
 438          if (extensionManager != null) {
 439              ExtensionResultHolder&lt;String&gt; result = new ExtensionResultHolder&lt;String&gt;();
 440              extensionManager.getProxy().getCacheKey(cacheKey, resultType, result);
 441              if (result.getResult() != null) {
 442                  cacheKey = result.getResult();
 443              }
 444          }
 445          return cacheKey;
 446      }
 447  
 448      @Override
 449      public List&lt;String&gt; getCacheKeyListForTemplateSite(String propertyName) {
 450          List&lt;String&gt; cacheKeyList = new ArrayList&lt;&gt;();
 451          String cacheKey = StringUtils.join(new String[] {propertyName}, &quot;|&quot;);
 452          if (extensionManager != null) {
 453              ExtensionResultHolder&lt;List&lt;String&gt;&gt; result = new ExtensionResultHolder&lt;List&lt;String&gt;&gt;();
 454              extensionManager.getProxy().getCacheKeyListForTemplateSite(cacheKey, result);
 455              if (result.getResult() != null) {
 456                  cacheKeyList = result.getResult();
 457              }
 458          }
 459          return cacheKeyList;
 460      }
 461  
 462      @Override
 463      public int getThresholdForFullCache() {
 464          if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 465              return thresholdForFullCache;
 466          } else {
 467              // don&#x27;t cache when not in a SandBox
 468              return -1;
 469          }
 470      }
 471  
 472      @Override
 473      public void setThresholdForFullCache(int thresholdForFullCache) {
 474          this.thresholdForFullCache = thresholdForFullCache;
 475      }
 476  
 477      @Override
 478      public int getTemplateThresholdForFullCache() {
 479          if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 480              return templateThresholdForFullCache;
 481          } else {
 482              // don&#x27;t cache when not in a SandBox
 483              return -1;
 484          }
 485      }
 486  
 487      @Override
 488      public void setTemplateThresholdForFullCache(int templateThresholdForFullCache) {
 489          this.templateThresholdForFullCache = templateThresholdForFullCache;
 490      }
 491  
 492      @Override
 493      public String getDefaultTranslationValue(Object entity, String property, Locale locale,
 494              String requestedDefaultValue) {
 495  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 496 -        if (returnBlankTranslationForNotDefaultLocale &amp;&amp; !localeMatchesDefaultLocale(locale) &amp;&amp; !propertyInDefaultLocaleExceptionList(entity, property)) {"> 496 -        if (returnBlankTranslationForNotDefaultLocale &amp;&amp; !localeMatchesDefaultLocale(locale) &amp;&amp; !propertyInDefaultðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 497 +        if (returnBlankTranslationForNotDefaultLocale</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 498 +                &amp;&amp; !localeMatchesDefaultLocale(locale)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 499 +                &amp;&amp; !propertyInDefaultLocaleExceptionList(entity, property)) {</span>
 500              return &quot;&quot;;
 501          }
 502  
 503          return requestedDefaultValue;
 504      }
 505  
 506      @Override
<abbr title=" 507      public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType standard, List&lt;String&gt; entityIds) {"> 507      public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType standard, LisðŸ”µ</abbr>
 508          return dao.readAllTranslationEntries(translatedEntity, standard, entityIds);
 509      }
 510  
 511      /**
 512       * Returns true if the passed in entity / property combination is in the defaultLocaleExceptionList
 513       *
 514       * The default implementation checks the &quot;translationExceptionProperties&quot; list to see if the
 515       * property matches one of the regularExpressions in that list.
 516       *
 517       * Implementors are expected to override this method for implementation specific needs.
 518       *
 519       * @param entity
 520       * @param property
 521       * @return
 522       */
 523      protected boolean propertyInDefaultLocaleExceptionList(Object entity, String property) {
 524          TranslatedEntity entityType = getEntityType(entity);
 525          if (entityType != null &amp;&amp; entityType.getFriendlyType() != null) {
 526              for (String exceptionProperty : translationExceptionProperties) {
 527                  if (property.matches(exceptionProperty)) {
 528                      return true;
 529                  }
 530              }
 531          }
 532          return false;
 533      }
 534  
 535      /**
 536       * Returns true if the passed in locale&#x27;s language matches the Broadleaf default locale.
 537       * @param locale
 538       * @return
 539       */
 540      protected boolean localeMatchesDefaultLocale(Locale locale) {
 541          String defaultLanguage = LocaleUtil.findLanguageCode(localeService.findDefaultLocale());
 542  
 543          if (defaultLanguage != null &amp;&amp; locale != null) {
 544              return defaultLanguage.equals(locale.getLanguage());
 545          }
 546          return false;
 547      }
 548  
 549  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.i18n.service;
  19  
  20  import org.apache.commons.lang3.StringUtils;
  21  import org.apache.commons.logging.Log;
  22  import org.apache.commons.logging.LogFactory;
  23  import org.broadleafcommerce.common.cache.StatisticsService;
  24  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  25  import org.broadleafcommerce.common.extension.ItemStatus;
  26  import org.broadleafcommerce.common.extension.ResultType;
  27  import org.broadleafcommerce.common.extension.StandardCacheItem;
  28  import org.broadleafcommerce.common.i18n.dao.TranslationDao;
  29  import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  30  import org.broadleafcommerce.common.i18n.domain.Translation;
  31  import org.broadleafcommerce.common.i18n.domain.TranslationImpl;
  32  import org.broadleafcommerce.common.locale.service.LocaleService;
  33  import org.broadleafcommerce.common.locale.util.LocaleUtil;
  34  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  35  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  36  import org.springframework.beans.factory.annotation.Value;
  37  import org.springframework.stereotype.Service;
  38  import org.springframework.transaction.annotation.Transactional;
  39  
  40  import java.util.ArrayList;
  41  import java.util.List;
  42  import java.util.Locale;
  43  import java.util.Map;
  44  import java.util.Map.Entry;
  45  
  46  import javax.annotation.Resource;
  47  
  48  import net.sf.ehcache.Cache;
  49  import net.sf.ehcache.CacheManager;


  50  
  51  @Service(&quot;blTranslationService&quot;)
  52  public class TranslationServiceImpl implements TranslationService, TranslationSupport {
  53  
  54      protected static final Log LOG = LogFactory.getLog(TranslationServiceImpl.class);
  55      private static final Translation DELETED_TRANSLATION = new TranslationImpl();

  56  
  57      @Resource(name = &quot;blTranslationDao&quot;)
  58      protected TranslationDao dao;
  59  
  60      @Resource(name=&quot;blStatisticsService&quot;)
  61      protected StatisticsService statisticsService;
  62  
  63      @Resource(name=&quot;blSandBoxHelper&quot;)
  64      protected SandBoxHelper sandBoxHelper;
  65  
  66      protected Cache cache;
  67  
  68      @Resource(name=&quot;blTranslationServiceExtensionManager&quot;)
  69      protected TranslationServiceExtensionManager extensionManager;
  70  
  71      /**
  72       * The default is 1000. Use the &#x27;translation.thresholdForFullCache&#x27; to change the value.
  73       */
  74      @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  75      protected int thresholdForFullCache;
  76  
  77      /**
  78       * The default is 1000. This property also uses &#x27;translation.thresholdForFullCache&#x27; for
  79       * backwards compatibility. If you wish to change this value, you&#x27;ll need to extend
<abbr title="  80       * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholdForFullCache()}">  80       * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholdForFullCðŸ”µ</abbr>
  81       */
  82      @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  83      protected int templateThresholdForFullCache;
  84  
  85      @Value(&quot;${returnBlankTranslationForNotDefaultLocale:false}&quot;)
  86      protected boolean returnBlankTranslationForNotDefaultLocale;
  87  
  88      @Resource(name = &quot;blTranslationExceptionProperties&quot;)
  89      protected List&lt;String&gt; translationExceptionProperties = new ArrayList&lt;String&gt;();
  90  
  91      @Resource(name = &quot;blLocaleService&quot;)
  92      protected LocaleService localeService;
  93  
  94      @Resource
  95      protected List&lt;TranslationOverrideStrategy&gt; strategies;
  96  





  97      @Override
  98      @Transactional(&quot;blTransactionManager&quot;)
  99      public Translation save(Translation translation) {
 100          return dao.save(translation);
 101      }
 102  
 103      @Override
 104      @Transactional(&quot;blTransactionManager&quot;)
 105      public Translation save(String entityType, String entityId, String fieldName, String localeCode,
 106              String translatedValue) {
 107          TranslatedEntity te = getAssignableEntityType(entityType);
 108  
 109          Translation translation = getTranslation(te, entityId, fieldName, localeCode);
 110  
 111          if (translation == null) {
 112              translation = dao.create();
 113              translation.setEntityType(te);
 114              translation.setEntityId(entityId);
 115              translation.setFieldName(fieldName);
 116              translation.setLocaleCode(localeCode);
 117          }
 118  
 119          translation.setTranslatedValue(translatedValue);
 120          return save(translation);
 121      }
 122  
 123      @Override
 124      public Translation findTranslationById(Long id) {
 125          return dao.readTranslationById(id);
 126      }
 127  
 128      @Override
 129      @Transactional(&quot;blTransactionManager&quot;)
 130      public Translation update(Long translationId, String localeCode, String translatedValue) {
 131          Translation t = dao.readTranslationById(translationId);
 132  
<abbr title=" 133          // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it if it exists"> 133          // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it if it existðŸ”µ</abbr>
 134          Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeCode);
 135          if (t2 != null &amp;&amp; t != t2) {
 136              dao.delete(t2);
 137          }
 138  
 139          t.setLocaleCode(localeCode);
 140          t.setTranslatedValue(translatedValue);
 141          return save(t);
 142      }
 143  
 144      @Override
 145      @Transactional(&quot;blTransactionManager&quot;)
 146      public void deleteTranslationById(Long translationId) {
 147          Translation t = dao.readTranslationById(translationId);
 148          dao.delete(t);
 149      }
 150  
 151      @Override
<abbr title=" 152      public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String localeCode) {"> 152      public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String localeCodðŸ”µ</abbr>
 153          return dao.readTranslation(entity, entityId, fieldName, localeCode);
 154      }
 155  
 156      @Override
 157      public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String property) {
 158          TranslatedEntity entityType = getAssignableEntityType(ceilingEntityClassname);
 159          return dao.readTranslations(entityType, entityId, property);
 160      }
 161  
 162      @Override
 163      public Cache getCache() {

 164          if (cache == null) {
 165              cache = CacheManager.getInstance().getCache(&quot;blTranslationElements&quot;);





 166          }
 167          return cache;
 168      }
 169  




 170      @Override
 171      public String getTranslatedValue(Object entity, String property, Locale locale) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -        TranslatedEntity entityType = getEntityType(entity);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -        String entityId = dao.getEntityId(entityType, entity);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -</span>
 175          String localeCode = locale.getLanguage();
 176          String localeCountryCode = localeCode;
 177          if (StringUtils.isNotBlank(locale.getCountry())) {
 178              localeCountryCode += &quot;_&quot; + locale.getCountry();
 179          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +        if (!shouldTranslateLocale(localeCountryCode)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +            return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +        TranslatedEntity entityType = getEntityType(entity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +        String entityId = dao.getEntityId(entityType, entity);</span>
 187  
 188          if (TranslationBatchReadCache.hasCache()) {
<abbr title=" 189              Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, property, localeCountryCode);"> 189              Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, property, localðŸ”µ</abbr>
 190              if (translation != null) {
 191                  return translation.getTranslatedValue();
 192              } else {
 193                  // There is no translation for this entity if it is not in the cache
 194                  return null;
 195              }
 196          }
 197  
 198          boolean isValidForCache = false;
 199          if (extensionManager != null) {
 200              ExtensionResultHolder&lt;Boolean&gt; response = new ExtensionResultHolder&lt;Boolean&gt;();
 201              response.setResult(false);
 202              extensionManager.getProxy().isValidState(response);
 203              isValidForCache = response.getResult();
 204          }
 205          if (!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox() || !isValidForCache) {
<abbr title=" 206              Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, localeCountryCode,"> 206              Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, localeCountrðŸ”µ</abbr>
 207                      ResultType.CATALOG_ONLY);
 208              if (translation != null) {
 209                  return translation.getTranslatedValue();
 210              } else {
 211                  return null;
 212              }
 213          }
 214  
 215          return getOverrideTranslatedValue(property, entityType, entityId, localeCode, localeCountryCode);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +     * Whether translations should be gathered for the provided locale.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +     * @param localeCode</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +     * @return Whether translations should be gathered for the provided locale.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +    protected boolean shouldTranslateLocale(String localeCode) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +        org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +        if (locale == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +            LOG.warn(&quot;A locale could not be found for the provided localeCode: &quot;+ localeCode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +            return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +        return !locale.getDefaultFlag();</span>
 233      }
 234  
 235      @Override
 236      public void removeTranslationFromCache(Translation translation) {
 237          if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 238              ResultType resultType = ResultType.STANDARD;
 239              if (extensionManager != null) {
 240                  ExtensionResultHolder&lt;ResultType&gt; response = new ExtensionResultHolder&lt;ResultType&gt;();
 241                  extensionManager.getProxy().getResultType(translation, response);
 242                  resultType = response.getResult();
 243                  if (ResultType.STANDARD == resultType) {
 244                      String key = getCacheKey(resultType, translation.getEntityType());
 245                      LOG.debug(&quot;Removing key [&quot; + key + &quot;] for STANDARD site&quot;);
 246                      getCache().remove(key);
 247                  } else {
 248                      List&lt;String&gt; cacheKeysList =
 249                              getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType());
 250                      for (String key: cacheKeysList) {
 251                          LOG.debug(&quot;Removing key [&quot; + key + &quot;] for TEMPLATE site&quot;);
 252                          getCache().remove(key);
 253                      }
 254                  }
 255              }
 256          }
 257      }
 258  
 259      protected String getOverrideTranslatedValue(String property, TranslatedEntity entityType,
 260                                                  String entityId, String localeCode, String localeCountryCode) {
 261          boolean specificTranslationDeleted = false;
 262          boolean generalTranslationDeleted = false;
 263          StandardCacheItem specificTranslation = null;
 264          StandardCacheItem generalTranslation = null;
 265          String specificPropertyKey = property + &quot;_&quot; + localeCountryCode;
 266          String generalPropertyKey = property + &quot;_&quot; + localeCode;
 267          String response = null;
 268          String cacheKey = getCacheKey(ResultType.STANDARD, entityType);
 269          LocalePair override = null;
 270          for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 271              override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeCountryCode, cacheKey);"> 271              override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeCountryCoðŸ”µ</abbr>
 272              if(override != null) {
 273                  specificTranslation = override.getSpecificItem();
 274                  generalTranslation = override.getGeneralItem();
 275                  break;
 276              }
 277          }
 278          if (override == null) {
<abbr title=" 279              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 279              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid vðŸ”µ</abbr>
 280          }
 281  
 282          if (specificTranslation != null) {
 283              if (ItemStatus.DELETED.equals(specificTranslation.getItemStatus())) {
 284                  specificTranslationDeleted = true;
 285              } else {
 286                  if (specificTranslation.getCacheItem() instanceof Translation) {
 287                      response = ((Translation) specificTranslation.getCacheItem()).getTranslatedValue();
 288                  } else {
 289                      response = (String) specificTranslation.getCacheItem();
 290                  }
 291                  return replaceEmptyWithNullResponse(response);
 292              }
 293          }
 294  
 295          if (generalTranslation != null) {
 296              if (ItemStatus.DELETED.equals(generalTranslation.getItemStatus())) {
 297                  generalTranslationDeleted = true;
 298                  //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 299                  //If the general translation is override deleted and we&#x27;ve only got a general local code - we&#x27;re done"> 299                  //If the general translation is override deleted and we&#x27;ve only got a general local code - we&#x27;re dðŸ”µ</abbr>
 300                  if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 301                      return null;
 302                  }
 303              } else {
 304                  if (generalTranslation.getCacheItem() instanceof Translation) {
 305                      response = ((Translation) generalTranslation.getCacheItem()).getTranslatedValue();
 306                  } else {
 307                      response = (String) generalTranslation.getCacheItem();
 308                  }
 309                  //If the specific translation is override deleted as well, we&#x27;re done
 310                  //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re done
 311                  if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 312                      return replaceEmptyWithNullResponse(response);
 313                  }
 314                  //We have a valid general override - don&#x27;t check for general template value
 315                  generalTranslationDeleted = true;
 316              }
 317          }
 318  
 319          // Check for a Template Match
 320          if (specificTranslationDeleted) {
<abbr title=" 321              // only check general properties since we explicitly deleted specific properties at standard (site) level"> 321              // only check general properties since we explicitly deleted specific properties at standard (site) leðŸ”µ</abbr>
 322              specificPropertyKey = generalPropertyKey;
 323          } else if (generalTranslationDeleted) {
<abbr title=" 324              // only check specific properties since we explicitly deleted general properties at standard (site) level"> 324              // only check specific properties since we explicitly deleted general properties at standard (site) leðŸ”µ</abbr>
 325              generalPropertyKey = specificPropertyKey;
 326          }
 327  
 328          String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, localeCode,
 329                      localeCountryCode, specificPropertyKey, generalPropertyKey);
 330          if (templateResponse != null) {
 331              response = templateResponse;
 332          }
 333          return response;
 334      }
 335  
 336      protected String replaceEmptyWithNullResponse(String response) {
 337          if (!StringUtils.isEmpty(response)) {
 338              return response;
 339          }
 340          return null;
 341      }
 342  
<abbr title=" 343      protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntity entityType,"> 343      protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntity entityTðŸ”µ</abbr>
<abbr title=" 344                          String entityId, String localeCode, String localeCountryCode, String specificPropertyKey, String generalPropertyKey) {"> 344                          String entityId, String localeCode, String localeCountryCode, String specificPropertyKey, ðŸ”µ</abbr>
 345          String cacheKey = getCacheKey(ResultType.TEMPLATE, entityType);
 346          StandardCacheItem translation = null;
 347          LocalePair override = null;
 348          for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 349              override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, localeCode, localeCountryCode, specificPropertyKey, generalPropertyKey);"> 349              override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, localeCode, ðŸ”µ</abbr>
 350              if(override != null) {
 351                  translation = override.getSpecificItem();
 352                  if (!strategy.validateTemplateProcessing(standardCacheKey, cacheKey)) {
 353                      return null;
 354                  }
 355                  break;
 356              }
 357          }
 358          if (override == null) {
<abbr title=" 359              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 359              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid vðŸ”µ</abbr>
 360          }
<abbr title=" 361          return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheItem()).getTranslatedValue());"> 361          return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheItem()).getTðŸ”µ</abbr>
 362      }
 363  
 364      @Override
 365      public StandardCacheItem lookupTranslationFromMap(String key,
 366              Map&lt;String, Map&lt;String, StandardCacheItem&gt;&gt; propertyTranslationMap, String entityId) {
 367  
 368          StandardCacheItem cacheItem = null;
 369          if (propertyTranslationMap.containsKey(key)) {
 370              Map&lt;String, StandardCacheItem&gt; byEntity = propertyTranslationMap.get(key);
 371              cacheItem = byEntity.get(entityId);
 372          }
 373          return cacheItem;
 374      }
 375  
 376      @Override
<abbr title=" 377      public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey, Map&lt;String, Map&lt;String, Translation&gt;&gt; propertyTranslationMap, String entityId) {"> 377      public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey, Map&lt;StriðŸ”µ</abbr>
 378          Translation translation = null;
 379          if (propertyTranslationMap.containsKey(specificPropertyKey)) {
 380              Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(specificPropertyKey);
 381              translation = byEntity.get(entityId);
 382          }
 383          if (translation == null &amp;&amp; propertyTranslationMap.containsKey(generalPropertyKey)) {
 384              Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(generalPropertyKey);
 385              translation = byEntity.get(entityId);
 386          }
 387          return translation;
 388      }
 389  
 390      protected TranslatedEntity getEntityType(Class&lt;?&gt; entityClass) {
 391          for (Entry&lt;String, TranslatedEntity&gt; entry : TranslatedEntity.getTypes().entrySet()) {
 392              try {
 393                  Class&lt;?&gt; clazz = Class.forName(entry.getKey());
 394                  if (clazz.isAssignableFrom(entityClass)) {
 395                      return entry.getValue();
 396                  }
 397              } catch (ClassNotFoundException e) {
 398                  throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, e);
 399              }
 400          }
 401          throw new IllegalArgumentException(entityClass.getName() + &quot; is not a known translatable class&quot;);
 402      }
 403  
 404      protected TranslatedEntity getEntityType(Object entity) {
 405          return getEntityType(entity.getClass());
 406      }
 407  

 408      public TranslatedEntity getAssignableEntityType(String className) {
 409          try {
 410              Class&lt;?&gt; clazz = Class.forName(className);
 411              return getEntityType(clazz);
 412          } catch (ClassNotFoundException e) {
 413              throw new IllegalArgumentException(className + &quot; is not a known translatable class&quot;);
 414          }
 415      }
 416  
 417      @Override
 418      public String getCacheKey(ResultType resultType, TranslatedEntity entityType) {
 419          String cacheKey = StringUtils.join(new String[] { entityType.getFriendlyType()}, &quot;|&quot;);
 420          if (extensionManager != null) {
 421              ExtensionResultHolder&lt;String&gt; result = new ExtensionResultHolder&lt;String&gt;();
 422              extensionManager.getProxy().getCacheKey(cacheKey, resultType, result);
 423              if (result.getResult() != null) {
 424                  cacheKey = result.getResult();
 425              }
 426          }
 427          return cacheKey;
 428      }
 429  
 430      @Override
 431      public List&lt;String&gt; getCacheKeyListForTemplateSite(String propertyName) {
 432          List&lt;String&gt; cacheKeyList = new ArrayList&lt;&gt;();
 433          String cacheKey = StringUtils.join(new String[] {propertyName}, &quot;|&quot;);
 434          if (extensionManager != null) {
 435              ExtensionResultHolder&lt;List&lt;String&gt;&gt; result = new ExtensionResultHolder&lt;List&lt;String&gt;&gt;();
 436              extensionManager.getProxy().getCacheKeyListForTemplateSite(cacheKey, result);
 437              if (result.getResult() != null) {
 438                  cacheKeyList = result.getResult();
 439              }
 440          }
 441          return cacheKeyList;
 442      }
 443  
 444      @Override
 445      public int getThresholdForFullCache() {
 446          if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 447              return thresholdForFullCache;
 448          } else {
 449              // don&#x27;t cache when not in a SandBox
 450              return -1;
 451          }
 452      }
 453  
 454      @Override
 455      public void setThresholdForFullCache(int thresholdForFullCache) {
 456          this.thresholdForFullCache = thresholdForFullCache;
 457      }
 458  
 459      @Override
 460      public int getTemplateThresholdForFullCache() {
 461          if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 462              return templateThresholdForFullCache;
 463          } else {
 464              // don&#x27;t cache when not in a SandBox
 465              return -1;
 466          }
 467      }
 468  
 469      @Override
 470      public void setTemplateThresholdForFullCache(int templateThresholdForFullCache) {
 471          this.templateThresholdForFullCache = templateThresholdForFullCache;
 472      }
 473  
 474      @Override
 475      public String getDefaultTranslationValue(Object entity, String property, Locale locale,
 476              String requestedDefaultValue) {
 477  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 478 -        if (returnBlankTranslationForNotDefaultLocale &amp;&amp; !localeMatchesDefaultLocale(locale) &amp;&amp; !propertyInDefaultLocaleExceptionList(entity, property)) {"> 478 -        if (returnBlankTranslationForNotDefaultLocale &amp;&amp; !localeMatchesDefaultLocale(locale) &amp;&amp; !propertyInDefaultðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 479 +        if (returnBlankTranslationForNotDefaultLocale</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 480 +                &amp;&amp; !localeMatchesDefaultLocale(locale)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 481 +                &amp;&amp; !propertyInDefaultLocaleExceptionList(entity, property)) {</span>
 482              return &quot;&quot;;
 483          }
 484  
 485          return requestedDefaultValue;
 486      }
 487  
 488      @Override
<abbr title=" 489      public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType standard, List&lt;String&gt; entityIds) {"> 489      public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType standard, LisðŸ”µ</abbr>
 490          return dao.readAllTranslationEntries(translatedEntity, standard, entityIds);
 491      }
 492  
 493      /**
 494       * Returns true if the passed in entity / property combination is in the defaultLocaleExceptionList
 495       *
 496       * The default implementation checks the &quot;translationExceptionProperties&quot; list to see if the
 497       * property matches one of the regularExpressions in that list.
 498       *
 499       * Implementors are expected to override this method for implementation specific needs.
 500       *
 501       * @param entity
 502       * @param property
 503       * @return
 504       */
 505      protected boolean propertyInDefaultLocaleExceptionList(Object entity, String property) {
 506          TranslatedEntity entityType = getEntityType(entity);
 507          if (entityType != null &amp;&amp; entityType.getFriendlyType() != null) {
 508              for (String exceptionProperty : translationExceptionProperties) {
 509                  if (property.matches(exceptionProperty)) {
 510                      return true;
 511                  }
 512              }
 513          }
 514          return false;
 515      }
 516  
 517      /**
 518       * Returns true if the passed in locale&#x27;s language matches the Broadleaf default locale.
 519       * @param locale
 520       * @return
 521       */
 522      protected boolean localeMatchesDefaultLocale(Locale locale) {
 523          String defaultLanguage = LocaleUtil.findLanguageCode(localeService.findDefaultLocale());
 524  
 525          if (defaultLanguage != null &amp;&amp; locale != null) {
 526              return defaultLanguage.equals(locale.getLanguage());
 527          }
 528          return false;
 529      }
 530  
 531  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            