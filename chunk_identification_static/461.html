<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>461</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    461
                    <a href="460.html">prev</a>
                    <a href="462.html">next</a>
                    <a href="461_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    EhsanTang/ApiManager_8d736aa2e68667d44b70ef12bcb8ddd207f641a5_api/src/main/java/cn/crap/controller/user/InterfaceController.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\EhsanTang\ApiManager show &quot;8d736aa2e68667d44b70ef12bcb8ddd207f641a5:api/src/main/java/cn/crap/controller/user/InterfaceController.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\EhsanTang\ApiManager show &quot;8d736aa2e68667d44b70ef12bcb8ddd207f641a5^1:api/src/main/java/cn/crap/controller/user/InterfaceController.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\EhsanTang\ApiManager show &quot;8d736aa2e68667d44b70ef12bcb8ddd207f641a5^2:api/src/main/java/cn/crap/controller/user/InterfaceController.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\EhsanTang\ApiManager show &quot;d55f2c80dd4e445a00e823a5d1bd2f8dbc94ffd8:api/src/main/java/cn/crap/controller/user/InterfaceController.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [s]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package cn.crap.controller.user;
   2 
   3 import cn.crap.adapter.InterfaceAdapter;
   4 import cn.crap.beans.Config;
   5 import cn.crap.dto.InterfaceDto;
   6 import cn.crap.dto.LoginInfoDto;
   7 import cn.crap.dto.SearchDto;
   8 import cn.crap.enumer.MonitorType;
   9 import cn.crap.enumer.MyError;
  10 import cn.crap.framework.JsonResult;
  11 import cn.crap.framework.MyException;
  12 import cn.crap.framework.base.BaseController;
  13 import cn.crap.framework.interceptor.AuthPassport;
  14 import cn.crap.model.Error;
  15 import cn.crap.model.InterfaceWithBLOBs;
  16 import cn.crap.model.Module;
  17 import cn.crap.model.Project;
  18 import cn.crap.query.ErrorQuery;
  19 import cn.crap.query.InterfaceQuery;
  20 import cn.crap.service.ErrorService;
  21 import cn.crap.service.ISearchService;
  22 import cn.crap.service.InterfaceService;
  23 import cn.crap.utils.LoginUserHelper;
  24 import cn.crap.utils.MyString;
  25 import cn.crap.utils.Page;
  26 import cn.crap.utils.Tools;
  27 import net.sf.json.JSONArray;
  28 import org.springframework.beans.factory.annotation.Autowired;
  29 import org.springframework.stereotype.Controller;
  30 import org.springframework.util.Assert;
  31 import org.springframework.web.bind.annotation.ModelAttribute;
  32 import org.springframework.web.bind.annotation.RequestMapping;
  33 import org.springframework.web.bind.annotation.RequestParam;
  34 import org.springframework.web.bind.annotation.ResponseBody;
  35 
  36 import java.io.IOException;
  37 import java.util.List;
  38 
  39 @Controller
  40 @RequestMapping(&quot;/user/interface&quot;)
  41 public class InterfaceController extends BaseController{
  42 
  43 	@Autowired
  44 	private InterfaceService interfaceService;
  45 	@Autowired
  46 	private ISearchService luceneService;
  47 	@Autowired
  48 	private ErrorService errorService;
  49 	@Autowired
  50 	private Config config;
  51 	
  52 	
  53 	@RequestMapping(&quot;/list.do&quot;)
  54 	@ResponseBody
  55 	@AuthPassport
  56 	public JsonResult list(@RequestParam String moduleId, String interfaceName, String url,
  57 			 Integer currentPage) throws MyException{
  58 		InterfaceQuery interfaceQuery = new InterfaceQuery();
<abbr title="  59 		interfaceQuery.setModuleId(moduleId).setInterfaceName(interfaceName).setFullUrl(url).setCurrentPage(currentPage);">  59 		interfaceQuery.setModuleId(moduleId).setInterfaceName(interfaceName).setFullUrl(url).setCurrentPage(curüîµ</abbr>
  60 		Page page= new Page(interfaceQuery);
  61 
  62 		Module module = moduleCache.get(moduleId);
  63 		Project project = projectCache.get(module.getProjectId());
  64 		checkUserPermissionByProject(project.getId(), VIEW);
  65 
  66 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  67 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module, project);">  67 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module,üîµ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68 		page.setAllRow(interfaceService.count(interfaceQuery));</span>
  69 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  71 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(example), null);">  71 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBüîµ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72 		JsonResult result = new JsonResult(1, interfaces, page);</span>
  73 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  74 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(example), null);">  74 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBüîµ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75         page.setAllRow(mybatisInterfaceService.countByExample(example));</span>
  76 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  77 		JsonResult result = new JsonResult(1, interfaces, page);
  78 		result.putOthers(&quot;crumbs&quot;, Tools.getCrumbs(&quot;Êé•Âè£ÂàóË°®:&quot;+ moduleCache.get(moduleId).getName(),&quot;void&quot;))
  79 				.putOthers(&quot;module&quot;, moduleCache.get(moduleId));
  80 
  81 		return result;
  82 		
  83 	}
  84 
  85 	@RequestMapping(&quot;/detail.do&quot;)
  86 	@ResponseBody
  87 	public JsonResult detail(String id, String moduleId) throws MyException {
  88 		InterfaceWithBLOBs model;
  89 		Module module = null;
  90 		if(id != null){
  91 			model= interfaceService.getById(id);
  92 			module = moduleCache.get(model.getModuleId());
  93 			checkUserPermissionByProject(model.getProjectId(), VIEW);
  94 		}else{
  95 			model = new InterfaceWithBLOBs();
  96 			module = moduleCache.get(moduleId);
  97 			model.setModuleId( moduleId);
  98 			model.setProjectId(module.getProjectId());
  99 			model.setParam(&quot;form=[]&quot;);
 100 			model.setResponseParam(&quot;[]&quot;);
 101 			model.setHeader(&quot;[]&quot;);
 102 			model.setParamRemark(&quot;[]&quot;);
 103 			if(!MyString.isEmpty(module.getTemplateId())){
 104 				InterfaceWithBLOBs template = interfaceService.getById(module.getTemplateId());
 105 				// Ê†πÊçÆÊ®°ÊùøÂàùÂßãÂåñÊé•Âè£
 106 				if(template != null){
 107 					model.setHeader(template.getHeader());
 108 					model.setParam(template.getParam());
 109 					model.setMethod(template.getMethod());
 110 					model.setVersion(template.getVersion());
 111 					model.setParamRemark(template.getParamRemark());
 112 					model.setResponseParam(template.getResponseParam());
 113 					model.setErrorList(template.getErrorList());
 114 					model.setErrors(template.getErrors());
 115 					model.setFalseExam(template.getFalseExam());
 116 					model.setTrueExam(template.getTrueExam());
 117 					model.setStatus(template.getStatus());
 118 					model.setContentType(template.getContentType());
 119 				}
 120 			}
 121 		}
 122 		return new JsonResult(1, InterfaceAdapter.getDto(model, module, null, false));
 123 	}
 124 	
 125 	/**
 126 	 * @param interFace
 127 	 * @return
 128 	 * @throws MyException
 129 	 * @throws IOException
 130 	 */
 131 	@RequestMapping(&quot;/copy.do&quot;)
 132 	@ResponseBody
 133 	public JsonResult copy(@ModelAttribute InterfaceDto interFace) throws MyException, IOException {
 134 		//Âà§Êñ≠ÊòØÂê¶Êã•ÊúâËØ•Ê®°ÂùóÁöÑÊùÉÈôê
 135 		checkUserPermissionByProject(interFace.getProjectId(), ADD_INTER);
 136 		Module module = moduleCache.get(interFace.getModuleId());
 137 
 138 		if(!config.isCanRepeatUrl()){
<abbr title=" 139 			if (interfaceService.count(new InterfaceQuery().setModuleId(interFace.getModuleId()).setEqualFullUrl(module.getUrl() + interFace.getUrl())) &gt; 0){"> 139 			if (interfaceService.count(new InterfaceQuery().setModuleId(interFace.getModuleId()).setEqualFullUrl(müîµ</abbr>
 140 				throw new MyException(MyError.E000004);
 141 			}
 142 		}
 143 		interFace.setId(null);
 144 		interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 145 		interfaceService.insert(InterfaceAdapter.getModel(interFace));
 146 
 147 		luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 148 		return new JsonResult(1, interFace);
 149 	}
 150 	
 151 	/**
 152 	 * Ê†πÊçÆÂèÇÊï∞ÁîüÊàêËØ∑Ê±ÇÁ§∫‰æã
 153 	 * @param interFace
 154 	 * @return
 155 	 */
 156 	@RequestMapping(&quot;/getRequestExam.do&quot;)
 157 	@ResponseBody
 158 	@AuthPassport
 159 	public JsonResult getRequestExam(@ModelAttribute InterfaceDto interFace) {
 160 		interfaceService.getInterFaceRequestExam(interFace);
 161 		return new JsonResult(1, interFace);
 162 	}
 163 
 164 	@RequestMapping(&quot;/addOrUpdate.do&quot;)
 165 	@ResponseBody
 166 	@AuthPassport
 167 	public JsonResult addOrUpdate(@ModelAttribute InterfaceDto interFace) throws IOException, MyException {
 168 		Assert.notNull(interFace.getProjectId(), &quot;projectId can&#x27;t be null&quot;);
 169 
 170 		if(MyString.isEmpty(interFace.getUrl())) {
 171 			return new JsonResult(MyError.E000005);
 172 		}
 173 		interFace.setUrl(interFace.getUrl().trim());
 174 		
 175 		/**
 176 		 * Ê†πÊçÆÈÄâÁùÄÁöÑÈîôËØØÁ†ÅidÔºåÁªÑË£ÖjsonÂ≠óÁ¨¶‰∏≤
 177 		 */
 178         ErrorQuery query = new ErrorQuery().setProjectId(interFace.getProjectId())
 179                 .setErrorCodeList(Tools.getIdsFromField(interFace.getErrorList())).setPageSize(100);
 180         List&lt;Error&gt; errors  = errorService.query(query);
 181 		interFace.setErrors(JSONArray.fromObject(errors).toString());
 182 
 183 		LoginInfoDto user = LoginUserHelper.getUser();
 184 		interFace.setUpdateBy(&quot;userNameÔºö&quot;+user.getUserName()+&quot; | trueNameÔºö&quot;+ user.getTrueName());
 185 
 186 		//ËØ∑Ê±ÇÁ§∫‰æã‰∏∫Á©∫ÔºåÂàôËá™Âä®Ê∑ªÂä†
 187 		if(MyString.isEmpty(interFace.getRequestExam())){
 188 			interfaceService.getInterFaceRequestExam(interFace);
 189 		}
 190         interFace.setMonitorType(MonitorType.No.getValue());
 191 		//Ê£ÄÊü•ÈÇÆ‰ª∂Ê†ºÂºèÊòØÂê¶Ê≠£Á°Æ
 192 		/**if(interFace.getMonitorType() != MonitorType.No.getValue()){
 193 			if(!MyString.isEmpty(interFace.getMonitorEmails())){
 194 				for(String email : interFace.getMonitorEmails().split(&quot;;&quot;)){
 195 					if( !Tools.checkEmail(email) ){
 196 						throw new MyException(E000032&quot;);
 197 					}
 198 				}
 199 			}else{
 200 				throw new MyException(E000032&quot;);
 201 			}
 202 		}**/
 203 
 204 		Module module = moduleCache.get(interFace.getModuleId());
 205 		if (!MyString.isEmpty(interFace.getId())) {
 206 			String oldModuleId = interfaceService.getById(interFace.getId()).getModuleId();
 207 			String projectId = moduleCache.get(oldModuleId).getProjectId();
 208 			Project project = projectCache.get(interFace.getProjectId() );
 209 
 210 			// Êé•Âè£Âè™ËÉΩÂú®Âêå‰∏Ä‰∏™È°πÁõÆ‰∏ãÁöÑÊ®°Âùó‰∏≠ÁßªÂä®
 211 			if( !projectId.equals(project.getId())){
 212 				throw new MyException(MyError.E000047);
 213 			}
 214 			// Âà§Êñ≠ÊòØÂê¶Êúâ‰øÆÊîπÊ®°ÂùóÁöÑÊùÉÈôê
 215 			checkUserPermissionByProject(project, MOD_INTER);
 216 			
 217 			//Âêå‰∏ÄÊ®°Âùó‰∏ã‰∏çÂÖÅËÆ∏ url ÈáçÂ§ç
 218             InterfaceQuery interfaceQuery = new InterfaceQuery();
<abbr title=" 219             interfaceQuery.setModuleId(interFace.getModuleId()).setFullUrl(module.getUrl() +interFace.getUrl()).setExceptId(interFace.getId());"> 219             interfaceQuery.setModuleId(interFace.getModuleId()).setFullUrl(module.getUrl() +interFace.getüîµ</abbr>
 220 			if( !config.isCanRepeatUrl() &amp;&amp; interfaceService.count(interfaceQuery) &gt;0 ){
 221 				throw new MyException(MyError.E000004);
 222 			}
 223 			
 224 			interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 225 			interfaceService.update(InterfaceAdapter.getModel(interFace), &quot;Êé•Âè£&quot;, &quot;&quot;);
 226 			if(interFace.getId().equals(interFace.getProjectId())){
 227 				throw new MyException(MyError.E000027);
 228 			}
 229 			luceneService.update(InterfaceAdapter.getSearchDto(interFace));
 230 			
 231 		} else {
 232 			checkUserPermissionByProject(projectCache.get(interFace.getProjectId() ), ADD_INTER);
 233             InterfaceQuery interfaceQuery = new InterfaceQuery();
<abbr title=" 234             interfaceQuery.setModuleId(interFace.getModuleId()).setFullUrl(module.getUrl() +interFace.getUrl());"> 234             interfaceQuery.setModuleId(interFace.getModuleId()).setFullUrl(module.getUrl() +interFace.getüîµ</abbr>
 235 			if(!config.isCanRepeatUrl() &amp;&amp; interfaceService.count(interfaceQuery)&gt;0){
 236 				return new JsonResult(MyError.E000004);
 237 			}
 238 			interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 239 			interfaceService.insert(InterfaceAdapter.getModel(interFace));
 240 			luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 241 		}
 242 		return new JsonResult(1, interFace);
 243 	}
 244 
 245 	@RequestMapping(&quot;/delete.do&quot;)
 246 	@ResponseBody
 247 	public JsonResult delete(String id, String ids) throws MyException, IOException{
 248 		if( MyString.isEmpty(id) &amp;&amp; MyString.isEmpty(ids)){
 249 			throw new MyException(MyError.E000029);
 250 		}
 251 		if( MyString.isEmpty(ids) ){
 252 			ids = id;
 253 		}
 254 		
 255 		for(String tempId : ids.split(&quot;,&quot;)){
 256 			if(MyString.isEmpty(tempId)){
 257 				continue;
 258 			}
 259 			InterfaceWithBLOBs interFace = interfaceService.getById( tempId );
 260 			checkUserPermissionByProject(interFace.getProjectId(), DEL_INTER);
 261 			interfaceService.delete(interFace.getId(), &quot;Êé•Âè£&quot;, &quot;&quot;);
 262 			luceneService.delete(new SearchDto(interFace.getId()));
 263 		}
 264 		return new JsonResult(1, null);
 265 	}
 266 
 267 	@RequestMapping(&quot;/changeSequence.do&quot;)
 268 	@ResponseBody
<abbr title=" 269 	public JsonResult changeSequence(@RequestParam String id,@RequestParam String changeId) throws MyException {"> 269 	public JsonResult changeSequence(@RequestParam String id,@RequestParam String changeId) throws MyExceptiüîµ</abbr>
 270 		InterfaceWithBLOBs change = interfaceService.getById(changeId);
 271 		InterfaceWithBLOBs model = interfaceService.getById(id);
 272 		checkUserPermissionByProject(model.getProjectId(), MOD_INTER);
 273 		checkUserPermissionByProject(change.getProjectId(), MOD_INTER);
 274 		
 275 		int modelSequence = model.getSequence();
 276 		
 277 		model.setSequence(change.getSequence());
 278 		change.setSequence(modelSequence);
 279 
 280 		interfaceService.update(model);
 281 		interfaceService.update(change);
 282 		return new JsonResult(1, null);
 283 	}
 284 }
 
 </pre></td>
                            <td><pre>   1 package cn.crap.controller.user;
   2 
   3 import cn.crap.adapter.InterfaceAdapter;
   4 import cn.crap.dto.InterfaceDto;
   5 import cn.crap.dto.LoginInfoDto;
   6 import cn.crap.dto.SearchDto;
   7 import cn.crap.enumer.MonitorType;
   8 import cn.crap.enumer.MyError;
   9 import cn.crap.framework.JsonResult;
  10 import cn.crap.framework.MyException;
  11 import cn.crap.framework.base.BaseController;
  12 import cn.crap.framework.interceptor.AuthPassport;
  13 import cn.crap.model.Error;
  14 import cn.crap.model.InterfaceWithBLOBs;
  15 import cn.crap.model.Module;
  16 import cn.crap.model.Project;
  17 import cn.crap.query.ErrorQuery;
  18 import cn.crap.query.InterfaceQuery;
  19 import cn.crap.service.ErrorService;
  20 import cn.crap.service.ISearchService;
  21 import cn.crap.service.InterfaceService;
  22 import cn.crap.utils.LoginUserHelper;
  23 import cn.crap.utils.MyString;
  24 import cn.crap.utils.Page;
  25 import cn.crap.utils.Tools;
  26 import cn.crap.beans.Config;
  27 import net.sf.json.JSONArray;
  28 import org.springframework.beans.factory.annotation.Autowired;
  29 import org.springframework.stereotype.Controller;
  30 import org.springframework.util.Assert;
  31 import org.springframework.web.bind.annotation.ModelAttribute;
  32 import org.springframework.web.bind.annotation.RequestMapping;
  33 import org.springframework.web.bind.annotation.RequestParam;
  34 import org.springframework.web.bind.annotation.ResponseBody;
  35 
  36 import java.io.IOException;
  37 import java.util.List;
  38 
  39 @Controller
  40 @RequestMapping(&quot;/user/interface&quot;)
  41 public class InterfaceController extends BaseController{
  42 
  43 	@Autowired
  44 	private InterfaceService interfaceService;
  45 	@Autowired
  46 	private ISearchService luceneService;
  47 	@Autowired
  48 	private ErrorService errorService;
  49 	@Autowired
  50 	private Config config;
  51 
  52 
  53 	@RequestMapping(&quot;/list.do&quot;)
  54 	@ResponseBody
  55 	@AuthPassport
  56 	public JsonResult list(@RequestParam String moduleId, String interfaceName, String url,
  57 			 Integer currentPage) throws MyException{
  58 		InterfaceQuery interfaceQuery = new InterfaceQuery();
<abbr title="  59 		interfaceQuery.setModuleId(moduleId).setInterfaceName(interfaceName).setFullUrl(url).setCurrentPage(currentPage);">  59 		interfaceQuery.setModuleId(moduleId).setInterfaceName(interfaceName).setFullUrl(url).setCurrentPage(curüîµ</abbr>
  60 		Page page= new Page(interfaceQuery);
  61 
  62 		Module module = moduleCache.get(moduleId);
  63 		Project project = projectCache.get(module.getProjectId());
  64 		checkUserPermissionByProject(project.getId(), VIEW);
  65 
  66 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  67 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module, project);">  67 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module,üîµ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68 		page.setAllRow(interfaceService.count(interfaceQuery));</span>
  69 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 		if (!MyString.isEmpty(url)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71 			criteria.andFullUrlLike(&quot;%&quot; + url + &quot;%&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  74 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(example), null);">  74 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBüîµ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75 		JsonResult result = new JsonResult(1, interfaces, page);</span>
  76 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  77 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(example), null);">  77 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBüîµ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78         page.setAllRow(mybatisInterfaceService.countByExample(example));</span>
  79 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  80 		JsonResult result = new JsonResult(1, interfaces, page);
  81 		result.putOthers(&quot;crumbs&quot;, Tools.getCrumbs(&quot;Êé•Âè£ÂàóË°®:&quot;+ moduleCache.get(moduleId).getName(),&quot;void&quot;))
  82 				.putOthers(&quot;module&quot;, moduleCache.get(moduleId));
  83 
  84 		return result;
  85 
  86 	}
  87 
  88 	@RequestMapping(&quot;/detail.do&quot;)
  89 	@ResponseBody
  90 	public JsonResult detail(String id, String moduleId) throws MyException {
  91 		InterfaceWithBLOBs model;
  92 		Module module = null;
  93 		if(id != null){
  94 			model= interfaceService.getById(id);
  95 			module = moduleCache.get(model.getModuleId());
  96 			checkUserPermissionByProject(model.getProjectId(), VIEW);
  97 		}else{
  98 			model = new InterfaceWithBLOBs();
  99 			module = moduleCache.get(moduleId);
 100 			model.setModuleId( moduleId);
 101 			model.setProjectId(module.getProjectId());
 102 			model.setParam(&quot;form=[]&quot;);
 103 			model.setResponseParam(&quot;[]&quot;);
 104 			model.setHeader(&quot;[]&quot;);
 105 			model.setParamRemark(&quot;[]&quot;);
 106 			if(!MyString.isEmpty(module.getTemplateId())){
 107 				InterfaceWithBLOBs template = interfaceService.getById(module.getTemplateId());
 108 				// Ê†πÊçÆÊ®°ÊùøÂàùÂßãÂåñÊé•Âè£
 109 				if(template != null){
 110 					model.setHeader(template.getHeader());
 111 					model.setParam(template.getParam());
 112 					model.setMethod(template.getMethod());
 113 					model.setVersion(template.getVersion());
 114 					model.setParamRemark(template.getParamRemark());
 115 					model.setResponseParam(template.getResponseParam());
 116 					model.setErrorList(template.getErrorList());
 117 					model.setErrors(template.getErrors());
 118 					model.setFalseExam(template.getFalseExam());
 119 					model.setTrueExam(template.getTrueExam());
 120 					model.setStatus(template.getStatus());
 121 					model.setContentType(template.getContentType());
 122 				}
 123 			}
 124 		}
 125 		return new JsonResult(1, InterfaceAdapter.getDto(model, module, null, false));
 126 	}
 127 
 128 	/**
 129 	 * @param interFace
 130 	 * @return
 131 	 * @throws MyException
 132 	 * @throws IOException
 133 	 */
 134 	@RequestMapping(&quot;/copy.do&quot;)
 135 	@ResponseBody
 136 	public JsonResult copy(@ModelAttribute InterfaceDto interFace) throws MyException, IOException {
 137 		//Âà§Êñ≠ÊòØÂê¶Êã•ÊúâËØ•Ê®°ÂùóÁöÑÊùÉÈôê
 138 		checkUserPermissionByProject(interFace.getProjectId(), ADD_INTER);
 139 		Module module = moduleCache.get(interFace.getModuleId());
 140 
 141 		if(!config.isCanRepeatUrl()){
<abbr title=" 142 			if (interfaceService.count(new InterfaceQuery().setModuleId(interFace.getModuleId()).setEqualFullUrl(module.getUrl() + interFace.getUrl())) &gt; 0){"> 142 			if (interfaceService.count(new InterfaceQuery().setModuleId(interFace.getModuleId()).setEqualFullUrl(müîµ</abbr>
 143 				throw new MyException(MyError.E000004);
 144 			}
 145 		}
 146 		interFace.setId(null);
 147 		interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 148 		interfaceService.insert(InterfaceAdapter.getModel(interFace));
 149 
 150 		luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 151 		return new JsonResult(1, interFace);
 152 	}
 153 
 154 	/**
 155 	 * Ê†πÊçÆÂèÇÊï∞ÁîüÊàêËØ∑Ê±ÇÁ§∫‰æã
 156 	 * @param interFace
 157 	 * @return
 158 	 */
 159 	@RequestMapping(&quot;/getRequestExam.do&quot;)
 160 	@ResponseBody
 161 	@AuthPassport
 162 	public JsonResult getRequestExam(@ModelAttribute InterfaceDto interFace) {
 163 		interfaceService.getInterFaceRequestExam(interFace);
 164 		return new JsonResult(1, interFace);
 165 	}
 166 
 167 	@RequestMapping(&quot;/addOrUpdate.do&quot;)
 168 	@ResponseBody
 169 	@AuthPassport
 170 	public JsonResult addOrUpdate(@ModelAttribute InterfaceDto interFace) throws IOException, MyException {
 171 		Assert.notNull(interFace.getProjectId(), &quot;projectId can&#x27;t be null&quot;);
 172 
 173 		if(MyString.isEmpty(interFace.getUrl())) {
 174 			return new JsonResult(MyError.E000005);
 175 		}
 176 		interFace.setUrl(interFace.getUrl().trim());
 177 
 178 		/**
 179 		 * Ê†πÊçÆÈÄâÁùÄÁöÑÈîôËØØÁ†ÅidÔºåÁªÑË£ÖjsonÂ≠óÁ¨¶‰∏≤
 180 		 */
 181         ErrorQuery query = new ErrorQuery().setProjectId(interFace.getProjectId())
 182                 .setErrorCodeList(Tools.getIdsFromField(interFace.getErrorList())).setPageSize(100);
 183         List&lt;Error&gt; errors  = errorService.query(query);
 184 		interFace.setErrors(JSONArray.fromObject(errors).toString());
 185 
 186 		LoginInfoDto user = LoginUserHelper.getUser();
 187 		interFace.setUpdateBy(&quot;userNameÔºö&quot;+user.getUserName()+&quot; | trueNameÔºö&quot;+ user.getTrueName());
 188 
 189 		//ËØ∑Ê±ÇÁ§∫‰æã‰∏∫Á©∫ÔºåÂàôËá™Âä®Ê∑ªÂä†
 190 		if(MyString.isEmpty(interFace.getRequestExam())){
 191 			interfaceService.getInterFaceRequestExam(interFace);
 192 		}
 193         interFace.setMonitorType(MonitorType.No.getValue());
 194 		//Ê£ÄÊü•ÈÇÆ‰ª∂Ê†ºÂºèÊòØÂê¶Ê≠£Á°Æ
 195 		/**if(interFace.getMonitorType() != MonitorType.No.getValue()){
 196 			if(!MyString.isEmpty(interFace.getMonitorEmails())){
 197 				for(String email : interFace.getMonitorEmails().split(&quot;;&quot;)){
 198 					if( !Tools.checkEmail(email) ){
 199 						throw new MyException(E000032&quot;);
 200 					}
 201 				}
 202 			}else{
 203 				throw new MyException(E000032&quot;);
 204 			}
 205 		}**/
 206 
 207 		Module module = moduleCache.get(interFace.getModuleId());
 208 		if (!MyString.isEmpty(interFace.getId())) {
 209 			String oldModuleId = interfaceService.getById(interFace.getId()).getModuleId();
 210 			String projectId = moduleCache.get(oldModuleId).getProjectId();
 211 			Project project = projectCache.get(interFace.getProjectId() );
 212 
 213 			// Êé•Âè£Âè™ËÉΩÂú®Âêå‰∏Ä‰∏™È°πÁõÆ‰∏ãÁöÑÊ®°Âùó‰∏≠ÁßªÂä®
 214 			if( !projectId.equals(project.getId())){
 215 				throw new MyException(MyError.E000047);
 216 			}
 217 			// Âà§Êñ≠ÊòØÂê¶Êúâ‰øÆÊîπÊ®°ÂùóÁöÑÊùÉÈôê
 218 			checkUserPermissionByProject(project, MOD_INTER);
 219 
 220 			//Âêå‰∏ÄÊ®°Âùó‰∏ã‰∏çÂÖÅËÆ∏ url ÈáçÂ§ç
 221             InterfaceQuery interfaceQuery = new InterfaceQuery();
<abbr title=" 222             interfaceQuery.setModuleId(interFace.getModuleId()).setFullUrl(module.getUrl() +interFace.getUrl()).setExceptId(interFace.getId());"> 222             interfaceQuery.setModuleId(interFace.getModuleId()).setFullUrl(module.getUrl() +interFace.getüîµ</abbr>
 223 			if( !config.isCanRepeatUrl() &amp;&amp; interfaceService.count(interfaceQuery) &gt;0 ){
 224 				throw new MyException(MyError.E000004);
 225 			}
 226 
 227 			interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 228 			interfaceService.update(InterfaceAdapter.getModel(interFace), &quot;Êé•Âè£&quot;, &quot;&quot;);
 229 			if(interFace.getId().equals(interFace.getProjectId())){
 230 				throw new MyException(MyError.E000027);
 231 			}
 232 			luceneService.update(InterfaceAdapter.getSearchDto(interFace));
 233 
 234 		} else {
 235 			checkUserPermissionByProject(projectCache.get(interFace.getProjectId() ), ADD_INTER);
 236             InterfaceQuery interfaceQuery = new InterfaceQuery();
<abbr title=" 237             interfaceQuery.setModuleId(interFace.getModuleId()).setFullUrl(module.getUrl() +interFace.getUrl());"> 237             interfaceQuery.setModuleId(interFace.getModuleId()).setFullUrl(module.getUrl() +interFace.getüîµ</abbr>
 238 			if(!config.isCanRepeatUrl() &amp;&amp; interfaceService.count(interfaceQuery)&gt;0){
 239 				return new JsonResult(MyError.E000004);
 240 			}
 241 			interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 242 			interfaceService.insert(InterfaceAdapter.getModel(interFace));
 243 			luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 244 		}
 245 		return new JsonResult(1, interFace);
 246 	}
 247 
 248 	@RequestMapping(&quot;/delete.do&quot;)
 249 	@ResponseBody
 250 	public JsonResult delete(String id, String ids) throws MyException, IOException{
 251 		if( MyString.isEmpty(id) &amp;&amp; MyString.isEmpty(ids)){
 252 			throw new MyException(MyError.E000029);
 253 		}
 254 		if( MyString.isEmpty(ids) ){
 255 			ids = id;
 256 		}
 257 
 258 		for(String tempId : ids.split(&quot;,&quot;)){
 259 			if(MyString.isEmpty(tempId)){
 260 				continue;
 261 			}
 262 			InterfaceWithBLOBs interFace = interfaceService.getById( tempId );
 263 			checkUserPermissionByProject(interFace.getProjectId(), DEL_INTER);
 264 			interfaceService.delete(interFace.getId(), &quot;Êé•Âè£&quot;, &quot;&quot;);
 265 			luceneService.delete(new SearchDto(interFace.getId()));
 266 		}
 267 		return new JsonResult(1, null);
 268 	}
 269 
 270 	@RequestMapping(&quot;/changeSequence.do&quot;)
 271 	@ResponseBody
<abbr title=" 272 	public JsonResult changeSequence(@RequestParam String id,@RequestParam String changeId) throws MyException {"> 272 	public JsonResult changeSequence(@RequestParam String id,@RequestParam String changeId) throws MyExceptiüîµ</abbr>
 273 		InterfaceWithBLOBs change = interfaceService.getById(changeId);
 274 		InterfaceWithBLOBs model = interfaceService.getById(id);
 275 		checkUserPermissionByProject(model.getProjectId(), MOD_INTER);
 276 		checkUserPermissionByProject(change.getProjectId(), MOD_INTER);
 277 
 278 		int modelSequence = model.getSequence();
 279 
 280 		model.setSequence(change.getSequence());
 281 		change.setSequence(modelSequence);
 282 
 283 		interfaceService.update(model);
 284 		interfaceService.update(change);
 285 		return new JsonResult(1, null);
 286 	}
 287 }</pre></td>
                            <td><pre>   1 package cn.crap.controller.user;
   2 
   3 import cn.crap.adapter.InterfaceAdapter;
   4 import cn.crap.beans.Config;
   5 import cn.crap.dto.InterfaceDto;
   6 import cn.crap.dto.LoginInfoDto;
   7 import cn.crap.dto.SearchDto;
   8 import cn.crap.enumer.MonitorType;
   9 import cn.crap.enumer.MyError;
  10 import cn.crap.framework.JsonResult;
  11 import cn.crap.framework.MyException;
  12 import cn.crap.framework.base.BaseController;
  13 import cn.crap.framework.interceptor.AuthPassport;
  14 import cn.crap.model.Error;
  15 import cn.crap.model.InterfaceWithBLOBs;
  16 import cn.crap.model.Module;
  17 import cn.crap.model.Project;
  18 import cn.crap.query.ErrorQuery;
  19 import cn.crap.query.InterfaceQuery;
  20 import cn.crap.service.ErrorService;
  21 import cn.crap.service.ISearchService;
  22 import cn.crap.service.InterfaceService;
  23 import cn.crap.utils.LoginUserHelper;
  24 import cn.crap.utils.MyString;
  25 import cn.crap.utils.Page;
  26 import cn.crap.utils.Tools;
  27 import java.io.IOException;
  28 import java.util.List;
  29 import net.sf.json.JSONArray;
  30 import org.springframework.beans.factory.annotation.Autowired;
  31 import org.springframework.stereotype.Controller;
  32 import org.springframework.util.Assert;
  33 import org.springframework.web.bind.annotation.ModelAttribute;
  34 import org.springframework.web.bind.annotation.RequestMapping;
  35 import org.springframework.web.bind.annotation.RequestParam;
  36 import org.springframework.web.bind.annotation.ResponseBody;
  37 
  38 
  39 @Controller
  40 @RequestMapping(&quot;/user/interface&quot;)
  41 public class InterfaceController extends BaseController {
  42 	@Autowired
  43 	private InterfaceService interfaceService;
  44 
  45 	@Autowired
  46 	private ISearchService luceneService;
  47 
  48 	@Autowired
  49 	private ErrorService errorService;
  50 
  51 	@Autowired
  52 	private Config config;
  53 
  54 	@RequestMapping(&quot;/list.do&quot;)
  55 	@ResponseBody
  56 	@AuthPassport
  57 	public JsonResult list(@RequestParam
  58 	String moduleId, String interfaceName, String url, Integer currentPage) throws MyException {
  59 		InterfaceQuery interfaceQuery = new InterfaceQuery();
<abbr title="  60 		interfaceQuery.setModuleId(moduleId).setInterfaceName(interfaceName).setFullUrl(url).setCurrentPage(currentPage);">  60 		interfaceQuery.setModuleId(moduleId).setInterfaceName(interfaceName).setFullUrl(url).setCurrentPage(curüîµ</abbr>
  61 		Page page = new Page(interfaceQuery);
  62 		Module module = moduleCache.get(moduleId);
  63 		Project project = projectCache.get(module.getProjectId());
  64 		checkUserPermissionByProject(project.getId(), VIEW);
<abbr title="  65 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module, project);">  65 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module,üîµ</abbr>
  66 
  67 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68 		page.setAllRow(interfaceService.count(interfaceQuery));</span>
  69 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  70 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  70 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwüîµ</abbr></span>
  71 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73         page.setAllRow(mybatisInterfaceService.countByExample(example));</span>
  74 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
  75 
  76 		JsonResult result = new JsonResult(1, interfaces, page);
<abbr title="  77 		result.putOthers(&quot;crumbs&quot;, Tools.getCrumbs(&quot;Êé•Âè£ÂàóË°®:&quot; + moduleCache.get(moduleId).getName(), &quot;void&quot;)).putOthers(&quot;module&quot;, moduleCache.get(moduleId));">  77 		result.putOthers(&quot;crumbs&quot;, Tools.getCrumbs(&quot;Êé•Âè£ÂàóË°®:&quot; + moduleCache.get(moduleId).getName(), &quot;void&quot;)).putOüîµ</abbr>
  78 		return result;
  79 	}
  80 
  81 	@RequestMapping(&quot;/detail.do&quot;)
  82 	@ResponseBody
  83 	public JsonResult detail(String id, String moduleId) throws MyException {
  84 		InterfaceWithBLOBs model;
  85 		Module module = null;
  86 		if (id != null) {
  87 			model = interfaceService.getById(id);
  88 			module = moduleCache.get(model.getModuleId());
  89 			checkUserPermissionByProject(model.getProjectId(), VIEW);
  90 		} else {
  91 			model = new InterfaceWithBLOBs();
  92 			module = moduleCache.get(moduleId);
  93 			model.setModuleId(moduleId);
  94 			model.setProjectId(module.getProjectId());
  95 			model.setParam(&quot;form=[]&quot;);
  96 			model.setResponseParam(&quot;[]&quot;);
  97 			model.setHeader(&quot;[]&quot;);
  98 			model.setParamRemark(&quot;[]&quot;);
  99 			if (!MyString.isEmpty(module.getTemplateId())) {
 100 				InterfaceWithBLOBs template = interfaceService.getById(module.getTemplateId());
 101 				// Ê†πÊçÆÊ®°ÊùøÂàùÂßãÂåñÊé•Âè£
 102 				if (template != null) {
 103 					model.setHeader(template.getHeader());
 104 					model.setParam(template.getParam());
 105 					model.setMethod(template.getMethod());
 106 					model.setVersion(template.getVersion());
 107 					model.setParamRemark(template.getParamRemark());
 108 					model.setResponseParam(template.getResponseParam());
 109 					model.setErrorList(template.getErrorList());
 110 					model.setErrors(template.getErrors());
 111 					model.setFalseExam(template.getFalseExam());
 112 					model.setTrueExam(template.getTrueExam());
 113 					model.setStatus(template.getStatus());
 114 					model.setContentType(template.getContentType());
 115 				}
 116 			}
 117 		}
 118 		return new JsonResult(1, InterfaceAdapter.getDto(model, module, null, false));
 119 	}
 120 
 121 	/**
 122 	 * @param interFace
 123 	 * @return
 124 	 * @throws MyException
 125 	 * @throws IOException
 126 	 */
 127 	@RequestMapping(&quot;/copy.do&quot;)
 128 	@ResponseBody
 129 	public JsonResult copy(@ModelAttribute
 130 	InterfaceDto interFace) throws MyException, IOException {
 131 		//Âà§Êñ≠ÊòØÂê¶Êã•ÊúâËØ•Ê®°ÂùóÁöÑÊùÉÈôê
 132 		checkUserPermissionByProject(interFace.getProjectId(), ADD_INTER);
 133 		Module module = moduleCache.get(interFace.getModuleId());
 134 		if (!config.isCanRepeatUrl()) {
<abbr title=" 135 			if (interfaceService.count(new InterfaceQuery().setModuleId(interFace.getModuleId()).setEqualFullUrl(module.getUrl() + interFace.getUrl())) &gt; 0) {"> 135 			if (interfaceService.count(new InterfaceQuery().setModuleId(interFace.getModuleId()).setEqualFullUrl(müîµ</abbr>
 136 				throw new MyException(MyError.E000004);
 137 			}
 138 		}
 139 		interFace.setId(null);
 140 		interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 141 		interfaceService.insert(InterfaceAdapter.getModel(interFace));
 142 		luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 143 		return new JsonResult(1, interFace);
 144 	}
 145 
 146 	/**
 147 	 * Ê†πÊçÆÂèÇÊï∞ÁîüÊàêËØ∑Ê±ÇÁ§∫‰æã
 148 	 * @param interFace
 149 	 * @return
 150 	 */
 151 	@RequestMapping(&quot;/getRequestExam.do&quot;)
 152 	@ResponseBody
 153 	@AuthPassport
 154 	public JsonResult getRequestExam(@ModelAttribute
 155 	InterfaceDto interFace) {
 156 		interfaceService.getInterFaceRequestExam(interFace);
 157 		return new JsonResult(1, interFace);
 158 	}
 159 
 160 	@RequestMapping(&quot;/addOrUpdate.do&quot;)
 161 	@ResponseBody
 162 	@AuthPassport
 163 	public JsonResult addOrUpdate(@ModelAttribute
 164 	InterfaceDto interFace) throws IOException, MyException {
 165 		Assert.notNull(interFace.getProjectId(), &quot;projectId can&#x27;t be null&quot;);
 166 		if (MyString.isEmpty(interFace.getUrl())) {
 167 			return new JsonResult(MyError.E000005);
 168 		}
 169 		interFace.setUrl(interFace.getUrl().trim());
 170 		/**
 171 		 * Ê†πÊçÆÈÄâÁùÄÁöÑÈîôËØØÁ†ÅidÔºåÁªÑË£ÖjsonÂ≠óÁ¨¶‰∏≤
 172 		 */
<abbr title=" 173 		ErrorQuery query = new ErrorQuery().setProjectId(interFace.getProjectId()).setErrorCodeList(Tools.getIdsFromField(interFace.getErrorList())).setPageSize(100);"> 173 		ErrorQuery query = new ErrorQuery().setProjectId(interFace.getProjectId()).setErrorCodeList(Tools.getIdüîµ</abbr>
 174 		List&lt;Error&gt; errors = errorService.query(query);
 175 		interFace.setErrors(JSONArray.fromObject(errors).toString());
 176 		LoginInfoDto user = LoginUserHelper.getUser();
 177 		interFace.setUpdateBy(((&quot;userNameÔºö&quot; + user.getUserName()) + &quot; | trueNameÔºö&quot;) + user.getTrueName());
 178 		//ËØ∑Ê±ÇÁ§∫‰æã‰∏∫Á©∫ÔºåÂàôËá™Âä®Ê∑ªÂä†
 179 		if (MyString.isEmpty(interFace.getRequestExam())) {
 180 			interfaceService.getInterFaceRequestExam(interFace);
 181 		}
 182 		interFace.setMonitorType(MonitorType.No.getValue());
 183 		//Ê£ÄÊü•ÈÇÆ‰ª∂Ê†ºÂºèÊòØÂê¶Ê≠£Á°Æ
 184 		/**if(interFace.getMonitorType() != MonitorType.No.getValue()){
 185 			if(!MyString.isEmpty(interFace.getMonitorEmails())){
 186 				for(String email : interFace.getMonitorEmails().split(&quot;;&quot;)){
 187 					if( !Tools.checkEmail(email) ){
 188 						throw new MyException(E000032&quot;);
 189 					}
 190 				}
 191 			}else{
 192 				throw new MyException(E000032&quot;);
 193 			}
 194 		}**/
 195 		Module module = moduleCache.get(interFace.getModuleId());
 196 		if (!MyString.isEmpty(interFace.getId())) {
 197 			String oldModuleId = interfaceService.getById(interFace.getId()).getModuleId();
 198 			String projectId = moduleCache.get(oldModuleId).getProjectId();
 199 			Project project = projectCache.get(interFace.getProjectId());
 200 			// Êé•Âè£Âè™ËÉΩÂú®Âêå‰∏Ä‰∏™È°πÁõÆ‰∏ãÁöÑÊ®°Âùó‰∏≠ÁßªÂä®
 201 			if (!projectId.equals(project.getId())) {
 202 				throw new MyException(MyError.E000047);
 203 			}
 204 			// Âà§Êñ≠ÊòØÂê¶Êúâ‰øÆÊîπÊ®°ÂùóÁöÑÊùÉÈôê
 205 			checkUserPermissionByProject(project, MOD_INTER);
 206 			// Âêå‰∏ÄÊ®°Âùó‰∏ã‰∏çÂÖÅËÆ∏ url ÈáçÂ§ç
 207 			InterfaceQuery interfaceQuery = new InterfaceQuery();
<abbr title=" 208 			interfaceQuery.setModuleId(interFace.getModuleId()).setFullUrl(module.getUrl() + interFace.getUrl()).setExceptId(interFace.getId());"> 208 			interfaceQuery.setModuleId(interFace.getModuleId()).setFullUrl(module.getUrl() + interFace.getUrl()).süîµ</abbr>
 209 			if ((!config.isCanRepeatUrl()) &amp;&amp; (interfaceService.count(interfaceQuery) &gt; 0)) {
 210 				throw new MyException(MyError.E000004);
 211 			}
 212 			interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 213 			interfaceService.update(InterfaceAdapter.getModel(interFace), &quot;Êé•Âè£&quot;, &quot;&quot;);
 214 			if (interFace.getId().equals(interFace.getProjectId())) {
 215 				throw new MyException(MyError.E000027);
 216 			}
 217 			luceneService.update(InterfaceAdapter.getSearchDto(interFace));
 218 		} else {
 219 			checkUserPermissionByProject(projectCache.get(interFace.getProjectId()), ADD_INTER);
 220 			InterfaceQuery interfaceQuery = new InterfaceQuery();
 221 			interfaceQuery.setModuleId(interFace.getModuleId()).setFullUrl(module.getUrl() + interFace.getUrl());
 222 			if ((!config.isCanRepeatUrl()) &amp;&amp; (interfaceService.count(interfaceQuery) &gt; 0)) {
 223 				return new JsonResult(MyError.E000004);
 224 			}
 225 			interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 226 			interfaceService.insert(InterfaceAdapter.getModel(interFace));
 227 			luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 228 		}
 229 		return new JsonResult(1, interFace);
 230 	}
 231 
 232 	@RequestMapping(&quot;/delete.do&quot;)
 233 	@ResponseBody
 234 	public JsonResult delete(String id, String ids) throws MyException, IOException {
 235 		if (MyString.isEmpty(id) &amp;&amp; MyString.isEmpty(ids)) {
 236 			throw new MyException(MyError.E000029);
 237 		}
 238 		if (MyString.isEmpty(ids)) {
 239 			ids = id;
 240 		}
 241 		for (String tempId : ids.split(&quot;,&quot;)) {
 242 			if (MyString.isEmpty(tempId)) {
 243 				continue;
 244 			}
 245 			InterfaceWithBLOBs interFace = interfaceService.getById(tempId);
 246 			checkUserPermissionByProject(interFace.getProjectId(), DEL_INTER);
 247 			interfaceService.delete(interFace.getId(), &quot;Êé•Âè£&quot;, &quot;&quot;);
 248 			luceneService.delete(new SearchDto(interFace.getId()));
 249 		}
 250 		return new JsonResult(1, null);
 251 	}
 252 
 253 	@RequestMapping(&quot;/changeSequence.do&quot;)
 254 	@ResponseBody
 255 	public JsonResult changeSequence(@RequestParam
 256 	String id, @RequestParam
 257 	String changeId) throws MyException {
 258 		InterfaceWithBLOBs change = interfaceService.getById(changeId);
 259 		InterfaceWithBLOBs model = interfaceService.getById(id);
 260 		checkUserPermissionByProject(model.getProjectId(), MOD_INTER);
 261 		checkUserPermissionByProject(change.getProjectId(), MOD_INTER);
 262 		int modelSequence = model.getSequence();
 263 		model.setSequence(change.getSequence());
 264 		change.setSequence(modelSequence);
 265 		interfaceService.update(model);
 266 		interfaceService.update(change);
 267 		return new JsonResult(1, null);
 268 	}
 269 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package cn.crap.controller.user;
   2  
   3  import cn.crap.adapter.InterfaceAdapter;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 +import cn.crap.beans.Config;</span>
   5  import cn.crap.dto.InterfaceDto;
   6  import cn.crap.dto.LoginInfoDto;
   7  import cn.crap.dto.SearchDto;
   8  import cn.crap.enumer.MonitorType;
   9  import cn.crap.enumer.MyError;
  10  import cn.crap.framework.JsonResult;
  11  import cn.crap.framework.MyException;
  12  import cn.crap.framework.base.BaseController;
  13  import cn.crap.framework.interceptor.AuthPassport;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  14 -import cn.crap.model.mybatis.Error;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 -import cn.crap.model.mybatis.*;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 +import cn.crap.model.Error;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 +import cn.crap.model.InterfaceWithBLOBs;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +import cn.crap.model.Module;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +import cn.crap.model.Project;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import cn.crap.query.ErrorQuery;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import cn.crap.query.InterfaceQuery;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import cn.crap.service.ErrorService;</span>
  23  import cn.crap.service.ISearchService;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import cn.crap.service.custom.CustomErrorService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import cn.crap.service.custom.CustomInterfaceService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import cn.crap.service.mybatis.InterfaceService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import cn.crap.beans.Config;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import cn.crap.utils.*;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import cn.crap.service.InterfaceService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import cn.crap.utils.LoginUserHelper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import cn.crap.utils.MyString;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import cn.crap.utils.Page;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import cn.crap.utils.Tools;</span>
  34  import net.sf.json.JSONArray;
  35  import org.springframework.beans.factory.annotation.Autowired;
  36  import org.springframework.stereotype.Controller;
  37  import org.springframework.util.Assert;
  38  import org.springframework.web.bind.annotation.ModelAttribute;
  39  import org.springframework.web.bind.annotation.RequestMapping;
  40  import org.springframework.web.bind.annotation.RequestParam;
  41  import org.springframework.web.bind.annotation.ResponseBody;
  42  
  43  import java.io.IOException;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import java.util.Date;</span>
  45  import java.util.List;
  46  
  47  @Controller
  48  @RequestMapping(&quot;/user/interface&quot;)
  49  public class InterfaceController extends BaseController{
  50  
  51  	@Autowired
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -	private CustomInterfaceService customInterfaceService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -	@Autowired</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -	private InterfaceService mybatisInterfaceService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +	private InterfaceService interfaceService;</span>
  56  	@Autowired
  57  	private ISearchService luceneService;
  58  	@Autowired
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -	private CustomErrorService customErrorService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +	private ErrorService errorService;</span>
  61  	@Autowired
  62  	private Config config;
  63  
  64  
  65  	@RequestMapping(&quot;/list.do&quot;)
  66  	@ResponseBody
  67  	@AuthPassport
  68  	public JsonResult list(@RequestParam String moduleId, String interfaceName, String url,
  69  			 Integer currentPage) throws MyException{
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -		Page page= new Page(currentPage);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -		checkUserPermissionByModuleId(moduleId, VIEW);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -		InterfaceCriteria example = new InterfaceCriteria();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -		InterfaceCriteria.Criteria criteria = example.createCriteria().andModuleIdEqualTo(moduleId);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -		if (!MyString.isEmpty(interfaceName)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -			criteria.andInterfaceNameLike(&quot;%&quot; + interfaceName + &quot;%&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -		if (!MyString.isEmpty(url)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -			criteria.andFullUrlLike(&quot;%&quot; + url + &quot;%&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  82 -		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(example), null);">  82 -		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(exampleüîµ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +		InterfaceQuery interfaceQuery = new InterfaceQuery();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  84 +		interfaceQuery.setModuleId(moduleId).setInterfaceName(interfaceName).setFullUrl(url).setCurrentPage(currentPage);">  84 +		interfaceQuery.setModuleId(moduleId).setInterfaceName(interfaceName).setFullUrl(url).setCurrentPage(currentPage)üîµ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +		Page page= new Page(interfaceQuery);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +		Module module = moduleCache.get(moduleId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +		Project project = projectCache.get(module.getProjectId());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +		checkUserPermissionByProject(project.getId(), VIEW);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  91 +		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module, project);">  91 +		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module, project)üîµ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +		page.setAllRow(interfaceService.count(interfaceQuery));</span>
  93  		JsonResult result = new JsonResult(1, interfaces, page);
  94  		result.putOthers(&quot;crumbs&quot;, Tools.getCrumbs(&quot;Êé•Âè£ÂàóË°®:&quot;+ moduleCache.get(moduleId).getName(),&quot;void&quot;))
  95  				.putOthers(&quot;module&quot;, moduleCache.get(moduleId));
  96  
  97  		return result;
  98  
  99  	}
 100  
 101  	@RequestMapping(&quot;/detail.do&quot;)
 102  	@ResponseBody
 103  	public JsonResult detail(String id, String moduleId) throws MyException {
 104  		InterfaceWithBLOBs model;
 105  		Module module = null;
 106  		if(id != null){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -			model= mybatisInterfaceService.getById(id);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +			model= interfaceService.getById(id);</span>
 109  			module = moduleCache.get(model.getModuleId());
 110  			checkUserPermissionByProject(model.getProjectId(), VIEW);
 111  		}else{
 112  			model = new InterfaceWithBLOBs();
 113  			module = moduleCache.get(moduleId);
 114  			model.setModuleId( moduleId);
 115  			model.setProjectId(module.getProjectId());
 116  			model.setParam(&quot;form=[]&quot;);
 117  			model.setResponseParam(&quot;[]&quot;);
 118  			model.setHeader(&quot;[]&quot;);
 119  			model.setParamRemark(&quot;[]&quot;);
 120  			if(!MyString.isEmpty(module.getTemplateId())){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -				InterfaceWithBLOBs template = mybatisInterfaceService.getById(module.getTemplateId());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +				InterfaceWithBLOBs template = interfaceService.getById(module.getTemplateId());</span>
 123  				// Ê†πÊçÆÊ®°ÊùøÂàùÂßãÂåñÊé•Âè£
 124  				if(template != null){
 125  					model.setHeader(template.getHeader());
 126  					model.setParam(template.getParam());
 127  					model.setMethod(template.getMethod());
 128  					model.setVersion(template.getVersion());
 129  					model.setParamRemark(template.getParamRemark());
 130  					model.setResponseParam(template.getResponseParam());
 131  					model.setErrorList(template.getErrorList());
 132  					model.setErrors(template.getErrors());
 133  					model.setFalseExam(template.getFalseExam());
 134  					model.setTrueExam(template.getTrueExam());
 135  					model.setStatus(template.getStatus());
 136  					model.setContentType(template.getContentType());
 137  				}
 138  			}
 139  		}
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -		return new JsonResult(1, InterfaceAdapter.getDto(model, module, false));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +		return new JsonResult(1, InterfaceAdapter.getDto(model, module, null, false));</span>
 142  	}
 143  
 144  	/**
 145  	 * @param interFace
 146  	 * @return
 147  	 * @throws MyException
 148  	 * @throws IOException
 149  	 */
 150  	@RequestMapping(&quot;/copy.do&quot;)
 151  	@ResponseBody
 152  	public JsonResult copy(@ModelAttribute InterfaceDto interFace) throws MyException, IOException {
 153  		//Âà§Êñ≠ÊòØÂê¶Êã•ÊúâËØ•Ê®°ÂùóÁöÑÊùÉÈôê
 154  		checkUserPermissionByProject(interFace.getProjectId(), ADD_INTER);
 155  		Module module = moduleCache.get(interFace.getModuleId());
 156  
 157  		if(!config.isCanRepeatUrl()){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -			InterfaceCriteria example = new InterfaceCriteria();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -			InterfaceCriteria.Criteria criteria = example.createCriteria();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -			criteria.andModuleIdEqualTo(interFace.getModuleId()).andFullUrlEqualTo(module.getUrl() + interFace.getUrl());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -			if (mybatisInterfaceService.countByExample(example) &gt; 0){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 162 +			if (interfaceService.count(new InterfaceQuery().setModuleId(interFace.getModuleId()).setEqualFullUrl(module.getUrl() + interFace.getUrl())) &gt; 0){"> 162 +			if (interfaceService.count(new InterfaceQuery().setModuleId(interFace.getModuleId()).setEqualFullUrl(module.getüîµ</abbr></span>
 163  				throw new MyException(MyError.E000004);
 164  			}
 165  		}
 166  		interFace.setId(null);
 167  		interFace.setFullUrl(module.getUrl() + interFace.getUrl());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -		mybatisInterfaceService.insert(InterfaceAdapter.getModel(interFace));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +		interfaceService.insert(InterfaceAdapter.getModel(interFace));</span>
 170  
 171  		luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 172  		return new JsonResult(1, interFace);
 173  	}
 174  
 175  	/**
 176  	 * Ê†πÊçÆÂèÇÊï∞ÁîüÊàêËØ∑Ê±ÇÁ§∫‰æã
 177  	 * @param interFace
 178  	 * @return
 179  	 */
 180  	@RequestMapping(&quot;/getRequestExam.do&quot;)
 181  	@ResponseBody
 182  	@AuthPassport
 183  	public JsonResult getRequestExam(@ModelAttribute InterfaceDto interFace) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -		customInterfaceService.getInterFaceRequestExam(interFace);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +		interfaceService.getInterFaceRequestExam(interFace);</span>
 186  		return new JsonResult(1, interFace);
 187  	}
 188  
 189  	@RequestMapping(&quot;/addOrUpdate.do&quot;)
 190  	@ResponseBody
 191  	@AuthPassport
 192  	public JsonResult addOrUpdate(@ModelAttribute InterfaceDto interFace) throws IOException, MyException {
 193  		Assert.notNull(interFace.getProjectId(), &quot;projectId can&#x27;t be null&quot;);
 194  
 195  		if(MyString.isEmpty(interFace.getUrl())) {
 196  			return new JsonResult(MyError.E000005);
 197  		}
 198  		interFace.setUrl(interFace.getUrl().trim());
 199  
 200  		/**
 201  		 * Ê†πÊçÆÈÄâÁùÄÁöÑÈîôËØØÁ†ÅidÔºåÁªÑË£ÖjsonÂ≠óÁ¨¶‰∏≤
 202  		 */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -		String errorIds = interFace.getErrorList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 204 -		List&lt;Error&gt; errors  = customErrorService.queryByProjectIdAndErrorCode(interFace.getProjectId(), Tools.getIdsFromField(errorIds));"> 204 -		List&lt;Error&gt; errors  = customErrorService.queryByProjectIdAndErrorCode(interFace.getProjectId(), Tools.getIdsFromüîµ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +        ErrorQuery query = new ErrorQuery().setProjectId(interFace.getProjectId())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +                .setErrorCodeList(Tools.getIdsFromField(interFace.getErrorList())).setPageSize(100);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +        List&lt;Error&gt; errors  = errorService.query(query);</span>
 208  		interFace.setErrors(JSONArray.fromObject(errors).toString());
 209  
 210  		LoginInfoDto user = LoginUserHelper.getUser();
 211  		interFace.setUpdateBy(&quot;userNameÔºö&quot;+user.getUserName()+&quot; | trueNameÔºö&quot;+ user.getTrueName());
 212  
 213  		//ËØ∑Ê±ÇÁ§∫‰æã‰∏∫Á©∫ÔºåÂàôËá™Âä®Ê∑ªÂä†
 214  		if(MyString.isEmpty(interFace.getRequestExam())){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -			customInterfaceService.getInterFaceRequestExam(interFace);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +			interfaceService.getInterFaceRequestExam(interFace);</span>
 217  		}
 218          interFace.setMonitorType(MonitorType.No.getValue());
 219  		//Ê£ÄÊü•ÈÇÆ‰ª∂Ê†ºÂºèÊòØÂê¶Ê≠£Á°Æ
 220  		/**if(interFace.getMonitorType() != MonitorType.No.getValue()){
 221  			if(!MyString.isEmpty(interFace.getMonitorEmails())){
 222  				for(String email : interFace.getMonitorEmails().split(&quot;;&quot;)){
 223  					if( !Tools.checkEmail(email) ){
 224  						throw new MyException(E000032&quot;);
 225  					}
 226  				}
 227  			}else{
 228  				throw new MyException(E000032&quot;);
 229  			}
 230  		}**/
 231  
 232  		Module module = moduleCache.get(interFace.getModuleId());
 233  		if (!MyString.isEmpty(interFace.getId())) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -			String oldModuleId = mybatisInterfaceService.getById(interFace.getId()).getModuleId();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +			String oldModuleId = interfaceService.getById(interFace.getId()).getModuleId();</span>
 236  			String projectId = moduleCache.get(oldModuleId).getProjectId();
 237  			Project project = projectCache.get(interFace.getProjectId() );
 238  
 239  			// Êé•Âè£Âè™ËÉΩÂú®Âêå‰∏Ä‰∏™È°πÁõÆ‰∏ãÁöÑÊ®°Âùó‰∏≠ÁßªÂä®
 240  			if( !projectId.equals(project.getId())){
 241  				throw new MyException(MyError.E000047);
 242  			}
 243  			// Âà§Êñ≠ÊòØÂê¶Êúâ‰øÆÊîπÊ®°ÂùóÁöÑÊùÉÈôê
 244  			checkUserPermissionByProject(project, MOD_INTER);
 245  
 246  			//Âêå‰∏ÄÊ®°Âùó‰∏ã‰∏çÂÖÅËÆ∏ url ÈáçÂ§ç
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -			if( !config.isCanRepeatUrl() &amp;&amp; customInterfaceService.countByFullUrl(interFace.getModuleId(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -					module.getUrl() +interFace.getUrl(), interFace.getId()) &gt;0 ){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +            InterfaceQuery interfaceQuery = new InterfaceQuery();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 250 +            interfaceQuery.setModuleId(interFace.getModuleId()).setFullUrl(module.getUrl() +interFace.getUrl()).setExceptId(interFace.getId());"> 250 +            interfaceQuery.setModuleId(interFace.getModuleId()).setFullUrl(module.getUrl() +interFace.getUrl()).seüîµ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +			if( !config.isCanRepeatUrl() &amp;&amp; interfaceService.count(interfaceQuery) &gt;0 ){</span>
 252  				throw new MyException(MyError.E000004);
 253  			}
 254  
 255  			interFace.setFullUrl(module.getUrl() + interFace.getUrl());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -			customInterfaceService.update(InterfaceAdapter.getModel(interFace), &quot;Êé•Âè£&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +			interfaceService.update(InterfaceAdapter.getModel(interFace), &quot;Êé•Âè£&quot;, &quot;&quot;);</span>
 258  			if(interFace.getId().equals(interFace.getProjectId())){
 259  				throw new MyException(MyError.E000027);
 260  			}
 261  			luceneService.update(InterfaceAdapter.getSearchDto(interFace));
 262  
 263  		} else {
 264  			checkUserPermissionByProject(projectCache.get(interFace.getProjectId() ), ADD_INTER);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 265 -			if(!config.isCanRepeatUrl() &amp;&amp; customInterfaceService.countByFullUrl(interFace.getModuleId(),module.getUrl() + interFace.getUrl(), null)&gt;0){"> 265 -			if(!config.isCanRepeatUrl() &amp;&amp; customInterfaceService.countByFullUrl(interFace.getModuleId(),module.getUrl() + üîµ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +            InterfaceQuery interfaceQuery = new InterfaceQuery();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +            interfaceQuery.setModuleId(interFace.getModuleId()).setFullUrl(module.getUrl() +interFace.getUrl());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +			if(!config.isCanRepeatUrl() &amp;&amp; interfaceService.count(interfaceQuery)&gt;0){</span>
 269  				return new JsonResult(MyError.E000004);
 270  			}
 271  			interFace.setFullUrl(module.getUrl() + interFace.getUrl());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -			mybatisInterfaceService.insert(InterfaceAdapter.getModel(interFace));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +			interfaceService.insert(InterfaceAdapter.getModel(interFace));</span>
 274  			luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 275  		}
 276  		return new JsonResult(1, interFace);
 277  	}
 278  
 279  	@RequestMapping(&quot;/delete.do&quot;)
 280  	@ResponseBody
 281  	public JsonResult delete(String id, String ids) throws MyException, IOException{
 282  		if( MyString.isEmpty(id) &amp;&amp; MyString.isEmpty(ids)){
 283  			throw new MyException(MyError.E000029);
 284  		}
 285  		if( MyString.isEmpty(ids) ){
 286  			ids = id;
 287  		}
 288  
 289  		for(String tempId : ids.split(&quot;,&quot;)){
 290  			if(MyString.isEmpty(tempId)){
 291  				continue;
 292  			}
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -			InterfaceWithBLOBs interFace = mybatisInterfaceService.getById( tempId );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +			InterfaceWithBLOBs interFace = interfaceService.getById( tempId );</span>
 295  			checkUserPermissionByProject(interFace.getProjectId(), DEL_INTER);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -			customInterfaceService.delete(interFace.getId(), &quot;Êé•Âè£&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +			interfaceService.delete(interFace.getId(), &quot;Êé•Âè£&quot;, &quot;&quot;);</span>
 298  			luceneService.delete(new SearchDto(interFace.getId()));
 299  		}
 300  		return new JsonResult(1, null);
 301  	}
 302  
 303  	@RequestMapping(&quot;/changeSequence.do&quot;)
 304  	@ResponseBody
 305  	public JsonResult changeSequence(@RequestParam String id,@RequestParam String changeId) throws MyException {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -		InterfaceWithBLOBs change = mybatisInterfaceService.getById(changeId);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -		InterfaceWithBLOBs model = mybatisInterfaceService.getById(id);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +		InterfaceWithBLOBs change = interfaceService.getById(changeId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +		InterfaceWithBLOBs model = interfaceService.getById(id);</span>
 310  		checkUserPermissionByProject(model.getProjectId(), MOD_INTER);
 311  		checkUserPermissionByProject(change.getProjectId(), MOD_INTER);
 312  
 313  		int modelSequence = model.getSequence();
 314  
 315  		model.setSequence(change.getSequence());
 316  		change.setSequence(modelSequence);
 317  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 318 -		mybatisInterfaceService.update(model);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 319 -		mybatisInterfaceService.update(change);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +		interfaceService.update(model);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +		interfaceService.update(change);</span>
 322  		return new JsonResult(1, null);
 323  	}
 324  }</pre></td>
                            <td><pre>   1  package cn.crap.controller.user;
   2  
   3  import cn.crap.adapter.InterfaceAdapter;

   4  import cn.crap.dto.InterfaceDto;
   5  import cn.crap.dto.LoginInfoDto;
   6  import cn.crap.dto.SearchDto;
   7  import cn.crap.enumer.MonitorType;
   8  import cn.crap.enumer.MyError;
   9  import cn.crap.framework.JsonResult;
  10  import cn.crap.framework.MyException;
  11  import cn.crap.framework.base.BaseController;
  12  import cn.crap.framework.interceptor.AuthPassport;
  13  import cn.crap.model.mybatis.Error;
  14  import cn.crap.model.mybatis.*;







  15  import cn.crap.service.ISearchService;
  16  import cn.crap.service.custom.CustomErrorService;
  17  import cn.crap.service.custom.CustomInterfaceService;
  18  import cn.crap.service.mybatis.InterfaceService;
  19  import cn.crap.beans.Config;
  20  import cn.crap.utils.*;





  21  import net.sf.json.JSONArray;
  22  import org.springframework.beans.factory.annotation.Autowired;
  23  import org.springframework.stereotype.Controller;
  24  import org.springframework.util.Assert;
  25  import org.springframework.web.bind.annotation.ModelAttribute;
  26  import org.springframework.web.bind.annotation.RequestMapping;
  27  import org.springframework.web.bind.annotation.RequestParam;
  28  import org.springframework.web.bind.annotation.ResponseBody;
  29  
  30  import java.io.IOException;
  31  import java.util.Date;
  32  import java.util.List;
  33  
  34  @Controller
  35  @RequestMapping(&quot;/user/interface&quot;)
  36  public class InterfaceController extends BaseController{
  37  
  38  	@Autowired
  39  	private CustomInterfaceService customInterfaceService;
  40  	@Autowired
  41  	private InterfaceService mybatisInterfaceService;

  42  	@Autowired
  43  	private ISearchService luceneService;
  44  	@Autowired
  45  	private CustomErrorService customErrorService;

  46  	@Autowired
  47  	private Config config;
  48  
  49  
  50  	@RequestMapping(&quot;/list.do&quot;)
  51  	@ResponseBody
  52  	@AuthPassport
  53  	public JsonResult list(@RequestParam String moduleId, String interfaceName, String url,
  54  			 Integer currentPage) throws MyException{
  55  		Page page= new Page(currentPage);
  56  		checkUserPermissionByModuleId(moduleId, VIEW);
  57  
  58  		InterfaceCriteria example = new InterfaceCriteria();
  59  		InterfaceCriteria.Criteria criteria = example.createCriteria().andModuleIdEqualTo(moduleId);
  60  		if (!MyString.isEmpty(interfaceName)){
  61  			criteria.andInterfaceNameLike(&quot;%&quot; + interfaceName + &quot;%&quot;);
  62  		}
  63  		if (!MyString.isEmpty(url)){
  64  			criteria.andFullUrlLike(&quot;%&quot; + url + &quot;%&quot;);
  65  		}
  66  
<abbr title="  67  		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(example), null);">  67  		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(exampleüîµ</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +        page.setAllRow(mybatisInterfaceService.countByExample(example));</span>









  69  		JsonResult result = new JsonResult(1, interfaces, page);
  70  		result.putOthers(&quot;crumbs&quot;, Tools.getCrumbs(&quot;Êé•Âè£ÂàóË°®:&quot;+ moduleCache.get(moduleId).getName(),&quot;void&quot;))
  71  				.putOthers(&quot;module&quot;, moduleCache.get(moduleId));
  72  
  73  		return result;
  74  
  75  	}
  76  
  77  	@RequestMapping(&quot;/detail.do&quot;)
  78  	@ResponseBody
  79  	public JsonResult detail(String id, String moduleId) throws MyException {
  80  		InterfaceWithBLOBs model;
  81  		Module module = null;
  82  		if(id != null){
  83  			model= mybatisInterfaceService.getById(id);

  84  			module = moduleCache.get(model.getModuleId());
  85  			checkUserPermissionByProject(model.getProjectId(), VIEW);
  86  		}else{
  87  			model = new InterfaceWithBLOBs();
  88  			module = moduleCache.get(moduleId);
  89  			model.setModuleId( moduleId);
  90  			model.setProjectId(module.getProjectId());
  91  			model.setParam(&quot;form=[]&quot;);
  92  			model.setResponseParam(&quot;[]&quot;);
  93  			model.setHeader(&quot;[]&quot;);
  94  			model.setParamRemark(&quot;[]&quot;);
  95  			if(!MyString.isEmpty(module.getTemplateId())){
  96  				InterfaceWithBLOBs template = mybatisInterfaceService.getById(module.getTemplateId());

  97  				// Ê†πÊçÆÊ®°ÊùøÂàùÂßãÂåñÊé•Âè£
  98  				if(template != null){
  99  					model.setHeader(template.getHeader());
 100  					model.setParam(template.getParam());
 101  					model.setMethod(template.getMethod());
 102  					model.setVersion(template.getVersion());
 103  					model.setParamRemark(template.getParamRemark());
 104  					model.setResponseParam(template.getResponseParam());
 105  					model.setErrorList(template.getErrorList());
 106  					model.setErrors(template.getErrors());
 107  					model.setFalseExam(template.getFalseExam());
 108  					model.setTrueExam(template.getTrueExam());
 109  					model.setStatus(template.getStatus());
 110  					model.setContentType(template.getContentType());
 111  				}
 112  			}
 113  		}
 114  		return new JsonResult(1, InterfaceAdapter.getDto(model, module, false));

 115  	}
 116  
 117  	/**
 118  	 * @param interFace
 119  	 * @return
 120  	 * @throws MyException
 121  	 * @throws IOException
 122  	 */
 123  	@RequestMapping(&quot;/copy.do&quot;)
 124  	@ResponseBody
 125  	public JsonResult copy(@ModelAttribute InterfaceDto interFace) throws MyException, IOException {
 126  		//Âà§Êñ≠ÊòØÂê¶Êã•ÊúâËØ•Ê®°ÂùóÁöÑÊùÉÈôê
 127  		checkUserPermissionByProject(interFace.getProjectId(), ADD_INTER);
 128  		Module module = moduleCache.get(interFace.getModuleId());
 129  
 130  		if(!config.isCanRepeatUrl()){
 131  			InterfaceCriteria example = new InterfaceCriteria();
 132  			InterfaceCriteria.Criteria criteria = example.createCriteria();
 133  			criteria.andModuleIdEqualTo(interFace.getModuleId()).andFullUrlEqualTo(module.getUrl() + interFace.getUrl());
 134  			if (mybatisInterfaceService.countByExample(example) &gt; 0){

 135  				throw new MyException(MyError.E000004);
 136  			}
 137  		}
 138  		interFace.setId(null);
 139  		interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 140  		mybatisInterfaceService.insert(InterfaceAdapter.getModel(interFace));

 141  
 142  		luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 143  		return new JsonResult(1, interFace);
 144  	}
 145  
 146  	/**
 147  	 * Ê†πÊçÆÂèÇÊï∞ÁîüÊàêËØ∑Ê±ÇÁ§∫‰æã
 148  	 * @param interFace
 149  	 * @return
 150  	 */
 151  	@RequestMapping(&quot;/getRequestExam.do&quot;)
 152  	@ResponseBody
 153  	@AuthPassport
 154  	public JsonResult getRequestExam(@ModelAttribute InterfaceDto interFace) {
 155  		customInterfaceService.getInterFaceRequestExam(interFace);

 156  		return new JsonResult(1, interFace);
 157  	}
 158  
 159  	@RequestMapping(&quot;/addOrUpdate.do&quot;)
 160  	@ResponseBody
 161  	@AuthPassport
 162  	public JsonResult addOrUpdate(@ModelAttribute InterfaceDto interFace) throws IOException, MyException {
 163  		Assert.notNull(interFace.getProjectId(), &quot;projectId can&#x27;t be null&quot;);
 164  
 165  		if(MyString.isEmpty(interFace.getUrl())) {
 166  			return new JsonResult(MyError.E000005);
 167  		}
 168  		interFace.setUrl(interFace.getUrl().trim());
 169  
 170  		/**
 171  		 * Ê†πÊçÆÈÄâÁùÄÁöÑÈîôËØØÁ†ÅidÔºåÁªÑË£ÖjsonÂ≠óÁ¨¶‰∏≤
 172  		 */
 173  		String errorIds = interFace.getErrorList();
<abbr title=" 174  		List&lt;Error&gt; errors  = customErrorService.queryByProjectIdAndErrorCode(interFace.getProjectId(), Tools.getIdsFromField(errorIds));"> 174  		List&lt;Error&gt; errors  = customErrorService.queryByProjectIdAndErrorCode(interFace.getProjectId(), Tools.getIdsFromüîµ</abbr>



 175  		interFace.setErrors(JSONArray.fromObject(errors).toString());
 176  
 177  		LoginInfoDto user = LoginUserHelper.getUser();
 178  		interFace.setUpdateBy(&quot;userNameÔºö&quot;+user.getUserName()+&quot; | trueNameÔºö&quot;+ user.getTrueName());
 179  
 180  		//ËØ∑Ê±ÇÁ§∫‰æã‰∏∫Á©∫ÔºåÂàôËá™Âä®Ê∑ªÂä†
 181  		if(MyString.isEmpty(interFace.getRequestExam())){
 182  			customInterfaceService.getInterFaceRequestExam(interFace);

 183  		}
 184          interFace.setMonitorType(MonitorType.No.getValue());
 185  		//Ê£ÄÊü•ÈÇÆ‰ª∂Ê†ºÂºèÊòØÂê¶Ê≠£Á°Æ
 186  		/**if(interFace.getMonitorType() != MonitorType.No.getValue()){
 187  			if(!MyString.isEmpty(interFace.getMonitorEmails())){
 188  				for(String email : interFace.getMonitorEmails().split(&quot;;&quot;)){
 189  					if( !Tools.checkEmail(email) ){
 190  						throw new MyException(E000032&quot;);
 191  					}
 192  				}
 193  			}else{
 194  				throw new MyException(E000032&quot;);
 195  			}
 196  		}**/
 197  
 198  		Module module = moduleCache.get(interFace.getModuleId());
 199  		if (!MyString.isEmpty(interFace.getId())) {
 200  			String oldModuleId = mybatisInterfaceService.getById(interFace.getId()).getModuleId();

 201  			String projectId = moduleCache.get(oldModuleId).getProjectId();
 202  			Project project = projectCache.get(interFace.getProjectId() );
 203  
 204  			// Êé•Âè£Âè™ËÉΩÂú®Âêå‰∏Ä‰∏™È°πÁõÆ‰∏ãÁöÑÊ®°Âùó‰∏≠ÁßªÂä®
 205  			if( !projectId.equals(project.getId())){
 206  				throw new MyException(MyError.E000047);
 207  			}
 208  			// Âà§Êñ≠ÊòØÂê¶Êúâ‰øÆÊîπÊ®°ÂùóÁöÑÊùÉÈôê
 209  			checkUserPermissionByProject(project, MOD_INTER);
 210  
 211  			//Âêå‰∏ÄÊ®°Âùó‰∏ã‰∏çÂÖÅËÆ∏ url ÈáçÂ§ç
 212  			if( !config.isCanRepeatUrl() &amp;&amp; customInterfaceService.countByFullUrl(interFace.getModuleId(),
 213  					module.getUrl() +interFace.getUrl(), interFace.getId()) &gt;0 ){



 214  				throw new MyException(MyError.E000004);
 215  			}
 216  
 217  			interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 218  			customInterfaceService.update(InterfaceAdapter.getModel(interFace), &quot;Êé•Âè£&quot;, &quot;&quot;);

 219  			if(interFace.getId().equals(interFace.getProjectId())){
 220  				throw new MyException(MyError.E000027);
 221  			}
 222  			luceneService.update(InterfaceAdapter.getSearchDto(interFace));
 223  
 224  		} else {
 225  			checkUserPermissionByProject(projectCache.get(interFace.getProjectId() ), ADD_INTER);
<abbr title=" 226  			if(!config.isCanRepeatUrl() &amp;&amp; customInterfaceService.countByFullUrl(interFace.getModuleId(),module.getUrl() + interFace.getUrl(), null)&gt;0){"> 226  			if(!config.isCanRepeatUrl() &amp;&amp; customInterfaceService.countByFullUrl(interFace.getModuleId(),module.getUrl() + üîµ</abbr>



 227  				return new JsonResult(MyError.E000004);
 228  			}
 229  			interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 230  			mybatisInterfaceService.insert(InterfaceAdapter.getModel(interFace));

 231  			luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 232  		}
 233  		return new JsonResult(1, interFace);
 234  	}
 235  
 236  	@RequestMapping(&quot;/delete.do&quot;)
 237  	@ResponseBody
 238  	public JsonResult delete(String id, String ids) throws MyException, IOException{
 239  		if( MyString.isEmpty(id) &amp;&amp; MyString.isEmpty(ids)){
 240  			throw new MyException(MyError.E000029);
 241  		}
 242  		if( MyString.isEmpty(ids) ){
 243  			ids = id;
 244  		}
 245  
 246  		for(String tempId : ids.split(&quot;,&quot;)){
 247  			if(MyString.isEmpty(tempId)){
 248  				continue;
 249  			}
 250  			InterfaceWithBLOBs interFace = mybatisInterfaceService.getById( tempId );

 251  			checkUserPermissionByProject(interFace.getProjectId(), DEL_INTER);
 252  			customInterfaceService.delete(interFace.getId(), &quot;Êé•Âè£&quot;, &quot;&quot;);

 253  			luceneService.delete(new SearchDto(interFace.getId()));
 254  		}
 255  		return new JsonResult(1, null);
 256  	}
 257  
 258  	@RequestMapping(&quot;/changeSequence.do&quot;)
 259  	@ResponseBody
 260  	public JsonResult changeSequence(@RequestParam String id,@RequestParam String changeId) throws MyException {
 261  		InterfaceWithBLOBs change = mybatisInterfaceService.getById(changeId);
 262  		InterfaceWithBLOBs model = mybatisInterfaceService.getById(id);


 263  		checkUserPermissionByProject(model.getProjectId(), MOD_INTER);
 264  		checkUserPermissionByProject(change.getProjectId(), MOD_INTER);
 265  
 266  		int modelSequence = model.getSequence();
 267  
 268  		model.setSequence(change.getSequence());
 269  		change.setSequence(modelSequence);
 270  
 271  		mybatisInterfaceService.update(model);
 272  		mybatisInterfaceService.update(change);


 273  		return new JsonResult(1, null);
 274  	}
 275  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            