<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>345</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    345
                    <a href="344.html">prev</a>
                    <a href="346.html">next</a>
                    <a href="345_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_cbc70fa886c8cb9647e92d5fa9f8a4c032c94031_impala/impala-sink/src/main/java/com/dtstack/flink/sql/sink/impala/ImpalaOutputFormat.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;cbc70fa886c8cb9647e92d5fa9f8a4c032c94031:impala/impala-sink/src/main/java/com/dtstack/flink/sql/sink/impala/ImpalaOutputFormat.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;cbc70fa886c8cb9647e92d5fa9f8a4c032c94031^1:impala/impala-sink/src/main/java/com/dtstack/flink/sql/sink/impala/ImpalaOutputFormat.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;cbc70fa886c8cb9647e92d5fa9f8a4c032c94031^2:impala/impala-sink/src/main/java/com/dtstack/flink/sql/sink/impala/ImpalaOutputFormat.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;64c00d303220e98a602fec341743013447048eea:impala/impala-sink/src/main/java/com/dtstack/flink/sql/sink/impala/ImpalaOutputFormat.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [b], [b], [j]], subset: [[b], [b], [b], [b], [b], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.sink.impala;
  20 
  21 import com.dtstack.flink.sql.factory.DTThreadFactory;
  22 import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;
  23 import com.dtstack.flink.sql.sink.rdb.JDBCTypeConvertUtils;
  24 import com.dtstack.flink.sql.table.AbstractTableInfo;
  25 import com.dtstack.flink.sql.util.JDBCUtils;
  26 import com.dtstack.flink.sql.util.KrbUtils;
  27 import com.google.common.collect.Maps;
  28 import org.apache.commons.collections.CollectionUtils;
  29 import org.apache.flink.api.java.tuple.Tuple2;
  30 import org.apache.flink.configuration.Configuration;
  31 import org.apache.flink.types.Row;
  32 import org.apache.hadoop.security.UserGroupInformation;
  33 import org.slf4j.Logger;
  34 import org.slf4j.LoggerFactory;
  35 
  36 import java.io.IOException;
  37 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  38 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import java.security.PrivilegedAction;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import java.security.PrivilegedExceptionAction;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import static org.apache.flink.util.Preconditions.checkNotNull;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46  * @program: flinkStreamSQL</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47  * @author: wuren</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48  * @create: 2020/09/11</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49  **/</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 public class ImpalaOutputFormat extends JDBCUpsertOutputFormat {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51     private String keytabPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52     private String krb5confPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53     private String principal;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54     private Integer authMech;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56     public ImpalaOutputFormat(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57         JDBCOptions options,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58         String[] fieldNames,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59         String[] keyFields,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60         String[] partitionFields,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61         int[] fieldTypes,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62         int flushMaxSize,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63         long flushIntervalMills,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64         boolean allReplace,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65         String updateMode,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66         Integer authMech,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67         String keytabPath,</span>
  68 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69 import java.rmi.RemoteException;</span>
  70 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  71 import java.security.PrivilegedExceptionAction;
  72 import java.sql.Connection;
  73 import java.sql.DriverManager;
  74 import java.sql.PreparedStatement;
  75 import java.sql.SQLException;
  76 import java.sql.Statement;
  77 import java.util.ArrayList;
  78 import java.util.Arrays;
  79 import java.util.HashMap;
  80 import java.util.List;
  81 import java.util.Map;
  82 import java.util.Objects;
  83 import java.util.Set;
  84 import java.util.concurrent.ScheduledExecutorService;
  85 import java.util.concurrent.ScheduledFuture;
  86 import java.util.concurrent.ScheduledThreadPoolExecutor;
  87 import java.util.concurrent.TimeUnit;
  88 import java.util.concurrent.atomic.AtomicReference;
  89 import java.util.regex.Matcher;
  90 import java.util.regex.Pattern;
  91 import java.util.stream.Collectors;
  92 
  93 import static com.dtstack.flink.sql.sink.rdb.JDBCTypeConvertUtils.setRecordToStatement;
  94 import static org.apache.flink.util.Preconditions.checkNotNull;
  95 
  96 /**
  97  * Date: 2020/10/14
  98  * Company: www.dtstack.com
  99  *
 100  * @author tiezhu
 101  */
 102 public class ImpalaOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&lt;Boolean, Row&gt;&gt; {
 103 
 104 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105     public ImpalaOutputFormat(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106             JDBCOptions options,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107             String[] fieldNames,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108             String[] keyFields,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109             String[] partitionFields,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110             int[] fieldTypes,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111             int flushMaxSize,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112             long flushIntervalMills,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113             boolean allReplace,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114             String updateMode,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115             Integer authMech,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116             String keytabPath,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117             String krb5confPath,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118             String principal) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119         super(options,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120                 fieldNames,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121                 keyFields,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122                 partitionFields,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123                 fieldTypes,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124                 flushMaxSize,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125                 flushIntervalMills,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126                 allReplace,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127                 updateMode);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128         this.authMech = authMech;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129         this.keytabPath = keytabPath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         this.krb5confPath = krb5confPath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         this.principal = principal;</span>
 132 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134     public ImpalaOutputFormat(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135         JDBCOptions options,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136         String[] fieldNames,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         String[] keyFields,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         String[] partitionFields,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139         int[] fieldTypes,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         int flushMaxSize,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141         long flushIntervalMills,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         boolean allReplace,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         String updateMode,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         Integer authMech,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145         String keytabPath,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146         String krb5confPath,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147         String principal) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148         super(options,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149             fieldNames,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150             keyFields,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151             partitionFields,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152             fieldTypes,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153             flushMaxSize,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154             flushIntervalMills,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             allReplace,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156             updateMode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157         this.authMech = authMech;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158         this.keytabPath = keytabPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159         this.krb5confPath = krb5confPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160         this.principal = principal;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164     public void open(int taskNumber, int numTasks) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         if (authMech == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166             UserGroupInformation ugi = KrbUtils.loginAndReturnUgi(principal, keytabPath, krb5confPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167             try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168                 ugi.doAs(new PrivilegedExceptionAction&lt;Void&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169                     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170                     public Void run() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171                         openJdbc();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172                         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174                 });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             } catch (InterruptedException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176                 e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179             super.open(taskNumber, numTasks);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183     public static Builder impalaBuilder() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184         return new Builder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187     public static class Builder {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188         private Integer authMech;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189         private String keytabPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190         private String krb5confPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191         private String principal;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193         protected JDBCOptions options;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194         protected String[] fieldNames;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195         protected String[] keyFields;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196         protected String[] partitionFields;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197         protected int[] fieldTypes;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         protected int flushMaxSize = DEFAULT_FLUSH_MAX_SIZE;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199         protected long flushIntervalMills = DEFAULT_FLUSH_INTERVAL_MILLS;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200         protected boolean allReplace = DEFAULT_ALLREPLACE_VALUE;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201         protected String updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203         /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204          * required, jdbc options.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205          */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206         public Builder setOptions(JDBCOptions options) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207             this.options = options;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211         /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212          * required, field names of this jdbc sink.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213          */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214         public Builder setFieldNames(String[] fieldNames) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215             this.fieldNames = fieldNames;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219         /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220          * required, upsert unique keys.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221          */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222         public Builder setKeyFields(List&lt;String&gt; keyFields) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223             this.keyFields = keyFields == null ? null : keyFields.toArray(new String[keyFields.size()]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227         /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228          * required, field types of this jdbc sink.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229          */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230         public Builder setFieldTypes(int[] fieldTypes) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231             this.fieldTypes = fieldTypes;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235         /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236          * optional, partition Fields</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237          *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238          * @param partitionFields</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239          * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240          */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241         public Builder setPartitionFields(String[] partitionFields) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242             this.partitionFields = partitionFields;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246         /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247          * optional, flush max size (includes all append, upsert and delete records),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248          * over this number of records, will flush data.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249          */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250         public Builder setFlushMaxSize(int flushMaxSize) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251             this.flushMaxSize = flushMaxSize;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255         /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256          * optional, flush interval mills, over this time, asynchronous threads will flush data.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257          */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258         public Builder setFlushIntervalMills(long flushIntervalMills) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259             this.flushIntervalMills = flushIntervalMills;</span>
 260 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261     private static final Logger LOG = LoggerFactory.getLogger(ImpalaOutputFormat.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263     private static final long serialVersionUID = 1L;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265     // ${field}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266     private static final Pattern STATIC_PARTITION_PATTERN = Pattern.compile(&quot;\\$\\{([^}]*)}&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 267     // cast(value as string) -&gt; cast(&#x27;value&#x27; as string)  cast(value as timestamp) -&gt; cast(&#x27;value&#x27; as timestamp)"> 267     // cast(value as string) -&gt; cast(&#x27;value&#x27; as string)  cast(value as timestamp) -&gt; cast(&#x27;value&#x27; as time🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268     private static final Pattern TYPE_PATTERN = Pattern.compile(&quot;cast\\((.*) as (.*)\\)&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269     //specific type which values need to be quoted</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270     private static final String[] NEED_QUOTE_TYPE = {&quot;string&quot;, &quot;timestamp&quot;, &quot;varchar&quot;};</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272     private static final Integer DEFAULT_CONN_TIME_OUT = 60;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273     private static final int RECEIVE_DATA_PRINT_FREQUENCY = 1000;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274     private static final int DIRTY_DATA_PRINT_FREQUENCY = 1000;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276     private static final String KUDU_TYPE = &quot;kudu&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277     private static final String UPDATE_MODE = &quot;update&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278     private static final String PARTITION_CONSTANT = &quot;PARTITION&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279     private static final String DRIVER_NAME = &quot;com.cloudera.impala.jdbc41.Driver&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281     private static final String VALUES_CONDITION = &quot;${valuesCondition}&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282     private static final String PARTITION_CONDITION = &quot;${partitionCondition}&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283     private static final String TABLE_FIELDS_CONDITION = &quot;${tableFieldsCondition}&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284     private static final String NO_PARTITION = &quot;noPartition&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286     protected transient Connection connection;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287     protected transient Statement statement;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288     protected transient PreparedStatement updateStatement;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290     private transient volatile boolean closed = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291     private int batchCount = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293     // |------------------------------------------------|</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294     // |   partitionCondition   |Array of valueCondition|</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295     // |------------------------------------------------|</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296     // | ptOne, ptTwo, ptThree  | [(v1, v2, v3, v4, v5)]|   DP</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297     // |------------------------------------------------|</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298     // | ptOne = v1, ptTwo = v2 | [(v3, v4, v5)]        |   SP</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299     // |------------------------------------------------|</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300     // | ptOne, ptTwo = v2      | [(v1, v3, v4, v5)]    |   DP and SP</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301     // |------------------------------------------------|</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302     // | noPartition            | [(v1, v2, v3, v4, v5)]|   kudu or disablePartition</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303     // |------------------------------------------------|</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304     private transient Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306     protected String keytabPath;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307     protected String krb5confPath;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308     protected String principal;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309     protected Integer authMech;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310     protected String dbUrl;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311     protected String userName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312     protected String password;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313     protected int batchSize = 100;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314     protected long batchWaitInterval = 60 * 1000L;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315     protected String tableName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316     protected List&lt;String&gt; primaryKeys;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317     protected String partitionFields;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318     protected Boolean enablePartition;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319     protected String schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320     protected String storeType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321     protected String updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322     public List&lt;String&gt; fieldNames;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323     public List&lt;String&gt; fieldTypes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324     public List&lt;AbstractTableInfo.FieldExtraInfo&gt; fieldExtraInfoList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326     // partition field of static partition which matched by ${field}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327     private final List&lt;String&gt; staticPartitionFields = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329     // valueFieldsName -&gt; 重组之后的fieldNames，为了重组row data字段值对应</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330     // 需要对partition字段做特殊处理，比如原来的字段顺序为(age, name, id)，但是因为partition，写入的SQL为</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331     // INSERT INTO tableName(name, id) PARTITION(age) VALUES(?, ?, ?)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332     // 那么实际executeSql设置字段的顺序应该为(name, id, age)，同时，字段对应的type顺序也需要重组</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333     private List&lt;String&gt; valueFieldNames;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334     private transient AbstractDtRichOutputFormat&lt;?&gt; metricOutputFormat;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335     private List&lt;Row&gt; rows;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337     private transient ScheduledExecutorService scheduler;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338     private transient ScheduledFuture&lt;?&gt; scheduledFuture;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341     public void configure(Configuration parameters) {</span>
 342 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 343     }
 344 
 345     @Override
 346     public void open(int taskNumber, int numTasks) throws IOException {
 347         try {
 348             rowDataMap = new HashMap&lt;&gt;();
 349             rows = new ArrayList&lt;&gt;();
 350             metricOutputFormat = this;
 351             openConnect();
 352             initScheduledTask(batchWaitInterval);
 353             init();
 354             initMetric();
 355         } catch (Exception e) {
 356             throw new RuntimeException(&quot;impala output format open error!&quot;, e);
 357         }
 358     }
 359 
 360     private void init() throws SQLException {
 361         if (Objects.nonNull(partitionFields)) {
 362             // match ${field} from partitionFields
 363             Matcher matcher = STATIC_PARTITION_PATTERN.matcher(partitionFields);
 364             while (matcher.find()) {
 365                 LOG.info(&quot;find static partition field: {}&quot;, matcher.group(1));
 366                 staticPartitionFields.add(matcher.group(1));
 367             }
 368         }
 369 
 370         if (updateMode.equalsIgnoreCase(UPDATE_MODE)) {
 371             if (!storeType.equalsIgnoreCase(KUDU_TYPE)) {
 372                 throw new IllegalArgumentException(&quot;update mode not support for non-kudu table!&quot;);
 373             }
 374 
<abbr title=" 375             updateStatement = connection.prepareStatement(buildUpdateSql(schema, tableName, fieldNames, primaryKeys));"> 375             updateStatement = connection.prepareStatement(buildUpdateSql(schema, tableName, fieldNames, p🔵</abbr>
 376             return;
 377         }
 378 
<abbr title=" 379         valueFieldNames = rebuildFieldNameListAndTypeList(fieldNames, staticPartitionFields, fieldTypes, partitionFields);"> 379         valueFieldNames = rebuildFieldNameListAndTypeList(fieldNames, staticPartitionFields, fieldTypes, 🔵</abbr>
 380     }
 381 
 382     private void initScheduledTask(Long batchWaitInterval) {
 383         try {
 384             if (batchWaitInterval != 0) {
 385                 this.scheduler = new ScheduledThreadPoolExecutor(1,
 386                         new DTThreadFactory(&quot;impala-upsert-output-format&quot;));
 387                 this.scheduledFuture = this.scheduler.scheduleWithFixedDelay(() -&gt; {
 388                     synchronized (ImpalaOutputFormat.this) {
 389                         try {
 390                             flush();
 391                         } catch (Exception e) {
 392                             LOG.error(&quot;Writing records to impala jdbc failed.&quot;, e);
 393                             throw new RuntimeException(&quot;Writing records to impala jdbc failed.&quot;, e);
 394                         }
 395                     }
 396                 }, batchWaitInterval, batchWaitInterval, TimeUnit.MILLISECONDS);
 397             }
 398         } catch (Exception e) {
 399             throw new RuntimeException(e);
 400         }
 401     }
 402 
 403     private void openConnect() throws IOException {
 404         if (authMech == 1) {
 405             UserGroupInformation ugi = KrbUtils.loginAndReturnUgi(principal, keytabPath, krb5confPath);
 406             try {
 407                 ugi.doAs((PrivilegedExceptionAction&lt;Void&gt;) () -&gt; {
 408                     openJdbc();
 409                     return null;
 410                 });
 411             } catch (InterruptedException | IOException e) {
 412                 throw new IllegalArgumentException(&quot;connect impala error!&quot;, e);
 413             }
 414         } else {
 415             openJdbc();
 416         }
 417     }
 418 
 419 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 420     public static Builder impalaBuilder() {</span>
 421 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423     public static Builder impalaBuilder() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424         return new Builder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427     public static class Builder {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428         private Integer authMech;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429         private String keytabPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430         private String krb5confPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431         private String principal;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433         protected JDBCOptions options;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434         protected String[] fieldNames;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435         protected String[] keyFields;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436         protected String[] partitionFields;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437         protected int[] fieldTypes;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438         protected int flushMaxSize = DEFAULT_FLUSH_MAX_SIZE;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439         protected long flushIntervalMills = DEFAULT_FLUSH_INTERVAL_MILLS;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 440         protected boolean allReplace = DEFAULT_ALLREPLACE_VALUE;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441         protected String updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443         /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444          * required, jdbc options.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445          */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446         public Builder setOptions(JDBCOptions options) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447             this.options = options;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451         /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452          * required, field names of this jdbc sink.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453          */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454         public Builder setFieldNames(String[] fieldNames) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455             this.fieldNames = fieldNames;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459         /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460          * required, upsert unique keys.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461          */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462         public Builder setKeyFields(List&lt;String&gt; keyFields) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463             this.keyFields = keyFields == null ? null : keyFields.toArray(new String[keyFields.size()]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 464             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 465         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467         /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 468          * required, field types of this jdbc sink.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 469          */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 470         public Builder setFieldTypes(int[] fieldTypes) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 471             this.fieldTypes = fieldTypes;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 472             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 473         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475         /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 476          * optional, partition Fields</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 477          *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 478          * @param partitionFields</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 479          * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 480          */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 481         public Builder setPartitionFields(String[] partitionFields) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482             this.partitionFields = partitionFields;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486         /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487          * optional, flush max size (includes all append, upsert and delete records),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488          * over this number of records, will flush data.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489          */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 490         public Builder setFlushMaxSize(int flushMaxSize) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 491             this.flushMaxSize = flushMaxSize;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 492             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 493         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 494 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495         /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496          * optional, flush interval mills, over this time, asynchronous threads will flush data.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497          */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498         public Builder setFlushIntervalMills(long flushIntervalMills) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499             this.flushIntervalMills = flushIntervalMills;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 502 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 503         public Builder setAllReplace(boolean allReplace) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 504             this.allReplace = allReplace;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 506         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 507 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 508         public Builder setUpdateMode(String updateMode) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 509             this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 511         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 512 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 513         public Builder setAuthMech(Integer authMech) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 514             this.authMech = authMech;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 515             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 516         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 517         public Builder setKeytabPath(String keytabPath) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 518             this.keytabPath = keytabPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 519             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 520         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 521         public Builder setKrb5confPath(String krb5confPath) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 522             this.krb5confPath = krb5confPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 523             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 524         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525         public Builder setPrincipal(String principal) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526             this.principal = principal;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 528         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530         public ImpalaOutputFormat build() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531             checkNotNull(options, &quot;No options supplied.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532             checkNotNull(fieldNames, &quot;No fieldNames supplied.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533             return new ImpalaOutputFormat(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 534                 options,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 535                 fieldNames,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 536                 keyFields,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 537                 partitionFields,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 538                 fieldTypes,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 539                 flushMaxSize,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 540                 flushIntervalMills,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 541                 allReplace,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 542                 updateMode,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 543                 authMech,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 544                 keytabPath,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 545                 krb5confPath,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 546                 principal);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 547         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 548     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 549 }</span>
 550 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552      * get jdbc connection</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554     private void openJdbc() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555         JDBCUtils.forName(DRIVER_NAME, getClass().getClassLoader());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557             connection = DriverManager.getConnection(dbUrl, userName, password);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558             statement = connection.createStatement();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559             connection.setAutoCommit(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560         } catch (SQLException sqlException) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561             throw new RuntimeException(&quot;get impala jdbc connection failed!&quot;, sqlException);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565     private void flush() throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566         if (batchCount &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567             if (updateMode.equalsIgnoreCase(UPDATE_MODE)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568                 executeUpdateBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570             if (!rowDataMap.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571                 String templateSql =</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 572                         &quot;INSERT INTO tableName ${tableFieldsCondition} PARTITION ${partitionCondition} VALUES ${valuesCondition}&quot;;"> 572                         &quot;INSERT INTO tableName ${tableFieldsCondition} PARTITION ${partitionCondition} VA🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573                 executeBatchSql(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574                         statement,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575                         templateSql,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576                         schema,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577                         tableName,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578                         storeType,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579                         enablePartition,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580                         valueFieldNames,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581                         partitionFields,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582                         rowDataMap</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583                 );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584                 rowDataMap.clear();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587         batchCount = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592      * execute batch update statement</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594      * @throws SQLException throw sql exception</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596     private void executeUpdateBatch() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598             rows.forEach(row -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599                 try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600                     JDBCTypeConvertUtils.setRecordToStatement(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601                             updateStatement,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602                             JDBCTypeConvertUtils.getSqlTypeFromFieldType(fieldTypes),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603                             row,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604                             primaryKeys.stream().mapToInt(fieldNames::indexOf).toArray()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605                     );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606                     updateStatement.addBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607                 } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608                     throw new RuntimeException(&quot;impala jdbc execute batch error!&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610             });</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611             updateStatement.executeBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612             connection.commit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613             rows.clear();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615             LOG.debug(&quot;impala jdbc execute batch error &quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616             connection.rollback();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617             connection.commit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618             updateStatement.clearBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619             executeUpdate(connection);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623     public void executeUpdate(Connection connection) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624         rows.forEach(row -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 626                 setRecordToStatement(updateStatement, JDBCTypeConvertUtils.getSqlTypeFromFieldType(fieldTypes), row);"> 626                 setRecordToStatement(updateStatement, JDBCTypeConvertUtils.getSqlTypeFromFieldType(fieldT🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627                 updateStatement.executeUpdate();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628                 connection.commit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629             } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630                 try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631                     connection.rollback();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632                     connection.commit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633                 } catch (SQLException e1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634                     throw new RuntimeException(e1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 636                 if (metricOutputFormat.outDirtyRecords.getCount() % DIRTY_DATA_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {"> 636                 if (metricOutputFormat.outDirtyRecords.getCount() % DIRTY_DATA_PRINT_FREQUENCY == 0 || LO🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637                     LOG.error(&quot;record insert failed ,this row is {}&quot;, row.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638                     LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640                 metricOutputFormat.outDirtyRecords.inc();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642         });</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643         rows.clear();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 646     private void putRowIntoMap(Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap, Tuple2&lt;String, String&gt; rowData) {"> 646     private void putRowIntoMap(Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap, Tuple2&lt;String, String&gt; rowData)🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647         Set&lt;String&gt; keySet = rowDataMap.keySet();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648         ArrayList&lt;String&gt; tempRowArray;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649         if (keySet.contains(rowData.f0)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650             tempRowArray = rowDataMap.get(rowData.f0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652             tempRowArray = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654         tempRowArray.add(rowData.f1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655         rowDataMap.put(rowData.f0, tempRowArray);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 658     private List&lt;String&gt; rebuildFieldNameListAndTypeList(List&lt;String&gt; fieldNames, List&lt;String&gt; staticPartitionFields, List&lt;String&gt; fieldTypes, String partitionFields) {"> 658     private List&lt;String&gt; rebuildFieldNameListAndTypeList(List&lt;String&gt; fieldNames, List&lt;String&gt; staticPart🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659         if (partitionFields.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660             return fieldNames;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663         List&lt;String&gt; valueFields = new ArrayList&lt;&gt;(fieldNames);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665         for (int i = valueFields.size() - 1; i &gt;= 0; i--) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666             if (staticPartitionFields.contains(fieldNames.get(i))) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667                 valueFields.remove(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668                 fieldTypes.remove(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672         for (int i = 0; i &lt; valueFields.size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673             if (partitionFields.contains(fieldNames.get(i))) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674                 valueFields.add(valueFields.remove(i));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675                 fieldTypes.add(fieldTypes.remove(i));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679         return valueFields;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683      * Quote a specific type of value, like string, timestamp</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684      * before: 1, cast(tiezhu as string), cast(2001-01-09 01:05:01 as timestamp), cast(123 as int)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685      * after: 1, cast(&#x27;tiezhu&#x27; as string), cast(&#x27;2001-01-09 01:05:01&#x27; as timestamp), cast(123 as int)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686      * if cast value is null, then cast(null as type)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688      * @param valueCondition original value condition</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689      * @return quoted condition</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691     private String valueConditionAddQuotation(String valueCondition) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692         String[] temps = valueCondition.split(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693         List&lt;String&gt; replacedItem = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694         Arrays.stream(temps).forEach(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695                 item -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696                     Matcher matcher = TYPE_PATTERN.matcher(item);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697                     while (matcher.find()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698                         String value = matcher.group(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699                         String type = matcher.group(2);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701                         for (String needQuoteType : NEED_QUOTE_TYPE) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702                             if (type.contains(needQuoteType)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703                                 if (!&quot;null&quot;.equals(value)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704                                     item = item.replace(value, &quot;&#x27;&quot; + value + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705                                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706                             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709                     replacedItem.add(item);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711         );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713         return &quot;(&quot; + String.join(&quot;, &quot;, replacedItem) + &quot;)&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717     public void writeRecord(Tuple2&lt;Boolean, Row&gt; record) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719             if (!record.f0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723             if (outRecords.getCount() % RECEIVE_DATA_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724                 LOG.info(&quot;Receive data : {}&quot;, record);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727             if (updateMode.equalsIgnoreCase(UPDATE_MODE)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728                 rows.add(Row.copy(record.f1));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730                 Map&lt;String, Object&gt; valueMap = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731                 Row row = Row.copy(record.f1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733                 for (int i = 0; i &lt; row.getArity(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734                     valueMap.put(fieldNames.get(i), row.getField(i));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 735                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 736 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 737                 Tuple2&lt;String, String&gt; rowTuple2 = new Tuple2&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 738                 if (storeType.equalsIgnoreCase(KUDU_TYPE) || !enablePartition) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 739                     rowTuple2.f0 = NO_PARTITION;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 740                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 741                     rowTuple2.f0 = buildPartitionCondition(valueMap, partitionFields, staticPartitionFields);"> 741                     rowTuple2.f0 = buildPartitionCondition(valueMap, partitionFields, staticPartitionFiel🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 742                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 743 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 744                 // 根据字段名对 row data 重组, 比如，原始 row data : (1, xxx, 20) -&gt; (id, name, age)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 745                 // 但是由于 partition，写入的field 顺序变成了 (name, id, age)，则需要对 row data 重组变成 (xxx, 1, 20)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 746                 Row rowValue = new Row(fieldTypes.size());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 747                 for (int i = 0; i &lt; fieldTypes.size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 748                     rowValue.setField(i, valueMap.get(valueFieldNames.get(i)));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 749                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 750                 rowTuple2.f1 = valueConditionAddQuotation(buildValuesCondition(fieldTypes, rowValue));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 751                 putRowIntoMap(rowDataMap, rowTuple2);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 752             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 753 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 754             batchCount++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 755 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 756             if (batchCount &gt;= batchSize) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 757                 flush();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 758             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 759 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 760             // Receive data</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 761             outRecords.inc();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 762         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 763             throw new IOException(&quot;Writing records to impala failed.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 764         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 765     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 766 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 767     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 768     public void close() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 769         if (closed) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 770             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 771         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 772         // 将还未执行的SQL flush</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 773         if (batchCount &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 774             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 775                 flush();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 776             } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 777                 throw new RuntimeException(&quot;Writing records to impala failed.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 778             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 779         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 780         // cancel scheduled task</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 781         if (this.scheduledFuture != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 782             scheduledFuture.cancel(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 783             this.scheduler.shutdown();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 784         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 785         // close connection</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 786         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 787             if (connection != null &amp;&amp; connection.isValid(DEFAULT_CONN_TIME_OUT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 788                 connection.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 789             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 790 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 791             if (statement != null &amp;&amp; !statement.isClosed()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 792                 statement.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 793             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 794 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 795             if (updateStatement != null &amp;&amp; !updateStatement.isClosed()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 796                 updateStatement.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 797             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 798         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 799             throw new RuntimeException(&quot;impala connection close failed!&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 800         } finally {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 801             connection = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 802             statement = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 803             updateStatement = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 804         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 805         closed = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 806     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 807 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 808     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 809      * execute batch sql from row data map</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 810      * sql like &#x27;insert into tableName(f1, f2, f3) ${partitionCondition} values(v1, v2, v3), (v4, v5, v6)...."> 810      * sql like &#x27;insert into tableName(f1, f2, f3) ${partitionCondition} values(v1, v2, v3), (v4, v5, v6)🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 811      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 812      * @param statement       execute statement</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 813      * @param tempSql         template sql</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 814      * @param storeType       the store type of data</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 815      * @param enablePartition enable partition or not</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 816      * @param fieldNames      field name list</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 817      * @param partitionFields partition fields</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 818      * @param rowDataMap      row data map</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 819      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 820     private void executeBatchSql(Statement statement,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 821                                  String tempSql,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 822                                  String schema,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 823                                  String tableName,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 824                                  String storeType,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 825                                  Boolean enablePartition,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 826                                  List&lt;String&gt; fieldNames,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 827                                  String partitionFields,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 828                                  Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 829         StringBuilder valuesCondition = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 830         StringBuilder partitionCondition = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 831         String tableFieldsCondition = buildTableFieldsCondition(fieldNames, partitionFields);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 832         ArrayList&lt;String&gt; rowData;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 833         String tableNameInfo = Objects.isNull(schema) ?</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 834                 tableName : quoteIdentifier(schema) + &quot;.&quot; + tableName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 835         tempSql = tempSql.replace(&quot;tableName&quot;, tableNameInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 836 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 837         // kudu ${partitionCondition} is null</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 838         if (storeType.equalsIgnoreCase(KUDU_TYPE) || !enablePartition) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 839             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 840                 rowData = rowDataMap.get(NO_PARTITION);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 841                 rowData.forEach(row -&gt; valuesCondition.append(row).append(&quot;, &quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 842                 String executeSql = tempSql.replace(VALUES_CONDITION, valuesCondition.toString())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 843                         .replace(PARTITION_CONDITION, partitionCondition.toString())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 844                         .replace(PARTITION_CONSTANT, &quot;&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 845                         .replace(TABLE_FIELDS_CONDITION, tableFieldsCondition);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 846                 String substring = executeSql.substring(0, executeSql.length() - 2);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 847                 statement.execute(substring);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 848             } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 849                 throw new RuntimeException(&quot;execute impala SQL error!&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 850             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 851             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 852         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 853 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 854         // partition sql</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 855         Set&lt;String&gt; keySet = rowDataMap.keySet();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 856         String finalTempSql = tempSql;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 857         for (String key : keySet) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 858             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 859                 String executeSql = String.copyValueOf(finalTempSql.toCharArray());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 860                 ArrayList&lt;String&gt; valuesConditionList = rowDataMap.get(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 861                 partitionCondition.append(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 862                 executeSql = executeSql.replace(PARTITION_CONDITION, partitionCondition.toString())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 863                         .replace(TABLE_FIELDS_CONDITION, tableFieldsCondition)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 864                         .replace(VALUES_CONDITION, String.join(&quot;, &quot;, valuesConditionList));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 865                 statement.execute(executeSql);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 866                 partitionCondition.delete(0, partitionCondition.length());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 867             } catch (SQLException sqlException) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 868                 throw new RuntimeException(&quot;execute impala SQL error! &quot;, sqlException);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 869             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 870         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 871     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 872 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 873     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 874      * build partition condition with row data</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 875      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 876      * @param rowData              row data</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 877      * @param partitionFields      partition fields</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 878      * @param staticPartitionField static partition fields</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 879      * @return condition like &#x27;(ptOne, ptTwo=v2)&#x27;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 880      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 881     private String buildPartitionCondition(Map&lt;String, Object&gt; rowData, String partitionFields, List&lt;String&gt; staticPartitionField) {"> 881     private String buildPartitionCondition(Map&lt;String, Object&gt; rowData, String partitionFields, List&lt;Stri🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 882         for (String key : staticPartitionField) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 883             StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 884             Object value = rowData.get(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 885             sb.append(key).append(&quot;=&quot;).append(value);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 886             partitionFields = partitionFields.replace(&quot;${&quot; + key + &quot;}&quot;, sb.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 887         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 888         return &quot;(&quot; + partitionFields + &quot;)&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 889     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 890 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 891     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 892      * build field condition according to field names</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 893      * replace ${tableFieldCondition}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 894      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 895      * @param fieldNames      the selected field names</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 896      * @param partitionFields the partition fields</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 897      * @return condition like &#x27;(id, name, age)&#x27;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 898      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 899     private String buildTableFieldsCondition(List&lt;String&gt; fieldNames, String partitionFields) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 900         return &quot;(&quot; + fieldNames.stream()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 901                 .filter(f -&gt; !partitionFields.contains(f))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 902                 .map(this::quoteIdentifier)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 903                 .collect(Collectors.joining(&quot;, &quot;)) + &quot;)&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 904     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 905 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 906     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 907      * according to field types, build the values condition</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 908      * replace ${valuesCondition}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 909      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 910      * @param fieldTypes field types</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 911      * @return condition like &#x27;(?, ?, cast(? as string))&#x27; and &#x27;?&#x27; will be replaced with row data</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 912      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 913     private String buildValuesCondition(List&lt;String&gt; fieldTypes, Row row) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 914         String valuesCondition = fieldTypes.stream().map(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 915                 f -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 916                     for (String item : NEED_QUOTE_TYPE) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 917                         if (f.toLowerCase().contains(item)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 918                             return String.format(&quot;cast(? as %s)&quot;, f.toLowerCase());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 919                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 920                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 921                     return &quot;?&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 922                 }).collect(Collectors.joining(&quot;, &quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 923         for (int i = 0; i &lt; row.getArity(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 924             valuesCondition = valuesCondition.replaceFirst(&quot;\\?&quot;, Objects.isNull(row.getField(i)) ? &quot;null&quot; : row.getField(i).toString());"> 924             valuesCondition = valuesCondition.replaceFirst(&quot;\\?&quot;, Objects.isNull(row.getField(i)) ? &quot;null🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 925         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 926         return valuesCondition;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 927     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 928 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 929     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 930      * impala update mode SQL</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 931      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 932      * @return UPDATE tableName SET setCondition WHERE whereCondition</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 933      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 934     private String buildUpdateSql(String schema, String tableName, List&lt;String&gt; fieldNames, List&lt;String&gt; primaryKeys) {"> 934     private String buildUpdateSql(String schema, String tableName, List&lt;String&gt; fieldNames, List&lt;String&gt; 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 935         //跳过primary key字段</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 936         String setClause = fieldNames.stream()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 937                 .filter(f -&gt; !CollectionUtils.isNotEmpty(primaryKeys) || !primaryKeys.contains(f))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 938                 .map(f -&gt; quoteIdentifier(f) + &quot;=?&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 939                 .collect(Collectors.joining(&quot;, &quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 940 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 941         String conditionClause = primaryKeys.stream()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 942                 .map(f -&gt; quoteIdentifier(f) + &quot;=?&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 943                 .collect(Collectors.joining(&quot; AND &quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 944 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 945         return &quot;UPDATE &quot; + (Objects.isNull(schema) ? &quot;&quot; : quoteIdentifier(schema) + &quot;.&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 946                 + quoteIdentifier(tableName) + &quot; SET &quot; + setClause + &quot; WHERE &quot; + conditionClause;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 947     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 948 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 949     private String quoteIdentifier(String identifier) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 950         return &quot;`&quot; + identifier + &quot;`&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 951     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 952 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 953     public static Builder getImpalaBuilder() {</span>
 954 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 955         return new Builder();
 956     }
 957 
 958     public static class Builder {
 959         private final ImpalaOutputFormat format = new ImpalaOutputFormat();
 960 
 961         public Builder setDbUrl(String dbUrl) {
 962             format.dbUrl = dbUrl;
 963             return this;
 964         }
 965 
 966         public Builder setUserName(String userName) {
 967             format.userName = userName;
 968             return this;
 969         }
 970 
 971         public Builder setPassword(String password) {
 972             format.password = password;
 973             return this;
 974         }
 975 
 976         public Builder setBatchSize(Integer batchSize) {
 977             format.batchSize = batchSize;
 978             return this;
 979         }
 980 
 981         public Builder setBatchWaitInterval(Long batchWaitInterval) {
 982             format.batchWaitInterval = batchWaitInterval;
 983             return this;
 984         }
 985 
 986         public Builder setTableName(String tableName) {
 987             format.tableName = tableName;
 988             return this;
 989         }
 990 
 991         public Builder setPartitionFields(String partitionFields) {
 992             format.partitionFields = Objects.isNull(partitionFields) ?
 993                     &quot;&quot; : partitionFields;
 994             return this;
 995         }
 996 
 997         public Builder setPrimaryKeys(List&lt;String&gt; primaryKeys) {
 998             format.primaryKeys = primaryKeys;
 999             return this;
1000         }
1001 
1002         public Builder setSchema(String schema) {
1003             format.schema = schema;
1004             return this;
1005         }
1006 
1007         public Builder setEnablePartition(Boolean enablePartition) {
1008             format.enablePartition = enablePartition;
1009             return this;
1010         }
1011 
1012         public Builder setUpdateMode(String updateMode) {
1013             format.updateMode = updateMode;
1014             return this;
1015         }
1016 
1017         public Builder setFieldList(List&lt;String&gt; fieldList) {
1018             format.fieldNames = fieldList;
1019             return this;
1020         }
1021 
1022         public Builder setFieldTypeList(List&lt;String&gt; fieldTypeList) {
1023             format.fieldTypes = fieldTypeList;
1024             return this;
1025         }
1026 
1027         public Builder setStoreType(String storeType) {
1028             format.storeType = storeType;
1029             return this;
1030         }
1031 
1032         public Builder setFieldExtraInfoList(List&lt;AbstractTableInfo.FieldExtraInfo&gt; fieldExtraInfoList) {
1033             format.fieldExtraInfoList = fieldExtraInfoList;
1034             return this;
1035         }
1036 
1037         public Builder setKeyTabPath(String keyTabPath) {
1038             format.keytabPath = keyTabPath;
1039             return this;
1040         }
1041 
1042         public Builder setKrb5ConfPath(String krb5ConfPath) {
1043             format.krb5confPath = krb5ConfPath;
1044             return this;
1045         }
1046 
1047         public Builder setPrincipal(String principal) {
1048             format.principal = principal;
1049             return this;
1050         }
1051 
1052         public Builder setAuthMech(Integer authMech) {
1053             format.authMech = authMech;
1054             return this;
1055         }
1056 
1057         private boolean canHandle(String url) {
1058             return url.startsWith(&quot;jdbc:impala:&quot;);
1059         }
1060 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1061         public Builder setKrb5confPath(String krb5confPath) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1062             this.krb5confPath = krb5confPath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1063             return this;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1064         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1065         public Builder setPrincipal(String principal) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1066             this.principal = principal;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1067             return this;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1068         }</span>
1069 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1070         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1071         public Builder setKrb5confPath(String krb5confPath) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1072             this.krb5confPath = krb5confPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1073             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1074         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1075         public Builder setPrincipal(String principal) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1076             this.principal = principal;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1077             return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1078         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1079         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1080         public ImpalaOutputFormat build() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1081             checkNotNull(options, &quot;No options supplied.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1082             checkNotNull(fieldNames, &quot;No fieldNames supplied.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1083             return new ImpalaOutputFormat(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1084                 options,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1085                 fieldNames,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1086                 keyFields,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1087                 partitionFields,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1088                 fieldTypes,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1089                 flushMaxSize,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1090                 flushIntervalMills,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1091                 allReplace,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1092                 updateMode,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1093                 authMech,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1094                 keytabPath,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1095                 krb5confPath,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1096                 principal);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1097         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1098     }</span>
1099 =======
1100 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1101 
1102         public ImpalaOutputFormat build() {
1103 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1104             checkNotNull(options, &quot;No options supplied.&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1105             checkNotNull(fieldNames, &quot;No fieldNames supplied.&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1106             return new ImpalaOutputFormat(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1107                     options,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1108                     fieldNames,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1109                     keyFields,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1110                     partitionFields,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1111                     fieldTypes,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1112                     flushMaxSize,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1113                     flushIntervalMills,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1114                     allReplace,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1115                     updateMode,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1116                     authMech,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1117                     keytabPath,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1118                     krb5confPath,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1119                     principal);</span>
1120 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1121         public ImpalaOutputFormat build() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1122             checkNotNull(options, &quot;No options supplied.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1123             checkNotNull(fieldNames, &quot;No fieldNames supplied.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1124             return new ImpalaOutputFormat(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1125                 options,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1126                 fieldNames,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1127                 keyFields,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1128                 partitionFields,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1129                 fieldTypes,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1130                 flushMaxSize,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1131                 flushIntervalMills,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1132                 allReplace,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1133                 updateMode,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1134                 authMech,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1135                 keytabPath,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1136                 krb5confPath,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1137                 principal);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1138         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1139     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1140 }</span>
1141 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1142             if (!canHandle(format.dbUrl)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1143                 throw new IllegalArgumentException(&quot;impala dbUrl is illegal, check url: &quot; + format.dbUrl);">1143                 throw new IllegalArgumentException(&quot;impala dbUrl is illegal, check url: &quot; + format.dbUrl)🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1144             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1145 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1146             if (format.authMech == EAuthMech.Kerberos.getType()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1147                 checkNotNull(format.krb5confPath,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1148                         &quot;When kerberos authentication is enabled, krb5confPath is required！&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1149                 checkNotNull(format.principal,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1150                         &quot;When kerberos authentication is enabled, principal is required！&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1151                 checkNotNull(format.keytabPath,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1152                         &quot;When kerberos authentication is enabled, keytabPath is required！&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1153             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1154 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1155             if (format.authMech == EAuthMech.UserName.getType()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1156                 checkNotNull(format.userName, &quot;userName is required!&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1157             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1158 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1159             if (format.authMech == EAuthMech.NameANDPassword.getType()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1160                 checkNotNull(format.userName, &quot;userName is required!&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1161                 checkNotNull(format.password, &quot;password is required!&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1162             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1163 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1164             checkNotNull(format.storeType, &quot;storeType is required!&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1165 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1166             return format;</span>
1167 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1168         }
1169     }
1170 }</pre></td>
                            <td><pre>   1 package com.dtstack.flink.sql.sink.impala;
   2 
   3 import com.dtstack.flink.sql.factory.DTThreadFactory;
   4 import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;
   5 import com.dtstack.flink.sql.sink.rdb.JDBCTypeConvertUtils;
   6 import com.dtstack.flink.sql.table.AbstractTableInfo;
   7 import com.dtstack.flink.sql.util.JDBCUtils;
   8 import com.dtstack.flink.sql.util.KrbUtils;
   9 import com.google.common.collect.Maps;
  10 import org.apache.commons.collections.CollectionUtils;
  11 import org.apache.flink.api.java.tuple.Tuple2;
  12 import org.apache.flink.configuration.Configuration;
  13 import org.apache.flink.types.Row;
  14 import org.apache.hadoop.security.UserGroupInformation;
  15 import org.slf4j.Logger;
  16 import org.slf4j.LoggerFactory;
  17 
  18 import java.io.IOException;
  19 import java.rmi.RemoteException;
  20 import java.security.PrivilegedExceptionAction;
  21 import java.sql.Connection;
  22 import java.sql.DriverManager;
  23 import java.sql.PreparedStatement;
  24 import java.sql.SQLException;
  25 import java.sql.Statement;
  26 import java.util.ArrayList;
  27 import java.util.Arrays;
  28 import java.util.HashMap;
  29 import java.util.List;
  30 import java.util.Map;
  31 import java.util.Objects;
  32 import java.util.Set;
  33 import java.util.concurrent.ScheduledExecutorService;
  34 import java.util.concurrent.ScheduledFuture;
  35 import java.util.concurrent.ScheduledThreadPoolExecutor;
  36 import java.util.concurrent.TimeUnit;
  37 import java.util.concurrent.atomic.AtomicReference;
  38 import java.util.regex.Matcher;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static com.dtstack.flink.sql.sink.rdb.JDBCTypeConvertUtils.setRecordToStatement;
  43 import static org.apache.flink.util.Preconditions.checkNotNull;
  44 
  45 /**
  46  * Date: 2020/10/14
  47  * Company: www.dtstack.com
  48  *
  49  * @author tiezhu
  50  */
  51 public class ImpalaOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&lt;Boolean, Row&gt;&gt; {
  52 
  53     private static final Logger LOG = LoggerFactory.getLogger(ImpalaOutputFormat.class);
  54 
  55     private static final long serialVersionUID = 1L;
  56 
  57     // ${field}
  58     private static final Pattern STATIC_PARTITION_PATTERN = Pattern.compile(&quot;\\$\\{([^}]*)}&quot;);
<abbr title="  59     // cast(value as string) -&gt; cast(&#x27;value&#x27; as string)  cast(value as timestamp) -&gt; cast(&#x27;value&#x27; as timestamp)">  59     // cast(value as string) -&gt; cast(&#x27;value&#x27; as string)  cast(value as timestamp) -&gt; cast(&#x27;value&#x27; as time🔵</abbr>
  60     private static final Pattern TYPE_PATTERN = Pattern.compile(&quot;cast\\((.*) as (.*)\\)&quot;);
  61     //specific type which values need to be quoted
  62     private static final String[] NEED_QUOTE_TYPE = {&quot;string&quot;, &quot;timestamp&quot;, &quot;varchar&quot;};
  63 
  64     private static final Integer DEFAULT_CONN_TIME_OUT = 60;
  65     private static final int RECEIVE_DATA_PRINT_FREQUENCY = 1000;
  66     private static final int DIRTY_DATA_PRINT_FREQUENCY = 1000;
  67 
  68     private static final String KUDU_TYPE = &quot;kudu&quot;;
  69     private static final String UPDATE_MODE = &quot;update&quot;;
  70     private static final String PARTITION_CONSTANT = &quot;PARTITION&quot;;
  71     private static final String DRIVER_NAME = &quot;com.cloudera.impala.jdbc41.Driver&quot;;
  72 
  73     private static final String VALUES_CONDITION = &quot;${valuesCondition}&quot;;
  74     private static final String PARTITION_CONDITION = &quot;${partitionCondition}&quot;;
  75     private static final String TABLE_FIELDS_CONDITION = &quot;${tableFieldsCondition}&quot;;
  76     private static final String NO_PARTITION = &quot;noPartition&quot;;
  77 
  78     protected transient Connection connection;
  79     protected transient Statement statement;
  80     protected transient PreparedStatement updateStatement;
  81 
  82     private transient volatile boolean closed = false;
  83     private int batchCount = 0;
  84 
  85     // |------------------------------------------------|
  86     // |   partitionCondition   |Array of valueCondition|
  87     // |------------------------------------------------|
  88     // | ptOne, ptTwo, ptThree  | [(v1, v2, v3, v4, v5)]|   DP
  89     // |------------------------------------------------|
  90     // | ptOne = v1, ptTwo = v2 | [(v3, v4, v5)]        |   SP
  91     // |------------------------------------------------|
  92     // | ptOne, ptTwo = v2      | [(v1, v3, v4, v5)]    |   DP and SP
  93     // |------------------------------------------------|
  94     // | noPartition            | [(v1, v2, v3, v4, v5)]|   kudu or disablePartition
  95     // |------------------------------------------------|
  96     private transient Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap;
  97 
  98     protected String keytabPath;
  99     protected String krb5confPath;
 100     protected String principal;
 101     protected Integer authMech;
 102     protected String dbUrl;
 103     protected String userName;
 104     protected String password;
 105     protected int batchSize = 100;
 106     protected long batchWaitInterval = 60 * 1000L;
 107     protected String tableName;
 108     protected List&lt;String&gt; primaryKeys;
 109     protected String partitionFields;
 110     protected Boolean enablePartition;
 111     protected String schema;
 112     protected String storeType;
 113     protected String updateMode;
 114     public List&lt;String&gt; fieldNames;
 115     public List&lt;String&gt; fieldTypes;
 116     public List&lt;AbstractTableInfo.FieldExtraInfo&gt; fieldExtraInfoList;
 117 
 118     // partition field of static partition which matched by ${field}
 119     private final List&lt;String&gt; staticPartitionFields = new ArrayList&lt;&gt;();
 120 
 121     // valueFieldsName -&gt; 重组之后的fieldNames，为了重组row data字段值对应
 122     // 需要对partition字段做特殊处理，比如原来的字段顺序为(age, name, id)，但是因为partition，写入的SQL为
 123     // INSERT INTO tableName(name, id) PARTITION(age) VALUES(?, ?, ?)
 124     // 那么实际executeSql设置字段的顺序应该为(name, id, age)，同时，字段对应的type顺序也需要重组
 125     private List&lt;String&gt; valueFieldNames;
 126     private transient AbstractDtRichOutputFormat&lt;?&gt; metricOutputFormat;
 127     private List&lt;Row&gt; rows;
 128 
 129     private transient ScheduledExecutorService scheduler;
 130     private transient ScheduledFuture&lt;?&gt; scheduledFuture;
 131 
 132     @Override
 133     public void configure(Configuration parameters) {
 134     }
 135 
 136     @Override
 137     public void open(int taskNumber, int numTasks) throws IOException {
 138 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139         if (authMech == 1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140             UserGroupInformation ugi = KrbUtils.loginAndReturnUgi(principal, keytabPath, krb5confPath);</span>
 141 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         if (authMech == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143             UserGroupInformation ugi = KrbUtils.getUgi(principal, keytabPath, krb5confPath);</span>
 144 =======
 145 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 146             try {
 147             rowDataMap = new HashMap&lt;&gt;();
 148             rows = new ArrayList&lt;&gt;();
 149             metricOutputFormat = this;
 150             openConnect();
 151             initScheduledTask(batchWaitInterval);
 152             init();
 153             initMetric();
 154         } catch (Exception e) {
 155             throw new RuntimeException(&quot;impala output format open error!&quot;, e);
 156         }
 157     }
 158 
 159     public static Builder getImpalaBuilder() {
 160         return new Builder();
 161     }
 162 
 163     private void init() throws SQLException {
 164         if (Objects.nonNull(partitionFields)) {
 165             // match ${field} from partitionFields
 166             Matcher matcher = STATIC_PARTITION_PATTERN.matcher(partitionFields);
 167             while (matcher.find()) {
 168                 LOG.info(&quot;find static partition field: {}&quot;, matcher.group(1));
 169                 staticPartitionFields.add(matcher.group(1));
 170             }
 171         }
 172 
 173         if (updateMode.equalsIgnoreCase(UPDATE_MODE)) {
 174             if (!storeType.equalsIgnoreCase(KUDU_TYPE)) {
 175                 throw new IllegalArgumentException(&quot;update mode not support for non-kudu table!&quot;);
 176             }
 177 
<abbr title=" 178             updateStatement = connection.prepareStatement(buildUpdateSql(schema, tableName, fieldNames, primaryKeys));"> 178             updateStatement = connection.prepareStatement(buildUpdateSql(schema, tableName, fieldNames, p🔵</abbr>
 179             return;
 180         }
 181 
<abbr title=" 182         valueFieldNames = rebuildFieldNameListAndTypeList(fieldNames, staticPartitionFields, fieldTypes, partitionFields);"> 182         valueFieldNames = rebuildFieldNameListAndTypeList(fieldNames, staticPartitionFields, fieldTypes, 🔵</abbr>
 183     }
 184 
 185     private void initScheduledTask(Long batchWaitInterval) {
 186         try {
 187             if (batchWaitInterval != 0) {
 188                 this.scheduler = new ScheduledThreadPoolExecutor(1,
 189                         new DTThreadFactory(&quot;impala-upsert-output-format&quot;));
 190                 this.scheduledFuture = this.scheduler.scheduleWithFixedDelay(() -&gt; {
 191                     synchronized (ImpalaOutputFormat.this) {
 192                         try {
 193                             flush();
 194                         } catch (Exception e) {
 195                             LOG.error(&quot;Writing records to impala jdbc failed.&quot;, e);
 196                             throw new RuntimeException(&quot;Writing records to impala jdbc failed.&quot;, e);
 197                         }
 198                     }
 199                 }, batchWaitInterval, batchWaitInterval, TimeUnit.MILLISECONDS);
 200             }
 201         } catch (Exception e) {
 202             throw new RuntimeException(e);
 203         }
 204     }
 205 
 206     private void openConnect() throws IOException {
 207         if (authMech == 1) {
 208             UserGroupInformation ugi = KrbUtils.loginAndReturnUgi(principal, keytabPath, krb5confPath);
 209             try {
 210                 ugi.doAs((PrivilegedExceptionAction&lt;Void&gt;) () -&gt; {
 211                     openJdbc();
 212                     return null;
 213                 });
 214             } catch (InterruptedException | IOException e) {
 215                 throw new IllegalArgumentException(&quot;connect impala error!&quot;, e);
 216             }
 217         } else {
 218             openJdbc();
 219         }
 220     }
 221 
 222     /**
 223      * get jdbc connection
 224      */
 225     private void openJdbc() {
 226         JDBCUtils.forName(DRIVER_NAME, getClass().getClassLoader());
 227         try {
 228             connection = DriverManager.getConnection(dbUrl, userName, password);
 229             statement = connection.createStatement();
 230             connection.setAutoCommit(false);
 231         } catch (SQLException sqlException) {
 232             throw new RuntimeException(&quot;get impala jdbc connection failed!&quot;, sqlException);
 233         }
 234     }
 235 
 236     private void flush() throws Exception {
 237         if (batchCount &gt; 0) {
 238             if (updateMode.equalsIgnoreCase(UPDATE_MODE)) {
 239                 executeUpdateBatch();
 240             }
 241             if (!rowDataMap.isEmpty()) {
 242                 String templateSql =
<abbr title=" 243                         &quot;INSERT INTO tableName ${tableFieldsCondition} PARTITION ${partitionCondition} VALUES ${valuesCondition}&quot;;"> 243                         &quot;INSERT INTO tableName ${tableFieldsCondition} PARTITION ${partitionCondition} VA🔵</abbr>
 244                 executeBatchSql(
 245                         statement,
 246                         templateSql,
 247                         schema,
 248                         tableName,
 249                         storeType,
 250                         enablePartition,
 251                         valueFieldNames,
 252                         partitionFields,
 253                         rowDataMap
 254                 );
 255                 rowDataMap.clear();
 256             }
 257         }
 258         batchCount = 0;
 259 
 260     }
 261 
 262     /**
 263      * execute batch update statement
 264      *
 265      * @throws SQLException throw sql exception
 266      */
 267     private void executeUpdateBatch() throws SQLException {
 268         try {
 269             rows.forEach(row -&gt; {
 270                 try {
 271                     JDBCTypeConvertUtils.setRecordToStatement(
 272                             updateStatement,
 273                             JDBCTypeConvertUtils.getSqlTypeFromFieldType(fieldTypes),
 274                             row,
 275                             primaryKeys.stream().mapToInt(fieldNames::indexOf).toArray()
 276                     );
 277                     updateStatement.addBatch();
 278                 } catch (Exception e) {
 279                     throw new RuntimeException(&quot;impala jdbc execute batch error!&quot;, e);
 280                 }
 281             });
 282             updateStatement.executeBatch();
 283             connection.commit();
 284             rows.clear();
 285         } catch (Exception e) {
 286             LOG.debug(&quot;impala jdbc execute batch error &quot;, e);
 287             connection.rollback();
 288             connection.commit();
 289             updateStatement.clearBatch();
 290             executeUpdate(connection);
 291         }
 292     }
 293 
 294     public void executeUpdate(Connection connection) {
 295         rows.forEach(row -&gt; {
 296             try {
<abbr title=" 297                 setRecordToStatement(updateStatement, JDBCTypeConvertUtils.getSqlTypeFromFieldType(fieldTypes), row);"> 297                 setRecordToStatement(updateStatement, JDBCTypeConvertUtils.getSqlTypeFromFieldType(fieldT🔵</abbr>
 298                 updateStatement.executeUpdate();
 299                 connection.commit();
 300             } catch (Exception e) {
 301                 try {
 302                     connection.rollback();
 303                     connection.commit();
 304                 } catch (SQLException e1) {
 305                     throw new RuntimeException(e1);
 306                 }
<abbr title=" 307                 if (metricOutputFormat.outDirtyRecords.getCount() % DIRTY_DATA_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {"> 307                 if (metricOutputFormat.outDirtyRecords.getCount() % DIRTY_DATA_PRINT_FREQUENCY == 0 || LO🔵</abbr>
 308                     LOG.error(&quot;record insert failed ,this row is {}&quot;, row.toString());
 309                     LOG.error(&quot;&quot;, e);
 310                 }
 311                 metricOutputFormat.outDirtyRecords.inc();
 312             }
 313         });
 314         rows.clear();
 315     }
 316 
<abbr title=" 317     private void putRowIntoMap(Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap, Tuple2&lt;String, String&gt; rowData) {"> 317     private void putRowIntoMap(Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap, Tuple2&lt;String, String&gt; rowData)🔵</abbr>
 318         Set&lt;String&gt; keySet = rowDataMap.keySet();
 319         ArrayList&lt;String&gt; tempRowArray;
 320         if (keySet.contains(rowData.f0)) {
 321             tempRowArray = rowDataMap.get(rowData.f0);
 322         } else {
 323             tempRowArray = new ArrayList&lt;&gt;();
 324         }
 325         tempRowArray.add(rowData.f1);
 326         rowDataMap.put(rowData.f0, tempRowArray);
 327     }
 328 
<abbr title=" 329     private List&lt;String&gt; rebuildFieldNameListAndTypeList(List&lt;String&gt; fieldNames, List&lt;String&gt; staticPartitionFields, List&lt;String&gt; fieldTypes, String partitionFields) {"> 329     private List&lt;String&gt; rebuildFieldNameListAndTypeList(List&lt;String&gt; fieldNames, List&lt;String&gt; staticPart🔵</abbr>
 330         if (partitionFields.isEmpty()) {
 331             return fieldNames;
 332         }
 333 
 334         List&lt;String&gt; valueFields = new ArrayList&lt;&gt;(fieldNames);
 335 
 336         for (int i = valueFields.size() - 1; i &gt;= 0; i--) {
 337             if (staticPartitionFields.contains(fieldNames.get(i))) {
 338                 valueFields.remove(i);
 339                 fieldTypes.remove(i);
 340             }
 341         }
 342 
 343         for (int i = 0; i &lt; valueFields.size(); i++) {
 344             if (partitionFields.contains(fieldNames.get(i))) {
 345                 valueFields.add(valueFields.remove(i));
 346                 fieldTypes.add(fieldTypes.remove(i));
 347             }
 348         }
 349 
 350         return valueFields;
 351     }
 352 
 353     /**
 354      * Quote a specific type of value, like string, timestamp
 355      * before: 1, cast(tiezhu as string), cast(2001-01-09 01:05:01 as timestamp), cast(123 as int)
 356      * after: 1, cast(&#x27;tiezhu&#x27; as string), cast(&#x27;2001-01-09 01:05:01&#x27; as timestamp), cast(123 as int)
 357      * if cast value is null, then cast(null as type)
 358      *
 359      * @param valueCondition original value condition
 360      * @return quoted condition
 361      */
 362     private String valueConditionAddQuotation(String valueCondition) {
 363         String[] temps = valueCondition.split(&quot;,&quot;);
 364         List&lt;String&gt; replacedItem = new ArrayList&lt;&gt;();
 365         Arrays.stream(temps).forEach(
 366                 item -&gt; {
 367                     Matcher matcher = TYPE_PATTERN.matcher(item);
 368                     while (matcher.find()) {
 369                         String value = matcher.group(1);
 370                         String type = matcher.group(2);
 371 
 372                         for (String needQuoteType : NEED_QUOTE_TYPE) {
 373                             if (type.contains(needQuoteType)) {
 374                                 if (!&quot;null&quot;.equals(value)) {
 375                                     item = item.replace(value, &quot;&#x27;&quot; + value + &quot;&#x27;&quot;);
 376                                 }
 377                             }
 378                         }
 379                     }
 380                     replacedItem.add(item);
 381                 }
 382         );
 383 
 384         return &quot;(&quot; + String.join(&quot;, &quot;, replacedItem) + &quot;)&quot;;
 385     }
 386 
 387     @Override
 388     public void writeRecord(Tuple2&lt;Boolean, Row&gt; record) throws IOException {
 389         try {
 390             if (!record.f0) {
 391                 return;
 392             }
 393 
 394             if (outRecords.getCount() % RECEIVE_DATA_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {
 395                 LOG.info(&quot;Receive data : {}&quot;, record);
 396             }
 397 
 398             if (updateMode.equalsIgnoreCase(UPDATE_MODE)) {
 399                 rows.add(Row.copy(record.f1));
 400             } else {
 401                 Map&lt;String, Object&gt; valueMap = Maps.newHashMap();
 402                 Row row = Row.copy(record.f1);
 403 
 404                 for (int i = 0; i &lt; row.getArity(); i++) {
 405                     valueMap.put(fieldNames.get(i), row.getField(i));
 406                 }
 407 
 408                 Tuple2&lt;String, String&gt; rowTuple2 = new Tuple2&lt;&gt;();
 409                 if (storeType.equalsIgnoreCase(KUDU_TYPE) || !enablePartition) {
 410                     rowTuple2.f0 = NO_PARTITION;
 411                 } else {
<abbr title=" 412                     rowTuple2.f0 = buildPartitionCondition(valueMap, partitionFields, staticPartitionFields);"> 412                     rowTuple2.f0 = buildPartitionCondition(valueMap, partitionFields, staticPartitionFiel🔵</abbr>
 413                 }
 414 
 415                 // 根据字段名对 row data 重组, 比如，原始 row data : (1, xxx, 20) -&gt; (id, name, age)
 416                 // 但是由于 partition，写入的field 顺序变成了 (name, id, age)，则需要对 row data 重组变成 (xxx, 1, 20)
 417                 Row rowValue = new Row(fieldTypes.size());
 418                 for (int i = 0; i &lt; fieldTypes.size(); i++) {
 419                     rowValue.setField(i, valueMap.get(valueFieldNames.get(i)));
 420                 }
 421                 rowTuple2.f1 = valueConditionAddQuotation(buildValuesCondition(fieldTypes, rowValue));
 422                 putRowIntoMap(rowDataMap, rowTuple2);
 423             }
 424 
 425             batchCount++;
 426 
 427             if (batchCount &gt;= batchSize) {
 428                 flush();
 429             }
 430 
 431             // Receive data
 432             outRecords.inc();
 433         } catch (Exception e) {
 434             throw new IOException(&quot;Writing records to impala failed.&quot;, e);
 435         }
 436     }
 437 
 438     @Override
 439     public void close() throws IOException {
 440         if (closed) {
 441             return;
 442         }
 443         // 将还未执行的SQL flush
 444         if (batchCount &gt; 0) {
 445             try {
 446                 flush();
 447             } catch (Exception e) {
 448                 throw new RuntimeException(&quot;Writing records to impala failed.&quot;, e);
 449             }
 450         }
 451         // cancel scheduled task
 452         if (this.scheduledFuture != null) {
 453             scheduledFuture.cancel(false);
 454             this.scheduler.shutdown();
 455         }
 456         // close connection
 457         try {
 458             if (connection != null &amp;&amp; connection.isValid(DEFAULT_CONN_TIME_OUT)) {
 459                 connection.close();
 460             }
 461 
 462             if (statement != null &amp;&amp; !statement.isClosed()) {
 463                 statement.close();
 464             }
 465 
 466             if (updateStatement != null &amp;&amp; !updateStatement.isClosed()) {
 467                 updateStatement.close();
 468             }
 469         } catch (SQLException e) {
 470             throw new RuntimeException(&quot;impala connection close failed!&quot;, e);
 471         } finally {
 472             connection = null;
 473             statement = null;
 474             updateStatement = null;
 475         }
 476         closed = true;
 477     }
 478 
 479     /**
 480      * execute batch sql from row data map
<abbr title=" 481      * sql like &#x27;insert into tableName(f1, f2, f3) ${partitionCondition} values(v1, v2, v3), (v4, v5, v6)...."> 481      * sql like &#x27;insert into tableName(f1, f2, f3) ${partitionCondition} values(v1, v2, v3), (v4, v5, v6)🔵</abbr>
 482      *
 483      * @param statement       execute statement
 484      * @param tempSql         template sql
 485      * @param storeType       the store type of data
 486      * @param enablePartition enable partition or not
 487      * @param fieldNames      field name list
 488      * @param partitionFields partition fields
 489      * @param rowDataMap      row data map
 490      */
 491     private void executeBatchSql(Statement statement,
 492                                  String tempSql,
 493                                  String schema,
 494                                  String tableName,
 495                                  String storeType,
 496                                  Boolean enablePartition,
 497                                  List&lt;String&gt; fieldNames,
 498                                  String partitionFields,
 499                                  Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap) {
 500         StringBuilder valuesCondition = new StringBuilder();
 501         StringBuilder partitionCondition = new StringBuilder();
 502         String tableFieldsCondition = buildTableFieldsCondition(fieldNames, partitionFields);
 503         ArrayList&lt;String&gt; rowData;
 504         String tableNameInfo = Objects.isNull(schema) ?
 505                 tableName : quoteIdentifier(schema) + &quot;.&quot; + tableName;
 506         tempSql = tempSql.replace(&quot;tableName&quot;, tableNameInfo);
 507 
 508         // kudu ${partitionCondition} is null
 509         if (storeType.equalsIgnoreCase(KUDU_TYPE) || !enablePartition) {
 510             try {
 511                 rowData = rowDataMap.get(NO_PARTITION);
 512                 rowData.forEach(row -&gt; valuesCondition.append(row).append(&quot;, &quot;));
 513                 String executeSql = tempSql.replace(VALUES_CONDITION, valuesCondition.toString())
 514                         .replace(PARTITION_CONDITION, partitionCondition.toString())
 515                         .replace(PARTITION_CONSTANT, &quot;&quot;)
 516                         .replace(TABLE_FIELDS_CONDITION, tableFieldsCondition);
 517                 String substring = executeSql.substring(0, executeSql.length() - 2);
 518                 statement.execute(substring);
 519             } catch (Exception e) {
 520                 throw new RuntimeException(&quot;execute impala SQL error!&quot;, e);
 521             }
 522             return;
 523         }
 524 
 525         // partition sql
 526         Set&lt;String&gt; keySet = rowDataMap.keySet();
 527         String finalTempSql = tempSql;
 528         for (String key : keySet) {
 529             try {
 530                 String executeSql = String.copyValueOf(finalTempSql.toCharArray());
 531                 ArrayList&lt;String&gt; valuesConditionList = rowDataMap.get(key);
 532                 partitionCondition.append(key);
 533                 executeSql = executeSql.replace(PARTITION_CONDITION, partitionCondition.toString())
 534                         .replace(TABLE_FIELDS_CONDITION, tableFieldsCondition)
 535                         .replace(VALUES_CONDITION, String.join(&quot;, &quot;, valuesConditionList));
 536                 statement.execute(executeSql);
 537                 partitionCondition.delete(0, partitionCondition.length());
 538             } catch (SQLException sqlException) {
 539                 throw new RuntimeException(&quot;execute impala SQL error! &quot;, sqlException);
 540             }
 541         }
 542     }
 543 
 544     /**
 545      * build partition condition with row data
 546      *
 547      * @param rowData              row data
 548      * @param partitionFields      partition fields
 549      * @param staticPartitionField static partition fields
 550      * @return condition like &#x27;(ptOne, ptTwo=v2)&#x27;
 551      */
<abbr title=" 552     private String buildPartitionCondition(Map&lt;String, Object&gt; rowData, String partitionFields, List&lt;String&gt; staticPartitionField) {"> 552     private String buildPartitionCondition(Map&lt;String, Object&gt; rowData, String partitionFields, List&lt;Stri🔵</abbr>
 553         for (String key : staticPartitionField) {
 554             StringBuilder sb = new StringBuilder();
 555             Object value = rowData.get(key);
 556             sb.append(key).append(&quot;=&quot;).append(value);
 557             partitionFields = partitionFields.replace(&quot;${&quot; + key + &quot;}&quot;, sb.toString());
 558         }
 559         return &quot;(&quot; + partitionFields + &quot;)&quot;;
 560     }
 561 
 562     /**
 563      * build field condition according to field names
 564      * replace ${tableFieldCondition}
 565      *
 566      * @param fieldNames      the selected field names
 567      * @param partitionFields the partition fields
 568      * @return condition like &#x27;(id, name, age)&#x27;
 569      */
 570     private String buildTableFieldsCondition(List&lt;String&gt; fieldNames, String partitionFields) {
 571         return &quot;(&quot; + fieldNames.stream()
 572                 .filter(f -&gt; !partitionFields.contains(f))
 573                 .map(this::quoteIdentifier)
 574                 .collect(Collectors.joining(&quot;, &quot;)) + &quot;)&quot;;
 575     }
 576 
 577     /**
 578      * according to field types, build the values condition
 579      * replace ${valuesCondition}
 580      *
 581      * @param fieldTypes field types
 582      * @return condition like &#x27;(?, ?, cast(? as string))&#x27; and &#x27;?&#x27; will be replaced with row data
 583      */
 584     private String buildValuesCondition(List&lt;String&gt; fieldTypes, Row row) {
 585         String valuesCondition = fieldTypes.stream().map(
 586                 f -&gt; {
 587                     for (String item : NEED_QUOTE_TYPE) {
 588                         if (f.toLowerCase().contains(item)) {
 589                             return String.format(&quot;cast(? as %s)&quot;, f.toLowerCase());
 590                         }
 591                     }
 592                     return &quot;?&quot;;
 593                 }).collect(Collectors.joining(&quot;, &quot;));
 594         for (int i = 0; i &lt; row.getArity(); i++) {
<abbr title=" 595             valuesCondition = valuesCondition.replaceFirst(&quot;\\?&quot;, Objects.isNull(row.getField(i)) ? &quot;null&quot; : row.getField(i).toString());"> 595             valuesCondition = valuesCondition.replaceFirst(&quot;\\?&quot;, Objects.isNull(row.getField(i)) ? &quot;null🔵</abbr>
 596         }
 597         return valuesCondition;
 598     }
 599 
 600     /**
 601      * impala update mode SQL
 602      *
 603      * @return UPDATE tableName SET setCondition WHERE whereCondition
 604      */
<abbr title=" 605     private String buildUpdateSql(String schema, String tableName, List&lt;String&gt; fieldNames, List&lt;String&gt; primaryKeys) {"> 605     private String buildUpdateSql(String schema, String tableName, List&lt;String&gt; fieldNames, List&lt;String&gt; 🔵</abbr>
 606         //跳过primary key字段
 607         String setClause = fieldNames.stream()
 608                 .filter(f -&gt; !CollectionUtils.isNotEmpty(primaryKeys) || !primaryKeys.contains(f))
 609                 .map(f -&gt; quoteIdentifier(f) + &quot;=?&quot;)
 610                 .collect(Collectors.joining(&quot;, &quot;));
 611 
 612         String conditionClause = primaryKeys.stream()
 613                 .map(f -&gt; quoteIdentifier(f) + &quot;=?&quot;)
 614                 .collect(Collectors.joining(&quot; AND &quot;));
 615 
 616         return &quot;UPDATE &quot; + (Objects.isNull(schema) ? &quot;&quot; : quoteIdentifier(schema) + &quot;.&quot;)
 617                 + quoteIdentifier(tableName) + &quot; SET &quot; + setClause + &quot; WHERE &quot; + conditionClause;
 618     }
 619 
 620     private String quoteIdentifier(String identifier) {
 621         return &quot;`&quot; + identifier + &quot;`&quot;;
 622     }
 623 
 624     public static class Builder {
 625         private final ImpalaOutputFormat format = new ImpalaOutputFormat();
 626 
 627         public Builder setDbUrl(String dbUrl) {
 628             format.dbUrl = dbUrl;
 629             return this;
 630         }
 631 
 632         public Builder setUserName(String userName) {
 633             format.userName = userName;
 634             return this;
 635         }
 636 
 637         public Builder setPassword(String password) {
 638             format.password = password;
 639             return this;
 640         }
 641 
 642         public Builder setBatchSize(Integer batchSize) {
 643             format.batchSize = batchSize;
 644             return this;
 645         }
 646 
 647         public Builder setBatchWaitInterval(Long batchWaitInterval) {
 648             format.batchWaitInterval = batchWaitInterval;
 649             return this;
 650         }
 651 
 652         public Builder setTableName(String tableName) {
 653             format.tableName = tableName;
 654             return this;
 655         }
 656 
 657         public Builder setPartitionFields(String partitionFields) {
 658             format.partitionFields = Objects.isNull(partitionFields) ?
 659                     &quot;&quot; : partitionFields;
 660             return this;
 661         }
 662 
 663         public Builder setPrimaryKeys(List&lt;String&gt; primaryKeys) {
 664             format.primaryKeys = primaryKeys;
 665             return this;
 666         }
 667 
 668         public Builder setSchema(String schema) {
 669             format.schema = schema;
 670             return this;
 671         }
 672 
 673         public Builder setEnablePartition(Boolean enablePartition) {
 674             format.enablePartition = enablePartition;
 675             return this;
 676         }
 677 
 678         public Builder setUpdateMode(String updateMode) {
 679             format.updateMode = updateMode;
 680             return this;
 681         }
 682 
 683         public Builder setFieldList(List&lt;String&gt; fieldList) {
 684             format.fieldNames = fieldList;
 685             return this;
 686         }
 687 
 688         public Builder setFieldTypeList(List&lt;String&gt; fieldTypeList) {
 689             format.fieldTypes = fieldTypeList;
 690             return this;
 691         }
 692 
 693         public Builder setStoreType(String storeType) {
 694             format.storeType = storeType;
 695             return this;
 696         }
 697 
 698         public Builder setFieldExtraInfoList(List&lt;AbstractTableInfo.FieldExtraInfo&gt; fieldExtraInfoList) {
 699             format.fieldExtraInfoList = fieldExtraInfoList;
 700             return this;
 701         }
 702 
 703         public Builder setPrincipal(String principal) {
 704             format.principal = principal;
 705             return this;
 706         }
 707 
 708         public Builder setAuthMech(Integer authMech) {
 709             format.authMech = authMech;
 710             return this;
 711         }
 712 
 713         public Builder setKeyTabPath(String keyTabPath) {
 714             format.keytabPath = keyTabPath;
 715             return this;
 716         }
 717 
 718         public Builder setKrb5ConfPath(String krb5ConfPath) {
 719             format.krb5confPath = krb5ConfPath;
 720             return this;
 721         }
 722 
 723         private boolean canHandle(String url) {
 724             return url.startsWith(&quot;jdbc:impala:&quot;);
 725         }
 726 
 727         public ImpalaOutputFormat build() {
 728             if (!canHandle(format.dbUrl)) {
<abbr title=" 729                 throw new IllegalArgumentException(&quot;impala dbUrl is illegal, check url: &quot; + format.dbUrl);"> 729                 throw new IllegalArgumentException(&quot;impala dbUrl is illegal, check url: &quot; + format.dbUrl)🔵</abbr>
 730             }
 731 
 732             if (format.authMech == EAuthMech.Kerberos.getType()) {
 733                 checkNotNull(format.krb5confPath,
 734                         &quot;When kerberos authentication is enabled, krb5confPath is required！&quot;);
 735                 checkNotNull(format.principal,
 736                         &quot;When kerberos authentication is enabled, principal is required！&quot;);
 737                 checkNotNull(format.keytabPath,
 738                         &quot;When kerberos authentication is enabled, keytabPath is required！&quot;);
 739             }
 740 
 741             if (format.authMech == EAuthMech.UserName.getType()) {
 742                 checkNotNull(format.userName, &quot;userName is required!&quot;);
 743             }
 744 
 745             if (format.authMech == EAuthMech.NameANDPassword.getType()) {
 746                 checkNotNull(format.userName, &quot;userName is required!&quot;);
 747                 checkNotNull(format.password, &quot;password is required!&quot;);
 748             }
 749 
 750             checkNotNull(format.storeType, &quot;storeType is required!&quot;);
 751 
 752             return format;
 753         }
 754     }
 755 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.sink.impala;
  19 
  20 import com.dtstack.flink.sql.factory.DTThreadFactory;
  21 import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;
  22 import com.dtstack.flink.sql.sink.rdb.JDBCTypeConvertUtils;
  23 import com.dtstack.flink.sql.table.AbstractTableInfo;
  24 import com.dtstack.flink.sql.util.JDBCUtils;
  25 import com.dtstack.flink.sql.util.KrbUtils;
  26 import com.google.common.collect.Maps;
  27 import java.io.IOException;
  28 import java.rmi.RemoteException;
  29 import java.security.PrivilegedExceptionAction;
  30 import java.sql.Connection;
  31 import java.sql.DriverManager;
  32 import java.sql.PreparedStatement;
  33 import java.sql.SQLException;
  34 import java.sql.Statement;
  35 import java.util.ArrayList;
  36 import java.util.Arrays;
  37 import java.util.HashMap;
  38 import java.util.List;
  39 import java.util.Map;
  40 import java.util.Objects;
  41 import java.util.Set;
  42 import java.util.concurrent.ScheduledExecutorService;
  43 import java.util.concurrent.ScheduledFuture;
  44 import java.util.concurrent.ScheduledThreadPoolExecutor;
  45 import java.util.concurrent.TimeUnit;
  46 import java.util.concurrent.atomic.AtomicReference;
  47 import java.util.regex.Matcher;
  48 import java.util.regex.Pattern;
  49 import java.util.stream.Collectors;
  50 import org.apache.commons.collections.CollectionUtils;
  51 import org.apache.flink.api.java.tuple.Tuple2;
  52 import org.apache.flink.configuration.Configuration;
  53 import org.apache.flink.types.Row;
  54 import org.apache.hadoop.security.UserGroupInformation;
  55 import org.slf4j.Logger;
  56 import org.slf4j.LoggerFactory;
  57 import static com.dtstack.flink.sql.sink.rdb.JDBCTypeConvertUtils.setRecordToStatement;
  58 import static org.apache.flink.util.Preconditions.checkNotNull;
  59 
  60 
  61 /**
  62  * Date: 2020/10/14
  63  * Company: www.dtstack.com
  64  *
  65  * @unknown flinkStreamSQL
  66  */
  67 public class ImpalaOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&lt;Boolean, Row&gt;&gt; {
  68     private static final Logger LOG = LoggerFactory.getLogger(ImpalaOutputFormat.class);
  69 
  70     private static final long serialVersionUID = 1L;
  71 
  72     // ${field}
  73     // ${field}
  74     private static final Pattern STATIC_PARTITION_PATTERN = Pattern.compile(&quot;\\$\\{([^}]*)}&quot;);
  75 
<abbr title="  76     // cast(value as string) -&gt; cast(&#x27;value&#x27; as string)  cast(value as timestamp) -&gt; cast(&#x27;value&#x27; as timestamp)">  76     // cast(value as string) -&gt; cast(&#x27;value&#x27; as string)  cast(value as timestamp) -&gt; cast(&#x27;value&#x27; as time🔵</abbr>
<abbr title="  77     // cast(value as string) -&gt; cast(&#x27;value&#x27; as string)  cast(value as timestamp) -&gt; cast(&#x27;value&#x27; as timestamp)">  77     // cast(value as string) -&gt; cast(&#x27;value&#x27; as string)  cast(value as timestamp) -&gt; cast(&#x27;value&#x27; as time🔵</abbr>
  78     private static final Pattern TYPE_PATTERN = Pattern.compile(&quot;cast\\((.*) as (.*)\\)&quot;);
  79 
  80     // specific type which values need to be quoted
<abbr title="  81     private static final String[] NEED_QUOTE_TYPE = new java.lang.String[]{ &quot;string&quot;, &quot;timestamp&quot;, &quot;varchar&quot; };">  81     private static final String[] NEED_QUOTE_TYPE = new java.lang.String[]{ &quot;string&quot;, &quot;timestamp&quot;, &quot;varch🔵</abbr>
  82 
  83     private static final Integer DEFAULT_CONN_TIME_OUT = 60;
  84 
  85     private static final int RECEIVE_DATA_PRINT_FREQUENCY = 1000;
  86 
  87     private static final int DIRTY_DATA_PRINT_FREQUENCY = 1000;
  88 
  89     private static final String KUDU_TYPE = &quot;kudu&quot;;
  90 
  91     private static final String UPDATE_MODE = &quot;update&quot;;
  92 
  93     private static final String PARTITION_CONSTANT = &quot;PARTITION&quot;;
  94 
  95     private static final String DRIVER_NAME = &quot;com.cloudera.impala.jdbc41.Driver&quot;;
  96 
  97     private static final String VALUES_CONDITION = &quot;${valuesCondition}&quot;;
  98 
  99     private static final String PARTITION_CONDITION = &quot;${partitionCondition}&quot;;
 100 
 101     private static final String TABLE_FIELDS_CONDITION = &quot;${tableFieldsCondition}&quot;;
 102 
 103     private static final String NO_PARTITION = &quot;noPartition&quot;;
 104 
 105     protected transient Connection connection;
 106 
 107     protected transient Statement statement;
 108 
 109     protected transient PreparedStatement updateStatement;
 110 
 111     private transient volatile boolean closed = false;
 112 
 113     private int batchCount = 0;
 114 
 115     // |------------------------------------------------|
 116     // |   partitionCondition   |Array of valueCondition|
 117     // |------------------------------------------------|
 118     // | ptOne, ptTwo, ptThree  | [(v1, v2, v3, v4, v5)]|   DP
 119     // |------------------------------------------------|
 120     // | ptOne = v1, ptTwo = v2 | [(v3, v4, v5)]        |   SP
 121     // |------------------------------------------------|
 122     // | ptOne, ptTwo = v2      | [(v1, v3, v4, v5)]    |   DP and SP
 123     // |------------------------------------------------|
 124     // | noPartition            | [(v1, v2, v3, v4, v5)]|   kudu or disablePartition
 125     // |------------------------------------------------|
 126     private transient Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap;
 127 
 128     protected String keytabPath;
 129 
 130     protected String krb5confPath;
 131 
 132     protected String principal;
 133 
 134     protected Integer authMech;
 135 
 136     protected String dbUrl;
 137 
 138     protected String userName;
 139 
 140     protected String password;
 141 
 142     protected int batchSize = 100;
 143 
 144     protected long batchWaitInterval = 60 * 1000L;
 145 
 146     protected String tableName;
 147 
 148     protected List&lt;String&gt; primaryKeys;
 149 
 150     protected String partitionFields;
 151 
 152     protected Boolean enablePartition;
 153 
 154     protected String schema;
 155 
 156     protected String storeType;
 157 
 158         protected String updateMode;
 159 
 160     public List&lt;String&gt; fieldNames;
 161 
 162     public List&lt;String&gt; fieldTypes;
 163 
 164     public List&lt;AbstractTableInfo.FieldExtraInfo&gt; fieldExtraInfoList;
 165 
 166     // partition field of static partition which matched by ${field}
 167     // partition field of static partition which matched by ${field}
 168     private final List&lt;String&gt; staticPartitionFields = new ArrayList&lt;&gt;();
 169 
 170     // valueFieldsName -&gt; 重组之后的fieldNames，为了重组row data字段值对应
 171     // 需要对partition字段做特殊处理，比如原来的字段顺序为(age, name, id)，但是因为partition，写入的SQL为
 172     // INSERT INTO tableName(name, id) PARTITION(age) VALUES(?, ?, ?)
 173     // 那么实际executeSql设置字段的顺序应该为(name, id, age)，同时，字段对应的type顺序也需要重组
 174     private List&lt;String&gt; valueFieldNames;
 175 
 176     private transient AbstractDtRichOutputFormat&lt;?&gt; metricOutputFormat;
 177 
 178     private List&lt;Row&gt; rows;
 179 
 180     private transient ScheduledExecutorService scheduler;
 181 
 182     private transient ScheduledFuture&lt;?&gt; scheduledFuture;
 183 
 184     @Override
 185     public void configure(Configuration parameters) {
 186     }
 187 
 188     @Override
 189     public void open(int taskNumber, int numTasks) throws IOException {
 190         try {
 191             rowDataMap = new HashMap&lt;&gt;();
 192             rows = new ArrayList&lt;&gt;();
 193             metricOutputFormat = this;
 194             openConnect();
 195             initScheduledTask(batchWaitInterval);
 196             init();
 197             initMetric();
 198         } catch (java.lang.Exception e) {
 199             throw new RuntimeException(&quot;impala output format open error!&quot;, e);
 200         }
 201     }
 202 
 203     private void init() throws SQLException {
 204         if (Objects.nonNull(partitionFields)) {
 205             // match ${field} from partitionFields
 206             Matcher matcher = STATIC_PARTITION_PATTERN.matcher(partitionFields);
 207             while (matcher.find()) {
 208                 LOG.info(&quot;find static partition field: {}&quot;, matcher.group(1));
 209                 staticPartitionFields.add(matcher.group(1));
 210             }
 211         }
 212 
 213         if (updateMode.equalsIgnoreCase(UPDATE_MODE)) {
 214             if (!storeType.equalsIgnoreCase(KUDU_TYPE)) {
 215                 throw new IllegalArgumentException(&quot;update mode not support for non-kudu table!&quot;);
 216             }
 217 
<abbr title=" 218             updateStatement = connection.prepareStatement(buildUpdateSql(schema, tableName, fieldNames, primaryKeys));"> 218             updateStatement = connection.prepareStatement(buildUpdateSql(schema, tableName, fieldNames, p🔵</abbr>
 219             return;
 220         }
 221 
<abbr title=" 222         valueFieldNames = rebuildFieldNameListAndTypeList(fieldNames, staticPartitionFields, fieldTypes, partitionFields);"> 222         valueFieldNames = rebuildFieldNameListAndTypeList(fieldNames, staticPartitionFields, fieldTypes, 🔵</abbr>
 223     }
 224 
 225     private void initScheduledTask(Long batchWaitInterval) {
 226         try {
 227             if (batchWaitInterval != 0) {
<abbr title=" 228                 this.scheduler = new ScheduledThreadPoolExecutor(1, new DTThreadFactory(&quot;impala-upsert-output-format&quot;));"> 228                 this.scheduler = new ScheduledThreadPoolExecutor(1, new DTThreadFactory(&quot;impala-upsert-ou🔵</abbr>
 229                 this.scheduledFuture = this.scheduler.scheduleWithFixedDelay(() -&gt; {
 230                     synchronized(this) {
 231                         try {
 232                             flush();
 233                         } catch (java.lang.Exception e) {
 234                             LOG.error(&quot;Writing records to impala jdbc failed.&quot;, e);
 235                             throw new RuntimeException(&quot;Writing records to impala jdbc failed.&quot;, e);
 236                         }
 237                     }
 238                 }, batchWaitInterval, batchWaitInterval, TimeUnit.MILLISECONDS);
 239             }
 240         } catch (java.lang.Exception e) {
 241             throw new RuntimeException(e);
 242         }
 243     }
 244 
 245     private void openConnect() throws IOException {
 246         if (authMech == 1) {
 247             UserGroupInformation ugi = KrbUtils.loginAndReturnUgi(principal, keytabPath, krb5confPath);
 248             try {
 249                 ugi.doAs(((PrivilegedExceptionAction&lt;Void&gt;) (() -&gt; {
 250                     openJdbc();
 251                     return null;
 252                 })));
 253             } catch (java.lang.InterruptedException | IOException e) {
 254                 throw new IllegalArgumentException(&quot;connect impala error!&quot;, e);
 255             }
 256         } else {
 257             openJdbc();
 258         }
 259     }
 260 
 261     /**
 262      * get jdbc connection
 263      */
 264     private void openJdbc() {
 265         JDBCUtils.forName(DRIVER_NAME, getClass().getClassLoader());
 266         try {
 267             connection = DriverManager.getConnection(dbUrl, userName, password);
 268             statement = connection.createStatement();
 269             connection.setAutoCommit(false);
 270         } catch (SQLException sqlException) {
 271             throw new RuntimeException(&quot;get impala jdbc connection failed!&quot;, sqlException);
 272         }
 273     }
 274 
 275     private void flush() throws Exception {
 276         if (batchCount &gt; 0) {
 277             if (updateMode.equalsIgnoreCase(UPDATE_MODE)) {
 278                 executeUpdateBatch();
 279             }
 280             if (!rowDataMap.isEmpty()) {
 281                 String templateSql =
<abbr title=" 282                         &quot;INSERT INTO tableName ${tableFieldsCondition} PARTITION ${partitionCondition} VALUES ${valuesCondition}&quot;;"> 282                         &quot;INSERT INTO tableName ${tableFieldsCondition} PARTITION ${partitionCondition} VA🔵</abbr>
 283                 executeBatchSql(
 284                         statement,
 285                         templateSql,
 286                         schema,
 287                         tableName,
 288                         storeType,
 289                         enablePartition,
 290                         valueFieldNames,
 291                         partitionFields,
 292                         rowDataMap
 293                 );
 294                 rowDataMap.clear();
 295             }
 296         }
 297         batchCount = 0;
 298 
 299     }
 300 
 301     /**
 302      * execute batch update statement
 303      *
 304      * @throws SQLException throw sql exception
 305      */
 306     private void executeUpdateBatch() throws SQLException {
 307         try {
 308             rows.forEach(row -&gt; {
 309                 try {
 310                     JDBCTypeConvertUtils.setRecordToStatement(
 311                             updateStatement,
 312                             JDBCTypeConvertUtils.getSqlTypeFromFieldType(fieldTypes),
 313                             row,
 314                             primaryKeys.stream().mapToInt(fieldNames::indexOf).toArray()
 315                     );
 316                     updateStatement.addBatch();
 317                 } catch (Exception e) {
 318                     throw new RuntimeException(&quot;impala jdbc execute batch error!&quot;, e);
 319                 }
 320             });
 321             updateStatement.executeBatch();
 322             connection.commit();
 323             rows.clear();
 324         } catch (Exception e) {
 325             LOG.debug(&quot;impala jdbc execute batch error &quot;, e);
 326             connection.rollback();
 327             connection.commit();
 328             updateStatement.clearBatch();
 329             executeUpdate(connection);
 330         }
 331     }
 332 
 333     public void executeUpdate(Connection connection) {
 334         rows.forEach(row -&gt; {
 335             try {
<abbr title=" 336                 setRecordToStatement(updateStatement, JDBCTypeConvertUtils.getSqlTypeFromFieldType(fieldTypes), row);"> 336                 setRecordToStatement(updateStatement, JDBCTypeConvertUtils.getSqlTypeFromFieldType(fieldT🔵</abbr>
 337                 updateStatement.executeUpdate();
 338                 connection.commit();
 339             } catch (Exception e) {
 340                 try {
 341                     connection.rollback();
 342                     connection.commit();
 343                 } catch (SQLException e1) {
 344                     throw new RuntimeException(e1);
 345                 }
<abbr title=" 346                 if (metricOutputFormat.outDirtyRecords.getCount() % DIRTY_DATA_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {"> 346                 if (metricOutputFormat.outDirtyRecords.getCount() % DIRTY_DATA_PRINT_FREQUENCY == 0 || LO🔵</abbr>
 347                     LOG.error(&quot;record insert failed ,this row is {}&quot;, row.toString());
 348                     LOG.error(&quot;&quot;, e);
 349                 }
 350                 metricOutputFormat.outDirtyRecords.inc();
 351             }
 352         });
 353         rows.clear();
 354     }
 355 
<abbr title=" 356     private void putRowIntoMap(Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap, Tuple2&lt;String, String&gt; rowData) {"> 356     private void putRowIntoMap(Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap, Tuple2&lt;String, String&gt; rowData)🔵</abbr>
 357         Set&lt;String&gt; keySet = rowDataMap.keySet();
 358         ArrayList&lt;String&gt; tempRowArray;
 359         if (keySet.contains(rowData.f0)) {
 360             tempRowArray = rowDataMap.get(rowData.f0);
 361         } else {
 362             tempRowArray = new ArrayList&lt;&gt;();
 363         }
 364         tempRowArray.add(rowData.f1);
 365         rowDataMap.put(rowData.f0, tempRowArray);
 366     }
 367 
<abbr title=" 368     private List&lt;String&gt; rebuildFieldNameListAndTypeList(List&lt;String&gt; fieldNames, List&lt;String&gt; staticPartitionFields, List&lt;String&gt; fieldTypes, String partitionFields) {"> 368     private List&lt;String&gt; rebuildFieldNameListAndTypeList(List&lt;String&gt; fieldNames, List&lt;String&gt; staticPart🔵</abbr>
 369         if (partitionFields.isEmpty()) {
 370             return fieldNames;
 371         }
 372         List&lt;String&gt; valueFields = new ArrayList&lt;&gt;(fieldNames);
 373         for (int i = valueFields.size() - 1; i &gt;= 0; i--) {
 374             if (staticPartitionFields.contains(fieldNames.get(i))) {
 375                 valueFields.remove(i);
 376                 fieldTypes.remove(i);
 377             }
 378         }
 379         for (int i = 0; i &lt; valueFields.size(); i++) {
 380             if (partitionFields.contains(fieldNames.get(i))) {
 381                 valueFields.add(valueFields.remove(i));
 382                 fieldTypes.add(fieldTypes.remove(i));
 383             }
 384         }
 385         return valueFields;
 386     }
 387 
 388     /**
 389      * Quote a specific type of value, like string, timestamp
 390      * before: 1, cast(tiezhu as string), cast(2001-01-09 01:05:01 as timestamp), cast(123 as int)
 391      * after: 1, cast(&#x27;tiezhu&#x27; as string), cast(&#x27;2001-01-09 01:05:01&#x27; as timestamp), cast(123 as int)
 392      * if cast value is null, then cast(null as type)
 393      *
 394      * @param valueCondition original value condition
 395      * @return quoted condition
 396      */
 397     private String valueConditionAddQuotation(String valueCondition) {
 398         String[] temps = valueCondition.split(&quot;,&quot;);
 399         List&lt;String&gt; replacedItem = new ArrayList&lt;&gt;();
 400         Arrays.stream(temps).forEach(( item) -&gt; {
 401             Matcher matcher = TYPE_PATTERN.matcher(item);
 402             while (matcher.find()) {
 403                 String value = matcher.group(1);
 404                 String type = matcher.group(2);
 405                 for (String needQuoteType : NEED_QUOTE_TYPE) {
 406                     if (type.contains(needQuoteType)) {
 407                         if (!&quot;null&quot;.equals(value)) {
 408                             item = item.replace(value, (&quot;&#x27;&quot; + value) + &quot;&#x27;&quot;);
 409                         }
 410                     }
 411                 }
 412             }
 413             replacedItem.add(item);
 414         });
 415         return (&quot;(&quot; + String.join(&quot;, &quot;, replacedItem)) + &quot;)&quot;;
 416     }
 417 
 418     @Override
 419     public void writeRecord(Tuple2&lt;Boolean, Row&gt; record) throws IOException {
 420         try {
 421             if (!record.f0) {
 422                 return;
 423             }
 424             if (((outRecords.getCount() % RECEIVE_DATA_PRINT_FREQUENCY) == 0) || LOG.isDebugEnabled()) {
 425                 LOG.info(&quot;Receive data : {}&quot;, record);
 426             }
 427             if (updateMode.equalsIgnoreCase(UPDATE_MODE)) {
 428                 rows.add(Row.copy(record.f1));
 429             } else {
 430                 Map&lt;String, Object&gt; valueMap = Maps.newHashMap();
 431                 Row row = Row.copy(record.f1);
 432                 for (int i = 0; i &lt; row.getArity(); i++) {
 433                     valueMap.put(fieldNames.get(i), row.getField(i));
 434                 }
 435                 Tuple2&lt;String, String&gt; rowTuple2 = new Tuple2&lt;&gt;();
 436                 if (storeType.equalsIgnoreCase(KUDU_TYPE) || (!enablePartition)) {
 437                     rowTuple2.f0 = NO_PARTITION;
 438                 } else {
<abbr title=" 439                     rowTuple2.f0 = buildPartitionCondition(valueMap, partitionFields, staticPartitionFields);"> 439                     rowTuple2.f0 = buildPartitionCondition(valueMap, partitionFields, staticPartitionFiel🔵</abbr>
 440                 }
 441                 // 根据字段名对 row data 重组, 比如，原始 row data : (1, xxx, 20) -&gt; (id, name, age)
 442                 // 但是由于 partition，写入的field 顺序变成了 (name, id, age)，则需要对 row data 重组变成 (xxx, 1, 20)
 443                 Row rowValue = new Row(fieldTypes.size());
 444                 for (int i = 0; i &lt; fieldTypes.size(); i++) {
 445                     rowValue.setField(i, valueMap.get(valueFieldNames.get(i)));
 446                 }
 447                 rowTuple2.f1 = valueConditionAddQuotation(buildValuesCondition(fieldTypes, rowValue));
 448                 putRowIntoMap(rowDataMap, rowTuple2);
 449             }
 450             batchCount++;
 451             if (batchCount &gt;= batchSize) {
 452                 flush();
 453             }
 454             // Receive data
 455             outRecords.inc();
 456         } catch (java.lang.Exception e) {
 457             throw new IOException(&quot;Writing records to impala failed.&quot;, e);
 458         }
 459     }
 460 
 461     @Override
 462     public void close() throws IOException {
 463         if (closed) {
 464             return;
 465         }
 466         // 将还未执行的SQL flush
 467         if (batchCount &gt; 0) {
 468             try {
 469                 flush();
 470             } catch (java.lang.Exception e) {
 471                 throw new RuntimeException(&quot;Writing records to impala failed.&quot;, e);
 472             }
 473         }
 474         // cancel scheduled task
 475         if (this.scheduledFuture != null) {
 476             scheduledFuture.cancel(false);
 477             this.scheduler.shutdown();
 478         }
 479         // close connection
 480         try {
 481             if ((connection != null) &amp;&amp; connection.isValid(DEFAULT_CONN_TIME_OUT)) {
 482                 connection.close();
 483             }
 484             if ((statement != null) &amp;&amp; (!statement.isClosed())) {
 485                 statement.close();
 486             }
 487             if ((updateStatement != null) &amp;&amp; (!updateStatement.isClosed())) {
 488                 updateStatement.close();
 489             }
 490         } catch (SQLException e) {
 491             throw new RuntimeException(&quot;impala connection close failed!&quot;, e);
 492         } finally {
 493             connection = null;
 494             statement = null;
 495             updateStatement = null;
 496         }
 497         closed = true;
 498     }
 499 
 500     /**
 501      * execute batch sql from row data map
<abbr title=" 502      * sql like &#x27;insert into tableName(f1, f2, f3) ${partitionCondition} values(v1, v2, v3), (v4, v5, v6)...."> 502      * sql like &#x27;insert into tableName(f1, f2, f3) ${partitionCondition} values(v1, v2, v3), (v4, v5, v6)🔵</abbr>
 503      *
 504      * @param statement       execute statement
 505      * @param tempSql         template sql
 506      * @param storeType       the store type of data
 507      * @param enablePartition enable partition or not
 508      * @param fieldNames      field name list
 509      * @param partitionFields partition fields
 510      * @param rowDataMap      row data map
 511      */
<abbr title=" 512     private void executeBatchSql(Statement statement, String tempSql, String schema, String tableName, String storeType, Boolean enablePartition, List&lt;String&gt; fieldNames, String partitionFields, Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap) {"> 512     private void executeBatchSql(Statement statement, String tempSql, String schema, String tableName, St🔵</abbr>
 513         StringBuilder valuesCondition = new StringBuilder();
 514         StringBuilder partitionCondition = new StringBuilder();
 515         String tableFieldsCondition = buildTableFieldsCondition(fieldNames, partitionFields);
 516         ArrayList&lt;String&gt; rowData;
<abbr title=" 517         String tableNameInfo = (Objects.isNull(schema)) ? tableName : (quoteIdentifier(schema) + &quot;.&quot;) + tableName;"> 517         String tableNameInfo = (Objects.isNull(schema)) ? tableName : (quoteIdentifier(schema) + &quot;.&quot;) + t🔵</abbr>
 518         tempSql = tempSql.replace(&quot;tableName&quot;, tableNameInfo);
 519         // kudu ${partitionCondition} is null
 520         if (storeType.equalsIgnoreCase(KUDU_TYPE) || (!enablePartition)) {
 521             try {
 522                 rowData = rowDataMap.get(NO_PARTITION);
 523                 rowData.forEach(( row) -&gt; valuesCondition.append(row).append(&quot;, &quot;));
<abbr title=" 524                 String executeSql = tempSql.replace(VALUES_CONDITION, valuesCondition.toString()).replace(PARTITION_CONDITION, partitionCondition.toString()).replace(PARTITION_CONSTANT, &quot;&quot;).replace(TABLE_FIELDS_CONDITION, tableFieldsCondition);"> 524                 String executeSql = tempSql.replace(VALUES_CONDITION, valuesCondition.toString()).replace🔵</abbr>
 525                 String substring = executeSql.substring(0, executeSql.length() - 2);
 526                 statement.execute(substring);
 527             } catch (java.lang.Exception e) {
 528                 throw new RuntimeException(&quot;execute impala SQL error!&quot;, e);
 529             }
 530             return;
 531         }
 532         // partition sql
 533         Set&lt;String&gt; keySet = rowDataMap.keySet();
 534         String finalTempSql = tempSql;
 535         for (String key : keySet) {
 536             try {
 537                 String executeSql = String.copyValueOf(finalTempSql.toCharArray());
 538                 ArrayList&lt;String&gt; valuesConditionList = rowDataMap.get(key);
 539                 partitionCondition.append(key);
<abbr title=" 540                 executeSql = executeSql.replace(PARTITION_CONDITION, partitionCondition.toString()).replace(TABLE_FIELDS_CONDITION, tableFieldsCondition).replace(VALUES_CONDITION, String.join(&quot;, &quot;, valuesConditionList));"> 540                 executeSql = executeSql.replace(PARTITION_CONDITION, partitionCondition.toString()).repla🔵</abbr>
 541                 statement.execute(executeSql);
 542                 partitionCondition.delete(0, partitionCondition.length());
 543             } catch (SQLException sqlException) {
 544                 throw new RuntimeException(&quot;execute impala SQL error! &quot;, sqlException);
 545             }
 546         }
 547     }
 548 
 549     /**
 550      * build partition condition with row data
 551      *
 552      * @param rowData              row data
 553      * @param partitionFields      partition fields
 554      * @param staticPartitionField static partition fields
 555      * @return condition like &#x27;(ptOne, ptTwo=v2)&#x27;
 556      */
<abbr title=" 557     private String buildPartitionCondition(Map&lt;String, Object&gt; rowData, String partitionFields, List&lt;String&gt; staticPartitionField) {"> 557     private String buildPartitionCondition(Map&lt;String, Object&gt; rowData, String partitionFields, List&lt;Stri🔵</abbr>
 558         for (String key : staticPartitionField) {
 559             StringBuilder sb = new StringBuilder();
 560             Object value = rowData.get(key);
 561             sb.append(key).append(&quot;=&quot;).append(value);
 562             partitionFields = partitionFields.replace(&quot;${&quot; + key + &quot;}&quot;, sb.toString());
 563         }
 564         return &quot;(&quot; + partitionFields + &quot;)&quot;;
 565     }
 566 
 567     /**
 568      * build field condition according to field names
 569      * replace ${tableFieldCondition}
 570      *
 571      * @param fieldNames      the selected field names
 572      * @param partitionFields the partition fields
 573      * @return condition like &#x27;(id, name, age)&#x27;
 574      */
 575     private String buildTableFieldsCondition(List&lt;String&gt; fieldNames, String partitionFields) {
 576         return &quot;(&quot; + fieldNames.stream()
 577                 .filter(f -&gt; !partitionFields.contains(f))
 578                 .map(this::quoteIdentifier)
 579                 .collect(Collectors.joining(&quot;, &quot;)) + &quot;)&quot;;
 580     }
 581 
 582     /**
 583      * according to field types, build the values condition
 584      * replace ${valuesCondition}
 585      *
 586      * @param fieldTypes field types
 587      * @return condition like &#x27;(?, ?, cast(? as string))&#x27; and &#x27;?&#x27; will be replaced with row data
 588      */
 589     private String buildValuesCondition(List&lt;String&gt; fieldTypes, Row row) {
 590         String valuesCondition = fieldTypes.stream().map(
 591                 f -&gt; {
 592                     for (String item : NEED_QUOTE_TYPE) {
 593                         if (f.toLowerCase().contains(item)) {
 594                             return String.format(&quot;cast(? as %s)&quot;, f.toLowerCase());
 595                         }
 596                     }
 597                     return &quot;?&quot;;
 598                 }).collect(Collectors.joining(&quot;, &quot;));
 599         for (int i = 0; i &lt; row.getArity(); i++) {
<abbr title=" 600             valuesCondition = valuesCondition.replaceFirst(&quot;\\?&quot;, Objects.isNull(row.getField(i)) ? &quot;null&quot; : row.getField(i).toString());"> 600             valuesCondition = valuesCondition.replaceFirst(&quot;\\?&quot;, Objects.isNull(row.getField(i)) ? &quot;null🔵</abbr>
 601         }
 602         return valuesCondition;
 603     }
 604 
 605     /**
 606      * impala update mode SQL
 607      *
 608      * @return UPDATE tableName SET setCondition WHERE whereCondition
 609      */
<abbr title=" 610     private String buildUpdateSql(String schema, String tableName, List&lt;String&gt; fieldNames, List&lt;String&gt; primaryKeys) {"> 610     private String buildUpdateSql(String schema, String tableName, List&lt;String&gt; fieldNames, List&lt;String&gt; 🔵</abbr>
 611         //跳过primary key字段
 612         String setClause = fieldNames.stream()
 613                 .filter(f -&gt; !CollectionUtils.isNotEmpty(primaryKeys) || !primaryKeys.contains(f))
 614                 .map(f -&gt; quoteIdentifier(f) + &quot;=?&quot;)
 615                 .collect(Collectors.joining(&quot;, &quot;));
 616 
 617         String conditionClause = primaryKeys.stream()
 618                 .map(f -&gt; quoteIdentifier(f) + &quot;=?&quot;)
 619                 .collect(Collectors.joining(&quot; AND &quot;));
 620 
 621         return &quot;UPDATE &quot; + (Objects.isNull(schema) ? &quot;&quot; : quoteIdentifier(schema) + &quot;.&quot;)
 622                 + quoteIdentifier(tableName) + &quot; SET &quot; + setClause + &quot; WHERE &quot; + conditionClause;
 623     }
 624 
 625     private String quoteIdentifier(String identifier) {
 626         return &quot;`&quot; + identifier + &quot;`&quot;;
 627     }
 628 
 629     public static Builder getImpalaBuilder() {
 630         return new Builder();
 631     }
 632 
 633     public static class Builder {
 634         private final ImpalaOutputFormat format = new ImpalaOutputFormat();
 635 
 636         public Builder setDbUrl(String dbUrl) {
 637             format.dbUrl = dbUrl;
 638             return this;
 639         }
 640 
 641         public Builder setUserName(String userName) {
 642             format.userName = userName;
 643             return this;
 644         }
 645 
 646         public Builder setPassword(String password) {
 647             format.password = password;
 648             return this;
 649         }
 650 
 651         public Builder setBatchSize(Integer batchSize) {
 652             format.batchSize = batchSize;
 653             return this;
 654         }
 655 
 656         public Builder setBatchWaitInterval(Long batchWaitInterval) {
 657             format.batchWaitInterval = batchWaitInterval;
 658             return this;
 659         }
 660 
 661         public Builder setTableName(String tableName) {
 662             format.tableName = tableName;
 663             return this;
 664         }
 665 
 666         public Builder setPartitionFields(String partitionFields) {
 667             format.partitionFields = (Objects.isNull(partitionFields)) ? &quot;&quot; : partitionFields;
 668             return this;
 669         }
 670 
 671         public Builder setPrimaryKeys(List&lt;String&gt; primaryKeys) {
 672             format.primaryKeys = primaryKeys;
 673             return this;
 674         }
 675 
 676         public Builder setSchema(String schema) {
 677             format.schema = schema;
 678             return this;
 679         }
 680 
 681         public Builder setEnablePartition(Boolean enablePartition) {
 682             format.enablePartition = enablePartition;
 683             return this;
 684         }
 685 
 686         public Builder setUpdateMode(String updateMode) {
 687             format.updateMode = updateMode;
 688             return this;
 689         }
 690 
 691         public Builder setFieldList(List&lt;String&gt; fieldList) {
 692             format.fieldNames = fieldList;
 693             return this;
 694         }
 695 
 696         public Builder setFieldTypeList(List&lt;String&gt; fieldTypeList) {
 697             format.fieldTypes = fieldTypeList;
 698             return this;
 699         }
 700 
 701         public Builder setStoreType(String storeType) {
 702             format.storeType = storeType;
 703             return this;
 704         }
 705 
 706         public Builder setFieldExtraInfoList(List&lt;AbstractTableInfo.FieldExtraInfo&gt; fieldExtraInfoList) {
 707             format.fieldExtraInfoList = fieldExtraInfoList;
 708             return this;
 709         }
 710 
 711         public Builder setKeyTabPath(String keyTabPath) {
 712             format.keytabPath = keyTabPath;
 713             return this;
 714         }
 715 
 716         public Builder setKrb5ConfPath(String krb5ConfPath) {
 717             format.krb5confPath = krb5ConfPath;
 718             return this;
 719         }
 720 
 721         public Builder setPrincipal(String principal) {
 722             format.principal = principal;
 723             return this;
 724         }
 725 
 726         public Builder setAuthMech(Integer authMech) {
 727             format.authMech = authMech;
 728             return this;
 729         }
 730 
 731         private boolean canHandle(String url) {
 732             return url.startsWith(&quot;jdbc:impala:&quot;);
 733         }
 734 
 735         public ImpalaOutputFormat build() {
 736             if (!canHandle(format.dbUrl)) {
<abbr title=" 737                 throw new IllegalArgumentException(&quot;impala dbUrl is illegal, check url: &quot; + format.dbUrl);"> 737                 throw new IllegalArgumentException(&quot;impala dbUrl is illegal, check url: &quot; + format.dbUrl)🔵</abbr>
 738             }
 739             if (format.authMech == EAuthMech.Kerberos.getType()) {
<abbr title=" 740                 checkNotNull(format.krb5confPath, &quot;When kerberos authentication is enabled, krb5confPath is required！&quot;);"> 740                 checkNotNull(format.krb5confPath, &quot;When kerberos authentication is enabled, krb5confPath 🔵</abbr>
<abbr title=" 741                 checkNotNull(format.principal, &quot;When kerberos authentication is enabled, principal is required！&quot;);"> 741                 checkNotNull(format.principal, &quot;When kerberos authentication is enabled, principal is req🔵</abbr>
<abbr title=" 742                 checkNotNull(format.keytabPath, &quot;When kerberos authentication is enabled, keytabPath is required！&quot;);"> 742                 checkNotNull(format.keytabPath, &quot;When kerberos authentication is enabled, keytabPath is r🔵</abbr>
 743             }
 744             if (format.authMech == EAuthMech.UserName.getType()) {
 745                 checkNotNull(format.userName, &quot;userName is required!&quot;);
 746             }
 747             if (format.authMech == EAuthMech.NameANDPassword.getType()) {
 748                 checkNotNull(format.userName, &quot;userName is required!&quot;);
 749                 checkNotNull(format.password, &quot;password is required!&quot;);
 750             }
 751             checkNotNull(format.storeType, &quot;storeType is required!&quot;);
 752             return format;
 753         }
 754     }
 755 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>

















   1  package com.dtstack.flink.sql.sink.impala;
   2  
   3  import com.dtstack.flink.sql.sink.rdb.JDBCOptions;
   4  import com.dtstack.flink.sql.sink.rdb.format.JDBCUpsertOutputFormat;





   5  import com.dtstack.flink.sql.util.KrbUtils;





   6  import org.apache.hadoop.security.UserGroupInformation;


   7  
   8  import java.io.IOException;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 -import java.security.PrivilegedAction;</span>

  10  import java.security.PrivilegedExceptionAction;








  11  import java.util.List;
  12  













  13  import static org.apache.flink.util.Preconditions.checkNotNull;
  14  
  15  /**
  16   * @program: flinkStreamSQL
  17   * @author: wuren
  18   * @create: 2020/09/11
  19   **/
  20  public class ImpalaOutputFormat extends JDBCUpsertOutputFormat {
  21      private String keytabPath;
  22      private String krb5confPath;
  23      private String principal;
  24      private Integer authMech;
  25  
  26      public ImpalaOutputFormat(
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -        JDBCOptions options,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -        String[] fieldNames,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -        String[] keyFields,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -        String[] partitionFields,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -        int[] fieldTypes,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -        int flushMaxSize,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -        long flushIntervalMills,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -        boolean allReplace,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -        String updateMode,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -        Integer authMech,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -        String keytabPath,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -        String krb5confPath,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -        String principal) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +            JDBCOptions options,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +            String[] fieldNames,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +            String[] keyFields,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +            String[] partitionFields,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +            int[] fieldTypes,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +            int flushMaxSize,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +            long flushIntervalMills,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +            boolean allReplace,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +            String updateMode,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +            Integer authMech,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +            String keytabPath,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +            String krb5confPath,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +            String principal) {</span>
  53          super(options,
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -            fieldNames,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -            keyFields,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -            partitionFields,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -            fieldTypes,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -            flushMaxSize,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -            flushIntervalMills,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -            allReplace,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -            updateMode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +                fieldNames,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +                keyFields,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +                partitionFields,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +                fieldTypes,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +                flushMaxSize,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +                flushIntervalMills,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +                allReplace,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +                updateMode);</span>
  70          this.authMech = authMech;
  71          this.keytabPath = keytabPath;
  72          this.krb5confPath = krb5confPath;
  73          this.principal = principal;
























































































  74      }
  75  
  76      @Override
  77      public void open(int taskNumber, int numTasks) throws IOException {

























































  78          if (authMech == 1) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -            UserGroupInformation ugi = KrbUtils.getUgi(principal, keytabPath, krb5confPath);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +            UserGroupInformation ugi = KrbUtils.loginAndReturnUgi(principal, keytabPath, krb5confPath);</span>
  81              try {
  82                  ugi.doAs(new PrivilegedExceptionAction&lt;Void&gt;() {
  83                      @Override
  84                      public Void run() throws IOException {
  85                          openJdbc();
  86                          return null;









































































































































































  87                      }
  88                  });
  89              } catch (InterruptedException e) {
  90                  e.printStackTrace();
  91              }
  92          } else {
  93              super.open(taskNumber, numTasks);
  94          }
  95      }
  96  
  97      public static Builder impalaBuilder() {





















































































































































































































































  98          return new Builder();
  99      }
 100  
 101      public static class Builder {
 102          private Integer authMech;
 103          private String keytabPath;
 104          private String krb5confPath;
 105          private String principal;
 106  
 107          protected JDBCOptions options;
 108          protected String[] fieldNames;
 109          protected String[] keyFields;
 110          protected String[] partitionFields;
 111          protected int[] fieldTypes;
 112          protected int flushMaxSize = DEFAULT_FLUSH_MAX_SIZE;
 113          protected long flushIntervalMills = DEFAULT_FLUSH_INTERVAL_MILLS;
 114          protected boolean allReplace = DEFAULT_ALLREPLACE_VALUE;
 115          protected String updateMode;
 116  
 117          /**
 118           * required, jdbc options.
 119           */
 120          public Builder setOptions(JDBCOptions options) {
 121              this.options = options;
 122              return this;
 123          }
 124  
 125          /**
 126           * required, field names of this jdbc sink.
 127           */
 128          public Builder setFieldNames(String[] fieldNames) {
 129              this.fieldNames = fieldNames;
 130              return this;
 131          }
 132  
 133          /**
 134           * required, upsert unique keys.
 135           */
 136          public Builder setKeyFields(List&lt;String&gt; keyFields) {
 137              this.keyFields = keyFields == null ? null : keyFields.toArray(new String[keyFields.size()]);
 138              return this;
 139          }
 140  
 141          /**
 142           * required, field types of this jdbc sink.
 143           */
 144          public Builder setFieldTypes(int[] fieldTypes) {
 145              this.fieldTypes = fieldTypes;
 146              return this;
 147          }
 148  
 149          /**
 150           * optional, partition Fields
 151           *
 152           * @param partitionFields
 153           * @return
 154           */
 155          public Builder setPartitionFields(String[] partitionFields) {
 156              this.partitionFields = partitionFields;
 157              return this;
 158          }
 159  
 160          /**
 161           * optional, flush max size (includes all append, upsert and delete records),
 162           * over this number of records, will flush data.
 163           */
 164          public Builder setFlushMaxSize(int flushMaxSize) {
 165              this.flushMaxSize = flushMaxSize;
 166              return this;
 167          }
 168  
 169          /**
 170           * optional, flush interval mills, over this time, asynchronous threads will flush data.
 171           */
 172          public Builder setFlushIntervalMills(long flushIntervalMills) {
 173              this.flushIntervalMills = flushIntervalMills;
 174              return this;
 175          }
 176  
 177          public Builder setAllReplace(boolean allReplace) {
 178              this.allReplace = allReplace;


















































 179              return this;
 180          }
 181  
 182          public Builder setUpdateMode(String updateMode) {
 183              this.updateMode = updateMode;




































 184              return this;
 185          }
 186  
 187          public Builder setAuthMech(Integer authMech) {
 188              this.authMech = authMech;
 189              return this;
 190          }
 191          public Builder setKeytabPath(String keytabPath) {
 192              this.keytabPath = keytabPath;
 193              return this;
 194          }
 195          public Builder setKrb5confPath(String krb5confPath) {
 196              this.krb5confPath = krb5confPath;
 197              return this;
 198          }
 199          public Builder setPrincipal(String principal) {
 200              this.principal = principal;
 201              return this;






 202          }
 203  
 204          public ImpalaOutputFormat build() {
 205              checkNotNull(options, &quot;No options supplied.&quot;);
 206              checkNotNull(fieldNames, &quot;No fieldNames supplied.&quot;);
 207              return new ImpalaOutputFormat(
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -                options,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -                fieldNames,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -                keyFields,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -                partitionFields,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -                fieldTypes,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -                flushMaxSize,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -                flushIntervalMills,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -                allReplace,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -                updateMode,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -                authMech,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -                keytabPath,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -                krb5confPath,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -                principal);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +                    options,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +                    fieldNames,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +                    keyFields,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +                    partitionFields,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +                    fieldTypes,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +                    flushMaxSize,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +                    flushIntervalMills,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +                    allReplace,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +                    updateMode,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +                    authMech,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +                    keytabPath,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +                    krb5confPath,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +                    principal);</span>












 234          }
 235      }
 236  }</pre></td>
                            <td><pre><span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   1 +/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 + * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 + * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 + * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 + * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 + * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 + * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 + * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 + * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 + * limitations under the License.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +</span>
  19  package com.dtstack.flink.sql.sink.impala;
  20  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import com.dtstack.flink.sql.sink.rdb.JDBCOptions;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.dtstack.flink.sql.sink.rdb.format.JDBCUpsertOutputFormat;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.dtstack.flink.sql.factory.DTThreadFactory;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import com.dtstack.flink.sql.sink.rdb.JDBCTypeConvertUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import com.dtstack.flink.sql.table.AbstractTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import com.dtstack.flink.sql.util.JDBCUtils;</span>
  28  import com.dtstack.flink.sql.util.KrbUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import org.apache.commons.collections.CollectionUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.apache.flink.types.Row;</span>
  34  import org.apache.hadoop.security.UserGroupInformation;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import org.slf4j.LoggerFactory;</span>
  37  
  38  import java.io.IOException;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import java.security.PrivilegedAction;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import java.rmi.RemoteException;</span>
  41  import java.security.PrivilegedExceptionAction;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +import java.sql.Connection;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +import java.sql.DriverManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +import java.sql.PreparedStatement;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import java.sql.SQLException;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +import java.sql.Statement;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +import java.util.Arrays;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +import java.util.HashMap;</span>
  50  import java.util.List;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +import java.util.Map;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +import java.util.Objects;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +import java.util.Set;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +import java.util.concurrent.ScheduledExecutorService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +import java.util.concurrent.ScheduledFuture;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +import java.util.concurrent.ScheduledThreadPoolExecutor;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +import java.util.concurrent.TimeUnit;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +import java.util.concurrent.atomic.AtomicReference;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +import java.util.regex.Matcher;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +import java.util.regex.Pattern;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +import java.util.stream.Collectors;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +import static com.dtstack.flink.sql.sink.rdb.JDBCTypeConvertUtils.setRecordToStatement;</span>
  65  import static org.apache.flink.util.Preconditions.checkNotNull;
  66  
  67  /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 - * @program: flinkStreamSQL</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 - * @author: wuren</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 - * @create: 2020/09/11</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 - **/</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -public class ImpalaOutputFormat extends JDBCUpsertOutputFormat {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -    private String keytabPath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -    private String krb5confPath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -    private String principal;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -    private Integer authMech;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -    public ImpalaOutputFormat(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -        JDBCOptions options,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -        String[] fieldNames,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -        String[] keyFields,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -        String[] partitionFields,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -        int[] fieldTypes,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -        int flushMaxSize,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -        long flushIntervalMills,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -        boolean allReplace,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -        String updateMode,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -        Integer authMech,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -        String keytabPath,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -        String krb5confPath,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -        String principal) {</span>













<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        super(options,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -            fieldNames,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -            keyFields,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -            partitionFields,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -            fieldTypes,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -            flushMaxSize,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -            flushIntervalMills,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -            allReplace,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -            updateMode);</span>








<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -        this.authMech = authMech;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -        this.keytabPath = keytabPath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        this.krb5confPath = krb5confPath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        this.principal = principal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 + * Date: 2020/10/14</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 + * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 + * @author tiezhu</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +public class ImpalaOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&lt;Boolean, Row&gt;&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +    private static final Logger LOG = LoggerFactory.getLogger(ImpalaOutputFormat.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +    private static final long serialVersionUID = 1L;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +    // ${field}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +    private static final Pattern STATIC_PARTITION_PATTERN = Pattern.compile(&quot;\\$\\{([^}]*)}&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +    // cast(value as string) -&gt; cast(&#x27;value&#x27; as string)  cast(value as timestamp) -&gt; cast(&#x27;value&#x27; as timestamp)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +    private static final Pattern TYPE_PATTERN = Pattern.compile(&quot;cast\\((.*) as (.*)\\)&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +    //specific type which values need to be quoted</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +    private static final String[] NEED_QUOTE_TYPE = {&quot;string&quot;, &quot;timestamp&quot;, &quot;varchar&quot;};</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +    private static final Integer DEFAULT_CONN_TIME_OUT = 60;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +    private static final int RECEIVE_DATA_PRINT_FREQUENCY = 1000;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +    private static final int DIRTY_DATA_PRINT_FREQUENCY = 1000;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +    private static final String KUDU_TYPE = &quot;kudu&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +    private static final String UPDATE_MODE = &quot;update&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +    private static final String PARTITION_CONSTANT = &quot;PARTITION&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +    private static final String DRIVER_NAME = &quot;com.cloudera.impala.jdbc41.Driver&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +    private static final String VALUES_CONDITION = &quot;${valuesCondition}&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +    private static final String PARTITION_CONDITION = &quot;${partitionCondition}&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +    private static final String TABLE_FIELDS_CONDITION = &quot;${tableFieldsCondition}&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +    private static final String NO_PARTITION = &quot;noPartition&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +    protected transient Connection connection;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +    protected transient Statement statement;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +    protected transient PreparedStatement updateStatement;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +    private transient volatile boolean closed = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +    private int batchCount = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +    // |------------------------------------------------|</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +    // |   partitionCondition   |Array of valueCondition|</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +    // |------------------------------------------------|</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +    // | ptOne, ptTwo, ptThree  | [(v1, v2, v3, v4, v5)]|   DP</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +    // |------------------------------------------------|</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +    // | ptOne = v1, ptTwo = v2 | [(v3, v4, v5)]        |   SP</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +    // |------------------------------------------------|</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +    // | ptOne, ptTwo = v2      | [(v1, v3, v4, v5)]    |   DP and SP</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +    // |------------------------------------------------|</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +    // | noPartition            | [(v1, v2, v3, v4, v5)]|   kudu or disablePartition</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +    // |------------------------------------------------|</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +    private transient Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +    protected String keytabPath;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +    protected String krb5confPath;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +    protected String principal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +    protected Integer authMech;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +    protected String dbUrl;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +    protected String userName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +    protected String password;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +    protected int batchSize = 100;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +    protected long batchWaitInterval = 60 * 1000L;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +    protected String tableName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +    protected List&lt;String&gt; primaryKeys;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +    protected String partitionFields;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +    protected Boolean enablePartition;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +    protected String schema;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +    protected String storeType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +    protected String updateMode;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +    public List&lt;String&gt; fieldNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +    public List&lt;String&gt; fieldTypes;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +    public List&lt;AbstractTableInfo.FieldExtraInfo&gt; fieldExtraInfoList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +    // partition field of static partition which matched by ${field}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +    private final List&lt;String&gt; staticPartitionFields = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +    // valueFieldsName -&gt; 重组之后的fieldNames，为了重组row data字段值对应</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +    // 需要对partition字段做特殊处理，比如原来的字段顺序为(age, name, id)，但是因为partition，写入的SQL为</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +    // INSERT INTO tableName(name, id) PARTITION(age) VALUES(?, ?, ?)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +    // 那么实际executeSql设置字段的顺序应该为(name, id, age)，同时，字段对应的type顺序也需要重组</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +    private List&lt;String&gt; valueFieldNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +    private transient AbstractDtRichOutputFormat&lt;?&gt; metricOutputFormat;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +    private List&lt;Row&gt; rows;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +    private transient ScheduledExecutorService scheduler;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +    private transient ScheduledFuture&lt;?&gt; scheduledFuture;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +    public void configure(Configuration parameters) {</span>
 193      }
 194  
 195      @Override
 196      public void open(int taskNumber, int numTasks) throws IOException {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +            rowDataMap = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +            rows = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +            metricOutputFormat = this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +            openConnect();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +            initScheduledTask(batchWaitInterval);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +            init();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +            initMetric();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +        } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +            throw new RuntimeException(&quot;impala output format open error!&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +    private void init() throws SQLException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +        if (Objects.nonNull(partitionFields)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +            // match ${field} from partitionFields</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +            Matcher matcher = STATIC_PARTITION_PATTERN.matcher(partitionFields);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +            while (matcher.find()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +                LOG.info(&quot;find static partition field: {}&quot;, matcher.group(1));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +                staticPartitionFields.add(matcher.group(1));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +        if (updateMode.equalsIgnoreCase(UPDATE_MODE)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +            if (!storeType.equalsIgnoreCase(KUDU_TYPE)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +                throw new IllegalArgumentException(&quot;update mode not support for non-kudu table!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 225 +            updateStatement = connection.prepareStatement(buildUpdateSql(schema, tableName, fieldNames, primaryKeys));"> 225 +            updateStatement = connection.prepareStatement(buildUpdateSql(schema, tableName, fieldNames, primaryKey🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 229 +        valueFieldNames = rebuildFieldNameListAndTypeList(fieldNames, staticPartitionFields, fieldTypes, partitionFields);"> 229 +        valueFieldNames = rebuildFieldNameListAndTypeList(fieldNames, staticPartitionFields, fieldTypes, partition🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +    private void initScheduledTask(Long batchWaitInterval) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +            if (batchWaitInterval != 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +                this.scheduler = new ScheduledThreadPoolExecutor(1,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +                        new DTThreadFactory(&quot;impala-upsert-output-format&quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +                this.scheduledFuture = this.scheduler.scheduleWithFixedDelay(() -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +                    synchronized (ImpalaOutputFormat.this) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +                        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +                            flush();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +                        } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +                            LOG.error(&quot;Writing records to impala jdbc failed.&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +                            throw new RuntimeException(&quot;Writing records to impala jdbc failed.&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +                }, batchWaitInterval, batchWaitInterval, TimeUnit.MILLISECONDS);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +        } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +            throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +    private void openConnect() throws IOException {</span>
 254          if (authMech == 1) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -            UserGroupInformation ugi = KrbUtils.getUgi(principal, keytabPath, krb5confPath);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +            UserGroupInformation ugi = KrbUtils.loginAndReturnUgi(principal, keytabPath, krb5confPath);</span>
 257              try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -                ugi.doAs(new PrivilegedExceptionAction&lt;Void&gt;() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -                    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -                    public Void run() throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -                        openJdbc();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -                        return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +                ugi.doAs((PrivilegedExceptionAction&lt;Void&gt;) () -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +                    openJdbc();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +                    return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +                });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +            } catch (InterruptedException | IOException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +                throw new IllegalArgumentException(&quot;connect impala error!&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +            openJdbc();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +     * get jdbc connection</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +    private void openJdbc() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +        JDBCUtils.forName(DRIVER_NAME, getClass().getClassLoader());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +            connection = DriverManager.getConnection(dbUrl, userName, password);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +            statement = connection.createStatement();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +            connection.setAutoCommit(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +        } catch (SQLException sqlException) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +            throw new RuntimeException(&quot;get impala jdbc connection failed!&quot;, sqlException);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +    private void flush() throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +        if (batchCount &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +            if (updateMode.equalsIgnoreCase(UPDATE_MODE)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +                executeUpdateBatch();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +            if (!rowDataMap.isEmpty()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +                String templateSql =</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 296 +                        &quot;INSERT INTO tableName ${tableFieldsCondition} PARTITION ${partitionCondition} VALUES ${valuesCondition}&quot;;"> 296 +                        &quot;INSERT INTO tableName ${tableFieldsCondition} PARTITION ${partitionCondition} VALUES ${va🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +                executeBatchSql(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +                        statement,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +                        templateSql,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +                        schema,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +                        tableName,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +                        storeType,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +                        enablePartition,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +                        valueFieldNames,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +                        partitionFields,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +                        rowDataMap</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +                );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +                rowDataMap.clear();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +        batchCount = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 313 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 314 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 315 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +     * execute batch update statement</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +     * @throws SQLException throw sql exception</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +    private void executeUpdateBatch() throws SQLException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +            rows.forEach(row -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +                try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +                    JDBCTypeConvertUtils.setRecordToStatement(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +                            updateStatement,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +                            JDBCTypeConvertUtils.getSqlTypeFromFieldType(fieldTypes),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +                            row,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +                            primaryKeys.stream().mapToInt(fieldNames::indexOf).toArray()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +                    );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +                    updateStatement.addBatch();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +                } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +                    throw new RuntimeException(&quot;impala jdbc execute batch error!&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +            updateStatement.executeBatch();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +            connection.commit();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +            rows.clear();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +        } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +            LOG.debug(&quot;impala jdbc execute batch error &quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +            connection.rollback();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +            connection.commit();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +            updateStatement.clearBatch();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +            executeUpdate(connection);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +    public void executeUpdate(Connection connection) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +        rows.forEach(row -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 350 +                setRecordToStatement(updateStatement, JDBCTypeConvertUtils.getSqlTypeFromFieldType(fieldTypes), row);"> 350 +                setRecordToStatement(updateStatement, JDBCTypeConvertUtils.getSqlTypeFromFieldType(fieldTypes), ro🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +                updateStatement.executeUpdate();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +                connection.commit();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +            } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +                try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +                    connection.rollback();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +                    connection.commit();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +                } catch (SQLException e1) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +                    throw new RuntimeException(e1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 360 +                if (metricOutputFormat.outDirtyRecords.getCount() % DIRTY_DATA_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {"> 360 +                if (metricOutputFormat.outDirtyRecords.getCount() % DIRTY_DATA_PRINT_FREQUENCY == 0 || LOG.isDebug🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +                    LOG.error(&quot;record insert failed ,this row is {}&quot;, row.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +                    LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +                metricOutputFormat.outDirtyRecords.inc();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 367 +        rows.clear();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 368 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 369 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 370 +    private void putRowIntoMap(Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap, Tuple2&lt;String, String&gt; rowData) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 371 +        Set&lt;String&gt; keySet = rowDataMap.keySet();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 372 +        ArrayList&lt;String&gt; tempRowArray;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 373 +        if (keySet.contains(rowData.f0)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 374 +            tempRowArray = rowDataMap.get(rowData.f0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 375 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 376 +            tempRowArray = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 378 +        tempRowArray.add(rowData.f1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +        rowDataMap.put(rowData.f0, tempRowArray);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 380 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 381 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 382 +    private List&lt;String&gt; rebuildFieldNameListAndTypeList(List&lt;String&gt; fieldNames, List&lt;String&gt; staticPartitionFields, List&lt;String&gt; fieldTypes, String partitionFields) {"> 382 +    private List&lt;String&gt; rebuildFieldNameListAndTypeList(List&lt;String&gt; fieldNames, List&lt;String&gt; staticPartitionFiel🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +        if (partitionFields.isEmpty()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 384 +            return fieldNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +        List&lt;String&gt; valueFields = new ArrayList&lt;&gt;(fieldNames);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +        for (int i = valueFields.size() - 1; i &gt;= 0; i--) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +            if (staticPartitionFields.contains(fieldNames.get(i))) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +                valueFields.remove(i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +                fieldTypes.remove(i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 395 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 396 +        for (int i = 0; i &lt; valueFields.size(); i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 397 +            if (partitionFields.contains(fieldNames.get(i))) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 398 +                valueFields.add(valueFields.remove(i));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 399 +                fieldTypes.add(fieldTypes.remove(i));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 400 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 401 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 402 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 403 +        return valueFields;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 404 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 405 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 406 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 407 +     * Quote a specific type of value, like string, timestamp</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 408 +     * before: 1, cast(tiezhu as string), cast(2001-01-09 01:05:01 as timestamp), cast(123 as int)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 409 +     * after: 1, cast(&#x27;tiezhu&#x27; as string), cast(&#x27;2001-01-09 01:05:01&#x27; as timestamp), cast(123 as int)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 410 +     * if cast value is null, then cast(null as type)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 411 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 412 +     * @param valueCondition original value condition</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 413 +     * @return quoted condition</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 414 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 415 +    private String valueConditionAddQuotation(String valueCondition) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 416 +        String[] temps = valueCondition.split(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 417 +        List&lt;String&gt; replacedItem = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +        Arrays.stream(temps).forEach(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 419 +                item -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 420 +                    Matcher matcher = TYPE_PATTERN.matcher(item);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 421 +                    while (matcher.find()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 422 +                        String value = matcher.group(1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 423 +                        String type = matcher.group(2);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 424 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 425 +                        for (String needQuoteType : NEED_QUOTE_TYPE) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 426 +                            if (type.contains(needQuoteType)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 427 +                                if (!&quot;null&quot;.equals(value)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 428 +                                    item = item.replace(value, &quot;&#x27;&quot; + value + &quot;&#x27;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 429 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 430 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 431 +                        }</span>
 432                      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 433 -                });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 434 -            } catch (InterruptedException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 435 -                e.printStackTrace();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 436 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 437 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 438 -            super.open(taskNumber, numTasks);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 439 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 440 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 441 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 442 -    public static Builder impalaBuilder() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 443 +                    replacedItem.add(item);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 444 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 445 +        );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 446 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 447 +        return &quot;(&quot; + String.join(&quot;, &quot;, replacedItem) + &quot;)&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 448 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 449 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 450 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 451 +    public void writeRecord(Tuple2&lt;Boolean, Row&gt; record) throws IOException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 452 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 453 +            if (!record.f0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 454 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 455 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 456 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 457 +            if (outRecords.getCount() % RECEIVE_DATA_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 458 +                LOG.info(&quot;Receive data : {}&quot;, record);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 459 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 460 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 461 +            if (updateMode.equalsIgnoreCase(UPDATE_MODE)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 462 +                rows.add(Row.copy(record.f1));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 463 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 464 +                Map&lt;String, Object&gt; valueMap = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 465 +                Row row = Row.copy(record.f1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 466 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 467 +                for (int i = 0; i &lt; row.getArity(); i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 468 +                    valueMap.put(fieldNames.get(i), row.getField(i));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 469 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 470 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 471 +                Tuple2&lt;String, String&gt; rowTuple2 = new Tuple2&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 472 +                if (storeType.equalsIgnoreCase(KUDU_TYPE) || !enablePartition) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 473 +                    rowTuple2.f0 = NO_PARTITION;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 474 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 475 +                    rowTuple2.f0 = buildPartitionCondition(valueMap, partitionFields, staticPartitionFields);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 476 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 477 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 478 +                // 根据字段名对 row data 重组, 比如，原始 row data : (1, xxx, 20) -&gt; (id, name, age)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 479 +                // 但是由于 partition，写入的field 顺序变成了 (name, id, age)，则需要对 row data 重组变成 (xxx, 1, 20)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 480 +                Row rowValue = new Row(fieldTypes.size());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 481 +                for (int i = 0; i &lt; fieldTypes.size(); i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 482 +                    rowValue.setField(i, valueMap.get(valueFieldNames.get(i)));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 483 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 484 +                rowTuple2.f1 = valueConditionAddQuotation(buildValuesCondition(fieldTypes, rowValue));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 485 +                putRowIntoMap(rowDataMap, rowTuple2);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 486 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 487 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 488 +            batchCount++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 489 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 490 +            if (batchCount &gt;= batchSize) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 491 +                flush();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 492 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 493 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 494 +            // Receive data</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 495 +            outRecords.inc();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 496 +        } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 497 +            throw new IOException(&quot;Writing records to impala failed.&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 498 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 499 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 500 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 501 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 502 +    public void close() throws IOException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 503 +        if (closed) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 504 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 505 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 506 +        // 将还未执行的SQL flush</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 507 +        if (batchCount &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 508 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 509 +                flush();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 510 +            } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 511 +                throw new RuntimeException(&quot;Writing records to impala failed.&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 512 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 513 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 514 +        // cancel scheduled task</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 515 +        if (this.scheduledFuture != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 516 +            scheduledFuture.cancel(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 517 +            this.scheduler.shutdown();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 518 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 519 +        // close connection</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 520 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 521 +            if (connection != null &amp;&amp; connection.isValid(DEFAULT_CONN_TIME_OUT)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 522 +                connection.close();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 523 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 524 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 525 +            if (statement != null &amp;&amp; !statement.isClosed()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 526 +                statement.close();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 527 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 528 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 529 +            if (updateStatement != null &amp;&amp; !updateStatement.isClosed()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 530 +                updateStatement.close();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 531 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 532 +        } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 533 +            throw new RuntimeException(&quot;impala connection close failed!&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 534 +        } finally {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 535 +            connection = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 536 +            statement = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 537 +            updateStatement = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 538 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 539 +        closed = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 540 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 541 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 542 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 543 +     * execute batch sql from row data map</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 544 +     * sql like &#x27;insert into tableName(f1, f2, f3) ${partitionCondition} values(v1, v2, v3), (v4, v5, v6)....</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 545 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 546 +     * @param statement       execute statement</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 547 +     * @param tempSql         template sql</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 548 +     * @param storeType       the store type of data</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 549 +     * @param enablePartition enable partition or not</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 550 +     * @param fieldNames      field name list</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 551 +     * @param partitionFields partition fields</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 552 +     * @param rowDataMap      row data map</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 553 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 554 +    private void executeBatchSql(Statement statement,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 555 +                                 String tempSql,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 556 +                                 String schema,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 557 +                                 String tableName,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 558 +                                 String storeType,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 559 +                                 Boolean enablePartition,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 560 +                                 List&lt;String&gt; fieldNames,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 561 +                                 String partitionFields,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 562 +                                 Map&lt;String, ArrayList&lt;String&gt;&gt; rowDataMap) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 563 +        StringBuilder valuesCondition = new StringBuilder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 564 +        StringBuilder partitionCondition = new StringBuilder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 565 +        String tableFieldsCondition = buildTableFieldsCondition(fieldNames, partitionFields);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 566 +        ArrayList&lt;String&gt; rowData;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 567 +        String tableNameInfo = Objects.isNull(schema) ?</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 568 +                tableName : quoteIdentifier(schema) + &quot;.&quot; + tableName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 569 +        tempSql = tempSql.replace(&quot;tableName&quot;, tableNameInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 570 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 571 +        // kudu ${partitionCondition} is null</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 572 +        if (storeType.equalsIgnoreCase(KUDU_TYPE) || !enablePartition) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 573 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 574 +                rowData = rowDataMap.get(NO_PARTITION);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 575 +                rowData.forEach(row -&gt; valuesCondition.append(row).append(&quot;, &quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 576 +                String executeSql = tempSql.replace(VALUES_CONDITION, valuesCondition.toString())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 577 +                        .replace(PARTITION_CONDITION, partitionCondition.toString())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 578 +                        .replace(PARTITION_CONSTANT, &quot;&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 579 +                        .replace(TABLE_FIELDS_CONDITION, tableFieldsCondition);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 580 +                String substring = executeSql.substring(0, executeSql.length() - 2);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 581 +                statement.execute(substring);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 582 +            } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 583 +                throw new RuntimeException(&quot;execute impala SQL error!&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 584 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 585 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 586 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 587 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 588 +        // partition sql</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 589 +        Set&lt;String&gt; keySet = rowDataMap.keySet();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 590 +        String finalTempSql = tempSql;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 591 +        for (String key : keySet) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 592 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 593 +                String executeSql = String.copyValueOf(finalTempSql.toCharArray());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 594 +                ArrayList&lt;String&gt; valuesConditionList = rowDataMap.get(key);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 595 +                partitionCondition.append(key);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 596 +                executeSql = executeSql.replace(PARTITION_CONDITION, partitionCondition.toString())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 597 +                        .replace(TABLE_FIELDS_CONDITION, tableFieldsCondition)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 598 +                        .replace(VALUES_CONDITION, String.join(&quot;, &quot;, valuesConditionList));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 599 +                statement.execute(executeSql);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 600 +                partitionCondition.delete(0, partitionCondition.length());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 601 +            } catch (SQLException sqlException) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 602 +                throw new RuntimeException(&quot;execute impala SQL error! &quot;, sqlException);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 603 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 604 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 605 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 606 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 607 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 608 +     * build partition condition with row data</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 609 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 610 +     * @param rowData              row data</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 611 +     * @param partitionFields      partition fields</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 612 +     * @param staticPartitionField static partition fields</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 613 +     * @return condition like &#x27;(ptOne, ptTwo=v2)&#x27;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 614 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 615 +    private String buildPartitionCondition(Map&lt;String, Object&gt; rowData, String partitionFields, List&lt;String&gt; staticPartitionField) {"> 615 +    private String buildPartitionCondition(Map&lt;String, Object&gt; rowData, String partitionFields, List&lt;String&gt; stati🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 616 +        for (String key : staticPartitionField) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 617 +            StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 618 +            Object value = rowData.get(key);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 619 +            sb.append(key).append(&quot;=&quot;).append(value);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 620 +            partitionFields = partitionFields.replace(&quot;${&quot; + key + &quot;}&quot;, sb.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 621 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 622 +        return &quot;(&quot; + partitionFields + &quot;)&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 623 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 624 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 625 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 626 +     * build field condition according to field names</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 627 +     * replace ${tableFieldCondition}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 628 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 629 +     * @param fieldNames      the selected field names</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 630 +     * @param partitionFields the partition fields</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 631 +     * @return condition like &#x27;(id, name, age)&#x27;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 632 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 633 +    private String buildTableFieldsCondition(List&lt;String&gt; fieldNames, String partitionFields) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 634 +        return &quot;(&quot; + fieldNames.stream()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 635 +                .filter(f -&gt; !partitionFields.contains(f))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 636 +                .map(this::quoteIdentifier)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 637 +                .collect(Collectors.joining(&quot;, &quot;)) + &quot;)&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 638 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 639 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 640 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 641 +     * according to field types, build the values condition</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 642 +     * replace ${valuesCondition}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 643 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 644 +     * @param fieldTypes field types</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 645 +     * @return condition like &#x27;(?, ?, cast(? as string))&#x27; and &#x27;?&#x27; will be replaced with row data</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 646 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 647 +    private String buildValuesCondition(List&lt;String&gt; fieldTypes, Row row) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 648 +        String valuesCondition = fieldTypes.stream().map(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 649 +                f -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 650 +                    for (String item : NEED_QUOTE_TYPE) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 651 +                        if (f.toLowerCase().contains(item)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 652 +                            return String.format(&quot;cast(? as %s)&quot;, f.toLowerCase());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 653 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 654 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 655 +                    return &quot;?&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 656 +                }).collect(Collectors.joining(&quot;, &quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 657 +        for (int i = 0; i &lt; row.getArity(); i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 658 +            valuesCondition = valuesCondition.replaceFirst(&quot;\\?&quot;, Objects.isNull(row.getField(i)) ? &quot;null&quot; : row.getField(i).toString());"> 658 +            valuesCondition = valuesCondition.replaceFirst(&quot;\\?&quot;, Objects.isNull(row.getField(i)) ? &quot;null&quot; : row.g🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 659 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 660 +        return valuesCondition;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 661 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 662 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 663 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 664 +     * impala update mode SQL</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 665 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 666 +     * @return UPDATE tableName SET setCondition WHERE whereCondition</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 667 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 668 +    private String buildUpdateSql(String schema, String tableName, List&lt;String&gt; fieldNames, List&lt;String&gt; primaryKeys) {"> 668 +    private String buildUpdateSql(String schema, String tableName, List&lt;String&gt; fieldNames, List&lt;String&gt; primaryKe🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 669 +        //跳过primary key字段</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 670 +        String setClause = fieldNames.stream()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 671 +                .filter(f -&gt; !CollectionUtils.isNotEmpty(primaryKeys) || !primaryKeys.contains(f))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 672 +                .map(f -&gt; quoteIdentifier(f) + &quot;=?&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 673 +                .collect(Collectors.joining(&quot;, &quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 674 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 675 +        String conditionClause = primaryKeys.stream()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 676 +                .map(f -&gt; quoteIdentifier(f) + &quot;=?&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 677 +                .collect(Collectors.joining(&quot; AND &quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 678 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 679 +        return &quot;UPDATE &quot; + (Objects.isNull(schema) ? &quot;&quot; : quoteIdentifier(schema) + &quot;.&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 680 +                + quoteIdentifier(tableName) + &quot; SET &quot; + setClause + &quot; WHERE &quot; + conditionClause;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 681 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 682 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 683 +    private String quoteIdentifier(String identifier) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 684 +        return &quot;`&quot; + identifier + &quot;`&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 685 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 686 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 687 +    public static Builder getImpalaBuilder() {</span>
 688          return new Builder();
 689      }
 690  
 691      public static class Builder {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 692 -        private Integer authMech;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 693 -        private String keytabPath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 694 -        private String krb5confPath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 695 -        private String principal;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 696 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 697 -        protected JDBCOptions options;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 698 -        protected String[] fieldNames;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 699 -        protected String[] keyFields;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 700 -        protected String[] partitionFields;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 701 -        protected int[] fieldTypes;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 702 -        protected int flushMaxSize = DEFAULT_FLUSH_MAX_SIZE;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 703 -        protected long flushIntervalMills = DEFAULT_FLUSH_INTERVAL_MILLS;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 704 -        protected boolean allReplace = DEFAULT_ALLREPLACE_VALUE;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 705 -        protected String updateMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 706 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 707 -        /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 708 -         * required, jdbc options.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 709 -         */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 710 -        public Builder setOptions(JDBCOptions options) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 711 -            this.options = options;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 712 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 713 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 714 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 715 -        /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 716 -         * required, field names of this jdbc sink.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 717 -         */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 718 -        public Builder setFieldNames(String[] fieldNames) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 719 -            this.fieldNames = fieldNames;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 720 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 721 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 722 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 723 -        /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 724 -         * required, upsert unique keys.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 725 -         */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 726 -        public Builder setKeyFields(List&lt;String&gt; keyFields) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 727 -            this.keyFields = keyFields == null ? null : keyFields.toArray(new String[keyFields.size()]);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 728 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 729 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 730 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 731 -        /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 732 -         * required, field types of this jdbc sink.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 733 -         */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 734 -        public Builder setFieldTypes(int[] fieldTypes) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 735 -            this.fieldTypes = fieldTypes;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 736 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 737 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 738 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 739 -        /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 740 -         * optional, partition Fields</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 741 -         *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 742 -         * @param partitionFields</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 743 -         * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 744 -         */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 745 -        public Builder setPartitionFields(String[] partitionFields) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 746 -            this.partitionFields = partitionFields;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 747 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 748 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 749 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 750 -        /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 751 -         * optional, flush max size (includes all append, upsert and delete records),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 752 -         * over this number of records, will flush data.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 753 -         */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 754 -        public Builder setFlushMaxSize(int flushMaxSize) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 755 -            this.flushMaxSize = flushMaxSize;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 756 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 757 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 758 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 759 -        /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 760 -         * optional, flush interval mills, over this time, asynchronous threads will flush data.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 761 -         */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 762 -        public Builder setFlushIntervalMills(long flushIntervalMills) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 763 -            this.flushIntervalMills = flushIntervalMills;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 764 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 765 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 766 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 767 -        public Builder setAllReplace(boolean allReplace) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 768 -            this.allReplace = allReplace;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 769 +        private final ImpalaOutputFormat format = new ImpalaOutputFormat();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 770 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 771 +        public Builder setDbUrl(String dbUrl) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 772 +            format.dbUrl = dbUrl;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 773 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 774 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 775 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 776 +        public Builder setUserName(String userName) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 777 +            format.userName = userName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 778 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 779 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 780 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 781 +        public Builder setPassword(String password) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 782 +            format.password = password;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 783 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 784 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 785 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 786 +        public Builder setBatchSize(Integer batchSize) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 787 +            format.batchSize = batchSize;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 788 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 789 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 790 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 791 +        public Builder setBatchWaitInterval(Long batchWaitInterval) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 792 +            format.batchWaitInterval = batchWaitInterval;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 793 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 794 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 795 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 796 +        public Builder setTableName(String tableName) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 797 +            format.tableName = tableName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 798 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 799 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 800 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 801 +        public Builder setPartitionFields(String partitionFields) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 802 +            format.partitionFields = Objects.isNull(partitionFields) ?</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 803 +                    &quot;&quot; : partitionFields;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 804 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 805 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 806 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 807 +        public Builder setPrimaryKeys(List&lt;String&gt; primaryKeys) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 808 +            format.primaryKeys = primaryKeys;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 809 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 810 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 811 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 812 +        public Builder setSchema(String schema) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 813 +            format.schema = schema;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 814 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 815 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 816 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 817 +        public Builder setEnablePartition(Boolean enablePartition) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 818 +            format.enablePartition = enablePartition;</span>
 819              return this;
 820          }
 821  
 822          public Builder setUpdateMode(String updateMode) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 823 -            this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 824 +            format.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 825 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 826 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 827 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 828 +        public Builder setFieldList(List&lt;String&gt; fieldList) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 829 +            format.fieldNames = fieldList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 830 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 831 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 832 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 833 +        public Builder setFieldTypeList(List&lt;String&gt; fieldTypeList) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 834 +            format.fieldTypes = fieldTypeList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 835 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 836 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 837 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 838 +        public Builder setStoreType(String storeType) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 839 +            format.storeType = storeType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 840 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 841 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 842 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 843 +        public Builder setFieldExtraInfoList(List&lt;AbstractTableInfo.FieldExtraInfo&gt; fieldExtraInfoList) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 844 +            format.fieldExtraInfoList = fieldExtraInfoList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 845 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 846 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 847 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 848 +        public Builder setKeyTabPath(String keyTabPath) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 849 +            format.keytabPath = keyTabPath;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 850 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 851 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 852 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 853 +        public Builder setKrb5ConfPath(String krb5ConfPath) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 854 +            format.krb5confPath = krb5ConfPath;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 855 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 856 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 857 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 858 +        public Builder setPrincipal(String principal) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 859 +            format.principal = principal;</span>
 860              return this;
 861          }
 862  
 863          public Builder setAuthMech(Integer authMech) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 864 -            this.authMech = authMech;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 865 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 866 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 867 -        public Builder setKeytabPath(String keytabPath) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 868 -            this.keytabPath = keytabPath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 869 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 870 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 871 -        public Builder setKrb5confPath(String krb5confPath) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 872 -            this.krb5confPath = krb5confPath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 873 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 874 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 875 -        public Builder setPrincipal(String principal) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 876 -            this.principal = principal;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 877 -            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 878 +            format.authMech = authMech;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 879 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 880 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 881 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 882 +        private boolean canHandle(String url) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 883 +            return url.startsWith(&quot;jdbc:impala:&quot;);</span>
 884          }
 885  
 886          public ImpalaOutputFormat build() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 887 -            checkNotNull(options, &quot;No options supplied.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 888 -            checkNotNull(fieldNames, &quot;No fieldNames supplied.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 889 -            return new ImpalaOutputFormat(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 890 -                options,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 891 -                fieldNames,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 892 -                keyFields,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 893 -                partitionFields,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 894 -                fieldTypes,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 895 -                flushMaxSize,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 896 -                flushIntervalMills,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 897 -                allReplace,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 898 -                updateMode,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 899 -                authMech,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 900 -                keytabPath,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 901 -                krb5confPath,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 902 -                principal);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 903 +            if (!canHandle(format.dbUrl)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 904 +                throw new IllegalArgumentException(&quot;impala dbUrl is illegal, check url: &quot; + format.dbUrl);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 905 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 906 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 907 +            if (format.authMech == EAuthMech.Kerberos.getType()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 908 +                checkNotNull(format.krb5confPath,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 909 +                        &quot;When kerberos authentication is enabled, krb5confPath is required！&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 910 +                checkNotNull(format.principal,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 911 +                        &quot;When kerberos authentication is enabled, principal is required！&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 912 +                checkNotNull(format.keytabPath,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 913 +                        &quot;When kerberos authentication is enabled, keytabPath is required！&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 914 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 915 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 916 +            if (format.authMech == EAuthMech.UserName.getType()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 917 +                checkNotNull(format.userName, &quot;userName is required!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 918 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 919 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 920 +            if (format.authMech == EAuthMech.NameANDPassword.getType()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 921 +                checkNotNull(format.userName, &quot;userName is required!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 922 +                checkNotNull(format.password, &quot;password is required!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 923 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 924 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 925 +            checkNotNull(format.storeType, &quot;storeType is required!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 926 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 927 +            return format;</span>
 928          }
 929      }
 930  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            