<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>63</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    63
                    <a href="62.html">prev</a>
                    <a href="64.html">next</a>
                    <a href="63_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    AriaLyy/Aria_99d857f3383c60ae4ae008f74e7d2b32afe9c26a_Aria/src/main/java/com/arialyy/aria/core/task/SingleThreadTask.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;99d857f3383c60ae4ae008f74e7d2b32afe9c26a:Aria/src/main/java/com/arialyy/aria/core/task/SingleThreadTask.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;99d857f3383c60ae4ae008f74e7d2b32afe9c26a^1:Aria/src/main/java/com/arialyy/aria/core/task/SingleThreadTask.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;99d857f3383c60ae4ae008f74e7d2b32afe9c26a^2:Aria/src/main/java/com/arialyy/aria/core/task/SingleThreadTask.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;41154d47fb8664ddca206122d28b50a6a3b8e9a6:Aria/src/main/java/com/arialyy/aria/core/task/SingleThreadTask.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   2 /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   3  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   4  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   5  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   6  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   7  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   8  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   9  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  10  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  11  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  12  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  13  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  14  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  15  * limitations under the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  16  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  17 package com.arialyy.aria.core.task;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  18 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  19 import android.os.Handler;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 import android.os.Looper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import android.os.Message;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import android.util.Log;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.arialyy.aria.util.BufferedRandomAccessFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 import java.io.File;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import java.io.IOException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import java.io.InputStream;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import java.io.RandomAccessFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import java.net.URL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import java.util.Properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35  * Created by lyy on 2017/1/18.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36  * 下载线程</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38 final class SingleThreadTask implements Runnable {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39   private static final String TAG      = &quot;SingleThreadTask&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40   // TODO: 2017/2/22 不能使用1024 否则最大速度不能超过3m</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41   private static final int    BUF_SIZE = 8192;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42   private DownloadUtil.ConfigEntity mConfigEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43   private String                    mConfigFPath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44   private              long   mChildCurrentLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45   private static final Object LOCK                  = new Object();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46   private IDownloadListener      mListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47   private DownloadStateConstance mConstance;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49   SingleThreadTask(DownloadStateConstance constance, IDownloadListener listener,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50       DownloadUtil.ConfigEntity downloadInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51     mConstance = constance;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52     mListener = listener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53     this.mConfigEntity = downloadInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54     if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55       mConfigFPath = downloadInfo.CONFIG_FILE_PATH;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59   @Override public void run() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60     HttpURLConnection conn = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61     InputStream is = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63       URL url = new URL(mConfigEntity.DOWNLOAD_URL);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64       //conn = (HttpURLConnection) url.openConnection();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65       conn = ConnectionHelp.handleConnection(url);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67         Log.d(TAG, &quot;线程_&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68             + mConfigEntity.THREAD_ID</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69             + &quot;_正在下载【开始位置 : &quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70             + mConfigEntity.START_LOCATION</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71             + &quot;，结束位置：&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72             + mConfigEntity.END_LOCATION</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73             + &quot;】&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74         //在头里面请求下载开始位置和结束位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75         conn.setRequestProperty(&quot;Range&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76             &quot;bytes=&quot; + mConfigEntity.START_LOCATION + &quot;-&quot; + mConfigEntity.END_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78         Log.w(TAG, &quot;该下载不支持断点，即将重新下载&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80       conn = ConnectionHelp.setConnectParam(conn);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81       conn.setConnectTimeout(mConstance.CONNECT_TIME_OUT);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82       conn.setReadTimeout(mConstance.READ_TIME_OUT);  //设置读取流的等待时间,必须设置该参数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83       is = conn.getInputStream();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84       //创建可设置位置的文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85       BufferedRandomAccessFile file =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86           new BufferedRandomAccessFile(mConfigEntity.TEMP_FILE, &quot;rwd&quot;, BUF_SIZE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87       //设置文件长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88       file.seek(mConfigEntity.START_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90       byte[] buffer = new byte[BUF_SIZE];</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91       int len;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92       //当前子线程的下载位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93       mChildCurrentLocation = mConfigEntity.START_LOCATION;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94       while ((len = is.read(buffer)) != -1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95         if (mConstance.isCancel) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96           break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98         if (mConstance.isStop) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99           Log.i(TAG, &quot;stop&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100           break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         //把下载数据数据写入文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         file.write(buffer, 0, len);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         progress(len);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106       file.close();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107       //close 为阻塞的，需要使用线程池来处理</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108       is.close();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109       conn.disconnect();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110       if (mConstance.isCancel) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111         return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113       //停止状态不需要删除记录文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114       if (mConstance.isStop) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115         return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117       //支持断点的处理</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119         Log.i(TAG, &quot;线程【&quot; + mConfigEntity.THREAD_ID + &quot;】下载完毕&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120         writeConfig(mConfigEntity.TEMP_FILE.getName() + &quot;_state_&quot; + mConfigEntity.THREAD_ID,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121             1 + &quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122         mListener.onChildComplete(mConfigEntity.END_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123         mConstance.COMPLETE_THREAD_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124         if (mConstance.isComplete()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125           File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126           if (configFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127             configFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130           mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133         Log.i(TAG, &quot;下载任务完成&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135         mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137     } catch (MalformedURLException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139       failDownload(mConfigEntity, mChildCurrentLocation, &quot;下载链接异常&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140     } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142       failDownload(mConfigEntity, mChildCurrentLocation, &quot;下载失败【&quot; + mConfigEntity.DOWNLOAD_URL + &quot;】&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143           e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146       failDownload(mConfigEntity, mChildCurrentLocation, &quot;获取流失败&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151    * 停止下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153   protected void stop() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154     synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155       try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156         if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157           mConstance.STOP_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158           String location = String.valueOf(mChildCurrentLocation);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159           Log.d(TAG, &quot;thread_&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160               + mConfigEntity.THREAD_ID</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161               + &quot;_stop, stop location ==&gt; &quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162               + mChildCurrentLocation);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163           writeConfig(mConfigEntity.TEMP_FILE.getName() + &quot;_record_&quot; + mConfigEntity.THREAD_ID,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164               location);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165           if (mConstance.isStop()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166             Log.d(TAG, &quot;++++++++++++++++ onStop +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167             mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168             mListener.onStop(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171           Log.d(TAG, &quot;++++++++++++++++ onStop +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173           mListener.onStop(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175       } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176         e.printStackTrace();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182    * 下载中</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184   private void progress(long len) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185     synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186       mChildCurrentLocation += len;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187       mConstance.CURRENT_LOCATION += len;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188       mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189       //mHandler.sendEmptyMessage(1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190       //mHandler.post(t);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194   Handler mHandler = new Handler(Looper.getMainLooper()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195     @Override public void handleMessage(Message msg) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196       super.handleMessage(msg);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197       mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199   };</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201   Thread t = new Thread(new Runnable() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202     @Override public void run() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203       mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205   });</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207   //Handler handler = new Handler(){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208   //  @Override public void handleMessage(Message msg) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209   //    super.handleMessage(msg);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210   //    mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211   //  }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212   //};</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214   Thread thread = new Thread();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217    * 取消下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219   protected void cancel() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220     synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222         mConstance.CANCEL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223         Log.d(TAG, &quot;++++++++++ thread_&quot; + mConfigEntity.THREAD_ID + &quot;_cancel ++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224         if (mConstance.isCancel()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225           File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226           if (configFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227             configFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229           if (mConfigEntity.TEMP_FILE.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230             mConfigEntity.TEMP_FILE.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232           Log.d(TAG, &quot;++++++++++++++++ onCancel +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 234           mListener.onCancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237         Log.d(TAG, &quot;++++++++++++++++ onCancel +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239         mListener.onCancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245    * 下载失败</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 246    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 247   private void failDownload(DownloadUtil.ConfigEntity dEntity, long currentLocation, String msg,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 248       Exception ex) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 249     synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250       try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 251         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 252         mConstance.isStop = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 253         if (ex != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 254           Log.e(TAG, CommonUtil.getPrintException(ex));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 255         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256         if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 257           if (currentLocation != -1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258             String location = String.valueOf(currentLocation);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259             writeConfig(dEntity.TEMP_FILE.getName() + &quot;_record_&quot; + dEntity.THREAD_ID, location);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261           if (mConstance.isFail()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262             Log.d(TAG, &quot;++++++++++++++++ onFail +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 263             mListener.onFail();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 264           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 265         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266           Log.d(TAG, &quot;++++++++++++++++ onFail +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267           mListener.onFail();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269       } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270         e.printStackTrace();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 274 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 275   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 276    * 将记录写入到配置文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 278   private void writeConfig(String key, String record) throws IOException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 279     File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280     Properties pro = CommonUtil.loadConfig(configFile);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 281     pro.setProperty(key, record);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 282     CommonUtil.saveConfig(configFile, pro);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 283   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 284 }</span>
 285 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301 package com.arialyy.aria.core.task;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303 import android.util.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307 import java.io.InputStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308 import java.io.RandomAccessFile;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315  * Created by lyy on 2017/1/18.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316  * 下载线程</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318 final class SingleThreadTask implements Runnable {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319   private static final String TAG = &quot;SingleThreadTask&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320   private DownloadUtil.ConfigEntity mConfigEntity;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321   private String mConfigFPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322   private long mChildCurrentLocation = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323   private static final Object LOCK = new Object();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324   private IDownloadListener mListener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325   private DownloadStateConstance mConstance;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327   SingleThreadTask(DownloadStateConstance constance, IDownloadListener listener,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328       DownloadUtil.ConfigEntity downloadInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329     mConstance = constance;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330     mListener = listener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331     this.mConfigEntity = downloadInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332     if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333       mConfigFPath = downloadInfo.CONFIG_FILE_PATH;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337   @Override public void run() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338     HttpURLConnection conn = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339     InputStream is = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341       URL url = new URL(mConfigEntity.DOWNLOAD_URL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342       //conn = (HttpURLConnection) url.openConnection();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343       conn = ConnectionHelp.handleConnection(url);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345         Log.d(TAG, &quot;线程_&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346             + mConfigEntity.THREAD_ID</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347             + &quot;_正在下载【开始位置 : &quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348             + mConfigEntity.START_LOCATION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349             + &quot;，结束位置：&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350             + mConfigEntity.END_LOCATION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351             + &quot;】&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352         //在头里面请求下载开始位置和结束位置</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353         conn.setRequestProperty(&quot;Range&quot;,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354             &quot;bytes=&quot; + mConfigEntity.START_LOCATION + &quot;-&quot; + mConfigEntity.END_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356         Log.w(TAG, &quot;该下载不支持断点，即将重新下载&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358       conn = ConnectionHelp.setConnectParam(conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359       conn.setConnectTimeout(mConstance.CONNECT_TIME_OUT);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360       conn.setReadTimeout(mConstance.READ_TIME_OUT);  //设置读取流的等待时间,必须设置该参数</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361       is = conn.getInputStream();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362       //创建可设置位置的文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363       RandomAccessFile file = new RandomAccessFile(mConfigEntity.TEMP_FILE, &quot;rwd&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364       //设置每条线程写入文件的位置</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365       file.seek(mConfigEntity.START_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366       byte[] buffer = new byte[1024];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367       int len;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368       //当前子线程的下载位置</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369       mChildCurrentLocation = mConfigEntity.START_LOCATION;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370       while ((len = is.read(buffer)) != -1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371         if (mConstance.isCancel) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374         if (mConstance.isStop) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375           Log.i(TAG, &quot;stop&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378         //把下载数据数据写入文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379         file.write(buffer, 0, len);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380         progress(len);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382       file.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383       //close 为阻塞的，需要使用线程池来处理</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384       is.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385       conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386       if (mConstance.isCancel) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387         return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389       //停止状态不需要删除记录文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390       if (mConstance.isStop) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391         return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393       //支持断点的处理</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395         Log.i(TAG, &quot;线程【&quot; + mConfigEntity.THREAD_ID + &quot;】下载完毕&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396         writeConfig(mConfigEntity.TEMP_FILE.getName() + &quot;_state_&quot; + mConfigEntity.THREAD_ID,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397             1 + &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398         mListener.onChildComplete(mConfigEntity.END_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399         mConstance.COMPLETE_THREAD_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400         if (mConstance.isComplete()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401           File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402           if (configFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403             configFile.delete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406           mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409         Log.i(TAG, &quot;下载任务完成&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411         mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413     } catch (MalformedURLException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415       failDownload(mConfigEntity, mChildCurrentLocation, &quot;下载链接异常&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416     } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418       failDownload(mConfigEntity, mChildCurrentLocation, &quot;下载失败【&quot; + mConfigEntity.DOWNLOAD_URL + &quot;】&quot;,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419           e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422       failDownload(mConfigEntity, mChildCurrentLocation, &quot;获取流失败&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427    * 停止下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429   protected void stop() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430     synchronized (LOCK) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431       try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432         if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433           mConstance.STOP_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434           String location = String.valueOf(mChildCurrentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435           Log.d(TAG, &quot;thread_&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436               + mConfigEntity.THREAD_ID</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437               + &quot;_stop, stop location ==&gt; &quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438               + mChildCurrentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439           writeConfig(mConfigEntity.TEMP_FILE.getName() + &quot;_record_&quot; + mConfigEntity.THREAD_ID,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 440               location);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441           if (mConstance.isStop()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442             Log.d(TAG, &quot;++++++++++++++++ onStop +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443             mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444             mListener.onStop(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447           Log.d(TAG, &quot;++++++++++++++++ onStop +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449           mListener.onStop(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451       } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452         e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458    * 下载中</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460   private void progress(long len) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461     synchronized (LOCK) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462       mChildCurrentLocation += len;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463       mConstance.CURRENT_LOCATION += len;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 464       mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 465     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 468   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 469    * 取消下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 470    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 471   protected void cancel() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 472     synchronized (LOCK) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 473       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474         mConstance.CANCEL_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475         Log.d(TAG, &quot;++++++++++ thread_&quot; + mConfigEntity.THREAD_ID + &quot;_cancel ++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 476         if (mConstance.isCancel()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 477           File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 478           if (configFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 479             configFile.delete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 480           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 481           if (mConfigEntity.TEMP_FILE.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482             mConfigEntity.TEMP_FILE.delete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484           Log.d(TAG, &quot;++++++++++++++++ onCancel +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486           mListener.onCancel();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489         Log.d(TAG, &quot;++++++++++++++++ onCancel +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 490         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 491         mListener.onCancel();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 492       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 493     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 494   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497    * 下载失败</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499   private void failDownload(DownloadUtil.ConfigEntity dEntity, long currentLocation, String msg,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500       Exception ex) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501     synchronized (LOCK) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 502       try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 503         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 504         mConstance.isStop = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505         if (ex != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 506           Log.e(TAG, CommonUtil.getPrintException(ex));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 507         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 508         if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 509           if (currentLocation != -1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510             String location = String.valueOf(currentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 511             writeConfig(dEntity.TEMP_FILE.getName() + &quot;_record_&quot; + dEntity.THREAD_ID, location);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 512           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 513           if (mConstance.isFail()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 514             Log.d(TAG, &quot;++++++++++++++++ onFail +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 515             mListener.onFail();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 516           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 517         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 518           Log.d(TAG, &quot;++++++++++++++++ onFail +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 519           mListener.onFail();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 520         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 521       } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 522         e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 523       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 524     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 528    * 将记录写入到配置文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530   private void writeConfig(String key, String record) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531     File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532     Properties pro = CommonUtil.loadConfig(configFile);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533     pro.setProperty(key, record);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 534     CommonUtil.saveConfig(configFile, pro);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 535   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 536 }</span>
 537 =======
 538 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   2 /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   3  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   4  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   5  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   6  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   7  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   8  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   9  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  10  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  11  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  12  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  13  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  14  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  15  * limitations under the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  16  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  17 package com.arialyy.aria.core.task;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  18 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  19 import android.os.Handler;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 import android.os.Looper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import android.os.Message;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import android.util.Log;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.arialyy.aria.util.BufferedRandomAccessFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 import java.io.File;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import java.io.IOException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import java.io.InputStream;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import java.io.RandomAccessFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import java.net.URL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import java.util.Properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35  * Created by lyy on 2017/1/18.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36  * 下载线程</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38 final class SingleThreadTask implements Runnable {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39   private static final String TAG      = &quot;SingleThreadTask&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40   // TODO: 2017/2/22 不能使用1024 否则最大速度不能超过3m</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41   private static final int    BUF_SIZE = 8192;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42   private DownloadUtil.ConfigEntity mConfigEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43   private String                    mConfigFPath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44   private              long   mChildCurrentLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45   private static final Object LOCK                  = new Object();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46   private IDownloadListener      mListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47   private DownloadStateConstance mConstance;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49   SingleThreadTask(DownloadStateConstance constance, IDownloadListener listener,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50       DownloadUtil.ConfigEntity downloadInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51     mConstance = constance;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52     mListener = listener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53     this.mConfigEntity = downloadInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54     if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55       mConfigFPath = downloadInfo.CONFIG_FILE_PATH;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59   @Override public void run() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60     HttpURLConnection conn = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61     InputStream is = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63       URL url = new URL(mConfigEntity.DOWNLOAD_URL);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64       //conn = (HttpURLConnection) url.openConnection();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65       conn = ConnectionHelp.handleConnection(url);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67         Log.d(TAG, &quot;线程_&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68             + mConfigEntity.THREAD_ID</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69             + &quot;_正在下载【开始位置 : &quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70             + mConfigEntity.START_LOCATION</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71             + &quot;，结束位置：&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72             + mConfigEntity.END_LOCATION</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73             + &quot;】&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74         //在头里面请求下载开始位置和结束位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75         conn.setRequestProperty(&quot;Range&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76             &quot;bytes=&quot; + mConfigEntity.START_LOCATION + &quot;-&quot; + mConfigEntity.END_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78         Log.w(TAG, &quot;该下载不支持断点，即将重新下载&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80       conn = ConnectionHelp.setConnectParam(conn);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81       conn.setConnectTimeout(mConstance.CONNECT_TIME_OUT);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82       conn.setReadTimeout(mConstance.READ_TIME_OUT);  //设置读取流的等待时间,必须设置该参数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83       is = conn.getInputStream();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84       //创建可设置位置的文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85       BufferedRandomAccessFile file =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86           new BufferedRandomAccessFile(mConfigEntity.TEMP_FILE, &quot;rwd&quot;, BUF_SIZE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87       //设置文件长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88       file.seek(mConfigEntity.START_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90       byte[] buffer = new byte[BUF_SIZE];</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91       int len;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92       //当前子线程的下载位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93       mChildCurrentLocation = mConfigEntity.START_LOCATION;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94       while ((len = is.read(buffer)) != -1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95         if (mConstance.isCancel) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96           break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98         if (mConstance.isStop) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99           Log.i(TAG, &quot;stop&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100           break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         //把下载数据数据写入文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         file.write(buffer, 0, len);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         progress(len);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106       file.close();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107       //close 为阻塞的，需要使用线程池来处理</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108       is.close();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109       conn.disconnect();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110       if (mConstance.isCancel) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111         return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113       //停止状态不需要删除记录文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114       if (mConstance.isStop) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115         return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117       //支持断点的处理</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119         Log.i(TAG, &quot;线程【&quot; + mConfigEntity.THREAD_ID + &quot;】下载完毕&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120         writeConfig(mConfigEntity.TEMP_FILE.getName() + &quot;_state_&quot; + mConfigEntity.THREAD_ID,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121             1 + &quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122         mListener.onChildComplete(mConfigEntity.END_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123         mConstance.COMPLETE_THREAD_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124         if (mConstance.isComplete()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125           File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126           if (configFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127             configFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130           mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133         Log.i(TAG, &quot;下载任务完成&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135         mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137     } catch (MalformedURLException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139       failDownload(mConfigEntity, mChildCurrentLocation, &quot;下载链接异常&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140     } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142       failDownload(mConfigEntity, mChildCurrentLocation, &quot;下载失败【&quot; + mConfigEntity.DOWNLOAD_URL + &quot;】&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143           e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146       failDownload(mConfigEntity, mChildCurrentLocation, &quot;获取流失败&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151    * 停止下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153   protected void stop() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154     synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155       try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156         if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157           mConstance.STOP_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158           String location = String.valueOf(mChildCurrentLocation);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159           Log.d(TAG, &quot;thread_&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160               + mConfigEntity.THREAD_ID</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161               + &quot;_stop, stop location ==&gt; &quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162               + mChildCurrentLocation);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163           writeConfig(mConfigEntity.TEMP_FILE.getName() + &quot;_record_&quot; + mConfigEntity.THREAD_ID,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164               location);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165           if (mConstance.isStop()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166             Log.d(TAG, &quot;++++++++++++++++ onStop +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167             mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168             mListener.onStop(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171           Log.d(TAG, &quot;++++++++++++++++ onStop +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173           mListener.onStop(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175       } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176         e.printStackTrace();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182    * 下载中</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184   private void progress(long len) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185     synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186       mChildCurrentLocation += len;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187       mConstance.CURRENT_LOCATION += len;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188       mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189       //mHandler.sendEmptyMessage(1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190       //mHandler.post(t);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194   Handler mHandler = new Handler(Looper.getMainLooper()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195     @Override public void handleMessage(Message msg) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196       super.handleMessage(msg);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197       mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199   };</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201   Thread t = new Thread(new Runnable() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202     @Override public void run() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203       mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205   });</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207   //Handler handler = new Handler(){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208   //  @Override public void handleMessage(Message msg) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209   //    super.handleMessage(msg);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210   //    mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211   //  }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212   //};</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214   Thread thread = new Thread();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217    * 取消下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219   protected void cancel() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220     synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222         mConstance.CANCEL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223         Log.d(TAG, &quot;++++++++++ thread_&quot; + mConfigEntity.THREAD_ID + &quot;_cancel ++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224         if (mConstance.isCancel()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225           File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226           if (configFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227             configFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229           if (mConfigEntity.TEMP_FILE.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230             mConfigEntity.TEMP_FILE.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232           Log.d(TAG, &quot;++++++++++++++++ onCancel +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 234           mListener.onCancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237         Log.d(TAG, &quot;++++++++++++++++ onCancel +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239         mListener.onCancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245    * 下载失败</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 246    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 247   private void failDownload(DownloadUtil.ConfigEntity dEntity, long currentLocation, String msg,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 248       Exception ex) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 249     synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250       try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 251         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 252         mConstance.isStop = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 253         if (ex != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 254           Log.e(TAG, CommonUtil.getPrintException(ex));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 255         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256         if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 257           if (currentLocation != -1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258             String location = String.valueOf(currentLocation);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259             writeConfig(dEntity.TEMP_FILE.getName() + &quot;_record_&quot; + dEntity.THREAD_ID, location);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261           if (mConstance.isFail()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262             Log.d(TAG, &quot;++++++++++++++++ onFail +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 263             mListener.onFail();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 264           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 265         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266           Log.d(TAG, &quot;++++++++++++++++ onFail +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267           mListener.onFail();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269       } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270         e.printStackTrace();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 274 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 275   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 276    * 将记录写入到配置文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 278   private void writeConfig(String key, String record) throws IOException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 279     File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280     Properties pro = CommonUtil.loadConfig(configFile);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 281     pro.setProperty(key, record);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 282     CommonUtil.saveConfig(configFile, pro);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 283   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 284 }</span>
 285 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301 package com.arialyy.aria.core.task;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303 import android.util.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307 import java.io.InputStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308 import java.io.RandomAccessFile;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315  * Created by lyy on 2017/1/18.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316  * 下载线程</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318 final class SingleThreadTask implements Runnable {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319   private static final String TAG = &quot;SingleThreadTask&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320   private DownloadUtil.ConfigEntity mConfigEntity;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321   private String mConfigFPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322   private long mChildCurrentLocation = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323   private static final Object LOCK = new Object();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324   private IDownloadListener mListener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325   private DownloadStateConstance mConstance;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327   SingleThreadTask(DownloadStateConstance constance, IDownloadListener listener,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328       DownloadUtil.ConfigEntity downloadInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329     mConstance = constance;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330     mListener = listener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331     this.mConfigEntity = downloadInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332     if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333       mConfigFPath = downloadInfo.CONFIG_FILE_PATH;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337   @Override public void run() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338     HttpURLConnection conn = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339     InputStream is = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341       URL url = new URL(mConfigEntity.DOWNLOAD_URL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342       //conn = (HttpURLConnection) url.openConnection();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343       conn = ConnectionHelp.handleConnection(url);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345         Log.d(TAG, &quot;线程_&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346             + mConfigEntity.THREAD_ID</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347             + &quot;_正在下载【开始位置 : &quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348             + mConfigEntity.START_LOCATION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349             + &quot;，结束位置：&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350             + mConfigEntity.END_LOCATION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351             + &quot;】&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352         //在头里面请求下载开始位置和结束位置</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353         conn.setRequestProperty(&quot;Range&quot;,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354             &quot;bytes=&quot; + mConfigEntity.START_LOCATION + &quot;-&quot; + mConfigEntity.END_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356         Log.w(TAG, &quot;该下载不支持断点，即将重新下载&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358       conn = ConnectionHelp.setConnectParam(conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359       conn.setConnectTimeout(mConstance.CONNECT_TIME_OUT);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360       conn.setReadTimeout(mConstance.READ_TIME_OUT);  //设置读取流的等待时间,必须设置该参数</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361       is = conn.getInputStream();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362       //创建可设置位置的文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363       RandomAccessFile file = new RandomAccessFile(mConfigEntity.TEMP_FILE, &quot;rwd&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364       //设置每条线程写入文件的位置</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365       file.seek(mConfigEntity.START_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366       byte[] buffer = new byte[1024];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367       int len;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368       //当前子线程的下载位置</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369       mChildCurrentLocation = mConfigEntity.START_LOCATION;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370       while ((len = is.read(buffer)) != -1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371         if (mConstance.isCancel) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374         if (mConstance.isStop) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375           Log.i(TAG, &quot;stop&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378         //把下载数据数据写入文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379         file.write(buffer, 0, len);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380         progress(len);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382       file.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383       //close 为阻塞的，需要使用线程池来处理</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384       is.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385       conn.disconnect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386       if (mConstance.isCancel) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387         return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389       //停止状态不需要删除记录文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390       if (mConstance.isStop) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391         return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393       //支持断点的处理</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395         Log.i(TAG, &quot;线程【&quot; + mConfigEntity.THREAD_ID + &quot;】下载完毕&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396         writeConfig(mConfigEntity.TEMP_FILE.getName() + &quot;_state_&quot; + mConfigEntity.THREAD_ID,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397             1 + &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398         mListener.onChildComplete(mConfigEntity.END_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399         mConstance.COMPLETE_THREAD_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400         if (mConstance.isComplete()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401           File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402           if (configFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403             configFile.delete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406           mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409         Log.i(TAG, &quot;下载任务完成&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411         mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413     } catch (MalformedURLException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415       failDownload(mConfigEntity, mChildCurrentLocation, &quot;下载链接异常&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416     } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418       failDownload(mConfigEntity, mChildCurrentLocation, &quot;下载失败【&quot; + mConfigEntity.DOWNLOAD_URL + &quot;】&quot;,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419           e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422       failDownload(mConfigEntity, mChildCurrentLocation, &quot;获取流失败&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427    * 停止下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429   protected void stop() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430     synchronized (LOCK) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431       try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432         if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433           mConstance.STOP_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434           String location = String.valueOf(mChildCurrentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435           Log.d(TAG, &quot;thread_&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436               + mConfigEntity.THREAD_ID</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437               + &quot;_stop, stop location ==&gt; &quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438               + mChildCurrentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439           writeConfig(mConfigEntity.TEMP_FILE.getName() + &quot;_record_&quot; + mConfigEntity.THREAD_ID,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 440               location);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441           if (mConstance.isStop()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442             Log.d(TAG, &quot;++++++++++++++++ onStop +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443             mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444             mListener.onStop(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447           Log.d(TAG, &quot;++++++++++++++++ onStop +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449           mListener.onStop(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451       } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452         e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458    * 下载中</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460   private void progress(long len) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461     synchronized (LOCK) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462       mChildCurrentLocation += len;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463       mConstance.CURRENT_LOCATION += len;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 464       mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 465     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 468   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 469    * 取消下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 470    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 471   protected void cancel() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 472     synchronized (LOCK) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 473       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474         mConstance.CANCEL_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475         Log.d(TAG, &quot;++++++++++ thread_&quot; + mConfigEntity.THREAD_ID + &quot;_cancel ++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 476         if (mConstance.isCancel()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 477           File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 478           if (configFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 479             configFile.delete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 480           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 481           if (mConfigEntity.TEMP_FILE.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482             mConfigEntity.TEMP_FILE.delete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484           Log.d(TAG, &quot;++++++++++++++++ onCancel +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486           mListener.onCancel();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489         Log.d(TAG, &quot;++++++++++++++++ onCancel +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 490         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 491         mListener.onCancel();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 492       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 493     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 494   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497    * 下载失败</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499   private void failDownload(DownloadUtil.ConfigEntity dEntity, long currentLocation, String msg,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500       Exception ex) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501     synchronized (LOCK) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 502       try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 503         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 504         mConstance.isStop = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505         if (ex != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 506           Log.e(TAG, CommonUtil.getPrintException(ex));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 507         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 508         if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 509           if (currentLocation != -1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510             String location = String.valueOf(currentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 511             writeConfig(dEntity.TEMP_FILE.getName() + &quot;_record_&quot; + dEntity.THREAD_ID, location);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 512           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 513           if (mConstance.isFail()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 514             Log.d(TAG, &quot;++++++++++++++++ onFail +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 515             mListener.onFail();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 516           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 517         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 518           Log.d(TAG, &quot;++++++++++++++++ onFail +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 519           mListener.onFail();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 520         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 521       } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 522         e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 523       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 524     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 528    * 将记录写入到配置文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530   private void writeConfig(String key, String record) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531     File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532     Properties pro = CommonUtil.loadConfig(configFile);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533     pro.setProperty(key, record);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 534     CommonUtil.saveConfig(configFile, pro);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 535   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 536 }</span>
 537 =======
 538 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   2 /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   3  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   4  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   5  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   6  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   7  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   8  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   9  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  10  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  11  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  12  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  13  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  14  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  15  * limitations under the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  16  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  17 package com.arialyy.aria.core.task;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  18 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  19 import android.os.Handler;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 import android.os.Looper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import android.os.Message;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import android.util.Log;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.arialyy.aria.util.BufferedRandomAccessFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 import java.io.File;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import java.io.IOException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import java.io.InputStream;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import java.io.RandomAccessFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import java.net.URL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import java.util.Properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35  * Created by lyy on 2017/1/18.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36  * 下载线程</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38 final class SingleThreadTask implements Runnable {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39   private static final String TAG      = &quot;SingleThreadTask&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40   // TODO: 2017/2/22 不能使用1024 否则最大速度不能超过3m</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41   private static final int    BUF_SIZE = 8192;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42   private DownloadUtil.ConfigEntity mConfigEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43   private String                    mConfigFPath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44   private              long   mChildCurrentLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45   private static final Object LOCK                  = new Object();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46   private IDownloadListener      mListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47   private DownloadStateConstance mConstance;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49   SingleThreadTask(DownloadStateConstance constance, IDownloadListener listener,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50       DownloadUtil.ConfigEntity downloadInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51     mConstance = constance;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52     mListener = listener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53     this.mConfigEntity = downloadInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54     if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55       mConfigFPath = downloadInfo.CONFIG_FILE_PATH;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59   @Override public void run() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60     HttpURLConnection conn = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61     InputStream is = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63       URL url = new URL(mConfigEntity.DOWNLOAD_URL);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64       //conn = (HttpURLConnection) url.openConnection();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65       conn = ConnectionHelp.handleConnection(url);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67         Log.d(TAG, &quot;线程_&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68             + mConfigEntity.THREAD_ID</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69             + &quot;_正在下载【开始位置 : &quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70             + mConfigEntity.START_LOCATION</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71             + &quot;，结束位置：&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72             + mConfigEntity.END_LOCATION</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73             + &quot;】&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74         //在头里面请求下载开始位置和结束位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75         conn.setRequestProperty(&quot;Range&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76             &quot;bytes=&quot; + mConfigEntity.START_LOCATION + &quot;-&quot; + mConfigEntity.END_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78         Log.w(TAG, &quot;该下载不支持断点，即将重新下载&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80       conn = ConnectionHelp.setConnectParam(conn);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81       conn.setConnectTimeout(mConstance.CONNECT_TIME_OUT);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82       conn.setReadTimeout(mConstance.READ_TIME_OUT);  //设置读取流的等待时间,必须设置该参数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83       is = conn.getInputStream();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84       //创建可设置位置的文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85       BufferedRandomAccessFile file =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86           new BufferedRandomAccessFile(mConfigEntity.TEMP_FILE, &quot;rwd&quot;, BUF_SIZE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87       //设置文件长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88       file.seek(mConfigEntity.START_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90       byte[] buffer = new byte[BUF_SIZE];</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91       int len;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92       //当前子线程的下载位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93       mChildCurrentLocation = mConfigEntity.START_LOCATION;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94       while ((len = is.read(buffer)) != -1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95         if (mConstance.isCancel) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96           break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98         if (mConstance.isStop) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99           Log.i(TAG, &quot;stop&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100           break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         //把下载数据数据写入文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         file.write(buffer, 0, len);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         progress(len);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106       file.close();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107       //close 为阻塞的，需要使用线程池来处理</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108       is.close();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109       conn.disconnect();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110       if (mConstance.isCancel) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111         return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113       //停止状态不需要删除记录文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114       if (mConstance.isStop) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115         return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117       //支持断点的处理</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119         Log.i(TAG, &quot;线程【&quot; + mConfigEntity.THREAD_ID + &quot;】下载完毕&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120         writeConfig(mConfigEntity.TEMP_FILE.getName() + &quot;_state_&quot; + mConfigEntity.THREAD_ID,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121             1 + &quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122         mListener.onChildComplete(mConfigEntity.END_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123         mConstance.COMPLETE_THREAD_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124         if (mConstance.isComplete()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125           File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126           if (configFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127             configFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130           mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133         Log.i(TAG, &quot;下载任务完成&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135         mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137     } catch (MalformedURLException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139       failDownload(mConfigEntity, mChildCurrentLocation, &quot;下载链接异常&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140     } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142       failDownload(mConfigEntity, mChildCurrentLocation, &quot;下载失败【&quot; + mConfigEntity.DOWNLOAD_URL + &quot;】&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143           e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145       mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146       failDownload(mConfigEntity, mChildCurrentLocation, &quot;获取流失败&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151    * 停止下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153   protected void stop() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154     synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155       try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156         if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157           mConstance.STOP_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158           String location = String.valueOf(mChildCurrentLocation);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159           Log.d(TAG, &quot;thread_&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160               + mConfigEntity.THREAD_ID</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161               + &quot;_stop, stop location ==&gt; &quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162               + mChildCurrentLocation);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163           writeConfig(mConfigEntity.TEMP_FILE.getName() + &quot;_record_&quot; + mConfigEntity.THREAD_ID,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164               location);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165           if (mConstance.isStop()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166             Log.d(TAG, &quot;++++++++++++++++ onStop +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167             mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168             mListener.onStop(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171           Log.d(TAG, &quot;++++++++++++++++ onStop +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173           mListener.onStop(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175       } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176         e.printStackTrace();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182    * 下载中</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184   private void progress(long len) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185     synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186       mChildCurrentLocation += len;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187       mConstance.CURRENT_LOCATION += len;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188       mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189       //mHandler.sendEmptyMessage(1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190       //mHandler.post(t);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194   Handler mHandler = new Handler(Looper.getMainLooper()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195     @Override public void handleMessage(Message msg) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196       super.handleMessage(msg);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197       mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199   };</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201   Thread t = new Thread(new Runnable() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202     @Override public void run() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203       mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205   });</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207   //Handler handler = new Handler(){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208   //  @Override public void handleMessage(Message msg) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209   //    super.handleMessage(msg);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210   //    mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211   //  }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212   //};</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214   Thread thread = new Thread();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217    * 取消下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219   protected void cancel() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220     synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221       if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222         mConstance.CANCEL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223         Log.d(TAG, &quot;++++++++++ thread_&quot; + mConfigEntity.THREAD_ID + &quot;_cancel ++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224         if (mConstance.isCancel()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225           File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226           if (configFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227             configFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229           if (mConfigEntity.TEMP_FILE.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230             mConfigEntity.TEMP_FILE.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232           Log.d(TAG, &quot;++++++++++++++++ onCancel +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 234           mListener.onCancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237         Log.d(TAG, &quot;++++++++++++++++ onCancel +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239         mListener.onCancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245    * 下载失败</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 246    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 247   private void failDownload(DownloadUtil.ConfigEntity dEntity, long currentLocation, String msg,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 248       Exception ex) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 249     synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250       try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 251         mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 252         mConstance.isStop = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 253         if (ex != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 254           Log.e(TAG, CommonUtil.getPrintException(ex));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 255         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256         if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 257           if (currentLocation != -1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258             String location = String.valueOf(currentLocation);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259             writeConfig(dEntity.TEMP_FILE.getName() + &quot;_record_&quot; + dEntity.THREAD_ID, location);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261           if (mConstance.isFail()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262             Log.d(TAG, &quot;++++++++++++++++ onFail +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 263             mListener.onFail();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 264           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 265         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266           Log.d(TAG, &quot;++++++++++++++++ onFail +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267           mListener.onFail();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269       } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270         e.printStackTrace();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 274 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 275   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 276    * 将记录写入到配置文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 278   private void writeConfig(String key, String record) throws IOException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 279     File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280     Properties pro = CommonUtil.loadConfig(configFile);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 281     pro.setProperty(key, record);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 282     CommonUtil.saveConfig(configFile, pro);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 283   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 284 }</span>
 285 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 286 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 286 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 287 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288 </span>
 289 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  package com.arialyy.aria.core.task;
  17  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +import android.os.Handler;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +import android.os.Looper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import android.os.Message;</span>
  21  import android.util.Log;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import com.arialyy.aria.util.BufferedRandomAccessFile;</span>
  23  import com.arialyy.aria.util.CommonUtil;
  24  import java.io.File;
  25  import java.io.IOException;
  26  import java.io.InputStream;
  27  import java.io.RandomAccessFile;
  28  import java.net.HttpURLConnection;
  29  import java.net.MalformedURLException;
  30  import java.net.URL;
  31  import java.util.Properties;
  32  
  33  /**
  34   * Created by lyy on 2017/1/18.
  35   * 下载线程
  36   */
  37  final class SingleThreadTask implements Runnable {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -  private static final String TAG = &quot;SingleThreadTask&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +  private static final String TAG      = &quot;SingleThreadTask&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +  // TODO: 2017/2/22 不能使用1024 否则最大速度不能超过3m</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +  private static final int    BUF_SIZE = 8192;</span>
  42    private DownloadUtil.ConfigEntity mConfigEntity;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -  private String mConfigFPath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -  private long mChildCurrentLocation = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -  private static final Object LOCK = new Object();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -  private IDownloadListener mListener;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +  private String                    mConfigFPath;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +  private              long   mChildCurrentLocation = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +  private static final Object LOCK                  = new Object();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +  private IDownloadListener      mListener;</span>
  51    private DownloadStateConstance mConstance;
  52  
  53    SingleThreadTask(DownloadStateConstance constance, IDownloadListener listener,
  54        DownloadUtil.ConfigEntity downloadInfo) {
  55      mConstance = constance;
  56      mListener = listener;
  57      this.mConfigEntity = downloadInfo;
  58      if (mConfigEntity.isSupportBreakpoint) {
  59        mConfigFPath = downloadInfo.CONFIG_FILE_PATH;
  60      }
  61    }
  62  
  63    @Override public void run() {
  64      HttpURLConnection conn = null;
  65      InputStream is = null;
  66      try {
  67        URL url = new URL(mConfigEntity.DOWNLOAD_URL);
  68        //conn = (HttpURLConnection) url.openConnection();
  69        conn = ConnectionHelp.handleConnection(url);
  70        if (mConfigEntity.isSupportBreakpoint) {
  71          Log.d(TAG, &quot;线程_&quot;
  72              + mConfigEntity.THREAD_ID
  73              + &quot;_正在下载【开始位置 : &quot;
  74              + mConfigEntity.START_LOCATION
  75              + &quot;，结束位置：&quot;
  76              + mConfigEntity.END_LOCATION
  77              + &quot;】&quot;);
  78          //在头里面请求下载开始位置和结束位置
  79          conn.setRequestProperty(&quot;Range&quot;,
  80              &quot;bytes=&quot; + mConfigEntity.START_LOCATION + &quot;-&quot; + mConfigEntity.END_LOCATION);
  81        } else {
  82          Log.w(TAG, &quot;该下载不支持断点，即将重新下载&quot;);
  83        }
  84        conn = ConnectionHelp.setConnectParam(conn);
  85        conn.setConnectTimeout(mConstance.CONNECT_TIME_OUT);
  86        conn.setReadTimeout(mConstance.READ_TIME_OUT);  //设置读取流的等待时间,必须设置该参数
  87        is = conn.getInputStream();
  88        //创建可设置位置的文件
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -      RandomAccessFile file = new RandomAccessFile(mConfigEntity.TEMP_FILE, &quot;rwd&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -      //设置每条线程写入文件的位置</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +      BufferedRandomAccessFile file =</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +          new BufferedRandomAccessFile(mConfigEntity.TEMP_FILE, &quot;rwd&quot;, BUF_SIZE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +      //设置文件长度</span>
  94        file.seek(mConfigEntity.START_LOCATION);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -      byte[] buffer = new byte[1024];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +      byte[] buffer = new byte[BUF_SIZE];</span>
  98        int len;
  99        //当前子线程的下载位置
 100        mChildCurrentLocation = mConfigEntity.START_LOCATION;
 101        while ((len = is.read(buffer)) != -1) {
 102          if (mConstance.isCancel) {
 103            break;
 104          }
 105          if (mConstance.isStop) {
 106            Log.i(TAG, &quot;stop&quot;);
 107            break;
 108          }
 109          //把下载数据数据写入文件
 110          file.write(buffer, 0, len);
 111          progress(len);
 112        }
 113        file.close();
 114        //close 为阻塞的，需要使用线程池来处理
 115        is.close();
 116        conn.disconnect();
 117        if (mConstance.isCancel) {
 118          return;
 119        }
 120        //停止状态不需要删除记录文件
 121        if (mConstance.isStop) {
 122          return;
 123        }
 124        //支持断点的处理
 125        if (mConfigEntity.isSupportBreakpoint) {
 126          Log.i(TAG, &quot;线程【&quot; + mConfigEntity.THREAD_ID + &quot;】下载完毕&quot;);
 127          writeConfig(mConfigEntity.TEMP_FILE.getName() + &quot;_state_&quot; + mConfigEntity.THREAD_ID,
 128              1 + &quot;&quot;);
 129          mListener.onChildComplete(mConfigEntity.END_LOCATION);
 130          mConstance.COMPLETE_THREAD_NUM++;
 131          if (mConstance.isComplete()) {
 132            File configFile = new File(mConfigFPath);
 133            if (configFile.exists()) {
 134              configFile.delete();
 135            }
 136            mConstance.isDownloading = false;
 137            mListener.onComplete();
 138          }
 139        } else {
 140          Log.i(TAG, &quot;下载任务完成&quot;);
 141          mConstance.isDownloading = false;
 142          mListener.onComplete();
 143        }
 144      } catch (MalformedURLException e) {
 145        mConstance.FAIL_NUM++;
 146        failDownload(mConfigEntity, mChildCurrentLocation, &quot;下载链接异常&quot;, e);
 147      } catch (IOException e) {
 148        mConstance.FAIL_NUM++;
 149        failDownload(mConfigEntity, mChildCurrentLocation, &quot;下载失败【&quot; + mConfigEntity.DOWNLOAD_URL + &quot;】&quot;,
 150            e);
 151      } catch (Exception e) {
 152        mConstance.FAIL_NUM++;
 153        failDownload(mConfigEntity, mChildCurrentLocation, &quot;获取流失败&quot;, e);
 154      }
 155    }
 156  
 157    /**
 158     * 停止下载
 159     */
 160    protected void stop() {
 161      synchronized (LOCK) {
 162        try {
 163          if (mConfigEntity.isSupportBreakpoint) {
 164            mConstance.STOP_NUM++;
 165            String location = String.valueOf(mChildCurrentLocation);
 166            Log.d(TAG, &quot;thread_&quot;
 167                + mConfigEntity.THREAD_ID
 168                + &quot;_stop, stop location ==&gt; &quot;
 169                + mChildCurrentLocation);
 170            writeConfig(mConfigEntity.TEMP_FILE.getName() + &quot;_record_&quot; + mConfigEntity.THREAD_ID,
 171                location);
 172            if (mConstance.isStop()) {
 173              Log.d(TAG, &quot;++++++++++++++++ onStop +++++++++++++++++&quot;);
 174              mConstance.isDownloading = false;
 175              mListener.onStop(mConstance.CURRENT_LOCATION);
 176            }
 177          } else {
 178            Log.d(TAG, &quot;++++++++++++++++ onStop +++++++++++++++++&quot;);
 179            mConstance.isDownloading = false;
 180            mListener.onStop(mConstance.CURRENT_LOCATION);
 181          }
 182        } catch (IOException e) {
 183          e.printStackTrace();
 184        }
 185      }
 186    }
 187  
 188    /**
 189     * 下载中
 190     */
 191    private void progress(long len) {
 192      synchronized (LOCK) {
 193        mChildCurrentLocation += len;
 194        mConstance.CURRENT_LOCATION += len;
 195        mListener.onProgress(mConstance.CURRENT_LOCATION);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +      //mHandler.sendEmptyMessage(1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +      //mHandler.post(t);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +  Handler mHandler = new Handler(Looper.getMainLooper()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +    @Override public void handleMessage(Message msg) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +      super.handleMessage(msg);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +      mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +  };</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +  Thread t = new Thread(new Runnable() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +    @Override public void run() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +      mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +  });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +  //Handler handler = new Handler(){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +  //  @Override public void handleMessage(Message msg) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +  //    super.handleMessage(msg);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +  //    mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +  //  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +  //};</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +  Thread thread = new Thread();</span>
 224  
 225    /**
 226     * 取消下载
 227     */
 228    protected void cancel() {
 229      synchronized (LOCK) {
 230        if (mConfigEntity.isSupportBreakpoint) {
 231          mConstance.CANCEL_NUM++;
 232          Log.d(TAG, &quot;++++++++++ thread_&quot; + mConfigEntity.THREAD_ID + &quot;_cancel ++++++++++&quot;);
 233          if (mConstance.isCancel()) {
 234            File configFile = new File(mConfigFPath);
 235            if (configFile.exists()) {
 236              configFile.delete();
 237            }
 238            if (mConfigEntity.TEMP_FILE.exists()) {
 239              mConfigEntity.TEMP_FILE.delete();
 240            }
 241            Log.d(TAG, &quot;++++++++++++++++ onCancel +++++++++++++++++&quot;);
 242            mConstance.isDownloading = false;
 243            mListener.onCancel();
 244          }
 245        } else {
 246          Log.d(TAG, &quot;++++++++++++++++ onCancel +++++++++++++++++&quot;);
 247          mConstance.isDownloading = false;
 248          mListener.onCancel();
 249        }
 250      }
 251    }
 252  
 253    /**
 254     * 下载失败
 255     */
 256    private void failDownload(DownloadUtil.ConfigEntity dEntity, long currentLocation, String msg,
 257        Exception ex) {
 258      synchronized (LOCK) {
 259        try {
 260          mConstance.isDownloading = false;
 261          mConstance.isStop = true;
 262          if (ex != null) {
 263            Log.e(TAG, CommonUtil.getPrintException(ex));
 264          }
 265          if (mConfigEntity.isSupportBreakpoint) {
 266            if (currentLocation != -1) {
 267              String location = String.valueOf(currentLocation);
 268              writeConfig(dEntity.TEMP_FILE.getName() + &quot;_record_&quot; + dEntity.THREAD_ID, location);
 269            }
 270            if (mConstance.isFail()) {
 271              Log.d(TAG, &quot;++++++++++++++++ onFail +++++++++++++++++&quot;);
 272              mListener.onFail();
 273            }
 274          } else {
 275            Log.d(TAG, &quot;++++++++++++++++ onFail +++++++++++++++++&quot;);
 276            mListener.onFail();
 277          }
 278        } catch (IOException e) {
 279          e.printStackTrace();
 280        }
 281      }
 282    }
 283  
 284    /**
 285     * 将记录写入到配置文件
 286     */
 287    private void writeConfig(String key, String record) throws IOException {
 288      File configFile = new File(mConfigFPath);
 289      Properties pro = CommonUtil.loadConfig(configFile);
 290      pro.setProperty(key, record);
 291      CommonUtil.saveConfig(configFile, pro);
 292    }
 293  }</pre></td>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 - * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 - * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 - *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 - * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 - * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 - * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  14 - * limitations under the License.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 -package com.arialyy.aria.core.task;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 -</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -import android.util.Log;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -import java.io.File;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import java.io.IOException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import java.io.InputStream;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import java.io.RandomAccessFile;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import java.net.MalformedURLException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import java.net.URL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import java.util.Properties;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 - * Created by lyy on 2017/1/18.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 - * 下载线程</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -final class SingleThreadTask implements Runnable {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -  private static final String TAG = &quot;SingleThreadTask&quot;;</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -  private DownloadUtil.ConfigEntity mConfigEntity;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -  private String mConfigFPath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -  private long mChildCurrentLocation = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -  private static final Object LOCK = new Object();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -  private IDownloadListener mListener;</span>




<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -  private DownloadStateConstance mConstance;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -  SingleThreadTask(DownloadStateConstance constance, IDownloadListener listener,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -      DownloadUtil.ConfigEntity downloadInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -    mConstance = constance;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -    mListener = listener;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -    this.mConfigEntity = downloadInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -    if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -      mConfigFPath = downloadInfo.CONFIG_FILE_PATH;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -  @Override public void run() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -    HttpURLConnection conn = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -    InputStream is = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -      URL url = new URL(mConfigEntity.DOWNLOAD_URL);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -      //conn = (HttpURLConnection) url.openConnection();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -      conn = ConnectionHelp.handleConnection(url);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -      if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -        Log.d(TAG, &quot;线程_&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -            + mConfigEntity.THREAD_ID</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -            + &quot;_正在下载【开始位置 : &quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -            + mConfigEntity.START_LOCATION</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -            + &quot;，结束位置：&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -            + mConfigEntity.END_LOCATION</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -            + &quot;】&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -        //在头里面请求下载开始位置和结束位置</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -        conn.setRequestProperty(&quot;Range&quot;,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -            &quot;bytes=&quot; + mConfigEntity.START_LOCATION + &quot;-&quot; + mConfigEntity.END_LOCATION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -        Log.w(TAG, &quot;该下载不支持断点，即将重新下载&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -      conn = ConnectionHelp.setConnectParam(conn);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -      conn.setConnectTimeout(mConstance.CONNECT_TIME_OUT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -      conn.setReadTimeout(mConstance.READ_TIME_OUT);  //设置读取流的等待时间,必须设置该参数</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -      is = conn.getInputStream();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -      //创建可设置位置的文件</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -      RandomAccessFile file = new RandomAccessFile(mConfigEntity.TEMP_FILE, &quot;rwd&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -      //设置每条线程写入文件的位置</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -      file.seek(mConfigEntity.START_LOCATION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -      byte[] buffer = new byte[1024];</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -      int len;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -      //当前子线程的下载位置</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -      mChildCurrentLocation = mConfigEntity.START_LOCATION;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -      while ((len = is.read(buffer)) != -1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -        if (mConstance.isCancel) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -          break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -        if (mConstance.isStop) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -          Log.i(TAG, &quot;stop&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -          break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -        //把下载数据数据写入文件</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -        file.write(buffer, 0, len);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -        progress(len);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -      file.close();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -      //close 为阻塞的，需要使用线程池来处理</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -      is.close();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -      conn.disconnect();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -      if (mConstance.isCancel) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -        return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -      //停止状态不需要删除记录文件</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -      if (mConstance.isStop) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -        return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -      //支持断点的处理</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -      if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -        Log.i(TAG, &quot;线程【&quot; + mConfigEntity.THREAD_ID + &quot;】下载完毕&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        writeConfig(mConfigEntity.TEMP_FILE.getName() + &quot;_state_&quot; + mConfigEntity.THREAD_ID,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -            1 + &quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -        mListener.onChildComplete(mConfigEntity.END_LOCATION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -        mConstance.COMPLETE_THREAD_NUM++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -        if (mConstance.isComplete()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -          File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -          if (configFile.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -            configFile.delete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -          }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -          mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -          mListener.onComplete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -        Log.i(TAG, &quot;下载任务完成&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -        mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -        mListener.onComplete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -    } catch (MalformedURLException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -      mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -      failDownload(mConfigEntity, mChildCurrentLocation, &quot;下载链接异常&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -    } catch (IOException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -      mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -      failDownload(mConfigEntity, mChildCurrentLocation, &quot;下载失败【&quot; + mConfigEntity.DOWNLOAD_URL + &quot;】&quot;,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -          e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -    } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -      mConstance.FAIL_NUM++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -      failDownload(mConfigEntity, mChildCurrentLocation, &quot;获取流失败&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -   * 停止下载</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -  protected void stop() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -    synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -      try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -        if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -          mConstance.STOP_NUM++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -          String location = String.valueOf(mChildCurrentLocation);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -          Log.d(TAG, &quot;thread_&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -              + mConfigEntity.THREAD_ID</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -              + &quot;_stop, stop location ==&gt; &quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -              + mChildCurrentLocation);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -          writeConfig(mConfigEntity.TEMP_FILE.getName() + &quot;_record_&quot; + mConfigEntity.THREAD_ID,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -              location);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -          if (mConstance.isStop()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -            Log.d(TAG, &quot;++++++++++++++++ onStop +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -            mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -            mListener.onStop(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -          }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -          Log.d(TAG, &quot;++++++++++++++++ onStop +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -          mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -          mListener.onStop(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -      } catch (IOException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -        e.printStackTrace();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -   * 下载中</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -  private void progress(long len) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -    synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -      mChildCurrentLocation += len;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -      mConstance.CURRENT_LOCATION += len;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -      mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -  }</span>


























<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -   * 取消下载</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -  protected void cancel() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -    synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -      if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -        mConstance.CANCEL_NUM++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -        Log.d(TAG, &quot;++++++++++ thread_&quot; + mConfigEntity.THREAD_ID + &quot;_cancel ++++++++++&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -        if (mConstance.isCancel()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -          File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -          if (configFile.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -            configFile.delete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -          }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -          if (mConfigEntity.TEMP_FILE.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -            mConfigEntity.TEMP_FILE.delete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -          }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -          Log.d(TAG, &quot;++++++++++++++++ onCancel +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -          mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -          mListener.onCancel();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -        Log.d(TAG, &quot;++++++++++++++++ onCancel +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -        mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -        mListener.onCancel();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -   * 下载失败</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -  private void failDownload(DownloadUtil.ConfigEntity dEntity, long currentLocation, String msg,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -      Exception ex) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -    synchronized (LOCK) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -      try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -        mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -        mConstance.isStop = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -        if (ex != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -          Log.e(TAG, CommonUtil.getPrintException(ex));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -        if (mConfigEntity.isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -          if (currentLocation != -1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -            String location = String.valueOf(currentLocation);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -            writeConfig(dEntity.TEMP_FILE.getName() + &quot;_record_&quot; + dEntity.THREAD_ID, location);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -          }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -          if (mConstance.isFail()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -            Log.d(TAG, &quot;++++++++++++++++ onFail +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -            mListener.onFail();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -          }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -          Log.d(TAG, &quot;++++++++++++++++ onFail +++++++++++++++++&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -          mListener.onFail();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -      } catch (IOException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -        e.printStackTrace();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -   * 将记录写入到配置文件</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -  private void writeConfig(String key, String record) throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -    File configFile = new File(mConfigFPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -    Properties pro = CommonUtil.loadConfig(configFile);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -    pro.setProperty(key, record);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -    CommonUtil.saveConfig(configFile, pro);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -}</span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            