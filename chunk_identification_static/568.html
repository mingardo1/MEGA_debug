<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>568</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    568
                    <a href="567.html">prev</a>
                    <a href="569.html">next</a>
                    <a href="568_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_d3f904d1d764e0acb7127ddbeb050c2b3ff060b3_redis5/redis5-side/redis-all-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAllReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;d3f904d1d764e0acb7127ddbeb050c2b3ff060b3:redis5/redis5-side/redis-all-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAllReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;d3f904d1d764e0acb7127ddbeb050c2b3ff060b3^1:redis5/redis5-side/redis-all-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAllReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;d3f904d1d764e0acb7127ddbeb050c2b3ff060b3^2:redis5/redis5-side/redis-all-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAllReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;d124305ffe07b66f8eee430b3c0ac1072281dc14:redis5/redis5-side/redis-all-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAllReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [b], [b], [b], [j], [j]], subset: [[bj], [b], [b], [bj], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.redis;
  20 
  21 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22 import com.dtstack.flink.sql.side.BaseAllReqRow;
  23 import com.dtstack.flink.sql.side.FieldInfo;
  24 import com.dtstack.flink.sql.side.JoinInfo;
  25 import com.dtstack.flink.sql.side.*;
  26 import com.dtstack.flink.sql.side.redis.enums.RedisType;
  27 import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  28 import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  29 import com.esotericsoftware.minlog.Log;
  30 import org.apache.calcite.sql.JoinType;
  31 import org.apache.commons.collections.CollectionUtils;
  32 import org.apache.commons.collections.MapUtils;
  33 import org.apache.commons.lang.StringUtils;
  34 import org.apache.commons.pool2.impl.GenericObjectPoolConfig;
  35 import org.apache.flink.api.java.tuple.Tuple2;
  36 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  37 import org.apache.flink.types.Row;
  38 import org.apache.flink.util.Collector;
  39 import com.google.common.collect.Maps;
  40 import org.slf4j.Logger;
  41 import org.slf4j.LoggerFactory;
  42 import redis.clients.jedis.HostAndPort;
  43 import redis.clients.jedis.Jedis;
  44 import redis.clients.jedis.JedisCluster;
  45 import redis.clients.jedis.JedisCommands;
  46 import redis.clients.jedis.JedisPool;
  47 import redis.clients.jedis.JedisSentinelPool;
  48 
  49 import java.io.Closeable;
  50 import java.io.IOException;
  51 import java.sql.SQLException;
  52 
  53 import java.util.Calendar;
  54 import java.util.HashSet;
  55 import java.util.List;
  56 import java.util.Map;
  57 import java.util.Set;
  58 import java.util.TreeSet;
  59 import java.util.concurrent.atomic.AtomicReference;
  60 /**
  61  * @author yanxi
  62  */
  63 public class RedisAllReqRow extends BaseAllReqRow {
  64 
  65     private static final long serialVersionUID = 7578879189085344807L;
  66 
  67     private static final Logger LOG = LoggerFactory.getLogger(RedisAllReqRow.class);
  68 
  69     private static final int CONN_RETRY_NUM = 3;
  70 
  71     private JedisPool pool;
  72 
  73     private JedisSentinelPool jedisSentinelPool;
  74 
  75     private RedisSideTableInfo tableInfo;
  76 
  77     private AtomicReference&lt;Map&lt;String, Map&lt;String, String&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  78 
  79     private RedisSideReqRow redisSideReqRow;
  80 
<abbr title="  81     public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  81     public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, A🔵</abbr>
  82         super(new RedisAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  83         this.redisSideReqRow = new RedisSideReqRow(super.sideInfo);
  84     }
  85 
  86     @Override
  87     public Row fillData(Row input, Object sideInput) {
  88         return redisSideReqRow.fillData(input, sideInput);
  89     }
  90 
  91     @Override
  92     protected void initCache() throws SQLException {
  93         tableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  94         Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
  95         cacheRef.set(newCache);
  96         loadData(newCache);
  97     }
  98 
  99     @Override
 100     protected void reloadCache() {
 101         Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
 102         try {
 103             loadData(newCache);
 104         } catch (SQLException e) {
 105             LOG.error(&quot;&quot;, e);
 106         }
 107 
 108         cacheRef.set(newCache);
 109         LOG.info(&quot;----- Redis all cacheRef reload end:{}&quot;, Calendar.getInstance());
 110     }
 111 
 112     @Override
 113     public void flatMap(Tuple2&lt;Boolean,Row&gt; input, Collector&lt;Tuple2&lt;Boolean,Row&gt;&gt; out) throws Exception {
 114         Map&lt;String, String&gt; inputParams = Maps.newHashMap();
 115 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116         for(Integer conValIndex : sideInfo.getEqualValIndex()){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117             Object equalObj = input.f1.getField(conValIndex);</span>
 118 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119         for(Integer conValIndex : sideInfo.getEqualValIndex()){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120             Object equalObj = input.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122                 if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123                     Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124                     out.collect(new CRow(data, input.change()));</span>
 125 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128             Object equalObj = input.row().getField(conValIndex);</span>
 129 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 130             if(equalObj == null){
 131 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132                 if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133                     Row data = fillData(input.f1, null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134                     out.collect(Tuple2.of(input.f0,data));</span>
 135 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136                 if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137                     Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138                     out.collect(new CRow(data, input.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142             String columnName = sideInfo.getEqualFieldList().get(conValIndex);</span>
 143 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144                 if(sideInfo.getJoinType() == JoinType.LEFT){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145                     Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146                     out.collect(new CRow(data, input.change()));</span>
 147 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 148                 }
 149                 return;
 150             }
 151             inputParams.put(sideInfo.getEqualFieldList().get(i), equalObj.toString());
 152         }
 153 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154         String key = buildKey(inputParams);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156         Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158         if (cacheMap == null){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159             if(sideInfo.getJoinType() == JoinType.LEFT){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160                 Row data = fillData(input.f1, null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161                 out.collect(Tuple2.of(input.f0,data));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162             }else{</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165 </span>
 166 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         String key = buildKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169         Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         if (cacheMap == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172             if(sideInfo.getJoinType() == JoinType.LEFT){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173                 Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174                 out.collect(new CRow(data, input.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178 </span>
 179 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181         if(StringUtils.isBlank(key)){</span>
 182 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 183             return;
 184         }
 185 
 186 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187         Row newRow = fillData(input.f1, cacheMap);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188         out.collect(Tuple2.of(input.f0,newRow));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189 </span>
 190 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191             }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         Row newRow = fillData(input.row(), cacheMap);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199         out.collect(new CRow(newRow, input.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202     private String buildKey(Map&lt;String, String&gt; inputParams) {</span>
 203 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204         Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205         if(MapUtils.isEmpty(cacheMap)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206             if(sideInfo.getJoinType() != JoinType.LEFT){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209             Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210             out.collect(new CRow(data, input.change()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214         Row newRow = fillData(input.row(), cacheMap);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215         out.collect(new CRow(newRow, input.change()));</span>
 216 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 217     }
 218 
 219     private String buildCacheKey(Map&lt;String, String&gt; refData) {
 220         StringBuilder keyBuilder = new StringBuilder(tableInfo.getTableName());
 221         List&lt;String&gt; primaryKeys = tableInfo.getPrimaryKeys();
 222         for(String primaryKey : primaryKeys){
 223             if(!refData.containsKey(primaryKey)){
 224                 return null;
 225             }
 226             keyBuilder.append(&quot;_&quot;).append(refData.get(primaryKey));
 227         }
 228         return keyBuilder.toString();
 229     }
 230 
 231 
 232     private void loadData(Map&lt;String, Map&lt;String, String&gt;&gt; tmpCache) throws SQLException {
 233         JedisCommands jedis = null;
 234         try {
 235             StringBuilder keyPattern = new StringBuilder(tableInfo.getTableName());
 236             for(String key : tableInfo.getPrimaryKeys()){
 237                 keyPattern.append(&quot;_&quot;).append(&quot;*&quot;);
 238             };
 239             jedis = getJedisWithRetry(CONN_RETRY_NUM);
<abbr title=" 240             Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.toString());"> 240             Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.🔵</abbr>
 241             if(CollectionUtils.isEmpty(keys)){
 242                 return;
 243             }
 244             for(String key : keys){
 245                 tmpCache.put(key, jedis.hgetAll(key));
 246             }
 247         } catch (Exception e){
 248             LOG.error(&quot;&quot;, e);
 249         } finally {
 250             if (jedis != null){
 251                 try {
 252                     ((Closeable) jedis).close();
 253                 } catch (IOException e) {
 254                     Log.error(&quot;&quot;, e);
 255                 }
 256             }
 257             if (jedisSentinelPool != null) {
 258                 jedisSentinelPool.close();
 259             }
 260             if (pool != null) {
 261                 pool.close();
 262             }
 263         }
 264     }
 265 
 266     private JedisCommands getJedis(RedisSideTableInfo tableInfo) {
 267         String url = tableInfo.getUrl();
 268         String password = tableInfo.getPassword();
 269         String database = tableInfo.getDatabase() == null ? &quot;0&quot; : tableInfo.getDatabase();
 270         int timeout = tableInfo.getTimeout();
 271         if (timeout == 0){
 272             timeout = 1000;
 273         }
 274 
 275         String[] nodes = url.split(&quot;,&quot;);
 276         String[] firstIpPort = nodes[0].split(&quot;:&quot;);
 277         String firstIp = firstIpPort[0];
 278         String firstPort = firstIpPort[1];
 279         Set&lt;HostAndPort&gt; addresses = new HashSet&lt;&gt;();
 280         Set&lt;String&gt; ipPorts = new HashSet&lt;&gt;();
 281         for (String ipPort : nodes) {
 282             ipPorts.add(ipPort);
 283             String[] ipPortPair = ipPort.split(&quot;:&quot;);
 284             addresses.add(new HostAndPort(ipPortPair[0].trim(), Integer.valueOf(ipPortPair[1].trim())));
 285         }
 286         if (timeout == 0){
 287             timeout = 1000;
 288         }
 289         JedisCommands jedis = null;
<abbr title=" 290         GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(), tableInfo.getMinIdle());"> 290         GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(🔵</abbr>
 291         switch (RedisType.parse(tableInfo.getRedisType())){
 292             //单机
 293             case STANDALONE:
<abbr title=" 294                 pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password, Integer.parseInt(database));"> 294                 pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password,🔵</abbr>
 295                 jedis = pool.getResource();
 296                 break;
 297             //哨兵
 298             case SENTINEL:
<abbr title=" 299                 jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig, timeout, password, Integer.parseInt(database));"> 299                 jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig,🔵</abbr>
 300                 jedis = jedisSentinelPool.getResource();
 301                 break;
 302             //集群
 303             case CLUSTER:
 304                 jedis = new JedisCluster(addresses, timeout, timeout,1, poolConfig);
 305             default:
 306                 break;
 307         }
 308 
 309         return jedis;
 310     }
 311 
 312     private JedisCommands getJedisWithRetry(int retryNum) {
 313         while (retryNum-- &gt; 0){
 314             try {
 315                 return getJedis(tableInfo);
 316             } catch (Exception e) {
 317                 if(retryNum &lt;= 0){
 318                     throw new RuntimeException(&quot;getJedisWithRetry error&quot;, e);
 319                 }
 320                 try {
<abbr title=" 321                     String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,database:&quot; + tableInfo.getDatabase();"> 321                     String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + 🔵</abbr>
 322                     LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + jedisInfo);
 323                     Thread.sleep(5 * 1000);
 324                 } catch (InterruptedException e1) {
 325                     LOG.error(&quot;&quot;, e1);
 326                 }
 327             }
 328         }
 329         return null;
 330     }
 331 
 332     private Set&lt;String&gt; getRedisKeys(RedisType redisType, JedisCommands jedis, String keyPattern){
 333         if(!redisType.equals(RedisType.CLUSTER)){
 334             return ((Jedis) jedis).keys(keyPattern);
 335         }
 336         Set&lt;String&gt; keys = new TreeSet&lt;&gt;();
 337         Map&lt;String, JedisPool&gt; clusterNodes = ((JedisCluster)jedis).getClusterNodes();
 338         for(String k : clusterNodes.keySet()){
 339             JedisPool jp = clusterNodes.get(k);
 340             Jedis connection = jp.getResource();
 341             try {
 342                 keys.addAll(connection.keys(keyPattern));
 343             } catch (Exception e){
 344                 LOG.error(&quot;Getting keys error: {}&quot;, e);
 345             } finally {
 346                 connection.close();
 347             }
 348         }
 349         return keys;
 350     }
 351 
 352     private GenericObjectPoolConfig setPoolConfig(String maxTotal, String maxIdle, String minIdle){
 353         GenericObjectPoolConfig config = new GenericObjectPoolConfig();
 354         if (maxTotal != null){
 355             config.setMaxTotal(Integer.parseInt(maxTotal));
 356         }
 357         if (maxIdle != null){
 358             config.setMaxIdle(Integer.parseInt(maxIdle));
 359         }
 360         if (minIdle != null){
 361             config.setMinIdle(Integer.parseInt(minIdle));
 362         }
 363         return config;
 364     }
 365 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.redis;
  20 
  21 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22 import com.dtstack.flink.sql.side.BaseAllReqRow;
  23 import com.dtstack.flink.sql.side.FieldInfo;
  24 import com.dtstack.flink.sql.side.JoinInfo;
  25 import com.dtstack.flink.sql.side.*;
  26 import com.dtstack.flink.sql.side.redis.enums.RedisType;
  27 import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  28 import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  29 import com.esotericsoftware.minlog.Log;
  30 import org.apache.calcite.sql.JoinType;
  31 import org.apache.commons.collections.CollectionUtils;
  32 import org.apache.commons.collections.MapUtils;
  33 import org.apache.commons.lang.StringUtils;
  34 import org.apache.commons.pool2.impl.GenericObjectPoolConfig;
  35 import org.apache.flink.api.java.tuple.Tuple2;
  36 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  37 import org.apache.flink.types.Row;
  38 import org.apache.flink.util.Collector;
  39 import com.google.common.collect.Maps;
  40 import org.slf4j.Logger;
  41 import org.slf4j.LoggerFactory;
  42 import redis.clients.jedis.HostAndPort;
  43 import redis.clients.jedis.Jedis;
  44 import redis.clients.jedis.JedisCluster;
  45 import redis.clients.jedis.JedisCommands;
  46 import redis.clients.jedis.JedisPool;
  47 import redis.clients.jedis.JedisSentinelPool;
  48 
  49 import java.io.Closeable;
  50 import java.io.IOException;
  51 import java.sql.SQLException;
  52 
  53 import java.util.Calendar;
  54 import java.util.HashSet;
  55 import java.util.List;
  56 import java.util.Map;
  57 import java.util.Set;
  58 import java.util.TreeSet;
  59 import java.util.concurrent.atomic.AtomicReference;
  60 /**
  61  * @author yanxi
  62  */
  63 public class RedisAllReqRow extends BaseAllReqRow {
  64 
  65     private static final long serialVersionUID = 7578879189085344807L;
  66 
  67     private static final Logger LOG = LoggerFactory.getLogger(RedisAllReqRow.class);
  68 
  69     private static final int CONN_RETRY_NUM = 3;
  70 
  71     private JedisPool pool;
  72 
  73     private JedisSentinelPool jedisSentinelPool;
  74 
  75     private RedisSideTableInfo tableInfo;
  76 
  77     private AtomicReference&lt;Map&lt;String, Map&lt;String, String&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  78 
  79     private RedisSideReqRow redisSideReqRow;
  80 
<abbr title="  81     public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  81     public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, A🔵</abbr>
  82         super(new RedisAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  83         this.redisSideReqRow = new RedisSideReqRow(super.sideInfo);
  84     }
  85 
  86     @Override
  87     public Row fillData(Row input, Object sideInput) {
  88         return redisSideReqRow.fillData(input, sideInput);
  89     }
  90 
  91     @Override
  92     protected void initCache() throws SQLException {
  93         tableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  94         Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
  95         cacheRef.set(newCache);
  96         loadData(newCache);
  97     }
  98 
  99     @Override
 100     protected void reloadCache() {
 101         Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
 102         try {
 103             loadData(newCache);
 104         } catch (SQLException e) {
 105             LOG.error(&quot;&quot;, e);
 106         }
 107 
 108         cacheRef.set(newCache);
 109         LOG.info(&quot;----- Redis all cacheRef reload end:{}&quot;, Calendar.getInstance());
 110     }
 111 
 112     @Override
 113     public void flatMap(Tuple2&lt;Boolean,Row&gt; input, Collector&lt;Tuple2&lt;Boolean,Row&gt;&gt; out) throws Exception {
 114         Map&lt;String, String&gt; inputParams = Maps.newHashMap();
 115 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116         for(Integer conValIndex : sideInfo.getEqualValIndex()){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117             Object equalObj = input.f1.getField(conValIndex);</span>
 118 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119         for(Integer conValIndex : sideInfo.getEqualValIndex()){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120             Object equalObj = input.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121             if(equalObj == null){</span>
 122 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125             Object equalObj = input.row().getField(conValIndex);</span>
 126 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 127             if(equalObj == null){
 128                 if (sideInfo.getJoinType() == JoinType.LEFT) {
 129                     Row data = fillData(input.f1, null);
 130                     out.collect(Tuple2.of(input.f0,data));
 131                 }
 132                 return;
 133             }
 134             inputParams.put(sideInfo.getEqualFieldList().get(i), equalObj.toString());
 135         }
 136         String key = buildCacheKey(inputParams);
 137         if(StringUtils.isBlank(key)){
 138             return;
 139         }
 140 
 141         Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);
 142 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144         if (cacheMap == null){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145             if(sideInfo.getJoinType() == JoinType.LEFT){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146                 Row data = fillData(input.f1, null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147                 out.collect(Tuple2.of(input.f0,data));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148             }else{</span>
 149 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151         if (cacheMap == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152             if(sideInfo.getJoinType() == JoinType.LEFT){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153                 Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154                 out.collect(new CRow(data, input.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158 </span>
 159 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160         if(MapUtils.isEmpty(cacheMap)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161             if(sideInfo.getJoinType() != JoinType.LEFT){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164             Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165             out.collect(new CRow(data, input.change()));</span>
 166 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 167                 return;
 168 
 169         }
 170 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172         Row newRow = fillData(input.f1, cacheMap);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173         out.collect(Tuple2.of(input.f0,newRow));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174 </span>
 175 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         Row newRow = fillData(input.row(), cacheMap);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178         out.collect(new CRow(newRow, input.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179     }</span>
 180 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181         Row newRow = fillData(input.row(), cacheMap);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182         out.collect(new CRow(newRow, input.change()));</span>
 183 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 184     }
 185 
 186     private String buildCacheKey(Map&lt;String, String&gt; refData) {
 187         StringBuilder keyBuilder = new StringBuilder(tableInfo.getTableName());
 188         List&lt;String&gt; primaryKeys = tableInfo.getPrimaryKeys();
 189         for(String primaryKey : primaryKeys){
 190             if(!refData.containsKey(primaryKey)){
 191                 return null;
 192             }
 193             keyBuilder.append(&quot;_&quot;).append(refData.get(primaryKey));
 194         }
 195         return keyBuilder.toString();
 196     }
 197 
 198 
 199     private void loadData(Map&lt;String, Map&lt;String, String&gt;&gt; tmpCache) throws SQLException {
 200         JedisCommands jedis = null;
 201         try {
 202             StringBuilder keyPattern = new StringBuilder(tableInfo.getTableName());
 203             for(String key : tableInfo.getPrimaryKeys()){
 204                 keyPattern.append(&quot;_&quot;).append(&quot;*&quot;);
 205             };
 206             jedis = getJedisWithRetry(CONN_RETRY_NUM);
<abbr title=" 207             Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.toString());"> 207             Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.🔵</abbr>
 208             if(CollectionUtils.isEmpty(keys)){
 209                 return;
 210                     }
 211                 for (String key : keys){
 212                 tmpCache.put(key, jedis.hgetAll(key));
 213                 }
 214         } catch (Exception e){
 215             LOG.error(&quot;&quot;, e);
 216         } finally {
 217             if (jedis != null){
 218                 try {
 219                     ((Closeable) jedis).close();
 220                 } catch (IOException e) {
 221                     Log.error(&quot;&quot;, e);
 222                 }
 223             }
 224             if (jedisSentinelPool != null) {
 225                 jedisSentinelPool.close();
 226             }
 227             if (pool != null) {
 228                 pool.close();
 229             }
 230         }
 231     }
 232 
 233     private JedisCommands getJedis(RedisSideTableInfo tableInfo) {
 234         String url = tableInfo.getUrl();
 235         String password = tableInfo.getPassword();
 236         String database = tableInfo.getDatabase() == null ? &quot;0&quot; : tableInfo.getDatabase();
 237         int timeout = tableInfo.getTimeout();
 238         if (timeout == 0){
 239             timeout = 1000;
 240         }
 241 
 242         String[] nodes = url.split(&quot;,&quot;);
 243         String[] firstIpPort = nodes[0].split(&quot;:&quot;);
 244         String firstIp = firstIpPort[0];
 245         String firstPort = firstIpPort[1];
 246         Set&lt;HostAndPort&gt; addresses = new HashSet&lt;&gt;();
 247         Set&lt;String&gt; ipPorts = new HashSet&lt;&gt;();
 248         for (String ipPort : nodes) {
 249             ipPorts.add(ipPort);
 250             String[] ipPortPair = ipPort.split(&quot;:&quot;);
 251             addresses.add(new HostAndPort(ipPortPair[0].trim(), Integer.valueOf(ipPortPair[1].trim())));
 252         }
 253         if (timeout == 0){
 254             timeout = 1000;
 255         }
 256         JedisCommands jedis = null;
<abbr title=" 257         GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(), tableInfo.getMinIdle());"> 257         GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(🔵</abbr>
 258         switch (RedisType.parse(tableInfo.getRedisType())){
 259             //单机
 260             case STANDALONE:
<abbr title=" 261                 pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password, Integer.parseInt(database));"> 261                 pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password,🔵</abbr>
 262                 jedis = pool.getResource();
 263                 break;
 264             //哨兵
 265             case SENTINEL:
<abbr title=" 266                 jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig, timeout, password, Integer.parseInt(database));"> 266                 jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig,🔵</abbr>
 267                 jedis = jedisSentinelPool.getResource();
 268                 break;
 269             //集群
 270             case CLUSTER:
 271                 jedis = new JedisCluster(addresses, timeout, timeout, 1, poolConfig);
 272             default:
 273                 break;
 274         }
 275 
 276         return jedis;
 277     }
 278 
 279     private JedisCommands getJedisWithRetry(int retryNum) {
 280         while (retryNum-- &gt; 0){
 281             try {
 282                 return getJedis(tableInfo);
 283             } catch (Exception e) {
 284                 if(retryNum &lt;= 0){
 285                     throw new RuntimeException(&quot;getJedisWithRetry error&quot;, e);
 286                 }
 287                 try {
<abbr title=" 288                     String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,database:&quot; + tableInfo.getDatabase();"> 288                     String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + 🔵</abbr>
 289                     LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + jedisInfo);
 290                     Thread.sleep(5 * 1000);
 291                 } catch (InterruptedException e1) {
 292                     LOG.error(&quot;&quot;, e1);
 293                 }
 294             }
 295         }
 296         return null;
 297     }
 298 
 299     private Set&lt;String&gt; getRedisKeys(RedisType redisType, JedisCommands jedis, String keyPattern){
 300         if(!redisType.equals(RedisType.CLUSTER)){
 301             return ((Jedis) jedis).keys(keyPattern);
 302         }
 303         Set&lt;String&gt; keys = new TreeSet&lt;&gt;();
 304         Map&lt;String, JedisPool&gt; clusterNodes = ((JedisCluster)jedis).getClusterNodes();
 305         for(String k : clusterNodes.keySet()){
 306             JedisPool jp = clusterNodes.get(k);
 307             Jedis connection = jp.getResource();
 308             try {
 309                 keys.addAll(connection.keys(keyPattern));
 310             } catch (Exception e){
 311                 LOG.error(&quot;Getting keys error: {}&quot;, e);
 312             } finally {
 313                 connection.close();
 314             }
 315         }
 316         return keys;
 317     }
 318 
 319     private GenericObjectPoolConfig setPoolConfig(String maxTotal, String maxIdle, String minIdle){
 320         GenericObjectPoolConfig config = new GenericObjectPoolConfig();
 321         if (maxTotal != null){
 322             config.setMaxTotal(Integer.parseInt(maxTotal));
 323         }
 324         if (maxIdle != null){
 325             config.setMaxIdle(Integer.parseInt(maxIdle));
 326         }
 327         if (minIdle != null){
 328             config.setMinIdle(Integer.parseInt(minIdle));
 329         }
 330         return config;
 331     }
 332 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.redis;
  19 
  20 import com.dtstack.flink.sql.side.*;
  21 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22 import com.dtstack.flink.sql.side.BaseAllReqRow;
  23 import com.dtstack.flink.sql.side.FieldInfo;
  24 import com.dtstack.flink.sql.side.JoinInfo;
  25 import com.dtstack.flink.sql.side.redis.enums.RedisType;
  26 import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  27 import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  28 import com.esotericsoftware.minlog.Log;
  29 import com.google.common.collect.Maps;
  30 import java.io.Closeable;
  31 import java.io.IOException;
  32 import java.sql.SQLException;
  33 import java.util.Calendar;
  34 import java.util.HashSet;
  35 import java.util.List;
  36 import java.util.Map;
  37 import java.util.Set;
  38 import java.util.TreeSet;
  39 import java.util.concurrent.atomic.AtomicReference;
  40 import org.apache.calcite.sql.JoinType;
  41 import org.apache.commons.collections.CollectionUtils;
  42 import org.apache.commons.collections.MapUtils;
  43 import org.apache.commons.lang.StringUtils;
  44 import org.apache.commons.pool2.impl.GenericObjectPoolConfig;
  45 import org.apache.flink.api.java.tuple.Tuple2;
  46 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  47 import org.apache.flink.types.Row;
  48 import org.apache.flink.util.Collector;
  49 import org.slf4j.Logger;
  50 import org.slf4j.LoggerFactory;
  51 import redis.clients.jedis.HostAndPort;
  52 import redis.clients.jedis.Jedis;
  53 import redis.clients.jedis.JedisCluster;
  54 import redis.clients.jedis.JedisCommands;
  55 import redis.clients.jedis.JedisPool;
  56 import redis.clients.jedis.JedisSentinelPool;
  57 
  58 
  59 /**
  60  * @author yanxi
  61  */
  62 public class RedisAllReqRow extends BaseAllReqRow {
  63     private static final long serialVersionUID = 7578879189085344807L;
  64 
  65     private static final Logger LOG = LoggerFactory.getLogger(RedisAllReqRow.class);
  66 
  67     private static final int CONN_RETRY_NUM = 3;
  68 
  69     private JedisPool pool;
  70 
  71     private JedisSentinelPool jedisSentinelPool;
  72 
  73     private RedisSideTableInfo tableInfo;
  74 
  75     private AtomicReference&lt;Map&lt;String, Map&lt;String, String&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  76 
  77     private RedisSideReqRow redisSideReqRow;
  78 
<abbr title="  79     public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  79     public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, A🔵</abbr>
  80         super(new RedisAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  81         this.redisSideReqRow = new RedisSideReqRow(super.sideInfo);
  82     }
  83 
  84     @Override
  85     public Row fillData(Row input, Object sideInput) {
  86         return redisSideReqRow.fillData(input, sideInput);
  87     }
  88 
  89     @Override
  90     protected void initCache() throws SQLException {
  91         tableInfo = ((RedisSideTableInfo) (sideInfo.getSideTableInfo()));
  92         Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
  93         cacheRef.set(newCache);
  94         loadData(newCache);
  95     }
  96 
  97     @Override
  98     protected void reloadCache() {
  99         Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
 100         try {
 101             loadData(newCache);
 102         } catch (SQLException e) {
 103             LOG.error(&quot;&quot;, e);
 104         }
 105 
 106         cacheRef.set(newCache);
 107         LOG.info(&quot;----- Redis all cacheRef reload end:{}&quot;, Calendar.getInstance());
 108     }
 109 
 110     @Override
<abbr title=" 111     public void flatMap(Tuple2&lt;Boolean, Row&gt; input, Collector&lt;Tuple2&lt;Boolean, Row&gt;&gt; out) throws Exception {"> 111     public void flatMap(Tuple2&lt;Boolean, Row&gt; input, Collector&lt;Tuple2&lt;Boolean, Row&gt;&gt; out) throws Exception🔵</abbr>
 112         Map&lt;String, String&gt; inputParams = Maps.newHashMap();
 113         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {
 114             Integer conValIndex = sideInfo.getEqualValIndex().get(i);
 115             Object equalObj = input.f1.getField(conValIndex);
 116             if (equalObj == null) {
 117                 if (sideInfo.getJoinType() == JoinType.LEFT) {
 118                     Row data = fillData(input.f1, null);
 119                     out.collect(Tuple2.of(input.f0, data));
 120                 }
 121                 return;
 122             }
 123             inputParams.put(sideInfo.getEqualFieldList().get(i), equalObj.toString());
 124         }
 125         String key = buildCacheKey(inputParams);
 126         if (StringUtils.isBlank(key)) {
 127             return;
 128         }
 129         Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);
 130         if (MapUtils.isEmpty(cacheMap)) {
 131             if (sideInfo.getJoinType() != JoinType.LEFT) {
 132                 return;
 133             }
 134             Row data = fillData(input.f1, null);
 135             out.collect(Tuple2.of(input.f0, data));
 136             return;
 137         }
 138         Row newRow = fillData(input.f1, cacheMap);
 139         out.collect(Tuple2.of(input.f0, newRow));
 140     }
 141 
 142     private String buildCacheKey(Map&lt;String, String&gt; refData) {
 143         StringBuilder keyBuilder = new StringBuilder(tableInfo.getTableName());
 144         List&lt;String&gt; primaryKeys = tableInfo.getPrimaryKeys();
 145         for (String primaryKey : primaryKeys) {
 146             if (!refData.containsKey(primaryKey)) {
 147                 return null;
 148             }
 149             keyBuilder.append(&quot;_&quot;).append(refData.get(primaryKey));
 150         }
 151         return keyBuilder.toString();
 152     }
 153 
 154     private void loadData(Map&lt;String, Map&lt;String, String&gt;&gt; tmpCache) throws SQLException {
 155         JedisCommands jedis = null;
 156         try {
 157             StringBuilder keyPattern = new StringBuilder(tableInfo.getTableName());
 158             for (String key : tableInfo.getPrimaryKeys()) {
 159                 keyPattern.append(&quot;_&quot;).append(&quot;*&quot;);
 160             }
 161             jedis = getJedisWithRetry(CONN_RETRY_NUM);
<abbr title=" 162             Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.toString());"> 162             Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.🔵</abbr>
 163             if (CollectionUtils.isEmpty(keys)) {
 164                 return;
 165             }
 166             for (String key : keys) {
 167                 tmpCache.put(key, jedis.hgetAll(key));
 168             }
 169         } catch (java.lang.Exception e) {
 170             LOG.error(&quot;&quot;, e);
 171         } finally {
 172             if (jedis != null) {
 173                 try {
 174                     ((Closeable) (jedis)).close();
 175                 } catch (IOException e) {
 176                     Log.error(&quot;&quot;, e);
 177                 }
 178             }
 179             if (jedisSentinelPool != null) {
 180                 jedisSentinelPool.close();
 181             }
 182             if (pool != null) {
 183                 pool.close();
 184             }
 185         }
 186     }
 187 
 188     private JedisCommands getJedis(RedisSideTableInfo tableInfo) {
 189         String url = tableInfo.getUrl();
 190         String password = tableInfo.getPassword();
 191         String database = (tableInfo.getDatabase() == null) ? &quot;0&quot; : tableInfo.getDatabase();
 192         int timeout = tableInfo.getTimeout();
 193         if (timeout == 0) {
 194             timeout = 1000;
 195         }
 196         String[] nodes = url.split(&quot;,&quot;);
 197         String[] firstIpPort = nodes[0].split(&quot;:&quot;);
 198         String firstIp = firstIpPort[0];
 199         String firstPort = firstIpPort[1];
 200         Set&lt;HostAndPort&gt; addresses = new HashSet&lt;&gt;();
 201         Set&lt;String&gt; ipPorts = new HashSet&lt;&gt;();
 202         for (String ipPort : nodes) {
 203             ipPorts.add(ipPort);
 204             String[] ipPortPair = ipPort.split(&quot;:&quot;);
 205             addresses.add(new HostAndPort(ipPortPair[0].trim(), Integer.valueOf(ipPortPair[1].trim())));
 206         }
 207         if (timeout == 0) {
 208             timeout = 1000;
 209         }
 210         JedisCommands jedis = null;
<abbr title=" 211         GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(), tableInfo.getMinIdle());"> 211         GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(🔵</abbr>
 212         switch (RedisType.parse(tableInfo.getRedisType())) {
 213             //单机
 214             case STANDALONE :
<abbr title=" 215                 pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password, Integer.parseInt(database));"> 215                 pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password,🔵</abbr>
 216                 jedis = pool.getResource();
 217                 break;
 218             //哨兵
 219             case SENTINEL :
<abbr title=" 220                 jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig, timeout, password, Integer.parseInt(database));"> 220                 jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig,🔵</abbr>
 221                 jedis = jedisSentinelPool.getResource();
 222                 break;
 223             //集群
 224             case CLUSTER :
 225                 jedis = new JedisCluster(addresses, timeout, timeout, 1, poolConfig);
 226             default :
 227                 break;
 228         }
 229         return jedis;
 230     }
 231 
 232     private JedisCommands getJedisWithRetry(int retryNum) {
 233         while ((retryNum--) &gt; 0) {
 234             try {
 235                 return getJedis(tableInfo);
 236             } catch (java.lang.Exception e) {
 237                 if (retryNum &lt;= 0) {
 238                     throw new RuntimeException(&quot;getJedisWithRetry error&quot;, e);
 239                 }
 240                 try {
<abbr title=" 241                     String jedisInfo = ((((&quot;url:&quot; + tableInfo.getUrl()) + &quot;,pwd:&quot;) + tableInfo.getPassword()) + &quot;,database:&quot;) + tableInfo.getDatabase();"> 241                     String jedisInfo = ((((&quot;url:&quot; + tableInfo.getUrl()) + &quot;,pwd:&quot;) + tableInfo.getPasswor🔵</abbr>
 242                     LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + jedisInfo);
 243                     Thread.sleep(5 * 1000);
 244                 } catch (java.lang.InterruptedException e1) {
 245                     LOG.error(&quot;&quot;, e1);
 246                 }
 247             }
 248         }
 249         return null;
 250     }
 251 
 252     private Set&lt;String&gt; getRedisKeys(RedisType redisType, JedisCommands jedis, String keyPattern) {
 253         if (!redisType.equals(RedisType.CLUSTER)) {
 254             return ((Jedis) (jedis)).keys(keyPattern);
 255         }
 256         Set&lt;String&gt; keys = new TreeSet&lt;&gt;();
 257         Map&lt;String, JedisPool&gt; clusterNodes = ((JedisCluster) (jedis)).getClusterNodes();
 258         for (String k : clusterNodes.keySet()) {
 259             JedisPool jp = clusterNodes.get(k);
 260             Jedis connection = jp.getResource();
 261             try {
 262                 keys.addAll(connection.keys(keyPattern));
 263             } catch (java.lang.Exception e) {
 264                 LOG.error(&quot;Getting keys error: {}&quot;, e);
 265             } finally {
 266                 connection.close();
 267             }
 268         }
 269         return keys;
 270     }
 271 
 272     private GenericObjectPoolConfig setPoolConfig(String maxTotal, String maxIdle, String minIdle){
 273         GenericObjectPoolConfig config = new GenericObjectPoolConfig();
 274         if (maxTotal != null){
 275             config.setMaxTotal(Integer.parseInt(maxTotal));
 276         }
 277         if (maxIdle != null){
 278             config.setMaxIdle(Integer.parseInt(maxIdle));
 279         }
 280         if (minIdle != null){
 281             config.setMinIdle(Integer.parseInt(minIdle));
 282         }
 283         return config;
 284     }
 285 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.redis;
  20  
  21  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22  import com.dtstack.flink.sql.side.BaseAllReqRow;
  23  import com.dtstack.flink.sql.side.FieldInfo;
  24  import com.dtstack.flink.sql.side.JoinInfo;


  25  import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  26  import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  27  import com.esotericsoftware.minlog.Log;
  28  import com.google.common.collect.Maps;
  29  import org.apache.calcite.sql.JoinType;
  30  import org.apache.commons.lang3.StringUtils;



  31  import org.apache.commons.pool2.impl.GenericObjectPoolConfig;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import org.apache.flink.api.java.tuple.Tuple2;</span>
  33  import org.apache.flink.api.java.typeutils.RowTypeInfo;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import org.apache.flink.table.runtime.types.CRow;</span>
  35  import org.apache.flink.types.Row;
  36  import org.apache.flink.util.Collector;

  37  import org.slf4j.Logger;
  38  import org.slf4j.LoggerFactory;
  39  import redis.clients.jedis.HostAndPort;
  40  import redis.clients.jedis.Jedis;
  41  import redis.clients.jedis.JedisCluster;
  42  import redis.clients.jedis.JedisCommands;
  43  import redis.clients.jedis.JedisPool;
  44  import redis.clients.jedis.JedisSentinelPool;
  45  
  46  import java.io.Closeable;
  47  import java.io.IOException;
  48  import java.sql.SQLException;

  49  import java.util.Calendar;
  50  import java.util.HashSet;
  51  import java.util.LinkedList;
  52  import java.util.List;
  53  import java.util.Map;
  54  import java.util.Set;
  55  import java.util.TreeSet;
  56  import java.util.concurrent.atomic.AtomicReference;
  57  import java.util.stream.Collectors;
  58  /**
  59   * @author yanxi
  60   */
  61  public class RedisAllReqRow extends BaseAllReqRow {
  62  
  63      private static final long serialVersionUID = 7578879189085344807L;
  64  
  65      private static final Logger LOG = LoggerFactory.getLogger(RedisAllReqRow.class);
  66  
  67      private static final int CONN_RETRY_NUM = 3;
  68  
  69      private JedisPool pool;
  70  
  71      private JedisSentinelPool jedisSentinelPool;
  72  
  73      private RedisSideTableInfo tableInfo;
  74  
  75      private AtomicReference&lt;Map&lt;String, Map&lt;String, String&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  76  
  77      private RedisSideReqRow redisSideReqRow;
  78  
<abbr title="  79      public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  79      public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSi🔵</abbr>
  80          super(new RedisAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  81          this.redisSideReqRow = new RedisSideReqRow(super.sideInfo);
  82      }
  83  
  84      @Override
  85      public Row fillData(Row input, Object sideInput) {
  86          return redisSideReqRow.fillData(input, sideInput);
  87      }
  88  
  89      @Override
  90      protected void initCache() throws SQLException {
  91          tableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  92          Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
  93          cacheRef.set(newCache);
  94          loadData(newCache);
  95      }
  96  
  97      @Override
  98      protected void reloadCache() {
  99          Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
 100          try {
 101              loadData(newCache);
 102          } catch (SQLException e) {
 103              LOG.error(&quot;&quot;, e);
 104          }
 105  
 106          cacheRef.set(newCache);
 107          LOG.info(&quot;----- Redis all cacheRef reload end:{}&quot;, Calendar.getInstance());
 108      }
 109  
 110      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -    public void flatMap(CRow input, Collector&lt;CRow&gt; out) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +    public void flatMap(Tuple2&lt;Boolean,Row&gt; input, Collector&lt;Tuple2&lt;Boolean,Row&gt;&gt; out) throws Exception {</span>
 113          Map&lt;String, String&gt; inputParams = Maps.newHashMap();
 114          for(Integer conValIndex : sideInfo.getEqualValIndex()){


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -            Object equalObj = input.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +            Object equalObj = input.f1.getField(conValIndex);</span>
 117              if(equalObj == null){
 118                  if (sideInfo.getJoinType() == JoinType.LEFT) {

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -                    Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -                    out.collect(new CRow(data, input.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +                    Row data = fillData(input.f1, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +                    out.collect(Tuple2.of(input.f0,data));</span>
 123                  }
 124                  return;
 125              }
 126              String columnName = sideInfo.getEqualFieldList().get(conValIndex);
 127              inputParams.put(columnName, equalObj.toString());
 128          }
 129          String key = buildKey(inputParams);






 130  
 131          Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);
 132  
 133          if (cacheMap == null){
 134              if(sideInfo.getJoinType() == JoinType.LEFT){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -                Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -                out.collect(new CRow(data, input.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +                Row data = fillData(input.f1, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +                out.collect(Tuple2.of(input.f0,data));</span>
 139              }else{


 140                  return;
 141              }
 142  


 143              return;
 144          }
 145  


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -        Row newRow = fillData(input.row(), cacheMap);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -        out.collect(new CRow(newRow, input.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +        Row newRow = fillData(input.f1, cacheMap);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +        out.collect(Tuple2.of(input.f0,newRow));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +</span>
 151      }
 152  
 153      private String buildKey(Map&lt;String, String&gt; inputParams) {
 154          String tableName = tableInfo.getTableName();
 155          StringBuilder key = new StringBuilder();
 156          for (int i=0; i&lt;inputParams.size(); i++){
 157              key.append(tableName).append(&quot;:&quot;).append(inputParams.keySet().toArray()[i]).append(&quot;:&quot;)
 158                      .append(inputParams.get(inputParams.keySet().toArray()[i]));
 159          }
 160          return key.toString();
 161      }












 162  
 163      private void loadData(Map&lt;String, Map&lt;String, String&gt;&gt; tmpCache) throws SQLException {
 164          JedisCommands jedis = null;
 165  
 166          try {
 167              for(int i=0; i&lt;CONN_RETRY_NUM; i++){
 168  
 169                  try{
 170                      jedis = getJedis(tableInfo);
 171                      break;
 172                  }catch (Exception e){
 173                      if(i == CONN_RETRY_NUM - 1){
 174                          throw new RuntimeException(&quot;&quot;, e);
 175                      }
 176  
 177                      try {
<abbr title=" 178                          String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,database:&quot; + tableInfo.getDatabase();"> 178                          String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,dat🔵</abbr>
 179                          LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + jedisInfo);
 180                          Thread.sleep(5 * 1000);
 181                      } catch (InterruptedException e1) {
 182                          LOG.error(&quot;&quot;, e1);
 183                      }
 184                  }
 185              }
 186  
 187              if (tableInfo.getRedisType() != 3){
 188                  String perKey = tableInfo.getTableName() + &quot;*&quot;;
 189                  Set&lt;String&gt; keys = ((Jedis) jedis).keys(perKey);
 190                  List&lt;String&gt; newPerKeys = new LinkedList&lt;&gt;();
 191                  for (String key : keys){
 192                      String[] splitKey = StringUtils.split(key, &quot;:&quot;);
 193                      String newKey = splitKey[0] + &quot;:&quot; + splitKey[1] + &quot;:&quot; + splitKey[2];
 194                      newPerKeys.add(newKey);
 195                  }
 196                  List&lt;String&gt; list = newPerKeys.stream().distinct().collect(Collectors.toList());
 197                  for(String key : list){
 198                      Map&lt;String, String&gt; kv = Maps.newHashMap();
 199                      String[] primaryKv = StringUtils.split(key, &quot;:&quot;);
 200                      kv.put(primaryKv[1], primaryKv[2]);
 201                      String pattern = key + &quot;*&quot;;
 202                      Set&lt;String&gt; realKeys = ((Jedis) jedis).keys(pattern);
 203                      for (String realKey : realKeys){
 204                          kv.put(StringUtils.split(realKey, &quot;:&quot;)[3], jedis.get(realKey));
 205                      }
 206                      tmpCache.put(key, kv);
 207                  }
 208              } else {
 209                  String perKey = tableInfo.getTableName() + &quot;*&quot;;
 210                  Set&lt;String&gt; keys = keys((JedisCluster) jedis, perKey);
 211                  List&lt;String&gt; newPerKeys = new LinkedList&lt;&gt;();
 212                  for (String key : keys){
 213                      String[] splitKey = StringUtils.split(key, &quot;:&quot;);
 214                      String newKey = splitKey[0] + &quot;:&quot; + splitKey[1] + &quot;:&quot; + splitKey[2];
 215                      newPerKeys.add(newKey);
 216                  }
 217                  List&lt;String&gt; list = newPerKeys.stream().distinct().collect(Collectors.toList());
 218                  for(String key : list){
 219                      Map&lt;String, String&gt; kv = Maps.newHashMap();
 220                      String[] primaryKv = StringUtils.split(key, &quot;:&quot;);
 221                      kv.put(primaryKv[1], primaryKv[2]);
 222                      String pattern = key + &quot;*&quot;;
 223                      Set&lt;String&gt; realKeys = keys((JedisCluster) jedis, pattern);
 224                      for (String realKey : realKeys){
 225                          kv.put(StringUtils.split(key, &quot;:&quot;)[3], jedis.get(realKey));
 226                      }
 227                      tmpCache.put(key, kv);
 228                  }
 229              }
 230  
 231  












 232          } catch (Exception e){
 233              LOG.error(&quot;&quot;, e);
 234          } finally {
 235              if (jedis != null){
 236                  try {
 237                      ((Closeable) jedis).close();
 238                  } catch (IOException e) {
 239                      Log.error(&quot;&quot;, e);
 240                  }
 241              }
 242              if (jedisSentinelPool != null) {
 243                  jedisSentinelPool.close();
 244              }
 245              if (pool != null) {
 246                  pool.close();
 247              }
 248          }
 249      }
 250  
 251      private JedisCommands getJedis(RedisSideTableInfo tableInfo) {
 252          String url = tableInfo.getUrl();
 253          String password = tableInfo.getPassword();
 254          String database = tableInfo.getDatabase();

 255          int timeout = tableInfo.getTimeout();
 256          if (timeout == 0){
 257              timeout = 1000;
 258          }
 259  
 260          String[] nodes = StringUtils.split(url, &quot;,&quot;);
 261          String[] firstIpPort = StringUtils.split(nodes[0], &quot;:&quot;);


 262          String firstIp = firstIpPort[0];
 263          String firstPort = firstIpPort[1];
 264          Set&lt;HostAndPort&gt; addresses = new HashSet&lt;&gt;();
 265          Set&lt;String&gt; ipPorts = new HashSet&lt;&gt;();
 266          for (String ipPort : nodes) {
 267              ipPorts.add(ipPort);
 268              String[] ipPortPair = StringUtils.split(ipPort, &quot;:&quot;);

 269              addresses.add(new HostAndPort(ipPortPair[0].trim(), Integer.valueOf(ipPortPair[1].trim())));
 270          }
 271          if (timeout == 0){
 272              timeout = 1000;
 273          }
 274          JedisCommands jedis = null;
<abbr title=" 275          GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(), tableInfo.getMinIdle());"> 275          GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(), tableI🔵</abbr>
 276          switch (tableInfo.getRedisType()){

 277              //单机
 278              case 1:

<abbr title=" 279                  pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password, Integer.parseInt(database));"> 279                  pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password, Integer.🔵</abbr>
 280                  jedis = pool.getResource();
 281                  break;
 282              //哨兵
 283              case 2:

<abbr title=" 284                  jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig, timeout, password, Integer.parseInt(database));"> 284                  jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig, timeout,🔵</abbr>
 285                  jedis = jedisSentinelPool.getResource();
 286                  break;
 287              //集群
 288              case 3:
 289                  jedis = new JedisCluster(addresses, timeout, timeout, 1, poolConfig);


 290              default:

 291          }
 292  
 293          return jedis;
 294      }
 295  
 296      private Set&lt;String&gt; keys(JedisCluster jedisCluster, String pattern){
























 297          Set&lt;String&gt; keys = new TreeSet&lt;&gt;();
 298          Map&lt;String, JedisPool&gt; clusterNodes = jedisCluster.getClusterNodes();

 299          for(String k : clusterNodes.keySet()){
 300              JedisPool jp = clusterNodes.get(k);
 301              Jedis connection = jp.getResource();
 302              try {
 303                  keys.addAll(connection.keys(pattern));

 304              } catch (Exception e){
 305                  LOG.error(&quot;Getting keys error: {}&quot;, e);
 306              } finally {
 307                  connection.close();
 308              }
 309          }
 310          return keys;
 311      }
 312  
 313      private GenericObjectPoolConfig setPoolConfig(String maxTotal, String maxIdle, String minIdle){
 314          GenericObjectPoolConfig config = new GenericObjectPoolConfig();
 315          if (maxTotal != null){
 316              config.setMaxTotal(Integer.parseInt(maxTotal));
 317          }
 318          if (maxIdle != null){
 319              config.setMaxIdle(Integer.parseInt(maxIdle));
 320          }
 321          if (minIdle != null){
 322              config.setMinIdle(Integer.parseInt(minIdle));
 323          }
 324          return config;
 325      }
 326  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.redis;
  20  
  21  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22  import com.dtstack.flink.sql.side.BaseAllReqRow;
  23  import com.dtstack.flink.sql.side.FieldInfo;
  24  import com.dtstack.flink.sql.side.JoinInfo;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import com.dtstack.flink.sql.side.*;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import com.dtstack.flink.sql.side.redis.enums.RedisType;</span>
  27  import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  28  import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  29  import com.esotericsoftware.minlog.Log;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import com.google.common.collect.Maps;</span>
  31  import org.apache.calcite.sql.JoinType;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.apache.commons.collections.CollectionUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import org.apache.commons.collections.MapUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import org.apache.commons.lang.StringUtils;</span>
  36  import org.apache.commons.pool2.impl.GenericObjectPoolConfig;

  37  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  38  import org.apache.flink.table.runtime.types.CRow;
  39  import org.apache.flink.types.Row;
  40  import org.apache.flink.util.Collector;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import com.google.common.collect.Maps;</span>
  42  import org.slf4j.Logger;
  43  import org.slf4j.LoggerFactory;
  44  import redis.clients.jedis.HostAndPort;
  45  import redis.clients.jedis.Jedis;
  46  import redis.clients.jedis.JedisCluster;
  47  import redis.clients.jedis.JedisCommands;
  48  import redis.clients.jedis.JedisPool;
  49  import redis.clients.jedis.JedisSentinelPool;
  50  
  51  import java.io.Closeable;
  52  import java.io.IOException;
  53  import java.sql.SQLException;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +</span>
  55  import java.util.Calendar;
  56  import java.util.HashSet;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -import java.util.LinkedList;</span>
  58  import java.util.List;
  59  import java.util.Map;
  60  import java.util.Set;
  61  import java.util.TreeSet;
  62  import java.util.concurrent.atomic.AtomicReference;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -import java.util.stream.Collectors;</span>
  64  /**
  65   * @author yanxi
  66   */
  67  public class RedisAllReqRow extends BaseAllReqRow {
  68  
  69      private static final long serialVersionUID = 7578879189085344807L;
  70  
  71      private static final Logger LOG = LoggerFactory.getLogger(RedisAllReqRow.class);
  72  
  73      private static final int CONN_RETRY_NUM = 3;
  74  
  75      private JedisPool pool;
  76  
  77      private JedisSentinelPool jedisSentinelPool;
  78  
  79      private RedisSideTableInfo tableInfo;
  80  
  81      private AtomicReference&lt;Map&lt;String, Map&lt;String, String&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  82  
  83      private RedisSideReqRow redisSideReqRow;
  84  
<abbr title="  85      public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  85      public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSi🔵</abbr>
  86          super(new RedisAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  87          this.redisSideReqRow = new RedisSideReqRow(super.sideInfo);
  88      }
  89  
  90      @Override
  91      public Row fillData(Row input, Object sideInput) {
  92          return redisSideReqRow.fillData(input, sideInput);
  93      }
  94  
  95      @Override
  96      protected void initCache() throws SQLException {
  97          tableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  98          Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
  99          cacheRef.set(newCache);
 100          loadData(newCache);
 101      }
 102  
 103      @Override
 104      protected void reloadCache() {
 105          Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
 106          try {
 107              loadData(newCache);
 108          } catch (SQLException e) {
 109              LOG.error(&quot;&quot;, e);
 110          }
 111  
 112          cacheRef.set(newCache);
 113          LOG.info(&quot;----- Redis all cacheRef reload end:{}&quot;, Calendar.getInstance());
 114      }
 115  
 116      @Override
 117      public void flatMap(CRow input, Collector&lt;CRow&gt; out) throws Exception {

 118          Map&lt;String, String&gt; inputParams = Maps.newHashMap();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -        for(Integer conValIndex : sideInfo.getEqualValIndex()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +        for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +            Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
 122              Object equalObj = input.row().getField(conValIndex);

 123              if(equalObj == null){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -                if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +                if(sideInfo.getJoinType() == JoinType.LEFT){</span>
 126                      Row data = fillData(input.row(), null);
 127                      out.collect(new CRow(data, input.change()));


 128                  }
 129                  return;
 130              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -            String columnName = sideInfo.getEqualFieldList().get(conValIndex);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -            inputParams.put(columnName, equalObj.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -        String key = buildKey(inputParams);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +            inputParams.put(sideInfo.getEqualFieldList().get(i), equalObj.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +        String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +        if(StringUtils.isBlank(key)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +        }</span>
 141  
 142          Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -        if (cacheMap == null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -            if(sideInfo.getJoinType() == JoinType.LEFT){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -                Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -                out.collect(new CRow(data, input.change()));</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -            }else{</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +        if(MapUtils.isEmpty(cacheMap)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +            if(sideInfo.getJoinType() != JoinType.LEFT){</span>
 151                  return;
 152              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +            Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +            out.collect(new CRow(data, input.change()));</span>
 156              return;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +        }</span>
 161          Row newRow = fillData(input.row(), cacheMap);
 162          out.collect(new CRow(newRow, input.change()));



 163      }
 164  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -    private String buildKey(Map&lt;String, String&gt; inputParams) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -        String tableName = tableInfo.getTableName();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -        StringBuilder key = new StringBuilder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -        for (int i=0; i&lt;inputParams.size(); i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -            key.append(tableName).append(&quot;:&quot;).append(inputParams.keySet().toArray()[i]).append(&quot;:&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -                    .append(inputParams.get(inputParams.keySet().toArray()[i]));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -        return key.toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +    private String buildCacheKey(Map&lt;String, String&gt; refData) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +        StringBuilder keyBuilder = new StringBuilder(tableInfo.getTableName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +        List&lt;String&gt; primaryKeys = tableInfo.getPrimaryKeys();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +        for(String primaryKey : primaryKeys){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +            if(!refData.containsKey(primaryKey)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +                return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +            keyBuilder.append(&quot;_&quot;).append(refData.get(primaryKey));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +        return keyBuilder.toString();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +</span>
 186  
 187      private void loadData(Map&lt;String, Map&lt;String, String&gt;&gt; tmpCache) throws SQLException {
 188          JedisCommands jedis = null;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -</span>
 190          try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -            for(int i=0; i&lt;CONN_RETRY_NUM; i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -                try{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -                    jedis = getJedis(tableInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -                    break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -                }catch (Exception e){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -                    if(i == CONN_RETRY_NUM - 1){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -                        throw new RuntimeException(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -                    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 202 -                        String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,database:&quot; + tableInfo.getDatabase();"> 202 -                        String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,dat🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -                        LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + jedisInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -                        Thread.sleep(5 * 1000);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -                    } catch (InterruptedException e1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -                        LOG.error(&quot;&quot;, e1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -            if (tableInfo.getRedisType() != 3){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -                String perKey = tableInfo.getTableName() + &quot;*&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -                Set&lt;String&gt; keys = ((Jedis) jedis).keys(perKey);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -                List&lt;String&gt; newPerKeys = new LinkedList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -                for (String key : keys){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -                    String[] splitKey = StringUtils.split(key, &quot;:&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -                    String newKey = splitKey[0] + &quot;:&quot; + splitKey[1] + &quot;:&quot; + splitKey[2];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -                    newPerKeys.add(newKey);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -                List&lt;String&gt; list = newPerKeys.stream().distinct().collect(Collectors.toList());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -                for(String key : list){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -                    Map&lt;String, String&gt; kv = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -                    String[] primaryKv = StringUtils.split(key, &quot;:&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -                    kv.put(primaryKv[1], primaryKv[2]);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -                    String pattern = key + &quot;*&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -                    Set&lt;String&gt; realKeys = ((Jedis) jedis).keys(pattern);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -                    for (String realKey : realKeys){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -                        kv.put(StringUtils.split(realKey, &quot;:&quot;)[3], jedis.get(realKey));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -                    tmpCache.put(key, kv);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -                String perKey = tableInfo.getTableName() + &quot;*&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -                Set&lt;String&gt; keys = keys((JedisCluster) jedis, perKey);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -                List&lt;String&gt; newPerKeys = new LinkedList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -                for (String key : keys){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -                    String[] splitKey = StringUtils.split(key, &quot;:&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -                    String newKey = splitKey[0] + &quot;:&quot; + splitKey[1] + &quot;:&quot; + splitKey[2];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -                    newPerKeys.add(newKey);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -                List&lt;String&gt; list = newPerKeys.stream().distinct().collect(Collectors.toList());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -                for(String key : list){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -                    Map&lt;String, String&gt; kv = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -                    String[] primaryKv = StringUtils.split(key, &quot;:&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -                    kv.put(primaryKv[1], primaryKv[2]);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -                    String pattern = key + &quot;*&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -                    Set&lt;String&gt; realKeys = keys((JedisCluster) jedis, pattern);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -                    for (String realKey : realKeys){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -                        kv.put(StringUtils.split(key, &quot;:&quot;)[3], jedis.get(realKey));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -                    tmpCache.put(key, kv);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +            StringBuilder keyPattern = new StringBuilder(tableInfo.getTableName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +            for(String key : tableInfo.getPrimaryKeys()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +                keyPattern.append(&quot;_&quot;).append(&quot;*&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +            };</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +            jedis = getJedisWithRetry(CONN_RETRY_NUM);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 261 +            Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.toString());"> 261 +            Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.toString(🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +            if(CollectionUtils.isEmpty(keys)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +            for(String key : keys){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +                tmpCache.put(key, jedis.hgetAll(key));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +            }</span>
 268          } catch (Exception e){
 269              LOG.error(&quot;&quot;, e);
 270          } finally {
 271              if (jedis != null){
 272                  try {
 273                      ((Closeable) jedis).close();
 274                  } catch (IOException e) {
 275                      Log.error(&quot;&quot;, e);
 276                  }
 277              }
 278              if (jedisSentinelPool != null) {
 279                  jedisSentinelPool.close();
 280              }
 281              if (pool != null) {
 282                  pool.close();
 283              }
 284          }
 285      }
 286  
 287      private JedisCommands getJedis(RedisSideTableInfo tableInfo) {
 288          String url = tableInfo.getUrl();
 289          String password = tableInfo.getPassword();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -        String database = tableInfo.getDatabase();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +        String database = tableInfo.getDatabase() == null ? &quot;0&quot; : tableInfo.getDatabase();</span>
 292          int timeout = tableInfo.getTimeout();
 293          if (timeout == 0){
 294              timeout = 1000;
 295          }
 296  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -        String[] nodes = StringUtils.split(url, &quot;,&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -        String[] firstIpPort = StringUtils.split(nodes[0], &quot;:&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +        String[] nodes = url.split(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +        String[] firstIpPort = nodes[0].split(&quot;:&quot;);</span>
 301          String firstIp = firstIpPort[0];
 302          String firstPort = firstIpPort[1];
 303          Set&lt;HostAndPort&gt; addresses = new HashSet&lt;&gt;();
 304          Set&lt;String&gt; ipPorts = new HashSet&lt;&gt;();
 305          for (String ipPort : nodes) {
 306              ipPorts.add(ipPort);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -            String[] ipPortPair = StringUtils.split(ipPort, &quot;:&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +            String[] ipPortPair = ipPort.split(&quot;:&quot;);</span>
 309              addresses.add(new HostAndPort(ipPortPair[0].trim(), Integer.valueOf(ipPortPair[1].trim())));
 310          }
 311          if (timeout == 0){
 312              timeout = 1000;
 313          }
 314          JedisCommands jedis = null;
<abbr title=" 315          GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(), tableInfo.getMinIdle());"> 315          GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(), tableI🔵</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 316 -        switch (tableInfo.getRedisType()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +        switch (RedisType.parse(tableInfo.getRedisType())){</span>
 318              //单机
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 319 -            case 1:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +            case STANDALONE:</span>
<abbr title=" 321                  pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password, Integer.parseInt(database));"> 321                  pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password, Integer.🔵</abbr>
 322                  jedis = pool.getResource();
 323                  break;
 324              //哨兵
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 325 -            case 2:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +            case SENTINEL:</span>
<abbr title=" 327                  jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig, timeout, password, Integer.parseInt(database));"> 327                  jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig, timeout,🔵</abbr>
 328                  jedis = jedisSentinelPool.getResource();
 329                  break;
 330              //集群
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 331 -            case 3:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 332 -                jedis = new JedisCluster(addresses, timeout, timeout, 1, poolConfig);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +            case CLUSTER:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +                jedis = new JedisCluster(addresses, timeout, timeout,1, poolConfig);</span>
 335              default:
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +                break;</span>
 337          }
 338  
 339          return jedis;
 340      }
 341  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 342 -    private Set&lt;String&gt; keys(JedisCluster jedisCluster, String pattern){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +    private JedisCommands getJedisWithRetry(int retryNum) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +        while (retryNum-- &gt; 0){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +                return getJedis(tableInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +            } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +                if(retryNum &lt;= 0){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +                    throw new RuntimeException(&quot;getJedisWithRetry error&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +                try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 352 +                    String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,database:&quot; + tableInfo.getDatabase();"> 352 +                    String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,databas🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +                    LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + jedisInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +                    Thread.sleep(5 * 1000);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +                } catch (InterruptedException e1) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +                    LOG.error(&quot;&quot;, e1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +        return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +    private Set&lt;String&gt; getRedisKeys(RedisType redisType, JedisCommands jedis, String keyPattern){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +        if(!redisType.equals(RedisType.CLUSTER)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +            return ((Jedis) jedis).keys(keyPattern);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +        }</span>
 367          Set&lt;String&gt; keys = new TreeSet&lt;&gt;();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -        Map&lt;String, JedisPool&gt; clusterNodes = jedisCluster.getClusterNodes();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 369 +        Map&lt;String, JedisPool&gt; clusterNodes = ((JedisCluster)jedis).getClusterNodes();</span>
 370          for(String k : clusterNodes.keySet()){
 371              JedisPool jp = clusterNodes.get(k);
 372              Jedis connection = jp.getResource();
 373              try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -                keys.addAll(connection.keys(pattern));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 375 +                keys.addAll(connection.keys(keyPattern));</span>
 376              } catch (Exception e){
 377                  LOG.error(&quot;Getting keys error: {}&quot;, e);
 378              } finally {
 379                  connection.close();
 380              }
 381          }
 382          return keys;
 383      }
 384  
 385      private GenericObjectPoolConfig setPoolConfig(String maxTotal, String maxIdle, String minIdle){
 386          GenericObjectPoolConfig config = new GenericObjectPoolConfig();
 387          if (maxTotal != null){
 388              config.setMaxTotal(Integer.parseInt(maxTotal));
 389          }
 390          if (maxIdle != null){
 391              config.setMaxIdle(Integer.parseInt(maxIdle));
 392          }
 393          if (minIdle != null){
 394              config.setMinIdle(Integer.parseInt(minIdle));
 395          }
 396          return config;
 397      }
 398  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            