<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>568</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    568
                    <a href="567.html">prev</a>
                    <a href="569.html">next</a>
                    <a href="568_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    GoogleCloudPlatform/bank-of-anthos_81c24e270353b7c3a7ffed1bb136e3fb3f242e64_src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;81c24e270353b7c3a7ffed1bb136e3fb3f242e64:src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;81c24e270353b7c3a7ffed1bb136e3fb3f242e64^1:src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;81c24e270353b7c3a7ffed1bb136e3fb3f242e64^2:src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;81724995a60501bba8cbc9eddcb397993965d78a:src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [bsj]], subset: [[b], [bsj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2  * Copyright 2020, Google LLC.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15  */                                                                                                      </span>
<span  style="">  16                                                                                                          </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  17 package anthos.samples.financedemo.ledgerwriter;                                                         </span>
<span  style="">  18                                                                                                          </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">  19 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="-6356287537734540725" onmouseenter="enter('-6356287537734540725');" onmouseout="out('-6356287537734540725');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 import java.util.concurrent.TimeUnit;                                                                    </span>
<span class="3887843854525453733" onmouseenter="enter('3887843854525453733');" onmouseout="out('3887843854525453733');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import java.util.logging.Logger;                                                                         </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22                                                                                                          </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style="">  23 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="3887843854525453733" onmouseenter="enter('3887843854525453733');" onmouseout="out('3887843854525453733');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import java.util.logging.Logger;                                                                         </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25                                                                                                          </span>
<span class="3248634983943737307" onmouseenter="enter('3248634983943737307');" onmouseout="out('3248634983943737307');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import  org.springframework.web.client.HttpServerErrorException;                                         </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  27 =======                                                                                                  </span>
<span class="-538473715904851717" onmouseenter="enter('-538473715904851717');" onmouseout="out('-538473715904851717');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import org.apache.logging.log4j.LogManager;                                                              </span>
<span class="2283937394492695819" onmouseenter="enter('2283937394492695819');" onmouseout="out('2283937394492695819');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import org.apache.logging.log4j.Logger;                                                                  </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style="">  30 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="3248634983943737307" onmouseenter="enter('3248634983943737307');" onmouseout="out('3248634983943737307');" style="">  31 import  org.springframework.web.client.HttpServerErrorException;                                         </span>
<span  style="">  32                                                                                                          </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  33 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  34 import org.springframework.http.HttpEntity;                                                              </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  35 import org.springframework.http.HttpHeaders;                                                             </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  36 import org.springframework.http.HttpMethod;                                                              </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  37 import org.springframework.http.HttpStatus;                                                              </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  38 import org.springframework.http.ResponseEntity;                                                          </span>
<span class="5341219335560996028" onmouseenter="enter('5341219335560996028');" onmouseout="out('5341219335560996028');" style="">  39 import org.springframework.transaction.CannotCreateTransactionException;                                 </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  40 import org.springframework.web.bind.annotation.GetMapping;                                               </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  41 import org.springframework.web.bind.annotation.PostMapping;                                              </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  42 import org.springframework.web.bind.annotation.RequestBody;                                              </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  43 import org.springframework.web.bind.annotation.RequestHeader;                                            </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  44 import org.springframework.web.bind.annotation.ResponseStatus;                                           </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  45 import org.springframework.web.bind.annotation.RestController;                                           </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="">  46 import org.springframework.web.client.ResourceAccessException;                                           </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  47 import org.springframework.web.client.RestTemplate;                                                      </span>
<span  style="">  48                                                                                                          </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  49 import com.auth0.jwt.JWTVerifier;                                                                        </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  50 import com.auth0.jwt.exceptions.JWTVerificationException;                                                </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  51 import com.auth0.jwt.interfaces.DecodedJWT;                                                              </span>
<span  style="">  52                                                                                                          </span>
<span  style="">  53                                                                                                          </span>
<span class="8064918626260915349" onmouseenter="enter('8064918626260915349');" onmouseout="out('8064918626260915349');" style="">  54 import com.google.common.cache.Cache;                                                                    </span>
<span class="-5185947672099267182" onmouseenter="enter('-5185947672099267182');" onmouseout="out('-5185947672099267182');" style="">  55 import com.google.common.cache.CacheBuilder;                                                             </span>
<span  style="">  56                                                                                                          </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="">  57 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                 </span>
<span class="5485927036637514847" onmouseenter="enter('5485927036637514847');" onmouseout="out('5485927036637514847');" style="">  58         EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE;                                                          </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="">  59 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                 </span>
<span class="-8362488606383815534" onmouseenter="enter('-8362488606383815534');" onmouseout="out('-8362488606383815534');" style="">  60         EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL;                                                </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="">  61 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                 </span>
<span class="4868142399698679402" onmouseenter="enter('4868142399698679402');" onmouseout="out('4868142399698679402');" style="">  62         EXCEPTION_MESSAGE_DUPLICATE_TRANSACTION;                                                         </span>
<span  style="">  63                                                                                                          </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  64 @RestController                                                                                          </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  65 public final class LedgerWriterController {                                                              </span>
<span  style="">  66                                                                                                          </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="">  67     private static final Logger LOGGER =                                                                 </span>
<span class="999928017189038216" onmouseenter="enter('999928017189038216');" onmouseout="out('999928017189038216');" style="">  68         LogManager.getLogger(LedgerWriterController.class);                                              </span>
<span  style="">  69                                                                                                          </span>
<span class="-728019112929028725" onmouseenter="enter('-728019112929028725');" onmouseout="out('-728019112929028725');" style="">  70     private TransactionRepository transactionRepository;                                                 </span>
<span class="-4578700528226723750" onmouseenter="enter('-4578700528226723750');" onmouseout="out('-4578700528226723750');" style="">  71     private TransactionValidator transactionValidator;                                                   </span>
<span class="-5049251535661215052" onmouseenter="enter('-5049251535661215052');" onmouseout="out('-5049251535661215052');" style="">  72     private JWTVerifier verifier;                                                                        </span>
<span  style="">  73                                                                                                          </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="">  74     private String localRoutingNum;                                                                      </span>
<span class="-469486944919448386" onmouseenter="enter('-469486944919448386');" onmouseout="out('-469486944919448386');" style="">  75     private String balancesApiUri;                                                                       </span>
<span class="6148824265517010025" onmouseenter="enter('6148824265517010025');" onmouseout="out('6148824265517010025');" style="">  76     private String version;                                                                              </span>
<span  style="">  77                                                                                                          </span>
<span class="998797035934579942" onmouseenter="enter('998797035934579942');" onmouseout="out('998797035934579942');" style="">  78     private Cache&lt;String, Long&gt; cache;                                                                   </span>
<span  style="">  79                                                                                                          </span>
<span class="-6505034648581184544" onmouseenter="enter('-6505034648581184544');" onmouseout="out('-6505034648581184544');" style="">  80     public static final String READINESS_CODE = &quot;ok&quot;;                                                    </span>
<span class="-9149089262416743429" onmouseenter="enter('-9149089262416743429');" onmouseout="out('-9149089262416743429');" style="">  81     public static final String UNAUTHORIZED_CODE = &quot;not authorized&quot;;                                     </span>
<span class="6290000176908202808" onmouseenter="enter('6290000176908202808');" onmouseout="out('6290000176908202808');" style="">  82     public static final String JWT_ACCOUNT_KEY = &quot;acct&quot;;                                                 </span>
<span  style="">  83                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  84     /**                                                                                                  </span>
<span class="-1436741038288612910" onmouseenter="enter('-1436741038288612910');" onmouseout="out('-1436741038288612910');" style="">  85     * Constructor.                                                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  86     *                                                                                                    </span>
<span class="-5348532432243399187" onmouseenter="enter('-5348532432243399187');" onmouseout="out('-5348532432243399187');" style="">  87     * Initializes JWT verifier.                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  88     */                                                                                                   </span>
<span  style="">  89                                                                                                          </span>
<span class="8937474768837710123" onmouseenter="enter('8937474768837710123');" onmouseout="out('8937474768837710123');" style="">  90     public LedgerWriterController(                                                                       </span>
<span class="2780303771851218368" onmouseenter="enter('2780303771851218368');" onmouseout="out('2780303771851218368');" style="">  91             JWTVerifier verifier,                                                                        </span>
<span class="1132068715177995291" onmouseenter="enter('1132068715177995291');" onmouseout="out('1132068715177995291');" style="">  92             TransactionRepository transactionRepository,                                                 </span>
<span class="5479269793478582431" onmouseenter="enter('5479269793478582431');" onmouseout="out('5479269793478582431');" style="">  93             TransactionValidator transactionValidator,                                                   </span>
<span class="-822564396537268339" onmouseenter="enter('-822564396537268339');" onmouseout="out('-822564396537268339');" style="">  94             @Value(&quot;${LOCAL_ROUTING_NUM}&quot;) String localRoutingNum,                                       </span>
<span class="-2250521274199702466" onmouseenter="enter('-2250521274199702466');" onmouseout="out('-2250521274199702466');" style="">  95             @Value(&quot;http://${BALANCES_API_ADDR}/balances&quot;)                                               </span>
<span class="5760341242560825698" onmouseenter="enter('5760341242560825698');" onmouseout="out('5760341242560825698');" style="">  96                     String balancesApiUri,                                                               </span>
<span class="3727660980762547349" onmouseenter="enter('3727660980762547349');" onmouseout="out('3727660980762547349');" style="">  97             @Value(&quot;${VERSION}&quot;) String version) {                                                       </span>
<span class="2791682847397564046" onmouseenter="enter('2791682847397564046');" onmouseout="out('2791682847397564046');" style="">  98         this.verifier = verifier;                                                                        </span>
<span class="5620916918385755227" onmouseenter="enter('5620916918385755227');" onmouseout="out('5620916918385755227');" style="">  99         this.transactionRepository = transactionRepository;                                              </span>
<span class="7194621662788445012" onmouseenter="enter('7194621662788445012');" onmouseout="out('7194621662788445012');" style=""> 100         this.transactionValidator = transactionValidator;                                                </span>
<span class="5248812605098956146" onmouseenter="enter('5248812605098956146');" onmouseout="out('5248812605098956146');" style=""> 101         this.localRoutingNum = localRoutingNum;                                                          </span>
<span class="-1729773563907748731" onmouseenter="enter('-1729773563907748731');" onmouseout="out('-1729773563907748731');" style=""> 102         this.balancesApiUri = balancesApiUri;                                                            </span>
<span class="8734022701570323791" onmouseenter="enter('8734022701570323791');" onmouseout="out('8734022701570323791');" style=""> 103         this.version = version;                                                                          </span>
<span class="8244837015881776783" onmouseenter="enter('8244837015881776783');" onmouseout="out('8244837015881776783');" style=""> 104         // Initialize cache to ignore duplicate transactions                                             </span>
<span class="-1757741908889032370" onmouseenter="enter('-1757741908889032370');" onmouseout="out('-1757741908889032370');" style=""> 105         this.cache = CacheBuilder.newBuilder()                                                           </span>
<span class="8658036842979585808" onmouseenter="enter('8658036842979585808');" onmouseout="out('8658036842979585808');" style=""> 106                             .expireAfterWrite(1, TimeUnit.HOURS)                                         </span>
<span class="-368814941510255410" onmouseenter="enter('-368814941510255410');" onmouseout="out('-368814941510255410');" style=""> 107                             .build();                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 108     }                                                                                                    </span>
<span  style=""> 109                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 110     /**                                                                                                  </span>
<span class="559132540195676827" onmouseenter="enter('559132540195676827');" onmouseout="out('559132540195676827');" style=""> 111      * Version endpoint.                                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 112      *                                                                                                   </span>
<span class="-3837725526160323045" onmouseenter="enter('-3837725526160323045');" onmouseout="out('-3837725526160323045');" style=""> 113      * @return  service version string                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 114      */                                                                                                  </span>
<span class="6685475051439146687" onmouseenter="enter('6685475051439146687');" onmouseout="out('6685475051439146687');" style=""> 115     @GetMapping(&quot;/version&quot;)                                                                              </span>
<span class="580444279607563843" onmouseenter="enter('580444279607563843');" onmouseout="out('580444279607563843');" style=""> 116     public ResponseEntity version() {                                                                    </span>
<span class="5343850267959959664" onmouseenter="enter('5343850267959959664');" onmouseout="out('5343850267959959664');" style=""> 117         return new ResponseEntity&lt;String&gt;(version, HttpStatus.OK);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 118     }                                                                                                    </span>
<span  style=""> 119                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 120     /**                                                                                                  </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style=""> 121      * Readiness probe endpoint.                                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 122      *                                                                                                   </span>
<span class="8463518254556868911" onmouseenter="enter('8463518254556868911');" onmouseout="out('8463518254556868911');" style=""> 123      * @return HTTP Status 200 if server is ready to receive requests.                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 124      */                                                                                                  </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style=""> 125     @GetMapping(&quot;/ready&quot;)                                                                                </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 126     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="7271346341917529010" onmouseenter="enter('7271346341917529010');" onmouseout="out('7271346341917529010');" style=""> 127     public ResponseEntity&lt;String&gt; readiness() {                                                          </span>
<span class="-4075762798656461919" onmouseenter="enter('-4075762798656461919');" onmouseout="out('-4075762798656461919');" style=""> 128         return new ResponseEntity&lt;String&gt;(READINESS_CODE, HttpStatus.OK);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 129     }                                                                                                    </span>
<span  style=""> 130                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 131     /**                                                                                                  </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style=""> 132      * Submit a new transaction to the ledger.                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 133      *                                                                                                   </span>
<span class="-1661212859137511783" onmouseenter="enter('-1661212859137511783');" onmouseout="out('-1661212859137511783');" style=""> 134      * @param bearerToken  HTTP request &#x27;Authorization&#x27; header                                           </span>
<span class="5399615509278749127" onmouseenter="enter('5399615509278749127');" onmouseout="out('5399615509278749127');" style=""> 135      * @param transaction  transaction to submit                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 136      *                                                                                                   </span>
<span class="7486646966745340100" onmouseenter="enter('7486646966745340100');" onmouseout="out('7486646966745340100');" style=""> 137      * @return  HTTP Status 200 if transaction was successfully submitted                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 138      */                                                                                                  </span>
<span class="5323932416516552401" onmouseenter="enter('5323932416516552401');" onmouseout="out('5323932416516552401');" style=""> 139     @PostMapping(value = &quot;/transactions&quot;, consumes = &quot;application/json&quot;)                                 </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 140     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="1897907323625472935" onmouseenter="enter('1897907323625472935');" onmouseout="out('1897907323625472935');" style=""> 141     public ResponseEntity&lt;?&gt; addTransaction(                                                             </span>
<span class="1166903297081280981" onmouseenter="enter('1166903297081280981');" onmouseout="out('1166903297081280981');" style=""> 142             @RequestHeader(&quot;Authorization&quot;) String bearerToken,                                          </span>
<span class="9022696444049056102" onmouseenter="enter('9022696444049056102');" onmouseout="out('9022696444049056102');" style=""> 143             @RequestBody Transaction transaction) {                                                      </span>
<span class="-3538581758087352701" onmouseenter="enter('-3538581758087352701');" onmouseout="out('-3538581758087352701');" style=""> 144         if (bearerToken != null &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                  </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 145             bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 146         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 147         try {                                                                                            </span>
<span class="-4457463381546497224" onmouseenter="enter('-4457463381546497224');" onmouseout="out('-4457463381546497224');" style=""> 148             if (bearerToken == null) {                                                                   </span>
<span class="8471284381161989921" onmouseenter="enter('8471284381161989921');" onmouseout="out('8471284381161989921');" style=""> 149                 LOGGER.error(&quot;Transaction submission failed: &quot;                                           </span>
<span class="-6310070690167802414" onmouseenter="enter('-6310070690167802414');" onmouseout="out('-6310070690167802414');" style=""> 150                     + &quot;Authorization header null&quot;);                                                      </span>
<span class="-5454936540258631376" onmouseenter="enter('-5454936540258631376');" onmouseout="out('-5454936540258631376');" style=""> 151                 throw new IllegalArgumentException(                                                      </span>
<span class="-4688472594501119643" onmouseenter="enter('-4688472594501119643');" onmouseout="out('-4688472594501119643');" style=""> 152                         EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 153             }                                                                                            </span>
<span class="-5768910099284843906" onmouseenter="enter('-5768910099284843906');" onmouseout="out('-5768910099284843906');" style=""> 154             final DecodedJWT jwt = this.verifier.verify(bearerToken);                                    </span>
<span  style=""> 155                                                                                                          </span>
<span class="-7357029865885638695" onmouseenter="enter('-7357029865885638695');" onmouseout="out('-7357029865885638695');" style=""> 156             // Check against cache for duplicate transactions                                            </span>
<span class="-7254451175943600487" onmouseenter="enter('-7254451175943600487');" onmouseout="out('-7254451175943600487');" style=""> 157             if (this.cache.asMap().containsKey(transaction.getRequestUuid())) {                          </span>
<span class="-8046945014218387655" onmouseenter="enter('-8046945014218387655');" onmouseout="out('-8046945014218387655');" style=""> 158                 throw new IllegalStateException(                                                         </span>
<span class="5344096214519321268" onmouseenter="enter('5344096214519321268');" onmouseout="out('5344096214519321268');" style=""> 159                         EXCEPTION_MESSAGE_DUPLICATE_TRANSACTION);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 160             }                                                                                            </span>
<span  style=""> 161                                                                                                          </span>
<span class="-6962791519859020761" onmouseenter="enter('-6962791519859020761');" onmouseout="out('-6962791519859020761');" style=""> 162             // validate transaction                                                                      </span>
<span class="776637986685870327" onmouseenter="enter('776637986685870327');" onmouseout="out('776637986685870327');" style=""> 163             transactionValidator.validateTransaction(localRoutingNum,                                    </span>
<span class="-4879758647615452357" onmouseenter="enter('-4879758647615452357');" onmouseout="out('-4879758647615452357');" style=""> 164                     jwt.getClaim(JWT_ACCOUNT_KEY).asString(), transaction);                              </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style=""> 165             // Ensure sender balance can cover transaction.                                              </span>
<span class="-6144219964793655128" onmouseenter="enter('-6144219964793655128');" onmouseout="out('-6144219964793655128');" style=""> 166             if (transaction.getFromRoutingNum().equals(localRoutingNum)) {                               </span>
<span class="7239735847198029864" onmouseenter="enter('7239735847198029864');" onmouseout="out('7239735847198029864');" style=""> 167                 int balance = getAvailableBalance(                                                       </span>
<span class="7702083458280016025" onmouseenter="enter('7702083458280016025');" onmouseout="out('7702083458280016025');" style=""> 168                         bearerToken, transaction.getFromAccountNum());                                   </span>
<span class="-8424323426889164999" onmouseenter="enter('-8424323426889164999');" onmouseout="out('-8424323426889164999');" style=""> 169                 if (balance &lt; transaction.getAmount()) {                                                 </span>
<span class="8471284381161989921" onmouseenter="enter('8471284381161989921');" onmouseout="out('8471284381161989921');" style=""> 170                     LOGGER.error(&quot;Transaction submission failed: &quot;                                       </span>
<span class="2606405075138145997" onmouseenter="enter('2606405075138145997');" onmouseout="out('2606405075138145997');" style=""> 171                         + &quot;Insufficient balance&quot;);                                                       </span>
<span class="-8046945014218387655" onmouseenter="enter('-8046945014218387655');" onmouseout="out('-8046945014218387655');" style=""> 172                     throw new IllegalStateException(                                                     </span>
<span class="-5146115328615515543" onmouseenter="enter('-5146115328615515543');" onmouseout="out('-5146115328615515543');" style=""> 173                             EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE);                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 174                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 175             }                                                                                            </span>
<span  style=""> 176                                                                                                          </span>
<span class="-3539745766511737220" onmouseenter="enter('-3539745766511737220');" onmouseout="out('-3539745766511737220');" style=""> 177             // No exceptions thrown. Add to ledger                                                       </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style=""> 178             transactionRepository.save(transaction);                                                     </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 179 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="-2122798952495658084" onmouseenter="enter('-2122798952495658084');" onmouseout="out('-2122798952495658084');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180             this.cache.put(transaction.getRequestUuid(),                                                 </span>
<span class="-2743452731222378684" onmouseenter="enter('-2743452731222378684');" onmouseout="out('-2743452731222378684');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181                     transaction.getTransactionId());                                                     </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 182 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183                                                                                                          </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184         } catch (JWTVerificationException e) {                                                           </span>
<span class="-4154758301555607236" onmouseenter="enter('-4154758301555607236');" onmouseout="out('-4154758301555607236');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185             return new ResponseEntity&lt;String&gt;(UNAUTHORIZED_CODE,                                         </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186                                               HttpStatus.UNAUTHORIZED);                                  </span>
<span class="-16261657306661328" onmouseenter="enter('-16261657306661328');" onmouseout="out('-16261657306661328');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         } catch (IllegalArgumentException | IllegalStateException e) {                                   </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188             return new ResponseEntity&lt;String&gt;(e.getMessage(),                                            </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                                               HttpStatus.BAD_REQUEST);                                   </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190         } catch (ResourceAccessException                                                                 </span>
<span class="7920423166678117814" onmouseenter="enter('7920423166678117814');" onmouseout="out('7920423166678117814');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                 | CannotCreateTransactionException                                                       </span>
<span class="-7265908382255363783" onmouseenter="enter('-7265908382255363783');" onmouseout="out('-7265908382255363783');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                 | HttpServerErrorException e) {                                                          </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193             return new ResponseEntity&lt;String&gt;(e.getMessage(),                                            </span>
<span class="862392687202373996" onmouseenter="enter('862392687202373996');" onmouseout="out('862392687202373996');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                                               HttpStatus.INTERNAL_SERVER_ERROR);                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198     /**                                                                                                  </span>
<span class="-840803106370353754" onmouseenter="enter('-840803106370353754');" onmouseout="out('-840803106370353754');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199      * Retrieve the balance for the transaction&#x27;s sender.                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200      *                                                                                                   </span>
<span class="-5399624366599429167" onmouseenter="enter('-5399624366599429167');" onmouseout="out('-5399624366599429167');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201      * @param token  the token used to authenticate request                                              </span>
<span class="5530241027805460636" onmouseenter="enter('5530241027805460636');" onmouseout="out('5530241027805460636');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202      * @param fromAcct  sender account number                                                            </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 203 =======                                                                                                  </span>
<span class="5719956641649610757" onmouseenter="enter('5719956641649610757');" onmouseout="out('5719956641649610757');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204             LOGGER.info(&quot;Submitted transaction successfully&quot;);                                           </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 205 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-5231725033690787161" onmouseenter="enter('-5231725033690787161');" onmouseout="out('-5231725033690787161');" style=""> 206             return new ResponseEntity&lt;String&gt;(READINESS_CODE,                                            </span>
<span class="-8527330892964817671" onmouseenter="enter('-8527330892964817671');" onmouseout="out('-8527330892964817671');" style=""> 207                     HttpStatus.CREATED);                                                                 </span>
<span  style=""> 208                                                                                                          </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 209         } catch (JWTVerificationException e) {                                                           </span>
<span class="-327448583504624880" onmouseenter="enter('-327448583504624880');" onmouseout="out('-327448583504624880');" style=""> 210             LOGGER.error(&quot;Failed to submit transaction: &quot;                                                </span>
<span class="5874187622003058896" onmouseenter="enter('5874187622003058896');" onmouseout="out('5874187622003058896');" style=""> 211                 + &quot;not authorized&quot;);                                                                     </span>
<span class="-4154758301555607236" onmouseenter="enter('-4154758301555607236');" onmouseout="out('-4154758301555607236');" style=""> 212             return new ResponseEntity&lt;String&gt;(UNAUTHORIZED_CODE,                                         </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 213                                               HttpStatus.UNAUTHORIZED);                                  </span>
<span class="-16261657306661328" onmouseenter="enter('-16261657306661328');" onmouseout="out('-16261657306661328');" style=""> 214         } catch (IllegalArgumentException | IllegalStateException e) {                                   </span>
<span class="-7663233641936656847" onmouseenter="enter('-7663233641936656847');" onmouseout="out('-7663233641936656847');" style=""> 215             LOGGER.error(&quot;Failed to retrieve account balance: &quot;                                          </span>
<span class="-1386920267869766944" onmouseenter="enter('-1386920267869766944');" onmouseout="out('-1386920267869766944');" style=""> 216                 + &quot;bad request&quot;);                                                                        </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style=""> 217             return new ResponseEntity&lt;String&gt;(e.getMessage(),                                            </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 218                                               HttpStatus.BAD_REQUEST);                                   </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style=""> 219         } catch (ResourceAccessException                                                                 </span>
<span class="7920423166678117814" onmouseenter="enter('7920423166678117814');" onmouseout="out('7920423166678117814');" style=""> 220                 | CannotCreateTransactionException                                                       </span>
<span class="-7265908382255363783" onmouseenter="enter('-7265908382255363783');" onmouseout="out('-7265908382255363783');" style=""> 221                 | HttpServerErrorException e) {                                                          </span>
<span class="-6756904505334648824" onmouseenter="enter('-6756904505334648824');" onmouseout="out('-6756904505334648824');" style=""> 222             LOGGER.error(&quot;Failed to retrieve account balance&quot;);                                          </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style=""> 223             return new ResponseEntity&lt;String&gt;(e.getMessage(),                                            </span>
<span class="862392687202373996" onmouseenter="enter('862392687202373996');" onmouseout="out('862392687202373996');" style=""> 224                                               HttpStatus.INTERNAL_SERVER_ERROR);                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 225         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 226     }                                                                                                    </span>
<span  style=""> 227                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 228     /**                                                                                                  </span>
<span class="-840803106370353754" onmouseenter="enter('-840803106370353754');" onmouseout="out('-840803106370353754');" style=""> 229      * Retrieve the balance for the transaction&#x27;s sender.                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 230      *                                                                                                   </span>
<span class="-5399624366599429167" onmouseenter="enter('-5399624366599429167');" onmouseout="out('-5399624366599429167');" style=""> 231      * @param token  the token used to authenticate request                                              </span>
<span class="5530241027805460636" onmouseenter="enter('5530241027805460636');" onmouseout="out('5530241027805460636');" style=""> 232      * @param fromAcct  sender account number                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 233      *                                                                                                   </span>
<span class="-4671862933441611565" onmouseenter="enter('-4671862933441611565');" onmouseout="out('-4671862933441611565');" style=""> 234      * @return available balance of the sender account                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 235      *                                                                                                   </span>
<span class="7966166498405371741" onmouseenter="enter('7966166498405371741');" onmouseout="out('7966166498405371741');" style=""> 236      * @throws HttpServerErrorException  if balance service returns 500                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 237      */                                                                                                  </span>
<span class="-4867839573468993721" onmouseenter="enter('-4867839573468993721');" onmouseout="out('-4867839573468993721');" style=""> 238     protected int getAvailableBalance(String token, String fromAcct)                                     </span>
<span class="7044480961715798280" onmouseenter="enter('7044480961715798280');" onmouseout="out('7044480961715798280');" style=""> 239             throws HttpServerErrorException {                                                            </span>
<span class="2945528015156409897" onmouseenter="enter('2945528015156409897');" onmouseout="out('2945528015156409897');" style=""> 240         LOGGER.debug(&quot;Retrieving balance for transaction sender&quot;);                                       </span>
<span  style=""> 241                                                                                                          </span>
<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 242         HttpHeaders headers = new HttpHeaders();                                                         </span>
<span class="3201291767686862102" onmouseenter="enter('3201291767686862102');" onmouseout="out('3201291767686862102');" style=""> 243         headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + token);                                                 </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 244         HttpEntity entity = new HttpEntity(headers);                                                     </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 245         RestTemplate restTemplate = new RestTemplate();                                                  </span>
<span class="5149154134365859036" onmouseenter="enter('5149154134365859036');" onmouseout="out('5149154134365859036');" style=""> 246         String uri = balancesApiUri + &quot;/&quot; + fromAcct;                                                    </span>
<span class="-697674251075958280" onmouseenter="enter('-697674251075958280');" onmouseout="out('-697674251075958280');" style=""> 247         ResponseEntity&lt;Integer&gt; response = restTemplate.exchange(                                        </span>
<span class="6083870125336786698" onmouseenter="enter('6083870125336786698');" onmouseout="out('6083870125336786698');" style=""> 248             uri, HttpMethod.GET, entity, Integer.class);                                                 </span>
<span class="6400740982500579689" onmouseenter="enter('6400740982500579689');" onmouseout="out('6400740982500579689');" style=""> 249         Integer senderBalance = response.getBody();                                                      </span>
<span class="8092340863849585815" onmouseenter="enter('8092340863849585815');" onmouseout="out('8092340863849585815');" style=""> 250         return senderBalance.intValue();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 252 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2  * Copyright 2020, Google LLC.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15  */                                                                                                      </span>
<span  style="">  16                                                                                                          </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  17 package anthos.samples.financedemo.ledgerwriter;                                                         </span>
<span  style="">  18                                                                                                          </span>
<span class="-6356287537734540725" onmouseenter="enter('-6356287537734540725');" onmouseout="out('-6356287537734540725');" style="">  19 import java.util.concurrent.TimeUnit;                                                                    </span>
<span  style="">  20                                                                                                          </span>
<span class="-538473715904851717" onmouseenter="enter('-538473715904851717');" onmouseout="out('-538473715904851717');" style="">  21 import org.apache.logging.log4j.LogManager;                                                              </span>
<span class="2283937394492695819" onmouseenter="enter('2283937394492695819');" onmouseout="out('2283937394492695819');" style="">  22 import org.apache.logging.log4j.Logger;                                                                  </span>
<span class="3248634983943737307" onmouseenter="enter('3248634983943737307');" onmouseout="out('3248634983943737307');" style="">  23 import  org.springframework.web.client.HttpServerErrorException;                                         </span>
<span  style="">  24                                                                                                          </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  25 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  26 import org.springframework.http.HttpEntity;                                                              </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  27 import org.springframework.http.HttpHeaders;                                                             </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  28 import org.springframework.http.HttpMethod;                                                              </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  29 import org.springframework.http.HttpStatus;                                                              </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  30 import org.springframework.http.ResponseEntity;                                                          </span>
<span class="5341219335560996028" onmouseenter="enter('5341219335560996028');" onmouseout="out('5341219335560996028');" style="">  31 import org.springframework.transaction.CannotCreateTransactionException;                                 </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  32 import org.springframework.web.bind.annotation.GetMapping;                                               </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  33 import org.springframework.web.bind.annotation.PostMapping;                                              </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  34 import org.springframework.web.bind.annotation.RequestBody;                                              </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  35 import org.springframework.web.bind.annotation.RequestHeader;                                            </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  36 import org.springframework.web.bind.annotation.ResponseStatus;                                           </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  37 import org.springframework.web.bind.annotation.RestController;                                           </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="">  38 import org.springframework.web.client.ResourceAccessException;                                           </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  39 import org.springframework.web.client.RestTemplate;                                                      </span>
<span  style="">  40                                                                                                          </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  41 import com.auth0.jwt.JWTVerifier;                                                                        </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  42 import com.auth0.jwt.exceptions.JWTVerificationException;                                                </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  43 import com.auth0.jwt.interfaces.DecodedJWT;                                                              </span>
<span  style="">  44                                                                                                          </span>
<span  style="">  45                                                                                                          </span>
<span class="8064918626260915349" onmouseenter="enter('8064918626260915349');" onmouseout="out('8064918626260915349');" style="">  46 import com.google.common.cache.Cache;                                                                    </span>
<span class="-5185947672099267182" onmouseenter="enter('-5185947672099267182');" onmouseout="out('-5185947672099267182');" style="">  47 import com.google.common.cache.CacheBuilder;                                                             </span>
<span  style="">  48                                                                                                          </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="">  49 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                 </span>
<span class="5485927036637514847" onmouseenter="enter('5485927036637514847');" onmouseout="out('5485927036637514847');" style="">  50         EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE;                                                          </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="">  51 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                 </span>
<span class="-8362488606383815534" onmouseenter="enter('-8362488606383815534');" onmouseout="out('-8362488606383815534');" style="">  52         EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL;                                                </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="">  53 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                 </span>
<span class="4868142399698679402" onmouseenter="enter('4868142399698679402');" onmouseout="out('4868142399698679402');" style="">  54         EXCEPTION_MESSAGE_DUPLICATE_TRANSACTION;                                                         </span>
<span  style="">  55                                                                                                          </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  56 @RestController                                                                                          </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  57 public final class LedgerWriterController {                                                              </span>
<span  style="">  58                                                                                                          </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="">  59     private static final Logger LOGGER =                                                                 </span>
<span class="999928017189038216" onmouseenter="enter('999928017189038216');" onmouseout="out('999928017189038216');" style="">  60         LogManager.getLogger(LedgerWriterController.class);                                              </span>
<span  style="">  61                                                                                                          </span>
<span class="-728019112929028725" onmouseenter="enter('-728019112929028725');" onmouseout="out('-728019112929028725');" style="">  62     private TransactionRepository transactionRepository;                                                 </span>
<span class="-4578700528226723750" onmouseenter="enter('-4578700528226723750');" onmouseout="out('-4578700528226723750');" style="">  63     private TransactionValidator transactionValidator;                                                   </span>
<span class="-5049251535661215052" onmouseenter="enter('-5049251535661215052');" onmouseout="out('-5049251535661215052');" style="">  64     private JWTVerifier verifier;                                                                        </span>
<span  style="">  65                                                                                                          </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="">  66     private String localRoutingNum;                                                                      </span>
<span class="-469486944919448386" onmouseenter="enter('-469486944919448386');" onmouseout="out('-469486944919448386');" style="">  67     private String balancesApiUri;                                                                       </span>
<span class="6148824265517010025" onmouseenter="enter('6148824265517010025');" onmouseout="out('6148824265517010025');" style="">  68     private String version;                                                                              </span>
<span  style="">  69                                                                                                          </span>
<span class="998797035934579942" onmouseenter="enter('998797035934579942');" onmouseout="out('998797035934579942');" style="">  70     private Cache&lt;String, Long&gt; cache;                                                                   </span>
<span  style="">  71                                                                                                          </span>
<span class="-6505034648581184544" onmouseenter="enter('-6505034648581184544');" onmouseout="out('-6505034648581184544');" style="">  72     public static final String READINESS_CODE = &quot;ok&quot;;                                                    </span>
<span class="-9149089262416743429" onmouseenter="enter('-9149089262416743429');" onmouseout="out('-9149089262416743429');" style="">  73     public static final String UNAUTHORIZED_CODE = &quot;not authorized&quot;;                                     </span>
<span class="6290000176908202808" onmouseenter="enter('6290000176908202808');" onmouseout="out('6290000176908202808');" style="">  74     public static final String JWT_ACCOUNT_KEY = &quot;acct&quot;;                                                 </span>
<span  style="">  75                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  76     /**                                                                                                  </span>
<span class="-1436741038288612910" onmouseenter="enter('-1436741038288612910');" onmouseout="out('-1436741038288612910');" style="">  77     * Constructor.                                                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  78     *                                                                                                    </span>
<span class="-5348532432243399187" onmouseenter="enter('-5348532432243399187');" onmouseout="out('-5348532432243399187');" style="">  79     * Initializes JWT verifier.                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  80     */                                                                                                   </span>
<span  style="">  81                                                                                                          </span>
<span class="8937474768837710123" onmouseenter="enter('8937474768837710123');" onmouseout="out('8937474768837710123');" style="">  82     public LedgerWriterController(                                                                       </span>
<span class="2780303771851218368" onmouseenter="enter('2780303771851218368');" onmouseout="out('2780303771851218368');" style="">  83             JWTVerifier verifier,                                                                        </span>
<span class="1132068715177995291" onmouseenter="enter('1132068715177995291');" onmouseout="out('1132068715177995291');" style="">  84             TransactionRepository transactionRepository,                                                 </span>
<span class="5479269793478582431" onmouseenter="enter('5479269793478582431');" onmouseout="out('5479269793478582431');" style="">  85             TransactionValidator transactionValidator,                                                   </span>
<span class="-822564396537268339" onmouseenter="enter('-822564396537268339');" onmouseout="out('-822564396537268339');" style="">  86             @Value(&quot;${LOCAL_ROUTING_NUM}&quot;) String localRoutingNum,                                       </span>
<span class="-2250521274199702466" onmouseenter="enter('-2250521274199702466');" onmouseout="out('-2250521274199702466');" style="">  87             @Value(&quot;http://${BALANCES_API_ADDR}/balances&quot;)                                               </span>
<span class="5760341242560825698" onmouseenter="enter('5760341242560825698');" onmouseout="out('5760341242560825698');" style="">  88                     String balancesApiUri,                                                               </span>
<span class="3727660980762547349" onmouseenter="enter('3727660980762547349');" onmouseout="out('3727660980762547349');" style="">  89             @Value(&quot;${VERSION}&quot;) String version) {                                                       </span>
<span class="2791682847397564046" onmouseenter="enter('2791682847397564046');" onmouseout="out('2791682847397564046');" style="">  90         this.verifier = verifier;                                                                        </span>
<span class="5620916918385755227" onmouseenter="enter('5620916918385755227');" onmouseout="out('5620916918385755227');" style="">  91         this.transactionRepository = transactionRepository;                                              </span>
<span class="7194621662788445012" onmouseenter="enter('7194621662788445012');" onmouseout="out('7194621662788445012');" style="">  92         this.transactionValidator = transactionValidator;                                                </span>
<span class="5248812605098956146" onmouseenter="enter('5248812605098956146');" onmouseout="out('5248812605098956146');" style="">  93         this.localRoutingNum = localRoutingNum;                                                          </span>
<span class="-1729773563907748731" onmouseenter="enter('-1729773563907748731');" onmouseout="out('-1729773563907748731');" style="">  94         this.balancesApiUri = balancesApiUri;                                                            </span>
<span class="8734022701570323791" onmouseenter="enter('8734022701570323791');" onmouseout="out('8734022701570323791');" style="">  95         this.version = version;                                                                          </span>
<span class="8244837015881776783" onmouseenter="enter('8244837015881776783');" onmouseout="out('8244837015881776783');" style="">  96         // Initialize cache to ignore duplicate transactions                                             </span>
<span class="-1757741908889032370" onmouseenter="enter('-1757741908889032370');" onmouseout="out('-1757741908889032370');" style="">  97         this.cache = CacheBuilder.newBuilder()                                                           </span>
<span class="8658036842979585808" onmouseenter="enter('8658036842979585808');" onmouseout="out('8658036842979585808');" style="">  98                             .expireAfterWrite(1, TimeUnit.HOURS)                                         </span>
<span class="-368814941510255410" onmouseenter="enter('-368814941510255410');" onmouseout="out('-368814941510255410');" style="">  99                             .build();                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 100     }                                                                                                    </span>
<span  style=""> 101                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 102     /**                                                                                                  </span>
<span class="559132540195676827" onmouseenter="enter('559132540195676827');" onmouseout="out('559132540195676827');" style=""> 103      * Version endpoint.                                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 104      *                                                                                                   </span>
<span class="-3837725526160323045" onmouseenter="enter('-3837725526160323045');" onmouseout="out('-3837725526160323045');" style=""> 105      * @return  service version string                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 106      */                                                                                                  </span>
<span class="6685475051439146687" onmouseenter="enter('6685475051439146687');" onmouseout="out('6685475051439146687');" style=""> 107     @GetMapping(&quot;/version&quot;)                                                                              </span>
<span class="580444279607563843" onmouseenter="enter('580444279607563843');" onmouseout="out('580444279607563843');" style=""> 108     public ResponseEntity version() {                                                                    </span>
<span class="5343850267959959664" onmouseenter="enter('5343850267959959664');" onmouseout="out('5343850267959959664');" style=""> 109         return new ResponseEntity&lt;String&gt;(version, HttpStatus.OK);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 110     }                                                                                                    </span>
<span  style=""> 111                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 112     /**                                                                                                  </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style=""> 113      * Readiness probe endpoint.                                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 114      *                                                                                                   </span>
<span class="8463518254556868911" onmouseenter="enter('8463518254556868911');" onmouseout="out('8463518254556868911');" style=""> 115      * @return HTTP Status 200 if server is ready to receive requests.                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 116      */                                                                                                  </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style=""> 117     @GetMapping(&quot;/ready&quot;)                                                                                </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 118     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="7271346341917529010" onmouseenter="enter('7271346341917529010');" onmouseout="out('7271346341917529010');" style=""> 119     public ResponseEntity&lt;String&gt; readiness() {                                                          </span>
<span class="-4075762798656461919" onmouseenter="enter('-4075762798656461919');" onmouseout="out('-4075762798656461919');" style=""> 120         return new ResponseEntity&lt;String&gt;(READINESS_CODE, HttpStatus.OK);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 121     }                                                                                                    </span>
<span  style=""> 122                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 123     /**                                                                                                  </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style=""> 124      * Submit a new transaction to the ledger.                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 125      *                                                                                                   </span>
<span class="-1661212859137511783" onmouseenter="enter('-1661212859137511783');" onmouseout="out('-1661212859137511783');" style=""> 126      * @param bearerToken  HTTP request &#x27;Authorization&#x27; header                                           </span>
<span class="5399615509278749127" onmouseenter="enter('5399615509278749127');" onmouseout="out('5399615509278749127');" style=""> 127      * @param transaction  transaction to submit                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 128      *                                                                                                   </span>
<span class="7486646966745340100" onmouseenter="enter('7486646966745340100');" onmouseout="out('7486646966745340100');" style=""> 129      * @return  HTTP Status 200 if transaction was successfully submitted                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 130      */                                                                                                  </span>
<span class="5323932416516552401" onmouseenter="enter('5323932416516552401');" onmouseout="out('5323932416516552401');" style=""> 131     @PostMapping(value = &quot;/transactions&quot;, consumes = &quot;application/json&quot;)                                 </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 132     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="1897907323625472935" onmouseenter="enter('1897907323625472935');" onmouseout="out('1897907323625472935');" style=""> 133     public ResponseEntity&lt;?&gt; addTransaction(                                                             </span>
<span class="1166903297081280981" onmouseenter="enter('1166903297081280981');" onmouseout="out('1166903297081280981');" style=""> 134             @RequestHeader(&quot;Authorization&quot;) String bearerToken,                                          </span>
<span class="9022696444049056102" onmouseenter="enter('9022696444049056102');" onmouseout="out('9022696444049056102');" style=""> 135             @RequestBody Transaction transaction) {                                                      </span>
<span class="-3538581758087352701" onmouseenter="enter('-3538581758087352701');" onmouseout="out('-3538581758087352701');" style=""> 136         if (bearerToken != null &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                  </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 137             bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 138         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 139         try {                                                                                            </span>
<span class="-4457463381546497224" onmouseenter="enter('-4457463381546497224');" onmouseout="out('-4457463381546497224');" style=""> 140             if (bearerToken == null) {                                                                   </span>
<span class="8471284381161989921" onmouseenter="enter('8471284381161989921');" onmouseout="out('8471284381161989921');" style=""> 141                 LOGGER.error(&quot;Transaction submission failed: &quot;                                           </span>
<span class="-6310070690167802414" onmouseenter="enter('-6310070690167802414');" onmouseout="out('-6310070690167802414');" style=""> 142                     + &quot;Authorization header null&quot;);                                                      </span>
<span class="-5454936540258631376" onmouseenter="enter('-5454936540258631376');" onmouseout="out('-5454936540258631376');" style=""> 143                 throw new IllegalArgumentException(                                                      </span>
<span class="-4688472594501119643" onmouseenter="enter('-4688472594501119643');" onmouseout="out('-4688472594501119643');" style=""> 144                         EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 145             }                                                                                            </span>
<span class="-5768910099284843906" onmouseenter="enter('-5768910099284843906');" onmouseout="out('-5768910099284843906');" style=""> 146             final DecodedJWT jwt = this.verifier.verify(bearerToken);                                    </span>
<span  style=""> 147                                                                                                          </span>
<span class="-7357029865885638695" onmouseenter="enter('-7357029865885638695');" onmouseout="out('-7357029865885638695');" style=""> 148             // Check against cache for duplicate transactions                                            </span>
<span class="-7254451175943600487" onmouseenter="enter('-7254451175943600487');" onmouseout="out('-7254451175943600487');" style=""> 149             if (this.cache.asMap().containsKey(transaction.getRequestUuid())) {                          </span>
<span class="-8046945014218387655" onmouseenter="enter('-8046945014218387655');" onmouseout="out('-8046945014218387655');" style=""> 150                 throw new IllegalStateException(                                                         </span>
<span class="5344096214519321268" onmouseenter="enter('5344096214519321268');" onmouseout="out('5344096214519321268');" style=""> 151                         EXCEPTION_MESSAGE_DUPLICATE_TRANSACTION);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 152             }                                                                                            </span>
<span  style=""> 153                                                                                                          </span>
<span class="-6962791519859020761" onmouseenter="enter('-6962791519859020761');" onmouseout="out('-6962791519859020761');" style=""> 154             // validate transaction                                                                      </span>
<span class="776637986685870327" onmouseenter="enter('776637986685870327');" onmouseout="out('776637986685870327');" style=""> 155             transactionValidator.validateTransaction(localRoutingNum,                                    </span>
<span class="-4879758647615452357" onmouseenter="enter('-4879758647615452357');" onmouseout="out('-4879758647615452357');" style=""> 156                     jwt.getClaim(JWT_ACCOUNT_KEY).asString(), transaction);                              </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style=""> 157             // Ensure sender balance can cover transaction.                                              </span>
<span class="-6144219964793655128" onmouseenter="enter('-6144219964793655128');" onmouseout="out('-6144219964793655128');" style=""> 158             if (transaction.getFromRoutingNum().equals(localRoutingNum)) {                               </span>
<span class="7239735847198029864" onmouseenter="enter('7239735847198029864');" onmouseout="out('7239735847198029864');" style=""> 159                 int balance = getAvailableBalance(                                                       </span>
<span class="7702083458280016025" onmouseenter="enter('7702083458280016025');" onmouseout="out('7702083458280016025');" style=""> 160                         bearerToken, transaction.getFromAccountNum());                                   </span>
<span class="-8424323426889164999" onmouseenter="enter('-8424323426889164999');" onmouseout="out('-8424323426889164999');" style=""> 161                 if (balance &lt; transaction.getAmount()) {                                                 </span>
<span class="8471284381161989921" onmouseenter="enter('8471284381161989921');" onmouseout="out('8471284381161989921');" style=""> 162                     LOGGER.error(&quot;Transaction submission failed: &quot;                                       </span>
<span class="2606405075138145997" onmouseenter="enter('2606405075138145997');" onmouseout="out('2606405075138145997');" style=""> 163                         + &quot;Insufficient balance&quot;);                                                       </span>
<span class="-8046945014218387655" onmouseenter="enter('-8046945014218387655');" onmouseout="out('-8046945014218387655');" style=""> 164                     throw new IllegalStateException(                                                     </span>
<span class="-5146115328615515543" onmouseenter="enter('-5146115328615515543');" onmouseout="out('-5146115328615515543');" style=""> 165                             EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE);                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 166                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 167             }                                                                                            </span>
<span  style=""> 168                                                                                                          </span>
<span class="-3539745766511737220" onmouseenter="enter('-3539745766511737220');" onmouseout="out('-3539745766511737220');" style=""> 169             // No exceptions thrown. Add to ledger                                                       </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style=""> 170             transactionRepository.save(transaction);                                                     </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style=""> 171 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="-2122798952495658084" onmouseenter="enter('-2122798952495658084');" onmouseout="out('-2122798952495658084');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172             this.cache.put(transaction.getRequestUuid(),                                                 </span>
<span class="-2743452731222378684" onmouseenter="enter('-2743452731222378684');" onmouseout="out('-2743452731222378684');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173                     transaction.getTransactionId());                                                     </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 174 ||||||| BASE                                                                                             </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175                                                                                                          </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176         } catch (JWTVerificationException e) {                                                           </span>
<span class="-4154758301555607236" onmouseenter="enter('-4154758301555607236');" onmouseout="out('-4154758301555607236');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177             return new ResponseEntity&lt;String&gt;(UNAUTHORIZED_CODE,                                         </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178                                               HttpStatus.UNAUTHORIZED);                                  </span>
<span class="-16261657306661328" onmouseenter="enter('-16261657306661328');" onmouseout="out('-16261657306661328');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179         } catch (IllegalArgumentException | IllegalStateException e) {                                   </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180             return new ResponseEntity&lt;String&gt;(e.getMessage(),                                            </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181                                               HttpStatus.BAD_REQUEST);                                   </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 182 =======                                                                                                  </span>
<span class="5719956641649610757" onmouseenter="enter('5719956641649610757');" onmouseout="out('5719956641649610757');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183             LOGGER.info(&quot;Submitted transaction successfully&quot;);                                           </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 184 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span class="-5231725033690787161" onmouseenter="enter('-5231725033690787161');" onmouseout="out('-5231725033690787161');" style=""> 185             return new ResponseEntity&lt;String&gt;(READINESS_CODE,                                            </span>
<span class="-8527330892964817671" onmouseenter="enter('-8527330892964817671');" onmouseout="out('-8527330892964817671');" style=""> 186                     HttpStatus.CREATED);                                                                 </span>
<span  style=""> 187                                                                                                          </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 188         } catch (JWTVerificationException e) {                                                           </span>
<span class="-327448583504624880" onmouseenter="enter('-327448583504624880');" onmouseout="out('-327448583504624880');" style=""> 189             LOGGER.error(&quot;Failed to submit transaction: &quot;                                                </span>
<span class="5874187622003058896" onmouseenter="enter('5874187622003058896');" onmouseout="out('5874187622003058896');" style=""> 190                 + &quot;not authorized&quot;);                                                                     </span>
<span class="-4154758301555607236" onmouseenter="enter('-4154758301555607236');" onmouseout="out('-4154758301555607236');" style=""> 191             return new ResponseEntity&lt;String&gt;(UNAUTHORIZED_CODE,                                         </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 192                                               HttpStatus.UNAUTHORIZED);                                  </span>
<span class="-16261657306661328" onmouseenter="enter('-16261657306661328');" onmouseout="out('-16261657306661328');" style=""> 193         } catch (IllegalArgumentException | IllegalStateException e) {                                   </span>
<span class="-7663233641936656847" onmouseenter="enter('-7663233641936656847');" onmouseout="out('-7663233641936656847');" style=""> 194             LOGGER.error(&quot;Failed to retrieve account balance: &quot;                                          </span>
<span class="-1386920267869766944" onmouseenter="enter('-1386920267869766944');" onmouseout="out('-1386920267869766944');" style=""> 195                 + &quot;bad request&quot;);                                                                        </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style=""> 196             return new ResponseEntity&lt;String&gt;(e.getMessage(),                                            </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 197                                               HttpStatus.BAD_REQUEST);                                   </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style=""> 198         } catch (ResourceAccessException                                                                 </span>
<span class="7920423166678117814" onmouseenter="enter('7920423166678117814');" onmouseout="out('7920423166678117814');" style=""> 199                 | CannotCreateTransactionException                                                       </span>
<span class="-7265908382255363783" onmouseenter="enter('-7265908382255363783');" onmouseout="out('-7265908382255363783');" style=""> 200                 | HttpServerErrorException e) {                                                          </span>
<span class="-6756904505334648824" onmouseenter="enter('-6756904505334648824');" onmouseout="out('-6756904505334648824');" style=""> 201             LOGGER.error(&quot;Failed to retrieve account balance&quot;);                                          </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style=""> 202             return new ResponseEntity&lt;String&gt;(e.getMessage(),                                            </span>
<span class="862392687202373996" onmouseenter="enter('862392687202373996');" onmouseout="out('862392687202373996');" style=""> 203                                               HttpStatus.INTERNAL_SERVER_ERROR);                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 204         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 205     }                                                                                                    </span>
<span  style=""> 206                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 207     /**                                                                                                  </span>
<span class="-840803106370353754" onmouseenter="enter('-840803106370353754');" onmouseout="out('-840803106370353754');" style=""> 208      * Retrieve the balance for the transaction&#x27;s sender.                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 209      *                                                                                                   </span>
<span class="-5399624366599429167" onmouseenter="enter('-5399624366599429167');" onmouseout="out('-5399624366599429167');" style=""> 210      * @param token  the token used to authenticate request                                              </span>
<span class="5530241027805460636" onmouseenter="enter('5530241027805460636');" onmouseout="out('5530241027805460636');" style=""> 211      * @param fromAcct  sender account number                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 212      *                                                                                                   </span>
<span class="-4671862933441611565" onmouseenter="enter('-4671862933441611565');" onmouseout="out('-4671862933441611565');" style=""> 213      * @return available balance of the sender account                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 214      *                                                                                                   </span>
<span class="7966166498405371741" onmouseenter="enter('7966166498405371741');" onmouseout="out('7966166498405371741');" style=""> 215      * @throws HttpServerErrorException  if balance service returns 500                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 216      */                                                                                                  </span>
<span class="-4867839573468993721" onmouseenter="enter('-4867839573468993721');" onmouseout="out('-4867839573468993721');" style=""> 217     protected int getAvailableBalance(String token, String fromAcct)                                     </span>
<span class="7044480961715798280" onmouseenter="enter('7044480961715798280');" onmouseout="out('7044480961715798280');" style=""> 218             throws HttpServerErrorException {                                                            </span>
<span class="2945528015156409897" onmouseenter="enter('2945528015156409897');" onmouseout="out('2945528015156409897');" style=""> 219         LOGGER.debug(&quot;Retrieving balance for transaction sender&quot;);                                       </span>
<span  style=""> 220                                                                                                          </span>
<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 221         HttpHeaders headers = new HttpHeaders();                                                         </span>
<span class="3201291767686862102" onmouseenter="enter('3201291767686862102');" onmouseout="out('3201291767686862102');" style=""> 222         headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + token);                                                 </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 223         HttpEntity entity = new HttpEntity(headers);                                                     </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 224         RestTemplate restTemplate = new RestTemplate();                                                  </span>
<span class="5149154134365859036" onmouseenter="enter('5149154134365859036');" onmouseout="out('5149154134365859036');" style=""> 225         String uri = balancesApiUri + &quot;/&quot; + fromAcct;                                                    </span>
<span class="-697674251075958280" onmouseenter="enter('-697674251075958280');" onmouseout="out('-697674251075958280');" style=""> 226         ResponseEntity&lt;Integer&gt; response = restTemplate.exchange(                                        </span>
<span class="6083870125336786698" onmouseenter="enter('6083870125336786698');" onmouseout="out('6083870125336786698');" style=""> 227             uri, HttpMethod.GET, entity, Integer.class);                                                 </span>
<span class="6400740982500579689" onmouseenter="enter('6400740982500579689');" onmouseout="out('6400740982500579689');" style=""> 228         Integer senderBalance = response.getBody();                                                      </span>
<span class="8092340863849585815" onmouseenter="enter('8092340863849585815');" onmouseout="out('8092340863849585815');" style=""> 229         return senderBalance.intValue();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 230     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 231 }                                                                                                        </span>



















</pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2  * Copyright 2020, Google LLC.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15  */                                                                                                      </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  16 package anthos.samples.financedemo.ledgerwriter;                                                         </span>
<span  style="">  17                                                                                                          </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  18 import com.auth0.jwt.JWTVerifier;                                                                        </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  19 import com.auth0.jwt.exceptions.JWTVerificationException;                                                </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  20 import com.auth0.jwt.interfaces.DecodedJWT;                                                              </span>
<span class="8064918626260915349" onmouseenter="enter('8064918626260915349');" onmouseout="out('8064918626260915349');" style="">  21 import com.google.common.cache.Cache;                                                                    </span>
<span class="-5185947672099267182" onmouseenter="enter('-5185947672099267182');" onmouseout="out('-5185947672099267182');" style="">  22 import com.google.common.cache.CacheBuilder;                                                             </span>
<span class="-6356287537734540725" onmouseenter="enter('-6356287537734540725');" onmouseout="out('-6356287537734540725');" style="">  23 import java.util.concurrent.TimeUnit;                                                                    </span>
<span class="-538473715904851717" onmouseenter="enter('-538473715904851717');" onmouseout="out('-538473715904851717');" style="">  24 import org.apache.logging.log4j.LogManager;                                                              </span>
<span class="2283937394492695819" onmouseenter="enter('2283937394492695819');" onmouseout="out('2283937394492695819');" style="">  25 import org.apache.logging.log4j.Logger;                                                                  </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  26 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  27 import org.springframework.http.HttpEntity;                                                              </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  28 import org.springframework.http.HttpHeaders;                                                             </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  29 import org.springframework.http.HttpMethod;                                                              </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  30 import org.springframework.http.HttpStatus;                                                              </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  31 import org.springframework.http.ResponseEntity;                                                          </span>
<span class="5341219335560996028" onmouseenter="enter('5341219335560996028');" onmouseout="out('5341219335560996028');" style="">  32 import org.springframework.transaction.CannotCreateTransactionException;                                 </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  33 import org.springframework.web.bind.annotation.GetMapping;                                               </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  34 import org.springframework.web.bind.annotation.PostMapping;                                              </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  35 import org.springframework.web.bind.annotation.RequestBody;                                              </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  36 import org.springframework.web.bind.annotation.RequestHeader;                                            </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  37 import org.springframework.web.bind.annotation.ResponseStatus;                                           </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  38 import org.springframework.web.bind.annotation.RestController;                                           </span>
<span class="6025390803839303694" onmouseenter="enter('6025390803839303694');" onmouseout="out('6025390803839303694');" style="">  39 import org.springframework.web.client.HttpServerErrorException;                                          </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="">  40 import org.springframework.web.client.ResourceAccessException;                                           </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  41 import org.springframework.web.client.RestTemplate;                                                      </span>
<span class="-6054460282354873866" onmouseenter="enter('-6054460282354873866');" onmouseout="out('-6054460282354873866');" style=""><abbr title="  42 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.EXCEPTION_MESSAGE_DUPLICATE_TRANSACTION;">  42 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.EXCEPTION_MESSAGE_DUPLICATE_TRANS</abbr></span>
<span class="8038844644609144748" onmouseenter="enter('8038844644609144748');" onmouseout="out('8038844644609144748');" style=""><abbr title="  43 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE;">  43 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.EXCEPTION_MESSAGE_INSUFFICIENT_BA</abbr></span>
<span class="6364632962761087598" onmouseenter="enter('6364632962761087598');" onmouseout="out('6364632962761087598');" style=""><abbr title="  44 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL;">  44 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.EXCEPTION_MESSAGE_WHEN_AUTHORIZAT</abbr></span>
<span  style="">  45                                                                                                          </span>
<span  style="">  46                                                                                                          </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  47 @RestController                                                                                          </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  48 public final class LedgerWriterController {                                                              </span>
<span class="3359173380053303113" onmouseenter="enter('3359173380053303113');" onmouseout="out('3359173380053303113');" style="">  49     private static final Logger LOGGER = LogManager.getLogger(LedgerWriterController.class);             </span>
<span  style="">  50                                                                                                          </span>
<span class="-728019112929028725" onmouseenter="enter('-728019112929028725');" onmouseout="out('-728019112929028725');" style="">  51     private TransactionRepository transactionRepository;                                                 </span>
<span  style="">  52                                                                                                          </span>
<span class="-4578700528226723750" onmouseenter="enter('-4578700528226723750');" onmouseout="out('-4578700528226723750');" style="">  53     private TransactionValidator transactionValidator;                                                   </span>
<span  style="">  54                                                                                                          </span>
<span class="-5049251535661215052" onmouseenter="enter('-5049251535661215052');" onmouseout="out('-5049251535661215052');" style="">  55     private JWTVerifier verifier;                                                                        </span>
<span  style="">  56                                                                                                          </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="">  57     private String localRoutingNum;                                                                      </span>
<span  style="">  58                                                                                                          </span>
<span class="-469486944919448386" onmouseenter="enter('-469486944919448386');" onmouseout="out('-469486944919448386');" style="">  59     private String balancesApiUri;                                                                       </span>
<span  style="">  60                                                                                                          </span>
<span class="6148824265517010025" onmouseenter="enter('6148824265517010025');" onmouseout="out('6148824265517010025');" style="">  61     private String version;                                                                              </span>
<span  style="">  62                                                                                                          </span>
<span class="998797035934579942" onmouseenter="enter('998797035934579942');" onmouseout="out('998797035934579942');" style="">  63     private Cache&lt;String, Long&gt; cache;                                                                   </span>
<span  style="">  64                                                                                                          </span>
<span class="-6505034648581184544" onmouseenter="enter('-6505034648581184544');" onmouseout="out('-6505034648581184544');" style="">  65     public static final String READINESS_CODE = &quot;ok&quot;;                                                    </span>
<span  style="">  66                                                                                                          </span>
<span class="-9149089262416743429" onmouseenter="enter('-9149089262416743429');" onmouseout="out('-9149089262416743429');" style="">  67     public static final String UNAUTHORIZED_CODE = &quot;not authorized&quot;;                                     </span>
<span  style="">  68                                                                                                          </span>
<span class="6290000176908202808" onmouseenter="enter('6290000176908202808');" onmouseout="out('6290000176908202808');" style="">  69     public static final String JWT_ACCOUNT_KEY = &quot;acct&quot;;                                                 </span>
<span  style="">  70                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  71     /**                                                                                                  </span>
<span class="-1436741038288612910" onmouseenter="enter('-1436741038288612910');" onmouseout="out('-1436741038288612910');" style="">  72     * Constructor.                                                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  73     *                                                                                                    </span>
<span class="-5348532432243399187" onmouseenter="enter('-5348532432243399187');" onmouseout="out('-5348532432243399187');" style="">  74     * Initializes JWT verifier.                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  75     */                                                                                                   </span>
<span class="-8402264985000865690" onmouseenter="enter('-8402264985000865690');" onmouseout="out('-8402264985000865690');" style=""><abbr title="  76     public LedgerWriterController(JWTVerifier verifier, TransactionRepository transactionRepository, TransactionValidator transactionValidator, @Value(&quot;${LOCAL_ROUTING_NUM}&quot;)">  76     public LedgerWriterController(JWTVerifier verifier, TransactionRepository transactionRepository, Tran</abbr></span>
<span class="-2409824870740125493" onmouseenter="enter('-2409824870740125493');" onmouseout="out('-2409824870740125493');" style="">  77     String localRoutingNum, @Value(&quot;http://${BALANCES_API_ADDR}/balances&quot;)                               </span>
<span class="6405472557125496080" onmouseenter="enter('6405472557125496080');" onmouseout="out('6405472557125496080');" style="">  78     String balancesApiUri, @Value(&quot;${VERSION}&quot;)                                                          </span>
<span class="-6479799029361189940" onmouseenter="enter('-6479799029361189940');" onmouseout="out('-6479799029361189940');" style="">  79     String version) {                                                                                    </span>
<span class="2791682847397564046" onmouseenter="enter('2791682847397564046');" onmouseout="out('2791682847397564046');" style="">  80         this.verifier = verifier;                                                                        </span>
<span class="5620916918385755227" onmouseenter="enter('5620916918385755227');" onmouseout="out('5620916918385755227');" style="">  81         this.transactionRepository = transactionRepository;                                              </span>
<span class="7194621662788445012" onmouseenter="enter('7194621662788445012');" onmouseout="out('7194621662788445012');" style="">  82         this.transactionValidator = transactionValidator;                                                </span>
<span class="5248812605098956146" onmouseenter="enter('5248812605098956146');" onmouseout="out('5248812605098956146');" style="">  83         this.localRoutingNum = localRoutingNum;                                                          </span>
<span class="-1729773563907748731" onmouseenter="enter('-1729773563907748731');" onmouseout="out('-1729773563907748731');" style="">  84         this.balancesApiUri = balancesApiUri;                                                            </span>
<span class="8734022701570323791" onmouseenter="enter('8734022701570323791');" onmouseout="out('8734022701570323791');" style="">  85         this.version = version;                                                                          </span>
<span class="8244837015881776783" onmouseenter="enter('8244837015881776783');" onmouseout="out('8244837015881776783');" style="">  86         // Initialize cache to ignore duplicate transactions                                             </span>
<span class="-8013717381260139809" onmouseenter="enter('-8013717381260139809');" onmouseout="out('-8013717381260139809');" style="">  87         this.cache = CacheBuilder.newBuilder().expireAfterWrite(1, TimeUnit.HOURS).build();              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  88     }                                                                                                    </span>
<span  style="">  89                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  90     /**                                                                                                  </span>
<span class="559132540195676827" onmouseenter="enter('559132540195676827');" onmouseout="out('559132540195676827');" style="">  91      * Version endpoint.                                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  92      *                                                                                                   </span>
<span class="-3837725526160323045" onmouseenter="enter('-3837725526160323045');" onmouseout="out('-3837725526160323045');" style="">  93      * @return  service version string                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  94      */                                                                                                  </span>
<span class="6685475051439146687" onmouseenter="enter('6685475051439146687');" onmouseout="out('6685475051439146687');" style="">  95     @GetMapping(&quot;/version&quot;)                                                                              </span>
<span class="580444279607563843" onmouseenter="enter('580444279607563843');" onmouseout="out('580444279607563843');" style="">  96     public ResponseEntity version() {                                                                    </span>
<span class="5343850267959959664" onmouseenter="enter('5343850267959959664');" onmouseout="out('5343850267959959664');" style="">  97         return new ResponseEntity&lt;String&gt;(version, HttpStatus.OK);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  98     }                                                                                                    </span>
<span  style="">  99                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 100     /**                                                                                                  </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style=""> 101      * Readiness probe endpoint.                                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 102      *                                                                                                   </span>
<span class="8463518254556868911" onmouseenter="enter('8463518254556868911');" onmouseout="out('8463518254556868911');" style=""> 103      * @return HTTP Status 200 if server is ready to receive requests.                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 104      */                                                                                                  </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style=""> 105     @GetMapping(&quot;/ready&quot;)                                                                                </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 106     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="7271346341917529010" onmouseenter="enter('7271346341917529010');" onmouseout="out('7271346341917529010');" style=""> 107     public ResponseEntity&lt;String&gt; readiness() {                                                          </span>
<span class="-4075762798656461919" onmouseenter="enter('-4075762798656461919');" onmouseout="out('-4075762798656461919');" style=""> 108         return new ResponseEntity&lt;String&gt;(READINESS_CODE, HttpStatus.OK);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 109     }                                                                                                    </span>
<span  style=""> 110                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 111     /**                                                                                                  </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style=""> 112      * Submit a new transaction to the ledger.                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 113      *                                                                                                   </span>
<span class="-1661212859137511783" onmouseenter="enter('-1661212859137511783');" onmouseout="out('-1661212859137511783');" style=""> 114      * @param bearerToken  HTTP request &#x27;Authorization&#x27; header                                           </span>
<span class="5399615509278749127" onmouseenter="enter('5399615509278749127');" onmouseout="out('5399615509278749127');" style=""> 115      * @param transaction  transaction to submit                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 116      *                                                                                                   </span>
<span class="7486646966745340100" onmouseenter="enter('7486646966745340100');" onmouseout="out('7486646966745340100');" style=""> 117      * @return  HTTP Status 200 if transaction was successfully submitted                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 118      */                                                                                                  </span>
<span class="5323932416516552401" onmouseenter="enter('5323932416516552401');" onmouseout="out('5323932416516552401');" style=""> 119     @PostMapping(value = &quot;/transactions&quot;, consumes = &quot;application/json&quot;)                                 </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 120     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="5470864294584925323" onmouseenter="enter('5470864294584925323');" onmouseout="out('5470864294584925323');" style=""> 121     public ResponseEntity&lt;?&gt; addTransaction(@RequestHeader(&quot;Authorization&quot;)                              </span>
<span class="-5836505278597876000" onmouseenter="enter('-5836505278597876000');" onmouseout="out('-5836505278597876000');" style=""> 122     String bearerToken, @RequestBody                                                                     </span>
<span class="395989369435282996" onmouseenter="enter('395989369435282996');" onmouseout="out('395989369435282996');" style=""> 123     Transaction transaction) {                                                                           </span>
<span class="-6149106221954289698" onmouseenter="enter('-6149106221954289698');" onmouseout="out('-6149106221954289698');" style=""> 124         if ((bearerToken != null) &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 125             bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 126         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 127         try {                                                                                            </span>
<span class="-4457463381546497224" onmouseenter="enter('-4457463381546497224');" onmouseout="out('-4457463381546497224');" style=""> 128             if (bearerToken == null) {                                                                   </span>
<span class="7368975142293428862" onmouseenter="enter('7368975142293428862');" onmouseout="out('7368975142293428862');" style=""> 129                 LOGGER.error(&quot;Transaction submission failed: &quot; + &quot;Authorization header null&quot;);           </span>
<span class="-2156981052151854315" onmouseenter="enter('-2156981052151854315');" onmouseout="out('-2156981052151854315');" style=""> 130                 throw new IllegalArgumentException(EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL);    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 131             }                                                                                            </span>
<span class="-5768910099284843906" onmouseenter="enter('-5768910099284843906');" onmouseout="out('-5768910099284843906');" style=""> 132             final DecodedJWT jwt = this.verifier.verify(bearerToken);                                    </span>
<span class="-7357029865885638695" onmouseenter="enter('-7357029865885638695');" onmouseout="out('-7357029865885638695');" style=""> 133             // Check against cache for duplicate transactions                                            </span>
<span class="-7254451175943600487" onmouseenter="enter('-7254451175943600487');" onmouseout="out('-7254451175943600487');" style=""> 134             if (this.cache.asMap().containsKey(transaction.getRequestUuid())) {                          </span>
<span class="8161468239609895872" onmouseenter="enter('8161468239609895872');" onmouseout="out('8161468239609895872');" style=""> 135                 throw new IllegalStateException(EXCEPTION_MESSAGE_DUPLICATE_TRANSACTION);                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 136             }                                                                                            </span>
<span class="-6962791519859020761" onmouseenter="enter('-6962791519859020761');" onmouseout="out('-6962791519859020761');" style=""> 137             // validate transaction                                                                      </span>
<span class="-4349899182181033152" onmouseenter="enter('-4349899182181033152');" onmouseout="out('-4349899182181033152');" style=""><abbr title=" 138             transactionValidator.validateTransaction(localRoutingNum, jwt.getClaim(JWT_ACCOUNT_KEY).asString(), transaction);"> 138             transactionValidator.validateTransaction(localRoutingNum, jwt.getClaim(JWT_ACCOUNT_KEY).asStr</abbr></span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style=""> 139             // Ensure sender balance can cover transaction.                                              </span>
<span class="-6144219964793655128" onmouseenter="enter('-6144219964793655128');" onmouseout="out('-6144219964793655128');" style=""> 140             if (transaction.getFromRoutingNum().equals(localRoutingNum)) {                               </span>
<span class="-6428277790266189321" onmouseenter="enter('-6428277790266189321');" onmouseout="out('-6428277790266189321');" style=""> 141                 int balance = getAvailableBalance(bearerToken, transaction.getFromAccountNum());         </span>
<span class="-8424323426889164999" onmouseenter="enter('-8424323426889164999');" onmouseout="out('-8424323426889164999');" style=""> 142                 if (balance &lt; transaction.getAmount()) {                                                 </span>
<span class="1217103842749309612" onmouseenter="enter('1217103842749309612');" onmouseout="out('1217103842749309612');" style=""> 143                     LOGGER.error(&quot;Transaction submission failed: &quot; + &quot;Insufficient balance&quot;);            </span>
<span class="2008293410870114109" onmouseenter="enter('2008293410870114109');" onmouseout="out('2008293410870114109');" style=""> 144                     throw new IllegalStateException(EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE);             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 145                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 146             }                                                                                            </span>
<span class="-3539745766511737220" onmouseenter="enter('-3539745766511737220');" onmouseout="out('-3539745766511737220');" style=""> 147             // No exceptions thrown. Add to ledger                                                       </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style=""> 148             transactionRepository.save(transaction);                                                     </span>
<span  style=""> 149                                                                                                          </span>
<span class="-6681681893462133916" onmouseenter="enter('-6681681893462133916');" onmouseout="out('-6681681893462133916');" style=""> 150 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT                                                                                             </span>
<span class="-2122798952495658084" onmouseenter="enter('-2122798952495658084');" onmouseout="out('-2122798952495658084');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151             this.cache.put(transaction.getRequestUuid(),                                                 </span>
<span class="-2743452731222378684" onmouseenter="enter('-2743452731222378684');" onmouseout="out('-2743452731222378684');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152                     transaction.getTransactionId());                                                     </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 153 ||||||| BASE                                                                                             </span>
<span class="-3639349873877828882" onmouseenter="enter('-3639349873877828882');" onmouseout="out('-3639349873877828882');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 154 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 154 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 155 =======                                                                                                  </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156                                                                                                          </span>
<span class="5719956641649610757" onmouseenter="enter('5719956641649610757');" onmouseout="out('5719956641649610757');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157             LOGGER.info(&quot;Submitted transaction successfully&quot;);                                           </span>
<span class="-1814092468913316143" onmouseenter="enter('-1814092468913316143');" onmouseout="out('-1814092468913316143');" style=""> 158 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT                                                                                            </span>
<span  style=""> 159                                                                                                          </span>
<span class="-4163445762070976221" onmouseenter="enter('-4163445762070976221');" onmouseout="out('-4163445762070976221');" style=""> 160             return new ResponseEntity&lt;String&gt;(READINESS_CODE, HttpStatus.CREATED);                       </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 161         } catch (JWTVerificationException e) {                                                           </span>
<span class="-4223624655466402674" onmouseenter="enter('-4223624655466402674');" onmouseout="out('-4223624655466402674');" style=""> 162             LOGGER.error(&quot;Failed to submit transaction: &quot; + &quot;not authorized&quot;);                           </span>
<span class="-1619102264012411381" onmouseenter="enter('-1619102264012411381');" onmouseout="out('-1619102264012411381');" style=""> 163             return new ResponseEntity&lt;String&gt;(UNAUTHORIZED_CODE, HttpStatus.UNAUTHORIZED);               </span>
<span class="7469340751764207194" onmouseenter="enter('7469340751764207194');" onmouseout="out('7469340751764207194');" style=""> 164         } catch (java.lang.IllegalArgumentException | java.lang.IllegalStateException e) {               </span>
<span class="4739833175287299564" onmouseenter="enter('4739833175287299564');" onmouseout="out('4739833175287299564');" style=""> 165             LOGGER.error(&quot;Failed to retrieve account balance: &quot; + &quot;bad request&quot;);                        </span>
<span class="-2722904246444290120" onmouseenter="enter('-2722904246444290120');" onmouseout="out('-2722904246444290120');" style=""> 166             return new ResponseEntity&lt;String&gt;(e.getMessage(), HttpStatus.BAD_REQUEST);                   </span>
<span class="786637002087973023" onmouseenter="enter('786637002087973023');" onmouseout="out('786637002087973023');" style=""><abbr title=" 167         } catch (ResourceAccessException | CannotCreateTransactionException | HttpServerErrorException e) {"> 167         } catch (ResourceAccessException | CannotCreateTransactionException | HttpServerErrorException e)</abbr></span>
<span class="-6756904505334648824" onmouseenter="enter('-6756904505334648824');" onmouseout="out('-6756904505334648824');" style=""> 168             LOGGER.error(&quot;Failed to retrieve account balance&quot;);                                          </span>
<span class="-6944296864182889898" onmouseenter="enter('-6944296864182889898');" onmouseout="out('-6944296864182889898');" style=""> 169             return new ResponseEntity&lt;String&gt;(e.getMessage(), HttpStatus.INTERNAL_SERVER_ERROR);         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 170         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 171     }                                                                                                    </span>
<span  style=""> 172                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 173     /**                                                                                                  </span>
<span class="-840803106370353754" onmouseenter="enter('-840803106370353754');" onmouseout="out('-840803106370353754');" style=""> 174      * Retrieve the balance for the transaction&#x27;s sender.                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 175      *                                                                                                   </span>
<span class="-5399624366599429167" onmouseenter="enter('-5399624366599429167');" onmouseout="out('-5399624366599429167');" style=""> 176      * @param token  the token used to authenticate request                                              </span>
<span class="5530241027805460636" onmouseenter="enter('5530241027805460636');" onmouseout="out('5530241027805460636');" style=""> 177      * @param fromAcct  sender account number                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 178      *                                                                                                   </span>
<span class="-4671862933441611565" onmouseenter="enter('-4671862933441611565');" onmouseout="out('-4671862933441611565');" style=""> 179      * @return available balance of the sender account                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 180      *                                                                                                   </span>
<span class="7966166498405371741" onmouseenter="enter('7966166498405371741');" onmouseout="out('7966166498405371741');" style=""> 181      * @throws HttpServerErrorException  if balance service returns 500                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 182      */                                                                                                  </span>
<span class="-5956584025775144244" onmouseenter="enter('-5956584025775144244');" onmouseout="out('-5956584025775144244');" style=""> 183     protected int getAvailableBalance(String token, String fromAcct) throws HttpServerErrorException {   </span>
<span class="2945528015156409897" onmouseenter="enter('2945528015156409897');" onmouseout="out('2945528015156409897');" style=""> 184         LOGGER.debug(&quot;Retrieving balance for transaction sender&quot;);                                       </span>
<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 185         HttpHeaders headers = new HttpHeaders();                                                         </span>
<span class="3201291767686862102" onmouseenter="enter('3201291767686862102');" onmouseout="out('3201291767686862102');" style=""> 186         headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + token);                                                 </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 187         HttpEntity entity = new HttpEntity(headers);                                                     </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 188         RestTemplate restTemplate = new RestTemplate();                                                  </span>
<span class="-369342590083106532" onmouseenter="enter('-369342590083106532');" onmouseout="out('-369342590083106532');" style=""> 189         String uri = (balancesApiUri + &quot;/&quot;) + fromAcct;                                                  </span>
<span class="1359361039333264780" onmouseenter="enter('1359361039333264780');" onmouseout="out('1359361039333264780');" style=""><abbr title=" 190         ResponseEntity&lt;Integer&gt; response = restTemplate.exchange(uri, HttpMethod.GET, entity, java.lang.Integer.class);"> 190         ResponseEntity&lt;Integer&gt; response = restTemplate.exchange(uri, HttpMethod.GET, entity, java.lang.I</abbr></span>
<span class="6400740982500579689" onmouseenter="enter('6400740982500579689');" onmouseout="out('6400740982500579689');" style=""> 191         Integer senderBalance = response.getBody();                                                      </span>
<span class="8092340863849585815" onmouseenter="enter('8092340863849585815');" onmouseout="out('8092340863849585815');" style=""> 192         return senderBalance.intValue();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 193     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 194 }                                                                                                        </span>
























































</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2   * Copyright 2020, Google LLC.                                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3   *                                                                                                                </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                                </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5   * you may not use this file except in compliance with the License.                                               </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6   * You may obtain a copy of the License at                                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7   *                                                                                                                </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8   *     http://www.apache.org/licenses/LICENSE-2.0                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9   *                                                                                                                </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10   * Unless required by applicable law or agreed to in writing, software                                            </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                              </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                       </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13   * See the License for the specific language governing permissions and                                            </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14   * limitations under the License.                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15   */                                                                                                               </span>
<span  style="">  16                                                                                                                    </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  17  package anthos.samples.financedemo.ledgerwriter;                                                                  </span>
<span  style="">  18                                                                                                                    </span>
<span class="-6356287537734540725" onmouseenter="enter('-6356287537734540725');" onmouseout="out('-6356287537734540725');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +import java.util.concurrent.TimeUnit;                                                                             </span>
<span class="3887843854525453733" onmouseenter="enter('3887843854525453733');" onmouseout="out('3887843854525453733');" style="">  20  import java.util.logging.Logger;                                                                                  </span>
<span  style="">  21                                                                                                                    </span>


<span class="3248634983943737307" onmouseenter="enter('3248634983943737307');" onmouseout="out('3248634983943737307');" style="">  22  import  org.springframework.web.client.HttpServerErrorException;                                                  </span>
<span  style="">  23                                                                                                                    </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  24  import org.springframework.beans.factory.annotation.Value;                                                        </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  25  import org.springframework.http.HttpEntity;                                                                       </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  26  import org.springframework.http.HttpHeaders;                                                                      </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  27  import org.springframework.http.HttpMethod;                                                                       </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  28  import org.springframework.http.HttpStatus;                                                                       </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  29  import org.springframework.http.ResponseEntity;                                                                   </span>
<span class="5341219335560996028" onmouseenter="enter('5341219335560996028');" onmouseout="out('5341219335560996028');" style="">  30  import org.springframework.transaction.CannotCreateTransactionException;                                          </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  31  import org.springframework.web.bind.annotation.GetMapping;                                                        </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  32  import org.springframework.web.bind.annotation.PostMapping;                                                       </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  33  import org.springframework.web.bind.annotation.RequestBody;                                                       </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  34  import org.springframework.web.bind.annotation.RequestHeader;                                                     </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  35  import org.springframework.web.bind.annotation.ResponseStatus;                                                    </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  36  import org.springframework.web.bind.annotation.RestController;                                                    </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="">  37  import org.springframework.web.client.ResourceAccessException;                                                    </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  38  import org.springframework.web.client.RestTemplate;                                                               </span>
<span  style="">  39                                                                                                                    </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  40  import com.auth0.jwt.JWTVerifier;                                                                                 </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  41  import com.auth0.jwt.exceptions.JWTVerificationException;                                                         </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  42  import com.auth0.jwt.interfaces.DecodedJWT;                                                                       </span>
<span  style="">  43                                                                                                                    </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +                                                                                                                  </span>
<span class="8064918626260915349" onmouseenter="enter('8064918626260915349');" onmouseout="out('8064918626260915349');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import com.google.common.cache.Cache;                                                                             </span>
<span class="-5185947672099267182" onmouseenter="enter('-5185947672099267182');" onmouseout="out('-5185947672099267182');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +import com.google.common.cache.CacheBuilder;                                                                      </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +                                                                                                                  </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="">  48  import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                          </span>
<span class="5485927036637514847" onmouseenter="enter('5485927036637514847');" onmouseout="out('5485927036637514847');" style="">  49          EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE;                                                                   </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="">  50  import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                          </span>
<span class="-8362488606383815534" onmouseenter="enter('-8362488606383815534');" onmouseout="out('-8362488606383815534');" style="">  51          EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL;                                                         </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                          </span>
<span class="4868142399698679402" onmouseenter="enter('4868142399698679402');" onmouseout="out('4868142399698679402');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +        EXCEPTION_MESSAGE_DUPLICATE_TRANSACTION;                                                                  </span>
<span  style="">  54                                                                                                                    </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  55  @RestController                                                                                                   </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  56  public final class LedgerWriterController {                                                                       </span>
<span  style="">  57                                                                                                                    </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="">  58      private static final Logger LOGGER =                                                                          </span>
<span class="-7957956039430515397" onmouseenter="enter('-7957956039430515397');" onmouseout="out('-7957956039430515397');" style="">  59              Logger.getLogger(LedgerWriterController.class.getName());                                             </span>

<span  style="">  60                                                                                                                    </span>
<span class="-728019112929028725" onmouseenter="enter('-728019112929028725');" onmouseout="out('-728019112929028725');" style="">  61      private TransactionRepository transactionRepository;                                                          </span>
<span class="-4578700528226723750" onmouseenter="enter('-4578700528226723750');" onmouseout="out('-4578700528226723750');" style="">  62      private TransactionValidator transactionValidator;                                                            </span>
<span class="-5049251535661215052" onmouseenter="enter('-5049251535661215052');" onmouseout="out('-5049251535661215052');" style="">  63      private JWTVerifier verifier;                                                                                 </span>
<span  style="">  64                                                                                                                    </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="">  65      private String localRoutingNum;                                                                               </span>
<span class="-469486944919448386" onmouseenter="enter('-469486944919448386');" onmouseout="out('-469486944919448386');" style="">  66      private String balancesApiUri;                                                                                </span>
<span class="6148824265517010025" onmouseenter="enter('6148824265517010025');" onmouseout="out('6148824265517010025');" style="">  67      private String version;                                                                                       </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +                                                                                                                  </span>
<span class="998797035934579942" onmouseenter="enter('998797035934579942');" onmouseout="out('998797035934579942');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +    private Cache&lt;String, Long&gt; cache;                                                                            </span>
<span  style="">  70                                                                                                                    </span>
<span class="-6505034648581184544" onmouseenter="enter('-6505034648581184544');" onmouseout="out('-6505034648581184544');" style="">  71      public static final String READINESS_CODE = &quot;ok&quot;;                                                             </span>
<span class="-9149089262416743429" onmouseenter="enter('-9149089262416743429');" onmouseout="out('-9149089262416743429');" style="">  72      public static final String UNAUTHORIZED_CODE = &quot;not authorized&quot;;                                              </span>
<span class="6290000176908202808" onmouseenter="enter('6290000176908202808');" onmouseout="out('6290000176908202808');" style="">  73      public static final String JWT_ACCOUNT_KEY = &quot;acct&quot;;                                                          </span>
<span  style="">  74                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  75      /**                                                                                                           </span>
<span class="-1436741038288612910" onmouseenter="enter('-1436741038288612910');" onmouseout="out('-1436741038288612910');" style="">  76      * Constructor.                                                                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  77      *                                                                                                             </span>
<span class="-5348532432243399187" onmouseenter="enter('-5348532432243399187');" onmouseout="out('-5348532432243399187');" style="">  78      * Initializes JWT verifier.                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  79      */                                                                                                            </span>
<span  style="">  80                                                                                                                    </span>
<span class="8937474768837710123" onmouseenter="enter('8937474768837710123');" onmouseout="out('8937474768837710123');" style="">  81      public LedgerWriterController(                                                                                </span>
<span class="2780303771851218368" onmouseenter="enter('2780303771851218368');" onmouseout="out('2780303771851218368');" style="">  82              JWTVerifier verifier,                                                                                 </span>
<span class="1132068715177995291" onmouseenter="enter('1132068715177995291');" onmouseout="out('1132068715177995291');" style="">  83              TransactionRepository transactionRepository,                                                          </span>
<span class="5479269793478582431" onmouseenter="enter('5479269793478582431');" onmouseout="out('5479269793478582431');" style="">  84              TransactionValidator transactionValidator,                                                            </span>
<span class="-822564396537268339" onmouseenter="enter('-822564396537268339');" onmouseout="out('-822564396537268339');" style="">  85              @Value(&quot;${LOCAL_ROUTING_NUM}&quot;) String localRoutingNum,                                                </span>
<span class="-2250521274199702466" onmouseenter="enter('-2250521274199702466');" onmouseout="out('-2250521274199702466');" style="">  86              @Value(&quot;http://${BALANCES_API_ADDR}/balances&quot;)                                                        </span>
<span class="5760341242560825698" onmouseenter="enter('5760341242560825698');" onmouseout="out('5760341242560825698');" style="">  87                      String balancesApiUri,                                                                        </span>
<span class="3727660980762547349" onmouseenter="enter('3727660980762547349');" onmouseout="out('3727660980762547349');" style="">  88              @Value(&quot;${VERSION}&quot;) String version) {                                                                </span>
<span class="2791682847397564046" onmouseenter="enter('2791682847397564046');" onmouseout="out('2791682847397564046');" style="">  89          this.verifier = verifier;                                                                                 </span>
<span class="5620916918385755227" onmouseenter="enter('5620916918385755227');" onmouseout="out('5620916918385755227');" style="">  90          this.transactionRepository = transactionRepository;                                                       </span>
<span class="7194621662788445012" onmouseenter="enter('7194621662788445012');" onmouseout="out('7194621662788445012');" style="">  91          this.transactionValidator = transactionValidator;                                                         </span>
<span class="5248812605098956146" onmouseenter="enter('5248812605098956146');" onmouseout="out('5248812605098956146');" style="">  92          this.localRoutingNum = localRoutingNum;                                                                   </span>
<span class="-1729773563907748731" onmouseenter="enter('-1729773563907748731');" onmouseout="out('-1729773563907748731');" style="">  93          this.balancesApiUri = balancesApiUri;                                                                     </span>
<span class="8734022701570323791" onmouseenter="enter('8734022701570323791');" onmouseout="out('8734022701570323791');" style="">  94          this.version = version;                                                                                   </span>
<span class="8244837015881776783" onmouseenter="enter('8244837015881776783');" onmouseout="out('8244837015881776783');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +        // Initialize cache to ignore duplicate transactions                                                      </span>
<span class="-1757741908889032370" onmouseenter="enter('-1757741908889032370');" onmouseout="out('-1757741908889032370');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +        this.cache = CacheBuilder.newBuilder()                                                                    </span>
<span class="8658036842979585808" onmouseenter="enter('8658036842979585808');" onmouseout="out('8658036842979585808');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +                            .expireAfterWrite(1, TimeUnit.HOURS)                                                  </span>
<span class="-368814941510255410" onmouseenter="enter('-368814941510255410');" onmouseout="out('-368814941510255410');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +                            .build();                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  99      }                                                                                                             </span>
<span  style=""> 100                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 101      /**                                                                                                           </span>
<span class="559132540195676827" onmouseenter="enter('559132540195676827');" onmouseout="out('559132540195676827');" style=""> 102       * Version endpoint.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 103       *                                                                                                            </span>
<span class="-3837725526160323045" onmouseenter="enter('-3837725526160323045');" onmouseout="out('-3837725526160323045');" style=""> 104       * @return  service version string                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 105       */                                                                                                           </span>
<span class="6685475051439146687" onmouseenter="enter('6685475051439146687');" onmouseout="out('6685475051439146687');" style=""> 106      @GetMapping(&quot;/version&quot;)                                                                                       </span>
<span class="580444279607563843" onmouseenter="enter('580444279607563843');" onmouseout="out('580444279607563843');" style=""> 107      public ResponseEntity version() {                                                                             </span>
<span class="5343850267959959664" onmouseenter="enter('5343850267959959664');" onmouseout="out('5343850267959959664');" style=""> 108          return new ResponseEntity&lt;String&gt;(version, HttpStatus.OK);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 109      }                                                                                                             </span>
<span  style=""> 110                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 111      /**                                                                                                           </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style=""> 112       * Readiness probe endpoint.                                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 113       *                                                                                                            </span>
<span class="8463518254556868911" onmouseenter="enter('8463518254556868911');" onmouseout="out('8463518254556868911');" style=""> 114       * @return HTTP Status 200 if server is ready to receive requests.                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 115       */                                                                                                           </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style=""> 116      @GetMapping(&quot;/ready&quot;)                                                                                         </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 117      @ResponseStatus(HttpStatus.OK)                                                                                </span>
<span class="7271346341917529010" onmouseenter="enter('7271346341917529010');" onmouseout="out('7271346341917529010');" style=""> 118      public ResponseEntity&lt;String&gt; readiness() {                                                                   </span>
<span class="-4075762798656461919" onmouseenter="enter('-4075762798656461919');" onmouseout="out('-4075762798656461919');" style=""> 119          return new ResponseEntity&lt;String&gt;(READINESS_CODE, HttpStatus.OK);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 120      }                                                                                                             </span>
<span  style=""> 121                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 122      /**                                                                                                           </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style=""> 123       * Submit a new transaction to the ledger.                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 124       *                                                                                                            </span>
<span class="-1661212859137511783" onmouseenter="enter('-1661212859137511783');" onmouseout="out('-1661212859137511783');" style=""> 125       * @param bearerToken  HTTP request &#x27;Authorization&#x27; header                                                    </span>
<span class="5399615509278749127" onmouseenter="enter('5399615509278749127');" onmouseout="out('5399615509278749127');" style=""> 126       * @param transaction  transaction to submit                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 127       *                                                                                                            </span>
<span class="7486646966745340100" onmouseenter="enter('7486646966745340100');" onmouseout="out('7486646966745340100');" style=""> 128       * @return  HTTP Status 200 if transaction was successfully submitted                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 129       */                                                                                                           </span>
<span class="5323932416516552401" onmouseenter="enter('5323932416516552401');" onmouseout="out('5323932416516552401');" style=""> 130      @PostMapping(value = &quot;/transactions&quot;, consumes = &quot;application/json&quot;)                                          </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 131      @ResponseStatus(HttpStatus.OK)                                                                                </span>
<span class="1897907323625472935" onmouseenter="enter('1897907323625472935');" onmouseout="out('1897907323625472935');" style=""> 132      public ResponseEntity&lt;?&gt; addTransaction(                                                                      </span>
<span class="1166903297081280981" onmouseenter="enter('1166903297081280981');" onmouseout="out('1166903297081280981');" style=""> 133              @RequestHeader(&quot;Authorization&quot;) String bearerToken,                                                   </span>
<span class="9022696444049056102" onmouseenter="enter('9022696444049056102');" onmouseout="out('9022696444049056102');" style=""> 134              @RequestBody Transaction transaction) {                                                               </span>
<span class="-3538581758087352701" onmouseenter="enter('-3538581758087352701');" onmouseout="out('-3538581758087352701');" style=""> 135          if (bearerToken != null &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                           </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 136              bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137          }                                                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 138          try {                                                                                                     </span>
<span class="-4457463381546497224" onmouseenter="enter('-4457463381546497224');" onmouseout="out('-4457463381546497224');" style=""> 139              if (bearerToken == null) {                                                                            </span>


<span class="-5454936540258631376" onmouseenter="enter('-5454936540258631376');" onmouseout="out('-5454936540258631376');" style=""> 140                  throw new IllegalArgumentException(                                                               </span>
<span class="-4688472594501119643" onmouseenter="enter('-4688472594501119643');" onmouseout="out('-4688472594501119643');" style=""> 141                          EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 142              }                                                                                                     </span>
<span class="-5768910099284843906" onmouseenter="enter('-5768910099284843906');" onmouseout="out('-5768910099284843906');" style=""> 143              final DecodedJWT jwt = this.verifier.verify(bearerToken);                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +                                                                                                                  </span>
<span class="-7357029865885638695" onmouseenter="enter('-7357029865885638695');" onmouseout="out('-7357029865885638695');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +            // Check against cache for duplicate transactions                                                     </span>
<span class="-7254451175943600487" onmouseenter="enter('-7254451175943600487');" onmouseout="out('-7254451175943600487');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +            if (this.cache.asMap().containsKey(transaction.getRequestUuid())) {                                   </span>
<span class="-8046945014218387655" onmouseenter="enter('-8046945014218387655');" onmouseout="out('-8046945014218387655');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +                throw new IllegalStateException(                                                                  </span>
<span class="5344096214519321268" onmouseenter="enter('5344096214519321268');" onmouseout="out('5344096214519321268');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +                        EXCEPTION_MESSAGE_DUPLICATE_TRANSACTION);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +            }                                                                                                     </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +                                                                                                                  </span>
<span class="-6962791519859020761" onmouseenter="enter('-6962791519859020761');" onmouseout="out('-6962791519859020761');" style=""> 151              // validate transaction                                                                               </span>
<span class="776637986685870327" onmouseenter="enter('776637986685870327');" onmouseout="out('776637986685870327');" style=""> 152              transactionValidator.validateTransaction(localRoutingNum,                                             </span>
<span class="-4879758647615452357" onmouseenter="enter('-4879758647615452357');" onmouseout="out('-4879758647615452357');" style=""> 153                      jwt.getClaim(JWT_ACCOUNT_KEY).asString(), transaction);                                       </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style=""> 154              // Ensure sender balance can cover transaction.                                                       </span>
<span class="-6144219964793655128" onmouseenter="enter('-6144219964793655128');" onmouseout="out('-6144219964793655128');" style=""> 155              if (transaction.getFromRoutingNum().equals(localRoutingNum)) {                                        </span>
<span class="7239735847198029864" onmouseenter="enter('7239735847198029864');" onmouseout="out('7239735847198029864');" style=""> 156                  int balance = getAvailableBalance(                                                                </span>
<span class="7702083458280016025" onmouseenter="enter('7702083458280016025');" onmouseout="out('7702083458280016025');" style=""> 157                          bearerToken, transaction.getFromAccountNum());                                            </span>
<span class="-8424323426889164999" onmouseenter="enter('-8424323426889164999');" onmouseout="out('-8424323426889164999');" style=""> 158                  if (balance &lt; transaction.getAmount()) {                                                          </span>


<span class="-8046945014218387655" onmouseenter="enter('-8046945014218387655');" onmouseout="out('-8046945014218387655');" style=""> 159                      throw new IllegalStateException(                                                              </span>
<span class="-5146115328615515543" onmouseenter="enter('-5146115328615515543');" onmouseout="out('-5146115328615515543');" style=""> 160                              EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE);                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 162              }                                                                                                     </span>
<span  style=""> 163                                                                                                                    </span>
<span class="-3539745766511737220" onmouseenter="enter('-3539745766511737220');" onmouseout="out('-3539745766511737220');" style=""> 164              // No exceptions thrown. Add to ledger                                                                </span>
<span class="613498208305766257" onmouseenter="enter('613498208305766257');" onmouseout="out('613498208305766257');" style=""> 165              LOGGER.fine(&quot;Submitting transaction &quot;                                                                 </span>
<span class="2531207035820706002" onmouseenter="enter('2531207035820706002');" onmouseout="out('2531207035820706002');" style=""> 166                      + transaction.toString());                                                                    </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style=""> 167              transactionRepository.save(transaction);                                                              </span>
<span class="-2122798952495658084" onmouseenter="enter('-2122798952495658084');" onmouseout="out('-2122798952495658084');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +            this.cache.put(transaction.getRequestUuid(),                                                          </span>
<span class="-2743452731222378684" onmouseenter="enter('-2743452731222378684');" onmouseout="out('-2743452731222378684');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +                    transaction.getTransactionId());                                                              </span>
<span class="-5231725033690787161" onmouseenter="enter('-5231725033690787161');" onmouseout="out('-5231725033690787161');" style=""> 170              return new ResponseEntity&lt;String&gt;(READINESS_CODE,                                                     </span>
<span class="-8527330892964817671" onmouseenter="enter('-8527330892964817671');" onmouseout="out('-8527330892964817671');" style=""> 171                      HttpStatus.CREATED);                                                                          </span>
<span  style=""> 172                                                                                                                    </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 173          } catch (JWTVerificationException e) {                                                                    </span>


<span class="-4154758301555607236" onmouseenter="enter('-4154758301555607236');" onmouseout="out('-4154758301555607236');" style=""> 174              return new ResponseEntity&lt;String&gt;(UNAUTHORIZED_CODE,                                                  </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 175                                                HttpStatus.UNAUTHORIZED);                                           </span>
<span class="-16261657306661328" onmouseenter="enter('-16261657306661328');" onmouseout="out('-16261657306661328');" style=""> 176          } catch (IllegalArgumentException | IllegalStateException e) {                                            </span>


<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style=""> 177              return new ResponseEntity&lt;String&gt;(e.getMessage(),                                                     </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 178                                                HttpStatus.BAD_REQUEST);                                            </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style=""> 179          } catch (ResourceAccessException                                                                          </span>
<span class="7920423166678117814" onmouseenter="enter('7920423166678117814');" onmouseout="out('7920423166678117814');" style=""> 180                  | CannotCreateTransactionException                                                                </span>
<span class="-7265908382255363783" onmouseenter="enter('-7265908382255363783');" onmouseout="out('-7265908382255363783');" style=""> 181                  | HttpServerErrorException e) {                                                                   </span>

<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style=""> 182              return new ResponseEntity&lt;String&gt;(e.getMessage(),                                                     </span>
<span class="862392687202373996" onmouseenter="enter('862392687202373996');" onmouseout="out('862392687202373996');" style=""> 183                                                HttpStatus.INTERNAL_SERVER_ERROR);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 184          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 185      }                                                                                                             </span>
<span  style=""> 186                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 187      /**                                                                                                           </span>
<span class="-840803106370353754" onmouseenter="enter('-840803106370353754');" onmouseout="out('-840803106370353754');" style=""> 188       * Retrieve the balance for the transaction&#x27;s sender.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 189       *                                                                                                            </span>
<span class="-5399624366599429167" onmouseenter="enter('-5399624366599429167');" onmouseout="out('-5399624366599429167');" style=""> 190       * @param token  the token used to authenticate request                                                       </span>
<span class="5530241027805460636" onmouseenter="enter('5530241027805460636');" onmouseout="out('5530241027805460636');" style=""> 191       * @param fromAcct  sender account number                                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 192       *                                                                                                            </span>
<span class="-4671862933441611565" onmouseenter="enter('-4671862933441611565');" onmouseout="out('-4671862933441611565');" style=""> 193       * @return available balance of the sender account                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 194       *                                                                                                            </span>
<span class="7966166498405371741" onmouseenter="enter('7966166498405371741');" onmouseout="out('7966166498405371741');" style=""> 195       * @throws HttpServerErrorException  if balance service returns 500                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 196       */                                                                                                           </span>
<span class="-4867839573468993721" onmouseenter="enter('-4867839573468993721');" onmouseout="out('-4867839573468993721');" style=""> 197      protected int getAvailableBalance(String token, String fromAcct)                                              </span>
<span class="7044480961715798280" onmouseenter="enter('7044480961715798280');" onmouseout="out('7044480961715798280');" style=""> 198              throws HttpServerErrorException {                                                                     </span>


<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 199          HttpHeaders headers = new HttpHeaders();                                                                  </span>
<span class="3201291767686862102" onmouseenter="enter('3201291767686862102');" onmouseout="out('3201291767686862102');" style=""> 200          headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + token);                                                          </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 201          HttpEntity entity = new HttpEntity(headers);                                                              </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 202          RestTemplate restTemplate = new RestTemplate();                                                           </span>
<span class="5149154134365859036" onmouseenter="enter('5149154134365859036');" onmouseout="out('5149154134365859036');" style=""> 203          String uri = balancesApiUri + &quot;/&quot; + fromAcct;                                                             </span>
<span class="-697674251075958280" onmouseenter="enter('-697674251075958280');" onmouseout="out('-697674251075958280');" style=""> 204          ResponseEntity&lt;Integer&gt; response = restTemplate.exchange(                                                 </span>
<span class="6083870125336786698" onmouseenter="enter('6083870125336786698');" onmouseout="out('6083870125336786698');" style=""> 205              uri, HttpMethod.GET, entity, Integer.class);                                                          </span>
<span class="6400740982500579689" onmouseenter="enter('6400740982500579689');" onmouseout="out('6400740982500579689');" style=""> 206          Integer senderBalance = response.getBody();                                                               </span>
<span class="8092340863849585815" onmouseenter="enter('8092340863849585815');" onmouseout="out('8092340863849585815');" style=""> 207          return senderBalance.intValue();                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 208      }                                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 209 -                                                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 210  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2   * Copyright 2020, Google LLC.                                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3   *                                                                                                                </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                                </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5   * you may not use this file except in compliance with the License.                                               </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6   * You may obtain a copy of the License at                                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7   *                                                                                                                </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8   *     http://www.apache.org/licenses/LICENSE-2.0                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9   *                                                                                                                </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10   * Unless required by applicable law or agreed to in writing, software                                            </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                              </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                       </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13   * See the License for the specific language governing permissions and                                            </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14   * limitations under the License.                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15   */                                                                                                               </span>
<span  style="">  16                                                                                                                    </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  17  package anthos.samples.financedemo.ledgerwriter;                                                                  </span>
<span  style="">  18                                                                                                                    </span>

<span class="3887843854525453733" onmouseenter="enter('3887843854525453733');" onmouseout="out('3887843854525453733');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  19 -import java.util.logging.Logger;                                                                                  </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  20 -                                                                                                                  </span>
<span class="-538473715904851717" onmouseenter="enter('-538473715904851717');" onmouseout="out('-538473715904851717');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import org.apache.logging.log4j.LogManager;                                                                       </span>
<span class="2283937394492695819" onmouseenter="enter('2283937394492695819');" onmouseout="out('2283937394492695819');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.apache.logging.log4j.Logger;                                                                           </span>
<span class="3248634983943737307" onmouseenter="enter('3248634983943737307');" onmouseout="out('3248634983943737307');" style="">  23  import  org.springframework.web.client.HttpServerErrorException;                                                  </span>
<span  style="">  24                                                                                                                    </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  25  import org.springframework.beans.factory.annotation.Value;                                                        </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  26  import org.springframework.http.HttpEntity;                                                                       </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  27  import org.springframework.http.HttpHeaders;                                                                      </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  28  import org.springframework.http.HttpMethod;                                                                       </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  29  import org.springframework.http.HttpStatus;                                                                       </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  30  import org.springframework.http.ResponseEntity;                                                                   </span>
<span class="5341219335560996028" onmouseenter="enter('5341219335560996028');" onmouseout="out('5341219335560996028');" style="">  31  import org.springframework.transaction.CannotCreateTransactionException;                                          </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  32  import org.springframework.web.bind.annotation.GetMapping;                                                        </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  33  import org.springframework.web.bind.annotation.PostMapping;                                                       </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  34  import org.springframework.web.bind.annotation.RequestBody;                                                       </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  35  import org.springframework.web.bind.annotation.RequestHeader;                                                     </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  36  import org.springframework.web.bind.annotation.ResponseStatus;                                                    </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  37  import org.springframework.web.bind.annotation.RestController;                                                    </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="">  38  import org.springframework.web.client.ResourceAccessException;                                                    </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  39  import org.springframework.web.client.RestTemplate;                                                               </span>
<span  style="">  40                                                                                                                    </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  41  import com.auth0.jwt.JWTVerifier;                                                                                 </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  42  import com.auth0.jwt.exceptions.JWTVerificationException;                                                         </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  43  import com.auth0.jwt.interfaces.DecodedJWT;                                                                       </span>
<span  style="">  44                                                                                                                    </span>




<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="">  45  import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                          </span>
<span class="5485927036637514847" onmouseenter="enter('5485927036637514847');" onmouseout="out('5485927036637514847');" style="">  46          EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE;                                                                   </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="">  47  import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                          </span>
<span class="-8362488606383815534" onmouseenter="enter('-8362488606383815534');" onmouseout="out('-8362488606383815534');" style="">  48          EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL;                                                         </span>


<span  style="">  49                                                                                                                    </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  50  @RestController                                                                                                   </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  51  public final class LedgerWriterController {                                                                       </span>
<span  style="">  52                                                                                                                    </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="">  53      private static final Logger LOGGER =                                                                          </span>
<span class="-7957956039430515397" onmouseenter="enter('-7957956039430515397');" onmouseout="out('-7957956039430515397');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  54 -            Logger.getLogger(LedgerWriterController.class.getName());                                             </span>
<span class="999928017189038216" onmouseenter="enter('999928017189038216');" onmouseout="out('999928017189038216');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +        LogManager.getLogger(LedgerWriterController.class);                                                       </span>
<span  style="">  56                                                                                                                    </span>
<span class="-728019112929028725" onmouseenter="enter('-728019112929028725');" onmouseout="out('-728019112929028725');" style="">  57      private TransactionRepository transactionRepository;                                                          </span>
<span class="-4578700528226723750" onmouseenter="enter('-4578700528226723750');" onmouseout="out('-4578700528226723750');" style="">  58      private TransactionValidator transactionValidator;                                                            </span>
<span class="-5049251535661215052" onmouseenter="enter('-5049251535661215052');" onmouseout="out('-5049251535661215052');" style="">  59      private JWTVerifier verifier;                                                                                 </span>
<span  style="">  60                                                                                                                    </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="">  61      private String localRoutingNum;                                                                               </span>
<span class="-469486944919448386" onmouseenter="enter('-469486944919448386');" onmouseout="out('-469486944919448386');" style="">  62      private String balancesApiUri;                                                                                </span>
<span class="6148824265517010025" onmouseenter="enter('6148824265517010025');" onmouseout="out('6148824265517010025');" style="">  63      private String version;                                                                                       </span>


<span  style="">  64                                                                                                                    </span>
<span class="-6505034648581184544" onmouseenter="enter('-6505034648581184544');" onmouseout="out('-6505034648581184544');" style="">  65      public static final String READINESS_CODE = &quot;ok&quot;;                                                             </span>
<span class="-9149089262416743429" onmouseenter="enter('-9149089262416743429');" onmouseout="out('-9149089262416743429');" style="">  66      public static final String UNAUTHORIZED_CODE = &quot;not authorized&quot;;                                              </span>
<span class="6290000176908202808" onmouseenter="enter('6290000176908202808');" onmouseout="out('6290000176908202808');" style="">  67      public static final String JWT_ACCOUNT_KEY = &quot;acct&quot;;                                                          </span>
<span  style="">  68                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  69      /**                                                                                                           </span>
<span class="-1436741038288612910" onmouseenter="enter('-1436741038288612910');" onmouseout="out('-1436741038288612910');" style="">  70      * Constructor.                                                                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  71      *                                                                                                             </span>
<span class="-5348532432243399187" onmouseenter="enter('-5348532432243399187');" onmouseout="out('-5348532432243399187');" style="">  72      * Initializes JWT verifier.                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  73      */                                                                                                            </span>
<span  style="">  74                                                                                                                    </span>
<span class="8937474768837710123" onmouseenter="enter('8937474768837710123');" onmouseout="out('8937474768837710123');" style="">  75      public LedgerWriterController(                                                                                </span>
<span class="2780303771851218368" onmouseenter="enter('2780303771851218368');" onmouseout="out('2780303771851218368');" style="">  76              JWTVerifier verifier,                                                                                 </span>
<span class="1132068715177995291" onmouseenter="enter('1132068715177995291');" onmouseout="out('1132068715177995291');" style="">  77              TransactionRepository transactionRepository,                                                          </span>
<span class="5479269793478582431" onmouseenter="enter('5479269793478582431');" onmouseout="out('5479269793478582431');" style="">  78              TransactionValidator transactionValidator,                                                            </span>
<span class="-822564396537268339" onmouseenter="enter('-822564396537268339');" onmouseout="out('-822564396537268339');" style="">  79              @Value(&quot;${LOCAL_ROUTING_NUM}&quot;) String localRoutingNum,                                                </span>
<span class="-2250521274199702466" onmouseenter="enter('-2250521274199702466');" onmouseout="out('-2250521274199702466');" style="">  80              @Value(&quot;http://${BALANCES_API_ADDR}/balances&quot;)                                                        </span>
<span class="5760341242560825698" onmouseenter="enter('5760341242560825698');" onmouseout="out('5760341242560825698');" style="">  81                      String balancesApiUri,                                                                        </span>
<span class="3727660980762547349" onmouseenter="enter('3727660980762547349');" onmouseout="out('3727660980762547349');" style="">  82              @Value(&quot;${VERSION}&quot;) String version) {                                                                </span>
<span class="2791682847397564046" onmouseenter="enter('2791682847397564046');" onmouseout="out('2791682847397564046');" style="">  83          this.verifier = verifier;                                                                                 </span>
<span class="5620916918385755227" onmouseenter="enter('5620916918385755227');" onmouseout="out('5620916918385755227');" style="">  84          this.transactionRepository = transactionRepository;                                                       </span>
<span class="7194621662788445012" onmouseenter="enter('7194621662788445012');" onmouseout="out('7194621662788445012');" style="">  85          this.transactionValidator = transactionValidator;                                                         </span>
<span class="5248812605098956146" onmouseenter="enter('5248812605098956146');" onmouseout="out('5248812605098956146');" style="">  86          this.localRoutingNum = localRoutingNum;                                                                   </span>
<span class="-1729773563907748731" onmouseenter="enter('-1729773563907748731');" onmouseout="out('-1729773563907748731');" style="">  87          this.balancesApiUri = balancesApiUri;                                                                     </span>
<span class="8734022701570323791" onmouseenter="enter('8734022701570323791');" onmouseout="out('8734022701570323791');" style="">  88          this.version = version;                                                                                   </span>




<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  89      }                                                                                                             </span>
<span  style="">  90                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  91      /**                                                                                                           </span>
<span class="559132540195676827" onmouseenter="enter('559132540195676827');" onmouseout="out('559132540195676827');" style="">  92       * Version endpoint.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  93       *                                                                                                            </span>
<span class="-3837725526160323045" onmouseenter="enter('-3837725526160323045');" onmouseout="out('-3837725526160323045');" style="">  94       * @return  service version string                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  95       */                                                                                                           </span>
<span class="6685475051439146687" onmouseenter="enter('6685475051439146687');" onmouseout="out('6685475051439146687');" style="">  96      @GetMapping(&quot;/version&quot;)                                                                                       </span>
<span class="580444279607563843" onmouseenter="enter('580444279607563843');" onmouseout="out('580444279607563843');" style="">  97      public ResponseEntity version() {                                                                             </span>
<span class="5343850267959959664" onmouseenter="enter('5343850267959959664');" onmouseout="out('5343850267959959664');" style="">  98          return new ResponseEntity&lt;String&gt;(version, HttpStatus.OK);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  99      }                                                                                                             </span>
<span  style=""> 100                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 101      /**                                                                                                           </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style=""> 102       * Readiness probe endpoint.                                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 103       *                                                                                                            </span>
<span class="8463518254556868911" onmouseenter="enter('8463518254556868911');" onmouseout="out('8463518254556868911');" style=""> 104       * @return HTTP Status 200 if server is ready to receive requests.                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 105       */                                                                                                           </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style=""> 106      @GetMapping(&quot;/ready&quot;)                                                                                         </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 107      @ResponseStatus(HttpStatus.OK)                                                                                </span>
<span class="7271346341917529010" onmouseenter="enter('7271346341917529010');" onmouseout="out('7271346341917529010');" style=""> 108      public ResponseEntity&lt;String&gt; readiness() {                                                                   </span>
<span class="-4075762798656461919" onmouseenter="enter('-4075762798656461919');" onmouseout="out('-4075762798656461919');" style=""> 109          return new ResponseEntity&lt;String&gt;(READINESS_CODE, HttpStatus.OK);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 110      }                                                                                                             </span>
<span  style=""> 111                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 112      /**                                                                                                           </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style=""> 113       * Submit a new transaction to the ledger.                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 114       *                                                                                                            </span>
<span class="-1661212859137511783" onmouseenter="enter('-1661212859137511783');" onmouseout="out('-1661212859137511783');" style=""> 115       * @param bearerToken  HTTP request &#x27;Authorization&#x27; header                                                    </span>
<span class="5399615509278749127" onmouseenter="enter('5399615509278749127');" onmouseout="out('5399615509278749127');" style=""> 116       * @param transaction  transaction to submit                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 117       *                                                                                                            </span>
<span class="7486646966745340100" onmouseenter="enter('7486646966745340100');" onmouseout="out('7486646966745340100');" style=""> 118       * @return  HTTP Status 200 if transaction was successfully submitted                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 119       */                                                                                                           </span>
<span class="5323932416516552401" onmouseenter="enter('5323932416516552401');" onmouseout="out('5323932416516552401');" style=""> 120      @PostMapping(value = &quot;/transactions&quot;, consumes = &quot;application/json&quot;)                                          </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 121      @ResponseStatus(HttpStatus.OK)                                                                                </span>
<span class="1897907323625472935" onmouseenter="enter('1897907323625472935');" onmouseout="out('1897907323625472935');" style=""> 122      public ResponseEntity&lt;?&gt; addTransaction(                                                                      </span>
<span class="1166903297081280981" onmouseenter="enter('1166903297081280981');" onmouseout="out('1166903297081280981');" style=""> 123              @RequestHeader(&quot;Authorization&quot;) String bearerToken,                                                   </span>
<span class="9022696444049056102" onmouseenter="enter('9022696444049056102');" onmouseout="out('9022696444049056102');" style=""> 124              @RequestBody Transaction transaction) {                                                               </span>
<span class="-3538581758087352701" onmouseenter="enter('-3538581758087352701');" onmouseout="out('-3538581758087352701');" style=""> 125          if (bearerToken != null &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                           </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 126              bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 127          }                                                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 128          try {                                                                                                     </span>
<span class="-4457463381546497224" onmouseenter="enter('-4457463381546497224');" onmouseout="out('-4457463381546497224');" style=""> 129              if (bearerToken == null) {                                                                            </span>
<span class="8471284381161989921" onmouseenter="enter('8471284381161989921');" onmouseout="out('8471284381161989921');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +                LOGGER.error(&quot;Transaction submission failed: &quot;                                                    </span>
<span class="-6310070690167802414" onmouseenter="enter('-6310070690167802414');" onmouseout="out('-6310070690167802414');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +                    + &quot;Authorization header null&quot;);                                                               </span>
<span class="-5454936540258631376" onmouseenter="enter('-5454936540258631376');" onmouseout="out('-5454936540258631376');" style=""> 132                  throw new IllegalArgumentException(                                                               </span>
<span class="-4688472594501119643" onmouseenter="enter('-4688472594501119643');" onmouseout="out('-4688472594501119643');" style=""> 133                          EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 134              }                                                                                                     </span>
<span class="-5768910099284843906" onmouseenter="enter('-5768910099284843906');" onmouseout="out('-5768910099284843906');" style=""> 135              final DecodedJWT jwt = this.verifier.verify(bearerToken);                                             </span>







<span class="-6962791519859020761" onmouseenter="enter('-6962791519859020761');" onmouseout="out('-6962791519859020761');" style=""> 136              // validate transaction                                                                               </span>
<span class="776637986685870327" onmouseenter="enter('776637986685870327');" onmouseout="out('776637986685870327');" style=""> 137              transactionValidator.validateTransaction(localRoutingNum,                                             </span>
<span class="-4879758647615452357" onmouseenter="enter('-4879758647615452357');" onmouseout="out('-4879758647615452357');" style=""> 138                      jwt.getClaim(JWT_ACCOUNT_KEY).asString(), transaction);                                       </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style=""> 139              // Ensure sender balance can cover transaction.                                                       </span>
<span class="-6144219964793655128" onmouseenter="enter('-6144219964793655128');" onmouseout="out('-6144219964793655128');" style=""> 140              if (transaction.getFromRoutingNum().equals(localRoutingNum)) {                                        </span>
<span class="7239735847198029864" onmouseenter="enter('7239735847198029864');" onmouseout="out('7239735847198029864');" style=""> 141                  int balance = getAvailableBalance(                                                                </span>
<span class="7702083458280016025" onmouseenter="enter('7702083458280016025');" onmouseout="out('7702083458280016025');" style=""> 142                          bearerToken, transaction.getFromAccountNum());                                            </span>
<span class="-8424323426889164999" onmouseenter="enter('-8424323426889164999');" onmouseout="out('-8424323426889164999');" style=""> 143                  if (balance &lt; transaction.getAmount()) {                                                          </span>
<span class="8471284381161989921" onmouseenter="enter('8471284381161989921');" onmouseout="out('8471284381161989921');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +                    LOGGER.error(&quot;Transaction submission failed: &quot;                                                </span>
<span class="2606405075138145997" onmouseenter="enter('2606405075138145997');" onmouseout="out('2606405075138145997');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +                        + &quot;Insufficient balance&quot;);                                                                </span>
<span class="-8046945014218387655" onmouseenter="enter('-8046945014218387655');" onmouseout="out('-8046945014218387655');" style=""> 146                      throw new IllegalStateException(                                                              </span>
<span class="-5146115328615515543" onmouseenter="enter('-5146115328615515543');" onmouseout="out('-5146115328615515543');" style=""> 147                              EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE);                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 148                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 149              }                                                                                                     </span>
<span  style=""> 150                                                                                                                    </span>
<span class="-3539745766511737220" onmouseenter="enter('-3539745766511737220');" onmouseout="out('-3539745766511737220');" style=""> 151              // No exceptions thrown. Add to ledger                                                                </span>
<span class="613498208305766257" onmouseenter="enter('613498208305766257');" onmouseout="out('613498208305766257');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 152 -            LOGGER.fine(&quot;Submitting transaction &quot;                                                                 </span>
<span class="2531207035820706002" onmouseenter="enter('2531207035820706002');" onmouseout="out('2531207035820706002');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 153 -                    + transaction.toString());                                                                    </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style=""> 154              transactionRepository.save(transaction);                                                              </span>
<span class="5719956641649610757" onmouseenter="enter('5719956641649610757');" onmouseout="out('5719956641649610757');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +            LOGGER.info(&quot;Submitted transaction successfully&quot;);                                                    </span>

<span class="-5231725033690787161" onmouseenter="enter('-5231725033690787161');" onmouseout="out('-5231725033690787161');" style=""> 156              return new ResponseEntity&lt;String&gt;(READINESS_CODE,                                                     </span>
<span class="-8527330892964817671" onmouseenter="enter('-8527330892964817671');" onmouseout="out('-8527330892964817671');" style=""> 157                      HttpStatus.CREATED);                                                                          </span>
<span  style=""> 158                                                                                                                    </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 159          } catch (JWTVerificationException e) {                                                                    </span>
<span class="-327448583504624880" onmouseenter="enter('-327448583504624880');" onmouseout="out('-327448583504624880');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +            LOGGER.error(&quot;Failed to submit transaction: &quot;                                                         </span>
<span class="5874187622003058896" onmouseenter="enter('5874187622003058896');" onmouseout="out('5874187622003058896');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                + &quot;not authorized&quot;);                                                                              </span>
<span class="-4154758301555607236" onmouseenter="enter('-4154758301555607236');" onmouseout="out('-4154758301555607236');" style=""> 162              return new ResponseEntity&lt;String&gt;(UNAUTHORIZED_CODE,                                                  </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 163                                                HttpStatus.UNAUTHORIZED);                                           </span>
<span class="-16261657306661328" onmouseenter="enter('-16261657306661328');" onmouseout="out('-16261657306661328');" style=""> 164          } catch (IllegalArgumentException | IllegalStateException e) {                                            </span>
<span class="-7663233641936656847" onmouseenter="enter('-7663233641936656847');" onmouseout="out('-7663233641936656847');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +            LOGGER.error(&quot;Failed to retrieve account balance: &quot;                                                   </span>
<span class="-1386920267869766944" onmouseenter="enter('-1386920267869766944');" onmouseout="out('-1386920267869766944');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +                + &quot;bad request&quot;);                                                                                 </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style=""> 167              return new ResponseEntity&lt;String&gt;(e.getMessage(),                                                     </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 168                                                HttpStatus.BAD_REQUEST);                                            </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style=""> 169          } catch (ResourceAccessException                                                                          </span>
<span class="7920423166678117814" onmouseenter="enter('7920423166678117814');" onmouseout="out('7920423166678117814');" style=""> 170                  | CannotCreateTransactionException                                                                </span>
<span class="-7265908382255363783" onmouseenter="enter('-7265908382255363783');" onmouseout="out('-7265908382255363783');" style=""> 171                  | HttpServerErrorException e) {                                                                   </span>
<span class="-6756904505334648824" onmouseenter="enter('-6756904505334648824');" onmouseout="out('-6756904505334648824');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +            LOGGER.error(&quot;Failed to retrieve account balance&quot;);                                                   </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style=""> 173              return new ResponseEntity&lt;String&gt;(e.getMessage(),                                                     </span>
<span class="862392687202373996" onmouseenter="enter('862392687202373996');" onmouseout="out('862392687202373996');" style=""> 174                                                HttpStatus.INTERNAL_SERVER_ERROR);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 175          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 176      }                                                                                                             </span>
<span  style=""> 177                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 178      /**                                                                                                           </span>
<span class="-840803106370353754" onmouseenter="enter('-840803106370353754');" onmouseout="out('-840803106370353754');" style=""> 179       * Retrieve the balance for the transaction&#x27;s sender.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 180       *                                                                                                            </span>
<span class="-5399624366599429167" onmouseenter="enter('-5399624366599429167');" onmouseout="out('-5399624366599429167');" style=""> 181       * @param token  the token used to authenticate request                                                       </span>
<span class="5530241027805460636" onmouseenter="enter('5530241027805460636');" onmouseout="out('5530241027805460636');" style=""> 182       * @param fromAcct  sender account number                                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 183       *                                                                                                            </span>
<span class="-4671862933441611565" onmouseenter="enter('-4671862933441611565');" onmouseout="out('-4671862933441611565');" style=""> 184       * @return available balance of the sender account                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 185       *                                                                                                            </span>
<span class="7966166498405371741" onmouseenter="enter('7966166498405371741');" onmouseout="out('7966166498405371741');" style=""> 186       * @throws HttpServerErrorException  if balance service returns 500                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 187       */                                                                                                           </span>
<span class="-4867839573468993721" onmouseenter="enter('-4867839573468993721');" onmouseout="out('-4867839573468993721');" style=""> 188      protected int getAvailableBalance(String token, String fromAcct)                                              </span>
<span class="7044480961715798280" onmouseenter="enter('7044480961715798280');" onmouseout="out('7044480961715798280');" style=""> 189              throws HttpServerErrorException {                                                                     </span>
<span class="2945528015156409897" onmouseenter="enter('2945528015156409897');" onmouseout="out('2945528015156409897');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +        LOGGER.debug(&quot;Retrieving balance for transaction sender&quot;);                                                </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +                                                                                                                  </span>
<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 192          HttpHeaders headers = new HttpHeaders();                                                                  </span>
<span class="3201291767686862102" onmouseenter="enter('3201291767686862102');" onmouseout="out('3201291767686862102');" style=""> 193          headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + token);                                                          </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 194          HttpEntity entity = new HttpEntity(headers);                                                              </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 195          RestTemplate restTemplate = new RestTemplate();                                                           </span>
<span class="5149154134365859036" onmouseenter="enter('5149154134365859036');" onmouseout="out('5149154134365859036');" style=""> 196          String uri = balancesApiUri + &quot;/&quot; + fromAcct;                                                             </span>
<span class="-697674251075958280" onmouseenter="enter('-697674251075958280');" onmouseout="out('-697674251075958280');" style=""> 197          ResponseEntity&lt;Integer&gt; response = restTemplate.exchange(                                                 </span>
<span class="6083870125336786698" onmouseenter="enter('6083870125336786698');" onmouseout="out('6083870125336786698');" style=""> 198              uri, HttpMethod.GET, entity, Integer.class);                                                          </span>
<span class="6400740982500579689" onmouseenter="enter('6400740982500579689');" onmouseout="out('6400740982500579689');" style=""> 199          Integer senderBalance = response.getBody();                                                               </span>
<span class="8092340863849585815" onmouseenter="enter('8092340863849585815');" onmouseout="out('8092340863849585815');" style=""> 200          return senderBalance.intValue();                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 201      }                                                                                                             </span>
<span  style=""> 202                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 203  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            