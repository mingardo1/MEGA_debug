<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>242</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    242
                    <a href="241.html">prev</a>
                    <a href="243.html">next</a>
                    <a href="242_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_7d965efa48243334b49155db30dad04e45e37a3e_Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;7d965efa48243334b49155db30dad04e45e37a3e:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;7d965efa48243334b49155db30dad04e45e37a3e^1:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;7d965efa48243334b49155db30dad04e45e37a3e^2:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;1294e0c80142522fc5c434cc9bd81aa52c810dfb:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.ActionBar;
   4 import android.app.Activity;
   5 import android.app.AlertDialog;
   6 import android.app.FragmentManager;
   7 import android.app.FragmentTransaction;
   8 import android.content.DialogInterface;
   9 import android.content.Intent;
  10 import android.content.SharedPreferences;
  11 import android.content.res.Configuration;
  12 import android.os.AsyncTask;
  13 import android.os.Bundle;
  14 import android.os.Parcelable;
  15 import android.preference.PreferenceManager;
  16 import android.view.Menu;
  17 import android.view.MenuInflater;
  18 import android.view.MenuItem;
  19 import android.widget.ListView;
  20 import android.widget.SearchView;
  21 
  22 import com.automattic.simplenote.models.Note;
  23 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.automattic.simplenote.models.Tag;</span>
  25 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import com.automattic.simplenote.utils.UndoBarController;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import com.google.analytics.tracking.android.EasyTracker;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import com.google.analytics.tracking.android.GoogleAnalytics;</span>
  29 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import com.automattic.simplenote.utils.PrefUtils;</span>
  31 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  32 import com.automattic.simplenote.utils.UndoBarController;
  33 import com.google.analytics.tracking.android.EasyTracker;
  34 import com.google.analytics.tracking.android.Tracker;
  35 import com.simperium.Simperium;
  36 import com.simperium.client.Bucket;
  37 import com.simperium.client.LoginActivity;
  38 import com.simperium.client.Query;
  39 import com.simperium.client.User;
  40 
  41 import java.util.Calendar;
  42 
  43 /**
  44  * An activity representing a list of Notes.
  45  * &lt;p/&gt;
  46  * The activity makes heavy use of fragments. The list of items is a
  47  * {@link NoteListFragment} and the item details (if present) is a
  48  * {@link NoteEditorFragment}.
  49  * &lt;p/&gt;
  50  * This activity also implements the required {@link NoteListFragment.Callbacks}
  51  * interface to listen for item selections.
  52  */
  53 public class NotesActivity extends Activity implements
  54         NoteListFragment.Callbacks, ActionBar.OnNavigationListener,
  55         User.AuthenticationListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,
  56         FragmentManager.OnBackStackChangedListener, Bucket.Listener&lt;Note&gt; {
  57 
  58     private boolean mIsLargeScreen, mIsLandscape;
  59     private UndoBarController mUndoBarController;
  60     private SearchView mSearchView;
  61     private MenuItem mSearchMenuItem;
  62     private NoteListFragment mNoteListFragment;
  63     private NoteEditorFragment mNoteEditorFragment;
  64     private Note mCurrentNote;
  65     private Bucket&lt;Note&gt; mNotesBucket;
  66     private Bucket&lt;Tag&gt; mTagsBucket;
  67     private int TRASH_SELECTED_ID = 1;
  68     private ActionBar mActionBar;
  69 
  70     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  71     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  72 
  73     // Google Analytics tracker
  74     private Tracker mTracker;
  75 
  76     @Override
  77     protected void onCreate(Bundle savedInstanceState) {
  78         super.onCreate(savedInstanceState);
  79         Simplenote currentApp = (Simplenote) getApplication();
  80         mNotesBucket = currentApp.getNotesBucket();
  81         mTagsBucket = currentApp.getTagsBucket();
  82         setContentView(R.layout.activity_notes);
  83 
  84         EasyTracker.getInstance().activityStart(this); // Add this method.
  85         mTracker = EasyTracker.getTracker();
  86 
  87         if (savedInstanceState == null) {
  88             mNoteListFragment = new NoteListFragment();
  89             FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
  90             fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
  91             fragmentTransaction.commit();
  92         } else {
  93             mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
  94         }
  95 
  96 
  97         Configuration config = getBaseContext().getResources().getConfiguration();
  98         if ((config.screenLayout
  99                 &amp; Configuration.SCREENLAYOUT_SIZE_MASK)
 100                 &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {
 101             mIsLargeScreen = true;
 102 
 103             if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 104                 mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 104                 mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTðŸ”µ</abbr>
 105             } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 106                 mIsLandscape = true;
 107                 addEditorFragment();
 108             }
 109         }
 110 
 111         mActionBar = getActionBar();
 112         mActionBar.setNavigationMode(ActionBar.NAVIGATION_MODE_LIST);
 113         mActionBar.setDisplayShowTitleEnabled(false);
 114 
 115         mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);
 116 
 117         getFragmentManager().addOnBackStackChangedListener(this);
 118 
 119         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 120             // Create the welcome note
 121             Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 122             welcomeNote.setCreationDate(Calendar.getInstance());
 123             welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 124             welcomeNote.setContent(getString(R.string.welcome_note));
 125             welcomeNote.getTitle();
 126             welcomeNote.save();
 127 
 128             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 129             SharedPreferences.Editor editor = preferences.edit();
 130             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 131             editor.commit();
 132         }
 133 
 134             if (Intent.ACTION_SEND.equals(getIntent().getAction())) {
 135             // Check share action
 136             Intent intent = getIntent();
 137             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 138             if (text != null) {
 139                 Note note = mNotesBucket.newObject();
 140                 note.setCreationDate(Calendar.getInstance());
 141                 note.setContent(text);
 142                 note.save();
 143                 onNoteSelected(note.getSimperiumKey());
 144                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;external_share&quot;, null);
 145             }
 146         }
 147         currentApp.getSimperium().setOnUserCreatedListener(this);
 148         currentApp.getSimperium().setAuthenticationListener(this);
 149     }
 150 
 151     private void addEditorFragment() {
 152         FragmentManager fm = getFragmentManager();
 153         FragmentTransaction ft = fm.beginTransaction();
 154         mNoteEditorFragment = new NoteEditorFragment();
 155         ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 156         ft.commitAllowingStateLoss();
 157         fm.executePendingTransactions();
 158     }
 159 
 160     @Override
 161     protected void onResume() {
 162         super.onResume();
 163 
 164         mNotesBucket.start();
 165         mTagsBucket.start();
 166 
 167         mNotesBucket.addOnNetworkChangeListener(this);
 168         mNotesBucket.addOnSaveObjectListener(this);
 169         mNotesBucket.addOnDeleteObjectListener(this);
 170 
 171         configureActionBar();
 172         invalidateOptionsMenu();
 173     }
 174 
 175     @Override
 176     protected void onPause() {
 177         super.onPause();
 178 
 179         mNotesBucket.stop();
 180         mTagsBucket.stop();
 181 
 182         mNotesBucket.removeOnNetworkChangeListener(this);
 183         mNotesBucket.removeOnSaveObjectListener(this);
 184         mNotesBucket.removeOnDeleteObjectListener(this);
 185     }
 186 
 187     @Override
 188     public void onStop() {
 189         super.onStop();
 190         EasyTracker.getInstance().activityStop(this);
 191     }
 192 
 193     public void setCurrentNote(Note note) {
 194         mCurrentNote = note;
 195     }
 196 
 197     // received a change from the network, refresh the list and the editor
 198     @Override
 199     public void onChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 200         final boolean resetEditor = mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(key);
 201         runOnUiThread(new Runnable() {
 202             @Override
 203             public void run() {
 204                 mNoteListFragment.refreshList();
 205                 if (!resetEditor) return;
 206                 if (mNoteEditorFragment != null) {
 207                     mNoteEditorFragment.refreshContent(true);
 208                 }
 209             }
 210         });
 211     }
 212 
 213     @Override
 214     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 215         runOnUiThread(new Runnable() {
 216             @Override
 217             public void run() {
 218                 mNoteListFragment.refreshList();
 219             }
 220         });
 221     }
 222 
 223     @Override
 224     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 225         runOnUiThread(new Runnable() {
 226             @Override
 227             public void run() {
 228                 mNoteListFragment.refreshList();
 229             }
 230         });
 231     }
 232 
 233     public boolean isLargeScreen() {
 234         return mIsLargeScreen;
 235     }
 236 
 237     public boolean isLargeScreenLandscape() {
 238         return mIsLargeScreen &amp;&amp; mIsLandscape;
 239     }
 240 
 241     // nbradbury 01-Apr-2013
 242     private NoteListFragment getNoteListFragment() {
 243         return mNoteListFragment;
 244     }
 245 
 246     @Override
 247     public boolean onCreateOptionsMenu(Menu menu) {
 248         super.onCreateOptionsMenu(menu);
 249         MenuInflater inflater = getMenuInflater();
 250         inflater.inflate(R.menu.notes_list, menu);
 251 
 252         mSearchMenuItem = menu.findItem(R.id.menu_search);
 253         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 254         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 255             @Override
 256             public boolean onQueryTextChange(String newText) {
 257                 if (mSearchMenuItem.isActionViewExpanded())
 258                     getNoteListFragment().searchNotes(newText);
 259                 return true;
 260             }
 261 
 262             @Override
 263             public boolean onQueryTextSubmit(String queryText) {
 264                 getNoteListFragment().searchNotes(queryText);
 265                 return true;
 266             }
 267 
 268         });
 269         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 270             @Override
 271             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 272                 showDetailPlaceholder();
 273                 getNoteListFragment().setEmptyListMessage(getString(R.string.no_notes_found));
 274                 mTracker.sendEvent(&quot;note&quot;, &quot;searched_notes&quot;, &quot;action_bar_search_tap&quot;, null);
 275                 return true;
 276             }
 277 
 278             @Override
 279             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 280                 // Show all notes again
 281                 getNoteListFragment().setEmptyListMessage(getString(R.string.no_notes));
 282                 getNoteListFragment().clearSearch();
 283                 return true;
 284             }
 285         });
 286 
 287         Simplenote currentApp = (Simplenote) getApplication();
<abbr title=" 288         if (currentApp.getSimperium().getUser() == null || currentApp.getSimperium().getUser().needsAuthentication())"> 288         if (currentApp.getSimperium().getUser() == null || currentApp.getSimperium().getUser().needsAutheðŸ”µ</abbr>
 289             menu.findItem(R.id.menu_sign_in).setVisible(true);
 290         else
 291             menu.findItem(R.id.menu_sign_in).setVisible(false);
 292 
 293         FragmentManager fm = getFragmentManager();
 294         if (fm.getBackStackEntryCount() &gt; 0) {
 295             mActionBar.setDisplayHomeAsUpEnabled(true);
 296             menu.findItem(R.id.menu_create_note).setVisible(false);
 297             menu.findItem(R.id.menu_search).setVisible(false);
 298             menu.findItem(R.id.menu_preferences).setVisible(false);
 299             menu.findItem(R.id.menu_share).setVisible(true);
 300             menu.findItem(R.id.menu_delete).setVisible(true);
 301             if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 302                 menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 303             menu.findItem(R.id.menu_edit_tags).setVisible(false);
 304             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 305         } else if (isLargeScreenLandscape()) {
 306             mActionBar.setDisplayHomeAsUpEnabled(false);
 307             mActionBar.setHomeButtonEnabled(false);
 308             menu.findItem(R.id.menu_create_note).setVisible(true);
 309             menu.findItem(R.id.menu_search).setVisible(true);
 310             menu.findItem(R.id.menu_preferences).setVisible(true);
 311             if (mCurrentNote != null) {
 312                 menu.findItem(R.id.menu_share).setVisible(true);
 313                 menu.findItem(R.id.menu_delete).setVisible(true);
 314             } else {
 315                 menu.findItem(R.id.menu_share).setVisible(false);
 316                 menu.findItem(R.id.menu_delete).setVisible(false);
 317             }
 318             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 319             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 320         } else {
 321             mActionBar.setDisplayHomeAsUpEnabled(false);
 322             mActionBar.setHomeButtonEnabled(false);
 323             menu.findItem(R.id.menu_create_note).setVisible(true);
 324             menu.findItem(R.id.menu_search).setVisible(true);
 325             menu.findItem(R.id.menu_preferences).setVisible(true);
 326             menu.findItem(R.id.menu_share).setVisible(false);
 327             menu.findItem(R.id.menu_delete).setVisible(false);
 328             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 329             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 330         }
 331 
 332         // Are we looking at the trash? Adjust menu accordingly.
 333         if (mActionBar.getSelectedNavigationIndex() == TRASH_SELECTED_ID) {
 334             menu.findItem(R.id.menu_empty_trash).setVisible(true);
 335             menu.findItem(R.id.menu_create_note).setVisible(false);
 336             menu.findItem(R.id.menu_search).setVisible(false);
 337             menu.findItem(R.id.menu_share).setVisible(false);
 338         }
 339 
 340         return true;
 341     }
 342 
 343     @Override
 344     public boolean onOptionsItemSelected(MenuItem item) {
 345         switch (item.getItemId()) {
 346             case R.id.menu_preferences:
<abbr title=" 347                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 347                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returnðŸ”µ</abbr>
 348                 Intent i = new Intent(this, PreferencesActivity.class);
 349                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 350                 return true;
 351             case R.id.menu_sign_in:
 352                 startLoginActivity();
 353                 return true;
 354             case R.id.menu_edit_tags:
 355                 Intent editTagsIntent = new Intent(this, TagsListActivity.class);
 356                 startActivity(editTagsIntent);
 357                 return true;
 358             case R.id.menu_create_note:
 359                 getNoteListFragment().addNote();
 360                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;action_bar_button&quot;, null);
 361                 return true;
 362             case R.id.menu_share:
 363                 if (mCurrentNote != null) {
 364                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 365                     shareIntent.setType(&quot;text/plain&quot;);
 366                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 367                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 367                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
 368                     mTracker.sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, null);
 369                 }
 370                 return true;
 371             case R.id.menu_delete:
 372                 if (mNoteEditorFragment != null) {
 373                     if (mCurrentNote != null) {
 374                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 375                         mCurrentNote.setModificationDate(Calendar.getInstance());
 376                         mCurrentNote.save();
 377 
 378                         if (mCurrentNote.isDeleted()) {
 379                             mUndoBarController.setDeletedNote(mCurrentNote);
<abbr title=" 380                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);"> 380                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null)ðŸ”µ</abbr>
 381                             mTracker.sendEvent(&quot;note&quot;, &quot;deleted_note&quot;, &quot;overflow_menu&quot;, null);
 382                         } else {
 383                             mTracker.sendEvent(&quot;note&quot;, &quot;restored_note&quot;, &quot;overflow_menu&quot;, null);
 384                         }
 385                         showDetailPlaceholder();
 386                     }
 387                     popNoteDetail();
 388                     NoteListFragment fragment = getNoteListFragment();
 389                     if (fragment != null) {
 390                         fragment.getPrefs();
 391                         fragment.refreshList();
 392                     }
 393                 }
 394                 return true;
 395             case R.id.menu_empty_trash:
 396                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 397 
 398                 alert.setTitle(R.string.empty_trash);
 399                 alert.setMessage(R.string.confirm_empty_trash);
 400                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 401                     public void onClick(DialogInterface dialog, int whichButton) {
 402                         new emptyTrashTask().execute();
 403                         mTracker.sendEvent(&quot;note&quot;, &quot;trash_emptied&quot;, &quot;overflow_menu&quot;, null);
 404                     }
 405                 });
 406                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 407                     public void onClick(DialogInterface dialog, int whichButton) {
 408                         // Do nothing, just closing the dialog
 409                     }
 410                 });
 411                 alert.show();
 412                 return true;
 413             case android.R.id.home:
 414                 popNoteDetail();
 415                 invalidateOptionsMenu();
 416                 return true;
 417             default:
 418                 return super.onOptionsItemSelected(item);
 419         }
 420     }
 421 
 422     protected void popNoteDetail() {
 423         FragmentManager fm = getFragmentManager();
 424         if (fm.getBackStackEntryCount() &gt; 0) {
 425             try {
 426                 fm.popBackStack();
 427             } catch (Exception e) {
 428                 e.printStackTrace();
 429             }
 430         }
 431     }
 432 
 433     /**
 434      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 435      * the item with the given ID was selected.
 436      */
 437     @Override
 438     public void onNoteSelected(String noteID) {
 439 
 440         if (mSearchMenuItem != null)
 441             mSearchMenuItem.collapseActionView();
 442 
 443         FragmentManager fm = getFragmentManager();
 444 
 445         if (!isLargeScreenLandscape()) {
 446             mActionBar.setNavigationMode(ActionBar.NAVIGATION_MODE_STANDARD);
 447             mActionBar.setDisplayShowTitleEnabled(true);
 448 
 449             // Create editor fragment
 450             Bundle arguments = new Bundle();
 451             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 452             mNoteEditorFragment = new NoteEditorFragment();
 453             mNoteEditorFragment.setArguments(arguments);
 454 
 455             // Add editor fragment to stack
 456             FragmentTransaction ft = fm.beginTransaction();
<abbr title=" 457             ft.setCustomAnimations(R.animator.slide_in, R.animator.zoom_in_and_fade, R.animator.zoom_out_and_fade, R.animator.slide_out);"> 457             ft.setCustomAnimations(R.animator.slide_in, R.animator.zoom_in_and_fade, R.animator.zoom_out_ðŸ”µ</abbr>
 458             ft.replace(R.id.noteFragmentContainer, mNoteEditorFragment);
 459             ft.addToBackStack(null);
 460             ft.commitAllowingStateLoss();
 461             fm.executePendingTransactions();
 462         } else {
 463             mNoteEditorFragment.setNote(noteID);
 464             getNoteListFragment().setNoteSelected(noteID);
 465         }
 466 
 467         mTracker.sendEvent(&quot;note&quot;, &quot;viewed_note&quot;, &quot;note_list_row_tap&quot;, null);
 468     }
 469 
 470     @Override
 471     public boolean onNavigationItemSelected(int itemPosition, long itemId) {
 472         // TODO Auto-generated method stub
 473         return false;
 474     }
 475 
 476     @Override
 477     public void onUserCreated(User user) {
 478         // New account created
 479         mTracker.sendEvent(&quot;user&quot;, &quot;new_account_created&quot;, &quot;account_created_from_login_activity&quot;, null);
 480     }
 481 
 482     public void onAuthenticationStatusChange(User.AuthenticationStatus status) {
 483         if (status == User.AuthenticationStatus.AUTHENTICATED) {
 484             // User signed in
 485             mTracker.sendEvent(&quot;user&quot;, &quot;signed_in&quot;, &quot;signed_in_from_login_activity&quot;, null);
 486             invalidateOptionsMenu();
 487         }
 488     }
 489 
 490     public void startLoginActivity() {
 491         Intent loginIntent = new Intent(this, LoginActivity.class);
 492         loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 493         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 494     }
 495 
 496 
 497     @Override
 498     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 499         super.onActivityResult(requestCode, resultCode, data);
 500         switch (requestCode) {
 501             case Simperium.SIGNUP_SIGNIN_REQUEST:
 502                 if (resultCode == RESULT_CANCELED)
 503                     finish();
 504                 break;
 505             case Simplenote.INTENT_PREFERENCES:
<abbr title=" 506                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 506                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 507                 NoteListFragment fragment = getNoteListFragment();
 508                 if (fragment != null) {
 509                     fragment.getPrefs();
 510                     fragment.refreshList();
 511                 }
 512                 break;
 513         }
 514     }
 515 
 516     @Override
 517     public void onUndo(Parcelable p) {
 518         if (mUndoBarController != null &amp;&amp; mUndoBarController.getDeletedNote() != null) {
 519             Note deletedNote = mUndoBarController.getDeletedNote();
 520             if (deletedNote != null) {
 521                 deletedNote.setDeleted(false);
 522                 deletedNote.setModificationDate(Calendar.getInstance());
 523                 deletedNote.save();
 524                 NoteListFragment fragment = getNoteListFragment();
 525                 if (fragment != null) {
 526                     fragment.getPrefs();
 527                     fragment.refreshList();
 528                 }
 529             }
 530         }
 531     }
 532 
 533     @Override
 534     public void onBackStackChanged() {
 535         configureActionBar();
 536         invalidateOptionsMenu();
 537     }
 538 
 539     private void configureActionBar() {
 540         if (getFragmentManager().getBackStackEntryCount() &gt; 0) {
 541             ActionBar ab = mActionBar;
 542             if (ab != null) {
 543                 ab.setNavigationMode(ActionBar.NAVIGATION_MODE_STANDARD);
 544             }
 545         } else {
 546             ActionBar ab = mActionBar;
 547             if (ab != null) {
 548                 ab.setNavigationMode(ActionBar.NAVIGATION_MODE_LIST);
 549                 ab.setDisplayShowTitleEnabled(false);
 550                 ab.setTitle(&quot;&quot;);
 551             }
 552         }
 553     }
 554 
 555     @Override
 556     public void onConfigurationChanged(Configuration newConfig) {
 557         super.onConfigurationChanged(newConfig);
 558 
 559         if (mIsLargeScreen) {
 560             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 561                 // Add the editor fragment
 562                 mIsLandscape = true;
 563                 popNoteDetail();
 564                 addEditorFragment();
 565                 if (mNoteListFragment != null) {
 566                     mNoteListFragment.setActivateOnItemClick(true);
 567                     mNoteListFragment.setDividerVisible(true);
 568                 }
 569                 // Select the current note on a tablet
 570                 if (mCurrentNote != null)
 571                     onNoteSelected(mCurrentNote.getSimperiumKey());
 572                 else {
 573                     mNoteEditorFragment.setPlaceholderVisible(true);
 574                     mNoteListFragment.getListView().clearChoices();
 575                 }
 576                 invalidateOptionsMenu();
<abbr title=" 577             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {"> 577             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragmentðŸ”µ</abbr>
 578                 // Remove the editor fragment when rotating back to portrait
 579                 mIsLandscape = false;
 580                 mCurrentNote = null;
 581                 if (mNoteListFragment != null) {
 582                     mNoteListFragment.setActivateOnItemClick(false);
 583                     mNoteListFragment.setDividerVisible(false);
 584                     mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 585                     mNoteListFragment.refreshList();
 586                 }
 587                 FragmentManager fm = getFragmentManager();
 588                 FragmentTransaction ft = fm.beginTransaction();
 589                 ft.remove(mNoteEditorFragment);
 590                 mNoteEditorFragment = null;
 591                 ft.commitAllowingStateLoss();
 592                 fm.executePendingTransactions();
 593                 invalidateOptionsMenu();
 594             }
 595         }
 596     }
 597 
 598     public void showDetailPlaceholder() {
 599         if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 600             mCurrentNote = null;
 601             invalidateOptionsMenu();
 602             mNoteEditorFragment.setPlaceholderVisible(true);
 603         }
 604     }
 605 
 606     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 607 
 608         @Override
 609         protected Void doInBackground(Void... voids) {
 610             Simplenote application = (Simplenote) getApplication();
 611             Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 612             Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 613             Bucket.ObjectCursor c = query.execute();
 614             while (c.moveToNext()) {
 615                 c.getObject().delete();
 616             }
 617             return null;
 618         }
 619     }
 620 
 621 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.ActionBar;
   4 import android.app.Activity;
   5 import android.app.AlertDialog;
   6 import android.app.FragmentManager;
   7 import android.app.FragmentTransaction;
   8 import android.content.DialogInterface;
   9 import android.content.Intent;
  10 import android.content.SharedPreferences;
  11 import android.content.res.Configuration;
  12 import android.os.AsyncTask;
  13 import android.os.Bundle;
  14 import android.os.Parcelable;
  15 import android.preference.PreferenceManager;
  16 import android.view.Menu;
  17 import android.view.MenuInflater;
  18 import android.view.MenuItem;
  19 import android.widget.ListView;
  20 import android.widget.SearchView;
  21 
  22 import com.automattic.simplenote.models.Note;
  23 import com.automattic.simplenote.models.Tag;
  24 import com.automattic.simplenote.utils.PrefUtils;
  25 import com.automattic.simplenote.utils.UndoBarController;
  26 import com.google.analytics.tracking.android.EasyTracker;
  27 import com.google.analytics.tracking.android.Tracker;
  28 import com.simperium.Simperium;
  29 import com.simperium.client.Bucket;
  30 import com.simperium.client.LoginActivity;
  31 import com.simperium.client.Query;
  32 import com.simperium.client.User;
  33 
  34 import java.util.Calendar;
  35 
  36 /**
  37  * An activity representing a list of Notes.
  38  * &lt;p/&gt;
  39  * The activity makes heavy use of fragments. The list of items is a
  40  * {@link NoteListFragment} and the item details (if present) is a
  41  * {@link NoteEditorFragment}.
  42  * &lt;p/&gt;
  43  * This activity also implements the required {@link NoteListFragment.Callbacks}
  44  * interface to listen for item selections.
  45  */
  46 public class NotesActivity extends Activity implements
  47         NoteListFragment.Callbacks, ActionBar.OnNavigationListener,
  48         User.AuthenticationListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,
  49         FragmentManager.OnBackStackChangedListener, Bucket.Listener&lt;Note&gt; {
  50 
  51     private boolean mIsLargeScreen, mIsLandscape;
  52     private UndoBarController mUndoBarController;
  53     private SearchView mSearchView;
  54     private MenuItem mSearchMenuItem;
  55     private NoteListFragment mNoteListFragment;
  56     private NoteEditorFragment mNoteEditorFragment;
  57     private Note mCurrentNote;
  58     private Bucket&lt;Note&gt; mNotesBucket;
  59     private Bucket&lt;Tag&gt; mTagsBucket;
  60     private int TRASH_SELECTED_ID = 1;
  61     private ActionBar mActionBar;
  62 
  63     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  64     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  65 
  66     // Google Analytics tracker
  67     private Tracker mTracker;
  68 
  69     @Override
  70     protected void onCreate(Bundle savedInstanceState) {
  71         super.onCreate(savedInstanceState);
  72         Simplenote currentApp = (Simplenote) getApplication();
  73         mNotesBucket = currentApp.getNotesBucket();
  74         mTagsBucket = currentApp.getTagsBucket();
  75         setContentView(R.layout.activity_notes);
  76 
  77         EasyTracker.getInstance().activityStart(this); // Add this method.
  78         mTracker = EasyTracker.getTracker();
  79 
  80         if (savedInstanceState == null) {
  81             mNoteListFragment = new NoteListFragment();
  82             FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
  83             fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
  84             fragmentTransaction.commit();
  85         } else {
  86             mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
  87         }
  88 
  89 
  90         Configuration config = getBaseContext().getResources().getConfiguration();
  91         if ((config.screenLayout
  92                 &amp; Configuration.SCREENLAYOUT_SIZE_MASK)
  93                 &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {
  94             mIsLargeScreen = true;
  95 
  96             if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="  97                 mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">  97                 mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTðŸ”µ</abbr>
  98             } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
  99                 mIsLandscape = true;
 100                 addEditorFragment();
 101             }
 102         }
 103 
 104         mActionBar = getActionBar();
 105         mActionBar.setNavigationMode(ActionBar.NAVIGATION_MODE_LIST);
 106         mActionBar.setDisplayShowTitleEnabled(false);
 107 
 108         mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);
 109 
 110         getFragmentManager().addOnBackStackChangedListener(this);
 111 
 112         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 113             // Create the welcome note
 114             Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 115             welcomeNote.setCreationDate(Calendar.getInstance());
 116             welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 117             welcomeNote.setContent(getString(R.string.welcome_note));
 118             welcomeNote.getTitle();
 119             welcomeNote.save();
 120 
 121             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 122             SharedPreferences.Editor editor = preferences.edit();
 123             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 124             editor.commit();
 125         }
 126 
 127             if (Intent.ACTION_SEND.equals(getIntent().getAction())) {
 128             // Check share action
 129             Intent intent = getIntent();
 130             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 131             if (text != null) {
 132                 Note note = mNotesBucket.newObject();
 133                 note.setCreationDate(Calendar.getInstance());
 134                 note.setContent(text);
 135                 note.save();
 136                 onNoteSelected(note.getSimperiumKey());
 137                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;external_share&quot;, null);
 138             }
 139         }
 140         currentApp.getSimperium().setOnUserCreatedListener(this);
 141         currentApp.getSimperium().setAuthenticationListener(this);
 142     }
 143 
 144     private void addEditorFragment() {
 145         FragmentManager fm = getFragmentManager();
 146         FragmentTransaction ft = fm.beginTransaction();
 147         mNoteEditorFragment = new NoteEditorFragment();
 148         ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 149         ft.commitAllowingStateLoss();
 150         fm.executePendingTransactions();
 151     }
 152 
 153     @Override
 154     protected void onResume() {
 155         super.onResume();
 156 
 157         mNotesBucket.start();
 158         mTagsBucket.start();
 159 
 160         mNotesBucket.addOnNetworkChangeListener(this);
 161         mNotesBucket.addOnSaveObjectListener(this);
 162         mNotesBucket.addOnDeleteObjectListener(this);
 163 
 164         configureActionBar();
 165         invalidateOptionsMenu();
 166     }
 167 
 168     @Override
 169     protected void onPause() {
 170         super.onPause();
 171 
 172         mNotesBucket.stop();
 173         mTagsBucket.stop();
 174 
 175         mNotesBucket.removeOnNetworkChangeListener(this);
 176         mNotesBucket.removeOnSaveObjectListener(this);
 177         mNotesBucket.removeOnDeleteObjectListener(this);
 178     }
 179 
 180     @Override
 181     public void onStop() {
 182         super.onStop();
 183         EasyTracker.getInstance().activityStop(this);
 184     }
 185 
 186     public void setCurrentNote(Note note) {
 187         mCurrentNote = note;
 188     }
 189 
 190     // received a change from the network, refresh the list and the editor
 191     @Override
 192     public void onChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 193         final boolean resetEditor = mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(key);
 194         runOnUiThread(new Runnable() {
 195             @Override
 196             public void run() {
 197                 mNoteListFragment.refreshList();
 198                 if (!resetEditor) return;
 199                 if (mNoteEditorFragment != null) {
 200                     mNoteEditorFragment.refreshContent(true);
 201                 }
 202             }
 203         });
 204     }
 205 
 206     @Override
 207     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 208         runOnUiThread(new Runnable() {
 209             @Override
 210             public void run() {
 211                 mNoteListFragment.refreshList();
 212             }
 213         });
 214     }
 215 
 216     @Override
 217     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 218         runOnUiThread(new Runnable() {
 219             @Override
 220             public void run() {
 221                 mNoteListFragment.refreshList();
 222             }
 223         });
 224     }
 225 
 226     public boolean isLargeScreen() {
 227         return mIsLargeScreen;
 228     }
 229 
 230     public boolean isLargeScreenLandscape() {
 231         return mIsLargeScreen &amp;&amp; mIsLandscape;
 232     }
 233 
 234     // nbradbury 01-Apr-2013
 235     private NoteListFragment getNoteListFragment() {
 236         return mNoteListFragment;
 237     }
 238 
 239     @Override
 240     public boolean onCreateOptionsMenu(Menu menu) {
 241         super.onCreateOptionsMenu(menu);
 242         MenuInflater inflater = getMenuInflater();
 243         inflater.inflate(R.menu.notes_list, menu);
 244 
 245         mSearchMenuItem = menu.findItem(R.id.menu_search);
 246         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 247         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 248             @Override
 249             public boolean onQueryTextChange(String newText) {
 250                 if (mSearchMenuItem.isActionViewExpanded())
 251                     getNoteListFragment().searchNotes(newText);
 252                 return true;
 253             }
 254 
 255             @Override
 256             public boolean onQueryTextSubmit(String queryText) {
 257                 getNoteListFragment().searchNotes(queryText);
 258                 return true;
 259             }
 260 
 261         });
 262         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 263             @Override
 264             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 265                 showDetailPlaceholder();
 266                 getNoteListFragment().setEmptyListMessage(getString(R.string.no_notes_found));
 267                 mTracker.sendEvent(&quot;note&quot;, &quot;searched_notes&quot;, &quot;action_bar_search_tap&quot;, null);
 268                 return true;
 269             }
 270 
 271             @Override
 272             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 273                 // Show all notes again
 274                 getNoteListFragment().setEmptyListMessage(getString(R.string.no_notes));
 275                 getNoteListFragment().clearSearch();
 276                 return true;
 277             }
 278         });
 279 
 280         Simplenote currentApp = (Simplenote) getApplication();
<abbr title=" 281         if (currentApp.getSimperium().getUser() == null || currentApp.getSimperium().getUser().needsAuthentication())"> 281         if (currentApp.getSimperium().getUser() == null || currentApp.getSimperium().getUser().needsAutheðŸ”µ</abbr>
 282             menu.findItem(R.id.menu_sign_in).setVisible(true);
 283         else
 284             menu.findItem(R.id.menu_sign_in).setVisible(false);
 285 
 286         FragmentManager fm = getFragmentManager();
 287         if (fm.getBackStackEntryCount() &gt; 0) {
 288             mActionBar.setDisplayHomeAsUpEnabled(true);
 289             menu.findItem(R.id.menu_create_note).setVisible(false);
 290             menu.findItem(R.id.menu_search).setVisible(false);
 291             menu.findItem(R.id.menu_preferences).setVisible(false);
 292             menu.findItem(R.id.menu_share).setVisible(true);
 293             menu.findItem(R.id.menu_delete).setVisible(true);
 294             if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 295                 menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 296             menu.findItem(R.id.menu_edit_tags).setVisible(false);
 297             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 298         } else if (isLargeScreenLandscape()) {
 299             mActionBar.setDisplayHomeAsUpEnabled(false);
 300             mActionBar.setHomeButtonEnabled(false);
 301             menu.findItem(R.id.menu_create_note).setVisible(true);
 302             menu.findItem(R.id.menu_search).setVisible(true);
 303             menu.findItem(R.id.menu_preferences).setVisible(true);
 304             if (mCurrentNote != null) {
 305                 menu.findItem(R.id.menu_share).setVisible(true);
 306                 menu.findItem(R.id.menu_delete).setVisible(true);
 307             } else {
 308                 menu.findItem(R.id.menu_share).setVisible(false);
 309                 menu.findItem(R.id.menu_delete).setVisible(false);
 310             }
 311             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 312             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 313         } else {
 314             mActionBar.setDisplayHomeAsUpEnabled(false);
 315             mActionBar.setHomeButtonEnabled(false);
 316             menu.findItem(R.id.menu_create_note).setVisible(true);
 317             menu.findItem(R.id.menu_search).setVisible(true);
 318             menu.findItem(R.id.menu_preferences).setVisible(true);
 319             menu.findItem(R.id.menu_share).setVisible(false);
 320             menu.findItem(R.id.menu_delete).setVisible(false);
 321             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 322             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 323         }
 324 
 325         // Are we looking at the trash? Adjust menu accordingly.
 326         if (mActionBar.getSelectedNavigationIndex() == TRASH_SELECTED_ID) {
 327             menu.findItem(R.id.menu_empty_trash).setVisible(true);
 328             menu.findItem(R.id.menu_create_note).setVisible(false);
 329             menu.findItem(R.id.menu_search).setVisible(false);
 330             menu.findItem(R.id.menu_share).setVisible(false);
 331         }
 332 
 333         return true;
 334     }
 335 
 336     @Override
 337     public boolean onOptionsItemSelected(MenuItem item) {
 338         switch (item.getItemId()) {
 339             case R.id.menu_preferences:
<abbr title=" 340                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 340                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returnðŸ”µ</abbr>
 341                 Intent i = new Intent(this, PreferencesActivity.class);
 342                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 343                 return true;
 344             case R.id.menu_sign_in:
 345                 startLoginActivity();
 346                 return true;
 347             case R.id.menu_edit_tags:
 348                 Intent editTagsIntent = new Intent(this, TagsListActivity.class);
 349                 startActivity(editTagsIntent);
 350                 return true;
 351             case R.id.menu_create_note:
 352                 getNoteListFragment().addNote();
 353                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;action_bar_button&quot;, null);
 354                 return true;
 355             case R.id.menu_share:
 356                 if (mCurrentNote != null) {
 357                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 358                     shareIntent.setType(&quot;text/plain&quot;);
 359                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 360                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 360                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
 361                     mTracker.sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, null);
 362                 }
 363                 return true;
 364             case R.id.menu_delete:
 365                 if (mNoteEditorFragment != null) {
 366                     if (mCurrentNote != null) {
 367                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 368                         mCurrentNote.setModificationDate(Calendar.getInstance());
 369                         mCurrentNote.save();
 370 
 371                         if (mCurrentNote.isDeleted()) {
 372                             mUndoBarController.setDeletedNote(mCurrentNote);
<abbr title=" 373                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);"> 373                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null)ðŸ”µ</abbr>
 374                             mTracker.sendEvent(&quot;note&quot;, &quot;deleted_note&quot;, &quot;overflow_menu&quot;, null);
 375                         } else {
 376                             mTracker.sendEvent(&quot;note&quot;, &quot;restored_note&quot;, &quot;overflow_menu&quot;, null);
 377                         }
 378                         showDetailPlaceholder();
 379                     }
 380                     popNoteDetail();
 381                     NoteListFragment fragment = getNoteListFragment();
 382                     if (fragment != null) {
 383                         fragment.getPrefs();
 384                         fragment.refreshList();
 385                     }
 386                 }
 387                 return true;
 388             case R.id.menu_empty_trash:
 389                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 390 
 391                 alert.setTitle(R.string.empty_trash);
 392                 alert.setMessage(R.string.confirm_empty_trash);
 393                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 394                     public void onClick(DialogInterface dialog, int whichButton) {
 395                         new emptyTrashTask().execute();
 396                         mTracker.sendEvent(&quot;note&quot;, &quot;trash_emptied&quot;, &quot;overflow_menu&quot;, null);
 397                     }
 398                 });
 399                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 400                     public void onClick(DialogInterface dialog, int whichButton) {
 401                         // Do nothing, just closing the dialog
 402                     }
 403                 });
 404                 alert.show();
 405                 return true;
 406             case android.R.id.home:
 407                 popNoteDetail();
 408                 invalidateOptionsMenu();
 409                 return true;
 410             default:
 411                 return super.onOptionsItemSelected(item);
 412         }
 413     }
 414 
 415     protected void popNoteDetail() {
 416         FragmentManager fm = getFragmentManager();
 417         if (fm.getBackStackEntryCount() &gt; 0) {
 418             try {
 419                 fm.popBackStack();
 420             } catch (Exception e) {
 421                 e.printStackTrace();
 422             }
 423         }
 424     }
 425 
 426     /**
 427      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 428      * the item with the given ID was selected.
 429      */
 430     @Override
 431     public void onNoteSelected(String noteID) {
 432 
 433         if (mSearchMenuItem != null)
 434             mSearchMenuItem.collapseActionView();
 435 
 436         FragmentManager fm = getFragmentManager();
 437 
 438         if (!isLargeScreenLandscape()) {
 439             mActionBar.setNavigationMode(ActionBar.NAVIGATION_MODE_STANDARD);
 440             mActionBar.setDisplayShowTitleEnabled(true);
 441 
 442             // Create editor fragment
 443             Bundle arguments = new Bundle();
 444             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 445             mNoteEditorFragment = new NoteEditorFragment();
 446             mNoteEditorFragment.setArguments(arguments);
 447 
 448             // Add editor fragment to stack
 449             FragmentTransaction ft = fm.beginTransaction();
<abbr title=" 450             ft.setCustomAnimations(R.animator.slide_in, R.animator.zoom_in_and_fade, R.animator.zoom_out_and_fade, R.animator.slide_out);"> 450             ft.setCustomAnimations(R.animator.slide_in, R.animator.zoom_in_and_fade, R.animator.zoom_out_ðŸ”µ</abbr>
 451             ft.replace(R.id.noteFragmentContainer, mNoteEditorFragment);
 452             ft.addToBackStack(null);
 453             ft.commitAllowingStateLoss();
 454             fm.executePendingTransactions();
 455         } else {
 456             mNoteEditorFragment.setNote(noteID);
 457             getNoteListFragment().setNoteSelected(noteID);
 458         }
 459 
 460         mTracker.sendEvent(&quot;note&quot;, &quot;viewed_note&quot;, &quot;note_list_row_tap&quot;, null);
 461     }
 462 
 463     @Override
 464     public boolean onNavigationItemSelected(int itemPosition, long itemId) {
 465         // TODO Auto-generated method stub
 466         return false;
 467     }
 468 
 469     @Override
 470     public void onUserCreated(User user) {
 471         // New account created
 472         mTracker.sendEvent(&quot;user&quot;, &quot;new_account_created&quot;, &quot;account_created_from_login_activity&quot;, null);
 473     }
 474 
 475     public void onAuthenticationStatusChange(User.AuthenticationStatus status) {
 476         if (status == User.AuthenticationStatus.AUTHENTICATED) {
 477             // User signed in
 478             mTracker.sendEvent(&quot;user&quot;, &quot;signed_in&quot;, &quot;signed_in_from_login_activity&quot;, null);
 479             invalidateOptionsMenu();
 480         }
 481     }
 482 
 483     public void startLoginActivity() {
 484         Intent loginIntent = new Intent(this, LoginActivity.class);
 485         loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 486         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 487     }
 488 
 489 
 490     @Override
 491     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 492         super.onActivityResult(requestCode, resultCode, data);
 493         switch (requestCode) {
 494             case Simperium.SIGNUP_SIGNIN_REQUEST:
 495                 if (resultCode == RESULT_CANCELED)
 496                     finish();
 497                 break;
 498             case Simplenote.INTENT_PREFERENCES:
<abbr title=" 499                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 499                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 500                 NoteListFragment fragment = getNoteListFragment();
 501                 if (fragment != null) {
 502                     fragment.getPrefs();
 503                     fragment.refreshList();
 504                 }
 505                 break;
 506         }
 507     }
 508 
 509     @Override
 510     public void onUndo(Parcelable p) {
 511         if (mUndoBarController != null &amp;&amp; mUndoBarController.getDeletedNote() != null) {
 512             Note deletedNote = mUndoBarController.getDeletedNote();
 513             if (deletedNote != null) {
 514                 deletedNote.setDeleted(false);
 515                 deletedNote.setModificationDate(Calendar.getInstance());
 516                 deletedNote.save();
 517                 NoteListFragment fragment = getNoteListFragment();
 518                 if (fragment != null) {
 519                     fragment.getPrefs();
 520                     fragment.refreshList();
 521                 }
 522             }
 523         }
 524     }
 525 
 526     @Override
 527     public void onBackStackChanged() {
 528         configureActionBar();
 529         invalidateOptionsMenu();
 530     }
 531 
 532     private void configureActionBar() {
 533         if (getFragmentManager().getBackStackEntryCount() &gt; 0) {
 534             ActionBar ab = mActionBar;
 535             if (ab != null) {
 536                 ab.setNavigationMode(ActionBar.NAVIGATION_MODE_STANDARD);
 537             }
 538         } else {
 539             ActionBar ab = mActionBar;
 540             if (ab != null) {
 541                 ab.setNavigationMode(ActionBar.NAVIGATION_MODE_LIST);
 542                 ab.setDisplayShowTitleEnabled(false);
 543                 ab.setTitle(&quot;&quot;);
 544             }
 545         }
 546     }
 547 
 548     @Override
 549     public void onConfigurationChanged(Configuration newConfig) {
 550         super.onConfigurationChanged(newConfig);
 551 
 552         if (mIsLargeScreen) {
 553             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 554                 // Add the editor fragment
 555                 mIsLandscape = true;
 556                 popNoteDetail();
 557                 addEditorFragment();
 558                 if (mNoteListFragment != null) {
 559                     mNoteListFragment.setActivateOnItemClick(true);
 560                     mNoteListFragment.setDividerVisible(true);
 561                 }
 562                 // Select the current note on a tablet
 563                 if (mCurrentNote != null)
 564                     onNoteSelected(mCurrentNote.getSimperiumKey());
 565                 else {
 566                     mNoteEditorFragment.setPlaceholderVisible(true);
 567                     mNoteListFragment.getListView().clearChoices();
 568                 }
 569                 invalidateOptionsMenu();
<abbr title=" 570             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {"> 570             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragmentðŸ”µ</abbr>
 571                 // Remove the editor fragment when rotating back to portrait
 572                 mIsLandscape = false;
 573                 mCurrentNote = null;
 574                 if (mNoteListFragment != null) {
 575                     mNoteListFragment.setActivateOnItemClick(false);
 576                     mNoteListFragment.setDividerVisible(false);
 577                     mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 578                     mNoteListFragment.refreshList();
 579                 }
 580                 FragmentManager fm = getFragmentManager();
 581                 FragmentTransaction ft = fm.beginTransaction();
 582                 ft.remove(mNoteEditorFragment);
 583                 mNoteEditorFragment = null;
 584                 ft.commitAllowingStateLoss();
 585                 fm.executePendingTransactions();
 586                 invalidateOptionsMenu();
 587             }
 588         }
 589     }
 590 
 591     public void showDetailPlaceholder() {
 592         if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 593             mCurrentNote = null;
 594             invalidateOptionsMenu();
 595             mNoteEditorFragment.setPlaceholderVisible(true);
 596         }
 597     }
 598 
 599     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 600 
 601         @Override
 602         protected Void doInBackground(Void... voids) {
 603             Simplenote application = (Simplenote) getApplication();
 604             Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 605             Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 606             Bucket.ObjectCursor c = query.execute();
 607             while (c.moveToNext()) {
 608                 c.getObject().delete();
 609             }
 610             return null;
 611         }
 612     }
 613 
 614 }
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.ActionBar;
   4 import android.app.Activity;
   5 import android.app.AlertDialog;
   6 import android.app.FragmentManager;
   7 import android.app.FragmentTransaction;
   8 import android.content.DialogInterface;
   9 import android.content.Intent;
  10 import android.content.SharedPreferences;
  11 import android.content.res.Configuration;
  12 import android.os.AsyncTask;
  13 import android.os.Bundle;
  14 import android.os.Parcelable;
  15 import android.preference.PreferenceManager;
  16 import android.view.Menu;
  17 import android.view.MenuInflater;
  18 import android.view.MenuItem;
  19 import android.widget.ListView;
  20 import android.widget.SearchView;
  21 import com.automattic.simplenote.models.Note;
  22 import com.automattic.simplenote.models.Tag;
  23 import com.automattic.simplenote.utils.PrefUtils;
  24 import com.automattic.simplenote.utils.UndoBarController;
  25 import com.google.analytics.tracking.android.EasyTracker;
  26 import com.google.analytics.tracking.android.Tracker;
  27 import com.simperium.Simperium;
  28 import com.simperium.client.Bucket;
  29 import com.simperium.client.LoginActivity;
  30 import com.simperium.client.Query;
  31 import com.simperium.client.User;
  32 import java.util.Calendar;
  33 
  34 
  35 /**
  36  * An activity representing a list of Notes.
  37  * &lt;p/&gt;
  38  * The activity makes heavy use of fragments. The list of items is a
  39  * {@link NoteListFragment} and the item details (if present) is a
  40  * {@link NoteEditorFragment}.
  41  * &lt;p/&gt;
  42  * This activity also implements the required {@link NoteListFragment.Callbacks}
  43  * interface to listen for item selections.
  44  */
<abbr title="  45 public class NotesActivity extends Activity implements NoteListFragment.Callbacks , ActionBar.OnNavigationListener , User.AuthenticationListener , Simperium.OnUserCreatedListener , UndoBarController.UndoListener , FragmentManager.OnBackStackChangedListener , Bucket.Listener&lt;Note&gt; {">  45 public class NotesActivity extends Activity implements NoteListFragment.Callbacks , ActionBar.OnNavigatioðŸ”µ</abbr>
  46     private boolean mIsLargeScreen;
  47 
  48     private boolean mIsLandscape;
  49 
  50     private UndoBarController mUndoBarController;
  51 
  52     private SearchView mSearchView;
  53 
  54     private MenuItem mSearchMenuItem;
  55 
  56     private NoteListFragment mNoteListFragment;
  57 
  58     private NoteEditorFragment mNoteEditorFragment;
  59 
  60     private Note mCurrentNote;
  61 
  62     private Bucket&lt;Note&gt; mNotesBucket;
  63 
  64     private Bucket&lt;Tag&gt; mTagsBucket;
  65 
  66     private int TRASH_SELECTED_ID = 1;
  67 
  68     private ActionBar mActionBar;
  69 
  70     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  71 
  72     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  73 
  74     // Google Analytics tracker
  75     // Google Analytics tracker
  76     private Tracker mTracker;
  77 
  78     @Override
  79     protected void onCreate(Bundle savedInstanceState) {
  80         super.onCreate(savedInstanceState);
  81         Simplenote currentApp = ((Simplenote) (getApplication()));
  82         mNotesBucket = currentApp.getNotesBucket();
  83         mTagsBucket = currentApp.getTagsBucket();
  84         setContentView(R.layout.activity_notes);
  85         EasyTracker.getInstance().activityStart(this);// Add this method.
  86 
  87         mTracker = EasyTracker.getTracker();
  88         if (savedInstanceState == null) {
  89             mNoteListFragment = new NoteListFragment();
  90             FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
  91             fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
  92             fragmentTransaction.commit();
  93         } else {
<abbr title="  94             mNoteListFragment = ((NoteListFragment) (getFragmentManager().findFragmentByTag(TAG_NOTE_LIST)));">  94             mNoteListFragment = ((NoteListFragment) (getFragmentManager().findFragmentByTag(TAG_NOTE_LISTðŸ”µ</abbr>
  95         }
  96         Configuration config = getBaseContext().getResources().getConfiguration();
<abbr title="  97         if ((config.screenLayout &amp; Configuration.SCREENLAYOUT_SIZE_MASK) &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {">  97         if ((config.screenLayout &amp; Configuration.SCREENLAYOUT_SIZE_MASK) &gt;= Configuration.SCREENLAYOUT_SIðŸ”µ</abbr>
  98             mIsLargeScreen = true;
  99             if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 100                 mNoteEditorFragment = ((NoteEditorFragment) (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR)));"> 100                 mNoteEditorFragment = ((NoteEditorFragment) (getFragmentManager().findFragmentByTag(TAG_NðŸ”µ</abbr>
 101             } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 102                 mIsLandscape = true;
 103                 addEditorFragment();
 104             }
 105         }
 106         mActionBar = getActionBar();
 107         mActionBar.setNavigationMode(ActionBar.NAVIGATION_MODE_LIST);
 108         mActionBar.setDisplayShowTitleEnabled(false);
 109         mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);
 110         getFragmentManager().addOnBackStackChangedListener(this);
 111         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 112             // Create the welcome note
 113             Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 114             welcomeNote.setCreationDate(Calendar.getInstance());
 115             welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 116             welcomeNote.setContent(getString(R.string.welcome_note));
 117             welcomeNote.getTitle();
 118             welcomeNote.save();
 119             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 120             SharedPreferences.Editor editor = preferences.edit();
 121             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 122             editor.commit();
 123         }
 124         if (Intent.ACTION_SEND.equals(getIntent().getAction())) {
 125             // Check share action
 126             Intent intent = getIntent();
 127             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 128             if (text != null) {
 129                 Note note = mNotesBucket.newObject();
 130                 note.setCreationDate(Calendar.getInstance());
 131                 note.setContent(text);
 132                 note.save();
 133                 onNoteSelected(note.getSimperiumKey());
 134                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;external_share&quot;, null);
 135             }
 136         }
 137         currentApp.getSimperium().setOnUserCreatedListener(this);
 138         currentApp.getSimperium().setAuthenticationListener(this);
 139     }
 140 
 141     private void addEditorFragment() {
 142         FragmentManager fm = getFragmentManager();
 143         FragmentTransaction ft = fm.beginTransaction();
 144         mNoteEditorFragment = new NoteEditorFragment();
 145         ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 146         ft.commitAllowingStateLoss();
 147         fm.executePendingTransactions();
 148     }
 149 
 150     @Override
 151     protected void onResume() {
 152         super.onResume();
 153         mNotesBucket.start();
 154         mTagsBucket.start();
 155         mNotesBucket.addOnNetworkChangeListener(this);
 156         mNotesBucket.addOnSaveObjectListener(this);
 157         mNotesBucket.addOnDeleteObjectListener(this);
 158         configureActionBar();
 159         invalidateOptionsMenu();
 160     }
 161 
 162     @Override
 163     protected void onPause() {
 164         super.onPause();
 165         mNotesBucket.stop();
 166         mTagsBucket.stop();
 167         mNotesBucket.removeOnNetworkChangeListener(this);
 168         mNotesBucket.removeOnSaveObjectListener(this);
 169         mNotesBucket.removeOnDeleteObjectListener(this);
 170     }
 171 
 172     @Override
 173     public void onStop() {
 174         super.onStop();
 175         EasyTracker.getInstance().activityStop(this);
 176     }
 177 
 178     public void setCurrentNote(Note note) {
 179         mCurrentNote = note;
 180     }
 181 
 182     // received a change from the network, refresh the list and the editor
 183     @Override
 184     public void onChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 185         final boolean resetEditor = (mCurrentNote != null) &amp;&amp; mCurrentNote.getSimperiumKey().equals(key);
 186         runOnUiThread(new Runnable() {
 187             @Override
 188             public void run() {
 189                 mNoteListFragment.refreshList();
 190                 if (!resetEditor) {
 191                     return;
 192                 }
 193                 if (mNoteEditorFragment != null) {
 194                     mNoteEditorFragment.refreshContent(true);
 195                 }
 196             }
 197         });
 198     }
 199 
 200     @Override
 201     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 202         runOnUiThread(new Runnable() {
 203             @Override
 204             public void run() {
 205                 mNoteListFragment.refreshList();
 206             }
 207         });
 208     }
 209 
 210     @Override
 211     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 212         runOnUiThread(new Runnable() {
 213             @Override
 214             public void run() {
 215                 mNoteListFragment.refreshList();
 216             }
 217         });
 218     }
 219 
 220     public boolean isLargeScreen() {
 221         return mIsLargeScreen;
 222     }
 223 
 224     public boolean isLargeScreenLandscape() {
 225         return mIsLargeScreen &amp;&amp; mIsLandscape;
 226     }
 227 
 228     // nbradbury 01-Apr-2013
 229     private NoteListFragment getNoteListFragment() {
 230         return mNoteListFragment;
 231     }
 232 
 233     @Override
 234     public boolean onCreateOptionsMenu(Menu menu) {
 235         super.onCreateOptionsMenu(menu);
 236         MenuInflater inflater = getMenuInflater();
 237         inflater.inflate(R.menu.notes_list, menu);
 238         mSearchMenuItem = menu.findItem(R.id.menu_search);
 239         mSearchView = ((SearchView) (mSearchMenuItem.getActionView()));
 240         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 241             @Override
 242             public boolean onQueryTextChange(String newText) {
 243                 if (mSearchMenuItem.isActionViewExpanded()) {
 244                     getNoteListFragment().searchNotes(newText);
 245                 }
 246                 return true;
 247             }
 248 
 249             @Override
 250             public boolean onQueryTextSubmit(String queryText) {
 251                 getNoteListFragment().searchNotes(queryText);
 252                 return true;
 253             }
 254         });
 255         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 256             @Override
 257             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 258                 showDetailPlaceholder();
 259                 getNoteListFragment().setEmptyListMessage(getString(R.string.no_notes_found));
 260                 mTracker.sendEvent(&quot;note&quot;, &quot;searched_notes&quot;, &quot;action_bar_search_tap&quot;, null);
 261                 return true;
 262             }
 263 
 264             @Override
 265             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 266                 // Show all notes again
 267                 getNoteListFragment().setEmptyListMessage(getString(R.string.no_notes));
 268                 getNoteListFragment().clearSearch();
 269                 return true;
 270             }
 271         });
 272         Simplenote currentApp = ((Simplenote) (getApplication()));
<abbr title=" 273         if ((currentApp.getSimperium().getUser() == null) || currentApp.getSimperium().getUser().needsAuthentication()) {"> 273         if ((currentApp.getSimperium().getUser() == null) || currentApp.getSimperium().getUser().needsAutðŸ”µ</abbr>
 274             menu.findItem(R.id.menu_sign_in).setVisible(true);
 275         } else {
 276             menu.findItem(R.id.menu_sign_in).setVisible(false);
 277         }
 278         FragmentManager fm = getFragmentManager();
 279         if (fm.getBackStackEntryCount() &gt; 0) {
 280             mActionBar.setDisplayHomeAsUpEnabled(true);
 281             menu.findItem(R.id.menu_create_note).setVisible(false);
 282             menu.findItem(R.id.menu_search).setVisible(false);
 283             menu.findItem(R.id.menu_preferences).setVisible(false);
 284             menu.findItem(R.id.menu_share).setVisible(true);
 285             menu.findItem(R.id.menu_delete).setVisible(true);
 286             if ((mCurrentNote != null) &amp;&amp; mCurrentNote.isDeleted()) {
 287                 menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 288             }
 289             menu.findItem(R.id.menu_edit_tags).setVisible(false);
 290             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 291         } else if (isLargeScreenLandscape()) {
 292             mActionBar.setDisplayHomeAsUpEnabled(false);
 293             mActionBar.setHomeButtonEnabled(false);
 294             menu.findItem(R.id.menu_create_note).setVisible(true);
 295             menu.findItem(R.id.menu_search).setVisible(true);
 296             menu.findItem(R.id.menu_preferences).setVisible(true);
 297             if (mCurrentNote != null) {
 298                 menu.findItem(R.id.menu_share).setVisible(true);
 299                 menu.findItem(R.id.menu_delete).setVisible(true);
 300             } else {
 301                 menu.findItem(R.id.menu_share).setVisible(false);
 302                 menu.findItem(R.id.menu_delete).setVisible(false);
 303             }
 304             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 305             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 306         } else {
 307             mActionBar.setDisplayHomeAsUpEnabled(false);
 308             mActionBar.setHomeButtonEnabled(false);
 309             menu.findItem(R.id.menu_create_note).setVisible(true);
 310             menu.findItem(R.id.menu_search).setVisible(true);
 311             menu.findItem(R.id.menu_preferences).setVisible(true);
 312             menu.findItem(R.id.menu_share).setVisible(false);
 313             menu.findItem(R.id.menu_delete).setVisible(false);
 314             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 315             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 316         }
 317         // Are we looking at the trash? Adjust menu accordingly.
 318         if (mActionBar.getSelectedNavigationIndex() == TRASH_SELECTED_ID) {
 319             menu.findItem(R.id.menu_empty_trash).setVisible(true);
 320             menu.findItem(R.id.menu_create_note).setVisible(false);
 321             menu.findItem(R.id.menu_search).setVisible(false);
 322             menu.findItem(R.id.menu_share).setVisible(false);
 323         }
 324         return true;
 325     }
 326 
 327     @Override
 328     public boolean onOptionsItemSelected(MenuItem item) {
 329         switch (item.getItemId()) {
 330             case R.id.menu_preferences :
<abbr title=" 331                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 331                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returnðŸ”µ</abbr>
 332                 Intent i = new Intent(this, PreferencesActivity.class);
 333                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 334                 return true;
 335             case R.id.menu_sign_in :
 336                 startLoginActivity();
 337                 return true;
 338             case R.id.menu_edit_tags :
 339                 Intent editTagsIntent = new Intent(this, TagsListActivity.class);
 340                 startActivity(editTagsIntent);
 341                 return true;
 342             case R.id.menu_create_note :
 343                 getNoteListFragment().addNote();
 344                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;action_bar_button&quot;, null);
 345                 return true;
 346             case R.id.menu_share :
 347                 if (mCurrentNote != null) {
 348                     Intent shareIntent = new Intent(Intent.ACTION_SEND);
 349                     shareIntent.setType(&quot;text/plain&quot;);
 350                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 351                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 351                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
 352                     mTracker.sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, null);
 353                 }
 354                 return true;
 355             case R.id.menu_delete :
 356                 if (mNoteEditorFragment != null) {
 357                     if (mCurrentNote != null) {
 358                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 359                         mCurrentNote.setModificationDate(Calendar.getInstance());
 360                         mCurrentNote.save();
 361                         if (mCurrentNote.isDeleted()) {
 362                             mUndoBarController.setDeletedNote(mCurrentNote);
<abbr title=" 363                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);"> 363                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null)ðŸ”µ</abbr>
 364                             mTracker.sendEvent(&quot;note&quot;, &quot;deleted_note&quot;, &quot;overflow_menu&quot;, null);
 365                         } else {
 366                             mTracker.sendEvent(&quot;note&quot;, &quot;restored_note&quot;, &quot;overflow_menu&quot;, null);
 367                         }
 368                         showDetailPlaceholder();
 369                     }
 370                     popNoteDetail();
 371                     NoteListFragment fragment = getNoteListFragment();
 372                     if (fragment != null) {
 373                         fragment.getPrefs();
 374                         fragment.refreshList();
 375                     }
 376                 }
 377                 return true;
 378             case R.id.menu_empty_trash :
 379                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 380                 alert.setTitle(R.string.empty_trash);
 381                 alert.setMessage(R.string.confirm_empty_trash);
 382                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 383                     public void onClick(DialogInterface dialog, int whichButton) {
 384                         new emptyTrashTask().execute();
 385                         mTracker.sendEvent(&quot;note&quot;, &quot;trash_emptied&quot;, &quot;overflow_menu&quot;, null);
 386                     }
 387                 });
 388                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 389                     public void onClick(DialogInterface dialog, int whichButton) {
 390                         // Do nothing, just closing the dialog
 391                     }
 392                 });
 393                 alert.show();
 394                 return true;
 395             case android.R.id.home :
 396                 popNoteDetail();
 397                 invalidateOptionsMenu();
 398                 return true;
 399             default :
 400                 return super.onOptionsItemSelected(item);
 401         }
 402     }
 403 
 404     protected void popNoteDetail() {
 405         FragmentManager fm = getFragmentManager();
 406         if (fm.getBackStackEntryCount() &gt; 0) {
 407             try {
 408                 fm.popBackStack();
 409             } catch (Exception e) {
 410                 e.printStackTrace();
 411             }
 412         }
 413     }
 414 
 415     /**
 416      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 417      * the item with the given ID was selected.
 418      */
 419     @Override
 420     public void onNoteSelected(String noteID) {
 421         if (mSearchMenuItem != null) {
 422             mSearchMenuItem.collapseActionView();
 423         }
 424         FragmentManager fm = getFragmentManager();
 425         if (!isLargeScreenLandscape()) {
 426             mActionBar.setNavigationMode(ActionBar.NAVIGATION_MODE_STANDARD);
 427             mActionBar.setDisplayShowTitleEnabled(true);
 428             // Create editor fragment
 429             Bundle arguments = new Bundle();
 430             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 431             mNoteEditorFragment = new NoteEditorFragment();
 432             mNoteEditorFragment.setArguments(arguments);
 433             // Add editor fragment to stack
 434             FragmentTransaction ft = fm.beginTransaction();
<abbr title=" 435             ft.setCustomAnimations(R.animator.slide_in, R.animator.zoom_in_and_fade, R.animator.zoom_out_and_fade, R.animator.slide_out);"> 435             ft.setCustomAnimations(R.animator.slide_in, R.animator.zoom_in_and_fade, R.animator.zoom_out_ðŸ”µ</abbr>
 436             ft.replace(R.id.noteFragmentContainer, mNoteEditorFragment);
 437             ft.addToBackStack(null);
 438             ft.commitAllowingStateLoss();
 439             fm.executePendingTransactions();
 440         } else {
 441             mNoteEditorFragment.setNote(noteID);
 442             getNoteListFragment().setNoteSelected(noteID);
 443         }
 444         mTracker.sendEvent(&quot;note&quot;, &quot;viewed_note&quot;, &quot;note_list_row_tap&quot;, null);
 445     }
 446 
 447     @Override
 448     public boolean onNavigationItemSelected(int itemPosition, long itemId) {
 449         // TODO Auto-generated method stub
 450         return false;
 451     }
 452 
 453     @Override
 454     public void onUserCreated(User user) {
 455         // New account created
 456         mTracker.sendEvent(&quot;user&quot;, &quot;new_account_created&quot;, &quot;account_created_from_login_activity&quot;, null);
 457     }
 458 
 459     public void onAuthenticationStatusChange(User.AuthenticationStatus status) {
 460         if (status == User.AuthenticationStatus.AUTHENTICATED) {
 461             // User signed in
 462             mTracker.sendEvent(&quot;user&quot;, &quot;signed_in&quot;, &quot;signed_in_from_login_activity&quot;, null);
 463             invalidateOptionsMenu();
 464         }
 465     }
 466 
 467     public void startLoginActivity() {
 468         Intent loginIntent = new Intent(this, LoginActivity.class);
 469         loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 470         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 471     }
 472 
 473     @Override
 474     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 475         super.onActivityResult(requestCode, resultCode, data);
 476         switch (requestCode) {
 477             case Simperium.SIGNUP_SIGNIN_REQUEST:
 478                 if (resultCode == RESULT_CANCELED)
 479                     finish();
 480                 break;
 481             case Simplenote.INTENT_PREFERENCES:
<abbr title=" 482                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 482                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 483                 NoteListFragment fragment = getNoteListFragment();
 484                 if (fragment != null) {
 485                     fragment.getPrefs();
 486                     fragment.refreshList();
 487                 }
 488                 break;
 489         }
 490     }
 491 
 492     @Override
 493     public void onUndo(Parcelable p) {
 494         if (mUndoBarController != null &amp;&amp; mUndoBarController.getDeletedNote() != null) {
 495             Note deletedNote = mUndoBarController.getDeletedNote();
 496             if (deletedNote != null) {
 497                 deletedNote.setDeleted(false);
 498                 deletedNote.setModificationDate(Calendar.getInstance());
 499                 deletedNote.save();
 500                 NoteListFragment fragment = getNoteListFragment();
 501                 if (fragment != null) {
 502                     fragment.getPrefs();
 503                     fragment.refreshList();
 504                 }
 505             }
 506         }
 507     }
 508 
 509     @Override
 510     public void onBackStackChanged() {
 511         configureActionBar();
 512         invalidateOptionsMenu();
 513     }
 514 
 515     private void configureActionBar() {
 516         if (getFragmentManager().getBackStackEntryCount() &gt; 0) {
 517             ActionBar ab = mActionBar;
 518             if (ab != null) {
 519                 ab.setNavigationMode(ActionBar.NAVIGATION_MODE_STANDARD);
 520             }
 521         } else {
 522             ActionBar ab = mActionBar;
 523             if (ab != null) {
 524                 ab.setNavigationMode(ActionBar.NAVIGATION_MODE_LIST);
 525                 ab.setDisplayShowTitleEnabled(false);
 526                 ab.setTitle(&quot;&quot;);
 527             }
 528         }
 529     }
 530 
 531     @Override
 532     public void onConfigurationChanged(Configuration newConfig) {
 533         super.onConfigurationChanged(newConfig);
 534         if (mIsLargeScreen) {
 535             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 536                 // Add the editor fragment
 537                 mIsLandscape = true;
 538                 popNoteDetail();
 539                 addEditorFragment();
 540                 if (mNoteListFragment != null) {
 541                     mNoteListFragment.setActivateOnItemClick(true);
 542                     mNoteListFragment.setDividerVisible(true);
 543                 }
 544                 // Select the current note on a tablet
 545                 if (mCurrentNote != null) {
 546                     onNoteSelected(mCurrentNote.getSimperiumKey());
 547                 } else {
 548                     mNoteEditorFragment.setPlaceholderVisible(true);
 549                     mNoteListFragment.getListView().clearChoices();
 550                 }
 551                 invalidateOptionsMenu();
<abbr title=" 552             } else if ((newConfig.orientation == Configuration.ORIENTATION_PORTRAIT) &amp;&amp; (mNoteEditorFragment != null)) {"> 552             } else if ((newConfig.orientation == Configuration.ORIENTATION_PORTRAIT) &amp;&amp; (mNoteEditorFragmðŸ”µ</abbr>
 553                 // Remove the editor fragment when rotating back to portrait
 554                 mIsLandscape = false;
 555                 mCurrentNote = null;
 556                 if (mNoteListFragment != null) {
 557                     mNoteListFragment.setActivateOnItemClick(false);
 558                     mNoteListFragment.setDividerVisible(false);
 559                     mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 560                     mNoteListFragment.refreshList();
 561                 }
 562                 FragmentManager fm = getFragmentManager();
 563                 FragmentTransaction ft = fm.beginTransaction();
 564                 ft.remove(mNoteEditorFragment);
 565                 mNoteEditorFragment = null;
 566                 ft.commitAllowingStateLoss();
 567                 fm.executePendingTransactions();
 568                 invalidateOptionsMenu();
 569             }
 570         }
 571     }
 572 
 573     public void showDetailPlaceholder() {
 574         if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 575             mCurrentNote = null;
 576             invalidateOptionsMenu();
 577             mNoteEditorFragment.setPlaceholderVisible(true);
 578         }
 579     }
 580 
 581     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 582         @Override
 583         protected Void doInBackground(Void... voids) {
 584             Simplenote application = ((Simplenote) (getApplication()));
 585             Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 586             Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 587             Bucket.ObjectCursor c = query.execute();
 588             while (c.moveToNext()) {
 589                 c.getObject().delete();
 590             }
 591             return null;
 592         }
 593     }
 594 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.ActionBar;
   4  import android.app.Activity;
   5  import android.app.AlertDialog;
   6  import android.app.FragmentManager;
   7  import android.app.FragmentTransaction;
   8  import android.content.DialogInterface;
   9  import android.content.Intent;

  10  import android.content.res.Configuration;
  11  import android.os.AsyncTask;
  12  import android.os.Bundle;
  13  import android.os.Parcelable;

  14  import android.view.Menu;
  15  import android.view.MenuInflater;
  16  import android.view.MenuItem;
  17  import android.widget.ListView;
  18  import android.widget.SearchView;
  19  
  20  import com.automattic.simplenote.models.Note;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import com.automattic.simplenote.models.Tag;</span>
  22  import com.automattic.simplenote.utils.UndoBarController;
  23  import com.google.analytics.tracking.android.EasyTracker;
  24  import com.google.analytics.tracking.android.GoogleAnalytics;
  25  import com.google.analytics.tracking.android.Tracker;
  26  import com.simperium.Simperium;
  27  import com.simperium.client.Bucket;
  28  import com.simperium.client.LoginActivity;
  29  import com.simperium.client.Query;
  30  import com.simperium.client.User;
  31  
  32  import java.util.Calendar;
  33  
  34  /**
  35   * An activity representing a list of Notes.
  36   * &lt;p/&gt;
  37   * The activity makes heavy use of fragments. The list of items is a
  38   * {@link NoteListFragment} and the item details (if present) is a
  39   * {@link NoteEditorFragment}.
  40   * &lt;p/&gt;
  41   * This activity also implements the required {@link NoteListFragment.Callbacks}
  42   * interface to listen for item selections.
  43   */
  44  public class NotesActivity extends Activity implements
  45          NoteListFragment.Callbacks, ActionBar.OnNavigationListener,
  46          User.AuthenticationListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,
  47          FragmentManager.OnBackStackChangedListener, Bucket.Listener&lt;Note&gt; {
  48  
  49      private boolean mIsLargeScreen, mIsLandscape;
  50      private UndoBarController mUndoBarController;
  51      private SearchView mSearchView;
  52      private MenuItem mSearchMenuItem;
  53      private NoteListFragment mNoteListFragment;
  54      private NoteEditorFragment mNoteEditorFragment;
  55      private Note mCurrentNote;
  56      private Bucket&lt;Note&gt; mNotesBucket;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +    private Bucket&lt;Tag&gt; mTagsBucket;</span>
  58      private int TRASH_SELECTED_ID = 1;

  59  
  60      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  61      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  62  
  63      // Google Analytics tracker
  64      private Tracker mTracker;
  65  
  66      @Override
  67      protected void onCreate(Bundle savedInstanceState) {
  68          super.onCreate(savedInstanceState);
  69          Simplenote currentApp = (Simplenote) getApplication();
  70          mNotesBucket = currentApp.getNotesBucket();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +        mTagsBucket = currentApp.getTagsBucket();</span>
  72          setContentView(R.layout.activity_notes);



  73  
  74          if (savedInstanceState == null) {
  75              mNoteListFragment = new NoteListFragment();
  76              FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
  77              fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
  78              fragmentTransaction.commit();
  79          } else {
  80              mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
  81          }
  82  
  83  
  84          Configuration config = getBaseContext().getResources().getConfiguration();
  85          if ((config.screenLayout
  86                  &amp; Configuration.SCREENLAYOUT_SIZE_MASK)
  87                  &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {
  88              mIsLargeScreen = true;
  89  
  90              if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="  91                  mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">  91                  mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR)ðŸ”µ</abbr>
  92              } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
  93                  mIsLandscape = true;
  94                  addEditorFragment();
  95              }
  96          }
  97  
  98          ActionBar ab = getActionBar();
  99          ab.setNavigationMode(ActionBar.NAVIGATION_MODE_LIST);
 100          ab.setDisplayShowTitleEnabled(false);



 101  
 102          mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);
 103  
 104          getFragmentManager().addOnBackStackChangedListener(this);
 105  
<abbr title=" 106          if (currentApp.getSimperium().getUser() == null || currentApp.getSimperium().getUser().needsAuthentication()) {"> 106          if (currentApp.getSimperium().getUser() == null || currentApp.getSimperium().getUser().needsAuthenticationðŸ”µ</abbr>
 107              startLoginActivity();
 108          } else if (Intent.ACTION_SEND.equals(getIntent().getAction())) {
















 109              // Check share action
 110              Intent intent = getIntent();
 111              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 112              if (text != null) {
 113                  Note note = mNotesBucket.newObject();
 114                  note.setCreationDate(Calendar.getInstance());
 115                  note.setContent(text);
 116                  note.save();
 117                  onNoteSelected(note);

 118                  mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;external_share&quot;, null);
 119              }
 120          }
 121          currentApp.getSimperium().setOnUserCreatedListener(this);
 122          currentApp.getSimperium().setAuthenticationListener(this);
 123  
 124          EasyTracker.getInstance().activityStart(this); // Add this method.
 125          mTracker = EasyTracker.getTracker();
 126      }
 127  
 128      private void addEditorFragment() {
 129          FragmentManager fm = getFragmentManager();
 130          FragmentTransaction ft = fm.beginTransaction();
 131          mNoteEditorFragment = new NoteEditorFragment();
 132          ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 133          ft.commitAllowingStateLoss();
 134          fm.executePendingTransactions();
 135      }
 136  
 137      @Override
 138      protected void onResume() {
 139          super.onResume();
 140  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +        mNotesBucket.start();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +        mTagsBucket.start();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +</span>
 144          mNotesBucket.addOnNetworkChangeListener(this);
 145          mNotesBucket.addOnSaveObjectListener(this);
 146          mNotesBucket.addOnDeleteObjectListener(this);
 147  
 148          configureActionBar();
 149          invalidateOptionsMenu();
 150      }
 151  
 152      @Override
 153      protected void onPause() {
 154          super.onPause();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +        mNotesBucket.stop();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +        mTagsBucket.stop();</span>
 158  
 159          mNotesBucket.removeOnNetworkChangeListener(this);
 160          mNotesBucket.removeOnSaveObjectListener(this);
 161          mNotesBucket.removeOnDeleteObjectListener(this);
 162      }
 163  
 164      @Override
 165      public void onStop() {
 166          super.onStop();
 167          EasyTracker.getInstance().activityStop(this);




 168      }
 169  
 170      // received a change from the network, refresh the list and the editor
 171      @Override
 172      public void onChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 173          final boolean resetEditor = mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(key);
 174          runOnUiThread(new Runnable() {
 175              @Override
 176              public void run() {
 177                  mNoteListFragment.refreshList();
 178                  if (!resetEditor) return;
 179                  if (mNoteEditorFragment != null) {
 180                      mNoteEditorFragment.refreshContent();

 181                  }
 182              }
 183          });
 184      }
 185  
 186      @Override
 187      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 188          runOnUiThread(new Runnable() {
 189              @Override
 190              public void run() {
 191                  mNoteListFragment.refreshList();
 192              }
 193          });
 194      }
 195  
 196      @Override
 197      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 198          runOnUiThread(new Runnable() {
 199              @Override
 200              public void run() {
 201                  mNoteListFragment.refreshList();
 202              }
 203          });
 204      }
 205  
 206      public boolean isLargeScreen() {
 207          return mIsLargeScreen;
 208      }
 209  
 210      public boolean isLargeScreenLandscape() {
 211          return mIsLargeScreen &amp;&amp; mIsLandscape;
 212      }
 213  
 214      // nbradbury 01-Apr-2013
 215      private NoteListFragment getNoteListFragment() {
 216          return mNoteListFragment;
 217      }
 218  
 219      @Override
 220      public boolean onCreateOptionsMenu(Menu menu) {
 221          super.onCreateOptionsMenu(menu);
 222          MenuInflater inflater = getMenuInflater();
 223          inflater.inflate(R.menu.notes_list, menu);
 224  
 225          mSearchMenuItem = menu.findItem(R.id.menu_search);
 226          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 227          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 228              @Override
 229              public boolean onQueryTextChange(String newText) {
 230                  if (mSearchMenuItem.isActionViewExpanded())
 231                      getNoteListFragment().searchNotes(newText);
 232                  return true;
 233              }
 234  
 235              @Override
 236              public boolean onQueryTextSubmit(String queryText) {
 237                  getNoteListFragment().searchNotes(queryText);
 238                  return true;
 239              }
 240  
 241          });
 242          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 243              @Override
 244              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 245                  showDetailPlaceholder();
 246                  getNoteListFragment().setEmptyListMessage(getString(R.string.no_notes_found));
 247                  mTracker.sendEvent(&quot;note&quot;, &quot;searched_notes&quot;, &quot;action_bar_search_tap&quot;, null);
 248                  return true;
 249              }
 250  
 251              @Override
 252              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 253                  // Show all notes again
 254                  getNoteListFragment().setEmptyListMessage(getString(R.string.no_notes));
 255                  getNoteListFragment().clearSearch();
 256                  return true;
 257              }
 258          });
 259  






 260          FragmentManager fm = getFragmentManager();
 261          if (fm.getBackStackEntryCount() &gt; 0) {
 262              getActionBar().setDisplayHomeAsUpEnabled(true);

 263              menu.findItem(R.id.menu_create_note).setVisible(false);
 264              menu.findItem(R.id.menu_search).setVisible(false);
 265              menu.findItem(R.id.menu_preferences).setVisible(false);
 266              menu.findItem(R.id.menu_share).setVisible(true);
 267              menu.findItem(R.id.menu_delete).setVisible(true);
 268              if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 269                  menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 270              menu.findItem(R.id.menu_edit_tags).setVisible(false);
 271              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 272          } else if (isLargeScreenLandscape()) {
 273              getActionBar().setDisplayHomeAsUpEnabled(false);
 274              getActionBar().setHomeButtonEnabled(false);


 275              menu.findItem(R.id.menu_create_note).setVisible(true);
 276              menu.findItem(R.id.menu_search).setVisible(true);
 277              menu.findItem(R.id.menu_preferences).setVisible(true);
 278              if (mCurrentNote != null) {
 279                  menu.findItem(R.id.menu_share).setVisible(true);
 280                  menu.findItem(R.id.menu_delete).setVisible(true);
 281              } else {
 282                  menu.findItem(R.id.menu_share).setVisible(false);
 283                  menu.findItem(R.id.menu_delete).setVisible(false);
 284              }
 285              menu.findItem(R.id.menu_edit_tags).setVisible(true);
 286              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 287          } else {
 288              getActionBar().setDisplayHomeAsUpEnabled(false);
 289              getActionBar().setHomeButtonEnabled(false);


 290              menu.findItem(R.id.menu_create_note).setVisible(true);
 291              menu.findItem(R.id.menu_search).setVisible(true);
 292              menu.findItem(R.id.menu_preferences).setVisible(true);
 293              menu.findItem(R.id.menu_share).setVisible(false);
 294              menu.findItem(R.id.menu_delete).setVisible(false);
 295              menu.findItem(R.id.menu_edit_tags).setVisible(true);
 296              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 297          }
 298  
 299          // Are we looking at the trash? Adjust menu accordingly.
 300          if (getActionBar().getSelectedNavigationIndex() == TRASH_SELECTED_ID) {

 301              menu.findItem(R.id.menu_empty_trash).setVisible(true);
 302              menu.findItem(R.id.menu_create_note).setVisible(false);
 303              menu.findItem(R.id.menu_search).setVisible(false);
 304              menu.findItem(R.id.menu_share).setVisible(false);
 305          }
 306  
 307          return true;
 308      }
 309  
 310      @Override
 311      public boolean onOptionsItemSelected(MenuItem item) {
 312          switch (item.getItemId()) {
 313              case R.id.menu_preferences:
<abbr title=" 314                  // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 314                  // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from prðŸ”µ</abbr>
 315                  Intent i = new Intent(this, PreferencesActivity.class);
 316                  startActivityForResult(i, Simplenote.INTENT_PREFERENCES);



 317                  return true;
 318              case R.id.menu_edit_tags:
 319                  Intent editTagsIntent = new Intent(this, TagsListActivity.class);
 320                  startActivity(editTagsIntent);
 321                  return true;
 322              case R.id.menu_create_note:
 323                  getNoteListFragment().addNote();
 324                  mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;action_bar_button&quot;, null);
 325                  return true;
 326              case R.id.menu_share:
 327                  if (mCurrentNote != null) {
 328                      Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 329                      shareIntent.setType(&quot;text/plain&quot;);
 330                      shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 331                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 331                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note))ðŸ”µ</abbr>
 332                      mTracker.sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, null);
 333                  }
 334                  return true;
 335              case R.id.menu_delete:
 336                  if (mNoteEditorFragment != null) {
 337                      if (mCurrentNote != null) {
 338                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 339                          mCurrentNote.setModificationDate(Calendar.getInstance());
 340                          mCurrentNote.save();
 341  
 342                          if (mCurrentNote.isDeleted()) {
 343                              mUndoBarController.setDeletedNote(mCurrentNote);
 344                              mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
 345                              mTracker.sendEvent(&quot;note&quot;, &quot;deleted_note&quot;, &quot;overflow_menu&quot;, null);
 346                          } else {
 347                              mTracker.sendEvent(&quot;note&quot;, &quot;restored_note&quot;, &quot;overflow_menu&quot;, null);
 348                          }
 349                          showDetailPlaceholder();
 350                      }
 351                      popNoteDetail();
 352                      NoteListFragment fragment = getNoteListFragment();
 353                      if (fragment != null) {
 354                          fragment.getPrefs();
 355                          fragment.refreshList();
 356                      }
 357                  }
 358                  return true;
 359              case R.id.menu_empty_trash:
 360                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 361  
 362                  alert.setTitle(R.string.empty_trash);
 363                  alert.setMessage(R.string.confirm_empty_trash);
 364                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 365                      public void onClick(DialogInterface dialog, int whichButton) {
 366                          new emptyTrashTask().execute();
 367                          mTracker.sendEvent(&quot;note&quot;, &quot;trash_emptied&quot;, &quot;overflow_menu&quot;, null);
 368                      }
 369                  });
 370                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 371                      public void onClick(DialogInterface dialog, int whichButton) {
 372                          // Do nothing, just closing the dialog
 373                      }
 374                  });
 375                  alert.show();
 376                  return true;
 377              case android.R.id.home:
 378                  popNoteDetail();
 379                  invalidateOptionsMenu();
 380                  return true;
 381              default:
 382                  return super.onOptionsItemSelected(item);
 383          }
 384      }
 385  
 386      protected void popNoteDetail() {
 387          FragmentManager fm = getFragmentManager();
 388          if (fm.getBackStackEntryCount() &gt; 0) {
 389              try {
 390                  fm.popBackStack();
 391              } catch (Exception e) {
 392                  e.printStackTrace();
 393              }
 394          }
 395      }
 396  
 397      /**
 398       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 399       * the item with the given ID was selected.
 400       */
 401      @Override
 402      public void onNoteSelected(Note note) {

 403  
 404          if (mSearchMenuItem != null)
 405              mSearchMenuItem.collapseActionView();
 406  
 407          mCurrentNote = note;
 408          String noteKey = note == null ? &quot;none&quot; : note.getSimperiumKey();
 409  
 410          FragmentManager fm = getFragmentManager();
 411  
 412          if (!isLargeScreenLandscape()) {
 413              ActionBar ab = getActionBar();
 414              ab.setNavigationMode(ActionBar.NAVIGATION_MODE_STANDARD);
 415              ab.setDisplayShowTitleEnabled(true);


 416  
 417              // Create editor fragment
 418              Bundle arguments = new Bundle();
 419              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteKey);

 420              mNoteEditorFragment = new NoteEditorFragment();
 421              mNoteEditorFragment.setArguments(arguments);
 422  
 423              // Add editor fragment to stack
 424              FragmentTransaction ft = fm.beginTransaction();
<abbr title=" 425              ft.setCustomAnimations(R.animator.slide_in, R.animator.zoom_in_and_fade, R.animator.zoom_out_and_fade, R.animator.slide_out);"> 425              ft.setCustomAnimations(R.animator.slide_in, R.animator.zoom_in_and_fade, R.animator.zoom_out_and_fade,ðŸ”µ</abbr>
 426              ft.replace(R.id.noteFragmentContainer, mNoteEditorFragment);
 427              ft.addToBackStack(null);
 428              ft.commitAllowingStateLoss();
 429              fm.executePendingTransactions();
 430          } else {
 431              mNoteEditorFragment.setNote(note);
 432              getNoteListFragment().setNoteSelected(note);
 433          }
 434  
 435          invalidateOptionsMenu();



 436  
 437          mTracker.sendEvent(&quot;note&quot;, &quot;viewed_note&quot;, &quot;note_list_row_tap&quot;, null);
 438      }
 439  
 440      @Override
 441      public boolean onNavigationItemSelected(int itemPosition, long itemId) {
 442          // TODO Auto-generated method stub
 443          return false;
 444      }
 445  
 446      @Override
 447      public void onUserCreated(User user) {
 448          // New account created
 449          mTracker.sendEvent(&quot;user&quot;, &quot;new_account_created&quot;, &quot;account_created_from_login_activity&quot;, null);
 450      }
 451  
 452      public void onAuthenticationStatusChange(User.AuthenticationStatus status) {
 453          if (status == User.AuthenticationStatus.NOT_AUTHENTICATED) {
 454              startLoginActivity();
 455          } else if (status == User.AuthenticationStatus.AUTHENTICATED) {

 456              // User signed in
 457              mTracker.sendEvent(&quot;user&quot;, &quot;signed_in&quot;, &quot;signed_in_from_login_activity&quot;, null);

 458          }
 459      }
 460  
 461      public void startLoginActivity() {
 462          Intent loginIntent = new Intent(this, LoginActivity.class);

 463          startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 464      }
 465  
 466  
 467      @Override
 468      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 469          super.onActivityResult(requestCode, resultCode, data);
 470          switch (requestCode) {
 471              case Simperium.SIGNUP_SIGNIN_REQUEST:
 472                  if (resultCode == RESULT_CANCELED)
 473                      finish();
 474                  break;
 475              case Simplenote.INTENT_PREFERENCES:
<abbr title=" 476                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 476                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
 477                  NoteListFragment fragment = getNoteListFragment();
 478                  if (fragment != null) {
 479                      fragment.getPrefs();
 480                      fragment.refreshList();
 481                  }
 482                  break;
 483          }
 484      }
 485  
 486      @Override
 487      public void onUndo(Parcelable p) {
 488          if (mUndoBarController != null &amp;&amp; mUndoBarController.getDeletedNote() != null) {
 489              Note deletedNote = mUndoBarController.getDeletedNote();
 490              if (deletedNote != null) {
 491                  deletedNote.setDeleted(false);
 492                  deletedNote.setModificationDate(Calendar.getInstance());
 493                  deletedNote.save();
 494                  NoteListFragment fragment = getNoteListFragment();
 495                  if (fragment != null) {
 496                      fragment.getPrefs();
 497                      fragment.refreshList();
 498                  }
 499              }
 500          }
 501      }
 502  
 503      @Override
 504      public void onBackStackChanged() {
 505          configureActionBar();
 506          invalidateOptionsMenu();
 507      }
 508  
 509      private void configureActionBar() {
 510          if (getFragmentManager().getBackStackEntryCount() &gt; 0) {
 511              ActionBar ab = getActionBar();

 512              if (ab != null) {
 513                  ab.setNavigationMode(ActionBar.NAVIGATION_MODE_STANDARD);
 514                  ab.setDisplayShowTitleEnabled(true);
 515              }
 516          } else {
 517              ActionBar ab = getActionBar();

 518              if (ab != null) {
 519                  ab.setNavigationMode(ActionBar.NAVIGATION_MODE_LIST);
 520                  ab.setDisplayShowTitleEnabled(false);

 521              }
 522          }
 523      }
 524  
 525      @Override
 526      public void onConfigurationChanged(Configuration newConfig) {
 527          super.onConfigurationChanged(newConfig);
 528  
 529          if (mIsLargeScreen) {
 530              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 531                  // Add the editor fragment
 532                  mIsLandscape = true;
 533                  popNoteDetail();
 534                  addEditorFragment();
 535                  if (mNoteListFragment != null) {
 536                      mNoteListFragment.setActivateOnItemClick(true);
 537                      mNoteListFragment.setDividerVisible(true);
 538                  }
 539                  // Select the current note on a tablet
 540                  if (mCurrentNote != null)
 541                      onNoteSelected(mCurrentNote);

 542                  else {
 543                      mNoteEditorFragment.setPlaceholderVisible(true);
 544                      mNoteListFragment.getListView().clearChoices();
 545                  }
 546                  invalidateOptionsMenu();
<abbr title=" 547              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {"> 547              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null)ðŸ”µ</abbr>
 548                  // Remove the editor fragment when rotating back to portrait
 549                  mIsLandscape = false;
 550                  mCurrentNote = null;
 551                  if (mNoteListFragment != null) {
 552                      mNoteListFragment.setActivateOnItemClick(false);
 553                      mNoteListFragment.setDividerVisible(false);
 554                      mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 555                      mNoteListFragment.refreshList();
 556                  }
 557                  FragmentManager fm = getFragmentManager();
 558                  FragmentTransaction ft = fm.beginTransaction();
 559                  ft.remove(mNoteEditorFragment);
 560                  mNoteEditorFragment = null;
 561                  ft.commitAllowingStateLoss();
 562                  fm.executePendingTransactions();
 563                  invalidateOptionsMenu();
 564              }
 565          }
 566      }
 567  
 568      public void showDetailPlaceholder() {
 569          if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 570              mCurrentNote = null;
 571              invalidateOptionsMenu();
 572              mNoteEditorFragment.setPlaceholderVisible(true);
 573          }
 574      }
 575  
 576      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 577  
 578          @Override
 579          protected Void doInBackground(Void... voids) {
 580              Simplenote application = (Simplenote) getApplication();
 581              Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 582              Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 583              Bucket.ObjectCursor c = query.execute();
 584              while (c.moveToNext()) {
 585                  c.getObject().delete();
 586              }
 587              return null;
 588          }
 589      }
 590  
 591  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.ActionBar;
   4  import android.app.Activity;
   5  import android.app.AlertDialog;
   6  import android.app.FragmentManager;
   7  import android.app.FragmentTransaction;
   8  import android.content.DialogInterface;
   9  import android.content.Intent;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 +import android.content.SharedPreferences;</span>
  11  import android.content.res.Configuration;
  12  import android.os.AsyncTask;
  13  import android.os.Bundle;
  14  import android.os.Parcelable;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 +import android.preference.PreferenceManager;</span>
  16  import android.view.Menu;
  17  import android.view.MenuInflater;
  18  import android.view.MenuItem;
  19  import android.widget.ListView;
  20  import android.widget.SearchView;
  21  
  22  import com.automattic.simplenote.models.Note;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.automattic.simplenote.utils.PrefUtils;</span>
  24  import com.automattic.simplenote.utils.UndoBarController;
  25  import com.google.analytics.tracking.android.EasyTracker;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import com.google.analytics.tracking.android.GoogleAnalytics;</span>
  27  import com.google.analytics.tracking.android.Tracker;
  28  import com.simperium.Simperium;
  29  import com.simperium.client.Bucket;
  30  import com.simperium.client.LoginActivity;
  31  import com.simperium.client.Query;
  32  import com.simperium.client.User;
  33  
  34  import java.util.Calendar;
  35  
  36  /**
  37   * An activity representing a list of Notes.
  38   * &lt;p/&gt;
  39   * The activity makes heavy use of fragments. The list of items is a
  40   * {@link NoteListFragment} and the item details (if present) is a
  41   * {@link NoteEditorFragment}.
  42   * &lt;p/&gt;
  43   * This activity also implements the required {@link NoteListFragment.Callbacks}
  44   * interface to listen for item selections.
  45   */
  46  public class NotesActivity extends Activity implements
  47          NoteListFragment.Callbacks, ActionBar.OnNavigationListener,
  48          User.AuthenticationListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,
  49          FragmentManager.OnBackStackChangedListener, Bucket.Listener&lt;Note&gt; {
  50  
  51      private boolean mIsLargeScreen, mIsLandscape;
  52      private UndoBarController mUndoBarController;
  53      private SearchView mSearchView;
  54      private MenuItem mSearchMenuItem;
  55      private NoteListFragment mNoteListFragment;
  56      private NoteEditorFragment mNoteEditorFragment;
  57      private Note mCurrentNote;
  58      private Bucket&lt;Note&gt; mNotesBucket;

  59      private int TRASH_SELECTED_ID = 1;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +    private ActionBar mActionBar;</span>
  61  
  62      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  63      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  64  
  65      // Google Analytics tracker
  66      private Tracker mTracker;
  67  
  68      @Override
  69      protected void onCreate(Bundle savedInstanceState) {
  70          super.onCreate(savedInstanceState);
  71          Simplenote currentApp = (Simplenote) getApplication();
  72          mNotesBucket = currentApp.getNotesBucket();

  73          setContentView(R.layout.activity_notes);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +        EasyTracker.getInstance().activityStart(this); // Add this method.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +        mTracker = EasyTracker.getTracker();</span>
  77  
  78          if (savedInstanceState == null) {
  79              mNoteListFragment = new NoteListFragment();
  80              FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
  81              fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
  82              fragmentTransaction.commit();
  83          } else {
  84              mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
  85          }
  86  
  87  
  88          Configuration config = getBaseContext().getResources().getConfiguration();
  89          if ((config.screenLayout
  90                  &amp; Configuration.SCREENLAYOUT_SIZE_MASK)
  91                  &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {
  92              mIsLargeScreen = true;
  93  
  94              if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="  95                  mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">  95                  mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR)ðŸ”µ</abbr>
  96              } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
  97                  mIsLandscape = true;
  98                  addEditorFragment();
  99              }
 100          }
 101  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -        ActionBar ab = getActionBar();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        ab.setNavigationMode(ActionBar.NAVIGATION_MODE_LIST);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        ab.setDisplayShowTitleEnabled(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +        mActionBar = getActionBar();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +        mActionBar.setNavigationMode(ActionBar.NAVIGATION_MODE_LIST);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +        mActionBar.setDisplayShowTitleEnabled(false);</span>
 108  
 109          mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);
 110  
 111          getFragmentManager().addOnBackStackChangedListener(this);
 112  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 113 -        if (currentApp.getSimperium().getUser() == null || currentApp.getSimperium().getUser().needsAuthentication()) {"> 113 -        if (currentApp.getSimperium().getUser() == null || currentApp.getSimperium().getUser().needsAuthenticationðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -            startLoginActivity();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -        } else if (Intent.ACTION_SEND.equals(getIntent().getAction())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +        if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +            // Create the welcome note</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +            Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +            welcomeNote.setCreationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +            welcomeNote.setModificationDate(welcomeNote.getCreationDate());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +            welcomeNote.setContent(getString(R.string.welcome_note));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +            welcomeNote.getTitle();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +            welcomeNote.save();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +            SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +            SharedPreferences.Editor editor = preferences.edit();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +            editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +            editor.commit();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +            if (Intent.ACTION_SEND.equals(getIntent().getAction())) {</span>
 132              // Check share action
 133              Intent intent = getIntent();
 134              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 135              if (text != null) {
 136                  Note note = mNotesBucket.newObject();
 137                  note.setCreationDate(Calendar.getInstance());
 138                  note.setContent(text);
 139                  note.save();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -                onNoteSelected(note);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +                onNoteSelected(note.getSimperiumKey());</span>
 142                  mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;external_share&quot;, null);
 143              }
 144          }
 145          currentApp.getSimperium().setOnUserCreatedListener(this);
 146          currentApp.getSimperium().setAuthenticationListener(this);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -        EasyTracker.getInstance().activityStart(this); // Add this method.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -        mTracker = EasyTracker.getTracker();</span>
 150      }
 151  
 152      private void addEditorFragment() {
 153          FragmentManager fm = getFragmentManager();
 154          FragmentTransaction ft = fm.beginTransaction();
 155          mNoteEditorFragment = new NoteEditorFragment();
 156          ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 157          ft.commitAllowingStateLoss();
 158          fm.executePendingTransactions();
 159      }
 160  
 161      @Override
 162      protected void onResume() {
 163          super.onResume();
 164  



 165          mNotesBucket.addOnNetworkChangeListener(this);
 166          mNotesBucket.addOnSaveObjectListener(this);
 167          mNotesBucket.addOnDeleteObjectListener(this);
 168  
 169          configureActionBar();
 170          invalidateOptionsMenu();
 171      }
 172  
 173      @Override
 174      protected void onPause() {
 175          super.onPause();



 176  
 177          mNotesBucket.removeOnNetworkChangeListener(this);
 178          mNotesBucket.removeOnSaveObjectListener(this);
 179          mNotesBucket.removeOnDeleteObjectListener(this);
 180      }
 181  
 182      @Override
 183      public void onStop() {
 184          super.onStop();
 185          EasyTracker.getInstance().activityStop(this);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +    public void setCurrentNote(Note note) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +        mCurrentNote = note;</span>
 190      }
 191  
 192      // received a change from the network, refresh the list and the editor
 193      @Override
 194      public void onChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 195          final boolean resetEditor = mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(key);
 196          runOnUiThread(new Runnable() {
 197              @Override
 198              public void run() {
 199                  mNoteListFragment.refreshList();
 200                  if (!resetEditor) return;
 201                  if (mNoteEditorFragment != null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -                    mNoteEditorFragment.refreshContent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +                    mNoteEditorFragment.refreshContent(true);</span>
 204                  }
 205              }
 206          });
 207      }
 208  
 209      @Override
 210      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 211          runOnUiThread(new Runnable() {
 212              @Override
 213              public void run() {
 214                  mNoteListFragment.refreshList();
 215              }
 216          });
 217      }
 218  
 219      @Override
 220      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 221          runOnUiThread(new Runnable() {
 222              @Override
 223              public void run() {
 224                  mNoteListFragment.refreshList();
 225              }
 226          });
 227      }
 228  
 229      public boolean isLargeScreen() {
 230          return mIsLargeScreen;
 231      }
 232  
 233      public boolean isLargeScreenLandscape() {
 234          return mIsLargeScreen &amp;&amp; mIsLandscape;
 235      }
 236  
 237      // nbradbury 01-Apr-2013
 238      private NoteListFragment getNoteListFragment() {
 239          return mNoteListFragment;
 240      }
 241  
 242      @Override
 243      public boolean onCreateOptionsMenu(Menu menu) {
 244          super.onCreateOptionsMenu(menu);
 245          MenuInflater inflater = getMenuInflater();
 246          inflater.inflate(R.menu.notes_list, menu);
 247  
 248          mSearchMenuItem = menu.findItem(R.id.menu_search);
 249          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 250          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 251              @Override
 252              public boolean onQueryTextChange(String newText) {
 253                  if (mSearchMenuItem.isActionViewExpanded())
 254                      getNoteListFragment().searchNotes(newText);
 255                  return true;
 256              }
 257  
 258              @Override
 259              public boolean onQueryTextSubmit(String queryText) {
 260                  getNoteListFragment().searchNotes(queryText);
 261                  return true;
 262              }
 263  
 264          });
 265          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 266              @Override
 267              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 268                  showDetailPlaceholder();
 269                  getNoteListFragment().setEmptyListMessage(getString(R.string.no_notes_found));
 270                  mTracker.sendEvent(&quot;note&quot;, &quot;searched_notes&quot;, &quot;action_bar_search_tap&quot;, null);
 271                  return true;
 272              }
 273  
 274              @Override
 275              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 276                  // Show all notes again
 277                  getNoteListFragment().setEmptyListMessage(getString(R.string.no_notes));
 278                  getNoteListFragment().clearSearch();
 279                  return true;
 280              }
 281          });
 282  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +        Simplenote currentApp = (Simplenote) getApplication();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 284 +        if (currentApp.getSimperium().getUser() == null || currentApp.getSimperium().getUser().needsAuthentication())"> 284 +        if (currentApp.getSimperium().getUser() == null || currentApp.getSimperium().getUser().needsAuthenticationðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +            menu.findItem(R.id.menu_sign_in).setVisible(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +        else</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +            menu.findItem(R.id.menu_sign_in).setVisible(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +</span>
 289          FragmentManager fm = getFragmentManager();
 290          if (fm.getBackStackEntryCount() &gt; 0) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -            getActionBar().setDisplayHomeAsUpEnabled(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +            mActionBar.setDisplayHomeAsUpEnabled(true);</span>
 293              menu.findItem(R.id.menu_create_note).setVisible(false);
 294              menu.findItem(R.id.menu_search).setVisible(false);
 295              menu.findItem(R.id.menu_preferences).setVisible(false);
 296              menu.findItem(R.id.menu_share).setVisible(true);
 297              menu.findItem(R.id.menu_delete).setVisible(true);
 298              if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 299                  menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 300              menu.findItem(R.id.menu_edit_tags).setVisible(false);
 301              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 302          } else if (isLargeScreenLandscape()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -            getActionBar().setDisplayHomeAsUpEnabled(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -            getActionBar().setHomeButtonEnabled(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +            mActionBar.setDisplayHomeAsUpEnabled(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +            mActionBar.setHomeButtonEnabled(false);</span>
 307              menu.findItem(R.id.menu_create_note).setVisible(true);
 308              menu.findItem(R.id.menu_search).setVisible(true);
 309              menu.findItem(R.id.menu_preferences).setVisible(true);
 310              if (mCurrentNote != null) {
 311                  menu.findItem(R.id.menu_share).setVisible(true);
 312                  menu.findItem(R.id.menu_delete).setVisible(true);
 313              } else {
 314                  menu.findItem(R.id.menu_share).setVisible(false);
 315                  menu.findItem(R.id.menu_delete).setVisible(false);
 316              }
 317              menu.findItem(R.id.menu_edit_tags).setVisible(true);
 318              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 319          } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 320 -            getActionBar().setDisplayHomeAsUpEnabled(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 321 -            getActionBar().setHomeButtonEnabled(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +            mActionBar.setDisplayHomeAsUpEnabled(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +            mActionBar.setHomeButtonEnabled(false);</span>
 324              menu.findItem(R.id.menu_create_note).setVisible(true);
 325              menu.findItem(R.id.menu_search).setVisible(true);
 326              menu.findItem(R.id.menu_preferences).setVisible(true);
 327              menu.findItem(R.id.menu_share).setVisible(false);
 328              menu.findItem(R.id.menu_delete).setVisible(false);
 329              menu.findItem(R.id.menu_edit_tags).setVisible(true);
 330              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 331          }
 332  
 333          // Are we looking at the trash? Adjust menu accordingly.
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 334 -        if (getActionBar().getSelectedNavigationIndex() == TRASH_SELECTED_ID) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +        if (mActionBar.getSelectedNavigationIndex() == TRASH_SELECTED_ID) {</span>
 336              menu.findItem(R.id.menu_empty_trash).setVisible(true);
 337              menu.findItem(R.id.menu_create_note).setVisible(false);
 338              menu.findItem(R.id.menu_search).setVisible(false);
 339              menu.findItem(R.id.menu_share).setVisible(false);
 340          }
 341  
 342          return true;
 343      }
 344  
 345      @Override
 346      public boolean onOptionsItemSelected(MenuItem item) {
 347          switch (item.getItemId()) {
 348              case R.id.menu_preferences:
<abbr title=" 349                  // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 349                  // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from prðŸ”µ</abbr>
 350                  Intent i = new Intent(this, PreferencesActivity.class);
 351                  startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +            case R.id.menu_sign_in:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +                startLoginActivity();</span>
 355                  return true;
 356              case R.id.menu_edit_tags:
 357                  Intent editTagsIntent = new Intent(this, TagsListActivity.class);
 358                  startActivity(editTagsIntent);
 359                  return true;
 360              case R.id.menu_create_note:
 361                  getNoteListFragment().addNote();
 362                  mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;action_bar_button&quot;, null);
 363                  return true;
 364              case R.id.menu_share:
 365                  if (mCurrentNote != null) {
 366                      Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 367                      shareIntent.setType(&quot;text/plain&quot;);
 368                      shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 369                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 369                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note))ðŸ”µ</abbr>
 370                      mTracker.sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, null);
 371                  }
 372                  return true;
 373              case R.id.menu_delete:
 374                  if (mNoteEditorFragment != null) {
 375                      if (mCurrentNote != null) {
 376                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 377                          mCurrentNote.setModificationDate(Calendar.getInstance());
 378                          mCurrentNote.save();
 379  
 380                          if (mCurrentNote.isDeleted()) {
 381                              mUndoBarController.setDeletedNote(mCurrentNote);
 382                              mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
 383                              mTracker.sendEvent(&quot;note&quot;, &quot;deleted_note&quot;, &quot;overflow_menu&quot;, null);
 384                          } else {
 385                              mTracker.sendEvent(&quot;note&quot;, &quot;restored_note&quot;, &quot;overflow_menu&quot;, null);
 386                          }
 387                          showDetailPlaceholder();
 388                      }
 389                      popNoteDetail();
 390                      NoteListFragment fragment = getNoteListFragment();
 391                      if (fragment != null) {
 392                          fragment.getPrefs();
 393                          fragment.refreshList();
 394                      }
 395                  }
 396                  return true;
 397              case R.id.menu_empty_trash:
 398                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 399  
 400                  alert.setTitle(R.string.empty_trash);
 401                  alert.setMessage(R.string.confirm_empty_trash);
 402                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 403                      public void onClick(DialogInterface dialog, int whichButton) {
 404                          new emptyTrashTask().execute();
 405                          mTracker.sendEvent(&quot;note&quot;, &quot;trash_emptied&quot;, &quot;overflow_menu&quot;, null);
 406                      }
 407                  });
 408                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 409                      public void onClick(DialogInterface dialog, int whichButton) {
 410                          // Do nothing, just closing the dialog
 411                      }
 412                  });
 413                  alert.show();
 414                  return true;
 415              case android.R.id.home:
 416                  popNoteDetail();
 417                  invalidateOptionsMenu();
 418                  return true;
 419              default:
 420                  return super.onOptionsItemSelected(item);
 421          }
 422      }
 423  
 424      protected void popNoteDetail() {
 425          FragmentManager fm = getFragmentManager();
 426          if (fm.getBackStackEntryCount() &gt; 0) {
 427              try {
 428                  fm.popBackStack();
 429              } catch (Exception e) {
 430                  e.printStackTrace();
 431              }
 432          }
 433      }
 434  
 435      /**
 436       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 437       * the item with the given ID was selected.
 438       */
 439      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 440 -    public void onNoteSelected(Note note) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 441 +    public void onNoteSelected(String noteID) {</span>
 442  
 443          if (mSearchMenuItem != null)
 444              mSearchMenuItem.collapseActionView();
 445  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 446 -        mCurrentNote = note;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 447 -        String noteKey = note == null ? &quot;none&quot; : note.getSimperiumKey();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 448 -</span>
 449          FragmentManager fm = getFragmentManager();
 450  
 451          if (!isLargeScreenLandscape()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 452 -            ActionBar ab = getActionBar();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 453 -            ab.setNavigationMode(ActionBar.NAVIGATION_MODE_STANDARD);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 454 -            ab.setDisplayShowTitleEnabled(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 455 +            mActionBar.setNavigationMode(ActionBar.NAVIGATION_MODE_STANDARD);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 456 +            mActionBar.setDisplayShowTitleEnabled(true);</span>
 457  
 458              // Create editor fragment
 459              Bundle arguments = new Bundle();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 460 -            arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteKey);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 461 +            arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);</span>
 462              mNoteEditorFragment = new NoteEditorFragment();
 463              mNoteEditorFragment.setArguments(arguments);
 464  
 465              // Add editor fragment to stack
 466              FragmentTransaction ft = fm.beginTransaction();
<abbr title=" 467              ft.setCustomAnimations(R.animator.slide_in, R.animator.zoom_in_and_fade, R.animator.zoom_out_and_fade, R.animator.slide_out);"> 467              ft.setCustomAnimations(R.animator.slide_in, R.animator.zoom_in_and_fade, R.animator.zoom_out_and_fade,ðŸ”µ</abbr>
 468              ft.replace(R.id.noteFragmentContainer, mNoteEditorFragment);
 469              ft.addToBackStack(null);
 470              ft.commitAllowingStateLoss();
 471              fm.executePendingTransactions();
 472          } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 473 -            mNoteEditorFragment.setNote(note);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 474 -            getNoteListFragment().setNoteSelected(note);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 475 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 476 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 477 -        invalidateOptionsMenu();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 478 +            mNoteEditorFragment.setNote(noteID);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 479 +            getNoteListFragment().setNoteSelected(noteID);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 480 +        }</span>
 481  
 482          mTracker.sendEvent(&quot;note&quot;, &quot;viewed_note&quot;, &quot;note_list_row_tap&quot;, null);
 483      }
 484  
 485      @Override
 486      public boolean onNavigationItemSelected(int itemPosition, long itemId) {
 487          // TODO Auto-generated method stub
 488          return false;
 489      }
 490  
 491      @Override
 492      public void onUserCreated(User user) {
 493          // New account created
 494          mTracker.sendEvent(&quot;user&quot;, &quot;new_account_created&quot;, &quot;account_created_from_login_activity&quot;, null);
 495      }
 496  
 497      public void onAuthenticationStatusChange(User.AuthenticationStatus status) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 498 -        if (status == User.AuthenticationStatus.NOT_AUTHENTICATED) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 499 -            startLoginActivity();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 500 -        } else if (status == User.AuthenticationStatus.AUTHENTICATED) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 501 +        if (status == User.AuthenticationStatus.AUTHENTICATED) {</span>
 502              // User signed in
 503              mTracker.sendEvent(&quot;user&quot;, &quot;signed_in&quot;, &quot;signed_in_from_login_activity&quot;, null);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 504 +            invalidateOptionsMenu();</span>
 505          }
 506      }
 507  
 508      public void startLoginActivity() {
 509          Intent loginIntent = new Intent(this, LoginActivity.class);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 510 +        loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);</span>
 511          startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 512      }
 513  
 514  
 515      @Override
 516      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 517          super.onActivityResult(requestCode, resultCode, data);
 518          switch (requestCode) {
 519              case Simperium.SIGNUP_SIGNIN_REQUEST:
 520                  if (resultCode == RESULT_CANCELED)
 521                      finish();
 522                  break;
 523              case Simplenote.INTENT_PREFERENCES:
<abbr title=" 524                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 524                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
 525                  NoteListFragment fragment = getNoteListFragment();
 526                  if (fragment != null) {
 527                      fragment.getPrefs();
 528                      fragment.refreshList();
 529                  }
 530                  break;
 531          }
 532      }
 533  
 534      @Override
 535      public void onUndo(Parcelable p) {
 536          if (mUndoBarController != null &amp;&amp; mUndoBarController.getDeletedNote() != null) {
 537              Note deletedNote = mUndoBarController.getDeletedNote();
 538              if (deletedNote != null) {
 539                  deletedNote.setDeleted(false);
 540                  deletedNote.setModificationDate(Calendar.getInstance());
 541                  deletedNote.save();
 542                  NoteListFragment fragment = getNoteListFragment();
 543                  if (fragment != null) {
 544                      fragment.getPrefs();
 545                      fragment.refreshList();
 546                  }
 547              }
 548          }
 549      }
 550  
 551      @Override
 552      public void onBackStackChanged() {
 553          configureActionBar();
 554          invalidateOptionsMenu();
 555      }
 556  
 557      private void configureActionBar() {
 558          if (getFragmentManager().getBackStackEntryCount() &gt; 0) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 559 -            ActionBar ab = getActionBar();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 560 +            ActionBar ab = mActionBar;</span>
 561              if (ab != null) {
 562                  ab.setNavigationMode(ActionBar.NAVIGATION_MODE_STANDARD);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 563 -                ab.setDisplayShowTitleEnabled(true);</span>
 564              }
 565          } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 566 -            ActionBar ab = getActionBar();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 567 +            ActionBar ab = mActionBar;</span>
 568              if (ab != null) {
 569                  ab.setNavigationMode(ActionBar.NAVIGATION_MODE_LIST);
 570                  ab.setDisplayShowTitleEnabled(false);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 571 +                ab.setTitle(&quot;&quot;);</span>
 572              }
 573          }
 574      }
 575  
 576      @Override
 577      public void onConfigurationChanged(Configuration newConfig) {
 578          super.onConfigurationChanged(newConfig);
 579  
 580          if (mIsLargeScreen) {
 581              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 582                  // Add the editor fragment
 583                  mIsLandscape = true;
 584                  popNoteDetail();
 585                  addEditorFragment();
 586                  if (mNoteListFragment != null) {
 587                      mNoteListFragment.setActivateOnItemClick(true);
 588                      mNoteListFragment.setDividerVisible(true);
 589                  }
 590                  // Select the current note on a tablet
 591                  if (mCurrentNote != null)
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 592 -                    onNoteSelected(mCurrentNote);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 593 +                    onNoteSelected(mCurrentNote.getSimperiumKey());</span>
 594                  else {
 595                      mNoteEditorFragment.setPlaceholderVisible(true);
 596                      mNoteListFragment.getListView().clearChoices();
 597                  }
 598                  invalidateOptionsMenu();
<abbr title=" 599              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {"> 599              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null)ðŸ”µ</abbr>
 600                  // Remove the editor fragment when rotating back to portrait
 601                  mIsLandscape = false;
 602                  mCurrentNote = null;
 603                  if (mNoteListFragment != null) {
 604                      mNoteListFragment.setActivateOnItemClick(false);
 605                      mNoteListFragment.setDividerVisible(false);
 606                      mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 607                      mNoteListFragment.refreshList();
 608                  }
 609                  FragmentManager fm = getFragmentManager();
 610                  FragmentTransaction ft = fm.beginTransaction();
 611                  ft.remove(mNoteEditorFragment);
 612                  mNoteEditorFragment = null;
 613                  ft.commitAllowingStateLoss();
 614                  fm.executePendingTransactions();
 615                  invalidateOptionsMenu();
 616              }
 617          }
 618      }
 619  
 620      public void showDetailPlaceholder() {
 621          if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 622              mCurrentNote = null;
 623              invalidateOptionsMenu();
 624              mNoteEditorFragment.setPlaceholderVisible(true);
 625          }
 626      }
 627  
 628      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 629  
 630          @Override
 631          protected Void doInBackground(Void... voids) {
 632              Simplenote application = (Simplenote) getApplication();
 633              Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 634              Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 635              Bucket.ObjectCursor c = query.execute();
 636              while (c.moveToNext()) {
 637                  c.getObject().delete();
 638              }
 639              return null;
 640          }
 641      }
 642  
 643  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            