<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>239</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    239
                    <a href="238.html">prev</a>
                    <a href="240.html">next</a>
                    <a href="239_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_bd01ec244a4deb5017acbb8fcaa766701c0c8cac_core/broadleaf-profile/src/main/java/org/broadleafcommerce/profile/core/dao/CustomerAddressDaoImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;bd01ec244a4deb5017acbb8fcaa766701c0c8cac:core/broadleaf-profile/src/main/java/org/broadleafcommerce/profile/core/dao/CustomerAddressDaoImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;bd01ec244a4deb5017acbb8fcaa766701c0c8cac^1:core/broadleaf-profile/src/main/java/org/broadleafcommerce/profile/core/dao/CustomerAddressDaoImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;bd01ec244a4deb5017acbb8fcaa766701c0c8cac^2:core/broadleaf-profile/src/main/java/org/broadleafcommerce/profile/core/dao/CustomerAddressDaoImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;27fb8aeb76208048099aab14c546c94639b2a4ef:core/broadleaf-profile/src/main/java/org/broadleafcommerce/profile/core/dao/CustomerAddressDaoImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Profile
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.profile.core.dao;
  19 
  20 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  21 import org.broadleafcommerce.profile.core.domain.CustomerAddress;
  22 import org.broadleafcommerce.profile.core.domain.CustomerAddressImpl;
  23 import org.hibernate.jpa.QueryHints;
  24 import org.springframework.stereotype.Repository;
  25 
  26 import java.util.ArrayList;
  27 import java.util.List;
  28 
  29 import javax.annotation.Resource;
  30 import javax.persistence.EntityManager;
  31 import javax.persistence.PersistenceContext;
  32 import javax.persistence.Query;
  33 import javax.persistence.TypedQuery;
  34 import javax.persistence.criteria.CriteriaBuilder;
  35 import javax.persistence.criteria.CriteriaQuery;
  36 import javax.persistence.criteria.Predicate;
  37 import javax.persistence.criteria.Root;
  38 
  39 @Repository(&quot;blCustomerAddressDao&quot;)
  40 public class CustomerAddressDaoImpl implements CustomerAddressDao {
  41 
  42     @PersistenceContext(unitName = &quot;blPU&quot;)
  43     protected EntityManager em;
  44 
  45     @Resource(name = &quot;blEntityConfiguration&quot;)
  46     protected EntityConfiguration entityConfiguration;
  47 
  48     @Override
  49     @SuppressWarnings(&quot;unchecked&quot;)
  50     public List&lt;CustomerAddress&gt; readActiveCustomerAddressesByCustomerId(Long customerId) {
  51         Query query = em.createNamedQuery(&quot;BC_READ_ACTIVE_CUSTOMER_ADDRESSES_BY_CUSTOMER_ID&quot;);
  52         query.setParameter(&quot;customerId&quot;, customerId);
  53         query.setParameter(&quot;archived&quot;, &#x27;N&#x27;);
  54         return query.getResultList();
  55     }
  56 
  57     @Override
  58     public CustomerAddress save(CustomerAddress customerAddress) {
  59             return em.merge(customerAddress);
  60     }
  61 
  62     @Override
  63     public CustomerAddress create() {
<abbr title="  64         return (CustomerAddress) entityConfiguration.createEntityInstance(CustomerAddress.class.getName());">  64         return (CustomerAddress) entityConfiguration.createEntityInstance(CustomerAddress.class.getName()ðŸ”µ</abbr>
  65     }
  66 
  67     @Override
  68     public List&lt;CustomerAddress&gt; readBatchCustomerAddresses(int start, int pageSize) {
  69         CriteriaBuilder builder = em.getCriteriaBuilder();
  70         CriteriaQuery&lt;CustomerAddress&gt; criteria = builder.createQuery(CustomerAddress.class);
  71         Root&lt;CustomerAddressImpl&gt; customer = criteria.from(CustomerAddressImpl.class);
  72         criteria.select(customer);
  73 
  74         TypedQuery&lt;CustomerAddress&gt; query = em.createQuery(criteria);
  75         query.setFirstResult(start);
  76         query.setMaxResults(pageSize);
  77         query.setHint(QueryHints.HINT_CACHEABLE, true);
  78         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.CustomerAddress&quot;);
  79 
  80         return query.getResultList();
  81     }
  82 
  83 
  84     @Override
  85     public Long readNumberOfAddresses() {
  86         CriteriaBuilder builder = em.getCriteriaBuilder();
  87         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
  88         criteria.select(builder.count(criteria.from(CustomerAddressImpl.class)));
  89         TypedQuery&lt;Long&gt; query = em.createQuery(criteria);
  90         return query.getSingleResult();
  91     }
  92 
  93     @Override
  94     public CustomerAddress readCustomerAddressById(Long customerAddressId) {
  95         return em.find(CustomerAddressImpl.class, customerAddressId);
  96     }
  97 
  98     @Override
  99     public void makeCustomerAddressDefault(Long customerAddressId, Long customerId) {
 100         // Throws a RuntimeException if the CustomerAddress is not found
<abbr title=" 101         CustomerAddress customerAddress = readCustomerAddressByIdAndCustomerId(customerAddressId, customerId);"> 101         CustomerAddress customerAddress = readCustomerAddressByIdAndCustomerId(customerAddressId, customeðŸ”µ</abbr>
 102 
 103         if (customerAddress != null) {
 104             clearDefaultAddressForCustomer(customerId);
 105 
 106             em.refresh(customerAddress);
 107             customerAddress.getAddress().setDefault(true);
 108 
 109             save(customerAddress);
 110         }
 111     }
 112 
 113     @Override
<abbr title=" 114     public CustomerAddress readCustomerAddressByIdAndCustomerId(Long customerAddressId, Long customerId) {"> 114     public CustomerAddress readCustomerAddressByIdAndCustomerId(Long customerAddressId, Long customerId) ðŸ”µ</abbr>
 115         CriteriaBuilder builder = em.getCriteriaBuilder();
 116         CriteriaQuery&lt;CustomerAddress&gt; criteria = builder.createQuery(CustomerAddress.class);
 117         Root&lt;CustomerAddressImpl&gt; customerAddress = criteria.from(CustomerAddressImpl.class);
 118         criteria.select(customerAddress);
 119 
 120         List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();
 121         predicates.add(builder.equal(customerAddress.get(&quot;id&quot;), customerAddressId));
 122         predicates.add(builder.equal(customerAddress.get(&quot;customer&quot;).get(&quot;id&quot;), customerId));
 123 
 124         criteria.where(builder.and(predicates.toArray(new Predicate[predicates.size()])));
 125         TypedQuery&lt;CustomerAddress&gt; query = em.createQuery(criteria);
 126         query.setHint(QueryHints.HINT_CACHEABLE, true);
 127         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.CustomerAddress&quot;);
 128 
 129         return query.getSingleResult();
 130     }
 131 
 132     @SuppressWarnings(&quot;unchecked&quot;)
 133     protected void clearDefaultAddressForCustomer(Long customerId) {
<abbr title=" 134         // This has to be done in two queries because MySQL doesn&#x27;t support updates on a table with a subquery on the same table"> 134         // This has to be done in two queries because MySQL doesn&#x27;t support updates on a table with a subðŸ”µ</abbr>
 135         Query query = em.createNamedQuery(&quot;BC_READ_DEFAULT_ADDRESS_IDS_BY_CUSTOMER_ID&quot;);
 136         query.setParameter(&quot;customerId&quot;, customerId);
 137         List&lt;Long&gt; addressIds = query.getResultList();
 138         Query update = em.createNamedQuery(&quot;BC_CLEAR_DEFAULT_ADDRESS_BY_IDS&quot;);
 139         update.setParameter(&quot;addressIds&quot;, addressIds);
 140         update.executeUpdate();
 141     }
 142 
 143     @Override
 144     public void deleteCustomerAddressById(Long customerAddressId) {
 145         CustomerAddress customerAddress = readCustomerAddressById(customerAddressId);
 146         if (customerAddress != null) {
 147             em.remove(customerAddress);
 148         }
 149     }
 150 
 151 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 152 ||||||| GitAnalyzerPlus_base
 153 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154 </span>
 155 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 156     @SuppressWarnings(&quot;unchecked&quot;)
 157     @Override
 158     public CustomerAddress findDefaultCustomerAddress(Long customerId) {
 159         Query query = em.createNamedQuery(&quot;BC_FIND_DEFAULT_ADDRESS_BY_CUSTOMER_ID&quot;);
 160         query.setParameter(&quot;customerId&quot;, customerId);
 161         List&lt;CustomerAddress&gt; customerAddresses = query.getResultList();
 162         return customerAddresses.isEmpty() ? null : customerAddresses.get(0);
 163     }
 164 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Profile
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.profile.core.dao;
  19 
  20 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  21 import org.broadleafcommerce.profile.core.domain.CustomerAddress;
  22 import org.broadleafcommerce.profile.core.domain.CustomerAddressImpl;
  23 import org.hibernate.jpa.QueryHints;
  24 import org.springframework.stereotype.Repository;
  25 
  26 import java.util.ArrayList;
  27 import java.util.List;
  28 
  29 import javax.annotation.Resource;
  30 import javax.persistence.EntityManager;
  31 import javax.persistence.PersistenceContext;
  32 import javax.persistence.Query;
  33 import javax.persistence.TypedQuery;
  34 import javax.persistence.criteria.CriteriaBuilder;
  35 import javax.persistence.criteria.CriteriaQuery;
  36 import javax.persistence.criteria.Predicate;
  37 import javax.persistence.criteria.Root;
  38 
  39 @Repository(&quot;blCustomerAddressDao&quot;)
  40 public class CustomerAddressDaoImpl implements CustomerAddressDao {
  41 
  42     @PersistenceContext(unitName = &quot;blPU&quot;)
  43     protected EntityManager em;
  44 
  45     @Resource(name = &quot;blEntityConfiguration&quot;)
  46     protected EntityConfiguration entityConfiguration;
  47 
  48     @Override
  49     @SuppressWarnings(&quot;unchecked&quot;)
  50     public List&lt;CustomerAddress&gt; readActiveCustomerAddressesByCustomerId(Long customerId) {
  51         Query query = em.createNamedQuery(&quot;BC_READ_ACTIVE_CUSTOMER_ADDRESSES_BY_CUSTOMER_ID&quot;);
  52         query.setParameter(&quot;customerId&quot;, customerId);
  53         query.setParameter(&quot;archived&quot;, &#x27;N&#x27;);
  54         return query.getResultList();
  55     }
  56 
  57     @Override
  58     public CustomerAddress save(CustomerAddress customerAddress) {
  59             return em.merge(customerAddress);
  60     }
  61 
  62     @Override
  63     public CustomerAddress create() {
<abbr title="  64         return (CustomerAddress) entityConfiguration.createEntityInstance(CustomerAddress.class.getName());">  64         return (CustomerAddress) entityConfiguration.createEntityInstance(CustomerAddress.class.getName()ðŸ”µ</abbr>
  65     }
  66 
  67     @Override
  68     public List&lt;CustomerAddress&gt; readBatchCustomerAddresses(int start, int pageSize) {
  69         CriteriaBuilder builder = em.getCriteriaBuilder();
  70         CriteriaQuery&lt;CustomerAddress&gt; criteria = builder.createQuery(CustomerAddress.class);
  71         Root&lt;CustomerAddressImpl&gt; customer = criteria.from(CustomerAddressImpl.class);
  72         criteria.select(customer);
  73 
  74         TypedQuery&lt;CustomerAddress&gt; query = em.createQuery(criteria);
  75         query.setFirstResult(start);
  76         query.setMaxResults(pageSize);
  77         query.setHint(QueryHints.HINT_CACHEABLE, true);
  78         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.CustomerAddress&quot;);
  79 
  80         return query.getResultList();
  81     }
  82 
  83 
  84     @Override
  85     public Long readNumberOfAddresses() {
  86         CriteriaBuilder builder = em.getCriteriaBuilder();
  87         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
  88         criteria.select(builder.count(criteria.from(CustomerAddressImpl.class)));
  89         TypedQuery&lt;Long&gt; query = em.createQuery(criteria);
  90         return query.getSingleResult();
  91     }
  92 
  93     @Override
  94     public CustomerAddress readCustomerAddressById(Long customerAddressId) {
  95         return em.find(CustomerAddressImpl.class, customerAddressId);
  96     }
  97 
  98     @Override
  99     public void makeCustomerAddressDefault(Long customerAddressId, Long customerId) {
 100         // Throws a RuntimeException if the CustomerAddress is not found
<abbr title=" 101         CustomerAddress customerAddress = readCustomerAddressByIdAndCustomerId(customerAddressId, customerId);"> 101         CustomerAddress customerAddress = readCustomerAddressByIdAndCustomerId(customerAddressId, customeðŸ”µ</abbr>
 102 
 103         if (customerAddress != null) {
 104             clearDefaultAddressForCustomer(customerId);
 105 
 106             em.refresh(customerAddress);
 107             customerAddress.getAddress().setDefault(true);
 108 
 109             save(customerAddress);
 110         }
 111     }
 112 
 113     @Override
<abbr title=" 114     public CustomerAddress readCustomerAddressByIdAndCustomerId(Long customerAddressId, Long customerId) {"> 114     public CustomerAddress readCustomerAddressByIdAndCustomerId(Long customerAddressId, Long customerId) ðŸ”µ</abbr>
 115         CriteriaBuilder builder = em.getCriteriaBuilder();
 116         CriteriaQuery&lt;CustomerAddress&gt; criteria = builder.createQuery(CustomerAddress.class);
 117         Root&lt;CustomerAddressImpl&gt; customerAddress = criteria.from(CustomerAddressImpl.class);
 118         criteria.select(customerAddress);
 119 
 120         List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();
 121         predicates.add(builder.equal(customerAddress.get(&quot;id&quot;), customerAddressId));
 122         predicates.add(builder.equal(customerAddress.get(&quot;customer&quot;).get(&quot;id&quot;), customerId));
 123 
 124         criteria.where(builder.and(predicates.toArray(new Predicate[predicates.size()])));
 125         TypedQuery&lt;CustomerAddress&gt; query = em.createQuery(criteria);
 126         query.setHint(QueryHints.HINT_CACHEABLE, true);
 127         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.CustomerAddress&quot;);
 128 
 129         return query.getSingleResult();
 130     }
 131 
 132     @SuppressWarnings(&quot;unchecked&quot;)
 133     protected void clearDefaultAddressForCustomer(Long customerId) {
<abbr title=" 134         // This has to be done in two queries because MySQL doesn&#x27;t support updates on a table with a subquery on the same table"> 134         // This has to be done in two queries because MySQL doesn&#x27;t support updates on a table with a subðŸ”µ</abbr>
 135         Query query = em.createNamedQuery(&quot;BC_READ_DEFAULT_ADDRESS_IDS_BY_CUSTOMER_ID&quot;);
 136         query.setParameter(&quot;customerId&quot;, customerId);
 137         List&lt;Long&gt; addressIds = query.getResultList();
 138         Query update = em.createNamedQuery(&quot;BC_CLEAR_DEFAULT_ADDRESS_BY_IDS&quot;);
 139         update.setParameter(&quot;addressIds&quot;, addressIds);
 140         update.executeUpdate();
 141     }
 142 
 143     @Override
 144     public void deleteCustomerAddressById(Long customerAddressId) {
 145         CustomerAddress customerAddress = readCustomerAddressById(customerAddressId);
 146         if (customerAddress != null) {
 147             em.remove(customerAddress);
 148         }
 149     }
 150 
 151     @SuppressWarnings(&quot;unchecked&quot;)
 152     @Override
 153     public CustomerAddress findDefaultCustomerAddress(Long customerId) {
 154         Query query = em.createNamedQuery(&quot;BC_FIND_DEFAULT_ADDRESS_BY_CUSTOMER_ID&quot;);
 155         query.setParameter(&quot;customerId&quot;, customerId);
 156         List&lt;CustomerAddress&gt; customerAddresses = query.getResultList();
 157         return customerAddresses.isEmpty() ? null : customerAddresses.get(0);
 158     }
 159 }
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Profile
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.profile.core.dao;
  19 
  20 import java.util.ArrayList;
  21 import java.util.List;
  22 import javax.annotation.Resource;
  23 import javax.persistence.EntityManager;
  24 import javax.persistence.PersistenceContext;
  25 import javax.persistence.Query;
  26 import javax.persistence.TypedQuery;
  27 import javax.persistence.criteria.CriteriaBuilder;
  28 import javax.persistence.criteria.CriteriaQuery;
  29 import javax.persistence.criteria.Predicate;
  30 import javax.persistence.criteria.Root;
  31 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  32 import org.broadleafcommerce.profile.core.domain.CustomerAddress;
  33 import org.broadleafcommerce.profile.core.domain.CustomerAddressImpl;
  34 import org.hibernate.jpa.QueryHints;
  35 import org.springframework.stereotype.Repository;
  36 
  37 
  38 @Repository(&quot;blCustomerAddressDao&quot;)
  39 public class CustomerAddressDaoImpl implements CustomerAddressDao {
  40     @PersistenceContext(unitName = &quot;blPU&quot;)
  41     protected EntityManager em;
  42 
  43     @Resource(name = &quot;blEntityConfiguration&quot;)
  44     protected EntityConfiguration entityConfiguration;
  45 
  46     @Override
  47     @SuppressWarnings(&quot;unchecked&quot;)
  48     public List&lt;CustomerAddress&gt; readActiveCustomerAddressesByCustomerId(Long customerId) {
  49         Query query = em.createNamedQuery(&quot;BC_READ_ACTIVE_CUSTOMER_ADDRESSES_BY_CUSTOMER_ID&quot;);
  50         query.setParameter(&quot;customerId&quot;, customerId);
  51         query.setParameter(&quot;archived&quot;, &#x27;N&#x27;);
  52         return query.getResultList();
  53     }
  54 
  55     @Override
  56     public CustomerAddress save(CustomerAddress customerAddress) {
  57             return em.merge(customerAddress);
  58     }
  59 
  60     @Override
  61     public CustomerAddress create() {
<abbr title="  62         return (CustomerAddress) entityConfiguration.createEntityInstance(CustomerAddress.class.getName());">  62         return (CustomerAddress) entityConfiguration.createEntityInstance(CustomerAddress.class.getName()ðŸ”µ</abbr>
  63     }
  64 
  65     @Override
  66     public List&lt;CustomerAddress&gt; readBatchCustomerAddresses(int start, int pageSize) {
  67         CriteriaBuilder builder = em.getCriteriaBuilder();
  68         CriteriaQuery&lt;CustomerAddress&gt; criteria = builder.createQuery(CustomerAddress.class);
  69         Root&lt;CustomerAddressImpl&gt; customer = criteria.from(CustomerAddressImpl.class);
  70         criteria.select(customer);
  71 
  72         TypedQuery&lt;CustomerAddress&gt; query = em.createQuery(criteria);
  73         query.setFirstResult(start);
  74         query.setMaxResults(pageSize);
  75         query.setHint(QueryHints.HINT_CACHEABLE, true);
  76         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.CustomerAddress&quot;);
  77 
  78         return query.getResultList();
  79     }
  80 
  81     @Override
  82     public Long readNumberOfAddresses() {
  83         CriteriaBuilder builder = em.getCriteriaBuilder();
  84         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
  85         criteria.select(builder.count(criteria.from(CustomerAddressImpl.class)));
  86         TypedQuery&lt;Long&gt; query = em.createQuery(criteria);
  87         return query.getSingleResult();
  88     }
  89 
  90     @Override
  91     public CustomerAddress readCustomerAddressById(Long customerAddressId) {
  92         return em.find(CustomerAddressImpl.class, customerAddressId);
  93     }
  94 
  95     @Override
  96     public void makeCustomerAddressDefault(Long customerAddressId, Long customerId) {
  97         // Throws a RuntimeException if the CustomerAddress is not found
<abbr title="  98         CustomerAddress customerAddress = readCustomerAddressByIdAndCustomerId(customerAddressId, customerId);">  98         CustomerAddress customerAddress = readCustomerAddressByIdAndCustomerId(customerAddressId, customeðŸ”µ</abbr>
  99         if (customerAddress != null) {
 100             clearDefaultAddressForCustomer(customerId);
 101             em.refresh(customerAddress);
 102             customerAddress.getAddress().setDefault(true);
 103             save(customerAddress);
 104         }
 105     }
 106 
 107     @Override
<abbr title=" 108     public CustomerAddress readCustomerAddressByIdAndCustomerId(Long customerAddressId, Long customerId) {"> 108     public CustomerAddress readCustomerAddressByIdAndCustomerId(Long customerAddressId, Long customerId) ðŸ”µ</abbr>
 109         CriteriaBuilder builder = em.getCriteriaBuilder();
 110         CriteriaQuery&lt;CustomerAddress&gt; criteria = builder.createQuery(CustomerAddress.class);
 111         Root&lt;CustomerAddressImpl&gt; customerAddress = criteria.from(CustomerAddressImpl.class);
 112         criteria.select(customerAddress);
 113         List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();
 114         predicates.add(builder.equal(customerAddress.get(&quot;id&quot;), customerAddressId));
 115         predicates.add(builder.equal(customerAddress.get(&quot;customer&quot;).get(&quot;id&quot;), customerId));
 116         criteria.where(builder.and(predicates.toArray(new Predicate[predicates.size()])));
 117         TypedQuery&lt;CustomerAddress&gt; query = em.createQuery(criteria);
 118         query.setHint(QueryHints.HINT_CACHEABLE, true);
 119         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.CustomerAddress&quot;);
 120         return query.getSingleResult();
 121     }
 122 
 123     @SuppressWarnings(&quot;unchecked&quot;)
 124     protected void clearDefaultAddressForCustomer(Long customerId) {
<abbr title=" 125         // This has to be done in two queries because MySQL doesn&#x27;t support updates on a table with a subquery on the same table"> 125         // This has to be done in two queries because MySQL doesn&#x27;t support updates on a table with a subðŸ”µ</abbr>
 126         Query query = em.createNamedQuery(&quot;BC_READ_DEFAULT_ADDRESS_IDS_BY_CUSTOMER_ID&quot;);
 127         query.setParameter(&quot;customerId&quot;, customerId);
 128         List&lt;Long&gt; addressIds = query.getResultList();
 129         Query update = em.createNamedQuery(&quot;BC_CLEAR_DEFAULT_ADDRESS_BY_IDS&quot;);
 130         update.setParameter(&quot;addressIds&quot;, addressIds);
 131         update.executeUpdate();
 132     }
 133 
 134     @Override
 135     public void deleteCustomerAddressById(Long customerAddressId) {
 136         CustomerAddress customerAddress = readCustomerAddressById(customerAddressId);
 137         if (customerAddress != null) {
 138             em.remove(customerAddress);
 139         }
 140     }
 141 
 142     @SuppressWarnings(&quot;unchecked&quot;)
 143     @Override
 144     public CustomerAddress findDefaultCustomerAddress(Long customerId) {
 145         Query query = em.createNamedQuery(&quot;BC_FIND_DEFAULT_ADDRESS_BY_CUSTOMER_ID&quot;);
 146         query.setParameter(&quot;customerId&quot;, customerId);
 147         List&lt;CustomerAddress&gt; customerAddresses = query.getResultList();
 148         return customerAddresses.isEmpty() ? null : customerAddresses.get(0);
 149     }
 150 }
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Profile
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.profile.core.dao;
  19  
  20  import org.broadleafcommerce.common.persistence.EntityConfiguration;
  21  import org.broadleafcommerce.profile.core.domain.CustomerAddress;
  22  import org.broadleafcommerce.profile.core.domain.CustomerAddressImpl;
  23  import org.hibernate.jpa.QueryHints;
  24  import org.springframework.stereotype.Repository;
  25  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import java.util.ArrayList;</span>
  27  import java.util.List;
  28  
  29  import javax.annotation.Resource;
  30  import javax.persistence.EntityManager;
  31  import javax.persistence.PersistenceContext;
  32  import javax.persistence.Query;
  33  import javax.persistence.TypedQuery;
  34  import javax.persistence.criteria.CriteriaBuilder;
  35  import javax.persistence.criteria.CriteriaQuery;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import javax.persistence.criteria.Predicate;</span>
  37  import javax.persistence.criteria.Root;
  38  
  39  @Repository(&quot;blCustomerAddressDao&quot;)
  40  public class CustomerAddressDaoImpl implements CustomerAddressDao {
  41  
  42      @PersistenceContext(unitName = &quot;blPU&quot;)
  43      protected EntityManager em;
  44  
  45      @Resource(name = &quot;blEntityConfiguration&quot;)
  46      protected EntityConfiguration entityConfiguration;
  47  
  48      @Override
  49      @SuppressWarnings(&quot;unchecked&quot;)
  50      public List&lt;CustomerAddress&gt; readActiveCustomerAddressesByCustomerId(Long customerId) {
  51          Query query = em.createNamedQuery(&quot;BC_READ_ACTIVE_CUSTOMER_ADDRESSES_BY_CUSTOMER_ID&quot;);
  52          query.setParameter(&quot;customerId&quot;, customerId);
  53          query.setParameter(&quot;archived&quot;, &#x27;N&#x27;);
  54          return query.getResultList();
  55      }
  56  
  57      @Override
  58      public CustomerAddress save(CustomerAddress customerAddress) {
  59              return em.merge(customerAddress);
  60      }
  61  
  62      @Override
  63      public CustomerAddress create() {
  64          return (CustomerAddress) entityConfiguration.createEntityInstance(CustomerAddress.class.getName());
  65      }
  66  
  67      @Override
  68      public List&lt;CustomerAddress&gt; readBatchCustomerAddresses(int start, int pageSize) {
  69          CriteriaBuilder builder = em.getCriteriaBuilder();
  70          CriteriaQuery&lt;CustomerAddress&gt; criteria = builder.createQuery(CustomerAddress.class);
  71          Root&lt;CustomerAddressImpl&gt; customer = criteria.from(CustomerAddressImpl.class);
  72          criteria.select(customer);
  73  
  74          TypedQuery&lt;CustomerAddress&gt; query = em.createQuery(criteria);
  75          query.setFirstResult(start);
  76          query.setMaxResults(pageSize);
  77          query.setHint(QueryHints.HINT_CACHEABLE, true);
  78          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.CustomerAddress&quot;);
  79  
  80          return query.getResultList();
  81      }
  82  
  83  
  84      @Override
  85      public Long readNumberOfAddresses() {
  86          CriteriaBuilder builder = em.getCriteriaBuilder();
  87          CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
  88          criteria.select(builder.count(criteria.from(CustomerAddressImpl.class)));
  89          TypedQuery&lt;Long&gt; query = em.createQuery(criteria);
  90          return query.getSingleResult();
  91      }
  92  
  93      @Override
  94      public CustomerAddress readCustomerAddressById(Long customerAddressId) {
  95          return em.find(CustomerAddressImpl.class, customerAddressId);
  96      }
  97  
  98      @Override
  99      public void makeCustomerAddressDefault(Long customerAddressId, Long customerId) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -        List&lt;CustomerAddress&gt; customerAddresses = readActiveCustomerAddressesByCustomerId(customerId);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -        for (CustomerAddress customerAddress : customerAddresses) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -            customerAddress.getAddress().setDefault(customerAddress.getId().equals(customerAddressId));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -            em.merge(customerAddress);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        // Throws a RuntimeException if the CustomerAddress is not found</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +        CustomerAddress customerAddress = readCustomerAddressByIdAndCustomerId(customerAddressId, customerId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +        if (customerAddress != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +            clearDefaultAddressForCustomer(customerId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +            em.refresh(customerAddress);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +            customerAddress.getAddress().setDefault(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +            save(customerAddress);</span>
 114          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +    public CustomerAddress readCustomerAddressByIdAndCustomerId(Long customerAddressId, Long customerId) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        CriteriaBuilder builder = em.getCriteriaBuilder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +        CriteriaQuery&lt;CustomerAddress&gt; criteria = builder.createQuery(CustomerAddress.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +        Root&lt;CustomerAddressImpl&gt; customerAddress = criteria.from(CustomerAddressImpl.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +        criteria.select(customerAddress);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +        List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +        predicates.add(builder.equal(customerAddress.get(&quot;id&quot;), customerAddressId));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        predicates.add(builder.equal(customerAddress.get(&quot;customer&quot;).get(&quot;id&quot;), customerId));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +        criteria.where(builder.and(predicates.toArray(new Predicate[predicates.size()])));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        TypedQuery&lt;CustomerAddress&gt; query = em.createQuery(criteria);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +        query.setHint(QueryHints.HINT_CACHEABLE, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.CustomerAddress&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +        return query.getSingleResult();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +    @SuppressWarnings(&quot;unchecked&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +    protected void clearDefaultAddressForCustomer(Long customerId) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 138 +        // This has to be done in two queries because MySQL doesn&#x27;t support updates on a table with a subquery on the same table"> 138 +        // This has to be done in two queries because MySQL doesn&#x27;t support updates on a table with a subquery on ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +        Query query = em.createNamedQuery(&quot;BC_READ_DEFAULT_ADDRESS_IDS_BY_CUSTOMER_ID&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +        query.setParameter(&quot;customerId&quot;, customerId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +        List&lt;Long&gt; addressIds = query.getResultList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +        Query update = em.createNamedQuery(&quot;BC_CLEAR_DEFAULT_ADDRESS_BY_IDS&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +        update.setParameter(&quot;addressIds&quot;, addressIds);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +        update.executeUpdate();</span>
 145      }
 146  
 147      @Override
 148      public void deleteCustomerAddressById(Long customerAddressId) {
 149          CustomerAddress customerAddress = readCustomerAddressById(customerAddressId);
 150          if (customerAddress != null) {
 151              em.remove(customerAddress);
 152          }
 153      }
 154  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +    @SuppressWarnings(&quot;unchecked&quot;)</span>

 156      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -    @SuppressWarnings(&quot;unchecked&quot;)</span>
 158      public CustomerAddress findDefaultCustomerAddress(Long customerId) {
 159          Query query = em.createNamedQuery(&quot;BC_FIND_DEFAULT_ADDRESS_BY_CUSTOMER_ID&quot;);
 160          query.setParameter(&quot;customerId&quot;, customerId);
 161          List&lt;CustomerAddress&gt; customerAddresses = query.getResultList();
 162          return customerAddresses.isEmpty() ? null : customerAddresses.get(0);
 163      }
 164  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Profile
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.profile.core.dao;
  19  
  20  import org.broadleafcommerce.common.persistence.EntityConfiguration;
  21  import org.broadleafcommerce.profile.core.domain.CustomerAddress;
  22  import org.broadleafcommerce.profile.core.domain.CustomerAddressImpl;
  23  import org.hibernate.jpa.QueryHints;
  24  import org.springframework.stereotype.Repository;
  25  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import java.util.ArrayList;</span>
  27  import java.util.List;
  28  
  29  import javax.annotation.Resource;
  30  import javax.persistence.EntityManager;
  31  import javax.persistence.PersistenceContext;
  32  import javax.persistence.Query;
  33  import javax.persistence.TypedQuery;
  34  import javax.persistence.criteria.CriteriaBuilder;
  35  import javax.persistence.criteria.CriteriaQuery;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import javax.persistence.criteria.Predicate;</span>
  37  import javax.persistence.criteria.Root;
  38  
  39  @Repository(&quot;blCustomerAddressDao&quot;)
  40  public class CustomerAddressDaoImpl implements CustomerAddressDao {
  41  
  42      @PersistenceContext(unitName = &quot;blPU&quot;)
  43      protected EntityManager em;
  44  
  45      @Resource(name = &quot;blEntityConfiguration&quot;)
  46      protected EntityConfiguration entityConfiguration;
  47  
  48      @Override
  49      @SuppressWarnings(&quot;unchecked&quot;)
  50      public List&lt;CustomerAddress&gt; readActiveCustomerAddressesByCustomerId(Long customerId) {
  51          Query query = em.createNamedQuery(&quot;BC_READ_ACTIVE_CUSTOMER_ADDRESSES_BY_CUSTOMER_ID&quot;);
  52          query.setParameter(&quot;customerId&quot;, customerId);
  53          query.setParameter(&quot;archived&quot;, &#x27;N&#x27;);
  54          return query.getResultList();
  55      }
  56  
  57      @Override
  58      public CustomerAddress save(CustomerAddress customerAddress) {
  59              return em.merge(customerAddress);
  60      }
  61  
  62      @Override
  63      public CustomerAddress create() {
  64          return (CustomerAddress) entityConfiguration.createEntityInstance(CustomerAddress.class.getName());
  65      }
  66  
  67      @Override
  68      public List&lt;CustomerAddress&gt; readBatchCustomerAddresses(int start, int pageSize) {
  69          CriteriaBuilder builder = em.getCriteriaBuilder();
  70          CriteriaQuery&lt;CustomerAddress&gt; criteria = builder.createQuery(CustomerAddress.class);
  71          Root&lt;CustomerAddressImpl&gt; customer = criteria.from(CustomerAddressImpl.class);
  72          criteria.select(customer);
  73  
  74          TypedQuery&lt;CustomerAddress&gt; query = em.createQuery(criteria);
  75          query.setFirstResult(start);
  76          query.setMaxResults(pageSize);
  77          query.setHint(QueryHints.HINT_CACHEABLE, true);
  78          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.CustomerAddress&quot;);
  79  
  80          return query.getResultList();
  81      }
  82  
  83  
  84      @Override
  85      public Long readNumberOfAddresses() {
  86          CriteriaBuilder builder = em.getCriteriaBuilder();
  87          CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
  88          criteria.select(builder.count(criteria.from(CustomerAddressImpl.class)));
  89          TypedQuery&lt;Long&gt; query = em.createQuery(criteria);
  90          return query.getSingleResult();
  91      }
  92  
  93      @Override
  94      public CustomerAddress readCustomerAddressById(Long customerAddressId) {
  95          return em.find(CustomerAddressImpl.class, customerAddressId);
  96      }
  97  
  98      @Override
  99      public void makeCustomerAddressDefault(Long customerAddressId, Long customerId) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -        List&lt;CustomerAddress&gt; customerAddresses = readActiveCustomerAddressesByCustomerId(customerId);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -        for (CustomerAddress customerAddress : customerAddresses) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -            customerAddress.getAddress().setDefault(customerAddress.getId().equals(customerAddressId));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -            em.merge(customerAddress);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        // Throws a RuntimeException if the CustomerAddress is not found</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +        CustomerAddress customerAddress = readCustomerAddressByIdAndCustomerId(customerAddressId, customerId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +        if (customerAddress != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +            clearDefaultAddressForCustomer(customerId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +            em.refresh(customerAddress);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +            customerAddress.getAddress().setDefault(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +            save(customerAddress);</span>
 114          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +    public CustomerAddress readCustomerAddressByIdAndCustomerId(Long customerAddressId, Long customerId) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        CriteriaBuilder builder = em.getCriteriaBuilder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +        CriteriaQuery&lt;CustomerAddress&gt; criteria = builder.createQuery(CustomerAddress.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +        Root&lt;CustomerAddressImpl&gt; customerAddress = criteria.from(CustomerAddressImpl.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +        criteria.select(customerAddress);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +        List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +        predicates.add(builder.equal(customerAddress.get(&quot;id&quot;), customerAddressId));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        predicates.add(builder.equal(customerAddress.get(&quot;customer&quot;).get(&quot;id&quot;), customerId));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +        criteria.where(builder.and(predicates.toArray(new Predicate[predicates.size()])));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        TypedQuery&lt;CustomerAddress&gt; query = em.createQuery(criteria);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +        query.setHint(QueryHints.HINT_CACHEABLE, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.CustomerAddress&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +        return query.getSingleResult();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +    @SuppressWarnings(&quot;unchecked&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +    protected void clearDefaultAddressForCustomer(Long customerId) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 138 +        // This has to be done in two queries because MySQL doesn&#x27;t support updates on a table with a subquery on the same table"> 138 +        // This has to be done in two queries because MySQL doesn&#x27;t support updates on a table with a subquery on ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +        Query query = em.createNamedQuery(&quot;BC_READ_DEFAULT_ADDRESS_IDS_BY_CUSTOMER_ID&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +        query.setParameter(&quot;customerId&quot;, customerId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +        List&lt;Long&gt; addressIds = query.getResultList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +        Query update = em.createNamedQuery(&quot;BC_CLEAR_DEFAULT_ADDRESS_BY_IDS&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +        update.setParameter(&quot;addressIds&quot;, addressIds);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +        update.executeUpdate();</span>
 145      }
 146  
 147      @Override
 148      public void deleteCustomerAddressById(Long customerAddressId) {
 149          CustomerAddress customerAddress = readCustomerAddressById(customerAddressId);
 150          if (customerAddress != null) {
 151              em.remove(customerAddress);
 152          }
 153      }
 154  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +    @SuppressWarnings(&quot;unchecked&quot;)</span>
 157      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -    @SuppressWarnings(&quot;unchecked&quot;)</span>
 159      public CustomerAddress findDefaultCustomerAddress(Long customerId) {
 160          Query query = em.createNamedQuery(&quot;BC_FIND_DEFAULT_ADDRESS_BY_CUSTOMER_ID&quot;);
 161          query.setParameter(&quot;customerId&quot;, customerId);
 162          List&lt;CustomerAddress&gt; customerAddresses = query.getResultList();
 163          return customerAddresses.isEmpty() ? null : customerAddresses.get(0);
 164      }
 165  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            