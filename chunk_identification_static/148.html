<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>148</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    148
                    <a href="147.html">prev</a>
                    <a href="149.html">next</a>
                    <a href="148_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_68d0a170f9399845027214d6e8e6e30c591900dd_core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;68d0a170f9399845027214d6e8e6e30c591900dd:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;68d0a170f9399845027214d6e8e6e30c591900dd^1:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;68d0a170f9399845027214d6e8e6e30c591900dd^2:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;3a313f224612dac7bdcaf4abaf4b36d05d83b1ae:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [s]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.controller.checkout;
  19 
  20 import org.apache.commons.logging.Log;
  21 import org.apache.commons.logging.LogFactory;
  22 import org.broadleafcommerce.common.exception.ServiceException;
  23 import org.broadleafcommerce.common.payment.PaymentGatewayType;
  24 import org.broadleafcommerce.common.payment.PaymentTransactionType;
  25 import org.broadleafcommerce.common.payment.PaymentType;
  26 import org.broadleafcommerce.common.vendor.service.exception.PaymentException;
  27 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  28 import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;
  29 import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;
  30 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  31 import org.broadleafcommerce.core.offer.service.exception.OfferExpiredException;
  32 import org.broadleafcommerce.core.offer.service.exception.OfferMaxUseExceededException;
  33 import org.broadleafcommerce.core.order.domain.NullOrderImpl;
  34 import org.broadleafcommerce.core.order.domain.Order;
  35 import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;
  36 import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  37 import org.broadleafcommerce.core.payment.domain.OrderPayment;
  38 import org.broadleafcommerce.core.payment.domain.PaymentTransaction;
  39 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  40 import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;
  41 import org.broadleafcommerce.core.web.order.CartState;
  42 import org.broadleafcommerce.profile.web.core.CustomerState;
  43 import org.springframework.ui.Model;
  44 import org.springframework.validation.BindingResult;
  45 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  46 
  47 import java.util.ArrayList;
  48 import java.util.List;
  49 
  50 import javax.servlet.http.HttpServletRequest;
  51 import javax.servlet.http.HttpServletResponse;
  52 
  53 /**
  54  * In charge of performing the various checkout operations
  55  * 
  56  * @author Andre Azzolini (apazzolini)
  57  * @author Elbert Bautista (elbertbautista)
  58  * @author Joshua Skorton (jskorton)
  59  */
  60 public class BroadleafCheckoutController extends AbstractCheckoutController {
  61 
  62     private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);
  63     protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;
  64 
  65     /**
  66      * Renders the default checkout page and allows modules to add variables to the model.
  67      *
  68      * @param request
  69      * @param response
  70      * @param model
  71      * @param model
  72      * @return the checkout view path
  73      */
  74     public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,
  75             RedirectAttributes redirectAttributes) {
  76         preValidateCartOperation(model);
  77         populateModelWithReferenceData(request, model);
  78 
  79         return getCheckoutView();
  80     }
  81 
  82     protected void preValidateCartOperation(Model model) {
  83         try {
  84             Order cart = CartState.getCart();
  85             orderService.preValidateCartOperation(cart);
  86         } catch (IllegalCartOperationException ex) {
  87             model.addAttribute(&quot;cartRequiresLock&quot;, true);
  88         }
  89     }
  90 
  91     /**
  92      * Renders checkout stages partial at the requested stage
  93      *
  94      * @param request
  95      * @param response
  96      * @param model
  97      * @param stage
  98      * @return the checkout stages partial path
  99      */
<abbr title=" 100     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,"> 100     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, ModelðŸ”µ</abbr>
 101             String stage, RedirectAttributes redirectAttributes) {
 102         model.addAttribute(ACTIVE_STAGE, stage);
 103         return getCheckoutStagesPartial();
 104     }
 105 
 106     /**
 107      * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously
 108      * @param request
 109      * @param model
 110      * @param orderInfoForm
 111      * @param result
 112      * @return
 113      * @throws ServiceException
 114      */
 115     public String saveGlobalOrderDetails(HttpServletRequest request, Model model, 
 116             OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {
 117         Order cart = CartState.getCart();
 118 
 119         orderInfoFormValidator.validate(orderInfoForm, result);
 120         if (result.hasErrors()) {
 121             // We need to clear the email on error in case they are trying to edit it
 122             try {
 123                 cart.setEmailAddress(null);
 124                 orderService.save(cart, false);
 125             } catch (PricingException pe) {
 126                 LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 127             }
 128             
 129             populateModelWithReferenceData(request, model);
 130             return getCheckoutView();
 131         }
 132         
 133         try {
 134             cart.setEmailAddress(orderInfoForm.getEmailAddress());
 135             orderService.save(cart, false);
 136         } catch (PricingException pe) {
 137             LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 138         }
 139         
 140         return getCheckoutPageRedirect();   
 141     }
 142 
 143     /**
 144      * Creates a pass-through payment of the PaymentType passed in with
 145      * an amount equal to the order total after any non-final applied payments.
 146      * (for example gift cards, customer credit, or third party accounts)
 147      *
 148      * This intended to be used in cases like COD and other Payment Types where implementations wish
 149      * to just checkout without having to do any payment processing.
 150      *
 151      * This default implementations assumes that the pass-through payment is the only
 152      * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED
<abbr title=" 153      * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 153      * That means that it will look at all transactions on the order payment and see if it has unconfirmeðŸ”µ</abbr>
 154      * If it does, it will not remove it.
 155      *
 156      * Make sure not to expose this method in your extended Controller if you do not wish to
 157      * have this feature enabled.
 158      *
 159      * @param redirectAttributes
 160      * @param paymentType
 161      * @return
 162      * @throws PaymentException
 163      * @throws PricingException
 164      */
 165     public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,
<abbr title=" 166                                              PaymentType paymentType) throws PaymentException, PricingException {"> 166                                              PaymentType paymentType) throws PaymentException, PricingExcðŸ”µ</abbr>
 167         Order cart = CartState.getCart();
 168 
<abbr title=" 169         //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED"> 169         //Invalidate any payments already on the order that do not have transactions on them that are UNCðŸ”µ</abbr>
 170         List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();
 171         for (OrderPayment payment : cart.getPayments()) {
 172             if (payment.isActive()) {
 173                 if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {
 174                     paymentsToInvalidate.add(payment);
 175                 } else {
 176                     for (PaymentTransaction transaction : payment.getTransactions()) {
 177                         if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {
 178                              paymentsToInvalidate.add(payment);
 179                         }
 180                     }
 181                 }
 182             }
 183         }
 184 
 185         for (OrderPayment payment : paymentsToInvalidate) {
 186             cart.getPayments().remove(payment);
 187             if (paymentGatewayCheckoutService != null) {
 188                 paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());
 189             }
 190         }
 191 
 192         //Create a new Order Payment of the passed in type
 193         OrderPayment passthroughPayment = orderPaymentService.create();
 194         passthroughPayment.setType(paymentType);
 195         passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);
 196         passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());
 197         passthroughPayment.setOrder(cart);
 198 
 199         // Create the transaction for the payment
 200         PaymentTransaction transaction = orderPaymentService.createTransaction();
 201         transaction.setAmount(cart.getTotalAfterAppliedPayments());
 202         transaction.setRawResponse(&quot;Passthrough Payment&quot;);
 203         transaction.setSuccess(true);
 204         transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);
<abbr title=" 205         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 205         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymeðŸ”µ</abbr>
 206 
 207         transaction.setOrderPayment(passthroughPayment);
 208         passthroughPayment.addTransaction(transaction);
 209         orderService.addPaymentToOrder(cart, passthroughPayment, null);
 210 
 211         orderService.save(cart, true);
 212 
 213         return processCompleteCheckoutOrderFinalized(redirectAttributes);
 214     }
 215 
 216     /**
 217      * If the order has been finalized. i.e. all the payments have been applied to the order,
 218      * then you can go ahead and call checkout using the passed in order id.
<abbr title=" 219      * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 219      * This is usually called from a Review Page or if enough Payments have been applied to the Order to ðŸ”µ</abbr>
<abbr title=" 220      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or"> 220      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway,ðŸ”µ</abbr>
<abbr title=" 221      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)"> 221      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express CheckoutðŸ”µ</abbr>
 222      *
 223      * @return
 224      * @throws Exception
 225      */
<abbr title=" 226     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 226     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throðŸ”µ</abbr>
 227         Order cart = CartState.getCart();
 228         String param = &quot;&quot;;
 229         if (cart != null &amp;&amp; !(cart instanceof NullOrderImpl)) {
 230             try {
<abbr title=" 231                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OfferServiceImpl.OFFERS_EXPIRED);"> 231                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties()ðŸ”µ</abbr>
 232                 if(o!=null &amp;&amp; (Boolean) o){
<abbr title=" 233                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was re-calculated, check order total and try again&quot;);"> 233                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order pðŸ”µ</abbr>
 234                 }
 235                 String orderNumber = initiateCheckout(cart.getId());
 236                 return getConfirmationViewRedirect(orderNumber);
 237             } catch (Exception e) {
 238                 handleProcessingException(e, redirectAttributes);
 239                 if(CustomerState.getCustomer().isAnonymous()){
 240                     param=&quot;?guest-checkout=true&quot;;
 241                 }
 242             }
 243         }
 244 
 245 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 246         return getCheckoutPageRedirect() + (CustomerState.getCustomer().isAnonymous() ? &quot;?guest-checkout=true&quot; : &quot;&quot;);"> 246         return getCheckoutPageRedirect() + (CustomerState.getCustomer().isAnonymous() ? &quot;?guest-checkout=ðŸ”µ</abbr></span>
 247 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250     public String initiateCheckout(Long orderId) throws Exception{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251         if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252             return paymentGatewayCheckoutService.initiateCheckout(orderId);</span>
 253 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254         return getCheckoutPageRedirect()+param;</span>
 255 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 256     }
 257 
 258     public String initiateCheckout(Long orderId) throws Exception{
 259         if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {
 260             return paymentGatewayCheckoutService.initiateCheckout(orderId);
 261         }
 262         return null;
 263     }
 264 
<abbr title=" 265     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 265     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymðŸ”µ</abbr>
<abbr title=" 266         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 266         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect AttribuðŸ”µ</abbr>
 267 
 268         Throwable cause = e.getCause();
 269 
 270         if (cause!= null &amp;&amp; cause.getCause() instanceof RequiredAttributeNotProvidedException) {
 271             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 272                     PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());
<abbr title=" 273         }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredException) {"> 273         }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferEðŸ”µ</abbr>
<abbr title=" 274             String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMessage();"> 274             String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() ðŸ”µ</abbr>
 275             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 276                     message);
 277         } else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferMaxUseExceededException) {
 278             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 279                     &quot;There was an error during checkout:&quot;+cause.getCause().getMessage());
 280         } else {
 281             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 282                     PaymentGatewayAbstractController.getProcessingErrorMessage());
 283         }
 284     }
 285 
 286     public String getBaseConfirmationRedirect() {
 287         return baseConfirmationRedirect;
 288     }
 289 
 290     protected String getConfirmationViewRedirect(String orderNumber) {
 291         return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;
 292     }
 293 
 294 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.controller.checkout;
  19 
  20 import org.apache.commons.logging.Log;
  21 import org.apache.commons.logging.LogFactory;
  22 import org.broadleafcommerce.common.exception.ServiceException;
  23 import org.broadleafcommerce.common.payment.PaymentGatewayType;
  24 import org.broadleafcommerce.common.payment.PaymentTransactionType;
  25 import org.broadleafcommerce.common.payment.PaymentType;
  26 import org.broadleafcommerce.common.vendor.service.exception.PaymentException;
  27 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  28 import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;
  29 import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;
  30 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  31 import org.broadleafcommerce.core.offer.service.exception.OfferExpiredException;
  32 import org.broadleafcommerce.core.offer.service.exception.OfferMaxUseExceededException;
  33 import org.broadleafcommerce.core.order.domain.NullOrderImpl;
  34 import org.broadleafcommerce.core.order.domain.Order;
  35 import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;
  36 import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  37 import org.broadleafcommerce.core.payment.domain.OrderPayment;
  38 import org.broadleafcommerce.core.payment.domain.PaymentTransaction;
  39 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  40 import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;
  41 import org.broadleafcommerce.core.web.order.CartState;
  42 import org.broadleafcommerce.profile.web.core.CustomerState;
  43 import org.springframework.ui.Model;
  44 import org.springframework.validation.BindingResult;
  45 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  46 
  47 import java.util.ArrayList;
  48 import java.util.List;
  49 
  50 import javax.servlet.http.HttpServletRequest;
  51 import javax.servlet.http.HttpServletResponse;
  52 
  53 /**
  54  * In charge of performing the various checkout operations
  55  *
  56  * @author Andre Azzolini (apazzolini)
  57  * @author Elbert Bautista (elbertbautista)
  58  * @author Joshua Skorton (jskorton)
  59  */
  60 public class BroadleafCheckoutController extends AbstractCheckoutController {
  61 
  62     private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);
  63     protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;
  64 
  65     /**
  66      * Renders the default checkout page and allows modules to add variables to the model.
  67      *
  68      * @param request
  69      * @param response
  70      * @param model
  71      * @param model
  72      * @return the checkout view path
  73      */
  74     public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,
  75             RedirectAttributes redirectAttributes) {
  76         preValidateCartOperation(model);
  77         populateModelWithReferenceData(request, model);
  78 
  79         return getCheckoutView();
  80     }
  81 
  82     protected void preValidateCartOperation(Model model) {
  83         try {
  84             Order cart = CartState.getCart();
  85             orderService.preValidateCartOperation(cart);
  86         } catch (IllegalCartOperationException ex) {
  87             model.addAttribute(&quot;cartRequiresLock&quot;, true);
  88         }
  89     }
  90 
  91     /**
  92      * Renders checkout stages partial at the requested stage
  93      *
  94      * @param request
  95      * @param response
  96      * @param model
  97      * @param stage
  98      * @return the checkout stages partial path
  99      */
<abbr title=" 100     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,"> 100     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, ModelðŸ”µ</abbr>
 101             String stage, RedirectAttributes redirectAttributes) {
 102         model.addAttribute(ACTIVE_STAGE, stage);
 103         return getCheckoutStagesPartial();
 104     }
 105 
 106     /**
 107      * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously
 108      * @param request
 109      * @param model
 110      * @param orderInfoForm
 111      * @param result
 112      * @return
 113      * @throws ServiceException
 114      */
 115     public String saveGlobalOrderDetails(HttpServletRequest request, Model model,
 116             OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {
 117         Order cart = CartState.getCart();
 118 
 119         orderInfoFormValidator.validate(orderInfoForm, result);
 120         if (result.hasErrors()) {
 121             // We need to clear the email on error in case they are trying to edit it
 122             try {
 123                 cart.setEmailAddress(null);
 124                 orderService.save(cart, false);
 125             } catch (PricingException pe) {
 126                 LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 127             }
 128 
 129             populateModelWithReferenceData(request, model);
 130             return getCheckoutView();
 131         }
 132 
 133         try {
 134             cart.setEmailAddress(orderInfoForm.getEmailAddress());
 135             orderService.save(cart, false);
 136         } catch (PricingException pe) {
 137             LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 138         }
 139 
 140         return getCheckoutPageRedirect();
 141     }
 142 
 143     /**
 144      * Creates a pass-through payment of the PaymentType passed in with
 145      * an amount equal to the order total after any non-final applied payments.
 146      * (for example gift cards, customer credit, or third party accounts)
 147      *
 148      * This intended to be used in cases like COD and other Payment Types where implementations wish
 149      * to just checkout without having to do any payment processing.
 150      *
 151      * This default implementations assumes that the pass-through payment is the only
 152      * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED
<abbr title=" 153      * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 153      * That means that it will look at all transactions on the order payment and see if it has unconfirmeðŸ”µ</abbr>
 154      * If it does, it will not remove it.
 155      *
 156      * Make sure not to expose this method in your extended Controller if you do not wish to
 157      * have this feature enabled.
 158      *
 159      * @param redirectAttributes
 160      * @param paymentType
 161      * @return
 162      * @throws PaymentException
 163      * @throws PricingException
 164      */
 165     public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,
<abbr title=" 166                                              PaymentType paymentType) throws PaymentException, PricingException {"> 166                                              PaymentType paymentType) throws PaymentException, PricingExcðŸ”µ</abbr>
 167         Order cart = CartState.getCart();
 168 
<abbr title=" 169         //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED"> 169         //Invalidate any payments already on the order that do not have transactions on them that are UNCðŸ”µ</abbr>
 170         List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();
 171         for (OrderPayment payment : cart.getPayments()) {
 172             if (payment.isActive()) {
 173                 if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {
 174                     paymentsToInvalidate.add(payment);
 175                 } else {
 176                     for (PaymentTransaction transaction : payment.getTransactions()) {
 177                         if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {
 178                              paymentsToInvalidate.add(payment);
 179                         }
 180                     }
 181                 }
 182             }
 183         }
 184 
 185         for (OrderPayment payment : paymentsToInvalidate) {
 186             cart.getPayments().remove(payment);
 187             if (paymentGatewayCheckoutService != null) {
 188                 paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());
 189             }
 190         }
 191 
 192         //Create a new Order Payment of the passed in type
 193         OrderPayment passthroughPayment = orderPaymentService.create();
 194         passthroughPayment.setType(paymentType);
 195         passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);
 196         passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());
 197         passthroughPayment.setOrder(cart);
 198 
 199         // Create the transaction for the payment
 200         PaymentTransaction transaction = orderPaymentService.createTransaction();
 201         transaction.setAmount(cart.getTotalAfterAppliedPayments());
 202         transaction.setRawResponse(&quot;Passthrough Payment&quot;);
 203         transaction.setSuccess(true);
 204         transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);
<abbr title=" 205         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 205         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymeðŸ”µ</abbr>
 206 
 207         transaction.setOrderPayment(passthroughPayment);
 208         passthroughPayment.addTransaction(transaction);
 209         orderService.addPaymentToOrder(cart, passthroughPayment, null);
 210 
 211         orderService.save(cart, true);
 212 
 213         return processCompleteCheckoutOrderFinalized(redirectAttributes);
 214     }
 215 
 216     /**
 217      * If the order has been finalized. i.e. all the payments have been applied to the order,
 218      * then you can go ahead and call checkout using the passed in order id.
<abbr title=" 219      * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 219      * This is usually called from a Review Page or if enough Payments have been applied to the Order to ðŸ”µ</abbr>
<abbr title=" 220      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or"> 220      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway,ðŸ”µ</abbr>
<abbr title=" 221      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)"> 221      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express CheckoutðŸ”µ</abbr>
 222      *
 223      * @return
 224      * @throws Exception
 225      */
<abbr title=" 226     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 226     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throðŸ”µ</abbr>
 227         Order cart = CartState.getCart();
 228         String param = &quot;&quot;;
 229         if (cart != null &amp;&amp; !(cart instanceof NullOrderImpl)) {
 230             try {
<abbr title=" 231                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OfferServiceImpl.OFFERS_EXPIRED);"> 231                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties()ðŸ”µ</abbr>
 232                 if(o!=null &amp;&amp; (Boolean) o){
<abbr title=" 233                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was re-calculated, check order total and try again&quot;);"> 233                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order pðŸ”µ</abbr>
 234                 }
 235                 String orderNumber = initiateCheckout(cart.getId());
 236                 return getConfirmationViewRedirect(orderNumber);
 237             } catch (Exception e) {
 238                 handleProcessingException(e, redirectAttributes);
 239                 if(CustomerState.getCustomer().isAnonymous()){
 240                     param=&quot;?guest-checkout=true&quot;;
 241                 }
 242             }
 243         }
 244 
 245 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 246         return getCheckoutPageRedirect() + (CustomerState.getCustomer().isAnonymous() ? &quot;?guest-checkout=true&quot; : &quot;&quot;);"> 246         return getCheckoutPageRedirect() + (CustomerState.getCustomer().isAnonymous() ? &quot;?guest-checkout=ðŸ”µ</abbr></span>
 247 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248         return getCheckoutPageRedirect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249     }</span>
 250 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251         return getCheckoutPageRedirect()+param;</span>
 252 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 253     }
 254 
 255     public String initiateCheckout(Long orderId) throws Exception{
 256         if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {
 257             return paymentGatewayCheckoutService.initiateCheckout(orderId);
 258         }
 259         return null;
 260     }
 261 
<abbr title=" 262     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 262     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymðŸ”µ</abbr>
<abbr title=" 263         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 263         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect AttribuðŸ”µ</abbr>
 264 
 265         Throwable cause = e.getCause();
 266 
 267         if (cause!= null &amp;&amp; cause.getCause() instanceof RequiredAttributeNotProvidedException) {
 268             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 269                     PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());
<abbr title=" 270         }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredException) {"> 270         }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferEðŸ”µ</abbr>
<abbr title=" 271             String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMessage();"> 271             String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() ðŸ”µ</abbr>
 272             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 273                     message);
 274         } else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferMaxUseExceededException) {
 275             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 276                     &quot;There was an error during checkout:&quot;+cause.getCause().getMessage());
 277         } else {
 278             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 279                     PaymentGatewayAbstractController.getProcessingErrorMessage());
 280         }
 281     }
 282 
 283     public String getBaseConfirmationRedirect() {
 284         return baseConfirmationRedirect;
 285     }
 286 
 287     protected String getConfirmationViewRedirect(String orderNumber) {
 288         return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;
 289     }
 290 
 291 }
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.controller.checkout;
  19 
  20 import java.util.ArrayList;
  21 import java.util.List;
  22 import javax.servlet.http.HttpServletRequest;
  23 import javax.servlet.http.HttpServletResponse;
  24 import org.apache.commons.logging.Log;
  25 import org.apache.commons.logging.LogFactory;
  26 import org.broadleafcommerce.common.exception.ServiceException;
  27 import org.broadleafcommerce.common.payment.PaymentGatewayType;
  28 import org.broadleafcommerce.common.payment.PaymentTransactionType;
  29 import org.broadleafcommerce.common.payment.PaymentType;
  30 import org.broadleafcommerce.common.vendor.service.exception.PaymentException;
  31 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  32 import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;
  33 import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;
  34 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  35 import org.broadleafcommerce.core.offer.service.exception.OfferExpiredException;
  36 import org.broadleafcommerce.core.offer.service.exception.OfferMaxUseExceededException;
  37 import org.broadleafcommerce.core.order.domain.NullOrderImpl;
  38 import org.broadleafcommerce.core.order.domain.Order;
  39 import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;
  40 import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  41 import org.broadleafcommerce.core.payment.domain.OrderPayment;
  42 import org.broadleafcommerce.core.payment.domain.PaymentTransaction;
  43 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  44 import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;
  45 import org.broadleafcommerce.core.web.order.CartState;
  46 import org.broadleafcommerce.profile.web.core.CustomerState;
  47 import org.springframework.ui.Model;
  48 import org.springframework.validation.BindingResult;
  49 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  50 
  51 
  52 /**
  53  * In charge of performing the various checkout operations
  54  *
  55  * @author Andre Azzolini (apazzolini)
  56  * @author Elbert Bautista (elbertbautista)
  57  * @author Joshua Skorton (jskorton)
  58  */
  59 public class BroadleafCheckoutController extends AbstractCheckoutController {
  60     private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);
  61 
  62     protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;
  63 
  64     /**
  65      * Renders the default checkout page and allows modules to add variables to the model.
  66      *
  67      * @param request
  68      * @param response
  69      * @param model
  70      * @param model
  71      * @return the checkout view path
  72      */
  73     public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,
  74             RedirectAttributes redirectAttributes) {
  75         preValidateCartOperation(model);
  76         populateModelWithReferenceData(request, model);
  77 
  78         return getCheckoutView();
  79     }
  80 
  81     protected void preValidateCartOperation(Model model) {
  82         try {
  83             Order cart = CartState.getCart();
  84             orderService.preValidateCartOperation(cart);
  85         } catch (IllegalCartOperationException ex) {
  86             model.addAttribute(&quot;cartRequiresLock&quot;, true);
  87         }
  88     }
  89 
  90     /**
  91      * Renders checkout stages partial at the requested stage
  92      *
  93      * @param request
  94      * @param response
  95      * @param model
  96      * @param stage
  97      * @return the checkout stages partial path
  98      */
<abbr title="  99     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,">  99     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, ModelðŸ”µ</abbr>
 100             String stage, RedirectAttributes redirectAttributes) {
 101         model.addAttribute(ACTIVE_STAGE, stage);
 102         return getCheckoutStagesPartial();
 103     }
 104 
 105     /**
 106      * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously
 107      * @param request
 108      * @param model
 109      * @param orderInfoForm
 110      * @param result
 111      * @return
 112      * @throws ServiceException
 113      */
 114     public String saveGlobalOrderDetails(HttpServletRequest request, Model model,
 115             OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {
 116         Order cart = CartState.getCart();
 117 
 118         orderInfoFormValidator.validate(orderInfoForm, result);
 119         if (result.hasErrors()) {
 120             // We need to clear the email on error in case they are trying to edit it
 121             try {
 122                 cart.setEmailAddress(null);
 123                 orderService.save(cart, false);
 124             } catch (PricingException pe) {
 125                 LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 126             }
 127 
 128             populateModelWithReferenceData(request, model);
 129             return getCheckoutView();
 130         }
 131 
 132         try {
 133             cart.setEmailAddress(orderInfoForm.getEmailAddress());
 134             orderService.save(cart, false);
 135         } catch (PricingException pe) {
 136             LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 137         }
 138 
 139         return getCheckoutPageRedirect();
 140     }
 141 
 142     /**
 143      * Creates a pass-through payment of the PaymentType passed in with
 144      * an amount equal to the order total after any non-final applied payments.
 145      * (for example gift cards, customer credit, or third party accounts)
 146      *
 147      * This intended to be used in cases like COD and other Payment Types where implementations wish
 148      * to just checkout without having to do any payment processing.
 149      *
 150      * This default implementations assumes that the pass-through payment is the only
 151      * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED
<abbr title=" 152      * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 152      * That means that it will look at all transactions on the order payment and see if it has unconfirmeðŸ”µ</abbr>
 153      * If it does, it will not remove it.
 154      *
 155      * Make sure not to expose this method in your extended Controller if you do not wish to
 156      * have this feature enabled.
 157      *
 158      * @param redirectAttributes
 159      * @param paymentType
 160      * @return
 161      * @throws PaymentException
 162      * @throws PricingException
 163      */
 164     public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,
<abbr title=" 165                                              PaymentType paymentType) throws PaymentException, PricingException {"> 165                                              PaymentType paymentType) throws PaymentException, PricingExcðŸ”µ</abbr>
 166         Order cart = CartState.getCart();
 167 
<abbr title=" 168         //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED"> 168         //Invalidate any payments already on the order that do not have transactions on them that are UNCðŸ”µ</abbr>
 169         List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();
 170         for (OrderPayment payment : cart.getPayments()) {
 171             if (payment.isActive()) {
 172                 if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {
 173                     paymentsToInvalidate.add(payment);
 174                 } else {
 175                     for (PaymentTransaction transaction : payment.getTransactions()) {
 176                         if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {
 177                              paymentsToInvalidate.add(payment);
 178                         }
 179                     }
 180                 }
 181             }
 182         }
 183 
 184         for (OrderPayment payment : paymentsToInvalidate) {
 185             cart.getPayments().remove(payment);
 186             if (paymentGatewayCheckoutService != null) {
 187                 paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());
 188             }
 189         }
 190 
 191         //Create a new Order Payment of the passed in type
 192         OrderPayment passthroughPayment = orderPaymentService.create();
 193         passthroughPayment.setType(paymentType);
 194         passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);
 195         passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());
 196         passthroughPayment.setOrder(cart);
 197 
 198         // Create the transaction for the payment
 199         PaymentTransaction transaction = orderPaymentService.createTransaction();
 200         transaction.setAmount(cart.getTotalAfterAppliedPayments());
 201         transaction.setRawResponse(&quot;Passthrough Payment&quot;);
 202         transaction.setSuccess(true);
 203         transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);
<abbr title=" 204         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 204         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymeðŸ”µ</abbr>
 205 
 206         transaction.setOrderPayment(passthroughPayment);
 207         passthroughPayment.addTransaction(transaction);
 208         orderService.addPaymentToOrder(cart, passthroughPayment, null);
 209 
 210         orderService.save(cart, true);
 211 
 212         return processCompleteCheckoutOrderFinalized(redirectAttributes);
 213     }
 214 
 215     /**
 216      * If the order has been finalized. i.e. all the payments have been applied to the order,
 217      * then you can go ahead and call checkout using the passed in order id.
<abbr title=" 218      * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 218      * This is usually called from a Review Page or if enough Payments have been applied to the Order to ðŸ”µ</abbr>
<abbr title=" 219      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or"> 219      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway,ðŸ”µ</abbr>
<abbr title=" 220      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)"> 220      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express CheckoutðŸ”µ</abbr>
 221      *
 222      * @return
 223      * @throws Exception
 224      */
<abbr title=" 225     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 225     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throðŸ”µ</abbr>
 226         Order cart = CartState.getCart();
 227         String param = &quot;&quot;;
 228         if ((cart != null) &amp;&amp; (!(cart instanceof NullOrderImpl))) {
 229             try {
<abbr title=" 230                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OfferServiceImpl.OFFERS_EXPIRED);"> 230                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties()ðŸ”µ</abbr>
 231                 if ((o != null) &amp;&amp; ((Boolean) (o))) {
<abbr title=" 232                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was re-calculated, check order total and try again&quot;);"> 232                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order pðŸ”µ</abbr>
 233                 }
 234                 String orderNumber = initiateCheckout(cart.getId());
 235                 return getConfirmationViewRedirect(orderNumber);
 236             } catch (java.lang.Exception e) {
 237                 handleProcessingException(e, redirectAttributes);
 238                 if (CustomerState.getCustomer().isAnonymous()) {
 239                     param = &quot;?guest-checkout=true&quot;;
 240                 }
 241             }
 242         }
 243         return
 244 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245 getCheckoutPageRedirect() + (CustomerState.getCustomer().isAnonymous() ? &quot;?guest-checkout=true&quot; : &quot;&quot;)</span>
 246 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 247 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 247 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 248 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250 getCheckoutPageRedirect()+param</span>
 251 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 252         ;
 253     }
 254 
 255     public String initiateCheckout(Long orderId) throws Exception{
 256         if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {
 257             return paymentGatewayCheckoutService.initiateCheckout(orderId);
 258         }
 259         return null;
 260     }
 261 
<abbr title=" 262     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 262     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymðŸ”µ</abbr>
<abbr title=" 263         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 263         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect AttribuðŸ”µ</abbr>
 264         Throwable cause = e.getCause();
 265         if ((cause != null) &amp;&amp; (cause.getCause() instanceof RequiredAttributeNotProvidedException)) {
<abbr title=" 266             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());"> 266             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, PaðŸ”µ</abbr>
<abbr title=" 267         } else if (((cause != null) &amp;&amp; (cause.getCause() instanceof OfferExpiredException)) || (e instanceof OfferExpiredException)) {"> 267         } else if (((cause != null) &amp;&amp; (cause.getCause() instanceof OfferExpiredException)) || (e instancðŸ”µ</abbr>
<abbr title=" 268             String message = ((cause != null) &amp;&amp; (cause.getCause() != null)) ? cause.getCause().getMessage() : e.getMessage();"> 268             String message = ((cause != null) &amp;&amp; (cause.getCause() != null)) ? cause.getCause().getMessagðŸ”µ</abbr>
<abbr title=" 269             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, message);"> 269             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, meðŸ”µ</abbr>
 270         } else if ((cause != null) &amp;&amp; (cause.getCause() instanceof OfferMaxUseExceededException)) {
<abbr title=" 271             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, &quot;There was an error during checkout:&quot; + cause.getCause().getMessage());"> 271             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, &quot;TðŸ”µ</abbr>
 272         } else {
<abbr title=" 273             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, PaymentGatewayAbstractController.getProcessingErrorMessage());"> 273             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, PaðŸ”µ</abbr>
 274         }
 275     }
 276 
 277     public String getBaseConfirmationRedirect() {
 278         return baseConfirmationRedirect;
 279     }
 280 
 281     protected String getConfirmationViewRedirect(String orderNumber) {
 282         return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;
 283     }
 284 }
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework Web
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.web.controller.checkout;
  19  
  20  import org.apache.commons.logging.Log;
  21  import org.apache.commons.logging.LogFactory;
  22  import org.broadleafcommerce.common.exception.ServiceException;
  23  import org.broadleafcommerce.common.payment.PaymentGatewayType;
  24  import org.broadleafcommerce.common.payment.PaymentTransactionType;
  25  import org.broadleafcommerce.common.payment.PaymentType;
  26  import org.broadleafcommerce.common.vendor.service.exception.PaymentException;
  27  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  28  import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;
  29  import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;
  30  import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  31  import org.broadleafcommerce.core.offer.service.exception.OfferExpiredException;

  32  import org.broadleafcommerce.core.order.domain.NullOrderImpl;
  33  import org.broadleafcommerce.core.order.domain.Order;
  34  import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;
  35  import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  36  import org.broadleafcommerce.core.payment.domain.OrderPayment;
  37  import org.broadleafcommerce.core.payment.domain.PaymentTransaction;
  38  import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  39  import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;
  40  import org.broadleafcommerce.core.web.order.CartState;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import org.broadleafcommerce.profile.web.core.CustomerState;</span>
  42  import org.springframework.ui.Model;
  43  import org.springframework.validation.BindingResult;
  44  import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  45  
  46  import java.util.ArrayList;
  47  import java.util.List;
  48  
  49  import javax.servlet.http.HttpServletRequest;
  50  import javax.servlet.http.HttpServletResponse;
  51  
  52  /**
  53   * In charge of performing the various checkout operations
  54   *
  55   * @author Andre Azzolini (apazzolini)
  56   * @author Elbert Bautista (elbertbautista)
  57   * @author Joshua Skorton (jskorton)
  58   */
  59  public class BroadleafCheckoutController extends AbstractCheckoutController {
  60  
  61      private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);
  62      protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;
  63  
  64      /**
  65       * Renders the default checkout page and allows modules to add variables to the model.
  66       *
  67       * @param request
  68       * @param response
  69       * @param model
  70       * @param model
  71       * @return the checkout view path
  72       */
  73      public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,
  74              RedirectAttributes redirectAttributes) {
  75          preValidateCartOperation(model);
  76          populateModelWithReferenceData(request, model);
  77  
  78          return getCheckoutView();
  79      }
  80  
  81      protected void preValidateCartOperation(Model model) {
  82          try {
  83              Order cart = CartState.getCart();
  84              orderService.preValidateCartOperation(cart);
  85          } catch (IllegalCartOperationException ex) {
  86              model.addAttribute(&quot;cartRequiresLock&quot;, true);
  87          }
  88      }
  89  
  90      /**
  91       * Renders checkout stages partial at the requested stage
  92       *
  93       * @param request
  94       * @param response
  95       * @param model
  96       * @param stage
  97       * @return the checkout stages partial path
  98       */
  99      public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,
 100              String stage, RedirectAttributes redirectAttributes) {
 101          model.addAttribute(ACTIVE_STAGE, stage);
 102          return getCheckoutStagesPartial();
 103      }
 104  
 105      /**
 106       * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously
 107       * @param request
 108       * @param model
 109       * @param orderInfoForm
 110       * @param result
 111       * @return
 112       * @throws ServiceException
 113       */
 114      public String saveGlobalOrderDetails(HttpServletRequest request, Model model,
 115              OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {
 116          Order cart = CartState.getCart();
 117  
 118          orderInfoFormValidator.validate(orderInfoForm, result);
 119          if (result.hasErrors()) {
 120              // We need to clear the email on error in case they are trying to edit it
 121              try {
 122                  cart.setEmailAddress(null);
 123                  orderService.save(cart, false);
 124              } catch (PricingException pe) {
 125                  LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 126              }
 127  
 128              populateModelWithReferenceData(request, model);
 129              return getCheckoutView();
 130          }
 131  
 132          try {
 133              cart.setEmailAddress(orderInfoForm.getEmailAddress());
 134              orderService.save(cart, false);
 135          } catch (PricingException pe) {
 136              LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 137          }
 138  
 139          return getCheckoutPageRedirect();
 140      }
 141  
 142      /**
 143       * Creates a pass-through payment of the PaymentType passed in with
 144       * an amount equal to the order total after any non-final applied payments.
 145       * (for example gift cards, customer credit, or third party accounts)
 146       *
 147       * This intended to be used in cases like COD and other Payment Types where implementations wish
 148       * to just checkout without having to do any payment processing.
 149       *
 150       * This default implementations assumes that the pass-through payment is the only
 151       * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED
<abbr title=" 152       * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 152       * That means that it will look at all transactions on the order payment and see if it has unconfirmed transacðŸ”µ</abbr>
 153       * If it does, it will not remove it.
 154       *
 155       * Make sure not to expose this method in your extended Controller if you do not wish to
 156       * have this feature enabled.
 157       *
 158       * @param redirectAttributes
 159       * @param paymentType
 160       * @return
 161       * @throws PaymentException
 162       * @throws PricingException
 163       */
 164      public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,
 165                                               PaymentType paymentType) throws PaymentException, PricingException {
 166          Order cart = CartState.getCart();
 167  
 168          //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED
 169          List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();
 170          for (OrderPayment payment : cart.getPayments()) {
 171              if (payment.isActive()) {
 172                  if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {
 173                      paymentsToInvalidate.add(payment);
 174                  } else {
 175                      for (PaymentTransaction transaction : payment.getTransactions()) {
 176                          if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {
 177                               paymentsToInvalidate.add(payment);
 178                          }
 179                      }
 180                  }
 181              }
 182          }
 183  
 184          for (OrderPayment payment : paymentsToInvalidate) {
 185              cart.getPayments().remove(payment);
 186              if (paymentGatewayCheckoutService != null) {
 187                  paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());
 188              }
 189          }
 190  
 191          //Create a new Order Payment of the passed in type
 192          OrderPayment passthroughPayment = orderPaymentService.create();
 193          passthroughPayment.setType(paymentType);
 194          passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);
 195          passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());
 196          passthroughPayment.setOrder(cart);
 197  
 198          // Create the transaction for the payment
 199          PaymentTransaction transaction = orderPaymentService.createTransaction();
 200          transaction.setAmount(cart.getTotalAfterAppliedPayments());
 201          transaction.setRawResponse(&quot;Passthrough Payment&quot;);
 202          transaction.setSuccess(true);
 203          transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);
<abbr title=" 204          transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 204          transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.geðŸ”µ</abbr>
 205  
 206          transaction.setOrderPayment(passthroughPayment);
 207          passthroughPayment.addTransaction(transaction);
 208          orderService.addPaymentToOrder(cart, passthroughPayment, null);
 209  
 210          orderService.save(cart, true);
 211  
 212          return processCompleteCheckoutOrderFinalized(redirectAttributes);
 213      }
 214  
 215      /**
 216       * If the order has been finalized. i.e. all the payments have been applied to the order,
 217       * then you can go ahead and call checkout using the passed in order id.
<abbr title=" 218       * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 218       * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete ðŸ”µ</abbr>
 219       * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or
 220       * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)
 221       *
 222       * @return
 223       * @throws Exception
 224       */
<abbr title=" 225      public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 225      public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymenðŸ”µ</abbr>
 226          Order cart = CartState.getCart();
 227  

 228          if (cart != null &amp;&amp; !(cart instanceof NullOrderImpl)) {
 229              try {
<abbr title=" 230                  Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OfferServiceImpl.OFFERS_EXPIRED);"> 230                  Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OffeðŸ”µ</abbr>
 231                  if(o!=null &amp;&amp; (Boolean) o){
<abbr title=" 232                      throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was re-calculated, check order total and try again&quot;);"> 232                      throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was ðŸ”µ</abbr>
 233                  }
 234                  String orderNumber = initiateCheckout(cart.getId());
 235                  return getConfirmationViewRedirect(orderNumber);
 236              } catch (Exception e) {
 237                  handleProcessingException(e, redirectAttributes);
 238              }
 239          }
 240  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -        return getCheckoutPageRedirect();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 242 +        return getCheckoutPageRedirect() + (CustomerState.getCustomer().isAnonymous() ? &quot;?guest-checkout=true&quot; : &quot;&quot;);"> 242 +        return getCheckoutPageRedirect() + (CustomerState.getCustomer().isAnonymous() ? &quot;?guest-checkout=true&quot; : &quot;ðŸ”µ</abbr></span>






 243      }
 244  
 245      public String initiateCheckout(Long orderId) throws Exception{
 246          if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {
 247              return paymentGatewayCheckoutService.initiateCheckout(orderId);
 248          }
 249          return null;
 250      }
 251  
<abbr title=" 252      public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 252      public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentExceptðŸ”µ</abbr>
<abbr title=" 253          LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 253          LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e)ðŸ”µ</abbr>
 254  
 255          Throwable cause = e.getCause();
 256  
 257          if (cause!= null &amp;&amp; cause.getCause() instanceof RequiredAttributeNotProvidedException) {
 258              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 259                      PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());
<abbr title=" 260          }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredException) {"> 260          }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredExcðŸ”µ</abbr>
<abbr title=" 261              String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMessage();"> 261              String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMeðŸ”µ</abbr>
 262              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 263                      message);



 264          } else {
 265              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 266                      PaymentGatewayAbstractController.getProcessingErrorMessage());
 267          }
 268      }
 269  
 270      public String getBaseConfirmationRedirect() {
 271          return baseConfirmationRedirect;
 272      }
 273  
 274      protected String getConfirmationViewRedirect(String orderNumber) {
 275          return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;
 276      }
 277  
 278  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework Web
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.web.controller.checkout;
  19  
  20  import org.apache.commons.logging.Log;
  21  import org.apache.commons.logging.LogFactory;
  22  import org.broadleafcommerce.common.exception.ServiceException;
  23  import org.broadleafcommerce.common.payment.PaymentGatewayType;
  24  import org.broadleafcommerce.common.payment.PaymentTransactionType;
  25  import org.broadleafcommerce.common.payment.PaymentType;
  26  import org.broadleafcommerce.common.vendor.service.exception.PaymentException;
  27  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  28  import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;
  29  import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;
  30  import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  31  import org.broadleafcommerce.core.offer.service.exception.OfferExpiredException;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import org.broadleafcommerce.core.offer.service.exception.OfferMaxUseExceededException;</span>
  33  import org.broadleafcommerce.core.order.domain.NullOrderImpl;
  34  import org.broadleafcommerce.core.order.domain.Order;
  35  import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;
  36  import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  37  import org.broadleafcommerce.core.payment.domain.OrderPayment;
  38  import org.broadleafcommerce.core.payment.domain.PaymentTransaction;
  39  import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  40  import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;
  41  import org.broadleafcommerce.core.web.order.CartState;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +import org.broadleafcommerce.profile.web.core.CustomerState;</span>
  43  import org.springframework.ui.Model;
  44  import org.springframework.validation.BindingResult;
  45  import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  46  
  47  import java.util.ArrayList;
  48  import java.util.List;
  49  
  50  import javax.servlet.http.HttpServletRequest;
  51  import javax.servlet.http.HttpServletResponse;
  52  
  53  /**
  54   * In charge of performing the various checkout operations
  55   *
  56   * @author Andre Azzolini (apazzolini)
  57   * @author Elbert Bautista (elbertbautista)
  58   * @author Joshua Skorton (jskorton)
  59   */
  60  public class BroadleafCheckoutController extends AbstractCheckoutController {
  61  
  62      private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);
  63      protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;
  64  
  65      /**
  66       * Renders the default checkout page and allows modules to add variables to the model.
  67       *
  68       * @param request
  69       * @param response
  70       * @param model
  71       * @param model
  72       * @return the checkout view path
  73       */
  74      public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,
  75              RedirectAttributes redirectAttributes) {
  76          preValidateCartOperation(model);
  77          populateModelWithReferenceData(request, model);
  78  
  79          return getCheckoutView();
  80      }
  81  
  82      protected void preValidateCartOperation(Model model) {
  83          try {
  84              Order cart = CartState.getCart();
  85              orderService.preValidateCartOperation(cart);
  86          } catch (IllegalCartOperationException ex) {
  87              model.addAttribute(&quot;cartRequiresLock&quot;, true);
  88          }
  89      }
  90  
  91      /**
  92       * Renders checkout stages partial at the requested stage
  93       *
  94       * @param request
  95       * @param response
  96       * @param model
  97       * @param stage
  98       * @return the checkout stages partial path
  99       */
 100      public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,
 101              String stage, RedirectAttributes redirectAttributes) {
 102          model.addAttribute(ACTIVE_STAGE, stage);
 103          return getCheckoutStagesPartial();
 104      }
 105  
 106      /**
 107       * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously
 108       * @param request
 109       * @param model
 110       * @param orderInfoForm
 111       * @param result
 112       * @return
 113       * @throws ServiceException
 114       */
 115      public String saveGlobalOrderDetails(HttpServletRequest request, Model model,
 116              OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {
 117          Order cart = CartState.getCart();
 118  
 119          orderInfoFormValidator.validate(orderInfoForm, result);
 120          if (result.hasErrors()) {
 121              // We need to clear the email on error in case they are trying to edit it
 122              try {
 123                  cart.setEmailAddress(null);
 124                  orderService.save(cart, false);
 125              } catch (PricingException pe) {
 126                  LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 127              }
 128  
 129              populateModelWithReferenceData(request, model);
 130              return getCheckoutView();
 131          }
 132  
 133          try {
 134              cart.setEmailAddress(orderInfoForm.getEmailAddress());
 135              orderService.save(cart, false);
 136          } catch (PricingException pe) {
 137              LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);
 138          }
 139  
 140          return getCheckoutPageRedirect();
 141      }
 142  
 143      /**
 144       * Creates a pass-through payment of the PaymentType passed in with
 145       * an amount equal to the order total after any non-final applied payments.
 146       * (for example gift cards, customer credit, or third party accounts)
 147       *
 148       * This intended to be used in cases like COD and other Payment Types where implementations wish
 149       * to just checkout without having to do any payment processing.
 150       *
 151       * This default implementations assumes that the pass-through payment is the only
 152       * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED
<abbr title=" 153       * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 153       * That means that it will look at all transactions on the order payment and see if it has unconfirmed transacðŸ”µ</abbr>
 154       * If it does, it will not remove it.
 155       *
 156       * Make sure not to expose this method in your extended Controller if you do not wish to
 157       * have this feature enabled.
 158       *
 159       * @param redirectAttributes
 160       * @param paymentType
 161       * @return
 162       * @throws PaymentException
 163       * @throws PricingException
 164       */
 165      public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,
 166                                               PaymentType paymentType) throws PaymentException, PricingException {
 167          Order cart = CartState.getCart();
 168  
 169          //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED
 170          List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();
 171          for (OrderPayment payment : cart.getPayments()) {
 172              if (payment.isActive()) {
 173                  if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {
 174                      paymentsToInvalidate.add(payment);
 175                  } else {
 176                      for (PaymentTransaction transaction : payment.getTransactions()) {
 177                          if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {
 178                               paymentsToInvalidate.add(payment);
 179                          }
 180                      }
 181                  }
 182              }
 183          }
 184  
 185          for (OrderPayment payment : paymentsToInvalidate) {
 186              cart.getPayments().remove(payment);
 187              if (paymentGatewayCheckoutService != null) {
 188                  paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());
 189              }
 190          }
 191  
 192          //Create a new Order Payment of the passed in type
 193          OrderPayment passthroughPayment = orderPaymentService.create();
 194          passthroughPayment.setType(paymentType);
 195          passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);
 196          passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());
 197          passthroughPayment.setOrder(cart);
 198  
 199          // Create the transaction for the payment
 200          PaymentTransaction transaction = orderPaymentService.createTransaction();
 201          transaction.setAmount(cart.getTotalAfterAppliedPayments());
 202          transaction.setRawResponse(&quot;Passthrough Payment&quot;);
 203          transaction.setSuccess(true);
 204          transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);
<abbr title=" 205          transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 205          transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.geðŸ”µ</abbr>
 206  
 207          transaction.setOrderPayment(passthroughPayment);
 208          passthroughPayment.addTransaction(transaction);
 209          orderService.addPaymentToOrder(cart, passthroughPayment, null);
 210  
 211          orderService.save(cart, true);
 212  
 213          return processCompleteCheckoutOrderFinalized(redirectAttributes);
 214      }
 215  
 216      /**
 217       * If the order has been finalized. i.e. all the payments have been applied to the order,
 218       * then you can go ahead and call checkout using the passed in order id.
<abbr title=" 219       * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 219       * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete ðŸ”µ</abbr>
 220       * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or
 221       * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)
 222       *
 223       * @return
 224       * @throws Exception
 225       */
<abbr title=" 226      public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 226      public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymenðŸ”µ</abbr>
 227          Order cart = CartState.getCart();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +        String param = &quot;&quot;;</span>
 230          if (cart != null &amp;&amp; !(cart instanceof NullOrderImpl)) {
 231              try {
<abbr title=" 232                  Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OfferServiceImpl.OFFERS_EXPIRED);"> 232                  Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OffeðŸ”µ</abbr>
 233                  if(o!=null &amp;&amp; (Boolean) o){
<abbr title=" 234                      throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was re-calculated, check order total and try again&quot;);"> 234                      throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was ðŸ”µ</abbr>
 235                  }
 236                  String orderNumber = initiateCheckout(cart.getId());
 237                  return getConfirmationViewRedirect(orderNumber);
 238              } catch (Exception e) {
 239                  handleProcessingException(e, redirectAttributes);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -        return getCheckoutPageRedirect();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +                if(CustomerState.getCustomer().isAnonymous()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +                    param=&quot;?guest-checkout=true&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +        return getCheckoutPageRedirect()+param;</span>
 251      }
 252  
 253      public String initiateCheckout(Long orderId) throws Exception{
 254          if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {
 255              return paymentGatewayCheckoutService.initiateCheckout(orderId);
 256          }
 257          return null;
 258      }
 259  
<abbr title=" 260      public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 260      public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentExceptðŸ”µ</abbr>
<abbr title=" 261          LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 261          LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e)ðŸ”µ</abbr>
 262  
 263          Throwable cause = e.getCause();
 264  
 265          if (cause!= null &amp;&amp; cause.getCause() instanceof RequiredAttributeNotProvidedException) {
 266              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 267                      PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());
<abbr title=" 268          }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredException) {"> 268          }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredExcðŸ”µ</abbr>
<abbr title=" 269              String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMessage();"> 269              String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMeðŸ”µ</abbr>
 270              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 271                      message);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +        } else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferMaxUseExceededException) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +            redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +                    &quot;There was an error during checkout:&quot;+cause.getCause().getMessage());</span>
 275          } else {
 276              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,
 277                      PaymentGatewayAbstractController.getProcessingErrorMessage());
 278          }
 279      }
 280  
 281      public String getBaseConfirmationRedirect() {
 282          return baseConfirmationRedirect;
 283      }
 284  
 285      protected String getConfirmationViewRedirect(String orderNumber) {
 286          return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;
 287      }
 288  
 289  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            