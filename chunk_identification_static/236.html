<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>236</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    236
                    <a href="235.html">prev</a>
                    <a href="237.html">next</a>
                    <a href="236_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_f5db368495dc79a81ae500a4493160411144408a_Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;f5db368495dc79a81ae500a4493160411144408a:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;f5db368495dc79a81ae500a4493160411144408a^1:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;f5db368495dc79a81ae500a4493160411144408a^2:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;de00faf7e4f61edac1b05e926931f24a8aa722c5:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import java.util.ArrayList;
   4 import java.util.Calendar;
   5 import java.util.List;
   6 
   7 import android.app.Activity;
   8 import android.app.Fragment;
   9 import android.content.Context;
  10 import android.graphics.Typeface;
  11 import android.os.AsyncTask;
  12 import android.database.Cursor;
  13 import android.os.Bundle;
  14 import android.os.Handler;
  15 import android.text.Editable;
  16 import android.text.Spannable;
  17 import android.text.SpannableString;
  18 import android.text.Spanned;
  19 import android.text.TextUtils;
  20 import android.text.TextWatcher;
  21 import android.util.Log;
  22 import android.view.LayoutInflater;
  23 import android.view.View;
  24 import android.view.ViewGroup;
  25 import android.view.inputmethod.InputMethodManager;
  26 import android.widget.ArrayAdapter;
  27 import android.widget.BaseAdapter;
  28 import android.widget.CursorAdapter;
  29 import android.widget.EditText;
  30 import android.widget.FilterQueryProvider;
  31 import android.widget.Filterable;
  32 import android.widget.LinearLayout;
  33 import android.widget.ListAdapter;
  34 import android.widget.MultiAutoCompleteTextView.Tokenizer;
  35 import android.widget.TextView;
  36 import android.widget.ToggleButton;
  37 
  38 import com.automattic.simplenote.models.Note;
  39 import com.automattic.simplenote.models.Tag;
  40 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  41 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  42 import com.automattic.simplenote.utils.TypefaceSpan;
  43 import com.automattic.simplenote.utils.Typefaces;
  44 import com.google.analytics.tracking.android.EasyTracker;
  45 import com.google.analytics.tracking.android.Tracker;
  46 import com.simperium.client.Bucket;
  47 import com.simperium.client.Bucket.ObjectCursor;
  48 import com.simperium.client.BucketObjectMissingException;
  49 import com.simperium.client.Query;
  50 
  51 public class NoteEditorFragment extends Fragment implements TextWatcher, OnTagAddedListener {
  52 
  53     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  54     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  55 
  56     private Note mNote;
  57     private EditText mContentEditText;
  58     private TagsMultiAutoCompleteTextView mTagView;
  59     private ToggleButton mPinButton;
  60     private boolean mShowNoteTitle;
  61     private Handler mAutoSaveHandler;
  62     private LinearLayout mPlaceholderView;
  63     private CursorAdapter mAutocompleteAdapter;
  64     /**
  65      * Mandatory empty constructor for the fragment manager to instantiate the
  66      * fragment (e.g. upon screen orientation changes).
  67      */
  68     public NoteEditorFragment() {
  69     }
  70 
  71     @Override
  72     public void onCreate(Bundle savedInstanceState) {
  73         super.onCreate(savedInstanceState);
  74 
  75         if (!((NotesActivity) getActivity()).isLargeScreenLandscape())
  76             mShowNoteTitle = true;
  77 
  78         mAutoSaveHandler = new Handler();
  79 
  80 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81         mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83             @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84             public View newView(Context context, Cursor cursor, ViewGroup parent) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85                 Activity activity = (Activity) context;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86                 if (activity == null) return null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87                 return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90             @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91             public void bindView(View view, Context context, Cursor cursor) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92                 TextView textView = (TextView) view;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93                 textView.setText(convertToString(cursor));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96             @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97             public CharSequence convertToString(Cursor cursor){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98                 return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101             @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102             public Cursor runQueryOnBackgroundThread(CharSequence filter){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 103                 Log.v(Simplenote.TAG, String.format(&quot;runQueryOnBackgroundThread with filter: %s&quot;, filter));"> 103                 Log.v(Simplenote.TAG, String.format(&quot;runQueryOnBackgroundThread with filter: %s&quot;, filter)ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104                 Activity activity = (Activity) getActivity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105                 if (activity == null) return null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106                 Simplenote application = (Simplenote) activity.getApplication();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107                 Query&lt;Tag&gt; query = application.getTagsBucket().query();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108                 // make the tag name available to the cursor</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109                 query.include(Tag.NAME_PROPERTY);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110                 // sort the tags by their names</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111                 query.order(Tag.NAME_PROPERTY);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112                 // if there&#x27;s a filter string find only matching tag names</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 113                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 113                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.forðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114                 return query.execute();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116         };</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117 </span>
 118 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119         mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120         mContentEditText.addTextChangedListener(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122         mTagView.setTokenizer(new SpaceTokenizer());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         if (((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;&amp; mNote == null)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127             mPlaceholderView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130             String key = getArguments().getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131             new loadNoteTask().execute(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134 		return rootView;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     public void onResume() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139         super.onResume();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         mTagView.setOnTagAddedListener(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141         if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142             // Show soft keyboard</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143             mContentEditText.requestFocus();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 145             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 145             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(CðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146             if (inputMethodManager != null)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147                 inputMethodManager.showSoftInput(mContentEditText, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152     public void onPause() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153         saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154         mTagView.setOnTagAddedListener(null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156         if (mAutoSaveHandler != null)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159         super.onPause();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160     }</span>
 161 =======
 162 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 163     }
 164 
 165     @Override
 166     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 167         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 168         mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));
 169         mContentEditText.addTextChangedListener(this);
<abbr title=" 170         mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 170         mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONTðŸ”µ</abbr>
 171         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 172         mTagView.setTokenizer(new SpaceTokenizer());
 173         mTagView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));
 174 
 175         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
 176         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
 177         if (((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;&amp; mNote == null)
 178             mPlaceholderView.setVisibility(View.VISIBLE);
 179 
 180         if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {
 181             String key = getArguments().getString(ARG_ITEM_ID);
 182             new loadNoteTask().execute(key);
 183         }
 184 
 185         mTagView.setAdapter(mAutocompleteAdapter);
 186 		return rootView;
 187 	}
 188 
 189     @Override
 190     public void onResume() {
 191         super.onResume();
 192         mTagView.setOnTagAddedListener(this);
 193         if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 194             // Show soft keyboard
 195             mContentEditText.requestFocus();
 196 
<abbr title=" 197             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 197             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(CðŸ”µ</abbr>
 198             if (inputMethodManager != null)
 199                 inputMethodManager.showSoftInput(mContentEditText, 0);
 200         }
 201     }
 202 
 203     @Override
 204     public void onPause() {
 205         saveAndSyncNote();
 206         mTagView.setOnTagAddedListener(null);
 207 
 208         if (mAutoSaveHandler != null)
 209             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 210 
 211         super.onPause();
 212     }
 213 
 214     public void setNote(String noteID) {
 215         mPlaceholderView.setVisibility(View.GONE);
 216 
 217         // If we have a note already (on a tablet in landscape), save the note.
 218         if (mNote != null)
 219             saveAndSyncNote();
 220 
 221         Simplenote simplenote = (Simplenote)getActivity().getApplication();
 222         Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 223         try {
 224             mNote = notesBucket.get(noteID);
 225         } catch (BucketObjectMissingException e) {
 226             e.printStackTrace();
 227         }
 228         refreshContent(false);
 229     }
 230 
 231     public void refreshContent(boolean isNoteUpdate) {
 232         if (mNote != null) {
 233             Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);
 234             // Restore the cursor position if possible.
 235 
<abbr title=" 236             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 236             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toStrinðŸ”µ</abbr>
 237             mContentEditText.setText(mNote.getContent());
<abbr title=" 238             if (isNoteUpdate &amp;&amp; mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())"> 238             if (isNoteUpdate &amp;&amp; mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSeleðŸ”µ</abbr>
 239                 mContentEditText.setSelection(cursorPosition);
 240 
 241             mPinButton.setChecked(mNote.isPinned());
 242 
 243             setActionBarTitle();
 244 
 245             updateTagList();
 246         }
 247     }
 248 
 249     public void updateTagList(){
 250         Activity activity = getActivity();
 251         if (activity == null) return;
 252 
 253         // Populate this note&#x27;s tags in the tagView
 254         mTagView.setChips(mNote.getTagString());
 255     }
 256 
 257     private void setActionBarTitle() {
 258         String title;
 259         if (mShowNoteTitle &amp;&amp; getActivity() != null) {
 260             if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))
 261                 title = mNote.getTitle();
 262             else
 263                 title = getString(R.string.new_note);
 264 
 265             SpannableString s = new SpannableString(title);
 266             s.setSpan(new TypefaceSpan(getActivity().getBaseContext()), 0, s.length(),
 267                     Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 268             getActivity().getActionBar().setTitle(s);
 269         }
 270     }
 271 
 272     int newCursorLocation(String newText, String oldText, int cursorLocation) {
 273         // Ported from the iOS app :)
 274         // Cases:
 275         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 276         // 1. Text was added after the cursor ==&gt; no change
 277         // 2. Text was added before the cursor ==&gt; location advances
 278         // 3. Text was removed after the cursor ==&gt; no change
 279         // 4. Text was removed before the cursor ==&gt; location retreats
 280         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 281 
 282         int newCursorLocation = cursorLocation;
 283 
 284         int deltaLength = newText.length() - oldText.length();
 285 
 286         // Case 0
 287         if (newText.length() &lt; cursorLocation)
 288             return newText.length();
 289 
 290         boolean beforeCursorMatches = false;
 291         boolean afterCursorMatches = false;
 292 
 293         try {
<abbr title=" 294             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 294             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorðŸ”µ</abbr>
<abbr title=" 295             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 295             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substðŸ”µ</abbr>
 296         } catch (Exception e) {
 297             e.printStackTrace();
 298         }
 299 
 300         // Cases 2 and 4
 301         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 302             newCursorLocation += deltaLength;
 303 
 304         // Cases 1, 3 and 5 have no change
 305         return newCursorLocation;
 306     }
 307 
 308     private Runnable autoSaveRunnable = new Runnable() {
 309         @Override
 310         public void run() {
 311             saveAndSyncNote();
 312         }
 313     };
 314 
 315     @Override
 316     public void onTagsChanged(String tagString){
 317         mNote.setTagString(tagString);
 318         mNote.setModificationDate(Calendar.getInstance());
 319         updateTagList();
 320         mNote.save();
 321         if (getActivity() != null)
 322             EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;added_tag&quot;, &quot;tag_added_to_note&quot;, null);
 323     }
 324 
 325     @Override
 326     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 327         // Unused
 328     }
 329 
 330     @Override
 331     public void afterTextChanged(Editable editable) {
 332         // Unused
 333 
 334     }
 335 
 336     @Override
 337     public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 338 
 339         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 340 
 341         if (mAutoSaveHandler != null) {
 342             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 343             mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 344         }
 345     }
 346 
 347     private void saveAndSyncNote() {
 348         if (mNote == null)
 349             return;
 350 
 351         new saveNoteTask().execute();
 352         setActionBarTitle();
 353 
 354         Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);
 355     }
 356 
 357     public void setPlaceholderVisible(boolean isVisible) {
 358         if (isVisible) {
 359             mNote = null;
 360             mContentEditText.setText(&quot;&quot;);
 361             mTagView.setText(&quot;&quot;);
 362             if (mPlaceholderView != null)
 363                 mPlaceholderView.setVisibility(View.VISIBLE);
 364         } else {
 365             if (mPlaceholderView != null)
 366                 mPlaceholderView.setVisibility(View.GONE);
 367         }
 368     }
 369 
 370     // Use spaces in tag autocompletion list
<abbr title=" 371     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 371     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-tðŸ”µ</abbr>
 372     public class SpaceTokenizer implements Tokenizer {
 373 
 374         public int findTokenStart(CharSequence text, int cursor) {
 375             int i = cursor;
 376 
 377             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {
 378                 i--;
 379             }
 380             while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {
 381                 i++;
 382             }
 383 
 384             return i;
 385         }
 386 
 387         public int findTokenEnd(CharSequence text, int cursor) {
 388             int i = cursor;
 389             int len = text.length();
 390 
 391             while (i &lt; len) {
 392                 if (text.charAt(i) == &#x27; &#x27;) {
 393                     return i;
 394                 } else {
 395                     i++;
 396                 }
 397             }
 398 
 399             return len;
 400         }
 401 
 402         public CharSequence terminateToken(CharSequence text) {
 403             int i = text.length();
 404 
 405             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 406                 i--;
 407             }
 408 
 409             if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 410                 return text;
 411             } else {
 412                 if (text instanceof Spanned) {
 413                     SpannableString sp = new SpannableString(text + &quot; &quot;);
 414                     TextUtils.copySpansFrom((Spanned) text, 0, text.length(),
 415                             Object.class, sp, 0);
 416                     return sp;
 417                 } else {
 418                     return text + &quot; &quot;;
 419                 }
 420             }
 421         }
 422     }
 423 
 424     private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 425 
 426         @Override
 427         protected Void doInBackground(String... args) {
 428             String noteID = args[0];
 429             NotesActivity notesActivity = (NotesActivity)getActivity();
 430             Simplenote application = (Simplenote) notesActivity.getApplication();
 431             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 432             try {
 433                 mNote = notesBucket.get(noteID);
 434                 notesActivity.setCurrentNote(mNote);
 435             } catch (BucketObjectMissingException e) {
 436                 // TODO: Handle a missing note
 437             }
 438             return null;
 439         }
 440 
 441         @Override
 442         protected void onPostExecute(Void nada) {
 443             refreshContent(false);
 444         }
 445     }
 446 
 447     private class saveNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 448 
 449         @Override
 450         protected Void doInBackground(String... args) {
 451             String content = mContentEditText.getText().toString();
 452             String tagString = mTagView.getText().toString();
 453             if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 454                 mNote.setContent(content);
 455                 mNote.setTagString(mTagView.getText().toString());
 456                 mNote.setModificationDate(Calendar.getInstance());
 457                 // Send pinned event to google analytics if changed
 458                 mNote.setPinned(mPinButton.isChecked());
 459                 mNote.save();
 460                 if (getActivity() != null) {
 461                     Tracker tracker = EasyTracker.getTracker();
 462                     if (mNote.isPinned() != mPinButton.isChecked())
<abbr title=" 463                         tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;pin_button&quot;, null);"> 463                         tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_noðŸ”µ</abbr>
 464                     tracker.sendEvent(&quot;note&quot;, &quot;edited_note&quot;, &quot;editor_save&quot;, null);
 465                 }
 466             }
 467 
 468             return null;
 469         }
 470     }
 471 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import java.util.ArrayList;
   4 import java.util.Calendar;
   5 import java.util.List;
   6 
   7 import android.app.Activity;
   8 import android.app.Fragment;
   9 import android.content.Context;
  10 import android.graphics.Typeface;
  11 import android.os.AsyncTask;
  12 import android.database.Cursor;
  13 import android.os.Bundle;
  14 import android.os.Handler;
  15 import android.text.Editable;
  16 import android.text.Spannable;
  17 import android.text.SpannableString;
  18 import android.text.Spanned;
  19 import android.text.TextUtils;
  20 import android.text.TextWatcher;
  21 import android.util.Log;
  22 import android.view.LayoutInflater;
  23 import android.view.View;
  24 import android.view.ViewGroup;
  25 import android.view.inputmethod.InputMethodManager;
  26 import android.widget.ArrayAdapter;
  27 import android.widget.BaseAdapter;
  28 import android.widget.CursorAdapter;
  29 import android.widget.EditText;
  30 import android.widget.FilterQueryProvider;
  31 import android.widget.Filterable;
  32 import android.widget.LinearLayout;
  33 import android.widget.ListAdapter;
  34 import android.widget.MultiAutoCompleteTextView.Tokenizer;
  35 import android.widget.TextView;
  36 import android.widget.ToggleButton;
  37 
  38 import com.automattic.simplenote.models.Note;
  39 import com.automattic.simplenote.models.Tag;
  40 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  41 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  42 import com.automattic.simplenote.utils.TypefaceSpan;
  43 import com.automattic.simplenote.utils.Typefaces;
  44 import com.google.analytics.tracking.android.EasyTracker;
  45 import com.google.analytics.tracking.android.Tracker;
  46 import com.simperium.client.Bucket;
  47 import com.simperium.client.Bucket.ObjectCursor;
  48 import com.simperium.client.BucketObjectMissingException;
  49 import com.simperium.client.Query;
  50 
  51 public class NoteEditorFragment extends Fragment implements TextWatcher, OnTagAddedListener {
  52 
  53     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  54     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  55 
  56     private Note mNote;
  57     private EditText mContentEditText;
  58     private TagsMultiAutoCompleteTextView mTagView;
  59     private ToggleButton mPinButton;
  60     private boolean mShowNoteTitle;
  61     private Handler mAutoSaveHandler;
  62     private LinearLayout mPlaceholderView;
  63     private CursorAdapter mAutocompleteAdapter;
  64     /**
  65      * Mandatory empty constructor for the fragment manager to instantiate the
  66      * fragment (e.g. upon screen orientation changes).
  67      */
  68     public NoteEditorFragment() {
  69     }
  70 
  71     @Override
  72     public void onCreate(Bundle savedInstanceState) {
  73         super.onCreate(savedInstanceState);
  74 
  75         if (!((NotesActivity) getActivity()).isLargeScreenLandscape())
  76             mShowNoteTitle = true;
  77 
  78         mAutoSaveHandler = new Handler();
  79 
  80 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81         mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83             @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84             public View newView(Context context, Cursor cursor, ViewGroup parent) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85                 Activity activity = (Activity) context;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86                 if (activity == null) return null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87                 return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90             @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91             public void bindView(View view, Context context, Cursor cursor) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92                 TextView textView = (TextView) view;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93                 textView.setText(convertToString(cursor));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96             @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97             public CharSequence convertToString(Cursor cursor){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98                 return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101             @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102             public Cursor runQueryOnBackgroundThread(CharSequence filter){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 103                 Log.v(Simplenote.TAG, String.format(&quot;runQueryOnBackgroundThread with filter: %s&quot;, filter));"> 103                 Log.v(Simplenote.TAG, String.format(&quot;runQueryOnBackgroundThread with filter: %s&quot;, filter)ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104                 Activity activity = (Activity) getActivity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105                 if (activity == null) return null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106                 Simplenote application = (Simplenote) activity.getApplication();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107                 Query&lt;Tag&gt; query = application.getTagsBucket().query();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108                 // make the tag name available to the cursor</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109                 query.include(Tag.NAME_PROPERTY);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110                 // sort the tags by their names</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111                 query.order(Tag.NAME_PROPERTY);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112                 // if there&#x27;s a filter string find only matching tag names</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 113                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 113                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.forðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114                 return query.execute();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116         };</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117 </span>
 118 ||||||| BASE
 119 =======
 120 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 121     }
 122 
 123     @Override
 124     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 125         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 126         mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));
 127         mContentEditText.addTextChangedListener(this);
<abbr title=" 128         mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 128         mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONTðŸ”µ</abbr>
 129         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 130         mTagView.setTokenizer(new SpaceTokenizer());
 131         mTagView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));
 132 
 133         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
 134         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
 135         if (((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;&amp; mNote == null)
 136             mPlaceholderView.setVisibility(View.VISIBLE);
 137 
 138         if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {
 139             String key = getArguments().getString(ARG_ITEM_ID);
 140             new loadNoteTask().execute(key);
 141         }
 142 
 143         mTagView.setAdapter(mAutocompleteAdapter);
 144 		return rootView;
 145 	}
 146 
 147     @Override
 148     public void onResume() {
 149         super.onResume();
 150         mTagView.setOnTagAddedListener(this);
 151         if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 152             // Show soft keyboard
 153             mContentEditText.requestFocus();
 154 
<abbr title=" 155             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 155             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(CðŸ”µ</abbr>
 156             if (inputMethodManager != null)
 157                 inputMethodManager.showSoftInput(mContentEditText, 0);
 158         }
 159     }
 160 
 161     @Override
 162     public void onPause() {
 163         saveAndSyncNote();
 164         mTagView.setOnTagAddedListener(null);
 165 
 166         if (mAutoSaveHandler != null)
 167             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 168 
 169         super.onPause();
 170     }
 171 
 172     public void setNote(String noteID) {
 173         mPlaceholderView.setVisibility(View.GONE);
 174 
 175         // If we have a note already (on a tablet in landscape), save the note.
 176         if (mNote != null)
 177             saveAndSyncNote();
 178 
 179         Simplenote simplenote = (Simplenote)getActivity().getApplication();
 180         Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 181         try {
 182             mNote = notesBucket.get(noteID);
 183         } catch (BucketObjectMissingException e) {
 184             e.printStackTrace();
 185         }
 186         refreshContent(false);
 187     }
 188 
 189     public void refreshContent(boolean isNoteUpdate) {
 190         if (mNote != null) {
 191             Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);
 192             // Restore the cursor position if possible.
 193 
<abbr title=" 194             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 194             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toStrinðŸ”µ</abbr>
 195             mContentEditText.setText(mNote.getContent());
<abbr title=" 196             if (isNoteUpdate &amp;&amp; mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())"> 196             if (isNoteUpdate &amp;&amp; mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSeleðŸ”µ</abbr>
 197                 mContentEditText.setSelection(cursorPosition);
 198 
 199             mPinButton.setChecked(mNote.isPinned());
 200 
 201             setActionBarTitle();
 202 
 203             updateTagList();
 204         }
 205     }
 206 
 207     public void updateTagList(){
 208         Activity activity = getActivity();
 209         if (activity == null) return;
 210 
 211         // Populate this note&#x27;s tags in the tagView
 212         mTagView.setChips(mNote.getTagString());
 213     }
 214 
 215     private void setActionBarTitle() {
 216         String title;
 217         if (mShowNoteTitle &amp;&amp; getActivity() != null) {
 218             if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))
 219                 title = mNote.getTitle();
 220             else
 221                 title = getString(R.string.new_note);
 222 
 223             SpannableString s = new SpannableString(title);
 224             s.setSpan(new TypefaceSpan(getActivity().getBaseContext()), 0, s.length(),
 225                     Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 226             getActivity().getActionBar().setTitle(s);
 227         }
 228     }
 229 
 230     int newCursorLocation(String newText, String oldText, int cursorLocation) {
 231         // Ported from the iOS app :)
 232         // Cases:
 233         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 234         // 1. Text was added after the cursor ==&gt; no change
 235         // 2. Text was added before the cursor ==&gt; location advances
 236         // 3. Text was removed after the cursor ==&gt; no change
 237         // 4. Text was removed before the cursor ==&gt; location retreats
 238         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 239 
 240         int newCursorLocation = cursorLocation;
 241 
 242         int deltaLength = newText.length() - oldText.length();
 243 
 244         // Case 0
 245         if (newText.length() &lt; cursorLocation)
 246             return newText.length();
 247 
 248         boolean beforeCursorMatches = false;
 249         boolean afterCursorMatches = false;
 250 
 251         try {
<abbr title=" 252             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 252             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorðŸ”µ</abbr>
<abbr title=" 253             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 253             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substðŸ”µ</abbr>
 254         } catch (Exception e) {
 255             e.printStackTrace();
 256         }
 257 
 258         // Cases 2 and 4
 259         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 260             newCursorLocation += deltaLength;
 261 
 262         // Cases 1, 3 and 5 have no change
 263         return newCursorLocation;
 264     }
 265 
 266     private Runnable autoSaveRunnable = new Runnable() {
 267         @Override
 268         public void run() {
 269             saveAndSyncNote();
 270         }
 271     };
 272 
 273     @Override
 274     public void onTagsChanged(String tagString){
 275         mNote.setTagString(tagString);
 276         mNote.setModificationDate(Calendar.getInstance());
 277         updateTagList();
 278         mNote.save();
 279         if (getActivity() != null)
 280             EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;added_tag&quot;, &quot;tag_added_to_note&quot;, null);
 281     }
 282 
 283     @Override
 284     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 285         // Unused
 286     }
 287 
 288     @Override
 289     public void afterTextChanged(Editable editable) {
 290         // Unused
 291 
 292     }
 293 
 294     @Override
 295     public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 296 
 297         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 298 
 299         if (mAutoSaveHandler != null) {
 300             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 301             mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 302         }
 303     }
 304 
 305     private void saveAndSyncNote() {
 306         if (mNote == null)
 307             return;
 308 
 309         new saveNoteTask().execute();
 310         setActionBarTitle();
 311 
 312         Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);
 313     }
 314 
 315     public void setPlaceholderVisible(boolean isVisible) {
 316         if (isVisible) {
 317             mNote = null;
 318             mContentEditText.setText(&quot;&quot;);
 319             mTagView.setText(&quot;&quot;);
 320             if (mPlaceholderView != null)
 321                 mPlaceholderView.setVisibility(View.VISIBLE);
 322         } else {
 323             if (mPlaceholderView != null)
 324                 mPlaceholderView.setVisibility(View.GONE);
 325         }
 326     }
 327 
 328     // Use spaces in tag autocompletion list
<abbr title=" 329     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 329     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-tðŸ”µ</abbr>
 330     public class SpaceTokenizer implements Tokenizer {
 331 
 332         public int findTokenStart(CharSequence text, int cursor) {
 333             int i = cursor;
 334 
 335             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {
 336                 i--;
 337             }
 338             while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {
 339                 i++;
 340             }
 341 
 342             return i;
 343         }
 344 
 345         public int findTokenEnd(CharSequence text, int cursor) {
 346             int i = cursor;
 347             int len = text.length();
 348 
 349             while (i &lt; len) {
 350                 if (text.charAt(i) == &#x27; &#x27;) {
 351                     return i;
 352                 } else {
 353                     i++;
 354                 }
 355             }
 356 
 357             return len;
 358         }
 359 
 360         public CharSequence terminateToken(CharSequence text) {
 361             int i = text.length();
 362 
 363             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 364                 i--;
 365             }
 366 
 367             if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 368                 return text;
 369             } else {
 370                 if (text instanceof Spanned) {
 371                     SpannableString sp = new SpannableString(text + &quot; &quot;);
 372                     TextUtils.copySpansFrom((Spanned) text, 0, text.length(),
 373                             Object.class, sp, 0);
 374                     return sp;
 375                 } else {
 376                     return text + &quot; &quot;;
 377                 }
 378             }
 379         }
 380     }
 381 
 382     private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 383 
 384         @Override
 385         protected Void doInBackground(String... args) {
 386             String noteID = args[0];
 387             NotesActivity notesActivity = (NotesActivity)getActivity();
 388             Simplenote application = (Simplenote) notesActivity.getApplication();
 389             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 390             try {
 391                 mNote = notesBucket.get(noteID);
 392                 notesActivity.setCurrentNote(mNote);
 393             } catch (BucketObjectMissingException e) {
 394                 // TODO: Handle a missing note
 395             }
 396             return null;
 397         }
 398 
 399         @Override
 400         protected void onPostExecute(Void nada) {
 401             refreshContent(false);
 402         }
 403     }
 404 
 405     private class saveNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 406 
 407         @Override
 408         protected Void doInBackground(String... args) {
 409             String content = mContentEditText.getText().toString();
 410             String tagString = mTagView.getText().toString();
 411             if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 412                 mNote.setContent(content);
 413                 mNote.setTagString(mTagView.getText().toString());
 414                 mNote.setModificationDate(Calendar.getInstance());
 415                 // Send pinned event to google analytics if changed
 416                 mNote.setPinned(mPinButton.isChecked());
 417                 mNote.save();
 418                 if (getActivity() != null) {
 419                     Tracker tracker = EasyTracker.getTracker();
 420                     if (mNote.isPinned() != mPinButton.isChecked())
<abbr title=" 421                         tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;pin_button&quot;, null);"> 421                         tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_noðŸ”µ</abbr>
 422                     tracker.sendEvent(&quot;note&quot;, &quot;edited_note&quot;, &quot;editor_save&quot;, null);
 423                 }
 424             }
 425 
 426             return null;
 427         }
 428     }
 429 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.Context;
   6 import android.database.Cursor;
   7 import android.graphics.Typeface;
   8 import android.os.AsyncTask;
   9 import android.os.Bundle;
  10 import android.os.Handler;
  11 import android.text.Editable;
  12 import android.text.Spannable;
  13 import android.text.SpannableString;
  14 import android.text.Spanned;
  15 import android.text.TextUtils;
  16 import android.text.TextWatcher;
  17 import android.util.Log;
  18 import android.view.LayoutInflater;
  19 import android.view.View;
  20 import android.view.ViewGroup;
  21 import android.view.inputmethod.InputMethodManager;
  22 import android.widget.ArrayAdapter;
  23 import android.widget.BaseAdapter;
  24 import android.widget.CursorAdapter;
  25 import android.widget.EditText;
  26 import android.widget.FilterQueryProvider;
  27 import android.widget.Filterable;
  28 import android.widget.LinearLayout;
  29 import android.widget.ListAdapter;
  30 import android.widget.MultiAutoCompleteTextView.Tokenizer;
  31 import android.widget.TextView;
  32 import android.widget.ToggleButton;
  33 import com.automattic.simplenote.models.Note;
  34 import com.automattic.simplenote.models.Tag;
  35 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  36 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  37 import com.automattic.simplenote.utils.TypefaceSpan;
  38 import com.automattic.simplenote.utils.Typefaces;
  39 import com.google.analytics.tracking.android.EasyTracker;
  40 import com.google.analytics.tracking.android.Tracker;
  41 import com.simperium.client.Bucket.ObjectCursor;
  42 import com.simperium.client.Bucket;
  43 import com.simperium.client.BucketObjectMissingException;
  44 import com.simperium.client.Query;
  45 import java.util.ArrayList;
  46 import java.util.Calendar;
  47 import java.util.List;
  48 
  49 
  50 public class NoteEditorFragment extends Fragment implements TextWatcher , OnTagAddedListener {
  51     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  52 
  53     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  54 
  55     private Note mNote;
  56 
  57     private EditText mContentEditText;
  58 
  59     private TagsMultiAutoCompleteTextView mTagView;
  60 
  61     private ToggleButton mPinButton;
  62 
  63     private boolean mShowNoteTitle;
  64 
  65     private Handler mAutoSaveHandler;
  66 
  67     private LinearLayout mPlaceholderView;
  68 
  69     private CursorAdapter mAutocompleteAdapter;
  70 
  71     /**
  72      * Mandatory empty constructor for the fragment manager to instantiate the
  73      * fragment (e.g. upon screen orientation changes).
  74      */
  75     public NoteEditorFragment() {
  76     }
  77 
  78     @Override
  79     public void onCreate(Bundle savedInstanceState) {
  80         super.onCreate(savedInstanceState);
  81         if (!((NotesActivity) (getActivity())).isLargeScreenLandscape()) {
  82             mShowNoteTitle = true;
  83         }
  84         mAutoSaveHandler = new Handler();
  85         mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0) {
  86             @Override
  87             public View newView(Context context, Cursor cursor, ViewGroup parent) {
  88                 Activity activity = ((Activity) (context));
  89                 if (activity == null) {
  90                     return null;
  91                 }
  92                 return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
  93             }
  94 
  95             @Override
  96             public void bindView(View view, Context context, Cursor cursor) {
  97                 TextView textView = ((TextView) (view));
  98                 textView.setText(convertToString(cursor));
  99             }
 100 
 101             @Override
 102             public CharSequence convertToString(Cursor cursor){
 103                 return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 104             }
 105 
 106             @Override
 107             public Cursor runQueryOnBackgroundThread(CharSequence filter) {
<abbr title=" 108                 Log.v(Simplenote.TAG, String.format(&quot;runQueryOnBackgroundThread with filter: %s&quot;, filter));"> 108                 Log.v(Simplenote.TAG, String.format(&quot;runQueryOnBackgroundThread with filter: %s&quot;, filter)ðŸ”µ</abbr>
 109                 Activity activity = ((Activity) (getActivity()));
 110                 if (activity == null) {
 111                     return null;
 112                 }
 113                 Simplenote application = ((Simplenote) (activity.getApplication()));
 114                 Query&lt;Tag&gt; query = application.getTagsBucket().query();
 115                 // make the tag name available to the cursor
 116                 query.include(Tag.NAME_PROPERTY);
 117                 // sort the tags by their names
 118                 query.order(Tag.NAME_PROPERTY);
 119                 // if there&#x27;s a filter string find only matching tag names
 120                 if (filter != null) {
<abbr title=" 121                     query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 121                     query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filteðŸ”µ</abbr>
 122                 }
 123                 return query.execute();
 124             }
 125         };
 126     }
 127 
 128     @Override
 129     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 130         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 131         mContentEditText = ((EditText) (rootView.findViewById(R.id.note_content)));
 132         mContentEditText.addTextChangedListener(this);
<abbr title=" 133         mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 133         mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONTðŸ”µ</abbr>
 134         mTagView = ((TagsMultiAutoCompleteTextView) (rootView.findViewById(R.id.tag_view)));
 135         mTagView.setTokenizer(new SpaceTokenizer());
 136         mTagView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));
 137         mPinButton = ((ToggleButton) (rootView.findViewById(R.id.pinButton)));
 138         mPlaceholderView = ((LinearLayout) (rootView.findViewById(R.id.placeholder)));
 139         if (((NotesActivity) (getActivity())).isLargeScreenLandscape() &amp;&amp; (mNote == null)) {
 140             mPlaceholderView.setVisibility(View.VISIBLE);
 141         }
 142         if ((getArguments() != null) &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {
 143             String key = getArguments().getString(ARG_ITEM_ID);
 144             new loadNoteTask().execute(key);
 145         }
 146         mTagView.setAdapter(mAutocompleteAdapter);
 147         return rootView;
 148     }
 149 
 150     @Override
 151     public void onResume() {
 152         super.onResume();
 153         mTagView.setOnTagAddedListener(this);
 154         if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 155             // Show soft keyboard
 156             mContentEditText.requestFocus();
 157 
<abbr title=" 158             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 158             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(CðŸ”µ</abbr>
 159             if (inputMethodManager != null)
 160                 inputMethodManager.showSoftInput(mContentEditText, 0);
 161         }
 162     }
 163 
 164     @Override
 165     public void onPause() {
 166         saveAndSyncNote();
 167         mTagView.setOnTagAddedListener(null);
 168 
 169         if (mAutoSaveHandler != null)
 170             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 171 
 172         super.onPause();
 173     }
 174 
 175     public void setNote(String noteID) {
 176         mPlaceholderView.setVisibility(View.GONE);
 177 
 178         // If we have a note already (on a tablet in landscape), save the note.
 179         if (mNote != null)
 180             saveAndSyncNote();
 181 
 182         Simplenote simplenote = (Simplenote)getActivity().getApplication();
 183         Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 184         try {
 185             mNote = notesBucket.get(noteID);
 186         } catch (BucketObjectMissingException e) {
 187             e.printStackTrace();
 188         }
 189         refreshContent(false);
 190     }
 191 
 192     public void refreshContent(boolean isNoteUpdate) {
 193         if (mNote != null) {
 194             Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);
 195             // Restore the cursor position if possible.
 196 
<abbr title=" 197             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 197             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toStrinðŸ”µ</abbr>
 198             mContentEditText.setText(mNote.getContent());
<abbr title=" 199             if (isNoteUpdate &amp;&amp; mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())"> 199             if (isNoteUpdate &amp;&amp; mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSeleðŸ”µ</abbr>
 200                 mContentEditText.setSelection(cursorPosition);
 201 
 202             mPinButton.setChecked(mNote.isPinned());
 203 
 204             setActionBarTitle();
 205 
 206             updateTagList();
 207         }
 208     }
 209 
 210     public void updateTagList() {
 211         Activity activity = getActivity();
 212         if (activity == null) {
 213             return;
 214         }
 215         // Populate this note&#x27;s tags in the tagView
 216         mTagView.setChips(mNote.getTagString());
 217     }
 218 
 219     private void setActionBarTitle() {
 220         String title;
 221         if (mShowNoteTitle &amp;&amp; (getActivity() != null)) {
 222             if ((mNote.getTitle() != null) &amp;&amp; (!mNote.getTitle().equals(&quot;&quot;))) {
 223                 title = mNote.getTitle();
 224             } else {
 225                 title = getString(R.string.new_note);
 226             }
 227             SpannableString s = new SpannableString(title);
<abbr title=" 228             s.setSpan(new TypefaceSpan(getActivity().getBaseContext()), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);"> 228             s.setSpan(new TypefaceSpan(getActivity().getBaseContext()), 0, s.length(), Spannable.SPAN_EXCðŸ”µ</abbr>
 229             getActivity().getActionBar().setTitle(s);
 230         }
 231     }
 232 
 233     int newCursorLocation(String newText, String oldText, int cursorLocation) {
 234         // Ported from the iOS app :)
 235         // Cases:
 236         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 237         // 1. Text was added after the cursor ==&gt; no change
 238         // 2. Text was added before the cursor ==&gt; location advances
 239         // 3. Text was removed after the cursor ==&gt; no change
 240         // 4. Text was removed before the cursor ==&gt; location retreats
 241         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 242 
 243         int newCursorLocation = cursorLocation;
 244 
 245         int deltaLength = newText.length() - oldText.length();
 246 
 247         // Case 0
 248         if (newText.length() &lt; cursorLocation)
 249             return newText.length();
 250 
 251         boolean beforeCursorMatches = false;
 252         boolean afterCursorMatches = false;
 253 
 254         try {
<abbr title=" 255             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 255             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorðŸ”µ</abbr>
<abbr title=" 256             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 256             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substðŸ”µ</abbr>
 257         } catch (Exception e) {
 258             e.printStackTrace();
 259         }
 260 
 261         // Cases 2 and 4
 262         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 263             newCursorLocation += deltaLength;
 264 
 265         // Cases 1, 3 and 5 have no change
 266         return newCursorLocation;
 267     }
 268 
 269     private Runnable autoSaveRunnable = new Runnable() {
 270         @Override
 271         public void run() {
 272             saveAndSyncNote();
 273         }
 274     };
 275 
 276     @Override
 277     public void onTagsChanged(String tagString){
 278         mNote.setTagString(tagString);
 279         mNote.setModificationDate(Calendar.getInstance());
 280         updateTagList();
 281         mNote.save();
 282         if (getActivity() != null)
 283             EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;added_tag&quot;, &quot;tag_added_to_note&quot;, null);
 284     }
 285 
 286     @Override
 287     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 288         // Unused
 289     }
 290 
 291     @Override
 292     public void afterTextChanged(Editable editable) {
 293         // Unused
 294 
 295     }
 296 
 297     @Override
 298     public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 299 
 300         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 301 
 302         if (mAutoSaveHandler != null) {
 303             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 304             mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 305         }
 306     }
 307 
 308     private void saveAndSyncNote() {
 309         if (mNote == null)
 310             return;
 311 
 312         new saveNoteTask().execute();
 313         setActionBarTitle();
 314 
 315         Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);
 316     }
 317 
 318     public void setPlaceholderVisible(boolean isVisible) {
 319         if (isVisible) {
 320             mNote = null;
 321             mContentEditText.setText(&quot;&quot;);
 322             mTagView.setText(&quot;&quot;);
 323             if (mPlaceholderView != null)
 324                 mPlaceholderView.setVisibility(View.VISIBLE);
 325         } else {
 326             if (mPlaceholderView != null)
 327                 mPlaceholderView.setVisibility(View.GONE);
 328         }
 329     }
 330 
 331     // Use spaces in tag autocompletion list
<abbr title=" 332     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 332     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-tðŸ”µ</abbr>
 333     public class SpaceTokenizer implements Tokenizer {
 334         public int findTokenStart(CharSequence text, int cursor) {
 335             int i = cursor;
 336             while ((i &gt; 0) &amp;&amp; (text.charAt(i - 1) != &#x27; &#x27;)) {
 337                 i--;
 338             }
 339             while ((i &lt; cursor) &amp;&amp; (text.charAt(i) == &#x27; &#x27;)) {
 340                 i++;
 341             }
 342             return i;
 343         }
 344 
 345         public int findTokenEnd(CharSequence text, int cursor) {
 346             int i = cursor;
 347             int len = text.length();
 348             while (i &lt; len) {
 349                 if (text.charAt(i) == &#x27; &#x27;) {
 350                     return i;
 351                 } else {
 352                     i++;
 353                 }
 354             }
 355             return len;
 356         }
 357 
 358         public CharSequence terminateToken(CharSequence text) {
 359             int i = text.length();
 360             while ((i &gt; 0) &amp;&amp; (text.charAt(i - 1) == &#x27; &#x27;)) {
 361                 i--;
 362             }
 363             if ((i &gt; 0) &amp;&amp; (text.charAt(i - 1) == &#x27; &#x27;)) {
 364                 return text;
 365             } else if (text instanceof Spanned) {
 366                 SpannableString sp = new SpannableString(text + &quot; &quot;);
<abbr title=" 367                 TextUtils.copySpansFrom(((Spanned) (text)), 0, text.length(), java.lang.Object.class, sp, 0);"> 367                 TextUtils.copySpansFrom(((Spanned) (text)), 0, text.length(), java.lang.Object.class, sp,ðŸ”µ</abbr>
 368                 return sp;
 369             } else {
 370                 return text + &quot; &quot;;
 371             }
 372         }
 373     }
 374 
 375     private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 376         @Override
 377         protected Void doInBackground(String... args) {
 378             String noteID = args[0];
 379             NotesActivity notesActivity = ((NotesActivity) (getActivity()));
 380             Simplenote application = ((Simplenote) (notesActivity.getApplication()));
 381             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 382             try {
 383                 mNote = notesBucket.get(noteID);
 384                 notesActivity.setCurrentNote(mNote);
 385             } catch (BucketObjectMissingException e) {
 386                 // TODO: Handle a missing note
 387             }
 388             return null;
 389         }
 390 
 391         @Override
 392         protected void onPostExecute(Void nada) {
 393             refreshContent(false);
 394         }
 395     }
 396 
 397     private class saveNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 398         @Override
 399         protected Void doInBackground(String... args) {
 400             String content = mContentEditText.getText().toString();
 401             String tagString = mTagView.getText().toString();
 402             if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 403                 mNote.setContent(content);
 404                 mNote.setTagString(mTagView.getText().toString());
 405                 mNote.setModificationDate(Calendar.getInstance());
 406                 // Send pinned event to google analytics if changed
 407                 mNote.setPinned(mPinButton.isChecked());
 408                 mNote.save();
 409                 if (getActivity() != null) {
 410                     Tracker tracker = EasyTracker.getTracker();
 411                     if (mNote.isPinned() != mPinButton.isChecked()) {
<abbr title=" 412                         tracker.sendEvent(&quot;note&quot;, mPinButton.isChecked() ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;pin_button&quot;, null);"> 412                         tracker.sendEvent(&quot;note&quot;, mPinButton.isChecked() ? &quot;pinned_note&quot; : &quot;unpinned_noteðŸ”µ</abbr>
 413                     }
 414                     tracker.sendEvent(&quot;note&quot;, &quot;edited_note&quot;, &quot;editor_save&quot;, null);
 415                 }
 416             }
 417             return null;
 418         }
 419     }
 420 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import java.util.ArrayList;
   4  import java.util.Calendar;
   5  import java.util.List;
   6  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 +import android.app.Activity;</span>
   8  import android.app.Fragment;
   9  import android.content.Context;

  10  import android.os.AsyncTask;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 +import android.database.Cursor;</span>
  12  import android.os.Bundle;
  13  import android.os.Handler;
  14  import android.text.Editable;

  15  import android.text.SpannableString;
  16  import android.text.Spanned;
  17  import android.text.TextUtils;
  18  import android.text.TextWatcher;
  19  import android.util.Log;
  20  import android.view.LayoutInflater;
  21  import android.view.View;
  22  import android.view.ViewGroup;
  23  import android.view.inputmethod.InputMethodManager;
  24  import android.widget.ArrayAdapter;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import android.widget.BaseAdapter;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import android.widget.CursorAdapter;</span>
  27  import android.widget.EditText;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import android.widget.FilterQueryProvider;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import android.widget.Filterable;</span>
  30  import android.widget.LinearLayout;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import android.widget.ListAdapter;</span>
  32  import android.widget.MultiAutoCompleteTextView.Tokenizer;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import android.widget.TextView;</span>
  34  import android.widget.ToggleButton;
  35  
  36  import com.automattic.simplenote.models.Note;
  37  import com.automattic.simplenote.models.Tag;
  38  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  39  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;


  40  import com.google.analytics.tracking.android.EasyTracker;
  41  import com.google.analytics.tracking.android.Tracker;
  42  import com.simperium.client.Bucket;
  43  import com.simperium.client.Bucket.ObjectCursor;
  44  import com.simperium.client.BucketObjectMissingException;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import com.simperium.client.Query;</span>
  46  
  47  public class NoteEditorFragment extends Fragment implements TextWatcher, OnTagAddedListener {
  48  
  49      public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  50      private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  51  
  52      private Note mNote;
  53      private EditText mContentEditText;
  54      private TagsMultiAutoCompleteTextView mTagView;
  55      private ToggleButton mPinButton;
  56      private boolean mShowNoteTitle;
  57      private Handler mAutoSaveHandler;
  58      private LinearLayout mPlaceholderView;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +    private CursorAdapter mAutocompleteAdapter;</span>
  61      /**
  62       * Mandatory empty constructor for the fragment manager to instantiate the
  63       * fragment (e.g. upon screen orientation changes).
  64       */
  65      public NoteEditorFragment() {
  66      }
  67  
  68      @Override
  69      public void onCreate(Bundle savedInstanceState) {
  70          super.onCreate(savedInstanceState);
  71  
  72          if (!((NotesActivity) getActivity()).isLargeScreenLandscape())
  73              mShowNoteTitle = true;
  74  
  75          mAutoSaveHandler = new Handler();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +        mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +            public View newView(Context context, Cursor cursor, ViewGroup parent) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +                Activity activity = (Activity) context;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +                if (activity == null) return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +                return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +            public void bindView(View view, Context context, Cursor cursor) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +                TextView textView = (TextView) view;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +                textView.setText(convertToString(cursor));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +            public CharSequence convertToString(Cursor cursor){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +                return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +            public Cursor runQueryOnBackgroundThread(CharSequence filter){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +                Log.v(Simplenote.TAG, String.format(&quot;runQueryOnBackgroundThread with filter: %s&quot;, filter));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +                Activity activity = (Activity) getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +                if (activity == null) return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +                Simplenote application = (Simplenote) activity.getApplication();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +                Query&lt;Tag&gt; query = application.getTagsBucket().query();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +                // make the tag name available to the cursor</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +                query.include(Tag.NAME_PROPERTY);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +                // sort the tags by their names</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +                query.order(Tag.NAME_PROPERTY);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +                // if there&#x27;s a filter string find only matching tag names</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 109 +                if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 109 +                if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +                return query.execute();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +        };</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +</span>
 114      }
 115  
 116      @Override
 117      public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 118          View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 119          mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));
 120          mContentEditText.addTextChangedListener(this);

 121          mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 122          mTagView.setTokenizer(new SpaceTokenizer());

 123  
 124          mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
 125          mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
 126          if (((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;&amp; mNote == null)
 127              mPlaceholderView.setVisibility(View.VISIBLE);
 128  
 129          if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {
 130              String key = getArguments().getString(ARG_ITEM_ID);
 131              new loadNoteTask().execute(key);
 132          }
 133  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +        mTagView.setAdapter(mAutocompleteAdapter);</span>
 135  		return rootView;
 136  	}
 137  
 138      @Override
 139      public void onResume() {
 140          super.onResume();
 141          mTagView.setOnTagAddedListener(this);
 142          if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 143              // Show soft keyboard
 144              mContentEditText.requestFocus();
 145  
<abbr title=" 146              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 146              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INðŸ”µ</abbr>
 147              if (inputMethodManager != null)
 148                  inputMethodManager.showSoftInput(mContentEditText, 0);
 149          }
 150      }
 151  
 152      @Override
 153      public void onPause() {
 154          saveAndSyncNote();
 155          mTagView.setOnTagAddedListener(null);
 156  
 157          if (mAutoSaveHandler != null)
 158              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 159  
 160          super.onPause();
 161      }
 162  
 163      public void setNote(String noteID) {
 164          mPlaceholderView.setVisibility(View.GONE);
 165  
 166          // If we have a note already (on a tablet in landscape), save the note.
 167          if (mNote != null)
 168              saveAndSyncNote();
 169  
 170          Simplenote simplenote = (Simplenote)getActivity().getApplication();
 171          Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 172          try {
 173              mNote = notesBucket.get(noteID);
 174          } catch (BucketObjectMissingException e) {
 175              e.printStackTrace();
 176          }
 177          refreshContent(false);
 178      }
 179  
 180      public void refreshContent(boolean isNoteUpdate) {
 181          if (mNote != null) {
 182              Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);
 183              // Restore the cursor position if possible.
 184  
<abbr title=" 185              int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 185              int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mConðŸ”µ</abbr>
 186              mContentEditText.setText(mNote.getContent());
<abbr title=" 187              if (isNoteUpdate &amp;&amp; mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())"> 187              if (isNoteUpdate &amp;&amp; mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd(ðŸ”µ</abbr>
 188                  mContentEditText.setSelection(cursorPosition);
 189  
 190              mPinButton.setChecked(mNote.isPinned());
 191  
 192              setActionBarTitle();
 193  
 194              updateTagList();
 195          }
 196      }
 197  
 198      public void updateTagList(){
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +        Activity activity = getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +        if (activity == null) return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +</span>
 202          // Populate this note&#x27;s tags in the tagView
 203          mTagView.setChips(mNote.getTagString());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -        new setTagsAdapterTask().execute();</span>
 206      }
 207  
 208      private void setActionBarTitle() {
 209          if (mShowNoteTitle) {


 210              if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))
 211                  getActivity().getActionBar().setTitle(mNote.getTitle());

 212              else
 213                  getActivity().getActionBar().setTitle(R.string.new_note);






 214          }
 215      }
 216  
 217      int newCursorLocation(String newText, String oldText, int cursorLocation) {
 218          // Ported from the iOS app :)
 219          // Cases:
 220          // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 221          // 1. Text was added after the cursor ==&gt; no change
 222          // 2. Text was added before the cursor ==&gt; location advances
 223          // 3. Text was removed after the cursor ==&gt; no change
 224          // 4. Text was removed before the cursor ==&gt; location retreats
 225          // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 226  
 227          int newCursorLocation = cursorLocation;
 228  
 229          int deltaLength = newText.length() - oldText.length();
 230  
 231          // Case 0
 232          if (newText.length() &lt; cursorLocation)
 233              return newText.length();
 234  
 235          boolean beforeCursorMatches = false;
 236          boolean afterCursorMatches = false;
 237  
 238          try {
<abbr title=" 239              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 239              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation)ðŸ”µ</abbr>
<abbr title=" 240              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 240              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursðŸ”µ</abbr>
 241          } catch (Exception e) {
 242              e.printStackTrace();
 243          }
 244  
 245          // Cases 2 and 4
 246          if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 247              newCursorLocation += deltaLength;
 248  
 249          // Cases 1, 3 and 5 have no change
 250          return newCursorLocation;
 251      }
 252  
 253      private Runnable autoSaveRunnable = new Runnable() {
 254          @Override
 255          public void run() {
 256              saveAndSyncNote();
 257          }
 258      };
 259  
 260      @Override
 261      public void onTagsChanged(String tagString){
 262          mNote.setTagString(tagString);
 263          mNote.setModificationDate(Calendar.getInstance());
 264          updateTagList();
 265          mNote.save();
 266          if (getActivity() != null)
 267              EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;added_tag&quot;, &quot;tag_added_to_note&quot;, null);
 268      }
 269  
 270      @Override
 271      public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 272          // Unused
 273      }
 274  
 275      @Override
 276      public void afterTextChanged(Editable editable) {
 277          // Unused
 278  
 279      }
 280  
 281      @Override
 282      public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 283  
 284          // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 285  
 286          if (mAutoSaveHandler != null) {
 287              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 288              mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 289          }
 290      }
 291  
 292      private void saveAndSyncNote() {
 293          if (mNote == null)
 294              return;
 295  
 296          new saveNoteTask().execute();
 297          setActionBarTitle();
 298  
 299          Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);
 300      }
 301  
 302      public void setPlaceholderVisible(boolean isVisible) {
 303          if (isVisible) {
 304              mNote = null;
 305              mContentEditText.setText(&quot;&quot;);
 306              mTagView.setText(&quot;&quot;);
 307              if (mPlaceholderView != null)
 308                  mPlaceholderView.setVisibility(View.VISIBLE);
 309          } else {
 310              if (mPlaceholderView != null)
 311                  mPlaceholderView.setVisibility(View.GONE);
 312          }
 313      }
 314  
 315      // Use spaces in tag autocompletion list
<abbr title=" 316      // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 316      // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiaðŸ”µ</abbr>
 317      public class SpaceTokenizer implements Tokenizer {
 318  
 319          public int findTokenStart(CharSequence text, int cursor) {
 320              int i = cursor;
 321  
 322              while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {
 323                  i--;
 324              }
 325              while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {
 326                  i++;
 327              }
 328  
 329              return i;
 330          }
 331  
 332          public int findTokenEnd(CharSequence text, int cursor) {
 333              int i = cursor;
 334              int len = text.length();
 335  
 336              while (i &lt; len) {
 337                  if (text.charAt(i) == &#x27; &#x27;) {
 338                      return i;
 339                  } else {
 340                      i++;
 341                  }
 342              }
 343  
 344              return len;
 345          }
 346  
 347          public CharSequence terminateToken(CharSequence text) {
 348              int i = text.length();
 349  
 350              while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 351                  i--;
 352              }
 353  
 354              if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 355                  return text;
 356              } else {
 357                  if (text instanceof Spanned) {
 358                      SpannableString sp = new SpannableString(text + &quot; &quot;);
 359                      TextUtils.copySpansFrom((Spanned) text, 0, text.length(),
 360                              Object.class, sp, 0);
 361                      return sp;
 362                  } else {
 363                      return text + &quot; &quot;;
 364                  }
 365              }
 366          }
 367      }
 368  
 369      private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 370  
 371          @Override
 372          protected Void doInBackground(String... args) {
 373              String noteID = args[0];
 374              NotesActivity notesActivity = (NotesActivity)getActivity();
 375              Simplenote application = (Simplenote) notesActivity.getApplication();
 376              Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 377              try {
 378                  mNote = notesBucket.get(noteID);
 379                  notesActivity.setCurrentNote(mNote);
 380              } catch (BucketObjectMissingException e) {
 381                  // TODO: Handle a missing note
 382              }
 383              return null;
 384          }
 385  
 386          @Override
 387          protected void onPostExecute(Void nada) {
 388              refreshContent(false);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 389 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 390 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 391 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 392 -    private class setTagsAdapterTask extends AsyncTask&lt;Void, List, List&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 393 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 394 -        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 395 -        protected List doInBackground(Void... voids) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -            // Populate tag list</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -            if (getActivity() == null)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -                return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -            Simplenote simplenote = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -            Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 401 -            ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().include(Tag.NAME_PROPERTY, Tag.NOTE_COUNT_INDEX_NAME).orderByKey().execute();"> 401 -            ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().include(Tag.NAME_PROPERTY, Tag.NOTE_COUNT_INDEX_NAME)ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -            List&lt;String&gt; allTags = new ArrayList&lt;String&gt;(tagsCursor.getCount());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 403 -            int nameColumnIndex = tagsCursor.getColumnIndex(Tag.NAME_PROPERTY);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -            while (tagsCursor.moveToNext()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -                if (!mNote.hasTag(tagsCursor.getSimperiumKey()))</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -                    allTags.add(tagsCursor.getString(nameColumnIndex));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -            tagsCursor.close();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -            return allTags;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -        protected void onPostExecute(List tags) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -            if (tags != null &amp;&amp; tags.size() &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -                ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -                        android.R.layout.simple_dropdown_item_1line, tags);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 417 -                mTagView.setAdapter(adapter);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 418 -            }</span>
 419          }
 420      }
 421  
 422      private class saveNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 423  
 424          @Override
 425          protected Void doInBackground(String... args) {
 426              String content = mContentEditText.getText().toString();
 427              String tagString = mTagView.getText().toString();
 428              if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 429                  mNote.setContent(content);
 430                  mNote.setTagString(mTagView.getText().toString());
 431                  mNote.setModificationDate(Calendar.getInstance());
 432                  // Send pinned event to google analytics if changed
 433                  mNote.setPinned(mPinButton.isChecked());
 434                  mNote.save();
 435                  if (getActivity() != null) {
 436                      Tracker tracker = EasyTracker.getTracker();
 437                      if (mNote.isPinned() != mPinButton.isChecked())
<abbr title=" 438                          tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;pin_button&quot;, null);"> 438                          tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;pinðŸ”µ</abbr>
 439                      tracker.sendEvent(&quot;note&quot;, &quot;edited_note&quot;, &quot;editor_save&quot;, null);
 440                  }
 441              }
 442  
 443              return null;
 444          }
 445      }
 446  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import java.util.ArrayList;
   4  import java.util.Calendar;
   5  import java.util.List;
   6  

   7  import android.app.Fragment;
   8  import android.content.Context;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 +import android.graphics.Typeface;</span>
  10  import android.os.AsyncTask;

  11  import android.os.Bundle;
  12  import android.os.Handler;
  13  import android.text.Editable;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 +import android.text.Spannable;</span>
  15  import android.text.SpannableString;
  16  import android.text.Spanned;
  17  import android.text.TextUtils;
  18  import android.text.TextWatcher;
  19  import android.util.Log;
  20  import android.view.LayoutInflater;
  21  import android.view.View;
  22  import android.view.ViewGroup;
  23  import android.view.inputmethod.InputMethodManager;
  24  import android.widget.ArrayAdapter;


  25  import android.widget.EditText;


  26  import android.widget.LinearLayout;

  27  import android.widget.MultiAutoCompleteTextView.Tokenizer;

  28  import android.widget.ToggleButton;
  29  
  30  import com.automattic.simplenote.models.Note;
  31  import com.automattic.simplenote.models.Tag;
  32  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  33  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import com.automattic.simplenote.utils.TypefaceSpan;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import com.automattic.simplenote.utils.Typefaces;</span>
  36  import com.google.analytics.tracking.android.EasyTracker;
  37  import com.google.analytics.tracking.android.Tracker;
  38  import com.simperium.client.Bucket;
  39  import com.simperium.client.Bucket.ObjectCursor;
  40  import com.simperium.client.BucketObjectMissingException;

  41  
  42  public class NoteEditorFragment extends Fragment implements TextWatcher, OnTagAddedListener {
  43  
  44      public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  45      private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  46  
  47      private Note mNote;
  48      private EditText mContentEditText;
  49      private TagsMultiAutoCompleteTextView mTagView;
  50      private ToggleButton mPinButton;
  51      private boolean mShowNoteTitle;
  52      private Handler mAutoSaveHandler;
  53      private LinearLayout mPlaceholderView;
  54  

  55      /**
  56       * Mandatory empty constructor for the fragment manager to instantiate the
  57       * fragment (e.g. upon screen orientation changes).
  58       */
  59      public NoteEditorFragment() {
  60      }
  61  
  62      @Override
  63      public void onCreate(Bundle savedInstanceState) {
  64          super.onCreate(savedInstanceState);
  65  
  66          if (!((NotesActivity) getActivity()).isLargeScreenLandscape())
  67              mShowNoteTitle = true;
  68  
  69          mAutoSaveHandler = new Handler();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +</span>





































  71      }
  72  
  73      @Override
  74      public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
  75          View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
  76          mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));
  77          mContentEditText.addTextChangedListener(this);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +        mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));</span>
  79          mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
  80          mTagView.setTokenizer(new SpaceTokenizer());
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +        mTagView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));</span>
  82  
  83          mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
  84          mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
  85          if (((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;&amp; mNote == null)
  86              mPlaceholderView.setVisibility(View.VISIBLE);
  87  
  88          if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {
  89              String key = getArguments().getString(ARG_ITEM_ID);
  90              new loadNoteTask().execute(key);
  91          }
  92  

  93  		return rootView;
  94  	}
  95  
  96      @Override
  97      public void onResume() {
  98          super.onResume();
  99          mTagView.setOnTagAddedListener(this);
 100          if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 101              // Show soft keyboard
 102              mContentEditText.requestFocus();
 103  
<abbr title=" 104              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 104              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INðŸ”µ</abbr>
 105              if (inputMethodManager != null)
 106                  inputMethodManager.showSoftInput(mContentEditText, 0);
 107          }
 108      }
 109  
 110      @Override
 111      public void onPause() {
 112          saveAndSyncNote();
 113          mTagView.setOnTagAddedListener(null);
 114  
 115          if (mAutoSaveHandler != null)
 116              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 117  
 118          super.onPause();
 119      }
 120  
 121      public void setNote(String noteID) {
 122          mPlaceholderView.setVisibility(View.GONE);
 123  
 124          // If we have a note already (on a tablet in landscape), save the note.
 125          if (mNote != null)
 126              saveAndSyncNote();
 127  
 128          Simplenote simplenote = (Simplenote)getActivity().getApplication();
 129          Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 130          try {
 131              mNote = notesBucket.get(noteID);
 132          } catch (BucketObjectMissingException e) {
 133              e.printStackTrace();
 134          }
 135          refreshContent(false);
 136      }
 137  
 138      public void refreshContent(boolean isNoteUpdate) {
 139          if (mNote != null) {
 140              Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);
 141              // Restore the cursor position if possible.
 142  
<abbr title=" 143              int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 143              int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mConðŸ”µ</abbr>
 144              mContentEditText.setText(mNote.getContent());
<abbr title=" 145              if (isNoteUpdate &amp;&amp; mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())"> 145              if (isNoteUpdate &amp;&amp; mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd(ðŸ”µ</abbr>
 146                  mContentEditText.setSelection(cursorPosition);
 147  
 148              mPinButton.setChecked(mNote.isPinned());
 149  
 150              setActionBarTitle();
 151  
 152              updateTagList();
 153          }
 154      }
 155  
 156      public void updateTagList(){



 157          // Populate this note&#x27;s tags in the tagView
 158          mTagView.setChips(mNote.getTagString());
 159  
 160          new setTagsAdapterTask().execute();
 161      }
 162  
 163      private void setActionBarTitle() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -        if (mShowNoteTitle) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +        String title;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +        if (mShowNoteTitle &amp;&amp; getActivity() != null) {</span>
 167              if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -                getActivity().getActionBar().setTitle(mNote.getTitle());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +                title = mNote.getTitle();</span>
 170              else
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -                getActivity().getActionBar().setTitle(R.string.new_note);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +                title = getString(R.string.new_note);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +            SpannableString s = new SpannableString(title);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +            s.setSpan(new TypefaceSpan(getActivity().getBaseContext()), 0, s.length(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +                    Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +            getActivity().getActionBar().setTitle(s);</span>
 178          }
 179      }
 180  
 181      int newCursorLocation(String newText, String oldText, int cursorLocation) {
 182          // Ported from the iOS app :)
 183          // Cases:
 184          // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 185          // 1. Text was added after the cursor ==&gt; no change
 186          // 2. Text was added before the cursor ==&gt; location advances
 187          // 3. Text was removed after the cursor ==&gt; no change
 188          // 4. Text was removed before the cursor ==&gt; location retreats
 189          // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 190  
 191          int newCursorLocation = cursorLocation;
 192  
 193          int deltaLength = newText.length() - oldText.length();
 194  
 195          // Case 0
 196          if (newText.length() &lt; cursorLocation)
 197              return newText.length();
 198  
 199          boolean beforeCursorMatches = false;
 200          boolean afterCursorMatches = false;
 201  
 202          try {
<abbr title=" 203              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 203              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation)ðŸ”µ</abbr>
<abbr title=" 204              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 204              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursðŸ”µ</abbr>
 205          } catch (Exception e) {
 206              e.printStackTrace();
 207          }
 208  
 209          // Cases 2 and 4
 210          if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 211              newCursorLocation += deltaLength;
 212  
 213          // Cases 1, 3 and 5 have no change
 214          return newCursorLocation;
 215      }
 216  
 217      private Runnable autoSaveRunnable = new Runnable() {
 218          @Override
 219          public void run() {
 220              saveAndSyncNote();
 221          }
 222      };
 223  
 224      @Override
 225      public void onTagsChanged(String tagString){
 226          mNote.setTagString(tagString);
 227          mNote.setModificationDate(Calendar.getInstance());
 228          updateTagList();
 229          mNote.save();
 230          if (getActivity() != null)
 231              EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;added_tag&quot;, &quot;tag_added_to_note&quot;, null);
 232      }
 233  
 234      @Override
 235      public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 236          // Unused
 237      }
 238  
 239      @Override
 240      public void afterTextChanged(Editable editable) {
 241          // Unused
 242  
 243      }
 244  
 245      @Override
 246      public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 247  
 248          // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 249  
 250          if (mAutoSaveHandler != null) {
 251              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 252              mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 253          }
 254      }
 255  
 256      private void saveAndSyncNote() {
 257          if (mNote == null)
 258              return;
 259  
 260          new saveNoteTask().execute();
 261          setActionBarTitle();
 262  
 263          Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);
 264      }
 265  
 266      public void setPlaceholderVisible(boolean isVisible) {
 267          if (isVisible) {
 268              mNote = null;
 269              mContentEditText.setText(&quot;&quot;);
 270              mTagView.setText(&quot;&quot;);
 271              if (mPlaceholderView != null)
 272                  mPlaceholderView.setVisibility(View.VISIBLE);
 273          } else {
 274              if (mPlaceholderView != null)
 275                  mPlaceholderView.setVisibility(View.GONE);
 276          }
 277      }
 278  
 279      // Use spaces in tag autocompletion list
<abbr title=" 280      // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 280      // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiaðŸ”µ</abbr>
 281      public class SpaceTokenizer implements Tokenizer {
 282  
 283          public int findTokenStart(CharSequence text, int cursor) {
 284              int i = cursor;
 285  
 286              while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {
 287                  i--;
 288              }
 289              while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {
 290                  i++;
 291              }
 292  
 293              return i;
 294          }
 295  
 296          public int findTokenEnd(CharSequence text, int cursor) {
 297              int i = cursor;
 298              int len = text.length();
 299  
 300              while (i &lt; len) {
 301                  if (text.charAt(i) == &#x27; &#x27;) {
 302                      return i;
 303                  } else {
 304                      i++;
 305                  }
 306              }
 307  
 308              return len;
 309          }
 310  
 311          public CharSequence terminateToken(CharSequence text) {
 312              int i = text.length();
 313  
 314              while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 315                  i--;
 316              }
 317  
 318              if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 319                  return text;
 320              } else {
 321                  if (text instanceof Spanned) {
 322                      SpannableString sp = new SpannableString(text + &quot; &quot;);
 323                      TextUtils.copySpansFrom((Spanned) text, 0, text.length(),
 324                              Object.class, sp, 0);
 325                      return sp;
 326                  } else {
 327                      return text + &quot; &quot;;
 328                  }
 329              }
 330          }
 331      }
 332  
 333      private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 334  
 335          @Override
 336          protected Void doInBackground(String... args) {
 337              String noteID = args[0];
 338              NotesActivity notesActivity = (NotesActivity)getActivity();
 339              Simplenote application = (Simplenote) notesActivity.getApplication();
 340              Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 341              try {
 342                  mNote = notesBucket.get(noteID);
 343                  notesActivity.setCurrentNote(mNote);
 344              } catch (BucketObjectMissingException e) {
 345                  // TODO: Handle a missing note
 346              }
 347              return null;
 348          }
 349  
 350          @Override
 351          protected void onPostExecute(Void nada) {
 352              refreshContent(false);
 353          }
 354      }
 355  
 356      private class setTagsAdapterTask extends AsyncTask&lt;Void, List, List&gt; {
 357  
 358          @Override
 359          protected List doInBackground(Void... voids) {
 360              // Populate tag list
 361              if (getActivity() == null)
 362                  return null;
 363              Simplenote simplenote = (Simplenote)getActivity().getApplication();
 364              Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();
<abbr title=" 365              ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().include(Tag.NAME_PROPERTY, Tag.NOTE_COUNT_INDEX_NAME).orderByKey().execute();"> 365              ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().include(Tag.NAME_PROPERTY, Tag.NOTE_COUNT_INDEX_NAME)ðŸ”µ</abbr>
 366              List&lt;String&gt; allTags = new ArrayList&lt;String&gt;(tagsCursor.getCount());
 367              int nameColumnIndex = tagsCursor.getColumnIndex(Tag.NAME_PROPERTY);
 368              while (tagsCursor.moveToNext()) {
 369                  if (!mNote.hasTag(tagsCursor.getSimperiumKey()))
 370                      allTags.add(tagsCursor.getString(nameColumnIndex));
 371              }
 372              tagsCursor.close();
 373              return allTags;
 374          }
 375  
 376          @Override
 377          protected void onPostExecute(List tags) {
 378              if (tags != null &amp;&amp; tags.size() &gt; 0) {
 379                  ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),
 380                          android.R.layout.simple_dropdown_item_1line, tags);
 381                  mTagView.setAdapter(adapter);
 382              }
 383          }
 384      }
 385  
 386      private class saveNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 387  
 388          @Override
 389          protected Void doInBackground(String... args) {
 390              String content = mContentEditText.getText().toString();
 391              String tagString = mTagView.getText().toString();
 392              if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 393                  mNote.setContent(content);
 394                  mNote.setTagString(mTagView.getText().toString());
 395                  mNote.setModificationDate(Calendar.getInstance());
 396                  // Send pinned event to google analytics if changed
 397                  mNote.setPinned(mPinButton.isChecked());
 398                  mNote.save();
 399                  if (getActivity() != null) {
 400                      Tracker tracker = EasyTracker.getTracker();
 401                      if (mNote.isPinned() != mPinButton.isChecked())
<abbr title=" 402                          tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;pin_button&quot;, null);"> 402                          tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;pinðŸ”µ</abbr>
 403                      tracker.sendEvent(&quot;note&quot;, &quot;edited_note&quot;, &quot;editor_save&quot;, null);
 404                  }
 405              }
 406  
 407              return null;
 408          }
 409      }
 410  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            