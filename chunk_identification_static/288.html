<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>288</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    288
                    <a href="287.html">prev</a>
                    <a href="289.html">next</a>
                    <a href="288_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_48c30def272c562fe0b11114c11e754ba4b41566_core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/order/security/CartStateRequestProcessor.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;48c30def272c562fe0b11114c11e754ba4b41566:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/order/security/CartStateRequestProcessor.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;48c30def272c562fe0b11114c11e754ba4b41566^1:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/order/security/CartStateRequestProcessor.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;48c30def272c562fe0b11114c11e754ba4b41566^2:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/order/security/CartStateRequestProcessor.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;e8ce904276a11f6347913bbed767a088729c7e21:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/order/security/CartStateRequestProcessor.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.order.security;
  19 
  20 import org.apache.commons.logging.Log;
  21 import org.apache.commons.logging.LogFactory;
  22 import org.broadleafcommerce.common.crossapp.service.CrossAppAuthService;
  23 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  24 import org.broadleafcommerce.common.util.BLCRequestUtils;
  25 import org.broadleafcommerce.common.web.AbstractBroadleafWebRequestProcessor;
  26 import org.broadleafcommerce.common.web.BroadleafWebRequestProcessor;
  27 import org.broadleafcommerce.core.order.domain.Order;
  28 import org.broadleafcommerce.core.order.service.MergeCartService;
  29 import org.broadleafcommerce.core.order.service.OrderService;
  30 import org.broadleafcommerce.core.order.service.call.MergeCartResponse;
  31 import org.broadleafcommerce.core.order.service.exception.RemoveFromCartException;
  32 import org.broadleafcommerce.core.order.service.type.OrderStatus;
  33 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  34 import org.broadleafcommerce.core.web.service.UpdateCartService;
  35 import org.broadleafcommerce.profile.core.domain.Customer;
  36 import org.broadleafcommerce.profile.web.core.CustomerState;
  37 import org.broadleafcommerce.profile.web.core.security.CustomerStateRequestProcessor;
  38 import org.springframework.beans.factory.annotation.Autowired;
  39 import org.springframework.beans.factory.annotation.Qualifier;
  40 import org.springframework.stereotype.Component;
  41 import org.springframework.web.context.request.ServletWebRequest;
  42 import org.springframework.web.context.request.WebRequest;
  43 
  44 import java.util.HashMap;
  45 import java.util.Map;
  46 
  47 import javax.annotation.Resource;
  48 
  49 /**
  50  * Ensures that the customer&#x27;s current cart is available to the request.  
  51  * 
  52  * Also invokes blMergeCartProcessor&quot; if the user has just logged in.   
  53  * 
<abbr title="  54  * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters, Portlet Filters ">  54  * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters,ðŸ”µ</abbr>
<abbr title="  55  * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests into WebRequests ">  55  * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests intðŸ”µ</abbr>
  56  * via &lt;br /&gt;
  57  * new ServletWebRequest(httpServletRequest); new PortletWebRequest(portletRequest); &lt;br /&gt;
  58  * For the interceptor pattern, you can simply implement a WebRequestInterceptor to invoke from there.
  59  * 
  60  * @author Phillip Verheyden
  61  * @see {@link CartStateFilter}
  62  * @see {@link BroadleafWebRequestProcessor}
  63  * @see {@link ServletWebRequest}
  64  * @see {@link org.springframework.web.portlet.context.PortletWebRequest}
  65  */
  66 @Component(&quot;blCartStateRequestProcessor&quot;)
  67 public class CartStateRequestProcessor extends AbstractBroadleafWebRequestProcessor {
  68 
  69     /** Logger for this class and subclasses */
  70     protected final Log LOG = LogFactory.getLog(getClass());
  71 
  72     public static final String BLC_RULE_MAP_PARAM = &quot;blRuleMap&quot;;
  73 
  74     private final String mergeCartResponseKey = &quot;bl_merge_cart_response&quot;;
  75 
  76     @Resource(name = &quot;blCartStateRequestProcessorExtensionManager&quot;)
  77     protected CartStateRequestProcessorExtensionManager extensionManager;
  78 
  79     @Resource(name = &quot;blOrderService&quot;)
  80     protected OrderService orderService;
  81 
  82     @Resource(name = &quot;blUpdateCartService&quot;)
  83     protected UpdateCartService updateCartService;
  84 
  85     @Resource(name = &quot;blMergeCartService&quot;)
  86     protected MergeCartService mergeCartService;
  87     
  88     @Resource(name = &quot;blCustomerStateRequestProcessor&quot;)
  89     protected CustomerStateRequestProcessor customerStateRequestProcessor;
  90 
  91     @Autowired(required = false)
  92     @Qualifier(&quot;blCrossAppAuthService&quot;)
  93     protected CrossAppAuthService crossAppAuthService;
  94 
  95     protected static String cartRequestAttributeName = &quot;cart&quot;;
  96     
  97     protected static String anonymousCartSessionAttributeName = &quot;anonymousCart&quot;;
  98 
  99     public static final String OVERRIDE_CART_ATTR_NAME = &quot;_blc_overrideCartId&quot;;
 100         
 101     @Override
 102     public void process(WebRequest request) {
 103         Customer customer = CustomerState.getCustomer();
 104 
 105         if (customer == null) {
<abbr title=" 106             LOG.info(&quot;No customer was found on the current request, no cart will be added to the current request. Ensure that the&quot;"> 106             LOG.info(&quot;No customer was found on the current request, no cart will be added to the current ðŸ”µ</abbr>
 107                     + &quot; blCustomerStateFilter occurs prior to the blCartStateFilter&quot;);
 108             return;
 109         }
 110 
 111         ExtensionResultHolder&lt;Order&gt; erh = new ExtensionResultHolder&lt;Order&gt;();
 112         extensionManager.getProxy().lookupOrCreateCart(request, customer, erh);
 113 
 114         Order cart;
 115         if (erh.getResult() != null) {
 116             cart = orderService.findCartForCustomerWithEnhancements(customer, erh.getResult());
 117         } else {
 118             cart = getOverrideCart(request);
 119             if (cart == null &amp;&amp; mergeCartNeeded(customer, request)) {
 120                 if (LOG.isDebugEnabled()) {
 121                     LOG.debug(&quot;Merge cart required, calling mergeCart &quot; + customer.getId());
 122                 }
 123                 cart = mergeCart(customer, request);
 124             } else if (cart == null) {
 125                 cart = orderService.findCartForCustomerWithEnhancements(customer);
 126             }
 127 
 128             if (cart == null) {
 129                 cart = orderService.getNullOrder();
 130             } else {
 131                 updateCartService.updateAndValidateCart(cart);
 132             }
 133         }
 134 
 135         updateCartRequestAttributes(request, cart);
 136 
 137     }
 138 
 139     protected void updateCartRequestAttributes(WebRequest request, Order cart) {
 140         request.setAttribute(cartRequestAttributeName, cart, WebRequest.SCOPE_REQUEST);
 141 
 142         // Setup cart for content rule processing
 143         @SuppressWarnings(&quot;unchecked&quot;)
<abbr title=" 144         Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRequest.SCOPE_REQUEST);"> 144         Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRðŸ”µ</abbr>
 145         if (ruleMap == null) {
 146             ruleMap = new HashMap&lt;String, Object&gt;();
 147         }
 148         ruleMap.put(&quot;order&quot;, cart);
 149 
<abbr title=" 150         // Leaving the following line in for backwards compatibility, but all rules should use order as the"> 150         // Leaving the following line in for backwards compatibility, but all rules should use order as tðŸ”µ</abbr>
 151         // variable name.
 152         ruleMap.put(&quot;cart&quot;, cart);
 153         request.setAttribute(BLC_RULE_MAP_PARAM, ruleMap, WebRequest.SCOPE_REQUEST);
 154     }
 155 
 156     public Order getOverrideCart(WebRequest request) {
 157         Long orderId = null;
 158         if (BLCRequestUtils.isOKtoUseSession(request)) {
 159             orderId = (Long) request.getAttribute(OVERRIDE_CART_ATTR_NAME, WebRequest.SCOPE_SESSION);
 160         }
 161         Order cart = null;
 162         if (orderId != null) {
 163             cart = orderService.findOrderById(orderId);
 164     
 165             if (cart == null || 
 166                     cart.getStatus().equals(OrderStatus.SUBMITTED) || 
 167                     cart.getStatus().equals(OrderStatus.CANCELLED)) {
 168                 return null;
 169             }
 170         }
 171 
 172         return cart;
 173     }
 174     
 175     /**
<abbr title=" 176      * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implying that this is"> 176      * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implyðŸ”µ</abbr>
 177      * the logged in customer and we need to merge the carts
 178      */
 179     public boolean mergeCartNeeded(Customer customer, WebRequest request) {
 180         // When the user is a CSR, we want to disable cart merging
 181         if (crossAppAuthService != null &amp;&amp; crossAppAuthService.isAuthedFromAdmin()) {
 182             return false;
 183         }
 184 
 185         Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);
<abbr title=" 186         return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymousCustomer.getId()));"> 186         return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymoðŸ”µ</abbr>
 187     }
 188 
 189     /**
<abbr title=" 190      * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;customer&lt;/b&gt;. This"> 190      * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;cusðŸ”µ</abbr>
 191      * will also remove the customer from session after it has finished since it is no longer needed
 192      */
 193     public Order mergeCart(Customer customer, WebRequest request) {
 194         Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);
 195         MergeCartResponse mergeCartResponse;
 196         try {
 197             Order cart = orderService.findCartForCustomer(anonymousCustomer);
 198             mergeCartResponse = mergeCartService.mergeCart(customer, cart);
 199         } catch (PricingException e) {
 200             throw new RuntimeException(e);
 201         } catch (RemoveFromCartException e) {
 202             throw new RuntimeException(e);
 203         }
 204         
 205         if (BLCRequestUtils.isOKtoUseSession(request)) {
 206             // The anonymous customer from session is no longer needed; it can be safely removed
<abbr title=" 207             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeName(),"> 207             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeNamðŸ”µ</abbr>
 208                     WebRequest.SCOPE_SESSION);
<abbr title=" 209             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeName(),"> 209             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeNðŸ”µ</abbr>
 210 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211                     WebRequest.SCOPE_SESSION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213             request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_SESSION);</span>
 214 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215                     WebRequest.SCOPE_GLOBAL_SESSION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 217             request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_GLOBAL_SESSION);"> 217             request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_GLOBAL_SESSIONðŸ”µ</abbr></span>
 218 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219                     WebRequest.SCOPE_GLOBAL_SESSION);</span>
 220 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 221         }
 222         return mergeCartResponse.getOrder();
 223     }
 224 
 225     public static String getCartRequestAttributeName() {
 226         return cartRequestAttributeName;
 227     }
 228 
 229     public static void setCartRequestAttributeName(String cartRequestAttributeName) {
 230         CartStateRequestProcessor.cartRequestAttributeName = cartRequestAttributeName;
 231     }
 232 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.order.security;
  19 
  20 import org.apache.commons.logging.Log;
  21 import org.apache.commons.logging.LogFactory;
  22 import org.broadleafcommerce.common.crossapp.service.CrossAppAuthService;
  23 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  24 import org.broadleafcommerce.common.util.BLCRequestUtils;
  25 import org.broadleafcommerce.common.web.AbstractBroadleafWebRequestProcessor;
  26 import org.broadleafcommerce.common.web.BroadleafWebRequestProcessor;
  27 import org.broadleafcommerce.core.order.domain.Order;
  28 import org.broadleafcommerce.core.order.service.MergeCartService;
  29 import org.broadleafcommerce.core.order.service.OrderService;
  30 import org.broadleafcommerce.core.order.service.call.MergeCartResponse;
  31 import org.broadleafcommerce.core.order.service.exception.RemoveFromCartException;
  32 import org.broadleafcommerce.core.order.service.type.OrderStatus;
  33 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  34 import org.broadleafcommerce.core.web.service.UpdateCartService;
  35 import org.broadleafcommerce.profile.core.domain.Customer;
  36 import org.broadleafcommerce.profile.web.core.CustomerState;
  37 import org.broadleafcommerce.profile.web.core.security.CustomerStateRequestProcessor;
  38 import org.springframework.beans.factory.annotation.Autowired;
  39 import org.springframework.beans.factory.annotation.Qualifier;
  40 import org.springframework.stereotype.Component;
  41 import org.springframework.web.context.request.ServletWebRequest;
  42 import org.springframework.web.context.request.WebRequest;
  43 
  44 import java.util.HashMap;
  45 import java.util.Map;
  46 
  47 import javax.annotation.Resource;
  48 
  49 /**
  50  * Ensures that the customer&#x27;s current cart is available to the request.
  51  *
  52  * Also invokes blMergeCartProcessor&quot; if the user has just logged in.
  53  *
<abbr title="  54  * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters, Portlet Filters">  54  * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters,ðŸ”µ</abbr>
<abbr title="  55  * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests into WebRequests">  55  * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests intðŸ”µ</abbr>
  56  * via &lt;br /&gt;
  57  * new ServletWebRequest(httpServletRequest); new PortletWebRequest(portletRequest); &lt;br /&gt;
  58  * For the interceptor pattern, you can simply implement a WebRequestInterceptor to invoke from there.
  59  *
  60  * @author Phillip Verheyden
  61  * @see {@link CartStateFilter}
  62  * @see {@link BroadleafWebRequestProcessor}
  63  * @see {@link ServletWebRequest}
  64  * @see {@link org.springframework.web.portlet.context.PortletWebRequest}
  65  */
  66 @Component(&quot;blCartStateRequestProcessor&quot;)
  67 public class CartStateRequestProcessor extends AbstractBroadleafWebRequestProcessor {
  68 
  69     /** Logger for this class and subclasses */
  70     protected final Log LOG = LogFactory.getLog(getClass());
  71 
  72     public static final String BLC_RULE_MAP_PARAM = &quot;blRuleMap&quot;;
  73 
  74     private final String mergeCartResponseKey = &quot;bl_merge_cart_response&quot;;
  75 
  76     @Resource(name = &quot;blCartStateRequestProcessorExtensionManager&quot;)
  77     protected CartStateRequestProcessorExtensionManager extensionManager;
  78 
  79     @Resource(name = &quot;blOrderService&quot;)
  80     protected OrderService orderService;
  81 
  82     @Resource(name = &quot;blUpdateCartService&quot;)
  83     protected UpdateCartService updateCartService;
  84 
  85     @Resource(name = &quot;blMergeCartService&quot;)
  86     protected MergeCartService mergeCartService;
  87 
  88     @Resource(name = &quot;blCustomerStateRequestProcessor&quot;)
  89     protected CustomerStateRequestProcessor customerStateRequestProcessor;
  90 
  91     @Autowired(required = false)
  92     @Qualifier(&quot;blCrossAppAuthService&quot;)
  93     protected CrossAppAuthService crossAppAuthService;
  94 
  95     protected static String cartRequestAttributeName = &quot;cart&quot;;
  96 
  97     protected static String anonymousCartSessionAttributeName = &quot;anonymousCart&quot;;
  98 
  99     public static final String OVERRIDE_CART_ATTR_NAME = &quot;_blc_overrideCartId&quot;;
 100 
 101     @Override
 102     public void process(WebRequest request) {
 103         Customer customer = CustomerState.getCustomer();
 104 
 105         if (customer == null) {
<abbr title=" 106             LOG.info(&quot;No customer was found on the current request, no cart will be added to the current request. Ensure that the&quot;"> 106             LOG.info(&quot;No customer was found on the current request, no cart will be added to the current ðŸ”µ</abbr>
 107                     + &quot; blCustomerStateFilter occurs prior to the blCartStateFilter&quot;);
 108             return;
 109         }
 110 
 111         ExtensionResultHolder&lt;Order&gt; erh = new ExtensionResultHolder&lt;Order&gt;();
 112         extensionManager.getProxy().lookupOrCreateCart(request, customer, erh);
 113 
 114         Order cart;
 115         if (erh.getResult() != null) {
 116             cart = orderService.findCartForCustomerWithEnhancements(customer, erh.getResult());
 117         } else {
 118             cart = getOverrideCart(request);
 119             if (cart == null &amp;&amp; mergeCartNeeded(customer, request)) {
 120                 if (LOG.isDebugEnabled()) {
 121                     LOG.debug(&quot;Merge cart required, calling mergeCart &quot; + customer.getId());
 122                 }
 123                 cart = mergeCart(customer, request);
 124             } else if (cart == null) {
 125                 cart = orderService.findCartForCustomerWithEnhancements(customer);
 126             }
 127 
 128             if (cart == null) {
 129                 cart = orderService.getNullOrder();
 130             } else {
 131                 updateCartService.updateAndValidateCart(cart);
 132             }
 133         }
 134 
 135         updateCartRequestAttributes(request, cart);
 136 
 137     }
 138 
 139     protected void updateCartRequestAttributes(WebRequest request, Order cart) {
 140         request.setAttribute(cartRequestAttributeName, cart, WebRequest.SCOPE_REQUEST);
 141 
 142         // Setup cart for content rule processing
 143         @SuppressWarnings(&quot;unchecked&quot;)
<abbr title=" 144         Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRequest.SCOPE_REQUEST);"> 144         Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRðŸ”µ</abbr>
 145         if (ruleMap == null) {
 146             ruleMap = new HashMap&lt;String, Object&gt;();
 147         }
 148         ruleMap.put(&quot;order&quot;, cart);
 149 
<abbr title=" 150         // Leaving the following line in for backwards compatibility, but all rules should use order as the"> 150         // Leaving the following line in for backwards compatibility, but all rules should use order as tðŸ”µ</abbr>
 151         // variable name.
 152         ruleMap.put(&quot;cart&quot;, cart);
 153         request.setAttribute(BLC_RULE_MAP_PARAM, ruleMap, WebRequest.SCOPE_REQUEST);
 154     }
 155 
 156     public Order getOverrideCart(WebRequest request) {
 157         Long orderId = null;
 158         if (BLCRequestUtils.isOKtoUseSession(request)) {
 159             orderId = (Long) request.getAttribute(OVERRIDE_CART_ATTR_NAME, WebRequest.SCOPE_SESSION);
 160         }
 161         Order cart = null;
 162         if (orderId != null) {
 163             cart = orderService.findOrderById(orderId);
 164 
 165             if (cart == null ||
 166                     cart.getStatus().equals(OrderStatus.SUBMITTED) ||
 167                     cart.getStatus().equals(OrderStatus.CANCELLED)) {
 168                 return null;
 169             }
 170         }
 171 
 172         return cart;
 173     }
 174 
 175     /**
<abbr title=" 176      * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implying that this is"> 176      * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implyðŸ”µ</abbr>
 177      * the logged in customer and we need to merge the carts
 178      */
 179     public boolean mergeCartNeeded(Customer customer, WebRequest request) {
 180         // When the user is a CSR, we want to disable cart merging
 181         if (crossAppAuthService != null &amp;&amp; crossAppAuthService.isAuthedFromAdmin()) {
 182             return false;
 183         }
 184 
 185         Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);
<abbr title=" 186         return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymousCustomer.getId()));"> 186         return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymoðŸ”µ</abbr>
 187     }
 188 
 189     /**
<abbr title=" 190      * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;customer&lt;/b&gt;. This"> 190      * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;cusðŸ”µ</abbr>
 191      * will also remove the customer from session after it has finished since it is no longer needed
 192      */
 193     public Order mergeCart(Customer customer, WebRequest request) {
 194         Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);
 195         MergeCartResponse mergeCartResponse;
 196         try {
 197             Order cart = orderService.findCartForCustomer(anonymousCustomer);
 198             mergeCartResponse = mergeCartService.mergeCart(customer, cart);
 199         } catch (PricingException e) {
 200             throw new RuntimeException(e);
 201         } catch (RemoveFromCartException e) {
 202             throw new RuntimeException(e);
 203         }
 204 
 205         if (BLCRequestUtils.isOKtoUseSession(request)) {
 206             // The anonymous customer from session is no longer needed; it can be safely removed
<abbr title=" 207             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeName(),"> 207             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeNamðŸ”µ</abbr>
 208                     WebRequest.SCOPE_SESSION);
<abbr title=" 209             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeName(),"> 209             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeNðŸ”µ</abbr>
 210 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211                     WebRequest.SCOPE_SESSION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213             request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_SESSION);</span>
 214 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215                     WebRequest.SCOPE_GLOBAL_SESSION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 217             request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_GLOBAL_SESSION);"> 217             request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_GLOBAL_SESSIONðŸ”µ</abbr></span>
 218 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219                     WebRequest.SCOPE_GLOBAL_SESSION);</span>
 220 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 221         }
 222         return mergeCartResponse.getOrder();
 223     }
 224 
 225     public static String getCartRequestAttributeName() {
 226         return cartRequestAttributeName;
 227     }
 228 
 229     public static void setCartRequestAttributeName(String cartRequestAttributeName) {
 230         CartStateRequestProcessor.cartRequestAttributeName = cartRequestAttributeName;
 231     }
 232 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.order.security;
  19 
  20 import java.util.HashMap;
  21 import java.util.Map;
  22 import javax.annotation.Resource;
  23 import org.apache.commons.logging.Log;
  24 import org.apache.commons.logging.LogFactory;
  25 import org.broadleafcommerce.common.crossapp.service.CrossAppAuthService;
  26 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  27 import org.broadleafcommerce.common.util.BLCRequestUtils;
  28 import org.broadleafcommerce.common.web.AbstractBroadleafWebRequestProcessor;
  29 import org.broadleafcommerce.common.web.BroadleafWebRequestProcessor;
  30 import org.broadleafcommerce.core.order.domain.Order;
  31 import org.broadleafcommerce.core.order.service.MergeCartService;
  32 import org.broadleafcommerce.core.order.service.OrderService;
  33 import org.broadleafcommerce.core.order.service.call.MergeCartResponse;
  34 import org.broadleafcommerce.core.order.service.exception.RemoveFromCartException;
  35 import org.broadleafcommerce.core.order.service.type.OrderStatus;
  36 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  37 import org.broadleafcommerce.core.web.service.UpdateCartService;
  38 import org.broadleafcommerce.profile.core.domain.Customer;
  39 import org.broadleafcommerce.profile.web.core.CustomerState;
  40 import org.broadleafcommerce.profile.web.core.security.CustomerStateRequestProcessor;
  41 import org.springframework.beans.factory.annotation.Autowired;
  42 import org.springframework.beans.factory.annotation.Qualifier;
  43 import org.springframework.stereotype.Component;
  44 import org.springframework.web.context.request.ServletWebRequest;
  45 import org.springframework.web.context.request.WebRequest;
  46 
  47 
  48 /**
  49  * Ensures that the customer&#x27;s current cart is available to the request.
  50  *
  51  * Also invokes blMergeCartProcessor&quot; if the user has just logged in.
  52  *
<abbr title="  53  * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters, Portlet Filters">  53  * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters,ðŸ”µ</abbr>
<abbr title="  54  * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests into WebRequests">  54  * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests intðŸ”µ</abbr>
  55  * via &lt;br /&gt;
  56  * new ServletWebRequest(httpServletRequest); new PortletWebRequest(portletRequest); &lt;br /&gt;
  57  * For the interceptor pattern, you can simply implement a WebRequestInterceptor to invoke from there.
  58  *
  59  * @author Phillip Verheyden
  60  * @see {@link CartStateFilter}
  61  * @see {@link BroadleafWebRequestProcessor}
  62  * @see {@link ServletWebRequest}
  63  * @see {@link org.springframework.web.portlet.context.PortletWebRequest}
  64  */
  65 @Component(&quot;blCartStateRequestProcessor&quot;)
  66 public class CartStateRequestProcessor extends AbstractBroadleafWebRequestProcessor {
  67     /** Logger for this class and subclasses */
  68     protected final Log LOG = LogFactory.getLog(getClass());
  69 
  70     public static final String BLC_RULE_MAP_PARAM = &quot;blRuleMap&quot;;
  71 
  72     private final String mergeCartResponseKey = &quot;bl_merge_cart_response&quot;;
  73 
  74     @Resource(name = &quot;blCartStateRequestProcessorExtensionManager&quot;)
  75     protected CartStateRequestProcessorExtensionManager extensionManager;
  76 
  77     @Resource(name = &quot;blOrderService&quot;)
  78     protected OrderService orderService;
  79 
  80     @Resource(name = &quot;blUpdateCartService&quot;)
  81     protected UpdateCartService updateCartService;
  82 
  83     @Resource(name = &quot;blMergeCartService&quot;)
  84     protected MergeCartService mergeCartService;
  85 
  86     @Resource(name = &quot;blCustomerStateRequestProcessor&quot;)
  87     protected CustomerStateRequestProcessor customerStateRequestProcessor;
  88 
  89     @Autowired(required = false)
  90     @Qualifier(&quot;blCrossAppAuthService&quot;)
  91     protected CrossAppAuthService crossAppAuthService;
  92 
  93     protected static String cartRequestAttributeName = &quot;cart&quot;;
  94 
  95     protected static String anonymousCartSessionAttributeName = &quot;anonymousCart&quot;;
  96 
  97     public static final String OVERRIDE_CART_ATTR_NAME = &quot;_blc_overrideCartId&quot;;
  98 
  99     @Override
 100     public void process(WebRequest request) {
 101         Customer customer = CustomerState.getCustomer();
 102 
 103         if (customer == null) {
<abbr title=" 104             LOG.info(&quot;No customer was found on the current request, no cart will be added to the current request. Ensure that the&quot;"> 104             LOG.info(&quot;No customer was found on the current request, no cart will be added to the current ðŸ”µ</abbr>
 105                     + &quot; blCustomerStateFilter occurs prior to the blCartStateFilter&quot;);
 106             return;
 107         }
 108 
 109         ExtensionResultHolder&lt;Order&gt; erh = new ExtensionResultHolder&lt;Order&gt;();
 110         extensionManager.getProxy().lookupOrCreateCart(request, customer, erh);
 111 
 112         Order cart;
 113         if (erh.getResult() != null) {
 114             cart = orderService.findCartForCustomerWithEnhancements(customer, erh.getResult());
 115         } else {
 116             cart = getOverrideCart(request);
 117             if (cart == null &amp;&amp; mergeCartNeeded(customer, request)) {
 118                 if (LOG.isDebugEnabled()) {
 119                     LOG.debug(&quot;Merge cart required, calling mergeCart &quot; + customer.getId());
 120                 }
 121                 cart = mergeCart(customer, request);
 122             } else if (cart == null) {
 123                 cart = orderService.findCartForCustomerWithEnhancements(customer);
 124             }
 125 
 126             if (cart == null) {
 127                 cart = orderService.getNullOrder();
 128             } else {
 129                 updateCartService.updateAndValidateCart(cart);
 130             }
 131         }
 132 
 133         updateCartRequestAttributes(request, cart);
 134 
 135     }
 136 
 137     protected void updateCartRequestAttributes(WebRequest request, Order cart) {
 138         request.setAttribute(cartRequestAttributeName, cart, WebRequest.SCOPE_REQUEST);
 139 
 140         // Setup cart for content rule processing
 141         @SuppressWarnings(&quot;unchecked&quot;)
<abbr title=" 142         Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRequest.SCOPE_REQUEST);"> 142         Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRðŸ”µ</abbr>
 143         if (ruleMap == null) {
 144             ruleMap = new HashMap&lt;String, Object&gt;();
 145         }
 146         ruleMap.put(&quot;order&quot;, cart);
 147 
<abbr title=" 148         // Leaving the following line in for backwards compatibility, but all rules should use order as the"> 148         // Leaving the following line in for backwards compatibility, but all rules should use order as tðŸ”µ</abbr>
 149         // variable name.
 150         ruleMap.put(&quot;cart&quot;, cart);
 151         request.setAttribute(BLC_RULE_MAP_PARAM, ruleMap, WebRequest.SCOPE_REQUEST);
 152     }
 153 
 154     public Order getOverrideCart(WebRequest request) {
 155         Long orderId = null;
 156         if (BLCRequestUtils.isOKtoUseSession(request)) {
 157             orderId = ((Long) (request.getAttribute(OVERRIDE_CART_ATTR_NAME, WebRequest.SCOPE_SESSION)));
 158         }
 159         Order cart = null;
 160         if (orderId != null) {
 161             cart = orderService.findOrderById(orderId);
<abbr title=" 162             if (((cart == null) || cart.getStatus().equals(OrderStatus.SUBMITTED)) || cart.getStatus().equals(OrderStatus.CANCELLED)) {"> 162             if (((cart == null) || cart.getStatus().equals(OrderStatus.SUBMITTED)) || cart.getStatus().eqðŸ”µ</abbr>
 163                 return null;
 164             }
 165         }
 166         return cart;
 167     }
 168 
 169     /**
<abbr title=" 170      * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implying that this is"> 170      * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implyðŸ”µ</abbr>
 171      * the logged in customer and we need to merge the carts
 172      */
 173     public boolean mergeCartNeeded(Customer customer, WebRequest request) {
 174         // When the user is a CSR, we want to disable cart merging
 175         if (crossAppAuthService != null &amp;&amp; crossAppAuthService.isAuthedFromAdmin()) {
 176             return false;
 177         }
 178 
 179         Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);
<abbr title=" 180         return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymousCustomer.getId()));"> 180         return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymoðŸ”µ</abbr>
 181     }
 182 
 183     /**
<abbr title=" 184      * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;customer&lt;/b&gt;. This"> 184      * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;cusðŸ”µ</abbr>
 185      * will also remove the customer from session after it has finished since it is no longer needed
 186      */
 187     public Order mergeCart(Customer customer, WebRequest request) {
 188         Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);
 189         MergeCartResponse mergeCartResponse;
 190         try {
 191             Order cart = orderService.findCartForCustomer(anonymousCustomer);
 192             mergeCartResponse = mergeCartService.mergeCart(customer, cart);
 193         } catch (PricingException e) {
 194             throw new RuntimeException(e);
 195         } catch (RemoveFromCartException e) {
 196             throw new RuntimeException(e);
 197         }
 198         if (BLCRequestUtils.isOKtoUseSession(request)) {
 199             // The anonymous customer from session is no longer needed; it can be safely removed
<abbr title=" 200             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeName(), WebRequest.SCOPE_SESSION);"> 200             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeNamðŸ”µ</abbr>
<abbr title=" 201             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeName(), WebRequest.SCOPE_SESSION);"> 201             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeNðŸ”µ</abbr>
 202         }
 203         return mergeCartResponse.getOrder();
 204     }
 205 
 206     public static String getCartRequestAttributeName() {
 207         return cartRequestAttributeName;
 208     }
 209 
 210     public static void setCartRequestAttributeName(String cartRequestAttributeName) {
 211         CartStateRequestProcessor.cartRequestAttributeName = cartRequestAttributeName;
 212     }
 213 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework Web
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.web.order.security;
  19  
  20  import org.apache.commons.logging.Log;
  21  import org.apache.commons.logging.LogFactory;
  22  import org.broadleafcommerce.common.crossapp.service.CrossAppAuthService;
  23  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  24  import org.broadleafcommerce.common.util.BLCRequestUtils;
  25  import org.broadleafcommerce.common.web.AbstractBroadleafWebRequestProcessor;
  26  import org.broadleafcommerce.common.web.BroadleafWebRequestProcessor;
  27  import org.broadleafcommerce.core.order.domain.Order;
  28  import org.broadleafcommerce.core.order.service.MergeCartService;
  29  import org.broadleafcommerce.core.order.service.OrderService;
  30  import org.broadleafcommerce.core.order.service.call.MergeCartResponse;
  31  import org.broadleafcommerce.core.order.service.exception.RemoveFromCartException;
  32  import org.broadleafcommerce.core.order.service.type.OrderStatus;
  33  import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  34  import org.broadleafcommerce.core.web.service.UpdateCartService;
  35  import org.broadleafcommerce.profile.core.domain.Customer;
  36  import org.broadleafcommerce.profile.web.core.CustomerState;
  37  import org.broadleafcommerce.profile.web.core.security.CustomerStateRequestProcessor;
  38  import org.springframework.beans.factory.annotation.Autowired;
  39  import org.springframework.beans.factory.annotation.Qualifier;
  40  import org.springframework.stereotype.Component;
  41  import org.springframework.web.context.request.ServletWebRequest;
  42  import org.springframework.web.context.request.WebRequest;
  43  
  44  import java.util.HashMap;
  45  import java.util.Map;
  46  
  47  import javax.annotation.Resource;
  48  
  49  /**
  50   * Ensures that the customer&#x27;s current cart is available to the request.
  51   *
  52   * Also invokes blMergeCartProcessor&quot; if the user has just logged in.
  53   *
<abbr title="  54   * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters, Portlet Filters">  54   * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters, Portlet ðŸ”µ</abbr>
<abbr title="  55   * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests into WebRequests">  55   * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests into WebRequðŸ”µ</abbr>
  56   * via &lt;br /&gt;
  57   * new ServletWebRequest(httpServletRequest); new PortletWebRequest(portletRequest); &lt;br /&gt;
  58   * For the interceptor pattern, you can simply implement a WebRequestInterceptor to invoke from there.
  59   *
  60   * @author Phillip Verheyden
  61   * @see {@link CartStateFilter}
  62   * @see {@link BroadleafWebRequestProcessor}
  63   * @see {@link ServletWebRequest}
  64   * @see {@link org.springframework.web.portlet.context.PortletWebRequest}
  65   */
  66  @Component(&quot;blCartStateRequestProcessor&quot;)
  67  public class CartStateRequestProcessor extends AbstractBroadleafWebRequestProcessor {
  68  
  69      /** Logger for this class and subclasses */
  70      protected final Log LOG = LogFactory.getLog(getClass());
  71  
  72      public static final String BLC_RULE_MAP_PARAM = &quot;blRuleMap&quot;;
  73  
  74      private final String mergeCartResponseKey = &quot;bl_merge_cart_response&quot;;
  75  
  76      @Resource(name = &quot;blCartStateRequestProcessorExtensionManager&quot;)
  77      protected CartStateRequestProcessorExtensionManager extensionManager;
  78  
  79      @Resource(name = &quot;blOrderService&quot;)
  80      protected OrderService orderService;
  81  
  82      @Resource(name = &quot;blUpdateCartService&quot;)
  83      protected UpdateCartService updateCartService;
  84  
  85      @Resource(name = &quot;blMergeCartService&quot;)
  86      protected MergeCartService mergeCartService;
  87  
  88      @Resource(name = &quot;blCustomerStateRequestProcessor&quot;)
  89      protected CustomerStateRequestProcessor customerStateRequestProcessor;
  90  
  91      @Autowired(required = false)
  92      @Qualifier(&quot;blCrossAppAuthService&quot;)
  93      protected CrossAppAuthService crossAppAuthService;
  94  
  95      protected static String cartRequestAttributeName = &quot;cart&quot;;
  96  
  97      protected static String anonymousCartSessionAttributeName = &quot;anonymousCart&quot;;
  98  
  99      public static final String OVERRIDE_CART_ATTR_NAME = &quot;_blc_overrideCartId&quot;;
 100  
 101      @Override
 102      public void process(WebRequest request) {
 103          Customer customer = CustomerState.getCustomer();
 104  
 105          if (customer == null) {
<abbr title=" 106              LOG.info(&quot;No customer was found on the current request, no cart will be added to the current request. Ensure that the&quot;"> 106              LOG.info(&quot;No customer was found on the current request, no cart will be added to the current request. ðŸ”µ</abbr>
 107                      + &quot; blCustomerStateFilter occurs prior to the blCartStateFilter&quot;);
 108              return;
 109          }
 110  
 111          ExtensionResultHolder&lt;Order&gt; erh = new ExtensionResultHolder&lt;Order&gt;();
 112          extensionManager.getProxy().lookupOrCreateCart(request, customer, erh);
 113  
 114          Order cart;
 115          if (erh.getResult() != null) {
 116              cart = orderService.findCartForCustomerWithEnhancements(customer, erh.getResult());
 117          } else {
 118              cart = getOverrideCart(request);
 119              if (cart == null &amp;&amp; mergeCartNeeded(customer, request)) {
 120                  if (LOG.isDebugEnabled()) {
 121                      LOG.debug(&quot;Merge cart required, calling mergeCart &quot; + customer.getId());
 122                  }
 123                  cart = mergeCart(customer, request);
 124              } else if (cart == null) {
 125                  cart = orderService.findCartForCustomerWithEnhancements(customer);
 126              }
 127  
 128              if (cart == null) {
 129                  cart = orderService.getNullOrder();
 130              } else {
 131                  updateCartService.updateAndValidateCart(cart);
 132              }
 133          }
 134  
 135          updateCartRequestAttributes(request, cart);
 136  
 137      }
 138  
 139      protected void updateCartRequestAttributes(WebRequest request, Order cart) {
 140          request.setAttribute(cartRequestAttributeName, cart, WebRequest.SCOPE_REQUEST);
 141  
 142          // Setup cart for content rule processing
 143          @SuppressWarnings(&quot;unchecked&quot;)
<abbr title=" 144          Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRequest.SCOPE_REQUEST);"> 144          Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRequest.SCðŸ”µ</abbr>
 145          if (ruleMap == null) {
 146              ruleMap = new HashMap&lt;String, Object&gt;();
 147          }
 148          ruleMap.put(&quot;order&quot;, cart);
 149  
 150          // Leaving the following line in for backwards compatibility, but all rules should use order as the
 151          // variable name.
 152          ruleMap.put(&quot;cart&quot;, cart);
 153          request.setAttribute(BLC_RULE_MAP_PARAM, ruleMap, WebRequest.SCOPE_REQUEST);
 154      }
 155  
 156      public Order getOverrideCart(WebRequest request) {
 157          Long orderId = null;
 158          if (BLCRequestUtils.isOKtoUseSession(request)) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -            orderId = (Long) request.getAttribute(OVERRIDE_CART_ATTR_NAME, WebRequest.SCOPE_GLOBAL_SESSION);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +            orderId = (Long) request.getAttribute(OVERRIDE_CART_ATTR_NAME, WebRequest.SCOPE_SESSION);</span>
 161          }
 162          Order cart = null;
 163          if (orderId != null) {
 164              cart = orderService.findOrderById(orderId);
 165  
 166              if (cart == null ||
 167                      cart.getStatus().equals(OrderStatus.SUBMITTED) ||
 168                      cart.getStatus().equals(OrderStatus.CANCELLED)) {
 169                  return null;
 170              }
 171          }
 172  
 173          return cart;
 174      }
 175  
 176      /**
<abbr title=" 177       * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implying that this is"> 177       * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implying that ðŸ”µ</abbr>
 178       * the logged in customer and we need to merge the carts
 179       */
 180      public boolean mergeCartNeeded(Customer customer, WebRequest request) {
 181          // When the user is a CSR, we want to disable cart merging
 182          if (crossAppAuthService != null &amp;&amp; crossAppAuthService.isAuthedFromAdmin()) {
 183              return false;
 184          }
 185  
 186          Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);
<abbr title=" 187          return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymousCustomer.getId()));"> 187          return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymousCustomeðŸ”µ</abbr>
 188      }
 189  
 190      /**
<abbr title=" 191       * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;customer&lt;/b&gt;. This"> 191       * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;customer&lt;/b&gt;ðŸ”µ</abbr>
 192       * will also remove the customer from session after it has finished since it is no longer needed
 193       */
 194      public Order mergeCart(Customer customer, WebRequest request) {
 195          Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);
 196          MergeCartResponse mergeCartResponse;
 197          try {
 198              Order cart = orderService.findCartForCustomer(anonymousCustomer);
 199              mergeCartResponse = mergeCartService.mergeCart(customer, cart);
 200          } catch (PricingException e) {
 201              throw new RuntimeException(e);
 202          } catch (RemoveFromCartException e) {
 203              throw new RuntimeException(e);
 204          }
 205  
 206          if (BLCRequestUtils.isOKtoUseSession(request)) {
 207              // The anonymous customer from session is no longer needed; it can be safely removed
 208              request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeName(),
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -                    WebRequest.SCOPE_GLOBAL_SESSION);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +                    WebRequest.SCOPE_SESSION);</span>
 211              request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeName(),
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -                    WebRequest.SCOPE_GLOBAL_SESSION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -            request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_GLOBAL_SESSION);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +                    WebRequest.SCOPE_SESSION);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +            request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_SESSION);</span>
 218          }
 219          return mergeCartResponse.getOrder();
 220      }
 221  
 222      public static String getCartRequestAttributeName() {
 223          return cartRequestAttributeName;
 224      }
 225  
 226      public static void setCartRequestAttributeName(String cartRequestAttributeName) {
 227          CartStateRequestProcessor.cartRequestAttributeName = cartRequestAttributeName;
 228      }
 229  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework Web
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.web.order.security;
  19  
  20  import org.apache.commons.logging.Log;
  21  import org.apache.commons.logging.LogFactory;
  22  import org.broadleafcommerce.common.crossapp.service.CrossAppAuthService;
  23  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  24  import org.broadleafcommerce.common.util.BLCRequestUtils;
  25  import org.broadleafcommerce.common.web.AbstractBroadleafWebRequestProcessor;
  26  import org.broadleafcommerce.common.web.BroadleafWebRequestProcessor;
  27  import org.broadleafcommerce.core.order.domain.Order;
  28  import org.broadleafcommerce.core.order.service.MergeCartService;
  29  import org.broadleafcommerce.core.order.service.OrderService;
  30  import org.broadleafcommerce.core.order.service.call.MergeCartResponse;
  31  import org.broadleafcommerce.core.order.service.exception.RemoveFromCartException;
  32  import org.broadleafcommerce.core.order.service.type.OrderStatus;
  33  import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  34  import org.broadleafcommerce.core.web.service.UpdateCartService;
  35  import org.broadleafcommerce.profile.core.domain.Customer;
  36  import org.broadleafcommerce.profile.web.core.CustomerState;
  37  import org.broadleafcommerce.profile.web.core.security.CustomerStateRequestProcessor;
  38  import org.springframework.beans.factory.annotation.Autowired;
  39  import org.springframework.beans.factory.annotation.Qualifier;
  40  import org.springframework.stereotype.Component;
  41  import org.springframework.web.context.request.ServletWebRequest;
  42  import org.springframework.web.context.request.WebRequest;
  43  
  44  import java.util.HashMap;
  45  import java.util.Map;
  46  
  47  import javax.annotation.Resource;
  48  
  49  /**
  50   * Ensures that the customer&#x27;s current cart is available to the request.
  51   *
  52   * Also invokes blMergeCartProcessor&quot; if the user has just logged in.
  53   *
<abbr title="  54   * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters, Portlet Filters">  54   * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters, Portlet ðŸ”µ</abbr>
<abbr title="  55   * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests into WebRequests">  55   * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests into WebRequðŸ”µ</abbr>
  56   * via &lt;br /&gt;
  57   * new ServletWebRequest(httpServletRequest); new PortletWebRequest(portletRequest); &lt;br /&gt;
  58   * For the interceptor pattern, you can simply implement a WebRequestInterceptor to invoke from there.
  59   *
  60   * @author Phillip Verheyden
  61   * @see {@link CartStateFilter}
  62   * @see {@link BroadleafWebRequestProcessor}
  63   * @see {@link ServletWebRequest}
  64   * @see {@link org.springframework.web.portlet.context.PortletWebRequest}
  65   */
  66  @Component(&quot;blCartStateRequestProcessor&quot;)
  67  public class CartStateRequestProcessor extends AbstractBroadleafWebRequestProcessor {
  68  
  69      /** Logger for this class and subclasses */
  70      protected final Log LOG = LogFactory.getLog(getClass());
  71  
  72      public static final String BLC_RULE_MAP_PARAM = &quot;blRuleMap&quot;;
  73  
  74      private final String mergeCartResponseKey = &quot;bl_merge_cart_response&quot;;
  75  
  76      @Resource(name = &quot;blCartStateRequestProcessorExtensionManager&quot;)
  77      protected CartStateRequestProcessorExtensionManager extensionManager;
  78  
  79      @Resource(name = &quot;blOrderService&quot;)
  80      protected OrderService orderService;
  81  
  82      @Resource(name = &quot;blUpdateCartService&quot;)
  83      protected UpdateCartService updateCartService;
  84  
  85      @Resource(name = &quot;blMergeCartService&quot;)
  86      protected MergeCartService mergeCartService;
  87  
  88      @Resource(name = &quot;blCustomerStateRequestProcessor&quot;)
  89      protected CustomerStateRequestProcessor customerStateRequestProcessor;
  90  
  91      @Autowired(required = false)
  92      @Qualifier(&quot;blCrossAppAuthService&quot;)
  93      protected CrossAppAuthService crossAppAuthService;
  94  
  95      protected static String cartRequestAttributeName = &quot;cart&quot;;
  96  
  97      protected static String anonymousCartSessionAttributeName = &quot;anonymousCart&quot;;
  98  
  99      public static final String OVERRIDE_CART_ATTR_NAME = &quot;_blc_overrideCartId&quot;;
 100  
 101      @Override
 102      public void process(WebRequest request) {
 103          Customer customer = CustomerState.getCustomer();
 104  
 105          if (customer == null) {
<abbr title=" 106              LOG.info(&quot;No customer was found on the current request, no cart will be added to the current request. Ensure that the&quot;"> 106              LOG.info(&quot;No customer was found on the current request, no cart will be added to the current request. ðŸ”µ</abbr>
 107                      + &quot; blCustomerStateFilter occurs prior to the blCartStateFilter&quot;);
 108              return;
 109          }
 110  
 111          ExtensionResultHolder&lt;Order&gt; erh = new ExtensionResultHolder&lt;Order&gt;();
 112          extensionManager.getProxy().lookupOrCreateCart(request, customer, erh);
 113  
 114          Order cart;
 115          if (erh.getResult() != null) {
 116              cart = orderService.findCartForCustomerWithEnhancements(customer, erh.getResult());
 117          } else {
 118              cart = getOverrideCart(request);
 119              if (cart == null &amp;&amp; mergeCartNeeded(customer, request)) {
 120                  if (LOG.isDebugEnabled()) {
 121                      LOG.debug(&quot;Merge cart required, calling mergeCart &quot; + customer.getId());
 122                  }
 123                  cart = mergeCart(customer, request);
 124              } else if (cart == null) {
 125                  cart = orderService.findCartForCustomerWithEnhancements(customer);
 126              }
 127  
 128              if (cart == null) {
 129                  cart = orderService.getNullOrder();
 130              } else {
 131                  updateCartService.updateAndValidateCart(cart);
 132              }
 133          }
 134  
 135          updateCartRequestAttributes(request, cart);
 136  
 137      }
 138  
 139      protected void updateCartRequestAttributes(WebRequest request, Order cart) {
 140          request.setAttribute(cartRequestAttributeName, cart, WebRequest.SCOPE_REQUEST);
 141  
 142          // Setup cart for content rule processing
 143          @SuppressWarnings(&quot;unchecked&quot;)
<abbr title=" 144          Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRequest.SCOPE_REQUEST);"> 144          Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRequest.SCðŸ”µ</abbr>
 145          if (ruleMap == null) {
 146              ruleMap = new HashMap&lt;String, Object&gt;();
 147          }
 148          ruleMap.put(&quot;order&quot;, cart);
 149  
 150          // Leaving the following line in for backwards compatibility, but all rules should use order as the
 151          // variable name.
 152          ruleMap.put(&quot;cart&quot;, cart);
 153          request.setAttribute(BLC_RULE_MAP_PARAM, ruleMap, WebRequest.SCOPE_REQUEST);
 154      }
 155  
 156      public Order getOverrideCart(WebRequest request) {
 157          Long orderId = null;
 158          if (BLCRequestUtils.isOKtoUseSession(request)) {
 159              orderId = (Long) request.getAttribute(OVERRIDE_CART_ATTR_NAME, WebRequest.SCOPE_GLOBAL_SESSION);

 160          }
 161          Order cart = null;
 162          if (orderId != null) {
 163              cart = orderService.findOrderById(orderId);
 164  
 165              if (cart == null ||
 166                      cart.getStatus().equals(OrderStatus.SUBMITTED) ||
 167                      cart.getStatus().equals(OrderStatus.CANCELLED)) {
 168                  return null;
 169              }
 170          }
 171  
 172          return cart;
 173      }
 174  
 175      /**
<abbr title=" 176       * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implying that this is"> 176       * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implying that ðŸ”µ</abbr>
 177       * the logged in customer and we need to merge the carts
 178       */
 179      public boolean mergeCartNeeded(Customer customer, WebRequest request) {
 180          // When the user is a CSR, we want to disable cart merging
 181          if (crossAppAuthService != null &amp;&amp; crossAppAuthService.isAuthedFromAdmin()) {
 182              return false;
 183          }
 184  
 185          Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);
<abbr title=" 186          return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymousCustomer.getId()));"> 186          return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymousCustomeðŸ”µ</abbr>
 187      }
 188  
 189      /**
<abbr title=" 190       * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;customer&lt;/b&gt;. This"> 190       * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;customer&lt;/b&gt;ðŸ”µ</abbr>
 191       * will also remove the customer from session after it has finished since it is no longer needed
 192       */
 193      public Order mergeCart(Customer customer, WebRequest request) {
 194          Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);
 195          MergeCartResponse mergeCartResponse;
 196          try {
 197              Order cart = orderService.findCartForCustomer(anonymousCustomer);
 198              mergeCartResponse = mergeCartService.mergeCart(customer, cart);
 199          } catch (PricingException e) {
 200              throw new RuntimeException(e);
 201          } catch (RemoveFromCartException e) {
 202              throw new RuntimeException(e);
 203          }
 204  
 205          if (BLCRequestUtils.isOKtoUseSession(request)) {
 206              // The anonymous customer from session is no longer needed; it can be safely removed
 207              request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeName(),
 208                      WebRequest.SCOPE_GLOBAL_SESSION);

 209              request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeName(),
 210                      WebRequest.SCOPE_GLOBAL_SESSION);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -            request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_GLOBAL_SESSION);</span>



 213          }
 214          return mergeCartResponse.getOrder();
 215      }
 216  
 217      public static String getCartRequestAttributeName() {
 218          return cartRequestAttributeName;
 219      }
 220  
 221      public static void setCartRequestAttributeName(String cartRequestAttributeName) {
 222          CartStateRequestProcessor.cartRequestAttributeName = cartRequestAttributeName;
 223      }
 224  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            