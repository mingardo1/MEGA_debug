<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>165</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    165
                    <a href="164.html">prev</a>
                    <a href="166.html">next</a>
                    <a href="165_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_6e41116e816ffe5b940f6df83fbbf5a28e8c88bb_admin/broadleaf-admin-module/src/main/java/org/broadleafcommerce/admin/server/service/handler/ProductCustomPersistenceHandler.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;6e41116e816ffe5b940f6df83fbbf5a28e8c88bb:admin/broadleaf-admin-module/src/main/java/org/broadleafcommerce/admin/server/service/handler/ProductCustomPersistenceHandler.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;6e41116e816ffe5b940f6df83fbbf5a28e8c88bb^1:admin/broadleaf-admin-module/src/main/java/org/broadleafcommerce/admin/server/service/handler/ProductCustomPersistenceHandler.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;6e41116e816ffe5b940f6df83fbbf5a28e8c88bb^2:admin/broadleaf-admin-module/src/main/java/org/broadleafcommerce/admin/server/service/handler/ProductCustomPersistenceHandler.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;7aa99231e33d2cad425553c3c1de5a674270c4e1:admin/broadleaf-admin-module/src/main/java/org/broadleafcommerce/admin/server/service/handler/ProductCustomPersistenceHandler.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [s]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*-
   2  * #%L
   3  * BroadleafCommerce Admin Module
   4  * %%
   5  * Copyright (C) 2009 - 2022 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.admin.server.service.handler;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.lang.ArrayUtils;
  22 import org.apache.commons.lang3.StringUtils;
  23 import org.apache.commons.logging.Log;
  24 import org.apache.commons.logging.LogFactory;
<abbr title="  25 import org.broadleafcommerce.admin.server.service.extension.ProductCustomPersistenceHandlerExtensionManager;">  25 import org.broadleafcommerce.admin.server.service.extension.ProductCustomPersistenceHandlerExtensionManagðŸ”µ</abbr>
  26 import org.broadleafcommerce.common.exception.ExceptionHelper;
  27 import org.broadleafcommerce.common.exception.ServiceException;
  28 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  29 import org.broadleafcommerce.common.presentation.client.OperationType;
  30 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  31 import org.broadleafcommerce.common.service.ParentCategoryLegacyModeService;
  32 import org.broadleafcommerce.common.service.ParentCategoryLegacyModeServiceImpl;
  33 import org.broadleafcommerce.common.util.BLCCollectionUtils;
  34 import org.broadleafcommerce.common.util.TypedTransformer;
  35 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  36 import org.broadleafcommerce.core.catalog.domain.Category;
  37 import org.broadleafcommerce.core.catalog.domain.CategoryProductXref;
  38 import org.broadleafcommerce.core.catalog.domain.CategoryProductXrefImpl;
  39 import org.broadleafcommerce.core.catalog.domain.Product;
  40 import org.broadleafcommerce.core.catalog.domain.ProductBundle;
  41 import org.broadleafcommerce.core.catalog.domain.ProductImpl;
  42 import org.broadleafcommerce.core.catalog.domain.Sku;
  43 import org.broadleafcommerce.core.catalog.service.CatalogService;
  44 import org.broadleafcommerce.core.catalog.service.type.ProductBundlePricingModelType;
  45 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  46 import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  47 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  48 import org.broadleafcommerce.openadmin.dto.Entity;
  49 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  50 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  51 import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  52 import org.broadleafcommerce.openadmin.dto.PersistencePerspective;
  53 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  54 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  55 import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  56 import org.broadleafcommerce.openadmin.server.service.persistence.module.EmptyFilterValues;
  57 import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  58 import org.broadleafcommerce.openadmin.server.service.persistence.module.PersistenceModule;
  59 import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  60 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FieldPath;
  61 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FieldPathBuilder;
  62 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FilterMapping;
  63 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.Restriction;
<abbr title="  64 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.predicate.PredicateProvider;">  64 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.predicate.PredicateProvðŸ”µ</abbr>
  65 import org.springframework.beans.factory.annotation.Value;
  66 import org.springframework.stereotype.Component;
  67 import java.lang.reflect.Field;
  68 import java.util.ArrayList;
  69 import java.util.Arrays;
  70 import java.util.List;
  71 import java.util.Map;
  72 import java.util.stream.Stream;
  73 
  74 import javax.annotation.Resource;
  75 import javax.persistence.TypedQuery;
  76 import javax.persistence.criteria.CriteriaBuilder;
  77 import javax.persistence.criteria.CriteriaQuery;
  78 import javax.persistence.criteria.From;
  79 import javax.persistence.criteria.JoinType;
  80 import javax.persistence.criteria.Path;
  81 import javax.persistence.criteria.Predicate;
  82 import javax.persistence.criteria.Root;
  83 
  84 /**
  85  * @author Jeff Fischer
  86  */
  87 @Component(&quot;blProductCustomPersistenceHandler&quot;)
  88 public class ProductCustomPersistenceHandler extends CustomPersistenceHandlerAdapter {
  89 
  90     protected static final String ID_PROPERTY = &quot;id&quot;;
  91 
  92     @Resource(name = &quot;blCatalogService&quot;)
  93     protected CatalogService catalogService;
  94 
  95     @Resource(name = &quot;blProductCustomPersistenceHandlerExtensionManager&quot;)
  96     protected ProductCustomPersistenceHandlerExtensionManager extensionManager;
  97 
  98     @Resource(name = &quot;blParentCategoryLegacyModeService&quot;)
  99     protected ParentCategoryLegacyModeService parentCategoryLegacyModeService;
 100 
 101     @Resource(name = &quot;blSandBoxHelper&quot;)
 102     protected SandBoxHelper sandBoxHelper;
 103 
 104     @Value(&quot;${product.query.limit:500}&quot;)
 105     protected long queryLimit;
 106 
 107     @Value(&quot;${product.eager.fetch.associations.admin:true}&quot;)
 108     protected boolean eagerFetchAssociations = true;
 109 
 110     private static final Log LOG = LogFactory.getLog(ProductCustomPersistenceHandler.class);
 111 
 112     @Override
 113     public Boolean canHandleAdd(PersistencePackage persistencePackage) {
<abbr title=" 114         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 114         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 115         String[] customCriteria = persistencePackage.getCustomCriteria();
<abbr title=" 116         return !ArrayUtils.isEmpty(customCriteria) &amp;&amp; &quot;productDirectEdit&quot;.equals(customCriteria[0]) &amp;&amp; Product.class.getName().equals(ceilingEntityFullyQualifiedClassname);"> 116         return !ArrayUtils.isEmpty(customCriteria) &amp;&amp; &quot;productDirectEdit&quot;.equals(customCriteria[0]) &amp;&amp; PrðŸ”µ</abbr>
 117     }
 118 
 119     @Override
 120     public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 121         return canHandleAdd(persistencePackage);
 122     }
 123 
 124     @Override
 125     public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 126         return canHandleAdd(persistencePackage);
 127     }
 128 
 129     @Override
 130     public Boolean canHandleFetch(PersistencePackage persistencePackage) {
 131         return isRecursiveProductSelection(persistencePackage) || canHandleAdd(persistencePackage);
 132     }
 133 
 134     @Override
 135     public Boolean canHandleInspect(PersistencePackage persistencePackage) {
 136         return canHandleAdd(persistencePackage);
 137     }
 138 
 139     @Override
<abbr title=" 140     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 140     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityðŸ”µ</abbr>
 141         Map&lt;String, FieldMetadata&gt; md = getMetadata(persistencePackage, helper);
 142 
 143         modifyParentCategoryMetadata(md);
 144 
 145         extensionManager.getProxy().manageInspect(md);
 146 
 147         return getResultSet(persistencePackage, helper, md);
 148     }
 149 
 150     @Override
<abbr title=" 151     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao"> 151     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynaðŸ”µ</abbr>
 152             dynamicEntityDao, RecordHelper helper) throws ServiceException {
 153 
 154         if (isRecursiveProductSelection(persistencePackage)) {
 155             return getFilteredDynamicResultSet(persistencePackage, cto, helper);
 156         }
 157 
 158         boolean legacy = parentCategoryLegacyModeService.isLegacyMode();
 159 
 160         //the following code applies when filters are present only:
<abbr title=" 161         //&quot;legacy&quot; means that the parent category filter still utilizes Product.defaultCategory as the field to be matched"> 161         //&quot;legacy&quot; means that the parent category filter still utilizes Product.defaultCategory as the fiðŸ”µ</abbr>
<abbr title=" 162         //against the categories chosen in the listGrid filter. The default behavior up to this point, assumes the &quot;legacy&quot; mode."> 162         //against the categories chosen in the listGrid filter. The default behavior up to this point, asðŸ”µ</abbr>
<abbr title=" 163         //This means that one of the FilterAndSortCriterias will try to match the chosen values against &quot;defaultCategory&quot;."> 163         //This means that one of the FilterAndSortCriterias will try to match the chosen values against &quot;ðŸ”µ</abbr>
<abbr title=" 164         //If &quot;legacy&quot; is false, we remove that FilterAndSortCriteria from the CTO, and inject a new FilterMapping in cto.additionalFilterMappings,"> 164         //If &quot;legacy&quot; is false, we remove that FilterAndSortCriteria from the CTO, and inject a new FilteðŸ”µ</abbr>
 165         //which seeks matching values in  allParentCategoryXRefs instead
 166         if (!legacy) {
 167             FilterAndSortCriteria fsc = cto.getCriteriaMap().get(&quot;defaultCategory&quot;);
 168             if (fsc != null) {
 169                 List&lt;String&gt; filterValues = fsc.getFilterValues();
 170                 cto.getCriteriaMap().remove(&quot;defaultCategory&quot;);
 171 
<abbr title=" 172                 List&lt;Long&gt; transformedValues = BLCCollectionUtils.collectList(filterValues, new TypedTransformer&lt;Long&gt;() {"> 172                 List&lt;Long&gt; transformedValues = BLCCollectionUtils.collectList(filterValues, new TypedTranðŸ”µ</abbr>
 173                     @Override
 174                     public Long transform(Object input) {
 175                         return Long.parseLong(((String) input));
 176                     }
 177                 });
<abbr title=" 178                 CriteriaBuilder builder = dynamicEntityDao.getStandardEntityManager().getCriteriaBuilder();"> 178                 CriteriaBuilder builder = dynamicEntityDao.getStandardEntityManager().getCriteriaBuilder(ðŸ”µ</abbr>
 179                 CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 180                 Root&lt;CategoryProductXrefImpl&gt; root = criteria.from(CategoryProductXrefImpl.class);
 181                 criteria.select(root.get(&quot;product&quot;).get(&quot;id&quot;).as(Long.class));
 182                 List&lt;Predicate&gt; restrictions = new ArrayList&lt;Predicate&gt;();
 183                 restrictions.add(builder.equal(root.get(&quot;defaultReference&quot;), Boolean.TRUE));
 184                 if (CollectionUtils.isNotEmpty(transformedValues)) {
 185                     restrictions.add(root.get(&quot;category&quot;).get(&quot;id&quot;).in(transformedValues));
 186                 }
 187 
 188                 criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
<abbr title=" 189                 TypedQuery&lt;Long&gt; query = dynamicEntityDao.getStandardEntityManager().createQuery(criteria);"> 189                 TypedQuery&lt;Long&gt; query = dynamicEntityDao.getStandardEntityManager().createQuery(criteriaðŸ”µ</abbr>
 190                 List&lt;Long&gt; productIds = query.getResultList();
<abbr title=" 191                 productIds = sandBoxHelper.mergeCloneIds(ProductImpl.class, productIds.toArray(new Long[productIds.size()]));"> 191                 productIds = sandBoxHelper.mergeCloneIds(ProductImpl.class, productIds.toArray(new Long[pðŸ”µ</abbr>
 192 
 193                 if (productIds.size() == 0) {
 194                     return new DynamicResultSet(null, new Entity[0], 0);
 195                 }
 196                 if (productIds.size() &lt;= queryLimit) {
 197                     FilterMapping filterMapping = new FilterMapping()
 198                             .withFieldPath(new FieldPath().withTargetProperty(&quot;id&quot;))
 199                             .withDirectFilterValues(productIds)
 200                             .withRestriction(new Restriction()
 201                                                      .withPredicateProvider(new PredicateProvider() {
 202                                                                                 @Override
<abbr title=" 203                                                                                 public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder,"> 203                                                                                 public Predicate buildPreðŸ”µ</abbr>
<abbr title=" 204                                                                                                                 From root, String ceilingEntity, String fullPropertyName,"> 204                                                                                                          ðŸ”µ</abbr>
<abbr title=" 205                                                                                                                 Path explicitPath, List directValues) {"> 205                                                                                                          ðŸ”µ</abbr>
<abbr title=" 206                                                                                     return explicitPath.in(directValues);"> 206                                                                                     return explicitPath.iðŸ”µ</abbr>
 207                                                                                 }
 208                                                                             }
 209                                                      )
 210                             );
 211                     cto.getAdditionalFilterMappings().add(filterMapping);
 212                 } else {
 213                     String joined = StringUtils.join(transformedValues, &#x27;,&#x27;);
<abbr title=" 214                     LOG.warn(String.format(&quot;Skipping default category filtering for product fetch query since there are &quot; +"> 214                     LOG.warn(String.format(&quot;Skipping default category filtering for product fetch query sðŸ”µ</abbr>
<abbr title=" 215                                            &quot;more than &quot; + queryLimit + &quot; products found to belong to the selected default categories(%s). This is a &quot; +"> 215                                            &quot;more than &quot; + queryLimit + &quot; products found to belong to the ðŸ”µ</abbr>
 216                                            &quot;filter query limitation.&quot;, joined));
 217                 }
 218                 cto.getNonCountAdditionalFilterMappings().add(
 219                         new FilterMapping().withFieldPath(new FieldPath().
 220                                 withAssociationPath(Arrays.asList(&quot;allParentCategoryXrefs&quot;,&quot;category&quot;)).
 221                                 withTargetPropertyPieces(Arrays.asList(&quot;name&quot;)))
 222                                 .withDirectFilterValues(new EmptyFilterValues())
 223                                 .withRestriction(new Restriction()
 224                                         .withPredicateProvider(new PredicateProvider() {
 225                                             @Override
 226                                             public Predicate buildPredicate(CriteriaBuilder builder,
<abbr title=" 227                                                                             FieldPathBuilder fieldPathBuilder, From root,"> 227                                                                             FieldPathBuilder fieldPathBuiðŸ”µ</abbr>
 228                                                                             String ceilingEntity,
<abbr title=" 229                                                                             String fullPropertyName, Path explicitPath,"> 229                                                                             String fullPropertyName, PathðŸ”µ</abbr>
 230                                                                             List directValues) {
<abbr title=" 231                                                 //expect it to be allParentCategoryXrefs.category.name, so we need to restrict on allParentCategoryXrefs - 2 levels up"> 231                                                 //expect it to be allParentCategoryXrefs.category.name, sðŸ”µ</abbr>
<abbr title=" 232                                                 Predicate equal = builder.equal(explicitPath.getParentPath().getParentPath().get(&quot;defaultReference&quot;), Boolean.TRUE);"> 232                                                 Predicate equal = builder.equal(explicitPath.getParentPatðŸ”µ</abbr>
 233                                                 return equal;
 234                                             }
 235                                         })
 236                                 ).withSortDirection(fsc.getSortDirection()));
 237             }
 238         }
 239 
 240         if (eagerFetchAssociations) {
 241             cto.getNonCountAdditionalFilterMappings().add(new FilterMapping()
<abbr title=" 242                                                                   .withDirectFilterValues(new EmptyFilterValues())"> 242                                                                   .withDirectFilterValues(new EmptyFilterðŸ”µ</abbr>
 243                                                                   .withRestriction(new Restriction()
<abbr title=" 244                                                                                            .withPredicateProvider(new PredicateProvider() {"> 244                                                                                            .withPredicateðŸ”µ</abbr>
 245                                                                                                @Override
<abbr title=" 246                                                                                                public Predicate buildPredicate(CriteriaBuilder builder,"> 246                                                                                                public PreðŸ”µ</abbr>
<abbr title=" 247                                                                                                                                FieldPathBuilder fieldPathBuilder, From root,"> 247                                                                                                          ðŸ”µ</abbr>
<abbr title=" 248                                                                                                                                String ceilingEntity,"> 248                                                                                                          ðŸ”µ</abbr>
<abbr title=" 249                                                                                                                                String fullPropertyName, Path explicitPath,"> 249                                                                                                          ðŸ”µ</abbr>
<abbr title=" 250                                                                                                                                List directValues) {"> 250                                                                                                          ðŸ”µ</abbr>
<abbr title=" 251                                                                                                    root.fetch(&quot;defaultSku&quot;, JoinType.LEFT);"> 251                                                                                                    root.fðŸ”µ</abbr>
<abbr title=" 252                                                                                                    root.fetch(&quot;defaultCategory&quot;, JoinType.LEFT);"> 252                                                                                                    root.fðŸ”µ</abbr>
<abbr title=" 253                                                                                                    return null;"> 253                                                                                                    returnðŸ”µ</abbr>
 254                                                                                                }
 255                                                                                            })
 256                                                                   ));
 257         }
 258         return helper.getCompatibleModule(OperationType.BASIC).fetch(persistencePackage, cto);
 259     }
 260 
 261     @Override
<abbr title=" 262     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 262     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelðŸ”µ</abbr>
 263         Entity entity = persistencePackage.getEntity();
 264         try {
<abbr title=" 265             PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();"> 265             PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective(ðŸ”µ</abbr>
 266             Product adminInstance = (Product) Class.forName(entity.getType()[0]).newInstance();
<abbr title=" 267             Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 267             Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.gðŸ”µ</abbr>
 268 
 269             if (adminInstance instanceof ProductBundle) {
 270                 removeBundleFieldRestrictions((ProductBundle) adminInstance, adminProperties, entity);
 271             }
 272 
<abbr title=" 273             adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminProperties, false);"> 273             adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminPropertiðŸ”µ</abbr>
 274             adminInstance = dynamicEntityDao.merge(adminInstance);
 275 
 276             //Since none of the Sku fields are required, it&#x27;s possible that the user did not fill out
<abbr title=" 277             //any Sku fields, and thus a Sku would not be created. Product still needs a default Sku so instantiate one"> 277             //any Sku fields, and thus a Sku would not be created. Product still needs a default Sku so iðŸ”µ</abbr>
 278             if (adminInstance.getDefaultSku() == null) {
 279                 Sku newSku = catalogService.createSku();
 280                 dynamicEntityDao.persist(newSku);
 281                 adminInstance.setDefaultSku(newSku);
 282                 adminInstance = dynamicEntityDao.merge(adminInstance);
 283             }
 284 
 285             //also set the default product for the Sku
 286             adminInstance.getDefaultSku().setDefaultProduct(adminInstance);
 287             dynamicEntityDao.merge(adminInstance.getDefaultSku());
 288 
 289             // if this is a Pre-Add, skip the rest of the method
 290             if (entity.isPreAdd()) {
 291                 return helper.getRecord(adminProperties, adminInstance, null, null);
 292             }
 293 
 294             boolean handled = false;
 295             if (extensionManager != null) {
<abbr title=" 296                 ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForAdd(persistencePackage, adminInstance);"> 296                 ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForAddðŸ”µ</abbr>
 297                 handled = ExtensionResultStatusType.NOT_HANDLED != result;
 298             }
 299             if (!handled) {
 300                 setupXref(adminInstance);
 301             }
 302 
 303             return helper.getRecord(adminProperties, adminInstance, null, null);
 304         } catch (Exception e) {
 305             throw new ServiceException(&quot;Unable to add entity for &quot; + entity.getType()[0], e);
 306         }
 307     }
 308 
 309     @Override
<abbr title=" 310     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 310     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordðŸ”µ</abbr>
 311         Entity entity = persistencePackage.getEntity();
 312         try {
<abbr title=" 313             PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();"> 313             PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective(ðŸ”µ</abbr>
 314 
<abbr title=" 315             Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 315             Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.gðŸ”µ</abbr>
 316 
<abbr title=" 317             BasicFieldMetadata defaultCategory = ((BasicFieldMetadata) adminProperties.get(&quot;defaultCategory&quot;));"> 317             BasicFieldMetadata defaultCategory = ((BasicFieldMetadata) adminProperties.get(&quot;defaultCategoðŸ”µ</abbr>
 318             defaultCategory.setFriendlyName(&quot;ProductImpl_Parent_Category&quot;);
<abbr title=" 319             if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; !StringUtils.isEmpty(entity.findProperty(&quot;defaultCategory&quot;).getValue())) {"> 319             if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; !StringUtils.isEmpty(entity.findPropertðŸ”µ</abbr>
<abbr title=" 320                 //Change the inherited type so that this property is disconnected from the entity and validation is temporarily skipped."> 320                 //Change the inherited type so that this property is disconnected from the entity and valðŸ”µ</abbr>
<abbr title=" 321                 //This is useful when the defaultCategory was previously completely empty for whatever reason. Without this, such"> 321                 //This is useful when the defaultCategory was previously completely empty for whatever reðŸ”µ</abbr>
<abbr title=" 322                 //a case would fail the validation, even though the property was specified in the submission."> 322                 //a case would fail the validation, even though the property was specified in the submissðŸ”µ</abbr>
 323                 defaultCategory.setInheritedFromType(String.class.getName());
 324             }
 325 
 326             Object primaryKey = helper.getPrimaryKey(entity, adminProperties);
<abbr title=" 327             Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(entity.getType()[0]), primaryKey);"> 327             Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(entity.getType()[0]ðŸ”µ</abbr>
 328             if (adminInstance instanceof ProductBundle) {
 329                 removeBundleFieldRestrictions((ProductBundle) adminInstance, adminProperties, entity);
 330             }
 331 
 332             CategoryProductXref oldDefault = getCurrentDefaultXref(adminInstance);
<abbr title=" 333             //Fix for QA#2963 - during deployment sanboxed (not deployed) version of category will not be fetched from db"> 333             //Fix for QA#2963 - during deployment sanboxed (not deployed) version of category will not beðŸ”µ</abbr>
<abbr title=" 334             //and it will cause validation error, we should allow deployemnt of product with category in sandbox state"> 334             //and it will cause validation error, we should allow deployemnt of product with category in ðŸ”µ</abbr>
 335             //so override required flag for that field during deployment
 336             if(BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()){
 337                 ((BasicFieldMetadata)adminProperties.get(&quot;defaultCategory&quot;)).setRequiredOverride(false);
 338             }
<abbr title=" 339             adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminProperties, false);"> 339             adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminPropertiðŸ”µ</abbr>
 340             adminInstance = dynamicEntityDao.merge(adminInstance);
 341             boolean handled = false;
 342             if (extensionManager != null) {
<abbr title=" 343                 ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForUpdate"> 343                 ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForUpdðŸ”µ</abbr>
 344                         (persistencePackage, adminInstance);
 345                 handled = ExtensionResultStatusType.NOT_HANDLED != result;
 346 
 347                 extensionManager.getProxy().manageFields(persistencePackage, adminInstance);
 348             }
 349             if (!handled) {
 350                 setupXref(adminInstance);
 351                 removeOldDefault(adminInstance, oldDefault, entity);
 352             }
 353 
 354             return helper.getRecord(adminProperties, adminInstance, null, null);
 355         } catch (Exception e) {
 356             throw new ServiceException(&quot;Unable to update entity for &quot; + entity.getType()[0], e);
 357         }
 358     }
 359 
 360     @Override
<abbr title=" 361     public void remove(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 361     public void remove(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHeðŸ”µ</abbr>
 362         Entity entity = persistencePackage.getEntity();
 363         try {
<abbr title=" 364             Product adminInstance = getAdminInstance(persistencePackage, dynamicEntityDao, helper, entity);"> 364             Product adminInstance = getAdminInstance(persistencePackage, dynamicEntityDao, helper, entityðŸ”µ</abbr>
 365             removeProduct(persistencePackage, adminInstance, helper);
 366             List&lt;Sku&gt; skuList = adminInstance.getAllSkus();
 367             for (Sku sku : skuList) {
 368                 catalogService.removeSku(sku);
 369             }
 370         } catch (ClassNotFoundException e) {
 371             throw new ServiceException(&quot;Unable to remove entity for &quot; + entity.getType()[0], e);
 372         }
 373     }
 374 
<abbr title=" 375     protected Product getAdminInstance(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper,"> 375     protected Product getAdminInstance(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntðŸ”µ</abbr>
 376                                        Entity entity) throws ClassNotFoundException {
 377         PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();
<abbr title=" 378         Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 378         Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getNaðŸ”µ</abbr>
 379         Object primaryKey = helper.getPrimaryKey(entity, adminProperties);
 380         String type = entity.getType()[0];
 381         Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(type), primaryKey);
 382 
 383         return adminInstance;
 384     }
 385 
<abbr title=" 386     protected void removeProduct(PersistencePackage persistencePackage, Product adminInstance, RecordHelper helper) throws ServiceException {"> 386     protected void removeProduct(PersistencePackage persistencePackage, Product adminInstance, RecordHelpðŸ”µ</abbr>
 387         catalogService.removeProduct(adminInstance);
 388     }
 389 
 390     /**
 391      * If the pricing model is of type item_sum, that property should not be required
 392      *
 393      * @param adminInstance
 394      * @param adminProperties
 395      * @param entity
 396      */
<abbr title=" 397     protected void removeBundleFieldRestrictions(ProductBundle adminInstance, Map&lt;String, FieldMetadata&gt; adminProperties, Entity entity) {"> 397     protected void removeBundleFieldRestrictions(ProductBundle adminInstance, Map&lt;String, FieldMetadata&gt; ðŸ”µ</abbr>
 398         //no required validation for product bundles
 399         ((BasicFieldMetadata) adminProperties.get(&quot;defaultSku.retailPrice&quot;)).setRequiredOverride(false);
 400         if (entity.getPMap().get(&quot;pricingModel&quot;) != null) {
<abbr title=" 401             if (ProductBundlePricingModelType.BUNDLE.getType().equals(entity.getPMap().get(&quot;pricingModel&quot;).getValue())) {"> 401             if (ProductBundlePricingModelType.BUNDLE.getType().equals(entity.getPMap().get(&quot;pricingModel&quot;ðŸ”µ</abbr>
<abbr title=" 402                 ((BasicFieldMetadata) adminProperties.get(&quot;defaultSku.retailPrice&quot;)).setRequiredOverride(true);"> 402                 ((BasicFieldMetadata) adminProperties.get(&quot;defaultSku.retailPrice&quot;)).setRequiredOverride(ðŸ”µ</abbr>
 403             }
 404         }
 405     }
 406 
 407     protected Boolean isDefaultCategoryLegacyMode() {
<abbr title=" 408         ParentCategoryLegacyModeService legacyModeService = ParentCategoryLegacyModeServiceImpl.getLegacyModeService();"> 408         ParentCategoryLegacyModeService legacyModeService = ParentCategoryLegacyModeServiceImpl.getLegacyðŸ”µ</abbr>
 409         if (legacyModeService != null) {
 410             return legacyModeService.isLegacyMode();
 411         }
 412         return false;
 413     }
 414 
 415     protected void modifyParentCategoryMetadata(Map&lt;String, FieldMetadata&gt; md) {
 416         if (!isDefaultCategoryLegacyMode()) {
 417             md.remove(&quot;allParentCategoryXrefs&quot;);
 418 
 419             BasicFieldMetadata defaultCategory = ((BasicFieldMetadata) md.get(&quot;defaultCategory&quot;));
 420             defaultCategory.setFriendlyName(&quot;ProductImpl_Parent_Category&quot;);
 421         }
 422     }
 423 
 424     protected Category getExistingDefaultCategory(Product product) {
 425         //Make sure we get the actual field value - not something manipulated in the getter
 426         Category parentCategory;
 427         try {
 428             Field defaultCategory = ProductImpl.class.getDeclaredField(&quot;defaultCategory&quot;);
 429             defaultCategory.setAccessible(true);
 430             parentCategory = (Category) defaultCategory.get(product);
 431         } catch (NoSuchFieldException e) {
 432             throw ExceptionHelper.refineException(e);
 433         } catch (IllegalAccessException e) {
 434             throw ExceptionHelper.refineException(e);
 435         }
 436         return parentCategory;
 437     }
 438 
<abbr title=" 439     protected void removeOldDefault(Product adminInstance, CategoryProductXref oldDefault, Entity entity) {"> 439     protected void removeOldDefault(Product adminInstance, CategoryProductXref oldDefault, Entity entity)ðŸ”µ</abbr>
 440         if (!isDefaultCategoryLegacyMode()) {
<abbr title=" 441             if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; StringUtils.isEmpty(entity.findProperty(&quot;defaultCategory&quot;).getValue())) {"> 441             if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; StringUtils.isEmpty(entity.findPropertyðŸ”µ</abbr>
 442                 adminInstance.setCategory(null);
 443             }
 444             CategoryProductXref newDefault = getCurrentDefaultXref(adminInstance);
 445             if (oldDefault != null &amp;&amp; !oldDefault.equals(newDefault)) {
 446                 adminInstance.getAllParentCategoryXrefs().remove(oldDefault);
 447             }
 448         }
 449     }
 450 
 451     protected void setupXref(Product adminInstance) {
 452         if (isDefaultCategoryLegacyMode()) {
 453             CategoryProductXref categoryXref = new CategoryProductXrefImpl();
 454             categoryXref.setCategory(getExistingDefaultCategory(adminInstance));
 455             categoryXref.setProduct(adminInstance);
<abbr title=" 456             if (!adminInstance.getAllParentCategoryXrefs().contains(categoryXref) &amp;&amp; categoryXref.getCategory() != null) {"> 456             if (!adminInstance.getAllParentCategoryXrefs().contains(categoryXref) &amp;&amp; categoryXref.getCateðŸ”µ</abbr>
 457                 adminInstance.getAllParentCategoryXrefs().add(categoryXref);
 458             }
 459         }
 460     }
 461 
 462     protected CategoryProductXref getCurrentDefaultXref(Product product) {
 463         CategoryProductXref currentDefault = null;
 464         List&lt;CategoryProductXref&gt; xrefs = product.getAllParentCategoryXrefs();
 465         if (!CollectionUtils.isEmpty(xrefs)) {
 466             for (CategoryProductXref xref : xrefs) {
<abbr title=" 467                 if (xref.getCategory().isActive() &amp;&amp; xref.getDefaultReference() != null &amp;&amp; xref.getDefaultReference()) {"> 467                 if (xref.getCategory().isActive() &amp;&amp; xref.getDefaultReference() != null &amp;&amp; xref.getDefaulðŸ”µ</abbr>
 468                     currentDefault = xref;
 469                     break;
 470                 }
 471             }
 472         }
 473         return currentDefault;
 474     }
 475 
 476     protected boolean isRecursiveProductSelection(PersistencePackage persistencePackage) {
 477         final List&lt;String&gt; customCriteria = Arrays.asList(persistencePackage.getCustomCriteria());
 478         return Stream.of(&quot;upsaleProduct&quot;, &quot;crossSaleProduct&quot;, &quot;requestingField=addOnProduct&quot;)
 479                 .anyMatch(customCriteria::contains);
 480     }
 481 
<abbr title=" 482     protected FilterMapping createFilterMappingForProperty(String targetPropertyName, PredicateProvider predicateProvider) {"> 482     protected FilterMapping createFilterMappingForProperty(String targetPropertyName, PredicateProvider pðŸ”µ</abbr>
 483 
 484         FieldPath fieldPath = new FieldPath().withTargetProperty(targetPropertyName);
 485         EmptyFilterValues directFilterValues = new EmptyFilterValues();
 486         Restriction newRestriction = new Restriction().withPredicateProvider(predicateProvider);
 487 
 488         return new FilterMapping()
 489             .withFieldPath(fieldPath)
 490             .withDirectFilterValues(directFilterValues)
 491             .withRestriction(newRestriction);
 492     }
 493 
<abbr title=" 494     protected DynamicResultSet getFilteredDynamicResultSet(PersistencePackage persistencePackage, CriteriaTransferObject cto, RecordHelper helper) throws ServiceException {"> 494     protected DynamicResultSet getFilteredDynamicResultSet(PersistencePackage persistencePackage, CriteriðŸ”µ</abbr>
 495 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 496         if(persistencePackage.getSectionCrumbs()!=null &amp;&amp; persistencePackage.getSectionCrumbs().length&gt;0) {"> 496         if(persistencePackage.getSectionCrumbs()!=null &amp;&amp; persistencePackage.getSectionCrumbs().length&gt;0)ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 497             FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicateProvider() {"> 497             FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 498                 @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 499                 public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder, From root,"> 499                 public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuildeðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 500                                                 String ceilingEntity, String fullPropertyName, Path explicitPath,"> 500                                                 String ceilingEntity, String fullPropertyName, Path expliðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 501                                                 List directValues) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 502                     return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbs()[0].getSectionId()));"> 502                     return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbsðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 503                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 504             });</span>
 505 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 506         FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicateProvider() {"> 506         FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicatePðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 507             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 508             public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder, From root,"> 508             public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder, FðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 509                                             String ceilingEntity, String fullPropertyName, Path explicitPath,"> 509                                             String ceilingEntity, String fullPropertyName, Path explicitPðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510                                             List directValues) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 511                 return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbs()[0].getSectionId()));"> 511                 return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbs()[0ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 512             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 513         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 514         cto.getAdditionalFilterMappings().add(defaultCategoryMapping);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 515         OperationType fetchType = persistencePackage.getPersistencePerspective().getOperationTypes().getFetchType();"> 515         OperationType fetchType = persistencePackage.getPersistencePerspective().getOperationTypes().getFðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 516         PersistenceModule persistenceModule = helper.getCompatibleModule(fetchType);</span>
 517 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518         SectionCrumb[] sectionCrumbs = persistencePackage.getSectionCrumbs();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519         if (sectionCrumbs != null &amp;&amp; sectionCrumbs.length &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520             FilterMapping defaultCategoryMapping = this.createFilterMappingForProperty(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521                     ID_PROPERTY,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 522                     (builder, fieldPathBuilder, root, ceilingEntity, fullPropertyName, explicitPath, directValues)"> 522                     (builder, fieldPathBuilder, root, ceilingEntity, fullPropertyName, explicitPath, direðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 523                             -&gt; builder.and(builder.notEqual(explicitPath, sectionCrumbs[0].getSectionId()))"> 523                             -&gt; builder.and(builder.notEqual(explicitPath, sectionCrumbs[0].getSectionId()ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524             );</span>
 525 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 526             cto.getAdditionalFilterMappings().add(defaultCategoryMapping);
 527         }
<abbr title=" 528         OperationType fetchType = persistencePackage.getPersistencePerspective().getOperationTypes().getFetchType();"> 528         OperationType fetchType = persistencePackage.getPersistencePerspective().getOperationTypes().getFðŸ”µ</abbr>
 529         PersistenceModule persistenceModule = helper.getCompatibleModule(fetchType);
 530         return persistenceModule.fetch(persistencePackage, cto);
 531     }
 532 }</pre></td>
                            <td><pre>   1 /*-
   2  * #%L
   3  * BroadleafCommerce Admin Module
   4  * %%
   5  * Copyright (C) 2009 - 2022 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.admin.server.service.handler;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.lang.ArrayUtils;
  22 import org.apache.commons.lang3.StringUtils;
  23 import org.apache.commons.logging.Log;
  24 import org.apache.commons.logging.LogFactory;
<abbr title="  25 import org.broadleafcommerce.admin.server.service.extension.ProductCustomPersistenceHandlerExtensionManager;">  25 import org.broadleafcommerce.admin.server.service.extension.ProductCustomPersistenceHandlerExtensionManagðŸ”µ</abbr>
  26 import org.broadleafcommerce.common.exception.ExceptionHelper;
  27 import org.broadleafcommerce.common.exception.ServiceException;
  28 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  29 import org.broadleafcommerce.common.presentation.client.OperationType;
  30 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  31 import org.broadleafcommerce.common.service.ParentCategoryLegacyModeService;
  32 import org.broadleafcommerce.common.service.ParentCategoryLegacyModeServiceImpl;
  33 import org.broadleafcommerce.common.util.BLCCollectionUtils;
  34 import org.broadleafcommerce.common.util.TypedTransformer;
  35 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  36 import org.broadleafcommerce.core.catalog.domain.Category;
  37 import org.broadleafcommerce.core.catalog.domain.CategoryProductXref;
  38 import org.broadleafcommerce.core.catalog.domain.CategoryProductXrefImpl;
  39 import org.broadleafcommerce.core.catalog.domain.Product;
  40 import org.broadleafcommerce.core.catalog.domain.ProductBundle;
  41 import org.broadleafcommerce.core.catalog.domain.ProductImpl;
  42 import org.broadleafcommerce.core.catalog.domain.Sku;
  43 import org.broadleafcommerce.core.catalog.service.CatalogService;
  44 import org.broadleafcommerce.core.catalog.service.type.ProductBundlePricingModelType;
  45 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  46 import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  47 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  48 import org.broadleafcommerce.openadmin.dto.Entity;
  49 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  50 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  51 import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  52 import org.broadleafcommerce.openadmin.dto.PersistencePerspective;
  53 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  54 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  55 import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  56 import org.broadleafcommerce.openadmin.server.service.persistence.module.EmptyFilterValues;
  57 import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  58 import org.broadleafcommerce.openadmin.server.service.persistence.module.PersistenceModule;
  59 import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  60 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FieldPath;
  61 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FieldPathBuilder;
  62 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FilterMapping;
  63 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.Restriction;
<abbr title="  64 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.predicate.PredicateProvider;">  64 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.predicate.PredicateProvðŸ”µ</abbr>
  65 import org.springframework.beans.factory.annotation.Value;
  66 import org.springframework.stereotype.Component;
  67 import java.lang.reflect.Field;
  68 import java.util.ArrayList;
  69 import java.util.Arrays;
  70 import java.util.List;
  71 import java.util.Map;
  72 import java.util.stream.Stream;
  73 
  74 import javax.annotation.Resource;
  75 import javax.persistence.TypedQuery;
  76 import javax.persistence.criteria.CriteriaBuilder;
  77 import javax.persistence.criteria.CriteriaQuery;
  78 import javax.persistence.criteria.From;
  79 import javax.persistence.criteria.JoinType;
  80 import javax.persistence.criteria.Path;
  81 import javax.persistence.criteria.Predicate;
  82 import javax.persistence.criteria.Root;
  83 
  84 /**
  85  * @author Jeff Fischer
  86  */
  87 @Component(&quot;blProductCustomPersistenceHandler&quot;)
  88 public class ProductCustomPersistenceHandler extends CustomPersistenceHandlerAdapter {
  89 
  90     protected static final String ID_PROPERTY = &quot;id&quot;;
  91 
  92     @Resource(name = &quot;blCatalogService&quot;)
  93     protected CatalogService catalogService;
  94 
  95     @Resource(name = &quot;blProductCustomPersistenceHandlerExtensionManager&quot;)
  96     protected ProductCustomPersistenceHandlerExtensionManager extensionManager;
  97 
  98     @Resource(name = &quot;blParentCategoryLegacyModeService&quot;)
  99     protected ParentCategoryLegacyModeService parentCategoryLegacyModeService;
 100 
 101     @Resource(name = &quot;blSandBoxHelper&quot;)
 102     protected SandBoxHelper sandBoxHelper;
 103 
 104     @Value(&quot;${product.query.limit:500}&quot;)
 105     protected long queryLimit;
 106 
 107     @Value(&quot;${product.eager.fetch.associations.admin:true}&quot;)
 108     protected boolean eagerFetchAssociations = true;
 109 
 110     private static final Log LOG = LogFactory.getLog(ProductCustomPersistenceHandler.class);
 111 
 112     @Override
 113     public Boolean canHandleAdd(PersistencePackage persistencePackage) {
<abbr title=" 114         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 114         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 115         String[] customCriteria = persistencePackage.getCustomCriteria();
<abbr title=" 116         return !ArrayUtils.isEmpty(customCriteria) &amp;&amp; &quot;productDirectEdit&quot;.equals(customCriteria[0]) &amp;&amp; Product.class.getName().equals(ceilingEntityFullyQualifiedClassname);"> 116         return !ArrayUtils.isEmpty(customCriteria) &amp;&amp; &quot;productDirectEdit&quot;.equals(customCriteria[0]) &amp;&amp; PrðŸ”µ</abbr>
 117     }
 118 
 119     @Override
 120     public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 121         return canHandleAdd(persistencePackage);
 122     }
 123 
 124     @Override
 125     public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 126         return canHandleAdd(persistencePackage);
 127     }
 128 
 129     @Override
 130     public Boolean canHandleFetch(PersistencePackage persistencePackage) {
 131         return isRecursiveProductSelection(persistencePackage) || canHandleAdd(persistencePackage);
 132     }
 133 
 134     @Override
 135     public Boolean canHandleInspect(PersistencePackage persistencePackage) {
 136         return canHandleAdd(persistencePackage);
 137     }
 138 
 139     @Override
<abbr title=" 140     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 140     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityðŸ”µ</abbr>
 141         Map&lt;String, FieldMetadata&gt; md = getMetadata(persistencePackage, helper);
 142 
 143         modifyParentCategoryMetadata(md);
 144 
 145         extensionManager.getProxy().manageInspect(md);
 146 
 147         return getResultSet(persistencePackage, helper, md);
 148     }
 149 
 150     @Override
<abbr title=" 151     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao"> 151     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynaðŸ”µ</abbr>
 152             dynamicEntityDao, RecordHelper helper) throws ServiceException {
 153 
 154         if (isRecursiveProductSelection(persistencePackage)) {
 155             return getFilteredDynamicResultSet(persistencePackage, cto, helper);
 156         }
 157 
 158         boolean legacy = parentCategoryLegacyModeService.isLegacyMode();
 159 
 160         //the following code applies when filters are present only:
<abbr title=" 161         //&quot;legacy&quot; means that the parent category filter still utilizes Product.defaultCategory as the field to be matched"> 161         //&quot;legacy&quot; means that the parent category filter still utilizes Product.defaultCategory as the fiðŸ”µ</abbr>
<abbr title=" 162         //against the categories chosen in the listGrid filter. The default behavior up to this point, assumes the &quot;legacy&quot; mode."> 162         //against the categories chosen in the listGrid filter. The default behavior up to this point, asðŸ”µ</abbr>
<abbr title=" 163         //This means that one of the FilterAndSortCriterias will try to match the chosen values against &quot;defaultCategory&quot;."> 163         //This means that one of the FilterAndSortCriterias will try to match the chosen values against &quot;ðŸ”µ</abbr>
<abbr title=" 164         //If &quot;legacy&quot; is false, we remove that FilterAndSortCriteria from the CTO, and inject a new FilterMapping in cto.additionalFilterMappings,"> 164         //If &quot;legacy&quot; is false, we remove that FilterAndSortCriteria from the CTO, and inject a new FilteðŸ”µ</abbr>
 165         //which seeks matching values in  allParentCategoryXRefs instead
 166         if (!legacy) {
 167             FilterAndSortCriteria fsc = cto.getCriteriaMap().get(&quot;defaultCategory&quot;);
 168             if (fsc != null) {
 169                 List&lt;String&gt; filterValues = fsc.getFilterValues();
 170                 cto.getCriteriaMap().remove(&quot;defaultCategory&quot;);
 171 
<abbr title=" 172                 List&lt;Long&gt; transformedValues = BLCCollectionUtils.collectList(filterValues, new TypedTransformer&lt;Long&gt;() {"> 172                 List&lt;Long&gt; transformedValues = BLCCollectionUtils.collectList(filterValues, new TypedTranðŸ”µ</abbr>
 173                     @Override
 174                     public Long transform(Object input) {
 175                         return Long.parseLong(((String) input));
 176                     }
 177                 });
<abbr title=" 178                 CriteriaBuilder builder = dynamicEntityDao.getStandardEntityManager().getCriteriaBuilder();"> 178                 CriteriaBuilder builder = dynamicEntityDao.getStandardEntityManager().getCriteriaBuilder(ðŸ”µ</abbr>
 179                 CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 180                 Root&lt;CategoryProductXrefImpl&gt; root = criteria.from(CategoryProductXrefImpl.class);
 181                 criteria.select(root.get(&quot;product&quot;).get(&quot;id&quot;).as(Long.class));
 182                 List&lt;Predicate&gt; restrictions = new ArrayList&lt;Predicate&gt;();
 183                 restrictions.add(builder.equal(root.get(&quot;defaultReference&quot;), Boolean.TRUE));
 184                 if (CollectionUtils.isNotEmpty(transformedValues)) {
 185                     restrictions.add(root.get(&quot;category&quot;).get(&quot;id&quot;).in(transformedValues));
 186                 }
 187 
 188                 criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
<abbr title=" 189                 TypedQuery&lt;Long&gt; query = dynamicEntityDao.getStandardEntityManager().createQuery(criteria);"> 189                 TypedQuery&lt;Long&gt; query = dynamicEntityDao.getStandardEntityManager().createQuery(criteriaðŸ”µ</abbr>
 190                 List&lt;Long&gt; productIds = query.getResultList();
<abbr title=" 191                 productIds = sandBoxHelper.mergeCloneIds(ProductImpl.class, productIds.toArray(new Long[productIds.size()]));"> 191                 productIds = sandBoxHelper.mergeCloneIds(ProductImpl.class, productIds.toArray(new Long[pðŸ”µ</abbr>
 192 
 193                 if (productIds.size() == 0) {
 194                     return new DynamicResultSet(null, new Entity[0], 0);
 195                 }
 196                 if (productIds.size() &lt;= queryLimit) {
 197                     FilterMapping filterMapping = new FilterMapping()
 198                             .withFieldPath(new FieldPath().withTargetProperty(&quot;id&quot;))
 199                             .withDirectFilterValues(productIds)
 200                             .withRestriction(new Restriction()
 201                                                      .withPredicateProvider(new PredicateProvider() {
 202                                                                                 @Override
<abbr title=" 203                                                                                 public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder,"> 203                                                                                 public Predicate buildPreðŸ”µ</abbr>
<abbr title=" 204                                                                                                                 From root, String ceilingEntity, String fullPropertyName,"> 204                                                                                                          ðŸ”µ</abbr>
<abbr title=" 205                                                                                                                 Path explicitPath, List directValues) {"> 205                                                                                                          ðŸ”µ</abbr>
<abbr title=" 206                                                                                     return explicitPath.in(directValues);"> 206                                                                                     return explicitPath.iðŸ”µ</abbr>
 207                                                                                 }
 208                                                                             }
 209                                                      )
 210                             );
 211                     cto.getAdditionalFilterMappings().add(filterMapping);
 212                 } else {
 213                     String joined = StringUtils.join(transformedValues, &#x27;,&#x27;);
<abbr title=" 214                     LOG.warn(String.format(&quot;Skipping default category filtering for product fetch query since there are &quot; +"> 214                     LOG.warn(String.format(&quot;Skipping default category filtering for product fetch query sðŸ”µ</abbr>
<abbr title=" 215                                            &quot;more than &quot; + queryLimit + &quot; products found to belong to the selected default categories(%s). This is a &quot; +"> 215                                            &quot;more than &quot; + queryLimit + &quot; products found to belong to the ðŸ”µ</abbr>
 216                                            &quot;filter query limitation.&quot;, joined));
 217                 }
 218                 cto.getNonCountAdditionalFilterMappings().add(
 219                         new FilterMapping().withFieldPath(new FieldPath().
 220                                 withAssociationPath(Arrays.asList(&quot;allParentCategoryXrefs&quot;,&quot;category&quot;)).
 221                                 withTargetPropertyPieces(Arrays.asList(&quot;name&quot;)))
 222                                 .withDirectFilterValues(new EmptyFilterValues())
 223                                 .withRestriction(new Restriction()
 224                                         .withPredicateProvider(new PredicateProvider() {
 225                                             @Override
 226                                             public Predicate buildPredicate(CriteriaBuilder builder,
<abbr title=" 227                                                                             FieldPathBuilder fieldPathBuilder, From root,"> 227                                                                             FieldPathBuilder fieldPathBuiðŸ”µ</abbr>
 228                                                                             String ceilingEntity,
<abbr title=" 229                                                                             String fullPropertyName, Path explicitPath,"> 229                                                                             String fullPropertyName, PathðŸ”µ</abbr>
 230                                                                             List directValues) {
<abbr title=" 231                                                 //expect it to be allParentCategoryXrefs.category.name, so we need to restrict on allParentCategoryXrefs - 2 levels up"> 231                                                 //expect it to be allParentCategoryXrefs.category.name, sðŸ”µ</abbr>
<abbr title=" 232                                                 Predicate equal = builder.equal(explicitPath.getParentPath().getParentPath().get(&quot;defaultReference&quot;), Boolean.TRUE);"> 232                                                 Predicate equal = builder.equal(explicitPath.getParentPatðŸ”µ</abbr>
 233                                                 return equal;
 234                                             }
 235                                         })
 236                                 ).withSortDirection(fsc.getSortDirection()));
 237             }
 238         }
 239 
 240         if (eagerFetchAssociations) {
 241             cto.getNonCountAdditionalFilterMappings().add(new FilterMapping()
<abbr title=" 242                                                                   .withDirectFilterValues(new EmptyFilterValues())"> 242                                                                   .withDirectFilterValues(new EmptyFilterðŸ”µ</abbr>
 243                                                                   .withRestriction(new Restriction()
<abbr title=" 244                                                                                            .withPredicateProvider(new PredicateProvider() {"> 244                                                                                            .withPredicateðŸ”µ</abbr>
 245                                                                                                @Override
<abbr title=" 246                                                                                                public Predicate buildPredicate(CriteriaBuilder builder,"> 246                                                                                                public PreðŸ”µ</abbr>
<abbr title=" 247                                                                                                                                FieldPathBuilder fieldPathBuilder, From root,"> 247                                                                                                          ðŸ”µ</abbr>
<abbr title=" 248                                                                                                                                String ceilingEntity,"> 248                                                                                                          ðŸ”µ</abbr>
<abbr title=" 249                                                                                                                                String fullPropertyName, Path explicitPath,"> 249                                                                                                          ðŸ”µ</abbr>
<abbr title=" 250                                                                                                                                List directValues) {"> 250                                                                                                          ðŸ”µ</abbr>
<abbr title=" 251                                                                                                    root.fetch(&quot;defaultSku&quot;, JoinType.LEFT);"> 251                                                                                                    root.fðŸ”µ</abbr>
<abbr title=" 252                                                                                                    root.fetch(&quot;defaultCategory&quot;, JoinType.LEFT);"> 252                                                                                                    root.fðŸ”µ</abbr>
<abbr title=" 253                                                                                                    return null;"> 253                                                                                                    returnðŸ”µ</abbr>
 254                                                                                                }
 255                                                                                            })
 256                                                                   ));
 257         }
 258         return helper.getCompatibleModule(OperationType.BASIC).fetch(persistencePackage, cto);
 259     }
 260 
 261     @Override
<abbr title=" 262     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 262     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelðŸ”µ</abbr>
 263         Entity entity = persistencePackage.getEntity();
 264         try {
<abbr title=" 265             PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();"> 265             PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective(ðŸ”µ</abbr>
 266             Product adminInstance = (Product) Class.forName(entity.getType()[0]).newInstance();
<abbr title=" 267             Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 267             Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.gðŸ”µ</abbr>
 268 
 269             if (adminInstance instanceof ProductBundle) {
 270                 removeBundleFieldRestrictions((ProductBundle) adminInstance, adminProperties, entity);
 271             }
 272 
<abbr title=" 273             adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminProperties, false);"> 273             adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminPropertiðŸ”µ</abbr>
 274             adminInstance = dynamicEntityDao.merge(adminInstance);
 275 
 276             //Since none of the Sku fields are required, it&#x27;s possible that the user did not fill out
<abbr title=" 277             //any Sku fields, and thus a Sku would not be created. Product still needs a default Sku so instantiate one"> 277             //any Sku fields, and thus a Sku would not be created. Product still needs a default Sku so iðŸ”µ</abbr>
 278             if (adminInstance.getDefaultSku() == null) {
 279                 Sku newSku = catalogService.createSku();
 280                 dynamicEntityDao.persist(newSku);
 281                 adminInstance.setDefaultSku(newSku);
 282                 adminInstance = dynamicEntityDao.merge(adminInstance);
 283             }
 284 
 285             //also set the default product for the Sku
 286             adminInstance.getDefaultSku().setDefaultProduct(adminInstance);
 287             dynamicEntityDao.merge(adminInstance.getDefaultSku());
 288 
 289             // if this is a Pre-Add, skip the rest of the method
 290             if (entity.isPreAdd()) {
 291                 return helper.getRecord(adminProperties, adminInstance, null, null);
 292             }
 293 
 294             boolean handled = false;
 295             if (extensionManager != null) {
<abbr title=" 296                 ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForAdd(persistencePackage, adminInstance);"> 296                 ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForAddðŸ”µ</abbr>
 297                 handled = ExtensionResultStatusType.NOT_HANDLED != result;
 298             }
 299             if (!handled) {
 300                 setupXref(adminInstance);
 301             }
 302 
 303             return helper.getRecord(adminProperties, adminInstance, null, null);
 304         } catch (Exception e) {
 305             throw new ServiceException(&quot;Unable to add entity for &quot; + entity.getType()[0], e);
 306         }
 307     }
 308 
 309     @Override
<abbr title=" 310     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 310     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordðŸ”µ</abbr>
 311         Entity entity = persistencePackage.getEntity();
 312         try {
<abbr title=" 313             PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();"> 313             PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective(ðŸ”µ</abbr>
 314 
<abbr title=" 315             Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 315             Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.gðŸ”µ</abbr>
 316 
<abbr title=" 317             BasicFieldMetadata defaultCategory = ((BasicFieldMetadata) adminProperties.get(&quot;defaultCategory&quot;));"> 317             BasicFieldMetadata defaultCategory = ((BasicFieldMetadata) adminProperties.get(&quot;defaultCategoðŸ”µ</abbr>
 318             defaultCategory.setFriendlyName(&quot;ProductImpl_Parent_Category&quot;);
<abbr title=" 319             if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; !StringUtils.isEmpty(entity.findProperty(&quot;defaultCategory&quot;).getValue())) {"> 319             if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; !StringUtils.isEmpty(entity.findPropertðŸ”µ</abbr>
<abbr title=" 320                 //Change the inherited type so that this property is disconnected from the entity and validation is temporarily skipped."> 320                 //Change the inherited type so that this property is disconnected from the entity and valðŸ”µ</abbr>
<abbr title=" 321                 //This is useful when the defaultCategory was previously completely empty for whatever reason. Without this, such"> 321                 //This is useful when the defaultCategory was previously completely empty for whatever reðŸ”µ</abbr>
<abbr title=" 322                 //a case would fail the validation, even though the property was specified in the submission."> 322                 //a case would fail the validation, even though the property was specified in the submissðŸ”µ</abbr>
 323                 defaultCategory.setInheritedFromType(String.class.getName());
 324             }
 325 
 326             Object primaryKey = helper.getPrimaryKey(entity, adminProperties);
<abbr title=" 327             Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(entity.getType()[0]), primaryKey);"> 327             Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(entity.getType()[0]ðŸ”µ</abbr>
 328             if (adminInstance instanceof ProductBundle) {
 329                 removeBundleFieldRestrictions((ProductBundle) adminInstance, adminProperties, entity);
 330             }
 331 
 332             CategoryProductXref oldDefault = getCurrentDefaultXref(adminInstance);
<abbr title=" 333             //Fix for QA#2963 - during deployment sanboxed (not deployed) version of category will not be fetched from db"> 333             //Fix for QA#2963 - during deployment sanboxed (not deployed) version of category will not beðŸ”µ</abbr>
<abbr title=" 334             //and it will cause validation error, we should allow deployemnt of product with category in sandbox state"> 334             //and it will cause validation error, we should allow deployemnt of product with category in ðŸ”µ</abbr>
 335             //so override required flag for that field during deployment
 336             if(BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()){
 337                 ((BasicFieldMetadata)adminProperties.get(&quot;defaultCategory&quot;)).setRequiredOverride(false);
 338             }
<abbr title=" 339             adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminProperties, false);"> 339             adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminPropertiðŸ”µ</abbr>
 340             adminInstance = dynamicEntityDao.merge(adminInstance);
 341             boolean handled = false;
 342             if (extensionManager != null) {
<abbr title=" 343                 ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForUpdate"> 343                 ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForUpdðŸ”µ</abbr>
 344                         (persistencePackage, adminInstance);
 345                 handled = ExtensionResultStatusType.NOT_HANDLED != result;
 346 
 347                 extensionManager.getProxy().manageFields(persistencePackage, adminInstance);
 348             }
 349             if (!handled) {
 350                 setupXref(adminInstance);
 351                 removeOldDefault(adminInstance, oldDefault, entity);
 352             }
 353 
 354             return helper.getRecord(adminProperties, adminInstance, null, null);
 355         } catch (Exception e) {
 356             throw new ServiceException(&quot;Unable to update entity for &quot; + entity.getType()[0], e);
 357         }
 358     }
 359 
 360     @Override
<abbr title=" 361     public void remove(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 361     public void remove(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHeðŸ”µ</abbr>
 362         Entity entity = persistencePackage.getEntity();
 363         try {
<abbr title=" 364             Product adminInstance = getAdminInstance(persistencePackage, dynamicEntityDao, helper, entity);"> 364             Product adminInstance = getAdminInstance(persistencePackage, dynamicEntityDao, helper, entityðŸ”µ</abbr>
 365             removeProduct(persistencePackage, adminInstance, helper);
 366             List&lt;Sku&gt; skuList = adminInstance.getAllSkus();
 367             for (Sku sku : skuList) {
 368                 catalogService.removeSku(sku);
 369             }
 370         } catch (ClassNotFoundException e) {
 371             throw new ServiceException(&quot;Unable to remove entity for &quot; + entity.getType()[0], e);
 372         }
 373     }
 374 
<abbr title=" 375     protected Product getAdminInstance(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper,"> 375     protected Product getAdminInstance(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntðŸ”µ</abbr>
 376                                        Entity entity) throws ClassNotFoundException {
 377         PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();
<abbr title=" 378         Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 378         Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getNaðŸ”µ</abbr>
 379         Object primaryKey = helper.getPrimaryKey(entity, adminProperties);
 380         String type = entity.getType()[0];
 381         Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(type), primaryKey);
 382 
 383         return adminInstance;
 384     }
 385 
<abbr title=" 386     protected void removeProduct(PersistencePackage persistencePackage, Product adminInstance, RecordHelper helper) throws ServiceException {"> 386     protected void removeProduct(PersistencePackage persistencePackage, Product adminInstance, RecordHelpðŸ”µ</abbr>
 387         catalogService.removeProduct(adminInstance);
 388     }
 389 
 390     /**
 391      * If the pricing model is of type item_sum, that property should not be required
 392      *
 393      * @param adminInstance
 394      * @param adminProperties
 395      * @param entity
 396      */
<abbr title=" 397     protected void removeBundleFieldRestrictions(ProductBundle adminInstance, Map&lt;String, FieldMetadata&gt; adminProperties, Entity entity) {"> 397     protected void removeBundleFieldRestrictions(ProductBundle adminInstance, Map&lt;String, FieldMetadata&gt; ðŸ”µ</abbr>
 398         //no required validation for product bundles
 399         ((BasicFieldMetadata) adminProperties.get(&quot;defaultSku.retailPrice&quot;)).setRequiredOverride(false);
 400         if (entity.getPMap().get(&quot;pricingModel&quot;) != null) {
<abbr title=" 401             if (ProductBundlePricingModelType.BUNDLE.getType().equals(entity.getPMap().get(&quot;pricingModel&quot;).getValue())) {"> 401             if (ProductBundlePricingModelType.BUNDLE.getType().equals(entity.getPMap().get(&quot;pricingModel&quot;ðŸ”µ</abbr>
<abbr title=" 402                 ((BasicFieldMetadata) adminProperties.get(&quot;defaultSku.retailPrice&quot;)).setRequiredOverride(true);"> 402                 ((BasicFieldMetadata) adminProperties.get(&quot;defaultSku.retailPrice&quot;)).setRequiredOverride(ðŸ”µ</abbr>
 403             }
 404         }
 405     }
 406 
 407     protected Boolean isDefaultCategoryLegacyMode() {
<abbr title=" 408         ParentCategoryLegacyModeService legacyModeService = ParentCategoryLegacyModeServiceImpl.getLegacyModeService();"> 408         ParentCategoryLegacyModeService legacyModeService = ParentCategoryLegacyModeServiceImpl.getLegacyðŸ”µ</abbr>
 409         if (legacyModeService != null) {
 410             return legacyModeService.isLegacyMode();
 411         }
 412         return false;
 413     }
 414 
 415     protected void modifyParentCategoryMetadata(Map&lt;String, FieldMetadata&gt; md) {
 416         if (!isDefaultCategoryLegacyMode()) {
 417             md.remove(&quot;allParentCategoryXrefs&quot;);
 418 
 419             BasicFieldMetadata defaultCategory = ((BasicFieldMetadata) md.get(&quot;defaultCategory&quot;));
 420             defaultCategory.setFriendlyName(&quot;ProductImpl_Parent_Category&quot;);
 421         }
 422     }
 423 
 424     protected Category getExistingDefaultCategory(Product product) {
 425         //Make sure we get the actual field value - not something manipulated in the getter
 426         Category parentCategory;
 427         try {
 428             Field defaultCategory = ProductImpl.class.getDeclaredField(&quot;defaultCategory&quot;);
 429             defaultCategory.setAccessible(true);
 430             parentCategory = (Category) defaultCategory.get(product);
 431         } catch (NoSuchFieldException e) {
 432             throw ExceptionHelper.refineException(e);
 433         } catch (IllegalAccessException e) {
 434             throw ExceptionHelper.refineException(e);
 435         }
 436         return parentCategory;
 437     }
 438 
<abbr title=" 439     protected void removeOldDefault(Product adminInstance, CategoryProductXref oldDefault, Entity entity) {"> 439     protected void removeOldDefault(Product adminInstance, CategoryProductXref oldDefault, Entity entity)ðŸ”µ</abbr>
 440         if (!isDefaultCategoryLegacyMode()) {
<abbr title=" 441             if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; StringUtils.isEmpty(entity.findProperty(&quot;defaultCategory&quot;).getValue())) {"> 441             if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; StringUtils.isEmpty(entity.findPropertyðŸ”µ</abbr>
 442                 adminInstance.setCategory(null);
 443             }
 444             CategoryProductXref newDefault = getCurrentDefaultXref(adminInstance);
 445             if (oldDefault != null &amp;&amp; !oldDefault.equals(newDefault)) {
 446                 adminInstance.getAllParentCategoryXrefs().remove(oldDefault);
 447             }
 448         }
 449     }
 450 
 451     protected void setupXref(Product adminInstance) {
 452         if (isDefaultCategoryLegacyMode()) {
 453             CategoryProductXref categoryXref = new CategoryProductXrefImpl();
 454             categoryXref.setCategory(getExistingDefaultCategory(adminInstance));
 455             categoryXref.setProduct(adminInstance);
<abbr title=" 456             if (!adminInstance.getAllParentCategoryXrefs().contains(categoryXref) &amp;&amp; categoryXref.getCategory() != null) {"> 456             if (!adminInstance.getAllParentCategoryXrefs().contains(categoryXref) &amp;&amp; categoryXref.getCateðŸ”µ</abbr>
 457                 adminInstance.getAllParentCategoryXrefs().add(categoryXref);
 458             }
 459         }
 460     }
 461 
 462     protected CategoryProductXref getCurrentDefaultXref(Product product) {
 463         CategoryProductXref currentDefault = null;
 464         List&lt;CategoryProductXref&gt; xrefs = product.getAllParentCategoryXrefs();
 465         if (!CollectionUtils.isEmpty(xrefs)) {
 466             for (CategoryProductXref xref : xrefs) {
<abbr title=" 467                 if (xref.getCategory().isActive() &amp;&amp; xref.getDefaultReference() != null &amp;&amp; xref.getDefaultReference()) {"> 467                 if (xref.getCategory().isActive() &amp;&amp; xref.getDefaultReference() != null &amp;&amp; xref.getDefaulðŸ”µ</abbr>
 468                     currentDefault = xref;
 469                     break;
 470                 }
 471             }
 472         }
 473         return currentDefault;
 474     }
 475 
 476     protected boolean isRecursiveProductSelection(PersistencePackage persistencePackage) {
 477         final List&lt;String&gt; customCriteria = Arrays.asList(persistencePackage.getCustomCriteria());
 478         return Stream.of(&quot;upsaleProduct&quot;, &quot;crossSaleProduct&quot;, &quot;requestingField=addOnProduct&quot;)
 479                 .anyMatch(customCriteria::contains);
 480     }
 481 
<abbr title=" 482     protected FilterMapping createFilterMappingForProperty(String targetPropertyName, PredicateProvider predicateProvider) {"> 482     protected FilterMapping createFilterMappingForProperty(String targetPropertyName, PredicateProvider pðŸ”µ</abbr>
 483 
 484         FieldPath fieldPath = new FieldPath().withTargetProperty(targetPropertyName);
 485         EmptyFilterValues directFilterValues = new EmptyFilterValues();
 486         Restriction newRestriction = new Restriction().withPredicateProvider(predicateProvider);
 487 
 488         return new FilterMapping()
 489             .withFieldPath(fieldPath)
 490             .withDirectFilterValues(directFilterValues)
 491             .withRestriction(newRestriction);
 492     }
 493 
<abbr title=" 494     protected DynamicResultSet getFilteredDynamicResultSet(PersistencePackage persistencePackage, CriteriaTransferObject cto, RecordHelper helper) throws ServiceException {"> 494     protected DynamicResultSet getFilteredDynamicResultSet(PersistencePackage persistencePackage, CriteriðŸ”µ</abbr>
 495 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 496         if(persistencePackage.getSectionCrumbs()!=null &amp;&amp; persistencePackage.getSectionCrumbs().length&gt;0) {"> 496         if(persistencePackage.getSectionCrumbs()!=null &amp;&amp; persistencePackage.getSectionCrumbs().length&gt;0)ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 497             FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicateProvider() {"> 497             FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 498                 @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 499                 public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder, From root,"> 499                 public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuildeðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 500                                                 String ceilingEntity, String fullPropertyName, Path explicitPath,"> 500                                                 String ceilingEntity, String fullPropertyName, Path expliðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 501                                                 List directValues) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 502                     return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbs()[0].getSectionId()));"> 502                     return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbsðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 503                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 504             });</span>
 505 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 506         FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicateProvider() {"> 506         FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicatePðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 507             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 508             public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder, From root,"> 508             public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder, FðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 509                                             String ceilingEntity, String fullPropertyName, Path explicitPath,"> 509                                             String ceilingEntity, String fullPropertyName, Path explicitPðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510                                             List directValues) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 511                 return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbs()[0].getSectionId()));"> 511                 return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbs()[0ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 512             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 513         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 514         cto.getAdditionalFilterMappings().add(defaultCategoryMapping);</span>
 515 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516         SectionCrumb[] sectionCrumbs = persistencePackage.getSectionCrumbs();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517         if (sectionCrumbs != null &amp;&amp; sectionCrumbs.length &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518             FilterMapping defaultCategoryMapping = this.createFilterMappingForProperty(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519                     ID_PROPERTY,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 520                     (builder, fieldPathBuilder, root, ceilingEntity, fullPropertyName, explicitPath, directValues)"> 520                     (builder, fieldPathBuilder, root, ceilingEntity, fullPropertyName, explicitPath, direðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 521                             -&gt; builder.and(builder.notEqual(explicitPath, sectionCrumbs[0].getSectionId()))"> 521                             -&gt; builder.and(builder.notEqual(explicitPath, sectionCrumbs[0].getSectionId()ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522             );</span>
 523 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 524         cto.getAdditionalFilterMappings().add(defaultCategoryMapping);
 525         }
<abbr title=" 526         OperationType fetchType = persistencePackage.getPersistencePerspective().getOperationTypes().getFetchType();"> 526         OperationType fetchType = persistencePackage.getPersistencePerspective().getOperationTypes().getFðŸ”µ</abbr>
 527         PersistenceModule persistenceModule = helper.getCompatibleModule(fetchType);
 528         return persistenceModule.fetch(persistencePackage, cto);
 529     }
 530 }
 </pre></td>
                            <td><pre>   1 /*-
   2  * #%L
   3  * BroadleafCommerce Admin Module
   4  * %%
   5  * Copyright (C) 2009 - 2022 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.admin.server.service.handler;
  19 
  20 import java.lang.reflect.Field;
  21 import java.util.ArrayList;
  22 import java.util.Arrays;
  23 import java.util.List;
  24 import java.util.Map;
  25 import java.util.stream.Stream;
  26 import javax.annotation.Resource;
  27 import javax.persistence.TypedQuery;
  28 import javax.persistence.criteria.CriteriaBuilder;
  29 import javax.persistence.criteria.CriteriaQuery;
  30 import javax.persistence.criteria.From;
  31 import javax.persistence.criteria.JoinType;
  32 import javax.persistence.criteria.Path;
  33 import javax.persistence.criteria.Predicate;
  34 import javax.persistence.criteria.Root;
  35 import org.apache.commons.collections.CollectionUtils;
  36 import org.apache.commons.lang.ArrayUtils;
  37 import org.apache.commons.lang3.StringUtils;
  38 import org.apache.commons.logging.Log;
  39 import org.apache.commons.logging.LogFactory;
<abbr title="  40 import org.broadleafcommerce.admin.server.service.extension.ProductCustomPersistenceHandlerExtensionManager;">  40 import org.broadleafcommerce.admin.server.service.extension.ProductCustomPersistenceHandlerExtensionManagðŸ”µ</abbr>
  41 import org.broadleafcommerce.common.exception.ExceptionHelper;
  42 import org.broadleafcommerce.common.exception.ServiceException;
  43 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  44 import org.broadleafcommerce.common.presentation.client.OperationType;
  45 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  46 import org.broadleafcommerce.common.service.ParentCategoryLegacyModeService;
  47 import org.broadleafcommerce.common.service.ParentCategoryLegacyModeServiceImpl;
  48 import org.broadleafcommerce.common.util.BLCCollectionUtils;
  49 import org.broadleafcommerce.common.util.TypedTransformer;
  50 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  51 import org.broadleafcommerce.core.catalog.domain.Category;
  52 import org.broadleafcommerce.core.catalog.domain.CategoryProductXref;
  53 import org.broadleafcommerce.core.catalog.domain.CategoryProductXrefImpl;
  54 import org.broadleafcommerce.core.catalog.domain.Product;
  55 import org.broadleafcommerce.core.catalog.domain.ProductBundle;
  56 import org.broadleafcommerce.core.catalog.domain.ProductImpl;
  57 import org.broadleafcommerce.core.catalog.domain.Sku;
  58 import org.broadleafcommerce.core.catalog.service.CatalogService;
  59 import org.broadleafcommerce.core.catalog.service.type.ProductBundlePricingModelType;
  60 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  61 import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  62 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  63 import org.broadleafcommerce.openadmin.dto.Entity;
  64 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  65 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  66 import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  67 import org.broadleafcommerce.openadmin.dto.PersistencePerspective;
  68 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  69 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  70 import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  71 import org.broadleafcommerce.openadmin.server.service.persistence.module.EmptyFilterValues;
  72 import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  73 import org.broadleafcommerce.openadmin.server.service.persistence.module.PersistenceModule;
  74 import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  75 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FieldPath;
  76 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FieldPathBuilder;
  77 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FilterMapping;
  78 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.Restriction;
<abbr title="  79 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.predicate.PredicateProvider;">  79 import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.predicate.PredicateProvðŸ”µ</abbr>
  80 import org.springframework.beans.factory.annotation.Value;
  81 import org.springframework.stereotype.Component;
  82 
  83 
  84 /**
  85  * @author Jeff Fischer
  86  */
  87 @Component(&quot;blProductCustomPersistenceHandler&quot;)
  88 public class ProductCustomPersistenceHandler extends CustomPersistenceHandlerAdapter {
  89     protected static final String ID_PROPERTY = &quot;id&quot;;
  90 
  91     @Resource(name = &quot;blCatalogService&quot;)
  92     protected CatalogService catalogService;
  93 
  94     @Resource(name = &quot;blProductCustomPersistenceHandlerExtensionManager&quot;)
  95     protected ProductCustomPersistenceHandlerExtensionManager extensionManager;
  96 
  97     @Resource(name = &quot;blParentCategoryLegacyModeService&quot;)
  98     protected ParentCategoryLegacyModeService parentCategoryLegacyModeService;
  99 
 100     @Resource(name = &quot;blSandBoxHelper&quot;)
 101     protected SandBoxHelper sandBoxHelper;
 102 
 103     @Value(&quot;${product.query.limit:500}&quot;)
 104     protected long queryLimit;
 105 
 106     @Value(&quot;${product.eager.fetch.associations.admin:true}&quot;)
 107     protected boolean eagerFetchAssociations = true;
 108 
 109     private static final Log LOG = LogFactory.getLog(ProductCustomPersistenceHandler.class);
 110 
 111     @Override
 112     public Boolean canHandleAdd(PersistencePackage persistencePackage) {
<abbr title=" 113         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 113         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 114         String[] customCriteria = persistencePackage.getCustomCriteria();
<abbr title=" 115         return !ArrayUtils.isEmpty(customCriteria) &amp;&amp; &quot;productDirectEdit&quot;.equals(customCriteria[0]) &amp;&amp; Product.class.getName().equals(ceilingEntityFullyQualifiedClassname);"> 115         return !ArrayUtils.isEmpty(customCriteria) &amp;&amp; &quot;productDirectEdit&quot;.equals(customCriteria[0]) &amp;&amp; PrðŸ”µ</abbr>
 116     }
 117 
 118     @Override
 119     public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 120         return canHandleAdd(persistencePackage);
 121     }
 122 
 123     @Override
 124     public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 125         return canHandleAdd(persistencePackage);
 126     }
 127 
 128     @Override
 129     public Boolean canHandleFetch(PersistencePackage persistencePackage) {
 130         return isRecursiveProductSelection(persistencePackage) || canHandleAdd(persistencePackage);
 131     }
 132 
 133     @Override
 134     public Boolean canHandleInspect(PersistencePackage persistencePackage) {
 135         return canHandleAdd(persistencePackage);
 136     }
 137 
 138     @Override
<abbr title=" 139     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 139     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityðŸ”µ</abbr>
 140         Map&lt;String, FieldMetadata&gt; md = getMetadata(persistencePackage, helper);
 141 
 142         modifyParentCategoryMetadata(md);
 143 
 144         extensionManager.getProxy().manageInspect(md);
 145 
 146         return getResultSet(persistencePackage, helper, md);
 147     }
 148 
 149     @Override
<abbr title=" 150     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao"> 150     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynaðŸ”µ</abbr>
 151             dynamicEntityDao, RecordHelper helper) throws ServiceException {
 152 
 153         if (isRecursiveProductSelection(persistencePackage)) {
 154             return getFilteredDynamicResultSet(persistencePackage, cto, helper);
 155         }
 156 
 157         boolean legacy = parentCategoryLegacyModeService.isLegacyMode();
 158 
 159         //the following code applies when filters are present only:
<abbr title=" 160         //&quot;legacy&quot; means that the parent category filter still utilizes Product.defaultCategory as the field to be matched"> 160         //&quot;legacy&quot; means that the parent category filter still utilizes Product.defaultCategory as the fiðŸ”µ</abbr>
<abbr title=" 161         //against the categories chosen in the listGrid filter. The default behavior up to this point, assumes the &quot;legacy&quot; mode."> 161         //against the categories chosen in the listGrid filter. The default behavior up to this point, asðŸ”µ</abbr>
<abbr title=" 162         //This means that one of the FilterAndSortCriterias will try to match the chosen values against &quot;defaultCategory&quot;."> 162         //This means that one of the FilterAndSortCriterias will try to match the chosen values against &quot;ðŸ”µ</abbr>
<abbr title=" 163         //If &quot;legacy&quot; is false, we remove that FilterAndSortCriteria from the CTO, and inject a new FilterMapping in cto.additionalFilterMappings,"> 163         //If &quot;legacy&quot; is false, we remove that FilterAndSortCriteria from the CTO, and inject a new FilteðŸ”µ</abbr>
 164         //which seeks matching values in  allParentCategoryXRefs instead
 165         if (!legacy) {
 166             FilterAndSortCriteria fsc = cto.getCriteriaMap().get(&quot;defaultCategory&quot;);
 167             if (fsc != null) {
 168                 List&lt;String&gt; filterValues = fsc.getFilterValues();
 169                 cto.getCriteriaMap().remove(&quot;defaultCategory&quot;);
 170 
<abbr title=" 171                 List&lt;Long&gt; transformedValues = BLCCollectionUtils.collectList(filterValues, new TypedTransformer&lt;Long&gt;() {"> 171                 List&lt;Long&gt; transformedValues = BLCCollectionUtils.collectList(filterValues, new TypedTranðŸ”µ</abbr>
 172                     @Override
 173                     public Long transform(Object input) {
 174                         return Long.parseLong(((String) input));
 175                     }
 176                 });
<abbr title=" 177                 CriteriaBuilder builder = dynamicEntityDao.getStandardEntityManager().getCriteriaBuilder();"> 177                 CriteriaBuilder builder = dynamicEntityDao.getStandardEntityManager().getCriteriaBuilder(ðŸ”µ</abbr>
 178                 CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 179                 Root&lt;CategoryProductXrefImpl&gt; root = criteria.from(CategoryProductXrefImpl.class);
 180                 criteria.select(root.get(&quot;product&quot;).get(&quot;id&quot;).as(Long.class));
 181                 List&lt;Predicate&gt; restrictions = new ArrayList&lt;Predicate&gt;();
 182                 restrictions.add(builder.equal(root.get(&quot;defaultReference&quot;), Boolean.TRUE));
 183                 if (CollectionUtils.isNotEmpty(transformedValues)) {
 184                     restrictions.add(root.get(&quot;category&quot;).get(&quot;id&quot;).in(transformedValues));
 185                 }
 186 
 187                 criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
<abbr title=" 188                 TypedQuery&lt;Long&gt; query = dynamicEntityDao.getStandardEntityManager().createQuery(criteria);"> 188                 TypedQuery&lt;Long&gt; query = dynamicEntityDao.getStandardEntityManager().createQuery(criteriaðŸ”µ</abbr>
 189                 List&lt;Long&gt; productIds = query.getResultList();
<abbr title=" 190                 productIds = sandBoxHelper.mergeCloneIds(ProductImpl.class, productIds.toArray(new Long[productIds.size()]));"> 190                 productIds = sandBoxHelper.mergeCloneIds(ProductImpl.class, productIds.toArray(new Long[pðŸ”µ</abbr>
 191 
 192                 if (productIds.size() == 0) {
 193                     return new DynamicResultSet(null, new Entity[0], 0);
 194                 }
 195                 if (productIds.size() &lt;= queryLimit) {
 196                     FilterMapping filterMapping = new FilterMapping()
 197                             .withFieldPath(new FieldPath().withTargetProperty(&quot;id&quot;))
 198                             .withDirectFilterValues(productIds)
 199                             .withRestriction(new Restriction()
 200                                                      .withPredicateProvider(new PredicateProvider() {
 201                                                                                 @Override
<abbr title=" 202                                                                                 public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder,"> 202                                                                                 public Predicate buildPreðŸ”µ</abbr>
<abbr title=" 203                                                                                                                 From root, String ceilingEntity, String fullPropertyName,"> 203                                                                                                          ðŸ”µ</abbr>
<abbr title=" 204                                                                                                                 Path explicitPath, List directValues) {"> 204                                                                                                          ðŸ”µ</abbr>
<abbr title=" 205                                                                                     return explicitPath.in(directValues);"> 205                                                                                     return explicitPath.iðŸ”µ</abbr>
 206                                                                                 }
 207                                                                             }
 208                                                      )
 209                             );
 210                     cto.getAdditionalFilterMappings().add(filterMapping);
 211                 } else {
 212                     String joined = StringUtils.join(transformedValues, &#x27;,&#x27;);
<abbr title=" 213                     LOG.warn(String.format(&quot;Skipping default category filtering for product fetch query since there are &quot; +"> 213                     LOG.warn(String.format(&quot;Skipping default category filtering for product fetch query sðŸ”µ</abbr>
<abbr title=" 214                                            &quot;more than &quot; + queryLimit + &quot; products found to belong to the selected default categories(%s). This is a &quot; +"> 214                                            &quot;more than &quot; + queryLimit + &quot; products found to belong to the ðŸ”µ</abbr>
 215                                            &quot;filter query limitation.&quot;, joined));
 216                 }
 217                 cto.getNonCountAdditionalFilterMappings().add(
 218                         new FilterMapping().withFieldPath(new FieldPath().
 219                                 withAssociationPath(Arrays.asList(&quot;allParentCategoryXrefs&quot;,&quot;category&quot;)).
 220                                 withTargetPropertyPieces(Arrays.asList(&quot;name&quot;)))
 221                                 .withDirectFilterValues(new EmptyFilterValues())
 222                                 .withRestriction(new Restriction()
 223                                         .withPredicateProvider(new PredicateProvider() {
 224                                             @Override
 225                                             public Predicate buildPredicate(CriteriaBuilder builder,
<abbr title=" 226                                                                             FieldPathBuilder fieldPathBuilder, From root,"> 226                                                                             FieldPathBuilder fieldPathBuiðŸ”µ</abbr>
 227                                                                             String ceilingEntity,
<abbr title=" 228                                                                             String fullPropertyName, Path explicitPath,"> 228                                                                             String fullPropertyName, PathðŸ”µ</abbr>
 229                                                                             List directValues) {
<abbr title=" 230                                                 //expect it to be allParentCategoryXrefs.category.name, so we need to restrict on allParentCategoryXrefs - 2 levels up"> 230                                                 //expect it to be allParentCategoryXrefs.category.name, sðŸ”µ</abbr>
<abbr title=" 231                                                 Predicate equal = builder.equal(explicitPath.getParentPath().getParentPath().get(&quot;defaultReference&quot;), Boolean.TRUE);"> 231                                                 Predicate equal = builder.equal(explicitPath.getParentPatðŸ”µ</abbr>
 232                                                 return equal;
 233                                             }
 234                                         })
 235                                 ).withSortDirection(fsc.getSortDirection()));
 236             }
 237         }
 238 
 239         if (eagerFetchAssociations) {
 240             cto.getNonCountAdditionalFilterMappings().add(new FilterMapping()
<abbr title=" 241                                                                   .withDirectFilterValues(new EmptyFilterValues())"> 241                                                                   .withDirectFilterValues(new EmptyFilterðŸ”µ</abbr>
 242                                                                   .withRestriction(new Restriction()
<abbr title=" 243                                                                                            .withPredicateProvider(new PredicateProvider() {"> 243                                                                                            .withPredicateðŸ”µ</abbr>
 244                                                                                                @Override
<abbr title=" 245                                                                                                public Predicate buildPredicate(CriteriaBuilder builder,"> 245                                                                                                public PreðŸ”µ</abbr>
<abbr title=" 246                                                                                                                                FieldPathBuilder fieldPathBuilder, From root,"> 246                                                                                                          ðŸ”µ</abbr>
<abbr title=" 247                                                                                                                                String ceilingEntity,"> 247                                                                                                          ðŸ”µ</abbr>
<abbr title=" 248                                                                                                                                String fullPropertyName, Path explicitPath,"> 248                                                                                                          ðŸ”µ</abbr>
<abbr title=" 249                                                                                                                                List directValues) {"> 249                                                                                                          ðŸ”µ</abbr>
<abbr title=" 250                                                                                                    root.fetch(&quot;defaultSku&quot;, JoinType.LEFT);"> 250                                                                                                    root.fðŸ”µ</abbr>
<abbr title=" 251                                                                                                    root.fetch(&quot;defaultCategory&quot;, JoinType.LEFT);"> 251                                                                                                    root.fðŸ”µ</abbr>
<abbr title=" 252                                                                                                    return null;"> 252                                                                                                    returnðŸ”µ</abbr>
 253                                                                                                }
 254                                                                                            })
 255                                                                   ));
 256         }
 257         return helper.getCompatibleModule(OperationType.BASIC).fetch(persistencePackage, cto);
 258     }
 259 
 260     @Override
<abbr title=" 261     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 261     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelðŸ”µ</abbr>
 262         Entity entity = persistencePackage.getEntity();
 263         try {
<abbr title=" 264             PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();"> 264             PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective(ðŸ”µ</abbr>
 265             Product adminInstance = (Product) Class.forName(entity.getType()[0]).newInstance();
<abbr title=" 266             Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 266             Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.gðŸ”µ</abbr>
 267 
 268             if (adminInstance instanceof ProductBundle) {
 269                 removeBundleFieldRestrictions((ProductBundle) adminInstance, adminProperties, entity);
 270             }
 271 
<abbr title=" 272             adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminProperties, false);"> 272             adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminPropertiðŸ”µ</abbr>
 273             adminInstance = dynamicEntityDao.merge(adminInstance);
 274 
 275             //Since none of the Sku fields are required, it&#x27;s possible that the user did not fill out
<abbr title=" 276             //any Sku fields, and thus a Sku would not be created. Product still needs a default Sku so instantiate one"> 276             //any Sku fields, and thus a Sku would not be created. Product still needs a default Sku so iðŸ”µ</abbr>
 277             if (adminInstance.getDefaultSku() == null) {
 278                 Sku newSku = catalogService.createSku();
 279                 dynamicEntityDao.persist(newSku);
 280                 adminInstance.setDefaultSku(newSku);
 281                 adminInstance = dynamicEntityDao.merge(adminInstance);
 282             }
 283 
 284             //also set the default product for the Sku
 285             adminInstance.getDefaultSku().setDefaultProduct(adminInstance);
 286             dynamicEntityDao.merge(adminInstance.getDefaultSku());
 287 
 288             // if this is a Pre-Add, skip the rest of the method
 289             if (entity.isPreAdd()) {
 290                 return helper.getRecord(adminProperties, adminInstance, null, null);
 291             }
 292 
 293             boolean handled = false;
 294             if (extensionManager != null) {
<abbr title=" 295                 ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForAdd(persistencePackage, adminInstance);"> 295                 ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForAddðŸ”µ</abbr>
 296                 handled = ExtensionResultStatusType.NOT_HANDLED != result;
 297             }
 298             if (!handled) {
 299                 setupXref(adminInstance);
 300             }
 301 
 302             return helper.getRecord(adminProperties, adminInstance, null, null);
 303         } catch (Exception e) {
 304             throw new ServiceException(&quot;Unable to add entity for &quot; + entity.getType()[0], e);
 305         }
 306     }
 307 
 308     @Override
<abbr title=" 309     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 309     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordðŸ”µ</abbr>
 310         Entity entity = persistencePackage.getEntity();
 311         try {
<abbr title=" 312             PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();"> 312             PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective(ðŸ”µ</abbr>
 313 
<abbr title=" 314             Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 314             Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.gðŸ”µ</abbr>
 315 
<abbr title=" 316             BasicFieldMetadata defaultCategory = ((BasicFieldMetadata) adminProperties.get(&quot;defaultCategory&quot;));"> 316             BasicFieldMetadata defaultCategory = ((BasicFieldMetadata) adminProperties.get(&quot;defaultCategoðŸ”µ</abbr>
 317             defaultCategory.setFriendlyName(&quot;ProductImpl_Parent_Category&quot;);
<abbr title=" 318             if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; !StringUtils.isEmpty(entity.findProperty(&quot;defaultCategory&quot;).getValue())) {"> 318             if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; !StringUtils.isEmpty(entity.findPropertðŸ”µ</abbr>
<abbr title=" 319                 //Change the inherited type so that this property is disconnected from the entity and validation is temporarily skipped."> 319                 //Change the inherited type so that this property is disconnected from the entity and valðŸ”µ</abbr>
<abbr title=" 320                 //This is useful when the defaultCategory was previously completely empty for whatever reason. Without this, such"> 320                 //This is useful when the defaultCategory was previously completely empty for whatever reðŸ”µ</abbr>
<abbr title=" 321                 //a case would fail the validation, even though the property was specified in the submission."> 321                 //a case would fail the validation, even though the property was specified in the submissðŸ”µ</abbr>
 322                 defaultCategory.setInheritedFromType(String.class.getName());
 323             }
 324 
 325             Object primaryKey = helper.getPrimaryKey(entity, adminProperties);
<abbr title=" 326             Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(entity.getType()[0]), primaryKey);"> 326             Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(entity.getType()[0]ðŸ”µ</abbr>
 327             if (adminInstance instanceof ProductBundle) {
 328                 removeBundleFieldRestrictions((ProductBundle) adminInstance, adminProperties, entity);
 329             }
 330 
 331             CategoryProductXref oldDefault = getCurrentDefaultXref(adminInstance);
<abbr title=" 332             //Fix for QA#2963 - during deployment sanboxed (not deployed) version of category will not be fetched from db"> 332             //Fix for QA#2963 - during deployment sanboxed (not deployed) version of category will not beðŸ”µ</abbr>
<abbr title=" 333             //and it will cause validation error, we should allow deployemnt of product with category in sandbox state"> 333             //and it will cause validation error, we should allow deployemnt of product with category in ðŸ”µ</abbr>
 334             //so override required flag for that field during deployment
 335             if(BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()){
 336                 ((BasicFieldMetadata)adminProperties.get(&quot;defaultCategory&quot;)).setRequiredOverride(false);
 337             }
<abbr title=" 338             adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminProperties, false);"> 338             adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminPropertiðŸ”µ</abbr>
 339             adminInstance = dynamicEntityDao.merge(adminInstance);
 340             boolean handled = false;
 341             if (extensionManager != null) {
<abbr title=" 342                 ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForUpdate"> 342                 ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForUpdðŸ”µ</abbr>
 343                         (persistencePackage, adminInstance);
 344                 handled = ExtensionResultStatusType.NOT_HANDLED != result;
 345 
 346                 extensionManager.getProxy().manageFields(persistencePackage, adminInstance);
 347             }
 348             if (!handled) {
 349                 setupXref(adminInstance);
 350                 removeOldDefault(adminInstance, oldDefault, entity);
 351             }
 352 
 353             return helper.getRecord(adminProperties, adminInstance, null, null);
 354         } catch (Exception e) {
 355             throw new ServiceException(&quot;Unable to update entity for &quot; + entity.getType()[0], e);
 356         }
 357     }
 358 
 359     @Override
<abbr title=" 360     public void remove(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 360     public void remove(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHeðŸ”µ</abbr>
 361         Entity entity = persistencePackage.getEntity();
 362         try {
<abbr title=" 363             Product adminInstance = getAdminInstance(persistencePackage, dynamicEntityDao, helper, entity);"> 363             Product adminInstance = getAdminInstance(persistencePackage, dynamicEntityDao, helper, entityðŸ”µ</abbr>
 364             removeProduct(persistencePackage, adminInstance, helper);
 365             List&lt;Sku&gt; skuList = adminInstance.getAllSkus();
 366             for (Sku sku : skuList) {
 367                 catalogService.removeSku(sku);
 368             }
 369         } catch (ClassNotFoundException e) {
 370             throw new ServiceException(&quot;Unable to remove entity for &quot; + entity.getType()[0], e);
 371         }
 372     }
 373 
<abbr title=" 374     protected Product getAdminInstance(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper,"> 374     protected Product getAdminInstance(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntðŸ”µ</abbr>
 375                                        Entity entity) throws ClassNotFoundException {
 376         PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();
<abbr title=" 377         Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 377         Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getNaðŸ”µ</abbr>
 378         Object primaryKey = helper.getPrimaryKey(entity, adminProperties);
 379         String type = entity.getType()[0];
 380         Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(type), primaryKey);
 381 
 382         return adminInstance;
 383     }
 384 
<abbr title=" 385     protected void removeProduct(PersistencePackage persistencePackage, Product adminInstance, RecordHelper helper) throws ServiceException {"> 385     protected void removeProduct(PersistencePackage persistencePackage, Product adminInstance, RecordHelpðŸ”µ</abbr>
 386         catalogService.removeProduct(adminInstance);
 387     }
 388 
 389     /**
 390      * If the pricing model is of type item_sum, that property should not be required
 391      *
 392      * @param adminInstance
 393      * @param adminProperties
 394      * @param entity
 395      */
<abbr title=" 396     protected void removeBundleFieldRestrictions(ProductBundle adminInstance, Map&lt;String, FieldMetadata&gt; adminProperties, Entity entity) {"> 396     protected void removeBundleFieldRestrictions(ProductBundle adminInstance, Map&lt;String, FieldMetadata&gt; ðŸ”µ</abbr>
 397         //no required validation for product bundles
 398         ((BasicFieldMetadata) adminProperties.get(&quot;defaultSku.retailPrice&quot;)).setRequiredOverride(false);
 399         if (entity.getPMap().get(&quot;pricingModel&quot;) != null) {
<abbr title=" 400             if (ProductBundlePricingModelType.BUNDLE.getType().equals(entity.getPMap().get(&quot;pricingModel&quot;).getValue())) {"> 400             if (ProductBundlePricingModelType.BUNDLE.getType().equals(entity.getPMap().get(&quot;pricingModel&quot;ðŸ”µ</abbr>
<abbr title=" 401                 ((BasicFieldMetadata) adminProperties.get(&quot;defaultSku.retailPrice&quot;)).setRequiredOverride(true);"> 401                 ((BasicFieldMetadata) adminProperties.get(&quot;defaultSku.retailPrice&quot;)).setRequiredOverride(ðŸ”µ</abbr>
 402             }
 403         }
 404     }
 405 
 406     protected Boolean isDefaultCategoryLegacyMode() {
<abbr title=" 407         ParentCategoryLegacyModeService legacyModeService = ParentCategoryLegacyModeServiceImpl.getLegacyModeService();"> 407         ParentCategoryLegacyModeService legacyModeService = ParentCategoryLegacyModeServiceImpl.getLegacyðŸ”µ</abbr>
 408         if (legacyModeService != null) {
 409             return legacyModeService.isLegacyMode();
 410         }
 411         return false;
 412     }
 413 
 414     protected void modifyParentCategoryMetadata(Map&lt;String, FieldMetadata&gt; md) {
 415         if (!isDefaultCategoryLegacyMode()) {
 416             md.remove(&quot;allParentCategoryXrefs&quot;);
 417 
 418             BasicFieldMetadata defaultCategory = ((BasicFieldMetadata) md.get(&quot;defaultCategory&quot;));
 419             defaultCategory.setFriendlyName(&quot;ProductImpl_Parent_Category&quot;);
 420         }
 421     }
 422 
 423     protected Category getExistingDefaultCategory(Product product) {
 424         //Make sure we get the actual field value - not something manipulated in the getter
 425         Category parentCategory;
 426         try {
 427             Field defaultCategory = ProductImpl.class.getDeclaredField(&quot;defaultCategory&quot;);
 428             defaultCategory.setAccessible(true);
 429             parentCategory = (Category) defaultCategory.get(product);
 430         } catch (NoSuchFieldException e) {
 431             throw ExceptionHelper.refineException(e);
 432         } catch (IllegalAccessException e) {
 433             throw ExceptionHelper.refineException(e);
 434         }
 435         return parentCategory;
 436     }
 437 
<abbr title=" 438     protected void removeOldDefault(Product adminInstance, CategoryProductXref oldDefault, Entity entity) {"> 438     protected void removeOldDefault(Product adminInstance, CategoryProductXref oldDefault, Entity entity)ðŸ”µ</abbr>
 439         if (!isDefaultCategoryLegacyMode()) {
<abbr title=" 440             if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; StringUtils.isEmpty(entity.findProperty(&quot;defaultCategory&quot;).getValue())) {"> 440             if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; StringUtils.isEmpty(entity.findPropertyðŸ”µ</abbr>
 441                 adminInstance.setCategory(null);
 442             }
 443             CategoryProductXref newDefault = getCurrentDefaultXref(adminInstance);
 444             if (oldDefault != null &amp;&amp; !oldDefault.equals(newDefault)) {
 445                 adminInstance.getAllParentCategoryXrefs().remove(oldDefault);
 446             }
 447         }
 448     }
 449 
 450     protected void setupXref(Product adminInstance) {
 451         if (isDefaultCategoryLegacyMode()) {
 452             CategoryProductXref categoryXref = new CategoryProductXrefImpl();
 453             categoryXref.setCategory(getExistingDefaultCategory(adminInstance));
 454             categoryXref.setProduct(adminInstance);
<abbr title=" 455             if (!adminInstance.getAllParentCategoryXrefs().contains(categoryXref) &amp;&amp; categoryXref.getCategory() != null) {"> 455             if (!adminInstance.getAllParentCategoryXrefs().contains(categoryXref) &amp;&amp; categoryXref.getCateðŸ”µ</abbr>
 456                 adminInstance.getAllParentCategoryXrefs().add(categoryXref);
 457             }
 458         }
 459     }
 460 
 461     protected CategoryProductXref getCurrentDefaultXref(Product product) {
 462         CategoryProductXref currentDefault = null;
 463         List&lt;CategoryProductXref&gt; xrefs = product.getAllParentCategoryXrefs();
 464         if (!CollectionUtils.isEmpty(xrefs)) {
 465             for (CategoryProductXref xref : xrefs) {
<abbr title=" 466                 if (xref.getCategory().isActive() &amp;&amp; xref.getDefaultReference() != null &amp;&amp; xref.getDefaultReference()) {"> 466                 if (xref.getCategory().isActive() &amp;&amp; xref.getDefaultReference() != null &amp;&amp; xref.getDefaulðŸ”µ</abbr>
 467                     currentDefault = xref;
 468                     break;
 469                 }
 470             }
 471         }
 472         return currentDefault;
 473     }
 474 
 475     protected boolean isRecursiveProductSelection(PersistencePackage persistencePackage) {
 476         final List&lt;String&gt; customCriteria = Arrays.asList(persistencePackage.getCustomCriteria());
<abbr title=" 477         return Stream.of(&quot;upsaleProduct&quot;, &quot;crossSaleProduct&quot;, &quot;requestingField=addOnProduct&quot;).anyMatch(customCriteria::contains);"> 477         return Stream.of(&quot;upsaleProduct&quot;, &quot;crossSaleProduct&quot;, &quot;requestingField=addOnProduct&quot;).anyMatch(cuðŸ”µ</abbr>
 478     }
 479 
<abbr title=" 480     protected FilterMapping createFilterMappingForProperty(String targetPropertyName, PredicateProvider predicateProvider) {"> 480     protected FilterMapping createFilterMappingForProperty(String targetPropertyName, PredicateProvider pðŸ”µ</abbr>
 481 
 482         FieldPath fieldPath = new FieldPath().withTargetProperty(targetPropertyName);
 483         EmptyFilterValues directFilterValues = new EmptyFilterValues();
 484         Restriction newRestriction = new Restriction().withPredicateProvider(predicateProvider);
 485 
 486         return new FilterMapping()
 487             .withFieldPath(fieldPath)
 488             .withDirectFilterValues(directFilterValues)
 489             .withRestriction(newRestriction);
 490     }
 491 
<abbr title=" 492     protected DynamicResultSet getFilteredDynamicResultSet(PersistencePackage persistencePackage, CriteriaTransferObject cto, RecordHelper helper) throws ServiceException {"> 492     protected DynamicResultSet getFilteredDynamicResultSet(PersistencePackage persistencePackage, CriteriðŸ”µ</abbr>
 493 
 494 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 495         if(persistencePackage.getSectionCrumbs()!=null &amp;&amp; persistencePackage.getSectionCrumbs().length&gt;0) {"> 495         if(persistencePackage.getSectionCrumbs()!=null &amp;&amp; persistencePackage.getSectionCrumbs().length&gt;0)ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 496             FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicateProvider() {"> 496             FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 497                 @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 498                 public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder, From root,"> 498                 public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuildeðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 499                                                 String ceilingEntity, String fullPropertyName, Path explicitPath,"> 499                                                 String ceilingEntity, String fullPropertyName, Path expliðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 500                                                 List directValues) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 501                     return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbs()[0].getSectionId()));"> 501                     return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbsðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 502                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 503             });</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 504             cto.getAdditionalFilterMappings().add(defaultCategoryMapping);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 505         }</span>
 506 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 507 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 507 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 508 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510         SectionCrumb[] sectionCrumbs = persistencePackage.getSectionCrumbs();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511         if (sectionCrumbs != null &amp;&amp; sectionCrumbs.length &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512             FilterMapping defaultCategoryMapping = this.createFilterMappingForProperty(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513                     ID_PROPERTY,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 514                     (builder, fieldPathBuilder, root, ceilingEntity, fullPropertyName, explicitPath, directValues)"> 514                     (builder, fieldPathBuilder, root, ceilingEntity, fullPropertyName, explicitPath, direðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 515                             -&gt; builder.and(builder.notEqual(explicitPath, sectionCrumbs[0].getSectionId()))"> 515                             -&gt; builder.and(builder.notEqual(explicitPath, sectionCrumbs[0].getSectionId()ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516             );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517             cto.getAdditionalFilterMappings().add(defaultCategoryMapping);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518         }</span>
 519 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 520 
<abbr title=" 521         OperationType fetchType = persistencePackage.getPersistencePerspective().getOperationTypes().getFetchType();"> 521         OperationType fetchType = persistencePackage.getPersistencePerspective().getOperationTypes().getFðŸ”µ</abbr>
 522         PersistenceModule persistenceModule = helper.getCompatibleModule(fetchType);
 523         return persistenceModule.fetch(persistencePackage, cto);
 524     }
 525 }
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 +/*-</span>
   3   * #%L
   4   * BroadleafCommerce Admin Module
   5   * %%
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + * Copyright (C) 2009 - 2022 Broadleaf Commerce</span>
   8   * %%
   9   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
  10   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
  11   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  12   * the Broadleaf End User License Agreement (EULA), Version 1.1
  13   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  14   * shall apply.
  15   *
<abbr title="  16   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  16   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  17   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  18   * #L%
  19   */
  20  package org.broadleafcommerce.admin.server.service.handler;
  21  
  22  import org.apache.commons.collections.CollectionUtils;
  23  import org.apache.commons.lang.ArrayUtils;
  24  import org.apache.commons.lang3.StringUtils;
  25  import org.apache.commons.logging.Log;
  26  import org.apache.commons.logging.LogFactory;
  27  import org.broadleafcommerce.admin.server.service.extension.ProductCustomPersistenceHandlerExtensionManager;
  28  import org.broadleafcommerce.common.exception.ExceptionHelper;
  29  import org.broadleafcommerce.common.exception.ServiceException;
  30  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  31  import org.broadleafcommerce.common.presentation.client.OperationType;
  32  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  33  import org.broadleafcommerce.common.service.ParentCategoryLegacyModeService;
  34  import org.broadleafcommerce.common.service.ParentCategoryLegacyModeServiceImpl;
  35  import org.broadleafcommerce.common.util.BLCCollectionUtils;
  36  import org.broadleafcommerce.common.util.TypedTransformer;
  37  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  38  import org.broadleafcommerce.core.catalog.domain.Category;
  39  import org.broadleafcommerce.core.catalog.domain.CategoryProductXref;
  40  import org.broadleafcommerce.core.catalog.domain.CategoryProductXrefImpl;
  41  import org.broadleafcommerce.core.catalog.domain.Product;
  42  import org.broadleafcommerce.core.catalog.domain.ProductBundle;
  43  import org.broadleafcommerce.core.catalog.domain.ProductImpl;
  44  import org.broadleafcommerce.core.catalog.domain.Sku;
  45  import org.broadleafcommerce.core.catalog.service.CatalogService;
  46  import org.broadleafcommerce.core.catalog.service.type.ProductBundlePricingModelType;
  47  import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  48  import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  49  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  50  import org.broadleafcommerce.openadmin.dto.Entity;
  51  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  52  import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  53  import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  54  import org.broadleafcommerce.openadmin.dto.PersistencePerspective;

  55  import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  56  import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  57  import org.broadleafcommerce.openadmin.server.service.persistence.module.EmptyFilterValues;
  58  import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  59  import org.broadleafcommerce.openadmin.server.service.persistence.module.PersistenceModule;
  60  import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  61  import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FieldPath;
  62  import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FieldPathBuilder;
  63  import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FilterMapping;
  64  import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.Restriction;
  65  import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.predicate.PredicateProvider;
  66  import org.springframework.beans.factory.annotation.Value;
  67  import org.springframework.stereotype.Component;
  68  import java.lang.reflect.Field;
  69  import java.util.ArrayList;
  70  import java.util.Arrays;
  71  import java.util.List;
  72  import java.util.Map;


  73  import javax.annotation.Resource;
  74  import javax.persistence.TypedQuery;
  75  import javax.persistence.criteria.CriteriaBuilder;
  76  import javax.persistence.criteria.CriteriaQuery;
  77  import javax.persistence.criteria.From;
  78  import javax.persistence.criteria.JoinType;
  79  import javax.persistence.criteria.Path;
  80  import javax.persistence.criteria.Predicate;
  81  import javax.persistence.criteria.Root;
  82  
  83  /**
  84   * @author Jeff Fischer
  85   */
  86  @Component(&quot;blProductCustomPersistenceHandler&quot;)
  87  public class ProductCustomPersistenceHandler extends CustomPersistenceHandlerAdapter {
  88  
  89      protected static final String ID_PROPERTY = &quot;id&quot;;
  90  
  91      @Resource(name = &quot;blCatalogService&quot;)
  92      protected CatalogService catalogService;
  93  
  94      @Resource(name = &quot;blProductCustomPersistenceHandlerExtensionManager&quot;)
  95      protected ProductCustomPersistenceHandlerExtensionManager extensionManager;
  96  
  97      @Resource(name = &quot;blParentCategoryLegacyModeService&quot;)
  98      protected ParentCategoryLegacyModeService parentCategoryLegacyModeService;
  99  
 100      @Resource(name = &quot;blSandBoxHelper&quot;)
 101      protected SandBoxHelper sandBoxHelper;
 102  
 103      @Value(&quot;${product.query.limit:500}&quot;)
 104      protected long queryLimit;
 105  
 106      @Value(&quot;${product.eager.fetch.associations.admin:true}&quot;)
 107      protected boolean eagerFetchAssociations = true;
 108  
 109      private static final Log LOG = LogFactory.getLog(ProductCustomPersistenceHandler.class);
 110  
 111      @Override
 112      public Boolean canHandleAdd(PersistencePackage persistencePackage) {
<abbr title=" 113          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 113          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
 114          String[] customCriteria = persistencePackage.getCustomCriteria();
<abbr title=" 115          return !ArrayUtils.isEmpty(customCriteria) &amp;&amp; &quot;productDirectEdit&quot;.equals(customCriteria[0]) &amp;&amp; Product.class.getName().equals(ceilingEntityFullyQualifiedClassname);"> 115          return !ArrayUtils.isEmpty(customCriteria) &amp;&amp; &quot;productDirectEdit&quot;.equals(customCriteria[0]) &amp;&amp; Product.claðŸ”µ</abbr>
 116      }
 117  
 118      @Override
 119      public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 120          return canHandleAdd(persistencePackage);
 121      }
 122  
 123      @Override
 124      public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 125          return canHandleAdd(persistencePackage);
 126      }
 127  
 128      @Override
 129      public Boolean canHandleFetch(PersistencePackage persistencePackage) {
 130          return isRecursiveProductSelection(persistencePackage) || canHandleAdd(persistencePackage);
 131      }
 132  
 133      @Override
 134      public Boolean canHandleInspect(PersistencePackage persistencePackage) {
 135          return canHandleAdd(persistencePackage);
 136      }
 137  
 138      @Override
<abbr title=" 139      public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 139      public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspðŸ”µ</abbr>
 140          Map&lt;String, FieldMetadata&gt; md = getMetadata(persistencePackage, helper);
 141  
 142          modifyParentCategoryMetadata(md);
 143  
 144          extensionManager.getProxy().manageInspect(md);
 145  
 146          return getResultSet(persistencePackage, helper, md);
 147      }
 148  
 149      @Override
<abbr title=" 150      public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao"> 150      public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityðŸ”µ</abbr>
 151              dynamicEntityDao, RecordHelper helper) throws ServiceException {
 152  
 153          if (isRecursiveProductSelection(persistencePackage)) {
 154              return getFilteredDynamicResultSet(persistencePackage, cto, helper);
 155          }
 156  
 157          boolean legacy = parentCategoryLegacyModeService.isLegacyMode();
 158  
 159          //the following code applies when filters are present only:
<abbr title=" 160          //&quot;legacy&quot; means that the parent category filter still utilizes Product.defaultCategory as the field to be matched"> 160          //&quot;legacy&quot; means that the parent category filter still utilizes Product.defaultCategory as the field to beðŸ”µ</abbr>
<abbr title=" 161          //against the categories chosen in the listGrid filter. The default behavior up to this point, assumes the &quot;legacy&quot; mode."> 161          //against the categories chosen in the listGrid filter. The default behavior up to this point, assumes theðŸ”µ</abbr>
<abbr title=" 162          //This means that one of the FilterAndSortCriterias will try to match the chosen values against &quot;defaultCategory&quot;."> 162          //This means that one of the FilterAndSortCriterias will try to match the chosen values against &quot;defaultCaðŸ”µ</abbr>
<abbr title=" 163          //If &quot;legacy&quot; is false, we remove that FilterAndSortCriteria from the CTO, and inject a new FilterMapping in cto.additionalFilterMappings,"> 163          //If &quot;legacy&quot; is false, we remove that FilterAndSortCriteria from the CTO, and inject a new FilterMapping ðŸ”µ</abbr>
 164          //which seeks matching values in  allParentCategoryXRefs instead
 165          if (!legacy) {
 166              FilterAndSortCriteria fsc = cto.getCriteriaMap().get(&quot;defaultCategory&quot;);
 167              if (fsc != null) {
 168                  List&lt;String&gt; filterValues = fsc.getFilterValues();
 169                  cto.getCriteriaMap().remove(&quot;defaultCategory&quot;);
 170  
<abbr title=" 171                  List&lt;Long&gt; transformedValues = BLCCollectionUtils.collectList(filterValues, new TypedTransformer&lt;Long&gt;() {"> 171                  List&lt;Long&gt; transformedValues = BLCCollectionUtils.collectList(filterValues, new TypedTransformer&lt;LðŸ”µ</abbr>
 172                      @Override
 173                      public Long transform(Object input) {
 174                          return Long.parseLong(((String) input));
 175                      }
 176                  });
 177                  CriteriaBuilder builder = dynamicEntityDao.getStandardEntityManager().getCriteriaBuilder();
 178                  CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 179                  Root&lt;CategoryProductXrefImpl&gt; root = criteria.from(CategoryProductXrefImpl.class);
 180                  criteria.select(root.get(&quot;product&quot;).get(&quot;id&quot;).as(Long.class));
 181                  List&lt;Predicate&gt; restrictions = new ArrayList&lt;Predicate&gt;();
 182                  restrictions.add(builder.equal(root.get(&quot;defaultReference&quot;), Boolean.TRUE));
 183                  if (CollectionUtils.isNotEmpty(transformedValues)) {
 184                      restrictions.add(root.get(&quot;category&quot;).get(&quot;id&quot;).in(transformedValues));
 185                  }
 186  
 187                  criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
 188                  TypedQuery&lt;Long&gt; query = dynamicEntityDao.getStandardEntityManager().createQuery(criteria);
 189                  List&lt;Long&gt; productIds = query.getResultList();
<abbr title=" 190                  productIds = sandBoxHelper.mergeCloneIds(ProductImpl.class, productIds.toArray(new Long[productIds.size()]));"> 190                  productIds = sandBoxHelper.mergeCloneIds(ProductImpl.class, productIds.toArray(new Long[productIdsðŸ”µ</abbr>
 191  
 192                  if (productIds.size() == 0) {
 193                      return new DynamicResultSet(null, new Entity[0], 0);
 194                  }
 195                  if (productIds.size() &lt;= queryLimit) {
 196                      FilterMapping filterMapping = new FilterMapping()
 197                              .withFieldPath(new FieldPath().withTargetProperty(&quot;id&quot;))
 198                              .withDirectFilterValues(productIds)
 199                              .withRestriction(new Restriction()
 200                                                       .withPredicateProvider(new PredicateProvider() {
 201                                                                                  @Override
<abbr title=" 202                                                                                  public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder,"> 202                                                                                  public Predicate buildPredicate(CrðŸ”µ</abbr>
<abbr title=" 203                                                                                                                  From root, String ceilingEntity, String fullPropertyName,"> 203                                                                                                                  FrðŸ”µ</abbr>
<abbr title=" 204                                                                                                                  Path explicitPath, List directValues) {"> 204                                                                                                                  PaðŸ”µ</abbr>
<abbr title=" 205                                                                                      return explicitPath.in(directValues);"> 205                                                                                      return explicitPath.in(directVðŸ”µ</abbr>
 206                                                                                  }
 207                                                                              }
 208                                                       )
 209                              );
 210                      cto.getAdditionalFilterMappings().add(filterMapping);
 211                  } else {
 212                      String joined = StringUtils.join(transformedValues, &#x27;,&#x27;);
<abbr title=" 213                      LOG.warn(String.format(&quot;Skipping default category filtering for product fetch query since there are &quot; +"> 213                      LOG.warn(String.format(&quot;Skipping default category filtering for product fetch query since therðŸ”µ</abbr>
<abbr title=" 214                                             &quot;more than &quot; + queryLimit + &quot; products found to belong to the selected default categories(%s). This is a &quot; +"> 214                                             &quot;more than &quot; + queryLimit + &quot; products found to belong to the selected ðŸ”µ</abbr>
 215                                             &quot;filter query limitation.&quot;, joined));
 216                  }
 217                  cto.getNonCountAdditionalFilterMappings().add(
 218                          new FilterMapping().withFieldPath(new FieldPath().
 219                                  withAssociationPath(Arrays.asList(&quot;allParentCategoryXrefs&quot;,&quot;category&quot;)).
 220                                  withTargetPropertyPieces(Arrays.asList(&quot;name&quot;)))
 221                                  .withDirectFilterValues(new EmptyFilterValues())
 222                                  .withRestriction(new Restriction()
 223                                          .withPredicateProvider(new PredicateProvider() {
 224                                              @Override
 225                                              public Predicate buildPredicate(CriteriaBuilder builder,
<abbr title=" 226                                                                              FieldPathBuilder fieldPathBuilder, From root,"> 226                                                                              FieldPathBuilder fieldPathBuilder, FroðŸ”µ</abbr>
 227                                                                              String ceilingEntity,
<abbr title=" 228                                                                              String fullPropertyName, Path explicitPath,"> 228                                                                              String fullPropertyName, Path explicitðŸ”µ</abbr>
 229                                                                              List directValues) {
<abbr title=" 230                                                  //expect it to be allParentCategoryXrefs.category.name, so we need to restrict on allParentCategoryXrefs - 2 levels up"> 230                                                  //expect it to be allParentCategoryXrefs.category.name, so we needðŸ”µ</abbr>
<abbr title=" 231                                                  Predicate equal = builder.equal(explicitPath.getParentPath().getParentPath().get(&quot;defaultReference&quot;), Boolean.TRUE);"> 231                                                  Predicate equal = builder.equal(explicitPath.getParentPath().getPaðŸ”µ</abbr>
 232                                                  return equal;
 233                                              }
 234                                          })
 235                                  ).withSortDirection(fsc.getSortDirection()));
 236              }
 237          }
 238  
 239          if (eagerFetchAssociations) {
 240              cto.getNonCountAdditionalFilterMappings().add(new FilterMapping()
 241                                                                    .withDirectFilterValues(new EmptyFilterValues())
 242                                                                    .withRestriction(new Restriction()
<abbr title=" 243                                                                                             .withPredicateProvider(new PredicateProvider() {"> 243                                                                                             .withPredicateProvider(ðŸ”µ</abbr>
 244                                                                                                 @Override
<abbr title=" 245                                                                                                 public Predicate buildPredicate(CriteriaBuilder builder,"> 245                                                                                                 public Predicate buðŸ”µ</abbr>
<abbr title=" 246                                                                                                                                 FieldPathBuilder fieldPathBuilder, From root,"> 246                                                                                                                    ðŸ”µ</abbr>
<abbr title=" 247                                                                                                                                 String ceilingEntity,"> 247                                                                                                                    ðŸ”µ</abbr>
<abbr title=" 248                                                                                                                                 String fullPropertyName, Path explicitPath,"> 248                                                                                                                    ðŸ”µ</abbr>
<abbr title=" 249                                                                                                                                 List directValues) {"> 249                                                                                                                    ðŸ”µ</abbr>
<abbr title=" 250                                                                                                     root.fetch(&quot;defaultSku&quot;, JoinType.LEFT);"> 250                                                                                                     root.fetch(&quot;defðŸ”µ</abbr>
<abbr title=" 251                                                                                                     root.fetch(&quot;defaultCategory&quot;, JoinType.LEFT);"> 251                                                                                                     root.fetch(&quot;defðŸ”µ</abbr>
 252                                                                                                     return null;
 253                                                                                                 }
 254                                                                                             })
 255                                                                    ));
 256          }
 257          return helper.getCompatibleModule(OperationType.BASIC).fetch(persistencePackage, cto);
 258      }
 259  
 260      @Override
<abbr title=" 261      public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 261      public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helpeðŸ”µ</abbr>
 262          Entity entity = persistencePackage.getEntity();
 263          try {
 264              PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();
 265              Product adminInstance = (Product) Class.forName(entity.getType()[0]).newInstance();
<abbr title=" 266              Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 266              Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(),ðŸ”µ</abbr>
 267  
 268              if (adminInstance instanceof ProductBundle) {
 269                  removeBundleFieldRestrictions((ProductBundle) adminInstance, adminProperties, entity);
 270              }
 271  
<abbr title=" 272              adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminProperties, false);"> 272              adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminProperties, falseðŸ”µ</abbr>
 273              adminInstance = dynamicEntityDao.merge(adminInstance);
 274  
 275              //Since none of the Sku fields are required, it&#x27;s possible that the user did not fill out
<abbr title=" 276              //any Sku fields, and thus a Sku would not be created. Product still needs a default Sku so instantiate one"> 276              //any Sku fields, and thus a Sku would not be created. Product still needs a default Sku so instantiatðŸ”µ</abbr>
 277              if (adminInstance.getDefaultSku() == null) {
 278                  Sku newSku = catalogService.createSku();
 279                  dynamicEntityDao.persist(newSku);
 280                  adminInstance.setDefaultSku(newSku);
 281                  adminInstance = dynamicEntityDao.merge(adminInstance);
 282              }
 283  
 284              //also set the default product for the Sku
 285              adminInstance.getDefaultSku().setDefaultProduct(adminInstance);
 286              dynamicEntityDao.merge(adminInstance.getDefaultSku());
 287  
 288              // if this is a Pre-Add, skip the rest of the method
 289              if (entity.isPreAdd()) {
 290                  return helper.getRecord(adminProperties, adminInstance, null, null);
 291              }
 292  
 293              boolean handled = false;
 294              if (extensionManager != null) {
<abbr title=" 295                  ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForAdd(persistencePackage, adminInstance);"> 295                  ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForAdd(persisteðŸ”µ</abbr>
 296                  handled = ExtensionResultStatusType.NOT_HANDLED != result;
 297              }
 298              if (!handled) {
 299                  setupXref(adminInstance);
 300              }
 301  
 302              return helper.getRecord(adminProperties, adminInstance, null, null);
 303          } catch (Exception e) {
 304              throw new ServiceException(&quot;Unable to add entity for &quot; + entity.getType()[0], e);
 305          }
 306      }
 307  
 308      @Override
<abbr title=" 309      public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 309      public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper heðŸ”µ</abbr>
 310          Entity entity = persistencePackage.getEntity();
 311          try {
 312              PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();
 313  
<abbr title=" 314              Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 314              Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(),ðŸ”µ</abbr>
 315  
 316              BasicFieldMetadata defaultCategory = ((BasicFieldMetadata) adminProperties.get(&quot;defaultCategory&quot;));
 317              defaultCategory.setFriendlyName(&quot;ProductImpl_Parent_Category&quot;);
<abbr title=" 318              if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; !StringUtils.isEmpty(entity.findProperty(&quot;defaultCategory&quot;).getValue())) {"> 318              if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; !StringUtils.isEmpty(entity.findProperty(&quot;defaulðŸ”µ</abbr>
<abbr title=" 319                  //Change the inherited type so that this property is disconnected from the entity and validation is temporarily skipped."> 319                  //Change the inherited type so that this property is disconnected from the entity and validation iðŸ”µ</abbr>
<abbr title=" 320                  //This is useful when the defaultCategory was previously completely empty for whatever reason. Without this, such"> 320                  //This is useful when the defaultCategory was previously completely empty for whatever reason. WitðŸ”µ</abbr>
 321                  //a case would fail the validation, even though the property was specified in the submission.
 322                  defaultCategory.setInheritedFromType(String.class.getName());
 323              }
 324  
 325              Object primaryKey = helper.getPrimaryKey(entity, adminProperties);
<abbr title=" 326              Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(entity.getType()[0]), primaryKey);"> 326              Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(entity.getType()[0]), primarðŸ”µ</abbr>
 327              if (adminInstance instanceof ProductBundle) {
 328                  removeBundleFieldRestrictions((ProductBundle) adminInstance, adminProperties, entity);
 329              }
 330  
 331              CategoryProductXref oldDefault = getCurrentDefaultXref(adminInstance);
<abbr title=" 332              //Fix for QA#2963 - during deployment sanboxed (not deployed) version of category will not be fetched from db"> 332              //Fix for QA#2963 - during deployment sanboxed (not deployed) version of category will not be fetched ðŸ”µ</abbr>
<abbr title=" 333              //and it will cause validation error, we should allow deployemnt of product with category in sandbox state"> 333              //and it will cause validation error, we should allow deployemnt of product with category in sandbox sðŸ”µ</abbr>
 334              //so override required flag for that field during deployment
 335              if(BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()){
 336                  ((BasicFieldMetadata)adminProperties.get(&quot;defaultCategory&quot;)).setRequiredOverride(false);
 337              }
<abbr title=" 338              adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminProperties, false);"> 338              adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminProperties, falseðŸ”µ</abbr>
 339              adminInstance = dynamicEntityDao.merge(adminInstance);
 340              boolean handled = false;
 341              if (extensionManager != null) {
 342                  ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForUpdate
 343                          (persistencePackage, adminInstance);
 344                  handled = ExtensionResultStatusType.NOT_HANDLED != result;
 345  
 346                  extensionManager.getProxy().manageFields(persistencePackage, adminInstance);
 347              }
 348              if (!handled) {
 349                  setupXref(adminInstance);
 350                  removeOldDefault(adminInstance, oldDefault, entity);
 351              }
 352  
 353              return helper.getRecord(adminProperties, adminInstance, null, null);
 354          } catch (Exception e) {
 355              throw new ServiceException(&quot;Unable to update entity for &quot; + entity.getType()[0], e);
 356          }
 357      }
 358  
 359      @Override
<abbr title=" 360      public void remove(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 360      public void remove(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helpðŸ”µ</abbr>
 361          Entity entity = persistencePackage.getEntity();
 362          try {
 363              Product adminInstance = getAdminInstance(persistencePackage, dynamicEntityDao, helper, entity);
 364              removeProduct(persistencePackage, adminInstance, helper);
 365              List&lt;Sku&gt; skuList = adminInstance.getAllSkus();
 366              for (Sku sku : skuList) {
 367                  catalogService.removeSku(sku);
 368              }
 369          } catch (ClassNotFoundException e) {
 370              throw new ServiceException(&quot;Unable to remove entity for &quot; + entity.getType()[0], e);
 371          }
 372      }
 373  
<abbr title=" 374      protected Product getAdminInstance(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper,"> 374      protected Product getAdminInstance(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RðŸ”µ</abbr>
 375                                         Entity entity) throws ClassNotFoundException {
 376          PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();
<abbr title=" 377          Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 377          Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), perðŸ”µ</abbr>
 378          Object primaryKey = helper.getPrimaryKey(entity, adminProperties);
 379          String type = entity.getType()[0];
 380          Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(type), primaryKey);
 381  
 382          return adminInstance;
 383      }
 384  
<abbr title=" 385      protected void removeProduct(PersistencePackage persistencePackage, Product adminInstance, RecordHelper helper) throws ServiceException {"> 385      protected void removeProduct(PersistencePackage persistencePackage, Product adminInstance, RecordHelper helperðŸ”µ</abbr>
 386          catalogService.removeProduct(adminInstance);
 387      }
 388  
 389      /**
 390       * If the pricing model is of type item_sum, that property should not be required
 391       *
 392       * @param adminInstance
 393       * @param adminProperties
 394       * @param entity
 395       */
<abbr title=" 396      protected void removeBundleFieldRestrictions(ProductBundle adminInstance, Map&lt;String, FieldMetadata&gt; adminProperties, Entity entity) {"> 396      protected void removeBundleFieldRestrictions(ProductBundle adminInstance, Map&lt;String, FieldMetadata&gt; adminPropðŸ”µ</abbr>
 397          //no required validation for product bundles
 398          ((BasicFieldMetadata) adminProperties.get(&quot;defaultSku.retailPrice&quot;)).setRequiredOverride(false);
 399          if (entity.getPMap().get(&quot;pricingModel&quot;) != null) {
<abbr title=" 400              if (ProductBundlePricingModelType.BUNDLE.getType().equals(entity.getPMap().get(&quot;pricingModel&quot;).getValue())) {"> 400              if (ProductBundlePricingModelType.BUNDLE.getType().equals(entity.getPMap().get(&quot;pricingModel&quot;).getValuðŸ”µ</abbr>
 401                  ((BasicFieldMetadata) adminProperties.get(&quot;defaultSku.retailPrice&quot;)).setRequiredOverride(true);
 402              }
 403          }
 404      }
 405  
 406      protected Boolean isDefaultCategoryLegacyMode() {
<abbr title=" 407          ParentCategoryLegacyModeService legacyModeService = ParentCategoryLegacyModeServiceImpl.getLegacyModeService();"> 407          ParentCategoryLegacyModeService legacyModeService = ParentCategoryLegacyModeServiceImpl.getLegacyModeServiðŸ”µ</abbr>
 408          if (legacyModeService != null) {
 409              return legacyModeService.isLegacyMode();
 410          }
 411          return false;
 412      }
 413  
 414      protected void modifyParentCategoryMetadata(Map&lt;String, FieldMetadata&gt; md) {
 415          if (!isDefaultCategoryLegacyMode()) {
 416              md.remove(&quot;allParentCategoryXrefs&quot;);
 417  
 418              BasicFieldMetadata defaultCategory = ((BasicFieldMetadata) md.get(&quot;defaultCategory&quot;));
 419              defaultCategory.setFriendlyName(&quot;ProductImpl_Parent_Category&quot;);
 420          }
 421      }
 422  
 423      protected Category getExistingDefaultCategory(Product product) {
 424          //Make sure we get the actual field value - not something manipulated in the getter
 425          Category parentCategory;
 426          try {
 427              Field defaultCategory = ProductImpl.class.getDeclaredField(&quot;defaultCategory&quot;);
 428              defaultCategory.setAccessible(true);
 429              parentCategory = (Category) defaultCategory.get(product);
 430          } catch (NoSuchFieldException e) {
 431              throw ExceptionHelper.refineException(e);
 432          } catch (IllegalAccessException e) {
 433              throw ExceptionHelper.refineException(e);
 434          }
 435          return parentCategory;
 436      }
 437  
 438      protected void removeOldDefault(Product adminInstance, CategoryProductXref oldDefault, Entity entity) {
 439          if (!isDefaultCategoryLegacyMode()) {
<abbr title=" 440              if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; StringUtils.isEmpty(entity.findProperty(&quot;defaultCategory&quot;).getValue())) {"> 440              if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; StringUtils.isEmpty(entity.findProperty(&quot;defaultðŸ”µ</abbr>
 441                  adminInstance.setCategory(null);
 442              }
 443              CategoryProductXref newDefault = getCurrentDefaultXref(adminInstance);
 444              if (oldDefault != null &amp;&amp; !oldDefault.equals(newDefault)) {
 445                  adminInstance.getAllParentCategoryXrefs().remove(oldDefault);
 446              }
 447          }
 448      }
 449  
 450      protected void setupXref(Product adminInstance) {
 451          if (isDefaultCategoryLegacyMode()) {
 452              CategoryProductXref categoryXref = new CategoryProductXrefImpl();
 453              categoryXref.setCategory(getExistingDefaultCategory(adminInstance));
 454              categoryXref.setProduct(adminInstance);
<abbr title=" 455              if (!adminInstance.getAllParentCategoryXrefs().contains(categoryXref) &amp;&amp; categoryXref.getCategory() != null) {"> 455              if (!adminInstance.getAllParentCategoryXrefs().contains(categoryXref) &amp;&amp; categoryXref.getCategory() !=ðŸ”µ</abbr>
 456                  adminInstance.getAllParentCategoryXrefs().add(categoryXref);
 457              }
 458          }
 459      }
 460  
 461      protected CategoryProductXref getCurrentDefaultXref(Product product) {
 462          CategoryProductXref currentDefault = null;
 463          List&lt;CategoryProductXref&gt; xrefs = product.getAllParentCategoryXrefs();
 464          if (!CollectionUtils.isEmpty(xrefs)) {
 465              for (CategoryProductXref xref : xrefs) {
<abbr title=" 466                  if (xref.getCategory().isActive() &amp;&amp; xref.getDefaultReference() != null &amp;&amp; xref.getDefaultReference()) {"> 466                  if (xref.getCategory().isActive() &amp;&amp; xref.getDefaultReference() != null &amp;&amp; xref.getDefaultReferencðŸ”µ</abbr>
 467                      currentDefault = xref;
 468                      break;
 469                  }
 470              }
 471          }
 472          return currentDefault;
 473      }
 474  
 475      protected boolean isRecursiveProductSelection(PersistencePackage persistencePackage) {
 476          List&lt;String&gt; customCriteria = Arrays.asList(persistencePackage.getCustomCriteria());
<abbr title=" 477          return customCriteria.contains(&quot;upsaleProduct&quot;) || customCriteria.contains(&quot;crossSaleProduct&quot;) || customCriteria.contains(&quot;requestingField=addOnProduct&quot;);"> 477          return customCriteria.contains(&quot;upsaleProduct&quot;) || customCriteria.contains(&quot;crossSaleProduct&quot;) || customCrðŸ”µ</abbr>



 478      }
 479  
<abbr title=" 480      protected FilterMapping createFilterMappingForProperty(String targetPropertyName, PredicateProvider predicateProvider) {"> 480      protected FilterMapping createFilterMappingForProperty(String targetPropertyName, PredicateProvider predicatePðŸ”µ</abbr>
 481  
 482          FieldPath fieldPath = new FieldPath().withTargetProperty(targetPropertyName);
 483          EmptyFilterValues directFilterValues = new EmptyFilterValues();
 484          Restriction newRestriction = new Restriction().withPredicateProvider(predicateProvider);
 485  
 486          return new FilterMapping()
 487              .withFieldPath(fieldPath)
 488              .withDirectFilterValues(directFilterValues)
 489              .withRestriction(newRestriction);
 490      }
 491  
<abbr title=" 492      protected DynamicResultSet getFilteredDynamicResultSet(PersistencePackage persistencePackage, CriteriaTransferObject cto, RecordHelper helper) throws ServiceException {"> 492      protected DynamicResultSet getFilteredDynamicResultSet(PersistencePackage persistencePackage, CriteriaTransferðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 493 -        FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicateProvider() {"> 493 -        FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicateProvider()ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 494 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 495 -            public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder, From root,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 496 -                                            String ceilingEntity, String fullPropertyName, Path explicitPath,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 497 -                                            List directValues) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 498 -                return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbs()[0].getSectionId()));"> 498 -                return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbs()[0].getSectðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 499 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 500 -        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 501 -        cto.getAdditionalFilterMappings().add(defaultCategoryMapping);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 502 +        if(persistencePackage.getSectionCrumbs()!=null &amp;&amp; persistencePackage.getSectionCrumbs().length&gt;0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 503 +            FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicateProvider() {"> 503 +            FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicateProvidðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 504 +                @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 505 +                public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder, From root,"> 505 +                public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder, From rðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 506 +                                                String ceilingEntity, String fullPropertyName, Path explicitPath,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 507 +                                                List directValues) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 508 +                    return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbs()[0].getSectionId()));"> 508 +                    return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbs()[0].getðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 509 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 510 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 511 +            cto.getAdditionalFilterMappings().add(defaultCategoryMapping);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 512 +        }</span>
<abbr title=" 513          OperationType fetchType = persistencePackage.getPersistencePerspective().getOperationTypes().getFetchType();"> 513          OperationType fetchType = persistencePackage.getPersistencePerspective().getOperationTypes().getFetchType(ðŸ”µ</abbr>
 514          PersistenceModule persistenceModule = helper.getCompatibleModule(fetchType);
 515          return persistenceModule.fetch(persistencePackage, cto);
 516      }
 517  }</pre></td>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 +/*-</span>
   3   * #%L
   4   * BroadleafCommerce Admin Module
   5   * %%
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + * Copyright (C) 2009 - 2022 Broadleaf Commerce</span>
   8   * %%
   9   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
  10   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
  11   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  12   * the Broadleaf End User License Agreement (EULA), Version 1.1
  13   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  14   * shall apply.
  15   *
<abbr title="  16   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  16   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  17   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  18   * #L%
  19   */
  20  package org.broadleafcommerce.admin.server.service.handler;
  21  
  22  import org.apache.commons.collections.CollectionUtils;
  23  import org.apache.commons.lang.ArrayUtils;
  24  import org.apache.commons.lang3.StringUtils;
  25  import org.apache.commons.logging.Log;
  26  import org.apache.commons.logging.LogFactory;
  27  import org.broadleafcommerce.admin.server.service.extension.ProductCustomPersistenceHandlerExtensionManager;
  28  import org.broadleafcommerce.common.exception.ExceptionHelper;
  29  import org.broadleafcommerce.common.exception.ServiceException;
  30  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  31  import org.broadleafcommerce.common.presentation.client.OperationType;
  32  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  33  import org.broadleafcommerce.common.service.ParentCategoryLegacyModeService;
  34  import org.broadleafcommerce.common.service.ParentCategoryLegacyModeServiceImpl;
  35  import org.broadleafcommerce.common.util.BLCCollectionUtils;
  36  import org.broadleafcommerce.common.util.TypedTransformer;
  37  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  38  import org.broadleafcommerce.core.catalog.domain.Category;
  39  import org.broadleafcommerce.core.catalog.domain.CategoryProductXref;
  40  import org.broadleafcommerce.core.catalog.domain.CategoryProductXrefImpl;
  41  import org.broadleafcommerce.core.catalog.domain.Product;
  42  import org.broadleafcommerce.core.catalog.domain.ProductBundle;
  43  import org.broadleafcommerce.core.catalog.domain.ProductImpl;
  44  import org.broadleafcommerce.core.catalog.domain.Sku;
  45  import org.broadleafcommerce.core.catalog.service.CatalogService;
  46  import org.broadleafcommerce.core.catalog.service.type.ProductBundlePricingModelType;
  47  import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  48  import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  49  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  50  import org.broadleafcommerce.openadmin.dto.Entity;
  51  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  52  import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  53  import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  54  import org.broadleafcommerce.openadmin.dto.PersistencePerspective;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +import org.broadleafcommerce.openadmin.dto.SectionCrumb;</span>
  56  import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  57  import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  58  import org.broadleafcommerce.openadmin.server.service.persistence.module.EmptyFilterValues;
  59  import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  60  import org.broadleafcommerce.openadmin.server.service.persistence.module.PersistenceModule;
  61  import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  62  import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FieldPath;
  63  import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FieldPathBuilder;
  64  import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.FilterMapping;
  65  import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.Restriction;
  66  import org.broadleafcommerce.openadmin.server.service.persistence.module.criteria.predicate.PredicateProvider;
  67  import org.springframework.beans.factory.annotation.Value;
  68  import org.springframework.stereotype.Component;
  69  import java.lang.reflect.Field;
  70  import java.util.ArrayList;
  71  import java.util.Arrays;
  72  import java.util.List;
  73  import java.util.Map;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +import java.util.stream.Stream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +</span>
  76  import javax.annotation.Resource;
  77  import javax.persistence.TypedQuery;
  78  import javax.persistence.criteria.CriteriaBuilder;
  79  import javax.persistence.criteria.CriteriaQuery;
  80  import javax.persistence.criteria.From;
  81  import javax.persistence.criteria.JoinType;
  82  import javax.persistence.criteria.Path;
  83  import javax.persistence.criteria.Predicate;
  84  import javax.persistence.criteria.Root;
  85  
  86  /**
  87   * @author Jeff Fischer
  88   */
  89  @Component(&quot;blProductCustomPersistenceHandler&quot;)
  90  public class ProductCustomPersistenceHandler extends CustomPersistenceHandlerAdapter {
  91  
  92      protected static final String ID_PROPERTY = &quot;id&quot;;
  93  
  94      @Resource(name = &quot;blCatalogService&quot;)
  95      protected CatalogService catalogService;
  96  
  97      @Resource(name = &quot;blProductCustomPersistenceHandlerExtensionManager&quot;)
  98      protected ProductCustomPersistenceHandlerExtensionManager extensionManager;
  99  
 100      @Resource(name = &quot;blParentCategoryLegacyModeService&quot;)
 101      protected ParentCategoryLegacyModeService parentCategoryLegacyModeService;
 102  
 103      @Resource(name = &quot;blSandBoxHelper&quot;)
 104      protected SandBoxHelper sandBoxHelper;
 105  
 106      @Value(&quot;${product.query.limit:500}&quot;)
 107      protected long queryLimit;
 108  
 109      @Value(&quot;${product.eager.fetch.associations.admin:true}&quot;)
 110      protected boolean eagerFetchAssociations = true;
 111  
 112      private static final Log LOG = LogFactory.getLog(ProductCustomPersistenceHandler.class);
 113  
 114      @Override
 115      public Boolean canHandleAdd(PersistencePackage persistencePackage) {
<abbr title=" 116          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 116          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
 117          String[] customCriteria = persistencePackage.getCustomCriteria();
<abbr title=" 118          return !ArrayUtils.isEmpty(customCriteria) &amp;&amp; &quot;productDirectEdit&quot;.equals(customCriteria[0]) &amp;&amp; Product.class.getName().equals(ceilingEntityFullyQualifiedClassname);"> 118          return !ArrayUtils.isEmpty(customCriteria) &amp;&amp; &quot;productDirectEdit&quot;.equals(customCriteria[0]) &amp;&amp; Product.claðŸ”µ</abbr>
 119      }
 120  
 121      @Override
 122      public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 123          return canHandleAdd(persistencePackage);
 124      }
 125  
 126      @Override
 127      public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 128          return canHandleAdd(persistencePackage);
 129      }
 130  
 131      @Override
 132      public Boolean canHandleFetch(PersistencePackage persistencePackage) {
 133          return isRecursiveProductSelection(persistencePackage) || canHandleAdd(persistencePackage);
 134      }
 135  
 136      @Override
 137      public Boolean canHandleInspect(PersistencePackage persistencePackage) {
 138          return canHandleAdd(persistencePackage);
 139      }
 140  
 141      @Override
<abbr title=" 142      public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 142      public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspðŸ”µ</abbr>
 143          Map&lt;String, FieldMetadata&gt; md = getMetadata(persistencePackage, helper);
 144  
 145          modifyParentCategoryMetadata(md);
 146  
 147          extensionManager.getProxy().manageInspect(md);
 148  
 149          return getResultSet(persistencePackage, helper, md);
 150      }
 151  
 152      @Override
<abbr title=" 153      public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao"> 153      public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityðŸ”µ</abbr>
 154              dynamicEntityDao, RecordHelper helper) throws ServiceException {
 155  
 156          if (isRecursiveProductSelection(persistencePackage)) {
 157              return getFilteredDynamicResultSet(persistencePackage, cto, helper);
 158          }
 159  
 160          boolean legacy = parentCategoryLegacyModeService.isLegacyMode();
 161  
 162          //the following code applies when filters are present only:
<abbr title=" 163          //&quot;legacy&quot; means that the parent category filter still utilizes Product.defaultCategory as the field to be matched"> 163          //&quot;legacy&quot; means that the parent category filter still utilizes Product.defaultCategory as the field to beðŸ”µ</abbr>
<abbr title=" 164          //against the categories chosen in the listGrid filter. The default behavior up to this point, assumes the &quot;legacy&quot; mode."> 164          //against the categories chosen in the listGrid filter. The default behavior up to this point, assumes theðŸ”µ</abbr>
<abbr title=" 165          //This means that one of the FilterAndSortCriterias will try to match the chosen values against &quot;defaultCategory&quot;."> 165          //This means that one of the FilterAndSortCriterias will try to match the chosen values against &quot;defaultCaðŸ”µ</abbr>
<abbr title=" 166          //If &quot;legacy&quot; is false, we remove that FilterAndSortCriteria from the CTO, and inject a new FilterMapping in cto.additionalFilterMappings,"> 166          //If &quot;legacy&quot; is false, we remove that FilterAndSortCriteria from the CTO, and inject a new FilterMapping ðŸ”µ</abbr>
 167          //which seeks matching values in  allParentCategoryXRefs instead
 168          if (!legacy) {
 169              FilterAndSortCriteria fsc = cto.getCriteriaMap().get(&quot;defaultCategory&quot;);
 170              if (fsc != null) {
 171                  List&lt;String&gt; filterValues = fsc.getFilterValues();
 172                  cto.getCriteriaMap().remove(&quot;defaultCategory&quot;);
 173  
<abbr title=" 174                  List&lt;Long&gt; transformedValues = BLCCollectionUtils.collectList(filterValues, new TypedTransformer&lt;Long&gt;() {"> 174                  List&lt;Long&gt; transformedValues = BLCCollectionUtils.collectList(filterValues, new TypedTransformer&lt;LðŸ”µ</abbr>
 175                      @Override
 176                      public Long transform(Object input) {
 177                          return Long.parseLong(((String) input));
 178                      }
 179                  });
 180                  CriteriaBuilder builder = dynamicEntityDao.getStandardEntityManager().getCriteriaBuilder();
 181                  CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 182                  Root&lt;CategoryProductXrefImpl&gt; root = criteria.from(CategoryProductXrefImpl.class);
 183                  criteria.select(root.get(&quot;product&quot;).get(&quot;id&quot;).as(Long.class));
 184                  List&lt;Predicate&gt; restrictions = new ArrayList&lt;Predicate&gt;();
 185                  restrictions.add(builder.equal(root.get(&quot;defaultReference&quot;), Boolean.TRUE));
 186                  if (CollectionUtils.isNotEmpty(transformedValues)) {
 187                      restrictions.add(root.get(&quot;category&quot;).get(&quot;id&quot;).in(transformedValues));
 188                  }
 189  
 190                  criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
 191                  TypedQuery&lt;Long&gt; query = dynamicEntityDao.getStandardEntityManager().createQuery(criteria);
 192                  List&lt;Long&gt; productIds = query.getResultList();
<abbr title=" 193                  productIds = sandBoxHelper.mergeCloneIds(ProductImpl.class, productIds.toArray(new Long[productIds.size()]));"> 193                  productIds = sandBoxHelper.mergeCloneIds(ProductImpl.class, productIds.toArray(new Long[productIdsðŸ”µ</abbr>
 194  
 195                  if (productIds.size() == 0) {
 196                      return new DynamicResultSet(null, new Entity[0], 0);
 197                  }
 198                  if (productIds.size() &lt;= queryLimit) {
 199                      FilterMapping filterMapping = new FilterMapping()
 200                              .withFieldPath(new FieldPath().withTargetProperty(&quot;id&quot;))
 201                              .withDirectFilterValues(productIds)
 202                              .withRestriction(new Restriction()
 203                                                       .withPredicateProvider(new PredicateProvider() {
 204                                                                                  @Override
<abbr title=" 205                                                                                  public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder,"> 205                                                                                  public Predicate buildPredicate(CrðŸ”µ</abbr>
<abbr title=" 206                                                                                                                  From root, String ceilingEntity, String fullPropertyName,"> 206                                                                                                                  FrðŸ”µ</abbr>
<abbr title=" 207                                                                                                                  Path explicitPath, List directValues) {"> 207                                                                                                                  PaðŸ”µ</abbr>
<abbr title=" 208                                                                                      return explicitPath.in(directValues);"> 208                                                                                      return explicitPath.in(directVðŸ”µ</abbr>
 209                                                                                  }
 210                                                                              }
 211                                                       )
 212                              );
 213                      cto.getAdditionalFilterMappings().add(filterMapping);
 214                  } else {
 215                      String joined = StringUtils.join(transformedValues, &#x27;,&#x27;);
<abbr title=" 216                      LOG.warn(String.format(&quot;Skipping default category filtering for product fetch query since there are &quot; +"> 216                      LOG.warn(String.format(&quot;Skipping default category filtering for product fetch query since therðŸ”µ</abbr>
<abbr title=" 217                                             &quot;more than &quot; + queryLimit + &quot; products found to belong to the selected default categories(%s). This is a &quot; +"> 217                                             &quot;more than &quot; + queryLimit + &quot; products found to belong to the selected ðŸ”µ</abbr>
 218                                             &quot;filter query limitation.&quot;, joined));
 219                  }
 220                  cto.getNonCountAdditionalFilterMappings().add(
 221                          new FilterMapping().withFieldPath(new FieldPath().
 222                                  withAssociationPath(Arrays.asList(&quot;allParentCategoryXrefs&quot;,&quot;category&quot;)).
 223                                  withTargetPropertyPieces(Arrays.asList(&quot;name&quot;)))
 224                                  .withDirectFilterValues(new EmptyFilterValues())
 225                                  .withRestriction(new Restriction()
 226                                          .withPredicateProvider(new PredicateProvider() {
 227                                              @Override
 228                                              public Predicate buildPredicate(CriteriaBuilder builder,
<abbr title=" 229                                                                              FieldPathBuilder fieldPathBuilder, From root,"> 229                                                                              FieldPathBuilder fieldPathBuilder, FroðŸ”µ</abbr>
 230                                                                              String ceilingEntity,
<abbr title=" 231                                                                              String fullPropertyName, Path explicitPath,"> 231                                                                              String fullPropertyName, Path explicitðŸ”µ</abbr>
 232                                                                              List directValues) {
<abbr title=" 233                                                  //expect it to be allParentCategoryXrefs.category.name, so we need to restrict on allParentCategoryXrefs - 2 levels up"> 233                                                  //expect it to be allParentCategoryXrefs.category.name, so we needðŸ”µ</abbr>
<abbr title=" 234                                                  Predicate equal = builder.equal(explicitPath.getParentPath().getParentPath().get(&quot;defaultReference&quot;), Boolean.TRUE);"> 234                                                  Predicate equal = builder.equal(explicitPath.getParentPath().getPaðŸ”µ</abbr>
 235                                                  return equal;
 236                                              }
 237                                          })
 238                                  ).withSortDirection(fsc.getSortDirection()));
 239              }
 240          }
 241  
 242          if (eagerFetchAssociations) {
 243              cto.getNonCountAdditionalFilterMappings().add(new FilterMapping()
 244                                                                    .withDirectFilterValues(new EmptyFilterValues())
 245                                                                    .withRestriction(new Restriction()
<abbr title=" 246                                                                                             .withPredicateProvider(new PredicateProvider() {"> 246                                                                                             .withPredicateProvider(ðŸ”µ</abbr>
 247                                                                                                 @Override
<abbr title=" 248                                                                                                 public Predicate buildPredicate(CriteriaBuilder builder,"> 248                                                                                                 public Predicate buðŸ”µ</abbr>
<abbr title=" 249                                                                                                                                 FieldPathBuilder fieldPathBuilder, From root,"> 249                                                                                                                    ðŸ”µ</abbr>
<abbr title=" 250                                                                                                                                 String ceilingEntity,"> 250                                                                                                                    ðŸ”µ</abbr>
<abbr title=" 251                                                                                                                                 String fullPropertyName, Path explicitPath,"> 251                                                                                                                    ðŸ”µ</abbr>
<abbr title=" 252                                                                                                                                 List directValues) {"> 252                                                                                                                    ðŸ”µ</abbr>
<abbr title=" 253                                                                                                     root.fetch(&quot;defaultSku&quot;, JoinType.LEFT);"> 253                                                                                                     root.fetch(&quot;defðŸ”µ</abbr>
<abbr title=" 254                                                                                                     root.fetch(&quot;defaultCategory&quot;, JoinType.LEFT);"> 254                                                                                                     root.fetch(&quot;defðŸ”µ</abbr>
 255                                                                                                     return null;
 256                                                                                                 }
 257                                                                                             })
 258                                                                    ));
 259          }
 260          return helper.getCompatibleModule(OperationType.BASIC).fetch(persistencePackage, cto);
 261      }
 262  
 263      @Override
<abbr title=" 264      public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 264      public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helpeðŸ”µ</abbr>
 265          Entity entity = persistencePackage.getEntity();
 266          try {
 267              PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();
 268              Product adminInstance = (Product) Class.forName(entity.getType()[0]).newInstance();
<abbr title=" 269              Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 269              Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(),ðŸ”µ</abbr>
 270  
 271              if (adminInstance instanceof ProductBundle) {
 272                  removeBundleFieldRestrictions((ProductBundle) adminInstance, adminProperties, entity);
 273              }
 274  
<abbr title=" 275              adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminProperties, false);"> 275              adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminProperties, falseðŸ”µ</abbr>
 276              adminInstance = dynamicEntityDao.merge(adminInstance);
 277  
 278              //Since none of the Sku fields are required, it&#x27;s possible that the user did not fill out
<abbr title=" 279              //any Sku fields, and thus a Sku would not be created. Product still needs a default Sku so instantiate one"> 279              //any Sku fields, and thus a Sku would not be created. Product still needs a default Sku so instantiatðŸ”µ</abbr>
 280              if (adminInstance.getDefaultSku() == null) {
 281                  Sku newSku = catalogService.createSku();
 282                  dynamicEntityDao.persist(newSku);
 283                  adminInstance.setDefaultSku(newSku);
 284                  adminInstance = dynamicEntityDao.merge(adminInstance);
 285              }
 286  
 287              //also set the default product for the Sku
 288              adminInstance.getDefaultSku().setDefaultProduct(adminInstance);
 289              dynamicEntityDao.merge(adminInstance.getDefaultSku());
 290  
 291              // if this is a Pre-Add, skip the rest of the method
 292              if (entity.isPreAdd()) {
 293                  return helper.getRecord(adminProperties, adminInstance, null, null);
 294              }
 295  
 296              boolean handled = false;
 297              if (extensionManager != null) {
<abbr title=" 298                  ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForAdd(persistencePackage, adminInstance);"> 298                  ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForAdd(persisteðŸ”µ</abbr>
 299                  handled = ExtensionResultStatusType.NOT_HANDLED != result;
 300              }
 301              if (!handled) {
 302                  setupXref(adminInstance);
 303              }
 304  
 305              return helper.getRecord(adminProperties, adminInstance, null, null);
 306          } catch (Exception e) {
 307              throw new ServiceException(&quot;Unable to add entity for &quot; + entity.getType()[0], e);
 308          }
 309      }
 310  
 311      @Override
<abbr title=" 312      public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 312      public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper heðŸ”µ</abbr>
 313          Entity entity = persistencePackage.getEntity();
 314          try {
 315              PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();
 316  
<abbr title=" 317              Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 317              Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(),ðŸ”µ</abbr>
 318  
 319              BasicFieldMetadata defaultCategory = ((BasicFieldMetadata) adminProperties.get(&quot;defaultCategory&quot;));
 320              defaultCategory.setFriendlyName(&quot;ProductImpl_Parent_Category&quot;);
<abbr title=" 321              if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; !StringUtils.isEmpty(entity.findProperty(&quot;defaultCategory&quot;).getValue())) {"> 321              if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; !StringUtils.isEmpty(entity.findProperty(&quot;defaulðŸ”µ</abbr>
<abbr title=" 322                  //Change the inherited type so that this property is disconnected from the entity and validation is temporarily skipped."> 322                  //Change the inherited type so that this property is disconnected from the entity and validation iðŸ”µ</abbr>
<abbr title=" 323                  //This is useful when the defaultCategory was previously completely empty for whatever reason. Without this, such"> 323                  //This is useful when the defaultCategory was previously completely empty for whatever reason. WitðŸ”µ</abbr>
 324                  //a case would fail the validation, even though the property was specified in the submission.
 325                  defaultCategory.setInheritedFromType(String.class.getName());
 326              }
 327  
 328              Object primaryKey = helper.getPrimaryKey(entity, adminProperties);
<abbr title=" 329              Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(entity.getType()[0]), primaryKey);"> 329              Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(entity.getType()[0]), primarðŸ”µ</abbr>
 330              if (adminInstance instanceof ProductBundle) {
 331                  removeBundleFieldRestrictions((ProductBundle) adminInstance, adminProperties, entity);
 332              }
 333  
 334              CategoryProductXref oldDefault = getCurrentDefaultXref(adminInstance);
<abbr title=" 335              //Fix for QA#2963 - during deployment sanboxed (not deployed) version of category will not be fetched from db"> 335              //Fix for QA#2963 - during deployment sanboxed (not deployed) version of category will not be fetched ðŸ”µ</abbr>
<abbr title=" 336              //and it will cause validation error, we should allow deployemnt of product with category in sandbox state"> 336              //and it will cause validation error, we should allow deployemnt of product with category in sandbox sðŸ”µ</abbr>
 337              //so override required flag for that field during deployment
 338              if(BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()){
 339                  ((BasicFieldMetadata)adminProperties.get(&quot;defaultCategory&quot;)).setRequiredOverride(false);
 340              }
<abbr title=" 341              adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminProperties, false);"> 341              adminInstance = (Product) helper.createPopulatedInstance(adminInstance, entity, adminProperties, falseðŸ”µ</abbr>
 342              adminInstance = dynamicEntityDao.merge(adminInstance);
 343              boolean handled = false;
 344              if (extensionManager != null) {
 345                  ExtensionResultStatusType result = extensionManager.getProxy().manageParentCategoryForUpdate
 346                          (persistencePackage, adminInstance);
 347                  handled = ExtensionResultStatusType.NOT_HANDLED != result;
 348  
 349                  extensionManager.getProxy().manageFields(persistencePackage, adminInstance);
 350              }
 351              if (!handled) {
 352                  setupXref(adminInstance);
 353                  removeOldDefault(adminInstance, oldDefault, entity);
 354              }
 355  
 356              return helper.getRecord(adminProperties, adminInstance, null, null);
 357          } catch (Exception e) {
 358              throw new ServiceException(&quot;Unable to update entity for &quot; + entity.getType()[0], e);
 359          }
 360      }
 361  
 362      @Override
<abbr title=" 363      public void remove(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 363      public void remove(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helpðŸ”µ</abbr>
 364          Entity entity = persistencePackage.getEntity();
 365          try {
 366              Product adminInstance = getAdminInstance(persistencePackage, dynamicEntityDao, helper, entity);
 367              removeProduct(persistencePackage, adminInstance, helper);
 368              List&lt;Sku&gt; skuList = adminInstance.getAllSkus();
 369              for (Sku sku : skuList) {
 370                  catalogService.removeSku(sku);
 371              }
 372          } catch (ClassNotFoundException e) {
 373              throw new ServiceException(&quot;Unable to remove entity for &quot; + entity.getType()[0], e);
 374          }
 375      }
 376  
<abbr title=" 377      protected Product getAdminInstance(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper,"> 377      protected Product getAdminInstance(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RðŸ”µ</abbr>
 378                                         Entity entity) throws ClassNotFoundException {
 379          PersistencePerspective persistencePerspective = persistencePackage.getPersistencePerspective();
<abbr title=" 380          Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), persistencePerspective);"> 380          Map&lt;String, FieldMetadata&gt; adminProperties = helper.getSimpleMergedProperties(Product.class.getName(), perðŸ”µ</abbr>
 381          Object primaryKey = helper.getPrimaryKey(entity, adminProperties);
 382          String type = entity.getType()[0];
 383          Product adminInstance = (Product) dynamicEntityDao.retrieve(Class.forName(type), primaryKey);
 384  
 385          return adminInstance;
 386      }
 387  
<abbr title=" 388      protected void removeProduct(PersistencePackage persistencePackage, Product adminInstance, RecordHelper helper) throws ServiceException {"> 388      protected void removeProduct(PersistencePackage persistencePackage, Product adminInstance, RecordHelper helperðŸ”µ</abbr>
 389          catalogService.removeProduct(adminInstance);
 390      }
 391  
 392      /**
 393       * If the pricing model is of type item_sum, that property should not be required
 394       *
 395       * @param adminInstance
 396       * @param adminProperties
 397       * @param entity
 398       */
<abbr title=" 399      protected void removeBundleFieldRestrictions(ProductBundle adminInstance, Map&lt;String, FieldMetadata&gt; adminProperties, Entity entity) {"> 399      protected void removeBundleFieldRestrictions(ProductBundle adminInstance, Map&lt;String, FieldMetadata&gt; adminPropðŸ”µ</abbr>
 400          //no required validation for product bundles
 401          ((BasicFieldMetadata) adminProperties.get(&quot;defaultSku.retailPrice&quot;)).setRequiredOverride(false);
 402          if (entity.getPMap().get(&quot;pricingModel&quot;) != null) {
<abbr title=" 403              if (ProductBundlePricingModelType.BUNDLE.getType().equals(entity.getPMap().get(&quot;pricingModel&quot;).getValue())) {"> 403              if (ProductBundlePricingModelType.BUNDLE.getType().equals(entity.getPMap().get(&quot;pricingModel&quot;).getValuðŸ”µ</abbr>
 404                  ((BasicFieldMetadata) adminProperties.get(&quot;defaultSku.retailPrice&quot;)).setRequiredOverride(true);
 405              }
 406          }
 407      }
 408  
 409      protected Boolean isDefaultCategoryLegacyMode() {
<abbr title=" 410          ParentCategoryLegacyModeService legacyModeService = ParentCategoryLegacyModeServiceImpl.getLegacyModeService();"> 410          ParentCategoryLegacyModeService legacyModeService = ParentCategoryLegacyModeServiceImpl.getLegacyModeServiðŸ”µ</abbr>
 411          if (legacyModeService != null) {
 412              return legacyModeService.isLegacyMode();
 413          }
 414          return false;
 415      }
 416  
 417      protected void modifyParentCategoryMetadata(Map&lt;String, FieldMetadata&gt; md) {
 418          if (!isDefaultCategoryLegacyMode()) {
 419              md.remove(&quot;allParentCategoryXrefs&quot;);
 420  
 421              BasicFieldMetadata defaultCategory = ((BasicFieldMetadata) md.get(&quot;defaultCategory&quot;));
 422              defaultCategory.setFriendlyName(&quot;ProductImpl_Parent_Category&quot;);
 423          }
 424      }
 425  
 426      protected Category getExistingDefaultCategory(Product product) {
 427          //Make sure we get the actual field value - not something manipulated in the getter
 428          Category parentCategory;
 429          try {
 430              Field defaultCategory = ProductImpl.class.getDeclaredField(&quot;defaultCategory&quot;);
 431              defaultCategory.setAccessible(true);
 432              parentCategory = (Category) defaultCategory.get(product);
 433          } catch (NoSuchFieldException e) {
 434              throw ExceptionHelper.refineException(e);
 435          } catch (IllegalAccessException e) {
 436              throw ExceptionHelper.refineException(e);
 437          }
 438          return parentCategory;
 439      }
 440  
 441      protected void removeOldDefault(Product adminInstance, CategoryProductXref oldDefault, Entity entity) {
 442          if (!isDefaultCategoryLegacyMode()) {
<abbr title=" 443              if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; StringUtils.isEmpty(entity.findProperty(&quot;defaultCategory&quot;).getValue())) {"> 443              if (entity.findProperty(&quot;defaultCategory&quot;) != null &amp;&amp; StringUtils.isEmpty(entity.findProperty(&quot;defaultðŸ”µ</abbr>
 444                  adminInstance.setCategory(null);
 445              }
 446              CategoryProductXref newDefault = getCurrentDefaultXref(adminInstance);
 447              if (oldDefault != null &amp;&amp; !oldDefault.equals(newDefault)) {
 448                  adminInstance.getAllParentCategoryXrefs().remove(oldDefault);
 449              }
 450          }
 451      }
 452  
 453      protected void setupXref(Product adminInstance) {
 454          if (isDefaultCategoryLegacyMode()) {
 455              CategoryProductXref categoryXref = new CategoryProductXrefImpl();
 456              categoryXref.setCategory(getExistingDefaultCategory(adminInstance));
 457              categoryXref.setProduct(adminInstance);
<abbr title=" 458              if (!adminInstance.getAllParentCategoryXrefs().contains(categoryXref) &amp;&amp; categoryXref.getCategory() != null) {"> 458              if (!adminInstance.getAllParentCategoryXrefs().contains(categoryXref) &amp;&amp; categoryXref.getCategory() !=ðŸ”µ</abbr>
 459                  adminInstance.getAllParentCategoryXrefs().add(categoryXref);
 460              }
 461          }
 462      }
 463  
 464      protected CategoryProductXref getCurrentDefaultXref(Product product) {
 465          CategoryProductXref currentDefault = null;
 466          List&lt;CategoryProductXref&gt; xrefs = product.getAllParentCategoryXrefs();
 467          if (!CollectionUtils.isEmpty(xrefs)) {
 468              for (CategoryProductXref xref : xrefs) {
<abbr title=" 469                  if (xref.getCategory().isActive() &amp;&amp; xref.getDefaultReference() != null &amp;&amp; xref.getDefaultReference()) {"> 469                  if (xref.getCategory().isActive() &amp;&amp; xref.getDefaultReference() != null &amp;&amp; xref.getDefaultReferencðŸ”µ</abbr>
 470                      currentDefault = xref;
 471                      break;
 472                  }
 473              }
 474          }
 475          return currentDefault;
 476      }
 477  
 478      protected boolean isRecursiveProductSelection(PersistencePackage persistencePackage) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 479 -        List&lt;String&gt; customCriteria = Arrays.asList(persistencePackage.getCustomCriteria());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 480 -        return customCriteria.contains(&quot;upsaleProduct&quot;) || customCriteria.contains(&quot;crossSaleProduct&quot;) || customCriteria.contains(&quot;requestingField=addOnProduct&quot;);"> 480 -        return customCriteria.contains(&quot;upsaleProduct&quot;) || customCriteria.contains(&quot;crossSaleProduct&quot;) || customCrðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 481 +        final List&lt;String&gt; customCriteria = Arrays.asList(persistencePackage.getCustomCriteria());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 482 +        return Stream.of(&quot;upsaleProduct&quot;, &quot;crossSaleProduct&quot;, &quot;requestingField=addOnProduct&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 483 +                .anyMatch(customCriteria::contains);</span>
 484      }
 485  
<abbr title=" 486      protected FilterMapping createFilterMappingForProperty(String targetPropertyName, PredicateProvider predicateProvider) {"> 486      protected FilterMapping createFilterMappingForProperty(String targetPropertyName, PredicateProvider predicatePðŸ”µ</abbr>
 487  
 488          FieldPath fieldPath = new FieldPath().withTargetProperty(targetPropertyName);
 489          EmptyFilterValues directFilterValues = new EmptyFilterValues();
 490          Restriction newRestriction = new Restriction().withPredicateProvider(predicateProvider);
 491  
 492          return new FilterMapping()
 493              .withFieldPath(fieldPath)
 494              .withDirectFilterValues(directFilterValues)
 495              .withRestriction(newRestriction);
 496      }
 497  
<abbr title=" 498      protected DynamicResultSet getFilteredDynamicResultSet(PersistencePackage persistencePackage, CriteriaTransferObject cto, RecordHelper helper) throws ServiceException {"> 498      protected DynamicResultSet getFilteredDynamicResultSet(PersistencePackage persistencePackage, CriteriaTransferðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 499 -        FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicateProvider() {"> 499 -        FilterMapping defaultCategoryMapping = createFilterMappingForProperty(ID_PROPERTY, new PredicateProvider()ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 500 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 501 -            public Predicate buildPredicate(CriteriaBuilder builder, FieldPathBuilder fieldPathBuilder, From root,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 502 -                                            String ceilingEntity, String fullPropertyName, Path explicitPath,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 503 -                                            List directValues) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 504 -                return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbs()[0].getSectionId()));"> 504 -                return builder.and(builder.notEqual(explicitPath, persistencePackage.getSectionCrumbs()[0].getSectðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 505 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 506 -        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 507 -        cto.getAdditionalFilterMappings().add(defaultCategoryMapping);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 508 +        SectionCrumb[] sectionCrumbs = persistencePackage.getSectionCrumbs();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 509 +        if (sectionCrumbs != null &amp;&amp; sectionCrumbs.length &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 510 +            FilterMapping defaultCategoryMapping = this.createFilterMappingForProperty(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 511 +                    ID_PROPERTY,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 512 +                    (builder, fieldPathBuilder, root, ceilingEntity, fullPropertyName, explicitPath, directValues)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 513 +                            -&gt; builder.and(builder.notEqual(explicitPath, sectionCrumbs[0].getSectionId()))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 514 +            );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 515 +            cto.getAdditionalFilterMappings().add(defaultCategoryMapping);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 516 +        }</span>


<abbr title=" 517          OperationType fetchType = persistencePackage.getPersistencePerspective().getOperationTypes().getFetchType();"> 517          OperationType fetchType = persistencePackage.getPersistencePerspective().getOperationTypes().getFetchType(ðŸ”µ</abbr>
 518          PersistenceModule persistenceModule = helper.getCompatibleModule(fetchType);
 519          return persistenceModule.fetch(persistencePackage, cto);
 520      }
 521  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            