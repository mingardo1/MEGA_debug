<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>306</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    306
                    <a href="305.html">prev</a>
                    <a href="307.html">next</a>
                    <a href="306_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_cd7cff12a798c3a68943ad44552e25fb0f98f8d1_admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/admin/server/handler/StructuredContentTypeCustomPersistenceHandler.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/admin/server/handler/StructuredContentTypeCustomPersistenceHandler.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1^1:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/admin/server/handler/StructuredContentTypeCustomPersistenceHandler.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1^2:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/admin/server/handler/StructuredContentTypeCustomPersistenceHandler.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;556ac57d12139326e76b29db4638956d93283fb1:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/admin/server/handler/StructuredContentTypeCustomPersistenceHandler.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce CMS Module
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.cms.admin.server.handler;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.MapUtils;
  22 import org.apache.commons.lang3.StringUtils;
  23 import org.apache.commons.logging.Log;
  24 import org.apache.commons.logging.LogFactory;
  25 import org.broadleafcommerce.cms.field.domain.FieldDefinition;
  26 import org.broadleafcommerce.cms.field.domain.FieldGroup;
  27 import org.broadleafcommerce.cms.structure.domain.StructuredContent;
  28 import org.broadleafcommerce.cms.structure.domain.StructuredContentField;
  29 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldImpl;
  30 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXref;
  31 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXrefImpl;
  32 import org.broadleafcommerce.cms.structure.domain.StructuredContentType;
  33 import org.broadleafcommerce.cms.structure.domain.StructuredContentTypeImpl;
  34 import org.broadleafcommerce.cms.structure.service.StructuredContentService;
  35 import org.broadleafcommerce.common.exception.ServiceException;
  36 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  37 import org.broadleafcommerce.openadmin.dto.ClassTree;
  38 import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  39 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  40 import org.broadleafcommerce.openadmin.dto.Entity;
  41 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  42 import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  43 import org.broadleafcommerce.openadmin.dto.Property;
  44 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  45 import org.broadleafcommerce.openadmin.server.service.ValidationException;
  46 import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  47 import org.broadleafcommerce.openadmin.server.service.handler.DynamicEntityRetriever;
  48 import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  49 import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  50 import org.springframework.stereotype.Component;
  51 
  52 import java.io.Serializable;
  53 import java.util.ArrayList;
  54 import java.util.Collections;
  55 import java.util.HashMap;
  56 import java.util.List;
  57 import java.util.Map;
  58 import java.util.Map.Entry;
  59 
  60 import javax.annotation.Resource;
  61 import javax.persistence.EntityManager;
  62 import javax.persistence.PersistenceContext;
  63 
  64 /**
  65  * Created by jfischer
  66  */
  67 @Component(&quot;blStructuredContentTypeCustomPersistenceHandler&quot;)
<abbr title="  68 public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implements DynamicEntityRetriever {">  68 public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implemðŸ”µ</abbr>
  69 
  70     private final Log LOG = LogFactory.getLog(StructuredContentTypeCustomPersistenceHandler.class);
  71 
  72     @Resource(name=&quot;blStructuredContentService&quot;)
  73     protected StructuredContentService structuredContentService;
  74 
  75     @Resource(name = &quot;blDynamicFieldPersistenceHandlerHelper&quot;)
  76     protected DynamicFieldPersistenceHandlerHelper dynamicFieldUtil;
  77 
  78     @PersistenceContext(unitName=&quot;blPU&quot;)
  79     protected EntityManager em;
  80 
  81     @Override
  82     public Boolean canHandleFetch(PersistencePackage persistencePackage) {
<abbr title="  83         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();">  83         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
  84         return
  85             StructuredContentType.class.getName().equals(ceilingEntityFullyQualifiedClassname) &amp;&amp;
  86             persistencePackage.getCustomCriteria() != null &amp;&amp;
  87             persistencePackage.getCustomCriteria().length &gt; 0 &amp;&amp;
  88             persistencePackage.getCustomCriteria()[0].equals(&quot;constructForm&quot;);
  89     }
  90 
  91     @Override
  92     public Boolean canHandleAdd(PersistencePackage persistencePackage) {
  93         return canHandleFetch(persistencePackage);
  94     }
  95 
  96     @Override
  97     public Boolean canHandleInspect(PersistencePackage persistencePackage) {
  98         return canHandleFetch(persistencePackage);
  99     }
 100 
 101     @Override
 102     public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 103         return false;
 104     }
 105 
 106     @Override
 107     public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 108         return canHandleFetch(persistencePackage);
 109     }
 110 
 111     @Override
<abbr title=" 112     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 112     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityðŸ”µ</abbr>
<abbr title=" 113         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 113         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 114         try {
 115             String structuredContentTypeId = persistencePackage.getCustomCriteria()[3];
<abbr title=" 116             StructuredContentType structuredContentType = structuredContentService.findStructuredContentTypeById(Long.valueOf(structuredContentTypeId));"> 116             StructuredContentType structuredContentType = structuredContentService.findStructuredContentTðŸ”µ</abbr>
 117             ClassMetadata metadata = new ClassMetadata();
 118             metadata.setCeilingType(StructuredContentType.class.getName());
 119             ClassTree entities = new ClassTree(StructuredContentTypeImpl.class.getName());
 120             metadata.setPolymorphicEntities(entities);
<abbr title=" 121             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentTypeImpl.class);"> 121             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStðŸ”µ</abbr>
 122             metadata.setProperties(properties);
 123             DynamicResultSet results = new DynamicResultSet(metadata);
 124 
 125             return results;
 126         } catch (Exception e) {
<abbr title=" 127             throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 127             throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiðŸ”µ</abbr>
 128         }
 129     }
 130 
 131 
 132     @Override
<abbr title=" 133     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 133     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynaðŸ”µ</abbr>
<abbr title=" 134         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 134         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 135         try {
 136             String structuredContentId = persistencePackage.getCustomCriteria()[1];
 137             Entity entity = fetchEntityBasedOnId(structuredContentId, null);
 138             DynamicResultSet results = new DynamicResultSet(new Entity[]{entity}, 1);
 139 
 140             return results;
 141         } catch (Exception e) {
<abbr title=" 142             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 142             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedðŸ”µ</abbr>
 143         }
 144     }
 145 
 146     @Override
<abbr title=" 147     public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws Exception {"> 147     public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws ExcepðŸ”µ</abbr>
<abbr title=" 148         StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 148         StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valðŸ”µ</abbr>
<abbr title=" 149         //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUpdate()"> 149         //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUðŸ”µ</abbr>
 150         em.refresh(structuredContent);
 151         return fetchDynamicEntity(structuredContent, dirtyFields, true);
 152     }
 153 
 154     @Override
 155     public String getFieldContainerClassName() {
 156         return StructuredContent.class.getName();
 157     }
 158 
 159     @Override
<abbr title=" 160     public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throws Exception {"> 160     public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throðŸ”µ</abbr>
 161         StructuredContent structuredContent = (StructuredContent) root;
<abbr title=" 162         Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructuredContentFieldXrefs();"> 162         Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructurðŸ”µ</abbr>
 163         Entity entity = new Entity();
 164         entity.setType(new String[]{StructuredContentType.class.getName()});
 165         List&lt;Property&gt; propertiesList = new ArrayList&lt;Property&gt;();
<abbr title=" 166         for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 166         for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieðŸ”µ</abbr>
 167             for (FieldDefinition def : fieldGroup.getFieldDefinitions()) {
 168                 Property property = new Property();
 169                 property.setName(def.getName());
 170                 String value = null;
 171                 if (!MapUtils.isEmpty(structuredContentFieldMap)) {
<abbr title=" 172                     StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.get(def.getName());"> 172                     StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.getðŸ”µ</abbr>
 173                     if (structuredContentFieldXref != null) {
<abbr title=" 174                         StructuredContentField structuredContentField = structuredContentFieldXref.getStructuredContentField();"> 174                         StructuredContentField structuredContentField = structuredContentFieldXref.getStrðŸ”µ</abbr>
 175                         if (structuredContentField != null) {
 176                             value = structuredContentField.getValue();
 177                         }
 178                     }
 179                 }
 180                 property.setValue(value);
 181                 if (!CollectionUtils.isEmpty(dirtyFields) &amp;&amp; dirtyFields.contains(property.getName())) {
 182                     property.setIsDirty(true);
 183                 }
 184 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 186                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; StringUtils.isNotEmpty(value)) {"> 186                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; StringUtils.iðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187                     // we need to look up the display value</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 188                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), value);"> 188                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), valðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189                     property.setDisplayValue(display);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190                 }</span>
 191 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                 property.setValue(value);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195                 if (!CollectionUtils.isEmpty(dirtyFields) &amp;&amp; dirtyFields.contains(property.getName())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196                     property.setIsDirty(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 199                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; value != null) {"> 199                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; value != nullðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200                     // we need to look up the display value</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 201                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), value);"> 201                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), valðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202                     property.setDisplayValue(display);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204                 propertiesList.add(property);</span>
 205 =======
 206 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 207                 propertiesList.add(property);
 208             }
 209         }
 210         if (includeId) {
 211             Property property = new Property();
 212             propertiesList.add(property);
 213             property.setName(&quot;id&quot;);
 214             property.setValue(String.valueOf(structuredContent.getId()));
 215         }
 216 
 217         entity.setProperties(propertiesList.toArray(new Property[]{}));
 218 
 219         return entity;
 220     }
 221 
 222     /**
<abbr title=" 223      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 223      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the struðŸ”µ</abbr>
 224      */
 225     @Override
<abbr title=" 226     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 226     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordðŸ”µ</abbr>
 227         return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 228     }
 229 
 230     /**
<abbr title=" 231      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 231      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the struðŸ”µ</abbr>
 232      */
 233     @Override
<abbr title=" 234     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 234     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelðŸ”µ</abbr>
 235         return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 236     }
 237 
<abbr title=" 238     protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 238     protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDaoðŸ”µ</abbr>
<abbr title=" 239         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 239         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 240         try {
 241             String structuredContentId = persistencePackage.getCustomCriteria()[1];
<abbr title=" 242             StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 242             StructuredContent structuredContent = structuredContentService.findStructuredContentById(LongðŸ”µ</abbr>
 243 
<abbr title=" 244             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentType.class);"> 244             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructðŸ”µ</abbr>
 245             Map&lt;String, FieldMetadata&gt; md = new HashMap&lt;String, FieldMetadata&gt;();
 246             for (Property property : properties) {
 247                 md.put(property.getName(), property.getMetadata());
 248             }
 249 
<abbr title=" 250             boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeImpl(), md);"> 250             boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeðŸ”µ</abbr>
 251             if (!validated) {
<abbr title=" 252                 throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamic fields failed validation&quot;);"> 252                 throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamicðŸ”µ</abbr>
 253             }
 254 
 255             List&lt;String&gt; templateFieldNames = new ArrayList&lt;String&gt;(20);
<abbr title=" 256             for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 256             for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFielðŸ”µ</abbr>
 257                 for (FieldDefinition def : group.getFieldDefinitions()) {
 258                     templateFieldNames.add(def.getName());
 259                 }
 260             }
 261             Map&lt;String, String&gt; dirtyFieldsOrigVals = new HashMap&lt;String, String&gt;();
 262             List&lt;String&gt; dirtyFields = new ArrayList&lt;String&gt;();
 263             Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap =
 264                     structuredContent.getStructuredContentFieldXrefs();
 265             for (Property property : persistencePackage.getEntity().getProperties()) {
 266                 if (property.getEnabled() &amp;&amp; templateFieldNames.contains(property.getName())) {
<abbr title=" 267                     StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName());"> 267                     StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName())ðŸ”µ</abbr>
 268                     if (scXref != null &amp;&amp; scXref.getStructuredContentField() != null) {
<abbr title=" 269                         StructuredContentField structuredContentField = scXref.getStructuredContentField();"> 269                         StructuredContentField structuredContentField = scXref.getStructuredContentField(ðŸ”µ</abbr>
<abbr title=" 270                         boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValue() != null) ||"> 270                         boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValueðŸ”µ</abbr>
<abbr title=" 271                                 (structuredContentField.getValue() != null &amp;&amp; property.getValue() == null);"> 271                                 (structuredContentField.getValue() != null &amp;&amp; property.getValue() == nullðŸ”µ</abbr>
<abbr title=" 272                         if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() != null &amp;&amp;"> 272                         if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() ðŸ”µ</abbr>
<abbr title=" 273                                 !structuredContentField.getValue().trim().equals(property.getValue().trim()))) {"> 273                                 !structuredContentField.getValue().trim().equals(property.getValue().trimðŸ”µ</abbr>
 274                             dirtyFields.add(property.getName());
<abbr title=" 275                             dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue());"> 275                             dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue()ðŸ”µ</abbr>
 276                             structuredContentField.setValue(property.getValue());
 277                             scXref = dynamicEntityDao.merge(scXref);
 278                         }
 279                     } else {
 280                         StructuredContentField structuredContentField = new StructuredContentFieldImpl();
 281                         structuredContentField.setFieldKey(property.getName());
 282                         structuredContentField.setValue(property.getValue());
 283 
 284                         StructuredContentFieldXref scfx = new StructuredContentFieldXrefImpl();
 285                         scfx.setStructuredContent(structuredContent);
 286                         scfx.setKey(property.getName());
 287                         scfx.setStrucuturedContentField(structuredContentField);
 288 
 289                         scfx = dynamicEntityDao.persist(scfx);
 290                         dirtyFields.add(property.getName());
 291                     }
 292                 }
 293             }
 294             List&lt;String&gt; removeItems = new ArrayList&lt;String&gt;();
 295             for (String key : structuredContentFieldMap.keySet()) {
 296                 if (persistencePackage.getEntity().findProperty(key)==null) {
 297                     removeItems.add(key);
 298                 }
 299             }
 300             if (removeItems.size() &gt; 0) {
 301                 for (String removeKey : removeItems) {
 302                     structuredContentFieldMap.remove(removeKey);
 303                 }
 304             }
 305 
 306             Collections.sort(dirtyFields);
 307             Entity entity = fetchEntityBasedOnId(structuredContentId, dirtyFields);
 308 
 309             for (Entry&lt;String, String&gt; entry : dirtyFieldsOrigVals.entrySet()) {
 310                 entity.getPMap().get(entry.getKey()).setOriginalValue(entry.getValue());
 311                 entity.getPMap().get(entry.getKey()).setOriginalDisplayValue(entry.getValue());
 312             }
 313 
 314             return entity;
 315         } catch (ValidationException e) {
 316             throw e;
 317         } catch (Exception e) {
<abbr title=" 318             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 318             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedðŸ”µ</abbr>
 319         }
 320     }
 321 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce CMS Module
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.cms.admin.server.handler;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.MapUtils;
  22 import org.apache.commons.lang3.StringUtils;
  23 import org.apache.commons.logging.Log;
  24 import org.apache.commons.logging.LogFactory;
  25 import org.broadleafcommerce.cms.field.domain.FieldDefinition;
  26 import org.broadleafcommerce.cms.field.domain.FieldGroup;
  27 import org.broadleafcommerce.cms.structure.domain.StructuredContent;
  28 import org.broadleafcommerce.cms.structure.domain.StructuredContentField;
  29 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldImpl;
  30 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXref;
  31 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXrefImpl;
  32 import org.broadleafcommerce.cms.structure.domain.StructuredContentType;
  33 import org.broadleafcommerce.cms.structure.domain.StructuredContentTypeImpl;
  34 import org.broadleafcommerce.cms.structure.service.StructuredContentService;
  35 import org.broadleafcommerce.common.exception.ServiceException;
  36 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  37 import org.broadleafcommerce.openadmin.dto.ClassTree;
  38 import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  39 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  40 import org.broadleafcommerce.openadmin.dto.Entity;
  41 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  42 import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  43 import org.broadleafcommerce.openadmin.dto.Property;
  44 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  45 import org.broadleafcommerce.openadmin.server.service.ValidationException;
  46 import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  47 import org.broadleafcommerce.openadmin.server.service.handler.DynamicEntityRetriever;
  48 import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  49 import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  50 import org.springframework.stereotype.Component;
  51 
  52 import java.io.Serializable;
  53 import java.util.ArrayList;
  54 import java.util.Collections;
  55 import java.util.HashMap;
  56 import java.util.List;
  57 import java.util.Map;
  58 import java.util.Map.Entry;
  59 
  60 import javax.annotation.Resource;
  61 import javax.persistence.EntityManager;
  62 import javax.persistence.PersistenceContext;
  63 
  64 /**
  65  * Created by jfischer
  66  */
  67 @Component(&quot;blStructuredContentTypeCustomPersistenceHandler&quot;)
<abbr title="  68 public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implements DynamicEntityRetriever {">  68 public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implemðŸ”µ</abbr>
  69 
  70     private final Log LOG = LogFactory.getLog(StructuredContentTypeCustomPersistenceHandler.class);
  71 
  72     @Resource(name=&quot;blStructuredContentService&quot;)
  73     protected StructuredContentService structuredContentService;
  74 
  75     @Resource(name = &quot;blDynamicFieldPersistenceHandlerHelper&quot;)
  76     protected DynamicFieldPersistenceHandlerHelper dynamicFieldUtil;
  77 
  78     @PersistenceContext(unitName=&quot;blPU&quot;)
  79     protected EntityManager em;
  80 
  81     @Override
  82     public Boolean canHandleFetch(PersistencePackage persistencePackage) {
<abbr title="  83         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();">  83         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
  84         return
  85             StructuredContentType.class.getName().equals(ceilingEntityFullyQualifiedClassname) &amp;&amp;
  86             persistencePackage.getCustomCriteria() != null &amp;&amp;
  87             persistencePackage.getCustomCriteria().length &gt; 0 &amp;&amp;
  88             persistencePackage.getCustomCriteria()[0].equals(&quot;constructForm&quot;);
  89     }
  90 
  91     @Override
  92     public Boolean canHandleAdd(PersistencePackage persistencePackage) {
  93         return canHandleFetch(persistencePackage);
  94     }
  95 
  96     @Override
  97     public Boolean canHandleInspect(PersistencePackage persistencePackage) {
  98         return canHandleFetch(persistencePackage);
  99     }
 100 
 101     @Override
 102     public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 103         return false;
 104     }
 105 
 106     @Override
 107     public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 108         return canHandleFetch(persistencePackage);
 109     }
 110 
 111     @Override
<abbr title=" 112     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 112     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityðŸ”µ</abbr>
<abbr title=" 113         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 113         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 114         try {
 115             String structuredContentTypeId = persistencePackage.getCustomCriteria()[3];
<abbr title=" 116             StructuredContentType structuredContentType = structuredContentService.findStructuredContentTypeById(Long.valueOf(structuredContentTypeId));"> 116             StructuredContentType structuredContentType = structuredContentService.findStructuredContentTðŸ”µ</abbr>
 117             ClassMetadata metadata = new ClassMetadata();
 118             metadata.setCeilingType(StructuredContentType.class.getName());
 119             ClassTree entities = new ClassTree(StructuredContentTypeImpl.class.getName());
 120             metadata.setPolymorphicEntities(entities);
<abbr title=" 121             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentTypeImpl.class);"> 121             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStðŸ”µ</abbr>
 122             metadata.setProperties(properties);
 123             DynamicResultSet results = new DynamicResultSet(metadata);
 124 
 125             return results;
 126         } catch (Exception e) {
<abbr title=" 127             throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 127             throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiðŸ”µ</abbr>
 128         }
 129     }
 130 
 131 
 132     @Override
<abbr title=" 133     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 133     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynaðŸ”µ</abbr>
<abbr title=" 134         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 134         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 135         try {
 136             String structuredContentId = persistencePackage.getCustomCriteria()[1];
 137             Entity entity = fetchEntityBasedOnId(structuredContentId, null);
 138             DynamicResultSet results = new DynamicResultSet(new Entity[]{entity}, 1);
 139 
 140             return results;
 141         } catch (Exception e) {
<abbr title=" 142             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 142             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedðŸ”µ</abbr>
 143         }
 144     }
 145 
 146     @Override
<abbr title=" 147     public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws Exception {"> 147     public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws ExcepðŸ”µ</abbr>
<abbr title=" 148         StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 148         StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valðŸ”µ</abbr>
<abbr title=" 149         //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUpdate()"> 149         //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUðŸ”µ</abbr>
 150         em.refresh(structuredContent);
 151         return fetchDynamicEntity(structuredContent, dirtyFields, true);
 152     }
 153 
 154     @Override
 155     public String getFieldContainerClassName() {
 156         return StructuredContent.class.getName();
 157     }
 158 
 159     @Override
<abbr title=" 160     public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throws Exception {"> 160     public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throðŸ”µ</abbr>
 161         StructuredContent structuredContent = (StructuredContent) root;
<abbr title=" 162         Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructuredContentFieldXrefs();"> 162         Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructurðŸ”µ</abbr>
 163         Entity entity = new Entity();
 164         entity.setType(new String[]{StructuredContentType.class.getName()});
 165         List&lt;Property&gt; propertiesList = new ArrayList&lt;Property&gt;();
<abbr title=" 166         for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 166         for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieðŸ”µ</abbr>
 167             for (FieldDefinition def : fieldGroup.getFieldDefinitions()) {
 168                 Property property = new Property();
 169                 property.setName(def.getName());
 170                 String value = null;
 171                 if (!MapUtils.isEmpty(structuredContentFieldMap)) {
<abbr title=" 172                     StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.get(def.getName());"> 172                     StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.getðŸ”µ</abbr>
 173                     if (structuredContentFieldXref != null) {
<abbr title=" 174                         StructuredContentField structuredContentField = structuredContentFieldXref.getStructuredContentField();"> 174                         StructuredContentField structuredContentField = structuredContentFieldXref.getStrðŸ”µ</abbr>
 175                         if (structuredContentField != null) {
 176                             value = structuredContentField.getValue();
 177                         }
 178                     }
 179                 }
 180                 property.setValue(value);
 181                 if (!CollectionUtils.isEmpty(dirtyFields) &amp;&amp; dirtyFields.contains(property.getName())) {
 182                     property.setIsDirty(true);
 183                 }
 184 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 186                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; StringUtils.isNotEmpty(value)) {"> 186                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; StringUtils.iðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187                     // we need to look up the display value</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 188                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), value);"> 188                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), valðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189                     property.setDisplayValue(display);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190                 }</span>
 191 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 193                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; value != null) {"> 193                 if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; value != nullðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                     // we need to look up the display value</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 195                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), value);"> 195                     String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), valðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196                     property.setDisplayValue(display);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197                 }</span>
 198 =======
 199 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 200                 propertiesList.add(property);
 201             }
 202         }
 203         if (includeId) {
 204             Property property = new Property();
 205             propertiesList.add(property);
 206             property.setName(&quot;id&quot;);
 207             property.setValue(String.valueOf(structuredContent.getId()));
 208         }
 209 
 210         entity.setProperties(propertiesList.toArray(new Property[]{}));
 211 
 212         return entity;
 213     }
 214 
 215     /**
<abbr title=" 216      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 216      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the struðŸ”µ</abbr>
 217      */
 218     @Override
<abbr title=" 219     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 219     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordðŸ”µ</abbr>
 220         return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 221     }
 222 
 223     /**
<abbr title=" 224      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 224      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the struðŸ”µ</abbr>
 225      */
 226     @Override
<abbr title=" 227     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 227     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelðŸ”µ</abbr>
 228         return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 229     }
 230 
<abbr title=" 231     protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 231     protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDaoðŸ”µ</abbr>
<abbr title=" 232         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 232         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 233         try {
 234             String structuredContentId = persistencePackage.getCustomCriteria()[1];
<abbr title=" 235             StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 235             StructuredContent structuredContent = structuredContentService.findStructuredContentById(LongðŸ”µ</abbr>
 236 
<abbr title=" 237             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentType.class);"> 237             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructðŸ”µ</abbr>
 238             Map&lt;String, FieldMetadata&gt; md = new HashMap&lt;String, FieldMetadata&gt;();
 239             for (Property property : properties) {
 240                 md.put(property.getName(), property.getMetadata());
 241             }
 242 
<abbr title=" 243             boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeImpl(), md);"> 243             boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeðŸ”µ</abbr>
 244             if (!validated) {
<abbr title=" 245                 throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamic fields failed validation&quot;);"> 245                 throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamicðŸ”µ</abbr>
 246             }
 247 
 248             List&lt;String&gt; templateFieldNames = new ArrayList&lt;String&gt;(20);
<abbr title=" 249             for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 249             for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFielðŸ”µ</abbr>
 250                 for (FieldDefinition def : group.getFieldDefinitions()) {
 251                     templateFieldNames.add(def.getName());
 252                 }
 253             }
 254             Map&lt;String, String&gt; dirtyFieldsOrigVals = new HashMap&lt;String, String&gt;();
 255             List&lt;String&gt; dirtyFields = new ArrayList&lt;String&gt;();
 256             Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap =
 257                     structuredContent.getStructuredContentFieldXrefs();
 258             for (Property property : persistencePackage.getEntity().getProperties()) {
 259                 if (property.getEnabled() &amp;&amp; templateFieldNames.contains(property.getName())) {
<abbr title=" 260                     StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName());"> 260                     StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName())ðŸ”µ</abbr>
 261                     if (scXref != null &amp;&amp; scXref.getStructuredContentField() != null) {
<abbr title=" 262                         StructuredContentField structuredContentField = scXref.getStructuredContentField();"> 262                         StructuredContentField structuredContentField = scXref.getStructuredContentField(ðŸ”µ</abbr>
<abbr title=" 263                         boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValue() != null) ||"> 263                         boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValueðŸ”µ</abbr>
<abbr title=" 264                                 (structuredContentField.getValue() != null &amp;&amp; property.getValue() == null);"> 264                                 (structuredContentField.getValue() != null &amp;&amp; property.getValue() == nullðŸ”µ</abbr>
<abbr title=" 265                         if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() != null &amp;&amp;"> 265                         if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() ðŸ”µ</abbr>
<abbr title=" 266                                 !structuredContentField.getValue().trim().equals(property.getValue().trim()))) {"> 266                                 !structuredContentField.getValue().trim().equals(property.getValue().trimðŸ”µ</abbr>
 267                             dirtyFields.add(property.getName());
<abbr title=" 268                             dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue());"> 268                             dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue()ðŸ”µ</abbr>
 269                             structuredContentField.setValue(property.getValue());
 270                             scXref = dynamicEntityDao.merge(scXref);
 271                         }
 272                     } else {
 273                         StructuredContentField structuredContentField = new StructuredContentFieldImpl();
 274                         structuredContentField.setFieldKey(property.getName());
 275                         structuredContentField.setValue(property.getValue());
 276 
 277                         StructuredContentFieldXref scfx = new StructuredContentFieldXrefImpl();
 278                         scfx.setStructuredContent(structuredContent);
 279                         scfx.setKey(property.getName());
 280                         scfx.setStrucuturedContentField(structuredContentField);
 281 
 282                         scfx = dynamicEntityDao.persist(scfx);
 283                         dirtyFields.add(property.getName());
 284                     }
 285                 }
 286             }
 287             List&lt;String&gt; removeItems = new ArrayList&lt;String&gt;();
 288             for (String key : structuredContentFieldMap.keySet()) {
 289                 if (persistencePackage.getEntity().findProperty(key)==null) {
 290                     removeItems.add(key);
 291                 }
 292             }
 293             if (removeItems.size() &gt; 0) {
 294                 for (String removeKey : removeItems) {
 295                     structuredContentFieldMap.remove(removeKey);
 296                 }
 297             }
 298 
 299             Collections.sort(dirtyFields);
 300             Entity entity = fetchEntityBasedOnId(structuredContentId, dirtyFields);
 301 
 302             for (Entry&lt;String, String&gt; entry : dirtyFieldsOrigVals.entrySet()) {
 303                 entity.getPMap().get(entry.getKey()).setOriginalValue(entry.getValue());
 304                 entity.getPMap().get(entry.getKey()).setOriginalDisplayValue(entry.getValue());
 305             }
 306 
 307             return entity;
 308         } catch (ValidationException e) {
 309             throw e;
 310         } catch (Exception e) {
<abbr title=" 311             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 311             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedðŸ”µ</abbr>
 312         }
 313     }
 314 }
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce CMS Module
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.cms.admin.server.handler;
  19 
  20 import java.io.Serializable;
  21 import java.util.ArrayList;
  22 import java.util.Collections;
  23 import java.util.HashMap;
  24 import java.util.List;
  25 import java.util.Map.Entry;
  26 import java.util.Map;
  27 import javax.annotation.Resource;
  28 import javax.persistence.EntityManager;
  29 import javax.persistence.PersistenceContext;
  30 import org.apache.commons.collections.CollectionUtils;
  31 import org.apache.commons.collections.MapUtils;
  32 import org.apache.commons.lang3.StringUtils;
  33 import org.apache.commons.logging.Log;
  34 import org.apache.commons.logging.LogFactory;
  35 import org.broadleafcommerce.cms.field.domain.FieldDefinition;
  36 import org.broadleafcommerce.cms.field.domain.FieldGroup;
  37 import org.broadleafcommerce.cms.structure.domain.StructuredContent;
  38 import org.broadleafcommerce.cms.structure.domain.StructuredContentField;
  39 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldImpl;
  40 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXref;
  41 import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXrefImpl;
  42 import org.broadleafcommerce.cms.structure.domain.StructuredContentType;
  43 import org.broadleafcommerce.cms.structure.domain.StructuredContentTypeImpl;
  44 import org.broadleafcommerce.cms.structure.service.StructuredContentService;
  45 import org.broadleafcommerce.common.exception.ServiceException;
  46 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  47 import org.broadleafcommerce.openadmin.dto.ClassTree;
  48 import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  49 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  50 import org.broadleafcommerce.openadmin.dto.Entity;
  51 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  52 import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  53 import org.broadleafcommerce.openadmin.dto.Property;
  54 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  55 import org.broadleafcommerce.openadmin.server.service.ValidationException;
  56 import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  57 import org.broadleafcommerce.openadmin.server.service.handler.DynamicEntityRetriever;
  58 import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  59 import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  60 import org.springframework.stereotype.Component;
  61 
  62 
  63 /**
  64  * Created by jfischer
  65  */
  66 @Component(&quot;blStructuredContentTypeCustomPersistenceHandler&quot;)
<abbr title="  67 public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implements DynamicEntityRetriever {">  67 public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implemðŸ”µ</abbr>
  68     private final Log LOG = LogFactory.getLog(StructuredContentTypeCustomPersistenceHandler.class);
  69 
  70     @Resource(name=&quot;blStructuredContentService&quot;)
  71     protected StructuredContentService structuredContentService;
  72 
  73     @Resource(name = &quot;blDynamicFieldPersistenceHandlerHelper&quot;)
  74     protected DynamicFieldPersistenceHandlerHelper dynamicFieldUtil;
  75 
  76     @PersistenceContext(unitName=&quot;blPU&quot;)
  77     protected EntityManager em;
  78 
  79     @Override
  80     public Boolean canHandleFetch(PersistencePackage persistencePackage) {
<abbr title="  81         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();">  81         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
  82         return
  83             StructuredContentType.class.getName().equals(ceilingEntityFullyQualifiedClassname) &amp;&amp;
  84             persistencePackage.getCustomCriteria() != null &amp;&amp;
  85             persistencePackage.getCustomCriteria().length &gt; 0 &amp;&amp;
  86             persistencePackage.getCustomCriteria()[0].equals(&quot;constructForm&quot;);
  87     }
  88 
  89     @Override
  90     public Boolean canHandleAdd(PersistencePackage persistencePackage) {
  91         return canHandleFetch(persistencePackage);
  92     }
  93 
  94     @Override
  95     public Boolean canHandleInspect(PersistencePackage persistencePackage) {
  96         return canHandleFetch(persistencePackage);
  97     }
  98 
  99     @Override
 100     public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 101         return false;
 102     }
 103 
 104     @Override
 105     public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 106         return canHandleFetch(persistencePackage);
 107     }
 108 
 109     @Override
<abbr title=" 110     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 110     public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityðŸ”µ</abbr>
<abbr title=" 111         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 111         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 112         try {
 113             String structuredContentTypeId = persistencePackage.getCustomCriteria()[3];
<abbr title=" 114             StructuredContentType structuredContentType = structuredContentService.findStructuredContentTypeById(Long.valueOf(structuredContentTypeId));"> 114             StructuredContentType structuredContentType = structuredContentService.findStructuredContentTðŸ”µ</abbr>
 115             ClassMetadata metadata = new ClassMetadata();
 116             metadata.setCeilingType(StructuredContentType.class.getName());
 117             ClassTree entities = new ClassTree(StructuredContentTypeImpl.class.getName());
 118             metadata.setPolymorphicEntities(entities);
<abbr title=" 119             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentTypeImpl.class);"> 119             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStðŸ”µ</abbr>
 120             metadata.setProperties(properties);
 121             DynamicResultSet results = new DynamicResultSet(metadata);
 122 
 123             return results;
 124         } catch (Exception e) {
<abbr title=" 125             throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 125             throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiðŸ”µ</abbr>
 126         }
 127     }
 128 
 129     @Override
<abbr title=" 130     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 130     public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynaðŸ”µ</abbr>
<abbr title=" 131         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 131         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 132         try {
 133             String structuredContentId = persistencePackage.getCustomCriteria()[1];
 134             Entity entity = fetchEntityBasedOnId(structuredContentId, null);
 135             DynamicResultSet results = new DynamicResultSet(new Entity[]{entity}, 1);
 136 
 137             return results;
 138         } catch (Exception e) {
<abbr title=" 139             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 139             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedðŸ”µ</abbr>
 140         }
 141     }
 142 
 143     @Override
<abbr title=" 144     public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws Exception {"> 144     public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws ExcepðŸ”µ</abbr>
<abbr title=" 145         StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 145         StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valðŸ”µ</abbr>
<abbr title=" 146         //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUpdate()"> 146         //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUðŸ”µ</abbr>
 147         em.refresh(structuredContent);
 148         return fetchDynamicEntity(structuredContent, dirtyFields, true);
 149     }
 150 
 151     @Override
 152     public String getFieldContainerClassName() {
 153         return StructuredContent.class.getName();
 154     }
 155 
 156     @Override
<abbr title=" 157     public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throws Exception {"> 157     public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throðŸ”µ</abbr>
 158         StructuredContent structuredContent = ((StructuredContent) (root));
<abbr title=" 159         Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructuredContentFieldXrefs();"> 159         Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructurðŸ”µ</abbr>
 160         Entity entity = new Entity();
 161         entity.setType(new String[]{ StructuredContentType.class.getName() });
 162         List&lt;Property&gt; propertiesList = new ArrayList&lt;Property&gt;();
<abbr title=" 163         for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 163         for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieðŸ”µ</abbr>
 164             for (FieldDefinition def : fieldGroup.getFieldDefinitions()) {
 165                 Property property = new Property();
 166                 property.setName(def.getName());
 167                 String value = null;
 168                 if (!MapUtils.isEmpty(structuredContentFieldMap)) {
<abbr title=" 169                     StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.get(def.getName());"> 169                     StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.getðŸ”µ</abbr>
 170                     if (structuredContentFieldXref != null) {
<abbr title=" 171                         StructuredContentField structuredContentField = structuredContentFieldXref.getStructuredContentField();"> 171                         StructuredContentField structuredContentField = structuredContentFieldXref.getStrðŸ”µ</abbr>
 172                         if (structuredContentField != null) {
 173                             value = structuredContentField.getValue();
 174                         }
 175                     }
 176                 }
 177                 property.setValue(value);
<abbr title=" 178                 if ((!CollectionUtils.isEmpty(dirtyFields)) &amp;&amp; dirtyFields.contains(property.getName())) {"> 178                 if ((!CollectionUtils.isEmpty(dirtyFields)) &amp;&amp; dirtyFields.contains(property.getName())) ðŸ”µ</abbr>
 179                     property.setIsDirty(true);
 180                 }
 181                 propertiesList.add(property);
 182             }
 183         }
 184         if (includeId) {
 185             Property property = new Property();
 186             propertiesList.add(property);
 187             property.setName(&quot;id&quot;);
 188             property.setValue(String.valueOf(structuredContent.getId()));
 189         }
 190         entity.setProperties(propertiesList.toArray(new Property[]{  }));
 191         return entity;
 192     }
 193 
 194     /**
<abbr title=" 195      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 195      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the struðŸ”µ</abbr>
 196      */
 197     @Override
<abbr title=" 198     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 198     public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordðŸ”µ</abbr>
 199         return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 200     }
 201 
 202     /**
<abbr title=" 203      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 203      * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the struðŸ”µ</abbr>
 204      */
 205     @Override
<abbr title=" 206     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 206     public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelðŸ”µ</abbr>
 207         return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 208     }
 209 
<abbr title=" 210     protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 210     protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDaoðŸ”µ</abbr>
<abbr title=" 211         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 211         String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClðŸ”µ</abbr>
 212         try {
 213             String structuredContentId = persistencePackage.getCustomCriteria()[1];
<abbr title=" 214             StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 214             StructuredContent structuredContent = structuredContentService.findStructuredContentById(LongðŸ”µ</abbr>
 215 
<abbr title=" 216             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentType.class);"> 216             Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructðŸ”µ</abbr>
 217             Map&lt;String, FieldMetadata&gt; md = new HashMap&lt;String, FieldMetadata&gt;();
 218             for (Property property : properties) {
 219                 md.put(property.getName(), property.getMetadata());
 220             }
 221 
<abbr title=" 222             boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeImpl(), md);"> 222             boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeðŸ”µ</abbr>
 223             if (!validated) {
<abbr title=" 224                 throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamic fields failed validation&quot;);"> 224                 throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamicðŸ”µ</abbr>
 225             }
 226 
 227             List&lt;String&gt; templateFieldNames = new ArrayList&lt;String&gt;(20);
<abbr title=" 228             for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 228             for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFielðŸ”µ</abbr>
 229                 for (FieldDefinition def : group.getFieldDefinitions()) {
 230                     templateFieldNames.add(def.getName());
 231                 }
 232             }
 233             Map&lt;String, String&gt; dirtyFieldsOrigVals = new HashMap&lt;String, String&gt;();
 234             List&lt;String&gt; dirtyFields = new ArrayList&lt;String&gt;();
 235             Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap =
 236                     structuredContent.getStructuredContentFieldXrefs();
 237             for (Property property : persistencePackage.getEntity().getProperties()) {
 238                 if (property.getEnabled() &amp;&amp; templateFieldNames.contains(property.getName())) {
<abbr title=" 239                     StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName());"> 239                     StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName())ðŸ”µ</abbr>
 240                     if (scXref != null &amp;&amp; scXref.getStructuredContentField() != null) {
<abbr title=" 241                         StructuredContentField structuredContentField = scXref.getStructuredContentField();"> 241                         StructuredContentField structuredContentField = scXref.getStructuredContentField(ðŸ”µ</abbr>
<abbr title=" 242                         boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValue() != null) ||"> 242                         boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValueðŸ”µ</abbr>
<abbr title=" 243                                 (structuredContentField.getValue() != null &amp;&amp; property.getValue() == null);"> 243                                 (structuredContentField.getValue() != null &amp;&amp; property.getValue() == nullðŸ”µ</abbr>
<abbr title=" 244                         if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() != null &amp;&amp;"> 244                         if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() ðŸ”µ</abbr>
<abbr title=" 245                                 !structuredContentField.getValue().trim().equals(property.getValue().trim()))) {"> 245                                 !structuredContentField.getValue().trim().equals(property.getValue().trimðŸ”µ</abbr>
 246                             dirtyFields.add(property.getName());
<abbr title=" 247                             dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue());"> 247                             dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue()ðŸ”µ</abbr>
 248                             structuredContentField.setValue(property.getValue());
 249                             scXref = dynamicEntityDao.merge(scXref);
 250                         }
 251                     } else {
 252                         StructuredContentField structuredContentField = new StructuredContentFieldImpl();
 253                         structuredContentField.setFieldKey(property.getName());
 254                         structuredContentField.setValue(property.getValue());
 255 
 256                         StructuredContentFieldXref scfx = new StructuredContentFieldXrefImpl();
 257                         scfx.setStructuredContent(structuredContent);
 258                         scfx.setKey(property.getName());
 259                         scfx.setStrucuturedContentField(structuredContentField);
 260 
 261                         scfx = dynamicEntityDao.persist(scfx);
 262                         dirtyFields.add(property.getName());
 263                     }
 264                 }
 265             }
 266             List&lt;String&gt; removeItems = new ArrayList&lt;String&gt;();
 267             for (String key : structuredContentFieldMap.keySet()) {
 268                 if (persistencePackage.getEntity().findProperty(key)==null) {
 269                     removeItems.add(key);
 270                 }
 271             }
 272             if (removeItems.size() &gt; 0) {
 273                 for (String removeKey : removeItems) {
 274                     structuredContentFieldMap.remove(removeKey);
 275                 }
 276             }
 277 
 278             Collections.sort(dirtyFields);
 279             Entity entity = fetchEntityBasedOnId(structuredContentId, dirtyFields);
 280 
 281             for (Entry&lt;String, String&gt; entry : dirtyFieldsOrigVals.entrySet()) {
 282                 entity.getPMap().get(entry.getKey()).setOriginalValue(entry.getValue());
 283                 entity.getPMap().get(entry.getKey()).setOriginalDisplayValue(entry.getValue());
 284             }
 285 
 286             return entity;
 287         } catch (ValidationException e) {
 288             throw e;
 289         } catch (Exception e) {
<abbr title=" 290             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 290             throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedðŸ”µ</abbr>
 291         }
 292     }
 293 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce CMS Module
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.cms.admin.server.handler;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.MapUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.apache.commons.lang3.StringUtils;</span>
  23  import org.apache.commons.logging.Log;
  24  import org.apache.commons.logging.LogFactory;
  25  import org.broadleafcommerce.cms.field.domain.FieldDefinition;
  26  import org.broadleafcommerce.cms.field.domain.FieldDefinitionImpl;
  27  import org.broadleafcommerce.cms.field.domain.FieldGroup;
  28  import org.broadleafcommerce.cms.structure.domain.StructuredContent;
  29  import org.broadleafcommerce.cms.structure.domain.StructuredContentField;
  30  import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldImpl;
  31  import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXref;
  32  import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXrefImpl;
  33  import org.broadleafcommerce.cms.structure.domain.StructuredContentType;
  34  import org.broadleafcommerce.cms.structure.domain.StructuredContentTypeImpl;
  35  import org.broadleafcommerce.cms.structure.service.StructuredContentService;
  36  import org.broadleafcommerce.common.exception.ServiceException;
  37  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  38  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  39  import org.broadleafcommerce.openadmin.dto.ClassTree;
  40  import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  41  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  42  import org.broadleafcommerce.openadmin.dto.Entity;
  43  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  44  import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  45  import org.broadleafcommerce.openadmin.dto.Property;
  46  import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  47  import org.broadleafcommerce.openadmin.server.service.AdminEntityService;
  48  import org.broadleafcommerce.openadmin.server.service.ValidationException;
  49  import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  50  import org.broadleafcommerce.openadmin.server.service.handler.DynamicEntityRetriever;
  51  import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  52  import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  53  import org.springframework.stereotype.Component;
  54  
  55  import java.io.Serializable;
  56  import java.util.ArrayList;
  57  import java.util.Collections;
  58  import java.util.HashMap;
  59  import java.util.List;
  60  import java.util.Map;
  61  import java.util.Map.Entry;
  62  
  63  import javax.annotation.Resource;
  64  import javax.persistence.EntityManager;
  65  import javax.persistence.PersistenceContext;
  66  
  67  /**
  68   * Created by jfischer
  69   */
  70  @Component(&quot;blStructuredContentTypeCustomPersistenceHandler&quot;)
<abbr title="  71  public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implements DynamicEntityRetriever {">  71  public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implements DynaðŸ”µ</abbr>
  72  
  73      private final Log LOG = LogFactory.getLog(StructuredContentTypeCustomPersistenceHandler.class);
  74  
  75      @Resource(name=&quot;blStructuredContentService&quot;)
  76      protected StructuredContentService structuredContentService;
  77  
  78      @Resource(name = &quot;blDynamicFieldPersistenceHandlerHelper&quot;)
  79      protected DynamicFieldPersistenceHandlerHelper dynamicFieldUtil;
  80  
  81      @PersistenceContext(unitName=&quot;blPU&quot;)
  82      protected EntityManager em;
  83  
  84      @Resource(name = &quot;blAdminEntityService&quot;)
  85      protected AdminEntityService service;
  86  
  87      @Override
  88      public Boolean canHandleFetch(PersistencePackage persistencePackage) {
<abbr title="  89          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();">  89          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
  90          return
  91              StructuredContentType.class.getName().equals(ceilingEntityFullyQualifiedClassname) &amp;&amp;
  92              persistencePackage.getCustomCriteria() != null &amp;&amp;
  93              persistencePackage.getCustomCriteria().length &gt; 0 &amp;&amp;
  94              persistencePackage.getCustomCriteria()[0].equals(&quot;constructForm&quot;);
  95      }
  96  
  97      @Override
  98      public Boolean canHandleAdd(PersistencePackage persistencePackage) {
  99          return canHandleFetch(persistencePackage);
 100      }
 101  
 102      @Override
 103      public Boolean canHandleInspect(PersistencePackage persistencePackage) {
 104          return canHandleFetch(persistencePackage);
 105      }
 106  
 107      @Override
 108      public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 109          return false;
 110      }
 111  
 112      @Override
 113      public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 114          return canHandleFetch(persistencePackage);
 115      }
 116  
 117      @Override
<abbr title=" 118      public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 118      public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspðŸ”µ</abbr>
<abbr title=" 119          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 119          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
 120          try {
 121              String structuredContentTypeId = persistencePackage.getCustomCriteria()[3];
<abbr title=" 122              StructuredContentType structuredContentType = structuredContentService.findStructuredContentTypeById(Long.valueOf(structuredContentTypeId));"> 122              StructuredContentType structuredContentType = structuredContentService.findStructuredContentTypeById(LðŸ”µ</abbr>
 123              ClassMetadata metadata = new ClassMetadata();
 124              metadata.setCeilingType(StructuredContentType.class.getName());
 125              ClassTree entities = new ClassTree(StructuredContentTypeImpl.class.getName());
 126              metadata.setPolymorphicEntities(entities);
<abbr title=" 127              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentTypeImpl.class);"> 127              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStructuredCðŸ”µ</abbr>
 128              metadata.setProperties(properties);
 129              DynamicResultSet results = new DynamicResultSet(metadata);
 130  
 131              return results;
 132          } catch (Exception e) {
<abbr title=" 133              throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 133              throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiedClassnaðŸ”µ</abbr>
 134          }
 135      }
 136  
 137  
 138      @Override
<abbr title=" 139      public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 139      public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityðŸ”µ</abbr>
<abbr title=" 140          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 140          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
 141          try {
 142              String structuredContentId = persistencePackage.getCustomCriteria()[1];
 143              Entity entity = fetchEntityBasedOnId(structuredContentId, null);
 144              DynamicResultSet results = new DynamicResultSet(new Entity[]{entity}, 1);
 145  
 146              return results;
 147          } catch (Exception e) {
<abbr title=" 148              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 148              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassnameðŸ”µ</abbr>
 149          }
 150      }
 151  
 152      @Override
 153      public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws Exception {
<abbr title=" 154          StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 154          StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(struðŸ”µ</abbr>
 155          //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUpdate()
 156          em.refresh(structuredContent);
 157          return fetchDynamicEntity(structuredContent, dirtyFields, true);
 158      }
 159  
 160      @Override
 161      public String getFieldContainerClassName() {
 162          return StructuredContent.class.getName();
 163      }
 164  
 165      @Override
<abbr title=" 166      public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throws Exception {"> 166      public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throws ExceptðŸ”µ</abbr>
 167          StructuredContent structuredContent = (StructuredContent) root;
<abbr title=" 168          Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructuredContentFieldXrefs();"> 168          Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructuredContentðŸ”µ</abbr>
 169          Entity entity = new Entity();
 170          entity.setType(new String[]{StructuredContentType.class.getName()});
 171          List&lt;Property&gt; propertiesList = new ArrayList&lt;Property&gt;();
<abbr title=" 172          for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 172          for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieldTemplatðŸ”µ</abbr>
 173              for (FieldDefinition def : fieldGroup.getFieldDefinitions()) {
 174                  Property property = new Property();
 175                  property.setName(def.getName());
 176                  String value = null;
 177                  if (!MapUtils.isEmpty(structuredContentFieldMap)) {
<abbr title=" 178                      StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.get(def.getName());"> 178                      StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.get(def.getNðŸ”µ</abbr>
 179                      if (structuredContentFieldXref != null) {
<abbr title=" 180                          StructuredContentField structuredContentField = structuredContentFieldXref.getStructuredContentField();"> 180                          StructuredContentField structuredContentField = structuredContentFieldXref.getStructuredCoðŸ”µ</abbr>
 181                          if (structuredContentField != null) {
 182                              value = structuredContentField.getValue();
 183                          }
 184                      }
 185                  }
 186                  property.setValue(value);
 187                  if (!CollectionUtils.isEmpty(dirtyFields) &amp;&amp; dirtyFields.contains(property.getName())) {
 188                      property.setIsDirty(true);
 189                  }
 190  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -                if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; value != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 192 +                if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; StringUtils.isNotEmpty(value)) {"> 192 +                if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; StringUtils.isNotEmptyðŸ”µ</abbr></span>
 193                      // we need to look up the display value
 194                      String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), value);
 195                      property.setDisplayValue(display);
 196                  }
 197                  propertiesList.add(property);
 198              }
 199          }
 200          if (includeId) {
 201              Property property = new Property();
 202              propertiesList.add(property);
 203              property.setName(&quot;id&quot;);
 204              property.setValue(String.valueOf(structuredContent.getId()));
 205          }
 206  
 207          entity.setProperties(propertiesList.toArray(new Property[]{}));
 208  
 209          return entity;
 210      }
 211  
 212      /**
<abbr title=" 213       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 213       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured coðŸ”µ</abbr>
 214       */
 215      @Override
<abbr title=" 216      public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 216      public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper heðŸ”µ</abbr>
 217          return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 218      }
 219  
 220      /**
<abbr title=" 221       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 221       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured coðŸ”µ</abbr>
 222       */
 223      @Override
<abbr title=" 224      public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 224      public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helpeðŸ”µ</abbr>
 225          return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 226      }
 227  
<abbr title=" 228      protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 228      protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHðŸ”µ</abbr>
<abbr title=" 229          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 229          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
 230          try {
 231              String structuredContentId = persistencePackage.getCustomCriteria()[1];
<abbr title=" 232              StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 232              StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(ðŸ”µ</abbr>
 233  
<abbr title=" 234              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentType.class);"> 234              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructuredConteðŸ”µ</abbr>
 235              Map&lt;String, FieldMetadata&gt; md = new HashMap&lt;String, FieldMetadata&gt;();
 236              for (Property property : properties) {
 237                  md.put(property.getName(), property.getMetadata());
 238              }
 239  
<abbr title=" 240              boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeImpl(), md);"> 240              boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeImpl(), mðŸ”µ</abbr>
 241              if (!validated) {
<abbr title=" 242                  throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamic fields failed validation&quot;);"> 242                  throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamic fields fðŸ”µ</abbr>
 243              }
 244  
 245              List&lt;String&gt; templateFieldNames = new ArrayList&lt;String&gt;(20);
<abbr title=" 246              for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 246              for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFieldTemplateðŸ”µ</abbr>
 247                  for (FieldDefinition def : group.getFieldDefinitions()) {
 248                      templateFieldNames.add(def.getName());
 249                  }
 250              }
 251              Map&lt;String, String&gt; dirtyFieldsOrigVals = new HashMap&lt;String, String&gt;();
 252              List&lt;String&gt; dirtyFields = new ArrayList&lt;String&gt;();
 253              Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap =
 254                      structuredContent.getStructuredContentFieldXrefs();
 255              for (Property property : persistencePackage.getEntity().getProperties()) {
 256                  if (property.getEnabled() &amp;&amp; templateFieldNames.contains(property.getName())) {
 257                      StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName());
 258                      if (scXref != null &amp;&amp; scXref.getStructuredContentField() != null) {
 259                          StructuredContentField structuredContentField = scXref.getStructuredContentField();
<abbr title=" 260                          boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValue() != null) ||"> 260                          boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValue() != nulðŸ”µ</abbr>
 261                                  (structuredContentField.getValue() != null &amp;&amp; property.getValue() == null);
<abbr title=" 262                          if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() != null &amp;&amp;"> 262                          if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() != null &amp;ðŸ”µ</abbr>
 263                                  !structuredContentField.getValue().trim().equals(property.getValue().trim()))) {
 264                              dirtyFields.add(property.getName());
 265                              dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue());
 266                              structuredContentField.setValue(property.getValue());
 267                              scXref = dynamicEntityDao.merge(scXref);
 268                          }
 269                      } else {
 270                          StructuredContentField structuredContentField = new StructuredContentFieldImpl();
 271                          structuredContentField.setFieldKey(property.getName());
 272                          structuredContentField.setValue(property.getValue());
 273  
 274                          StructuredContentFieldXref scfx = new StructuredContentFieldXrefImpl();
 275                          scfx.setStructuredContent(structuredContent);
 276                          scfx.setKey(property.getName());
 277                          scfx.setStrucuturedContentField(structuredContentField);
 278  
 279                          scfx = dynamicEntityDao.persist(scfx);
 280                          dirtyFields.add(property.getName());
 281                      }
 282                  }
 283              }
 284              List&lt;String&gt; removeItems = new ArrayList&lt;String&gt;();
 285              for (String key : structuredContentFieldMap.keySet()) {
 286                  if (persistencePackage.getEntity().findProperty(key)==null) {
 287                      removeItems.add(key);
 288                  }
 289              }
 290              if (removeItems.size() &gt; 0) {
 291                  for (String removeKey : removeItems) {
 292                      structuredContentFieldMap.remove(removeKey);
 293                  }
 294              }
 295  
 296              Collections.sort(dirtyFields);
 297              Entity entity = fetchEntityBasedOnId(structuredContentId, dirtyFields);
 298  
 299              for (Entry&lt;String, String&gt; entry : dirtyFieldsOrigVals.entrySet()) {
 300                  entity.getPMap().get(entry.getKey()).setOriginalValue(entry.getValue());
 301                  entity.getPMap().get(entry.getKey()).setOriginalDisplayValue(entry.getValue());
 302              }
 303  
 304              return entity;
 305          } catch (ValidationException e) {
 306              throw e;
 307          } catch (Exception e) {
<abbr title=" 308              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 308              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassnameðŸ”µ</abbr>
 309          }
 310      }
 311  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce CMS Module
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.cms.admin.server.handler;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.MapUtils;

  22  import org.apache.commons.logging.Log;
  23  import org.apache.commons.logging.LogFactory;
  24  import org.broadleafcommerce.cms.field.domain.FieldDefinition;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import org.broadleafcommerce.cms.field.domain.FieldDefinitionImpl;</span>
  26  import org.broadleafcommerce.cms.field.domain.FieldGroup;
  27  import org.broadleafcommerce.cms.structure.domain.StructuredContent;
  28  import org.broadleafcommerce.cms.structure.domain.StructuredContentField;
  29  import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldImpl;
  30  import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXref;
  31  import org.broadleafcommerce.cms.structure.domain.StructuredContentFieldXrefImpl;
  32  import org.broadleafcommerce.cms.structure.domain.StructuredContentType;
  33  import org.broadleafcommerce.cms.structure.domain.StructuredContentTypeImpl;
  34  import org.broadleafcommerce.cms.structure.service.StructuredContentService;
  35  import org.broadleafcommerce.common.exception.ServiceException;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import org.broadleafcommerce.common.presentation.client.SupportedFieldType;</span>
  37  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  38  import org.broadleafcommerce.openadmin.dto.ClassTree;
  39  import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  40  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  41  import org.broadleafcommerce.openadmin.dto.Entity;
  42  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  43  import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  44  import org.broadleafcommerce.openadmin.dto.Property;
  45  import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import org.broadleafcommerce.openadmin.server.service.AdminEntityService;</span>
  47  import org.broadleafcommerce.openadmin.server.service.ValidationException;
  48  import org.broadleafcommerce.openadmin.server.service.handler.CustomPersistenceHandlerAdapter;
  49  import org.broadleafcommerce.openadmin.server.service.handler.DynamicEntityRetriever;
  50  import org.broadleafcommerce.openadmin.server.service.persistence.module.InspectHelper;
  51  import org.broadleafcommerce.openadmin.server.service.persistence.module.RecordHelper;
  52  import org.springframework.stereotype.Component;
  53  
  54  import java.io.Serializable;
  55  import java.util.ArrayList;
  56  import java.util.Collections;
  57  import java.util.HashMap;
  58  import java.util.List;
  59  import java.util.Map;
  60  import java.util.Map.Entry;
  61  
  62  import javax.annotation.Resource;
  63  import javax.persistence.EntityManager;
  64  import javax.persistence.PersistenceContext;
  65  
  66  /**
  67   * Created by jfischer
  68   */
  69  @Component(&quot;blStructuredContentTypeCustomPersistenceHandler&quot;)
<abbr title="  70  public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implements DynamicEntityRetriever {">  70  public class StructuredContentTypeCustomPersistenceHandler extends CustomPersistenceHandlerAdapter implements DynaðŸ”µ</abbr>
  71  
  72      private final Log LOG = LogFactory.getLog(StructuredContentTypeCustomPersistenceHandler.class);
  73  
  74      @Resource(name=&quot;blStructuredContentService&quot;)
  75      protected StructuredContentService structuredContentService;
  76  
  77      @Resource(name = &quot;blDynamicFieldPersistenceHandlerHelper&quot;)
  78      protected DynamicFieldPersistenceHandlerHelper dynamicFieldUtil;
  79  
  80      @PersistenceContext(unitName=&quot;blPU&quot;)
  81      protected EntityManager em;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -    @Resource(name = &quot;blAdminEntityService&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -    protected AdminEntityService service;</span>
  85  
  86      @Override
  87      public Boolean canHandleFetch(PersistencePackage persistencePackage) {
<abbr title="  88          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();">  88          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
  89          return
  90              StructuredContentType.class.getName().equals(ceilingEntityFullyQualifiedClassname) &amp;&amp;
  91              persistencePackage.getCustomCriteria() != null &amp;&amp;
  92              persistencePackage.getCustomCriteria().length &gt; 0 &amp;&amp;
  93              persistencePackage.getCustomCriteria()[0].equals(&quot;constructForm&quot;);
  94      }
  95  
  96      @Override
  97      public Boolean canHandleAdd(PersistencePackage persistencePackage) {
  98          return canHandleFetch(persistencePackage);
  99      }
 100  
 101      @Override
 102      public Boolean canHandleInspect(PersistencePackage persistencePackage) {
 103          return canHandleFetch(persistencePackage);
 104      }
 105  
 106      @Override
 107      public Boolean canHandleRemove(PersistencePackage persistencePackage) {
 108          return false;
 109      }
 110  
 111      @Override
 112      public Boolean canHandleUpdate(PersistencePackage persistencePackage) {
 113          return canHandleFetch(persistencePackage);
 114      }
 115  
 116      @Override
<abbr title=" 117      public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspectHelper helper) throws ServiceException {"> 117      public DynamicResultSet inspect(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, InspðŸ”µ</abbr>
<abbr title=" 118          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 118          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
 119          try {
 120              String structuredContentTypeId = persistencePackage.getCustomCriteria()[3];
<abbr title=" 121              StructuredContentType structuredContentType = structuredContentService.findStructuredContentTypeById(Long.valueOf(structuredContentTypeId));"> 121              StructuredContentType structuredContentType = structuredContentService.findStructuredContentTypeById(LðŸ”µ</abbr>
 122              ClassMetadata metadata = new ClassMetadata();
 123              metadata.setCeilingType(StructuredContentType.class.getName());
 124              ClassTree entities = new ClassTree(StructuredContentTypeImpl.class.getName());
 125              metadata.setPolymorphicEntities(entities);
<abbr title=" 126              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentTypeImpl.class);"> 126              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContentType.getStructuredCðŸ”µ</abbr>
 127              metadata.setProperties(properties);
 128              DynamicResultSet results = new DynamicResultSet(metadata);
 129  
 130              return results;
 131          } catch (Exception e) {
<abbr title=" 132              throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 132              throw new ServiceException(&quot;Unable to perform inspect for entity: &quot;+ceilingEntityFullyQualifiedClassnaðŸ”µ</abbr>
 133          }
 134      }
 135  
 136  
 137      @Override
<abbr title=" 138      public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 138      public DynamicResultSet fetch(PersistencePackage persistencePackage, CriteriaTransferObject cto, DynamicEntityðŸ”µ</abbr>
<abbr title=" 139          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 139          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
 140          try {
 141              String structuredContentId = persistencePackage.getCustomCriteria()[1];
 142              Entity entity = fetchEntityBasedOnId(structuredContentId, null);
 143              DynamicResultSet results = new DynamicResultSet(new Entity[]{entity}, 1);
 144  
 145              return results;
 146          } catch (Exception e) {
<abbr title=" 147              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 147              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassnameðŸ”µ</abbr>
 148          }
 149      }
 150  
 151      @Override
 152      public Entity fetchEntityBasedOnId(String structuredContentId, List&lt;String&gt; dirtyFields) throws Exception {
<abbr title=" 153          StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 153          StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(struðŸ”µ</abbr>
 154          //Make sure the fieldmap is refreshed from the database based on any changes introduced in addOrUpdate()
 155          em.refresh(structuredContent);
 156          return fetchDynamicEntity(structuredContent, dirtyFields, true);
 157      }
 158  
 159      @Override
 160      public String getFieldContainerClassName() {
 161          return StructuredContent.class.getName();
 162      }
 163  
 164      @Override
<abbr title=" 165      public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throws Exception {"> 165      public Entity fetchDynamicEntity(Serializable root, List&lt;String&gt; dirtyFields, boolean includeId) throws ExceptðŸ”µ</abbr>
 166          StructuredContent structuredContent = (StructuredContent) root;
<abbr title=" 167          Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructuredContentFieldXrefs();"> 167          Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap = structuredContent.getStructuredContentðŸ”µ</abbr>
 168          Entity entity = new Entity();
 169          entity.setType(new String[]{StructuredContentType.class.getName()});
 170          List&lt;Property&gt; propertiesList = new ArrayList&lt;Property&gt;();
<abbr title=" 171          for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 171          for (FieldGroup fieldGroup : structuredContent.getStructuredContentType().getStructuredContentFieldTemplatðŸ”µ</abbr>
 172              for (FieldDefinition def : fieldGroup.getFieldDefinitions()) {
 173                  Property property = new Property();
 174                  property.setName(def.getName());
 175                  String value = null;
 176                  if (!MapUtils.isEmpty(structuredContentFieldMap)) {
<abbr title=" 177                      StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.get(def.getName());"> 177                      StructuredContentFieldXref structuredContentFieldXref = structuredContentFieldMap.get(def.getNðŸ”µ</abbr>
 178                      if (structuredContentFieldXref != null) {
<abbr title=" 179                          StructuredContentField structuredContentField = structuredContentFieldXref.getStructuredContentField();"> 179                          StructuredContentField structuredContentField = structuredContentFieldXref.getStructuredCoðŸ”µ</abbr>
 180                          if (structuredContentField != null) {
 181                              value = structuredContentField.getValue();
 182                          }
 183                      }
 184                  }
 185                  property.setValue(value);
 186                  if (!CollectionUtils.isEmpty(dirtyFields) &amp;&amp; dirtyFields.contains(property.getName())) {
 187                      property.setIsDirty(true);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -                if (SupportedFieldType.ADDITIONAL_FOREIGN_KEY.equals(def.getFieldType()) &amp;&amp; value != null) {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -                    // we need to look up the display value</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -                    String display = service.getForeignEntityName(def.getAdditionalForeignKeyClass(), value);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -                    property.setDisplayValue(display);</span>
 194                  }
 195                  propertiesList.add(property);
 196              }
 197          }
 198          if (includeId) {
 199              Property property = new Property();
 200              propertiesList.add(property);
 201              property.setName(&quot;id&quot;);
 202              property.setValue(String.valueOf(structuredContent.getId()));
 203          }
 204  
 205          entity.setProperties(propertiesList.toArray(new Property[]{}));
 206  
 207          return entity;
 208      }
 209  
 210      /**
<abbr title=" 211       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 211       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured coðŸ”µ</abbr>
 212       */
 213      @Override
<abbr title=" 214      public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 214      public Entity update(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper heðŸ”µ</abbr>
 215          return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 216      }
 217  
 218      /**
<abbr title=" 219       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured content type"> 219       * Invoked when {@link StructuredContent} is saved in order to fill out the dynamic form for the structured coðŸ”µ</abbr>
 220       */
 221      @Override
<abbr title=" 222      public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 222      public Entity add(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helpeðŸ”µ</abbr>
 223          return addOrUpdate(persistencePackage, dynamicEntityDao, helper);
 224      }
 225  
<abbr title=" 226      protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHelper helper) throws ServiceException {"> 226      protected Entity addOrUpdate(PersistencePackage persistencePackage, DynamicEntityDao dynamicEntityDao, RecordHðŸ”µ</abbr>
<abbr title=" 227          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname();"> 227          String ceilingEntityFullyQualifiedClassname = persistencePackage.getCeilingEntityFullyQualifiedClassname()ðŸ”µ</abbr>
 228          try {
 229              String structuredContentId = persistencePackage.getCustomCriteria()[1];
<abbr title=" 230              StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(structuredContentId));"> 230              StructuredContent structuredContent = structuredContentService.findStructuredContentById(Long.valueOf(ðŸ”µ</abbr>
 231  
<abbr title=" 232              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups(), StructuredContentType.class);"> 232              Property[] properties = dynamicFieldUtil.buildDynamicPropertyList(structuredContent.getStructuredConteðŸ”µ</abbr>
 233              Map&lt;String, FieldMetadata&gt; md = new HashMap&lt;String, FieldMetadata&gt;();
 234              for (Property property : properties) {
 235                  md.put(property.getName(), property.getMetadata());
 236              }
 237  
<abbr title=" 238              boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeImpl(), md);"> 238              boolean validated = helper.validate(persistencePackage.getEntity(), new StructuredContentTypeImpl(), mðŸ”µ</abbr>
 239              if (!validated) {
<abbr title=" 240                  throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamic fields failed validation&quot;);"> 240                  throw new ValidationException(persistencePackage.getEntity(), &quot;Structured Content dynamic fields fðŸ”µ</abbr>
 241              }
 242  
 243              List&lt;String&gt; templateFieldNames = new ArrayList&lt;String&gt;(20);
<abbr title=" 244              for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFieldTemplate().getFieldGroups()) {"> 244              for (FieldGroup group : structuredContent.getStructuredContentType().getStructuredContentFieldTemplateðŸ”µ</abbr>
 245                  for (FieldDefinition def : group.getFieldDefinitions()) {
 246                      templateFieldNames.add(def.getName());
 247                  }
 248              }
 249              Map&lt;String, String&gt; dirtyFieldsOrigVals = new HashMap&lt;String, String&gt;();
 250              List&lt;String&gt; dirtyFields = new ArrayList&lt;String&gt;();
 251              Map&lt;String, StructuredContentFieldXref&gt; structuredContentFieldMap =
 252                      structuredContent.getStructuredContentFieldXrefs();
 253              for (Property property : persistencePackage.getEntity().getProperties()) {
 254                  if (property.getEnabled() &amp;&amp; templateFieldNames.contains(property.getName())) {
 255                      StructuredContentFieldXref scXref = structuredContentFieldMap.get(property.getName());
 256                      if (scXref != null &amp;&amp; scXref.getStructuredContentField() != null) {
 257                          StructuredContentField structuredContentField = scXref.getStructuredContentField();
<abbr title=" 258                          boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValue() != null) ||"> 258                          boolean isDirty = (structuredContentField.getValue() == null &amp;&amp; property.getValue() != nulðŸ”µ</abbr>
 259                                  (structuredContentField.getValue() != null &amp;&amp; property.getValue() == null);
<abbr title=" 260                          if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() != null &amp;&amp;"> 260                          if (isDirty || (structuredContentField.getValue() != null &amp;&amp; property.getValue() != null &amp;ðŸ”µ</abbr>
 261                                  !structuredContentField.getValue().trim().equals(property.getValue().trim()))) {
 262                              dirtyFields.add(property.getName());
 263                              dirtyFieldsOrigVals.put(property.getName(), structuredContentField.getValue());
 264                              structuredContentField.setValue(property.getValue());
 265                              scXref = dynamicEntityDao.merge(scXref);
 266                          }
 267                      } else {
 268                          StructuredContentField structuredContentField = new StructuredContentFieldImpl();
 269                          structuredContentField.setFieldKey(property.getName());
 270                          structuredContentField.setValue(property.getValue());
 271  
 272                          StructuredContentFieldXref scfx = new StructuredContentFieldXrefImpl();
 273                          scfx.setStructuredContent(structuredContent);
 274                          scfx.setKey(property.getName());
 275                          scfx.setStrucuturedContentField(structuredContentField);
 276  
 277                          scfx = dynamicEntityDao.persist(scfx);
 278                          dirtyFields.add(property.getName());
 279                      }
 280                  }
 281              }
 282              List&lt;String&gt; removeItems = new ArrayList&lt;String&gt;();
 283              for (String key : structuredContentFieldMap.keySet()) {
 284                  if (persistencePackage.getEntity().findProperty(key)==null) {
 285                      removeItems.add(key);
 286                  }
 287              }
 288              if (removeItems.size() &gt; 0) {
 289                  for (String removeKey : removeItems) {
 290                      structuredContentFieldMap.remove(removeKey);
 291                  }
 292              }
 293  
 294              Collections.sort(dirtyFields);
 295              Entity entity = fetchEntityBasedOnId(structuredContentId, dirtyFields);
 296  
 297              for (Entry&lt;String, String&gt; entry : dirtyFieldsOrigVals.entrySet()) {
 298                  entity.getPMap().get(entry.getKey()).setOriginalValue(entry.getValue());
 299                  entity.getPMap().get(entry.getKey()).setOriginalDisplayValue(entry.getValue());
 300              }
 301  
 302              return entity;
 303          } catch (ValidationException e) {
 304              throw e;
 305          } catch (Exception e) {
<abbr title=" 306              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassname, e);"> 306              throw new ServiceException(&quot;Unable to perform fetch for entity: &quot;+ceilingEntityFullyQualifiedClassnameðŸ”µ</abbr>
 307          }
 308      }
 309  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            