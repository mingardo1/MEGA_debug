<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>409</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    409
                    <a href="408.html">prev</a>
                    <a href="410.html">next</a>
                    <a href="409_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_e408d12c730a7397701e361d52cac823c1694111_redis5/redis5-side/redis-all-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAllReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e408d12c730a7397701e361d52cac823c1694111:redis5/redis5-side/redis-all-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAllReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e408d12c730a7397701e361d52cac823c1694111^1:redis5/redis5-side/redis-all-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAllReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e408d12c730a7397701e361d52cac823c1694111^2:redis5/redis5-side/redis-all-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAllReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;09a8d23c2b8c9e6955f6f68bed4a2fe16cc7fbd3:redis5/redis5-side/redis-all-side/src/main/java/com/dtstack/flink/sql/side/redis/RedisAllReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [bs], [bs], [j], [s]], subset: [[bs], [bs], [bs], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.redis;
  20 
  21 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22 import com.dtstack.flink.sql.side.BaseAllReqRow;
  23 import com.dtstack.flink.sql.side.FieldInfo;
  24 import com.dtstack.flink.sql.side.JoinInfo;
  25 import com.dtstack.flink.sql.side.redis.enums.RedisType;
  26 import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  27 import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  28 import com.dtstack.flink.sql.util.RowDataComplete;
  29 import com.esotericsoftware.minlog.Log;
  30 import com.google.common.collect.Maps;
  31 import org.apache.calcite.sql.JoinType;
  32 import org.apache.commons.collections.CollectionUtils;
  33 import org.apache.commons.lang3.StringUtils;
  34 import org.apache.commons.pool2.impl.GenericObjectPoolConfig;
  35 import org.apache.flink.api.java.tuple.Tuple2;
  36 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  37 import org.apache.flink.table.dataformat.BaseRow;
  38 import org.apache.flink.types.Row;
  39 import org.apache.flink.util.Collector;
  40 import org.slf4j.Logger;
  41 import org.slf4j.LoggerFactory;
  42 import redis.clients.jedis.HostAndPort;
  43 import redis.clients.jedis.Jedis;
  44 import redis.clients.jedis.JedisCluster;
  45 import redis.clients.jedis.JedisCommands;
  46 import redis.clients.jedis.JedisPool;
  47 import redis.clients.jedis.JedisSentinelPool;
  48 
  49 import java.io.Closeable;
  50 import java.io.IOException;
  51 import java.sql.SQLException;
  52 import java.util.Calendar;
  53 import java.util.HashSet;
  54 import java.util.LinkedList;
  55 import java.util.List;
  56 import java.util.Map;
  57 import java.util.Set;
  58 import java.util.TreeSet;
  59 import java.util.concurrent.atomic.AtomicReference;
  60 import java.util.stream.Collectors;
  61 /**
  62  * @author yanxi
  63  */
  64 public class RedisAllReqRow extends BaseAllReqRow {
  65 
  66     private static final long serialVersionUID = 7578879189085344807L;
  67 
  68     private static final Logger LOG = LoggerFactory.getLogger(RedisAllReqRow.class);
  69 
  70     private static final int CONN_RETRY_NUM = 3;
  71 
  72     private JedisPool pool;
  73 
  74     private JedisSentinelPool jedisSentinelPool;
  75 
  76     private RedisSideTableInfo tableInfo;
  77 
  78     private AtomicReference&lt;Map&lt;String, Map&lt;String, String&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  79 
  80     private RedisSideReqRow redisSideReqRow;
  81 
<abbr title="  82     public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  82     public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, A🔵</abbr>
  83         super(new RedisAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  84         this.redisSideReqRow = new RedisSideReqRow(super.sideInfo, (RedisSideTableInfo) sideTableInfo);
  85     }
  86 
  87     @Override
  88     public Row fillData(Row input, Object sideInput) {
  89         return redisSideReqRow.fillData(input, sideInput);
  90     }
  91 
  92     @Override
  93     protected void initCache() throws SQLException {
  94         tableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  95         Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
  96         cacheRef.set(newCache);
  97         loadData(newCache);
  98     }
  99 
 100     @Override
 101     protected void reloadCache() {
 102         Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
 103         try {
 104             loadData(newCache);
 105         } catch (SQLException e) {
 106             LOG.error(&quot;&quot;, e);
 107             throw new RuntimeException(e);
 108         }
 109 
 110         cacheRef.set(newCache);
 111         LOG.info(&quot;----- Redis all cacheRef reload end:{}&quot;, Calendar.getInstance());
 112     }
 113 
 114     @Override
 115 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116     public void flatMap(Row input, Collector&lt;BaseRow&gt; out) throws Exception {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117         Map&lt;String, String&gt; inputParams = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118         for(Integer conValIndex : sideInfo.getEqualValIndex()){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119             Object equalObj = input.getField(conValIndex);</span>
 120 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121     public void flatMap(CRow input, Collector&lt;CRow&gt; out) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122         Map&lt;String, String&gt; inputParams = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125             Object equalObj = input.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126             if(equalObj == null){</span>
 127 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128     public void flatMap(CRow input, Collector&lt;CRow&gt; out) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129         Map&lt;String, Object&gt; inputParams = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132             Object equalObj = input.row().getField(conValIndex);</span>
 133 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 134             if(equalObj == null){
 135                 if (sideInfo.getJoinType() == JoinType.LEFT) {
 136                     Row data = fillData(input, null);
 137                     RowDataComplete.collectRow(out, data);
 138                 }
 139                 return;
 140             }
 141 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142             String columnName = sideInfo.getEqualFieldList().get(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143             inputParams.put(columnName, equalObj.toString());</span>
 144 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145             inputParams.put(sideInfo.getEqualFieldList().get(i), equalObj.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147         String key = buildCacheKey(inputParams);</span>
 148 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149             inputParams.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
 150 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 151         }
 152 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153         String key = buildCacheKey(inputParams);</span>
 154 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156         if(StringUtils.isBlank(key)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158         }</span>
 159 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160         String key = redisSideReqRow.buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161         if(StringUtils.isBlank(key)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163         }</span>
 164 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 165 
 166         Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);
 167 
 168         if (cacheMap == null){
 169             if(sideInfo.getJoinType() == JoinType.LEFT){
 170                 Row data = fillData(input, null);
 171                 RowDataComplete.collectRow(out, data);
 172             }else{
 173                 return;
 174             }
 175 
 176             return;
 177         }
 178 
 179         Row newRow = fillData(input, cacheMap);
 180         RowDataComplete.collectRow(out, newRow);
 181     }
 182 
 183     private void loadData(Map&lt;String, Map&lt;String, String&gt;&gt; tmpCache) throws SQLException {
 184         JedisCommands jedis = null;
 185         try {
 186             StringBuilder keyPattern = new StringBuilder(tableInfo.getTableName());
 187             for (String key : tableInfo.getPrimaryKeys()) {
 188                 keyPattern.append(&quot;_&quot;).append(&quot;*&quot;);
 189             }
 190             jedis = getJedisWithRetry(CONN_RETRY_NUM);
 191             if (null == jedis) {
 192                 throw new RuntimeException(&quot;redis all load data error,get jedis commands error!&quot;);
 193             }
<abbr title=" 194             Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.toString());"> 194             Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.🔵</abbr>
 195             if (CollectionUtils.isEmpty(keys)) {
 196                 return;
 197             }
 198             for (String key : keys) {
 199                 tmpCache.put(key, jedis.hgetAll(key));
 200             }
 201         } finally {
 202             if (jedis != null) {
 203                 try {
 204                     ((Closeable) jedis).close();
 205                 } catch (IOException e) {
 206                     Log.error(&quot;&quot;, e);
 207                 }
 208             }
 209             if (jedisSentinelPool != null) {
 210                 jedisSentinelPool.close();
 211             }
 212             if (pool != null) {
 213                 pool.close();
 214             }
 215         }
 216     }
 217 
 218     private JedisCommands getJedis(RedisSideTableInfo tableInfo) {
 219         String url = tableInfo.getUrl();
 220         String password = tableInfo.getPassword();
 221         String database = tableInfo.getDatabase() == null ? &quot;0&quot; : tableInfo.getDatabase();
 222         int timeout = tableInfo.getTimeout();
 223         if (timeout == 0){
 224             timeout = 1000;
 225         }
 226 
 227         String[] nodes = StringUtils.split(url, &quot;,&quot;);
 228         String[] firstIpPort = StringUtils.split(nodes[0], &quot;:&quot;);
 229         String firstIp = firstIpPort[0];
 230         String firstPort = firstIpPort[1];
 231         Set&lt;HostAndPort&gt; addresses = new HashSet&lt;&gt;();
 232         Set&lt;String&gt; ipPorts = new HashSet&lt;&gt;();
 233         for (String ipPort : nodes) {
 234             ipPorts.add(ipPort);
 235             String[] ipPortPair = ipPort.split(&quot;:&quot;);
 236             addresses.add(new HostAndPort(ipPortPair[0].trim(), Integer.valueOf(ipPortPair[1].trim())));
 237         }
 238         if (timeout == 0){
 239             timeout = 1000;
 240         }
 241         JedisCommands jedis = null;
<abbr title=" 242         GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(), tableInfo.getMinIdle());"> 242         GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(🔵</abbr>
 243         switch (RedisType.parse(tableInfo.getRedisType())){
 244             //单机
 245             case STANDALONE:
<abbr title=" 246                 pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password, Integer.parseInt(database));"> 246                 pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password,🔵</abbr>
 247                 jedis = pool.getResource();
 248                 break;
 249             //哨兵
 250             case SENTINEL:
<abbr title=" 251                 jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig, timeout, password, Integer.parseInt(database));"> 251                 jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig,🔵</abbr>
 252                 jedis = jedisSentinelPool.getResource();
 253                 break;
 254             //集群
 255             case CLUSTER:
 256                 jedis = new JedisCluster(addresses, timeout, timeout,1, poolConfig);
 257             default:
 258                 break;
 259         }
 260 
 261         return jedis;
 262     }
 263 
 264     private JedisCommands getJedisWithRetry(int retryNum) {
 265         while (retryNum-- &gt; 0) {
 266             try {
 267                 return getJedis(tableInfo);
 268             } catch (Exception e) {
 269                 if (retryNum &lt;= 0) {
 270                     throw new RuntimeException(&quot;getJedisWithRetry error&quot;, e);
 271                 }
 272                 try {
<abbr title=" 273                     String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,database:&quot; + tableInfo.getDatabase();"> 273                     String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + 🔵</abbr>
 274                     LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + jedisInfo);
 275                     Thread.sleep(LOAD_DATA_ERROR_SLEEP_TIME);
 276                 } catch (InterruptedException e1) {
 277                     LOG.error(&quot;&quot;, e1);
 278                 }
 279             }
 280         }
 281         return null;
 282     }
 283 
 284     private Set&lt;String&gt; getRedisKeys(RedisType redisType, JedisCommands jedis, String keyPattern){
 285         if(!redisType.equals(RedisType.CLUSTER)){
 286             return ((Jedis) jedis).keys(keyPattern);
 287         }
 288         Set&lt;String&gt; keys = new TreeSet&lt;&gt;();
 289         Map&lt;String, JedisPool&gt; clusterNodes = ((JedisCluster)jedis).getClusterNodes();
 290         for(String k : clusterNodes.keySet()){
 291             JedisPool jp = clusterNodes.get(k);
 292             Jedis connection = jp.getResource();
 293             try {
 294                 keys.addAll(connection.keys(keyPattern));
 295             } catch (Exception e){
 296                 LOG.error(&quot;Getting keys error: {}&quot;, e);
 297             } finally {
 298                 connection.close();
 299             }
 300         }
 301         return keys;
 302     }
 303 
 304     private GenericObjectPoolConfig setPoolConfig(String maxTotal, String maxIdle, String minIdle){
 305         GenericObjectPoolConfig config = new GenericObjectPoolConfig();
 306         if (maxTotal != null){
 307             config.setMaxTotal(Integer.parseInt(maxTotal));
 308         }
 309         if (maxIdle != null){
 310             config.setMaxIdle(Integer.parseInt(maxIdle));
 311         }
 312         if (minIdle != null){
 313             config.setMinIdle(Integer.parseInt(minIdle));
 314         }
 315         return config;
 316     }
 317 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.redis;
  20 
  21 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22 import com.dtstack.flink.sql.side.BaseAllReqRow;
  23 import com.dtstack.flink.sql.side.FieldInfo;
  24 import com.dtstack.flink.sql.side.JoinInfo;
  25 import com.dtstack.flink.sql.side.redis.enums.RedisType;
  26 import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  27 import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  28 import com.dtstack.flink.sql.util.RowDataComplete;
  29 import com.esotericsoftware.minlog.Log;
  30 import org.apache.calcite.sql.JoinType;
  31 import org.apache.commons.collections.CollectionUtils;
  32 import org.apache.commons.lang3.StringUtils;
  33 import org.apache.commons.pool2.impl.GenericObjectPoolConfig;
  34 import org.apache.flink.api.java.tuple.Tuple2;
  35 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  36 import org.apache.flink.table.dataformat.BaseRow;
  37 import org.apache.flink.types.Row;
  38 import org.apache.flink.util.Collector;
  39 import com.google.common.collect.Maps;
  40 import org.slf4j.Logger;
  41 import org.slf4j.LoggerFactory;
  42 import redis.clients.jedis.HostAndPort;
  43 import redis.clients.jedis.Jedis;
  44 import redis.clients.jedis.JedisCluster;
  45 import redis.clients.jedis.JedisCommands;
  46 import redis.clients.jedis.JedisPool;
  47 import redis.clients.jedis.JedisSentinelPool;
  48 
  49 import java.io.Closeable;
  50 import java.io.IOException;
  51 import java.sql.SQLException;
  52 import java.util.Calendar;
  53 import java.util.HashSet;
  54 import java.util.LinkedList;
  55 import java.util.List;
  56 import java.util.Map;
  57 import java.util.Set;
  58 import java.util.TreeSet;
  59 import java.util.concurrent.atomic.AtomicReference;
  60 import java.util.stream.Collectors;
  61 /**
  62  * @author yanxi
  63  */
  64 public class RedisAllReqRow extends BaseAllReqRow {
  65 
  66     private static final long serialVersionUID = 7578879189085344807L;
  67 
  68     private static final Logger LOG = LoggerFactory.getLogger(RedisAllReqRow.class);
  69 
  70     private static final int CONN_RETRY_NUM = 3;
  71 
  72     private JedisPool pool;
  73 
  74     private JedisSentinelPool jedisSentinelPool;
  75 
  76     private RedisSideTableInfo tableInfo;
  77 
  78     private AtomicReference&lt;Map&lt;String, Map&lt;String, String&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  79 
  80     private RedisSideReqRow redisSideReqRow;
  81 
<abbr title="  82     public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  82     public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, A🔵</abbr>
  83         super(new RedisAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  84         this.redisSideReqRow = new RedisSideReqRow(super.sideInfo, (RedisSideTableInfo) sideTableInfo);
  85     }
  86 
  87     @Override
  88     public Row fillData(Row input, Object sideInput) {
  89         return redisSideReqRow.fillData(input, sideInput);
  90     }
  91 
  92     @Override
  93     protected void initCache() throws SQLException {
  94         tableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  95         Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
  96         cacheRef.set(newCache);
  97         loadData(newCache);
  98     }
  99 
 100     @Override
 101     protected void reloadCache() {
 102         Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
 103         try {
 104             loadData(newCache);
 105         } catch (SQLException e) {
 106             LOG.error(&quot;&quot;, e);
 107             throw new RuntimeException(e);
 108         }
 109 
 110         cacheRef.set(newCache);
 111         LOG.info(&quot;----- Redis all cacheRef reload end:{}&quot;, Calendar.getInstance());
 112     }
 113 
 114     @Override
 115     public void flatMap(Row input, Collector&lt;BaseRow&gt; out) throws Exception {
 116         Map&lt;String, String&gt; inputParams = Maps.newHashMap();
 117         for(Integer conValIndex : sideInfo.getEqualValIndex()){
 118             Object equalObj = input.getField(conValIndex);
 119             if(equalObj == null){
 120                 if (sideInfo.getJoinType() == JoinType.LEFT) {
 121                     Row data = fillData(input, null);
 122                     RowDataComplete.collectRow(out, data);
 123                 }
 124                 return;
 125             }
 126             String columnName = sideInfo.getEqualFieldList().get(conValIndex);
 127             inputParams.put(columnName, equalObj.toString());
 128         }
 129         String key = buildCacheKey(inputParams);
 130 
 131         Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);
 132 
 133         if (cacheMap == null){
 134             if(sideInfo.getJoinType() == JoinType.LEFT){
 135                 Row data = fillData(input, null);
 136                 RowDataComplete.collectRow(out, data);
 137             }else{
 138                 return;
 139             }
 140 
 141             return;
 142         }
 143 
 144         Row newRow = fillData(input, cacheMap);
 145         RowDataComplete.collectRow(out, newRow);
 146     }
 147 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 148 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149 @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150     public void flatMap(CRow input, Collector&lt;CRow&gt; out) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151         Map&lt;String, String&gt; inputParams = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154             Object equalObj = input.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156                 if(sideInfo.getJoinType() == JoinType.LEFT){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157                     Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158                     out.collect(new CRow(data, input.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162             inputParams.put(sideInfo.getEqualFieldList().get(i), equalObj.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         if(StringUtils.isBlank(key)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169         Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170         if(MapUtils.isEmpty(cacheMap)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171             if(sideInfo.getJoinType() != JoinType.LEFT){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174             Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             out.collect(new CRow(data, input.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179         Row newRow = fillData(input.row(), cacheMap);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180         out.collect(new CRow(newRow, input.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181     }</span>
 182 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183 @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184     public void flatMap(CRow input, Collector&lt;CRow&gt; out) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185         Map&lt;String, Object&gt; inputParams = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188             Object equalObj = input.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190                 if(sideInfo.getJoinType() == JoinType.LEFT){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191                     Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192                     out.collect(new CRow(data, input.change()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196             inputParams.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198         String key = redisSideReqRow.buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199         if(StringUtils.isBlank(key)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203         Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204         if(MapUtils.isEmpty(cacheMap)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205             if(sideInfo.getJoinType() != JoinType.LEFT){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208             Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209             out.collect(new CRow(data, input.change()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213         Row newRow = fillData(input.row(), cacheMap);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214         out.collect(new CRow(newRow, input.change()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215     }</span>
 216 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 217 
 218 
 219     private void loadData(Map&lt;String, Map&lt;String, String&gt;&gt; tmpCache) throws SQLException {
 220         JedisCommands jedis = null;
 221         try {
 222             StringBuilder keyPattern = new StringBuilder(tableInfo.getTableName());
 223             for (String key : tableInfo.getPrimaryKeys()) {
 224                 keyPattern.append(&quot;_&quot;).append(&quot;*&quot;);
 225             }
 226             jedis = getJedisWithRetry(CONN_RETRY_NUM);
 227             if (null == jedis) {
 228                 throw new RuntimeException(&quot;redis all load data error,get jedis commands error!&quot;);
 229             }
<abbr title=" 230             Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.toString());"> 230             Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.🔵</abbr>
 231             if (CollectionUtils.isEmpty(keys)) {
 232                 return;
 233             }
 234             for (String key : keys) {
 235                 tmpCache.put(key, jedis.hgetAll(key));
 236             }
 237         } finally {
 238             if (jedis != null) {
 239                 try {
 240                     ((Closeable) jedis).close();
 241                 } catch (IOException e) {
 242                     Log.error(&quot;&quot;, e);
 243                 }
 244             }
 245             if (jedisSentinelPool != null) {
 246                 jedisSentinelPool.close();
 247             }
 248             if (pool != null) {
 249                 pool.close();
 250             }
 251         }
 252     }
 253 
 254     private JedisCommands getJedis(RedisSideTableInfo tableInfo) {
 255         String url = tableInfo.getUrl();
 256         String password = tableInfo.getPassword();
 257         String database = tableInfo.getDatabase() == null ? &quot;0&quot; : tableInfo.getDatabase();
 258         int timeout = tableInfo.getTimeout();
 259         if (timeout == 0){
 260             timeout = 1000;
 261         }
 262 
 263         String[] nodes = StringUtils.split(url, &quot;,&quot;);
 264         String[] firstIpPort = StringUtils.split(nodes[0], &quot;:&quot;);
 265         String firstIp = firstIpPort[0];
 266         String firstPort = firstIpPort[1];
 267         Set&lt;HostAndPort&gt; addresses = new HashSet&lt;&gt;();
 268         Set&lt;String&gt; ipPorts = new HashSet&lt;&gt;();
 269         for (String ipPort : nodes) {
 270             ipPorts.add(ipPort);
 271             String[] ipPortPair = ipPort.split(&quot;:&quot;);
 272             addresses.add(new HostAndPort(ipPortPair[0].trim(), Integer.valueOf(ipPortPair[1].trim())));
 273         }
 274         if (timeout == 0){
 275             timeout = 1000;
 276         }
 277         JedisCommands jedis = null;
<abbr title=" 278         GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(), tableInfo.getMinIdle());"> 278         GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(🔵</abbr>
 279         switch (RedisType.parse(tableInfo.getRedisType())){
 280             //单机
 281             case STANDALONE:
<abbr title=" 282                 pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password, Integer.parseInt(database));"> 282                 pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password,🔵</abbr>
 283                 jedis = pool.getResource();
 284                 break;
 285             //哨兵
 286             case SENTINEL:
<abbr title=" 287                 jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig, timeout, password, Integer.parseInt(database));"> 287                 jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig,🔵</abbr>
 288                 jedis = jedisSentinelPool.getResource();
 289                 break;
 290             //集群
 291             case CLUSTER:
 292                 jedis = new JedisCluster(addresses, timeout, timeout,1, poolConfig);
 293             default:
 294                 break;
 295         }
 296 
 297         return jedis;
 298     }
 299 
 300     private JedisCommands getJedisWithRetry(int retryNum) {
 301         while (retryNum-- &gt; 0) {
 302             try {
 303                 return getJedis(tableInfo);
 304             } catch (Exception e) {
 305                 if (retryNum &lt;= 0) {
 306                     throw new RuntimeException(&quot;getJedisWithRetry error&quot;, e);
 307                 }
 308                 try {
<abbr title=" 309                     String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,database:&quot; + tableInfo.getDatabase();"> 309                     String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + 🔵</abbr>
 310                     LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + jedisInfo);
 311                     Thread.sleep(LOAD_DATA_ERROR_SLEEP_TIME);
 312                 } catch (InterruptedException e1) {
 313                     LOG.error(&quot;&quot;, e1);
 314                 }
 315             }
 316         }
 317         return null;
 318     }
 319 
 320     private Set&lt;String&gt; getRedisKeys(RedisType redisType, JedisCommands jedis, String keyPattern){
 321         if(!redisType.equals(RedisType.CLUSTER)){
 322             return ((Jedis) jedis).keys(keyPattern);
 323         }
 324         Set&lt;String&gt; keys = new TreeSet&lt;&gt;();
 325         Map&lt;String, JedisPool&gt; clusterNodes = ((JedisCluster)jedis).getClusterNodes();
 326         for(String k : clusterNodes.keySet()){
 327             JedisPool jp = clusterNodes.get(k);
 328             Jedis connection = jp.getResource();
 329             try {
 330                 keys.addAll(connection.keys(keyPattern));
 331             } catch (Exception e){
 332                 LOG.error(&quot;Getting keys error: {}&quot;, e);
 333             } finally {
 334                 connection.close();
 335             }
 336         }
 337         return keys;
 338     }
 339 
 340     private GenericObjectPoolConfig setPoolConfig(String maxTotal, String maxIdle, String minIdle){
 341         GenericObjectPoolConfig config = new GenericObjectPoolConfig();
 342         if (maxTotal != null){
 343             config.setMaxTotal(Integer.parseInt(maxTotal));
 344         }
 345         if (maxIdle != null){
 346             config.setMaxIdle(Integer.parseInt(maxIdle));
 347         }
 348         if (minIdle != null){
 349             config.setMinIdle(Integer.parseInt(minIdle));
 350         }
 351         return config;
 352     }
 353 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.redis;
  19 
  20 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  21 import com.dtstack.flink.sql.side.BaseAllReqRow;
  22 import com.dtstack.flink.sql.side.FieldInfo;
  23 import com.dtstack.flink.sql.side.JoinInfo;
  24 import com.dtstack.flink.sql.side.redis.enums.RedisType;
  25 import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  26 import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
  27 import com.dtstack.flink.sql.util.RowDataComplete;
  28 import com.esotericsoftware.minlog.Log;
  29 import com.google.common.collect.Maps;
  30 import java.io.Closeable;
  31 import java.io.IOException;
  32 import java.sql.SQLException;
  33 import java.util.Calendar;
  34 import java.util.HashSet;
  35 import java.util.LinkedList;
  36 import java.util.List;
  37 import java.util.Map;
  38 import java.util.Set;
  39 import java.util.TreeSet;
  40 import java.util.concurrent.atomic.AtomicReference;
  41 import java.util.stream.Collectors;
  42 import org.apache.calcite.sql.JoinType;
  43 import org.apache.commons.collections.CollectionUtils;
  44 import org.apache.commons.lang3.StringUtils;
  45 import org.apache.commons.pool2.impl.GenericObjectPoolConfig;
  46 import org.apache.flink.api.java.tuple.Tuple2;
  47 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  48 import org.apache.flink.table.dataformat.BaseRow;
  49 import org.apache.flink.types.Row;
  50 import org.apache.flink.util.Collector;
  51 import org.slf4j.Logger;
  52 import org.slf4j.LoggerFactory;
  53 import redis.clients.jedis.HostAndPort;
  54 import redis.clients.jedis.Jedis;
  55 import redis.clients.jedis.JedisCluster;
  56 import redis.clients.jedis.JedisCommands;
  57 import redis.clients.jedis.JedisPool;
  58 import redis.clients.jedis.JedisSentinelPool;
  59 
  60 
  61 /**
  62  * @author yanxi
  63  */
  64 public class RedisAllReqRow extends BaseAllReqRow {
  65     private static final long serialVersionUID = 7578879189085344807L;
  66 
  67     private static final Logger LOG = LoggerFactory.getLogger(RedisAllReqRow.class);
  68 
  69     private static final int CONN_RETRY_NUM = 3;
  70 
  71     private JedisPool pool;
  72 
  73     private JedisSentinelPool jedisSentinelPool;
  74 
  75     private RedisSideTableInfo tableInfo;
  76 
  77     private AtomicReference&lt;Map&lt;String, Map&lt;String, String&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  78 
  79     private RedisSideReqRow redisSideReqRow;
  80 
<abbr title="  81     public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  81     public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, A🔵</abbr>
  82         super(new RedisAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
<abbr title="  83         this.redisSideReqRow = new RedisSideReqRow(super.sideInfo, ((RedisSideTableInfo) (sideTableInfo)));">  83         this.redisSideReqRow = new RedisSideReqRow(super.sideInfo, ((RedisSideTableInfo) (sideTableInfo))🔵</abbr>
  84     }
  85 
  86     @Override
  87     public Row fillData(Row input, Object sideInput) {
  88         return redisSideReqRow.fillData(input, sideInput);
  89     }
  90 
  91     @Override
  92     protected void initCache() throws SQLException {
  93         tableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  94         Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
  95         cacheRef.set(newCache);
  96         loadData(newCache);
  97     }
  98 
  99     @Override
 100     protected void reloadCache() {
 101         Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
 102         try {
 103             loadData(newCache);
 104         } catch (SQLException e) {
 105             LOG.error(&quot;&quot;, e);
 106             throw new RuntimeException(e);
 107         }
 108 
 109         cacheRef.set(newCache);
 110         LOG.info(&quot;----- Redis all cacheRef reload end:{}&quot;, Calendar.getInstance());
 111     }
 112 
 113     @Override
 114     public void flatMap(Row input, Collector&lt;BaseRow&gt; out) throws Exception {
 115 
 116 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117         Map&lt;String, String&gt; inputParams = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118         for(Integer conValIndex : sideInfo.getEqualValIndex()){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119             Object equalObj = input.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120 </span>
 121 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 122 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 122 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 123 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125         Map&lt;String, Object&gt; inputParams = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128             Object equalObj = input.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129 </span>
 130 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 131             if(equalObj == null){
 132                 if (sideInfo.getJoinType() == JoinType.LEFT) {
 133                     Row data = fillData(input, null);
 134                     RowDataComplete.collectRow(out, data);
 135                 }
 136                 return;
 137             }
 138 
 139 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140             String columnName = sideInfo.getEqualFieldList().get(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141             inputParams.put(columnName, equalObj.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142 </span>
 143 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 144 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 144 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 145 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147             inputParams.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148 </span>
 149 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 150         }
 151 
 152 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154 </span>
 155 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 156 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 156 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 157 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159         String key = redisSideReqRow.buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160         if(StringUtils.isBlank(key)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163 </span>
 164 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 165 
 166         Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);
 167 
 168         if (cacheMap == null){
 169             if(sideInfo.getJoinType() == JoinType.LEFT){
 170                 Row data = fillData(input, null);
 171                 RowDataComplete.collectRow(out, data);
 172             }else{
 173                 return;
 174             }
 175 
 176             return;
 177         }
 178 
 179         Row newRow = fillData(input, cacheMap);
 180         RowDataComplete.collectRow(out, newRow);
 181     }
 182 
 183     private void loadData(Map&lt;String, Map&lt;String, String&gt;&gt; tmpCache) throws SQLException {
 184         JedisCommands jedis = null;
 185         try {
 186             StringBuilder keyPattern = new StringBuilder(tableInfo.getTableName());
 187             for (String key : tableInfo.getPrimaryKeys()) {
 188                 keyPattern.append(&quot;_&quot;).append(&quot;*&quot;);
 189             }
 190             jedis = getJedisWithRetry(CONN_RETRY_NUM);
 191             if (null == jedis) {
 192                 throw new RuntimeException(&quot;redis all load data error,get jedis commands error!&quot;);
 193             }
<abbr title=" 194             Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.toString());"> 194             Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.🔵</abbr>
 195             if (CollectionUtils.isEmpty(keys)) {
 196                 return;
 197             }
 198             for (String key : keys) {
 199                 tmpCache.put(key, jedis.hgetAll(key));
 200             }
 201         } finally {
 202             if (jedis != null) {
 203                 try {
 204                     ((Closeable) jedis).close();
 205                 } catch (IOException e) {
 206                     Log.error(&quot;&quot;, e);
 207                 }
 208             }
 209             if (jedisSentinelPool != null) {
 210                 jedisSentinelPool.close();
 211             }
 212             if (pool != null) {
 213                 pool.close();
 214             }
 215         }
 216     }
 217 
 218     private JedisCommands getJedis(RedisSideTableInfo tableInfo) {
 219         String url = tableInfo.getUrl();
 220         String password = tableInfo.getPassword();
 221         String database = (tableInfo.getDatabase() == null) ? &quot;0&quot; : tableInfo.getDatabase();
 222         int timeout = tableInfo.getTimeout();
 223         if (timeout == 0) {
 224             timeout = 1000;
 225         }
 226         String[] nodes = StringUtils.split(url, &quot;,&quot;);
 227         String[] firstIpPort = StringUtils.split(nodes[0], &quot;:&quot;);
 228         String firstIp = firstIpPort[0];
 229         String firstPort = firstIpPort[1];
 230         Set&lt;HostAndPort&gt; addresses = new HashSet&lt;&gt;();
 231         Set&lt;String&gt; ipPorts = new HashSet&lt;&gt;();
 232         for (String ipPort : nodes) {
 233             ipPorts.add(ipPort);
 234             String[] ipPortPair = ipPort.split(&quot;:&quot;);
 235             addresses.add(new HostAndPort(ipPortPair[0].trim(), Integer.valueOf(ipPortPair[1].trim())));
 236         }
 237         if (timeout == 0) {
 238             timeout = 1000;
 239         }
 240         JedisCommands jedis = null;
<abbr title=" 241         GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(), tableInfo.getMinIdle());"> 241         GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(🔵</abbr>
 242         switch (RedisType.parse(tableInfo.getRedisType())) {
 243             // 单机
 244             case STANDALONE :
<abbr title=" 245                 pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password, Integer.parseInt(database));"> 245                 pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password,🔵</abbr>
 246                 jedis = pool.getResource();
 247                 break;
 248                 // 哨兵
 249             case SENTINEL :
<abbr title=" 250                 jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig, timeout, password, Integer.parseInt(database));"> 250                 jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig,🔵</abbr>
 251                 jedis = jedisSentinelPool.getResource();
 252                 break;
 253                 // 集群
 254             case CLUSTER :
 255                 jedis = new JedisCluster(addresses, timeout, timeout, 1, poolConfig);
 256             default :
 257                 break;
 258         }
 259         return jedis;
 260     }
 261 
 262     private JedisCommands getJedisWithRetry(int retryNum) {
 263         while (retryNum-- &gt; 0) {
 264             try {
 265                 return getJedis(tableInfo);
 266             } catch (Exception e) {
 267                 if (retryNum &lt;= 0) {
 268                     throw new RuntimeException(&quot;getJedisWithRetry error&quot;, e);
 269                 }
 270                 try {
<abbr title=" 271                     String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,database:&quot; + tableInfo.getDatabase();"> 271                     String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + 🔵</abbr>
 272                     LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + jedisInfo);
 273                     Thread.sleep(LOAD_DATA_ERROR_SLEEP_TIME);
 274                 } catch (InterruptedException e1) {
 275                     LOG.error(&quot;&quot;, e1);
 276                 }
 277             }
 278         }
 279         return null;
 280     }
 281 
 282     private Set&lt;String&gt; getRedisKeys(RedisType redisType, JedisCommands jedis, String keyPattern){
 283         if(!redisType.equals(RedisType.CLUSTER)){
 284             return ((Jedis) jedis).keys(keyPattern);
 285         }
 286         Set&lt;String&gt; keys = new TreeSet&lt;&gt;();
 287         Map&lt;String, JedisPool&gt; clusterNodes = ((JedisCluster)jedis).getClusterNodes();
 288         for(String k : clusterNodes.keySet()){
 289             JedisPool jp = clusterNodes.get(k);
 290             Jedis connection = jp.getResource();
 291             try {
 292                 keys.addAll(connection.keys(keyPattern));
 293             } catch (Exception e){
 294                 LOG.error(&quot;Getting keys error: {}&quot;, e);
 295             } finally {
 296                 connection.close();
 297             }
 298         }
 299         return keys;
 300     }
 301 
 302     private GenericObjectPoolConfig setPoolConfig(String maxTotal, String maxIdle, String minIdle){
 303         GenericObjectPoolConfig config = new GenericObjectPoolConfig();
 304         if (maxTotal != null){
 305             config.setMaxTotal(Integer.parseInt(maxTotal));
 306         }
 307         if (maxIdle != null){
 308             config.setMaxIdle(Integer.parseInt(maxIdle));
 309         }
 310         if (minIdle != null){
 311             config.setMinIdle(Integer.parseInt(minIdle));
 312         }
 313         return config;
 314     }
 315 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.redis;
  20  
  21  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22  import com.dtstack.flink.sql.side.BaseAllReqRow;
  23  import com.dtstack.flink.sql.side.FieldInfo;
  24  import com.dtstack.flink.sql.side.JoinInfo;
  25  import com.dtstack.flink.sql.side.redis.enums.RedisType;
  26  import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  27  import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import com.dtstack.flink.sql.util.RowDataComplete;</span>
  29  import com.esotericsoftware.minlog.Log;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import com.google.common.collect.Maps;</span>
  31  import org.apache.calcite.sql.JoinType;
  32  import org.apache.commons.collections.CollectionUtils;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import org.apache.commons.collections.MapUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import org.apache.commons.lang.StringUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import org.apache.commons.lang3.StringUtils;</span>
  36  import org.apache.commons.pool2.impl.GenericObjectPoolConfig;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +import org.apache.flink.api.java.tuple.Tuple2;</span>
  38  import org.apache.flink.api.java.typeutils.RowTypeInfo;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import org.apache.flink.table.dataformat.BaseRow;</span>
  41  import org.apache.flink.types.Row;
  42  import org.apache.flink.util.Collector;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import com.google.common.collect.Maps;</span>
  44  import org.slf4j.Logger;
  45  import org.slf4j.LoggerFactory;
  46  import redis.clients.jedis.HostAndPort;
  47  import redis.clients.jedis.Jedis;
  48  import redis.clients.jedis.JedisCluster;
  49  import redis.clients.jedis.JedisCommands;
  50  import redis.clients.jedis.JedisPool;
  51  import redis.clients.jedis.JedisSentinelPool;
  52  
  53  import java.io.Closeable;
  54  import java.io.IOException;
  55  import java.sql.SQLException;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -</span>
  57  import java.util.Calendar;
  58  import java.util.HashSet;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +import java.util.LinkedList;</span>
  60  import java.util.List;
  61  import java.util.Map;
  62  import java.util.Set;
  63  import java.util.TreeSet;
  64  import java.util.concurrent.atomic.AtomicReference;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +import java.util.stream.Collectors;</span>
  66  /**
  67   * @author yanxi
  68   */
  69  public class RedisAllReqRow extends BaseAllReqRow {
  70  
  71      private static final long serialVersionUID = 7578879189085344807L;
  72  
  73      private static final Logger LOG = LoggerFactory.getLogger(RedisAllReqRow.class);
  74  
  75      private static final int CONN_RETRY_NUM = 3;
  76  
  77      private JedisPool pool;
  78  
  79      private JedisSentinelPool jedisSentinelPool;
  80  
  81      private RedisSideTableInfo tableInfo;
  82  
  83      private AtomicReference&lt;Map&lt;String, Map&lt;String, String&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  84  
  85      private RedisSideReqRow redisSideReqRow;
  86  
<abbr title="  87      public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  87      public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSi🔵</abbr>
  88          super(new RedisAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  89          this.redisSideReqRow = new RedisSideReqRow(super.sideInfo);

  90      }
  91  
  92      @Override
  93      public Row fillData(Row input, Object sideInput) {
  94          return redisSideReqRow.fillData(input, sideInput);
  95      }
  96  
  97      @Override
  98      protected void initCache() throws SQLException {
  99          tableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
 100          Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
 101          cacheRef.set(newCache);
 102          loadData(newCache);
 103      }
 104  
 105      @Override
 106      protected void reloadCache() {
 107          Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
 108          try {
 109              loadData(newCache);
 110          } catch (SQLException e) {
 111              LOG.error(&quot;&quot;, e);
 112              throw new RuntimeException(e);
 113          }
 114  
 115          cacheRef.set(newCache);
 116          LOG.info(&quot;----- Redis all cacheRef reload end:{}&quot;, Calendar.getInstance());
 117      }
 118  
 119      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -    public void flatMap(CRow input, Collector&lt;CRow&gt; out) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +    public void flatMap(Row input, Collector&lt;BaseRow&gt; out) throws Exception {</span>
 122          Map&lt;String, String&gt; inputParams = Maps.newHashMap();

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -        for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -            Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -            Object equalObj = input.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        for(Integer conValIndex : sideInfo.getEqualValIndex()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +            Object equalObj = input.getField(conValIndex);</span>
 128              if(equalObj == null){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -                if(sideInfo.getJoinType() == JoinType.LEFT){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -                    Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -                    out.collect(new CRow(data, input.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +                if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +                    Row data = fillData(input, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +                    RowDataComplete.collectRow(out, data);</span>
 135                  }
 136                  return;
 137              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -            inputParams.put(sideInfo.getEqualFieldList().get(i), equalObj.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +            String columnName = sideInfo.getEqualFieldList().get(conValIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +            inputParams.put(columnName, equalObj.toString());</span>
 141          }
 142          String key = buildCacheKey(inputParams);



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -        if(StringUtils.isBlank(key)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +        Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +        if (cacheMap == null){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +            if(sideInfo.getJoinType() == JoinType.LEFT){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +                Row data = fillData(input, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +                RowDataComplete.collectRow(out, data);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +            }else{</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +</span>
 155              return;
 156          }
 157  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -        Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -        if(MapUtils.isEmpty(cacheMap)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -            if(sideInfo.getJoinType() != JoinType.LEFT){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -            Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -            out.collect(new CRow(data, input.change()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -            return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -        Row newRow = fillData(input.row(), cacheMap);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -        out.collect(new CRow(newRow, input.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +        Row newRow = fillData(input, cacheMap);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +        RowDataComplete.collectRow(out, newRow);</span>
 172      }
 173  
 174      private String buildCacheKey(Map&lt;String, String&gt; refData) {
 175          StringBuilder keyBuilder = new StringBuilder(tableInfo.getTableName());
 176          List&lt;String&gt; primaryKeys = tableInfo.getPrimaryKeys();
 177          for(String primaryKey : primaryKeys){
 178              if(!refData.containsKey(primaryKey)){
 179                  return null;
 180              }
 181              keyBuilder.append(&quot;_&quot;).append(refData.get(primaryKey));
 182          }
 183          return keyBuilder.toString();
 184      }
 185  
 186  
 187      private void loadData(Map&lt;String, Map&lt;String, String&gt;&gt; tmpCache) throws SQLException {
 188          JedisCommands jedis = null;
 189          try {
 190              StringBuilder keyPattern = new StringBuilder(tableInfo.getTableName());
 191              for (String key : tableInfo.getPrimaryKeys()) {
 192                  keyPattern.append(&quot;_&quot;).append(&quot;*&quot;);
 193              }
 194              jedis = getJedisWithRetry(CONN_RETRY_NUM);
 195              if (null == jedis) {
 196                  throw new RuntimeException(&quot;redis all load data error,get jedis commands error!&quot;);
 197              }
<abbr title=" 198              Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.toString());"> 198              Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.toString(🔵</abbr>
 199              if (CollectionUtils.isEmpty(keys)) {
 200                  return;
 201              }
 202              for (String key : keys) {
 203                  tmpCache.put(key, jedis.hgetAll(key));
 204              }
 205          } finally {
 206              if (jedis != null) {
 207                  try {
 208                      ((Closeable) jedis).close();
 209                  } catch (IOException e) {
 210                      Log.error(&quot;&quot;, e);
 211                  }
 212              }
 213              if (jedisSentinelPool != null) {
 214                  jedisSentinelPool.close();
 215              }
 216              if (pool != null) {
 217                  pool.close();
 218              }
 219          }
 220      }
 221  
 222      private JedisCommands getJedis(RedisSideTableInfo tableInfo) {
 223          String url = tableInfo.getUrl();
 224          String password = tableInfo.getPassword();
 225          String database = tableInfo.getDatabase() == null ? &quot;0&quot; : tableInfo.getDatabase();
 226          int timeout = tableInfo.getTimeout();
 227          if (timeout == 0){
 228              timeout = 1000;
 229          }
 230  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -        String[] nodes = url.split(&quot;,&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -        String[] firstIpPort = nodes[0].split(&quot;:&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +        String[] nodes = StringUtils.split(url, &quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +        String[] firstIpPort = StringUtils.split(nodes[0], &quot;:&quot;);</span>
 235          String firstIp = firstIpPort[0];
 236          String firstPort = firstIpPort[1];
 237          Set&lt;HostAndPort&gt; addresses = new HashSet&lt;&gt;();
 238          Set&lt;String&gt; ipPorts = new HashSet&lt;&gt;();
 239          for (String ipPort : nodes) {
 240              ipPorts.add(ipPort);
 241              String[] ipPortPair = ipPort.split(&quot;:&quot;);
 242              addresses.add(new HostAndPort(ipPortPair[0].trim(), Integer.valueOf(ipPortPair[1].trim())));
 243          }
 244          if (timeout == 0){
 245              timeout = 1000;
 246          }
 247          JedisCommands jedis = null;
<abbr title=" 248          GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(), tableInfo.getMinIdle());"> 248          GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(), tableI🔵</abbr>
 249          switch (RedisType.parse(tableInfo.getRedisType())){
 250              //单机
 251              case STANDALONE:
<abbr title=" 252                  pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password, Integer.parseInt(database));"> 252                  pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password, Integer.🔵</abbr>
 253                  jedis = pool.getResource();
 254                  break;
 255              //哨兵
 256              case SENTINEL:
<abbr title=" 257                  jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig, timeout, password, Integer.parseInt(database));"> 257                  jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig, timeout,🔵</abbr>
 258                  jedis = jedisSentinelPool.getResource();
 259                  break;
 260              //集群
 261              case CLUSTER:
 262                  jedis = new JedisCluster(addresses, timeout, timeout,1, poolConfig);
 263              default:
 264                  break;
 265          }
 266  
 267          return jedis;
 268      }
 269  
 270      private JedisCommands getJedisWithRetry(int retryNum) {
 271          while (retryNum-- &gt; 0) {
 272              try {
 273                  return getJedis(tableInfo);
 274              } catch (Exception e) {
 275                  if (retryNum &lt;= 0) {
 276                      throw new RuntimeException(&quot;getJedisWithRetry error&quot;, e);
 277                  }
 278                  try {
<abbr title=" 279                      String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,database:&quot; + tableInfo.getDatabase();"> 279                      String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,databas🔵</abbr>
 280                      LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + jedisInfo);
 281                      Thread.sleep(LOAD_DATA_ERROR_SLEEP_TIME);
 282                  } catch (InterruptedException e1) {
 283                      LOG.error(&quot;&quot;, e1);
 284                  }
 285              }
 286          }
 287          return null;
 288      }
 289  
 290      private Set&lt;String&gt; getRedisKeys(RedisType redisType, JedisCommands jedis, String keyPattern){
 291          if(!redisType.equals(RedisType.CLUSTER)){
 292              return ((Jedis) jedis).keys(keyPattern);
 293          }
 294          Set&lt;String&gt; keys = new TreeSet&lt;&gt;();
 295          Map&lt;String, JedisPool&gt; clusterNodes = ((JedisCluster)jedis).getClusterNodes();
 296          for(String k : clusterNodes.keySet()){
 297              JedisPool jp = clusterNodes.get(k);
 298              Jedis connection = jp.getResource();
 299              try {
 300                  keys.addAll(connection.keys(keyPattern));
 301              } catch (Exception e){
 302                  LOG.error(&quot;Getting keys error: {}&quot;, e);
 303              } finally {
 304                  connection.close();
 305              }
 306          }
 307          return keys;
 308      }
 309  
 310      private GenericObjectPoolConfig setPoolConfig(String maxTotal, String maxIdle, String minIdle){
 311          GenericObjectPoolConfig config = new GenericObjectPoolConfig();
 312          if (maxTotal != null){
 313              config.setMaxTotal(Integer.parseInt(maxTotal));
 314          }
 315          if (maxIdle != null){
 316              config.setMaxIdle(Integer.parseInt(maxIdle));
 317          }
 318          if (minIdle != null){
 319              config.setMinIdle(Integer.parseInt(minIdle));
 320          }
 321          return config;
 322      }
 323  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.redis;
  20  
  21  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22  import com.dtstack.flink.sql.side.BaseAllReqRow;
  23  import com.dtstack.flink.sql.side.FieldInfo;
  24  import com.dtstack.flink.sql.side.JoinInfo;
  25  import com.dtstack.flink.sql.side.redis.enums.RedisType;
  26  import com.dtstack.flink.sql.side.redis.table.RedisSideReqRow;
  27  import com.dtstack.flink.sql.side.redis.table.RedisSideTableInfo;

  28  import com.esotericsoftware.minlog.Log;

  29  import org.apache.calcite.sql.JoinType;
  30  import org.apache.commons.collections.CollectionUtils;
  31  import org.apache.commons.collections.MapUtils;
  32  import org.apache.commons.lang.StringUtils;

  33  import org.apache.commons.pool2.impl.GenericObjectPoolConfig;

  34  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  35  import org.apache.flink.table.runtime.types.CRow;

  36  import org.apache.flink.types.Row;
  37  import org.apache.flink.util.Collector;
  38  import com.google.common.collect.Maps;
  39  import org.slf4j.Logger;
  40  import org.slf4j.LoggerFactory;
  41  import redis.clients.jedis.HostAndPort;
  42  import redis.clients.jedis.Jedis;
  43  import redis.clients.jedis.JedisCluster;
  44  import redis.clients.jedis.JedisCommands;
  45  import redis.clients.jedis.JedisPool;
  46  import redis.clients.jedis.JedisSentinelPool;
  47  
  48  import java.io.Closeable;
  49  import java.io.IOException;
  50  import java.sql.SQLException;
  51  
  52  import java.util.Calendar;
  53  import java.util.HashSet;

  54  import java.util.List;
  55  import java.util.Map;
  56  import java.util.Set;
  57  import java.util.TreeSet;
  58  import java.util.concurrent.atomic.AtomicReference;

  59  /**
  60   * @author yanxi
  61   */
  62  public class RedisAllReqRow extends BaseAllReqRow {
  63  
  64      private static final long serialVersionUID = 7578879189085344807L;
  65  
  66      private static final Logger LOG = LoggerFactory.getLogger(RedisAllReqRow.class);
  67  
  68      private static final int CONN_RETRY_NUM = 3;
  69  
  70      private JedisPool pool;
  71  
  72      private JedisSentinelPool jedisSentinelPool;
  73  
  74      private RedisSideTableInfo tableInfo;
  75  
  76      private AtomicReference&lt;Map&lt;String, Map&lt;String, String&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  77  
  78      private RedisSideReqRow redisSideReqRow;
  79  
<abbr title="  80      public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  80      public RedisAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSi🔵</abbr>
  81          super(new RedisAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -        this.redisSideReqRow = new RedisSideReqRow(super.sideInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +        this.redisSideReqRow = new RedisSideReqRow(super.sideInfo, (RedisSideTableInfo) sideTableInfo);</span>
  84      }
  85  
  86      @Override
  87      public Row fillData(Row input, Object sideInput) {
  88          return redisSideReqRow.fillData(input, sideInput);
  89      }
  90  
  91      @Override
  92      protected void initCache() throws SQLException {
  93          tableInfo = (RedisSideTableInfo) sideInfo.getSideTableInfo();
  94          Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
  95          cacheRef.set(newCache);
  96          loadData(newCache);
  97      }
  98  
  99      @Override
 100      protected void reloadCache() {
 101          Map&lt;String, Map&lt;String, String&gt;&gt; newCache = Maps.newConcurrentMap();
 102          try {
 103              loadData(newCache);
 104          } catch (SQLException e) {
 105              LOG.error(&quot;&quot;, e);
 106              throw new RuntimeException(e);
 107          }
 108  
 109          cacheRef.set(newCache);
 110          LOG.info(&quot;----- Redis all cacheRef reload end:{}&quot;, Calendar.getInstance());
 111      }
 112  
 113      @Override
 114      public void flatMap(CRow input, Collector&lt;CRow&gt; out) throws Exception {

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -        Map&lt;String, String&gt; inputParams = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +        Map&lt;String, Object&gt; inputParams = Maps.newHashMap();</span>
 117          for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {
 118              Integer conValIndex = sideInfo.getEqualValIndex().get(i);
 119              Object equalObj = input.row().getField(conValIndex);


 120              if(equalObj == null){
 121                  if(sideInfo.getJoinType() == JoinType.LEFT){
 122                      Row data = fillData(input.row(), null);
 123                      out.collect(new CRow(data, input.change()));



 124                  }
 125                  return;
 126              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -            inputParams.put(sideInfo.getEqualFieldList().get(i), equalObj.toString());</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -        String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +            inputParams.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +        String key = redisSideReqRow.buildCacheKey(inputParams);</span>
 133          if(StringUtils.isBlank(key)){











 134              return;
 135          }
 136  
 137          Map&lt;String, String&gt; cacheMap = cacheRef.get().get(key);
 138          if(MapUtils.isEmpty(cacheMap)){
 139              if(sideInfo.getJoinType() != JoinType.LEFT){
 140                  return;
 141              }
 142              Row data = fillData(input.row(), null);
 143              out.collect(new CRow(data, input.change()));
 144              return;
 145  
 146          }
 147          Row newRow = fillData(input.row(), cacheMap);
 148          out.collect(new CRow(newRow, input.change()));


 149      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -    private String buildCacheKey(Map&lt;String, String&gt; refData) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -        StringBuilder keyBuilder = new StringBuilder(tableInfo.getTableName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -        List&lt;String&gt; primaryKeys = tableInfo.getPrimaryKeys();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -        for(String primaryKey : primaryKeys){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -            if(!refData.containsKey(primaryKey)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -                return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -            keyBuilder.append(&quot;_&quot;).append(refData.get(primaryKey));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -        return keyBuilder.toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -</span>
 163  
 164      private void loadData(Map&lt;String, Map&lt;String, String&gt;&gt; tmpCache) throws SQLException {
 165          JedisCommands jedis = null;
 166          try {
 167              StringBuilder keyPattern = new StringBuilder(tableInfo.getTableName());
 168              for (String key : tableInfo.getPrimaryKeys()) {
 169                  keyPattern.append(&quot;_&quot;).append(&quot;*&quot;);
 170              }
 171              jedis = getJedisWithRetry(CONN_RETRY_NUM);
 172              if (null == jedis) {
 173                  throw new RuntimeException(&quot;redis all load data error,get jedis commands error!&quot;);
 174              }
<abbr title=" 175              Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.toString());"> 175              Set&lt;String&gt; keys = getRedisKeys(RedisType.parse(tableInfo.getRedisType()), jedis, keyPattern.toString(🔵</abbr>
 176              if (CollectionUtils.isEmpty(keys)) {
 177                  return;
 178              }
 179              for (String key : keys) {
 180                  tmpCache.put(key, jedis.hgetAll(key));
 181              }
 182          } finally {
 183              if (jedis != null) {
 184                  try {
 185                      ((Closeable) jedis).close();
 186                  } catch (IOException e) {
 187                      Log.error(&quot;&quot;, e);
 188                  }
 189              }
 190              if (jedisSentinelPool != null) {
 191                  jedisSentinelPool.close();
 192              }
 193              if (pool != null) {
 194                  pool.close();
 195              }
 196          }
 197      }
 198  
 199      private JedisCommands getJedis(RedisSideTableInfo tableInfo) {
 200          String url = tableInfo.getUrl();
 201          String password = tableInfo.getPassword();
 202          String database = tableInfo.getDatabase() == null ? &quot;0&quot; : tableInfo.getDatabase();
 203          int timeout = tableInfo.getTimeout();
 204          if (timeout == 0){
 205              timeout = 1000;
 206          }
 207  
 208          String[] nodes = url.split(&quot;,&quot;);
 209          String[] firstIpPort = nodes[0].split(&quot;:&quot;);


 210          String firstIp = firstIpPort[0];
 211          String firstPort = firstIpPort[1];
 212          Set&lt;HostAndPort&gt; addresses = new HashSet&lt;&gt;();
 213          Set&lt;String&gt; ipPorts = new HashSet&lt;&gt;();
 214          for (String ipPort : nodes) {
 215              ipPorts.add(ipPort);
 216              String[] ipPortPair = ipPort.split(&quot;:&quot;);
 217              addresses.add(new HostAndPort(ipPortPair[0].trim(), Integer.valueOf(ipPortPair[1].trim())));
 218          }
 219          if (timeout == 0){
 220              timeout = 1000;
 221          }
 222          JedisCommands jedis = null;
<abbr title=" 223          GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(), tableInfo.getMinIdle());"> 223          GenericObjectPoolConfig poolConfig = setPoolConfig(tableInfo.getMaxTotal(), tableInfo.getMaxIdle(), tableI🔵</abbr>
 224          switch (RedisType.parse(tableInfo.getRedisType())){
 225              //单机
 226              case STANDALONE:
<abbr title=" 227                  pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password, Integer.parseInt(database));"> 227                  pool = new JedisPool(poolConfig, firstIp, Integer.parseInt(firstPort), timeout, password, Integer.🔵</abbr>
 228                  jedis = pool.getResource();
 229                  break;
 230              //哨兵
 231              case SENTINEL:
<abbr title=" 232                  jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig, timeout, password, Integer.parseInt(database));"> 232                  jedisSentinelPool = new JedisSentinelPool(tableInfo.getMasterName(), ipPorts, poolConfig, timeout,🔵</abbr>
 233                  jedis = jedisSentinelPool.getResource();
 234                  break;
 235              //集群
 236              case CLUSTER:
 237                  jedis = new JedisCluster(addresses, timeout, timeout,1, poolConfig);
 238              default:
 239                  break;
 240          }
 241  
 242          return jedis;
 243      }
 244  
 245      private JedisCommands getJedisWithRetry(int retryNum) {
 246          while (retryNum-- &gt; 0) {
 247              try {
 248                  return getJedis(tableInfo);
 249              } catch (Exception e) {
 250                  if (retryNum &lt;= 0) {
 251                      throw new RuntimeException(&quot;getJedisWithRetry error&quot;, e);
 252                  }
 253                  try {
<abbr title=" 254                      String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,database:&quot; + tableInfo.getDatabase();"> 254                      String jedisInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;,pwd:&quot; + tableInfo.getPassword() + &quot;,databas🔵</abbr>
 255                      LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + jedisInfo);
 256                      Thread.sleep(LOAD_DATA_ERROR_SLEEP_TIME);
 257                  } catch (InterruptedException e1) {
 258                      LOG.error(&quot;&quot;, e1);
 259                  }
 260              }
 261          }
 262          return null;
 263      }
 264  
 265      private Set&lt;String&gt; getRedisKeys(RedisType redisType, JedisCommands jedis, String keyPattern){
 266          if(!redisType.equals(RedisType.CLUSTER)){
 267              return ((Jedis) jedis).keys(keyPattern);
 268          }
 269          Set&lt;String&gt; keys = new TreeSet&lt;&gt;();
 270          Map&lt;String, JedisPool&gt; clusterNodes = ((JedisCluster)jedis).getClusterNodes();
 271          for(String k : clusterNodes.keySet()){
 272              JedisPool jp = clusterNodes.get(k);
 273              Jedis connection = jp.getResource();
 274              try {
 275                  keys.addAll(connection.keys(keyPattern));
 276              } catch (Exception e){
 277                  LOG.error(&quot;Getting keys error: {}&quot;, e);
 278              } finally {
 279                  connection.close();
 280              }
 281          }
 282          return keys;
 283      }
 284  
 285      private GenericObjectPoolConfig setPoolConfig(String maxTotal, String maxIdle, String minIdle){
 286          GenericObjectPoolConfig config = new GenericObjectPoolConfig();
 287          if (maxTotal != null){
 288              config.setMaxTotal(Integer.parseInt(maxTotal));
 289          }
 290          if (maxIdle != null){
 291              config.setMaxIdle(Integer.parseInt(maxIdle));
 292          }
 293          if (minIdle != null){
 294              config.setMinIdle(Integer.parseInt(minIdle));
 295          }
 296          return config;
 297      }
 298  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            