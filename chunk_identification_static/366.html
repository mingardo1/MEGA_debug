<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>366</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    366
                    <a href="365.html">prev</a>
                    <a href="367.html">next</a>
                    <a href="366_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    EhsanTang/ApiManager_89d9ce2e8c22723ce04ffb9c91f9374eea57358f_api/src/main/java/cn/crap/controller/user/InterfaceController.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\EhsanTang\ApiManager show &quot;89d9ce2e8c22723ce04ffb9c91f9374eea57358f:api/src/main/java/cn/crap/controller/user/InterfaceController.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\EhsanTang\ApiManager show &quot;89d9ce2e8c22723ce04ffb9c91f9374eea57358f^1:api/src/main/java/cn/crap/controller/user/InterfaceController.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\EhsanTang\ApiManager show &quot;89d9ce2e8c22723ce04ffb9c91f9374eea57358f^2:api/src/main/java/cn/crap/controller/user/InterfaceController.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\EhsanTang\ApiManager show &quot;ae7b7af96578599840c94cd69d84013baa5297ba:api/src/main/java/cn/crap/controller/user/InterfaceController.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bs], [j]], subset: [[bs], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package cn.crap.controller.user;
   2 
   3 import cn.crap.adapter.InterfaceAdapter;
   4 import cn.crap.beans.Config;
   5 import cn.crap.dto.InterfaceDto;
   6 import cn.crap.dto.LoginInfoDto;
   7 import cn.crap.dto.ParamDto;
   8 import cn.crap.dto.SearchDto;
   9 import cn.crap.enu.InterfaceContentType;
  10 import cn.crap.enu.InterfaceStatus;
  11 import cn.crap.enu.MonitorType;
  12 import cn.crap.enu.MyError;
  13 import cn.crap.framework.JsonResult;
  14 import cn.crap.framework.MyException;
  15 import cn.crap.framework.base.BaseController;
  16 import cn.crap.framework.interceptor.AuthPassport;
  17 import cn.crap.model.Error;
  18 import cn.crap.model.InterfaceWithBLOBs;
  19 import cn.crap.model.Module;
  20 import cn.crap.model.Project;
  21 import cn.crap.query.ErrorQuery;
  22 import cn.crap.query.InterfaceQuery;
  23 import cn.crap.service.ErrorService;
  24 import cn.crap.service.ISearchService;
  25 import cn.crap.service.InterfaceService;
  26 import cn.crap.utils.*;
  27 import com.alibaba.fastjson.JSONArray;
  28 import org.springframework.beans.factory.annotation.Autowired;
  29 import org.springframework.stereotype.Controller;
  30 import org.springframework.util.Assert;
  31 import org.springframework.web.bind.annotation.ModelAttribute;
  32 import org.springframework.web.bind.annotation.RequestMapping;
  33 import org.springframework.web.bind.annotation.RequestParam;
  34 import org.springframework.web.bind.annotation.ResponseBody;
  35 
  36 import java.io.IOException;
  37 import java.util.HashMap;
  38 import java.util.List;
  39 import java.util.Map;
  40 
  41 @Controller
  42 @RequestMapping(&quot;/user/interface&quot;)
  43 public class InterfaceController extends BaseController{
  44 
  45 	@Autowired
  46 	private InterfaceService interfaceService;
  47 	@Autowired
  48 	private ISearchService luceneService;
  49 	@Autowired
  50 	private ErrorService errorService;
  51 
  52 	@RequestMapping(&quot;/list.do&quot;)
  53 	@ResponseBody
  54 	@AuthPassport
  55 	public JsonResult list(@ModelAttribute InterfaceQuery query, String url) throws MyException{
  56         Module module = getModule(query);
  57         Project project = getProject(query);
  58         checkPermission(project, READ);
  59 
  60 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61         InterfaceQuery interfaceQuery = query.setFullUrl(url);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62 		Page page= new Page(interfaceQuery);</span>
  63 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64 		InterfaceCriteria example = new InterfaceCriteria();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65 		InterfaceCriteria.Criteria criteria = example.createCriteria().andModuleIdEqualTo(moduleId);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66 		if (!MyString.isEmpty(interfaceName)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67 			criteria.andInterfaceNameLike(&quot;%&quot; + interfaceName + &quot;%&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69 		if (!MyString.isEmpty(url)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 			criteria.andFullUrlLike(&quot;%&quot; + url + &quot;%&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  73 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(example), null);">  73 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOB🔵</abbr></span>
  74 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75 		InterfaceCriteria example = new InterfaceCriteria();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76 		InterfaceCriteria.Criteria criteria = example.createCriteria().andModuleIdEqualTo(moduleId);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77 		if (!MyString.isEmpty(interfaceName)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78 			criteria.andInterfaceNameLike(&quot;%&quot; + interfaceName + &quot;%&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80 		if (!MyString.isEmpty(url)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81 			criteria.andFullUrlLike(&quot;%&quot; + url + &quot;%&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83 		example.setLimitStart(page.getStart());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84 		example.setMaxResults(page.getSize());</span>
  85 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  86 
<abbr title="  87 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module, project);">  87 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module,🔵</abbr>
  88 		page.setAllRow(interfaceService.count(interfaceQuery));
  89 		JsonResult result = new JsonResult(1, interfaces, page);
  90 		result.putOthers(&quot;module&quot;, module);
  91 
  92 		return result;
  93 		
  94 	}
  95 
  96 	@RequestMapping(&quot;/detail.do&quot;)
  97 	@ResponseBody
  98 	public JsonResult detail(String id, String moduleId, String projectId) throws MyException {
  99 		InterfaceWithBLOBs model;
 100 		Module module;
 101 		if(id != null){
 102 			model= interfaceService.getById(id);
 103 			module = moduleCache.get(model.getModuleId());
 104 		}else{
 105 			model = new InterfaceWithBLOBs();
 106 			module = moduleCache.get(moduleId);
 107 			model.setModuleId( moduleId);
 108 			model.setProjectId(module.getProjectId() == null ? projectId : module.getProjectId());
 109 			model.setResponseParam(&quot;[]&quot;);
 110 			model.setHeader(&quot;[]&quot;);
 111 			model.setParamRemark(&quot;[]&quot;);
 112             model.setErrors(&quot;[]&quot;);
 113             model.setMethod(IConst.C_METHOD_GET);
 114             model.setStatus(InterfaceStatus.ONLINE.getByteValue());
 115             model.setContentType(InterfaceContentType.JSON.getType());
 116             model.setParam(IConst.C_PARAM_FORM_PRE + &quot;[]&quot;);
 117 
 118             if(!MyString.isEmpty(module.getTemplateId())){
 119 				InterfaceWithBLOBs template = interfaceService.getById(module.getTemplateId());
 120 				// 根据模板初始化接口
 121 				if(template != null){
 122 					model.setHeader(template.getHeader());
 123 					model.setParam(template.getParam());
 124 					model.setMethod(template.getMethod());
 125 					model.setVersion(template.getVersion());
 126 					model.setParamRemark(template.getParamRemark());
 127 					model.setResponseParam(template.getResponseParam());
 128 					model.setErrorList(template.getErrorList());
 129 					model.setErrors(template.getErrors());
 130 					model.setFalseExam(template.getFalseExam());
 131 					model.setTrueExam(template.getTrueExam());
 132 					model.setStatus(template.getStatus());
 133 					model.setContentType(template.getContentType());
 134 				}
 135 			}
 136 		}
 137         checkPermission(model.getProjectId(), READ);
 138 		return new JsonResult(1, InterfaceAdapter.getDtoWithBLOBs(model, module, null, false));
 139 	}
 140 	
 141 	/**
 142 	 * @return
 143 	 * @throws MyException
 144 	 * @throws IOException
 145 	 */
 146 	@RequestMapping(&quot;/copy.do&quot;)
 147 	@ResponseBody
<abbr title=" 148 	public JsonResult copy(@RequestParam String id, String interfaceName, String url, String moduleId) throws MyException, IOException {"> 148 	public JsonResult copy(@RequestParam String id, String interfaceName, String url, String moduleId) throw🔵</abbr>
 149 		InterfaceWithBLOBs interFace = interfaceService.getById(id);
 150 
 151 		//判断是否拥有原来项目的权限
 152 		checkPermission(interFace.getProjectId(), READ);
 153         Project project = getProject(interFace.getProjectId(), moduleId);
 154         Module module = moduleCache.get(moduleId);
 155 		// 检查新项目的权限
 156         checkPermission(project, ADD_INTER);
 157 
 158 		if(!Config.canRepeatUrl){
<abbr title=" 159 			if (interfaceService.count(new InterfaceQuery().setModuleId(moduleId).setEqualFullUrl(module.getUrl() + interFace.getUrl())) &gt; 0){"> 159 			if (interfaceService.count(new InterfaceQuery().setModuleId(moduleId).setEqualFullUrl(module.getUrl() 🔵</abbr>
 160 				throw new MyException(MyError.E000004);
 161 			}
 162 		}
 163 
 164 		interFace.setId(null);
 165 		interFace.setUrl(url);
 166         interFace.setFullUrl((module.getUrl() == null ? &quot;&quot; : module.getUrl()) + url);
 167         interFace.setInterfaceName(interfaceName);
 168         interFace.setModuleId(moduleId);
 169         interFace.setProjectId(project.getId());
 170         interfaceService.insert(interFace);
 171 
 172         interFace.setId(interFace.getId());
 173 		luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 174 		return new JsonResult(1, interFace);
 175 	}
 176 
 177 	@RequestMapping(&quot;/addOrUpdate.do&quot;)
 178 	@ResponseBody
 179 	@AuthPassport
<abbr title=" 180 	public JsonResult addOrUpdate(@ModelAttribute InterfaceDto dto, String modifyRemark) throws IOException, MyException {"> 180 	public JsonResult addOrUpdate(@ModelAttribute InterfaceDto dto, String modifyRemark) throws IOException,🔵</abbr>
 181 		Assert.notNull(dto.getProjectId(), &quot;projectId can&#x27;t be null&quot;);
 182         Assert.notNull(dto.getUrl(), &quot;url can&#x27;t be null&quot;);
 183 
 184         String id = dto.getId();
 185         Module module = moduleCache.get(dto.getModuleId());
 186         String newProjectId = getProjectId(dto.getProjectId(), dto.getModuleId());
 187         dto.setProjectId(newProjectId);
 188 		dto.setUrl(dto.getUrl().trim());
 189         dto.setFullUrl(module.getUrl() + dto.getUrl());
 190 
 191         if (C_PARAM_FORM.equals(dto.getParamType())){
 192 		    dto.setParam(C_PARAM_FORM_PRE + dto.getParam());
 193         }
 194 		
 195 		/**
 196 		 * 根据选着的错误码id，组装json字符串
 197 		 */
<abbr title=" 198         ErrorQuery query = new ErrorQuery().setProjectId(newProjectId).setErrorCodeList(Tools.getIdsFromField(dto.getErrorList())).setPageSize(100);"> 198         ErrorQuery query = new ErrorQuery().setProjectId(newProjectId).setErrorCodeList(Tools.getIdsFromF🔵</abbr>
 199         List&lt;Error&gt; errors  = errorService.query(query);
 200 		dto.setErrors(JSONArray.toJSONString(errors));
 201 
 202 		LoginInfoDto user = LoginUserHelper.getUser();
 203 		dto.setUpdateBy(&quot;userName：&quot;+user.getUserName()+&quot; | trueName：&quot;+ user.getTrueName());
 204         dto.setMonitorType(MonitorType.No.getValue());
 205         InterfaceWithBLOBs interFace = InterfaceAdapter.getModel(dto);
 206         if (id != null) {
 207 			String oldProjectId = interfaceService.getById(interFace.getId()).getProjectId();
 208 			// 判断是否有修改模块的权限
 209 			checkPermission(oldProjectId, READ);
 210             checkPermission(newProjectId, MOD_INTER);
 211 
 212 			//同一模块下不允许 url 重复
<abbr title=" 213             InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(interFace.getFullUrl()).setExceptId(interFace.getId());"> 213             InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(in🔵</abbr>
 214 			if( !Config.canRepeatUrl &amp;&amp; interfaceService.count(interfaceQuery) &gt;0 ){
 215 				throw new MyException(MyError.E000004);
 216 			}
 217 			
 218 			interfaceService.update(interFace, &quot;接口&quot;, modifyRemark);
 219 		} else {
 220 			checkPermission(interFace.getProjectId(), ADD_INTER);
<abbr title=" 221             InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(interFace.getFullUrl());"> 221             InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(in🔵</abbr>
 222 			if(!Config.canRepeatUrl &amp;&amp; interfaceService.count(interfaceQuery)&gt;0){
 223 				return new JsonResult(MyError.E000004);
 224 			}
 225 			interfaceService.insert(interFace);
 226 			id = interFace.getId();
 227 		}
 228 
 229         luceneService.update(InterfaceAdapter.getSearchDto(interfaceService.getById(id)));
 230         return new JsonResult(1, interFace);
 231 	}
 232 
 233 
 234 	@RequestMapping(&quot;/debug.do&quot;)
 235 	@ResponseBody
 236 	@AuthPassport
 237 	public JsonResult debug(@ModelAttribute InterfaceDto interFace) throws IOException, Exception {
 238 		Assert.notNull(interFace.getMethod(), &quot;请求方法不能为空&quot;);
 239 		Assert.notNull(interFace.getFullUrl(), &quot;地址不能为空&quot;);
 240         Assert.isTrue(interFace.getFullUrl().startsWith(&quot;http&quot;), &quot;地址必须以 http开头&quot;);
 241 
 242         String fullUrl = interFace.getFullUrl();
 243 
<abbr title=" 244 		List&lt;ParamDto&gt; headerList = JSONArray.parseArray(interFace.getHeader() == null ? &quot;[]&quot; : interFace.getHeader(), ParamDto.class);"> 244 		List&lt;ParamDto&gt; headerList = JSONArray.parseArray(interFace.getHeader() == null ? &quot;[]&quot; : interFace.getHe🔵</abbr>
 245 
 246         Map&lt;String, String&gt; httpHeaders = new HashMap&lt;&gt;();
 247         for (ParamDto paramDto : headerList) {
 248             httpHeaders.put(paramDto.getName(), paramDto.getDef());
 249         }
 250         // 如果自定义参数不为空，则表示需要使用post发送自定义包体
 251         if (C_PARAM_RAW.equals(interFace.getParamType())) {
<abbr title=" 252             return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.postBody(fullUrl, interFace.getParam(), httpHeaders)));"> 252             return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.postBody(fullUrl, interFace.🔵</abbr>
 253         }
 254 
<abbr title=" 255         List&lt;ParamDto&gt; paramList = JSONArray.parseArray(interFace.getParam() == null ? &quot;[]&quot; : interFace.getParam(), ParamDto.class);"> 255         List&lt;ParamDto&gt; paramList = JSONArray.parseArray(interFace.getParam() == null ? &quot;[]&quot; : interFace.g🔵</abbr>
 256 
 257 
 258         Map&lt;String, String&gt; httpParams = new HashMap&lt;&gt;();
 259         for (ParamDto paramDto : paramList) {
 260             if (fullUrl.contains(&quot;{&quot; + paramDto.getRealName() + &quot;}&quot;)) {
 261                 fullUrl = fullUrl.replace(&quot;{&quot; + paramDto.getName() + &quot;}&quot;, paramDto.getDef());
 262             } else {
 263                 httpParams.put(paramDto.getName(), paramDto.getDef());
 264             }
 265         }
 266         try {
 267             switch (interFace.getMethod()) {
 268                 case &quot;POST&quot;:
<abbr title=" 269                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.post(fullUrl, httpParams, httpHeaders)));"> 269                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.post(fullUrl, httpPa🔵</abbr>
 270                 case &quot;GET&quot;:
<abbr title=" 271                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.get(fullUrl, httpParams, httpHeaders)));"> 271                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.get(fullUrl, httpPar🔵</abbr>
 272                 case &quot;PUT&quot;:
<abbr title=" 273                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.put(fullUrl, httpParams, httpHeaders)));"> 273                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.put(fullUrl, httpPar🔵</abbr>
 274                 case &quot;DELETE&quot;:
<abbr title=" 275                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.delete(fullUrl, httpParams, httpHeaders)));"> 275                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.delete(fullUrl, http🔵</abbr>
 276                 case &quot;HEAD&quot;:
<abbr title=" 277                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.head(fullUrl, httpParams, httpHeaders)));"> 277                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.head(fullUrl, httpPa🔵</abbr>
 278                 case &quot;OPTIONS&quot;:
<abbr title=" 279                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.options(fullUrl, httpParams, httpHeaders)));"> 279                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.options(fullUrl, htt🔵</abbr>
 280                 case &quot;TRACE&quot;:
<abbr title=" 281                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.trace(fullUrl, httpParams, httpHeaders)));"> 281                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.trace(fullUrl, httpP🔵</abbr>
 282 				case &quot;PATCH&quot;:
<abbr title=" 283 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.patch(fullUrl, httpParams, httpHeaders)));"> 283 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.patch(fullUrl, httpParams, httpHead🔵</abbr>
 284                 default:
<abbr title=" 285                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, &quot;不支持的请求方法：&quot; + interFace.getMethod()));"> 285                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, &quot;不支持的请求方法：&quot; + interFace.getMetho🔵</abbr>
 286             }
 287         } catch (Exception e) {
 288             e.printStackTrace();
 289             return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, &quot;调试出错\r\nmessage:&quot; + e.getMessage()));
 290         }
 291 
 292 	}
 293 
 294 	@RequestMapping(&quot;/delete.do&quot;)
 295 	@ResponseBody
 296 	public JsonResult delete(String id, String ids) throws MyException, IOException{
 297 		if( MyString.isEmpty(id) &amp;&amp; MyString.isEmpty(ids)){
 298 			throw new MyException(MyError.E000029);
 299 		}
 300 		if( MyString.isEmpty(ids) ){
 301 			ids = id;
 302 		}
 303 		
 304 		for(String tempId : ids.split(&quot;,&quot;)){
 305 			if(MyString.isEmpty(tempId)){
 306 				continue;
 307 			}
 308 			InterfaceWithBLOBs interFace = interfaceService.getById( tempId );
 309 			checkPermission(interFace.getProjectId(), DEL_INTER);
 310 
 311             luceneService.delete(new SearchDto(interFace.getId()));
 312 			interfaceService.delete(interFace.getId(), &quot;接口&quot;, &quot;&quot;);
 313 		}
 314 		return new JsonResult(1, null);
 315 	}
 316 
 317 	@RequestMapping(&quot;/changeSequence.do&quot;)
 318 	@ResponseBody
<abbr title=" 319 	public JsonResult changeSequence(@RequestParam String id,@RequestParam String changeId) throws MyException {"> 319 	public JsonResult changeSequence(@RequestParam String id,@RequestParam String changeId) throws MyExcepti🔵</abbr>
 320 		InterfaceWithBLOBs change = interfaceService.getById(changeId);
 321 		InterfaceWithBLOBs model = interfaceService.getById(id);
 322 		checkPermission(model.getProjectId(), MOD_INTER);
 323 		checkPermission(change.getProjectId(), MOD_INTER);
 324 		
 325 		int modelSequence = model.getSequence();
 326 		
 327 		model.setSequence(change.getSequence());
 328 		change.setSequence(modelSequence);
 329 
 330 		interfaceService.update(model);
 331 		interfaceService.update(change);
 332 		return new JsonResult(1, null);
 333 	}
 334 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package cn.crap.controller.user;
   2 
   3 import cn.crap.adapter.InterfaceAdapter;
   4 import cn.crap.dto.InterfaceDto;
   5 import cn.crap.dto.LoginInfoDto;
   6 import cn.crap.dto.ParamDto;
   7 import cn.crap.dto.SearchDto;
   8 import cn.crap.enu.InterfaceContentType;
   9 import cn.crap.enu.InterfaceStatus;
  10 import cn.crap.enu.MonitorType;
  11 import cn.crap.enu.MyError;
  12 import cn.crap.framework.JsonResult;
  13 import cn.crap.framework.MyException;
  14 import cn.crap.framework.base.BaseController;
  15 import cn.crap.framework.interceptor.AuthPassport;
  16 import cn.crap.model.Error;
  17 import cn.crap.model.InterfaceWithBLOBs;
  18 import cn.crap.model.Module;
  19 import cn.crap.model.Project;
  20 import cn.crap.query.ErrorQuery;
  21 import cn.crap.query.InterfaceQuery;
  22 import cn.crap.service.ErrorService;
  23 import cn.crap.service.ISearchService;
  24 import cn.crap.service.InterfaceService;
  25 import cn.crap.beans.Config;
  26 import cn.crap.utils.*;
  27 import com.alibaba.fastjson.JSONArray;
  28 import org.springframework.beans.factory.annotation.Autowired;
  29 import org.springframework.stereotype.Controller;
  30 import org.springframework.util.Assert;
  31 import org.springframework.web.bind.annotation.ModelAttribute;
  32 import org.springframework.web.bind.annotation.RequestMapping;
  33 import org.springframework.web.bind.annotation.RequestParam;
  34 import org.springframework.web.bind.annotation.ResponseBody;
  35 
  36 import java.io.IOException;
  37 import java.util.HashMap;
  38 import java.util.List;
  39 import java.util.Map;
  40 
  41 @Controller
  42 @RequestMapping(&quot;/user/interface&quot;)
  43 public class InterfaceController extends BaseController{
  44 
  45 	@Autowired
  46 	private InterfaceService interfaceService;
  47 	@Autowired
  48 	private ISearchService luceneService;
  49 	@Autowired
  50 	private ErrorService errorService;
  51 
  52 	@RequestMapping(&quot;/list.do&quot;)
  53 	@ResponseBody
  54 	@AuthPassport
  55 	public JsonResult list(@ModelAttribute InterfaceQuery query, String url) throws MyException{
  56         Module module = getModule(query);
  57         Project project = getProject(query);
  58         checkPermission(project, READ);
  59 
  60         InterfaceQuery interfaceQuery = query.setFullUrl(url);
  61 		Page page= new Page(interfaceQuery);
  62 
<abbr title="  63 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module, project);">  63 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module,🔵</abbr>
  64 		page.setAllRow(interfaceService.count(interfaceQuery));
  65 		JsonResult result = new JsonResult(1, interfaces, page);
  66 		result.putOthers(&quot;module&quot;, module);
  67 
  68 		return result;
  69 
  70 	}
  71 
  72 	@RequestMapping(&quot;/detail.do&quot;)
  73 	@ResponseBody
  74 	public JsonResult detail(String id, String moduleId, String projectId) throws MyException {
  75 		InterfaceWithBLOBs model;
  76 		Module module;
  77 		if(id != null){
  78 			model= interfaceService.getById(id);
  79 			module = moduleCache.get(model.getModuleId());
  80 		}else{
  81 			model = new InterfaceWithBLOBs();
  82 			module = moduleCache.get(moduleId);
  83 			model.setModuleId( moduleId);
  84 			model.setProjectId(module.getProjectId() == null ? projectId : module.getProjectId());
  85 			model.setResponseParam(&quot;[]&quot;);
  86 			model.setHeader(&quot;[]&quot;);
  87 			model.setParamRemark(&quot;[]&quot;);
  88             model.setErrors(&quot;[]&quot;);
  89             model.setMethod(IConst.C_METHOD_GET);
  90             model.setStatus(InterfaceStatus.ONLINE.getByteValue());
  91             model.setContentType(InterfaceContentType.JSON.getType());
  92             model.setParam(IConst.C_PARAM_FORM_PRE + &quot;[]&quot;);
  93 
  94 			if(!MyString.isEmpty(module.getTemplateId())){
  95 				InterfaceWithBLOBs template = interfaceService.getById(module.getTemplateId());
  96 				// 根据模板初始化接口
  97 				if(template != null){
  98 					model.setHeader(template.getHeader());
  99 					model.setParam(template.getParam());
 100 					model.setMethod(template.getMethod());
 101 					model.setVersion(template.getVersion());
 102 					model.setParamRemark(template.getParamRemark());
 103 					model.setResponseParam(template.getResponseParam());
 104 					model.setErrorList(template.getErrorList());
 105 					model.setErrors(template.getErrors());
 106 					model.setFalseExam(template.getFalseExam());
 107 					model.setTrueExam(template.getTrueExam());
 108 					model.setStatus(template.getStatus());
 109 					model.setContentType(template.getContentType());
 110 				}
 111 			}
 112 		}
 113         checkPermission(model.getProjectId(), READ);
 114 		return new JsonResult(1, InterfaceAdapter.getDtoWithBLOBs(model, module, null, false));
 115 	}
 116 
 117 	/**
 118 	 * @return
 119 	 * @throws MyException
 120 	 * @throws IOException
 121 	 */
 122 	@RequestMapping(&quot;/copy.do&quot;)
 123 	@ResponseBody
<abbr title=" 124 	public JsonResult copy(@RequestParam String id, String interfaceName, String url, String moduleId) throws MyException, IOException {"> 124 	public JsonResult copy(@RequestParam String id, String interfaceName, String url, String moduleId) throw🔵</abbr>
 125 		InterfaceWithBLOBs interFace = interfaceService.getById(id);
 126 
 127 		//判断是否拥有原来项目的权限
 128 		checkPermission(interFace.getProjectId(), READ);
 129         Project project = getProject(interFace.getProjectId(), moduleId);
 130         Module module = moduleCache.get(moduleId);
 131 		// 检查新项目的权限
 132         checkPermission(project, ADD_INTER);
 133 
 134 		if(!Config.canRepeatUrl){
<abbr title=" 135 			if (interfaceService.count(new InterfaceQuery().setModuleId(moduleId).setEqualFullUrl(module.getUrl() + interFace.getUrl())) &gt; 0){"> 135 			if (interfaceService.count(new InterfaceQuery().setModuleId(moduleId).setEqualFullUrl(module.getUrl() 🔵</abbr>
 136 				throw new MyException(MyError.E000004);
 137 			}
 138 		}
 139 
 140 		interFace.setId(null);
 141 		interFace.setUrl(url);
 142         interFace.setFullUrl((module.getUrl() == null ? &quot;&quot; : module.getUrl()) + url);
 143         interFace.setInterfaceName(interfaceName);
 144         interFace.setModuleId(moduleId);
 145         interFace.setProjectId(project.getId());
 146         interfaceService.insert(interFace);
 147 
 148         interFace.setId(interFace.getId());
 149 		luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 150 		return new JsonResult(1, interFace);
 151 	}
 152 
 153 	@RequestMapping(&quot;/addOrUpdate.do&quot;)
 154 	@ResponseBody
 155 	@AuthPassport
<abbr title=" 156 	public JsonResult addOrUpdate(@ModelAttribute InterfaceDto dto, String modifyRemark) throws IOException, MyException {"> 156 	public JsonResult addOrUpdate(@ModelAttribute InterfaceDto dto, String modifyRemark) throws IOException,🔵</abbr>
 157 		Assert.notNull(dto.getProjectId(), &quot;projectId can&#x27;t be null&quot;);
 158         Assert.notNull(dto.getUrl(), &quot;url can&#x27;t be null&quot;);
 159 
 160         String id = dto.getId();
 161         Module module = moduleCache.get(dto.getModuleId());
 162         String newProjectId = getProjectId(dto.getProjectId(), dto.getModuleId());
 163         dto.setProjectId(newProjectId);
 164 		dto.setUrl(dto.getUrl().trim());
 165         dto.setFullUrl(module.getUrl() + dto.getUrl());
 166 
 167         if (C_PARAM_FORM.equals(dto.getParamType())){
 168 		    dto.setParam(C_PARAM_FORM_PRE + dto.getParam());
 169         }
 170 
 171 		/**
 172 		 * 根据选着的错误码id，组装json字符串
 173 		 */
<abbr title=" 174         ErrorQuery query = new ErrorQuery().setProjectId(newProjectId).setErrorCodeList(Tools.getIdsFromField(dto.getErrorList())).setPageSize(100);"> 174         ErrorQuery query = new ErrorQuery().setProjectId(newProjectId).setErrorCodeList(Tools.getIdsFromF🔵</abbr>
 175         List&lt;Error&gt; errors  = errorService.query(query);
 176 		dto.setErrors(JSONArray.toJSONString(errors));
 177 
 178 		LoginInfoDto user = LoginUserHelper.getUser();
 179 		dto.setUpdateBy(&quot;userName：&quot;+user.getUserName()+&quot; | trueName：&quot;+ user.getTrueName());
 180         dto.setMonitorType(MonitorType.No.getValue());
 181         InterfaceWithBLOBs interFace = InterfaceAdapter.getModel(dto);
 182         if (id != null) {
 183 			String oldProjectId = interfaceService.getById(interFace.getId()).getProjectId();
 184 			// 判断是否有修改模块的权限
 185 			checkPermission(oldProjectId, READ);
 186             checkPermission(newProjectId, MOD_INTER);
 187 
 188 			//同一模块下不允许 url 重复
<abbr title=" 189             InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(interFace.getFullUrl()).setExceptId(interFace.getId());"> 189             InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(in🔵</abbr>
 190 			if( !Config.canRepeatUrl &amp;&amp; interfaceService.count(interfaceQuery) &gt;0 ){
 191 				throw new MyException(MyError.E000004);
 192 			}
 193 
 194 			interfaceService.update(interFace, &quot;接口&quot;, modifyRemark);
 195 		} else {
 196 			checkPermission(interFace.getProjectId(), ADD_INTER);
<abbr title=" 197             InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(interFace.getFullUrl());"> 197             InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(in🔵</abbr>
 198 			if(!Config.canRepeatUrl &amp;&amp; interfaceService.count(interfaceQuery)&gt;0){
 199 				return new JsonResult(MyError.E000004);
 200 			}
 201 			interfaceService.insert(interFace);
 202 			id = interFace.getId();
 203 		}
 204 
 205         luceneService.update(InterfaceAdapter.getSearchDto(interfaceService.getById(id)));
 206         return new JsonResult(1, interFace);
 207 	}
 208 
 209 
 210 	@RequestMapping(&quot;/debug.do&quot;)
 211 	@ResponseBody
 212 	@AuthPassport
 213 	public JsonResult debug(@ModelAttribute InterfaceDto interFace) throws IOException, Exception {
 214 		Assert.notNull(interFace.getMethod(), &quot;请求方法不能为空&quot;);
 215 		Assert.notNull(interFace.getFullUrl(), &quot;地址不能为空&quot;);
 216         Assert.isTrue(interFace.getFullUrl().startsWith(&quot;http&quot;), &quot;地址必须以 http开头&quot;);
 217 
 218         String fullUrl = interFace.getFullUrl();
 219 
<abbr title=" 220 		List&lt;ParamDto&gt; headerList = JSONArray.parseArray(interFace.getHeader() == null ? &quot;[]&quot; : interFace.getHeader(), ParamDto.class);"> 220 		List&lt;ParamDto&gt; headerList = JSONArray.parseArray(interFace.getHeader() == null ? &quot;[]&quot; : interFace.getHe🔵</abbr>
 221 
 222         Map&lt;String, String&gt; httpHeaders = new HashMap&lt;&gt;();
 223         for (ParamDto paramDto : headerList) {
 224             httpHeaders.put(paramDto.getName(), paramDto.getDef());
 225         }
 226         // 如果自定义参数不为空，则表示需要使用post发送自定义包体
 227         if (C_PARAM_RAW.equals(interFace.getParamType())) {
<abbr title=" 228             return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.postBody(fullUrl, interFace.getParam(), httpHeaders)));"> 228             return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.postBody(fullUrl, interFace.🔵</abbr>
 229         }
 230 
<abbr title=" 231         List&lt;ParamDto&gt; paramList = JSONArray.parseArray(interFace.getParam() == null ? &quot;[]&quot; : interFace.getParam(), ParamDto.class);"> 231         List&lt;ParamDto&gt; paramList = JSONArray.parseArray(interFace.getParam() == null ? &quot;[]&quot; : interFace.g🔵</abbr>
 232 
 233 
 234         Map&lt;String, String&gt; httpParams = new HashMap&lt;&gt;();
 235         for (ParamDto paramDto : paramList) {
 236             if (fullUrl.contains(&quot;{&quot; + paramDto.getRealName() + &quot;}&quot;)) {
 237                 fullUrl = fullUrl.replace(&quot;{&quot; + paramDto.getName() + &quot;}&quot;, paramDto.getDef());
 238             } else {
 239                 httpParams.put(paramDto.getName(), paramDto.getDef());
 240             }
 241         }
 242         try {
 243             switch (interFace.getMethod()) {
 244                 case &quot;POST&quot;:
<abbr title=" 245                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.post(fullUrl, httpParams, httpHeaders)));"> 245                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.post(fullUrl, httpPa🔵</abbr>
 246                 case &quot;GET&quot;:
<abbr title=" 247                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.get(fullUrl, httpParams, httpHeaders)));"> 247                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.get(fullUrl, httpPar🔵</abbr>
 248                 case &quot;PUT&quot;:
<abbr title=" 249                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.put(fullUrl, httpParams, httpHeaders)));"> 249                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.put(fullUrl, httpPar🔵</abbr>
 250                 case &quot;DELETE&quot;:
<abbr title=" 251                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.delete(fullUrl, httpParams, httpHeaders)));"> 251                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.delete(fullUrl, http🔵</abbr>
 252                 case &quot;HEAD&quot;:
<abbr title=" 253                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.head(fullUrl, httpParams, httpHeaders)));"> 253                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.head(fullUrl, httpPa🔵</abbr>
 254                 case &quot;OPTIONS&quot;:
<abbr title=" 255                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.options(fullUrl, httpParams, httpHeaders)));"> 255                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.options(fullUrl, htt🔵</abbr>
 256                 case &quot;TRACE&quot;:
<abbr title=" 257                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.trace(fullUrl, httpParams, httpHeaders)));"> 257                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.trace(fullUrl, httpP🔵</abbr>
 258 				case &quot;PATCH&quot;:
<abbr title=" 259 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.patch(fullUrl, httpParams, httpHeaders)));"> 259 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.patch(fullUrl, httpParams, httpHead🔵</abbr>
 260                 default:
<abbr title=" 261                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, &quot;不支持的请求方法：&quot; + interFace.getMethod()));"> 261                     return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, &quot;不支持的请求方法：&quot; + interFace.getMetho🔵</abbr>
 262             }
 263         } catch (Exception e) {
 264             e.printStackTrace();
 265             return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, &quot;调试出错\r\nmessage:&quot; + e.getMessage()));
 266         }
 267 
 268 	}
 269 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 270 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271 @RequestMapping(&quot;/list.do&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272 	@ResponseBody</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273 	@AuthPassport</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274 	public JsonResult list(@RequestParam String moduleId, String interfaceName, String url,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275 			 Integer currentPage) throws MyException{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276 		Page page= new Page(currentPage);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277 		checkUserPermissionByModuleId(moduleId, VIEW);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279 		InterfaceCriteria example = new InterfaceCriteria();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280 		InterfaceCriteria.Criteria criteria = example.createCriteria().andModuleIdEqualTo(moduleId);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281 		if (!MyString.isEmpty(interfaceName)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282 			criteria.andInterfaceNameLike(&quot;%&quot; + interfaceName + &quot;%&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284 		if (!MyString.isEmpty(url)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285 			criteria.andFullUrlLike(&quot;%&quot; + url + &quot;%&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 288 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(example), null);"> 288 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOB🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289         page.setAllRow(mybatisInterfaceService.countByExample(example));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290 		JsonResult result = new JsonResult(1, interfaces, page);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291 		result.putOthers(&quot;crumbs&quot;, Tools.getCrumbs(&quot;接口列表:&quot;+ moduleCache.get(moduleId).getName(),&quot;void&quot;))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292 				.putOthers(&quot;module&quot;, moduleCache.get(moduleId));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294 		return result;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296 	}</span>
 297 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298 @RequestMapping(&quot;/list.do&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299 	@ResponseBody</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300 	@AuthPassport</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301 	public JsonResult list(@RequestParam String moduleId, String interfaceName, String url,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302 			 Integer currentPage) throws MyException{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303 		Page page= new Page(currentPage);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304 		checkUserPermissionByModuleId(moduleId, VIEW);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306 		InterfaceCriteria example = new InterfaceCriteria();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307 		InterfaceCriteria.Criteria criteria = example.createCriteria().andModuleIdEqualTo(moduleId);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308 		if (!MyString.isEmpty(interfaceName)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309 			criteria.andInterfaceNameLike(&quot;%&quot; + interfaceName + &quot;%&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311 		if (!MyString.isEmpty(url)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312 			criteria.andFullUrlLike(&quot;%&quot; + url + &quot;%&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314 		example.setLimitStart(page.getStart());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315 		example.setMaxResults(page.getSize());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 317 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(example), null);"> 317 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOB🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318         page.setAllRow(mybatisInterfaceService.countByExample(example));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319 		JsonResult result = new JsonResult(1, interfaces, page);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320 		result.putOthers(&quot;crumbs&quot;, Tools.getCrumbs(&quot;接口列表:&quot;+ moduleCache.get(moduleId).getName(),&quot;void&quot;))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321 				.putOthers(&quot;module&quot;, moduleCache.get(moduleId));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323 		return result;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325 	}</span>
 326 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 327 
 328 
 329 	@RequestMapping(&quot;/delete.do&quot;)
 330 	@ResponseBody
 331 	public JsonResult delete(String id, String ids) throws MyException, IOException{
 332 		if( MyString.isEmpty(id) &amp;&amp; MyString.isEmpty(ids)){
 333 			throw new MyException(MyError.E000029);
 334 		}
 335 		if( MyString.isEmpty(ids) ){
 336 			ids = id;
 337 		}
 338 
 339 		for(String tempId : ids.split(&quot;,&quot;)){
 340 			if(MyString.isEmpty(tempId)){
 341 				continue;
 342 			}
 343 			InterfaceWithBLOBs interFace = interfaceService.getById( tempId );
 344 			checkPermission(interFace.getProjectId(), DEL_INTER);
 345 
 346 			luceneService.delete(new SearchDto(interFace.getId()));
 347 			interfaceService.delete(interFace.getId(), &quot;接口&quot;, &quot;&quot;);
 348 		}
 349 		return new JsonResult(1, null);
 350 	}
 351 
 352 	@RequestMapping(&quot;/changeSequence.do&quot;)
 353 	@ResponseBody
<abbr title=" 354 	public JsonResult changeSequence(@RequestParam String id,@RequestParam String changeId) throws MyException {"> 354 	public JsonResult changeSequence(@RequestParam String id,@RequestParam String changeId) throws MyExcepti🔵</abbr>
 355 		InterfaceWithBLOBs change = interfaceService.getById(changeId);
 356 		InterfaceWithBLOBs model = interfaceService.getById(id);
 357 		checkPermission(model.getProjectId(), MOD_INTER);
 358 		checkPermission(change.getProjectId(), MOD_INTER);
 359 
 360 		int modelSequence = model.getSequence();
 361 
 362 		model.setSequence(change.getSequence());
 363 		change.setSequence(modelSequence);
 364 
 365 		interfaceService.update(model);
 366 		interfaceService.update(change);
 367 		return new JsonResult(1, null);
 368 	}
 369 }</pre></td>
                            <td><pre>   1 package cn.crap.controller.user;
   2 
   3 import cn.crap.adapter.InterfaceAdapter;
   4 import cn.crap.beans.Config;
   5 import cn.crap.dto.InterfaceDto;
   6 import cn.crap.dto.LoginInfoDto;
   7 import cn.crap.dto.ParamDto;
   8 import cn.crap.dto.SearchDto;
   9 import cn.crap.enu.InterfaceContentType;
  10 import cn.crap.enu.InterfaceStatus;
  11 import cn.crap.enu.MonitorType;
  12 import cn.crap.enu.MyError;
  13 import cn.crap.framework.JsonResult;
  14 import cn.crap.framework.MyException;
  15 import cn.crap.framework.base.BaseController;
  16 import cn.crap.framework.interceptor.AuthPassport;
  17 import cn.crap.model.Error;
  18 import cn.crap.model.InterfaceWithBLOBs;
  19 import cn.crap.model.Module;
  20 import cn.crap.model.Project;
  21 import cn.crap.query.ErrorQuery;
  22 import cn.crap.query.InterfaceQuery;
  23 import cn.crap.service.ErrorService;
  24 import cn.crap.service.ISearchService;
  25 import cn.crap.service.InterfaceService;
  26 import cn.crap.utils.*;
  27 import com.alibaba.fastjson.JSONArray;
  28 import java.io.IOException;
  29 import java.util.HashMap;
  30 import java.util.List;
  31 import java.util.Map;
  32 import org.springframework.beans.factory.annotation.Autowired;
  33 import org.springframework.stereotype.Controller;
  34 import org.springframework.util.Assert;
  35 import org.springframework.web.bind.annotation.ModelAttribute;
  36 import org.springframework.web.bind.annotation.RequestMapping;
  37 import org.springframework.web.bind.annotation.RequestParam;
  38 import org.springframework.web.bind.annotation.ResponseBody;
  39 
  40 
  41 @Controller
  42 @RequestMapping(&quot;/user/interface&quot;)
  43 public class InterfaceController extends BaseController {
  44 	@Autowired
  45 	private InterfaceService interfaceService;
  46 
  47 	@Autowired
  48 	private ISearchService luceneService;
  49 
  50 	@Autowired
  51 	private ErrorService errorService;
  52 
  53 	@RequestMapping(&quot;/list.do&quot;)
  54 	@ResponseBody
  55 	@AuthPassport
  56 	public JsonResult list(@ModelAttribute
  57 	InterfaceQuery query, String url) throws MyException {
  58 	       Module module = getModule(query);
  59 	       Project project = getProject(query);
  60 	       checkPermission(project, READ);
  61 
  62 
  63 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64 	       InterfaceQuery interfaceQuery = query.setFullUrl(url);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65 		Page page= new Page(interfaceQuery);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66 </span>
  67 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  68 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  68 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
  69 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71 		InterfaceCriteria example = new InterfaceCriteria();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72 		InterfaceCriteria.Criteria criteria = example.createCriteria().andModuleIdEqualTo(moduleId);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73 		if (!MyString.isEmpty(interfaceName)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74 			criteria.andInterfaceNameLike(&quot;%&quot; + interfaceName + &quot;%&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76 		if (!MyString.isEmpty(url)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77 			criteria.andFullUrlLike(&quot;%&quot; + url + &quot;%&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79 		example.setLimitStart(page.getStart());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80 		example.setMaxResults(page.getSize());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81 </span>
  82 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
  83 
<abbr title="  84 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module, project);">  84 		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module,🔵</abbr>
  85 		page.setAllRow(interfaceService.count(interfaceQuery));
  86 		JsonResult result = new JsonResult(1, interfaces, page);
  87 		result.putOthers(&quot;module&quot;, module);
  88 
  89 		return result;
  90 
  91 	}
  92 
  93 	@RequestMapping(&quot;/detail.do&quot;)
  94 	@ResponseBody
  95 	public JsonResult detail(String id, String moduleId, String projectId) throws MyException {
  96 		InterfaceWithBLOBs model;
  97 		Module module;
  98 		if (id != null) {
  99 			model = interfaceService.getById(id);
 100 			module = moduleCache.get(model.getModuleId());
 101 		} else {
 102 			model = new InterfaceWithBLOBs();
 103 			module = moduleCache.get(moduleId);
 104 			model.setModuleId(moduleId);
 105 			model.setProjectId(module.getProjectId() == null ? projectId : module.getProjectId());
 106 			model.setResponseParam(&quot;[]&quot;);
 107 			model.setHeader(&quot;[]&quot;);
 108 			model.setParamRemark(&quot;[]&quot;);
 109 			model.setErrors(&quot;[]&quot;);
 110 			model.setMethod(IConst.C_METHOD_GET);
 111 			model.setStatus(InterfaceStatus.ONLINE.getByteValue());
 112 			model.setContentType(InterfaceContentType.JSON.getType());
 113 			model.setParam(IConst.C_PARAM_FORM_PRE + &quot;[]&quot;);
 114 			if (!MyString.isEmpty(module.getTemplateId())) {
 115 				InterfaceWithBLOBs template = interfaceService.getById(module.getTemplateId());
 116 				// 根据模板初始化接口
 117 				if (template != null) {
 118 					model.setHeader(template.getHeader());
 119 					model.setParam(template.getParam());
 120 					model.setMethod(template.getMethod());
 121 					model.setVersion(template.getVersion());
 122 					model.setParamRemark(template.getParamRemark());
 123 					model.setResponseParam(template.getResponseParam());
 124 					model.setErrorList(template.getErrorList());
 125 					model.setErrors(template.getErrors());
 126 					model.setFalseExam(template.getFalseExam());
 127 					model.setTrueExam(template.getTrueExam());
 128 					model.setStatus(template.getStatus());
 129 					model.setContentType(template.getContentType());
 130 				}
 131 			}
 132 		}
 133 		checkPermission(model.getProjectId(), READ);
 134 		return new JsonResult(1, InterfaceAdapter.getDtoWithBLOBs(model, module, null, false));
 135 	}
 136 
 137 	/**
 138 	 *
 139 	 *
 140 	 * @param interFace
 141 	 *
 142 	 * @return
 143 	 * @throws IOException
 144 	 *
 145 	 */
 146 	@RequestMapping(&quot;/copy.do&quot;)
 147 	@ResponseBody
 148 	public JsonResult copy(@RequestParam
 149 	String id, String interfaceName, String url, String moduleId) throws MyException, IOException {
 150 		InterfaceWithBLOBs interFace = interfaceService.getById(id);
 151 		// 判断是否拥有原来项目的权限
 152 		checkPermission(interFace.getProjectId(), READ);
 153 		Project project = getProject(interFace.getProjectId(), moduleId);
 154 		Module module = moduleCache.get(moduleId);
 155 		// 检查新项目的权限
 156 		checkPermission(project, ADD_INTER);
 157 		if (!Config.canRepeatUrl) {
<abbr title=" 158 			if (interfaceService.count(new InterfaceQuery().setModuleId(moduleId).setEqualFullUrl(module.getUrl() + interFace.getUrl())) &gt; 0) {"> 158 			if (interfaceService.count(new InterfaceQuery().setModuleId(moduleId).setEqualFullUrl(module.getUrl() 🔵</abbr>
 159 				throw new MyException(MyError.E000004);
 160 			}
 161 		}
 162 		interFace.setId(null);
 163 		interFace.setUrl(url);
 164 		interFace.setFullUrl((module.getUrl() == null ? &quot;&quot; : module.getUrl()) + url);
 165 		interFace.setInterfaceName(interfaceName);
 166 		interFace.setModuleId(moduleId);
 167 		interFace.setProjectId(project.getId());
 168 		interfaceService.insert(interFace);
 169 		interFace.setId(interFace.getId());
 170 		luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 171 		return new JsonResult(1, interFace);
 172 	}
 173 
 174 	@RequestMapping(&quot;/addOrUpdate.do&quot;)
 175 	@ResponseBody
 176 	@AuthPassport
 177 	public JsonResult addOrUpdate(@ModelAttribute
 178 	InterfaceDto dto, String modifyRemark) throws IOException, MyException {
 179 		Assert.notNull(dto.getProjectId(), &quot;projectId can&#x27;t be null&quot;);
 180 		Assert.notNull(dto.getUrl(), &quot;url can&#x27;t be null&quot;);
 181 		String id = dto.getId();
 182 		Module module = moduleCache.get(dto.getModuleId());
 183 		String newProjectId = getProjectId(dto.getProjectId(), dto.getModuleId());
 184 		dto.setProjectId(newProjectId);
 185 		dto.setUrl(dto.getUrl().trim());
 186 		dto.setFullUrl(module.getUrl() + dto.getUrl());
 187 		if (C_PARAM_FORM.equals(dto.getParamType())) {
 188 			dto.setParam(C_PARAM_FORM_PRE + dto.getParam());
 189 		}
 190 		/**
 191 		 * 根据选着的错误码id，组装json字符串
 192 		 */
<abbr title=" 193 		ErrorQuery query = new ErrorQuery().setProjectId(newProjectId).setErrorCodeList(Tools.getIdsFromField(dto.getErrorList())).setPageSize(100);"> 193 		ErrorQuery query = new ErrorQuery().setProjectId(newProjectId).setErrorCodeList(Tools.getIdsFromField(d🔵</abbr>
 194 		List&lt;Error&gt; errors = errorService.query(query);
 195 		dto.setErrors(JSONArray.toJSONString(errors));
 196 		LoginInfoDto user = LoginUserHelper.getUser();
 197 		dto.setUpdateBy(((&quot;userName：&quot; + user.getUserName()) + &quot; | trueName：&quot;) + user.getTrueName());
 198 		dto.setMonitorType(MonitorType.No.getValue());
 199 		InterfaceWithBLOBs interFace = InterfaceAdapter.getModel(dto);
 200 		if (id != null) {
 201 			String oldProjectId = interfaceService.getById(interFace.getId()).getProjectId();
 202 			// 判断是否有修改模块的权限
 203 			checkPermission(oldProjectId, READ);
 204 			checkPermission(newProjectId, MOD_INTER);
 205 			//同一模块下不允许 url 重复
<abbr title=" 206 			InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(interFace.getFullUrl()).setExceptId(interFace.getId());"> 206 			InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(interFace.g🔵</abbr>
 207 			if ((!Config.canRepeatUrl) &amp;&amp; (interfaceService.count(interfaceQuery) &gt; 0)) {
 208 				throw new MyException(MyError.E000004);
 209 			}
 210 			interfaceService.update(interFace, &quot;接口&quot;, modifyRemark);
 211 		} else {
 212 			checkPermission(interFace.getProjectId(), ADD_INTER);
<abbr title=" 213 			InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(interFace.getFullUrl());"> 213 			InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(interFace.g🔵</abbr>
 214 			if ((!Config.canRepeatUrl) &amp;&amp; (interfaceService.count(interfaceQuery) &gt; 0)) {
 215 				return new JsonResult(MyError.E000004);
 216 			}
 217 			interfaceService.insert(interFace);
 218 			id = interFace.getId();
 219 		}
 220 		luceneService.update(InterfaceAdapter.getSearchDto(interfaceService.getById(id)));
 221 		return new JsonResult(1, interFace);
 222 	}
 223 
 224 	@RequestMapping(&quot;/debug.do&quot;)
 225 	@ResponseBody
 226 	@AuthPassport
 227 	public JsonResult debug(@ModelAttribute
 228 	InterfaceDto interFace) throws IOException, Exception {
 229 		Assert.notNull(interFace.getMethod(), &quot;请求方法不能为空&quot;);
 230 		Assert.notNull(interFace.getFullUrl(), &quot;地址不能为空&quot;);
 231 		Assert.isTrue(interFace.getFullUrl().startsWith(&quot;http&quot;), &quot;地址必须以 http开头&quot;);
 232 		String fullUrl = interFace.getFullUrl();
<abbr title=" 233 		List&lt;ParamDto&gt; headerList = JSONArray.parseArray(interFace.getHeader() == null ? &quot;[]&quot; : interFace.getHeader(), ParamDto.class);"> 233 		List&lt;ParamDto&gt; headerList = JSONArray.parseArray(interFace.getHeader() == null ? &quot;[]&quot; : interFace.getHe🔵</abbr>
 234 		Map&lt;String, String&gt; httpHeaders = new HashMap&lt;&gt;();
 235 		for (ParamDto paramDto : headerList) {
 236 			httpHeaders.put(paramDto.getName(), paramDto.getDef());
 237 		}
 238 								// 如果自定义参数不为空，则表示需要使用post发送自定义包体
 239 		if (C_PARAM_RAW.equals(interFace.getParamType())) {
<abbr title=" 240 			return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.postBody(fullUrl, interFace.getParam(), httpHeaders)));"> 240 			return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.postBody(fullUrl, interFace.getParam(🔵</abbr>
 241 		}
<abbr title=" 242 		List&lt;ParamDto&gt; paramList = JSONArray.parseArray(interFace.getParam() == null ? &quot;[]&quot; : interFace.getParam(), ParamDto.class);"> 242 		List&lt;ParamDto&gt; paramList = JSONArray.parseArray(interFace.getParam() == null ? &quot;[]&quot; : interFace.getPara🔵</abbr>
 243 		Map&lt;String, String&gt; httpParams = new HashMap&lt;&gt;();
 244 		for (ParamDto paramDto : paramList) {
 245 			if (fullUrl.contains((&quot;{&quot; + paramDto.getRealName()) + &quot;}&quot;)) {
 246 				fullUrl = fullUrl.replace((&quot;{&quot; + paramDto.getName()) + &quot;}&quot;, paramDto.getDef());
 247 			} else {
 248 				httpParams.put(paramDto.getName(), paramDto.getDef());
 249 			}
 250 		}
 251 		try {
 252 			switch (interFace.getMethod()) {
 253 				case &quot;POST&quot; :
<abbr title=" 254 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.post(fullUrl, httpParams, httpHeaders)));"> 254 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.post(fullUrl, httpParams, httpHeade🔵</abbr>
 255 				case &quot;GET&quot; :
<abbr title=" 256 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.get(fullUrl, httpParams, httpHeaders)));"> 256 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.get(fullUrl, httpParams, httpHeader🔵</abbr>
 257 				case &quot;PUT&quot; :
<abbr title=" 258 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.put(fullUrl, httpParams, httpHeaders)));"> 258 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.put(fullUrl, httpParams, httpHeader🔵</abbr>
 259 				case &quot;DELETE&quot; :
<abbr title=" 260 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.delete(fullUrl, httpParams, httpHeaders)));"> 260 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.delete(fullUrl, httpParams, httpHea🔵</abbr>
 261 				case &quot;HEAD&quot; :
<abbr title=" 262 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.head(fullUrl, httpParams, httpHeaders)));"> 262 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.head(fullUrl, httpParams, httpHeade🔵</abbr>
 263 				case &quot;OPTIONS&quot; :
<abbr title=" 264 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.options(fullUrl, httpParams, httpHeaders)));"> 264 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.options(fullUrl, httpParams, httpHe🔵</abbr>
 265 				case &quot;TRACE&quot; :
<abbr title=" 266 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.trace(fullUrl, httpParams, httpHeaders)));"> 266 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.trace(fullUrl, httpParams, httpHead🔵</abbr>
 267 				case &quot;PATCH&quot; :
<abbr title=" 268 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.patch(fullUrl, httpParams, httpHeaders)));"> 268 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.patch(fullUrl, httpParams, httpHead🔵</abbr>
 269 				default :
 270 					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, &quot;不支持的请求方法：&quot; + interFace.getMethod()));
 271 			}
 272 		} catch (java.lang.Exception e) {
 273 			e.printStackTrace();
 274 			return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, &quot;调试出错\r\nmessage:&quot; + e.getMessage()));
 275 		}
 276 	}
 277 
 278 	@RequestMapping(&quot;/delete.do&quot;)
 279 	@ResponseBody
 280 	public JsonResult delete(String id, String ids) throws MyException, IOException {
 281 		if (MyString.isEmpty(id) &amp;&amp; MyString.isEmpty(ids)) {
 282 			throw new MyException(MyError.E000029);
 283 		}
 284 		if (MyString.isEmpty(ids)) {
 285 			ids = id;
 286 		}
 287 		for (String tempId : ids.split(&quot;,&quot;)) {
 288 			if (MyString.isEmpty(tempId)) {
 289 				continue;
 290 			}
 291 			InterfaceWithBLOBs interFace = interfaceService.getById(tempId);
 292 			checkPermission(interFace.getProjectId(), DEL_INTER);
 293 			luceneService.delete(new SearchDto(interFace.getId()));
 294 			interfaceService.delete(interFace.getId(), &quot;接口&quot;, &quot;&quot;);
 295 		}
 296 		return new JsonResult(1, null);
 297 	}
 298 
 299 	@RequestMapping(&quot;/changeSequence.do&quot;)
 300 	@ResponseBody
 301 	public JsonResult changeSequence(@RequestParam
 302 	String id, @RequestParam
 303 	String changeId) throws MyException {
 304 		InterfaceWithBLOBs change = interfaceService.getById(changeId);
 305 		InterfaceWithBLOBs model = interfaceService.getById(id);
 306 		checkPermission(model.getProjectId(), MOD_INTER);
 307 		checkPermission(change.getProjectId(), MOD_INTER);
 308 		int modelSequence = model.getSequence();
 309 		model.setSequence(change.getSequence());
 310 		change.setSequence(modelSequence);
 311 		interfaceService.update(model);
 312 		interfaceService.update(change);
 313 		return new JsonResult(1, null);
 314 	}
 315 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package cn.crap.controller.user;
   2  
   3  import cn.crap.adapter.InterfaceAdapter;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 +import cn.crap.beans.Config;</span>
   5  import cn.crap.dto.InterfaceDto;
   6  import cn.crap.dto.LoginInfoDto;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 +import cn.crap.dto.ParamDto;</span>
   8  import cn.crap.dto.SearchDto;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 -import cn.crap.enumer.MonitorType;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 -import cn.crap.enumer.MyError;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 +import cn.crap.enu.InterfaceContentType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 +import cn.crap.enu.InterfaceStatus;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 +import cn.crap.enu.MonitorType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 +import cn.crap.enu.MyError;</span>
  15  import cn.crap.framework.JsonResult;
  16  import cn.crap.framework.MyException;
  17  import cn.crap.framework.base.BaseController;
  18  import cn.crap.framework.interceptor.AuthPassport;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -import cn.crap.model.mybatis.Error;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -import cn.crap.model.mybatis.*;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import cn.crap.model.Error;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import cn.crap.model.InterfaceWithBLOBs;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import cn.crap.model.Module;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import cn.crap.model.Project;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import cn.crap.query.ErrorQuery;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import cn.crap.query.InterfaceQuery;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import cn.crap.service.ErrorService;</span>
  28  import cn.crap.service.ISearchService;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import cn.crap.service.custom.CustomErrorService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import cn.crap.service.custom.CustomInterfaceService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import cn.crap.service.mybatis.InterfaceService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import cn.crap.beans.Config;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import cn.crap.service.InterfaceService;</span>
  34  import cn.crap.utils.*;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import net.sf.json.JSONArray;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import com.alibaba.fastjson.JSONArray;</span>
  37  import org.springframework.beans.factory.annotation.Autowired;
  38  import org.springframework.stereotype.Controller;
  39  import org.springframework.util.Assert;
  40  import org.springframework.web.bind.annotation.ModelAttribute;
  41  import org.springframework.web.bind.annotation.RequestMapping;
  42  import org.springframework.web.bind.annotation.RequestParam;
  43  import org.springframework.web.bind.annotation.ResponseBody;
  44  
  45  import java.io.IOException;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import java.util.Date;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import java.util.HashMap;</span>
  48  import java.util.List;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +import java.util.Map;</span>
  50  
  51  @Controller
  52  @RequestMapping(&quot;/user/interface&quot;)
  53  public class InterfaceController extends BaseController{
  54  
  55  	@Autowired
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -	private CustomInterfaceService customInterfaceService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -	@Autowired</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -	private InterfaceService mybatisInterfaceService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +	private InterfaceService interfaceService;</span>
  60  	@Autowired
  61  	private ISearchService luceneService;
  62  	@Autowired
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -	private CustomErrorService customErrorService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -	@Autowired</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -	private Config config;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +	private ErrorService errorService;</span>
  68  
  69  	@RequestMapping(&quot;/list.do&quot;)
  70  	@ResponseBody
  71  	@AuthPassport
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -	public JsonResult list(@RequestParam String moduleId, String interfaceName, String url,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -			 Integer currentPage) throws MyException{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -		Page page= new Page(currentPage);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -		checkUserPermissionByModuleId(moduleId, VIEW);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -		InterfaceCriteria example = new InterfaceCriteria();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -		InterfaceCriteria.Criteria criteria = example.createCriteria().andModuleIdEqualTo(moduleId);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -		if (!MyString.isEmpty(interfaceName)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -			criteria.andInterfaceNameLike(&quot;%&quot; + interfaceName + &quot;%&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -		if (!MyString.isEmpty(url)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -			criteria.andFullUrlLike(&quot;%&quot; + url + &quot;%&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -		}</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  86 -		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(example), null);">  86 -		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(example🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -        page.setAllRow(mybatisInterfaceService.countByExample(example));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +	public JsonResult list(@ModelAttribute InterfaceQuery query, String url) throws MyException{</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +        Module module = getModule(query);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +        Project project = getProject(query);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +        checkPermission(project, READ);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +        InterfaceQuery interfaceQuery = query.setFullUrl(url);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +		Page page= new Page(interfaceQuery);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  96 +		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module, project);">  96 +		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(interfaceService.query(interfaceQuery), module, project)🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +		page.setAllRow(interfaceService.count(interfaceQuery));</span>
  98  		JsonResult result = new JsonResult(1, interfaces, page);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -		result.putOthers(&quot;crumbs&quot;, Tools.getCrumbs(&quot;接口列表:&quot;+ moduleCache.get(moduleId).getName(),&quot;void&quot;))</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -				.putOthers(&quot;module&quot;, moduleCache.get(moduleId));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +		result.putOthers(&quot;module&quot;, module);</span>
 102  
 103  		return result;
 104  
 105  	}
 106  
 107  	@RequestMapping(&quot;/detail.do&quot;)
 108  	@ResponseBody
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -	public JsonResult detail(String id, String moduleId) throws MyException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +	public JsonResult detail(String id, String moduleId, String projectId) throws MyException {</span>
 111  		InterfaceWithBLOBs model;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -		Module module = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +		Module module;</span>
 114  		if(id != null){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -			model= mybatisInterfaceService.getById(id);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +			model= interfaceService.getById(id);</span>
 117  			module = moduleCache.get(model.getModuleId());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -			checkUserPermissionByProject(model.getProjectId(), VIEW);</span>
 119  		}else{
 120  			model = new InterfaceWithBLOBs();
 121  			module = moduleCache.get(moduleId);
 122  			model.setModuleId( moduleId);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -			model.setProjectId(module.getProjectId());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -			model.setParam(&quot;form=[]&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +			model.setProjectId(module.getProjectId() == null ? projectId : module.getProjectId());</span>
 126  			model.setResponseParam(&quot;[]&quot;);
 127  			model.setHeader(&quot;[]&quot;);
 128  			model.setParamRemark(&quot;[]&quot;);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -			if(!MyString.isEmpty(module.getTemplateId())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -				InterfaceWithBLOBs template = mybatisInterfaceService.getById(module.getTemplateId());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +            model.setErrors(&quot;[]&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +            model.setMethod(IConst.C_METHOD_GET);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +            model.setStatus(InterfaceStatus.ONLINE.getByteValue());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +            model.setContentType(InterfaceContentType.JSON.getType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +            model.setParam(IConst.C_PARAM_FORM_PRE + &quot;[]&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +            if(!MyString.isEmpty(module.getTemplateId())){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +				InterfaceWithBLOBs template = interfaceService.getById(module.getTemplateId());</span>
 139  				// 根据模板初始化接口
 140  				if(template != null){
 141  					model.setHeader(template.getHeader());
 142  					model.setParam(template.getParam());
 143  					model.setMethod(template.getMethod());
 144  					model.setVersion(template.getVersion());
 145  					model.setParamRemark(template.getParamRemark());
 146  					model.setResponseParam(template.getResponseParam());
 147  					model.setErrorList(template.getErrorList());
 148  					model.setErrors(template.getErrors());
 149  					model.setFalseExam(template.getFalseExam());
 150  					model.setTrueExam(template.getTrueExam());
 151  					model.setStatus(template.getStatus());
 152  					model.setContentType(template.getContentType());
 153  				}
 154  			}
 155  		}
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -		return new JsonResult(1, InterfaceAdapter.getDto(model, module, false));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +        checkPermission(model.getProjectId(), READ);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +		return new JsonResult(1, InterfaceAdapter.getDtoWithBLOBs(model, module, null, false));</span>
 159  	}
 160  
 161  	/**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -	 * @param interFace</span>
 163  	 * @return
 164  	 * @throws MyException
 165  	 * @throws IOException
 166  	 */
 167  	@RequestMapping(&quot;/copy.do&quot;)
 168  	@ResponseBody
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -	public JsonResult copy(@ModelAttribute InterfaceDto interFace) throws MyException, IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -		//判断是否拥有该模块的权限</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -		checkUserPermissionByProject(interFace.getProjectId(), ADD_INTER);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -		Module module = moduleCache.get(interFace.getModuleId());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -		if(!config.isCanRepeatUrl()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -			InterfaceCriteria example = new InterfaceCriteria();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -			InterfaceCriteria.Criteria criteria = example.createCriteria();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -			criteria.andModuleIdEqualTo(interFace.getModuleId()).andFullUrlEqualTo(module.getUrl() + interFace.getUrl());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -			if (mybatisInterfaceService.countByExample(example) &gt; 0){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 179 +	public JsonResult copy(@RequestParam String id, String interfaceName, String url, String moduleId) throws MyException, IOException {"> 179 +	public JsonResult copy(@RequestParam String id, String interfaceName, String url, String moduleId) throws MyExcep🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +		InterfaceWithBLOBs interFace = interfaceService.getById(id);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +		//判断是否拥有原来项目的权限</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +		checkPermission(interFace.getProjectId(), READ);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +        Project project = getProject(interFace.getProjectId(), moduleId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +        Module module = moduleCache.get(moduleId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +		// 检查新项目的权限</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +        checkPermission(project, ADD_INTER);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +		if(!Config.canRepeatUrl){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 190 +			if (interfaceService.count(new InterfaceQuery().setModuleId(moduleId).setEqualFullUrl(module.getUrl() + interFace.getUrl())) &gt; 0){"> 190 +			if (interfaceService.count(new InterfaceQuery().setModuleId(moduleId).setEqualFullUrl(module.getUrl() + interFa🔵</abbr></span>
 191  				throw new MyException(MyError.E000004);
 192  			}
 193  		}
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +</span>
 195  		interFace.setId(null);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -		interFace.setFullUrl(module.getUrl() + interFace.getUrl());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -		mybatisInterfaceService.insert(InterfaceAdapter.getModel(interFace));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +		interFace.setUrl(url);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +        interFace.setFullUrl((module.getUrl() == null ? &quot;&quot; : module.getUrl()) + url);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +        interFace.setInterfaceName(interfaceName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +        interFace.setModuleId(moduleId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +        interFace.setProjectId(project.getId());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +        interfaceService.insert(interFace);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +        interFace.setId(interFace.getId());</span>
 207  		luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 208  		return new JsonResult(1, interFace);
 209  	}
 210  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -	 * 根据参数生成请求示例</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -	 * @param interFace</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -	 * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -	@RequestMapping(&quot;/getRequestExam.do&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +	@RequestMapping(&quot;/addOrUpdate.do&quot;)</span>
 218  	@ResponseBody
 219  	@AuthPassport
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -	public JsonResult getRequestExam(@ModelAttribute InterfaceDto interFace) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -		customInterfaceService.getInterFaceRequestExam(interFace);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -		return new JsonResult(1, interFace);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -	@RequestMapping(&quot;/addOrUpdate.do&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -	@ResponseBody</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -	@AuthPassport</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -	public JsonResult addOrUpdate(@ModelAttribute InterfaceDto interFace) throws IOException, MyException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -		Assert.notNull(interFace.getProjectId(), &quot;projectId can&#x27;t be null&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -		if(MyString.isEmpty(interFace.getUrl())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -			return new JsonResult(MyError.E000005);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -		interFace.setUrl(interFace.getUrl().trim());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 235 +	public JsonResult addOrUpdate(@ModelAttribute InterfaceDto dto, String modifyRemark) throws IOException, MyException {"> 235 +	public JsonResult addOrUpdate(@ModelAttribute InterfaceDto dto, String modifyRemark) throws IOException, MyExcept🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +		Assert.notNull(dto.getProjectId(), &quot;projectId can&#x27;t be null&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +        Assert.notNull(dto.getUrl(), &quot;url can&#x27;t be null&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +        String id = dto.getId();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +        Module module = moduleCache.get(dto.getModuleId());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +        String newProjectId = getProjectId(dto.getProjectId(), dto.getModuleId());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +        dto.setProjectId(newProjectId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +		dto.setUrl(dto.getUrl().trim());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +        dto.setFullUrl(module.getUrl() + dto.getUrl());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +        if (C_PARAM_FORM.equals(dto.getParamType())){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +		    dto.setParam(C_PARAM_FORM_PRE + dto.getParam());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +        }</span>
 249  
 250  		/**
 251  		 * 根据选着的错误码id，组装json字符串
 252  		 */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -		String errorIds = interFace.getErrorList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 254 -		List&lt;Error&gt; errors  = customErrorService.queryByProjectIdAndErrorCode(interFace.getProjectId(), Tools.getIdsFromField(errorIds));"> 254 -		List&lt;Error&gt; errors  = customErrorService.queryByProjectIdAndErrorCode(interFace.getProjectId(), Tools.getIdsFrom🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -		interFace.setErrors(JSONArray.fromObject(errors).toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 256 +        ErrorQuery query = new ErrorQuery().setProjectId(newProjectId).setErrorCodeList(Tools.getIdsFromField(dto.getErrorList())).setPageSize(100);"> 256 +        ErrorQuery query = new ErrorQuery().setProjectId(newProjectId).setErrorCodeList(Tools.getIdsFromField(dto.🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +        List&lt;Error&gt; errors  = errorService.query(query);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +		dto.setErrors(JSONArray.toJSONString(errors));</span>
 259  
 260  		LoginInfoDto user = LoginUserHelper.getUser();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -		interFace.setUpdateBy(&quot;userName：&quot;+user.getUserName()+&quot; | trueName：&quot;+ user.getTrueName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -		//请求示例为空，则自动添加</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -		if(MyString.isEmpty(interFace.getRequestExam())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -			customInterfaceService.getInterFaceRequestExam(interFace);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -        interFace.setMonitorType(MonitorType.No.getValue());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -		//检查邮件格式是否正确</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -		/**if(interFace.getMonitorType() != MonitorType.No.getValue()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -			if(!MyString.isEmpty(interFace.getMonitorEmails())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -				for(String email : interFace.getMonitorEmails().split(&quot;;&quot;)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -					if( !Tools.checkEmail(email) ){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -						throw new MyException(E000032&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -					}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -				}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -			}else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -				throw new MyException(E000032&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -		}**/</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -		Module module = moduleCache.get(interFace.getModuleId());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -		if (!MyString.isEmpty(interFace.getId())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -			String oldModuleId = mybatisInterfaceService.getById(interFace.getId()).getModuleId();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -			String projectId = moduleCache.get(oldModuleId).getProjectId();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -			Project project = projectCache.get(interFace.getProjectId() );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -			// 接口只能在同一个项目下的模块中移动</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -			if( !projectId.equals(project.getId())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -				throw new MyException(MyError.E000047);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -			}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +		dto.setUpdateBy(&quot;userName：&quot;+user.getUserName()+&quot; | trueName：&quot;+ user.getTrueName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +        dto.setMonitorType(MonitorType.No.getValue());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +        InterfaceWithBLOBs interFace = InterfaceAdapter.getModel(dto);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +        if (id != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +			String oldProjectId = interfaceService.getById(interFace.getId()).getProjectId();</span>
 296  			// 判断是否有修改模块的权限
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -			checkUserPermissionByProject(project, MOD_INTER);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +			checkPermission(oldProjectId, READ);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +            checkPermission(newProjectId, MOD_INTER);</span>
 300  
 301  			//同一模块下不允许 url 重复
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -			if( !config.isCanRepeatUrl() &amp;&amp; customInterfaceService.countByFullUrl(interFace.getModuleId(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -					module.getUrl() +interFace.getUrl(), interFace.getId()) &gt;0 ){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 304 +            InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(interFace.getFullUrl()).setExceptId(interFace.getId());"> 304 +            InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(interFace.g🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +			if( !Config.canRepeatUrl &amp;&amp; interfaceService.count(interfaceQuery) &gt;0 ){</span>
 306  				throw new MyException(MyError.E000004);
 307  			}
 308  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -			interFace.setFullUrl(module.getUrl() + interFace.getUrl());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -			customInterfaceService.update(InterfaceAdapter.getModel(interFace), &quot;接口&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -			if(interFace.getId().equals(interFace.getProjectId())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -				throw new MyException(MyError.E000027);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -			luceneService.update(InterfaceAdapter.getSearchDto(interFace));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +			interfaceService.update(interFace, &quot;接口&quot;, modifyRemark);</span>
 317  		} else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 318 -			checkUserPermissionByProject(projectCache.get(interFace.getProjectId() ), ADD_INTER);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 319 -			if(!config.isCanRepeatUrl() &amp;&amp; customInterfaceService.countByFullUrl(interFace.getModuleId(),module.getUrl() + interFace.getUrl(), null)&gt;0){"> 319 -			if(!config.isCanRepeatUrl() &amp;&amp; customInterfaceService.countByFullUrl(interFace.getModuleId(),module.getUrl() + 🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +			checkPermission(interFace.getProjectId(), ADD_INTER);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 321 +            InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(interFace.getFullUrl());"> 321 +            InterfaceQuery interfaceQuery = new InterfaceQuery().setProjectId(newProjectId).setFullUrl(interFace.g🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +			if(!Config.canRepeatUrl &amp;&amp; interfaceService.count(interfaceQuery)&gt;0){</span>
 323  				return new JsonResult(MyError.E000004);
 324  			}
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 325 -			interFace.setFullUrl(module.getUrl() + interFace.getUrl());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 326 -			mybatisInterfaceService.insert(InterfaceAdapter.getModel(interFace));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 327 -			luceneService.add(InterfaceAdapter.getSearchDto(interFace));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 328 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 329 -		return new JsonResult(1, interFace);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +			interfaceService.insert(interFace);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +			id = interFace.getId();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +		}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +        luceneService.update(InterfaceAdapter.getSearchDto(interfaceService.getById(id)));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +        return new JsonResult(1, interFace);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +	}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +	@RequestMapping(&quot;/debug.do&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +	@ResponseBody</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +	@AuthPassport</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +	public JsonResult debug(@ModelAttribute InterfaceDto interFace) throws IOException, Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +		Assert.notNull(interFace.getMethod(), &quot;请求方法不能为空&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +		Assert.notNull(interFace.getFullUrl(), &quot;地址不能为空&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +        Assert.isTrue(interFace.getFullUrl().startsWith(&quot;http&quot;), &quot;地址必须以 http开头&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +        String fullUrl = interFace.getFullUrl();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 349 +		List&lt;ParamDto&gt; headerList = JSONArray.parseArray(interFace.getHeader() == null ? &quot;[]&quot; : interFace.getHeader(), ParamDto.class);"> 349 +		List&lt;ParamDto&gt; headerList = JSONArray.parseArray(interFace.getHeader() == null ? &quot;[]&quot; : interFace.getHeader(), P🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +        Map&lt;String, String&gt; httpHeaders = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +        for (ParamDto paramDto : headerList) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +            httpHeaders.put(paramDto.getName(), paramDto.getDef());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +        // 如果自定义参数不为空，则表示需要使用post发送自定义包体</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +        if (C_PARAM_RAW.equals(interFace.getParamType())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 357 +            return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.postBody(fullUrl, interFace.getParam(), httpHeaders)));"> 357 +            return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.postBody(fullUrl, interFace.getParam(🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 360 +        List&lt;ParamDto&gt; paramList = JSONArray.parseArray(interFace.getParam() == null ? &quot;[]&quot; : interFace.getParam(), ParamDto.class);"> 360 +        List&lt;ParamDto&gt; paramList = JSONArray.parseArray(interFace.getParam() == null ? &quot;[]&quot; : interFace.getParam()🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +        Map&lt;String, String&gt; httpParams = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +        for (ParamDto paramDto : paramList) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +            if (fullUrl.contains(&quot;{&quot; + paramDto.getRealName() + &quot;}&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +                fullUrl = fullUrl.replace(&quot;{&quot; + paramDto.getName() + &quot;}&quot;, paramDto.getDef());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 367 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 368 +                httpParams.put(paramDto.getName(), paramDto.getDef());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 369 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 370 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 371 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 372 +            switch (interFace.getMethod()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 373 +                case &quot;POST&quot;:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 374 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.post(fullUrl, httpParams, httpHeaders)));"> 374 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.post(fullUrl, httpParams, htt🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 375 +                case &quot;GET&quot;:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 376 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.get(fullUrl, httpParams, httpHeaders)));"> 376 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.get(fullUrl, httpParams, http🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +                case &quot;PUT&quot;:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 378 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.put(fullUrl, httpParams, httpHeaders)));"> 378 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.put(fullUrl, httpParams, http🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +                case &quot;DELETE&quot;:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 380 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.delete(fullUrl, httpParams, httpHeaders)));"> 380 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.delete(fullUrl, httpParams, h🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 381 +                case &quot;HEAD&quot;:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 382 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.head(fullUrl, httpParams, httpHeaders)));"> 382 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.head(fullUrl, httpParams, htt🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +                case &quot;OPTIONS&quot;:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 384 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.options(fullUrl, httpParams, httpHeaders)));"> 384 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.options(fullUrl, httpParams, 🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +                case &quot;TRACE&quot;:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 386 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.trace(fullUrl, httpParams, httpHeaders)));"> 386 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.trace(fullUrl, httpParams, ht🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +				case &quot;PATCH&quot;:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +					return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, HttpPostGet.patch(fullUrl, httpParams, httpHeaders)));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +                default:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +                    return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, &quot;不支持的请求方法：&quot; + interFace.getMethod()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +        } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +            e.printStackTrace();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +            return new JsonResult(1, Tools.getMap(&quot;debugResult&quot;, &quot;调试出错\r\nmessage:&quot; + e.getMessage()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 395 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 396 +</span>
 397  	}
 398  
 399  	@RequestMapping(&quot;/delete.do&quot;)
 400  	@ResponseBody
 401  	public JsonResult delete(String id, String ids) throws MyException, IOException{
 402  		if( MyString.isEmpty(id) &amp;&amp; MyString.isEmpty(ids)){
 403  			throw new MyException(MyError.E000029);
 404  		}
 405  		if( MyString.isEmpty(ids) ){
 406  			ids = id;
 407  		}
 408  
 409  		for(String tempId : ids.split(&quot;,&quot;)){
 410  			if(MyString.isEmpty(tempId)){
 411  				continue;
 412  			}
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -			InterfaceWithBLOBs interFace = mybatisInterfaceService.getById( tempId );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -			checkUserPermissionByProject(interFace.getProjectId(), DEL_INTER);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -			customInterfaceService.delete(interFace.getId(), &quot;接口&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -			luceneService.delete(new SearchDto(interFace.getId()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 417 +			InterfaceWithBLOBs interFace = interfaceService.getById( tempId );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +			checkPermission(interFace.getProjectId(), DEL_INTER);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 419 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 420 +            luceneService.delete(new SearchDto(interFace.getId()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 421 +			interfaceService.delete(interFace.getId(), &quot;接口&quot;, &quot;&quot;);</span>
 422  		}
 423  		return new JsonResult(1, null);
 424  	}
 425  
 426  	@RequestMapping(&quot;/changeSequence.do&quot;)
 427  	@ResponseBody
 428  	public JsonResult changeSequence(@RequestParam String id,@RequestParam String changeId) throws MyException {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 429 -		InterfaceWithBLOBs change = mybatisInterfaceService.getById(changeId);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 430 -		InterfaceWithBLOBs model = mybatisInterfaceService.getById(id);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 431 -		checkUserPermissionByProject(model.getProjectId(), MOD_INTER);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 432 -		checkUserPermissionByProject(change.getProjectId(), MOD_INTER);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 433 +		InterfaceWithBLOBs change = interfaceService.getById(changeId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 434 +		InterfaceWithBLOBs model = interfaceService.getById(id);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 435 +		checkPermission(model.getProjectId(), MOD_INTER);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 436 +		checkPermission(change.getProjectId(), MOD_INTER);</span>
 437  
 438  		int modelSequence = model.getSequence();
 439  
 440  		model.setSequence(change.getSequence());
 441  		change.setSequence(modelSequence);
 442  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 443 -		mybatisInterfaceService.update(model);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 444 -		mybatisInterfaceService.update(change);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 445 +		interfaceService.update(model);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 446 +		interfaceService.update(change);</span>
 447  		return new JsonResult(1, null);
 448  	}
 449  }</pre></td>
                            <td><pre>   1  package cn.crap.controller.user;
   2  
   3  import cn.crap.adapter.InterfaceAdapter;

   4  import cn.crap.dto.InterfaceDto;
   5  import cn.crap.dto.LoginInfoDto;

   6  import cn.crap.dto.SearchDto;
   7  import cn.crap.enumer.MonitorType;
   8  import cn.crap.enumer.MyError;




   9  import cn.crap.framework.JsonResult;
  10  import cn.crap.framework.MyException;
  11  import cn.crap.framework.base.BaseController;
  12  import cn.crap.framework.interceptor.AuthPassport;
  13  import cn.crap.model.mybatis.Error;
  14  import cn.crap.model.mybatis.*;







  15  import cn.crap.service.ISearchService;
  16  import cn.crap.service.custom.CustomErrorService;
  17  import cn.crap.service.custom.CustomInterfaceService;
  18  import cn.crap.service.mybatis.InterfaceService;
  19  import cn.crap.beans.Config;

  20  import cn.crap.utils.*;
  21  import net.sf.json.JSONArray;

  22  import org.springframework.beans.factory.annotation.Autowired;
  23  import org.springframework.stereotype.Controller;
  24  import org.springframework.util.Assert;
  25  import org.springframework.web.bind.annotation.ModelAttribute;
  26  import org.springframework.web.bind.annotation.RequestMapping;
  27  import org.springframework.web.bind.annotation.RequestParam;
  28  import org.springframework.web.bind.annotation.ResponseBody;
  29  
  30  import java.io.IOException;
  31  import java.util.Date;

  32  import java.util.List;

  33  
  34  @Controller
  35  @RequestMapping(&quot;/user/interface&quot;)
  36  public class InterfaceController extends BaseController{
  37  
  38  	@Autowired
  39  	private CustomInterfaceService customInterfaceService;
  40  	@Autowired
  41  	private InterfaceService mybatisInterfaceService;

  42  	@Autowired
  43  	private ISearchService luceneService;
  44  	@Autowired
  45  	private CustomErrorService customErrorService;
  46  	@Autowired
  47  	private Config config;
  48  

  49  
  50  	@RequestMapping(&quot;/list.do&quot;)
  51  	@ResponseBody
  52  	@AuthPassport
  53  	public JsonResult list(@RequestParam String moduleId, String interfaceName, String url,
  54  			 Integer currentPage) throws MyException{
  55  		Page page= new Page(currentPage);
  56  		checkUserPermissionByModuleId(moduleId, VIEW);
  57  
  58  		InterfaceCriteria example = new InterfaceCriteria();
  59  		InterfaceCriteria.Criteria criteria = example.createCriteria().andModuleIdEqualTo(moduleId);
  60  		if (!MyString.isEmpty(interfaceName)){
  61  			criteria.andInterfaceNameLike(&quot;%&quot; + interfaceName + &quot;%&quot;);
  62  		}
  63  		if (!MyString.isEmpty(url)){
  64  			criteria.andFullUrlLike(&quot;%&quot; + url + &quot;%&quot;);
  65  		}
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +		example.setLimitStart(page.getStart());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +		example.setMaxResults(page.getSize());</span>
  68  
<abbr title="  69  		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(example), null);">  69  		List&lt;InterfaceDto&gt; interfaces = InterfaceAdapter.getDto(mybatisInterfaceService.selectByExampleWithBLOBs(example🔵</abbr>
  70          page.setAllRow(mybatisInterfaceService.countByExample(example));










  71  		JsonResult result = new JsonResult(1, interfaces, page);
  72  		result.putOthers(&quot;crumbs&quot;, Tools.getCrumbs(&quot;接口列表:&quot;+ moduleCache.get(moduleId).getName(),&quot;void&quot;))
  73  				.putOthers(&quot;module&quot;, moduleCache.get(moduleId));

  74  
  75  		return result;
  76  
  77  	}
  78  
  79  	@RequestMapping(&quot;/detail.do&quot;)
  80  	@ResponseBody
  81  	public JsonResult detail(String id, String moduleId) throws MyException {

  82  		InterfaceWithBLOBs model;
  83  		Module module = null;

  84  		if(id != null){
  85  			model= mybatisInterfaceService.getById(id);

  86  			module = moduleCache.get(model.getModuleId());
  87  			checkUserPermissionByProject(model.getProjectId(), VIEW);
  88  		}else{
  89  			model = new InterfaceWithBLOBs();
  90  			module = moduleCache.get(moduleId);
  91  			model.setModuleId( moduleId);
  92  			model.setProjectId(module.getProjectId());
  93  			model.setParam(&quot;form=[]&quot;);

  94  			model.setResponseParam(&quot;[]&quot;);
  95  			model.setHeader(&quot;[]&quot;);
  96  			model.setParamRemark(&quot;[]&quot;);
  97  			if(!MyString.isEmpty(module.getTemplateId())){
  98  				InterfaceWithBLOBs template = mybatisInterfaceService.getById(module.getTemplateId());








  99  				// 根据模板初始化接口
 100  				if(template != null){
 101  					model.setHeader(template.getHeader());
 102  					model.setParam(template.getParam());
 103  					model.setMethod(template.getMethod());
 104  					model.setVersion(template.getVersion());
 105  					model.setParamRemark(template.getParamRemark());
 106  					model.setResponseParam(template.getResponseParam());
 107  					model.setErrorList(template.getErrorList());
 108  					model.setErrors(template.getErrors());
 109  					model.setFalseExam(template.getFalseExam());
 110  					model.setTrueExam(template.getTrueExam());
 111  					model.setStatus(template.getStatus());
 112  					model.setContentType(template.getContentType());
 113  				}
 114  			}
 115  		}
 116  		return new JsonResult(1, InterfaceAdapter.getDto(model, module, false));


 117  	}
 118  
 119  	/**
 120  	 * @param interFace
 121  	 * @return
 122  	 * @throws MyException
 123  	 * @throws IOException
 124  	 */
 125  	@RequestMapping(&quot;/copy.do&quot;)
 126  	@ResponseBody
 127  	public JsonResult copy(@ModelAttribute InterfaceDto interFace) throws MyException, IOException {
 128  		//判断是否拥有该模块的权限
 129  		checkUserPermissionByProject(interFace.getProjectId(), ADD_INTER);
 130  		Module module = moduleCache.get(interFace.getModuleId());
 131  
 132  		if(!config.isCanRepeatUrl()){
 133  			InterfaceCriteria example = new InterfaceCriteria();
 134  			InterfaceCriteria.Criteria criteria = example.createCriteria();
 135  			criteria.andModuleIdEqualTo(interFace.getModuleId()).andFullUrlEqualTo(module.getUrl() + interFace.getUrl());
 136  			if (mybatisInterfaceService.countByExample(example) &gt; 0){












 137  				throw new MyException(MyError.E000004);
 138  			}
 139  		}

 140  		interFace.setId(null);
 141  		interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 142  		mybatisInterfaceService.insert(InterfaceAdapter.getModel(interFace));
 143  








 144  		luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 145  		return new JsonResult(1, interFace);
 146  	}
 147  
 148  	/**
 149  	 * 根据参数生成请求示例
 150  	 * @param interFace
 151  	 * @return
 152  	 */
 153  	@RequestMapping(&quot;/getRequestExam.do&quot;)

 154  	@ResponseBody
 155  	@AuthPassport
 156  	public JsonResult getRequestExam(@ModelAttribute InterfaceDto interFace) {
 157  		customInterfaceService.getInterFaceRequestExam(interFace);
 158  		return new JsonResult(1, interFace);
 159  	}
 160  
 161  	@RequestMapping(&quot;/addOrUpdate.do&quot;)
 162  	@ResponseBody
 163  	@AuthPassport
 164  	public JsonResult addOrUpdate(@ModelAttribute InterfaceDto interFace) throws IOException, MyException {
 165  		Assert.notNull(interFace.getProjectId(), &quot;projectId can&#x27;t be null&quot;);
 166  
 167  		if(MyString.isEmpty(interFace.getUrl())) {
 168  			return new JsonResult(MyError.E000005);
 169  		}
 170  		interFace.setUrl(interFace.getUrl().trim());














 171  
 172  		/**
 173  		 * 根据选着的错误码id，组装json字符串
 174  		 */
 175  		String errorIds = interFace.getErrorList();
<abbr title=" 176  		List&lt;Error&gt; errors  = customErrorService.queryByProjectIdAndErrorCode(interFace.getProjectId(), Tools.getIdsFromField(errorIds));"> 176  		List&lt;Error&gt; errors  = customErrorService.queryByProjectIdAndErrorCode(interFace.getProjectId(), Tools.getIdsFrom🔵</abbr>
 177  		interFace.setErrors(JSONArray.fromObject(errors).toString());



 178  
 179  		LoginInfoDto user = LoginUserHelper.getUser();
 180  		interFace.setUpdateBy(&quot;userName：&quot;+user.getUserName()+&quot; | trueName：&quot;+ user.getTrueName());
 181  
 182  		//请求示例为空，则自动添加
 183  		if(MyString.isEmpty(interFace.getRequestExam())){
 184  			customInterfaceService.getInterFaceRequestExam(interFace);
 185  		}
 186          interFace.setMonitorType(MonitorType.No.getValue());
 187  		//检查邮件格式是否正确
 188  		/**if(interFace.getMonitorType() != MonitorType.No.getValue()){
 189  			if(!MyString.isEmpty(interFace.getMonitorEmails())){
 190  				for(String email : interFace.getMonitorEmails().split(&quot;;&quot;)){
 191  					if( !Tools.checkEmail(email) ){
 192  						throw new MyException(E000032&quot;);
 193  					}
 194  				}
 195  			}else{
 196  				throw new MyException(E000032&quot;);
 197  			}
 198  		}**/
 199  
 200  		Module module = moduleCache.get(interFace.getModuleId());
 201  		if (!MyString.isEmpty(interFace.getId())) {
 202  			String oldModuleId = mybatisInterfaceService.getById(interFace.getId()).getModuleId();
 203  			String projectId = moduleCache.get(oldModuleId).getProjectId();
 204  			Project project = projectCache.get(interFace.getProjectId() );
 205  
 206  			// 接口只能在同一个项目下的模块中移动
 207  			if( !projectId.equals(project.getId())){
 208  				throw new MyException(MyError.E000047);
 209  			}





 210  			// 判断是否有修改模块的权限
 211  			checkUserPermissionByProject(project, MOD_INTER);


 212  
 213  			//同一模块下不允许 url 重复
 214  			if( !config.isCanRepeatUrl() &amp;&amp; customInterfaceService.countByFullUrl(interFace.getModuleId(),
 215  					module.getUrl() +interFace.getUrl(), interFace.getId()) &gt;0 ){


 216  				throw new MyException(MyError.E000004);
 217  			}
 218  
 219  			interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 220  			customInterfaceService.update(InterfaceAdapter.getModel(interFace), &quot;接口&quot;, &quot;&quot;);
 221  			if(interFace.getId().equals(interFace.getProjectId())){
 222  				throw new MyException(MyError.E000027);
 223  			}
 224  			luceneService.update(InterfaceAdapter.getSearchDto(interFace));
 225  

 226  		} else {
 227  			checkUserPermissionByProject(projectCache.get(interFace.getProjectId() ), ADD_INTER);
<abbr title=" 228  			if(!config.isCanRepeatUrl() &amp;&amp; customInterfaceService.countByFullUrl(interFace.getModuleId(),module.getUrl() + interFace.getUrl(), null)&gt;0){"> 228  			if(!config.isCanRepeatUrl() &amp;&amp; customInterfaceService.countByFullUrl(interFace.getModuleId(),module.getUrl() + 🔵</abbr>



 229  				return new JsonResult(MyError.E000004);
 230  			}
 231  			interFace.setFullUrl(module.getUrl() + interFace.getUrl());
 232  			mybatisInterfaceService.insert(InterfaceAdapter.getModel(interFace));
 233  			luceneService.add(InterfaceAdapter.getSearchDto(interFace));
 234  		}
 235  		return new JsonResult(1, interFace);



































































 236  	}
 237  
 238  	@RequestMapping(&quot;/delete.do&quot;)
 239  	@ResponseBody
 240  	public JsonResult delete(String id, String ids) throws MyException, IOException{
 241  		if( MyString.isEmpty(id) &amp;&amp; MyString.isEmpty(ids)){
 242  			throw new MyException(MyError.E000029);
 243  		}
 244  		if( MyString.isEmpty(ids) ){
 245  			ids = id;
 246  		}
 247  
 248  		for(String tempId : ids.split(&quot;,&quot;)){
 249  			if(MyString.isEmpty(tempId)){
 250  				continue;
 251  			}
 252  			InterfaceWithBLOBs interFace = mybatisInterfaceService.getById( tempId );
 253  			checkUserPermissionByProject(interFace.getProjectId(), DEL_INTER);
 254  			customInterfaceService.delete(interFace.getId(), &quot;接口&quot;, &quot;&quot;);
 255  			luceneService.delete(new SearchDto(interFace.getId()));





 256  		}
 257  		return new JsonResult(1, null);
 258  	}
 259  
 260  	@RequestMapping(&quot;/changeSequence.do&quot;)
 261  	@ResponseBody
 262  	public JsonResult changeSequence(@RequestParam String id,@RequestParam String changeId) throws MyException {
 263  		InterfaceWithBLOBs change = mybatisInterfaceService.getById(changeId);
 264  		InterfaceWithBLOBs model = mybatisInterfaceService.getById(id);
 265  		checkUserPermissionByProject(model.getProjectId(), MOD_INTER);
 266  		checkUserPermissionByProject(change.getProjectId(), MOD_INTER);




 267  
 268  		int modelSequence = model.getSequence();
 269  
 270  		model.setSequence(change.getSequence());
 271  		change.setSequence(modelSequence);
 272  
 273  		mybatisInterfaceService.update(model);
 274  		mybatisInterfaceService.update(change);


 275  		return new JsonResult(1, null);
 276  	}
 277  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            