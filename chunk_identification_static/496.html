<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>496</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    496
                    <a href="495.html">prev</a>
                    <a href="497.html">next</a>
                    <a href="496_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_e346a804d69c8cd0124b4eb3d35156cfb5cd0779_launcher/src/main/java/com/dtstack/flink/sql/launcher/LauncherMain.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779:launcher/src/main/java/com/dtstack/flink/sql/launcher/LauncherMain.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^1:launcher/src/main/java/com/dtstack/flink/sql/launcher/LauncherMain.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^2:launcher/src/main/java/com/dtstack/flink/sql/launcher/LauncherMain.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;6e351a99f6e8449c76ad55e517a5da6cbb108379:launcher/src/main/java/com/dtstack/flink/sql/launcher/LauncherMain.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [bs], [bs], [j], [j]], subset: [[b], [bs], [bs], [j], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.launcher;
  21 
  22 import com.dtstack.flink.sql.launcher.entity.JobParamsInfo;
  23 import com.dtstack.flink.sql.launcher.executor.StandaloneExecutor;
  24 import com.dtstack.flink.sql.launcher.executor.YarnJobClusterExecutor;
  25 import com.dtstack.flink.sql.launcher.executor.YarnSessionClusterExecutor;
  26 import com.alibaba.fastjson.JSON;
  27 import com.alibaba.fastjson.TypeReference;
  28 import com.dtstack.flink.sql.enums.ClusterMode;
  29 import com.dtstack.flink.sql.Main;
  30 import com.dtstack.flink.sql.option.OptionParser;
  31 import com.dtstack.flink.sql.option.Options;
  32 import com.dtstack.flink.sql.util.PluginUtil;
  33 import org.apache.commons.io.Charsets;
  34 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  35 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.apache.commons.lang.BooleanUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.apache.commons.lang.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.apache.flink.client.program.ClusterClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.apache.flink.client.program.PackagedProgram;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import org.apache.flink.client.program.PackagedProgramUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import org.apache.flink.configuration.GlobalConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import org.apache.flink.runtime.jobgraph.SavepointRestoreSettings;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import org.apache.flink.util.FileUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import java.io.File;</span>
  48 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49 import org.apache.commons.lang.BooleanUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50 import org.apache.commons.lang.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51 import org.apache.flink.client.program.ClusterClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52 import org.apache.flink.client.program.PackagedProgram;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53 import org.apache.flink.client.program.PackagedProgramUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55 import org.apache.flink.configuration.GlobalConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57 import org.apache.flink.runtime.jobgraph.SavepointRestoreSettings;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58 import org.apache.flink.util.FileUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60 import org.slf4j.LoggerFactory;</span>
  61 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  62 
  63 import java.io.BufferedReader;
  64 import java.io.FileInputStream;
  65 import java.io.IOException;
  66 import java.io.InputStreamReader;
  67 import java.net.URLDecoder;
  68 import java.util.LinkedList;
  69 import java.util.List;
  70 import java.util.Map;
  71 import java.util.Properties;
  72 
  73 /**
  74  * Date: 2017/2/20
  75  * Company: www.dtstack.com
  76  * @author xuchao
  77  */
  78 
  79 public class LauncherMain {
  80 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  81 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84  * Date: 2017/2/20</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89 public class LauncherMain {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90     private static final String CORE_JAR = &quot;core&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92     private static String SP = File.separator;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94     private static String getLocalCoreJarPath(String localSqlRootJar) throws Exception {</span>
  95 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97     private static final Logger LOG = LoggerFactory.getLogger(LauncherMain.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98     private static final String CORE_JAR = &quot;core&quot;;</span>
  99 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 100 
 101 
 102 
 103 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104     public static JobParamsInfo parseArgs(String[] args) throws Exception {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105         if (args.length == 1 &amp;&amp; args[0].endsWith(&quot;.json&quot;)) {</span>
 106 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111 public class LauncherMain {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112     private static final String CORE_JAR = &quot;core&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114     private static String SP = File.separator;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116     private static String getLocalCoreJarPath(String localSqlRootJar) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117         String jarPath = PluginUtil.getCoreJarFileName(localSqlRootJar, CORE_JAR);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118         String corePath = localSqlRootJar + SP + jarPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119         return corePath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122     public static void main(String[] args) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123         if (args.length == 1 &amp;&amp; args[0].endsWith(&quot;.json&quot;)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124             args = parseJson(args);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         Options launcherOptions = optionParser.getOptions();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128         String mode = launcherOptions.getMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         List&lt;String&gt; argList = optionParser.getProgramExeArgList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130 </span>
 131 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132     public static void main(String[] args) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134         LOG.info(&quot;----start----&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136         if (args.length == 1 &amp;&amp; args[0].endsWith(&quot;.json&quot;)){</span>
 137 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 138             args = parseJson(args);
 139         }
 140 
 141         OptionParser optionParser = new OptionParser(args);
 142         Options launcherOptions = optionParser.getOptions();
 143         List&lt;String&gt; programExeArgList = optionParser.getProgramExeArgList();
 144         String[] execArgs = programExeArgList.toArray(new String[programExeArgList.size()]);
 145 
 146         String name = launcherOptions.getName();
 147         String mode = launcherOptions.getMode();
 148         String localPluginRoot = launcherOptions.getLocalSqlPluginPath();
 149         String flinkConfDir = launcherOptions.getFlinkconf();
 150         String flinkJarPath = launcherOptions.getFlinkJarPath();
 151         String yarnConfDir = launcherOptions.getYarnconf();
 152         String udfJar = launcherOptions.getAddjar();
 153         String queue = launcherOptions.getQueue();
 154         String pluginLoadMode = launcherOptions.getPluginLoadMode();
 155 
<abbr title=" 156         String yarnSessionConf = URLDecoder.decode(launcherOptions.getYarnSessionConf(), Charsets.UTF_8.toString());"> 156         String yarnSessionConf = URLDecoder.decode(launcherOptions.getYarnSessionConf(), Charsets.UTF_8.t🔵</abbr>
<abbr title=" 157         Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 157         Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.cla🔵</abbr>
 158 
 159         String confProp = URLDecoder.decode(launcherOptions.getConfProp(), Charsets.UTF_8.toString());
 160         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);
 161 
 162         return JobParamsInfo.builder()
 163                 .setExecArgs(execArgs)
 164                 .setName(name)
 165                 .setMode(mode)
 166                 .setUdfJar(udfJar)
 167                 .setLocalPluginRoot(localPluginRoot)
 168                 .setFlinkConfDir(flinkConfDir)
 169                 .setYarnConfDir(yarnConfDir)
 170                 .setConfProperties(confProperties)
 171                 .setYarnSessionConfProperties(yarnSessionConfProperties)
 172                 .setFlinkJarPath(flinkJarPath)
 173                 .setPluginLoadMode(pluginLoadMode)
 174                 .setQueue(queue)
 175                 .build();
 176     }
 177 
 178     private static String[] parseJson(String[] args) {
 179         BufferedReader reader = null;
 180         String lastStr = &quot;&quot;;
 181         try {
 182             FileInputStream fileInputStream = new FileInputStream(args[0]);
 183             InputStreamReader inputStreamReader = new InputStreamReader(fileInputStream, &quot;UTF-8&quot;);
 184             reader = new BufferedReader(inputStreamReader);
 185             String tempString = null;
 186             while ((tempString = reader.readLine()) != null) {
 187                 lastStr += tempString;
 188             }
 189             reader.close();
 190         } catch (IOException e) {
 191             e.printStackTrace();
 192         } finally {
 193             if (reader != null) {
 194                 try {
 195                     reader.close();
 196                 } catch (IOException e) {
 197                     e.printStackTrace();
 198                 }
 199             }
 200         }
 201         Map&lt;String, Object&gt; map = JSON.parseObject(lastStr, new TypeReference&lt;Map&lt;String, Object&gt;&gt;() {
 202         });
 203         List&lt;String&gt; list = new LinkedList&lt;&gt;();
 204 
 205         for (Map.Entry&lt;String, Object&gt; entry : map.entrySet()) {
 206             list.add(&quot;-&quot; + entry.getKey());
 207             list.add(entry.getValue().toString());
 208         }
 209         String[] array = list.toArray(new String[list.size()]);
 210         return array;
 211     }
 212 
 213 
 214     public static void main(String[] args) throws Exception {
 215         JobParamsInfo jobParamsInfo = parseArgs(args);
 216         ClusterMode execMode = ClusterMode.valueOf(jobParamsInfo.getMode());
 217 
 218         switch (execMode) {
 219             case local:
 220                 Main.main(jobParamsInfo.getExecArgs());
 221                 break;
 222             case yarn:
 223                 new YarnSessionClusterExecutor(jobParamsInfo).exec();
 224                 break;
 225             case yarnPer:
 226                 new YarnJobClusterExecutor(jobParamsInfo).exec();
 227                 break;
 228             case standalone:
 229                 new StandaloneExecutor(jobParamsInfo).exec();
 230                 break;
 231             default:
 232                 throw new RuntimeException(&quot;Unsupported operating mode, please use local,yarn,yarnPer&quot;);
 233         }
 234     }
 235 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.launcher;
  21 
  22 import com.dtstack.flink.sql.launcher.entity.JobParamsInfo;
  23 import com.dtstack.flink.sql.launcher.executor.StandaloneExecutor;
  24 import com.dtstack.flink.sql.launcher.executor.YarnJobClusterExecutor;
  25 import com.dtstack.flink.sql.launcher.executor.YarnSessionClusterExecutor;
  26 import com.alibaba.fastjson.JSON;
  27 import com.alibaba.fastjson.TypeReference;
  28 import com.dtstack.flink.sql.enums.ClusterMode;
  29 import com.dtstack.flink.sql.Main;
  30 import com.dtstack.flink.sql.option.OptionParser;
  31 import com.dtstack.flink.sql.option.Options;
  32 import com.dtstack.flink.sql.util.PluginUtil;
  33 import org.apache.commons.io.Charsets;
  34 
  35 import java.io.BufferedReader;
  36 import java.io.FileInputStream;
  37 import org.slf4j.Logger;
  38 import org.slf4j.LoggerFactory;
  39 import java.io.IOException;
  40 import java.io.InputStreamReader;
  41 import java.net.URLDecoder;
  42 import java.util.LinkedList;
  43 import java.util.List;
  44 import java.util.Map;
  45 import java.util.Properties;
  46 
  47 /**
  48  * Date: 2017/2/20
  49  * Company: www.dtstack.com
  50  * @author xuchao
  51  */
  52 
  53 public class LauncherMain {
  54 
  55 
  56 
  57     public static JobParamsInfo parseArgs(String[] args) throws Exception {
  58         if (args.length == 1 &amp;&amp; args[0].endsWith(&quot;.json&quot;)) {
  59             args = parseJson(args);
  60         }
  61         OptionParser optionParser = new OptionParser(args);
  62         Options launcherOptions = optionParser.getOptions();
  63         List&lt;String&gt; programExeArgList = optionParser.getProgramExeArgList();
  64         String[] execArgs = programExeArgList.toArray(new String[programExeArgList.size()]);
  65 
  66         String name = launcherOptions.getName();
  67         String mode = launcherOptions.getMode();
  68         String localPluginRoot = launcherOptions.getLocalSqlPluginPath();
  69         String flinkConfDir = launcherOptions.getFlinkconf();
  70         String flinkJarPath = launcherOptions.getFlinkJarPath();
  71         String yarnConfDir = launcherOptions.getYarnconf();
  72         String udfJar = launcherOptions.getAddjar();
  73         String queue = launcherOptions.getQueue();
  74         String pluginLoadMode = launcherOptions.getPluginLoadMode();
  75 
<abbr title="  76         String yarnSessionConf = URLDecoder.decode(launcherOptions.getYarnSessionConf(), Charsets.UTF_8.toString());">  76         String yarnSessionConf = URLDecoder.decode(launcherOptions.getYarnSessionConf(), Charsets.UTF_8.t🔵</abbr>
<abbr title="  77         Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);">  77         Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.cla🔵</abbr>
  78 
  79         String confProp = URLDecoder.decode(launcherOptions.getConfProp(), Charsets.UTF_8.toString());
  80         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);
  81 
  82         return JobParamsInfo.builder()
  83                 .setExecArgs(execArgs)
  84                 .setName(name)
  85                 .setMode(mode)
  86                 .setUdfJar(udfJar)
  87                 .setLocalPluginRoot(localPluginRoot)
  88                 .setFlinkConfDir(flinkConfDir)
  89                 .setYarnConfDir(yarnConfDir)
  90                 .setConfProperties(confProperties)
  91                 .setYarnSessionConfProperties(yarnSessionConfProperties)
  92                 .setFlinkJarPath(flinkJarPath)
  93                 .setPluginLoadMode(pluginLoadMode)
  94                 .setQueue(queue)
  95                 .build();
  96     }
  97 
  98     private static final Logger LOG = LoggerFactory.getLogger(LauncherMain.class);
  99 
 100 
 101     public static void main(String[] args) throws Exception {
 102 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         JobParamsInfo jobParamsInfo = parseArgs(args);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         ClusterMode execMode = ClusterMode.valueOf(jobParamsInfo.getMode());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106         switch (execMode) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107             case local:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108                 Main.main(jobParamsInfo.getExecArgs());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109                 break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110             case yarn:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111                 new YarnSessionClusterExecutor(jobParamsInfo).exec();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112                 break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113             case yarnPer:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114                 new YarnJobClusterExecutor(jobParamsInfo).exec();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115                 break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116             case standalone:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117                 new StandaloneExecutor(jobParamsInfo).exec();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118                 break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119             default:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120                 throw new RuntimeException(&quot;Unsupported operating mode, please use local,yarn,yarnPer&quot;);</span>
 121 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122         if (args.length == 1 &amp;&amp; args[0].endsWith(&quot;.json&quot;)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123             args = parseJson(args);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         Options launcherOptions = optionParser.getOptions();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         String mode = launcherOptions.getMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128         List&lt;String&gt; argList = optionParser.getProgramExeArgList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130         String confProp = launcherOptions.getConfProp();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131         confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         if(mode.equals(ClusterMode.local.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135             String[] localArgs = argList.toArray(new String[argList.size()]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136             Main.main(localArgs);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 </span>
 140 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142         LOG.info(&quot;----start----&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144         if (args.length == 1 &amp;&amp; args[0].endsWith(&quot;.json&quot;)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145             args = parseJson(args);</span>
 146 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 147         }
 148 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 149 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150         List&lt;String&gt; argList = optionParser.getProgramExeArgList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152         String confProp = launcherOptions.getConfProp();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153         confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156         if(mode.equals(ClusterMode.local.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157             String[] localArgs = argList.toArray(new String[argList.size()]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158             Main.main(localArgs);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162         String pluginRoot = launcherOptions.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163         File jarFile = new File(getLocalCoreJarPath(pluginRoot));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164         String[] remoteArgs = argList.toArray(new String[argList.size()]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         PackagedProgram program = new PackagedProgram(jarFile, Lists.newArrayList(), remoteArgs);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         String savePointPath = confProperties.getProperty(ConfigConstrant.SAVE_POINT_PATH_KEY);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168         if(StringUtils.isNotBlank(savePointPath)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 169             String allowNonRestoredState = confProperties.getOrDefault(ConfigConstrant.ALLOW_NON_RESTORED_STATE_KEY, &quot;false&quot;).toString();"> 169             String allowNonRestoredState = confProperties.getOrDefault(ConfigConstrant.ALLOW_NON_RESTORED🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 170             program.setSavepointRestoreSettings(SavepointRestoreSettings.forPath(savePointPath, BooleanUtils.toBoolean(allowNonRestoredState)));"> 170             program.setSavepointRestoreSettings(SavepointRestoreSettings.forPath(savePointPath, BooleanUt🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         if(mode.equals(ClusterMode.yarnPer.name())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174             String flinkConfDir = launcherOptions.getFlinkconf();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 175             Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);"> 175             Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfig🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176             JobGraph jobGraph = PackagedProgramUtils.createJobGraph(program, config, 1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177             PerJobSubmitter.submit(launcherOptions, jobGraph, config);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179             ClusterClient clusterClient = ClusterClientFactory.createClusterClient(launcherOptions);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180             clusterClient.run(program, 1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181             clusterClient.shutdown();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184     }</span>
 185 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187         OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188         Options launcherOptions = optionParser.getOptions();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189         String mode = launcherOptions.getMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190         List&lt;String&gt; argList = optionParser.getProgramExeArgList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192         String confProp = launcherOptions.getConfProp();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193         confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196         if(mode.equals(ClusterMode.local.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197             String[] localArgs = argList.toArray(new String[argList.size()]);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198             Main.main(localArgs);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202         String pluginRoot = launcherOptions.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203         File jarFile = new File(getLocalCoreJarPath(pluginRoot));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204         String[] remoteArgs = argList.toArray(new String[argList.size()]);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205         PackagedProgram program = new PackagedProgram(jarFile, Lists.newArrayList(), remoteArgs);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207         String savePointPath = confProperties.getProperty(ConfigConstrant.SAVE_POINT_PATH_KEY);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208         if(StringUtils.isNotBlank(savePointPath)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 209             String allowNonRestoredState = confProperties.getOrDefault(ConfigConstrant.ALLOW_NON_RESTORED_STATE_KEY, &quot;false&quot;).toString();"> 209             String allowNonRestoredState = confProperties.getOrDefault(ConfigConstrant.ALLOW_NON_RESTORED🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 210             program.setSavepointRestoreSettings(SavepointRestoreSettings.forPath(savePointPath, BooleanUtils.toBoolean(allowNonRestoredState)));"> 210             program.setSavepointRestoreSettings(SavepointRestoreSettings.forPath(savePointPath, BooleanUt🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213         if(mode.equals(ClusterMode.yarnPer.name())){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214             String flinkConfDir = launcherOptions.getFlinkconf();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 215             Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);"> 215             Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfig🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216             JobGraph jobGraph = PackagedProgramUtils.createJobGraph(program, config, 1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217             PerJobSubmitter.submit(launcherOptions, jobGraph, config);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219             ClusterClient clusterClient = ClusterClientFactory.createClusterClient(launcherOptions);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220             clusterClient.run(program, 1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221             clusterClient.shutdown();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223 </span>
 224 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 225     }
 226 
 227     private static String[] parseJson(String[] args) {
 228         BufferedReader reader = null;
 229         String lastStr = &quot;&quot;;
 230         try {
 231             FileInputStream fileInputStream = new FileInputStream(args[0]);
 232             InputStreamReader inputStreamReader = new InputStreamReader(fileInputStream, &quot;UTF-8&quot;);
 233             reader = new BufferedReader(inputStreamReader);
 234             String tempString = null;
 235             while ((tempString = reader.readLine()) != null) {
 236                 lastStr += tempString;
 237             }
 238             reader.close();
 239         } catch (IOException e) {
 240             e.printStackTrace();
 241         } finally {
 242             if (reader != null) {
 243                 try {
 244                     reader.close();
 245                 } catch (IOException e) {
 246                     e.printStackTrace();
 247                 }
 248             }
 249         }
 250         Map&lt;String, Object&gt; map = JSON.parseObject(lastStr, new TypeReference&lt;Map&lt;String, Object&gt;&gt;() {
 251         });
 252         List&lt;String&gt; list = new LinkedList&lt;&gt;();
 253 
 254         for (Map.Entry&lt;String, Object&gt; entry : map.entrySet()) {
 255             list.add(&quot;-&quot; + entry.getKey());
 256             list.add(entry.getValue().toString());
 257         }
 258         String[] array = list.toArray(new String[list.size()]);
 259         return array;
 260     }
 261 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.launcher;
  19 
  20 import com.alibaba.fastjson.JSON;
  21 import com.alibaba.fastjson.TypeReference;
  22 import com.dtstack.flink.sql.Main;
  23 import com.dtstack.flink.sql.enums.ClusterMode;
  24 import com.dtstack.flink.sql.launcher.entity.JobParamsInfo;
  25 import com.dtstack.flink.sql.launcher.executor.StandaloneExecutor;
  26 import com.dtstack.flink.sql.launcher.executor.YarnJobClusterExecutor;
  27 import com.dtstack.flink.sql.launcher.executor.YarnSessionClusterExecutor;
  28 import com.dtstack.flink.sql.option.OptionParser;
  29 import com.dtstack.flink.sql.option.Options;
  30 import com.dtstack.flink.sql.util.PluginUtil;
  31 import java.io.BufferedReader;
  32 import java.io.FileInputStream;
  33 import java.io.IOException;
  34 import java.io.InputStreamReader;
  35 import java.net.URLDecoder;
  36 import java.util.LinkedList;
  37 import java.util.List;
  38 import java.util.Map;
  39 import java.util.Properties;
  40 import org.apache.commons.io.Charsets;
  41 import org.slf4j.Logger;
  42 import org.slf4j.LoggerFactory;
  43 
  44 
  45 /**
  46  * Date: 2017/2/20
  47  * Company: www.dtstack.com
  48  * @author xuchao
  49  */
  50 
  51 public class LauncherMain {
  52 
  53 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54 </span>
  55 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  56 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  56 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
  57 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60     private static final Logger LOG = LoggerFactory.getLogger(LauncherMain.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61     private static final String CORE_JAR = &quot;core&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62 </span>
  63 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
  64 
  65 
  66 
  67 
  68 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69     public static JobParamsInfo parseArgs(String[] args) throws Exception {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70         if (args.length == 1 &amp;&amp; args[0].endsWith(&quot;.json&quot;)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71 </span>
  72 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  73 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  73 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
  74 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76     public static void main(String[] args) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78         LOG.info(&quot;----start----&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80         if (args.length == 1 &amp;&amp; args[0].endsWith(&quot;.json&quot;)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81 </span>
  82 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
  83             args = parseJson(args);
  84         }
  85 
  86         OptionParser optionParser = new OptionParser(args);
  87         Options launcherOptions = optionParser.getOptions();
  88         List&lt;String&gt; programExeArgList = optionParser.getProgramExeArgList();
  89         String[] execArgs = programExeArgList.toArray(new String[programExeArgList.size()]);
  90 
  91         String name = launcherOptions.getName();
  92         String mode = launcherOptions.getMode();
  93         String localPluginRoot = launcherOptions.getLocalSqlPluginPath();
  94         String flinkConfDir = launcherOptions.getFlinkconf();
  95         String flinkJarPath = launcherOptions.getFlinkJarPath();
  96         String yarnConfDir = launcherOptions.getYarnconf();
  97         String udfJar = launcherOptions.getAddjar();
  98         String queue = launcherOptions.getQueue();
  99         String pluginLoadMode = launcherOptions.getPluginLoadMode();
 100 
<abbr title=" 101         String yarnSessionConf = URLDecoder.decode(launcherOptions.getYarnSessionConf(), Charsets.UTF_8.toString());"> 101         String yarnSessionConf = URLDecoder.decode(launcherOptions.getYarnSessionConf(), Charsets.UTF_8.t🔵</abbr>
<abbr title=" 102         Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 102         Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.cla🔵</abbr>
 103 
 104         String confProp = URLDecoder.decode(launcherOptions.getConfProp(), Charsets.UTF_8.toString());
 105         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);
 106 
 107         return JobParamsInfo.builder()
 108                 .setExecArgs(execArgs)
 109                 .setName(name)
 110                 .setMode(mode)
 111                 .setUdfJar(udfJar)
 112                 .setLocalPluginRoot(localPluginRoot)
 113                 .setFlinkConfDir(flinkConfDir)
 114                 .setYarnConfDir(yarnConfDir)
 115                 .setConfProperties(confProperties)
 116                 .setYarnSessionConfProperties(yarnSessionConfProperties)
 117                 .setFlinkJarPath(flinkJarPath)
 118                 .setPluginLoadMode(pluginLoadMode)
 119                 .setQueue(queue)
 120                 .build();
 121     }
 122 
 123     private static String[] parseJson(String[] args) {
 124         BufferedReader reader = null;
 125         String lastStr = &quot;&quot;;
 126         try {
 127             FileInputStream fileInputStream = new FileInputStream(args[0]);
 128             InputStreamReader inputStreamReader = new InputStreamReader(fileInputStream, &quot;UTF-8&quot;);
 129             reader = new BufferedReader(inputStreamReader);
 130             String tempString = null;
 131             while ((tempString = reader.readLine()) != null) {
 132                 lastStr += tempString;
 133             }
 134             reader.close();
 135         } catch (IOException e) {
 136             e.printStackTrace();
 137         } finally {
 138             if (reader != null) {
 139                 try {
 140                     reader.close();
 141                 } catch (IOException e) {
 142                     e.printStackTrace();
 143                 }
 144             }
 145         }
 146         Map&lt;String, Object&gt; map = JSON.parseObject(lastStr, new TypeReference&lt;Map&lt;String, Object&gt;&gt;() {
 147         });
 148         List&lt;String&gt; list = new LinkedList&lt;&gt;();
 149 
 150         for (Map.Entry&lt;String, Object&gt; entry : map.entrySet()) {
 151             list.add(&quot;-&quot; + entry.getKey());
 152             list.add(entry.getValue().toString());
 153         }
 154         String[] array = list.toArray(new String[list.size()]);
 155         return array;
 156     }
 157 
 158 
 159     public static void main(String[] args) throws Exception {
 160         JobParamsInfo jobParamsInfo = parseArgs(args);
 161         ClusterMode execMode = ClusterMode.valueOf(jobParamsInfo.getMode());
 162 
 163         switch (execMode) {
 164             case local:
 165                 Main.main(jobParamsInfo.getExecArgs());
 166                 break;
 167             case yarn:
 168                 new YarnSessionClusterExecutor(jobParamsInfo).exec();
 169                 break;
 170             case yarnPer:
 171                 new YarnJobClusterExecutor(jobParamsInfo).exec();
 172                 break;
 173             case standalone:
 174                 new StandaloneExecutor(jobParamsInfo).exec();
 175                 break;
 176             default:
 177                 throw new RuntimeException(&quot;Unsupported operating mode, please use local,yarn,yarnPer&quot;);
 178         }
 179     }
 180 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -</span>
  21  package com.dtstack.flink.sql.launcher;
  22  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.constrant.ConfigConstrant;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import com.dtstack.flink.sql.launcher.entity.JobParamsInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import com.dtstack.flink.sql.launcher.executor.StandaloneExecutor;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import com.dtstack.flink.sql.launcher.executor.YarnJobClusterExecutor;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import com.dtstack.flink.sql.launcher.executor.YarnSessionClusterExecutor;</span>
  29  import com.alibaba.fastjson.JSON;
  30  import com.alibaba.fastjson.TypeReference;
  31  import com.dtstack.flink.sql.enums.ClusterMode;
  32  import com.dtstack.flink.sql.Main;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import com.dtstack.flink.sql.launcher.perjob.PerJobSubmitter;</span>
  34  import com.dtstack.flink.sql.option.OptionParser;
  35  import com.dtstack.flink.sql.option.Options;
  36  import com.dtstack.flink.sql.util.PluginUtil;
  37  import org.apache.commons.io.Charsets;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import org.apache.commons.lang.BooleanUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import org.apache.commons.lang.StringUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import org.apache.flink.client.program.ClusterClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import org.apache.flink.client.program.PackagedProgram;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import org.apache.flink.client.program.PackagedProgramUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import org.apache.flink.configuration.GlobalConfiguration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import org.apache.flink.runtime.jobgraph.SavepointRestoreSettings;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import org.apache.flink.util.FileUtils;</span>


  48  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -import java.io.File;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +import java.io.BufferedReader;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +import java.io.FileInputStream;</span>
  52  import java.io.IOException;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +import java.io.InputStreamReader;</span>
  54  import java.net.URLDecoder;
  55  import java.util.LinkedList;
  56  import java.util.List;
  57  import java.util.Map;
  58  import java.util.Properties;
  59  
  60  /**
  61   * Date: 2017/2/20
  62   * Company: www.dtstack.com
  63   * @author xuchao
  64   */
  65  
  66  public class LauncherMain {


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -    private static final String CORE_JAR = &quot;core&quot;;</span>
  68  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -    private static String SP = File.separator;</span>
  70  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -    private static String getLocalCoreJarPath(String localSqlRootJar) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -        String jarPath = PluginUtil.getCoreJarFileName(localSqlRootJar, CORE_JAR);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -        String corePath = localSqlRootJar + SP + jarPath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -        return corePath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -    }</span>
  76  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -    public static void main(String[] args) throws Exception {</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -        if (args.length == 1 &amp;&amp; args[0].endsWith(&quot;.json&quot;)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +    public static JobParamsInfo parseArgs(String[] args) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +        if (args.length == 1 &amp;&amp; args[0].endsWith(&quot;.json&quot;)) {</span>
  81              args = parseJson(args);
  82          }

  83          OptionParser optionParser = new OptionParser(args);
  84          Options launcherOptions = optionParser.getOptions();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +        List&lt;String&gt; programExeArgList = optionParser.getProgramExeArgList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +        String[] execArgs = programExeArgList.toArray(new String[programExeArgList.size()]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +        String name = launcherOptions.getName();</span>
  89          String mode = launcherOptions.getMode();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -        List&lt;String&gt; argList = optionParser.getProgramExeArgList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +        String localPluginRoot = launcherOptions.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +        String flinkConfDir = launcherOptions.getFlinkconf();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +        String flinkJarPath = launcherOptions.getFlinkJarPath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +        String yarnConfDir = launcherOptions.getYarnconf();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +        String udfJar = launcherOptions.getAddjar();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +        String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +        String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
  98  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -        String confProp = launcherOptions.getConfProp();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -        confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 101 +        String yarnSessionConf = URLDecoder.decode(launcherOptions.getYarnSessionConf(), Charsets.UTF_8.toString());"> 101 +        String yarnSessionConf = URLDecoder.decode(launcherOptions.getYarnSessionConf(), Charsets.UTF_8.toString()🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +        Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        String confProp = URLDecoder.decode(launcherOptions.getConfProp(), Charsets.UTF_8.toString());</span>
 105          Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);
 106  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -        if(mode.equals(ClusterMode.local.name())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -            String[] localArgs = argList.toArray(new String[argList.size()]);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -            Main.main(localArgs);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -            return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -        String pluginRoot = launcherOptions.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -        File jarFile = new File(getLocalCoreJarPath(pluginRoot));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -        String[] remoteArgs = argList.toArray(new String[argList.size()]);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -        PackagedProgram program = new PackagedProgram(jarFile, Lists.newArrayList(), remoteArgs);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -        String savePointPath = confProperties.getProperty(ConfigConstrant.SAVE_POINT_PATH_KEY);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -        if(StringUtils.isNotBlank(savePointPath)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 120 -            String allowNonRestoredState = confProperties.getOrDefault(ConfigConstrant.ALLOW_NON_RESTORED_STATE_KEY, &quot;false&quot;).toString();"> 120 -            String allowNonRestoredState = confProperties.getOrDefault(ConfigConstrant.ALLOW_NON_RESTORED_STATE_KE🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 121 -            program.setSavepointRestoreSettings(SavepointRestoreSettings.forPath(savePointPath, BooleanUtils.toBoolean(allowNonRestoredState)));"> 121 -            program.setSavepointRestoreSettings(SavepointRestoreSettings.forPath(savePointPath, BooleanUtils.toBoo🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -        if(mode.equals(ClusterMode.yarnPer.name())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -            String flinkConfDir = launcherOptions.getFlinkconf();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 126 -            Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);"> 126 -            Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.l🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -            JobGraph jobGraph = PackagedProgramUtils.createJobGraph(program, config, 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -            PerJobSubmitter.submit(launcherOptions, jobGraph, config);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -            ClusterClient clusterClient = ClusterClientFactory.createClusterClient(launcherOptions);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -            clusterClient.run(program, 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -            clusterClient.shutdown();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +        return JobParamsInfo.builder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +                .setExecArgs(execArgs)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +                .setName(name)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +                .setMode(mode)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +                .setUdfJar(udfJar)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +                .setLocalPluginRoot(localPluginRoot)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +                .setFlinkConfDir(flinkConfDir)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +                .setYarnConfDir(yarnConfDir)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +                .setConfProperties(confProperties)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +                .setYarnSessionConfProperties(yarnSessionConfProperties)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +                .setFlinkJarPath(flinkJarPath)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +                .setPluginLoadMode(pluginLoadMode)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +                .setQueue(queue)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +                .build();</span>
 149      }
 150  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -    private static String[] parseJson(String[] args) throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -        String lastStr = FileUtils.readFileUtf8(new File(args[0]));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +    private static String[] parseJson(String[] args) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +        BufferedReader reader = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +        String lastStr = &quot;&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +            FileInputStream fileInputStream = new FileInputStream(args[0]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +            InputStreamReader inputStreamReader = new InputStreamReader(fileInputStream, &quot;UTF-8&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +            reader = new BufferedReader(inputStreamReader);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +            String tempString = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +            while ((tempString = reader.readLine()) != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +                lastStr += tempString;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +            reader.close();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +        } catch (IOException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +            e.printStackTrace();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +        } finally {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +            if (reader != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +                try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +                    reader.close();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +                } catch (IOException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +                    e.printStackTrace();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +        }</span>
 176          Map&lt;String, Object&gt; map = JSON.parseObject(lastStr, new TypeReference&lt;Map&lt;String, Object&gt;&gt;() {
 177          });
 178          List&lt;String&gt; list = new LinkedList&lt;&gt;();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +</span>
 180          for (Map.Entry&lt;String, Object&gt; entry : map.entrySet()) {
 181              list.add(&quot;-&quot; + entry.getKey());
 182              list.add(entry.getValue().toString());
 183          }
 184          String[] array = list.toArray(new String[list.size()]);
 185          return array;
 186      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +    public static void main(String[] args) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +        JobParamsInfo jobParamsInfo = parseArgs(args);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +        ClusterMode execMode = ClusterMode.valueOf(jobParamsInfo.getMode());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +        switch (execMode) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +            case local:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +                Main.main(jobParamsInfo.getExecArgs());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +            case yarn:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +                new YarnSessionClusterExecutor(jobParamsInfo).exec();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +            case yarnPer:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +                new YarnJobClusterExecutor(jobParamsInfo).exec();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +            case standalone:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +                new StandaloneExecutor(jobParamsInfo).exec();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +            default:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +                throw new RuntimeException(&quot;Unsupported operating mode, please use local,yarn,yarnPer&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +    }</span>
 210  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  
  21  package com.dtstack.flink.sql.launcher;
  22  
  23  import com.dtstack.flink.sql.constrant.ConfigConstrant;
  24  import com.google.common.collect.Lists;




  25  import com.alibaba.fastjson.JSON;
  26  import com.alibaba.fastjson.TypeReference;
  27  import com.dtstack.flink.sql.enums.ClusterMode;
  28  import com.dtstack.flink.sql.Main;
  29  import com.dtstack.flink.sql.launcher.perjob.PerJobSubmitter;
  30  import com.dtstack.flink.sql.option.OptionParser;
  31  import com.dtstack.flink.sql.option.Options;
  32  import com.dtstack.flink.sql.util.PluginUtil;
  33  import org.apache.commons.io.Charsets;
  34  import org.apache.commons.lang.BooleanUtils;
  35  import org.apache.commons.lang.StringUtils;
  36  import org.apache.flink.client.program.ClusterClient;
  37  import org.apache.flink.client.program.PackagedProgram;
  38  import org.apache.flink.client.program.PackagedProgramUtils;
  39  import org.apache.flink.configuration.Configuration;
  40  import org.apache.flink.configuration.GlobalConfiguration;
  41  import org.apache.flink.runtime.jobgraph.JobGraph;
  42  import org.apache.flink.runtime.jobgraph.SavepointRestoreSettings;
  43  import org.apache.flink.util.FileUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import org.slf4j.LoggerFactory;</span>
  46  
  47  import java.io.File;


  48  import java.io.IOException;

  49  import java.net.URLDecoder;
  50  import java.util.LinkedList;
  51  import java.util.List;
  52  import java.util.Map;
  53  import java.util.Properties;
  54  
  55  /**
  56   * Date: 2017/2/20
  57   * Company: www.dtstack.com
  58   * @author xuchao
  59   */
  60  
  61  public class LauncherMain {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +    private static final Logger LOG = LoggerFactory.getLogger(LauncherMain.class);</span>
  64      private static final String CORE_JAR = &quot;core&quot;;
  65  
  66      private static String SP = File.separator;
  67  
  68      private static String getLocalCoreJarPath(String localSqlRootJar) throws Exception {
  69          String jarPath = PluginUtil.getCoreJarFileName(localSqlRootJar, CORE_JAR);
  70          String corePath = localSqlRootJar + SP + jarPath;
  71          return corePath;
  72      }
  73  
  74      public static void main(String[] args) throws Exception {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +        LOG.info(&quot;----start----&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +</span>
  78          if (args.length == 1 &amp;&amp; args[0].endsWith(&quot;.json&quot;)){


  79              args = parseJson(args);
  80          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +</span>
  82          OptionParser optionParser = new OptionParser(args);
  83          Options launcherOptions = optionParser.getOptions();




  84          String mode = launcherOptions.getMode();
  85          List&lt;String&gt; argList = optionParser.getProgramExeArgList();







  86  
  87          String confProp = launcherOptions.getConfProp();
  88          confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());




  89          Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);
  90  
  91          if(mode.equals(ClusterMode.local.name())) {
  92              String[] localArgs = argList.toArray(new String[argList.size()]);
  93              Main.main(localArgs);
  94              return;
  95          }
  96  
  97          String pluginRoot = launcherOptions.getLocalSqlPluginPath();
  98          File jarFile = new File(getLocalCoreJarPath(pluginRoot));
  99          String[] remoteArgs = argList.toArray(new String[argList.size()]);
 100          PackagedProgram program = new PackagedProgram(jarFile, Lists.newArrayList(), remoteArgs);
 101  
 102          String savePointPath = confProperties.getProperty(ConfigConstrant.SAVE_POINT_PATH_KEY);
 103          if(StringUtils.isNotBlank(savePointPath)){
<abbr title=" 104              String allowNonRestoredState = confProperties.getOrDefault(ConfigConstrant.ALLOW_NON_RESTORED_STATE_KEY, &quot;false&quot;).toString();"> 104              String allowNonRestoredState = confProperties.getOrDefault(ConfigConstrant.ALLOW_NON_RESTORED_STATE_KE🔵</abbr>
<abbr title=" 105              program.setSavepointRestoreSettings(SavepointRestoreSettings.forPath(savePointPath, BooleanUtils.toBoolean(allowNonRestoredState)));"> 105              program.setSavepointRestoreSettings(SavepointRestoreSettings.forPath(savePointPath, BooleanUtils.toBoo🔵</abbr>
 106          }
 107  
 108          if(mode.equals(ClusterMode.yarnPer.name())){
 109              String flinkConfDir = launcherOptions.getFlinkconf();
<abbr title=" 110              Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);"> 110              Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.l🔵</abbr>
 111              JobGraph jobGraph = PackagedProgramUtils.createJobGraph(program, config, 1);
 112              PerJobSubmitter.submit(launcherOptions, jobGraph, config);
 113          } else {
 114              ClusterClient clusterClient = ClusterClientFactory.createClusterClient(launcherOptions);
 115              clusterClient.run(program, 1);
 116              clusterClient.shutdown();
 117          }
 118  














 119      }
 120  
 121      private static String[] parseJson(String[] args) throws IOException {
 122          String lastStr = FileUtils.readFileUtf8(new File(args[0]));























 123          Map&lt;String, Object&gt; map = JSON.parseObject(lastStr, new TypeReference&lt;Map&lt;String, Object&gt;&gt;() {
 124          });
 125          List&lt;String&gt; list = new LinkedList&lt;&gt;();

 126          for (Map.Entry&lt;String, Object&gt; entry : map.entrySet()) {
 127              list.add(&quot;-&quot; + entry.getKey());
 128              list.add(entry.getValue().toString());
 129          }
 130          String[] array = list.toArray(new String[list.size()]);
 131          return array;
 132      }























 133  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            