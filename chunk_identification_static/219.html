<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>219</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    219
                    <a href="218.html">prev</a>
                    <a href="220.html">next</a>
                    <a href="219_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_85784acfd63b348aa9271a84368432c2699a9d67_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/domain/SkuImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;85784acfd63b348aa9271a84368432c2699a9d67:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/domain/SkuImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;85784acfd63b348aa9271a84368432c2699a9d67^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/domain/SkuImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;85784acfd63b348aa9271a84368432c2699a9d67^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/domain/SkuImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ce5c9279711e306f5901899835666ffa510d85bd:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/domain/SkuImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.catalog.domain;
  19 
  20 import org.apache.commons.beanutils.MethodUtils;
  21 import org.apache.commons.collections.MapUtils;
  22 import org.apache.commons.collections.map.MultiValueMap;
  23 import org.apache.commons.lang.StringUtils;
  24 import org.apache.commons.logging.Log;
  25 import org.apache.commons.logging.LogFactory;
  26 import org.broadleafcommerce.common.copy.CreateResponse;
  27 import org.broadleafcommerce.common.copy.MultiTenantCopyContext;
  28 import org.broadleafcommerce.common.currency.domain.BroadleafCurrency;
  29 import org.broadleafcommerce.common.currency.domain.BroadleafCurrencyImpl;
  30 import org.broadleafcommerce.common.extensibility.jpa.clone.ClonePolicyArchive;
  31 import org.broadleafcommerce.common.extensibility.jpa.clone.ClonePolicyCollectionOverride;
  32 import org.broadleafcommerce.common.extensibility.jpa.clone.IgnoreEnterpriseBehavior;
  33 import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransform;
  34 import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransformMember;
  35 import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransformTypes;
  36 import org.broadleafcommerce.common.i18n.service.DynamicTranslationProvider;
  37 import org.broadleafcommerce.common.media.domain.Media;
  38 import org.broadleafcommerce.common.money.Money;
  39 import org.broadleafcommerce.common.presentation.AdminPresentation;
  40 import org.broadleafcommerce.common.presentation.AdminPresentationCollection;
  41 import org.broadleafcommerce.common.presentation.AdminPresentationDataDrivenEnumeration;
  42 import org.broadleafcommerce.common.presentation.AdminPresentationMap;
  43 import org.broadleafcommerce.common.presentation.AdminPresentationMapField;
  44 import org.broadleafcommerce.common.presentation.AdminPresentationMapFields;
  45 import org.broadleafcommerce.common.presentation.AdminPresentationToOneLookup;
  46 import org.broadleafcommerce.common.presentation.ConfigurationItem;
  47 import org.broadleafcommerce.common.presentation.OptionFilterParam;
  48 import org.broadleafcommerce.common.presentation.OptionFilterParamType;
  49 import org.broadleafcommerce.common.presentation.ValidationConfiguration;
  50 import org.broadleafcommerce.common.presentation.client.LookupType;
  51 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  52 import org.broadleafcommerce.common.presentation.client.VisibilityEnum;
  53 import org.broadleafcommerce.common.util.DateUtil;
  54 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  55 import org.broadleafcommerce.core.catalog.service.dynamic.DynamicSkuPrices;
  56 import org.broadleafcommerce.core.catalog.service.dynamic.SkuActiveDateConsiderationContext;
  57 import org.broadleafcommerce.core.catalog.service.dynamic.SkuPricingConsiderationContext;
  58 import org.broadleafcommerce.core.inventory.service.type.InventoryType;
  59 import org.broadleafcommerce.core.order.domain.FulfillmentOption;
  60 import org.broadleafcommerce.core.order.domain.FulfillmentOptionImpl;
  61 import org.broadleafcommerce.core.order.service.type.FulfillmentType;
  62 import org.broadleafcommerce.core.search.domain.FieldEntity;
  63 import org.hibernate.annotations.BatchSize;
  64 import org.hibernate.annotations.Cache;
  65 import org.hibernate.annotations.CacheConcurrencyStrategy;
  66 import org.hibernate.annotations.Cascade;
  67 import org.hibernate.annotations.GenericGenerator;
  68 import org.hibernate.annotations.Index;
  69 import org.hibernate.annotations.Parameter;
  70 import org.hibernate.annotations.Type;
  71 
  72 import java.lang.reflect.InvocationHandler;
  73 import java.lang.reflect.Method;
  74 import java.lang.reflect.Proxy;
  75 import java.math.BigDecimal;
  76 import java.util.ArrayList;
  77 import java.util.Collection;
  78 import java.util.Collections;
  79 import java.util.Comparator;
  80 import java.util.Date;
  81 import java.util.HashMap;
  82 import java.util.HashSet;
  83 import java.util.LinkedHashMap;
  84 import java.util.List;
  85 import java.util.Map;
  86 import java.util.Set;
  87 import java.util.function.Function;
  88 import java.util.stream.Collectors;
  89 
  90 import javax.persistence.CascadeType;
  91 import javax.persistence.CollectionTable;
  92 import javax.persistence.Column;
  93 import javax.persistence.ElementCollection;
  94 import javax.persistence.Embedded;
  95 import javax.persistence.Entity;
  96 import javax.persistence.FetchType;
  97 import javax.persistence.GeneratedValue;
  98 import javax.persistence.Id;
  99 import javax.persistence.Inheritance;
 100 import javax.persistence.InheritanceType;
 101 import javax.persistence.JoinColumn;
 102 import javax.persistence.JoinTable;
 103 import javax.persistence.Lob;
 104 import javax.persistence.ManyToMany;
 105 import javax.persistence.ManyToOne;
 106 import javax.persistence.MapKey;
 107 import javax.persistence.MapKeyClass;
 108 import javax.persistence.MapKeyJoinColumn;
 109 import javax.persistence.OneToMany;
 110 import javax.persistence.OneToOne;
 111 import javax.persistence.Table;
 112 import javax.persistence.Transient;
 113 
 114 /**
 115  * The Class SkuImpl is the default implementation of {@link Sku}. A SKU is a
 116  * specific item that can be sold including any specific attributes of the item
 117  * such as color or size. &lt;br&gt;
 118  * &lt;br&gt;
 119  * If you want to add fields specific to your implementation of
 120  * BroadLeafCommerce you should extend this class and add your fields. If you
 121  * need to make significant changes to the SkuImpl then you should implement
 122  * your own version of {@link Sku}.&lt;br&gt;
 123  * &lt;br&gt;
 124  * This implementation uses a Hibernate implementation of JPA configured through
 125  * annotations. The Entity references the following tables: BLC_SKU,
 126  * BLC_SKU_IMAGE
 127  *
 128  * !!!!!!!!!!!!!!!!!
<abbr title=" 129  * &lt;p&gt;For admin required field validation, if this Sku is apart of an additionalSkus list (meaning it is not a defaultSku) then"> 129  * &lt;p&gt;For admin required field validation, if this Sku is apart of an additionalSkus list (meaning it is ðŸ”µ</abbr>
<abbr title=" 130  * it should have no required restrictions on it. All additional Skus can delegate to the defaultSku of the related product"> 130  * it should have no required restrictions on it. All additional Skus can delegate to the defaultSku of tðŸ”µ</abbr>
<abbr title=" 131  * for all of its fields. For this reason, if you would like to mark more fields as required then rather than using"> 131  * for all of its fields. For this reason, if you would like to mark more fields as required then rather ðŸ”µ</abbr>
<abbr title=" 132  * {@link AdminPresentation#requiredOverride()}, use the mo:overrides section in bl-admin-applicationContext.xml for Product"> 132  * {@link AdminPresentation#requiredOverride()}, use the mo:overrides section in bl-admin-applicationContðŸ”µ</abbr>
 133  * and reference each required field like &#x27;defaultSku.name&#x27; or &#x27;defaultSku.retailPrice&#x27;.&lt;/p&gt;
 134  *
 135  * @author btaylor
 136  * @see {@link Sku}
 137  */
 138 @Entity
 139 @Inheritance(strategy = InheritanceType.JOINED)
 140 @Table(name = &quot;BLC_SKU&quot;)
<abbr title=" 141 //multi-column indexes don&#x27;t appear to get exported correctly when declared at the field level, so declaring here as a workaround"> 141 //multi-column indexes don&#x27;t appear to get exported correctly when declared at the field level, so declarðŸ”µ</abbr>
 142 @org.hibernate.annotations.Table(appliesTo = &quot;BLC_SKU&quot;, indexes = {
 143     @Index(name = &quot;SKU_URL_KEY_INDEX&quot;,
 144         columnNames = { &quot;URL_KEY&quot; }
 145     )
 146 })
 147 @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 148 @DirectCopyTransform({
 149         @DirectCopyTransformMember(templateTokens = DirectCopyTransformTypes.SANDBOX, skipOverlaps=true),
 150         @DirectCopyTransformMember(templateTokens = DirectCopyTransformTypes.MULTITENANT_CATALOG)
 151 })
 152 public class SkuImpl implements Sku, SkuAdminPresentation {
 153     
 154     private static final Log LOG = LogFactory.getLog(SkuImpl.class);
 155     
 156     private static final long serialVersionUID = 1L;
 157 
 158     @Id
 159     @GeneratedValue(generator = &quot;SkuId&quot;)
 160     @GenericGenerator(
 161         name = &quot;SkuId&quot;,
 162         strategy = &quot;org.broadleafcommerce.common.persistence.IdOverrideTableGenerator&quot;,
 163         parameters = {
 164             @Parameter(name = &quot;segment_value&quot;, value = &quot;SkuImpl&quot;),
 165             @Parameter(name = &quot;entity_name&quot;, value = &quot;org.broadleafcommerce.core.catalog.domain.SkuImpl&quot;)
 166         }
 167     )
 168     @Column(name = &quot;SKU_ID&quot;)
 169     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_ID&quot;, visibility = VisibilityEnum.HIDDEN_ALL)
 170     protected Long id;
 171 
 172     @Column(name = &quot;EXTERNAL_ID&quot;)
 173     @Index(name=&quot;SKU_EXTERNAL_ID_INDEX&quot;, columnNames={&quot;EXTERNAL_ID&quot;})
 174     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_ExternalID&quot;,
 175         group = GroupName.Miscellaneous, order = FieldOrder.EXTERNAL_ID,
 176         tooltip = &quot;SkuImpl_Sku_ExternalID_Tooltip&quot;)
 177     protected String externalId;
 178 
 179     @Column(name = &quot;URL_KEY&quot;)
 180     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_UrlKey&quot;,
 181         group = GroupName.Advanced, order = 4000,
 182         excluded = true)
 183     protected String urlKey;
 184 
 185     @Column(name = &quot;DISPLAY_TEMPLATE&quot;)
 186     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Display_Template&quot;,
 187         group = GroupName.Advanced, order = 5000,
 188         excluded = true)
 189     protected String displayTemplate;
 190 
 191     @Column(name = &quot;UPC&quot;)
 192     @Index(name = &quot;SKU_UPC_INDEX&quot;, columnNames = { &quot;UPC&quot; })
 193     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_UPC&quot;,
 194             group = GroupName.Miscellaneous, order = FieldOrder.UPC)
 195     protected String upc;
 196 
 197     @Column(name = &quot;SALE_PRICE&quot;, precision = 19, scale = 5)
 198     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Sale_Price&quot;,
 199         group = GroupName.Price, order = FieldOrder.SALE_PRICE,
 200         tooltip = &quot;SkuImpl_Sku_Sale_Price_tooltip&quot;,
 201         prominent = true, gridOrder = 6,
 202         fieldType = SupportedFieldType.MONEY)
 203     protected BigDecimal salePrice;
 204 
 205     @Column(name = &quot;RETAIL_PRICE&quot;, precision = 19, scale = 5)
 206     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Retail_Price&quot;,
 207         group = GroupName.Price, order = FieldOrder.RETAIL_PRICE,
 208         prominent = true, gridOrder = 5,
 209         fieldType = SupportedFieldType.MONEY)
 210     protected BigDecimal retailPrice;
 211 
 212     @Column(name = &quot;COST&quot;, precision = 19, scale = 5)
 213     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Cost&quot;,
 214             group = GroupName.Price, order = FieldOrder.COST,
 215             fieldType = SupportedFieldType.MONEY)
 216     protected BigDecimal cost;
 217 
 218     @Column(name = &quot;NAME&quot;)
 219     @Index(name = &quot;SKU_NAME_INDEX&quot;, columnNames = {&quot;NAME&quot;})
 220     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Name&quot;,
 221         group = GroupName.General, order = FieldOrder.NAME,
 222         prominent = true, gridOrder = 1, columnWidth = &quot;260px&quot;,
 223         translatable = true)
 224     protected String name;
 225 
 226     @Column(name = &quot;DESCRIPTION&quot;)
 227     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Description&quot;,
 228         group = GroupName.General, order = FieldOrder.SHORT_DESCRIPTION,
 229         largeEntry = true, 
 230         excluded = true,
 231         translatable = true)
 232     protected String description;
 233 
 234     @Lob
 235     @Type(type = &quot;org.hibernate.type.MaterializedClobType&quot;)
 236     @Column(name = &quot;LONG_DESCRIPTION&quot;, length = Integer.MAX_VALUE - 1)
 237     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Large_Description&quot;,
 238         group = GroupName.General, order = FieldOrder.LONG_DESCRIPTION,
 239         largeEntry = true, 
 240         fieldType = SupportedFieldType.HTML_BASIC,
 241         translatable = true)
 242     protected String longDescription;
 243 
 244     @Column(name = &quot;TAX_CODE&quot;)
 245     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_TaxCode&quot;, order = 1001, group = GroupName.Financial)
<abbr title=" 246     @AdminPresentationDataDrivenEnumeration(optionCanEditValues = true, optionHideIfEmpty = true, optionFilterParams = { @OptionFilterParam("> 246     @AdminPresentationDataDrivenEnumeration(optionCanEditValues = true, optionHideIfEmpty = true, optionFðŸ”µ</abbr>
 247             param = &quot;type.key&quot;, value = &quot;TAX_CODE&quot;, paramType = OptionFilterParamType.STRING) })
 248     protected String taxCode;
 249 
 250     @Column(name = &quot;TAXABLE_FLAG&quot;)
 251     @Index(name=&quot;SKU_TAXABLE_INDEX&quot;, columnNames={&quot;TAXABLE_FLAG&quot;})
 252     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Taxable&quot;,
 253             group = GroupName.Financial, order = FieldOrder.TAXABLE)
 254     protected Character taxable;
 255 
 256     @Column(name = &quot;DISCOUNTABLE_FLAG&quot;)
 257     @Index(name=&quot;SKU_DISCOUNTABLE_INDEX&quot;, columnNames={&quot;DISCOUNTABLE_FLAG&quot;})
 258     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Discountable&quot;,
 259         group = GroupName.Discountable,
 260         helpText = &quot;SkuImpl_Sku_Discountable_helptext&quot;,
 261         defaultValue = &quot;Y&quot;)
 262     protected Character discountable;
 263 
 264     @Column(name = &quot;AVAILABLE_FLAG&quot;)
 265     @Index(name = &quot;SKU_AVAILABLE_INDEX&quot;, columnNames = {&quot;AVAILABLE_FLAG&quot;})
 266     @AdminPresentation(excluded = true)
 267     @Deprecated
 268     protected Character available;
 269 
 270     @Column(name = &quot;ACTIVE_START_DATE&quot;)
 271     @Index(name=&quot;SKU_ACTIVE_START_INDEX&quot;)
 272     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Start_Date&quot;,
 273         group = GroupName.ActiveDateRange, order = FieldOrder.ACTIVE_START_DATE,
 274         tooltip = &quot;skuStartDateTooltip&quot;,
 275         defaultValue = &quot;today&quot;)
 276     protected Date activeStartDate;
 277 
 278     @Column(name = &quot;ACTIVE_END_DATE&quot;)
 279     @Index(name=&quot;SKU_ACTIVE_END_INDEX&quot;)
 280     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_End_Date&quot;,
 281         group = GroupName.ActiveDateRange, order = FieldOrder.ACTIVE_END_DATE,
 282         tooltip = &quot;skuEndDateTooltip&quot;,
 283         validationConfigurations = {
 284             @ValidationConfiguration(
 285                 validationImplementation = &quot;blAfterStartDateValidator&quot;,
 286                 configurationItems = {
 287                         @ConfigurationItem(itemName = &quot;otherField&quot;, itemValue = &quot;activeStartDate&quot;)
 288                 }) 
 289         })
 290     protected Date activeEndDate;
 291 
 292     @Embedded
 293     protected Dimension dimension = new Dimension();
 294 
 295     @Embedded
 296     protected Weight weight = new Weight();
 297 
 298     @Column(name = &quot;IS_MACHINE_SORTABLE&quot;)
 299     @AdminPresentation(friendlyName = &quot;ProductImpl_Is_Product_Machine_Sortable&quot;,
 300         group = GroupName.ShippingOther, order = FieldOrder.IS_MACHINE_SORTABLE,
 301         defaultValue = &quot;false&quot;)
 302     protected Boolean isMachineSortable;
 303 
 304     @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuMediaXrefImpl.class, cascade = { CascadeType.ALL })
 305     @MapKey(name = &quot;key&quot;)
 306     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 307     @BatchSize(size = 50)
 308     @AdminPresentationMap(friendlyName = &quot;SkuImpl_Sku_Media&quot;,
 309         tab = TabName.Media,
 310         keyPropertyFriendlyName = &quot;SkuImpl_Sku_Media_Key&quot;,
 311         deleteEntityUponRemove = true,
 312         mediaField = &quot;media.url&quot;,
 313         toOneTargetProperty = &quot;media&quot;,
 314         toOneParentProperty = &quot;sku&quot;,
 315         forceFreeFormKeys = true
 316     )
 317     @AdminPresentationMapFields(
 318         mapDisplayFields = {
 319             @AdminPresentationMapField(
 320                     fieldName = &quot;primary&quot;,
 321                     fieldPresentation = @AdminPresentation(fieldType = SupportedFieldType.MEDIA,
 322                             group = GroupName.Image,
 323                             order = FieldOrder.PRIMARY_MEDIA,
 324                             friendlyName = &quot;SkuImpl_Primary_Media&quot;)
 325             )
 326     })
 327     protected Map&lt;String, SkuMediaXref&gt; skuMedia = new HashMap&lt;String, SkuMediaXref&gt;();
 328 
 329     @Transient
 330     protected Map&lt;String, Media&gt; legacySkuMedia = new HashMap&lt;String, Media&gt;();
 331 
 332     /**
 333      * This will be non-null if and only if this Sku is the default Sku for a Product
 334      */
 335     @OneToOne(optional = true, targetEntity = ProductImpl.class, cascade = {CascadeType.ALL})
 336     @Cascade(value = {org.hibernate.annotations.CascadeType.ALL})
 337     @JoinColumn(name = &quot;DEFAULT_PRODUCT_ID&quot;)
 338     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 339     @IgnoreEnterpriseBehavior
 340     protected Product defaultProduct;
 341 
 342     /**
 343      * This relationship will be non-null if and only if this Sku is contained in the list of
 344      * additional Skus for a Product (for Skus based on ProductOptions)
 345      */
<abbr title=" 346     @ManyToOne(optional = true, targetEntity = ProductImpl.class, cascade = {CascadeType.PERSIST, CascadeType.MERGE, CascadeType.REFRESH})"> 346     @ManyToOne(optional = true, targetEntity = ProductImpl.class, cascade = {CascadeType.PERSIST, CascadeðŸ”µ</abbr>
 347     @JoinColumn(name = &quot;ADDL_PRODUCT_ID&quot;)
 348     protected Product product;
 349 
 350 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 351     @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL }, orphanRemoval = true)"> 351     @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL }, orðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 352     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)</span>
 353 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 354     @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL }, orphanRemoval = true)"> 354     @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL }, orðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355     @Cache(usage=CacheConcurrencyStrategy.NONSTRICT_READ_WRITE, region=&quot;blProducts&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356     @BatchSize(size = 50)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357     @AdminPresentationCollection(friendlyName = &quot;skuAttributesTitle&quot;,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358             tab = TabName.Advanced, order = 1000)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359     protected List&lt;SkuAttribute&gt; skuAttributes = new ArrayList&lt;SkuAttribute&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 361     @OneToMany(targetEntity = SkuProductOptionValueXrefImpl.class, cascade = CascadeType.ALL, mappedBy = &quot;sku&quot;)"> 361     @OneToMany(targetEntity = SkuProductOptionValueXrefImpl.class, cascade = CascadeType.ALL, mappedBy = ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363     @BatchSize(size = 50)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364     @ClonePolicyCollectionOverride</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365     @ClonePolicyArchive</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366     //Use a Set instead of a List - see https://github.com/BroadleafCommerce/BroadleafCommerce/issues/917</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 367     protected Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs = new HashSet&lt;SkuProductOptionValueXref&gt;();"> 367     protected Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs = new HashSet&lt;SkuProductOptionValueXðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369     @Transient</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370     protected Set&lt;ProductOptionValue&gt; legacyProductOptionValues = new HashSet&lt;ProductOptionValue&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372     @ManyToMany(fetch = FetchType.LAZY, targetEntity = SkuFeeImpl.class)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373     @JoinTable(name = &quot;BLC_SKU_FEE_XREF&quot;,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374             joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;, nullable = true),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 375             inverseJoinColumns = @JoinColumn(name = &quot;SKU_FEE_ID&quot;, referencedColumnName = &quot;SKU_FEE_ID&quot;, nullable = true))"> 375             inverseJoinColumns = @JoinColumn(name = &quot;SKU_FEE_ID&quot;, referencedColumnName = &quot;SKU_FEE_ID&quot;, nuðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377     @BatchSize(size = 50)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378     protected List&lt;SkuFee&gt; fees = new ArrayList&lt;SkuFee&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380     @ElementCollection</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381     @CollectionTable(name = &quot;BLC_SKU_FULFILLMENT_FLAT_RATES&quot;, </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382         joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;, nullable = true))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383     @MapKeyJoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;, referencedColumnName = &quot;FULFILLMENT_OPTION_ID&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384     @MapKeyClass(FulfillmentOptionImpl.class)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385     @Column(name = &quot;RATE&quot;, precision = 19, scale = 5)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386     @Cascade(org.hibernate.annotations.CascadeType.ALL)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388     @BatchSize(size = 50)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 389     protected Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates = new HashMap&lt;FulfillmentOption, BigDecimal&gt;();"> 389     protected Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates = new HashMap&lt;FulfillmentOption, BiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391     @ManyToMany(targetEntity = FulfillmentOptionImpl.class)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392     @JoinTable(name = &quot;BLC_SKU_FULFILLMENT_EXCLUDED&quot;,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393             joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 394             inverseJoinColumns = @JoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;,referencedColumnName = &quot;FULFILLMENT_OPTION_ID&quot;))"> 394             inverseJoinColumns = @JoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;,referencedColumnName = &quot;FULFIðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396     @BatchSize(size = 50)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397     protected List&lt;FulfillmentOption&gt; excludedFulfillmentOptions = new ArrayList&lt;FulfillmentOption&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399     @Column(name = &quot;INVENTORY_TYPE&quot;)</span>
 400 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401     @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL })</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402     @Cache(usage=CacheConcurrencyStrategy.NONSTRICT_READ_WRITE, region=&quot;blProducts&quot;)</span>
 403 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 404     @BatchSize(size = 50)
 405     @AdminPresentationCollection(friendlyName = &quot;skuAttributesTitle&quot;,
 406             tab = TabName.Advanced, order = 1000)
 407     protected List&lt;SkuAttribute&gt; skuAttributes = new ArrayList&lt;SkuAttribute&gt;();
 408 
<abbr title=" 409     @OneToMany(targetEntity = SkuProductOptionValueXrefImpl.class, cascade = CascadeType.ALL, mappedBy = &quot;sku&quot;)"> 409     @OneToMany(targetEntity = SkuProductOptionValueXrefImpl.class, cascade = CascadeType.ALL, mappedBy = ðŸ”µ</abbr>
 410     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 411     @BatchSize(size = 50)
 412     @ClonePolicyCollectionOverride
 413     @ClonePolicyArchive
 414     //Use a Set instead of a List - see https://github.com/BroadleafCommerce/BroadleafCommerce/issues/917
<abbr title=" 415     protected Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs = new HashSet&lt;SkuProductOptionValueXref&gt;();"> 415     protected Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs = new HashSet&lt;SkuProductOptionValueXðŸ”µ</abbr>
 416 
 417     @Transient
 418     protected Set&lt;ProductOptionValue&gt; legacyProductOptionValues = new HashSet&lt;ProductOptionValue&gt;();
 419 
 420     @ManyToMany(fetch = FetchType.LAZY, targetEntity = SkuFeeImpl.class)
 421     @JoinTable(name = &quot;BLC_SKU_FEE_XREF&quot;,
 422             joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;, nullable = true),
<abbr title=" 423             inverseJoinColumns = @JoinColumn(name = &quot;SKU_FEE_ID&quot;, referencedColumnName = &quot;SKU_FEE_ID&quot;, nullable = true))"> 423             inverseJoinColumns = @JoinColumn(name = &quot;SKU_FEE_ID&quot;, referencedColumnName = &quot;SKU_FEE_ID&quot;, nuðŸ”µ</abbr>
 424     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 425     @BatchSize(size = 50)
 426     protected List&lt;SkuFee&gt; fees = new ArrayList&lt;SkuFee&gt;();
 427 
 428     @ElementCollection
 429     @CollectionTable(name = &quot;BLC_SKU_FULFILLMENT_FLAT_RATES&quot;, 
 430         joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;, nullable = true))
 431     @MapKeyJoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;, referencedColumnName = &quot;FULFILLMENT_OPTION_ID&quot;)
 432     @MapKeyClass(FulfillmentOptionImpl.class)
 433     @Column(name = &quot;RATE&quot;, precision = 19, scale = 5)
 434     @Cascade(org.hibernate.annotations.CascadeType.ALL)
 435     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 436     @BatchSize(size = 50)
<abbr title=" 437     protected Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates = new HashMap&lt;FulfillmentOption, BigDecimal&gt;();"> 437     protected Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates = new HashMap&lt;FulfillmentOption, BiðŸ”µ</abbr>
 438 
 439     @ManyToMany(targetEntity = FulfillmentOptionImpl.class)
 440     @JoinTable(name = &quot;BLC_SKU_FULFILLMENT_EXCLUDED&quot;,
 441             joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;),
<abbr title=" 442             inverseJoinColumns = @JoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;,referencedColumnName = &quot;FULFILLMENT_OPTION_ID&quot;))"> 442             inverseJoinColumns = @JoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;,referencedColumnName = &quot;FULFIðŸ”µ</abbr>
 443     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 444     @BatchSize(size = 50)
 445     protected List&lt;FulfillmentOption&gt; excludedFulfillmentOptions = new ArrayList&lt;FulfillmentOption&gt;();
 446 
 447     @Column(name = &quot;INVENTORY_TYPE&quot;)
 448     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_InventoryType&quot;,
 449         group = GroupName.Inventory, order = 1000,
 450         helpText = &quot;skuInventoryTypeHelpText&quot;,
 451         fieldType = SupportedFieldType.BROADLEAF_ENUMERATION, 
 452         broadleafEnumeration = &quot;org.broadleafcommerce.core.inventory.service.type.InventoryType&quot;,
 453         columnWidth = &quot;180px&quot;, prominent = true)
 454     protected String inventoryType;
 455     
 456     @Column(name = &quot;QUANTITY_AVAILABLE&quot;)
 457     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_QuantityAvailable&quot;,
 458             group = GroupName.Inventory, order = 1010)
 459     protected Integer quantityAvailable = 0;
 460 
 461     @Column(name = &quot;FULFILLMENT_TYPE&quot;)
 462     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_FulfillmentType&quot;,
 463         group = GroupName.ShippingFulfillment, order = FieldOrder.FULFILLMENT_TYPE,
 464         fieldType = SupportedFieldType.BROADLEAF_ENUMERATION, 
 465         broadleafEnumeration = &quot;org.broadleafcommerce.core.order.service.type.FulfillmentType&quot;)
 466     protected String fulfillmentType;
 467     
 468     /**
<abbr title=" 469      * Note that this field is not the target of the currencyCodeField attribute on either retailPrice or salePrice."> 469      * Note that this field is not the target of the currencyCodeField attribute on either retailPrice orðŸ”µ</abbr>
<abbr title=" 470      * This is because SKUs are special in that we want to return the currency on this SKU if there is one, falling back"> 470      * This is because SKUs are special in that we want to return the currency on this SKU if there is onðŸ”µ</abbr>
 471      * to the defaultSku&#x27;s currency if possible.
 472      * 
 473      * Normally null and hidden.  Use Meta-Data overrides to display in the admin.
 474      * @see Sku#getCurrency() for further cautions about using this field.
 475      */
 476     @ManyToOne(targetEntity = BroadleafCurrencyImpl.class, fetch = FetchType.LAZY)
 477     @JoinColumn(name = &quot;CURRENCY_CODE&quot;)
 478     @AdminPresentation(friendlyName = &quot;SkuImpl_Currency&quot;,
 479             group = GroupName.Advanced, order = 3000,
 480             visibility = VisibilityEnum.HIDDEN_ALL)
<abbr title=" 481     @AdminPresentationToOneLookup(lookupType = LookupType.DROPDOWN, lookupDisplayProperty = &quot;friendlyName&quot;)"> 481     @AdminPresentationToOneLookup(lookupType = LookupType.DROPDOWN, lookupDisplayProperty = &quot;friendlyNameðŸ”µ</abbr>
 482     protected BroadleafCurrency currency;
 483 
 484     @Override
 485     public Long getId() {
 486         return id;
 487     }
 488 
 489     @Override
 490     public void setId(Long id) {
 491         this.id = id;
 492     }
 493 
 494     @Override
 495     public String getUrlKey() {
 496         return urlKey;
 497     }
 498 
 499     @Override
 500     public void setUrlKey(String urlKey) {
 501         this.urlKey = urlKey;
 502     }
 503     
 504     @Override
 505     public String getDisplayTemplate() {
 506         return displayTemplate;
 507     }
 508     
 509     @Override
 510     public void setDisplayTemplate(String displayTemplate) {
 511         this.displayTemplate = displayTemplate;
 512     }
 513 
 514     @Override
 515     public boolean isOnSale() {
 516         Money retailPrice = getRetailPrice();
 517         Money salePrice = getSalePrice();
 518         return (salePrice != null &amp;&amp; !salePrice.isZero() &amp;&amp; salePrice.lessThan(retailPrice));
 519     }
 520 
 521     protected boolean hasDefaultSku() {
<abbr title=" 522         return (product != null &amp;&amp; product.getDefaultSku() != null &amp;&amp; getId() != null &amp;&amp; !getId().equals(product.getDefaultSku().getId()));"> 522         return (product != null &amp;&amp; product.getDefaultSku() != null &amp;&amp; getId() != null &amp;&amp; !getId().equals(ðŸ”µ</abbr>
 523     }
 524 
 525     protected Sku lookupDefaultSku() {
 526         if (product != null &amp;&amp; product.getDefaultSku() != null) {
 527             return product.getDefaultSku();
 528         } else {
 529             return null;
 530         }
 531     }
 532 
 533     @Override
 534     public Money getProductOptionValueAdjustments() {
 535         Money optionValuePriceAdjustments = null;
 536         if (getProductOptionValues() != null) {
 537             for (ProductOptionValue value : getProductOptionValues()) {
 538                 if (value.getPriceAdjustment() != null) {
 539                     if (optionValuePriceAdjustments == null) {
 540                         optionValuePriceAdjustments = value.getPriceAdjustment();
 541                     } else {
<abbr title=" 542                         optionValuePriceAdjustments = optionValuePriceAdjustments.add(value.getPriceAdjustment());"> 542                         optionValuePriceAdjustments = optionValuePriceAdjustments.add(value.getPriceAdjusðŸ”µ</abbr>
 543                     }
 544                 }
 545             }
 546         }
 547         return optionValuePriceAdjustments;
 548     }
 549 
 550     @Override
 551     public Money getSalePrice() {
 552         Money returnPrice = null;
 553         Money optionValueAdjustments = null;
 554 
 555         if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 556             // We have dynamic pricing, so we will pull the sale price from there
 557             DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 558             returnPrice = dynamicPrices.getSalePrice();
 559             optionValueAdjustments = dynamicPrices.getPriceAdjustment();
 560             if (SkuPricingConsiderationContext.isPricingConsiderationActive()) {
 561                 return returnPrice;
 562             }
 563         } else if (salePrice != null) {
<abbr title=" 564             // We have an explicitly set sale price directly on this entity. We will not apply any adjustments"> 564             // We have an explicitly set sale price directly on this entity. We will not apply any adjustðŸ”µ</abbr>
 565             returnPrice = new Money(salePrice, getCurrency());
 566         }
 567 
 568         if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 569             returnPrice = lookupDefaultSku().getSalePrice();
 570             optionValueAdjustments = getProductOptionValueAdjustments();
 571         }
 572 
 573         if (returnPrice == null) {
 574             return null;
 575         }
 576         
 577         if (optionValueAdjustments != null) {
 578             returnPrice = returnPrice.add(optionValueAdjustments);
 579         }
 580 
 581         return returnPrice;
 582     }
 583 
 584     @Override
 585     public boolean hasSalePrice() {
 586         return getSalePrice() != null;
 587     }
 588 
 589     @Override
 590     public void setSalePrice(Money salePrice) {
 591         this.salePrice = Money.toAmount(salePrice);
 592     }
 593 
 594     @Override
 595     public Money getRetailPrice() {
 596         return getRetailPriceInternal();
 597     }
 598 
 599     /*
<abbr title=" 600      * This allows us a way to determine or calculate the retail price. If one is not available this method will return null. "> 600      * This allows us a way to determine or calculate the retail price. If one is not available this methðŸ”µ</abbr>
<abbr title=" 601      * This allows the call to hasRetailPrice() to determine if there is a retail price without the overhead of an exception. "> 601      * This allows the call to hasRetailPrice() to determine if there is a retail price without the overhðŸ”µ</abbr>
 602      */
 603     protected Money getRetailPriceInternal() {
 604         Money returnPrice = null;
 605         Money optionValueAdjustments = null;
 606 
 607         if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 608             // We have dynamic pricing, so we will pull the retail price from there
 609             DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 610             returnPrice = dynamicPrices.getRetailPrice();
 611             optionValueAdjustments = dynamicPrices.getPriceAdjustment();
 612             if (SkuPricingConsiderationContext.isPricingConsiderationActive()) {
 613                 return returnPrice;
 614             }
 615         } else if (retailPrice != null) {
 616             returnPrice = new Money(retailPrice, getCurrency());
 617         }
 618 
 619         if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 620             // Otherwise, we&#x27;ll pull the retail price from the default sku
 621             returnPrice = lookupDefaultSku().getRetailPrice();
 622             optionValueAdjustments = getProductOptionValueAdjustments();
 623         }
 624         
 625         if (returnPrice != null &amp;&amp; optionValueAdjustments != null) {
 626             returnPrice = returnPrice.add(optionValueAdjustments);
 627         }
 628         
 629         return returnPrice;
 630     }
 631 
 632     @Override
 633     public Money getBaseRetailPrice() {
 634         Money returnPrice = null;
 635         if (retailPrice != null) {
 636             returnPrice = new Money(retailPrice, getCurrency());
 637         }
 638         if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 639             Sku defaultSku = lookupDefaultSku();
 640             returnPrice = defaultSku.getBaseRetailPrice();
 641         }
 642         return returnPrice;
 643     }
 644 
 645     @Override
 646     public Money getBaseSalePrice() {
 647         Money returnPrice = null;
 648         if (salePrice != null) {
 649             returnPrice = new Money(salePrice, getCurrency());
 650         }
 651         if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 652             Sku defaultSku = lookupDefaultSku();
 653             returnPrice = defaultSku.getBaseSalePrice();
 654         }
 655         return returnPrice;
 656     }
 657 
 658     @Override
 659     public DynamicSkuPrices getPriceData() {
 660         if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 661             DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 662             return dynamicPrices;
 663         } else {
 664             DynamicSkuPrices dsp = new DynamicSkuPrices();
 665             BroadleafCurrency tmpCurrency;
 666             if (currency != null) {
 667                 tmpCurrency = currency;
 668             } else {
 669                 tmpCurrency = BroadleafRequestContext.getCurrency();
 670             }
 671             if (retailPrice != null) {
 672                 dsp.setRetailPrice(new Money(retailPrice, tmpCurrency));
 673             }
 674             if (salePrice != null) {
 675                 dsp.setSalePrice(new Money(salePrice, tmpCurrency));
 676             }
 677             return dsp;
 678         }
 679     }
 680 
 681     @Override
 682     public boolean hasRetailPrice() {
 683         return getRetailPriceInternal() != null;
 684     }
 685 
 686     @Override
 687     public void setRetailPrice(Money retailPrice) {
 688         this.retailPrice = Money.toAmount(retailPrice);
 689     }
 690 
 691     @Override
 692     public Money getPrice() {
 693         return isOnSale() ? getSalePrice() : getRetailPrice();
 694     }
 695 
 696     @Override
 697     @Deprecated
 698     public Money getListPrice() {
 699         return getRetailPrice();
 700     }
 701 
 702     @Override
 703     @Deprecated
 704     public void setListPrice(Money listPrice) {
 705         this.retailPrice = Money.toAmount(listPrice);
 706     }
 707 
 708     @Override
 709     public Money getCost() {
 710         if (cost == null &amp;&amp; hasDefaultSku()) {
 711             return lookupDefaultSku().getCost();
 712         }
 713 
 714         if (cost == null) {
 715             return null;
 716         }
 717 
 718         return new Money(cost, getCurrency());
 719     }
 720 
 721     @Override
 722     public void setCost(Money cost) {
 723         this.cost = cost.getAmount();
 724     }
 725 
 726     @Override
 727     public Money getMargin() {
 728         Money margin = null;
 729         Money price = getPrice();
 730         Money purchaseCost = getCost();
 731 
 732         if (price == null &amp;&amp; hasDefaultSku()) {
 733             price = lookupDefaultSku().getPrice();
 734         }
 735 
 736         if (purchaseCost == null &amp;&amp; hasDefaultSku()) {
 737             purchaseCost = lookupDefaultSku().getCost();
 738         }
 739 
 740         if (price != null &amp;&amp; !price.getAmount().equals(BigDecimal.ZERO)) {
 741             if (purchaseCost != null) {
 742                 margin = price.subtract(purchaseCost).divide(price.getAmount());
 743             }
 744         } else {
 745             margin = Money.ZERO;
 746         }
 747 
 748         return margin;
 749     }
 750 
 751     @Override
 752     public String getName() {
 753         if (name == null &amp;&amp; hasDefaultSku()) {
 754             return lookupDefaultSku().getName();
 755         }
 756         
 757         return DynamicTranslationProvider.getValue(this, &quot;name&quot;, name);
 758     }
 759 
 760     @Override
 761     public void setName(String name) {
 762         this.name = name;
 763     }
 764 
 765     @Override
 766     public String getDescription() {
 767         if (description == null &amp;&amp; hasDefaultSku()) {
 768             return lookupDefaultSku().getDescription();
 769         }
 770         
 771         return DynamicTranslationProvider.getValue(this, &quot;description&quot;, description);
 772     }
 773 
 774     @Override
 775     public void setDescription(String description) {
 776         this.description = description;
 777     }
 778 
 779     @Override
 780     public String getLongDescription() {
 781         if (longDescription == null &amp;&amp; hasDefaultSku()) {
 782             return lookupDefaultSku().getLongDescription();
 783         }
 784         
 785         return DynamicTranslationProvider.getValue(this, &quot;longDescription&quot;, longDescription);
 786     }
 787 
 788     @Override
 789     public void setLongDescription(String longDescription) {
 790         this.longDescription = longDescription;
 791     }
 792 
 793     @Override
 794     public Boolean isTaxable() {
 795         if (taxable == null) {
 796             if (hasDefaultSku()) {
 797                 return lookupDefaultSku().isTaxable();
 798             }
 799             return null;
 800         }
 801         return taxable == &#x27;Y&#x27; ? Boolean.TRUE : Boolean.FALSE;
 802     }
 803 
 804     @Override
 805     public Boolean getTaxable() {
 806         return isTaxable();
 807     }
 808 
 809     @Override
 810     public void setTaxable(Boolean taxable) {
 811         if (taxable == null) {
 812             this.taxable = null;
 813         } else {
 814             this.taxable = taxable ? &#x27;Y&#x27; : &#x27;N&#x27;;
 815         }
 816     }
 817 
 818     @Override
 819     public Boolean isDiscountable() {
 820         if (discountable == null) {
 821             if (hasDefaultSku()) {
 822                 return lookupDefaultSku().isDiscountable();
 823             }
 824             return Boolean.FALSE;
 825         }
 826         return discountable == &#x27;Y&#x27; ? Boolean.TRUE : Boolean.FALSE;
 827     }
 828 
 829     /*
 830      * This is to facilitate serialization to non-Java clients
 831      */
 832     public Boolean getDiscountable() {
 833         return isDiscountable();
 834     }
 835 
 836     @Override
 837     public void setDiscountable(Boolean discountable) {
 838         if (discountable == null) {
 839             this.discountable = null;
 840         } else {
 841             this.discountable = discountable ? &#x27;Y&#x27; : &#x27;N&#x27;;
 842         }
 843     }
 844 
 845     @Override
 846     public Boolean isAvailable() {
 847         if (InventoryType.UNAVAILABLE.equals(getInventoryType())) {
 848             return false;
 849         }
 850         
 851         if (available == null) {
 852             if (hasDefaultSku()) {
 853                 return lookupDefaultSku().isAvailable();
 854             }
 855             return true;
 856         }
 857         return available != &#x27;N&#x27;;
 858     }
 859 
 860     @Override
 861     public Boolean getAvailable() {
 862         return isAvailable();
 863     }
 864 
 865     @Override
 866     public void setAvailable(Boolean available) {
 867         if (available == null) {
 868             this.available = null;
 869         } else {
 870             this.available = available ? &#x27;Y&#x27; : &#x27;N&#x27;;
 871         }
 872     }
 873 
 874     @Override
 875     public Date getActiveStartDate() {
 876         Date returnDate = null;
 877         if (SkuActiveDateConsiderationContext.hasDynamicActiveDates()) {
<abbr title=" 878             returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveStartDate(this);"> 878             returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveðŸ”µ</abbr>
 879         }
 880 
 881         if (returnDate == null) {
 882             if (activeStartDate == null &amp;&amp; hasDefaultSku()) {
 883                 return lookupDefaultSku().getActiveStartDate();
 884             } else {
 885                 return activeStartDate;
 886             }
 887         } else {
 888             return returnDate;
 889         }
 890     }
 891 
 892     @Override
 893     public void setActiveStartDate(Date activeStartDate) {
 894         this.activeStartDate = activeStartDate;
 895     }
 896 
 897     @Override
 898     public Date getActiveEndDate() {
 899         Date returnDate = null;
 900         if (SkuActiveDateConsiderationContext.hasDynamicActiveDates()) {
<abbr title=" 901             returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveEndDate(this);"> 901             returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveðŸ”µ</abbr>
 902         }
 903 
 904         if (returnDate == null) {
 905             if (activeEndDate == null &amp;&amp; hasDefaultSku()) {
 906                 return lookupDefaultSku().getActiveEndDate();
 907             } else {
 908                 return activeEndDate;
 909             }
 910         } else {
 911             return returnDate;
 912         }
 913     }
 914 
 915     @Override
 916     public void setActiveEndDate(Date activeEndDate) {
 917         this.activeEndDate = activeEndDate;
 918     }
 919 
 920     @Override
 921     public Dimension getDimension() {
 922         if (dimension == null &amp;&amp; hasDefaultSku()) {
 923             return lookupDefaultSku().getDimension();
 924         } else {
 925             return dimension;
 926         }
 927     }
 928 
 929     @Override
 930     public void setDimension(Dimension dimension) {
 931         this.dimension = dimension;
 932     }
 933 
 934     @Override
 935     public Weight getWeight() {
 936         if (weight == null &amp;&amp; hasDefaultSku()) {
 937             return lookupDefaultSku().getWeight();
 938         } else {
 939             return weight;
 940         }
 941     }
 942 
 943     @Override
 944     public void setWeight(Weight weight) {
 945         this.weight = weight;
 946     }
 947 
 948     @Override
 949     public boolean isActive() {
 950         if (activeStartDate == null &amp;&amp; activeEndDate == null &amp;&amp; hasDefaultSku()) {
 951             return lookupDefaultSku().isActive();
 952         }
 953         if (LOG.isDebugEnabled()) {
 954             if (!DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true)) {
 955                 LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to date&quot;);
 956             }
 957         }
 958 
 959         if (!(getProduct() == null) &amp;&amp; !getProduct().isActive()) {
 960             return false;
 961         }
 962 
 963         return DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true);
 964     }
 965 
 966     @Override
 967     public boolean isActive(Product product, Category category) {
 968         if (LOG.isDebugEnabled()) {
 969             if (!DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true)) {
 970                 LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to date&quot;);
 971             } else if (!product.isActive()) {
 972                 LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to product being inactive&quot;);
 973             } else if (!category.isActive()) {
 974                 LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to category being inactive&quot;);
 975             }
 976         }
<abbr title=" 977         return this.isActive() &amp;&amp; (product == null || product.isActive()) &amp;&amp; (category == null || category.isActive());"> 977         return this.isActive() &amp;&amp; (product == null || product.isActive()) &amp;&amp; (category == null || categorðŸ”µ</abbr>
 978     }
 979 
 980     @Override
 981     @Deprecated
 982     public Map&lt;String, Media&gt; getSkuMedia() {
 983         Map&lt;String, Media&gt; skuMediaMap = new LinkedHashMap&lt;&gt;(legacySkuMedia);
 984 
 985         if (MapUtils.isEmpty(skuMediaMap)) {
 986             for (Map.Entry&lt;String, SkuMediaXref&gt; entry : getSkuMediaXref().entrySet()) {
 987                 skuMediaMap.put(entry.getKey(), entry.getValue().getMedia());
 988             }
 989         }
 990 
 991         return Collections.unmodifiableMap(skuMediaMap);
 992     }
 993 
 994     @Override
 995     @Deprecated
 996     public void setSkuMedia(Map&lt;String, Media&gt; skuMedia) {
 997         this.skuMedia.clear();
 998         this.legacySkuMedia.clear();
 999         for(Map.Entry&lt;String, Media&gt; entry : skuMedia.entrySet()){
<abbr title="1000             this.skuMedia.put(entry.getKey(), new SkuMediaXrefImpl(this, entry.getValue(), entry.getKey()));">1000             this.skuMedia.put(entry.getKey(), new SkuMediaXrefImpl(this, entry.getValue(), entry.getKey()ðŸ”µ</abbr>
1001         }
1002     }
1003 
1004     @Override
1005     public Map&lt;String, SkuMediaXref&gt; getSkuMediaXref() {
1006         Map&lt;String, SkuMediaXref&gt; skuMediaMap = skuMedia;
1007 
1008         if (MapUtils.isEmpty(skuMediaMap)) {
1009             if (hasDefaultSku()) {
1010                 return lookupDefaultSku().getSkuMediaXref();
1011             }
1012         }
1013 
1014         if (isOrderedSkuMedia(skuMediaMap)) {
1015             skuMediaMap = sortSkuMedia(skuMediaMap);
1016         }
1017 
1018         return skuMediaMap;
1019     }
1020 
1021     @Override
1022     public Map&lt;String, SkuMediaXref&gt; getSkuMediaXrefIgnoreDefaultSku() {
1023         Map&lt;String, SkuMediaXref&gt; skuMediaMap = skuMedia;
1024 
1025         if (isOrderedSkuMedia(skuMediaMap)) {
1026             skuMediaMap = sortSkuMedia(skuMediaMap);
1027         }
1028 
1029         return skuMediaMap;
1030     }
1031 
1032     @Override
1033     public Media getPrimarySkuMedia() {
1034         Map&lt;String, SkuMediaXref&gt; skuMediaMap = getSkuMediaXrefIgnoreDefaultSku();
1035 
1036         if (MapUtils.isNotEmpty(skuMediaMap)) {
1037             if (isOrderedSkuMedia(skuMediaMap)) {
1038                 return skuMediaMap.values().stream()
1039                         .map(OrderedSkuMediaXref.class::cast)
1040                         .filter(OrderedSkuMediaXref::getShowInGallery)
1041                         .findFirst()
1042                         .map(SkuMediaXref.class::cast)
1043                         .map(SkuMediaXref::getMedia)
1044                         .orElse(null);
1045             } else {
1046                 SkuMediaXref primaryXref = skuMediaMap.get(&quot;primary&quot;);
1047 
1048                 return (primaryXref == null)? null : primaryXref.getMedia();
1049             }
1050         }
1051 
1052         return null;
1053     }
1054 
1055     @Override
1056     public void setSkuMediaXref(Map&lt;String, SkuMediaXref&gt; skuMediaXref) {
1057         this.skuMedia = skuMediaXref;
1058     }
1059 
1060     protected boolean isOrderedSkuMedia(Map&lt;String, SkuMediaXref&gt; skuMedia) {
1061         return skuMedia.values().stream()
1062                 .anyMatch(OrderedSkuMediaXref.class::isInstance);
1063     }
1064 
1065     protected Map&lt;String, SkuMediaXref&gt; sortSkuMedia(Map&lt;String, SkuMediaXref&gt; skuMedia) {
1066         return skuMedia.values().stream()
1067                 .sorted(Comparator.comparing(xref -&gt; ((OrderedSkuMediaXref) xref).getDisplayOrder()))
1068                 .collect(Collectors.toMap(SkuMediaXref::getKey, Function.identity(),
<abbr title="1069                         (key1,key2) -&gt;{ throw new IllegalStateException(String.format(&quot;Duplicate key %s&quot;, key1)); },">1069                         (key1,key2) -&gt;{ throw new IllegalStateException(String.format(&quot;Duplicate key %s&quot;,ðŸ”µ</abbr>
1070                         LinkedHashMap::new));
1071     }
1072 
1073     @Override
1074     public Product getDefaultProduct() {
1075         return defaultProduct;
1076     }
1077 
1078     @Override
1079     public void setDefaultProduct(Product defaultProduct) {
1080         this.defaultProduct = defaultProduct;
1081     }
1082 
1083     @Override
1084     public Product getProduct() {
1085         return (getDefaultProduct() != null) ? getDefaultProduct() : this.product;
1086     }
1087 
1088     @Override
1089     public void setProduct(Product product) {
1090         this.product = product;
1091     }
1092     
1093     @Override
1094     public Set&lt;SkuProductOptionValueXref&gt; getProductOptionValueXrefs() {
1095         return productOptionValueXrefs;
1096     }
1097 
1098     @Override
1099     public void setProductOptionValueXrefs(Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs) {
1100         this.productOptionValueXrefs = productOptionValueXrefs;
1101     }
1102 
1103     @Override
1104     public Set&lt;ProductOptionValue&gt; getProductOptionValuesCollection() {
1105         if (legacyProductOptionValues.size() == 0) {
1106             for (SkuProductOptionValueXref xref : productOptionValueXrefs) {
1107                 legacyProductOptionValues.add(xref.getProductOptionValue());
1108             }
1109         }
1110         return Collections.unmodifiableSet(legacyProductOptionValues);
1111     }
1112 
1113     @Override
1114     public void setProductOptionValuesCollection(Set&lt;ProductOptionValue&gt; productOptionValues) {
1115         this.legacyProductOptionValues.clear();
1116         this.productOptionValueXrefs.clear();
1117         for (ProductOptionValue val : productOptionValues) {
1118             this.productOptionValueXrefs.add(new SkuProductOptionValueXrefImpl(this, val));
1119         }
1120     }
1121 
1122     @Override
1123     @Deprecated
1124     public List&lt;ProductOptionValue&gt; getProductOptionValues() {
<abbr title="1125         //Changing this API to Set is ill-advised (especially in a patch release). The tendrils are widespread. Instead">1125         //Changing this API to Set is ill-advised (especially in a patch release). The tendrils are widesðŸ”µ</abbr>
1126         //we just migrate the call from the List to the internal Set representation. This is in response
1127         //to https://github.com/BroadleafCommerce/BroadleafCommerce/issues/917.
<abbr title="1128         return (List&lt;ProductOptionValue&gt;) Proxy.newProxyInstance(getClass().getClassLoader(), new Class&lt;?&gt;[]{List.class}, new InvocationHandler() {">1128         return (List&lt;ProductOptionValue&gt;) Proxy.newProxyInstance(getClass().getClassLoader(), new Class&lt;?ðŸ”µ</abbr>
1129             @Override
1130             public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
<abbr title="1131                 return MethodUtils.invokeMethod(getProductOptionValuesCollection(), method.getName(), args, method.getParameterTypes());">1131                 return MethodUtils.invokeMethod(getProductOptionValuesCollection(), method.getName(), argðŸ”µ</abbr>
1132             }
1133         });
1134     }
1135 
1136     @Override
1137     @Deprecated
1138     public void setProductOptionValues(List&lt;ProductOptionValue&gt; productOptionValues) {
1139         setProductOptionValuesCollection(new HashSet&lt;ProductOptionValue&gt;(productOptionValues));
1140     }
1141 
1142     @Override
1143     @Deprecated
1144     public Boolean isMachineSortable() {
1145         if (isMachineSortable == null &amp;&amp; hasDefaultSku()) {
1146             return lookupDefaultSku().isMachineSortable();
1147         }
1148         return isMachineSortable == null ? false : isMachineSortable;
1149     }
1150 
1151     @Override
1152     public Boolean getIsMachineSortable() {
1153         if (isMachineSortable == null &amp;&amp; hasDefaultSku()) {
1154             return lookupDefaultSku().getIsMachineSortable();
1155         }
1156         return isMachineSortable == null ? false : isMachineSortable;
1157     }
1158 
1159     @Override
1160     @Deprecated
1161     public void setMachineSortable(Boolean isMachineSortable) {
1162         this.isMachineSortable = isMachineSortable;
1163     }
1164 
1165     @Override
1166     public void setIsMachineSortable(Boolean isMachineSortable) {
1167         this.isMachineSortable = isMachineSortable;
1168     }
1169 
1170     @Override
1171     public List&lt;SkuFee&gt; getFees() {
1172         return fees;
1173     }
1174 
1175     @Override
1176     public void setFees(List&lt;SkuFee&gt; fees) {
1177         this.fees = fees;
1178     }
1179 
1180     @Override
1181     public Map&lt;FulfillmentOption, BigDecimal&gt; getFulfillmentFlatRates() {
1182         return fulfillmentFlatRates;
1183     }
1184 
1185     @Override
1186     public void setFulfillmentFlatRates(Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates) {
1187         this.fulfillmentFlatRates = fulfillmentFlatRates;
1188     }
1189 
1190     @Override
1191     public List&lt;FulfillmentOption&gt; getExcludedFulfillmentOptions() {
1192         return excludedFulfillmentOptions;
1193     }
1194 
1195     @Override
1196     public void setExcludedFulfillmentOptions(List&lt;FulfillmentOption&gt; excludedFulfillmentOptions) {
1197         this.excludedFulfillmentOptions = excludedFulfillmentOptions;
1198     }
1199 
1200     @Override
1201     public InventoryType getInventoryType() {
1202         if (StringUtils.isEmpty(this.inventoryType)) {
1203             if (hasDefaultSku() &amp;&amp; lookupDefaultSku().getInventoryType() != null) {
1204                 return lookupDefaultSku().getInventoryType();
1205             } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1206                 return getProduct().getDefaultCategory().getInventoryType();
1207             }
1208             return null;
1209         }
1210         return InventoryType.getInstance(this.inventoryType);
1211     }
1212 
1213     @Override
1214     public void setInventoryType(InventoryType inventoryType) {
1215         this.inventoryType = (inventoryType == null) ? null : inventoryType.getType();
1216     }
1217     
1218     @Override
1219     public Integer getQuantityAvailable() {
1220         return quantityAvailable;
1221     }
1222     
1223     @Override
1224     public void setQuantityAvailable(Integer quantityAvailable) {
1225         this.quantityAvailable = quantityAvailable;
1226     }
1227 
1228     @Override
1229     public FulfillmentType getFulfillmentType() {
1230         if (StringUtils.isEmpty(this.fulfillmentType)) {
1231             if (hasDefaultSku() &amp;&amp; lookupDefaultSku().getFulfillmentType() != null) {
1232                 return lookupDefaultSku().getFulfillmentType();
1233             } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1234                 return getProduct().getDefaultCategory().getFulfillmentType();
1235             }
1236             return null;
1237         }
1238         return FulfillmentType.getInstance(this.fulfillmentType);
1239     }
1240 
1241     @Override
1242     public void setFulfillmentType(FulfillmentType fulfillmentType) {
1243         if (fulfillmentType != null) {
1244             this.fulfillmentType = fulfillmentType.getType();
1245         }
1246     }
1247 
1248     @Override
1249     @Deprecated
1250     public Map&lt;String, SkuAttribute&gt; getSkuAttributes() {
1251         Map&lt;String, SkuAttribute&gt; attributeMap = new HashMap&lt;String, SkuAttribute&gt;();
1252 
1253         for (SkuAttribute skuAttribute : skuAttributes) {
1254             attributeMap.put(skuAttribute.getName(), skuAttribute);
1255         }
1256 
1257         return attributeMap;
1258     }
1259 
1260     @Override
1261     @SuppressWarnings(&quot;unchecked&quot;)
1262     public Map&lt;String, Collection&lt;SkuAttribute&gt;&gt; getMultiValueSkuAttributes() {
1263         MultiValueMap multiValueMap = new MultiValueMap();
1264 
1265         for (SkuAttribute skuAttribute : skuAttributes) {
1266             multiValueMap.put(skuAttribute.getName(), skuAttribute);
1267         }
1268 
1269         return multiValueMap;
1270     }
1271 
1272     @Override
1273     public void setSkuAttributes(Map&lt;String, SkuAttribute&gt; skuAttributes) {
1274         List&lt;SkuAttribute&gt; skuAttributeList = new ArrayList&lt;SkuAttribute&gt;();
1275 
1276         for(Map.Entry&lt;String, SkuAttribute&gt; entry : skuAttributes.entrySet()){
1277             skuAttributeList.add(entry.getValue());
1278         }
1279 
1280         this.skuAttributes = skuAttributeList;
1281     }
1282 
1283     @Override
1284     public BroadleafCurrency getCurrency() {
1285         if (currency == null &amp;&amp; hasDefaultSku()) {
1286             return lookupDefaultSku().getCurrency();
1287         } else {
1288             return currency;
1289         }
1290     }
1291 
1292     @Override
1293     public void setCurrency(BroadleafCurrency currency) {
1294         this.currency = currency;
1295     }
1296 
1297     @Override
1298     public void clearDynamicPrices() {
1299         SkuPricingConsiderationContext.removeFromThreadCache(getId());
1300     }
1301 
1302     @Override
1303     public boolean equals(Object obj) {
1304         if (this == obj) {
1305             return true;
1306         }
1307         if (obj == null) {
1308             return false;
1309         }
1310         if (!getClass().isAssignableFrom(obj.getClass())) {
1311             return false;
1312         }
1313         SkuImpl other = (SkuImpl) obj;
1314 
1315         if (id != null &amp;&amp; other.id != null) {
1316             return id.equals(other.id);
1317         }
1318 
1319         if (getName() == null) {
1320             if (other.getName() != null) {
1321                 return false;
1322             }
1323         } else if (!getName().equals(other.getName())) {
1324             return false;
1325         }
1326         return true;
1327     }
1328 
1329     @Override
1330     public int hashCode() {
1331         final int prime = 31;
1332         int result = 1;
1333         result = prime * result + ((name == null) ? 0 : name.hashCode());
1334         return result;
1335     }
1336 
1337     @Override
1338     public String getTaxCode() {
1339         if (StringUtils.isEmpty(this.taxCode)) {
1340             if (hasDefaultSku() &amp;&amp; !StringUtils.isEmpty(lookupDefaultSku().getTaxCode())) {
1341                 return lookupDefaultSku().getTaxCode();
1342             } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1343                 return getProduct().getDefaultCategory().getTaxCode();
1344             }
1345         }
1346         return this.taxCode;
1347     }
1348 
1349     @Override
1350     public void setTaxCode(String taxCode) {
1351         this.taxCode = taxCode;
1352     }
1353 
1354     @Override
1355     public String getExternalId() {
1356         return externalId;
1357     }
1358 
1359     @Override
1360     public void setExternalId(String externalId) {
1361         this.externalId = externalId;
1362     }
1363 
1364     @Override
1365     public String getUpc() {
1366         return upc;
1367     }
1368 
1369     @Override
1370     public void setUpc(String upc) {
1371         this.upc = upc;
1372     }
1373     
1374     @Override
1375     public FieldEntity getFieldEntityType() {
1376         return FieldEntity.SKU;
1377     }
1378 
1379     @Override
<abbr title="1380     public &lt;G extends Sku&gt; CreateResponse&lt;G&gt; createOrRetrieveCopyInstance(MultiTenantCopyContext context) throws CloneNotSupportedException {">1380     public &lt;G extends Sku&gt; CreateResponse&lt;G&gt; createOrRetrieveCopyInstance(MultiTenantCopyContext context)ðŸ”µ</abbr>
1381         CreateResponse&lt;G&gt; createResponse = context.createOrRetrieveCopyInstance(this);
1382         if (createResponse.isAlreadyPopulated()) {
1383             return createResponse;
1384         }
1385         Sku cloned = createResponse.getClone();
1386         cloned.setRetailPrice(getRetailPrice());
1387         cloned.setSalePrice(getSalePrice());
1388         cloned.setName(name);
1389         cloned.setActiveEndDate(activeEndDate);
1390         cloned.setActiveStartDate(activeStartDate);
1391         cloned.setCurrency(currency);
1392         cloned.setQuantityAvailable(quantityAvailable);
1393         cloned.setDescription(description);
1394         cloned.setDimension(dimension);
1395         cloned.setDiscountable(isDiscountable());
1396         cloned.setDisplayTemplate(displayTemplate);
1397         cloned.setExternalId(externalId);
1398         cloned.setTaxable(isTaxable());
1399         cloned.setTaxCode(taxCode);
1400         cloned.setUrlKey(urlKey);
1401         cloned.setInventoryType(getInventoryType());
1402         cloned.setFulfillmentType(getFulfillmentType());
1403         cloned.setIsMachineSortable(isMachineSortable);
1404         cloned.setLongDescription(longDescription);
1405         cloned.setUpc(upc);
1406         if (product != null) {
1407             cloned.setDefaultProduct(product.createOrRetrieveCopyInstance(context).getClone());
1408         }
1409         if (product != null) {
1410             cloned.setProduct(product.createOrRetrieveCopyInstance(context).getClone());
1411         }
1412         for(Map.Entry&lt;String, SkuAttribute&gt; entry : getSkuAttributes().entrySet()){
1413             SkuAttribute clonedEntry = entry.getValue().createOrRetrieveCopyInstance(context).getClone();
1414             cloned.getSkuAttributes().put(entry.getKey(),clonedEntry);
1415         }
1416         for(SkuProductOptionValueXref entry : productOptionValueXrefs){
<abbr title="1417             SkuProductOptionValueXref clonedEntry = entry.createOrRetrieveCopyInstance(context).getClone();">1417             SkuProductOptionValueXref clonedEntry = entry.createOrRetrieveCopyInstance(context).getClone(ðŸ”µ</abbr>
1418             cloned.getProductOptionValueXrefs().add(clonedEntry);
1419         }
1420         for(Map.Entry&lt;String, SkuMediaXref&gt; entry : skuMedia.entrySet()){
<abbr title="1421             SkuMediaXrefImpl clonedEntry = ((SkuMediaXrefImpl)entry.getValue()).createOrRetrieveCopyInstance(context).getClone();">1421             SkuMediaXrefImpl clonedEntry = ((SkuMediaXrefImpl)entry.getValue()).createOrRetrieveCopyInstaðŸ”µ</abbr>
1422             cloned.getSkuMediaXrefIgnoreDefaultSku().put(entry.getKey(),clonedEntry);
1423         }
1424         for(FulfillmentOption entry : excludedFulfillmentOptions){
1425             FulfillmentOption clonedEntry = entry.createOrRetrieveCopyInstance(context).getClone();
1426             cloned.getExcludedFulfillmentOptions().add(clonedEntry);
1427         }
1428         for(Map.Entry&lt;FulfillmentOption, BigDecimal&gt; entry : fulfillmentFlatRates.entrySet()){
<abbr title="1429             FulfillmentOption clonedEntry = entry.getKey().createOrRetrieveCopyInstance(context).getClone();">1429             FulfillmentOption clonedEntry = entry.getKey().createOrRetrieveCopyInstance(context).getCloneðŸ”µ</abbr>
1430             cloned.getFulfillmentFlatRates().put(clonedEntry,entry.getValue());
1431         }
1432 
1433         return  createResponse;
1434     }
1435 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.catalog.domain;
  19 
  20 import org.apache.commons.beanutils.MethodUtils;
  21 import org.apache.commons.collections.MapUtils;
  22 import org.apache.commons.collections.map.MultiValueMap;
  23 import org.apache.commons.lang.StringUtils;
  24 import org.apache.commons.logging.Log;
  25 import org.apache.commons.logging.LogFactory;
  26 import org.broadleafcommerce.common.copy.CreateResponse;
  27 import org.broadleafcommerce.common.copy.MultiTenantCopyContext;
  28 import org.broadleafcommerce.common.currency.domain.BroadleafCurrency;
  29 import org.broadleafcommerce.common.currency.domain.BroadleafCurrencyImpl;
  30 import org.broadleafcommerce.common.extensibility.jpa.clone.ClonePolicyArchive;
  31 import org.broadleafcommerce.common.extensibility.jpa.clone.ClonePolicyCollectionOverride;
  32 import org.broadleafcommerce.common.extensibility.jpa.clone.IgnoreEnterpriseBehavior;
  33 import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransform;
  34 import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransformMember;
  35 import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransformTypes;
  36 import org.broadleafcommerce.common.i18n.service.DynamicTranslationProvider;
  37 import org.broadleafcommerce.common.media.domain.Media;
  38 import org.broadleafcommerce.common.money.Money;
  39 import org.broadleafcommerce.common.presentation.AdminPresentation;
  40 import org.broadleafcommerce.common.presentation.AdminPresentationCollection;
  41 import org.broadleafcommerce.common.presentation.AdminPresentationDataDrivenEnumeration;
  42 import org.broadleafcommerce.common.presentation.AdminPresentationMap;
  43 import org.broadleafcommerce.common.presentation.AdminPresentationMapField;
  44 import org.broadleafcommerce.common.presentation.AdminPresentationMapFields;
  45 import org.broadleafcommerce.common.presentation.AdminPresentationToOneLookup;
  46 import org.broadleafcommerce.common.presentation.ConfigurationItem;
  47 import org.broadleafcommerce.common.presentation.OptionFilterParam;
  48 import org.broadleafcommerce.common.presentation.OptionFilterParamType;
  49 import org.broadleafcommerce.common.presentation.ValidationConfiguration;
  50 import org.broadleafcommerce.common.presentation.client.LookupType;
  51 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  52 import org.broadleafcommerce.common.presentation.client.VisibilityEnum;
  53 import org.broadleafcommerce.common.util.DateUtil;
  54 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  55 import org.broadleafcommerce.core.catalog.service.dynamic.DynamicSkuPrices;
  56 import org.broadleafcommerce.core.catalog.service.dynamic.SkuActiveDateConsiderationContext;
  57 import org.broadleafcommerce.core.catalog.service.dynamic.SkuPricingConsiderationContext;
  58 import org.broadleafcommerce.core.inventory.service.type.InventoryType;
  59 import org.broadleafcommerce.core.order.domain.FulfillmentOption;
  60 import org.broadleafcommerce.core.order.domain.FulfillmentOptionImpl;
  61 import org.broadleafcommerce.core.order.service.type.FulfillmentType;
  62 import org.broadleafcommerce.core.search.domain.FieldEntity;
  63 import org.hibernate.annotations.BatchSize;
  64 import org.hibernate.annotations.Cache;
  65 import org.hibernate.annotations.CacheConcurrencyStrategy;
  66 import org.hibernate.annotations.Cascade;
  67 import org.hibernate.annotations.GenericGenerator;
  68 import org.hibernate.annotations.Index;
  69 import org.hibernate.annotations.Parameter;
  70 import org.hibernate.annotations.Type;
  71 
  72 import javax.persistence.CascadeType;
  73 import javax.persistence.CollectionTable;
  74 import javax.persistence.Column;
  75 import javax.persistence.ElementCollection;
  76 import javax.persistence.Embedded;
  77 import javax.persistence.Entity;
  78 import javax.persistence.FetchType;
  79 import javax.persistence.GeneratedValue;
  80 import javax.persistence.Id;
  81 import javax.persistence.Inheritance;
  82 import javax.persistence.InheritanceType;
  83 import javax.persistence.JoinColumn;
  84 import javax.persistence.JoinTable;
  85 import javax.persistence.Lob;
  86 import javax.persistence.ManyToMany;
  87 import javax.persistence.ManyToOne;
  88 import javax.persistence.MapKey;
  89 import javax.persistence.MapKeyClass;
  90 import javax.persistence.MapKeyJoinColumn;
  91 import javax.persistence.OneToMany;
  92 import javax.persistence.OneToOne;
  93 import javax.persistence.Table;
  94 import javax.persistence.Transient;
  95 
  96 import java.lang.reflect.InvocationHandler;
  97 import java.lang.reflect.Method;
  98 import java.lang.reflect.Proxy;
  99 import java.math.BigDecimal;
 100 import java.util.ArrayList;
 101 import java.util.Collection;
 102 import java.util.Collections;
 103 import java.util.Comparator;
 104 import java.util.Date;
 105 import java.util.HashMap;
 106 import java.util.HashSet;
 107 import java.util.LinkedHashMap;
 108 import java.util.List;
 109 import java.util.Map;
 110 import java.util.Set;
 111 import java.util.function.Function;
 112 import java.util.stream.Collectors;
 113 
 114 /**
 115  * The Class SkuImpl is the default implementation of {@link Sku}. A SKU is a
 116  * specific item that can be sold including any specific attributes of the item
 117  * such as color or size. &lt;br&gt;
 118  * &lt;br&gt;
 119  * If you want to add fields specific to your implementation of
 120  * BroadLeafCommerce you should extend this class and add your fields. If you
 121  * need to make significant changes to the SkuImpl then you should implement
 122  * your own version of {@link Sku}.&lt;br&gt;
 123  * &lt;br&gt;
 124  * This implementation uses a Hibernate implementation of JPA configured through
 125  * annotations. The Entity references the following tables: BLC_SKU,
 126  * BLC_SKU_IMAGE
 127  *
 128  * !!!!!!!!!!!!!!!!!
<abbr title=" 129  * &lt;p&gt;For admin required field validation, if this Sku is apart of an additionalSkus list (meaning it is not a defaultSku) then"> 129  * &lt;p&gt;For admin required field validation, if this Sku is apart of an additionalSkus list (meaning it is ðŸ”µ</abbr>
<abbr title=" 130  * it should have no required restrictions on it. All additional Skus can delegate to the defaultSku of the related product"> 130  * it should have no required restrictions on it. All additional Skus can delegate to the defaultSku of tðŸ”µ</abbr>
<abbr title=" 131  * for all of its fields. For this reason, if you would like to mark more fields as required then rather than using"> 131  * for all of its fields. For this reason, if you would like to mark more fields as required then rather ðŸ”µ</abbr>
<abbr title=" 132  * {@link AdminPresentation#requiredOverride()}, use the mo:overrides section in bl-admin-applicationContext.xml for Product"> 132  * {@link AdminPresentation#requiredOverride()}, use the mo:overrides section in bl-admin-applicationContðŸ”µ</abbr>
 133  * and reference each required field like &#x27;defaultSku.name&#x27; or &#x27;defaultSku.retailPrice&#x27;.&lt;/p&gt;
 134  *
 135  * @author btaylor
 136  * @see {@link Sku}
 137  */
 138 @Entity
 139 @Inheritance(strategy = InheritanceType.JOINED)
 140 @Table(name = &quot;BLC_SKU&quot;)
<abbr title=" 141 //multi-column indexes don&#x27;t appear to get exported correctly when declared at the field level, so declaring here as a workaround"> 141 //multi-column indexes don&#x27;t appear to get exported correctly when declared at the field level, so declarðŸ”µ</abbr>
 142 @org.hibernate.annotations.Table(appliesTo = &quot;BLC_SKU&quot;, indexes = {
 143     @Index(name = &quot;SKU_URL_KEY_INDEX&quot;,
 144         columnNames = { &quot;URL_KEY&quot; }
 145     )
 146 })
 147 @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 148 @DirectCopyTransform({
 149         @DirectCopyTransformMember(templateTokens = DirectCopyTransformTypes.SANDBOX, skipOverlaps=true),
 150         @DirectCopyTransformMember(templateTokens = DirectCopyTransformTypes.MULTITENANT_CATALOG)
 151 })
 152 public class SkuImpl implements Sku, SkuAdminPresentation {
 153 
 154     private static final Log LOG = LogFactory.getLog(SkuImpl.class);
 155 
 156     private static final long serialVersionUID = 1L;
 157 
 158     @Id
 159     @GeneratedValue(generator = &quot;SkuId&quot;)
 160     @GenericGenerator(
 161         name = &quot;SkuId&quot;,
 162         strategy = &quot;org.broadleafcommerce.common.persistence.IdOverrideTableGenerator&quot;,
 163         parameters = {
 164             @Parameter(name = &quot;segment_value&quot;, value = &quot;SkuImpl&quot;),
 165             @Parameter(name = &quot;entity_name&quot;, value = &quot;org.broadleafcommerce.core.catalog.domain.SkuImpl&quot;)
 166         }
 167     )
 168     @Column(name = &quot;SKU_ID&quot;)
 169     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_ID&quot;, visibility = VisibilityEnum.HIDDEN_ALL)
 170     protected Long id;
 171 
 172     @Column(name = &quot;EXTERNAL_ID&quot;)
 173     @Index(name=&quot;SKU_EXTERNAL_ID_INDEX&quot;, columnNames={&quot;EXTERNAL_ID&quot;})
 174     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_ExternalID&quot;,
 175         group = GroupName.Miscellaneous, order = FieldOrder.EXTERNAL_ID,
 176         tooltip = &quot;SkuImpl_Sku_ExternalID_Tooltip&quot;)
 177     protected String externalId;
 178 
 179     @Column(name = &quot;URL_KEY&quot;)
 180     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_UrlKey&quot;,
 181         group = GroupName.Advanced, order = 4000,
 182         excluded = true)
 183     protected String urlKey;
 184 
 185     @Column(name = &quot;DISPLAY_TEMPLATE&quot;)
 186     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Display_Template&quot;,
 187         group = GroupName.Advanced, order = 5000,
 188         excluded = true)
 189     protected String displayTemplate;
 190 
 191     @Column(name = &quot;UPC&quot;)
 192     @Index(name = &quot;SKU_UPC_INDEX&quot;, columnNames = { &quot;UPC&quot; })
 193     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_UPC&quot;,
 194             group = GroupName.Miscellaneous, order = FieldOrder.UPC)
 195     protected String upc;
 196 
 197     @Column(name = &quot;SALE_PRICE&quot;, precision = 19, scale = 5)
 198     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Sale_Price&quot;,
 199         group = GroupName.Price, order = FieldOrder.SALE_PRICE,
 200         tooltip = &quot;SkuImpl_Sku_Sale_Price_tooltip&quot;,
 201         prominent = true, gridOrder = 6,
 202         fieldType = SupportedFieldType.MONEY)
 203     protected BigDecimal salePrice;
 204 
 205     @Column(name = &quot;RETAIL_PRICE&quot;, precision = 19, scale = 5)
 206     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Retail_Price&quot;,
 207         group = GroupName.Price, order = FieldOrder.RETAIL_PRICE,
 208         prominent = true, gridOrder = 5,
 209         fieldType = SupportedFieldType.MONEY)
 210     protected BigDecimal retailPrice;
 211 
 212     @Column(name = &quot;COST&quot;, precision = 19, scale = 5)
 213     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Cost&quot;,
 214             group = GroupName.Price, order = FieldOrder.COST,
 215             fieldType = SupportedFieldType.MONEY)
 216     protected BigDecimal cost;
 217 
 218     @Column(name = &quot;NAME&quot;)
 219     @Index(name = &quot;SKU_NAME_INDEX&quot;, columnNames = {&quot;NAME&quot;})
 220     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Name&quot;,
 221         group = GroupName.General, order = FieldOrder.NAME,
 222         prominent = true, gridOrder = 1, columnWidth = &quot;260px&quot;,
 223         translatable = true)
 224     protected String name;
 225 
 226     @Column(name = &quot;DESCRIPTION&quot;)
 227     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Description&quot;,
 228         group = GroupName.General, order = FieldOrder.SHORT_DESCRIPTION,
 229         largeEntry = true,
 230         excluded = true,
 231         translatable = true)
 232     protected String description;
 233 
 234     @Lob
 235     @Type(type = &quot;org.hibernate.type.MaterializedClobType&quot;)
 236     @Column(name = &quot;LONG_DESCRIPTION&quot;, length = Integer.MAX_VALUE - 1)
 237     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Large_Description&quot;,
 238         group = GroupName.General, order = FieldOrder.LONG_DESCRIPTION,
 239         largeEntry = true,
 240         fieldType = SupportedFieldType.HTML_BASIC,
 241         translatable = true)
 242     protected String longDescription;
 243 
 244     @Column(name = &quot;TAX_CODE&quot;)
 245     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_TaxCode&quot;, order = 1001, group = GroupName.Financial)
<abbr title=" 246     @AdminPresentationDataDrivenEnumeration(optionCanEditValues = true, optionHideIfEmpty = true, optionFilterParams = { @OptionFilterParam("> 246     @AdminPresentationDataDrivenEnumeration(optionCanEditValues = true, optionHideIfEmpty = true, optionFðŸ”µ</abbr>
 247             param = &quot;type.key&quot;, value = &quot;TAX_CODE&quot;, paramType = OptionFilterParamType.STRING) })
 248     protected String taxCode;
 249 
 250     @Column(name = &quot;TAXABLE_FLAG&quot;)
 251     @Index(name=&quot;SKU_TAXABLE_INDEX&quot;, columnNames={&quot;TAXABLE_FLAG&quot;})
 252     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Taxable&quot;,
 253             group = GroupName.Financial, order = FieldOrder.TAXABLE)
 254     protected Character taxable;
 255 
 256     @Column(name = &quot;DISCOUNTABLE_FLAG&quot;)
 257     @Index(name=&quot;SKU_DISCOUNTABLE_INDEX&quot;, columnNames={&quot;DISCOUNTABLE_FLAG&quot;})
 258     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Discountable&quot;,
 259         group = GroupName.Discountable,
 260         helpText = &quot;SkuImpl_Sku_Discountable_helptext&quot;,
 261         defaultValue = &quot;Y&quot;)
 262     protected Character discountable;
 263 
 264     @Column(name = &quot;AVAILABLE_FLAG&quot;)
 265     @Index(name = &quot;SKU_AVAILABLE_INDEX&quot;, columnNames = {&quot;AVAILABLE_FLAG&quot;})
 266     @AdminPresentation(excluded = true)
 267     @Deprecated
 268     protected Character available;
 269 
 270     @Column(name = &quot;ACTIVE_START_DATE&quot;)
 271     @Index(name=&quot;SKU_ACTIVE_START_INDEX&quot;)
 272     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Start_Date&quot;,
 273         group = GroupName.ActiveDateRange, order = FieldOrder.ACTIVE_START_DATE,
 274         tooltip = &quot;skuStartDateTooltip&quot;,
 275         defaultValue = &quot;today&quot;)
 276     protected Date activeStartDate;
 277 
 278     @Column(name = &quot;ACTIVE_END_DATE&quot;)
 279     @Index(name=&quot;SKU_ACTIVE_END_INDEX&quot;)
 280     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_End_Date&quot;,
 281         group = GroupName.ActiveDateRange, order = FieldOrder.ACTIVE_END_DATE,
 282         tooltip = &quot;skuEndDateTooltip&quot;,
 283         validationConfigurations = {
 284             @ValidationConfiguration(
 285                 validationImplementation = &quot;blAfterStartDateValidator&quot;,
 286                 configurationItems = {
 287                         @ConfigurationItem(itemName = &quot;otherField&quot;, itemValue = &quot;activeStartDate&quot;)
 288                 })
 289         })
 290     protected Date activeEndDate;
 291 
 292     @Embedded
 293     protected Dimension dimension = new Dimension();
 294 
 295     @Embedded
 296     protected Weight weight = new Weight();
 297 
 298     @Column(name = &quot;IS_MACHINE_SORTABLE&quot;)
 299     @AdminPresentation(friendlyName = &quot;ProductImpl_Is_Product_Machine_Sortable&quot;,
 300         group = GroupName.ShippingOther, order = FieldOrder.IS_MACHINE_SORTABLE,
 301         defaultValue = &quot;false&quot;)
 302     protected Boolean isMachineSortable;
 303 
 304     @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuMediaXrefImpl.class, cascade = { CascadeType.ALL })
 305     @MapKey(name = &quot;key&quot;)
 306     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 307     @BatchSize(size = 50)
 308     @AdminPresentationMap(friendlyName = &quot;SkuImpl_Sku_Media&quot;,
 309         tab = TabName.Media,
 310         keyPropertyFriendlyName = &quot;SkuImpl_Sku_Media_Key&quot;,
 311         deleteEntityUponRemove = true,
 312         mediaField = &quot;media.url&quot;,
 313         toOneTargetProperty = &quot;media&quot;,
 314         toOneParentProperty = &quot;sku&quot;,
 315         forceFreeFormKeys = true
 316     )
 317     @AdminPresentationMapFields(
 318         mapDisplayFields = {
 319             @AdminPresentationMapField(
 320                     fieldName = &quot;primary&quot;,
 321                     fieldPresentation = @AdminPresentation(fieldType = SupportedFieldType.MEDIA,
 322                             group = GroupName.Image,
 323                             order = FieldOrder.PRIMARY_MEDIA,
 324                             friendlyName = &quot;SkuImpl_Primary_Media&quot;)
 325             )
 326     })
 327     protected Map&lt;String, SkuMediaXref&gt; skuMedia = new HashMap&lt;String, SkuMediaXref&gt;();
 328 
 329     @Transient
 330     protected Map&lt;String, Media&gt; legacySkuMedia = new HashMap&lt;String, Media&gt;();
 331 
 332     /**
 333      * This will be non-null if and only if this Sku is the default Sku for a Product
 334      */
 335     @OneToOne(optional = true, targetEntity = ProductImpl.class, cascade = {CascadeType.ALL})
 336     @Cascade(value = {org.hibernate.annotations.CascadeType.ALL})
 337     @JoinColumn(name = &quot;DEFAULT_PRODUCT_ID&quot;)
 338     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 339     @IgnoreEnterpriseBehavior
 340     protected Product defaultProduct;
 341 
 342     /**
 343      * This relationship will be non-null if and only if this Sku is contained in the list of
 344      * additional Skus for a Product (for Skus based on ProductOptions)
 345      */
<abbr title=" 346     @ManyToOne(optional = true, targetEntity = ProductImpl.class, cascade = {CascadeType.PERSIST, CascadeType.MERGE, CascadeType.REFRESH})"> 346     @ManyToOne(optional = true, targetEntity = ProductImpl.class, cascade = {CascadeType.PERSIST, CascadeðŸ”µ</abbr>
 347     @JoinColumn(name = &quot;ADDL_PRODUCT_ID&quot;)
 348     protected Product product;
 349 
 350 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 351 @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL }, orphanRemoval = true)"> 351 @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL }, orphanðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 352     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)</span>
 353 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 354 @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL }, orphanRemoval = true)"> 354 @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL }, orphanðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355     @Cache(usage=CacheConcurrencyStrategy.NONSTRICT_READ_WRITE, region=&quot;blProducts&quot;)</span>
 356 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357 @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL })</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 358     @Cache(usage=CacheConcurrencyStrategy.NONSTRICT_READ_WRITE, region=&quot;blProducts&quot;)</span>
 359 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 360     @BatchSize(size = 50)
 361     @AdminPresentationCollection(friendlyName = &quot;skuAttributesTitle&quot;,
 362             tab = TabName.Advanced, order = 1000)
 363     protected List&lt;SkuAttribute&gt; skuAttributes = new ArrayList&lt;SkuAttribute&gt;();
 364 
<abbr title=" 365     @OneToMany(targetEntity = SkuProductOptionValueXrefImpl.class, cascade = CascadeType.ALL, mappedBy = &quot;sku&quot;)"> 365     @OneToMany(targetEntity = SkuProductOptionValueXrefImpl.class, cascade = CascadeType.ALL, mappedBy = ðŸ”µ</abbr>
 366     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 367     @BatchSize(size = 50)
 368     @ClonePolicyCollectionOverride
 369     @ClonePolicyArchive
 370     //Use a Set instead of a List - see https://github.com/BroadleafCommerce/BroadleafCommerce/issues/917
<abbr title=" 371     protected Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs = new HashSet&lt;SkuProductOptionValueXref&gt;();"> 371     protected Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs = new HashSet&lt;SkuProductOptionValueXðŸ”µ</abbr>
 372 
 373     @Transient
 374     protected Set&lt;ProductOptionValue&gt; legacyProductOptionValues = new HashSet&lt;ProductOptionValue&gt;();
 375 
 376     @ManyToMany(fetch = FetchType.LAZY, targetEntity = SkuFeeImpl.class)
 377     @JoinTable(name = &quot;BLC_SKU_FEE_XREF&quot;,
 378             joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;, nullable = true),
<abbr title=" 379             inverseJoinColumns = @JoinColumn(name = &quot;SKU_FEE_ID&quot;, referencedColumnName = &quot;SKU_FEE_ID&quot;, nullable = true))"> 379             inverseJoinColumns = @JoinColumn(name = &quot;SKU_FEE_ID&quot;, referencedColumnName = &quot;SKU_FEE_ID&quot;, nuðŸ”µ</abbr>
 380     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 381     @BatchSize(size = 50)
 382     protected List&lt;SkuFee&gt; fees = new ArrayList&lt;SkuFee&gt;();
 383 
 384     @ElementCollection
 385     @CollectionTable(name = &quot;BLC_SKU_FULFILLMENT_FLAT_RATES&quot;,
 386         joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;, nullable = true))
 387     @MapKeyJoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;, referencedColumnName = &quot;FULFILLMENT_OPTION_ID&quot;)
 388     @MapKeyClass(FulfillmentOptionImpl.class)
 389     @Column(name = &quot;RATE&quot;, precision = 19, scale = 5)
 390     @Cascade(org.hibernate.annotations.CascadeType.ALL)
 391     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 392     @BatchSize(size = 50)
<abbr title=" 393     protected Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates = new HashMap&lt;FulfillmentOption, BigDecimal&gt;();"> 393     protected Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates = new HashMap&lt;FulfillmentOption, BiðŸ”µ</abbr>
 394 
 395     @ManyToMany(targetEntity = FulfillmentOptionImpl.class)
 396     @JoinTable(name = &quot;BLC_SKU_FULFILLMENT_EXCLUDED&quot;,
 397             joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;),
<abbr title=" 398             inverseJoinColumns = @JoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;,referencedColumnName = &quot;FULFILLMENT_OPTION_ID&quot;))"> 398             inverseJoinColumns = @JoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;,referencedColumnName = &quot;FULFIðŸ”µ</abbr>
 399     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 400     @BatchSize(size = 50)
 401     protected List&lt;FulfillmentOption&gt; excludedFulfillmentOptions = new ArrayList&lt;FulfillmentOption&gt;();
 402 
 403     @Column(name = &quot;INVENTORY_TYPE&quot;)
 404     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_InventoryType&quot;,
 405         group = GroupName.Inventory, order = 1000,
 406         helpText = &quot;skuInventoryTypeHelpText&quot;,
 407         fieldType = SupportedFieldType.BROADLEAF_ENUMERATION,
 408         broadleafEnumeration = &quot;org.broadleafcommerce.core.inventory.service.type.InventoryType&quot;,
 409         columnWidth = &quot;180px&quot;, prominent = true)
 410     protected String inventoryType;
 411 
 412     @Column(name = &quot;QUANTITY_AVAILABLE&quot;)
 413     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_QuantityAvailable&quot;,
 414             group = GroupName.Inventory, order = 1010)
 415     protected Integer quantityAvailable = 0;
 416 
 417     @Column(name = &quot;FULFILLMENT_TYPE&quot;)
 418     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_FulfillmentType&quot;,
 419         group = GroupName.ShippingFulfillment, order = FieldOrder.FULFILLMENT_TYPE,
 420         fieldType = SupportedFieldType.BROADLEAF_ENUMERATION,
 421         broadleafEnumeration = &quot;org.broadleafcommerce.core.order.service.type.FulfillmentType&quot;)
 422     protected String fulfillmentType;
 423 
 424     /**
<abbr title=" 425      * Note that this field is not the target of the currencyCodeField attribute on either retailPrice or salePrice."> 425      * Note that this field is not the target of the currencyCodeField attribute on either retailPrice orðŸ”µ</abbr>
<abbr title=" 426      * This is because SKUs are special in that we want to return the currency on this SKU if there is one, falling back"> 426      * This is because SKUs are special in that we want to return the currency on this SKU if there is onðŸ”µ</abbr>
 427      * to the defaultSku&#x27;s currency if possible.
 428      *
 429      * Normally null and hidden.  Use Meta-Data overrides to display in the admin.
 430      * @see Sku#getCurrency() for further cautions about using this field.
 431      */
 432     @ManyToOne(targetEntity = BroadleafCurrencyImpl.class, fetch = FetchType.LAZY)
 433     @JoinColumn(name = &quot;CURRENCY_CODE&quot;)
 434     @AdminPresentation(friendlyName = &quot;SkuImpl_Currency&quot;,
 435             group = GroupName.Advanced, order = 3000,
 436             visibility = VisibilityEnum.HIDDEN_ALL)
<abbr title=" 437     @AdminPresentationToOneLookup(lookupType = LookupType.DROPDOWN, lookupDisplayProperty = &quot;friendlyName&quot;)"> 437     @AdminPresentationToOneLookup(lookupType = LookupType.DROPDOWN, lookupDisplayProperty = &quot;friendlyNameðŸ”µ</abbr>
 438     protected BroadleafCurrency currency;
 439 
 440     @Override
 441     public Long getId() {
 442         return id;
 443     }
 444 
 445     @Override
 446     public void setId(Long id) {
 447         this.id = id;
 448     }
 449 
 450     @Override
 451     public String getUrlKey() {
 452         return urlKey;
 453     }
 454 
 455     @Override
 456     public void setUrlKey(String urlKey) {
 457         this.urlKey = urlKey;
 458     }
 459 
 460     @Override
 461     public String getDisplayTemplate() {
 462         return displayTemplate;
 463     }
 464 
 465     @Override
 466     public void setDisplayTemplate(String displayTemplate) {
 467         this.displayTemplate = displayTemplate;
 468     }
 469 
 470     @Override
 471     public boolean isOnSale() {
 472         Money retailPrice = getRetailPrice();
 473         Money salePrice = getSalePrice();
 474         return (salePrice != null &amp;&amp; !salePrice.isZero() &amp;&amp; salePrice.lessThan(retailPrice));
 475     }
 476 
 477     protected boolean hasDefaultSku() {
<abbr title=" 478         return (product != null &amp;&amp; product.getDefaultSku() != null &amp;&amp; getId() != null &amp;&amp; !getId().equals(product.getDefaultSku().getId()));"> 478         return (product != null &amp;&amp; product.getDefaultSku() != null &amp;&amp; getId() != null &amp;&amp; !getId().equals(ðŸ”µ</abbr>
 479     }
 480 
 481     protected Sku lookupDefaultSku() {
 482         if (product != null &amp;&amp; product.getDefaultSku() != null) {
 483             return product.getDefaultSku();
 484         } else {
 485             return null;
 486         }
 487     }
 488 
 489     @Override
 490     public Money getProductOptionValueAdjustments() {
 491         Money optionValuePriceAdjustments = null;
 492         if (getProductOptionValues() != null) {
 493             for (ProductOptionValue value : getProductOptionValues()) {
 494                 if (value.getPriceAdjustment() != null) {
 495                     if (optionValuePriceAdjustments == null) {
 496                         optionValuePriceAdjustments = value.getPriceAdjustment();
 497                     } else {
<abbr title=" 498                         optionValuePriceAdjustments = optionValuePriceAdjustments.add(value.getPriceAdjustment());"> 498                         optionValuePriceAdjustments = optionValuePriceAdjustments.add(value.getPriceAdjusðŸ”µ</abbr>
 499                     }
 500                 }
 501             }
 502         }
 503         return optionValuePriceAdjustments;
 504     }
 505 
 506     @Override
 507     public Money getSalePrice() {
 508         Money returnPrice = null;
 509         Money optionValueAdjustments = null;
 510 
 511         if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 512             // We have dynamic pricing, so we will pull the sale price from there
 513             DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 514             returnPrice = dynamicPrices.getSalePrice();
 515             optionValueAdjustments = dynamicPrices.getPriceAdjustment();
 516             if (SkuPricingConsiderationContext.isPricingConsiderationActive()) {
 517                 return returnPrice;
 518             }
 519         } else if (salePrice != null) {
<abbr title=" 520             // We have an explicitly set sale price directly on this entity. We will not apply any adjustments"> 520             // We have an explicitly set sale price directly on this entity. We will not apply any adjustðŸ”µ</abbr>
 521             returnPrice = new Money(salePrice, getCurrency());
 522         }
 523 
 524         if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 525             returnPrice = lookupDefaultSku().getSalePrice();
 526             optionValueAdjustments = getProductOptionValueAdjustments();
 527         }
 528 
 529         if (returnPrice == null) {
 530             return null;
 531         }
 532 
 533         if (optionValueAdjustments != null) {
 534             returnPrice = returnPrice.add(optionValueAdjustments);
 535         }
 536 
 537         return returnPrice;
 538     }
 539 
 540     @Override
 541     public boolean hasSalePrice() {
 542         return getSalePrice() != null;
 543     }
 544 
 545     @Override
 546     public void setSalePrice(Money salePrice) {
 547         this.salePrice = Money.toAmount(salePrice);
 548     }
 549 
 550     @Override
 551     public Money getRetailPrice() {
 552         return getRetailPriceInternal();
 553     }
 554 
 555     /*
<abbr title=" 556      * This allows us a way to determine or calculate the retail price. If one is not available this method will return null."> 556      * This allows us a way to determine or calculate the retail price. If one is not available this methðŸ”µ</abbr>
<abbr title=" 557      * This allows the call to hasRetailPrice() to determine if there is a retail price without the overhead of an exception."> 557      * This allows the call to hasRetailPrice() to determine if there is a retail price without the overhðŸ”µ</abbr>
 558      */
 559     protected Money getRetailPriceInternal() {
 560         Money returnPrice = null;
 561         Money optionValueAdjustments = null;
 562 
 563         if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 564             // We have dynamic pricing, so we will pull the retail price from there
 565             DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 566             returnPrice = dynamicPrices.getRetailPrice();
 567             optionValueAdjustments = dynamicPrices.getPriceAdjustment();
 568             if (SkuPricingConsiderationContext.isPricingConsiderationActive()) {
 569                 return returnPrice;
 570             }
 571         } else if (retailPrice != null) {
 572             returnPrice = new Money(retailPrice, getCurrency());
 573         }
 574 
 575         if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 576             // Otherwise, we&#x27;ll pull the retail price from the default sku
 577             returnPrice = lookupDefaultSku().getRetailPrice();
 578             optionValueAdjustments = getProductOptionValueAdjustments();
 579         }
 580 
 581         if (returnPrice != null &amp;&amp; optionValueAdjustments != null) {
 582             returnPrice = returnPrice.add(optionValueAdjustments);
 583         }
 584 
 585         return returnPrice;
 586     }
 587 
 588     @Override
 589     public Money getBaseRetailPrice() {
 590         Money returnPrice = null;
 591         if (retailPrice != null) {
 592             returnPrice = new Money(retailPrice, getCurrency());
 593         }
 594         if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 595             Sku defaultSku = lookupDefaultSku();
 596             returnPrice = defaultSku.getBaseRetailPrice();
 597         }
 598         return returnPrice;
 599     }
 600 
 601     @Override
 602     public Money getBaseSalePrice() {
 603         Money returnPrice = null;
 604         if (salePrice != null) {
 605             returnPrice = new Money(salePrice, getCurrency());
 606         }
 607         if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 608             Sku defaultSku = lookupDefaultSku();
 609             returnPrice = defaultSku.getBaseSalePrice();
 610         }
 611         return returnPrice;
 612     }
 613 
 614     @Override
 615     public DynamicSkuPrices getPriceData() {
 616         if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 617             DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 618             return dynamicPrices;
 619         } else {
 620             DynamicSkuPrices dsp = new DynamicSkuPrices();
 621             BroadleafCurrency tmpCurrency;
 622             if (currency != null) {
 623                 tmpCurrency = currency;
 624             } else {
 625                 tmpCurrency = BroadleafRequestContext.getCurrency();
 626             }
 627             if (retailPrice != null) {
 628                 dsp.setRetailPrice(new Money(retailPrice, tmpCurrency));
 629             }
 630             if (salePrice != null) {
 631                 dsp.setSalePrice(new Money(salePrice, tmpCurrency));
 632             }
 633             return dsp;
 634         }
 635     }
 636 
 637     @Override
 638     public boolean hasRetailPrice() {
 639         return getRetailPriceInternal() != null;
 640     }
 641 
 642     @Override
 643     public void setRetailPrice(Money retailPrice) {
 644         this.retailPrice = Money.toAmount(retailPrice);
 645     }
 646 
 647     @Override
 648     public Money getPrice() {
 649         return isOnSale() ? getSalePrice() : getRetailPrice();
 650     }
 651 
 652     @Override
 653     @Deprecated
 654     public Money getListPrice() {
 655         return getRetailPrice();
 656     }
 657 
 658     @Override
 659     @Deprecated
 660     public void setListPrice(Money listPrice) {
 661         this.retailPrice = Money.toAmount(listPrice);
 662     }
 663 
 664     @Override
 665     public Money getCost() {
 666         if (cost == null &amp;&amp; hasDefaultSku()) {
 667             return lookupDefaultSku().getCost();
 668         }
 669 
 670         if (cost == null) {
 671             return null;
 672         }
 673 
 674         return new Money(cost, getCurrency());
 675     }
 676 
 677     @Override
 678     public void setCost(Money cost) {
 679         this.cost = cost.getAmount();
 680     }
 681 
 682     @Override
 683     public Money getMargin() {
 684         Money margin = null;
 685         Money price = getPrice();
 686         Money purchaseCost = getCost();
 687 
 688         if (price == null &amp;&amp; hasDefaultSku()) {
 689             price = lookupDefaultSku().getPrice();
 690         }
 691 
 692         if (purchaseCost == null &amp;&amp; hasDefaultSku()) {
 693             purchaseCost = lookupDefaultSku().getCost();
 694         }
 695 
 696         if (price != null &amp;&amp; !price.getAmount().equals(BigDecimal.ZERO)) {
 697             if (purchaseCost != null) {
 698                 margin = price.subtract(purchaseCost).divide(price.getAmount());
 699             }
 700         } else {
 701             margin = Money.ZERO;
 702         }
 703 
 704         return margin;
 705     }
 706 
 707     @Override
 708     public String getName() {
 709         if (name == null &amp;&amp; hasDefaultSku()) {
 710             return lookupDefaultSku().getName();
 711         }
 712 
 713         return DynamicTranslationProvider.getValue(this, &quot;name&quot;, name);
 714     }
 715 
 716     @Override
 717     public void setName(String name) {
 718         this.name = name;
 719     }
 720 
 721     @Override
 722     public String getDescription() {
 723         if (description == null &amp;&amp; hasDefaultSku()) {
 724             return lookupDefaultSku().getDescription();
 725         }
 726 
 727         return DynamicTranslationProvider.getValue(this, &quot;description&quot;, description);
 728     }
 729 
 730     @Override
 731     public void setDescription(String description) {
 732         this.description = description;
 733     }
 734 
 735     @Override
 736     public String getLongDescription() {
 737         if (longDescription == null &amp;&amp; hasDefaultSku()) {
 738             return lookupDefaultSku().getLongDescription();
 739         }
 740 
 741         return DynamicTranslationProvider.getValue(this, &quot;longDescription&quot;, longDescription);
 742     }
 743 
 744     @Override
 745     public void setLongDescription(String longDescription) {
 746         this.longDescription = longDescription;
 747     }
 748 
 749     @Override
 750     public Boolean isTaxable() {
 751         if (taxable == null) {
 752             if (hasDefaultSku()) {
 753                 return lookupDefaultSku().isTaxable();
 754             }
 755             return null;
 756         }
 757         return taxable == &#x27;Y&#x27; ? Boolean.TRUE : Boolean.FALSE;
 758     }
 759 
 760     @Override
 761     public Boolean getTaxable() {
 762         return isTaxable();
 763     }
 764 
 765     @Override
 766     public void setTaxable(Boolean taxable) {
 767         if (taxable == null) {
 768             this.taxable = null;
 769         } else {
 770             this.taxable = taxable ? &#x27;Y&#x27; : &#x27;N&#x27;;
 771         }
 772     }
 773 
 774     @Override
 775     public Boolean isDiscountable() {
 776         if (discountable == null) {
 777             if (hasDefaultSku()) {
 778                 return lookupDefaultSku().isDiscountable();
 779             }
 780             return Boolean.FALSE;
 781         }
 782         return discountable == &#x27;Y&#x27; ? Boolean.TRUE : Boolean.FALSE;
 783     }
 784 
 785     /*
 786      * This is to facilitate serialization to non-Java clients
 787      */
 788     public Boolean getDiscountable() {
 789         return isDiscountable();
 790     }
 791 
 792     @Override
 793     public void setDiscountable(Boolean discountable) {
 794         if (discountable == null) {
 795             this.discountable = null;
 796         } else {
 797             this.discountable = discountable ? &#x27;Y&#x27; : &#x27;N&#x27;;
 798         }
 799     }
 800 
 801     @Override
 802     public Boolean isAvailable() {
 803         if (InventoryType.UNAVAILABLE.equals(getInventoryType())) {
 804             return false;
 805         }
 806 
 807         if (available == null) {
 808             if (hasDefaultSku()) {
 809                 return lookupDefaultSku().isAvailable();
 810             }
 811             return true;
 812         }
 813         return available != &#x27;N&#x27;;
 814     }
 815 
 816     @Override
 817     public Boolean getAvailable() {
 818         return isAvailable();
 819     }
 820 
 821     @Override
 822     public void setAvailable(Boolean available) {
 823         if (available == null) {
 824             this.available = null;
 825         } else {
 826             this.available = available ? &#x27;Y&#x27; : &#x27;N&#x27;;
 827         }
 828     }
 829 
 830     @Override
 831     public Date getActiveStartDate() {
 832         Date returnDate = null;
 833         if (SkuActiveDateConsiderationContext.hasDynamicActiveDates()) {
<abbr title=" 834             returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveStartDate(this);"> 834             returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveðŸ”µ</abbr>
 835         }
 836 
 837         if (returnDate == null) {
 838             if (activeStartDate == null &amp;&amp; hasDefaultSku()) {
 839                 return lookupDefaultSku().getActiveStartDate();
 840             } else {
 841                 return activeStartDate;
 842             }
 843         } else {
 844             return returnDate;
 845         }
 846     }
 847 
 848     @Override
 849     public void setActiveStartDate(Date activeStartDate) {
 850         this.activeStartDate = activeStartDate;
 851     }
 852 
 853     @Override
 854     public Date getActiveEndDate() {
 855         Date returnDate = null;
 856         if (SkuActiveDateConsiderationContext.hasDynamicActiveDates()) {
<abbr title=" 857             returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveEndDate(this);"> 857             returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveðŸ”µ</abbr>
 858         }
 859 
 860         if (returnDate == null) {
 861             if (activeEndDate == null &amp;&amp; hasDefaultSku()) {
 862                 return lookupDefaultSku().getActiveEndDate();
 863             } else {
 864                 return activeEndDate;
 865             }
 866         } else {
 867             return returnDate;
 868         }
 869     }
 870 
 871     @Override
 872     public void setActiveEndDate(Date activeEndDate) {
 873         this.activeEndDate = activeEndDate;
 874     }
 875 
 876     @Override
 877     public Dimension getDimension() {
 878         if (dimension == null &amp;&amp; hasDefaultSku()) {
 879             return lookupDefaultSku().getDimension();
 880         } else {
 881             return dimension;
 882         }
 883     }
 884 
 885     @Override
 886     public void setDimension(Dimension dimension) {
 887         this.dimension = dimension;
 888     }
 889 
 890     @Override
 891     public Weight getWeight() {
 892         if (weight == null &amp;&amp; hasDefaultSku()) {
 893             return lookupDefaultSku().getWeight();
 894         } else {
 895             return weight;
 896         }
 897     }
 898 
 899     @Override
 900     public void setWeight(Weight weight) {
 901         this.weight = weight;
 902     }
 903 
 904     @Override
 905     public boolean isActive() {
 906         if (activeStartDate == null &amp;&amp; activeEndDate == null &amp;&amp; hasDefaultSku()) {
 907             return lookupDefaultSku().isActive();
 908         }
 909         if (LOG.isDebugEnabled()) {
 910             if (!DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true)) {
 911                 LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to date&quot;);
 912             }
 913         }
 914 
 915         if (!(getProduct() == null) &amp;&amp; !getProduct().isActive()) {
 916             return false;
 917         }
 918 
 919         return DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true);
 920     }
 921 
 922     @Override
 923     public boolean isActive(Product product, Category category) {
 924         if (LOG.isDebugEnabled()) {
 925             if (!DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true)) {
 926                 LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to date&quot;);
 927             } else if (!product.isActive()) {
 928                 LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to product being inactive&quot;);
 929             } else if (!category.isActive()) {
 930                 LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to category being inactive&quot;);
 931             }
 932         }
<abbr title=" 933         return this.isActive() &amp;&amp; (product == null || product.isActive()) &amp;&amp; (category == null || category.isActive());"> 933         return this.isActive() &amp;&amp; (product == null || product.isActive()) &amp;&amp; (category == null || categorðŸ”µ</abbr>
 934     }
 935 
 936     @Override
 937     @Deprecated
 938     public Map&lt;String, Media&gt; getSkuMedia() {
 939         Map&lt;String, Media&gt; skuMediaMap = new LinkedHashMap&lt;&gt;(legacySkuMedia);
 940 
 941         if (MapUtils.isEmpty(skuMediaMap)) {
 942             for (Map.Entry&lt;String, SkuMediaXref&gt; entry : getSkuMediaXref().entrySet()) {
 943                 skuMediaMap.put(entry.getKey(), entry.getValue().getMedia());
 944             }
 945         }
 946 
 947         return Collections.unmodifiableMap(skuMediaMap);
 948     }
 949 
 950     @Override
 951     @Deprecated
 952     public void setSkuMedia(Map&lt;String, Media&gt; skuMedia) {
 953         this.skuMedia.clear();
 954         this.legacySkuMedia.clear();
 955         for(Map.Entry&lt;String, Media&gt; entry : skuMedia.entrySet()){
<abbr title=" 956             this.skuMedia.put(entry.getKey(), new SkuMediaXrefImpl(this, entry.getValue(), entry.getKey()));"> 956             this.skuMedia.put(entry.getKey(), new SkuMediaXrefImpl(this, entry.getValue(), entry.getKey()ðŸ”µ</abbr>
 957         }
 958     }
 959 
 960     @Override
 961     public Map&lt;String, SkuMediaXref&gt; getSkuMediaXref() {
 962         Map&lt;String, SkuMediaXref&gt; skuMediaMap = skuMedia;
 963 
 964         if (MapUtils.isEmpty(skuMediaMap)) {
 965             if (hasDefaultSku()) {
 966                 return lookupDefaultSku().getSkuMediaXref();
 967             }
 968         }
 969 
 970         if (isOrderedSkuMedia(skuMediaMap)) {
 971             skuMediaMap = sortSkuMedia(skuMediaMap);
 972         }
 973 
 974         return skuMediaMap;
 975     }
 976 
 977     @Override
 978     public Map&lt;String, SkuMediaXref&gt; getSkuMediaXrefIgnoreDefaultSku() {
 979         Map&lt;String, SkuMediaXref&gt; skuMediaMap = skuMedia;
 980 
 981         if (isOrderedSkuMedia(skuMediaMap)) {
 982             skuMediaMap = sortSkuMedia(skuMediaMap);
 983         }
 984 
 985         return skuMediaMap;
 986     }
 987 
 988     @Override
 989     public Media getPrimarySkuMedia() {
 990         Map&lt;String, SkuMediaXref&gt; skuMediaMap = getSkuMediaXrefIgnoreDefaultSku();
 991 
 992         if (MapUtils.isNotEmpty(skuMediaMap)) {
 993             if (isOrderedSkuMedia(skuMediaMap)) {
 994                 return skuMediaMap.values().stream()
 995                         .map(OrderedSkuMediaXref.class::cast)
 996                         .filter(OrderedSkuMediaXref::getShowInGallery)
 997                         .findFirst()
 998                         .map(SkuMediaXref.class::cast)
 999                         .map(SkuMediaXref::getMedia)
1000                         .orElse(null);
1001             } else {
1002                 SkuMediaXref primaryXref = skuMediaMap.get(&quot;primary&quot;);
1003 
1004                 return (primaryXref == null)? null : primaryXref.getMedia();
1005             }
1006         }
1007 
1008         return null;
1009     }
1010 
1011     @Override
1012     public void setSkuMediaXref(Map&lt;String, SkuMediaXref&gt; skuMediaXref) {
1013         this.skuMedia = skuMediaXref;
1014     }
1015 
1016     protected boolean isOrderedSkuMedia(Map&lt;String, SkuMediaXref&gt; skuMedia) {
1017         return skuMedia.values().stream()
1018                 .anyMatch(OrderedSkuMediaXref.class::isInstance);
1019     }
1020 
1021     protected Map&lt;String, SkuMediaXref&gt; sortSkuMedia(Map&lt;String, SkuMediaXref&gt; skuMedia) {
1022         return skuMedia.values().stream()
1023                 .sorted(Comparator.comparing(xref -&gt; ((OrderedSkuMediaXref) xref).getDisplayOrder()))
1024                 .collect(Collectors.toMap(SkuMediaXref::getKey, Function.identity(),
<abbr title="1025                         (key1,key2) -&gt;{ throw new IllegalStateException(String.format(&quot;Duplicate key %s&quot;, key1)); },">1025                         (key1,key2) -&gt;{ throw new IllegalStateException(String.format(&quot;Duplicate key %s&quot;,ðŸ”µ</abbr>
1026                         LinkedHashMap::new));
1027     }
1028 
1029     @Override
1030     public Product getDefaultProduct() {
1031         return defaultProduct;
1032     }
1033 
1034     @Override
1035     public void setDefaultProduct(Product defaultProduct) {
1036         this.defaultProduct = defaultProduct;
1037     }
1038 
1039     @Override
1040     public Product getProduct() {
1041         return (getDefaultProduct() != null) ? getDefaultProduct() : this.product;
1042     }
1043 
1044     @Override
1045     public void setProduct(Product product) {
1046         this.product = product;
1047     }
1048 
1049     @Override
1050     public Set&lt;SkuProductOptionValueXref&gt; getProductOptionValueXrefs() {
1051         return productOptionValueXrefs;
1052     }
1053 
1054     @Override
1055     public void setProductOptionValueXrefs(Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs) {
1056         this.productOptionValueXrefs = productOptionValueXrefs;
1057     }
1058 
1059     @Override
1060     public Set&lt;ProductOptionValue&gt; getProductOptionValuesCollection() {
1061         if (legacyProductOptionValues.size() == 0) {
1062             for (SkuProductOptionValueXref xref : productOptionValueXrefs) {
1063                 legacyProductOptionValues.add(xref.getProductOptionValue());
1064             }
1065         }
1066         return Collections.unmodifiableSet(legacyProductOptionValues);
1067     }
1068 
1069     @Override
1070     public void setProductOptionValuesCollection(Set&lt;ProductOptionValue&gt; productOptionValues) {
1071         this.legacyProductOptionValues.clear();
1072         this.productOptionValueXrefs.clear();
1073         for (ProductOptionValue val : productOptionValues) {
1074             this.productOptionValueXrefs.add(new SkuProductOptionValueXrefImpl(this, val));
1075         }
1076     }
1077 
1078     @Override
1079     @Deprecated
1080     public List&lt;ProductOptionValue&gt; getProductOptionValues() {
<abbr title="1081         //Changing this API to Set is ill-advised (especially in a patch release). The tendrils are widespread. Instead">1081         //Changing this API to Set is ill-advised (especially in a patch release). The tendrils are widesðŸ”µ</abbr>
1082         //we just migrate the call from the List to the internal Set representation. This is in response
1083         //to https://github.com/BroadleafCommerce/BroadleafCommerce/issues/917.
<abbr title="1084         return (List&lt;ProductOptionValue&gt;) Proxy.newProxyInstance(getClass().getClassLoader(), new Class&lt;?&gt;[]{List.class}, new InvocationHandler() {">1084         return (List&lt;ProductOptionValue&gt;) Proxy.newProxyInstance(getClass().getClassLoader(), new Class&lt;?ðŸ”µ</abbr>
1085             @Override
1086             public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
<abbr title="1087                 return MethodUtils.invokeMethod(getProductOptionValuesCollection(), method.getName(), args, method.getParameterTypes());">1087                 return MethodUtils.invokeMethod(getProductOptionValuesCollection(), method.getName(), argðŸ”µ</abbr>
1088             }
1089         });
1090     }
1091 
1092     @Override
1093     @Deprecated
1094     public void setProductOptionValues(List&lt;ProductOptionValue&gt; productOptionValues) {
1095         setProductOptionValuesCollection(new HashSet&lt;ProductOptionValue&gt;(productOptionValues));
1096     }
1097 
1098     @Override
1099     @Deprecated
1100     public Boolean isMachineSortable() {
1101         if (isMachineSortable == null &amp;&amp; hasDefaultSku()) {
1102             return lookupDefaultSku().isMachineSortable();
1103         }
1104         return isMachineSortable == null ? false : isMachineSortable;
1105     }
1106 
1107     @Override
1108     public Boolean getIsMachineSortable() {
1109         if (isMachineSortable == null &amp;&amp; hasDefaultSku()) {
1110             return lookupDefaultSku().getIsMachineSortable();
1111         }
1112         return isMachineSortable == null ? false : isMachineSortable;
1113     }
1114 
1115     @Override
1116     @Deprecated
1117     public void setMachineSortable(Boolean isMachineSortable) {
1118         this.isMachineSortable = isMachineSortable;
1119     }
1120 
1121     @Override
1122     public void setIsMachineSortable(Boolean isMachineSortable) {
1123         this.isMachineSortable = isMachineSortable;
1124     }
1125 
1126     @Override
1127     public List&lt;SkuFee&gt; getFees() {
1128         return fees;
1129     }
1130 
1131     @Override
1132     public void setFees(List&lt;SkuFee&gt; fees) {
1133         this.fees = fees;
1134     }
1135 
1136     @Override
1137     public Map&lt;FulfillmentOption, BigDecimal&gt; getFulfillmentFlatRates() {
1138         return fulfillmentFlatRates;
1139     }
1140 
1141     @Override
1142     public void setFulfillmentFlatRates(Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates) {
1143         this.fulfillmentFlatRates = fulfillmentFlatRates;
1144     }
1145 
1146     @Override
1147     public List&lt;FulfillmentOption&gt; getExcludedFulfillmentOptions() {
1148         return excludedFulfillmentOptions;
1149     }
1150 
1151     @Override
1152     public void setExcludedFulfillmentOptions(List&lt;FulfillmentOption&gt; excludedFulfillmentOptions) {
1153         this.excludedFulfillmentOptions = excludedFulfillmentOptions;
1154     }
1155 
1156     @Override
1157     public InventoryType getInventoryType() {
1158         if (StringUtils.isEmpty(this.inventoryType)) {
1159             if (hasDefaultSku() &amp;&amp; lookupDefaultSku().getInventoryType() != null) {
1160                 return lookupDefaultSku().getInventoryType();
1161             } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1162                 return getProduct().getDefaultCategory().getInventoryType();
1163             }
1164             return null;
1165         }
1166         return InventoryType.getInstance(this.inventoryType);
1167     }
1168 
1169     @Override
1170     public void setInventoryType(InventoryType inventoryType) {
1171         this.inventoryType = (inventoryType == null) ? null : inventoryType.getType();
1172     }
1173 
1174     @Override
1175     public Integer getQuantityAvailable() {
1176         return quantityAvailable;
1177     }
1178 
1179     @Override
1180     public void setQuantityAvailable(Integer quantityAvailable) {
1181         this.quantityAvailable = quantityAvailable;
1182     }
1183 
1184     @Override
1185     public FulfillmentType getFulfillmentType() {
1186         if (StringUtils.isEmpty(this.fulfillmentType)) {
1187             if (hasDefaultSku() &amp;&amp; lookupDefaultSku().getFulfillmentType() != null) {
1188                 return lookupDefaultSku().getFulfillmentType();
1189             } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1190                 return getProduct().getDefaultCategory().getFulfillmentType();
1191             }
1192             return null;
1193         }
1194         return FulfillmentType.getInstance(this.fulfillmentType);
1195     }
1196 
1197     @Override
1198     public void setFulfillmentType(FulfillmentType fulfillmentType) {
1199         if (fulfillmentType != null) {
1200             this.fulfillmentType = fulfillmentType.getType();
1201         }
1202     }
1203 
1204     @Override
1205     @Deprecated
1206     public Map&lt;String, SkuAttribute&gt; getSkuAttributes() {
1207         Map&lt;String, SkuAttribute&gt; attributeMap = new HashMap&lt;String, SkuAttribute&gt;();
1208 
1209         for (SkuAttribute skuAttribute : skuAttributes) {
1210             attributeMap.put(skuAttribute.getName(), skuAttribute);
1211         }
1212 
1213         return attributeMap;
1214     }
1215 
1216     @Override
1217     @SuppressWarnings(&quot;unchecked&quot;)
1218     public Map&lt;String, Collection&lt;SkuAttribute&gt;&gt; getMultiValueSkuAttributes() {
1219         MultiValueMap multiValueMap = new MultiValueMap();
1220 
1221         for (SkuAttribute skuAttribute : skuAttributes) {
1222             multiValueMap.put(skuAttribute.getName(), skuAttribute);
1223         }
1224 
1225         return multiValueMap;
1226     }
1227 
1228     @Override
1229     public void setSkuAttributes(Map&lt;String, SkuAttribute&gt; skuAttributes) {
1230         List&lt;SkuAttribute&gt; skuAttributeList = new ArrayList&lt;SkuAttribute&gt;();
1231 
1232         for(Map.Entry&lt;String, SkuAttribute&gt; entry : skuAttributes.entrySet()){
1233             skuAttributeList.add(entry.getValue());
1234         }
1235 
1236         this.skuAttributes = skuAttributeList;
1237     }
1238 
1239     @Override
1240     public BroadleafCurrency getCurrency() {
1241         if (currency == null &amp;&amp; hasDefaultSku()) {
1242             return lookupDefaultSku().getCurrency();
1243         } else {
1244             return currency;
1245         }
1246     }
1247 
1248     @Override
1249     public void setCurrency(BroadleafCurrency currency) {
1250         this.currency = currency;
1251     }
1252 
1253     @Override
1254     public void clearDynamicPrices() {
1255         SkuPricingConsiderationContext.removeFromThreadCache(getId());
1256     }
1257 
1258     @Override
1259     public boolean equals(Object obj) {
1260         if (this == obj) {
1261             return true;
1262         }
1263         if (obj == null) {
1264             return false;
1265         }
1266         if (!getClass().isAssignableFrom(obj.getClass())) {
1267             return false;
1268         }
1269         SkuImpl other = (SkuImpl) obj;
1270 
1271         if (id != null &amp;&amp; other.id != null) {
1272             return id.equals(other.id);
1273         }
1274 
1275         if (getName() == null) {
1276             if (other.getName() != null) {
1277                 return false;
1278             }
1279         } else if (!getName().equals(other.getName())) {
1280             return false;
1281         }
1282         return true;
1283     }
1284 
1285     @Override
1286     public int hashCode() {
1287         final int prime = 31;
1288         int result = 1;
1289         result = prime * result + ((name == null) ? 0 : name.hashCode());
1290         return result;
1291     }
1292 
1293     @Override
1294     public String getTaxCode() {
1295         if (StringUtils.isEmpty(this.taxCode)) {
1296             if (hasDefaultSku() &amp;&amp; !StringUtils.isEmpty(lookupDefaultSku().getTaxCode())) {
1297                 return lookupDefaultSku().getTaxCode();
1298             } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1299                 return getProduct().getDefaultCategory().getTaxCode();
1300             }
1301         }
1302         return this.taxCode;
1303     }
1304 
1305     @Override
1306     public void setTaxCode(String taxCode) {
1307         this.taxCode = taxCode;
1308     }
1309 
1310     @Override
1311     public String getExternalId() {
1312         return externalId;
1313     }
1314 
1315     @Override
1316     public void setExternalId(String externalId) {
1317         this.externalId = externalId;
1318     }
1319 
1320     @Override
1321     public String getUpc() {
1322         return upc;
1323     }
1324 
1325     @Override
1326     public void setUpc(String upc) {
1327         this.upc = upc;
1328     }
1329 
1330     @Override
1331     public FieldEntity getFieldEntityType() {
1332         return FieldEntity.SKU;
1333     }
1334 
1335     @Override
<abbr title="1336     public &lt;G extends Sku&gt; CreateResponse&lt;G&gt; createOrRetrieveCopyInstance(MultiTenantCopyContext context) throws CloneNotSupportedException {">1336     public &lt;G extends Sku&gt; CreateResponse&lt;G&gt; createOrRetrieveCopyInstance(MultiTenantCopyContext context)ðŸ”µ</abbr>
1337         CreateResponse&lt;G&gt; createResponse = context.createOrRetrieveCopyInstance(this);
1338         if (createResponse.isAlreadyPopulated()) {
1339             return createResponse;
1340         }
1341         Sku cloned = createResponse.getClone();
1342         cloned.setRetailPrice(getRetailPrice());
1343         cloned.setSalePrice(getSalePrice());
1344         cloned.setName(name);
1345         cloned.setActiveEndDate(activeEndDate);
1346         cloned.setActiveStartDate(activeStartDate);
1347         cloned.setCurrency(currency);
1348         cloned.setQuantityAvailable(quantityAvailable);
1349         cloned.setDescription(description);
1350         cloned.setDimension(dimension);
1351         cloned.setDiscountable(isDiscountable());
1352         cloned.setDisplayTemplate(displayTemplate);
1353         cloned.setExternalId(externalId);
1354         cloned.setTaxable(isTaxable());
1355         cloned.setTaxCode(taxCode);
1356         cloned.setUrlKey(urlKey);
1357         cloned.setInventoryType(getInventoryType());
1358         cloned.setFulfillmentType(getFulfillmentType());
1359         cloned.setIsMachineSortable(isMachineSortable);
1360         cloned.setLongDescription(longDescription);
1361         cloned.setUpc(upc);
1362         if (product != null) {
1363             cloned.setDefaultProduct(product.createOrRetrieveCopyInstance(context).getClone());
1364         }
1365         if (product != null) {
1366             cloned.setProduct(product.createOrRetrieveCopyInstance(context).getClone());
1367         }
1368         for(Map.Entry&lt;String, SkuAttribute&gt; entry : getSkuAttributes().entrySet()){
1369             SkuAttribute clonedEntry = entry.getValue().createOrRetrieveCopyInstance(context).getClone();
1370             cloned.getSkuAttributes().put(entry.getKey(),clonedEntry);
1371         }
1372         for(SkuProductOptionValueXref entry : productOptionValueXrefs){
<abbr title="1373             SkuProductOptionValueXref clonedEntry = entry.createOrRetrieveCopyInstance(context).getClone();">1373             SkuProductOptionValueXref clonedEntry = entry.createOrRetrieveCopyInstance(context).getClone(ðŸ”µ</abbr>
1374             cloned.getProductOptionValueXrefs().add(clonedEntry);
1375         }
1376         for(Map.Entry&lt;String, SkuMediaXref&gt; entry : skuMedia.entrySet()){
<abbr title="1377             SkuMediaXrefImpl clonedEntry = ((SkuMediaXrefImpl)entry.getValue()).createOrRetrieveCopyInstance(context).getClone();">1377             SkuMediaXrefImpl clonedEntry = ((SkuMediaXrefImpl)entry.getValue()).createOrRetrieveCopyInstaðŸ”µ</abbr>
1378             cloned.getSkuMediaXrefIgnoreDefaultSku().put(entry.getKey(),clonedEntry);
1379         }
1380         for(FulfillmentOption entry : excludedFulfillmentOptions){
1381             FulfillmentOption clonedEntry = entry.createOrRetrieveCopyInstance(context).getClone();
1382             cloned.getExcludedFulfillmentOptions().add(clonedEntry);
1383         }
1384         for(Map.Entry&lt;FulfillmentOption, BigDecimal&gt; entry : fulfillmentFlatRates.entrySet()){
<abbr title="1385             FulfillmentOption clonedEntry = entry.getKey().createOrRetrieveCopyInstance(context).getClone();">1385             FulfillmentOption clonedEntry = entry.getKey().createOrRetrieveCopyInstance(context).getCloneðŸ”µ</abbr>
1386             cloned.getFulfillmentFlatRates().put(clonedEntry,entry.getValue());
1387         }
1388 
1389         return  createResponse;
1390     }
1391 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.catalog.domain;
  19 
  20 import java.lang.reflect.InvocationHandler;
  21 import java.lang.reflect.Method;
  22 import java.lang.reflect.Proxy;
  23 import java.math.BigDecimal;
  24 import java.util.ArrayList;
  25 import java.util.Collection;
  26 import java.util.Collections;
  27 import java.util.Comparator;
  28 import java.util.Date;
  29 import java.util.HashMap;
  30 import java.util.HashSet;
  31 import java.util.LinkedHashMap;
  32 import java.util.List;
  33 import java.util.Map;
  34 import java.util.Set;
  35 import java.util.function.Function;
  36 import java.util.stream.Collectors;
  37 import javax.persistence.CascadeType;
  38 import javax.persistence.CollectionTable;
  39 import javax.persistence.Column;
  40 import javax.persistence.ElementCollection;
  41 import javax.persistence.Embedded;
  42 import javax.persistence.Entity;
  43 import javax.persistence.FetchType;
  44 import javax.persistence.GeneratedValue;
  45 import javax.persistence.Id;
  46 import javax.persistence.Inheritance;
  47 import javax.persistence.InheritanceType;
  48 import javax.persistence.JoinColumn;
  49 import javax.persistence.JoinTable;
  50 import javax.persistence.Lob;
  51 import javax.persistence.ManyToMany;
  52 import javax.persistence.ManyToOne;
  53 import javax.persistence.MapKey;
  54 import javax.persistence.MapKeyClass;
  55 import javax.persistence.MapKeyJoinColumn;
  56 import javax.persistence.OneToMany;
  57 import javax.persistence.OneToOne;
  58 import javax.persistence.Table;
  59 import javax.persistence.Transient;
  60 import org.apache.commons.beanutils.MethodUtils;
  61 import org.apache.commons.collections.MapUtils;
  62 import org.apache.commons.collections.map.MultiValueMap;
  63 import org.apache.commons.lang.StringUtils;
  64 import org.apache.commons.logging.Log;
  65 import org.apache.commons.logging.LogFactory;
  66 import org.broadleafcommerce.common.copy.CreateResponse;
  67 import org.broadleafcommerce.common.copy.MultiTenantCopyContext;
  68 import org.broadleafcommerce.common.currency.domain.BroadleafCurrency;
  69 import org.broadleafcommerce.common.currency.domain.BroadleafCurrencyImpl;
  70 import org.broadleafcommerce.common.extensibility.jpa.clone.ClonePolicyArchive;
  71 import org.broadleafcommerce.common.extensibility.jpa.clone.ClonePolicyCollectionOverride;
  72 import org.broadleafcommerce.common.extensibility.jpa.clone.IgnoreEnterpriseBehavior;
  73 import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransform;
  74 import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransformMember;
  75 import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransformTypes;
  76 import org.broadleafcommerce.common.i18n.service.DynamicTranslationProvider;
  77 import org.broadleafcommerce.common.media.domain.Media;
  78 import org.broadleafcommerce.common.money.Money;
  79 import org.broadleafcommerce.common.presentation.AdminPresentation;
  80 import org.broadleafcommerce.common.presentation.AdminPresentationCollection;
  81 import org.broadleafcommerce.common.presentation.AdminPresentationDataDrivenEnumeration;
  82 import org.broadleafcommerce.common.presentation.AdminPresentationMap;
  83 import org.broadleafcommerce.common.presentation.AdminPresentationMapField;
  84 import org.broadleafcommerce.common.presentation.AdminPresentationMapFields;
  85 import org.broadleafcommerce.common.presentation.AdminPresentationToOneLookup;
  86 import org.broadleafcommerce.common.presentation.ConfigurationItem;
  87 import org.broadleafcommerce.common.presentation.OptionFilterParam;
  88 import org.broadleafcommerce.common.presentation.OptionFilterParamType;
  89 import org.broadleafcommerce.common.presentation.ValidationConfiguration;
  90 import org.broadleafcommerce.common.presentation.client.LookupType;
  91 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  92 import org.broadleafcommerce.common.presentation.client.VisibilityEnum;
  93 import org.broadleafcommerce.common.util.DateUtil;
  94 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  95 import org.broadleafcommerce.core.catalog.service.dynamic.DynamicSkuPrices;
  96 import org.broadleafcommerce.core.catalog.service.dynamic.SkuActiveDateConsiderationContext;
  97 import org.broadleafcommerce.core.catalog.service.dynamic.SkuPricingConsiderationContext;
  98 import org.broadleafcommerce.core.inventory.service.type.InventoryType;
  99 import org.broadleafcommerce.core.order.domain.FulfillmentOption;
 100 import org.broadleafcommerce.core.order.domain.FulfillmentOptionImpl;
 101 import org.broadleafcommerce.core.order.service.type.FulfillmentType;
 102 import org.broadleafcommerce.core.search.domain.FieldEntity;
 103 import org.hibernate.annotations.BatchSize;
 104 import org.hibernate.annotations.Cache;
 105 import org.hibernate.annotations.CacheConcurrencyStrategy;
 106 import org.hibernate.annotations.Cascade;
 107 import org.hibernate.annotations.GenericGenerator;
 108 import org.hibernate.annotations.Index;
 109 import org.hibernate.annotations.Parameter;
 110 import org.hibernate.annotations.Type;
 111 
 112 
 113 /**
 114  * The Class SkuImpl is the default implementation of {@link Sku}. A SKU is a
 115  * specific item that can be sold including any specific attributes of the item
 116  * such as color or size. &lt;br&gt;
 117  * &lt;br&gt;
 118  * If you want to add fields specific to your implementation of
 119  * BroadLeafCommerce you should extend this class and add your fields. If you
 120  * need to make significant changes to the SkuImpl then you should implement
 121  * your own version of {@link Sku}.&lt;br&gt;
 122  * &lt;br&gt;
 123  * This implementation uses a Hibernate implementation of JPA configured through
 124  * annotations. The Entity references the following tables: BLC_SKU,
 125  * BLC_SKU_IMAGE
 126  *
 127  * !!!!!!!!!!!!!!!!!
<abbr title=" 128  * &lt;p&gt;For admin required field validation, if this Sku is apart of an additionalSkus list (meaning it is not a defaultSku) then"> 128  * &lt;p&gt;For admin required field validation, if this Sku is apart of an additionalSkus list (meaning it is ðŸ”µ</abbr>
<abbr title=" 129  * it should have no required restrictions on it. All additional Skus can delegate to the defaultSku of the related product"> 129  * it should have no required restrictions on it. All additional Skus can delegate to the defaultSku of tðŸ”µ</abbr>
<abbr title=" 130  * for all of its fields. For this reason, if you would like to mark more fields as required then rather than using"> 130  * for all of its fields. For this reason, if you would like to mark more fields as required then rather ðŸ”µ</abbr>
<abbr title=" 131  * {@link AdminPresentation#requiredOverride()}, use the mo:overrides section in bl-admin-applicationContext.xml for Product"> 131  * {@link AdminPresentation#requiredOverride()}, use the mo:overrides section in bl-admin-applicationContðŸ”µ</abbr>
 132  * and reference each required field like &#x27;defaultSku.name&#x27; or &#x27;defaultSku.retailPrice&#x27;.&lt;/p&gt;
 133  *
 134  * @author btaylor
 135  * @see {@link Sku}
 136  */
<abbr title=" 137 //multi-column indexes don&#x27;t appear to get exported correctly when declared at the field level, so declaring here as a workaround"> 137 //multi-column indexes don&#x27;t appear to get exported correctly when declared at the field level, so declarðŸ”µ</abbr>
 138 @Entity
 139 @Inheritance(strategy = InheritanceType.JOINED)
 140 @Table(name = &quot;BLC_SKU&quot;)
<abbr title=" 141 @Table(appliesTo = &quot;BLC_SKU&quot;, indexes = { @Index(name = &quot;SKU_URL_KEY_INDEX&quot;, columnNames = { &quot;URL_KEY&quot; }) })"> 141 @Table(appliesTo = &quot;BLC_SKU&quot;, indexes = { @Index(name = &quot;SKU_URL_KEY_INDEX&quot;, columnNames = { &quot;URL_KEY&quot; })ðŸ”µ</abbr>
 142 @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
<abbr title=" 143 @DirectCopyTransform({ @DirectCopyTransformMember(templateTokens = DirectCopyTransformTypes.SANDBOX, skipOverlaps = true), @DirectCopyTransformMember(templateTokens = DirectCopyTransformTypes.MULTITENANT_CATALOG) })"> 143 @DirectCopyTransform({ @DirectCopyTransformMember(templateTokens = DirectCopyTransformTypes.SANDBOX, skipðŸ”µ</abbr>
 144 public class SkuImpl implements Sku , SkuAdminPresentation {
 145     private static final Log LOG = LogFactory.getLog(SkuImpl.class);
 146 
 147     private static final long serialVersionUID = 1L;
 148 
 149     @Id
 150     @GeneratedValue(generator = &quot;SkuId&quot;)
<abbr title=" 151     @GenericGenerator(name = &quot;SkuId&quot;, strategy = &quot;org.broadleafcommerce.common.persistence.IdOverrideTableGenerator&quot;, parameters = { @Parameter(name = &quot;segment_value&quot;, value = &quot;SkuImpl&quot;), @Parameter(name = &quot;entity_name&quot;, value = &quot;org.broadleafcommerce.core.catalog.domain.SkuImpl&quot;) })"> 151     @GenericGenerator(name = &quot;SkuId&quot;, strategy = &quot;org.broadleafcommerce.common.persistence.IdOverrideTablðŸ”µ</abbr>
 152     @Column(name = &quot;SKU_ID&quot;)
 153     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_ID&quot;, visibility = VisibilityEnum.HIDDEN_ALL)
 154     protected Long id;
 155 
 156     @Column(name = &quot;EXTERNAL_ID&quot;)
 157     @Index(name = &quot;SKU_EXTERNAL_ID_INDEX&quot;, columnNames = { &quot;EXTERNAL_ID&quot; })
<abbr title=" 158     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_ExternalID&quot;, group = GroupName.Miscellaneous, order = FieldOrder.EXTERNAL_ID, tooltip = &quot;SkuImpl_Sku_ExternalID_Tooltip&quot;)"> 158     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_ExternalID&quot;, group = GroupName.Miscellaneous, order = ðŸ”µ</abbr>
 159     protected String externalId;
 160 
 161     @Column(name = &quot;URL_KEY&quot;)
<abbr title=" 162     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_UrlKey&quot;, group = GroupName.Advanced, order = 4000, excluded = true)"> 162     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_UrlKey&quot;, group = GroupName.Advanced, order = 4000, excðŸ”µ</abbr>
 163     protected String urlKey;
 164 
 165     @Column(name = &quot;DISPLAY_TEMPLATE&quot;)
<abbr title=" 166     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Display_Template&quot;, group = GroupName.Advanced, order = 5000, excluded = true)"> 166     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Display_Template&quot;, group = GroupName.Advanced, order =ðŸ”µ</abbr>
 167     protected String displayTemplate;
 168 
 169     @Column(name = &quot;UPC&quot;)
 170     @Index(name = &quot;SKU_UPC_INDEX&quot;, columnNames = { &quot;UPC&quot; })
<abbr title=" 171     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_UPC&quot;, group = GroupName.Miscellaneous, order = FieldOrder.UPC)"> 171     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_UPC&quot;, group = GroupName.Miscellaneous, order = FieldOrðŸ”µ</abbr>
 172     protected String upc;
 173 
 174     @Column(name = &quot;SALE_PRICE&quot;, precision = 19, scale = 5)
<abbr title=" 175     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Sale_Price&quot;, group = GroupName.Price, order = FieldOrder.SALE_PRICE, tooltip = &quot;SkuImpl_Sku_Sale_Price_tooltip&quot;, prominent = true, gridOrder = 6, fieldType = SupportedFieldType.MONEY)"> 175     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Sale_Price&quot;, group = GroupName.Price, order = FieldOrdðŸ”µ</abbr>
 176     protected BigDecimal salePrice;
 177 
 178     @Column(name = &quot;RETAIL_PRICE&quot;, precision = 19, scale = 5)
<abbr title=" 179     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Retail_Price&quot;, group = GroupName.Price, order = FieldOrder.RETAIL_PRICE, prominent = true, gridOrder = 5, fieldType = SupportedFieldType.MONEY)"> 179     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Retail_Price&quot;, group = GroupName.Price, order = FieldOðŸ”µ</abbr>
 180     protected BigDecimal retailPrice;
 181 
 182     @Column(name = &quot;COST&quot;, precision = 19, scale = 5)
<abbr title=" 183     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Cost&quot;, group = GroupName.Price, order = FieldOrder.COST, fieldType = SupportedFieldType.MONEY)"> 183     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Cost&quot;, group = GroupName.Price, order = FieldOrder.COSðŸ”µ</abbr>
 184     protected BigDecimal cost;
 185 
 186     @Column(name = &quot;NAME&quot;)
 187     @Index(name = &quot;SKU_NAME_INDEX&quot;, columnNames = { &quot;NAME&quot; })
<abbr title=" 188     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Name&quot;, group = GroupName.General, order = FieldOrder.NAME, prominent = true, gridOrder = 1, columnWidth = &quot;260px&quot;, translatable = true)"> 188     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Name&quot;, group = GroupName.General, order = FieldOrder.NðŸ”µ</abbr>
 189     protected String name;
 190 
 191     @Column(name = &quot;DESCRIPTION&quot;)
<abbr title=" 192     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Description&quot;, group = GroupName.General, order = FieldOrder.SHORT_DESCRIPTION, largeEntry = true, excluded = true, translatable = true)"> 192     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Description&quot;, group = GroupName.General, order = FieldðŸ”µ</abbr>
 193     protected String description;
 194 
 195     @Lob
 196     @Type(type = &quot;org.hibernate.type.MaterializedClobType&quot;)
 197     @Column(name = &quot;LONG_DESCRIPTION&quot;, length = Integer.MAX_VALUE - 1)
<abbr title=" 198     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Large_Description&quot;, group = GroupName.General, order = FieldOrder.LONG_DESCRIPTION, largeEntry = true, fieldType = SupportedFieldType.HTML_BASIC, translatable = true)"> 198     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Large_Description&quot;, group = GroupName.General, order =ðŸ”µ</abbr>
 199     protected String longDescription;
 200 
 201     @Column(name = &quot;TAX_CODE&quot;)
 202     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_TaxCode&quot;, order = 1001, group = GroupName.Financial)
<abbr title=" 203     @AdminPresentationDataDrivenEnumeration(optionCanEditValues = true, optionHideIfEmpty = true, optionFilterParams = { @OptionFilterParam(param = &quot;type.key&quot;, value = &quot;TAX_CODE&quot;, paramType = OptionFilterParamType.STRING) })"> 203     @AdminPresentationDataDrivenEnumeration(optionCanEditValues = true, optionHideIfEmpty = true, optionFðŸ”µ</abbr>
 204     protected String taxCode;
 205 
 206     @Column(name = &quot;TAXABLE_FLAG&quot;)
 207     @Index(name = &quot;SKU_TAXABLE_INDEX&quot;, columnNames = { &quot;TAXABLE_FLAG&quot; })
<abbr title=" 208     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Taxable&quot;, group = GroupName.Financial, order = FieldOrder.TAXABLE)"> 208     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Taxable&quot;, group = GroupName.Financial, order = FieldOrðŸ”µ</abbr>
 209     protected Character taxable;
 210 
 211     @Column(name = &quot;DISCOUNTABLE_FLAG&quot;)
 212     @Index(name = &quot;SKU_DISCOUNTABLE_INDEX&quot;, columnNames = { &quot;DISCOUNTABLE_FLAG&quot; })
<abbr title=" 213     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Discountable&quot;, group = GroupName.Discountable, helpText = &quot;SkuImpl_Sku_Discountable_helptext&quot;, defaultValue = &quot;Y&quot;)"> 213     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Discountable&quot;, group = GroupName.Discountable, helpTexðŸ”µ</abbr>
 214     protected Character discountable;
 215 
 216     @Column(name = &quot;AVAILABLE_FLAG&quot;)
 217     @Index(name = &quot;SKU_AVAILABLE_INDEX&quot;, columnNames = { &quot;AVAILABLE_FLAG&quot; })
 218     @AdminPresentation(excluded = true)
 219     @Deprecated
 220     protected Character available;
 221 
 222     @Column(name = &quot;ACTIVE_START_DATE&quot;)
 223     @Index(name = &quot;SKU_ACTIVE_START_INDEX&quot;)
<abbr title=" 224     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Start_Date&quot;, group = GroupName.ActiveDateRange, order = FieldOrder.ACTIVE_START_DATE, tooltip = &quot;skuStartDateTooltip&quot;, defaultValue = &quot;today&quot;)"> 224     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Start_Date&quot;, group = GroupName.ActiveDateRange, order ðŸ”µ</abbr>
 225     protected Date activeStartDate;
 226 
 227     @Column(name = &quot;ACTIVE_END_DATE&quot;)
 228     @Index(name = &quot;SKU_ACTIVE_END_INDEX&quot;)
<abbr title=" 229     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_End_Date&quot;, group = GroupName.ActiveDateRange, order = FieldOrder.ACTIVE_END_DATE, tooltip = &quot;skuEndDateTooltip&quot;, validationConfigurations = { @ValidationConfiguration(validationImplementation = &quot;blAfterStartDateValidator&quot;, configurationItems = { @ConfigurationItem(itemName = &quot;otherField&quot;, itemValue = &quot;activeStartDate&quot;) }) })"> 229     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_End_Date&quot;, group = GroupName.ActiveDateRange, order = ðŸ”µ</abbr>
 230     protected Date activeEndDate;
 231 
 232     @Embedded
 233     protected Dimension dimension = new Dimension();
 234 
 235     @Embedded
 236     protected Weight weight = new Weight();
 237 
 238     @Column(name = &quot;IS_MACHINE_SORTABLE&quot;)
<abbr title=" 239     @AdminPresentation(friendlyName = &quot;ProductImpl_Is_Product_Machine_Sortable&quot;, group = GroupName.ShippingOther, order = FieldOrder.IS_MACHINE_SORTABLE, defaultValue = &quot;false&quot;)"> 239     @AdminPresentation(friendlyName = &quot;ProductImpl_Is_Product_Machine_Sortable&quot;, group = GroupName.ShippiðŸ”µ</abbr>
 240     protected Boolean isMachineSortable;
 241 
 242     @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuMediaXrefImpl.class, cascade = { CascadeType.ALL })
 243     @MapKey(name = &quot;key&quot;)
 244     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 245     @BatchSize(size = 50)
<abbr title=" 246     @AdminPresentationMap(friendlyName = &quot;SkuImpl_Sku_Media&quot;, tab = TabName.Media, keyPropertyFriendlyName = &quot;SkuImpl_Sku_Media_Key&quot;, deleteEntityUponRemove = true, mediaField = &quot;media.url&quot;, toOneTargetProperty = &quot;media&quot;, toOneParentProperty = &quot;sku&quot;, forceFreeFormKeys = true)"> 246     @AdminPresentationMap(friendlyName = &quot;SkuImpl_Sku_Media&quot;, tab = TabName.Media, keyPropertyFriendlyNamðŸ”µ</abbr>
<abbr title=" 247     @AdminPresentationMapFields(mapDisplayFields = { @AdminPresentationMapField(fieldName = &quot;primary&quot;, fieldPresentation = @AdminPresentation(fieldType = SupportedFieldType.MEDIA, group = GroupName.Image, order = FieldOrder.PRIMARY_MEDIA, friendlyName = &quot;SkuImpl_Primary_Media&quot;)) })"> 247     @AdminPresentationMapFields(mapDisplayFields = { @AdminPresentationMapField(fieldName = &quot;primary&quot;, fiðŸ”µ</abbr>
 248     protected Map&lt;String, SkuMediaXref&gt; skuMedia = new HashMap&lt;String, SkuMediaXref&gt;();
 249 
 250     @Transient
 251     protected Map&lt;String, Media&gt; legacySkuMedia = new HashMap&lt;String, Media&gt;();
 252 
 253     /**
 254      * This will be non-null if and only if this Sku is the default Sku for a Product
 255      */
 256     @OneToOne(optional = true, targetEntity = ProductImpl.class, cascade = { CascadeType.ALL })
 257     @Cascade({ CascadeType.ALL })
 258     @JoinColumn(name = &quot;DEFAULT_PRODUCT_ID&quot;)
 259     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 260     @IgnoreEnterpriseBehavior
 261     protected Product defaultProduct;
 262 
 263     /**
 264      * This relationship will be non-null if and only if this Sku is contained in the list of
 265      * additional Skus for a Product (for Skus based on ProductOptions)
 266      */
<abbr title=" 267     @ManyToOne(optional = true, targetEntity = ProductImpl.class, cascade = { CascadeType.PERSIST, CascadeType.MERGE, CascadeType.REFRESH })"> 267     @ManyToOne(optional = true, targetEntity = ProductImpl.class, cascade = { CascadeType.PERSIST, CascadðŸ”µ</abbr>
 268     @JoinColumn(name = &quot;ADDL_PRODUCT_ID&quot;)
 269     protected Product product;
 270 
 271     @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL })
 272     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 273     @BatchSize(size = 50)
<abbr title=" 274     @AdminPresentationCollection(friendlyName = &quot;skuAttributesTitle&quot;, tab = TabName.Advanced, order = 1000)"> 274     @AdminPresentationCollection(friendlyName = &quot;skuAttributesTitle&quot;, tab = TabName.Advanced, order = 100ðŸ”µ</abbr>
 275     protected List&lt;SkuAttribute&gt; skuAttributes = new ArrayList&lt;SkuAttribute&gt;();
 276 
 277     //Use a Set instead of a List - see https://github.com/BroadleafCommerce/BroadleafCommerce/issues/917
<abbr title=" 278     @OneToMany(targetEntity = SkuProductOptionValueXrefImpl.class, cascade = CascadeType.ALL, mappedBy = &quot;sku&quot;)"> 278     @OneToMany(targetEntity = SkuProductOptionValueXrefImpl.class, cascade = CascadeType.ALL, mappedBy = ðŸ”µ</abbr>
 279     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 280     @BatchSize(size = 50)
 281     @ClonePolicyCollectionOverride
 282     @ClonePolicyArchive
<abbr title=" 283     protected Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs = new HashSet&lt;SkuProductOptionValueXref&gt;();"> 283     protected Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs = new HashSet&lt;SkuProductOptionValueXðŸ”µ</abbr>
 284 
 285     @Transient
 286     protected Set&lt;ProductOptionValue&gt; legacyProductOptionValues = new HashSet&lt;ProductOptionValue&gt;();
 287 
 288     @ManyToMany(fetch = FetchType.LAZY, targetEntity = SkuFeeImpl.class)
<abbr title=" 289     @JoinTable(name = &quot;BLC_SKU_FEE_XREF&quot;, joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;, nullable = true), inverseJoinColumns = @JoinColumn(name = &quot;SKU_FEE_ID&quot;, referencedColumnName = &quot;SKU_FEE_ID&quot;, nullable = true))"> 289     @JoinTable(name = &quot;BLC_SKU_FEE_XREF&quot;, joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnNameðŸ”µ</abbr>
 290     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 291     @BatchSize(size = 50)
 292     protected List&lt;SkuFee&gt; fees = new ArrayList&lt;SkuFee&gt;();
 293 
 294     @ElementCollection
<abbr title=" 295     @CollectionTable(name = &quot;BLC_SKU_FULFILLMENT_FLAT_RATES&quot;, joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;, nullable = true))"> 295     @CollectionTable(name = &quot;BLC_SKU_FULFILLMENT_FLAT_RATES&quot;, joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, ðŸ”µ</abbr>
 296     @MapKeyJoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;, referencedColumnName = &quot;FULFILLMENT_OPTION_ID&quot;)
 297     @MapKeyClass(FulfillmentOptionImpl.class)
 298     @Column(name = &quot;RATE&quot;, precision = 19, scale = 5)
 299     @Cascade(CascadeType.ALL)
 300     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 301     @BatchSize(size = 50)
<abbr title=" 302     protected Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates = new HashMap&lt;FulfillmentOption, BigDecimal&gt;();"> 302     protected Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates = new HashMap&lt;FulfillmentOption, BiðŸ”µ</abbr>
 303 
 304     @ManyToMany(targetEntity = FulfillmentOptionImpl.class)
<abbr title=" 305     @JoinTable(name = &quot;BLC_SKU_FULFILLMENT_EXCLUDED&quot;, joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;), inverseJoinColumns = @JoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;, referencedColumnName = &quot;FULFILLMENT_OPTION_ID&quot;))"> 305     @JoinTable(name = &quot;BLC_SKU_FULFILLMENT_EXCLUDED&quot;, joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencðŸ”µ</abbr>
 306     @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 307     @BatchSize(size = 50)
 308     protected List&lt;FulfillmentOption&gt; excludedFulfillmentOptions = new ArrayList&lt;FulfillmentOption&gt;();
 309 
 310     @Column(name = &quot;INVENTORY_TYPE&quot;)
<abbr title=" 311     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_InventoryType&quot;, group = GroupName.Inventory, order = 1000, helpText = &quot;skuInventoryTypeHelpText&quot;, fieldType = SupportedFieldType.BROADLEAF_ENUMERATION, broadleafEnumeration = &quot;org.broadleafcommerce.core.inventory.service.type.InventoryType&quot;, columnWidth = &quot;180px&quot;, prominent = true)"> 311     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_InventoryType&quot;, group = GroupName.Inventory, order = 1ðŸ”µ</abbr>
 312     protected String inventoryType;
 313 
 314     @Column(name = &quot;QUANTITY_AVAILABLE&quot;)
<abbr title=" 315     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_QuantityAvailable&quot;, group = GroupName.Inventory, order = 1010)"> 315     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_QuantityAvailable&quot;, group = GroupName.Inventory, orderðŸ”µ</abbr>
 316     protected Integer quantityAvailable = 0;
 317 
 318     @Column(name = &quot;FULFILLMENT_TYPE&quot;)
<abbr title=" 319     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_FulfillmentType&quot;, group = GroupName.ShippingFulfillment, order = FieldOrder.FULFILLMENT_TYPE, fieldType = SupportedFieldType.BROADLEAF_ENUMERATION, broadleafEnumeration = &quot;org.broadleafcommerce.core.order.service.type.FulfillmentType&quot;)"> 319     @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_FulfillmentType&quot;, group = GroupName.ShippingFulfillmenðŸ”µ</abbr>
 320     protected String fulfillmentType;
 321 
 322     /**
<abbr title=" 323      * Note that this field is not the target of the currencyCodeField attribute on either retailPrice or salePrice."> 323      * Note that this field is not the target of the currencyCodeField attribute on either retailPrice orðŸ”µ</abbr>
<abbr title=" 324      * This is because SKUs are special in that we want to return the currency on this SKU if there is one, falling back"> 324      * This is because SKUs are special in that we want to return the currency on this SKU if there is onðŸ”µ</abbr>
 325      * to the defaultSku&#x27;s currency if possible.
 326      *
 327      * Normally null and hidden.  Use Meta-Data overrides to display in the admin.
 328      * @see Sku#getCurrency() for further cautions about using this field.
 329      */
 330     @ManyToOne(fetch = FetchType.LAZY, targetEntity = BroadleafCurrencyImpl.class)
 331     @JoinColumn(name = &quot;CURRENCY_CODE&quot;)
<abbr title=" 332     @AdminPresentation(friendlyName = &quot;SkuImpl_Currency&quot;, group = GroupName.Advanced, order = 3000, visibility = VisibilityEnum.HIDDEN_ALL)"> 332     @AdminPresentation(friendlyName = &quot;SkuImpl_Currency&quot;, group = GroupName.Advanced, order = 3000, visibðŸ”µ</abbr>
<abbr title=" 333     @AdminPresentationToOneLookup(lookupType = LookupType.DROPDOWN, lookupDisplayProperty = &quot;friendlyName&quot;)"> 333     @AdminPresentationToOneLookup(lookupType = LookupType.DROPDOWN, lookupDisplayProperty = &quot;friendlyNameðŸ”µ</abbr>
 334     protected BroadleafCurrency currency;
 335 
 336     @Override
 337     public Long getId() {
 338         return id;
 339     }
 340 
 341     @Override
 342     public void setId(Long id) {
 343         this.id = id;
 344     }
 345 
 346     @Override
 347     public String getUrlKey() {
 348         return urlKey;
 349     }
 350 
 351     @Override
 352     public void setUrlKey(String urlKey) {
 353         this.urlKey = urlKey;
 354     }
 355 
 356     @Override
 357     public String getDisplayTemplate() {
 358         return displayTemplate;
 359     }
 360 
 361     @Override
 362     public void setDisplayTemplate(String displayTemplate) {
 363         this.displayTemplate = displayTemplate;
 364     }
 365 
 366     @Override
 367     public boolean isOnSale() {
 368         Money retailPrice = getRetailPrice();
 369         Money salePrice = getSalePrice();
 370         return (salePrice != null &amp;&amp; !salePrice.isZero() &amp;&amp; salePrice.lessThan(retailPrice));
 371     }
 372 
 373     protected boolean hasDefaultSku() {
<abbr title=" 374         return (product != null &amp;&amp; product.getDefaultSku() != null &amp;&amp; getId() != null &amp;&amp; !getId().equals(product.getDefaultSku().getId()));"> 374         return (product != null &amp;&amp; product.getDefaultSku() != null &amp;&amp; getId() != null &amp;&amp; !getId().equals(ðŸ”µ</abbr>
 375     }
 376 
 377     protected Sku lookupDefaultSku() {
 378         if (product != null &amp;&amp; product.getDefaultSku() != null) {
 379             return product.getDefaultSku();
 380         } else {
 381             return null;
 382         }
 383     }
 384 
 385     @Override
 386     public Money getProductOptionValueAdjustments() {
 387         Money optionValuePriceAdjustments = null;
 388         if (getProductOptionValues() != null) {
 389             for (ProductOptionValue value : getProductOptionValues()) {
 390                 if (value.getPriceAdjustment() != null) {
 391                     if (optionValuePriceAdjustments == null) {
 392                         optionValuePriceAdjustments = value.getPriceAdjustment();
 393                     } else {
<abbr title=" 394                         optionValuePriceAdjustments = optionValuePriceAdjustments.add(value.getPriceAdjustment());"> 394                         optionValuePriceAdjustments = optionValuePriceAdjustments.add(value.getPriceAdjusðŸ”µ</abbr>
 395                     }
 396                 }
 397             }
 398         }
 399         return optionValuePriceAdjustments;
 400     }
 401 
 402     @Override
 403     public Money getSalePrice() {
 404         Money returnPrice = null;
 405         Money optionValueAdjustments = null;
 406 
 407         if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 408             // We have dynamic pricing, so we will pull the sale price from there
 409             DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 410             returnPrice = dynamicPrices.getSalePrice();
 411             optionValueAdjustments = dynamicPrices.getPriceAdjustment();
 412             if (SkuPricingConsiderationContext.isPricingConsiderationActive()) {
 413                 return returnPrice;
 414             }
 415         } else if (salePrice != null) {
<abbr title=" 416             // We have an explicitly set sale price directly on this entity. We will not apply any adjustments"> 416             // We have an explicitly set sale price directly on this entity. We will not apply any adjustðŸ”µ</abbr>
 417             returnPrice = new Money(salePrice, getCurrency());
 418         }
 419 
 420         if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 421             returnPrice = lookupDefaultSku().getSalePrice();
 422             optionValueAdjustments = getProductOptionValueAdjustments();
 423         }
 424 
 425         if (returnPrice == null) {
 426             return null;
 427         }
 428 
 429         if (optionValueAdjustments != null) {
 430             returnPrice = returnPrice.add(optionValueAdjustments);
 431         }
 432 
 433         return returnPrice;
 434     }
 435 
 436     @Override
 437     public boolean hasSalePrice() {
 438         return getSalePrice() != null;
 439     }
 440 
 441     @Override
 442     public void setSalePrice(Money salePrice) {
 443         this.salePrice = Money.toAmount(salePrice);
 444     }
 445 
 446     @Override
 447     public Money getRetailPrice() {
 448         return getRetailPriceInternal();
 449     }
 450 
 451     /*
<abbr title=" 452      * This allows us a way to determine or calculate the retail price. If one is not available this method will return null."> 452      * This allows us a way to determine or calculate the retail price. If one is not available this methðŸ”µ</abbr>
<abbr title=" 453      * This allows the call to hasRetailPrice() to determine if there is a retail price without the overhead of an exception."> 453      * This allows the call to hasRetailPrice() to determine if there is a retail price without the overhðŸ”µ</abbr>
 454      */
 455     protected Money getRetailPriceInternal() {
 456         Money returnPrice = null;
 457         Money optionValueAdjustments = null;
 458 
 459         if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 460             // We have dynamic pricing, so we will pull the retail price from there
 461             DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 462             returnPrice = dynamicPrices.getRetailPrice();
 463             optionValueAdjustments = dynamicPrices.getPriceAdjustment();
 464             if (SkuPricingConsiderationContext.isPricingConsiderationActive()) {
 465                 return returnPrice;
 466             }
 467         } else if (retailPrice != null) {
 468             returnPrice = new Money(retailPrice, getCurrency());
 469         }
 470 
 471         if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 472             // Otherwise, we&#x27;ll pull the retail price from the default sku
 473             returnPrice = lookupDefaultSku().getRetailPrice();
 474             optionValueAdjustments = getProductOptionValueAdjustments();
 475         }
 476 
 477         if (returnPrice != null &amp;&amp; optionValueAdjustments != null) {
 478             returnPrice = returnPrice.add(optionValueAdjustments);
 479         }
 480 
 481         return returnPrice;
 482     }
 483 
 484     @Override
 485     public Money getBaseRetailPrice() {
 486         Money returnPrice = null;
 487         if (retailPrice != null) {
 488             returnPrice = new Money(retailPrice, getCurrency());
 489         }
 490         if ((returnPrice == null) &amp;&amp; hasDefaultSku()) {
 491             Sku defaultSku = lookupDefaultSku();
 492             returnPrice = defaultSku.getBaseRetailPrice();
 493         }
 494         return returnPrice;
 495     }
 496 
 497     @Override
 498     public Money getBaseSalePrice() {
 499         Money returnPrice = null;
 500         if (salePrice != null) {
 501             returnPrice = new Money(salePrice, getCurrency());
 502         }
 503         if ((returnPrice == null) &amp;&amp; hasDefaultSku()) {
 504             Sku defaultSku = lookupDefaultSku();
 505             returnPrice = defaultSku.getBaseSalePrice();
 506         }
 507         return returnPrice;
 508     }
 509 
 510     @Override
 511     public DynamicSkuPrices getPriceData() {
 512         if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 513             DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 514             return dynamicPrices;
 515         } else {
 516             DynamicSkuPrices dsp = new DynamicSkuPrices();
 517             BroadleafCurrency tmpCurrency;
 518             if (currency != null) {
 519                 tmpCurrency = currency;
 520             } else {
 521                 tmpCurrency = BroadleafRequestContext.getCurrency();
 522             }
 523             if (retailPrice != null) {
 524                 dsp.setRetailPrice(new Money(retailPrice, tmpCurrency));
 525             }
 526             if (salePrice != null) {
 527                 dsp.setSalePrice(new Money(salePrice, tmpCurrency));
 528             }
 529             return dsp;
 530         }
 531     }
 532 
 533     @Override
 534     public boolean hasRetailPrice() {
 535         return getRetailPriceInternal() != null;
 536     }
 537 
 538     @Override
 539     public void setRetailPrice(Money retailPrice) {
 540         this.retailPrice = Money.toAmount(retailPrice);
 541     }
 542 
 543     @Override
 544     public Money getPrice() {
 545         return isOnSale() ? getSalePrice() : getRetailPrice();
 546     }
 547 
 548     @Override
 549     @Deprecated
 550     public Money getListPrice() {
 551         return getRetailPrice();
 552     }
 553 
 554     @Override
 555     @Deprecated
 556     public void setListPrice(Money listPrice) {
 557         this.retailPrice = Money.toAmount(listPrice);
 558     }
 559 
 560     @Override
 561     public Money getCost() {
 562         if (cost == null &amp;&amp; hasDefaultSku()) {
 563             return lookupDefaultSku().getCost();
 564         }
 565 
 566         if (cost == null) {
 567             return null;
 568         }
 569 
 570         return new Money(cost, getCurrency());
 571     }
 572 
 573     @Override
 574     public void setCost(Money cost) {
 575         this.cost = cost.getAmount();
 576     }
 577 
 578     @Override
 579     public Money getMargin() {
 580         Money margin = null;
 581         Money price = getPrice();
 582         Money purchaseCost = getCost();
 583 
 584         if (price == null &amp;&amp; hasDefaultSku()) {
 585             price = lookupDefaultSku().getPrice();
 586         }
 587 
 588         if (purchaseCost == null &amp;&amp; hasDefaultSku()) {
 589             purchaseCost = lookupDefaultSku().getCost();
 590         }
 591 
 592         if (price != null &amp;&amp; !price.getAmount().equals(BigDecimal.ZERO)) {
 593             if (purchaseCost != null) {
 594                 margin = price.subtract(purchaseCost).divide(price.getAmount());
 595             }
 596         } else {
 597             margin = Money.ZERO;
 598         }
 599 
 600         return margin;
 601     }
 602 
 603     @Override
 604     public String getName() {
 605         if (name == null &amp;&amp; hasDefaultSku()) {
 606             return lookupDefaultSku().getName();
 607         }
 608 
 609         return DynamicTranslationProvider.getValue(this, &quot;name&quot;, name);
 610     }
 611 
 612     @Override
 613     public void setName(String name) {
 614         this.name = name;
 615     }
 616 
 617     @Override
 618     public String getDescription() {
 619         if (description == null &amp;&amp; hasDefaultSku()) {
 620             return lookupDefaultSku().getDescription();
 621         }
 622 
 623         return DynamicTranslationProvider.getValue(this, &quot;description&quot;, description);
 624     }
 625 
 626     @Override
 627     public void setDescription(String description) {
 628         this.description = description;
 629     }
 630 
 631     @Override
 632     public String getLongDescription() {
 633         if (longDescription == null &amp;&amp; hasDefaultSku()) {
 634             return lookupDefaultSku().getLongDescription();
 635         }
 636 
 637         return DynamicTranslationProvider.getValue(this, &quot;longDescription&quot;, longDescription);
 638     }
 639 
 640     @Override
 641     public void setLongDescription(String longDescription) {
 642         this.longDescription = longDescription;
 643     }
 644 
 645     @Override
 646     public Boolean isTaxable() {
 647         if (taxable == null) {
 648             if (hasDefaultSku()) {
 649                 return lookupDefaultSku().isTaxable();
 650             }
 651             return null;
 652         }
 653         return taxable == &#x27;Y&#x27; ? Boolean.TRUE : Boolean.FALSE;
 654     }
 655 
 656     @Override
 657     public Boolean getTaxable() {
 658         return isTaxable();
 659     }
 660 
 661     @Override
 662     public void setTaxable(Boolean taxable) {
 663         if (taxable == null) {
 664             this.taxable = null;
 665         } else {
 666             this.taxable = taxable ? &#x27;Y&#x27; : &#x27;N&#x27;;
 667         }
 668     }
 669 
 670     @Override
 671     public Boolean isDiscountable() {
 672         if (discountable == null) {
 673             if (hasDefaultSku()) {
 674                 return lookupDefaultSku().isDiscountable();
 675             }
 676             return Boolean.FALSE;
 677         }
 678         return discountable == &#x27;Y&#x27; ? Boolean.TRUE : Boolean.FALSE;
 679     }
 680 
 681     /*
 682      * This is to facilitate serialization to non-Java clients
 683      */
 684     public Boolean getDiscountable() {
 685         return isDiscountable();
 686     }
 687 
 688     @Override
 689     public void setDiscountable(Boolean discountable) {
 690         if (discountable == null) {
 691             this.discountable = null;
 692         } else {
 693             this.discountable = discountable ? &#x27;Y&#x27; : &#x27;N&#x27;;
 694         }
 695     }
 696 
 697     @Override
 698     public Boolean isAvailable() {
 699         if (InventoryType.UNAVAILABLE.equals(getInventoryType())) {
 700             return false;
 701         }
 702 
 703         if (available == null) {
 704             if (hasDefaultSku()) {
 705                 return lookupDefaultSku().isAvailable();
 706             }
 707             return true;
 708         }
 709         return available != &#x27;N&#x27;;
 710     }
 711 
 712     @Override
 713     public Boolean getAvailable() {
 714         return isAvailable();
 715     }
 716 
 717     @Override
 718     public void setAvailable(Boolean available) {
 719         if (available == null) {
 720             this.available = null;
 721         } else {
 722             this.available = available ? &#x27;Y&#x27; : &#x27;N&#x27;;
 723         }
 724     }
 725 
 726     @Override
 727     public Date getActiveStartDate() {
 728         Date returnDate = null;
 729         if (SkuActiveDateConsiderationContext.hasDynamicActiveDates()) {
<abbr title=" 730             returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveStartDate(this);"> 730             returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveðŸ”µ</abbr>
 731         }
 732 
 733         if (returnDate == null) {
 734             if (activeStartDate == null &amp;&amp; hasDefaultSku()) {
 735                 return lookupDefaultSku().getActiveStartDate();
 736             } else {
 737                 return activeStartDate;
 738             }
 739         } else {
 740             return returnDate;
 741         }
 742     }
 743 
 744     @Override
 745     public void setActiveStartDate(Date activeStartDate) {
 746         this.activeStartDate = activeStartDate;
 747     }
 748 
 749     @Override
 750     public Date getActiveEndDate() {
 751         Date returnDate = null;
 752         if (SkuActiveDateConsiderationContext.hasDynamicActiveDates()) {
<abbr title=" 753             returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveEndDate(this);"> 753             returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveðŸ”µ</abbr>
 754         }
 755 
 756         if (returnDate == null) {
 757             if (activeEndDate == null &amp;&amp; hasDefaultSku()) {
 758                 return lookupDefaultSku().getActiveEndDate();
 759             } else {
 760                 return activeEndDate;
 761             }
 762         } else {
 763             return returnDate;
 764         }
 765     }
 766 
 767     @Override
 768     public void setActiveEndDate(Date activeEndDate) {
 769         this.activeEndDate = activeEndDate;
 770     }
 771 
 772     @Override
 773     public Dimension getDimension() {
 774         if (dimension == null &amp;&amp; hasDefaultSku()) {
 775             return lookupDefaultSku().getDimension();
 776         } else {
 777             return dimension;
 778         }
 779     }
 780 
 781     @Override
 782     public void setDimension(Dimension dimension) {
 783         this.dimension = dimension;
 784     }
 785 
 786     @Override
 787     public Weight getWeight() {
 788         if (weight == null &amp;&amp; hasDefaultSku()) {
 789             return lookupDefaultSku().getWeight();
 790         } else {
 791             return weight;
 792         }
 793     }
 794 
 795     @Override
 796     public void setWeight(Weight weight) {
 797         this.weight = weight;
 798     }
 799 
 800     @Override
 801     public boolean isActive() {
 802         if (activeStartDate == null &amp;&amp; activeEndDate == null &amp;&amp; hasDefaultSku()) {
 803             return lookupDefaultSku().isActive();
 804         }
 805         if (LOG.isDebugEnabled()) {
 806             if (!DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true)) {
 807                 LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to date&quot;);
 808             }
 809         }
 810 
 811         if (!(getProduct() == null) &amp;&amp; !getProduct().isActive()) {
 812             return false;
 813         }
 814 
 815         return DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true);
 816     }
 817 
 818     @Override
 819     public boolean isActive(Product product, Category category) {
 820         if (LOG.isDebugEnabled()) {
 821             if (!DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true)) {
 822                 LOG.debug((&quot;sku, &quot; + id) + &quot;, inactive due to date&quot;);
 823             } else if (!product.isActive()) {
 824                 LOG.debug((&quot;sku, &quot; + id) + &quot;, inactive due to product being inactive&quot;);
 825             } else if (!category.isActive()) {
 826                 LOG.debug((&quot;sku, &quot; + id) + &quot;, inactive due to category being inactive&quot;);
 827             }
 828         }
<abbr title=" 829         return (this.isActive() &amp;&amp; ((product == null) || product.isActive())) &amp;&amp; ((category == null) || category.isActive());"> 829         return (this.isActive() &amp;&amp; ((product == null) || product.isActive())) &amp;&amp; ((category == null) || cðŸ”µ</abbr>
 830     }
 831 
 832     @Override
 833     @Deprecated
 834     public Map&lt;String, Media&gt; getSkuMedia() {
 835         Map&lt;String, Media&gt; skuMediaMap = new LinkedHashMap&lt;&gt;(legacySkuMedia);
 836         if (MapUtils.isEmpty(skuMediaMap)) {
 837             for (Map.Entry&lt;String, SkuMediaXref&gt; entry : getSkuMediaXref().entrySet()) {
 838                 skuMediaMap.put(entry.getKey(), entry.getValue().getMedia());
 839             }
 840         }
 841         return Collections.unmodifiableMap(skuMediaMap);
 842     }
 843 
 844     @Override
 845     @Deprecated
 846     public void setSkuMedia(Map&lt;String, Media&gt; skuMedia) {
 847         this.skuMedia.clear();
 848         this.legacySkuMedia.clear();
 849         for (Map.Entry&lt;String, Media&gt; entry : skuMedia.entrySet()) {
<abbr title=" 850             this.skuMedia.put(entry.getKey(), new SkuMediaXrefImpl(this, entry.getValue(), entry.getKey()));"> 850             this.skuMedia.put(entry.getKey(), new SkuMediaXrefImpl(this, entry.getValue(), entry.getKey()ðŸ”µ</abbr>
 851         }
 852     }
 853 
 854     @Override
 855     public Map&lt;String, SkuMediaXref&gt; getSkuMediaXref() {
 856         Map&lt;String, SkuMediaXref&gt; skuMediaMap = skuMedia;
 857         if (MapUtils.isEmpty(skuMediaMap)) {
 858             if (hasDefaultSku()) {
 859                 return lookupDefaultSku().getSkuMediaXref();
 860             }
 861         }
 862         if (isOrderedSkuMedia(skuMediaMap)) {
 863             skuMediaMap = sortSkuMedia(skuMediaMap);
 864         }
 865         return skuMediaMap;
 866     }
 867 
 868     @Override
 869     public Map&lt;String, SkuMediaXref&gt; getSkuMediaXrefIgnoreDefaultSku() {
 870         Map&lt;String, SkuMediaXref&gt; skuMediaMap = skuMedia;
 871         if (isOrderedSkuMedia(skuMediaMap)) {
 872             skuMediaMap = sortSkuMedia(skuMediaMap);
 873         }
 874         return skuMediaMap;
 875     }
 876 
 877     @Override
 878     public Media getPrimarySkuMedia() {
 879         Map&lt;String, SkuMediaXref&gt; skuMediaMap = getSkuMediaXrefIgnoreDefaultSku();
 880         if (MapUtils.isNotEmpty(skuMediaMap)) {
 881             if (isOrderedSkuMedia(skuMediaMap)) {
<abbr title=" 882                 return skuMediaMap.values().stream().map(OrderedSkuMediaXref.class::cast).filter(OrderedSkuMediaXref::getShowInGallery).findFirst().map(SkuMediaXref.class::cast).map(SkuMediaXref::getMedia).orElse(null);"> 882                 return skuMediaMap.values().stream().map(OrderedSkuMediaXref.class::cast).filter(OrderedSðŸ”µ</abbr>
 883             } else {
 884                 SkuMediaXref primaryXref = skuMediaMap.get(&quot;primary&quot;);
 885                 return primaryXref == null ? null : primaryXref.getMedia();
 886             }
 887         }
 888         return null;
 889     }
 890 
 891     @Override
 892     public void setSkuMediaXref(Map&lt;String, SkuMediaXref&gt; skuMediaXref) {
 893         this.skuMedia = skuMediaXref;
 894     }
 895 
 896     protected boolean isOrderedSkuMedia(Map&lt;String, SkuMediaXref&gt; skuMedia) {
 897         return skuMedia.values().stream().anyMatch(OrderedSkuMediaXref.class::isInstance);
 898     }
 899 
 900     protected Map&lt;String, SkuMediaXref&gt; sortSkuMedia(Map&lt;String, SkuMediaXref&gt; skuMedia) {
<abbr title=" 901         return skuMedia.values().stream().sorted(Comparator.comparing(( xref) -&gt; ((OrderedSkuMediaXref) (xref)).getDisplayOrder())).collect(Collectors.toMap(SkuMediaXref::getKey, Function.identity(), ( key1, key2) -&gt; {"> 901         return skuMedia.values().stream().sorted(Comparator.comparing(( xref) -&gt; ((OrderedSkuMediaXref) (ðŸ”µ</abbr>
 902             throw new IllegalStateException(String.format(&quot;Duplicate key %s&quot;, key1));
 903         }, LinkedHashMap::new));
 904     }
 905 
 906     @Override
 907     public Product getDefaultProduct() {
 908         return defaultProduct;
 909     }
 910 
 911     @Override
 912     public void setDefaultProduct(Product defaultProduct) {
 913         this.defaultProduct = defaultProduct;
 914     }
 915 
 916     @Override
 917     public Product getProduct() {
 918         return (getDefaultProduct() != null) ? getDefaultProduct() : this.product;
 919     }
 920 
 921     @Override
 922     public void setProduct(Product product) {
 923         this.product = product;
 924     }
 925 
 926     @Override
 927     public Set&lt;SkuProductOptionValueXref&gt; getProductOptionValueXrefs() {
 928         return productOptionValueXrefs;
 929     }
 930 
 931     @Override
 932     public void setProductOptionValueXrefs(Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs) {
 933         this.productOptionValueXrefs = productOptionValueXrefs;
 934     }
 935 
 936     @Override
 937     public Set&lt;ProductOptionValue&gt; getProductOptionValuesCollection() {
 938         if (legacyProductOptionValues.size() == 0) {
 939             for (SkuProductOptionValueXref xref : productOptionValueXrefs) {
 940                 legacyProductOptionValues.add(xref.getProductOptionValue());
 941             }
 942         }
 943         return Collections.unmodifiableSet(legacyProductOptionValues);
 944     }
 945 
 946     @Override
 947     public void setProductOptionValuesCollection(Set&lt;ProductOptionValue&gt; productOptionValues) {
 948         this.legacyProductOptionValues.clear();
 949         this.productOptionValueXrefs.clear();
 950         for (ProductOptionValue val : productOptionValues) {
 951             this.productOptionValueXrefs.add(new SkuProductOptionValueXrefImpl(this, val));
 952         }
 953     }
 954 
 955     @Override
 956     @Deprecated
 957     public List&lt;ProductOptionValue&gt; getProductOptionValues() {
<abbr title=" 958         //Changing this API to Set is ill-advised (especially in a patch release). The tendrils are widespread. Instead"> 958         //Changing this API to Set is ill-advised (especially in a patch release). The tendrils are widesðŸ”µ</abbr>
 959         //we just migrate the call from the List to the internal Set representation. This is in response
 960         //to https://github.com/BroadleafCommerce/BroadleafCommerce/issues/917.
<abbr title=" 961         return ((List&lt;ProductOptionValue&gt;) (Proxy.newProxyInstance(getClass().getClassLoader(), new Class&lt;?&gt;[]{ List.class }, new InvocationHandler() {"> 961         return ((List&lt;ProductOptionValue&gt;) (Proxy.newProxyInstance(getClass().getClassLoader(), new ClassðŸ”µ</abbr>
 962             @Override
 963             public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
<abbr title=" 964                 return MethodUtils.invokeMethod(getProductOptionValuesCollection(), method.getName(), args, method.getParameterTypes());"> 964                 return MethodUtils.invokeMethod(getProductOptionValuesCollection(), method.getName(), argðŸ”µ</abbr>
 965             }
 966         })));
 967     }
 968 
 969     @Override
 970     @Deprecated
 971     public void setProductOptionValues(List&lt;ProductOptionValue&gt; productOptionValues) {
 972         setProductOptionValuesCollection(new HashSet&lt;ProductOptionValue&gt;(productOptionValues));
 973     }
 974 
 975     @Override
 976     @Deprecated
 977     public Boolean isMachineSortable() {
 978         if (isMachineSortable == null &amp;&amp; hasDefaultSku()) {
 979             return lookupDefaultSku().isMachineSortable();
 980         }
 981         return isMachineSortable == null ? false : isMachineSortable;
 982     }
 983 
 984     @Override
 985     public Boolean getIsMachineSortable() {
 986         if (isMachineSortable == null &amp;&amp; hasDefaultSku()) {
 987             return lookupDefaultSku().getIsMachineSortable();
 988         }
 989         return isMachineSortable == null ? false : isMachineSortable;
 990     }
 991 
 992     @Override
 993     @Deprecated
 994     public void setMachineSortable(Boolean isMachineSortable) {
 995         this.isMachineSortable = isMachineSortable;
 996     }
 997 
 998     @Override
 999     public void setIsMachineSortable(Boolean isMachineSortable) {
1000         this.isMachineSortable = isMachineSortable;
1001     }
1002 
1003     @Override
1004     public List&lt;SkuFee&gt; getFees() {
1005         return fees;
1006     }
1007 
1008     @Override
1009     public void setFees(List&lt;SkuFee&gt; fees) {
1010         this.fees = fees;
1011     }
1012 
1013     @Override
1014     public Map&lt;FulfillmentOption, BigDecimal&gt; getFulfillmentFlatRates() {
1015         return fulfillmentFlatRates;
1016     }
1017 
1018     @Override
1019     public void setFulfillmentFlatRates(Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates) {
1020         this.fulfillmentFlatRates = fulfillmentFlatRates;
1021     }
1022 
1023     @Override
1024     public List&lt;FulfillmentOption&gt; getExcludedFulfillmentOptions() {
1025         return excludedFulfillmentOptions;
1026     }
1027 
1028     @Override
1029     public void setExcludedFulfillmentOptions(List&lt;FulfillmentOption&gt; excludedFulfillmentOptions) {
1030         this.excludedFulfillmentOptions = excludedFulfillmentOptions;
1031     }
1032 
1033     @Override
1034     public InventoryType getInventoryType() {
1035         if (StringUtils.isEmpty(this.inventoryType)) {
1036             if (hasDefaultSku() &amp;&amp; lookupDefaultSku().getInventoryType() != null) {
1037                 return lookupDefaultSku().getInventoryType();
1038             } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1039                 return getProduct().getDefaultCategory().getInventoryType();
1040             }
1041             return null;
1042         }
1043         return InventoryType.getInstance(this.inventoryType);
1044     }
1045 
1046     @Override
1047     public void setInventoryType(InventoryType inventoryType) {
1048         this.inventoryType = (inventoryType == null) ? null : inventoryType.getType();
1049     }
1050 
1051     @Override
1052     public Integer getQuantityAvailable() {
1053         return quantityAvailable;
1054     }
1055 
1056     @Override
1057     public void setQuantityAvailable(Integer quantityAvailable) {
1058         this.quantityAvailable = quantityAvailable;
1059     }
1060 
1061     @Override
1062     public FulfillmentType getFulfillmentType() {
1063         if (StringUtils.isEmpty(this.fulfillmentType)) {
1064             if (hasDefaultSku() &amp;&amp; lookupDefaultSku().getFulfillmentType() != null) {
1065                 return lookupDefaultSku().getFulfillmentType();
1066             } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1067                 return getProduct().getDefaultCategory().getFulfillmentType();
1068             }
1069             return null;
1070         }
1071         return FulfillmentType.getInstance(this.fulfillmentType);
1072     }
1073 
1074     @Override
1075     public void setFulfillmentType(FulfillmentType fulfillmentType) {
1076         if (fulfillmentType != null) {
1077             this.fulfillmentType = fulfillmentType.getType();
1078         }
1079     }
1080 
1081     @Override
1082     @Deprecated
1083     public Map&lt;String, SkuAttribute&gt; getSkuAttributes() {
1084         Map&lt;String, SkuAttribute&gt; attributeMap = new HashMap&lt;String, SkuAttribute&gt;();
1085         for (SkuAttribute skuAttribute : skuAttributes) {
1086             attributeMap.put(skuAttribute.getName(), skuAttribute);
1087         }
1088         return attributeMap;
1089     }
1090 
1091     @Override
1092     @SuppressWarnings(&quot;unchecked&quot;)
1093     public Map&lt;String, Collection&lt;SkuAttribute&gt;&gt; getMultiValueSkuAttributes() {
1094         MultiValueMap multiValueMap = new MultiValueMap();
1095         for (SkuAttribute skuAttribute : skuAttributes) {
1096             multiValueMap.put(skuAttribute.getName(), skuAttribute);
1097         }
1098         return multiValueMap;
1099     }
1100 
1101     @Override
1102     public void setSkuAttributes(Map&lt;String, SkuAttribute&gt; skuAttributes) {
1103         List&lt;SkuAttribute&gt; skuAttributeList = new ArrayList&lt;SkuAttribute&gt;();
1104         for (Map.Entry&lt;String, SkuAttribute&gt; entry : skuAttributes.entrySet()) {
1105             skuAttributeList.add(entry.getValue());
1106         }
1107         this.skuAttributes = skuAttributeList;
1108     }
1109 
1110     @Override
1111     public BroadleafCurrency getCurrency() {
1112         if (currency == null &amp;&amp; hasDefaultSku()) {
1113             return lookupDefaultSku().getCurrency();
1114         } else {
1115             return currency;
1116         }
1117     }
1118 
1119     @Override
1120     public void setCurrency(BroadleafCurrency currency) {
1121         this.currency = currency;
1122     }
1123 
1124     @Override
1125     public void clearDynamicPrices() {
1126         SkuPricingConsiderationContext.removeFromThreadCache(getId());
1127     }
1128 
1129     @Override
1130     public boolean equals(Object obj) {
1131         if (this == obj) {
1132             return true;
1133         }
1134         if (obj == null) {
1135             return false;
1136         }
1137         if (!getClass().isAssignableFrom(obj.getClass())) {
1138             return false;
1139         }
1140         SkuImpl other = (SkuImpl) obj;
1141 
1142         if (id != null &amp;&amp; other.id != null) {
1143             return id.equals(other.id);
1144         }
1145 
1146         if (getName() == null) {
1147             if (other.getName() != null) {
1148                 return false;
1149             }
1150         } else if (!getName().equals(other.getName())) {
1151             return false;
1152         }
1153         return true;
1154     }
1155 
1156     @Override
1157     public int hashCode() {
1158         final int prime = 31;
1159         int result = 1;
1160         result = prime * result + ((name == null) ? 0 : name.hashCode());
1161         return result;
1162     }
1163 
1164     @Override
1165     public String getTaxCode() {
1166         if (StringUtils.isEmpty(this.taxCode)) {
1167             if (hasDefaultSku() &amp;&amp; !StringUtils.isEmpty(lookupDefaultSku().getTaxCode())) {
1168                 return lookupDefaultSku().getTaxCode();
1169             } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1170                 return getProduct().getDefaultCategory().getTaxCode();
1171             }
1172         }
1173         return this.taxCode;
1174     }
1175 
1176     @Override
1177     public void setTaxCode(String taxCode) {
1178         this.taxCode = taxCode;
1179     }
1180 
1181     @Override
1182     public String getExternalId() {
1183         return externalId;
1184     }
1185 
1186     @Override
1187     public void setExternalId(String externalId) {
1188         this.externalId = externalId;
1189     }
1190 
1191     @Override
1192     public String getUpc() {
1193         return upc;
1194     }
1195 
1196     @Override
1197     public void setUpc(String upc) {
1198         this.upc = upc;
1199     }
1200 
1201     @Override
1202     public FieldEntity getFieldEntityType() {
1203         return FieldEntity.SKU;
1204     }
1205 
1206     @Override
<abbr title="1207     public &lt;G extends Sku&gt; CreateResponse&lt;G&gt; createOrRetrieveCopyInstance(MultiTenantCopyContext context) throws CloneNotSupportedException {">1207     public &lt;G extends Sku&gt; CreateResponse&lt;G&gt; createOrRetrieveCopyInstance(MultiTenantCopyContext context)ðŸ”µ</abbr>
1208         CreateResponse&lt;G&gt; createResponse = context.createOrRetrieveCopyInstance(this);
1209         if (createResponse.isAlreadyPopulated()) {
1210             return createResponse;
1211         }
1212         Sku cloned = createResponse.getClone();
1213         cloned.setRetailPrice(getRetailPrice());
1214         cloned.setSalePrice(getSalePrice());
1215         cloned.setName(name);
1216         cloned.setActiveEndDate(activeEndDate);
1217         cloned.setActiveStartDate(activeStartDate);
1218         cloned.setCurrency(currency);
1219         cloned.setQuantityAvailable(quantityAvailable);
1220         cloned.setDescription(description);
1221         cloned.setDimension(dimension);
1222         cloned.setDiscountable(isDiscountable());
1223         cloned.setDisplayTemplate(displayTemplate);
1224         cloned.setExternalId(externalId);
1225         cloned.setTaxable(isTaxable());
1226         cloned.setTaxCode(taxCode);
1227         cloned.setUrlKey(urlKey);
1228         cloned.setInventoryType(getInventoryType());
1229         cloned.setFulfillmentType(getFulfillmentType());
1230         cloned.setIsMachineSortable(isMachineSortable);
1231         cloned.setLongDescription(longDescription);
1232         cloned.setUpc(upc);
1233         if (product != null) {
1234             cloned.setDefaultProduct(product.createOrRetrieveCopyInstance(context).getClone());
1235         }
1236         if (product != null) {
1237             cloned.setProduct(product.createOrRetrieveCopyInstance(context).getClone());
1238         }
1239         for (Map.Entry&lt;String, SkuAttribute&gt; entry : getSkuAttributes().entrySet()) {
1240             SkuAttribute clonedEntry = entry.getValue().createOrRetrieveCopyInstance(context).getClone();
1241             cloned.getSkuAttributes().put(entry.getKey(), clonedEntry);
1242         }
1243         for (SkuProductOptionValueXref entry : productOptionValueXrefs) {
<abbr title="1244             SkuProductOptionValueXref clonedEntry = entry.createOrRetrieveCopyInstance(context).getClone();">1244             SkuProductOptionValueXref clonedEntry = entry.createOrRetrieveCopyInstance(context).getClone(ðŸ”µ</abbr>
1245             cloned.getProductOptionValueXrefs().add(clonedEntry);
1246         }
1247         for (Map.Entry&lt;String, SkuMediaXref&gt; entry : skuMedia.entrySet()) {
<abbr title="1248             SkuMediaXrefImpl clonedEntry = ((SkuMediaXrefImpl) (entry.getValue())).createOrRetrieveCopyInstance(context).getClone();">1248             SkuMediaXrefImpl clonedEntry = ((SkuMediaXrefImpl) (entry.getValue())).createOrRetrieveCopyInðŸ”µ</abbr>
1249             cloned.getSkuMediaXrefIgnoreDefaultSku().put(entry.getKey(), clonedEntry);
1250         }
1251         for (FulfillmentOption entry : excludedFulfillmentOptions) {
1252             FulfillmentOption clonedEntry = entry.createOrRetrieveCopyInstance(context).getClone();
1253             cloned.getExcludedFulfillmentOptions().add(clonedEntry);
1254         }
1255         for (Map.Entry&lt;FulfillmentOption, BigDecimal&gt; entry : fulfillmentFlatRates.entrySet()) {
<abbr title="1256             FulfillmentOption clonedEntry = entry.getKey().createOrRetrieveCopyInstance(context).getClone();">1256             FulfillmentOption clonedEntry = entry.getKey().createOrRetrieveCopyInstance(context).getCloneðŸ”µ</abbr>
1257             cloned.getFulfillmentFlatRates().put(clonedEntry, entry.getValue());
1258         }
1259         return createResponse;
1260     }
1261 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.catalog.domain;
  19  
  20  import org.apache.commons.beanutils.MethodUtils;
  21  import org.apache.commons.collections.MapUtils;
  22  import org.apache.commons.collections.map.MultiValueMap;
  23  import org.apache.commons.lang.StringUtils;
  24  import org.apache.commons.logging.Log;
  25  import org.apache.commons.logging.LogFactory;
  26  import org.broadleafcommerce.common.copy.CreateResponse;
  27  import org.broadleafcommerce.common.copy.MultiTenantCopyContext;
  28  import org.broadleafcommerce.common.currency.domain.BroadleafCurrency;
  29  import org.broadleafcommerce.common.currency.domain.BroadleafCurrencyImpl;
  30  import org.broadleafcommerce.common.extensibility.jpa.clone.ClonePolicyArchive;
  31  import org.broadleafcommerce.common.extensibility.jpa.clone.ClonePolicyCollectionOverride;
  32  import org.broadleafcommerce.common.extensibility.jpa.clone.IgnoreEnterpriseBehavior;
  33  import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransform;
  34  import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransformMember;
  35  import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransformTypes;
  36  import org.broadleafcommerce.common.i18n.service.DynamicTranslationProvider;
  37  import org.broadleafcommerce.common.media.domain.Media;
  38  import org.broadleafcommerce.common.money.Money;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import org.broadleafcommerce.common.presentation.*;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import org.broadleafcommerce.common.presentation.AdminPresentation;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import org.broadleafcommerce.common.presentation.AdminPresentationCollection;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +import org.broadleafcommerce.common.presentation.AdminPresentationDataDrivenEnumeration;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +import org.broadleafcommerce.common.presentation.AdminPresentationMap;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +import org.broadleafcommerce.common.presentation.AdminPresentationMapField;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import org.broadleafcommerce.common.presentation.AdminPresentationMapFields;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +import org.broadleafcommerce.common.presentation.AdminPresentationToOneLookup;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import org.broadleafcommerce.common.presentation.ConfigurationItem;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +import org.broadleafcommerce.common.presentation.OptionFilterParam;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +import org.broadleafcommerce.common.presentation.OptionFilterParamType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +import org.broadleafcommerce.common.presentation.ValidationConfiguration;</span>
  51  import org.broadleafcommerce.common.presentation.client.LookupType;
  52  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  53  import org.broadleafcommerce.common.presentation.client.VisibilityEnum;
  54  import org.broadleafcommerce.common.util.DateUtil;
  55  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  56  import org.broadleafcommerce.core.catalog.service.dynamic.DynamicSkuPrices;
  57  import org.broadleafcommerce.core.catalog.service.dynamic.SkuActiveDateConsiderationContext;
  58  import org.broadleafcommerce.core.catalog.service.dynamic.SkuPricingConsiderationContext;
  59  import org.broadleafcommerce.core.inventory.service.type.InventoryType;
  60  import org.broadleafcommerce.core.order.domain.FulfillmentOption;
  61  import org.broadleafcommerce.core.order.domain.FulfillmentOptionImpl;
  62  import org.broadleafcommerce.core.order.service.type.FulfillmentType;
  63  import org.broadleafcommerce.core.search.domain.FieldEntity;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -import org.hibernate.annotations.*;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +import org.hibernate.annotations.BatchSize;</span>
  66  import org.hibernate.annotations.Cache;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +import org.hibernate.annotations.CacheConcurrencyStrategy;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +import org.hibernate.annotations.Cascade;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +import org.hibernate.annotations.GenericGenerator;</span>
  70  import org.hibernate.annotations.Index;
  71  import org.hibernate.annotations.Parameter;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -import javax.persistence.CascadeType;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -import javax.persistence.*;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -import javax.persistence.Entity;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -import javax.persistence.Table;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +import org.hibernate.annotations.Type;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +</span>
  79  import java.lang.reflect.InvocationHandler;
  80  import java.lang.reflect.Method;
  81  import java.lang.reflect.Proxy;
  82  import java.math.BigDecimal;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -import java.util.*;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +import java.util.Collection;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +import java.util.Collections;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +import java.util.Comparator;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +import java.util.Date;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +import java.util.HashMap;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +import java.util.HashSet;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +import java.util.LinkedHashMap;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +import java.util.List;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +import java.util.Map;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +import java.util.Set;</span>
  95  import java.util.function.Function;
  96  import java.util.stream.Collectors;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +import javax.persistence.CascadeType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +import javax.persistence.CollectionTable;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +import javax.persistence.Column;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +import javax.persistence.ElementCollection;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +import javax.persistence.Embedded;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +import javax.persistence.Entity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +import javax.persistence.FetchType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +import javax.persistence.GeneratedValue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +import javax.persistence.Id;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +import javax.persistence.Inheritance;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +import javax.persistence.InheritanceType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +import javax.persistence.JoinColumn;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +import javax.persistence.JoinTable;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +import javax.persistence.Lob;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +import javax.persistence.ManyToMany;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +import javax.persistence.ManyToOne;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +import javax.persistence.MapKey;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +import javax.persistence.MapKeyClass;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +import javax.persistence.MapKeyJoinColumn;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +import javax.persistence.OneToMany;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +import javax.persistence.OneToOne;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +import javax.persistence.Table;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +import javax.persistence.Transient;</span>
 121  
 122  /**
 123   * The Class SkuImpl is the default implementation of {@link Sku}. A SKU is a
 124   * specific item that can be sold including any specific attributes of the item
 125   * such as color or size. &lt;br&gt;
 126   * &lt;br&gt;
 127   * If you want to add fields specific to your implementation of
 128   * BroadLeafCommerce you should extend this class and add your fields. If you
 129   * need to make significant changes to the SkuImpl then you should implement
 130   * your own version of {@link Sku}.&lt;br&gt;
 131   * &lt;br&gt;
 132   * This implementation uses a Hibernate implementation of JPA configured through
 133   * annotations. The Entity references the following tables: BLC_SKU,
 134   * BLC_SKU_IMAGE
 135   *
 136   * !!!!!!!!!!!!!!!!!
<abbr title=" 137   * &lt;p&gt;For admin required field validation, if this Sku is apart of an additionalSkus list (meaning it is not a defaultSku) then"> 137   * &lt;p&gt;For admin required field validation, if this Sku is apart of an additionalSkus list (meaning it is not a defðŸ”µ</abbr>
<abbr title=" 138   * it should have no required restrictions on it. All additional Skus can delegate to the defaultSku of the related product"> 138   * it should have no required restrictions on it. All additional Skus can delegate to the defaultSku of the relateðŸ”µ</abbr>
<abbr title=" 139   * for all of its fields. For this reason, if you would like to mark more fields as required then rather than using"> 139   * for all of its fields. For this reason, if you would like to mark more fields as required then rather than usinðŸ”µ</abbr>
<abbr title=" 140   * {@link AdminPresentation#requiredOverride()}, use the mo:overrides section in bl-admin-applicationContext.xml for Product"> 140   * {@link AdminPresentation#requiredOverride()}, use the mo:overrides section in bl-admin-applicationContext.xml fðŸ”µ</abbr>
 141   * and reference each required field like &#x27;defaultSku.name&#x27; or &#x27;defaultSku.retailPrice&#x27;.&lt;/p&gt;
 142   *
 143   * @author btaylor
 144   * @see {@link Sku}
 145   */
 146  @Entity
 147  @Inheritance(strategy = InheritanceType.JOINED)
 148  @Table(name = &quot;BLC_SKU&quot;)
<abbr title=" 149  //multi-column indexes don&#x27;t appear to get exported correctly when declared at the field level, so declaring here as a workaround"> 149  //multi-column indexes don&#x27;t appear to get exported correctly when declared at the field level, so declaring here ðŸ”µ</abbr>
 150  @org.hibernate.annotations.Table(appliesTo = &quot;BLC_SKU&quot;, indexes = {
 151      @Index(name = &quot;SKU_URL_KEY_INDEX&quot;,
 152          columnNames = { &quot;URL_KEY&quot; }
 153      )
 154  })
 155  @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 156  @DirectCopyTransform({
 157          @DirectCopyTransformMember(templateTokens = DirectCopyTransformTypes.SANDBOX, skipOverlaps=true),
 158          @DirectCopyTransformMember(templateTokens = DirectCopyTransformTypes.MULTITENANT_CATALOG)
 159  })
 160  public class SkuImpl implements Sku, SkuAdminPresentation {
 161  
 162      private static final Log LOG = LogFactory.getLog(SkuImpl.class);
 163  
 164      private static final long serialVersionUID = 1L;
 165  
 166      @Id
 167      @GeneratedValue(generator = &quot;SkuId&quot;)
 168      @GenericGenerator(
 169          name = &quot;SkuId&quot;,
 170          strategy = &quot;org.broadleafcommerce.common.persistence.IdOverrideTableGenerator&quot;,
 171          parameters = {
 172              @Parameter(name = &quot;segment_value&quot;, value = &quot;SkuImpl&quot;),
 173              @Parameter(name = &quot;entity_name&quot;, value = &quot;org.broadleafcommerce.core.catalog.domain.SkuImpl&quot;)
 174          }
 175      )
 176      @Column(name = &quot;SKU_ID&quot;)
 177      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_ID&quot;, visibility = VisibilityEnum.HIDDEN_ALL)
 178      protected Long id;
 179  
 180      @Column(name = &quot;EXTERNAL_ID&quot;)
 181      @Index(name=&quot;SKU_EXTERNAL_ID_INDEX&quot;, columnNames={&quot;EXTERNAL_ID&quot;})
 182      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_ExternalID&quot;,
 183          group = GroupName.Miscellaneous, order = FieldOrder.EXTERNAL_ID,
 184          tooltip = &quot;SkuImpl_Sku_ExternalID_Tooltip&quot;)
 185      protected String externalId;
 186  
 187      @Column(name = &quot;URL_KEY&quot;)
 188      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_UrlKey&quot;,
 189          group = GroupName.Advanced, order = 4000,
 190          excluded = true)
 191      protected String urlKey;
 192  
 193      @Column(name = &quot;DISPLAY_TEMPLATE&quot;)
 194      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Display_Template&quot;,
 195          group = GroupName.Advanced, order = 5000,
 196          excluded = true)
 197      protected String displayTemplate;
 198  
 199      @Column(name = &quot;UPC&quot;)
 200      @Index(name = &quot;SKU_UPC_INDEX&quot;, columnNames = { &quot;UPC&quot; })
 201      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_UPC&quot;,
 202              group = GroupName.Miscellaneous, order = FieldOrder.UPC)
 203      protected String upc;
 204  
 205      @Column(name = &quot;SALE_PRICE&quot;, precision = 19, scale = 5)
 206      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Sale_Price&quot;,
 207          group = GroupName.Price, order = FieldOrder.SALE_PRICE,
 208          tooltip = &quot;SkuImpl_Sku_Sale_Price_tooltip&quot;,
 209          prominent = true, gridOrder = 6,
 210          fieldType = SupportedFieldType.MONEY)
 211      protected BigDecimal salePrice;
 212  
 213      @Column(name = &quot;RETAIL_PRICE&quot;, precision = 19, scale = 5)
 214      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Retail_Price&quot;,
 215          group = GroupName.Price, order = FieldOrder.RETAIL_PRICE,
 216          prominent = true, gridOrder = 5,
 217          fieldType = SupportedFieldType.MONEY)
 218      protected BigDecimal retailPrice;
 219  
 220      @Column(name = &quot;COST&quot;, precision = 19, scale = 5)
 221      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Cost&quot;,
 222              group = GroupName.Price, order = FieldOrder.COST,
 223              fieldType = SupportedFieldType.MONEY)
 224      protected BigDecimal cost;
 225  
 226      @Column(name = &quot;NAME&quot;)
 227      @Index(name = &quot;SKU_NAME_INDEX&quot;, columnNames = {&quot;NAME&quot;})
 228      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Name&quot;,
 229          group = GroupName.General, order = FieldOrder.NAME,
 230          prominent = true, gridOrder = 1, columnWidth = &quot;260px&quot;,
 231          translatable = true)
 232      protected String name;
 233  
 234      @Column(name = &quot;DESCRIPTION&quot;)
 235      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Description&quot;,
 236          group = GroupName.General, order = FieldOrder.SHORT_DESCRIPTION,
 237          largeEntry = true,
 238          excluded = true,
 239          translatable = true)
 240      protected String description;
 241  
 242      @Lob
 243      @Type(type = &quot;org.hibernate.type.MaterializedClobType&quot;)
 244      @Column(name = &quot;LONG_DESCRIPTION&quot;, length = Integer.MAX_VALUE - 1)
 245      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Large_Description&quot;,
 246          group = GroupName.General, order = FieldOrder.LONG_DESCRIPTION,
 247          largeEntry = true,
 248          fieldType = SupportedFieldType.HTML_BASIC,
 249          translatable = true)
 250      protected String longDescription;
 251  
 252      @Column(name = &quot;TAX_CODE&quot;)
 253      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_TaxCode&quot;, order = 1001, group = GroupName.Financial)
<abbr title=" 254      @AdminPresentationDataDrivenEnumeration(optionCanEditValues = true, optionHideIfEmpty = true, optionFilterParams = { @OptionFilterParam("> 254      @AdminPresentationDataDrivenEnumeration(optionCanEditValues = true, optionHideIfEmpty = true, optionFilterParaðŸ”µ</abbr>
 255              param = &quot;type.key&quot;, value = &quot;TAX_CODE&quot;, paramType = OptionFilterParamType.STRING) })
 256      protected String taxCode;
 257  
 258      @Column(name = &quot;TAXABLE_FLAG&quot;)
 259      @Index(name=&quot;SKU_TAXABLE_INDEX&quot;, columnNames={&quot;TAXABLE_FLAG&quot;})
 260      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Taxable&quot;,
 261              group = GroupName.Financial, order = FieldOrder.TAXABLE)
 262      protected Character taxable;
 263  
 264      @Column(name = &quot;DISCOUNTABLE_FLAG&quot;)
 265      @Index(name=&quot;SKU_DISCOUNTABLE_INDEX&quot;, columnNames={&quot;DISCOUNTABLE_FLAG&quot;})
 266      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Discountable&quot;,
 267          group = GroupName.Discountable,
 268          helpText = &quot;SkuImpl_Sku_Discountable_helptext&quot;,
 269          defaultValue = &quot;Y&quot;)
 270      protected Character discountable;
 271  
 272      @Column(name = &quot;AVAILABLE_FLAG&quot;)
 273      @Index(name = &quot;SKU_AVAILABLE_INDEX&quot;, columnNames = {&quot;AVAILABLE_FLAG&quot;})
 274      @AdminPresentation(excluded = true)
 275      @Deprecated
 276      protected Character available;
 277  
 278      @Column(name = &quot;ACTIVE_START_DATE&quot;)
 279      @Index(name=&quot;SKU_ACTIVE_START_INDEX&quot;)
 280      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Start_Date&quot;,
 281          group = GroupName.ActiveDateRange, order = FieldOrder.ACTIVE_START_DATE,
 282          tooltip = &quot;skuStartDateTooltip&quot;,
 283          defaultValue = &quot;today&quot;)
 284      protected Date activeStartDate;
 285  
 286      @Column(name = &quot;ACTIVE_END_DATE&quot;)
 287      @Index(name=&quot;SKU_ACTIVE_END_INDEX&quot;)
 288      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_End_Date&quot;,
 289          group = GroupName.ActiveDateRange, order = FieldOrder.ACTIVE_END_DATE,
 290          tooltip = &quot;skuEndDateTooltip&quot;,
 291          validationConfigurations = {
 292              @ValidationConfiguration(
 293                  validationImplementation = &quot;blAfterStartDateValidator&quot;,
 294                  configurationItems = {
 295                          @ConfigurationItem(itemName = &quot;otherField&quot;, itemValue = &quot;activeStartDate&quot;)
 296                  })
 297          })
 298      protected Date activeEndDate;
 299  
 300      @Embedded
 301      protected Dimension dimension = new Dimension();
 302  
 303      @Embedded
 304      protected Weight weight = new Weight();
 305  
 306      @Column(name = &quot;IS_MACHINE_SORTABLE&quot;)
 307      @AdminPresentation(friendlyName = &quot;ProductImpl_Is_Product_Machine_Sortable&quot;,
 308          group = GroupName.ShippingOther, order = FieldOrder.IS_MACHINE_SORTABLE,
 309          defaultValue = &quot;false&quot;)
 310      protected Boolean isMachineSortable;
 311  
<abbr title=" 312      @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuMediaXrefImpl.class, cascade = { CascadeType.ALL }, orphanRemoval = true)"> 312      @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuMediaXrefImpl.class, cascade = { CascadeType.ALL }, orphanRemovðŸ”µ</abbr>

 313      @MapKey(name = &quot;key&quot;)
 314      @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 315      @BatchSize(size = 50)
 316      @AdminPresentationMap(friendlyName = &quot;SkuImpl_Sku_Media&quot;,
 317          tab = TabName.Media,
 318          keyPropertyFriendlyName = &quot;SkuImpl_Sku_Media_Key&quot;,
 319          deleteEntityUponRemove = true,
 320          mediaField = &quot;media.url&quot;,
 321          toOneTargetProperty = &quot;media&quot;,
 322          toOneParentProperty = &quot;sku&quot;,
 323          forceFreeFormKeys = true
 324      )
 325      @AdminPresentationMapFields(
 326          mapDisplayFields = {
 327              @AdminPresentationMapField(
 328                      fieldName = &quot;primary&quot;,
 329                      fieldPresentation = @AdminPresentation(fieldType = SupportedFieldType.MEDIA,
 330                              group = GroupName.Image,
 331                              order = FieldOrder.PRIMARY_MEDIA,
 332                              friendlyName = &quot;SkuImpl_Primary_Media&quot;)
 333              )
 334      })
 335      protected Map&lt;String, SkuMediaXref&gt; skuMedia = new HashMap&lt;String, SkuMediaXref&gt;();
 336  
 337      @Transient
 338      protected Map&lt;String, Media&gt; legacySkuMedia = new HashMap&lt;String, Media&gt;();
 339  
 340      /**
 341       * This will be non-null if and only if this Sku is the default Sku for a Product
 342       */
 343      @OneToOne(optional = true, targetEntity = ProductImpl.class, cascade = {CascadeType.ALL})
 344      @Cascade(value = {org.hibernate.annotations.CascadeType.ALL})
 345      @JoinColumn(name = &quot;DEFAULT_PRODUCT_ID&quot;)
 346      @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 347      @IgnoreEnterpriseBehavior
 348      protected Product defaultProduct;
 349  
 350      /**
 351       * This relationship will be non-null if and only if this Sku is contained in the list of
 352       * additional Skus for a Product (for Skus based on ProductOptions)
 353       */
<abbr title=" 354      @ManyToOne(optional = true, targetEntity = ProductImpl.class, cascade = {CascadeType.PERSIST, CascadeType.MERGE, CascadeType.REFRESH})"> 354      @ManyToOne(optional = true, targetEntity = ProductImpl.class, cascade = {CascadeType.PERSIST, CascadeType.MERGðŸ”µ</abbr>
 355      @JoinColumn(name = &quot;ADDL_PRODUCT_ID&quot;)
 356      protected Product product;
 357  
<abbr title=" 358      @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL }, orphanRemoval = true)"> 358      @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL }, orphanRemovðŸ”µ</abbr>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 359 -    @Cache(usage=CacheConcurrencyStrategy.NONSTRICT_READ_WRITE, region=&quot;blProducts&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +    @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)</span>
 361      @BatchSize(size = 50)
 362      @AdminPresentationCollection(friendlyName = &quot;skuAttributesTitle&quot;,
 363              tab = TabName.Advanced, order = 1000)
 364      protected List&lt;SkuAttribute&gt; skuAttributes = new ArrayList&lt;SkuAttribute&gt;();
 365  
 366      @OneToMany(targetEntity = SkuProductOptionValueXrefImpl.class, cascade = CascadeType.ALL, mappedBy = &quot;sku&quot;)
 367      @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 368      @BatchSize(size = 50)
 369      @ClonePolicyCollectionOverride
 370      @ClonePolicyArchive
 371      //Use a Set instead of a List - see https://github.com/BroadleafCommerce/BroadleafCommerce/issues/917
 372      protected Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs = new HashSet&lt;SkuProductOptionValueXref&gt;();
 373  
 374      @Transient
 375      protected Set&lt;ProductOptionValue&gt; legacyProductOptionValues = new HashSet&lt;ProductOptionValue&gt;();
 376  
 377      @ManyToMany(fetch = FetchType.LAZY, targetEntity = SkuFeeImpl.class)
 378      @JoinTable(name = &quot;BLC_SKU_FEE_XREF&quot;,
 379              joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;, nullable = true),
<abbr title=" 380              inverseJoinColumns = @JoinColumn(name = &quot;SKU_FEE_ID&quot;, referencedColumnName = &quot;SKU_FEE_ID&quot;, nullable = true))"> 380              inverseJoinColumns = @JoinColumn(name = &quot;SKU_FEE_ID&quot;, referencedColumnName = &quot;SKU_FEE_ID&quot;, nullable = ðŸ”µ</abbr>
 381      @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 382      @BatchSize(size = 50)
 383      protected List&lt;SkuFee&gt; fees = new ArrayList&lt;SkuFee&gt;();
 384  
 385      @ElementCollection
 386      @CollectionTable(name = &quot;BLC_SKU_FULFILLMENT_FLAT_RATES&quot;,
 387          joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;, nullable = true))
 388      @MapKeyJoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;, referencedColumnName = &quot;FULFILLMENT_OPTION_ID&quot;)
 389      @MapKeyClass(FulfillmentOptionImpl.class)
 390      @Column(name = &quot;RATE&quot;, precision = 19, scale = 5)
 391      @Cascade(org.hibernate.annotations.CascadeType.ALL)
 392      @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 393      @BatchSize(size = 50)
<abbr title=" 394      protected Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates = new HashMap&lt;FulfillmentOption, BigDecimal&gt;();"> 394      protected Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates = new HashMap&lt;FulfillmentOption, BigDecimal&gt;ðŸ”µ</abbr>
 395  
 396      @ManyToMany(targetEntity = FulfillmentOptionImpl.class)
 397      @JoinTable(name = &quot;BLC_SKU_FULFILLMENT_EXCLUDED&quot;,
 398              joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;),
<abbr title=" 399              inverseJoinColumns = @JoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;,referencedColumnName = &quot;FULFILLMENT_OPTION_ID&quot;))"> 399              inverseJoinColumns = @JoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;,referencedColumnName = &quot;FULFILLMENT_OPðŸ”µ</abbr>
 400      @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 401      @BatchSize(size = 50)
 402      protected List&lt;FulfillmentOption&gt; excludedFulfillmentOptions = new ArrayList&lt;FulfillmentOption&gt;();
 403  
 404      @Column(name = &quot;INVENTORY_TYPE&quot;)
 405      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_InventoryType&quot;,
 406          group = GroupName.Inventory, order = 1000,
 407          helpText = &quot;skuInventoryTypeHelpText&quot;,
 408          fieldType = SupportedFieldType.BROADLEAF_ENUMERATION,
 409          broadleafEnumeration = &quot;org.broadleafcommerce.core.inventory.service.type.InventoryType&quot;,
 410          columnWidth = &quot;180px&quot;, prominent = true)
 411      protected String inventoryType;
 412  
 413      @Column(name = &quot;QUANTITY_AVAILABLE&quot;)
 414      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_QuantityAvailable&quot;,
 415              group = GroupName.Inventory, order = 1010)
 416      protected Integer quantityAvailable = 0;
 417  
 418      @Column(name = &quot;FULFILLMENT_TYPE&quot;)
 419      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_FulfillmentType&quot;,
 420          group = GroupName.ShippingFulfillment, order = FieldOrder.FULFILLMENT_TYPE,
 421          fieldType = SupportedFieldType.BROADLEAF_ENUMERATION,
 422          broadleafEnumeration = &quot;org.broadleafcommerce.core.order.service.type.FulfillmentType&quot;)
 423      protected String fulfillmentType;
 424  
 425      /**
<abbr title=" 426       * Note that this field is not the target of the currencyCodeField attribute on either retailPrice or salePrice."> 426       * Note that this field is not the target of the currencyCodeField attribute on either retailPrice or salePricðŸ”µ</abbr>
<abbr title=" 427       * This is because SKUs are special in that we want to return the currency on this SKU if there is one, falling back"> 427       * This is because SKUs are special in that we want to return the currency on this SKU if there is one, fallinðŸ”µ</abbr>
 428       * to the defaultSku&#x27;s currency if possible.
 429       *
 430       * Normally null and hidden.  Use Meta-Data overrides to display in the admin.
 431       * @see Sku#getCurrency() for further cautions about using this field.
 432       */
 433      @ManyToOne(targetEntity = BroadleafCurrencyImpl.class)

 434      @JoinColumn(name = &quot;CURRENCY_CODE&quot;)
 435      @AdminPresentation(friendlyName = &quot;SkuImpl_Currency&quot;,
 436              group = GroupName.Advanced, order = 3000,
 437              visibility = VisibilityEnum.HIDDEN_ALL)
 438      @AdminPresentationToOneLookup(lookupType = LookupType.DROPDOWN, lookupDisplayProperty = &quot;friendlyName&quot;)
 439      protected BroadleafCurrency currency;
 440  
 441      @Override
 442      public Long getId() {
 443          return id;
 444      }
 445  
 446      @Override
 447      public void setId(Long id) {
 448          this.id = id;
 449      }
 450  
 451      @Override
 452      public String getUrlKey() {
 453          return urlKey;
 454      }
 455  
 456      @Override
 457      public void setUrlKey(String urlKey) {
 458          this.urlKey = urlKey;
 459      }
 460  
 461      @Override
 462      public String getDisplayTemplate() {
 463          return displayTemplate;
 464      }
 465  
 466      @Override
 467      public void setDisplayTemplate(String displayTemplate) {
 468          this.displayTemplate = displayTemplate;
 469      }
 470  
 471      @Override
 472      public boolean isOnSale() {
 473          Money retailPrice = getRetailPrice();
 474          Money salePrice = getSalePrice();
 475          return (salePrice != null &amp;&amp; !salePrice.isZero() &amp;&amp; salePrice.lessThan(retailPrice));
 476      }
 477  
 478      protected boolean hasDefaultSku() {
<abbr title=" 479          return (product != null &amp;&amp; product.getDefaultSku() != null &amp;&amp; getId() != null &amp;&amp; !getId().equals(product.getDefaultSku().getId()));"> 479          return (product != null &amp;&amp; product.getDefaultSku() != null &amp;&amp; getId() != null &amp;&amp; !getId().equals(product.gðŸ”µ</abbr>
 480      }
 481  
 482      protected Sku lookupDefaultSku() {
 483          if (product != null &amp;&amp; product.getDefaultSku() != null) {
 484              return product.getDefaultSku();
 485          } else {
 486              return null;
 487          }
 488      }
 489  
 490      @Override
 491      public Money getProductOptionValueAdjustments() {
 492          Money optionValuePriceAdjustments = null;
 493          if (getProductOptionValues() != null) {
 494              for (ProductOptionValue value : getProductOptionValues()) {
 495                  if (value.getPriceAdjustment() != null) {
 496                      if (optionValuePriceAdjustments == null) {
 497                          optionValuePriceAdjustments = value.getPriceAdjustment();
 498                      } else {
 499                          optionValuePriceAdjustments = optionValuePriceAdjustments.add(value.getPriceAdjustment());
 500                      }
 501                  }
 502              }
 503          }
 504          return optionValuePriceAdjustments;
 505      }
 506  
 507      @Override
 508      public Money getSalePrice() {
 509          Money returnPrice = null;
 510          Money optionValueAdjustments = null;
 511  
 512          if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 513              // We have dynamic pricing, so we will pull the sale price from there
 514              DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 515              returnPrice = dynamicPrices.getSalePrice();
 516              optionValueAdjustments = dynamicPrices.getPriceAdjustment();
 517              if (SkuPricingConsiderationContext.isPricingConsiderationActive()) {
 518                  return returnPrice;
 519              }
 520          } else if (salePrice != null) {
 521              // We have an explicitly set sale price directly on this entity. We will not apply any adjustments
 522              returnPrice = new Money(salePrice, getCurrency());
 523          }
 524  
 525          if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 526              returnPrice = lookupDefaultSku().getSalePrice();
 527              optionValueAdjustments = getProductOptionValueAdjustments();
 528          }
 529  
 530          if (returnPrice == null) {
 531              return null;
 532          }
 533  
 534          if (optionValueAdjustments != null) {
 535              returnPrice = returnPrice.add(optionValueAdjustments);
 536          }
 537  
 538          return returnPrice;
 539      }
 540  
 541      @Override
 542      public boolean hasSalePrice() {
 543          return getSalePrice() != null;
 544      }
 545  
 546      @Override
 547      public void setSalePrice(Money salePrice) {
 548          this.salePrice = Money.toAmount(salePrice);
 549      }
 550  
 551      @Override
 552      public Money getRetailPrice() {
 553          return getRetailPriceInternal();
 554      }
 555  
 556      /*
<abbr title=" 557       * This allows us a way to determine or calculate the retail price. If one is not available this method will return null."> 557       * This allows us a way to determine or calculate the retail price. If one is not available this method will rðŸ”µ</abbr>
<abbr title=" 558       * This allows the call to hasRetailPrice() to determine if there is a retail price without the overhead of an exception."> 558       * This allows the call to hasRetailPrice() to determine if there is a retail price without the overhead of anðŸ”µ</abbr>
 559       */
 560      protected Money getRetailPriceInternal() {
 561          Money returnPrice = null;
 562          Money optionValueAdjustments = null;
 563  
 564          if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 565              // We have dynamic pricing, so we will pull the retail price from there
 566              DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 567              returnPrice = dynamicPrices.getRetailPrice();
 568              optionValueAdjustments = dynamicPrices.getPriceAdjustment();
 569              if (SkuPricingConsiderationContext.isPricingConsiderationActive()) {
 570                  return returnPrice;
 571              }
 572          } else if (retailPrice != null) {
 573              returnPrice = new Money(retailPrice, getCurrency());
 574          }
 575  
 576          if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 577              // Otherwise, we&#x27;ll pull the retail price from the default sku
 578              returnPrice = lookupDefaultSku().getRetailPrice();
 579              optionValueAdjustments = getProductOptionValueAdjustments();
 580          }
 581  
 582          if (returnPrice != null &amp;&amp; optionValueAdjustments != null) {
 583              returnPrice = returnPrice.add(optionValueAdjustments);
 584          }
 585  
 586          return returnPrice;
 587      }
 588  
 589      @Override
 590      public Money getBaseRetailPrice() {
 591          Money returnPrice = null;
 592          if (retailPrice != null) {
 593              returnPrice = new Money(retailPrice, getCurrency());
 594          }
 595          if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 596              Sku defaultSku = lookupDefaultSku();
 597              returnPrice = defaultSku.getBaseRetailPrice();
 598          }
 599          return returnPrice;
 600      }
 601  
 602      @Override
 603      public Money getBaseSalePrice() {
 604          Money returnPrice = null;
 605          if (salePrice != null) {
 606              returnPrice = new Money(salePrice, getCurrency());
 607          }
 608          if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 609              Sku defaultSku = lookupDefaultSku();
 610              returnPrice = defaultSku.getBaseSalePrice();
 611          }
 612          return returnPrice;
 613      }
 614  
 615      @Override
 616      public DynamicSkuPrices getPriceData() {
 617          if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 618              DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 619              return dynamicPrices;
 620          } else {
 621              DynamicSkuPrices dsp = new DynamicSkuPrices();
 622              BroadleafCurrency tmpCurrency;
 623              if (currency != null) {
 624                  tmpCurrency = currency;
 625              } else {
 626                  tmpCurrency = BroadleafRequestContext.getCurrency();
 627              }
 628              if (retailPrice != null) {
 629                  dsp.setRetailPrice(new Money(retailPrice, tmpCurrency));
 630              }
 631              if (salePrice != null) {
 632                  dsp.setSalePrice(new Money(salePrice, tmpCurrency));
 633              }
 634              return dsp;
 635          }
 636      }
 637  
 638      @Override
 639      public boolean hasRetailPrice() {
 640          return getRetailPriceInternal() != null;
 641      }
 642  
 643      @Override
 644      public void setRetailPrice(Money retailPrice) {
 645          this.retailPrice = Money.toAmount(retailPrice);
 646      }
 647  
 648      @Override
 649      public Money getPrice() {
 650          return isOnSale() ? getSalePrice() : getRetailPrice();
 651      }
 652  
 653      @Override
 654      @Deprecated
 655      public Money getListPrice() {
 656          return getRetailPrice();
 657      }
 658  
 659      @Override
 660      @Deprecated
 661      public void setListPrice(Money listPrice) {
 662          this.retailPrice = Money.toAmount(listPrice);
 663      }
 664  
 665      @Override
 666      public Money getCost() {
 667          if (cost == null &amp;&amp; hasDefaultSku()) {
 668              return lookupDefaultSku().getCost();
 669          }
 670  
 671          if (cost == null) {
 672              return null;
 673          }
 674  
 675          return new Money(cost, getCurrency());
 676      }
 677  
 678      @Override
 679      public void setCost(Money cost) {
 680          this.cost = cost.getAmount();
 681      }
 682  
 683      @Override
 684      public Money getMargin() {
 685          Money margin = null;
 686          Money price = getPrice();
 687          Money purchaseCost = getCost();
 688  
 689          if (price == null &amp;&amp; hasDefaultSku()) {
 690              price = lookupDefaultSku().getPrice();
 691          }
 692  
 693          if (purchaseCost == null &amp;&amp; hasDefaultSku()) {
 694              purchaseCost = lookupDefaultSku().getCost();
 695          }
 696  
 697          if (price != null &amp;&amp; !price.getAmount().equals(BigDecimal.ZERO)) {
 698              if (purchaseCost != null) {
 699                  margin = price.subtract(purchaseCost).divide(price.getAmount());
 700              }
 701          } else {
 702              margin = Money.ZERO;
 703          }
 704  
 705          return margin;
 706      }
 707  
 708      @Override
 709      public String getName() {
 710          if (name == null &amp;&amp; hasDefaultSku()) {
 711              return lookupDefaultSku().getName();
 712          }
 713  
 714          return DynamicTranslationProvider.getValue(this, &quot;name&quot;, name);
 715      }
 716  
 717      @Override
 718      public void setName(String name) {
 719          this.name = name;
 720      }
 721  
 722      @Override
 723      public String getDescription() {
 724          if (description == null &amp;&amp; hasDefaultSku()) {
 725              return lookupDefaultSku().getDescription();
 726          }
 727  
 728          return DynamicTranslationProvider.getValue(this, &quot;description&quot;, description);
 729      }
 730  
 731      @Override
 732      public void setDescription(String description) {
 733          this.description = description;
 734      }
 735  
 736      @Override
 737      public String getLongDescription() {
 738          if (longDescription == null &amp;&amp; hasDefaultSku()) {
 739              return lookupDefaultSku().getLongDescription();
 740          }
 741  
 742          return DynamicTranslationProvider.getValue(this, &quot;longDescription&quot;, longDescription);
 743      }
 744  
 745      @Override
 746      public void setLongDescription(String longDescription) {
 747          this.longDescription = longDescription;
 748      }
 749  
 750      @Override
 751      public Boolean isTaxable() {
 752          if (taxable == null) {
 753              if (hasDefaultSku()) {
 754                  return lookupDefaultSku().isTaxable();
 755              }
 756              return null;
 757          }
 758          return taxable == &#x27;Y&#x27; ? Boolean.TRUE : Boolean.FALSE;
 759      }
 760  
 761      @Override
 762      public Boolean getTaxable() {
 763          return isTaxable();
 764      }
 765  
 766      @Override
 767      public void setTaxable(Boolean taxable) {
 768          if (taxable == null) {
 769              this.taxable = null;
 770          } else {
 771              this.taxable = taxable ? &#x27;Y&#x27; : &#x27;N&#x27;;
 772          }
 773      }
 774  
 775      @Override
 776      public Boolean isDiscountable() {
 777          if (discountable == null) {
 778              if (hasDefaultSku()) {
 779                  return lookupDefaultSku().isDiscountable();
 780              }
 781              return Boolean.FALSE;
 782          }
 783          return discountable == &#x27;Y&#x27; ? Boolean.TRUE : Boolean.FALSE;
 784      }
 785  
 786      /*
 787       * This is to facilitate serialization to non-Java clients
 788       */
 789      public Boolean getDiscountable() {
 790          return isDiscountable();
 791      }
 792  
 793      @Override
 794      public void setDiscountable(Boolean discountable) {
 795          if (discountable == null) {
 796              this.discountable = null;
 797          } else {
 798              this.discountable = discountable ? &#x27;Y&#x27; : &#x27;N&#x27;;
 799          }
 800      }
 801  
 802      @Override
 803      public Boolean isAvailable() {
 804          if (InventoryType.UNAVAILABLE.equals(getInventoryType())) {
 805              return false;
 806          }
 807  
 808          if (available == null) {
 809              if (hasDefaultSku()) {
 810                  return lookupDefaultSku().isAvailable();
 811              }
 812              return true;
 813          }
 814          return available != &#x27;N&#x27;;
 815      }
 816  
 817      @Override
 818      public Boolean getAvailable() {
 819          return isAvailable();
 820      }
 821  
 822      @Override
 823      public void setAvailable(Boolean available) {
 824          if (available == null) {
 825              this.available = null;
 826          } else {
 827              this.available = available ? &#x27;Y&#x27; : &#x27;N&#x27;;
 828          }
 829      }
 830  
 831      @Override
 832      public Date getActiveStartDate() {
 833          Date returnDate = null;
 834          if (SkuActiveDateConsiderationContext.hasDynamicActiveDates()) {
<abbr title=" 835              returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveStartDate(this);"> 835              returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveStartDateðŸ”µ</abbr>
 836          }
 837  
 838          if (returnDate == null) {
 839              if (activeStartDate == null &amp;&amp; hasDefaultSku()) {
 840                  return lookupDefaultSku().getActiveStartDate();
 841              } else {
 842                  return activeStartDate;
 843              }
 844          } else {
 845              return returnDate;
 846          }
 847      }
 848  
 849      @Override
 850      public void setActiveStartDate(Date activeStartDate) {
 851          this.activeStartDate = activeStartDate;
 852      }
 853  
 854      @Override
 855      public Date getActiveEndDate() {
 856          Date returnDate = null;
 857          if (SkuActiveDateConsiderationContext.hasDynamicActiveDates()) {
<abbr title=" 858              returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveEndDate(this);"> 858              returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveEndDate(tðŸ”µ</abbr>
 859          }
 860  
 861          if (returnDate == null) {
 862              if (activeEndDate == null &amp;&amp; hasDefaultSku()) {
 863                  return lookupDefaultSku().getActiveEndDate();
 864              } else {
 865                  return activeEndDate;
 866              }
 867          } else {
 868              return returnDate;
 869          }
 870      }
 871  
 872      @Override
 873      public void setActiveEndDate(Date activeEndDate) {
 874          this.activeEndDate = activeEndDate;
 875      }
 876  
 877      @Override
 878      public Dimension getDimension() {
 879          if (dimension == null &amp;&amp; hasDefaultSku()) {
 880              return lookupDefaultSku().getDimension();
 881          } else {
 882              return dimension;
 883          }
 884      }
 885  
 886      @Override
 887      public void setDimension(Dimension dimension) {
 888          this.dimension = dimension;
 889      }
 890  
 891      @Override
 892      public Weight getWeight() {
 893          if (weight == null &amp;&amp; hasDefaultSku()) {
 894              return lookupDefaultSku().getWeight();
 895          } else {
 896              return weight;
 897          }
 898      }
 899  
 900      @Override
 901      public void setWeight(Weight weight) {
 902          this.weight = weight;
 903      }
 904  
 905      @Override
 906      public boolean isActive() {
 907          if (activeStartDate == null &amp;&amp; activeEndDate == null &amp;&amp; hasDefaultSku()) {
 908              return lookupDefaultSku().isActive();
 909          }
 910          if (LOG.isDebugEnabled()) {
 911              if (!DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true)) {
 912                  LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to date&quot;);
 913              }
 914          }
 915  
 916          if (!(getProduct() == null) &amp;&amp; !getProduct().isActive()) {
 917              return false;
 918          }
 919  
 920          return DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true);
 921      }
 922  
 923      @Override
 924      public boolean isActive(Product product, Category category) {
 925          if (LOG.isDebugEnabled()) {
 926              if (!DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true)) {
 927                  LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to date&quot;);
 928              } else if (!product.isActive()) {
 929                  LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to product being inactive&quot;);
 930              } else if (!category.isActive()) {
 931                  LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to category being inactive&quot;);
 932              }
 933          }
<abbr title=" 934          return this.isActive() &amp;&amp; (product == null || product.isActive()) &amp;&amp; (category == null || category.isActive());"> 934          return this.isActive() &amp;&amp; (product == null || product.isActive()) &amp;&amp; (category == null || category.isActivðŸ”µ</abbr>
 935      }
 936  
 937      @Override
 938      @Deprecated
 939      public Map&lt;String, Media&gt; getSkuMedia() {
 940          Map&lt;String, Media&gt; skuMediaMap = new LinkedHashMap&lt;&gt;(legacySkuMedia);
 941  
 942          if (MapUtils.isEmpty(skuMediaMap)) {
 943              for (Map.Entry&lt;String, SkuMediaXref&gt; entry : getSkuMediaXref().entrySet()) {
 944                  skuMediaMap.put(entry.getKey(), entry.getValue().getMedia());
 945              }
 946          }
 947  
 948          return Collections.unmodifiableMap(skuMediaMap);
 949      }
 950  
 951      @Override
 952      @Deprecated
 953      public void setSkuMedia(Map&lt;String, Media&gt; skuMedia) {
 954          this.skuMedia.clear();
 955          this.legacySkuMedia.clear();
 956          for(Map.Entry&lt;String, Media&gt; entry : skuMedia.entrySet()){
 957              this.skuMedia.put(entry.getKey(), new SkuMediaXrefImpl(this, entry.getValue(), entry.getKey()));
 958          }
 959      }
 960  
 961      @Override
 962      public Map&lt;String, SkuMediaXref&gt; getSkuMediaXref() {
 963          Map&lt;String, SkuMediaXref&gt; skuMediaMap = skuMedia;
 964  
 965          if (MapUtils.isEmpty(skuMediaMap)) {
 966              if (hasDefaultSku()) {
 967                  return lookupDefaultSku().getSkuMediaXref();
 968              }
 969          }
 970  
 971          if (isOrderedSkuMedia(skuMediaMap)) {
 972              skuMediaMap = sortSkuMedia(skuMediaMap);
 973          }
 974  
 975          return skuMediaMap;
 976      }
 977  
 978      @Override
 979      public Map&lt;String, SkuMediaXref&gt; getSkuMediaXrefIgnoreDefaultSku() {
 980          Map&lt;String, SkuMediaXref&gt; skuMediaMap = skuMedia;
 981  
 982          if (isOrderedSkuMedia(skuMediaMap)) {
 983              skuMediaMap = sortSkuMedia(skuMediaMap);
 984          }
 985  
 986          return skuMediaMap;
 987      }
 988  
 989      @Override
 990      public Media getPrimarySkuMedia() {
 991          Map&lt;String, SkuMediaXref&gt; skuMediaMap = getSkuMediaXrefIgnoreDefaultSku();
 992  
 993          if (MapUtils.isNotEmpty(skuMediaMap)) {
 994              if (isOrderedSkuMedia(skuMediaMap)) {
 995                  return skuMediaMap.values().stream()
 996                          .map(OrderedSkuMediaXref.class::cast)
 997                          .filter(OrderedSkuMediaXref::getShowInGallery)
 998                          .findFirst()
 999                          .map(SkuMediaXref.class::cast)
1000                          .map(SkuMediaXref::getMedia)
1001                          .orElse(null);
1002              } else {
1003                  SkuMediaXref primaryXref = skuMediaMap.get(&quot;primary&quot;);
1004  
1005                  return (primaryXref == null)? null : primaryXref.getMedia();
1006              }
1007          }
1008  
1009          return null;
1010      }
1011  
1012      @Override
1013      public void setSkuMediaXref(Map&lt;String, SkuMediaXref&gt; skuMediaXref) {
1014          this.skuMedia = skuMediaXref;
1015      }
1016  
1017      protected boolean isOrderedSkuMedia(Map&lt;String, SkuMediaXref&gt; skuMedia) {
1018          return skuMedia.values().stream()
1019                  .anyMatch(OrderedSkuMediaXref.class::isInstance);
1020      }
1021  
1022      protected Map&lt;String, SkuMediaXref&gt; sortSkuMedia(Map&lt;String, SkuMediaXref&gt; skuMedia) {
1023          return skuMedia.values().stream()
1024                  .sorted(Comparator.comparing(xref -&gt; ((OrderedSkuMediaXref) xref).getDisplayOrder()))
1025                  .collect(Collectors.toMap(SkuMediaXref::getKey, Function.identity(),
<abbr title="1026                          (key1,key2) -&gt;{ throw new IllegalStateException(String.format(&quot;Duplicate key %s&quot;, key1)); },">1026                          (key1,key2) -&gt;{ throw new IllegalStateException(String.format(&quot;Duplicate key %s&quot;, key1)); ðŸ”µ</abbr>
1027                          LinkedHashMap::new));
1028      }
1029  
1030      @Override
1031      public Product getDefaultProduct() {
1032          return defaultProduct;
1033      }
1034  
1035      @Override
1036      public void setDefaultProduct(Product defaultProduct) {
1037          this.defaultProduct = defaultProduct;
1038      }
1039  
1040      @Override
1041      public Product getProduct() {
1042          return (getDefaultProduct() != null) ? getDefaultProduct() : this.product;
1043      }
1044  
1045      @Override
1046      public void setProduct(Product product) {
1047          this.product = product;
1048      }
1049  
1050      @Override
1051      public Set&lt;SkuProductOptionValueXref&gt; getProductOptionValueXrefs() {
1052          return productOptionValueXrefs;
1053      }
1054  
1055      @Override
1056      public void setProductOptionValueXrefs(Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs) {
1057          this.productOptionValueXrefs = productOptionValueXrefs;
1058      }
1059  
1060      @Override
1061      public Set&lt;ProductOptionValue&gt; getProductOptionValuesCollection() {
1062          if (legacyProductOptionValues.size() == 0) {
1063              for (SkuProductOptionValueXref xref : productOptionValueXrefs) {
1064                  legacyProductOptionValues.add(xref.getProductOptionValue());
1065              }
1066          }
1067          return Collections.unmodifiableSet(legacyProductOptionValues);
1068      }
1069  
1070      @Override
1071      public void setProductOptionValuesCollection(Set&lt;ProductOptionValue&gt; productOptionValues) {
1072          this.legacyProductOptionValues.clear();
1073          this.productOptionValueXrefs.clear();
1074          for (ProductOptionValue val : productOptionValues) {
1075              this.productOptionValueXrefs.add(new SkuProductOptionValueXrefImpl(this, val));
1076          }
1077      }
1078  
1079      @Override
1080      @Deprecated
1081      public List&lt;ProductOptionValue&gt; getProductOptionValues() {
<abbr title="1082          //Changing this API to Set is ill-advised (especially in a patch release). The tendrils are widespread. Instead">1082          //Changing this API to Set is ill-advised (especially in a patch release). The tendrils are widespread. InðŸ”µ</abbr>
1083          //we just migrate the call from the List to the internal Set representation. This is in response
1084          //to https://github.com/BroadleafCommerce/BroadleafCommerce/issues/917.
<abbr title="1085          return (List&lt;ProductOptionValue&gt;) Proxy.newProxyInstance(getClass().getClassLoader(), new Class&lt;?&gt;[]{List.class}, new InvocationHandler() {">1085          return (List&lt;ProductOptionValue&gt;) Proxy.newProxyInstance(getClass().getClassLoader(), new Class&lt;?&gt;[]{List.ðŸ”µ</abbr>
1086              @Override
1087              public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
<abbr title="1088                  return MethodUtils.invokeMethod(getProductOptionValuesCollection(), method.getName(), args, method.getParameterTypes());">1088                  return MethodUtils.invokeMethod(getProductOptionValuesCollection(), method.getName(), args, methodðŸ”µ</abbr>
1089              }
1090          });
1091      }
1092  
1093      @Override
1094      @Deprecated
1095      public void setProductOptionValues(List&lt;ProductOptionValue&gt; productOptionValues) {
1096          setProductOptionValuesCollection(new HashSet&lt;ProductOptionValue&gt;(productOptionValues));
1097      }
1098  
1099      @Override
1100      @Deprecated
1101      public Boolean isMachineSortable() {
1102          if (isMachineSortable == null &amp;&amp; hasDefaultSku()) {
1103              return lookupDefaultSku().isMachineSortable();
1104          }
1105          return isMachineSortable == null ? false : isMachineSortable;
1106      }
1107  
1108      @Override
1109      public Boolean getIsMachineSortable() {
1110          if (isMachineSortable == null &amp;&amp; hasDefaultSku()) {
1111              return lookupDefaultSku().getIsMachineSortable();
1112          }
1113          return isMachineSortable == null ? false : isMachineSortable;
1114      }
1115  
1116      @Override
1117      @Deprecated
1118      public void setMachineSortable(Boolean isMachineSortable) {
1119          this.isMachineSortable = isMachineSortable;
1120      }
1121  
1122      @Override
1123      public void setIsMachineSortable(Boolean isMachineSortable) {
1124          this.isMachineSortable = isMachineSortable;
1125      }
1126  
1127      @Override
1128      public List&lt;SkuFee&gt; getFees() {
1129          return fees;
1130      }
1131  
1132      @Override
1133      public void setFees(List&lt;SkuFee&gt; fees) {
1134          this.fees = fees;
1135      }
1136  
1137      @Override
1138      public Map&lt;FulfillmentOption, BigDecimal&gt; getFulfillmentFlatRates() {
1139          return fulfillmentFlatRates;
1140      }
1141  
1142      @Override
1143      public void setFulfillmentFlatRates(Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates) {
1144          this.fulfillmentFlatRates = fulfillmentFlatRates;
1145      }
1146  
1147      @Override
1148      public List&lt;FulfillmentOption&gt; getExcludedFulfillmentOptions() {
1149          return excludedFulfillmentOptions;
1150      }
1151  
1152      @Override
1153      public void setExcludedFulfillmentOptions(List&lt;FulfillmentOption&gt; excludedFulfillmentOptions) {
1154          this.excludedFulfillmentOptions = excludedFulfillmentOptions;
1155      }
1156  
1157      @Override
1158      public InventoryType getInventoryType() {
1159          if (StringUtils.isEmpty(this.inventoryType)) {
1160              if (hasDefaultSku() &amp;&amp; lookupDefaultSku().getInventoryType() != null) {
1161                  return lookupDefaultSku().getInventoryType();
1162              } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1163                  return getProduct().getDefaultCategory().getInventoryType();
1164              }
1165              return null;
1166          }
1167          return InventoryType.getInstance(this.inventoryType);
1168      }
1169  
1170      @Override
1171      public void setInventoryType(InventoryType inventoryType) {
1172          this.inventoryType = (inventoryType == null) ? null : inventoryType.getType();
1173      }
1174  
1175      @Override
1176      public Integer getQuantityAvailable() {
1177          return quantityAvailable;
1178      }
1179  
1180      @Override
1181      public void setQuantityAvailable(Integer quantityAvailable) {
1182          this.quantityAvailable = quantityAvailable;
1183      }
1184  
1185      @Override
1186      public FulfillmentType getFulfillmentType() {
1187          if (StringUtils.isEmpty(this.fulfillmentType)) {
1188              if (hasDefaultSku() &amp;&amp; lookupDefaultSku().getFulfillmentType() != null) {
1189                  return lookupDefaultSku().getFulfillmentType();
1190              } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1191                  return getProduct().getDefaultCategory().getFulfillmentType();
1192              }
1193              return null;
1194          }
1195          return FulfillmentType.getInstance(this.fulfillmentType);
1196      }
1197  
1198      @Override
1199      public void setFulfillmentType(FulfillmentType fulfillmentType) {
1200          if (fulfillmentType != null) {
1201              this.fulfillmentType = fulfillmentType.getType();
1202          }
1203      }
1204  
1205      @Override
1206      @Deprecated
1207      public Map&lt;String, SkuAttribute&gt; getSkuAttributes() {
1208          Map&lt;String, SkuAttribute&gt; attributeMap = new HashMap&lt;String, SkuAttribute&gt;();
1209  
1210          for (SkuAttribute skuAttribute : skuAttributes) {
1211              attributeMap.put(skuAttribute.getName(), skuAttribute);
1212          }
1213  
1214          return attributeMap;
1215      }
1216  
1217      @Override
1218      @SuppressWarnings(&quot;unchecked&quot;)
1219      public Map&lt;String, Collection&lt;SkuAttribute&gt;&gt; getMultiValueSkuAttributes() {
1220          MultiValueMap multiValueMap = new MultiValueMap();
1221  
1222          for (SkuAttribute skuAttribute : skuAttributes) {
1223              multiValueMap.put(skuAttribute.getName(), skuAttribute);
1224          }
1225  
1226          return multiValueMap;
1227      }
1228  
1229      @Override
1230      public void setSkuAttributes(Map&lt;String, SkuAttribute&gt; skuAttributes) {
1231          List&lt;SkuAttribute&gt; skuAttributeList = new ArrayList&lt;SkuAttribute&gt;();
1232  
1233          for(Map.Entry&lt;String, SkuAttribute&gt; entry : skuAttributes.entrySet()){
1234              skuAttributeList.add(entry.getValue());
1235          }
1236  
1237          this.skuAttributes = skuAttributeList;
1238      }
1239  
1240      @Override
1241      public BroadleafCurrency getCurrency() {
1242          if (currency == null &amp;&amp; hasDefaultSku()) {
1243              return lookupDefaultSku().getCurrency();
1244          } else {
1245              return currency;
1246          }
1247      }
1248  
1249      @Override
1250      public void setCurrency(BroadleafCurrency currency) {
1251          this.currency = currency;
1252      }
1253  
1254      @Override
1255      public void clearDynamicPrices() {
1256          SkuPricingConsiderationContext.removeFromThreadCache(getId());
1257      }
1258  
1259      @Override
1260      public boolean equals(Object obj) {
1261          if (this == obj) {
1262              return true;
1263          }
1264          if (obj == null) {
1265              return false;
1266          }
1267          if (!getClass().isAssignableFrom(obj.getClass())) {
1268              return false;
1269          }
1270          SkuImpl other = (SkuImpl) obj;
1271  
1272          if (id != null &amp;&amp; other.id != null) {
1273              return id.equals(other.id);
1274          }
1275  
1276          if (getName() == null) {
1277              if (other.getName() != null) {
1278                  return false;
1279              }
1280          } else if (!getName().equals(other.getName())) {
1281              return false;
1282          }
1283          return true;
1284      }
1285  
1286      @Override
1287      public int hashCode() {
1288          final int prime = 31;
1289          int result = 1;
1290          result = prime * result + ((name == null) ? 0 : name.hashCode());
1291          return result;
1292      }
1293  
1294      @Override
1295      public String getTaxCode() {
1296          if (StringUtils.isEmpty(this.taxCode)) {
1297              if (hasDefaultSku() &amp;&amp; !StringUtils.isEmpty(lookupDefaultSku().getTaxCode())) {
1298                  return lookupDefaultSku().getTaxCode();
1299              } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1300                  return getProduct().getDefaultCategory().getTaxCode();
1301              }
1302          }
1303          return this.taxCode;
1304      }
1305  
1306      @Override
1307      public void setTaxCode(String taxCode) {
1308          this.taxCode = taxCode;
1309      }
1310  
1311      @Override
1312      public String getExternalId() {
1313          return externalId;
1314      }
1315  
1316      @Override
1317      public void setExternalId(String externalId) {
1318          this.externalId = externalId;
1319      }
1320  
1321      @Override
1322      public String getUpc() {
1323          return upc;
1324      }
1325  
1326      @Override
1327      public void setUpc(String upc) {
1328          this.upc = upc;
1329      }
1330  
1331      @Override
1332      public FieldEntity getFieldEntityType() {
1333          return FieldEntity.SKU;
1334      }
1335  
1336      @Override
<abbr title="1337      public &lt;G extends Sku&gt; CreateResponse&lt;G&gt; createOrRetrieveCopyInstance(MultiTenantCopyContext context) throws CloneNotSupportedException {">1337      public &lt;G extends Sku&gt; CreateResponse&lt;G&gt; createOrRetrieveCopyInstance(MultiTenantCopyContext context) throws CðŸ”µ</abbr>
1338          CreateResponse&lt;G&gt; createResponse = context.createOrRetrieveCopyInstance(this);
1339          if (createResponse.isAlreadyPopulated()) {
1340              return createResponse;
1341          }
1342          Sku cloned = createResponse.getClone();
1343          cloned.setRetailPrice(getRetailPrice());
1344          cloned.setSalePrice(getSalePrice());
1345          cloned.setName(name);
1346          cloned.setActiveEndDate(activeEndDate);
1347          cloned.setActiveStartDate(activeStartDate);
1348          cloned.setCurrency(currency);
1349          cloned.setQuantityAvailable(quantityAvailable);
1350          cloned.setDescription(description);
1351          cloned.setDimension(dimension);
1352          cloned.setDiscountable(isDiscountable());
1353          cloned.setDisplayTemplate(displayTemplate);
1354          cloned.setExternalId(externalId);
1355          cloned.setTaxable(isTaxable());
1356          cloned.setTaxCode(taxCode);
1357          cloned.setUrlKey(urlKey);
1358          cloned.setInventoryType(getInventoryType());
1359          cloned.setFulfillmentType(getFulfillmentType());
1360          cloned.setIsMachineSortable(isMachineSortable);
1361          cloned.setLongDescription(longDescription);
1362          cloned.setUpc(upc);
1363          if (product != null) {
1364              cloned.setDefaultProduct(product.createOrRetrieveCopyInstance(context).getClone());
1365          }
1366          if (product != null) {
1367              cloned.setProduct(product.createOrRetrieveCopyInstance(context).getClone());
1368          }
1369          for(Map.Entry&lt;String, SkuAttribute&gt; entry : getSkuAttributes().entrySet()){
1370              SkuAttribute clonedEntry = entry.getValue().createOrRetrieveCopyInstance(context).getClone();
1371              cloned.getSkuAttributes().put(entry.getKey(),clonedEntry);
1372          }
1373          for(SkuProductOptionValueXref entry : productOptionValueXrefs){
1374              SkuProductOptionValueXref clonedEntry = entry.createOrRetrieveCopyInstance(context).getClone();
1375              cloned.getProductOptionValueXrefs().add(clonedEntry);
1376          }
1377          for(Map.Entry&lt;String, SkuMediaXref&gt; entry : skuMedia.entrySet()){
<abbr title="1378              SkuMediaXrefImpl clonedEntry = ((SkuMediaXrefImpl)entry.getValue()).createOrRetrieveCopyInstance(context).getClone();">1378              SkuMediaXrefImpl clonedEntry = ((SkuMediaXrefImpl)entry.getValue()).createOrRetrieveCopyInstance(conteðŸ”µ</abbr>
1379              cloned.getSkuMediaXrefIgnoreDefaultSku().put(entry.getKey(),clonedEntry);
1380          }
1381          for(FulfillmentOption entry : excludedFulfillmentOptions){
1382              FulfillmentOption clonedEntry = entry.createOrRetrieveCopyInstance(context).getClone();
1383              cloned.getExcludedFulfillmentOptions().add(clonedEntry);
1384          }
1385          for(Map.Entry&lt;FulfillmentOption, BigDecimal&gt; entry : fulfillmentFlatRates.entrySet()){
1386              FulfillmentOption clonedEntry = entry.getKey().createOrRetrieveCopyInstance(context).getClone();
1387              cloned.getFulfillmentFlatRates().put(clonedEntry,entry.getValue());
1388          }
1389  
1390          return  createResponse;
1391      }
1392  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.catalog.domain;
  19  
  20  import org.apache.commons.beanutils.MethodUtils;
  21  import org.apache.commons.collections.MapUtils;
  22  import org.apache.commons.collections.map.MultiValueMap;
  23  import org.apache.commons.lang.StringUtils;
  24  import org.apache.commons.logging.Log;
  25  import org.apache.commons.logging.LogFactory;
  26  import org.broadleafcommerce.common.copy.CreateResponse;
  27  import org.broadleafcommerce.common.copy.MultiTenantCopyContext;
  28  import org.broadleafcommerce.common.currency.domain.BroadleafCurrency;
  29  import org.broadleafcommerce.common.currency.domain.BroadleafCurrencyImpl;
  30  import org.broadleafcommerce.common.extensibility.jpa.clone.ClonePolicyArchive;
  31  import org.broadleafcommerce.common.extensibility.jpa.clone.ClonePolicyCollectionOverride;
  32  import org.broadleafcommerce.common.extensibility.jpa.clone.IgnoreEnterpriseBehavior;
  33  import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransform;
  34  import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransformMember;
  35  import org.broadleafcommerce.common.extensibility.jpa.copy.DirectCopyTransformTypes;
  36  import org.broadleafcommerce.common.i18n.service.DynamicTranslationProvider;
  37  import org.broadleafcommerce.common.media.domain.Media;
  38  import org.broadleafcommerce.common.money.Money;
  39  import org.broadleafcommerce.common.presentation.*;











  40  import org.broadleafcommerce.common.presentation.client.LookupType;
  41  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  42  import org.broadleafcommerce.common.presentation.client.VisibilityEnum;
  43  import org.broadleafcommerce.common.util.DateUtil;
  44  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  45  import org.broadleafcommerce.core.catalog.service.dynamic.DynamicSkuPrices;
  46  import org.broadleafcommerce.core.catalog.service.dynamic.SkuActiveDateConsiderationContext;
  47  import org.broadleafcommerce.core.catalog.service.dynamic.SkuPricingConsiderationContext;
  48  import org.broadleafcommerce.core.inventory.service.type.InventoryType;
  49  import org.broadleafcommerce.core.order.domain.FulfillmentOption;
  50  import org.broadleafcommerce.core.order.domain.FulfillmentOptionImpl;
  51  import org.broadleafcommerce.core.order.service.type.FulfillmentType;
  52  import org.broadleafcommerce.core.search.domain.FieldEntity;
  53  import org.hibernate.annotations.*;

  54  import org.hibernate.annotations.Cache;



  55  import org.hibernate.annotations.Index;
  56  import org.hibernate.annotations.Parameter;
  57  
  58  import javax.persistence.CascadeType;
  59  import javax.persistence.*;
  60  import javax.persistence.Entity;
  61  import javax.persistence.Table;


  62  import java.lang.reflect.InvocationHandler;
  63  import java.lang.reflect.Method;
  64  import java.lang.reflect.Proxy;
  65  import java.math.BigDecimal;
  66  import java.util.*;











  67  import java.util.function.Function;
  68  import java.util.stream.Collectors;
























  69  
  70  /**
  71   * The Class SkuImpl is the default implementation of {@link Sku}. A SKU is a
  72   * specific item that can be sold including any specific attributes of the item
  73   * such as color or size. &lt;br&gt;
  74   * &lt;br&gt;
  75   * If you want to add fields specific to your implementation of
  76   * BroadLeafCommerce you should extend this class and add your fields. If you
  77   * need to make significant changes to the SkuImpl then you should implement
  78   * your own version of {@link Sku}.&lt;br&gt;
  79   * &lt;br&gt;
  80   * This implementation uses a Hibernate implementation of JPA configured through
  81   * annotations. The Entity references the following tables: BLC_SKU,
  82   * BLC_SKU_IMAGE
  83   *
  84   * !!!!!!!!!!!!!!!!!
<abbr title="  85   * &lt;p&gt;For admin required field validation, if this Sku is apart of an additionalSkus list (meaning it is not a defaultSku) then">  85   * &lt;p&gt;For admin required field validation, if this Sku is apart of an additionalSkus list (meaning it is not a defðŸ”µ</abbr>
<abbr title="  86   * it should have no required restrictions on it. All additional Skus can delegate to the defaultSku of the related product">  86   * it should have no required restrictions on it. All additional Skus can delegate to the defaultSku of the relateðŸ”µ</abbr>
<abbr title="  87   * for all of its fields. For this reason, if you would like to mark more fields as required then rather than using">  87   * for all of its fields. For this reason, if you would like to mark more fields as required then rather than usinðŸ”µ</abbr>
<abbr title="  88   * {@link AdminPresentation#requiredOverride()}, use the mo:overrides section in bl-admin-applicationContext.xml for Product">  88   * {@link AdminPresentation#requiredOverride()}, use the mo:overrides section in bl-admin-applicationContext.xml fðŸ”µ</abbr>
  89   * and reference each required field like &#x27;defaultSku.name&#x27; or &#x27;defaultSku.retailPrice&#x27;.&lt;/p&gt;
  90   *
  91   * @author btaylor
  92   * @see {@link Sku}
  93   */
  94  @Entity
  95  @Inheritance(strategy = InheritanceType.JOINED)
  96  @Table(name = &quot;BLC_SKU&quot;)
<abbr title="  97  //multi-column indexes don&#x27;t appear to get exported correctly when declared at the field level, so declaring here as a workaround">  97  //multi-column indexes don&#x27;t appear to get exported correctly when declared at the field level, so declaring here ðŸ”µ</abbr>
  98  @org.hibernate.annotations.Table(appliesTo = &quot;BLC_SKU&quot;, indexes = {
  99      @Index(name = &quot;SKU_URL_KEY_INDEX&quot;,
 100          columnNames = { &quot;URL_KEY&quot; }
 101      )
 102  })
 103  @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 104  @DirectCopyTransform({
 105          @DirectCopyTransformMember(templateTokens = DirectCopyTransformTypes.SANDBOX, skipOverlaps=true),
 106          @DirectCopyTransformMember(templateTokens = DirectCopyTransformTypes.MULTITENANT_CATALOG)
 107  })
 108  public class SkuImpl implements Sku, SkuAdminPresentation {
 109  
 110      private static final Log LOG = LogFactory.getLog(SkuImpl.class);
 111  
 112      private static final long serialVersionUID = 1L;
 113  
 114      @Id
 115      @GeneratedValue(generator = &quot;SkuId&quot;)
 116      @GenericGenerator(
 117          name = &quot;SkuId&quot;,
 118          strategy = &quot;org.broadleafcommerce.common.persistence.IdOverrideTableGenerator&quot;,
 119          parameters = {
 120              @Parameter(name = &quot;segment_value&quot;, value = &quot;SkuImpl&quot;),
 121              @Parameter(name = &quot;entity_name&quot;, value = &quot;org.broadleafcommerce.core.catalog.domain.SkuImpl&quot;)
 122          }
 123      )
 124      @Column(name = &quot;SKU_ID&quot;)
 125      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_ID&quot;, visibility = VisibilityEnum.HIDDEN_ALL)
 126      protected Long id;
 127  
 128      @Column(name = &quot;EXTERNAL_ID&quot;)
 129      @Index(name=&quot;SKU_EXTERNAL_ID_INDEX&quot;, columnNames={&quot;EXTERNAL_ID&quot;})
 130      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_ExternalID&quot;,
 131          group = GroupName.Miscellaneous, order = FieldOrder.EXTERNAL_ID,
 132          tooltip = &quot;SkuImpl_Sku_ExternalID_Tooltip&quot;)
 133      protected String externalId;
 134  
 135      @Column(name = &quot;URL_KEY&quot;)
 136      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_UrlKey&quot;,
 137          group = GroupName.Advanced, order = 4000,
 138          excluded = true)
 139      protected String urlKey;
 140  
 141      @Column(name = &quot;DISPLAY_TEMPLATE&quot;)
 142      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Display_Template&quot;,
 143          group = GroupName.Advanced, order = 5000,
 144          excluded = true)
 145      protected String displayTemplate;
 146  
 147      @Column(name = &quot;UPC&quot;)
 148      @Index(name = &quot;SKU_UPC_INDEX&quot;, columnNames = { &quot;UPC&quot; })
 149      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_UPC&quot;,
 150              group = GroupName.Miscellaneous, order = FieldOrder.UPC)
 151      protected String upc;
 152  
 153      @Column(name = &quot;SALE_PRICE&quot;, precision = 19, scale = 5)
 154      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Sale_Price&quot;,
 155          group = GroupName.Price, order = FieldOrder.SALE_PRICE,
 156          tooltip = &quot;SkuImpl_Sku_Sale_Price_tooltip&quot;,
 157          prominent = true, gridOrder = 6,
 158          fieldType = SupportedFieldType.MONEY)
 159      protected BigDecimal salePrice;
 160  
 161      @Column(name = &quot;RETAIL_PRICE&quot;, precision = 19, scale = 5)
 162      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Retail_Price&quot;,
 163          group = GroupName.Price, order = FieldOrder.RETAIL_PRICE,
 164          prominent = true, gridOrder = 5,
 165          fieldType = SupportedFieldType.MONEY)
 166      protected BigDecimal retailPrice;
 167  
 168      @Column(name = &quot;COST&quot;, precision = 19, scale = 5)
 169      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Cost&quot;,
 170              group = GroupName.Price, order = FieldOrder.COST,
 171              fieldType = SupportedFieldType.MONEY)
 172      protected BigDecimal cost;
 173  
 174      @Column(name = &quot;NAME&quot;)
 175      @Index(name = &quot;SKU_NAME_INDEX&quot;, columnNames = {&quot;NAME&quot;})
 176      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Name&quot;,
 177          group = GroupName.General, order = FieldOrder.NAME,
 178          prominent = true, gridOrder = 1, columnWidth = &quot;260px&quot;,
 179          translatable = true)
 180      protected String name;
 181  
 182      @Column(name = &quot;DESCRIPTION&quot;)
 183      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Description&quot;,
 184          group = GroupName.General, order = FieldOrder.SHORT_DESCRIPTION,
 185          largeEntry = true,
 186          excluded = true,
 187          translatable = true)
 188      protected String description;
 189  
 190      @Lob
 191      @Type(type = &quot;org.hibernate.type.MaterializedClobType&quot;)
 192      @Column(name = &quot;LONG_DESCRIPTION&quot;, length = Integer.MAX_VALUE - 1)
 193      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Large_Description&quot;,
 194          group = GroupName.General, order = FieldOrder.LONG_DESCRIPTION,
 195          largeEntry = true,
 196          fieldType = SupportedFieldType.HTML_BASIC,
 197          translatable = true)
 198      protected String longDescription;
 199  
 200      @Column(name = &quot;TAX_CODE&quot;)
 201      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_TaxCode&quot;, order = 1001, group = GroupName.Financial)
<abbr title=" 202      @AdminPresentationDataDrivenEnumeration(optionCanEditValues = true, optionHideIfEmpty = true, optionFilterParams = { @OptionFilterParam("> 202      @AdminPresentationDataDrivenEnumeration(optionCanEditValues = true, optionHideIfEmpty = true, optionFilterParaðŸ”µ</abbr>
 203              param = &quot;type.key&quot;, value = &quot;TAX_CODE&quot;, paramType = OptionFilterParamType.STRING) })
 204      protected String taxCode;
 205  
 206      @Column(name = &quot;TAXABLE_FLAG&quot;)
 207      @Index(name=&quot;SKU_TAXABLE_INDEX&quot;, columnNames={&quot;TAXABLE_FLAG&quot;})
 208      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Taxable&quot;,
 209              group = GroupName.Financial, order = FieldOrder.TAXABLE)
 210      protected Character taxable;
 211  
 212      @Column(name = &quot;DISCOUNTABLE_FLAG&quot;)
 213      @Index(name=&quot;SKU_DISCOUNTABLE_INDEX&quot;, columnNames={&quot;DISCOUNTABLE_FLAG&quot;})
 214      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Discountable&quot;,
 215          group = GroupName.Discountable,
 216          helpText = &quot;SkuImpl_Sku_Discountable_helptext&quot;,
 217          defaultValue = &quot;Y&quot;)
 218      protected Character discountable;
 219  
 220      @Column(name = &quot;AVAILABLE_FLAG&quot;)
 221      @Index(name = &quot;SKU_AVAILABLE_INDEX&quot;, columnNames = {&quot;AVAILABLE_FLAG&quot;})
 222      @AdminPresentation(excluded = true)
 223      @Deprecated
 224      protected Character available;
 225  
 226      @Column(name = &quot;ACTIVE_START_DATE&quot;)
 227      @Index(name=&quot;SKU_ACTIVE_START_INDEX&quot;)
 228      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_Start_Date&quot;,
 229          group = GroupName.ActiveDateRange, order = FieldOrder.ACTIVE_START_DATE,
 230          tooltip = &quot;skuStartDateTooltip&quot;,
 231          defaultValue = &quot;today&quot;)
 232      protected Date activeStartDate;
 233  
 234      @Column(name = &quot;ACTIVE_END_DATE&quot;)
 235      @Index(name=&quot;SKU_ACTIVE_END_INDEX&quot;)
 236      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_End_Date&quot;,
 237          group = GroupName.ActiveDateRange, order = FieldOrder.ACTIVE_END_DATE,
 238          tooltip = &quot;skuEndDateTooltip&quot;,
 239          validationConfigurations = {
 240              @ValidationConfiguration(
 241                  validationImplementation = &quot;blAfterStartDateValidator&quot;,
 242                  configurationItems = {
 243                          @ConfigurationItem(itemName = &quot;otherField&quot;, itemValue = &quot;activeStartDate&quot;)
 244                  })
 245          })
 246      protected Date activeEndDate;
 247  
 248      @Embedded
 249      protected Dimension dimension = new Dimension();
 250  
 251      @Embedded
 252      protected Weight weight = new Weight();
 253  
 254      @Column(name = &quot;IS_MACHINE_SORTABLE&quot;)
 255      @AdminPresentation(friendlyName = &quot;ProductImpl_Is_Product_Machine_Sortable&quot;,
 256          group = GroupName.ShippingOther, order = FieldOrder.IS_MACHINE_SORTABLE,
 257          defaultValue = &quot;false&quot;)
 258      protected Boolean isMachineSortable;
 259  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 260 -    @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuMediaXrefImpl.class, cascade = { CascadeType.ALL }, orphanRemoval = true)"> 260 -    @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuMediaXrefImpl.class, cascade = { CascadeType.ALL }, orphanRemovðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +    @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuMediaXrefImpl.class, cascade = { CascadeType.ALL })</span>
 262      @MapKey(name = &quot;key&quot;)
 263      @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 264      @BatchSize(size = 50)
 265      @AdminPresentationMap(friendlyName = &quot;SkuImpl_Sku_Media&quot;,
 266          tab = TabName.Media,
 267          keyPropertyFriendlyName = &quot;SkuImpl_Sku_Media_Key&quot;,
 268          deleteEntityUponRemove = true,
 269          mediaField = &quot;media.url&quot;,
 270          toOneTargetProperty = &quot;media&quot;,
 271          toOneParentProperty = &quot;sku&quot;,
 272          forceFreeFormKeys = true
 273      )
 274      @AdminPresentationMapFields(
 275          mapDisplayFields = {
 276              @AdminPresentationMapField(
 277                      fieldName = &quot;primary&quot;,
 278                      fieldPresentation = @AdminPresentation(fieldType = SupportedFieldType.MEDIA,
 279                              group = GroupName.Image,
 280                              order = FieldOrder.PRIMARY_MEDIA,
 281                              friendlyName = &quot;SkuImpl_Primary_Media&quot;)
 282              )
 283      })
 284      protected Map&lt;String, SkuMediaXref&gt; skuMedia = new HashMap&lt;String, SkuMediaXref&gt;();
 285  
 286      @Transient
 287      protected Map&lt;String, Media&gt; legacySkuMedia = new HashMap&lt;String, Media&gt;();
 288  
 289      /**
 290       * This will be non-null if and only if this Sku is the default Sku for a Product
 291       */
 292      @OneToOne(optional = true, targetEntity = ProductImpl.class, cascade = {CascadeType.ALL})
 293      @Cascade(value = {org.hibernate.annotations.CascadeType.ALL})
 294      @JoinColumn(name = &quot;DEFAULT_PRODUCT_ID&quot;)
 295      @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 296      @IgnoreEnterpriseBehavior
 297      protected Product defaultProduct;
 298  
 299      /**
 300       * This relationship will be non-null if and only if this Sku is contained in the list of
 301       * additional Skus for a Product (for Skus based on ProductOptions)
 302       */
<abbr title=" 303      @ManyToOne(optional = true, targetEntity = ProductImpl.class, cascade = {CascadeType.PERSIST, CascadeType.MERGE, CascadeType.REFRESH})"> 303      @ManyToOne(optional = true, targetEntity = ProductImpl.class, cascade = {CascadeType.PERSIST, CascadeType.MERGðŸ”µ</abbr>
 304      @JoinColumn(name = &quot;ADDL_PRODUCT_ID&quot;)
 305      protected Product product;
 306  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 307 -    @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL }, orphanRemoval = true)"> 307 -    @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL }, orphanRemovðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +    @OneToMany(mappedBy = &quot;sku&quot;, targetEntity = SkuAttributeImpl.class, cascade = { CascadeType.ALL })</span>
 309      @Cache(usage=CacheConcurrencyStrategy.NONSTRICT_READ_WRITE, region=&quot;blProducts&quot;)

 310      @BatchSize(size = 50)
 311      @AdminPresentationCollection(friendlyName = &quot;skuAttributesTitle&quot;,
 312              tab = TabName.Advanced, order = 1000)
 313      protected List&lt;SkuAttribute&gt; skuAttributes = new ArrayList&lt;SkuAttribute&gt;();
 314  
 315      @OneToMany(targetEntity = SkuProductOptionValueXrefImpl.class, cascade = CascadeType.ALL, mappedBy = &quot;sku&quot;)
 316      @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 317      @BatchSize(size = 50)
 318      @ClonePolicyCollectionOverride
 319      @ClonePolicyArchive
 320      //Use a Set instead of a List - see https://github.com/BroadleafCommerce/BroadleafCommerce/issues/917
 321      protected Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs = new HashSet&lt;SkuProductOptionValueXref&gt;();
 322  
 323      @Transient
 324      protected Set&lt;ProductOptionValue&gt; legacyProductOptionValues = new HashSet&lt;ProductOptionValue&gt;();
 325  
 326      @ManyToMany(fetch = FetchType.LAZY, targetEntity = SkuFeeImpl.class)
 327      @JoinTable(name = &quot;BLC_SKU_FEE_XREF&quot;,
 328              joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;, nullable = true),
<abbr title=" 329              inverseJoinColumns = @JoinColumn(name = &quot;SKU_FEE_ID&quot;, referencedColumnName = &quot;SKU_FEE_ID&quot;, nullable = true))"> 329              inverseJoinColumns = @JoinColumn(name = &quot;SKU_FEE_ID&quot;, referencedColumnName = &quot;SKU_FEE_ID&quot;, nullable = ðŸ”µ</abbr>
 330      @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 331      @BatchSize(size = 50)
 332      protected List&lt;SkuFee&gt; fees = new ArrayList&lt;SkuFee&gt;();
 333  
 334      @ElementCollection
 335      @CollectionTable(name = &quot;BLC_SKU_FULFILLMENT_FLAT_RATES&quot;,
 336          joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;, nullable = true))
 337      @MapKeyJoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;, referencedColumnName = &quot;FULFILLMENT_OPTION_ID&quot;)
 338      @MapKeyClass(FulfillmentOptionImpl.class)
 339      @Column(name = &quot;RATE&quot;, precision = 19, scale = 5)
 340      @Cascade(org.hibernate.annotations.CascadeType.ALL)
 341      @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 342      @BatchSize(size = 50)
<abbr title=" 343      protected Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates = new HashMap&lt;FulfillmentOption, BigDecimal&gt;();"> 343      protected Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates = new HashMap&lt;FulfillmentOption, BigDecimal&gt;ðŸ”µ</abbr>
 344  
 345      @ManyToMany(targetEntity = FulfillmentOptionImpl.class)
 346      @JoinTable(name = &quot;BLC_SKU_FULFILLMENT_EXCLUDED&quot;,
 347              joinColumns = @JoinColumn(name = &quot;SKU_ID&quot;, referencedColumnName = &quot;SKU_ID&quot;),
<abbr title=" 348              inverseJoinColumns = @JoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;,referencedColumnName = &quot;FULFILLMENT_OPTION_ID&quot;))"> 348              inverseJoinColumns = @JoinColumn(name = &quot;FULFILLMENT_OPTION_ID&quot;,referencedColumnName = &quot;FULFILLMENT_OPðŸ”µ</abbr>
 349      @Cache(usage = CacheConcurrencyStrategy.READ_WRITE, region = &quot;blProducts&quot;)
 350      @BatchSize(size = 50)
 351      protected List&lt;FulfillmentOption&gt; excludedFulfillmentOptions = new ArrayList&lt;FulfillmentOption&gt;();
 352  
 353      @Column(name = &quot;INVENTORY_TYPE&quot;)
 354      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_InventoryType&quot;,
 355          group = GroupName.Inventory, order = 1000,
 356          helpText = &quot;skuInventoryTypeHelpText&quot;,
 357          fieldType = SupportedFieldType.BROADLEAF_ENUMERATION,
 358          broadleafEnumeration = &quot;org.broadleafcommerce.core.inventory.service.type.InventoryType&quot;,
 359          columnWidth = &quot;180px&quot;, prominent = true)
 360      protected String inventoryType;
 361  
 362      @Column(name = &quot;QUANTITY_AVAILABLE&quot;)
 363      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_QuantityAvailable&quot;,
 364              group = GroupName.Inventory, order = 1010)
 365      protected Integer quantityAvailable = 0;
 366  
 367      @Column(name = &quot;FULFILLMENT_TYPE&quot;)
 368      @AdminPresentation(friendlyName = &quot;SkuImpl_Sku_FulfillmentType&quot;,
 369          group = GroupName.ShippingFulfillment, order = FieldOrder.FULFILLMENT_TYPE,
 370          fieldType = SupportedFieldType.BROADLEAF_ENUMERATION,
 371          broadleafEnumeration = &quot;org.broadleafcommerce.core.order.service.type.FulfillmentType&quot;)
 372      protected String fulfillmentType;
 373  
 374      /**
<abbr title=" 375       * Note that this field is not the target of the currencyCodeField attribute on either retailPrice or salePrice."> 375       * Note that this field is not the target of the currencyCodeField attribute on either retailPrice or salePricðŸ”µ</abbr>
<abbr title=" 376       * This is because SKUs are special in that we want to return the currency on this SKU if there is one, falling back"> 376       * This is because SKUs are special in that we want to return the currency on this SKU if there is one, fallinðŸ”µ</abbr>
 377       * to the defaultSku&#x27;s currency if possible.
 378       *
 379       * Normally null and hidden.  Use Meta-Data overrides to display in the admin.
 380       * @see Sku#getCurrency() for further cautions about using this field.
 381       */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 382 -    @ManyToOne(targetEntity = BroadleafCurrencyImpl.class)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +    @ManyToOne(targetEntity = BroadleafCurrencyImpl.class, fetch = FetchType.LAZY)</span>
 384      @JoinColumn(name = &quot;CURRENCY_CODE&quot;)
 385      @AdminPresentation(friendlyName = &quot;SkuImpl_Currency&quot;,
 386              group = GroupName.Advanced, order = 3000,
 387              visibility = VisibilityEnum.HIDDEN_ALL)
 388      @AdminPresentationToOneLookup(lookupType = LookupType.DROPDOWN, lookupDisplayProperty = &quot;friendlyName&quot;)
 389      protected BroadleafCurrency currency;
 390  
 391      @Override
 392      public Long getId() {
 393          return id;
 394      }
 395  
 396      @Override
 397      public void setId(Long id) {
 398          this.id = id;
 399      }
 400  
 401      @Override
 402      public String getUrlKey() {
 403          return urlKey;
 404      }
 405  
 406      @Override
 407      public void setUrlKey(String urlKey) {
 408          this.urlKey = urlKey;
 409      }
 410  
 411      @Override
 412      public String getDisplayTemplate() {
 413          return displayTemplate;
 414      }
 415  
 416      @Override
 417      public void setDisplayTemplate(String displayTemplate) {
 418          this.displayTemplate = displayTemplate;
 419      }
 420  
 421      @Override
 422      public boolean isOnSale() {
 423          Money retailPrice = getRetailPrice();
 424          Money salePrice = getSalePrice();
 425          return (salePrice != null &amp;&amp; !salePrice.isZero() &amp;&amp; salePrice.lessThan(retailPrice));
 426      }
 427  
 428      protected boolean hasDefaultSku() {
<abbr title=" 429          return (product != null &amp;&amp; product.getDefaultSku() != null &amp;&amp; getId() != null &amp;&amp; !getId().equals(product.getDefaultSku().getId()));"> 429          return (product != null &amp;&amp; product.getDefaultSku() != null &amp;&amp; getId() != null &amp;&amp; !getId().equals(product.gðŸ”µ</abbr>
 430      }
 431  
 432      protected Sku lookupDefaultSku() {
 433          if (product != null &amp;&amp; product.getDefaultSku() != null) {
 434              return product.getDefaultSku();
 435          } else {
 436              return null;
 437          }
 438      }
 439  
 440      @Override
 441      public Money getProductOptionValueAdjustments() {
 442          Money optionValuePriceAdjustments = null;
 443          if (getProductOptionValues() != null) {
 444              for (ProductOptionValue value : getProductOptionValues()) {
 445                  if (value.getPriceAdjustment() != null) {
 446                      if (optionValuePriceAdjustments == null) {
 447                          optionValuePriceAdjustments = value.getPriceAdjustment();
 448                      } else {
 449                          optionValuePriceAdjustments = optionValuePriceAdjustments.add(value.getPriceAdjustment());
 450                      }
 451                  }
 452              }
 453          }
 454          return optionValuePriceAdjustments;
 455      }
 456  
 457      @Override
 458      public Money getSalePrice() {
 459          Money returnPrice = null;
 460          Money optionValueAdjustments = null;
 461  
 462          if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 463              // We have dynamic pricing, so we will pull the sale price from there
 464              DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 465              returnPrice = dynamicPrices.getSalePrice();
 466              optionValueAdjustments = dynamicPrices.getPriceAdjustment();
 467              if (SkuPricingConsiderationContext.isPricingConsiderationActive()) {
 468                  return returnPrice;
 469              }
 470          } else if (salePrice != null) {
 471              // We have an explicitly set sale price directly on this entity. We will not apply any adjustments
 472              returnPrice = new Money(salePrice, getCurrency());
 473          }
 474  
 475          if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 476              returnPrice = lookupDefaultSku().getSalePrice();
 477              optionValueAdjustments = getProductOptionValueAdjustments();
 478          }
 479  
 480          if (returnPrice == null) {
 481              return null;
 482          }
 483  
 484          if (optionValueAdjustments != null) {
 485              returnPrice = returnPrice.add(optionValueAdjustments);
 486          }
 487  
 488          return returnPrice;
 489      }
 490  
 491      @Override
 492      public boolean hasSalePrice() {
 493          return getSalePrice() != null;
 494      }
 495  
 496      @Override
 497      public void setSalePrice(Money salePrice) {
 498          this.salePrice = Money.toAmount(salePrice);
 499      }
 500  
 501      @Override
 502      public Money getRetailPrice() {
 503          return getRetailPriceInternal();
 504      }
 505  
 506      /*
<abbr title=" 507       * This allows us a way to determine or calculate the retail price. If one is not available this method will return null."> 507       * This allows us a way to determine or calculate the retail price. If one is not available this method will rðŸ”µ</abbr>
<abbr title=" 508       * This allows the call to hasRetailPrice() to determine if there is a retail price without the overhead of an exception."> 508       * This allows the call to hasRetailPrice() to determine if there is a retail price without the overhead of anðŸ”µ</abbr>
 509       */
 510      protected Money getRetailPriceInternal() {
 511          Money returnPrice = null;
 512          Money optionValueAdjustments = null;
 513  
 514          if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 515              // We have dynamic pricing, so we will pull the retail price from there
 516              DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 517              returnPrice = dynamicPrices.getRetailPrice();
 518              optionValueAdjustments = dynamicPrices.getPriceAdjustment();
 519              if (SkuPricingConsiderationContext.isPricingConsiderationActive()) {
 520                  return returnPrice;
 521              }
 522          } else if (retailPrice != null) {
 523              returnPrice = new Money(retailPrice, getCurrency());
 524          }
 525  
 526          if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 527              // Otherwise, we&#x27;ll pull the retail price from the default sku
 528              returnPrice = lookupDefaultSku().getRetailPrice();
 529              optionValueAdjustments = getProductOptionValueAdjustments();
 530          }
 531  
 532          if (returnPrice != null &amp;&amp; optionValueAdjustments != null) {
 533              returnPrice = returnPrice.add(optionValueAdjustments);
 534          }
 535  
 536          return returnPrice;
 537      }
 538  
 539      @Override
 540      public Money getBaseRetailPrice() {
 541          Money returnPrice = null;
 542          if (retailPrice != null) {
 543              returnPrice = new Money(retailPrice, getCurrency());
 544          }
 545          if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 546              Sku defaultSku = lookupDefaultSku();
 547              returnPrice = defaultSku.getBaseRetailPrice();
 548          }
 549          return returnPrice;
 550      }
 551  
 552      @Override
 553      public Money getBaseSalePrice() {
 554          Money returnPrice = null;
 555          if (salePrice != null) {
 556              returnPrice = new Money(salePrice, getCurrency());
 557          }
 558          if (returnPrice == null &amp;&amp; hasDefaultSku()) {
 559              Sku defaultSku = lookupDefaultSku();
 560              returnPrice = defaultSku.getBaseSalePrice();
 561          }
 562          return returnPrice;
 563      }
 564  
 565      @Override
 566      public DynamicSkuPrices getPriceData() {
 567          if (SkuPricingConsiderationContext.hasDynamicPricing()) {
 568              DynamicSkuPrices dynamicPrices = SkuPricingConsiderationContext.getDynamicSkuPrices(this);
 569              return dynamicPrices;
 570          } else {
 571              DynamicSkuPrices dsp = new DynamicSkuPrices();
 572              BroadleafCurrency tmpCurrency;
 573              if (currency != null) {
 574                  tmpCurrency = currency;
 575              } else {
 576                  tmpCurrency = BroadleafRequestContext.getCurrency();
 577              }
 578              if (retailPrice != null) {
 579                  dsp.setRetailPrice(new Money(retailPrice, tmpCurrency));
 580              }
 581              if (salePrice != null) {
 582                  dsp.setSalePrice(new Money(salePrice, tmpCurrency));
 583              }
 584              return dsp;
 585          }
 586      }
 587  
 588      @Override
 589      public boolean hasRetailPrice() {
 590          return getRetailPriceInternal() != null;
 591      }
 592  
 593      @Override
 594      public void setRetailPrice(Money retailPrice) {
 595          this.retailPrice = Money.toAmount(retailPrice);
 596      }
 597  
 598      @Override
 599      public Money getPrice() {
 600          return isOnSale() ? getSalePrice() : getRetailPrice();
 601      }
 602  
 603      @Override
 604      @Deprecated
 605      public Money getListPrice() {
 606          return getRetailPrice();
 607      }
 608  
 609      @Override
 610      @Deprecated
 611      public void setListPrice(Money listPrice) {
 612          this.retailPrice = Money.toAmount(listPrice);
 613      }
 614  
 615      @Override
 616      public Money getCost() {
 617          if (cost == null &amp;&amp; hasDefaultSku()) {
 618              return lookupDefaultSku().getCost();
 619          }
 620  
 621          if (cost == null) {
 622              return null;
 623          }
 624  
 625          return new Money(cost, getCurrency());
 626      }
 627  
 628      @Override
 629      public void setCost(Money cost) {
 630          this.cost = cost.getAmount();
 631      }
 632  
 633      @Override
 634      public Money getMargin() {
 635          Money margin = null;
 636          Money price = getPrice();
 637          Money purchaseCost = getCost();
 638  
 639          if (price == null &amp;&amp; hasDefaultSku()) {
 640              price = lookupDefaultSku().getPrice();
 641          }
 642  
 643          if (purchaseCost == null &amp;&amp; hasDefaultSku()) {
 644              purchaseCost = lookupDefaultSku().getCost();
 645          }
 646  
 647          if (price != null &amp;&amp; !price.getAmount().equals(BigDecimal.ZERO)) {
 648              if (purchaseCost != null) {
 649                  margin = price.subtract(purchaseCost).divide(price.getAmount());
 650              }
 651          } else {
 652              margin = Money.ZERO;
 653          }
 654  
 655          return margin;
 656      }
 657  
 658      @Override
 659      public String getName() {
 660          if (name == null &amp;&amp; hasDefaultSku()) {
 661              return lookupDefaultSku().getName();
 662          }
 663  
 664          return DynamicTranslationProvider.getValue(this, &quot;name&quot;, name);
 665      }
 666  
 667      @Override
 668      public void setName(String name) {
 669          this.name = name;
 670      }
 671  
 672      @Override
 673      public String getDescription() {
 674          if (description == null &amp;&amp; hasDefaultSku()) {
 675              return lookupDefaultSku().getDescription();
 676          }
 677  
 678          return DynamicTranslationProvider.getValue(this, &quot;description&quot;, description);
 679      }
 680  
 681      @Override
 682      public void setDescription(String description) {
 683          this.description = description;
 684      }
 685  
 686      @Override
 687      public String getLongDescription() {
 688          if (longDescription == null &amp;&amp; hasDefaultSku()) {
 689              return lookupDefaultSku().getLongDescription();
 690          }
 691  
 692          return DynamicTranslationProvider.getValue(this, &quot;longDescription&quot;, longDescription);
 693      }
 694  
 695      @Override
 696      public void setLongDescription(String longDescription) {
 697          this.longDescription = longDescription;
 698      }
 699  
 700      @Override
 701      public Boolean isTaxable() {
 702          if (taxable == null) {
 703              if (hasDefaultSku()) {
 704                  return lookupDefaultSku().isTaxable();
 705              }
 706              return null;
 707          }
 708          return taxable == &#x27;Y&#x27; ? Boolean.TRUE : Boolean.FALSE;
 709      }
 710  
 711      @Override
 712      public Boolean getTaxable() {
 713          return isTaxable();
 714      }
 715  
 716      @Override
 717      public void setTaxable(Boolean taxable) {
 718          if (taxable == null) {
 719              this.taxable = null;
 720          } else {
 721              this.taxable = taxable ? &#x27;Y&#x27; : &#x27;N&#x27;;
 722          }
 723      }
 724  
 725      @Override
 726      public Boolean isDiscountable() {
 727          if (discountable == null) {
 728              if (hasDefaultSku()) {
 729                  return lookupDefaultSku().isDiscountable();
 730              }
 731              return Boolean.FALSE;
 732          }
 733          return discountable == &#x27;Y&#x27; ? Boolean.TRUE : Boolean.FALSE;
 734      }
 735  
 736      /*
 737       * This is to facilitate serialization to non-Java clients
 738       */
 739      public Boolean getDiscountable() {
 740          return isDiscountable();
 741      }
 742  
 743      @Override
 744      public void setDiscountable(Boolean discountable) {
 745          if (discountable == null) {
 746              this.discountable = null;
 747          } else {
 748              this.discountable = discountable ? &#x27;Y&#x27; : &#x27;N&#x27;;
 749          }
 750      }
 751  
 752      @Override
 753      public Boolean isAvailable() {
 754          if (InventoryType.UNAVAILABLE.equals(getInventoryType())) {
 755              return false;
 756          }
 757  
 758          if (available == null) {
 759              if (hasDefaultSku()) {
 760                  return lookupDefaultSku().isAvailable();
 761              }
 762              return true;
 763          }
 764          return available != &#x27;N&#x27;;
 765      }
 766  
 767      @Override
 768      public Boolean getAvailable() {
 769          return isAvailable();
 770      }
 771  
 772      @Override
 773      public void setAvailable(Boolean available) {
 774          if (available == null) {
 775              this.available = null;
 776          } else {
 777              this.available = available ? &#x27;Y&#x27; : &#x27;N&#x27;;
 778          }
 779      }
 780  
 781      @Override
 782      public Date getActiveStartDate() {
 783          Date returnDate = null;
 784          if (SkuActiveDateConsiderationContext.hasDynamicActiveDates()) {
<abbr title=" 785              returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveStartDate(this);"> 785              returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveStartDateðŸ”µ</abbr>
 786          }
 787  
 788          if (returnDate == null) {
 789              if (activeStartDate == null &amp;&amp; hasDefaultSku()) {
 790                  return lookupDefaultSku().getActiveStartDate();
 791              } else {
 792                  return activeStartDate;
 793              }
 794          } else {
 795              return returnDate;
 796          }
 797      }
 798  
 799      @Override
 800      public void setActiveStartDate(Date activeStartDate) {
 801          this.activeStartDate = activeStartDate;
 802      }
 803  
 804      @Override
 805      public Date getActiveEndDate() {
 806          Date returnDate = null;
 807          if (SkuActiveDateConsiderationContext.hasDynamicActiveDates()) {
<abbr title=" 808              returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveEndDate(this);"> 808              returnDate = SkuActiveDateConsiderationContext.getSkuActiveDatesService().getDynamicSkuActiveEndDate(tðŸ”µ</abbr>
 809          }
 810  
 811          if (returnDate == null) {
 812              if (activeEndDate == null &amp;&amp; hasDefaultSku()) {
 813                  return lookupDefaultSku().getActiveEndDate();
 814              } else {
 815                  return activeEndDate;
 816              }
 817          } else {
 818              return returnDate;
 819          }
 820      }
 821  
 822      @Override
 823      public void setActiveEndDate(Date activeEndDate) {
 824          this.activeEndDate = activeEndDate;
 825      }
 826  
 827      @Override
 828      public Dimension getDimension() {
 829          if (dimension == null &amp;&amp; hasDefaultSku()) {
 830              return lookupDefaultSku().getDimension();
 831          } else {
 832              return dimension;
 833          }
 834      }
 835  
 836      @Override
 837      public void setDimension(Dimension dimension) {
 838          this.dimension = dimension;
 839      }
 840  
 841      @Override
 842      public Weight getWeight() {
 843          if (weight == null &amp;&amp; hasDefaultSku()) {
 844              return lookupDefaultSku().getWeight();
 845          } else {
 846              return weight;
 847          }
 848      }
 849  
 850      @Override
 851      public void setWeight(Weight weight) {
 852          this.weight = weight;
 853      }
 854  
 855      @Override
 856      public boolean isActive() {
 857          if (activeStartDate == null &amp;&amp; activeEndDate == null &amp;&amp; hasDefaultSku()) {
 858              return lookupDefaultSku().isActive();
 859          }
 860          if (LOG.isDebugEnabled()) {
 861              if (!DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true)) {
 862                  LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to date&quot;);
 863              }
 864          }
 865  
 866          if (!(getProduct() == null) &amp;&amp; !getProduct().isActive()) {
 867              return false;
 868          }
 869  
 870          return DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true);
 871      }
 872  
 873      @Override
 874      public boolean isActive(Product product, Category category) {
 875          if (LOG.isDebugEnabled()) {
 876              if (!DateUtil.isActive(getActiveStartDate(), getActiveEndDate(), true)) {
 877                  LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to date&quot;);
 878              } else if (!product.isActive()) {
 879                  LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to product being inactive&quot;);
 880              } else if (!category.isActive()) {
 881                  LOG.debug(&quot;sku, &quot; + id + &quot;, inactive due to category being inactive&quot;);
 882              }
 883          }
<abbr title=" 884          return this.isActive() &amp;&amp; (product == null || product.isActive()) &amp;&amp; (category == null || category.isActive());"> 884          return this.isActive() &amp;&amp; (product == null || product.isActive()) &amp;&amp; (category == null || category.isActivðŸ”µ</abbr>
 885      }
 886  
 887      @Override
 888      @Deprecated
 889      public Map&lt;String, Media&gt; getSkuMedia() {
 890          Map&lt;String, Media&gt; skuMediaMap = new LinkedHashMap&lt;&gt;(legacySkuMedia);
 891  
 892          if (MapUtils.isEmpty(skuMediaMap)) {
 893              for (Map.Entry&lt;String, SkuMediaXref&gt; entry : getSkuMediaXref().entrySet()) {
 894                  skuMediaMap.put(entry.getKey(), entry.getValue().getMedia());
 895              }
 896          }
 897  
 898          return Collections.unmodifiableMap(skuMediaMap);
 899      }
 900  
 901      @Override
 902      @Deprecated
 903      public void setSkuMedia(Map&lt;String, Media&gt; skuMedia) {
 904          this.skuMedia.clear();
 905          this.legacySkuMedia.clear();
 906          for(Map.Entry&lt;String, Media&gt; entry : skuMedia.entrySet()){
 907              this.skuMedia.put(entry.getKey(), new SkuMediaXrefImpl(this, entry.getValue(), entry.getKey()));
 908          }
 909      }
 910  
 911      @Override
 912      public Map&lt;String, SkuMediaXref&gt; getSkuMediaXref() {
 913          Map&lt;String, SkuMediaXref&gt; skuMediaMap = skuMedia;
 914  
 915          if (MapUtils.isEmpty(skuMediaMap)) {
 916              if (hasDefaultSku()) {
 917                  return lookupDefaultSku().getSkuMediaXref();
 918              }
 919          }
 920  
 921          if (isOrderedSkuMedia(skuMediaMap)) {
 922              skuMediaMap = sortSkuMedia(skuMediaMap);
 923          }
 924  
 925          return skuMediaMap;
 926      }
 927  
 928      @Override
 929      public Map&lt;String, SkuMediaXref&gt; getSkuMediaXrefIgnoreDefaultSku() {
 930          Map&lt;String, SkuMediaXref&gt; skuMediaMap = skuMedia;
 931  
 932          if (isOrderedSkuMedia(skuMediaMap)) {
 933              skuMediaMap = sortSkuMedia(skuMediaMap);
 934          }
 935  
 936          return skuMediaMap;
 937      }
 938  
 939      @Override
 940      public Media getPrimarySkuMedia() {
 941          Map&lt;String, SkuMediaXref&gt; skuMediaMap = getSkuMediaXrefIgnoreDefaultSku();
 942  
 943          if (MapUtils.isNotEmpty(skuMediaMap)) {
 944              if (isOrderedSkuMedia(skuMediaMap)) {
 945                  return skuMediaMap.values().stream()
 946                          .map(OrderedSkuMediaXref.class::cast)
 947                          .filter(OrderedSkuMediaXref::getShowInGallery)
 948                          .findFirst()
 949                          .map(SkuMediaXref.class::cast)
 950                          .map(SkuMediaXref::getMedia)
 951                          .orElse(null);
 952              } else {
 953                  SkuMediaXref primaryXref = skuMediaMap.get(&quot;primary&quot;);
 954  
 955                  return (primaryXref == null)? null : primaryXref.getMedia();
 956              }
 957          }
 958  
 959          return null;
 960      }
 961  
 962      @Override
 963      public void setSkuMediaXref(Map&lt;String, SkuMediaXref&gt; skuMediaXref) {
 964          this.skuMedia = skuMediaXref;
 965      }
 966  
 967      protected boolean isOrderedSkuMedia(Map&lt;String, SkuMediaXref&gt; skuMedia) {
 968          return skuMedia.values().stream()
 969                  .anyMatch(OrderedSkuMediaXref.class::isInstance);
 970      }
 971  
 972      protected Map&lt;String, SkuMediaXref&gt; sortSkuMedia(Map&lt;String, SkuMediaXref&gt; skuMedia) {
 973          return skuMedia.values().stream()
 974                  .sorted(Comparator.comparing(xref -&gt; ((OrderedSkuMediaXref) xref).getDisplayOrder()))
 975                  .collect(Collectors.toMap(SkuMediaXref::getKey, Function.identity(),
<abbr title=" 976                          (key1,key2) -&gt;{ throw new IllegalStateException(String.format(&quot;Duplicate key %s&quot;, key1)); },"> 976                          (key1,key2) -&gt;{ throw new IllegalStateException(String.format(&quot;Duplicate key %s&quot;, key1)); ðŸ”µ</abbr>
 977                          LinkedHashMap::new));
 978      }
 979  
 980      @Override
 981      public Product getDefaultProduct() {
 982          return defaultProduct;
 983      }
 984  
 985      @Override
 986      public void setDefaultProduct(Product defaultProduct) {
 987          this.defaultProduct = defaultProduct;
 988      }
 989  
 990      @Override
 991      public Product getProduct() {
 992          return (getDefaultProduct() != null) ? getDefaultProduct() : this.product;
 993      }
 994  
 995      @Override
 996      public void setProduct(Product product) {
 997          this.product = product;
 998      }
 999  
1000      @Override
1001      public Set&lt;SkuProductOptionValueXref&gt; getProductOptionValueXrefs() {
1002          return productOptionValueXrefs;
1003      }
1004  
1005      @Override
1006      public void setProductOptionValueXrefs(Set&lt;SkuProductOptionValueXref&gt; productOptionValueXrefs) {
1007          this.productOptionValueXrefs = productOptionValueXrefs;
1008      }
1009  
1010      @Override
1011      public Set&lt;ProductOptionValue&gt; getProductOptionValuesCollection() {
1012          if (legacyProductOptionValues.size() == 0) {
1013              for (SkuProductOptionValueXref xref : productOptionValueXrefs) {
1014                  legacyProductOptionValues.add(xref.getProductOptionValue());
1015              }
1016          }
1017          return Collections.unmodifiableSet(legacyProductOptionValues);
1018      }
1019  
1020      @Override
1021      public void setProductOptionValuesCollection(Set&lt;ProductOptionValue&gt; productOptionValues) {
1022          this.legacyProductOptionValues.clear();
1023          this.productOptionValueXrefs.clear();
1024          for (ProductOptionValue val : productOptionValues) {
1025              this.productOptionValueXrefs.add(new SkuProductOptionValueXrefImpl(this, val));
1026          }
1027      }
1028  
1029      @Override
1030      @Deprecated
1031      public List&lt;ProductOptionValue&gt; getProductOptionValues() {
<abbr title="1032          //Changing this API to Set is ill-advised (especially in a patch release). The tendrils are widespread. Instead">1032          //Changing this API to Set is ill-advised (especially in a patch release). The tendrils are widespread. InðŸ”µ</abbr>
1033          //we just migrate the call from the List to the internal Set representation. This is in response
1034          //to https://github.com/BroadleafCommerce/BroadleafCommerce/issues/917.
<abbr title="1035          return (List&lt;ProductOptionValue&gt;) Proxy.newProxyInstance(getClass().getClassLoader(), new Class&lt;?&gt;[]{List.class}, new InvocationHandler() {">1035          return (List&lt;ProductOptionValue&gt;) Proxy.newProxyInstance(getClass().getClassLoader(), new Class&lt;?&gt;[]{List.ðŸ”µ</abbr>
1036              @Override
1037              public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
<abbr title="1038                  return MethodUtils.invokeMethod(getProductOptionValuesCollection(), method.getName(), args, method.getParameterTypes());">1038                  return MethodUtils.invokeMethod(getProductOptionValuesCollection(), method.getName(), args, methodðŸ”µ</abbr>
1039              }
1040          });
1041      }
1042  
1043      @Override
1044      @Deprecated
1045      public void setProductOptionValues(List&lt;ProductOptionValue&gt; productOptionValues) {
1046          setProductOptionValuesCollection(new HashSet&lt;ProductOptionValue&gt;(productOptionValues));
1047      }
1048  
1049      @Override
1050      @Deprecated
1051      public Boolean isMachineSortable() {
1052          if (isMachineSortable == null &amp;&amp; hasDefaultSku()) {
1053              return lookupDefaultSku().isMachineSortable();
1054          }
1055          return isMachineSortable == null ? false : isMachineSortable;
1056      }
1057  
1058      @Override
1059      public Boolean getIsMachineSortable() {
1060          if (isMachineSortable == null &amp;&amp; hasDefaultSku()) {
1061              return lookupDefaultSku().getIsMachineSortable();
1062          }
1063          return isMachineSortable == null ? false : isMachineSortable;
1064      }
1065  
1066      @Override
1067      @Deprecated
1068      public void setMachineSortable(Boolean isMachineSortable) {
1069          this.isMachineSortable = isMachineSortable;
1070      }
1071  
1072      @Override
1073      public void setIsMachineSortable(Boolean isMachineSortable) {
1074          this.isMachineSortable = isMachineSortable;
1075      }
1076  
1077      @Override
1078      public List&lt;SkuFee&gt; getFees() {
1079          return fees;
1080      }
1081  
1082      @Override
1083      public void setFees(List&lt;SkuFee&gt; fees) {
1084          this.fees = fees;
1085      }
1086  
1087      @Override
1088      public Map&lt;FulfillmentOption, BigDecimal&gt; getFulfillmentFlatRates() {
1089          return fulfillmentFlatRates;
1090      }
1091  
1092      @Override
1093      public void setFulfillmentFlatRates(Map&lt;FulfillmentOption, BigDecimal&gt; fulfillmentFlatRates) {
1094          this.fulfillmentFlatRates = fulfillmentFlatRates;
1095      }
1096  
1097      @Override
1098      public List&lt;FulfillmentOption&gt; getExcludedFulfillmentOptions() {
1099          return excludedFulfillmentOptions;
1100      }
1101  
1102      @Override
1103      public void setExcludedFulfillmentOptions(List&lt;FulfillmentOption&gt; excludedFulfillmentOptions) {
1104          this.excludedFulfillmentOptions = excludedFulfillmentOptions;
1105      }
1106  
1107      @Override
1108      public InventoryType getInventoryType() {
1109          if (StringUtils.isEmpty(this.inventoryType)) {
1110              if (hasDefaultSku() &amp;&amp; lookupDefaultSku().getInventoryType() != null) {
1111                  return lookupDefaultSku().getInventoryType();
1112              } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1113                  return getProduct().getDefaultCategory().getInventoryType();
1114              }
1115              return null;
1116          }
1117          return InventoryType.getInstance(this.inventoryType);
1118      }
1119  
1120      @Override
1121      public void setInventoryType(InventoryType inventoryType) {
1122          this.inventoryType = (inventoryType == null) ? null : inventoryType.getType();
1123      }
1124  
1125      @Override
1126      public Integer getQuantityAvailable() {
1127          return quantityAvailable;
1128      }
1129  
1130      @Override
1131      public void setQuantityAvailable(Integer quantityAvailable) {
1132          this.quantityAvailable = quantityAvailable;
1133      }
1134  
1135      @Override
1136      public FulfillmentType getFulfillmentType() {
1137          if (StringUtils.isEmpty(this.fulfillmentType)) {
1138              if (hasDefaultSku() &amp;&amp; lookupDefaultSku().getFulfillmentType() != null) {
1139                  return lookupDefaultSku().getFulfillmentType();
1140              } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1141                  return getProduct().getDefaultCategory().getFulfillmentType();
1142              }
1143              return null;
1144          }
1145          return FulfillmentType.getInstance(this.fulfillmentType);
1146      }
1147  
1148      @Override
1149      public void setFulfillmentType(FulfillmentType fulfillmentType) {
1150          if (fulfillmentType != null) {
1151              this.fulfillmentType = fulfillmentType.getType();
1152          }
1153      }
1154  
1155      @Override
1156      @Deprecated
1157      public Map&lt;String, SkuAttribute&gt; getSkuAttributes() {
1158          Map&lt;String, SkuAttribute&gt; attributeMap = new HashMap&lt;String, SkuAttribute&gt;();
1159  
1160          for (SkuAttribute skuAttribute : skuAttributes) {
1161              attributeMap.put(skuAttribute.getName(), skuAttribute);
1162          }
1163  
1164          return attributeMap;
1165      }
1166  
1167      @Override
1168      @SuppressWarnings(&quot;unchecked&quot;)
1169      public Map&lt;String, Collection&lt;SkuAttribute&gt;&gt; getMultiValueSkuAttributes() {
1170          MultiValueMap multiValueMap = new MultiValueMap();
1171  
1172          for (SkuAttribute skuAttribute : skuAttributes) {
1173              multiValueMap.put(skuAttribute.getName(), skuAttribute);
1174          }
1175  
1176          return multiValueMap;
1177      }
1178  
1179      @Override
1180      public void setSkuAttributes(Map&lt;String, SkuAttribute&gt; skuAttributes) {
1181          List&lt;SkuAttribute&gt; skuAttributeList = new ArrayList&lt;SkuAttribute&gt;();
1182  
1183          for(Map.Entry&lt;String, SkuAttribute&gt; entry : skuAttributes.entrySet()){
1184              skuAttributeList.add(entry.getValue());
1185          }
1186  
1187          this.skuAttributes = skuAttributeList;
1188      }
1189  
1190      @Override
1191      public BroadleafCurrency getCurrency() {
1192          if (currency == null &amp;&amp; hasDefaultSku()) {
1193              return lookupDefaultSku().getCurrency();
1194          } else {
1195              return currency;
1196          }
1197      }
1198  
1199      @Override
1200      public void setCurrency(BroadleafCurrency currency) {
1201          this.currency = currency;
1202      }
1203  
1204      @Override
1205      public void clearDynamicPrices() {
1206          SkuPricingConsiderationContext.removeFromThreadCache(getId());
1207      }
1208  
1209      @Override
1210      public boolean equals(Object obj) {
1211          if (this == obj) {
1212              return true;
1213          }
1214          if (obj == null) {
1215              return false;
1216          }
1217          if (!getClass().isAssignableFrom(obj.getClass())) {
1218              return false;
1219          }
1220          SkuImpl other = (SkuImpl) obj;
1221  
1222          if (id != null &amp;&amp; other.id != null) {
1223              return id.equals(other.id);
1224          }
1225  
1226          if (getName() == null) {
1227              if (other.getName() != null) {
1228                  return false;
1229              }
1230          } else if (!getName().equals(other.getName())) {
1231              return false;
1232          }
1233          return true;
1234      }
1235  
1236      @Override
1237      public int hashCode() {
1238          final int prime = 31;
1239          int result = 1;
1240          result = prime * result + ((name == null) ? 0 : name.hashCode());
1241          return result;
1242      }
1243  
1244      @Override
1245      public String getTaxCode() {
1246          if (StringUtils.isEmpty(this.taxCode)) {
1247              if (hasDefaultSku() &amp;&amp; !StringUtils.isEmpty(lookupDefaultSku().getTaxCode())) {
1248                  return lookupDefaultSku().getTaxCode();
1249              } else if (getProduct() != null &amp;&amp; getProduct().getDefaultCategory() != null) {
1250                  return getProduct().getDefaultCategory().getTaxCode();
1251              }
1252          }
1253          return this.taxCode;
1254      }
1255  
1256      @Override
1257      public void setTaxCode(String taxCode) {
1258          this.taxCode = taxCode;
1259      }
1260  
1261      @Override
1262      public String getExternalId() {
1263          return externalId;
1264      }
1265  
1266      @Override
1267      public void setExternalId(String externalId) {
1268          this.externalId = externalId;
1269      }
1270  
1271      @Override
1272      public String getUpc() {
1273          return upc;
1274      }
1275  
1276      @Override
1277      public void setUpc(String upc) {
1278          this.upc = upc;
1279      }
1280  
1281      @Override
1282      public FieldEntity getFieldEntityType() {
1283          return FieldEntity.SKU;
1284      }
1285  
1286      @Override
<abbr title="1287      public &lt;G extends Sku&gt; CreateResponse&lt;G&gt; createOrRetrieveCopyInstance(MultiTenantCopyContext context) throws CloneNotSupportedException {">1287      public &lt;G extends Sku&gt; CreateResponse&lt;G&gt; createOrRetrieveCopyInstance(MultiTenantCopyContext context) throws CðŸ”µ</abbr>
1288          CreateResponse&lt;G&gt; createResponse = context.createOrRetrieveCopyInstance(this);
1289          if (createResponse.isAlreadyPopulated()) {
1290              return createResponse;
1291          }
1292          Sku cloned = createResponse.getClone();
1293          cloned.setRetailPrice(getRetailPrice());
1294          cloned.setSalePrice(getSalePrice());
1295          cloned.setName(name);
1296          cloned.setActiveEndDate(activeEndDate);
1297          cloned.setActiveStartDate(activeStartDate);
1298          cloned.setCurrency(currency);
1299          cloned.setQuantityAvailable(quantityAvailable);
1300          cloned.setDescription(description);
1301          cloned.setDimension(dimension);
1302          cloned.setDiscountable(isDiscountable());
1303          cloned.setDisplayTemplate(displayTemplate);
1304          cloned.setExternalId(externalId);
1305          cloned.setTaxable(isTaxable());
1306          cloned.setTaxCode(taxCode);
1307          cloned.setUrlKey(urlKey);
1308          cloned.setInventoryType(getInventoryType());
1309          cloned.setFulfillmentType(getFulfillmentType());
1310          cloned.setIsMachineSortable(isMachineSortable);
1311          cloned.setLongDescription(longDescription);
1312          cloned.setUpc(upc);
1313          if (product != null) {
1314              cloned.setDefaultProduct(product.createOrRetrieveCopyInstance(context).getClone());
1315          }
1316          if (product != null) {
1317              cloned.setProduct(product.createOrRetrieveCopyInstance(context).getClone());
1318          }
1319          for(Map.Entry&lt;String, SkuAttribute&gt; entry : getSkuAttributes().entrySet()){
1320              SkuAttribute clonedEntry = entry.getValue().createOrRetrieveCopyInstance(context).getClone();
1321              cloned.getSkuAttributes().put(entry.getKey(),clonedEntry);
1322          }
1323          for(SkuProductOptionValueXref entry : productOptionValueXrefs){
1324              SkuProductOptionValueXref clonedEntry = entry.createOrRetrieveCopyInstance(context).getClone();
1325              cloned.getProductOptionValueXrefs().add(clonedEntry);
1326          }
1327          for(Map.Entry&lt;String, SkuMediaXref&gt; entry : skuMedia.entrySet()){
<abbr title="1328              SkuMediaXrefImpl clonedEntry = ((SkuMediaXrefImpl)entry.getValue()).createOrRetrieveCopyInstance(context).getClone();">1328              SkuMediaXrefImpl clonedEntry = ((SkuMediaXrefImpl)entry.getValue()).createOrRetrieveCopyInstance(conteðŸ”µ</abbr>
1329              cloned.getSkuMediaXrefIgnoreDefaultSku().put(entry.getKey(),clonedEntry);
1330          }
1331          for(FulfillmentOption entry : excludedFulfillmentOptions){
1332              FulfillmentOption clonedEntry = entry.createOrRetrieveCopyInstance(context).getClone();
1333              cloned.getExcludedFulfillmentOptions().add(clonedEntry);
1334          }
1335          for(Map.Entry&lt;FulfillmentOption, BigDecimal&gt; entry : fulfillmentFlatRates.entrySet()){
1336              FulfillmentOption clonedEntry = entry.getKey().createOrRetrieveCopyInstance(context).getClone();
1337              cloned.getFulfillmentFlatRates().put(clonedEntry,entry.getValue());
1338          }
1339  
1340          return  createResponse;
1341      }
1342  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            