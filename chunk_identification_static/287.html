<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>287</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    287
                    <a href="286.html">prev</a>
                    <a href="288.html">next</a>
                    <a href="287_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_48c30def272c562fe0b11114c11e754ba4b41566_core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/order/security/CartStateRequestProcessor.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;48c30def272c562fe0b11114c11e754ba4b41566:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/order/security/CartStateRequestProcessor.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;48c30def272c562fe0b11114c11e754ba4b41566^1:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/order/security/CartStateRequestProcessor.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;48c30def272c562fe0b11114c11e754ba4b41566^2:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/order/security/CartStateRequestProcessor.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;e8ce904276a11f6347913bbed767a088729c7e21:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/order/security/CartStateRequestProcessor.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="6211491254187717485" onmouseenter="enter('6211491254187717485');" onmouseout="out('6211491254187717485');" style="">   3  * BroadleafCommerce Framework Web                                                                       </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="9047174597422306618" onmouseenter="enter('9047174597422306618');" onmouseout="out('9047174597422306618');" style="">  18 package org.broadleafcommerce.core.web.order.security;                                                   </span>
<span  style="">  19                                                                                                          </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-44736846564495697" onmouseenter="enter('-44736846564495697');" onmouseout="out('-44736846564495697');" style="">  22 import org.broadleafcommerce.common.crossapp.service.CrossAppAuthService;                                </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  23 import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                     </span>
<span class="-6556509414411446728" onmouseenter="enter('-6556509414411446728');" onmouseout="out('-6556509414411446728');" style="">  24 import org.broadleafcommerce.common.util.BLCRequestUtils;                                                </span>
<span class="-6774162061490374742" onmouseenter="enter('-6774162061490374742');" onmouseout="out('-6774162061490374742');" style="">  25 import org.broadleafcommerce.common.web.AbstractBroadleafWebRequestProcessor;                            </span>
<span class="7310498659107503620" onmouseenter="enter('7310498659107503620');" onmouseout="out('7310498659107503620');" style="">  26 import org.broadleafcommerce.common.web.BroadleafWebRequestProcessor;                                    </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  27 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="1732621347693690105" onmouseenter="enter('1732621347693690105');" onmouseout="out('1732621347693690105');" style="">  28 import org.broadleafcommerce.core.order.service.MergeCartService;                                        </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  29 import org.broadleafcommerce.core.order.service.OrderService;                                            </span>
<span class="4773848044130999111" onmouseenter="enter('4773848044130999111');" onmouseout="out('4773848044130999111');" style="">  30 import org.broadleafcommerce.core.order.service.call.MergeCartResponse;                                  </span>
<span class="4692349346970735648" onmouseenter="enter('4692349346970735648');" onmouseout="out('4692349346970735648');" style="">  31 import org.broadleafcommerce.core.order.service.exception.RemoveFromCartException;                       </span>
<span class="614288234168063731" onmouseenter="enter('614288234168063731');" onmouseout="out('614288234168063731');" style="">  32 import org.broadleafcommerce.core.order.service.type.OrderStatus;                                        </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  33 import org.broadleafcommerce.core.pricing.service.exception.PricingException;                            </span>
<span class="-7959314516630637692" onmouseenter="enter('-7959314516630637692');" onmouseout="out('-7959314516630637692');" style="">  34 import org.broadleafcommerce.core.web.service.UpdateCartService;                                         </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  35 import org.broadleafcommerce.profile.core.domain.Customer;                                               </span>
<span class="-6031821648249405492" onmouseenter="enter('-6031821648249405492');" onmouseout="out('-6031821648249405492');" style="">  36 import org.broadleafcommerce.profile.web.core.CustomerState;                                             </span>
<span class="-4063269764380812642" onmouseenter="enter('-4063269764380812642');" onmouseout="out('-4063269764380812642');" style="">  37 import org.broadleafcommerce.profile.web.core.security.CustomerStateRequestProcessor;                    </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="">  38 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="-4664978283136443479" onmouseenter="enter('-4664978283136443479');" onmouseout="out('-4664978283136443479');" style="">  39 import org.springframework.beans.factory.annotation.Qualifier;                                           </span>
<span class="8406454220154166073" onmouseenter="enter('8406454220154166073');" onmouseout="out('8406454220154166073');" style="">  40 import org.springframework.stereotype.Component;                                                         </span>
<span class="-208569050100229982" onmouseenter="enter('-208569050100229982');" onmouseout="out('-208569050100229982');" style="">  41 import org.springframework.web.context.request.ServletWebRequest;                                        </span>
<span class="8045684338721768523" onmouseenter="enter('8045684338721768523');" onmouseout="out('8045684338721768523');" style="">  42 import org.springframework.web.context.request.WebRequest;                                               </span>
<span  style="">  43                                                                                                          </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  44 import java.util.HashMap;                                                                                </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  45 import java.util.Map;                                                                                    </span>
<span  style="">  46                                                                                                          </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  47 import javax.annotation.Resource;                                                                        </span>
<span  style="">  48                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  49 /**                                                                                                      </span>
<span class="6949785334522964843" onmouseenter="enter('6949785334522964843');" onmouseout="out('6949785334522964843');" style="">  50  * Ensures that the customer&#x27;s current cart is available to the request.                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  51  *                                                                                                       </span>
<span class="-6044904845818784259" onmouseenter="enter('-6044904845818784259');" onmouseout="out('-6044904845818784259');" style="">  52  * Also invokes blMergeCartProcessor&quot; if the user has just logged in.                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  53  *                                                                                                       </span>
<span class="-7095132053112495828" onmouseenter="enter('-7095132053112495828');" onmouseout="out('-7095132053112495828');" style=""><abbr title="  54  * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters, Portlet Filters ">  54  * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters,ðŸ”µ</abbr></span>
<span class="-8141282893564723204" onmouseenter="enter('-8141282893564723204');" onmouseout="out('-8141282893564723204');" style=""><abbr title="  55  * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests into WebRequests ">  55  * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests intðŸ”µ</abbr></span>
<span class="-4149953333143573394" onmouseenter="enter('-4149953333143573394');" onmouseout="out('-4149953333143573394');" style="">  56  * via &lt;br /&gt;                                                                                            </span>
<span class="-2288628475956287787" onmouseenter="enter('-2288628475956287787');" onmouseout="out('-2288628475956287787');" style="">  57  * new ServletWebRequest(httpServletRequest); new PortletWebRequest(portletRequest); &lt;br /&gt;              </span>
<span class="-3373499860696082880" onmouseenter="enter('-3373499860696082880');" onmouseout="out('-3373499860696082880');" style="">  58  * For the interceptor pattern, you can simply implement a WebRequestInterceptor to invoke from there.   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  59  *                                                                                                       </span>
<span class="-2581105714976122669" onmouseenter="enter('-2581105714976122669');" onmouseout="out('-2581105714976122669');" style="">  60  * @author Phillip Verheyden                                                                             </span>
<span class="691156538645414019" onmouseenter="enter('691156538645414019');" onmouseout="out('691156538645414019');" style="">  61  * @see {@link CartStateFilter}                                                                          </span>
<span class="2345590137904887447" onmouseenter="enter('2345590137904887447');" onmouseout="out('2345590137904887447');" style="">  62  * @see {@link BroadleafWebRequestProcessor}                                                             </span>
<span class="-1762186850923570701" onmouseenter="enter('-1762186850923570701');" onmouseout="out('-1762186850923570701');" style="">  63  * @see {@link ServletWebRequest}                                                                        </span>
<span class="3606349442508010109" onmouseenter="enter('3606349442508010109');" onmouseout="out('3606349442508010109');" style="">  64  * @see {@link org.springframework.web.portlet.context.PortletWebRequest}                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  65  */                                                                                                      </span>
<span class="-7470255366716761762" onmouseenter="enter('-7470255366716761762');" onmouseout="out('-7470255366716761762');" style="">  66 @Component(&quot;blCartStateRequestProcessor&quot;)                                                                </span>
<span class="-1024024663522960488" onmouseenter="enter('-1024024663522960488');" onmouseout="out('-1024024663522960488');" style="">  67 public class CartStateRequestProcessor extends AbstractBroadleafWebRequestProcessor {                    </span>
<span  style="">  68                                                                                                          </span>
<span class="-4030114958641496547" onmouseenter="enter('-4030114958641496547');" onmouseout="out('-4030114958641496547');" style="">  69     /** Logger for this class and subclasses */                                                          </span>
<span class="8347569796035482168" onmouseenter="enter('8347569796035482168');" onmouseout="out('8347569796035482168');" style="">  70     protected final Log LOG = LogFactory.getLog(getClass());                                             </span>
<span  style="">  71                                                                                                          </span>
<span class="-5119951708732545437" onmouseenter="enter('-5119951708732545437');" onmouseout="out('-5119951708732545437');" style="">  72     public static final String BLC_RULE_MAP_PARAM = &quot;blRuleMap&quot;;                                         </span>
<span  style="">  73                                                                                                          </span>
<span class="8871930809399696828" onmouseenter="enter('8871930809399696828');" onmouseout="out('8871930809399696828');" style="">  74     private final String mergeCartResponseKey = &quot;bl_merge_cart_response&quot;;                                </span>
<span  style="">  75                                                                                                          </span>
<span class="6044335667426838645" onmouseenter="enter('6044335667426838645');" onmouseout="out('6044335667426838645');" style="">  76     @Resource(name = &quot;blCartStateRequestProcessorExtensionManager&quot;)                                      </span>
<span class="-8185812064196536655" onmouseenter="enter('-8185812064196536655');" onmouseout="out('-8185812064196536655');" style="">  77     protected CartStateRequestProcessorExtensionManager extensionManager;                                </span>
<span  style="">  78                                                                                                          </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style="">  79     @Resource(name = &quot;blOrderService&quot;)                                                                   </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style="">  80     protected OrderService orderService;                                                                 </span>
<span  style="">  81                                                                                                          </span>
<span class="-5832711189651279120" onmouseenter="enter('-5832711189651279120');" onmouseout="out('-5832711189651279120');" style="">  82     @Resource(name = &quot;blUpdateCartService&quot;)                                                              </span>
<span class="-6474151620344678255" onmouseenter="enter('-6474151620344678255');" onmouseout="out('-6474151620344678255');" style="">  83     protected UpdateCartService updateCartService;                                                       </span>
<span  style="">  84                                                                                                          </span>
<span class="3052322175513128984" onmouseenter="enter('3052322175513128984');" onmouseout="out('3052322175513128984');" style="">  85     @Resource(name = &quot;blMergeCartService&quot;)                                                               </span>
<span class="8208298738953975930" onmouseenter="enter('8208298738953975930');" onmouseout="out('8208298738953975930');" style="">  86     protected MergeCartService mergeCartService;                                                         </span>
<span  style="">  87                                                                                                          </span>
<span class="-4242208026742072321" onmouseenter="enter('-4242208026742072321');" onmouseout="out('-4242208026742072321');" style="">  88     @Resource(name = &quot;blCustomerStateRequestProcessor&quot;)                                                  </span>
<span class="-8544356289477463500" onmouseenter="enter('-8544356289477463500');" onmouseout="out('-8544356289477463500');" style="">  89     protected CustomerStateRequestProcessor customerStateRequestProcessor;                               </span>
<span  style="">  90                                                                                                          </span>
<span class="2602789178515286342" onmouseenter="enter('2602789178515286342');" onmouseout="out('2602789178515286342');" style="">  91     @Autowired(required = false)                                                                         </span>
<span class="-6782784833899333066" onmouseenter="enter('-6782784833899333066');" onmouseout="out('-6782784833899333066');" style="">  92     @Qualifier(&quot;blCrossAppAuthService&quot;)                                                                  </span>
<span class="-8287485368967055684" onmouseenter="enter('-8287485368967055684');" onmouseout="out('-8287485368967055684');" style="">  93     protected CrossAppAuthService crossAppAuthService;                                                   </span>
<span  style="">  94                                                                                                          </span>
<span class="-8085941326179479324" onmouseenter="enter('-8085941326179479324');" onmouseout="out('-8085941326179479324');" style="">  95     protected static String cartRequestAttributeName = &quot;cart&quot;;                                           </span>
<span  style="">  96                                                                                                          </span>
<span class="1778878837115274965" onmouseenter="enter('1778878837115274965');" onmouseout="out('1778878837115274965');" style="">  97     protected static String anonymousCartSessionAttributeName = &quot;anonymousCart&quot;;                         </span>
<span  style="">  98                                                                                                          </span>
<span class="3570049000477591403" onmouseenter="enter('3570049000477591403');" onmouseout="out('3570049000477591403');" style="">  99     public static final String OVERRIDE_CART_ATTR_NAME = &quot;_blc_overrideCartId&quot;;                          </span>
<span  style=""> 100                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 101     @Override                                                                                            </span>
<span class="-1087564729186269972" onmouseenter="enter('-1087564729186269972');" onmouseout="out('-1087564729186269972');" style=""> 102     public void process(WebRequest request) {                                                            </span>
<span class="-5515974955877981002" onmouseenter="enter('-5515974955877981002');" onmouseout="out('-5515974955877981002');" style=""> 103         Customer customer = CustomerState.getCustomer();                                                 </span>
<span  style=""> 104                                                                                                          </span>
<span class="-1371412200964570990" onmouseenter="enter('-1371412200964570990');" onmouseout="out('-1371412200964570990');" style=""> 105         if (customer == null) {                                                                          </span>
<span class="7950488184855848644" onmouseenter="enter('7950488184855848644');" onmouseout="out('7950488184855848644');" style=""><abbr title=" 106             LOG.info(&quot;No customer was found on the current request, no cart will be added to the current request. Ensure that the&quot;"> 106             LOG.info(&quot;No customer was found on the current request, no cart will be added to the current ðŸ”µ</abbr></span>
<span class="1683793928531658492" onmouseenter="enter('1683793928531658492');" onmouseout="out('1683793928531658492');" style=""> 107                     + &quot; blCustomerStateFilter occurs prior to the blCartStateFilter&quot;);                   </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 108             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 109         }                                                                                                </span>
<span  style=""> 110                                                                                                          </span>
<span class="5165057861481115804" onmouseenter="enter('5165057861481115804');" onmouseout="out('5165057861481115804');" style=""> 111         ExtensionResultHolder&lt;Order&gt; erh = new ExtensionResultHolder&lt;Order&gt;();                           </span>
<span class="5601587306461975752" onmouseenter="enter('5601587306461975752');" onmouseout="out('5601587306461975752');" style=""> 112         extensionManager.getProxy().lookupOrCreateCart(request, customer, erh);                          </span>
<span  style=""> 113                                                                                                          </span>
<span class="847348363243900875" onmouseenter="enter('847348363243900875');" onmouseout="out('847348363243900875');" style=""> 114         Order cart;                                                                                      </span>
<span class="5745510142944708411" onmouseenter="enter('5745510142944708411');" onmouseout="out('5745510142944708411');" style=""> 115         if (erh.getResult() != null) {                                                                   </span>
<span class="-7012036676670353222" onmouseenter="enter('-7012036676670353222');" onmouseout="out('-7012036676670353222');" style=""> 116             cart = orderService.findCartForCustomerWithEnhancements(customer, erh.getResult());          </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 117         } else {                                                                                         </span>
<span class="-3651333313322615728" onmouseenter="enter('-3651333313322615728');" onmouseout="out('-3651333313322615728');" style=""> 118             cart = getOverrideCart(request);                                                             </span>
<span class="1988681715974209575" onmouseenter="enter('1988681715974209575');" onmouseout="out('1988681715974209575');" style=""> 119             if (cart == null &amp;&amp; mergeCartNeeded(customer, request)) {                                    </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 120                 if (LOG.isDebugEnabled()) {                                                              </span>
<span class="-3126227002554961137" onmouseenter="enter('-3126227002554961137');" onmouseout="out('-3126227002554961137');" style=""> 121                     LOG.debug(&quot;Merge cart required, calling mergeCart &quot; + customer.getId());             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122                 }                                                                                        </span>
<span class="729291545179835184" onmouseenter="enter('729291545179835184');" onmouseout="out('729291545179835184');" style=""> 123                 cart = mergeCart(customer, request);                                                     </span>
<span class="-4362027600375335251" onmouseenter="enter('-4362027600375335251');" onmouseout="out('-4362027600375335251');" style=""> 124             } else if (cart == null) {                                                                   </span>
<span class="2009346020505670050" onmouseenter="enter('2009346020505670050');" onmouseout="out('2009346020505670050');" style=""> 125                 cart = orderService.findCartForCustomerWithEnhancements(customer);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 126             }                                                                                            </span>
<span  style=""> 127                                                                                                          </span>
<span class="-2482909530219509442" onmouseenter="enter('-2482909530219509442');" onmouseout="out('-2482909530219509442');" style=""> 128             if (cart == null) {                                                                          </span>
<span class="5619175994998149041" onmouseenter="enter('5619175994998149041');" onmouseout="out('5619175994998149041');" style=""> 129                 cart = orderService.getNullOrder();                                                      </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 130             } else {                                                                                     </span>
<span class="4717244821681544775" onmouseenter="enter('4717244821681544775');" onmouseout="out('4717244821681544775');" style=""> 131                 updateCartService.updateAndValidateCart(cart);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 132             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 133         }                                                                                                </span>
<span  style=""> 134                                                                                                          </span>
<span class="5570729529055502013" onmouseenter="enter('5570729529055502013');" onmouseout="out('5570729529055502013');" style=""> 135         updateCartRequestAttributes(request, cart);                                                      </span>
<span  style=""> 136                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137     }                                                                                                    </span>
<span  style=""> 138                                                                                                          </span>
<span class="4979469920847154161" onmouseenter="enter('4979469920847154161');" onmouseout="out('4979469920847154161');" style=""> 139     protected void updateCartRequestAttributes(WebRequest request, Order cart) {                         </span>
<span class="7956162395984675060" onmouseenter="enter('7956162395984675060');" onmouseout="out('7956162395984675060');" style=""> 140         request.setAttribute(cartRequestAttributeName, cart, WebRequest.SCOPE_REQUEST);                  </span>
<span  style=""> 141                                                                                                          </span>
<span class="2250168164336394635" onmouseenter="enter('2250168164336394635');" onmouseout="out('2250168164336394635');" style=""> 142         // Setup cart for content rule processing                                                        </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 143         @SuppressWarnings(&quot;unchecked&quot;)                                                                   </span>
<span class="-7009529966960283141" onmouseenter="enter('-7009529966960283141');" onmouseout="out('-7009529966960283141');" style=""><abbr title=" 144         Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRequest.SCOPE_REQUEST);"> 144         Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRðŸ”µ</abbr></span>
<span class="7719424053900967992" onmouseenter="enter('7719424053900967992');" onmouseout="out('7719424053900967992');" style=""> 145         if (ruleMap == null) {                                                                           </span>
<span class="7584262357946796931" onmouseenter="enter('7584262357946796931');" onmouseout="out('7584262357946796931');" style=""> 146             ruleMap = new HashMap&lt;String, Object&gt;();                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147         }                                                                                                </span>
<span class="-7082993895566141830" onmouseenter="enter('-7082993895566141830');" onmouseout="out('-7082993895566141830');" style=""> 148         ruleMap.put(&quot;order&quot;, cart);                                                                      </span>
<span  style=""> 149                                                                                                          </span>
<span class="-8486868703965614260" onmouseenter="enter('-8486868703965614260');" onmouseout="out('-8486868703965614260');" style=""><abbr title=" 150         // Leaving the following line in for backwards compatibility, but all rules should use order as the"> 150         // Leaving the following line in for backwards compatibility, but all rules should use order as tðŸ”µ</abbr></span>
<span class="8713525845734832130" onmouseenter="enter('8713525845734832130');" onmouseout="out('8713525845734832130');" style=""> 151         // variable name.                                                                                </span>
<span class="8466527126795751415" onmouseenter="enter('8466527126795751415');" onmouseout="out('8466527126795751415');" style=""> 152         ruleMap.put(&quot;cart&quot;, cart);                                                                       </span>
<span class="-29008669505238211" onmouseenter="enter('-29008669505238211');" onmouseout="out('-29008669505238211');" style=""> 153         request.setAttribute(BLC_RULE_MAP_PARAM, ruleMap, WebRequest.SCOPE_REQUEST);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 154     }                                                                                                    </span>
<span  style=""> 155                                                                                                          </span>
<span class="-7740129989171948267" onmouseenter="enter('-7740129989171948267');" onmouseout="out('-7740129989171948267');" style=""> 156     public Order getOverrideCart(WebRequest request) {                                                   </span>
<span class="-1923411589124412388" onmouseenter="enter('-1923411589124412388');" onmouseout="out('-1923411589124412388');" style=""> 157         Long orderId = null;                                                                             </span>
<span class="8442798390701474713" onmouseenter="enter('8442798390701474713');" onmouseout="out('8442798390701474713');" style=""> 158         if (BLCRequestUtils.isOKtoUseSession(request)) {                                                 </span>
<span class="-6220500265898572524" onmouseenter="enter('-6220500265898572524');" onmouseout="out('-6220500265898572524');" style=""> 159             orderId = (Long) request.getAttribute(OVERRIDE_CART_ATTR_NAME, WebRequest.SCOPE_SESSION);    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 160         }                                                                                                </span>
<span class="-4269565703796629770" onmouseenter="enter('-4269565703796629770');" onmouseout="out('-4269565703796629770');" style=""> 161         Order cart = null;                                                                               </span>
<span class="1156566652422122209" onmouseenter="enter('1156566652422122209');" onmouseout="out('1156566652422122209');" style=""> 162         if (orderId != null) {                                                                           </span>
<span class="-8700600114578005615" onmouseenter="enter('-8700600114578005615');" onmouseout="out('-8700600114578005615');" style=""> 163             cart = orderService.findOrderById(orderId);                                                  </span>
<span  style=""> 164                                                                                                          </span>
<span class="7744785123834062822" onmouseenter="enter('7744785123834062822');" onmouseout="out('7744785123834062822');" style=""> 165             if (cart == null ||                                                                          </span>
<span class="5826484381865674251" onmouseenter="enter('5826484381865674251');" onmouseout="out('5826484381865674251');" style=""> 166                     cart.getStatus().equals(OrderStatus.SUBMITTED) ||                                    </span>
<span class="7497968434275069271" onmouseenter="enter('7497968434275069271');" onmouseout="out('7497968434275069271');" style=""> 167                     cart.getStatus().equals(OrderStatus.CANCELLED)) {                                    </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 168                 return null;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 169             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 170         }                                                                                                </span>
<span  style=""> 171                                                                                                          </span>
<span class="-6231498894577494482" onmouseenter="enter('-6231498894577494482');" onmouseout="out('-6231498894577494482');" style=""> 172         return cart;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 173     }                                                                                                    </span>
<span  style=""> 174                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 175     /**                                                                                                  </span>
<span class="2543515529052098943" onmouseenter="enter('2543515529052098943');" onmouseout="out('2543515529052098943');" style=""><abbr title=" 176      * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implying that this is"> 176      * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implyðŸ”µ</abbr></span>
<span class="3368064714905975053" onmouseenter="enter('3368064714905975053');" onmouseout="out('3368064714905975053');" style=""> 177      * the logged in customer and we need to merge the carts                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 178      */                                                                                                  </span>
<span class="976646062219528439" onmouseenter="enter('976646062219528439');" onmouseout="out('976646062219528439');" style=""> 179     public boolean mergeCartNeeded(Customer customer, WebRequest request) {                              </span>
<span class="-2306216560497710970" onmouseenter="enter('-2306216560497710970');" onmouseout="out('-2306216560497710970');" style=""> 180         // When the user is a CSR, we want to disable cart merging                                       </span>
<span class="3724967001772040546" onmouseenter="enter('3724967001772040546');" onmouseout="out('3724967001772040546');" style=""> 181         if (crossAppAuthService != null &amp;&amp; crossAppAuthService.isAuthedFromAdmin()) {                    </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 182             return false;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183         }                                                                                                </span>
<span  style=""> 184                                                                                                          </span>
<span class="-2037434992999027399" onmouseenter="enter('-2037434992999027399');" onmouseout="out('-2037434992999027399');" style=""> 185         Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);        </span>
<span class="-4250888802750644339" onmouseenter="enter('-4250888802750644339');" onmouseout="out('-4250888802750644339');" style=""><abbr title=" 186         return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymousCustomer.getId()));"> 186         return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymoðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 187     }                                                                                                    </span>
<span  style=""> 188                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 189     /**                                                                                                  </span>
<span class="7405625424464652207" onmouseenter="enter('7405625424464652207');" onmouseout="out('7405625424464652207');" style=""><abbr title=" 190      * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;customer&lt;/b&gt;. This"> 190      * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;cusðŸ”µ</abbr></span>
<span class="-1511666666862096457" onmouseenter="enter('-1511666666862096457');" onmouseout="out('-1511666666862096457');" style=""> 191      * will also remove the customer from session after it has finished since it is no longer needed     </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 192      */                                                                                                  </span>
<span class="-8642121540254730814" onmouseenter="enter('-8642121540254730814');" onmouseout="out('-8642121540254730814');" style=""> 193     public Order mergeCart(Customer customer, WebRequest request) {                                      </span>
<span class="-2037434992999027399" onmouseenter="enter('-2037434992999027399');" onmouseout="out('-2037434992999027399');" style=""> 194         Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);        </span>
<span class="3567488516081904884" onmouseenter="enter('3567488516081904884');" onmouseout="out('3567488516081904884');" style=""> 195         MergeCartResponse mergeCartResponse;                                                             </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 196         try {                                                                                            </span>
<span class="6955444521103915231" onmouseenter="enter('6955444521103915231');" onmouseout="out('6955444521103915231');" style=""> 197             Order cart = orderService.findCartForCustomer(anonymousCustomer);                            </span>
<span class="1811537806218071823" onmouseenter="enter('1811537806218071823');" onmouseout="out('1811537806218071823');" style=""> 198             mergeCartResponse = mergeCartService.mergeCart(customer, cart);                              </span>
<span class="8325775691603685335" onmouseenter="enter('8325775691603685335');" onmouseout="out('8325775691603685335');" style=""> 199         } catch (PricingException e) {                                                                   </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 200             throw new RuntimeException(e);                                                               </span>
<span class="2264439919030346254" onmouseenter="enter('2264439919030346254');" onmouseout="out('2264439919030346254');" style=""> 201         } catch (RemoveFromCartException e) {                                                            </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 202             throw new RuntimeException(e);                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 203         }                                                                                                </span>
<span  style=""> 204                                                                                                          </span>
<span class="8442798390701474713" onmouseenter="enter('8442798390701474713');" onmouseout="out('8442798390701474713');" style=""> 205         if (BLCRequestUtils.isOKtoUseSession(request)) {                                                 </span>
<span class="-2691808975299315412" onmouseenter="enter('-2691808975299315412');" onmouseout="out('-2691808975299315412');" style=""> 206             // The anonymous customer from session is no longer needed; it can be safely removed         </span>
<span class="708215544978738967" onmouseenter="enter('708215544978738967');" onmouseout="out('708215544978738967');" style=""><abbr title=" 207             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeName(),"> 207             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeNamðŸ”µ</abbr></span>
<span class="-8992065164011733984" onmouseenter="enter('-8992065164011733984');" onmouseout="out('-8992065164011733984');" style=""> 208                     WebRequest.SCOPE_SESSION);                                                           </span>
<span class="-4675926701498081497" onmouseenter="enter('-4675926701498081497');" onmouseout="out('-4675926701498081497');" style=""><abbr title=" 209             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeName(),"> 209             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeNðŸ”µ</abbr></span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 210 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="-8992065164011733984" onmouseenter="enter('-8992065164011733984');" onmouseout="out('-8992065164011733984');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211                     WebRequest.SCOPE_SESSION);                                                           </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212                                                                                                          </span>
<span class="3895015659049002158" onmouseenter="enter('3895015659049002158');" onmouseout="out('3895015659049002158');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213             request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_SESSION);     </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 214 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="-7739736464352471759" onmouseenter="enter('-7739736464352471759');" onmouseout="out('-7739736464352471759');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215                     WebRequest.SCOPE_GLOBAL_SESSION);                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216                                                                                                          </span>
<span class="-4852350541649994679" onmouseenter="enter('-4852350541649994679');" onmouseout="out('-4852350541649994679');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 217             request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_GLOBAL_SESSION);"> 217             request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_GLOBAL_SESSIONðŸ”µ</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 218 =======                                                                                                  </span>
<span class="-7739736464352471759" onmouseenter="enter('-7739736464352471759');" onmouseout="out('-7739736464352471759');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219                     WebRequest.SCOPE_GLOBAL_SESSION);                                                    </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 220 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 221         }                                                                                                </span>
<span class="-3259849467893150872" onmouseenter="enter('-3259849467893150872');" onmouseout="out('-3259849467893150872');" style=""> 222         return mergeCartResponse.getOrder();                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 223     }                                                                                                    </span>
<span  style=""> 224                                                                                                          </span>
<span class="-1418008799783690701" onmouseenter="enter('-1418008799783690701');" onmouseout="out('-1418008799783690701');" style=""> 225     public static String getCartRequestAttributeName() {                                                 </span>
<span class="-7826677971898041484" onmouseenter="enter('-7826677971898041484');" onmouseout="out('-7826677971898041484');" style=""> 226         return cartRequestAttributeName;                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 227     }                                                                                                    </span>
<span  style=""> 228                                                                                                          </span>
<span class="8336122383281290122" onmouseenter="enter('8336122383281290122');" onmouseout="out('8336122383281290122');" style=""> 229     public static void setCartRequestAttributeName(String cartRequestAttributeName) {                    </span>
<span class="-9172660232233003621" onmouseenter="enter('-9172660232233003621');" onmouseout="out('-9172660232233003621');" style=""> 230         CartStateRequestProcessor.cartRequestAttributeName = cartRequestAttributeName;                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 231     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 232 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="6211491254187717485" onmouseenter="enter('6211491254187717485');" onmouseout="out('6211491254187717485');" style="">   3  * BroadleafCommerce Framework Web                                                                       </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="9047174597422306618" onmouseenter="enter('9047174597422306618');" onmouseout="out('9047174597422306618');" style="">  18 package org.broadleafcommerce.core.web.order.security;                                                   </span>
<span  style="">  19                                                                                                          </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-44736846564495697" onmouseenter="enter('-44736846564495697');" onmouseout="out('-44736846564495697');" style="">  22 import org.broadleafcommerce.common.crossapp.service.CrossAppAuthService;                                </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  23 import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                     </span>
<span class="-6556509414411446728" onmouseenter="enter('-6556509414411446728');" onmouseout="out('-6556509414411446728');" style="">  24 import org.broadleafcommerce.common.util.BLCRequestUtils;                                                </span>
<span class="-6774162061490374742" onmouseenter="enter('-6774162061490374742');" onmouseout="out('-6774162061490374742');" style="">  25 import org.broadleafcommerce.common.web.AbstractBroadleafWebRequestProcessor;                            </span>
<span class="7310498659107503620" onmouseenter="enter('7310498659107503620');" onmouseout="out('7310498659107503620');" style="">  26 import org.broadleafcommerce.common.web.BroadleafWebRequestProcessor;                                    </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  27 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="1732621347693690105" onmouseenter="enter('1732621347693690105');" onmouseout="out('1732621347693690105');" style="">  28 import org.broadleafcommerce.core.order.service.MergeCartService;                                        </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  29 import org.broadleafcommerce.core.order.service.OrderService;                                            </span>
<span class="4773848044130999111" onmouseenter="enter('4773848044130999111');" onmouseout="out('4773848044130999111');" style="">  30 import org.broadleafcommerce.core.order.service.call.MergeCartResponse;                                  </span>
<span class="4692349346970735648" onmouseenter="enter('4692349346970735648');" onmouseout="out('4692349346970735648');" style="">  31 import org.broadleafcommerce.core.order.service.exception.RemoveFromCartException;                       </span>
<span class="614288234168063731" onmouseenter="enter('614288234168063731');" onmouseout="out('614288234168063731');" style="">  32 import org.broadleafcommerce.core.order.service.type.OrderStatus;                                        </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  33 import org.broadleafcommerce.core.pricing.service.exception.PricingException;                            </span>
<span class="-7959314516630637692" onmouseenter="enter('-7959314516630637692');" onmouseout="out('-7959314516630637692');" style="">  34 import org.broadleafcommerce.core.web.service.UpdateCartService;                                         </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  35 import org.broadleafcommerce.profile.core.domain.Customer;                                               </span>
<span class="-6031821648249405492" onmouseenter="enter('-6031821648249405492');" onmouseout="out('-6031821648249405492');" style="">  36 import org.broadleafcommerce.profile.web.core.CustomerState;                                             </span>
<span class="-4063269764380812642" onmouseenter="enter('-4063269764380812642');" onmouseout="out('-4063269764380812642');" style="">  37 import org.broadleafcommerce.profile.web.core.security.CustomerStateRequestProcessor;                    </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="">  38 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="-4664978283136443479" onmouseenter="enter('-4664978283136443479');" onmouseout="out('-4664978283136443479');" style="">  39 import org.springframework.beans.factory.annotation.Qualifier;                                           </span>
<span class="8406454220154166073" onmouseenter="enter('8406454220154166073');" onmouseout="out('8406454220154166073');" style="">  40 import org.springframework.stereotype.Component;                                                         </span>
<span class="-208569050100229982" onmouseenter="enter('-208569050100229982');" onmouseout="out('-208569050100229982');" style="">  41 import org.springframework.web.context.request.ServletWebRequest;                                        </span>
<span class="8045684338721768523" onmouseenter="enter('8045684338721768523');" onmouseout="out('8045684338721768523');" style="">  42 import org.springframework.web.context.request.WebRequest;                                               </span>
<span  style="">  43                                                                                                          </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  44 import java.util.HashMap;                                                                                </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  45 import java.util.Map;                                                                                    </span>
<span  style="">  46                                                                                                          </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  47 import javax.annotation.Resource;                                                                        </span>
<span  style="">  48                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  49 /**                                                                                                      </span>
<span class="6949785334522964843" onmouseenter="enter('6949785334522964843');" onmouseout="out('6949785334522964843');" style="">  50  * Ensures that the customer&#x27;s current cart is available to the request.                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  51  *                                                                                                       </span>
<span class="-6044904845818784259" onmouseenter="enter('-6044904845818784259');" onmouseout="out('-6044904845818784259');" style="">  52  * Also invokes blMergeCartProcessor&quot; if the user has just logged in.                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  53  *                                                                                                       </span>
<span class="-7095132053112495828" onmouseenter="enter('-7095132053112495828');" onmouseout="out('-7095132053112495828');" style=""><abbr title="  54  * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters, Portlet Filters">  54  * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters,ðŸ”µ</abbr></span>
<span class="-8141282893564723204" onmouseenter="enter('-8141282893564723204');" onmouseout="out('-8141282893564723204');" style=""><abbr title="  55  * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests into WebRequests">  55  * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests intðŸ”µ</abbr></span>
<span class="-4149953333143573394" onmouseenter="enter('-4149953333143573394');" onmouseout="out('-4149953333143573394');" style="">  56  * via &lt;br /&gt;                                                                                            </span>
<span class="-2288628475956287787" onmouseenter="enter('-2288628475956287787');" onmouseout="out('-2288628475956287787');" style="">  57  * new ServletWebRequest(httpServletRequest); new PortletWebRequest(portletRequest); &lt;br /&gt;              </span>
<span class="-3373499860696082880" onmouseenter="enter('-3373499860696082880');" onmouseout="out('-3373499860696082880');" style="">  58  * For the interceptor pattern, you can simply implement a WebRequestInterceptor to invoke from there.   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  59  *                                                                                                       </span>
<span class="-2581105714976122669" onmouseenter="enter('-2581105714976122669');" onmouseout="out('-2581105714976122669');" style="">  60  * @author Phillip Verheyden                                                                             </span>
<span class="691156538645414019" onmouseenter="enter('691156538645414019');" onmouseout="out('691156538645414019');" style="">  61  * @see {@link CartStateFilter}                                                                          </span>
<span class="2345590137904887447" onmouseenter="enter('2345590137904887447');" onmouseout="out('2345590137904887447');" style="">  62  * @see {@link BroadleafWebRequestProcessor}                                                             </span>
<span class="-1762186850923570701" onmouseenter="enter('-1762186850923570701');" onmouseout="out('-1762186850923570701');" style="">  63  * @see {@link ServletWebRequest}                                                                        </span>
<span class="3606349442508010109" onmouseenter="enter('3606349442508010109');" onmouseout="out('3606349442508010109');" style="">  64  * @see {@link org.springframework.web.portlet.context.PortletWebRequest}                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  65  */                                                                                                      </span>
<span class="-7470255366716761762" onmouseenter="enter('-7470255366716761762');" onmouseout="out('-7470255366716761762');" style="">  66 @Component(&quot;blCartStateRequestProcessor&quot;)                                                                </span>
<span class="-1024024663522960488" onmouseenter="enter('-1024024663522960488');" onmouseout="out('-1024024663522960488');" style="">  67 public class CartStateRequestProcessor extends AbstractBroadleafWebRequestProcessor {                    </span>
<span  style="">  68                                                                                                          </span>
<span class="-4030114958641496547" onmouseenter="enter('-4030114958641496547');" onmouseout="out('-4030114958641496547');" style="">  69     /** Logger for this class and subclasses */                                                          </span>
<span class="8347569796035482168" onmouseenter="enter('8347569796035482168');" onmouseout="out('8347569796035482168');" style="">  70     protected final Log LOG = LogFactory.getLog(getClass());                                             </span>
<span  style="">  71                                                                                                          </span>
<span class="-5119951708732545437" onmouseenter="enter('-5119951708732545437');" onmouseout="out('-5119951708732545437');" style="">  72     public static final String BLC_RULE_MAP_PARAM = &quot;blRuleMap&quot;;                                         </span>
<span  style="">  73                                                                                                          </span>
<span class="8871930809399696828" onmouseenter="enter('8871930809399696828');" onmouseout="out('8871930809399696828');" style="">  74     private final String mergeCartResponseKey = &quot;bl_merge_cart_response&quot;;                                </span>
<span  style="">  75                                                                                                          </span>
<span class="6044335667426838645" onmouseenter="enter('6044335667426838645');" onmouseout="out('6044335667426838645');" style="">  76     @Resource(name = &quot;blCartStateRequestProcessorExtensionManager&quot;)                                      </span>
<span class="-8185812064196536655" onmouseenter="enter('-8185812064196536655');" onmouseout="out('-8185812064196536655');" style="">  77     protected CartStateRequestProcessorExtensionManager extensionManager;                                </span>
<span  style="">  78                                                                                                          </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style="">  79     @Resource(name = &quot;blOrderService&quot;)                                                                   </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style="">  80     protected OrderService orderService;                                                                 </span>
<span  style="">  81                                                                                                          </span>
<span class="-5832711189651279120" onmouseenter="enter('-5832711189651279120');" onmouseout="out('-5832711189651279120');" style="">  82     @Resource(name = &quot;blUpdateCartService&quot;)                                                              </span>
<span class="-6474151620344678255" onmouseenter="enter('-6474151620344678255');" onmouseout="out('-6474151620344678255');" style="">  83     protected UpdateCartService updateCartService;                                                       </span>
<span  style="">  84                                                                                                          </span>
<span class="3052322175513128984" onmouseenter="enter('3052322175513128984');" onmouseout="out('3052322175513128984');" style="">  85     @Resource(name = &quot;blMergeCartService&quot;)                                                               </span>
<span class="8208298738953975930" onmouseenter="enter('8208298738953975930');" onmouseout="out('8208298738953975930');" style="">  86     protected MergeCartService mergeCartService;                                                         </span>
<span  style="">  87                                                                                                          </span>
<span class="-4242208026742072321" onmouseenter="enter('-4242208026742072321');" onmouseout="out('-4242208026742072321');" style="">  88     @Resource(name = &quot;blCustomerStateRequestProcessor&quot;)                                                  </span>
<span class="-8544356289477463500" onmouseenter="enter('-8544356289477463500');" onmouseout="out('-8544356289477463500');" style="">  89     protected CustomerStateRequestProcessor customerStateRequestProcessor;                               </span>
<span  style="">  90                                                                                                          </span>
<span class="2602789178515286342" onmouseenter="enter('2602789178515286342');" onmouseout="out('2602789178515286342');" style="">  91     @Autowired(required = false)                                                                         </span>
<span class="-6782784833899333066" onmouseenter="enter('-6782784833899333066');" onmouseout="out('-6782784833899333066');" style="">  92     @Qualifier(&quot;blCrossAppAuthService&quot;)                                                                  </span>
<span class="-8287485368967055684" onmouseenter="enter('-8287485368967055684');" onmouseout="out('-8287485368967055684');" style="">  93     protected CrossAppAuthService crossAppAuthService;                                                   </span>
<span  style="">  94                                                                                                          </span>
<span class="-8085941326179479324" onmouseenter="enter('-8085941326179479324');" onmouseout="out('-8085941326179479324');" style="">  95     protected static String cartRequestAttributeName = &quot;cart&quot;;                                           </span>
<span  style="">  96                                                                                                          </span>
<span class="1778878837115274965" onmouseenter="enter('1778878837115274965');" onmouseout="out('1778878837115274965');" style="">  97     protected static String anonymousCartSessionAttributeName = &quot;anonymousCart&quot;;                         </span>
<span  style="">  98                                                                                                          </span>
<span class="3570049000477591403" onmouseenter="enter('3570049000477591403');" onmouseout="out('3570049000477591403');" style="">  99     public static final String OVERRIDE_CART_ATTR_NAME = &quot;_blc_overrideCartId&quot;;                          </span>
<span  style=""> 100                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 101     @Override                                                                                            </span>
<span class="-1087564729186269972" onmouseenter="enter('-1087564729186269972');" onmouseout="out('-1087564729186269972');" style=""> 102     public void process(WebRequest request) {                                                            </span>
<span class="-5515974955877981002" onmouseenter="enter('-5515974955877981002');" onmouseout="out('-5515974955877981002');" style=""> 103         Customer customer = CustomerState.getCustomer();                                                 </span>
<span  style=""> 104                                                                                                          </span>
<span class="-1371412200964570990" onmouseenter="enter('-1371412200964570990');" onmouseout="out('-1371412200964570990');" style=""> 105         if (customer == null) {                                                                          </span>
<span class="7950488184855848644" onmouseenter="enter('7950488184855848644');" onmouseout="out('7950488184855848644');" style=""><abbr title=" 106             LOG.info(&quot;No customer was found on the current request, no cart will be added to the current request. Ensure that the&quot;"> 106             LOG.info(&quot;No customer was found on the current request, no cart will be added to the current ðŸ”µ</abbr></span>
<span class="1683793928531658492" onmouseenter="enter('1683793928531658492');" onmouseout="out('1683793928531658492');" style=""> 107                     + &quot; blCustomerStateFilter occurs prior to the blCartStateFilter&quot;);                   </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 108             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 109         }                                                                                                </span>
<span  style=""> 110                                                                                                          </span>
<span class="5165057861481115804" onmouseenter="enter('5165057861481115804');" onmouseout="out('5165057861481115804');" style=""> 111         ExtensionResultHolder&lt;Order&gt; erh = new ExtensionResultHolder&lt;Order&gt;();                           </span>
<span class="5601587306461975752" onmouseenter="enter('5601587306461975752');" onmouseout="out('5601587306461975752');" style=""> 112         extensionManager.getProxy().lookupOrCreateCart(request, customer, erh);                          </span>
<span  style=""> 113                                                                                                          </span>
<span class="847348363243900875" onmouseenter="enter('847348363243900875');" onmouseout="out('847348363243900875');" style=""> 114         Order cart;                                                                                      </span>
<span class="5745510142944708411" onmouseenter="enter('5745510142944708411');" onmouseout="out('5745510142944708411');" style=""> 115         if (erh.getResult() != null) {                                                                   </span>
<span class="-7012036676670353222" onmouseenter="enter('-7012036676670353222');" onmouseout="out('-7012036676670353222');" style=""> 116             cart = orderService.findCartForCustomerWithEnhancements(customer, erh.getResult());          </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 117         } else {                                                                                         </span>
<span class="-3651333313322615728" onmouseenter="enter('-3651333313322615728');" onmouseout="out('-3651333313322615728');" style=""> 118             cart = getOverrideCart(request);                                                             </span>
<span class="1988681715974209575" onmouseenter="enter('1988681715974209575');" onmouseout="out('1988681715974209575');" style=""> 119             if (cart == null &amp;&amp; mergeCartNeeded(customer, request)) {                                    </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 120                 if (LOG.isDebugEnabled()) {                                                              </span>
<span class="-3126227002554961137" onmouseenter="enter('-3126227002554961137');" onmouseout="out('-3126227002554961137');" style=""> 121                     LOG.debug(&quot;Merge cart required, calling mergeCart &quot; + customer.getId());             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122                 }                                                                                        </span>
<span class="729291545179835184" onmouseenter="enter('729291545179835184');" onmouseout="out('729291545179835184');" style=""> 123                 cart = mergeCart(customer, request);                                                     </span>
<span class="-4362027600375335251" onmouseenter="enter('-4362027600375335251');" onmouseout="out('-4362027600375335251');" style=""> 124             } else if (cart == null) {                                                                   </span>
<span class="2009346020505670050" onmouseenter="enter('2009346020505670050');" onmouseout="out('2009346020505670050');" style=""> 125                 cart = orderService.findCartForCustomerWithEnhancements(customer);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 126             }                                                                                            </span>
<span  style=""> 127                                                                                                          </span>
<span class="-2482909530219509442" onmouseenter="enter('-2482909530219509442');" onmouseout="out('-2482909530219509442');" style=""> 128             if (cart == null) {                                                                          </span>
<span class="5619175994998149041" onmouseenter="enter('5619175994998149041');" onmouseout="out('5619175994998149041');" style=""> 129                 cart = orderService.getNullOrder();                                                      </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 130             } else {                                                                                     </span>
<span class="4717244821681544775" onmouseenter="enter('4717244821681544775');" onmouseout="out('4717244821681544775');" style=""> 131                 updateCartService.updateAndValidateCart(cart);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 132             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 133         }                                                                                                </span>
<span  style=""> 134                                                                                                          </span>
<span class="5570729529055502013" onmouseenter="enter('5570729529055502013');" onmouseout="out('5570729529055502013');" style=""> 135         updateCartRequestAttributes(request, cart);                                                      </span>
<span  style=""> 136                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137     }                                                                                                    </span>
<span  style=""> 138                                                                                                          </span>
<span class="4979469920847154161" onmouseenter="enter('4979469920847154161');" onmouseout="out('4979469920847154161');" style=""> 139     protected void updateCartRequestAttributes(WebRequest request, Order cart) {                         </span>
<span class="7956162395984675060" onmouseenter="enter('7956162395984675060');" onmouseout="out('7956162395984675060');" style=""> 140         request.setAttribute(cartRequestAttributeName, cart, WebRequest.SCOPE_REQUEST);                  </span>
<span  style=""> 141                                                                                                          </span>
<span class="2250168164336394635" onmouseenter="enter('2250168164336394635');" onmouseout="out('2250168164336394635');" style=""> 142         // Setup cart for content rule processing                                                        </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 143         @SuppressWarnings(&quot;unchecked&quot;)                                                                   </span>
<span class="-7009529966960283141" onmouseenter="enter('-7009529966960283141');" onmouseout="out('-7009529966960283141');" style=""><abbr title=" 144         Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRequest.SCOPE_REQUEST);"> 144         Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRðŸ”µ</abbr></span>
<span class="7719424053900967992" onmouseenter="enter('7719424053900967992');" onmouseout="out('7719424053900967992');" style=""> 145         if (ruleMap == null) {                                                                           </span>
<span class="7584262357946796931" onmouseenter="enter('7584262357946796931');" onmouseout="out('7584262357946796931');" style=""> 146             ruleMap = new HashMap&lt;String, Object&gt;();                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147         }                                                                                                </span>
<span class="-7082993895566141830" onmouseenter="enter('-7082993895566141830');" onmouseout="out('-7082993895566141830');" style=""> 148         ruleMap.put(&quot;order&quot;, cart);                                                                      </span>
<span  style=""> 149                                                                                                          </span>
<span class="-8486868703965614260" onmouseenter="enter('-8486868703965614260');" onmouseout="out('-8486868703965614260');" style=""><abbr title=" 150         // Leaving the following line in for backwards compatibility, but all rules should use order as the"> 150         // Leaving the following line in for backwards compatibility, but all rules should use order as tðŸ”µ</abbr></span>
<span class="8713525845734832130" onmouseenter="enter('8713525845734832130');" onmouseout="out('8713525845734832130');" style=""> 151         // variable name.                                                                                </span>
<span class="8466527126795751415" onmouseenter="enter('8466527126795751415');" onmouseout="out('8466527126795751415');" style=""> 152         ruleMap.put(&quot;cart&quot;, cart);                                                                       </span>
<span class="-29008669505238211" onmouseenter="enter('-29008669505238211');" onmouseout="out('-29008669505238211');" style=""> 153         request.setAttribute(BLC_RULE_MAP_PARAM, ruleMap, WebRequest.SCOPE_REQUEST);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 154     }                                                                                                    </span>
<span  style=""> 155                                                                                                          </span>
<span class="-7740129989171948267" onmouseenter="enter('-7740129989171948267');" onmouseout="out('-7740129989171948267');" style=""> 156     public Order getOverrideCart(WebRequest request) {                                                   </span>
<span class="-1923411589124412388" onmouseenter="enter('-1923411589124412388');" onmouseout="out('-1923411589124412388');" style=""> 157         Long orderId = null;                                                                             </span>
<span class="8442798390701474713" onmouseenter="enter('8442798390701474713');" onmouseout="out('8442798390701474713');" style=""> 158         if (BLCRequestUtils.isOKtoUseSession(request)) {                                                 </span>
<span class="-6220500265898572524" onmouseenter="enter('-6220500265898572524');" onmouseout="out('-6220500265898572524');" style=""> 159             orderId = (Long) request.getAttribute(OVERRIDE_CART_ATTR_NAME, WebRequest.SCOPE_SESSION);    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 160         }                                                                                                </span>
<span class="-4269565703796629770" onmouseenter="enter('-4269565703796629770');" onmouseout="out('-4269565703796629770');" style=""> 161         Order cart = null;                                                                               </span>
<span class="1156566652422122209" onmouseenter="enter('1156566652422122209');" onmouseout="out('1156566652422122209');" style=""> 162         if (orderId != null) {                                                                           </span>
<span class="-8700600114578005615" onmouseenter="enter('-8700600114578005615');" onmouseout="out('-8700600114578005615');" style=""> 163             cart = orderService.findOrderById(orderId);                                                  </span>
<span  style=""> 164                                                                                                          </span>
<span class="7744785123834062822" onmouseenter="enter('7744785123834062822');" onmouseout="out('7744785123834062822');" style=""> 165             if (cart == null ||                                                                          </span>
<span class="5826484381865674251" onmouseenter="enter('5826484381865674251');" onmouseout="out('5826484381865674251');" style=""> 166                     cart.getStatus().equals(OrderStatus.SUBMITTED) ||                                    </span>
<span class="7497968434275069271" onmouseenter="enter('7497968434275069271');" onmouseout="out('7497968434275069271');" style=""> 167                     cart.getStatus().equals(OrderStatus.CANCELLED)) {                                    </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 168                 return null;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 169             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 170         }                                                                                                </span>
<span  style=""> 171                                                                                                          </span>
<span class="-6231498894577494482" onmouseenter="enter('-6231498894577494482');" onmouseout="out('-6231498894577494482');" style=""> 172         return cart;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 173     }                                                                                                    </span>
<span  style=""> 174                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 175     /**                                                                                                  </span>
<span class="2543515529052098943" onmouseenter="enter('2543515529052098943');" onmouseout="out('2543515529052098943');" style=""><abbr title=" 176      * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implying that this is"> 176      * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implyðŸ”µ</abbr></span>
<span class="3368064714905975053" onmouseenter="enter('3368064714905975053');" onmouseout="out('3368064714905975053');" style=""> 177      * the logged in customer and we need to merge the carts                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 178      */                                                                                                  </span>
<span class="976646062219528439" onmouseenter="enter('976646062219528439');" onmouseout="out('976646062219528439');" style=""> 179     public boolean mergeCartNeeded(Customer customer, WebRequest request) {                              </span>
<span class="-2306216560497710970" onmouseenter="enter('-2306216560497710970');" onmouseout="out('-2306216560497710970');" style=""> 180         // When the user is a CSR, we want to disable cart merging                                       </span>
<span class="3724967001772040546" onmouseenter="enter('3724967001772040546');" onmouseout="out('3724967001772040546');" style=""> 181         if (crossAppAuthService != null &amp;&amp; crossAppAuthService.isAuthedFromAdmin()) {                    </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 182             return false;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183         }                                                                                                </span>
<span  style=""> 184                                                                                                          </span>
<span class="-2037434992999027399" onmouseenter="enter('-2037434992999027399');" onmouseout="out('-2037434992999027399');" style=""> 185         Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);        </span>
<span class="-4250888802750644339" onmouseenter="enter('-4250888802750644339');" onmouseout="out('-4250888802750644339');" style=""><abbr title=" 186         return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymousCustomer.getId()));"> 186         return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymoðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 187     }                                                                                                    </span>
<span  style=""> 188                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 189     /**                                                                                                  </span>
<span class="7405625424464652207" onmouseenter="enter('7405625424464652207');" onmouseout="out('7405625424464652207');" style=""><abbr title=" 190      * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;customer&lt;/b&gt;. This"> 190      * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;cusðŸ”µ</abbr></span>
<span class="-1511666666862096457" onmouseenter="enter('-1511666666862096457');" onmouseout="out('-1511666666862096457');" style=""> 191      * will also remove the customer from session after it has finished since it is no longer needed     </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 192      */                                                                                                  </span>
<span class="-8642121540254730814" onmouseenter="enter('-8642121540254730814');" onmouseout="out('-8642121540254730814');" style=""> 193     public Order mergeCart(Customer customer, WebRequest request) {                                      </span>
<span class="-2037434992999027399" onmouseenter="enter('-2037434992999027399');" onmouseout="out('-2037434992999027399');" style=""> 194         Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);        </span>
<span class="3567488516081904884" onmouseenter="enter('3567488516081904884');" onmouseout="out('3567488516081904884');" style=""> 195         MergeCartResponse mergeCartResponse;                                                             </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 196         try {                                                                                            </span>
<span class="6955444521103915231" onmouseenter="enter('6955444521103915231');" onmouseout="out('6955444521103915231');" style=""> 197             Order cart = orderService.findCartForCustomer(anonymousCustomer);                            </span>
<span class="1811537806218071823" onmouseenter="enter('1811537806218071823');" onmouseout="out('1811537806218071823');" style=""> 198             mergeCartResponse = mergeCartService.mergeCart(customer, cart);                              </span>
<span class="8325775691603685335" onmouseenter="enter('8325775691603685335');" onmouseout="out('8325775691603685335');" style=""> 199         } catch (PricingException e) {                                                                   </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 200             throw new RuntimeException(e);                                                               </span>
<span class="2264439919030346254" onmouseenter="enter('2264439919030346254');" onmouseout="out('2264439919030346254');" style=""> 201         } catch (RemoveFromCartException e) {                                                            </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 202             throw new RuntimeException(e);                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 203         }                                                                                                </span>
<span  style=""> 204                                                                                                          </span>
<span class="8442798390701474713" onmouseenter="enter('8442798390701474713');" onmouseout="out('8442798390701474713');" style=""> 205         if (BLCRequestUtils.isOKtoUseSession(request)) {                                                 </span>
<span class="-2691808975299315412" onmouseenter="enter('-2691808975299315412');" onmouseout="out('-2691808975299315412');" style=""> 206             // The anonymous customer from session is no longer needed; it can be safely removed         </span>
<span class="708215544978738967" onmouseenter="enter('708215544978738967');" onmouseout="out('708215544978738967');" style=""><abbr title=" 207             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeName(),"> 207             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeNamðŸ”µ</abbr></span>
<span class="-8992065164011733984" onmouseenter="enter('-8992065164011733984');" onmouseout="out('-8992065164011733984');" style=""> 208                     WebRequest.SCOPE_SESSION);                                                           </span>
<span class="-4675926701498081497" onmouseenter="enter('-4675926701498081497');" onmouseout="out('-4675926701498081497');" style=""><abbr title=" 209             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeName(),"> 209             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeNðŸ”µ</abbr></span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style=""> 210 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="-8992065164011733984" onmouseenter="enter('-8992065164011733984');" onmouseout="out('-8992065164011733984');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211                     WebRequest.SCOPE_SESSION);                                                           </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212                                                                                                          </span>
<span class="3895015659049002158" onmouseenter="enter('3895015659049002158');" onmouseout="out('3895015659049002158');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213             request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_SESSION);     </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 214 ||||||| BASE                                                                                             </span>
<span class="-7739736464352471759" onmouseenter="enter('-7739736464352471759');" onmouseout="out('-7739736464352471759');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215                     WebRequest.SCOPE_GLOBAL_SESSION);                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216                                                                                                          </span>
<span class="-4852350541649994679" onmouseenter="enter('-4852350541649994679');" onmouseout="out('-4852350541649994679');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 217             request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_GLOBAL_SESSION);"> 217             request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_GLOBAL_SESSIONðŸ”µ</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 218 =======                                                                                                  </span>
<span class="-7739736464352471759" onmouseenter="enter('-7739736464352471759');" onmouseout="out('-7739736464352471759');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219                     WebRequest.SCOPE_GLOBAL_SESSION);                                                    </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 220 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 221         }                                                                                                </span>
<span class="-3259849467893150872" onmouseenter="enter('-3259849467893150872');" onmouseout="out('-3259849467893150872');" style=""> 222         return mergeCartResponse.getOrder();                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 223     }                                                                                                    </span>
<span  style=""> 224                                                                                                          </span>
<span class="-1418008799783690701" onmouseenter="enter('-1418008799783690701');" onmouseout="out('-1418008799783690701');" style=""> 225     public static String getCartRequestAttributeName() {                                                 </span>
<span class="-7826677971898041484" onmouseenter="enter('-7826677971898041484');" onmouseout="out('-7826677971898041484');" style=""> 226         return cartRequestAttributeName;                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 227     }                                                                                                    </span>
<span  style=""> 228                                                                                                          </span>
<span class="8336122383281290122" onmouseenter="enter('8336122383281290122');" onmouseout="out('8336122383281290122');" style=""> 229     public static void setCartRequestAttributeName(String cartRequestAttributeName) {                    </span>
<span class="-9172660232233003621" onmouseenter="enter('-9172660232233003621');" onmouseout="out('-9172660232233003621');" style=""> 230         CartStateRequestProcessor.cartRequestAttributeName = cartRequestAttributeName;                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 231     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 232 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="6211491254187717485" onmouseenter="enter('6211491254187717485');" onmouseout="out('6211491254187717485');" style="">   3  * BroadleafCommerce Framework Web                                                                       </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="9047174597422306618" onmouseenter="enter('9047174597422306618');" onmouseout="out('9047174597422306618');" style="">  18 package org.broadleafcommerce.core.web.order.security;                                                   </span>
<span  style="">  19                                                                                                          </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  20 import java.util.HashMap;                                                                                </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  21 import java.util.Map;                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  22 import javax.annotation.Resource;                                                                        </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  23 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  24 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-44736846564495697" onmouseenter="enter('-44736846564495697');" onmouseout="out('-44736846564495697');" style="">  25 import org.broadleafcommerce.common.crossapp.service.CrossAppAuthService;                                </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  26 import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                     </span>
<span class="-6556509414411446728" onmouseenter="enter('-6556509414411446728');" onmouseout="out('-6556509414411446728');" style="">  27 import org.broadleafcommerce.common.util.BLCRequestUtils;                                                </span>
<span class="-6774162061490374742" onmouseenter="enter('-6774162061490374742');" onmouseout="out('-6774162061490374742');" style="">  28 import org.broadleafcommerce.common.web.AbstractBroadleafWebRequestProcessor;                            </span>
<span class="7310498659107503620" onmouseenter="enter('7310498659107503620');" onmouseout="out('7310498659107503620');" style="">  29 import org.broadleafcommerce.common.web.BroadleafWebRequestProcessor;                                    </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  30 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="1732621347693690105" onmouseenter="enter('1732621347693690105');" onmouseout="out('1732621347693690105');" style="">  31 import org.broadleafcommerce.core.order.service.MergeCartService;                                        </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  32 import org.broadleafcommerce.core.order.service.OrderService;                                            </span>
<span class="4773848044130999111" onmouseenter="enter('4773848044130999111');" onmouseout="out('4773848044130999111');" style="">  33 import org.broadleafcommerce.core.order.service.call.MergeCartResponse;                                  </span>
<span class="4692349346970735648" onmouseenter="enter('4692349346970735648');" onmouseout="out('4692349346970735648');" style="">  34 import org.broadleafcommerce.core.order.service.exception.RemoveFromCartException;                       </span>
<span class="614288234168063731" onmouseenter="enter('614288234168063731');" onmouseout="out('614288234168063731');" style="">  35 import org.broadleafcommerce.core.order.service.type.OrderStatus;                                        </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  36 import org.broadleafcommerce.core.pricing.service.exception.PricingException;                            </span>
<span class="-7959314516630637692" onmouseenter="enter('-7959314516630637692');" onmouseout="out('-7959314516630637692');" style="">  37 import org.broadleafcommerce.core.web.service.UpdateCartService;                                         </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  38 import org.broadleafcommerce.profile.core.domain.Customer;                                               </span>
<span class="-6031821648249405492" onmouseenter="enter('-6031821648249405492');" onmouseout="out('-6031821648249405492');" style="">  39 import org.broadleafcommerce.profile.web.core.CustomerState;                                             </span>
<span class="-4063269764380812642" onmouseenter="enter('-4063269764380812642');" onmouseout="out('-4063269764380812642');" style="">  40 import org.broadleafcommerce.profile.web.core.security.CustomerStateRequestProcessor;                    </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="">  41 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="-4664978283136443479" onmouseenter="enter('-4664978283136443479');" onmouseout="out('-4664978283136443479');" style="">  42 import org.springframework.beans.factory.annotation.Qualifier;                                           </span>
<span class="8406454220154166073" onmouseenter="enter('8406454220154166073');" onmouseout="out('8406454220154166073');" style="">  43 import org.springframework.stereotype.Component;                                                         </span>
<span class="-208569050100229982" onmouseenter="enter('-208569050100229982');" onmouseout="out('-208569050100229982');" style="">  44 import org.springframework.web.context.request.ServletWebRequest;                                        </span>
<span class="8045684338721768523" onmouseenter="enter('8045684338721768523');" onmouseout="out('8045684338721768523');" style="">  45 import org.springframework.web.context.request.WebRequest;                                               </span>
<span  style="">  46                                                                                                          </span>
<span  style="">  47                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  48 /**                                                                                                      </span>
<span class="6949785334522964843" onmouseenter="enter('6949785334522964843');" onmouseout="out('6949785334522964843');" style="">  49  * Ensures that the customer&#x27;s current cart is available to the request.                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  50  *                                                                                                       </span>
<span class="-6044904845818784259" onmouseenter="enter('-6044904845818784259');" onmouseout="out('-6044904845818784259');" style="">  51  * Also invokes blMergeCartProcessor&quot; if the user has just logged in.                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  52  *                                                                                                       </span>
<span class="-7095132053112495828" onmouseenter="enter('-7095132053112495828');" onmouseout="out('-7095132053112495828');" style=""><abbr title="  53  * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters, Portlet Filters">  53  * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters,ðŸ”µ</abbr></span>
<span class="-8141282893564723204" onmouseenter="enter('-8141282893564723204');" onmouseout="out('-8141282893564723204');" style=""><abbr title="  54  * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests into WebRequests">  54  * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests intðŸ”µ</abbr></span>
<span class="-4149953333143573394" onmouseenter="enter('-4149953333143573394');" onmouseout="out('-4149953333143573394');" style="">  55  * via &lt;br /&gt;                                                                                            </span>
<span class="-2288628475956287787" onmouseenter="enter('-2288628475956287787');" onmouseout="out('-2288628475956287787');" style="">  56  * new ServletWebRequest(httpServletRequest); new PortletWebRequest(portletRequest); &lt;br /&gt;              </span>
<span class="-3373499860696082880" onmouseenter="enter('-3373499860696082880');" onmouseout="out('-3373499860696082880');" style="">  57  * For the interceptor pattern, you can simply implement a WebRequestInterceptor to invoke from there.   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  58  *                                                                                                       </span>
<span class="-2581105714976122669" onmouseenter="enter('-2581105714976122669');" onmouseout="out('-2581105714976122669');" style="">  59  * @author Phillip Verheyden                                                                             </span>
<span class="691156538645414019" onmouseenter="enter('691156538645414019');" onmouseout="out('691156538645414019');" style="">  60  * @see {@link CartStateFilter}                                                                          </span>
<span class="2345590137904887447" onmouseenter="enter('2345590137904887447');" onmouseout="out('2345590137904887447');" style="">  61  * @see {@link BroadleafWebRequestProcessor}                                                             </span>
<span class="-1762186850923570701" onmouseenter="enter('-1762186850923570701');" onmouseout="out('-1762186850923570701');" style="">  62  * @see {@link ServletWebRequest}                                                                        </span>
<span class="3606349442508010109" onmouseenter="enter('3606349442508010109');" onmouseout="out('3606349442508010109');" style="">  63  * @see {@link org.springframework.web.portlet.context.PortletWebRequest}                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  64  */                                                                                                      </span>
<span class="-7470255366716761762" onmouseenter="enter('-7470255366716761762');" onmouseout="out('-7470255366716761762');" style="">  65 @Component(&quot;blCartStateRequestProcessor&quot;)                                                                </span>
<span class="-1024024663522960488" onmouseenter="enter('-1024024663522960488');" onmouseout="out('-1024024663522960488');" style="">  66 public class CartStateRequestProcessor extends AbstractBroadleafWebRequestProcessor {                    </span>
<span class="-4030114958641496547" onmouseenter="enter('-4030114958641496547');" onmouseout="out('-4030114958641496547');" style="">  67     /** Logger for this class and subclasses */                                                          </span>
<span class="8347569796035482168" onmouseenter="enter('8347569796035482168');" onmouseout="out('8347569796035482168');" style="">  68     protected final Log LOG = LogFactory.getLog(getClass());                                             </span>
<span  style="">  69                                                                                                          </span>
<span class="-5119951708732545437" onmouseenter="enter('-5119951708732545437');" onmouseout="out('-5119951708732545437');" style="">  70     public static final String BLC_RULE_MAP_PARAM = &quot;blRuleMap&quot;;                                         </span>
<span  style="">  71                                                                                                          </span>
<span class="8871930809399696828" onmouseenter="enter('8871930809399696828');" onmouseout="out('8871930809399696828');" style="">  72     private final String mergeCartResponseKey = &quot;bl_merge_cart_response&quot;;                                </span>
<span  style="">  73                                                                                                          </span>
<span class="6044335667426838645" onmouseenter="enter('6044335667426838645');" onmouseout="out('6044335667426838645');" style="">  74     @Resource(name = &quot;blCartStateRequestProcessorExtensionManager&quot;)                                      </span>
<span class="-8185812064196536655" onmouseenter="enter('-8185812064196536655');" onmouseout="out('-8185812064196536655');" style="">  75     protected CartStateRequestProcessorExtensionManager extensionManager;                                </span>
<span  style="">  76                                                                                                          </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style="">  77     @Resource(name = &quot;blOrderService&quot;)                                                                   </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style="">  78     protected OrderService orderService;                                                                 </span>
<span  style="">  79                                                                                                          </span>
<span class="-5832711189651279120" onmouseenter="enter('-5832711189651279120');" onmouseout="out('-5832711189651279120');" style="">  80     @Resource(name = &quot;blUpdateCartService&quot;)                                                              </span>
<span class="-6474151620344678255" onmouseenter="enter('-6474151620344678255');" onmouseout="out('-6474151620344678255');" style="">  81     protected UpdateCartService updateCartService;                                                       </span>
<span  style="">  82                                                                                                          </span>
<span class="3052322175513128984" onmouseenter="enter('3052322175513128984');" onmouseout="out('3052322175513128984');" style="">  83     @Resource(name = &quot;blMergeCartService&quot;)                                                               </span>
<span class="8208298738953975930" onmouseenter="enter('8208298738953975930');" onmouseout="out('8208298738953975930');" style="">  84     protected MergeCartService mergeCartService;                                                         </span>
<span  style="">  85                                                                                                          </span>
<span class="-4242208026742072321" onmouseenter="enter('-4242208026742072321');" onmouseout="out('-4242208026742072321');" style="">  86     @Resource(name = &quot;blCustomerStateRequestProcessor&quot;)                                                  </span>
<span class="-8544356289477463500" onmouseenter="enter('-8544356289477463500');" onmouseout="out('-8544356289477463500');" style="">  87     protected CustomerStateRequestProcessor customerStateRequestProcessor;                               </span>
<span  style="">  88                                                                                                          </span>
<span class="2602789178515286342" onmouseenter="enter('2602789178515286342');" onmouseout="out('2602789178515286342');" style="">  89     @Autowired(required = false)                                                                         </span>
<span class="-6782784833899333066" onmouseenter="enter('-6782784833899333066');" onmouseout="out('-6782784833899333066');" style="">  90     @Qualifier(&quot;blCrossAppAuthService&quot;)                                                                  </span>
<span class="-8287485368967055684" onmouseenter="enter('-8287485368967055684');" onmouseout="out('-8287485368967055684');" style="">  91     protected CrossAppAuthService crossAppAuthService;                                                   </span>
<span  style="">  92                                                                                                          </span>
<span class="-8085941326179479324" onmouseenter="enter('-8085941326179479324');" onmouseout="out('-8085941326179479324');" style="">  93     protected static String cartRequestAttributeName = &quot;cart&quot;;                                           </span>
<span  style="">  94                                                                                                          </span>
<span class="1778878837115274965" onmouseenter="enter('1778878837115274965');" onmouseout="out('1778878837115274965');" style="">  95     protected static String anonymousCartSessionAttributeName = &quot;anonymousCart&quot;;                         </span>
<span  style="">  96                                                                                                          </span>
<span class="3570049000477591403" onmouseenter="enter('3570049000477591403');" onmouseout="out('3570049000477591403');" style="">  97     public static final String OVERRIDE_CART_ATTR_NAME = &quot;_blc_overrideCartId&quot;;                          </span>
<span  style="">  98                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  99     @Override                                                                                            </span>
<span class="-1087564729186269972" onmouseenter="enter('-1087564729186269972');" onmouseout="out('-1087564729186269972');" style=""> 100     public void process(WebRequest request) {                                                            </span>
<span class="-5515974955877981002" onmouseenter="enter('-5515974955877981002');" onmouseout="out('-5515974955877981002');" style=""> 101         Customer customer = CustomerState.getCustomer();                                                 </span>
<span  style=""> 102                                                                                                          </span>
<span class="-1371412200964570990" onmouseenter="enter('-1371412200964570990');" onmouseout="out('-1371412200964570990');" style=""> 103         if (customer == null) {                                                                          </span>
<span class="7950488184855848644" onmouseenter="enter('7950488184855848644');" onmouseout="out('7950488184855848644');" style=""><abbr title=" 104             LOG.info(&quot;No customer was found on the current request, no cart will be added to the current request. Ensure that the&quot;"> 104             LOG.info(&quot;No customer was found on the current request, no cart will be added to the current ðŸ”µ</abbr></span>
<span class="1683793928531658492" onmouseenter="enter('1683793928531658492');" onmouseout="out('1683793928531658492');" style=""> 105                     + &quot; blCustomerStateFilter occurs prior to the blCartStateFilter&quot;);                   </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 106             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 107         }                                                                                                </span>
<span  style=""> 108                                                                                                          </span>
<span class="5165057861481115804" onmouseenter="enter('5165057861481115804');" onmouseout="out('5165057861481115804');" style=""> 109         ExtensionResultHolder&lt;Order&gt; erh = new ExtensionResultHolder&lt;Order&gt;();                           </span>
<span class="5601587306461975752" onmouseenter="enter('5601587306461975752');" onmouseout="out('5601587306461975752');" style=""> 110         extensionManager.getProxy().lookupOrCreateCart(request, customer, erh);                          </span>
<span  style=""> 111                                                                                                          </span>
<span class="847348363243900875" onmouseenter="enter('847348363243900875');" onmouseout="out('847348363243900875');" style=""> 112         Order cart;                                                                                      </span>
<span class="5745510142944708411" onmouseenter="enter('5745510142944708411');" onmouseout="out('5745510142944708411');" style=""> 113         if (erh.getResult() != null) {                                                                   </span>
<span class="-7012036676670353222" onmouseenter="enter('-7012036676670353222');" onmouseout="out('-7012036676670353222');" style=""> 114             cart = orderService.findCartForCustomerWithEnhancements(customer, erh.getResult());          </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 115         } else {                                                                                         </span>
<span class="-3651333313322615728" onmouseenter="enter('-3651333313322615728');" onmouseout="out('-3651333313322615728');" style=""> 116             cart = getOverrideCart(request);                                                             </span>
<span class="1988681715974209575" onmouseenter="enter('1988681715974209575');" onmouseout="out('1988681715974209575');" style=""> 117             if (cart == null &amp;&amp; mergeCartNeeded(customer, request)) {                                    </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 118                 if (LOG.isDebugEnabled()) {                                                              </span>
<span class="-3126227002554961137" onmouseenter="enter('-3126227002554961137');" onmouseout="out('-3126227002554961137');" style=""> 119                     LOG.debug(&quot;Merge cart required, calling mergeCart &quot; + customer.getId());             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 120                 }                                                                                        </span>
<span class="729291545179835184" onmouseenter="enter('729291545179835184');" onmouseout="out('729291545179835184');" style=""> 121                 cart = mergeCart(customer, request);                                                     </span>
<span class="-4362027600375335251" onmouseenter="enter('-4362027600375335251');" onmouseout="out('-4362027600375335251');" style=""> 122             } else if (cart == null) {                                                                   </span>
<span class="2009346020505670050" onmouseenter="enter('2009346020505670050');" onmouseout="out('2009346020505670050');" style=""> 123                 cart = orderService.findCartForCustomerWithEnhancements(customer);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 124             }                                                                                            </span>
<span  style=""> 125                                                                                                          </span>
<span class="-2482909530219509442" onmouseenter="enter('-2482909530219509442');" onmouseout="out('-2482909530219509442');" style=""> 126             if (cart == null) {                                                                          </span>
<span class="5619175994998149041" onmouseenter="enter('5619175994998149041');" onmouseout="out('5619175994998149041');" style=""> 127                 cart = orderService.getNullOrder();                                                      </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 128             } else {                                                                                     </span>
<span class="4717244821681544775" onmouseenter="enter('4717244821681544775');" onmouseout="out('4717244821681544775');" style=""> 129                 updateCartService.updateAndValidateCart(cart);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 130             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 131         }                                                                                                </span>
<span  style=""> 132                                                                                                          </span>
<span class="5570729529055502013" onmouseenter="enter('5570729529055502013');" onmouseout="out('5570729529055502013');" style=""> 133         updateCartRequestAttributes(request, cart);                                                      </span>
<span  style=""> 134                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 135     }                                                                                                    </span>
<span  style=""> 136                                                                                                          </span>
<span class="4979469920847154161" onmouseenter="enter('4979469920847154161');" onmouseout="out('4979469920847154161');" style=""> 137     protected void updateCartRequestAttributes(WebRequest request, Order cart) {                         </span>
<span class="7956162395984675060" onmouseenter="enter('7956162395984675060');" onmouseout="out('7956162395984675060');" style=""> 138         request.setAttribute(cartRequestAttributeName, cart, WebRequest.SCOPE_REQUEST);                  </span>
<span  style=""> 139                                                                                                          </span>
<span class="2250168164336394635" onmouseenter="enter('2250168164336394635');" onmouseout="out('2250168164336394635');" style=""> 140         // Setup cart for content rule processing                                                        </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 141         @SuppressWarnings(&quot;unchecked&quot;)                                                                   </span>
<span class="-7009529966960283141" onmouseenter="enter('-7009529966960283141');" onmouseout="out('-7009529966960283141');" style=""><abbr title=" 142         Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRequest.SCOPE_REQUEST);"> 142         Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRðŸ”µ</abbr></span>
<span class="7719424053900967992" onmouseenter="enter('7719424053900967992');" onmouseout="out('7719424053900967992');" style=""> 143         if (ruleMap == null) {                                                                           </span>
<span class="7584262357946796931" onmouseenter="enter('7584262357946796931');" onmouseout="out('7584262357946796931');" style=""> 144             ruleMap = new HashMap&lt;String, Object&gt;();                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 145         }                                                                                                </span>
<span class="-7082993895566141830" onmouseenter="enter('-7082993895566141830');" onmouseout="out('-7082993895566141830');" style=""> 146         ruleMap.put(&quot;order&quot;, cart);                                                                      </span>
<span  style=""> 147                                                                                                          </span>
<span class="-8486868703965614260" onmouseenter="enter('-8486868703965614260');" onmouseout="out('-8486868703965614260');" style=""><abbr title=" 148         // Leaving the following line in for backwards compatibility, but all rules should use order as the"> 148         // Leaving the following line in for backwards compatibility, but all rules should use order as tðŸ”µ</abbr></span>
<span class="8713525845734832130" onmouseenter="enter('8713525845734832130');" onmouseout="out('8713525845734832130');" style=""> 149         // variable name.                                                                                </span>
<span class="8466527126795751415" onmouseenter="enter('8466527126795751415');" onmouseout="out('8466527126795751415');" style=""> 150         ruleMap.put(&quot;cart&quot;, cart);                                                                       </span>
<span class="-29008669505238211" onmouseenter="enter('-29008669505238211');" onmouseout="out('-29008669505238211');" style=""> 151         request.setAttribute(BLC_RULE_MAP_PARAM, ruleMap, WebRequest.SCOPE_REQUEST);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 152     }                                                                                                    </span>
<span  style=""> 153                                                                                                          </span>
<span class="-7740129989171948267" onmouseenter="enter('-7740129989171948267');" onmouseout="out('-7740129989171948267');" style=""> 154     public Order getOverrideCart(WebRequest request) {                                                   </span>
<span class="-1923411589124412388" onmouseenter="enter('-1923411589124412388');" onmouseout="out('-1923411589124412388');" style=""> 155         Long orderId = null;                                                                             </span>
<span class="8442798390701474713" onmouseenter="enter('8442798390701474713');" onmouseout="out('8442798390701474713');" style=""> 156         if (BLCRequestUtils.isOKtoUseSession(request)) {                                                 </span>
<span class="-8673112719831413480" onmouseenter="enter('-8673112719831413480');" onmouseout="out('-8673112719831413480');" style=""> 157             orderId = ((Long) (request.getAttribute(OVERRIDE_CART_ATTR_NAME, WebRequest.SCOPE_SESSION)));</span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 158         }                                                                                                </span>
<span class="-4269565703796629770" onmouseenter="enter('-4269565703796629770');" onmouseout="out('-4269565703796629770');" style=""> 159         Order cart = null;                                                                               </span>
<span class="1156566652422122209" onmouseenter="enter('1156566652422122209');" onmouseout="out('1156566652422122209');" style=""> 160         if (orderId != null) {                                                                           </span>
<span class="-8700600114578005615" onmouseenter="enter('-8700600114578005615');" onmouseout="out('-8700600114578005615');" style=""> 161             cart = orderService.findOrderById(orderId);                                                  </span>
<span class="6334775178382828868" onmouseenter="enter('6334775178382828868');" onmouseout="out('6334775178382828868');" style=""><abbr title=" 162             if (((cart == null) || cart.getStatus().equals(OrderStatus.SUBMITTED)) || cart.getStatus().equals(OrderStatus.CANCELLED)) {"> 162             if (((cart == null) || cart.getStatus().equals(OrderStatus.SUBMITTED)) || cart.getStatus().eqðŸ”µ</abbr></span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 163                 return null;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 164             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 165         }                                                                                                </span>
<span class="-6231498894577494482" onmouseenter="enter('-6231498894577494482');" onmouseout="out('-6231498894577494482');" style=""> 166         return cart;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 167     }                                                                                                    </span>
<span  style=""> 168                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 169     /**                                                                                                  </span>
<span class="2543515529052098943" onmouseenter="enter('2543515529052098943');" onmouseout="out('2543515529052098943');" style=""><abbr title=" 170      * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implying that this is"> 170      * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implyðŸ”µ</abbr></span>
<span class="3368064714905975053" onmouseenter="enter('3368064714905975053');" onmouseout="out('3368064714905975053');" style=""> 171      * the logged in customer and we need to merge the carts                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 172      */                                                                                                  </span>
<span class="976646062219528439" onmouseenter="enter('976646062219528439');" onmouseout="out('976646062219528439');" style=""> 173     public boolean mergeCartNeeded(Customer customer, WebRequest request) {                              </span>
<span class="-2306216560497710970" onmouseenter="enter('-2306216560497710970');" onmouseout="out('-2306216560497710970');" style=""> 174         // When the user is a CSR, we want to disable cart merging                                       </span>
<span class="3724967001772040546" onmouseenter="enter('3724967001772040546');" onmouseout="out('3724967001772040546');" style=""> 175         if (crossAppAuthService != null &amp;&amp; crossAppAuthService.isAuthedFromAdmin()) {                    </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 176             return false;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 177         }                                                                                                </span>
<span  style=""> 178                                                                                                          </span>
<span class="-2037434992999027399" onmouseenter="enter('-2037434992999027399');" onmouseout="out('-2037434992999027399');" style=""> 179         Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);        </span>
<span class="-4250888802750644339" onmouseenter="enter('-4250888802750644339');" onmouseout="out('-4250888802750644339');" style=""><abbr title=" 180         return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymousCustomer.getId()));"> 180         return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymoðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181     }                                                                                                    </span>
<span  style=""> 182                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 183     /**                                                                                                  </span>
<span class="7405625424464652207" onmouseenter="enter('7405625424464652207');" onmouseout="out('7405625424464652207');" style=""><abbr title=" 184      * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;customer&lt;/b&gt;. This"> 184      * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;cusðŸ”µ</abbr></span>
<span class="-1511666666862096457" onmouseenter="enter('-1511666666862096457');" onmouseout="out('-1511666666862096457');" style=""> 185      * will also remove the customer from session after it has finished since it is no longer needed     </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 186      */                                                                                                  </span>
<span class="-8642121540254730814" onmouseenter="enter('-8642121540254730814');" onmouseout="out('-8642121540254730814');" style=""> 187     public Order mergeCart(Customer customer, WebRequest request) {                                      </span>
<span class="-2037434992999027399" onmouseenter="enter('-2037434992999027399');" onmouseout="out('-2037434992999027399');" style=""> 188         Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);        </span>
<span class="3567488516081904884" onmouseenter="enter('3567488516081904884');" onmouseout="out('3567488516081904884');" style=""> 189         MergeCartResponse mergeCartResponse;                                                             </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 190         try {                                                                                            </span>
<span class="6955444521103915231" onmouseenter="enter('6955444521103915231');" onmouseout="out('6955444521103915231');" style=""> 191             Order cart = orderService.findCartForCustomer(anonymousCustomer);                            </span>
<span class="1811537806218071823" onmouseenter="enter('1811537806218071823');" onmouseout="out('1811537806218071823');" style=""> 192             mergeCartResponse = mergeCartService.mergeCart(customer, cart);                              </span>
<span class="8325775691603685335" onmouseenter="enter('8325775691603685335');" onmouseout="out('8325775691603685335');" style=""> 193         } catch (PricingException e) {                                                                   </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 194             throw new RuntimeException(e);                                                               </span>
<span class="2264439919030346254" onmouseenter="enter('2264439919030346254');" onmouseout="out('2264439919030346254');" style=""> 195         } catch (RemoveFromCartException e) {                                                            </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 196             throw new RuntimeException(e);                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 197         }                                                                                                </span>
<span class="8442798390701474713" onmouseenter="enter('8442798390701474713');" onmouseout="out('8442798390701474713');" style=""> 198         if (BLCRequestUtils.isOKtoUseSession(request)) {                                                 </span>
<span class="-2691808975299315412" onmouseenter="enter('-2691808975299315412');" onmouseout="out('-2691808975299315412');" style=""> 199             // The anonymous customer from session is no longer needed; it can be safely removed         </span>
<span class="-666891249441057195" onmouseenter="enter('-666891249441057195');" onmouseout="out('-666891249441057195');" style=""><abbr title=" 200             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeName(), WebRequest.SCOPE_SESSION);"> 200             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeNamðŸ”µ</abbr></span>
<span class="6837904310297202466" onmouseenter="enter('6837904310297202466');" onmouseout="out('6837904310297202466');" style=""><abbr title=" 201             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeName(), WebRequest.SCOPE_SESSION);"> 201             request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeNðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 202         }                                                                                                </span>
<span class="-3259849467893150872" onmouseenter="enter('-3259849467893150872');" onmouseout="out('-3259849467893150872');" style=""> 203         return mergeCartResponse.getOrder();                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 204     }                                                                                                    </span>
<span  style=""> 205                                                                                                          </span>
<span class="-1418008799783690701" onmouseenter="enter('-1418008799783690701');" onmouseout="out('-1418008799783690701');" style=""> 206     public static String getCartRequestAttributeName() {                                                 </span>
<span class="-7826677971898041484" onmouseenter="enter('-7826677971898041484');" onmouseout="out('-7826677971898041484');" style=""> 207         return cartRequestAttributeName;                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 208     }                                                                                                    </span>
<span  style=""> 209                                                                                                          </span>
<span class="8336122383281290122" onmouseenter="enter('8336122383281290122');" onmouseout="out('8336122383281290122');" style=""> 210     public static void setCartRequestAttributeName(String cartRequestAttributeName) {                    </span>
<span class="-9172660232233003621" onmouseenter="enter('-9172660232233003621');" onmouseout="out('-9172660232233003621');" style=""> 211         CartStateRequestProcessor.cartRequestAttributeName = cartRequestAttributeName;                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 212     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 213 }                                                                                                        </span>

















</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="6211491254187717485" onmouseenter="enter('6211491254187717485');" onmouseout="out('6211491254187717485');" style="">   3   * BroadleafCommerce Framework Web                                                                                </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="9047174597422306618" onmouseenter="enter('9047174597422306618');" onmouseout="out('9047174597422306618');" style="">  18  package org.broadleafcommerce.core.web.order.security;                                                            </span>
<span  style="">  19                                                                                                                    </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="-44736846564495697" onmouseenter="enter('-44736846564495697');" onmouseout="out('-44736846564495697');" style="">  22  import org.broadleafcommerce.common.crossapp.service.CrossAppAuthService;                                         </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  23  import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                              </span>
<span class="-6556509414411446728" onmouseenter="enter('-6556509414411446728');" onmouseout="out('-6556509414411446728');" style="">  24  import org.broadleafcommerce.common.util.BLCRequestUtils;                                                         </span>
<span class="-6774162061490374742" onmouseenter="enter('-6774162061490374742');" onmouseout="out('-6774162061490374742');" style="">  25  import org.broadleafcommerce.common.web.AbstractBroadleafWebRequestProcessor;                                     </span>
<span class="7310498659107503620" onmouseenter="enter('7310498659107503620');" onmouseout="out('7310498659107503620');" style="">  26  import org.broadleafcommerce.common.web.BroadleafWebRequestProcessor;                                             </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  27  import org.broadleafcommerce.core.order.domain.Order;                                                             </span>
<span class="1732621347693690105" onmouseenter="enter('1732621347693690105');" onmouseout="out('1732621347693690105');" style="">  28  import org.broadleafcommerce.core.order.service.MergeCartService;                                                 </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  29  import org.broadleafcommerce.core.order.service.OrderService;                                                     </span>
<span class="4773848044130999111" onmouseenter="enter('4773848044130999111');" onmouseout="out('4773848044130999111');" style="">  30  import org.broadleafcommerce.core.order.service.call.MergeCartResponse;                                           </span>
<span class="4692349346970735648" onmouseenter="enter('4692349346970735648');" onmouseout="out('4692349346970735648');" style="">  31  import org.broadleafcommerce.core.order.service.exception.RemoveFromCartException;                                </span>
<span class="614288234168063731" onmouseenter="enter('614288234168063731');" onmouseout="out('614288234168063731');" style="">  32  import org.broadleafcommerce.core.order.service.type.OrderStatus;                                                 </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  33  import org.broadleafcommerce.core.pricing.service.exception.PricingException;                                     </span>
<span class="-7959314516630637692" onmouseenter="enter('-7959314516630637692');" onmouseout="out('-7959314516630637692');" style="">  34  import org.broadleafcommerce.core.web.service.UpdateCartService;                                                  </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  35  import org.broadleafcommerce.profile.core.domain.Customer;                                                        </span>
<span class="-6031821648249405492" onmouseenter="enter('-6031821648249405492');" onmouseout="out('-6031821648249405492');" style="">  36  import org.broadleafcommerce.profile.web.core.CustomerState;                                                      </span>
<span class="-4063269764380812642" onmouseenter="enter('-4063269764380812642');" onmouseout="out('-4063269764380812642');" style="">  37  import org.broadleafcommerce.profile.web.core.security.CustomerStateRequestProcessor;                             </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="">  38  import org.springframework.beans.factory.annotation.Autowired;                                                    </span>
<span class="-4664978283136443479" onmouseenter="enter('-4664978283136443479');" onmouseout="out('-4664978283136443479');" style="">  39  import org.springframework.beans.factory.annotation.Qualifier;                                                    </span>
<span class="8406454220154166073" onmouseenter="enter('8406454220154166073');" onmouseout="out('8406454220154166073');" style="">  40  import org.springframework.stereotype.Component;                                                                  </span>
<span class="-208569050100229982" onmouseenter="enter('-208569050100229982');" onmouseout="out('-208569050100229982');" style="">  41  import org.springframework.web.context.request.ServletWebRequest;                                                 </span>
<span class="8045684338721768523" onmouseenter="enter('8045684338721768523');" onmouseout="out('8045684338721768523');" style="">  42  import org.springframework.web.context.request.WebRequest;                                                        </span>
<span  style="">  43                                                                                                                    </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  44  import java.util.HashMap;                                                                                         </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  45  import java.util.Map;                                                                                             </span>
<span  style="">  46                                                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  47  import javax.annotation.Resource;                                                                                 </span>
<span  style="">  48                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  49  /**                                                                                                               </span>
<span class="6949785334522964843" onmouseenter="enter('6949785334522964843');" onmouseout="out('6949785334522964843');" style="">  50   * Ensures that the customer&#x27;s current cart is available to the request.                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  51   *                                                                                                                </span>
<span class="-6044904845818784259" onmouseenter="enter('-6044904845818784259');" onmouseout="out('-6044904845818784259');" style="">  52   * Also invokes blMergeCartProcessor&quot; if the user has just logged in.                                             </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  53   *                                                                                                                </span>
<span class="-7095132053112495828" onmouseenter="enter('-7095132053112495828');" onmouseout="out('-7095132053112495828');" style=""><abbr title="  54   * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters, Portlet Filters">  54   * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters, Portlet ðŸ”µ</abbr></span>
<span class="-8141282893564723204" onmouseenter="enter('-8141282893564723204');" onmouseout="out('-8141282893564723204');" style=""><abbr title="  55   * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests into WebRequests">  55   * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests into WebRequðŸ”µ</abbr></span>
<span class="-4149953333143573394" onmouseenter="enter('-4149953333143573394');" onmouseout="out('-4149953333143573394');" style="">  56   * via &lt;br /&gt;                                                                                                     </span>
<span class="-2288628475956287787" onmouseenter="enter('-2288628475956287787');" onmouseout="out('-2288628475956287787');" style="">  57   * new ServletWebRequest(httpServletRequest); new PortletWebRequest(portletRequest); &lt;br /&gt;                       </span>
<span class="-3373499860696082880" onmouseenter="enter('-3373499860696082880');" onmouseout="out('-3373499860696082880');" style="">  58   * For the interceptor pattern, you can simply implement a WebRequestInterceptor to invoke from there.            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  59   *                                                                                                                </span>
<span class="-2581105714976122669" onmouseenter="enter('-2581105714976122669');" onmouseout="out('-2581105714976122669');" style="">  60   * @author Phillip Verheyden                                                                                      </span>
<span class="691156538645414019" onmouseenter="enter('691156538645414019');" onmouseout="out('691156538645414019');" style="">  61   * @see {@link CartStateFilter}                                                                                   </span>
<span class="2345590137904887447" onmouseenter="enter('2345590137904887447');" onmouseout="out('2345590137904887447');" style="">  62   * @see {@link BroadleafWebRequestProcessor}                                                                      </span>
<span class="-1762186850923570701" onmouseenter="enter('-1762186850923570701');" onmouseout="out('-1762186850923570701');" style="">  63   * @see {@link ServletWebRequest}                                                                                 </span>
<span class="3606349442508010109" onmouseenter="enter('3606349442508010109');" onmouseout="out('3606349442508010109');" style="">  64   * @see {@link org.springframework.web.portlet.context.PortletWebRequest}                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  65   */                                                                                                               </span>
<span class="-7470255366716761762" onmouseenter="enter('-7470255366716761762');" onmouseout="out('-7470255366716761762');" style="">  66  @Component(&quot;blCartStateRequestProcessor&quot;)                                                                         </span>
<span class="-1024024663522960488" onmouseenter="enter('-1024024663522960488');" onmouseout="out('-1024024663522960488');" style="">  67  public class CartStateRequestProcessor extends AbstractBroadleafWebRequestProcessor {                             </span>
<span  style="">  68                                                                                                                    </span>
<span class="-4030114958641496547" onmouseenter="enter('-4030114958641496547');" onmouseout="out('-4030114958641496547');" style="">  69      /** Logger for this class and subclasses */                                                                   </span>
<span class="8347569796035482168" onmouseenter="enter('8347569796035482168');" onmouseout="out('8347569796035482168');" style="">  70      protected final Log LOG = LogFactory.getLog(getClass());                                                      </span>
<span  style="">  71                                                                                                                    </span>
<span class="-5119951708732545437" onmouseenter="enter('-5119951708732545437');" onmouseout="out('-5119951708732545437');" style="">  72      public static final String BLC_RULE_MAP_PARAM = &quot;blRuleMap&quot;;                                                  </span>
<span  style="">  73                                                                                                                    </span>
<span class="8871930809399696828" onmouseenter="enter('8871930809399696828');" onmouseout="out('8871930809399696828');" style="">  74      private final String mergeCartResponseKey = &quot;bl_merge_cart_response&quot;;                                         </span>
<span  style="">  75                                                                                                                    </span>
<span class="6044335667426838645" onmouseenter="enter('6044335667426838645');" onmouseout="out('6044335667426838645');" style="">  76      @Resource(name = &quot;blCartStateRequestProcessorExtensionManager&quot;)                                               </span>
<span class="-8185812064196536655" onmouseenter="enter('-8185812064196536655');" onmouseout="out('-8185812064196536655');" style="">  77      protected CartStateRequestProcessorExtensionManager extensionManager;                                         </span>
<span  style="">  78                                                                                                                    </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style="">  79      @Resource(name = &quot;blOrderService&quot;)                                                                            </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style="">  80      protected OrderService orderService;                                                                          </span>
<span  style="">  81                                                                                                                    </span>
<span class="-5832711189651279120" onmouseenter="enter('-5832711189651279120');" onmouseout="out('-5832711189651279120');" style="">  82      @Resource(name = &quot;blUpdateCartService&quot;)                                                                       </span>
<span class="-6474151620344678255" onmouseenter="enter('-6474151620344678255');" onmouseout="out('-6474151620344678255');" style="">  83      protected UpdateCartService updateCartService;                                                                </span>
<span  style="">  84                                                                                                                    </span>
<span class="3052322175513128984" onmouseenter="enter('3052322175513128984');" onmouseout="out('3052322175513128984');" style="">  85      @Resource(name = &quot;blMergeCartService&quot;)                                                                        </span>
<span class="8208298738953975930" onmouseenter="enter('8208298738953975930');" onmouseout="out('8208298738953975930');" style="">  86      protected MergeCartService mergeCartService;                                                                  </span>
<span  style="">  87                                                                                                                    </span>
<span class="-4242208026742072321" onmouseenter="enter('-4242208026742072321');" onmouseout="out('-4242208026742072321');" style="">  88      @Resource(name = &quot;blCustomerStateRequestProcessor&quot;)                                                           </span>
<span class="-8544356289477463500" onmouseenter="enter('-8544356289477463500');" onmouseout="out('-8544356289477463500');" style="">  89      protected CustomerStateRequestProcessor customerStateRequestProcessor;                                        </span>
<span  style="">  90                                                                                                                    </span>
<span class="2602789178515286342" onmouseenter="enter('2602789178515286342');" onmouseout="out('2602789178515286342');" style="">  91      @Autowired(required = false)                                                                                  </span>
<span class="-6782784833899333066" onmouseenter="enter('-6782784833899333066');" onmouseout="out('-6782784833899333066');" style="">  92      @Qualifier(&quot;blCrossAppAuthService&quot;)                                                                           </span>
<span class="-8287485368967055684" onmouseenter="enter('-8287485368967055684');" onmouseout="out('-8287485368967055684');" style="">  93      protected CrossAppAuthService crossAppAuthService;                                                            </span>
<span  style="">  94                                                                                                                    </span>
<span class="-8085941326179479324" onmouseenter="enter('-8085941326179479324');" onmouseout="out('-8085941326179479324');" style="">  95      protected static String cartRequestAttributeName = &quot;cart&quot;;                                                    </span>
<span  style="">  96                                                                                                                    </span>
<span class="1778878837115274965" onmouseenter="enter('1778878837115274965');" onmouseout="out('1778878837115274965');" style="">  97      protected static String anonymousCartSessionAttributeName = &quot;anonymousCart&quot;;                                  </span>
<span  style="">  98                                                                                                                    </span>
<span class="3570049000477591403" onmouseenter="enter('3570049000477591403');" onmouseout="out('3570049000477591403');" style="">  99      public static final String OVERRIDE_CART_ATTR_NAME = &quot;_blc_overrideCartId&quot;;                                   </span>
<span  style=""> 100                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 101      @Override                                                                                                     </span>
<span class="-1087564729186269972" onmouseenter="enter('-1087564729186269972');" onmouseout="out('-1087564729186269972');" style=""> 102      public void process(WebRequest request) {                                                                     </span>
<span class="-5515974955877981002" onmouseenter="enter('-5515974955877981002');" onmouseout="out('-5515974955877981002');" style=""> 103          Customer customer = CustomerState.getCustomer();                                                          </span>
<span  style=""> 104                                                                                                                    </span>
<span class="-1371412200964570990" onmouseenter="enter('-1371412200964570990');" onmouseout="out('-1371412200964570990');" style=""> 105          if (customer == null) {                                                                                   </span>
<span class="7950488184855848644" onmouseenter="enter('7950488184855848644');" onmouseout="out('7950488184855848644');" style=""><abbr title=" 106              LOG.info(&quot;No customer was found on the current request, no cart will be added to the current request. Ensure that the&quot;"> 106              LOG.info(&quot;No customer was found on the current request, no cart will be added to the current request. ðŸ”µ</abbr></span>
<span class="1683793928531658492" onmouseenter="enter('1683793928531658492');" onmouseout="out('1683793928531658492');" style=""> 107                      + &quot; blCustomerStateFilter occurs prior to the blCartStateFilter&quot;);                            </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 108              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 109          }                                                                                                         </span>
<span  style=""> 110                                                                                                                    </span>
<span class="5165057861481115804" onmouseenter="enter('5165057861481115804');" onmouseout="out('5165057861481115804');" style=""> 111          ExtensionResultHolder&lt;Order&gt; erh = new ExtensionResultHolder&lt;Order&gt;();                                    </span>
<span class="5601587306461975752" onmouseenter="enter('5601587306461975752');" onmouseout="out('5601587306461975752');" style=""> 112          extensionManager.getProxy().lookupOrCreateCart(request, customer, erh);                                   </span>
<span  style=""> 113                                                                                                                    </span>
<span class="847348363243900875" onmouseenter="enter('847348363243900875');" onmouseout="out('847348363243900875');" style=""> 114          Order cart;                                                                                               </span>
<span class="5745510142944708411" onmouseenter="enter('5745510142944708411');" onmouseout="out('5745510142944708411');" style=""> 115          if (erh.getResult() != null) {                                                                            </span>
<span class="-7012036676670353222" onmouseenter="enter('-7012036676670353222');" onmouseout="out('-7012036676670353222');" style=""> 116              cart = orderService.findCartForCustomerWithEnhancements(customer, erh.getResult());                   </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 117          } else {                                                                                                  </span>
<span class="-3651333313322615728" onmouseenter="enter('-3651333313322615728');" onmouseout="out('-3651333313322615728');" style=""> 118              cart = getOverrideCart(request);                                                                      </span>
<span class="1988681715974209575" onmouseenter="enter('1988681715974209575');" onmouseout="out('1988681715974209575');" style=""> 119              if (cart == null &amp;&amp; mergeCartNeeded(customer, request)) {                                             </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 120                  if (LOG.isDebugEnabled()) {                                                                       </span>
<span class="-3126227002554961137" onmouseenter="enter('-3126227002554961137');" onmouseout="out('-3126227002554961137');" style=""> 121                      LOG.debug(&quot;Merge cart required, calling mergeCart &quot; + customer.getId());                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122                  }                                                                                                 </span>
<span class="729291545179835184" onmouseenter="enter('729291545179835184');" onmouseout="out('729291545179835184');" style=""> 123                  cart = mergeCart(customer, request);                                                              </span>
<span class="-4362027600375335251" onmouseenter="enter('-4362027600375335251');" onmouseout="out('-4362027600375335251');" style=""> 124              } else if (cart == null) {                                                                            </span>
<span class="2009346020505670050" onmouseenter="enter('2009346020505670050');" onmouseout="out('2009346020505670050');" style=""> 125                  cart = orderService.findCartForCustomerWithEnhancements(customer);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 126              }                                                                                                     </span>
<span  style=""> 127                                                                                                                    </span>
<span class="-2482909530219509442" onmouseenter="enter('-2482909530219509442');" onmouseout="out('-2482909530219509442');" style=""> 128              if (cart == null) {                                                                                   </span>
<span class="5619175994998149041" onmouseenter="enter('5619175994998149041');" onmouseout="out('5619175994998149041');" style=""> 129                  cart = orderService.getNullOrder();                                                               </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 130              } else {                                                                                              </span>
<span class="4717244821681544775" onmouseenter="enter('4717244821681544775');" onmouseout="out('4717244821681544775');" style=""> 131                  updateCartService.updateAndValidateCart(cart);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 132              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 133          }                                                                                                         </span>
<span  style=""> 134                                                                                                                    </span>
<span class="5570729529055502013" onmouseenter="enter('5570729529055502013');" onmouseout="out('5570729529055502013');" style=""> 135          updateCartRequestAttributes(request, cart);                                                               </span>
<span  style=""> 136                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137      }                                                                                                             </span>
<span  style=""> 138                                                                                                                    </span>
<span class="4979469920847154161" onmouseenter="enter('4979469920847154161');" onmouseout="out('4979469920847154161');" style=""> 139      protected void updateCartRequestAttributes(WebRequest request, Order cart) {                                  </span>
<span class="7956162395984675060" onmouseenter="enter('7956162395984675060');" onmouseout="out('7956162395984675060');" style=""> 140          request.setAttribute(cartRequestAttributeName, cart, WebRequest.SCOPE_REQUEST);                           </span>
<span  style=""> 141                                                                                                                    </span>
<span class="2250168164336394635" onmouseenter="enter('2250168164336394635');" onmouseout="out('2250168164336394635');" style=""> 142          // Setup cart for content rule processing                                                                 </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 143          @SuppressWarnings(&quot;unchecked&quot;)                                                                            </span>
<span class="-7009529966960283141" onmouseenter="enter('-7009529966960283141');" onmouseout="out('-7009529966960283141');" style=""><abbr title=" 144          Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRequest.SCOPE_REQUEST);"> 144          Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRequest.SCðŸ”µ</abbr></span>
<span class="7719424053900967992" onmouseenter="enter('7719424053900967992');" onmouseout="out('7719424053900967992');" style=""> 145          if (ruleMap == null) {                                                                                    </span>
<span class="7584262357946796931" onmouseenter="enter('7584262357946796931');" onmouseout="out('7584262357946796931');" style=""> 146              ruleMap = new HashMap&lt;String, Object&gt;();                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147          }                                                                                                         </span>
<span class="-7082993895566141830" onmouseenter="enter('-7082993895566141830');" onmouseout="out('-7082993895566141830');" style=""> 148          ruleMap.put(&quot;order&quot;, cart);                                                                               </span>
<span  style=""> 149                                                                                                                    </span>
<span class="-8486868703965614260" onmouseenter="enter('-8486868703965614260');" onmouseout="out('-8486868703965614260');" style=""> 150          // Leaving the following line in for backwards compatibility, but all rules should use order as the       </span>
<span class="8713525845734832130" onmouseenter="enter('8713525845734832130');" onmouseout="out('8713525845734832130');" style=""> 151          // variable name.                                                                                         </span>
<span class="8466527126795751415" onmouseenter="enter('8466527126795751415');" onmouseout="out('8466527126795751415');" style=""> 152          ruleMap.put(&quot;cart&quot;, cart);                                                                                </span>
<span class="-29008669505238211" onmouseenter="enter('-29008669505238211');" onmouseout="out('-29008669505238211');" style=""> 153          request.setAttribute(BLC_RULE_MAP_PARAM, ruleMap, WebRequest.SCOPE_REQUEST);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 154      }                                                                                                             </span>
<span  style=""> 155                                                                                                                    </span>
<span class="-7740129989171948267" onmouseenter="enter('-7740129989171948267');" onmouseout="out('-7740129989171948267');" style=""> 156      public Order getOverrideCart(WebRequest request) {                                                            </span>
<span class="-1923411589124412388" onmouseenter="enter('-1923411589124412388');" onmouseout="out('-1923411589124412388');" style=""> 157          Long orderId = null;                                                                                      </span>
<span class="8442798390701474713" onmouseenter="enter('8442798390701474713');" onmouseout="out('8442798390701474713');" style=""> 158          if (BLCRequestUtils.isOKtoUseSession(request)) {                                                          </span>
<span class="-3148132494393667395" onmouseenter="enter('-3148132494393667395');" onmouseout="out('-3148132494393667395');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 159 -            orderId = (Long) request.getAttribute(OVERRIDE_CART_ATTR_NAME, WebRequest.SCOPE_GLOBAL_SESSION);      </span>
<span class="-6220500265898572524" onmouseenter="enter('-6220500265898572524');" onmouseout="out('-6220500265898572524');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +            orderId = (Long) request.getAttribute(OVERRIDE_CART_ATTR_NAME, WebRequest.SCOPE_SESSION);             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161          }                                                                                                         </span>
<span class="-4269565703796629770" onmouseenter="enter('-4269565703796629770');" onmouseout="out('-4269565703796629770');" style=""> 162          Order cart = null;                                                                                        </span>
<span class="1156566652422122209" onmouseenter="enter('1156566652422122209');" onmouseout="out('1156566652422122209');" style=""> 163          if (orderId != null) {                                                                                    </span>
<span class="-8700600114578005615" onmouseenter="enter('-8700600114578005615');" onmouseout="out('-8700600114578005615');" style=""> 164              cart = orderService.findOrderById(orderId);                                                           </span>
<span  style=""> 165                                                                                                                    </span>
<span class="7744785123834062822" onmouseenter="enter('7744785123834062822');" onmouseout="out('7744785123834062822');" style=""> 166              if (cart == null ||                                                                                   </span>
<span class="5826484381865674251" onmouseenter="enter('5826484381865674251');" onmouseout="out('5826484381865674251');" style=""> 167                      cart.getStatus().equals(OrderStatus.SUBMITTED) ||                                             </span>
<span class="7497968434275069271" onmouseenter="enter('7497968434275069271');" onmouseout="out('7497968434275069271');" style=""> 168                      cart.getStatus().equals(OrderStatus.CANCELLED)) {                                             </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 169                  return null;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 170              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 171          }                                                                                                         </span>
<span  style=""> 172                                                                                                                    </span>
<span class="-6231498894577494482" onmouseenter="enter('-6231498894577494482');" onmouseout="out('-6231498894577494482');" style=""> 173          return cart;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 174      }                                                                                                             </span>
<span  style=""> 175                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 176      /**                                                                                                           </span>
<span class="2543515529052098943" onmouseenter="enter('2543515529052098943');" onmouseout="out('2543515529052098943');" style=""><abbr title=" 177       * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implying that this is"> 177       * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implying that ðŸ”µ</abbr></span>
<span class="3368064714905975053" onmouseenter="enter('3368064714905975053');" onmouseout="out('3368064714905975053');" style=""> 178       * the logged in customer and we need to merge the carts                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 179       */                                                                                                           </span>
<span class="976646062219528439" onmouseenter="enter('976646062219528439');" onmouseout="out('976646062219528439');" style=""> 180      public boolean mergeCartNeeded(Customer customer, WebRequest request) {                                       </span>
<span class="-2306216560497710970" onmouseenter="enter('-2306216560497710970');" onmouseout="out('-2306216560497710970');" style=""> 181          // When the user is a CSR, we want to disable cart merging                                                </span>
<span class="3724967001772040546" onmouseenter="enter('3724967001772040546');" onmouseout="out('3724967001772040546');" style=""> 182          if (crossAppAuthService != null &amp;&amp; crossAppAuthService.isAuthedFromAdmin()) {                             </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 183              return false;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 184          }                                                                                                         </span>
<span  style=""> 185                                                                                                                    </span>
<span class="-2037434992999027399" onmouseenter="enter('-2037434992999027399');" onmouseout="out('-2037434992999027399');" style=""> 186          Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);                 </span>
<span class="-4250888802750644339" onmouseenter="enter('-4250888802750644339');" onmouseout="out('-4250888802750644339');" style=""><abbr title=" 187          return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymousCustomer.getId()));"> 187          return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymousCustomeðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 188      }                                                                                                             </span>
<span  style=""> 189                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 190      /**                                                                                                           </span>
<span class="7405625424464652207" onmouseenter="enter('7405625424464652207');" onmouseout="out('7405625424464652207');" style=""><abbr title=" 191       * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;customer&lt;/b&gt;. This"> 191       * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;customer&lt;/b&gt;ðŸ”µ</abbr></span>
<span class="-1511666666862096457" onmouseenter="enter('-1511666666862096457');" onmouseout="out('-1511666666862096457');" style=""> 192       * will also remove the customer from session after it has finished since it is no longer needed              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 193       */                                                                                                           </span>
<span class="-8642121540254730814" onmouseenter="enter('-8642121540254730814');" onmouseout="out('-8642121540254730814');" style=""> 194      public Order mergeCart(Customer customer, WebRequest request) {                                               </span>
<span class="-2037434992999027399" onmouseenter="enter('-2037434992999027399');" onmouseout="out('-2037434992999027399');" style=""> 195          Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);                 </span>
<span class="3567488516081904884" onmouseenter="enter('3567488516081904884');" onmouseout="out('3567488516081904884');" style=""> 196          MergeCartResponse mergeCartResponse;                                                                      </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 197          try {                                                                                                     </span>
<span class="6955444521103915231" onmouseenter="enter('6955444521103915231');" onmouseout="out('6955444521103915231');" style=""> 198              Order cart = orderService.findCartForCustomer(anonymousCustomer);                                     </span>
<span class="1811537806218071823" onmouseenter="enter('1811537806218071823');" onmouseout="out('1811537806218071823');" style=""> 199              mergeCartResponse = mergeCartService.mergeCart(customer, cart);                                       </span>
<span class="8325775691603685335" onmouseenter="enter('8325775691603685335');" onmouseout="out('8325775691603685335');" style=""> 200          } catch (PricingException e) {                                                                            </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 201              throw new RuntimeException(e);                                                                        </span>
<span class="2264439919030346254" onmouseenter="enter('2264439919030346254');" onmouseout="out('2264439919030346254');" style=""> 202          } catch (RemoveFromCartException e) {                                                                     </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 203              throw new RuntimeException(e);                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 204          }                                                                                                         </span>
<span  style=""> 205                                                                                                                    </span>
<span class="8442798390701474713" onmouseenter="enter('8442798390701474713');" onmouseout="out('8442798390701474713');" style=""> 206          if (BLCRequestUtils.isOKtoUseSession(request)) {                                                          </span>
<span class="-2691808975299315412" onmouseenter="enter('-2691808975299315412');" onmouseout="out('-2691808975299315412');" style=""> 207              // The anonymous customer from session is no longer needed; it can be safely removed                  </span>
<span class="708215544978738967" onmouseenter="enter('708215544978738967');" onmouseout="out('708215544978738967');" style=""> 208              request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeName(),     </span>
<span class="-7739736464352471759" onmouseenter="enter('-7739736464352471759');" onmouseout="out('-7739736464352471759');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 209 -                    WebRequest.SCOPE_GLOBAL_SESSION);                                                             </span>
<span class="-8992065164011733984" onmouseenter="enter('-8992065164011733984');" onmouseout="out('-8992065164011733984');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +                    WebRequest.SCOPE_SESSION);                                                                    </span>
<span class="-4675926701498081497" onmouseenter="enter('-4675926701498081497');" onmouseout="out('-4675926701498081497');" style=""> 211              request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeName(),   </span>
<span class="-7739736464352471759" onmouseenter="enter('-7739736464352471759');" onmouseout="out('-7739736464352471759');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 212 -                    WebRequest.SCOPE_GLOBAL_SESSION);                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 213 -                                                                                                                  </span>
<span class="-4852350541649994679" onmouseenter="enter('-4852350541649994679');" onmouseout="out('-4852350541649994679');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 214 -            request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_GLOBAL_SESSION);       </span>
<span class="-8992065164011733984" onmouseenter="enter('-8992065164011733984');" onmouseout="out('-8992065164011733984');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +                    WebRequest.SCOPE_SESSION);                                                                    </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +                                                                                                                  </span>
<span class="3895015659049002158" onmouseenter="enter('3895015659049002158');" onmouseout="out('3895015659049002158');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +            request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_SESSION);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 218          }                                                                                                         </span>
<span class="-3259849467893150872" onmouseenter="enter('-3259849467893150872');" onmouseout="out('-3259849467893150872');" style=""> 219          return mergeCartResponse.getOrder();                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 220      }                                                                                                             </span>
<span  style=""> 221                                                                                                                    </span>
<span class="-1418008799783690701" onmouseenter="enter('-1418008799783690701');" onmouseout="out('-1418008799783690701');" style=""> 222      public static String getCartRequestAttributeName() {                                                          </span>
<span class="-7826677971898041484" onmouseenter="enter('-7826677971898041484');" onmouseout="out('-7826677971898041484');" style=""> 223          return cartRequestAttributeName;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 224      }                                                                                                             </span>
<span  style=""> 225                                                                                                                    </span>
<span class="8336122383281290122" onmouseenter="enter('8336122383281290122');" onmouseout="out('8336122383281290122');" style=""> 226      public static void setCartRequestAttributeName(String cartRequestAttributeName) {                             </span>
<span class="-9172660232233003621" onmouseenter="enter('-9172660232233003621');" onmouseout="out('-9172660232233003621');" style=""> 227          CartStateRequestProcessor.cartRequestAttributeName = cartRequestAttributeName;                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 228      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 229  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="6211491254187717485" onmouseenter="enter('6211491254187717485');" onmouseout="out('6211491254187717485');" style="">   3   * BroadleafCommerce Framework Web                                                                                </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="9047174597422306618" onmouseenter="enter('9047174597422306618');" onmouseout="out('9047174597422306618');" style="">  18  package org.broadleafcommerce.core.web.order.security;                                                            </span>
<span  style="">  19                                                                                                                    </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="-44736846564495697" onmouseenter="enter('-44736846564495697');" onmouseout="out('-44736846564495697');" style="">  22  import org.broadleafcommerce.common.crossapp.service.CrossAppAuthService;                                         </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  23  import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                              </span>
<span class="-6556509414411446728" onmouseenter="enter('-6556509414411446728');" onmouseout="out('-6556509414411446728');" style="">  24  import org.broadleafcommerce.common.util.BLCRequestUtils;                                                         </span>
<span class="-6774162061490374742" onmouseenter="enter('-6774162061490374742');" onmouseout="out('-6774162061490374742');" style="">  25  import org.broadleafcommerce.common.web.AbstractBroadleafWebRequestProcessor;                                     </span>
<span class="7310498659107503620" onmouseenter="enter('7310498659107503620');" onmouseout="out('7310498659107503620');" style="">  26  import org.broadleafcommerce.common.web.BroadleafWebRequestProcessor;                                             </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  27  import org.broadleafcommerce.core.order.domain.Order;                                                             </span>
<span class="1732621347693690105" onmouseenter="enter('1732621347693690105');" onmouseout="out('1732621347693690105');" style="">  28  import org.broadleafcommerce.core.order.service.MergeCartService;                                                 </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  29  import org.broadleafcommerce.core.order.service.OrderService;                                                     </span>
<span class="4773848044130999111" onmouseenter="enter('4773848044130999111');" onmouseout="out('4773848044130999111');" style="">  30  import org.broadleafcommerce.core.order.service.call.MergeCartResponse;                                           </span>
<span class="4692349346970735648" onmouseenter="enter('4692349346970735648');" onmouseout="out('4692349346970735648');" style="">  31  import org.broadleafcommerce.core.order.service.exception.RemoveFromCartException;                                </span>
<span class="614288234168063731" onmouseenter="enter('614288234168063731');" onmouseout="out('614288234168063731');" style="">  32  import org.broadleafcommerce.core.order.service.type.OrderStatus;                                                 </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  33  import org.broadleafcommerce.core.pricing.service.exception.PricingException;                                     </span>
<span class="-7959314516630637692" onmouseenter="enter('-7959314516630637692');" onmouseout="out('-7959314516630637692');" style="">  34  import org.broadleafcommerce.core.web.service.UpdateCartService;                                                  </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  35  import org.broadleafcommerce.profile.core.domain.Customer;                                                        </span>
<span class="-6031821648249405492" onmouseenter="enter('-6031821648249405492');" onmouseout="out('-6031821648249405492');" style="">  36  import org.broadleafcommerce.profile.web.core.CustomerState;                                                      </span>
<span class="-4063269764380812642" onmouseenter="enter('-4063269764380812642');" onmouseout="out('-4063269764380812642');" style="">  37  import org.broadleafcommerce.profile.web.core.security.CustomerStateRequestProcessor;                             </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="">  38  import org.springframework.beans.factory.annotation.Autowired;                                                    </span>
<span class="-4664978283136443479" onmouseenter="enter('-4664978283136443479');" onmouseout="out('-4664978283136443479');" style="">  39  import org.springframework.beans.factory.annotation.Qualifier;                                                    </span>
<span class="8406454220154166073" onmouseenter="enter('8406454220154166073');" onmouseout="out('8406454220154166073');" style="">  40  import org.springframework.stereotype.Component;                                                                  </span>
<span class="-208569050100229982" onmouseenter="enter('-208569050100229982');" onmouseout="out('-208569050100229982');" style="">  41  import org.springframework.web.context.request.ServletWebRequest;                                                 </span>
<span class="8045684338721768523" onmouseenter="enter('8045684338721768523');" onmouseout="out('8045684338721768523');" style="">  42  import org.springframework.web.context.request.WebRequest;                                                        </span>
<span  style="">  43                                                                                                                    </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  44  import java.util.HashMap;                                                                                         </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  45  import java.util.Map;                                                                                             </span>
<span  style="">  46                                                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  47  import javax.annotation.Resource;                                                                                 </span>
<span  style="">  48                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  49  /**                                                                                                               </span>
<span class="6949785334522964843" onmouseenter="enter('6949785334522964843');" onmouseout="out('6949785334522964843');" style="">  50   * Ensures that the customer&#x27;s current cart is available to the request.                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  51   *                                                                                                                </span>
<span class="-6044904845818784259" onmouseenter="enter('-6044904845818784259');" onmouseout="out('-6044904845818784259');" style="">  52   * Also invokes blMergeCartProcessor&quot; if the user has just logged in.                                             </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  53   *                                                                                                                </span>
<span class="-7095132053112495828" onmouseenter="enter('-7095132053112495828');" onmouseout="out('-7095132053112495828');" style=""><abbr title="  54   * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters, Portlet Filters">  54   * Genericized version of the CartStateFilter. This was made to facilitate reuse between Servlet Filters, Portlet ðŸ”µ</abbr></span>
<span class="-8141282893564723204" onmouseenter="enter('-8141282893564723204');" onmouseout="out('-8141282893564723204');" style=""><abbr title="  55   * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests into WebRequests">  55   * and Spring MVC interceptors. Spring has an easy way of converting HttpRequests and PortletRequests into WebRequðŸ”µ</abbr></span>
<span class="-4149953333143573394" onmouseenter="enter('-4149953333143573394');" onmouseout="out('-4149953333143573394');" style="">  56   * via &lt;br /&gt;                                                                                                     </span>
<span class="-2288628475956287787" onmouseenter="enter('-2288628475956287787');" onmouseout="out('-2288628475956287787');" style="">  57   * new ServletWebRequest(httpServletRequest); new PortletWebRequest(portletRequest); &lt;br /&gt;                       </span>
<span class="-3373499860696082880" onmouseenter="enter('-3373499860696082880');" onmouseout="out('-3373499860696082880');" style="">  58   * For the interceptor pattern, you can simply implement a WebRequestInterceptor to invoke from there.            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  59   *                                                                                                                </span>
<span class="-2581105714976122669" onmouseenter="enter('-2581105714976122669');" onmouseout="out('-2581105714976122669');" style="">  60   * @author Phillip Verheyden                                                                                      </span>
<span class="691156538645414019" onmouseenter="enter('691156538645414019');" onmouseout="out('691156538645414019');" style="">  61   * @see {@link CartStateFilter}                                                                                   </span>
<span class="2345590137904887447" onmouseenter="enter('2345590137904887447');" onmouseout="out('2345590137904887447');" style="">  62   * @see {@link BroadleafWebRequestProcessor}                                                                      </span>
<span class="-1762186850923570701" onmouseenter="enter('-1762186850923570701');" onmouseout="out('-1762186850923570701');" style="">  63   * @see {@link ServletWebRequest}                                                                                 </span>
<span class="3606349442508010109" onmouseenter="enter('3606349442508010109');" onmouseout="out('3606349442508010109');" style="">  64   * @see {@link org.springframework.web.portlet.context.PortletWebRequest}                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  65   */                                                                                                               </span>
<span class="-7470255366716761762" onmouseenter="enter('-7470255366716761762');" onmouseout="out('-7470255366716761762');" style="">  66  @Component(&quot;blCartStateRequestProcessor&quot;)                                                                         </span>
<span class="-1024024663522960488" onmouseenter="enter('-1024024663522960488');" onmouseout="out('-1024024663522960488');" style="">  67  public class CartStateRequestProcessor extends AbstractBroadleafWebRequestProcessor {                             </span>
<span  style="">  68                                                                                                                    </span>
<span class="-4030114958641496547" onmouseenter="enter('-4030114958641496547');" onmouseout="out('-4030114958641496547');" style="">  69      /** Logger for this class and subclasses */                                                                   </span>
<span class="8347569796035482168" onmouseenter="enter('8347569796035482168');" onmouseout="out('8347569796035482168');" style="">  70      protected final Log LOG = LogFactory.getLog(getClass());                                                      </span>
<span  style="">  71                                                                                                                    </span>
<span class="-5119951708732545437" onmouseenter="enter('-5119951708732545437');" onmouseout="out('-5119951708732545437');" style="">  72      public static final String BLC_RULE_MAP_PARAM = &quot;blRuleMap&quot;;                                                  </span>
<span  style="">  73                                                                                                                    </span>
<span class="8871930809399696828" onmouseenter="enter('8871930809399696828');" onmouseout="out('8871930809399696828');" style="">  74      private final String mergeCartResponseKey = &quot;bl_merge_cart_response&quot;;                                         </span>
<span  style="">  75                                                                                                                    </span>
<span class="6044335667426838645" onmouseenter="enter('6044335667426838645');" onmouseout="out('6044335667426838645');" style="">  76      @Resource(name = &quot;blCartStateRequestProcessorExtensionManager&quot;)                                               </span>
<span class="-8185812064196536655" onmouseenter="enter('-8185812064196536655');" onmouseout="out('-8185812064196536655');" style="">  77      protected CartStateRequestProcessorExtensionManager extensionManager;                                         </span>
<span  style="">  78                                                                                                                    </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style="">  79      @Resource(name = &quot;blOrderService&quot;)                                                                            </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style="">  80      protected OrderService orderService;                                                                          </span>
<span  style="">  81                                                                                                                    </span>
<span class="-5832711189651279120" onmouseenter="enter('-5832711189651279120');" onmouseout="out('-5832711189651279120');" style="">  82      @Resource(name = &quot;blUpdateCartService&quot;)                                                                       </span>
<span class="-6474151620344678255" onmouseenter="enter('-6474151620344678255');" onmouseout="out('-6474151620344678255');" style="">  83      protected UpdateCartService updateCartService;                                                                </span>
<span  style="">  84                                                                                                                    </span>
<span class="3052322175513128984" onmouseenter="enter('3052322175513128984');" onmouseout="out('3052322175513128984');" style="">  85      @Resource(name = &quot;blMergeCartService&quot;)                                                                        </span>
<span class="8208298738953975930" onmouseenter="enter('8208298738953975930');" onmouseout="out('8208298738953975930');" style="">  86      protected MergeCartService mergeCartService;                                                                  </span>
<span  style="">  87                                                                                                                    </span>
<span class="-4242208026742072321" onmouseenter="enter('-4242208026742072321');" onmouseout="out('-4242208026742072321');" style="">  88      @Resource(name = &quot;blCustomerStateRequestProcessor&quot;)                                                           </span>
<span class="-8544356289477463500" onmouseenter="enter('-8544356289477463500');" onmouseout="out('-8544356289477463500');" style="">  89      protected CustomerStateRequestProcessor customerStateRequestProcessor;                                        </span>
<span  style="">  90                                                                                                                    </span>
<span class="2602789178515286342" onmouseenter="enter('2602789178515286342');" onmouseout="out('2602789178515286342');" style="">  91      @Autowired(required = false)                                                                                  </span>
<span class="-6782784833899333066" onmouseenter="enter('-6782784833899333066');" onmouseout="out('-6782784833899333066');" style="">  92      @Qualifier(&quot;blCrossAppAuthService&quot;)                                                                           </span>
<span class="-8287485368967055684" onmouseenter="enter('-8287485368967055684');" onmouseout="out('-8287485368967055684');" style="">  93      protected CrossAppAuthService crossAppAuthService;                                                            </span>
<span  style="">  94                                                                                                                    </span>
<span class="-8085941326179479324" onmouseenter="enter('-8085941326179479324');" onmouseout="out('-8085941326179479324');" style="">  95      protected static String cartRequestAttributeName = &quot;cart&quot;;                                                    </span>
<span  style="">  96                                                                                                                    </span>
<span class="1778878837115274965" onmouseenter="enter('1778878837115274965');" onmouseout="out('1778878837115274965');" style="">  97      protected static String anonymousCartSessionAttributeName = &quot;anonymousCart&quot;;                                  </span>
<span  style="">  98                                                                                                                    </span>
<span class="3570049000477591403" onmouseenter="enter('3570049000477591403');" onmouseout="out('3570049000477591403');" style="">  99      public static final String OVERRIDE_CART_ATTR_NAME = &quot;_blc_overrideCartId&quot;;                                   </span>
<span  style=""> 100                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 101      @Override                                                                                                     </span>
<span class="-1087564729186269972" onmouseenter="enter('-1087564729186269972');" onmouseout="out('-1087564729186269972');" style=""> 102      public void process(WebRequest request) {                                                                     </span>
<span class="-5515974955877981002" onmouseenter="enter('-5515974955877981002');" onmouseout="out('-5515974955877981002');" style=""> 103          Customer customer = CustomerState.getCustomer();                                                          </span>
<span  style=""> 104                                                                                                                    </span>
<span class="-1371412200964570990" onmouseenter="enter('-1371412200964570990');" onmouseout="out('-1371412200964570990');" style=""> 105          if (customer == null) {                                                                                   </span>
<span class="7950488184855848644" onmouseenter="enter('7950488184855848644');" onmouseout="out('7950488184855848644');" style=""><abbr title=" 106              LOG.info(&quot;No customer was found on the current request, no cart will be added to the current request. Ensure that the&quot;"> 106              LOG.info(&quot;No customer was found on the current request, no cart will be added to the current request. ðŸ”µ</abbr></span>
<span class="1683793928531658492" onmouseenter="enter('1683793928531658492');" onmouseout="out('1683793928531658492');" style=""> 107                      + &quot; blCustomerStateFilter occurs prior to the blCartStateFilter&quot;);                            </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 108              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 109          }                                                                                                         </span>
<span  style=""> 110                                                                                                                    </span>
<span class="5165057861481115804" onmouseenter="enter('5165057861481115804');" onmouseout="out('5165057861481115804');" style=""> 111          ExtensionResultHolder&lt;Order&gt; erh = new ExtensionResultHolder&lt;Order&gt;();                                    </span>
<span class="5601587306461975752" onmouseenter="enter('5601587306461975752');" onmouseout="out('5601587306461975752');" style=""> 112          extensionManager.getProxy().lookupOrCreateCart(request, customer, erh);                                   </span>
<span  style=""> 113                                                                                                                    </span>
<span class="847348363243900875" onmouseenter="enter('847348363243900875');" onmouseout="out('847348363243900875');" style=""> 114          Order cart;                                                                                               </span>
<span class="5745510142944708411" onmouseenter="enter('5745510142944708411');" onmouseout="out('5745510142944708411');" style=""> 115          if (erh.getResult() != null) {                                                                            </span>
<span class="-7012036676670353222" onmouseenter="enter('-7012036676670353222');" onmouseout="out('-7012036676670353222');" style=""> 116              cart = orderService.findCartForCustomerWithEnhancements(customer, erh.getResult());                   </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 117          } else {                                                                                                  </span>
<span class="-3651333313322615728" onmouseenter="enter('-3651333313322615728');" onmouseout="out('-3651333313322615728');" style=""> 118              cart = getOverrideCart(request);                                                                      </span>
<span class="1988681715974209575" onmouseenter="enter('1988681715974209575');" onmouseout="out('1988681715974209575');" style=""> 119              if (cart == null &amp;&amp; mergeCartNeeded(customer, request)) {                                             </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 120                  if (LOG.isDebugEnabled()) {                                                                       </span>
<span class="-3126227002554961137" onmouseenter="enter('-3126227002554961137');" onmouseout="out('-3126227002554961137');" style=""> 121                      LOG.debug(&quot;Merge cart required, calling mergeCart &quot; + customer.getId());                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122                  }                                                                                                 </span>
<span class="729291545179835184" onmouseenter="enter('729291545179835184');" onmouseout="out('729291545179835184');" style=""> 123                  cart = mergeCart(customer, request);                                                              </span>
<span class="-4362027600375335251" onmouseenter="enter('-4362027600375335251');" onmouseout="out('-4362027600375335251');" style=""> 124              } else if (cart == null) {                                                                            </span>
<span class="2009346020505670050" onmouseenter="enter('2009346020505670050');" onmouseout="out('2009346020505670050');" style=""> 125                  cart = orderService.findCartForCustomerWithEnhancements(customer);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 126              }                                                                                                     </span>
<span  style=""> 127                                                                                                                    </span>
<span class="-2482909530219509442" onmouseenter="enter('-2482909530219509442');" onmouseout="out('-2482909530219509442');" style=""> 128              if (cart == null) {                                                                                   </span>
<span class="5619175994998149041" onmouseenter="enter('5619175994998149041');" onmouseout="out('5619175994998149041');" style=""> 129                  cart = orderService.getNullOrder();                                                               </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 130              } else {                                                                                              </span>
<span class="4717244821681544775" onmouseenter="enter('4717244821681544775');" onmouseout="out('4717244821681544775');" style=""> 131                  updateCartService.updateAndValidateCart(cart);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 132              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 133          }                                                                                                         </span>
<span  style=""> 134                                                                                                                    </span>
<span class="5570729529055502013" onmouseenter="enter('5570729529055502013');" onmouseout="out('5570729529055502013');" style=""> 135          updateCartRequestAttributes(request, cart);                                                               </span>
<span  style=""> 136                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137      }                                                                                                             </span>
<span  style=""> 138                                                                                                                    </span>
<span class="4979469920847154161" onmouseenter="enter('4979469920847154161');" onmouseout="out('4979469920847154161');" style=""> 139      protected void updateCartRequestAttributes(WebRequest request, Order cart) {                                  </span>
<span class="7956162395984675060" onmouseenter="enter('7956162395984675060');" onmouseout="out('7956162395984675060');" style=""> 140          request.setAttribute(cartRequestAttributeName, cart, WebRequest.SCOPE_REQUEST);                           </span>
<span  style=""> 141                                                                                                                    </span>
<span class="2250168164336394635" onmouseenter="enter('2250168164336394635');" onmouseout="out('2250168164336394635');" style=""> 142          // Setup cart for content rule processing                                                                 </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 143          @SuppressWarnings(&quot;unchecked&quot;)                                                                            </span>
<span class="-7009529966960283141" onmouseenter="enter('-7009529966960283141');" onmouseout="out('-7009529966960283141');" style=""><abbr title=" 144          Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRequest.SCOPE_REQUEST);"> 144          Map&lt;String, Object&gt; ruleMap = (Map&lt;String, Object&gt;) request.getAttribute(BLC_RULE_MAP_PARAM, WebRequest.SCðŸ”µ</abbr></span>
<span class="7719424053900967992" onmouseenter="enter('7719424053900967992');" onmouseout="out('7719424053900967992');" style=""> 145          if (ruleMap == null) {                                                                                    </span>
<span class="7584262357946796931" onmouseenter="enter('7584262357946796931');" onmouseout="out('7584262357946796931');" style=""> 146              ruleMap = new HashMap&lt;String, Object&gt;();                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147          }                                                                                                         </span>
<span class="-7082993895566141830" onmouseenter="enter('-7082993895566141830');" onmouseout="out('-7082993895566141830');" style=""> 148          ruleMap.put(&quot;order&quot;, cart);                                                                               </span>
<span  style=""> 149                                                                                                                    </span>
<span class="-8486868703965614260" onmouseenter="enter('-8486868703965614260');" onmouseout="out('-8486868703965614260');" style=""> 150          // Leaving the following line in for backwards compatibility, but all rules should use order as the       </span>
<span class="8713525845734832130" onmouseenter="enter('8713525845734832130');" onmouseout="out('8713525845734832130');" style=""> 151          // variable name.                                                                                         </span>
<span class="8466527126795751415" onmouseenter="enter('8466527126795751415');" onmouseout="out('8466527126795751415');" style=""> 152          ruleMap.put(&quot;cart&quot;, cart);                                                                                </span>
<span class="-29008669505238211" onmouseenter="enter('-29008669505238211');" onmouseout="out('-29008669505238211');" style=""> 153          request.setAttribute(BLC_RULE_MAP_PARAM, ruleMap, WebRequest.SCOPE_REQUEST);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 154      }                                                                                                             </span>
<span  style=""> 155                                                                                                                    </span>
<span class="-7740129989171948267" onmouseenter="enter('-7740129989171948267');" onmouseout="out('-7740129989171948267');" style=""> 156      public Order getOverrideCart(WebRequest request) {                                                            </span>
<span class="-1923411589124412388" onmouseenter="enter('-1923411589124412388');" onmouseout="out('-1923411589124412388');" style=""> 157          Long orderId = null;                                                                                      </span>
<span class="8442798390701474713" onmouseenter="enter('8442798390701474713');" onmouseout="out('8442798390701474713');" style=""> 158          if (BLCRequestUtils.isOKtoUseSession(request)) {                                                          </span>
<span class="-3148132494393667395" onmouseenter="enter('-3148132494393667395');" onmouseout="out('-3148132494393667395');" style=""> 159              orderId = (Long) request.getAttribute(OVERRIDE_CART_ATTR_NAME, WebRequest.SCOPE_GLOBAL_SESSION);      </span>

<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 160          }                                                                                                         </span>
<span class="-4269565703796629770" onmouseenter="enter('-4269565703796629770');" onmouseout="out('-4269565703796629770');" style=""> 161          Order cart = null;                                                                                        </span>
<span class="1156566652422122209" onmouseenter="enter('1156566652422122209');" onmouseout="out('1156566652422122209');" style=""> 162          if (orderId != null) {                                                                                    </span>
<span class="-8700600114578005615" onmouseenter="enter('-8700600114578005615');" onmouseout="out('-8700600114578005615');" style=""> 163              cart = orderService.findOrderById(orderId);                                                           </span>
<span  style=""> 164                                                                                                                    </span>
<span class="7744785123834062822" onmouseenter="enter('7744785123834062822');" onmouseout="out('7744785123834062822');" style=""> 165              if (cart == null ||                                                                                   </span>
<span class="5826484381865674251" onmouseenter="enter('5826484381865674251');" onmouseout="out('5826484381865674251');" style=""> 166                      cart.getStatus().equals(OrderStatus.SUBMITTED) ||                                             </span>
<span class="7497968434275069271" onmouseenter="enter('7497968434275069271');" onmouseout="out('7497968434275069271');" style=""> 167                      cart.getStatus().equals(OrderStatus.CANCELLED)) {                                             </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 168                  return null;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 169              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 170          }                                                                                                         </span>
<span  style=""> 171                                                                                                                    </span>
<span class="-6231498894577494482" onmouseenter="enter('-6231498894577494482');" onmouseout="out('-6231498894577494482');" style=""> 172          return cart;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 173      }                                                                                                             </span>
<span  style=""> 174                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 175      /**                                                                                                           </span>
<span class="2543515529052098943" onmouseenter="enter('2543515529052098943');" onmouseout="out('2543515529052098943');" style=""><abbr title=" 176       * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implying that this is"> 176       * Returns true if the given &lt;b&gt;customer&lt;/b&gt; is different than the previous anonymous customer, implying that ðŸ”µ</abbr></span>
<span class="3368064714905975053" onmouseenter="enter('3368064714905975053');" onmouseout="out('3368064714905975053');" style=""> 177       * the logged in customer and we need to merge the carts                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 178       */                                                                                                           </span>
<span class="976646062219528439" onmouseenter="enter('976646062219528439');" onmouseout="out('976646062219528439');" style=""> 179      public boolean mergeCartNeeded(Customer customer, WebRequest request) {                                       </span>
<span class="-2306216560497710970" onmouseenter="enter('-2306216560497710970');" onmouseout="out('-2306216560497710970');" style=""> 180          // When the user is a CSR, we want to disable cart merging                                                </span>
<span class="3724967001772040546" onmouseenter="enter('3724967001772040546');" onmouseout="out('3724967001772040546');" style=""> 181          if (crossAppAuthService != null &amp;&amp; crossAppAuthService.isAuthedFromAdmin()) {                             </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 182              return false;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183          }                                                                                                         </span>
<span  style=""> 184                                                                                                                    </span>
<span class="-2037434992999027399" onmouseenter="enter('-2037434992999027399');" onmouseout="out('-2037434992999027399');" style=""> 185          Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);                 </span>
<span class="-4250888802750644339" onmouseenter="enter('-4250888802750644339');" onmouseout="out('-4250888802750644339');" style=""><abbr title=" 186          return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymousCustomer.getId()));"> 186          return (anonymousCustomer != null &amp;&amp; customer.getId() != null &amp;&amp; !customer.getId().equals(anonymousCustomeðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 187      }                                                                                                             </span>
<span  style=""> 188                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 189      /**                                                                                                           </span>
<span class="7405625424464652207" onmouseenter="enter('7405625424464652207');" onmouseout="out('7405625424464652207');" style=""><abbr title=" 190       * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;customer&lt;/b&gt;. This"> 190       * Looks up the anonymous customer and merges that cart with the cart from the given logged in &lt;b&gt;customer&lt;/b&gt;ðŸ”µ</abbr></span>
<span class="-1511666666862096457" onmouseenter="enter('-1511666666862096457');" onmouseout="out('-1511666666862096457');" style=""> 191       * will also remove the customer from session after it has finished since it is no longer needed              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 192       */                                                                                                           </span>
<span class="-8642121540254730814" onmouseenter="enter('-8642121540254730814');" onmouseout="out('-8642121540254730814');" style=""> 193      public Order mergeCart(Customer customer, WebRequest request) {                                               </span>
<span class="-2037434992999027399" onmouseenter="enter('-2037434992999027399');" onmouseout="out('-2037434992999027399');" style=""> 194          Customer anonymousCustomer = customerStateRequestProcessor.getAnonymousCustomer(request);                 </span>
<span class="3567488516081904884" onmouseenter="enter('3567488516081904884');" onmouseout="out('3567488516081904884');" style=""> 195          MergeCartResponse mergeCartResponse;                                                                      </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 196          try {                                                                                                     </span>
<span class="6955444521103915231" onmouseenter="enter('6955444521103915231');" onmouseout="out('6955444521103915231');" style=""> 197              Order cart = orderService.findCartForCustomer(anonymousCustomer);                                     </span>
<span class="1811537806218071823" onmouseenter="enter('1811537806218071823');" onmouseout="out('1811537806218071823');" style=""> 198              mergeCartResponse = mergeCartService.mergeCart(customer, cart);                                       </span>
<span class="8325775691603685335" onmouseenter="enter('8325775691603685335');" onmouseout="out('8325775691603685335');" style=""> 199          } catch (PricingException e) {                                                                            </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 200              throw new RuntimeException(e);                                                                        </span>
<span class="2264439919030346254" onmouseenter="enter('2264439919030346254');" onmouseout="out('2264439919030346254');" style=""> 201          } catch (RemoveFromCartException e) {                                                                     </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 202              throw new RuntimeException(e);                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 203          }                                                                                                         </span>
<span  style=""> 204                                                                                                                    </span>
<span class="8442798390701474713" onmouseenter="enter('8442798390701474713');" onmouseout="out('8442798390701474713');" style=""> 205          if (BLCRequestUtils.isOKtoUseSession(request)) {                                                          </span>
<span class="-2691808975299315412" onmouseenter="enter('-2691808975299315412');" onmouseout="out('-2691808975299315412');" style=""> 206              // The anonymous customer from session is no longer needed; it can be safely removed                  </span>
<span class="708215544978738967" onmouseenter="enter('708215544978738967');" onmouseout="out('708215544978738967');" style=""> 207              request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerSessionAttributeName(),     </span>
<span class="-7739736464352471759" onmouseenter="enter('-7739736464352471759');" onmouseout="out('-7739736464352471759');" style=""> 208                      WebRequest.SCOPE_GLOBAL_SESSION);                                                             </span>

<span class="-4675926701498081497" onmouseenter="enter('-4675926701498081497');" onmouseout="out('-4675926701498081497');" style=""> 209              request.removeAttribute(CustomerStateRequestProcessor.getAnonymousCustomerIdSessionAttributeName(),   </span>
<span class="-7739736464352471759" onmouseenter="enter('-7739736464352471759');" onmouseout="out('-7739736464352471759');" style=""> 210                      WebRequest.SCOPE_GLOBAL_SESSION);                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 211 -                                                                                                                  </span>
<span class="-4852350541649994679" onmouseenter="enter('-4852350541649994679');" onmouseout="out('-4852350541649994679');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 212 -            request.setAttribute(mergeCartResponseKey, mergeCartResponse, WebRequest.SCOPE_GLOBAL_SESSION);       </span>



<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 213          }                                                                                                         </span>
<span class="-3259849467893150872" onmouseenter="enter('-3259849467893150872');" onmouseout="out('-3259849467893150872');" style=""> 214          return mergeCartResponse.getOrder();                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 215      }                                                                                                             </span>
<span  style=""> 216                                                                                                                    </span>
<span class="-1418008799783690701" onmouseenter="enter('-1418008799783690701');" onmouseout="out('-1418008799783690701');" style=""> 217      public static String getCartRequestAttributeName() {                                                          </span>
<span class="-7826677971898041484" onmouseenter="enter('-7826677971898041484');" onmouseout="out('-7826677971898041484');" style=""> 218          return cartRequestAttributeName;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 219      }                                                                                                             </span>
<span  style=""> 220                                                                                                                    </span>
<span class="8336122383281290122" onmouseenter="enter('8336122383281290122');" onmouseout="out('8336122383281290122');" style=""> 221      public static void setCartRequestAttributeName(String cartRequestAttributeName) {                             </span>
<span class="-9172660232233003621" onmouseenter="enter('-9172660232233003621');" onmouseout="out('-9172660232233003621');" style=""> 222          CartStateRequestProcessor.cartRequestAttributeName = cartRequestAttributeName;                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 223      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 224  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            