<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>16</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    16
                    <a href="15.html">prev</a>
                    <a href="17.html">next</a>
                    <a href="16_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    AriaLyy/Aria_cb1f0e730bde28a18e672c263c1236eb9c4df4fa_Aria/src/main/java/com/arialyy/aria/core/command/normal/ResumeAllCmd.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;cb1f0e730bde28a18e672c263c1236eb9c4df4fa:Aria/src/main/java/com/arialyy/aria/core/command/normal/ResumeAllCmd.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;cb1f0e730bde28a18e672c263c1236eb9c4df4fa^1:Aria/src/main/java/com/arialyy/aria/core/command/normal/ResumeAllCmd.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;cb1f0e730bde28a18e672c263c1236eb9c4df4fa^2:Aria/src/main/java/com/arialyy/aria/core/command/normal/ResumeAllCmd.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;e362621c3899fe60df42df4433560ff4649f9a1e:Aria/src/main/java/com/arialyy/aria/core/command/normal/ResumeAllCmd.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.arialyy.aria.core.command.normal;
   2 
   3 import com.arialyy.aria.core.AriaManager;
   4 import com.arialyy.aria.core.download.DownloadGroupTaskEntity;
   5 import com.arialyy.aria.core.download.DownloadTaskEntity;
   6 import com.arialyy.aria.core.download.wrapper.DGTEWrapper;
   7 import com.arialyy.aria.core.download.wrapper.DTEWrapper;
   8 import com.arialyy.aria.core.inf.AbsTask;
   9 import com.arialyy.aria.core.inf.AbsTaskEntity;
  10 import com.arialyy.aria.core.inf.IEntity;
  11 import com.arialyy.aria.core.queue.DownloadGroupTaskQueue;
  12 import com.arialyy.aria.core.queue.DownloadTaskQueue;
  13 import com.arialyy.aria.core.queue.UploadTaskQueue;
  14 import com.arialyy.aria.core.upload.UploadTaskEntity;
  15 import com.arialyy.aria.core.upload.wrapper.UTEWrapper;
  16 import com.arialyy.aria.orm.DbEntity;
  17 import com.arialyy.aria.util.ALog;
  18 import com.arialyy.aria.util.CommonUtil;
  19 import com.arialyy.aria.util.NetUtils;
  20 import java.util.ArrayList;
  21 import java.util.List;
  22 
  23 /**
  24  * Created by AriaL on 2017/6/13.
  25  * 恢复所有停止的任务
  26  * 1.如果执行队列没有满，则开始下载任务，直到执行队列满
  27  * 2.如果队列执行队列已经满了，则将所有任务添加到等待队列中
  28  * 3.如果队列中只有等待状态的任务，如果执行队列没有满，则会启动等待状态的任务，如果执行队列已经满了，则会将所有等待状态的任务加载到缓存队列中
  29  */
  30 final class ResumeAllCmd&lt;T extends AbsTaskEntity&gt; extends AbsNormalCmd&lt;T&gt; {
  31   private List&lt;AbsTaskEntity&gt; mWaitList = new ArrayList&lt;&gt;();
  32 
  33   /**
  34    * @param targetName 产生任务的对象名
  35    */
  36   ResumeAllCmd(String targetName, T entity, int taskType) {
  37     super(targetName, entity, taskType);
  38   }
  39 
  40   @Override public void executeCmd() {
  41     if (!NetUtils.isConnected(AriaManager.APP)) {
  42       ALog.w(TAG, &quot;恢复任务失败，网络未连接&quot;);
  43       return;
  44     }
  45     if (isDownloadCmd) {
  46       resumeTask(findTaskData(1));
  47       resumeTask(findTaskData(2));
  48     } else {
  49       resumeTask(findTaskData(3));
  50     }
  51     resumeWaitTask();
  52   }
  53 
  54   /**
  55    * 查找数据库中的所有任务数据
  56    *
  57    * @param type {@code 1}单任务下载任务；{@code 2}任务组下载任务；{@code 3} 单任务上传任务
  58    */
  59   private List&lt;AbsTaskEntity&gt; findTaskData(int type) {
  60     List&lt;AbsTaskEntity&gt; tempList = new ArrayList&lt;&gt;();
  61     if (type == 1) {
  62       List&lt;DTEWrapper&gt; wrappers = DbEntity.findRelationData(DTEWrapper.class,
  63           &quot;DownloadTaskEntity.isGroupTask=? and DownloadTaskEntity.state!=?&quot;, &quot;false&quot;, &quot;1&quot;);
  64       if (wrappers != null &amp;&amp; !wrappers.isEmpty()) {
  65         for (DTEWrapper w : wrappers) {
  66           tempList.add(w.taskEntity);
  67         }
  68       }
  69     } else if (type == 2) {
  70       List&lt;DGTEWrapper&gt; wrappers =
  71           DbEntity.findRelationData(DGTEWrapper.class, &quot;DownloadGroupTaskEntity.state!=?&quot;, &quot;1&quot;);
  72       if (wrappers != null &amp;&amp; !wrappers.isEmpty()) {
  73         for (DGTEWrapper w : wrappers) {
  74           tempList.add(w.taskEntity);
  75         }
  76       }
  77     } else if (type == 3) {
  78       List&lt;UTEWrapper&gt; wrappers =
  79           DbEntity.findRelationData(UTEWrapper.class, &quot;UploadTaskEntity.state!=?&quot;, &quot;1&quot;);
  80       if (wrappers != null &amp;&amp; !wrappers.isEmpty()) {
  81         for (UTEWrapper w : wrappers) {
  82           tempList.add(w.taskEntity);
  83         }
  84       }
  85     }
  86     return tempList;
  87   }
  88 
  89   /**
  90    * 恢复任务
  91    */
  92   private void resumeTask(List&lt;AbsTaskEntity&gt; taskList) {
  93     if (taskList != null &amp;&amp; !taskList.isEmpty()) {
  94       for (AbsTaskEntity te : taskList) {
  95         if (te == null || te.getEntity() == null) continue;
  96         int state = te.getState();
  97         if (state == IEntity.STATE_STOP || state == IEntity.STATE_OTHER) {
  98           resumeEntity(te);
  99         } else if (state == IEntity.STATE_WAIT) {
 100           mWaitList.add(te);
 101         } else if (state == IEntity.STATE_RUNNING) {
 102           if (!mQueue.taskIsRunning(te.getEntity().getKey())) {
 103             resumeEntity(te);
 104           }
 105         }
 106       }
 107     }
 108   }
 109 
 110   /**
 111    * 处理等待状态的任务
 112    */
 113   private void resumeWaitTask() {
 114     int maxTaskNum = mQueue.getMaxTaskNum();
 115     if (mWaitList == null || mWaitList.isEmpty()) return;
 116     for (AbsTaskEntity te : mWaitList) {
 117       if (mQueue.getCurrentExePoolNum() &lt; maxTaskNum) {
 118         startTask(createTask(te));
 119       } else {
 120         createTask(te);
 121       }
 122     }
 123   }
 124 
 125   /**
 126    * 恢复实体任务
 127    *
 128    * @param te 任务实体
 129    */
 130   private void resumeEntity(AbsTaskEntity te) {
 131     if (te instanceof DownloadTaskEntity) {
 132       if (te.getRequestType() == AbsTaskEntity.D_FTP || te.getRequestType() == AbsTaskEntity.U_FTP) {
 133         te.setUrlEntity(CommonUtil.getFtpUrlInfo(te.getEntity().getKey()));
 134       }
 135       mQueue = DownloadTaskQueue.getInstance();
 136     } else if (te instanceof UploadTaskEntity) {
 137       mQueue = UploadTaskQueue.getInstance();
 138     } else if (te instanceof DownloadGroupTaskEntity) {
 139       mQueue = DownloadGroupTaskQueue.getInstance();
 140     }
 141     int exeNum = mQueue.getCurrentExePoolNum();
 142     if (exeNum == 0 || exeNum &lt; mQueue.getMaxTaskNum()) {
 143       startTask(createTask(te));
 144     } else {
 145       te.getEntity().setState(IEntity.STATE_WAIT);
 146 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147       createTask(te);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148       sendWaitState();</span>
 149 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150       te.getEntity().setState(IEntity.STATE_WAIT);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151       createTask(te);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153   }</span>
 154 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155       AbsTask task = createTask(te);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156       sendWaitState(task);</span>
 157 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 158     }
 159   }
 160 }</pre></td>
                            <td><pre>   1 package com.arialyy.aria.core.command.normal;
   2 
   3 import com.arialyy.aria.core.AriaManager;
   4 import com.arialyy.aria.core.download.DownloadGroupTaskEntity;
   5 import com.arialyy.aria.core.download.DownloadTaskEntity;
   6 import com.arialyy.aria.core.download.wrapper.DGTEWrapper;
   7 import com.arialyy.aria.core.download.wrapper.DTEWrapper;
   8 import com.arialyy.aria.core.inf.AbsTask;
   9 import com.arialyy.aria.core.inf.AbsTaskEntity;
  10 import com.arialyy.aria.core.inf.IEntity;
  11 import com.arialyy.aria.core.queue.DownloadGroupTaskQueue;
  12 import com.arialyy.aria.core.queue.DownloadTaskQueue;
  13 import com.arialyy.aria.core.queue.UploadTaskQueue;
  14 import com.arialyy.aria.core.upload.UploadTaskEntity;
  15 import com.arialyy.aria.core.upload.wrapper.UTEWrapper;
  16 import com.arialyy.aria.orm.DbEntity;
  17 import com.arialyy.aria.util.ALog;
  18 import com.arialyy.aria.util.CommonUtil;
  19 import com.arialyy.aria.util.NetUtils;
  20 import java.util.ArrayList;
  21 import java.util.List;
  22 
  23 /**
  24  * Created by AriaL on 2017/6/13.
  25  * 恢复所有停止的任务
  26  * 1.如果执行队列没有满，则开始下载任务，直到执行队列满
  27  * 2.如果队列执行队列已经满了，则将所有任务添加到等待队列中
  28  * 3.如果队列中只有等待状态的任务，如果执行队列没有满，则会启动等待状态的任务，如果执行队列已经满了，则会将所有等待状态的任务加载到缓存队列中
  29  */
  30 final class ResumeAllCmd&lt;T extends AbsTaskEntity&gt; extends AbsNormalCmd&lt;T&gt; {
  31   private List&lt;AbsTaskEntity&gt; mWaitList = new ArrayList&lt;&gt;();
  32 
  33   /**
  34    * @param targetName 产生任务的对象名
  35    */
  36   ResumeAllCmd(String targetName, T entity, int taskType) {
  37     super(targetName, entity, taskType);
  38   }
  39 
  40   @Override public void executeCmd() {
  41     if (!NetUtils.isConnected(AriaManager.APP)) {
  42       ALog.w(TAG, &quot;恢复任务失败，网络未连接&quot;);
  43       return;
  44     }
  45     if (isDownloadCmd) {
  46       resumeTask(findTaskData(1));
  47       resumeTask(findTaskData(2));
  48     } else {
  49       resumeTask(findTaskData(3));
  50     }
  51     resumeWaitTask();
  52   }
  53 
  54   /**
  55    * 查找数据库中的所有任务数据
  56    *
  57    * @param type {@code 1}单任务下载任务；{@code 2}任务组下载任务；{@code 3} 单任务上传任务
  58    */
  59   private List&lt;AbsTaskEntity&gt; findTaskData(int type) {
  60     List&lt;AbsTaskEntity&gt; tempList = new ArrayList&lt;&gt;();
  61     if (type == 1) {
  62       List&lt;DTEWrapper&gt; wrappers = DbEntity.findRelationData(DTEWrapper.class,
  63           &quot;DownloadTaskEntity.isGroupTask=? and DownloadTaskEntity.state!=?&quot;, &quot;false&quot;, &quot;1&quot;);
  64       if (wrappers != null &amp;&amp; !wrappers.isEmpty()) {
  65         for (DTEWrapper w : wrappers) {
  66           tempList.add(w.taskEntity);
  67         }
  68       }
  69     } else if (type == 2) {
  70       List&lt;DGTEWrapper&gt; wrappers =
  71           DbEntity.findRelationData(DGTEWrapper.class, &quot;DownloadGroupTaskEntity.state!=?&quot;, &quot;1&quot;);
  72       if (wrappers != null &amp;&amp; !wrappers.isEmpty()) {
  73         for (DGTEWrapper w : wrappers) {
  74           tempList.add(w.taskEntity);
  75         }
  76       }
  77     } else if (type == 3) {
  78       List&lt;UTEWrapper&gt; wrappers =
  79           DbEntity.findRelationData(UTEWrapper.class, &quot;UploadTaskEntity.state!=?&quot;, &quot;1&quot;);
  80       if (wrappers != null &amp;&amp; !wrappers.isEmpty()) {
  81         for (UTEWrapper w : wrappers) {
  82           tempList.add(w.taskEntity);
  83         }
  84       }
  85     }
  86     return tempList;
  87   }
  88 
  89   /**
  90    * 恢复任务
  91    */
  92   private void resumeTask(List&lt;AbsTaskEntity&gt; taskList) {
  93     if (taskList != null &amp;&amp; !taskList.isEmpty()) {
  94       for (AbsTaskEntity te : taskList) {
  95         if (te == null || te.getEntity() == null) continue;
  96         int state = te.getState();
  97         if (state == IEntity.STATE_STOP || state == IEntity.STATE_OTHER) {
  98           resumeEntity(te);
  99         } else if (state == IEntity.STATE_WAIT) {
 100           mWaitList.add(te);
 101         } else if (state == IEntity.STATE_RUNNING) {
 102           if (!mQueue.taskIsRunning(te.getEntity().getKey())) {
 103             resumeEntity(te);
 104           }
 105         }
 106       }
 107     }
 108   }
 109 
 110   /**
 111    * 处理等待状态的任务
 112    */
 113   private void resumeWaitTask() {
 114     int maxTaskNum = mQueue.getMaxTaskNum();
 115     if (mWaitList == null || mWaitList.isEmpty()) return;
 116     for (AbsTaskEntity te : mWaitList) {
 117       if (mQueue.getCurrentExePoolNum() &lt; maxTaskNum) {
 118         startTask(createTask(te));
 119       } else {
 120         createTask(te);
 121       }
 122     }
 123   }
 124 
 125   /**
 126    * 恢复实体任务
 127    *
 128    * @param te 任务实体
 129    */
 130   private void resumeEntity(AbsTaskEntity te) {
 131     if (te instanceof DownloadTaskEntity) {
 132       if (te.getRequestType() == AbsTaskEntity.D_FTP || te.getRequestType() == AbsTaskEntity.U_FTP) {
 133         te.setUrlEntity(CommonUtil.getFtpUrlInfo(te.getEntity().getKey()));
 134       }
 135       mQueue = DownloadTaskQueue.getInstance();
 136     } else if (te instanceof UploadTaskEntity) {
 137       mQueue = UploadTaskQueue.getInstance();
 138     } else if (te instanceof DownloadGroupTaskEntity) {
 139       mQueue = DownloadGroupTaskQueue.getInstance();
 140     }
 141     int exeNum = mQueue.getCurrentExePoolNum();
 142     if (exeNum == 0 || exeNum &lt; mQueue.getMaxTaskNum()) {
 143       startTask(createTask(te));
 144     } else {
 145       te.getEntity().setState(IEntity.STATE_WAIT);
 146 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147       createTask(te);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148       sendWaitState();</span>
 149 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150       createTask(te);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151     }</span>
 152 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153       AbsTask task = createTask(te);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154       sendWaitState(task);</span>
 155 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 156     }
 157   }
 158 }
 
 </pre></td>
                            <td><pre>   1 package com.arialyy.aria.core.command.normal;
   2 
   3 import com.arialyy.aria.core.AriaManager;
   4 import com.arialyy.aria.core.download.DownloadGroupTaskEntity;
   5 import com.arialyy.aria.core.download.DownloadTaskEntity;
   6 import com.arialyy.aria.core.download.wrapper.DGTEWrapper;
   7 import com.arialyy.aria.core.download.wrapper.DTEWrapper;
   8 import com.arialyy.aria.core.inf.AbsTask;
   9 import com.arialyy.aria.core.inf.AbsTaskEntity;
  10 import com.arialyy.aria.core.inf.IEntity;
  11 import com.arialyy.aria.core.queue.DownloadGroupTaskQueue;
  12 import com.arialyy.aria.core.queue.DownloadTaskQueue;
  13 import com.arialyy.aria.core.queue.UploadTaskQueue;
  14 import com.arialyy.aria.core.upload.UploadTaskEntity;
  15 import com.arialyy.aria.core.upload.wrapper.UTEWrapper;
  16 import com.arialyy.aria.orm.DbEntity;
  17 import com.arialyy.aria.util.ALog;
  18 import com.arialyy.aria.util.CommonUtil;
  19 import com.arialyy.aria.util.NetUtils;
  20 import java.util.ArrayList;
  21 import java.util.List;
  22 
  23 
  24 /**
  25  * Created by AriaL on 2017/6/13.
  26  * 恢复所有停止的任务
  27  * 1.如果执行队列没有满，则开始下载任务，直到执行队列满
  28  * 2.如果队列执行队列已经满了，则将所有任务添加到等待队列中
  29  * 3.如果队列中只有等待状态的任务，如果执行队列没有满，则会启动等待状态的任务，如果执行队列已经满了，则会将所有等待状态的任务加载到缓存队列中
  30  */
  31 final class ResumeAllCmd&lt;T extends AbsTaskEntity&gt; extends AbsNormalCmd&lt;T&gt; {
  32   private List&lt;AbsTaskEntity&gt; mWaitList = new ArrayList&lt;&gt;();
  33 
  34   /**
  35    *
  36    *
  37    * @param targetName
  38    * 		产生任务的对象名
  39    */
  40   ResumeAllCmd(String targetName, T entity, int taskType) {
  41     super(targetName, entity, taskType);
  42   }
  43 
  44   @Override public void executeCmd() {
  45     if (!NetUtils.isConnected(AriaManager.APP)) {
  46       ALog.w(TAG, &quot;恢复任务失败，网络未连接&quot;);
  47       return;
  48     }
  49     if (isDownloadCmd) {
  50       resumeTask(findTaskData(1));
  51       resumeTask(findTaskData(2));
  52     } else {
  53       resumeTask(findTaskData(3));
  54     }
  55     resumeWaitTask();
  56   }
  57 
  58   /**
  59    * 查找数据库中的所有任务数据
  60    *
  61    * @param type {@code 1}单任务下载任务；{@code 2}任务组下载任务；{@code 3} 单任务上传任务
  62    */
  63   private List&lt;AbsTaskEntity&gt; findTaskData(int type) {
  64     List&lt;AbsTaskEntity&gt; tempList = new ArrayList&lt;&gt;();
  65     if (type == 1) {
<abbr title="  66       List&lt;DTEWrapper&gt; wrappers = DbEntity.findRelationData(DTEWrapper.class, &quot;DownloadTaskEntity.isGroupTask=? and DownloadTaskEntity.state!=?&quot;, &quot;false&quot;, &quot;1&quot;);">  66       List&lt;DTEWrapper&gt; wrappers = DbEntity.findRelationData(DTEWrapper.class, &quot;DownloadTaskEntity.isGroup🔵</abbr>
  67       if ((wrappers != null) &amp;&amp; (!wrappers.isEmpty())) {
  68         for (DTEWrapper w : wrappers) {
  69           tempList.add(w.taskEntity);
  70         }
  71       }
  72     } else if (type == 2) {
<abbr title="  73       List&lt;DGTEWrapper&gt; wrappers = DbEntity.findRelationData(DGTEWrapper.class, &quot;DownloadGroupTaskEntity.state!=?&quot;, &quot;1&quot;);">  73       List&lt;DGTEWrapper&gt; wrappers = DbEntity.findRelationData(DGTEWrapper.class, &quot;DownloadGroupTaskEntity.🔵</abbr>
  74       if ((wrappers != null) &amp;&amp; (!wrappers.isEmpty())) {
  75         for (DGTEWrapper w : wrappers) {
  76           tempList.add(w.taskEntity);
  77         }
  78       }
  79     } else if (type == 3) {
<abbr title="  80       List&lt;UTEWrapper&gt; wrappers = DbEntity.findRelationData(UTEWrapper.class, &quot;UploadTaskEntity.state!=?&quot;, &quot;1&quot;);">  80       List&lt;UTEWrapper&gt; wrappers = DbEntity.findRelationData(UTEWrapper.class, &quot;UploadTaskEntity.state!=?&quot;🔵</abbr>
  81       if ((wrappers != null) &amp;&amp; (!wrappers.isEmpty())) {
  82         for (UTEWrapper w : wrappers) {
  83           tempList.add(w.taskEntity);
  84         }
  85       }
  86     }
  87     return tempList;
  88   }
  89 
  90   /**
  91    * 恢复任务
  92    */
  93   private void resumeTask(List&lt;AbsTaskEntity&gt; taskList) {
  94     if (taskList != null &amp;&amp; !taskList.isEmpty()) {
  95       for (AbsTaskEntity te : taskList) {
  96         if (te == null || te.getEntity() == null) continue;
  97         int state = te.getState();
  98         if (state == IEntity.STATE_STOP || state == IEntity.STATE_OTHER) {
  99           resumeEntity(te);
 100         } else if (state == IEntity.STATE_WAIT) {
 101           mWaitList.add(te);
 102         } else if (state == IEntity.STATE_RUNNING) {
 103           if (!mQueue.taskIsRunning(te.getEntity().getKey())) {
 104             resumeEntity(te);
 105           }
 106         }
 107       }
 108     }
 109   }
 110 
 111   /**
 112    * 处理等待状态的任务
 113    */
 114   private void resumeWaitTask() {
 115     int maxTaskNum = mQueue.getMaxTaskNum();
 116     if (mWaitList == null || mWaitList.isEmpty()) return;
 117     for (AbsTaskEntity te : mWaitList) {
 118       if (mQueue.getCurrentExePoolNum() &lt; maxTaskNum) {
 119         startTask(createTask(te));
 120       } else {
 121         createTask(te);
 122       }
 123     }
 124   }
 125 
 126   /**
 127    * 恢复实体任务
 128    *
 129    * @param te 任务实体
 130    */
 131   private void resumeEntity(AbsTaskEntity te) {
 132     if (te instanceof DownloadTaskEntity) {
 133       if ((te.getRequestType() == AbsTaskEntity.D_FTP) || (te.getRequestType() == AbsTaskEntity.U_FTP)) {
 134         te.setUrlEntity(CommonUtil.getFtpUrlInfo(te.getEntity().getKey()));
 135       }
 136       mQueue = DownloadTaskQueue.getInstance();
 137     } else if (te instanceof UploadTaskEntity) {
 138       mQueue = UploadTaskQueue.getInstance();
 139     } else if (te instanceof DownloadGroupTaskEntity) {
 140       mQueue = DownloadGroupTaskQueue.getInstance();
 141     }
 142     int exeNum = mQueue.getCurrentExePoolNum();
 143     if ((exeNum == 0) || (exeNum &lt; mQueue.getMaxTaskNum())) {
 144       startTask(createTask(te));
 145     } else {
 146       te.getEntity().setState(IEntity.STATE_WAIT);
 147 
 148 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149       createTask(te);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150       sendWaitState();</span>
 151 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 152 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 152 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 153 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155       AbsTask task = createTask(te);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156       sendWaitState(task);</span>
 157 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 158 
 159     }
 160   }
 161 }</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.arialyy.aria.core.command.normal;
   2  
   3  import com.arialyy.aria.core.AriaManager;
   4  import com.arialyy.aria.core.download.DownloadGroupTaskEntity;
   5  import com.arialyy.aria.core.download.DownloadTaskEntity;
   6  import com.arialyy.aria.core.download.wrapper.DGTEWrapper;
   7  import com.arialyy.aria.core.download.wrapper.DTEWrapper;

   8  import com.arialyy.aria.core.inf.AbsTaskEntity;
   9  import com.arialyy.aria.core.inf.IEntity;
  10  import com.arialyy.aria.core.queue.DownloadGroupTaskQueue;
  11  import com.arialyy.aria.core.queue.DownloadTaskQueue;
  12  import com.arialyy.aria.core.queue.UploadTaskQueue;
  13  import com.arialyy.aria.core.upload.UploadTaskEntity;
  14  import com.arialyy.aria.core.upload.wrapper.UTEWrapper;
  15  import com.arialyy.aria.orm.DbEntity;
  16  import com.arialyy.aria.util.ALog;
  17  import com.arialyy.aria.util.CommonUtil;
  18  import com.arialyy.aria.util.NetUtils;
  19  import java.util.ArrayList;
  20  import java.util.List;
  21  
  22  /**
  23   * Created by AriaL on 2017/6/13.
  24   * 恢复所有停止的任务
  25   * 1.如果执行队列没有满，则开始下载任务，直到执行队列满
  26   * 2.如果队列执行队列已经满了，则将所有任务添加到等待队列中
  27   * 3.如果队列中只有等待状态的任务，如果执行队列没有满，则会启动等待状态的任务，如果执行队列已经满了，则会将所有等待状态的任务加载到缓存队列中
  28   */
  29  final class ResumeAllCmd&lt;T extends AbsTaskEntity&gt; extends AbsNormalCmd&lt;T&gt; {
  30    private List&lt;AbsTaskEntity&gt; mWaitList = new ArrayList&lt;&gt;();
  31  
  32    /**
  33     * @param targetName 产生任务的对象名
  34     */
  35    ResumeAllCmd(String targetName, T entity, int taskType) {
  36      super(targetName, entity, taskType);
  37    }
  38  
  39    @Override public void executeCmd() {
  40      if (!NetUtils.isConnected(AriaManager.APP)) {
  41        ALog.w(TAG, &quot;恢复任务失败，网络未连接&quot;);
  42        return;
  43      }
  44      if (isDownloadCmd) {
  45        resumeTask(findTaskData(1));
  46        resumeTask(findTaskData(2));
  47      } else {
  48        resumeTask(findTaskData(3));
  49      }
  50      resumeWaitTask();
  51    }
  52  
  53    /**
  54     * 查找数据库中的所有任务数据
  55     *
  56     * @param type {@code 1}单任务下载任务；{@code 2}任务组下载任务；{@code 3} 单任务上传任务
  57     */
  58    private List&lt;AbsTaskEntity&gt; findTaskData(int type) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -    // TODO: 2018/4/20 需要测试</span>
  60      List&lt;AbsTaskEntity&gt; tempList = new ArrayList&lt;&gt;();
  61      if (type == 1) {
  62        List&lt;DTEWrapper&gt; wrappers = DbEntity.findRelationData(DTEWrapper.class,
  63            &quot;DownloadTaskEntity.isGroupTask=? and DownloadTaskEntity.state!=?&quot;, &quot;false&quot;, &quot;1&quot;);
  64        if (wrappers != null &amp;&amp; !wrappers.isEmpty()) {
  65          for (DTEWrapper w : wrappers) {
  66            tempList.add(w.taskEntity);
  67          }
  68        }
  69      } else if (type == 2) {
  70        List&lt;DGTEWrapper&gt; wrappers =
  71            DbEntity.findRelationData(DGTEWrapper.class, &quot;DownloadGroupTaskEntity.state!=?&quot;, &quot;1&quot;);
  72        if (wrappers != null &amp;&amp; !wrappers.isEmpty()) {
  73          for (DGTEWrapper w : wrappers) {
  74            tempList.add(w.taskEntity);
  75          }
  76        }
  77      } else if (type == 3) {
  78        List&lt;UTEWrapper&gt; wrappers =
  79            DbEntity.findRelationData(UTEWrapper.class, &quot;UploadTaskEntity.state!=?&quot;, &quot;1&quot;);
  80        if (wrappers != null &amp;&amp; !wrappers.isEmpty()) {
  81          for (UTEWrapper w : wrappers) {
  82            tempList.add(w.taskEntity);
  83          }
  84        }
  85      }
  86      return tempList;
  87    }
  88  
  89    /**
  90     * 恢复任务
  91     */
  92    private void resumeTask(List&lt;AbsTaskEntity&gt; taskList) {
  93      if (taskList != null &amp;&amp; !taskList.isEmpty()) {
  94        for (AbsTaskEntity te : taskList) {
  95          if (te == null || te.getEntity() == null) continue;
  96          int state = te.getState();
  97          if (state == IEntity.STATE_STOP || state == IEntity.STATE_OTHER) {
  98            resumeEntity(te);
  99          } else if (state == IEntity.STATE_WAIT) {
 100            mWaitList.add(te);
 101          } else if (state == IEntity.STATE_RUNNING) {
 102            if (!mQueue.taskIsRunning(te.getEntity().getKey())) {
 103              resumeEntity(te);
 104            }
 105          }
 106        }
 107      }
 108    }
 109  
 110    /**
 111     * 处理等待状态的任务
 112     */
 113    private void resumeWaitTask() {
 114      int maxTaskNum = mQueue.getMaxTaskNum();
 115      if (mWaitList == null || mWaitList.isEmpty()) return;
 116      for (AbsTaskEntity te : mWaitList) {
 117        if (mQueue.getCurrentExePoolNum() &lt; maxTaskNum) {
 118          startTask(createTask(te));
 119        } else {
 120          createTask(te);
 121        }
 122      }
 123    }
 124  
 125    /**
 126     * 恢复实体任务
 127     *
 128     * @param te 任务实体
 129     */
 130    private void resumeEntity(AbsTaskEntity te) {
 131      if (te instanceof DownloadTaskEntity) {
 132        if (te.getRequestType() == AbsTaskEntity.D_FTP || te.getRequestType() == AbsTaskEntity.U_FTP) {
 133          te.setUrlEntity(CommonUtil.getFtpUrlInfo(te.getEntity().getKey()));
 134        }
 135        mQueue = DownloadTaskQueue.getInstance();
 136      } else if (te instanceof UploadTaskEntity) {
 137        mQueue = UploadTaskQueue.getInstance();
 138      } else if (te instanceof DownloadGroupTaskEntity) {
 139        mQueue = DownloadGroupTaskQueue.getInstance();
 140      }
 141      int exeNum = mQueue.getCurrentExePoolNum();
 142      if (exeNum == 0 || exeNum &lt; mQueue.getMaxTaskNum()) {
 143        startTask(createTask(te));
 144      } else {
 145        te.getEntity().setState(IEntity.STATE_WAIT);
 146        createTask(te);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +      sendWaitState();</span>

 148      }
 149    }
 150  }</pre></td>
                            <td><pre>   1  package com.arialyy.aria.core.command.normal;
   2  
   3  import com.arialyy.aria.core.AriaManager;
   4  import com.arialyy.aria.core.download.DownloadGroupTaskEntity;
   5  import com.arialyy.aria.core.download.DownloadTaskEntity;
   6  import com.arialyy.aria.core.download.wrapper.DGTEWrapper;
   7  import com.arialyy.aria.core.download.wrapper.DTEWrapper;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 +import com.arialyy.aria.core.inf.AbsTask;</span>
   9  import com.arialyy.aria.core.inf.AbsTaskEntity;
  10  import com.arialyy.aria.core.inf.IEntity;
  11  import com.arialyy.aria.core.queue.DownloadGroupTaskQueue;
  12  import com.arialyy.aria.core.queue.DownloadTaskQueue;
  13  import com.arialyy.aria.core.queue.UploadTaskQueue;
  14  import com.arialyy.aria.core.upload.UploadTaskEntity;
  15  import com.arialyy.aria.core.upload.wrapper.UTEWrapper;
  16  import com.arialyy.aria.orm.DbEntity;
  17  import com.arialyy.aria.util.ALog;
  18  import com.arialyy.aria.util.CommonUtil;
  19  import com.arialyy.aria.util.NetUtils;
  20  import java.util.ArrayList;
  21  import java.util.List;
  22  
  23  /**
  24   * Created by AriaL on 2017/6/13.
  25   * 恢复所有停止的任务
  26   * 1.如果执行队列没有满，则开始下载任务，直到执行队列满
  27   * 2.如果队列执行队列已经满了，则将所有任务添加到等待队列中
  28   * 3.如果队列中只有等待状态的任务，如果执行队列没有满，则会启动等待状态的任务，如果执行队列已经满了，则会将所有等待状态的任务加载到缓存队列中
  29   */
  30  final class ResumeAllCmd&lt;T extends AbsTaskEntity&gt; extends AbsNormalCmd&lt;T&gt; {
  31    private List&lt;AbsTaskEntity&gt; mWaitList = new ArrayList&lt;&gt;();
  32  
  33    /**
  34     * @param targetName 产生任务的对象名
  35     */
  36    ResumeAllCmd(String targetName, T entity, int taskType) {
  37      super(targetName, entity, taskType);
  38    }
  39  
  40    @Override public void executeCmd() {
  41      if (!NetUtils.isConnected(AriaManager.APP)) {
  42        ALog.w(TAG, &quot;恢复任务失败，网络未连接&quot;);
  43        return;
  44      }
  45      if (isDownloadCmd) {
  46        resumeTask(findTaskData(1));
  47        resumeTask(findTaskData(2));
  48      } else {
  49        resumeTask(findTaskData(3));
  50      }
  51      resumeWaitTask();
  52    }
  53  
  54    /**
  55     * 查找数据库中的所有任务数据
  56     *
  57     * @param type {@code 1}单任务下载任务；{@code 2}任务组下载任务；{@code 3} 单任务上传任务
  58     */
  59    private List&lt;AbsTaskEntity&gt; findTaskData(int type) {
  60      // TODO: 2018/4/20 需要测试
  61      List&lt;AbsTaskEntity&gt; tempList = new ArrayList&lt;&gt;();
  62      if (type == 1) {
  63        List&lt;DTEWrapper&gt; wrappers = DbEntity.findRelationData(DTEWrapper.class,
  64            &quot;DownloadTaskEntity.isGroupTask=? and DownloadTaskEntity.state!=?&quot;, &quot;false&quot;, &quot;1&quot;);
  65        if (wrappers != null &amp;&amp; !wrappers.isEmpty()) {
  66          for (DTEWrapper w : wrappers) {
  67            tempList.add(w.taskEntity);
  68          }
  69        }
  70      } else if (type == 2) {
  71        List&lt;DGTEWrapper&gt; wrappers =
  72            DbEntity.findRelationData(DGTEWrapper.class, &quot;DownloadGroupTaskEntity.state!=?&quot;, &quot;1&quot;);
  73        if (wrappers != null &amp;&amp; !wrappers.isEmpty()) {
  74          for (DGTEWrapper w : wrappers) {
  75            tempList.add(w.taskEntity);
  76          }
  77        }
  78      } else if (type == 3) {
  79        List&lt;UTEWrapper&gt; wrappers =
  80            DbEntity.findRelationData(UTEWrapper.class, &quot;UploadTaskEntity.state!=?&quot;, &quot;1&quot;);
  81        if (wrappers != null &amp;&amp; !wrappers.isEmpty()) {
  82          for (UTEWrapper w : wrappers) {
  83            tempList.add(w.taskEntity);
  84          }
  85        }
  86      }
  87      return tempList;
  88    }
  89  
  90    /**
  91     * 恢复任务
  92     */
  93    private void resumeTask(List&lt;AbsTaskEntity&gt; taskList) {
  94      if (taskList != null &amp;&amp; !taskList.isEmpty()) {
  95        for (AbsTaskEntity te : taskList) {
  96          if (te == null || te.getEntity() == null) continue;
  97          int state = te.getState();
  98          if (state == IEntity.STATE_STOP || state == IEntity.STATE_OTHER) {
  99            resumeEntity(te);
 100          } else if (state == IEntity.STATE_WAIT) {
 101            mWaitList.add(te);
 102          } else if (state == IEntity.STATE_RUNNING) {
 103            if (!mQueue.taskIsRunning(te.getEntity().getKey())) {
 104              resumeEntity(te);
 105            }
 106          }
 107        }
 108      }
 109    }
 110  
 111    /**
 112     * 处理等待状态的任务
 113     */
 114    private void resumeWaitTask() {
 115      int maxTaskNum = mQueue.getMaxTaskNum();
 116      if (mWaitList == null || mWaitList.isEmpty()) return;
 117      for (AbsTaskEntity te : mWaitList) {
 118        if (mQueue.getCurrentExePoolNum() &lt; maxTaskNum) {
 119          startTask(createTask(te));
 120        } else {
 121          createTask(te);
 122        }
 123      }
 124    }
 125  
 126    /**
 127     * 恢复实体任务
 128     *
 129     * @param te 任务实体
 130     */
 131    private void resumeEntity(AbsTaskEntity te) {
 132      if (te instanceof DownloadTaskEntity) {
 133        if (te.getRequestType() == AbsTaskEntity.D_FTP || te.getRequestType() == AbsTaskEntity.U_FTP) {
 134          te.setUrlEntity(CommonUtil.getFtpUrlInfo(te.getEntity().getKey()));
 135        }
 136        mQueue = DownloadTaskQueue.getInstance();
 137      } else if (te instanceof UploadTaskEntity) {
 138        mQueue = UploadTaskQueue.getInstance();
 139      } else if (te instanceof DownloadGroupTaskEntity) {
 140        mQueue = DownloadGroupTaskQueue.getInstance();
 141      }
 142      int exeNum = mQueue.getCurrentExePoolNum();
 143      if (exeNum == 0 || exeNum &lt; mQueue.getMaxTaskNum()) {
 144        startTask(createTask(te));
 145      } else {
 146        te.getEntity().setState(IEntity.STATE_WAIT);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -      createTask(te);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +      AbsTask task = createTask(te);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +      sendWaitState(task);</span>
 150      }
 151    }
 152  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            