<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>134</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    134
                    <a href="133.html">prev</a>
                    <a href="135.html">next</a>
                    <a href="134_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_8ec316b606af0886a6e3f206ba607cf9a095ae8f_Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;8ec316b606af0886a6e3f206ba607cf9a095ae8f:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;8ec316b606af0886a6e3f206ba607cf9a095ae8f^1:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;8ec316b606af0886a6e3f206ba607cf9a095ae8f^2:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;04d77bda04eb0af8ff637d58bcb982b21e1869ba:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.DialogInterface;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.net.Uri;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.widget.Toast;
  12 
  13 import androidx.appcompat.app.AlertDialog;
  14 import androidx.appcompat.view.ContextThemeWrapper;
  15 import androidx.preference.ListPreference;
  16 import androidx.preference.Preference;
  17 import androidx.preference.PreferenceFragmentCompat;
  18 import androidx.preference.PreferenceManager;
  19 import androidx.preference.SwitchPreferenceCompat;
  20 
  21 import com.automattic.simplenote.analytics.AnalyticsTracker;
  22 import com.automattic.simplenote.models.Note;
  23 import com.automattic.simplenote.models.Preferences;
  24 import com.automattic.simplenote.utils.CrashUtils;
  25 import com.automattic.simplenote.utils.HtmlCompat;
  26 import com.automattic.simplenote.utils.PrefUtils;
  27 import com.automattic.simplenote.utils.WidgetUtils;
  28 import com.simperium.Simperium;
  29 import com.simperium.client.Bucket;
  30 import com.simperium.client.BucketObjectMissingException;
  31 import com.simperium.client.BucketObjectNameInvalid;
  32 import com.simperium.client.User;
  33 
  34 import java.lang.ref.WeakReference;
  35 
  36 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  37 
  38 /**
  39  * A simple {@link Fragment} subclass.
  40  */
  41 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener,
  42         Simperium.OnUserCreatedListener {
  43 
  44     private static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  45 
  46     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  47     private SwitchPreferenceCompat mAnalyticsSwitch;
  48 
  49     public PreferencesFragment() {
  50         // Required empty public constructor
  51     }
  52 
  53     @Override
  54     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  55         addPreferencesFromResource(R.xml.preferences);
  56     }
  57 
  58     @Override
  59     public void onActivityCreated(Bundle savedInstanceState) {
  60         super.onActivityCreated(savedInstanceState);
  61 
  62         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  63         Simplenote currentApp = (Simplenote) getActivity().getApplication();
  64         Simperium simperium = currentApp.getSimperium();
  65         simperium.setUserStatusChangeListener(this);
  66         simperium.setOnUserCreatedListener(this);
  67         mPreferencesBucket = currentApp.getPreferencesBucket();
  68         mPreferencesBucket.start();
  69 
  70         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  71         if (simperium.needsAuthorization()) {
  72             authenticatePreference.setTitle(R.string.sign_in);
  73         } else {
  74             authenticatePreference.setTitle(R.string.sign_out);
  75         }
  76 
  77         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
  78             @Override
  79             public boolean onPreferenceClick(Preference preference) {
  80                 if (!isAdded()) {
  81                     return false;
  82                 }
  83 
  84                 Simplenote currentApp = (Simplenote) getActivity().getApplication();
  85                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title="  86                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);">  86                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
  87                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
  88                 } else {
  89                     new SignOutAsyncTask(PreferencesFragment.this).execute();
  90                 }
  91                 return true;
  92             }
  93         });
  94 
<abbr title="  95         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {">  95         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
  96             @Override
  97             public boolean onPreferenceClick(Preference preference) {
  98                 try {
  99                     startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(&quot;http://simplenote.com&quot;)));
 100                 } catch (Exception e) {
<abbr title=" 101                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();"> 101                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show(ðŸ”µ</abbr>
 102                 }
 103                 return true;
 104             }
 105         });
 106 
<abbr title=" 107         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 107         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
 108             @Override
 109             public boolean onPreferenceClick(Preference preference) {
 110                 startActivity(new Intent(getActivity(), AboutActivity.class));
 111                 return true;
 112             }
 113         });
 114 
 115         final ListPreference themePreference = (ListPreference) findPreference(PrefUtils.PREF_THEME);
 116         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 117             @Override
 118             public boolean onPreferenceChange(Preference preference, Object newValue) {
 119 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121                 final Activity activity = getActivity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122                 final int index = Integer.parseInt(newValue.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123                 if (index == ThemeUtils.THEME_AUTO) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125                     PermissionListener permissionListener = new BasePermissionListener() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126                         @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127                         public void onPermissionGranted(PermissionGrantedResponse response) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128                             updateTheme(activity, index);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130                         @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131                         public void onPermissionDenied(PermissionDeniedResponse response) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132                             new AlertDialog.Builder(new ContextThemeWrapper(activity, R.style.Dialog))</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133                                     .setTitle(R.string.location_permission_denied)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134                                     .setMessage(R.string.location_permission_explanation)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 135                                     .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {"> 135                                     .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickLiðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 136                                         @Override public void onClick(DialogInterface dialog, int which) {"> 136                                         @Override public void onClick(DialogInterface dialog, int which) ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137                                             dialog.dismiss();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138                                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139                                     })</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140                                     .show();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142                     };</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143                     Dexter.withActivity(activity)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144                             .withPermission(Manifest.permission.ACCESS_COARSE_LOCATION)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145                             .withListener(permissionListener)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146                             .check();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147                     updateTheme(activity, index);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149                     updateTheme(activity, index);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151 </span>
 152 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156         final ListPreference themePreference = (ListPreference) findPreference(PrefUtils.PREF_THEME);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160             public boolean onPreferenceChange(Preference preference, Object newValue) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162                 final Activity activity = getActivity();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163                 final int index = Integer.parseInt(newValue.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164                 if (index == ThemeUtils.THEME_AUTO) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166                     PermissionListener permissionListener = new BasePermissionListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167                         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168                         public void onPermissionGranted(PermissionGrantedResponse response) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169                             updateTheme(activity, index);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171                         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172                         public void onPermissionDenied(PermissionDeniedResponse response) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173                             new AlertDialog.Builder(activity)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174                                     .setTitle(R.string.location_permission_denied)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175                                     .setMessage(R.string.location_permission_explanation)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 176                                     .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {"> 176                                     .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickLiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 177                                         @Override public void onClick(DialogInterface dialog, int which) {"> 177                                         @Override public void onClick(DialogInterface dialog, int which) ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178                                             dialog.dismiss();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179                                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180                                     })</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181                                     .show();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183                     };</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184                     Dexter.withActivity(activity)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185                             .withPermission(Manifest.permission.ACCESS_COARSE_LOCATION)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186                             .withListener(permissionListener)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187                             .check();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188                     updateTheme(activity, index);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190                     updateTheme(activity, index);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 return true;</span>
 194 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));</span>
 196 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 197                 return true;
 198             }
 199 
 200             private void updateTheme(Activity activity, int index) {
 201                 CharSequence[] entries = themePreference.getEntries();
 202                 themePreference.setSummary(entries[index]);
 203 
 204                 AnalyticsTracker.track(
 205                         AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 206                         AnalyticsTracker.CATEGORY_USER,
 207                         &quot;theme_preference&quot;
 208                 );
 209 
 210                 // recreate the activity so new theme is applied
 211                 activity.recreate();
 212             }
 213         });
 214 
 215         final ListPreference sortPreference = (ListPreference) findPreference(PrefUtils.PREF_SORT_ORDER);
 216         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 217             @Override
 218             public boolean onPreferenceChange(Preference preference, Object newValue) {
 219                 int index = Integer.parseInt(newValue.toString());
 220                 CharSequence[] entries = sortPreference.getEntries();
 221                 sortPreference.setSummary(entries[index]);
 222 
 223                 return true;
 224             }
 225         });
 226 
 227         Preference versionPref = findPreference(&quot;pref_key_build&quot;);
 228         versionPref.setSummary(PrefUtils.versionInfo());
 229 
<abbr title=" 230         SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_note_list&quot;);"> 230         SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condeðŸ”µ</abbr>
 231         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 232             @Override
 233             public boolean onPreferenceChange(Preference preference, Object o) {
 234                 if (((SwitchPreferenceCompat) preference).isChecked()) {
 235                     AnalyticsTracker.track(
 236                             AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 237                             AnalyticsTracker.CATEGORY_USER,
 238                             &quot;condensed_list_preference&quot;
 239                     );
 240                 }
 241 
 242                 return true;
 243             }
 244         });
 245 
 246         // Add the hyperlink to the analytics summary
 247         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 248         String formattedSummary = String.format(
 249                 getString(R.string.share_analytics_summary),
 250                 &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 251                 &quot;&lt;/a&gt;&quot;
 252         );
 253         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 254 
 255         mAnalyticsSwitch = (SwitchPreferenceCompat)findPreference(&quot;pref_key_analytics_switch&quot;);
 256         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 257             @Override
 258             public boolean onPreferenceChange(Preference preference, Object newValue) {
 259                 try {
 260                     boolean isChecked = (boolean)newValue;
 261                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 262                     prefs.setAnalyticsEnabled(isChecked);
 263                     prefs.save();
 264                 } catch (BucketObjectMissingException e) {
 265                     e.printStackTrace();
 266                 }
 267 
 268                 return true;
 269             }
 270         });
 271 
 272         updateAnalyticsSwitchState();
 273     }
 274 
 275     @Override
 276     public void onPause() {
 277         super.onPause();
 278         mPreferencesBucket.stop();
 279     }
 280 
<abbr title=" 281     private DialogInterface.OnClickListener signOutClickListener = new DialogInterface.OnClickListener() {"> 281     private DialogInterface.OnClickListener signOutClickListener = new DialogInterface.OnClickListener() ðŸ”µ</abbr>
 282         @Override
 283         public void onClick(DialogInterface dialogInterface, int i) {
 284             signOut();
 285         }
 286     };
 287 
<abbr title=" 288     private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListener() {"> 288     private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListenerðŸ”µ</abbr>
 289         @Override
 290         public void onClick(DialogInterface dialogInterface, int i) {
 291             startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(WEB_APP_URL)));
 292         }
 293     };
 294 
 295     private boolean hasUnsyncedNotes() {
 296         Simplenote application = (Simplenote) getActivity().getApplication();
 297         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 298         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 299         while (notesCursor.moveToNext()) {
 300             Note note = notesCursor.getObject();
 301             if (note.isNew() || note.isModified()) {
 302                 return true;
 303             }
 304         }
 305 
 306         return false;
 307     }
 308 
 309     private void signOut() {
 310         Simplenote application = (Simplenote) getActivity().getApplication();
 311         application.getSimperium().deauthorizeUser();
 312 
 313         application.getNotesBucket().reset();
 314         application.getTagsBucket().reset();
 315         application.getPreferencesBucket().reset();
 316 
 317         application.getNotesBucket().stop();
 318         application.getTagsBucket().stop();
 319         application.getPreferencesBucket().stop();
 320 
 321         AnalyticsTracker.track(
 322                 AnalyticsTracker.Stat.USER_SIGNED_OUT,
 323                 AnalyticsTracker.CATEGORY_USER,
 324                 &quot;preferences_sign_out_button&quot;
 325         );
 326 
 327         // Resets analytics user back to &#x27;anon&#x27; type
 328         AnalyticsTracker.refreshMetadata(null);
 329         CrashUtils.clearCurrentUser();
 330 
 331         // Remove wp.com token
<abbr title=" 332         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();"> 332         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edðŸ”µ</abbr>
 333         editor.remove(PrefUtils.PREF_WP_TOKEN);
 334 
 335         // Remove WordPress sites
 336         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 337         editor.apply();
 338 
 339         WidgetUtils.updateNoteWidgets(getActivity());
 340 
 341         getActivity().finish();
 342     }
 343 
 344     @Override
 345     public void onUserStatusChange(User.Status status) {
 346         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 347             // User signed in
 348             getActivity().runOnUiThread(new Runnable() {
 349                 public void run() {
 350                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 351                     authenticatePreference.setTitle(R.string.sign_out);
 352                 }
 353             });
 354 
 355             Simplenote app = (Simplenote) getActivity().getApplication();
 356             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 357             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 358 
 359             AnalyticsTracker.track(
 360                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 361                     AnalyticsTracker.CATEGORY_USER,
 362                     &quot;signed_in_from_preferences_activity&quot;
 363             );
 364         }
 365     }
 366 
 367     @Override
 368     public void onUserCreated(User user) {
 369         AnalyticsTracker.track(
 370                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 371                 AnalyticsTracker.CATEGORY_USER,
 372                 &quot;account_created_from_preferences_activity&quot;
 373         );
 374     }
 375 
 376     private void updateAnalyticsSwitchState() {
 377         try {
 378             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 379             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 380         } catch (BucketObjectMissingException e) {
 381             // The preferences object doesn&#x27;t exist for this user yet, create it
 382             try {
 383                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 384                 prefs.setAnalyticsEnabled(true);
 385                 prefs.save();
 386             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 387                 bucketObjectNameInvalid.printStackTrace();
 388             }
 389         }
 390     }
 391 
 392     private static class SignOutAsyncTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 393         private WeakReference&lt;PreferencesFragment&gt; fragmentWeakReference;
 394 
 395         SignOutAsyncTask(PreferencesFragment fragment) {
 396             fragmentWeakReference = new WeakReference&lt;&gt;(fragment);
 397         }
 398 
 399         @Override
 400         protected Boolean doInBackground(Void... voids) {
 401             PreferencesFragment fragment = fragmentWeakReference.get();
 402             return fragment == null || fragment.hasUnsyncedNotes();
 403         }
 404 
 405         @Override
 406         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 407             PreferencesFragment fragment = fragmentWeakReference.get();
 408             if (fragment == null) {
 409                 return;
 410             }
 411 
 412             // Safety first! Check if any notes are unsynced and warn the user if so.
 413             if (hasUnsyncedNotes) {
<abbr title=" 414                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))"> 414                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 415                         .setTitle(R.string.unsynced_notes)
 416                         .setMessage(R.string.unsynced_notes_message)
 417                         .setPositiveButton(R.string.delete_notes, fragment.signOutClickListener)
 418                         .setNeutralButton(R.string.visit_web_app, fragment.loadWebAppClickListener)
 419                         .setNegativeButton(R.string.cancel, null)
 420                         .show();
 421             } else {
 422                 fragment.signOut();
 423             }
 424         }
 425     }
 426 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.DialogInterface;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.net.Uri;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.widget.Toast;
  12 
  13 import androidx.appcompat.app.AlertDialog;
  14 import androidx.appcompat.view.ContextThemeWrapper;
  15 import androidx.preference.ListPreference;
  16 import androidx.preference.Preference;
  17 import androidx.preference.PreferenceFragmentCompat;
  18 import androidx.preference.PreferenceManager;
  19 import androidx.preference.SwitchPreferenceCompat;
  20 
  21 import com.automattic.simplenote.analytics.AnalyticsTracker;
  22 import com.automattic.simplenote.models.Note;
  23 import com.automattic.simplenote.models.Preferences;
  24 import com.automattic.simplenote.utils.CrashUtils;
  25 import com.automattic.simplenote.utils.HtmlCompat;
  26 import com.automattic.simplenote.utils.PrefUtils;
  27 import com.automattic.simplenote.utils.WidgetUtils;
  28 import com.simperium.Simperium;
  29 import com.simperium.client.Bucket;
  30 import com.simperium.client.BucketObjectMissingException;
  31 import com.simperium.client.BucketObjectNameInvalid;
  32 import com.simperium.client.User;
  33 
  34 import java.lang.ref.WeakReference;
  35 
  36 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  37 
  38 /**
  39  * A simple {@link Fragment} subclass.
  40  */
  41 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener,
  42         Simperium.OnUserCreatedListener {
  43 
  44     private static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  45 
  46     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  47     private SwitchPreferenceCompat mAnalyticsSwitch;
  48 
  49     public PreferencesFragment() {
  50         // Required empty public constructor
  51     }
  52 
  53     @Override
  54     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  55         addPreferencesFromResource(R.xml.preferences);
  56     }
  57 
  58     @Override
  59     public void onActivityCreated(Bundle savedInstanceState) {
  60         super.onActivityCreated(savedInstanceState);
  61 
  62         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  63         Simplenote currentApp = (Simplenote) getActivity().getApplication();
  64         Simperium simperium = currentApp.getSimperium();
  65         simperium.setUserStatusChangeListener(this);
  66         simperium.setOnUserCreatedListener(this);
  67         mPreferencesBucket = currentApp.getPreferencesBucket();
  68         mPreferencesBucket.start();
  69 
  70         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  71         if (simperium.needsAuthorization()) {
  72             authenticatePreference.setTitle(R.string.sign_in);
  73         } else {
  74             authenticatePreference.setTitle(R.string.sign_out);
  75         }
  76 
  77         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
  78             @Override
  79             public boolean onPreferenceClick(Preference preference) {
  80                 if (!isAdded()) {
  81                     return false;
  82                 }
  83 
  84                 Simplenote currentApp = (Simplenote) getActivity().getApplication();
  85                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title="  86                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);">  86                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
  87                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
  88                 } else {
  89                     new SignOutAsyncTask(PreferencesFragment.this).execute();
  90                 }
  91                 return true;
  92             }
  93         });
  94 
<abbr title="  95         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {">  95         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
  96             @Override
  97             public boolean onPreferenceClick(Preference preference) {
  98                 try {
  99                     startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(&quot;http://simplenote.com&quot;)));
 100                 } catch (Exception e) {
<abbr title=" 101                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();"> 101                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show(ðŸ”µ</abbr>
 102                 }
 103                 return true;
 104             }
 105         });
 106 
<abbr title=" 107         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 107         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
 108             @Override
 109             public boolean onPreferenceClick(Preference preference) {
 110                 startActivity(new Intent(getActivity(), AboutActivity.class));
 111                 return true;
 112             }
 113         });
 114 
 115         final ListPreference themePreference = (ListPreference) findPreference(PrefUtils.PREF_THEME);
 116         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 117             @Override
 118             public boolean onPreferenceChange(Preference preference, Object newValue) {
 119 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121                 final Activity activity = getActivity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122                 final int index = Integer.parseInt(newValue.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123                 if (index == ThemeUtils.THEME_AUTO) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125                     PermissionListener permissionListener = new BasePermissionListener() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126                         @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127                         public void onPermissionGranted(PermissionGrantedResponse response) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128                             updateTheme(activity, index);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130                         @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131                         public void onPermissionDenied(PermissionDeniedResponse response) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132                             new AlertDialog.Builder(new ContextThemeWrapper(activity, R.style.Dialog))</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133                                     .setTitle(R.string.location_permission_denied)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134                                     .setMessage(R.string.location_permission_explanation)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 135                                     .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {"> 135                                     .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickLiðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 136                                         @Override public void onClick(DialogInterface dialog, int which) {"> 136                                         @Override public void onClick(DialogInterface dialog, int which) ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137                                             dialog.dismiss();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138                                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139                                     })</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140                                     .show();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142                     };</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143                     Dexter.withActivity(activity)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144                             .withPermission(Manifest.permission.ACCESS_COARSE_LOCATION)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145                             .withListener(permissionListener)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146                             .check();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147                     updateTheme(activity, index);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149                     updateTheme(activity, index);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151 </span>
 152 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153             public boolean onPreferenceChange(Preference preference, Object newValue) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155                 final Activity activity = getActivity();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156                 final int index = Integer.parseInt(newValue.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157                 if (index == ThemeUtils.THEME_AUTO) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159                     PermissionListener permissionListener = new BasePermissionListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160                         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161                         public void onPermissionGranted(PermissionGrantedResponse response) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162                             updateTheme(activity, index);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164                         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165                         public void onPermissionDenied(PermissionDeniedResponse response) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166                             new AlertDialog.Builder(activity)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167                                     .setTitle(R.string.location_permission_denied)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168                                     .setMessage(R.string.location_permission_explanation)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 169                                     .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {"> 169                                     .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickLiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 170                                         @Override public void onClick(DialogInterface dialog, int which) {"> 170                                         @Override public void onClick(DialogInterface dialog, int which) ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171                                             dialog.dismiss();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172                                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173                                     })</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174                                     .show();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176                     };</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177                     Dexter.withActivity(activity)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178                             .withPermission(Manifest.permission.ACCESS_COARSE_LOCATION)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179                             .withListener(permissionListener)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180                             .check();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181                     updateTheme(activity, index);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183                     updateTheme(activity, index);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185 </span>
 186 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));</span>
 188 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 189                 return true;
 190             }
 191 
 192             private void updateTheme(Activity activity, int index) {
 193                 CharSequence[] entries = themePreference.getEntries();
 194                 themePreference.setSummary(entries[index]);
 195 
 196                 AnalyticsTracker.track(
 197                         AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 198                         AnalyticsTracker.CATEGORY_USER,
 199                         &quot;theme_preference&quot;
 200                 );
 201 
 202                 // recreate the activity so new theme is applied
 203                 activity.recreate();
 204             }
 205         });
 206 
 207         final ListPreference sortPreference = (ListPreference) findPreference(PrefUtils.PREF_SORT_ORDER);
 208         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 209             @Override
 210             public boolean onPreferenceChange(Preference preference, Object newValue) {
 211                 int index = Integer.parseInt(newValue.toString());
 212                 CharSequence[] entries = sortPreference.getEntries();
 213                 sortPreference.setSummary(entries[index]);
 214 
 215                 return true;
 216             }
 217         });
 218 
 219         Preference versionPref = findPreference(&quot;pref_key_build&quot;);
 220         versionPref.setSummary(PrefUtils.versionInfo());
 221 
<abbr title=" 222         SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_note_list&quot;);"> 222         SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condeðŸ”µ</abbr>
 223         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 224             @Override
 225             public boolean onPreferenceChange(Preference preference, Object o) {
 226                 if (((SwitchPreferenceCompat) preference).isChecked()) {
 227                     AnalyticsTracker.track(
 228                             AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 229                             AnalyticsTracker.CATEGORY_USER,
 230                             &quot;condensed_list_preference&quot;
 231                     );
 232                 }
 233 
 234                 return true;
 235             }
 236         });
 237 
 238         // Add the hyperlink to the analytics summary
 239         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 240         String formattedSummary = String.format(
 241                 getString(R.string.share_analytics_summary),
 242                 &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 243                 &quot;&lt;/a&gt;&quot;
 244         );
 245         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 246 
 247         mAnalyticsSwitch = (SwitchPreferenceCompat)findPreference(&quot;pref_key_analytics_switch&quot;);
 248         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 249             @Override
 250             public boolean onPreferenceChange(Preference preference, Object newValue) {
 251                 try {
 252                     boolean isChecked = (boolean)newValue;
 253                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 254                     prefs.setAnalyticsEnabled(isChecked);
 255                     prefs.save();
 256                 } catch (BucketObjectMissingException e) {
 257                     e.printStackTrace();
 258                 }
 259 
 260                 return true;
 261             }
 262         });
 263 
 264         updateAnalyticsSwitchState();
 265     }
 266 
 267     @Override
 268     public void onPause() {
 269         super.onPause();
 270         mPreferencesBucket.stop();
 271     }
 272 
<abbr title=" 273     private DialogInterface.OnClickListener signOutClickListener = new DialogInterface.OnClickListener() {"> 273     private DialogInterface.OnClickListener signOutClickListener = new DialogInterface.OnClickListener() ðŸ”µ</abbr>
 274         @Override
 275         public void onClick(DialogInterface dialogInterface, int i) {
 276             signOut();
 277         }
 278     };
 279 
<abbr title=" 280     private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListener() {"> 280     private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListenerðŸ”µ</abbr>
 281         @Override
 282         public void onClick(DialogInterface dialogInterface, int i) {
 283             startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(WEB_APP_URL)));
 284         }
 285     };
 286 
 287     private boolean hasUnsyncedNotes() {
 288         Simplenote application = (Simplenote) getActivity().getApplication();
 289         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 290         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 291         while (notesCursor.moveToNext()) {
 292             Note note = notesCursor.getObject();
 293             if (note.isNew() || note.isModified()) {
 294                 return true;
 295             }
 296         }
 297 
 298         return false;
 299     }
 300 
 301     private void signOut() {
 302         Simplenote application = (Simplenote) getActivity().getApplication();
 303         application.getSimperium().deauthorizeUser();
 304 
 305         application.getNotesBucket().reset();
 306         application.getTagsBucket().reset();
 307         application.getPreferencesBucket().reset();
 308 
 309         application.getNotesBucket().stop();
 310         application.getTagsBucket().stop();
 311         application.getPreferencesBucket().stop();
 312 
 313         AnalyticsTracker.track(
 314                 AnalyticsTracker.Stat.USER_SIGNED_OUT,
 315                 AnalyticsTracker.CATEGORY_USER,
 316                 &quot;preferences_sign_out_button&quot;
 317         );
 318 
 319         // Resets analytics user back to &#x27;anon&#x27; type
 320         AnalyticsTracker.refreshMetadata(null);
 321         CrashUtils.clearCurrentUser();
 322 
 323         // Remove wp.com token
<abbr title=" 324         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();"> 324         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edðŸ”µ</abbr>
 325         editor.remove(PrefUtils.PREF_WP_TOKEN);
 326 
 327         // Remove WordPress sites
 328         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 329         editor.apply();
 330 
 331         WidgetUtils.updateNoteWidgets(getActivity());
 332 
 333         getActivity().finish();
 334     }
 335 
 336     @Override
 337     public void onUserStatusChange(User.Status status) {
 338         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 339             // User signed in
 340             getActivity().runOnUiThread(new Runnable() {
 341                 public void run() {
 342                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 343                     authenticatePreference.setTitle(R.string.sign_out);
 344                 }
 345             });
 346 
 347             Simplenote app = (Simplenote) getActivity().getApplication();
 348             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 349             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 350 
 351             AnalyticsTracker.track(
 352                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 353                     AnalyticsTracker.CATEGORY_USER,
 354                     &quot;signed_in_from_preferences_activity&quot;
 355             );
 356         }
 357     }
 358 
 359     @Override
 360     public void onUserCreated(User user) {
 361         AnalyticsTracker.track(
 362                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 363                 AnalyticsTracker.CATEGORY_USER,
 364                 &quot;account_created_from_preferences_activity&quot;
 365         );
 366     }
 367 
 368     private void updateAnalyticsSwitchState() {
 369         try {
 370             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 371             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 372         } catch (BucketObjectMissingException e) {
 373             // The preferences object doesn&#x27;t exist for this user yet, create it
 374             try {
 375                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 376                 prefs.setAnalyticsEnabled(true);
 377                 prefs.save();
 378             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 379                 bucketObjectNameInvalid.printStackTrace();
 380             }
 381         }
 382     }
 383 
 384     private static class SignOutAsyncTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 385         private WeakReference&lt;PreferencesFragment&gt; fragmentWeakReference;
 386 
 387         SignOutAsyncTask(PreferencesFragment fragment) {
 388             fragmentWeakReference = new WeakReference&lt;&gt;(fragment);
 389         }
 390 
 391         @Override
 392         protected Boolean doInBackground(Void... voids) {
 393             PreferencesFragment fragment = fragmentWeakReference.get();
 394             return fragment == null || fragment.hasUnsyncedNotes();
 395         }
 396 
 397         @Override
 398         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 399             PreferencesFragment fragment = fragmentWeakReference.get();
 400             if (fragment == null) {
 401                 return;
 402             }
 403 
 404             // Safety first! Check if any notes are unsynced and warn the user if so.
 405             if (hasUnsyncedNotes) {
<abbr title=" 406                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))"> 406                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 407                         .setTitle(R.string.unsynced_notes)
 408                         .setMessage(R.string.unsynced_notes_message)
 409                         .setPositiveButton(R.string.delete_notes, fragment.signOutClickListener)
 410                         .setNeutralButton(R.string.visit_web_app, fragment.loadWebAppClickListener)
 411                         .setNegativeButton(R.string.cancel, null)
 412                         .show();
 413             } else {
 414                 fragment.signOut();
 415             }
 416         }
 417     }
 418 }
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.DialogInterface;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.net.Uri;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.widget.Toast;
  12 import androidx.appcompat.app.AlertDialog;
  13 import androidx.appcompat.view.ContextThemeWrapper;
  14 import androidx.preference.ListPreference;
  15 import androidx.preference.Preference;
  16 import androidx.preference.PreferenceFragmentCompat;
  17 import androidx.preference.PreferenceManager;
  18 import androidx.preference.SwitchPreferenceCompat;
  19 import com.automattic.simplenote.analytics.AnalyticsTracker;
  20 import com.automattic.simplenote.models.Note;
  21 import com.automattic.simplenote.models.Preferences;
  22 import com.automattic.simplenote.utils.CrashUtils;
  23 import com.automattic.simplenote.utils.HtmlCompat;
  24 import com.automattic.simplenote.utils.PrefUtils;
  25 import com.automattic.simplenote.utils.WidgetUtils;
  26 import com.simperium.Simperium;
  27 import com.simperium.client.Bucket;
  28 import com.simperium.client.BucketObjectMissingException;
  29 import com.simperium.client.BucketObjectNameInvalid;
  30 import com.simperium.client.User;
  31 import java.lang.ref.WeakReference;
  32 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  33 
  34 
  35 /**
  36  * A simple {@link Fragment} subclass.
  37  */
<abbr title="  38 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener , Simperium.OnUserCreatedListener {">  38 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener , ðŸ”µ</abbr>
  39     private static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  40 
  41     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  42 
  43     private SwitchPreferenceCompat mAnalyticsSwitch;
  44 
  45     public PreferencesFragment() {
  46         // Required empty public constructor
  47     }
  48 
  49     @Override
  50     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  51         addPreferencesFromResource(R.xml.preferences);
  52     }
  53 
  54     @Override
  55     public void onActivityCreated(Bundle savedInstanceState) {
  56         super.onActivityCreated(savedInstanceState);
  57         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  58         Simplenote currentApp = ((Simplenote) (getActivity().getApplication()));
  59         Simperium simperium = currentApp.getSimperium();
  60         simperium.setUserStatusChangeListener(this);
  61         simperium.setOnUserCreatedListener(this);
  62         mPreferencesBucket = currentApp.getPreferencesBucket();
  63         mPreferencesBucket.start();
  64         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  65         if (simperium.needsAuthorization()) {
  66             authenticatePreference.setTitle(R.string.sign_in);
  67         } else {
  68             authenticatePreference.setTitle(R.string.sign_out);
  69         }
  70         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
  71             @Override
  72             public boolean onPreferenceClick(Preference preference) {
  73                 if (!isAdded()) {
  74                     return false;
  75                 }
  76                 Simplenote currentApp = ((Simplenote) (getActivity().getApplication()));
  77                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title="  78                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);">  78                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
  79                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
  80                 } else {
  81                     new SignOutAsyncTask(PreferencesFragment.this).execute();
  82                 }
  83                 return true;
  84             }
  85         });
<abbr title="  86         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {">  86         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
  87             @Override
  88             public boolean onPreferenceClick(Preference preference) {
  89                 try {
  90                     startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(&quot;http://simplenote.com&quot;)));
  91                 } catch (java.lang.Exception e) {
<abbr title="  92                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();">  92                     Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show(ðŸ”µ</abbr>
  93                 }
  94                 return true;
  95             }
  96         });
<abbr title="  97         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {">  97         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
  98             @Override
  99             public boolean onPreferenceClick(Preference preference) {
 100                 startActivity(new Intent(getActivity(), AboutActivity.class));
 101                 return true;
 102             }
 103         });
 104         final ListPreference themePreference = ((ListPreference) (findPreference(PrefUtils.PREF_THEME)));
 105         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 106             @Override
 107             public boolean onPreferenceChange(Preference preference, Object newValue) {
 108                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 109                 return true;
 110             }
 111 
 112             private void updateTheme(Activity activity, int index) {
 113                 CharSequence[] entries = themePreference.getEntries();
 114                 themePreference.setSummary(entries[index]);
 115 
 116                 AnalyticsTracker.track(
 117                         AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 118                         AnalyticsTracker.CATEGORY_USER,
 119                         &quot;theme_preference&quot;
 120                 );
 121 
 122                 // recreate the activity so new theme is applied
 123                 activity.recreate();
 124             }
 125         });
<abbr title=" 126         final ListPreference sortPreference = ((ListPreference) (findPreference(PrefUtils.PREF_SORT_ORDER)));"> 126         final ListPreference sortPreference = ((ListPreference) (findPreference(PrefUtils.PREF_SORT_ORDERðŸ”µ</abbr>
 127         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 128             @Override
 129             public boolean onPreferenceChange(Preference preference, Object newValue) {
 130                 int index = Integer.parseInt(newValue.toString());
 131                 CharSequence[] entries = sortPreference.getEntries();
 132                 sortPreference.setSummary(entries[index]);
 133                 return true;
 134             }
 135         });
 136         Preference versionPref = findPreference(&quot;pref_key_build&quot;);
 137         versionPref.setSummary(PrefUtils.versionInfo());
<abbr title=" 138         SwitchPreferenceCompat switchPreference = ((SwitchPreferenceCompat) (findPreference(&quot;pref_key_condensed_note_list&quot;)));"> 138         SwitchPreferenceCompat switchPreference = ((SwitchPreferenceCompat) (findPreference(&quot;pref_key_conðŸ”µ</abbr>
 139         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 140             @Override
 141             public boolean onPreferenceChange(Preference preference, Object o) {
 142                 if (((SwitchPreferenceCompat) (preference)).isChecked()) {
<abbr title=" 143                     AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED, AnalyticsTracker.CATEGORY_USER, &quot;condensed_list_preference&quot;);"> 143                     AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED, AnalytiðŸ”µ</abbr>
 144                 }
 145                 return true;
 146             }
 147         });
 148         // Add the hyperlink to the analytics summary
 149         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
<abbr title=" 150         String formattedSummary = String.format(getString(R.string.share_analytics_summary), &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;, &quot;&lt;/a&gt;&quot;);"> 150         String formattedSummary = String.format(getString(R.string.share_analytics_summary), &quot;&lt;a href=\&quot;hðŸ”µ</abbr>
 151         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 152         mAnalyticsSwitch = ((SwitchPreferenceCompat) (findPreference(&quot;pref_key_analytics_switch&quot;)));
 153         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 154             @Override
 155             public boolean onPreferenceChange(Preference preference, Object newValue) {
 156                 try {
 157                     boolean isChecked = ((boolean) (newValue));
 158                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 159                     prefs.setAnalyticsEnabled(isChecked);
 160                     prefs.save();
 161                 } catch (BucketObjectMissingException e) {
 162                     e.printStackTrace();
 163                 }
 164                 return true;
 165             }
 166         });
 167         updateAnalyticsSwitchState();
 168     }
 169 
 170     @Override
 171     public void onPause() {
 172         super.onPause();
 173         mPreferencesBucket.stop();
 174     }
 175 
<abbr title=" 176     private DialogInterface.OnClickListener signOutClickListener = new DialogInterface.OnClickListener() {"> 176     private DialogInterface.OnClickListener signOutClickListener = new DialogInterface.OnClickListener() ðŸ”µ</abbr>
 177         @Override
 178         public void onClick(DialogInterface dialogInterface, int i) {
 179             signOut();
 180         }
 181     };
 182 
<abbr title=" 183     private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListener() {"> 183     private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListenerðŸ”µ</abbr>
 184         @Override
 185         public void onClick(DialogInterface dialogInterface, int i) {
 186             startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(WEB_APP_URL)));
 187         }
 188     };
 189 
 190     private boolean hasUnsyncedNotes() {
 191         Simplenote application = (Simplenote) getActivity().getApplication();
 192         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 193         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 194         while (notesCursor.moveToNext()) {
 195             Note note = notesCursor.getObject();
 196             if (note.isNew() || note.isModified()) {
 197                 return true;
 198             }
 199         }
 200 
 201         return false;
 202     }
 203 
 204     private void signOut() {
 205         Simplenote application = (Simplenote) getActivity().getApplication();
 206         application.getSimperium().deauthorizeUser();
 207 
 208         application.getNotesBucket().reset();
 209         application.getTagsBucket().reset();
 210         application.getPreferencesBucket().reset();
 211 
 212         application.getNotesBucket().stop();
 213         application.getTagsBucket().stop();
 214         application.getPreferencesBucket().stop();
 215 
 216         AnalyticsTracker.track(
 217                 AnalyticsTracker.Stat.USER_SIGNED_OUT,
 218                 AnalyticsTracker.CATEGORY_USER,
 219                 &quot;preferences_sign_out_button&quot;
 220         );
 221 
 222         // Resets analytics user back to &#x27;anon&#x27; type
 223         AnalyticsTracker.refreshMetadata(null);
 224         CrashUtils.clearCurrentUser();
 225 
 226         // Remove wp.com token
<abbr title=" 227         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();"> 227         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edðŸ”µ</abbr>
 228         editor.remove(PrefUtils.PREF_WP_TOKEN);
 229 
 230         // Remove WordPress sites
 231         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 232         editor.apply();
 233 
 234         WidgetUtils.updateNoteWidgets(getActivity());
 235 
 236         getActivity().finish();
 237     }
 238 
 239     @Override
 240     public void onUserStatusChange(User.Status status) {
 241         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 242             // User signed in
 243             getActivity().runOnUiThread(new Runnable() {
 244                 public void run() {
 245                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 246                     authenticatePreference.setTitle(R.string.sign_out);
 247                 }
 248             });
 249 
 250             Simplenote app = (Simplenote) getActivity().getApplication();
 251             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 252             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 253 
 254             AnalyticsTracker.track(
 255                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 256                     AnalyticsTracker.CATEGORY_USER,
 257                     &quot;signed_in_from_preferences_activity&quot;
 258             );
 259         }
 260     }
 261 
 262     @Override
 263     public void onUserCreated(User user) {
 264         AnalyticsTracker.track(
 265                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 266                 AnalyticsTracker.CATEGORY_USER,
 267                 &quot;account_created_from_preferences_activity&quot;
 268         );
 269     }
 270 
 271     private void updateAnalyticsSwitchState() {
 272         try {
 273             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 274             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 275         } catch (BucketObjectMissingException e) {
 276             // The preferences object doesn&#x27;t exist for this user yet, create it
 277             try {
 278                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 279                 prefs.setAnalyticsEnabled(true);
 280                 prefs.save();
 281             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 282                 bucketObjectNameInvalid.printStackTrace();
 283             }
 284         }
 285     }
 286 
 287     private static class SignOutAsyncTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 288         private WeakReference&lt;PreferencesFragment&gt; fragmentWeakReference;
 289 
 290         SignOutAsyncTask(PreferencesFragment fragment) {
 291             fragmentWeakReference = new WeakReference&lt;&gt;(fragment);
 292         }
 293 
 294         @Override
 295         protected Boolean doInBackground(Void... voids) {
 296             PreferencesFragment fragment = fragmentWeakReference.get();
 297             return fragment == null || fragment.hasUnsyncedNotes();
 298         }
 299 
 300         @Override
 301         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 302             PreferencesFragment fragment = fragmentWeakReference.get();
 303             if (fragment == null) {
 304                 return;
 305             }
 306             // Safety first! Check if any notes are unsynced and warn the user if so.
 307             if (hasUnsyncedNotes) {
<abbr title=" 308                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog)).setTitle(R.string.unsynced_notes).setMessage(R.string.unsynced_notes_message).setPositiveButton(R.string.delete_notes, fragment.signOutClickListener).setNeutralButton(R.string.visit_web_app, fragment.loadWebAppClickListener).setNegativeButton(R.string.cancel, null).show();"> 308                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 309             } else {
 310                 fragment.signOut();
 311             }
 312         }
 313     }
 314 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.Manifest;
   4  import android.app.Activity;
   5  import android.app.Fragment;
   6  import android.content.DialogInterface;
   7  import android.content.Intent;
   8  import android.content.SharedPreferences;
   9  import android.net.Uri;
  10  import android.os.AsyncTask;
  11  import android.os.Bundle;
  12  import android.widget.Toast;
  13  
  14  import androidx.appcompat.app.AlertDialog;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 +import androidx.appcompat.view.ContextThemeWrapper;</span>
  16  import androidx.preference.ListPreference;
  17  import androidx.preference.Preference;
  18  import androidx.preference.PreferenceFragmentCompat;
  19  import androidx.preference.PreferenceManager;
  20  import androidx.preference.SwitchPreferenceCompat;
  21  
  22  import com.automattic.simplenote.analytics.AnalyticsTracker;
  23  import com.automattic.simplenote.models.Note;
  24  import com.automattic.simplenote.models.Preferences;
  25  import com.automattic.simplenote.utils.CrashUtils;
  26  import com.automattic.simplenote.utils.HtmlCompat;
  27  import com.automattic.simplenote.utils.PrefUtils;
  28  import com.automattic.simplenote.utils.ThemeUtils;
  29  import com.automattic.simplenote.utils.WidgetUtils;
  30  import com.karumi.dexter.Dexter;
  31  import com.karumi.dexter.listener.PermissionDeniedResponse;
  32  import com.karumi.dexter.listener.PermissionGrantedResponse;
  33  import com.karumi.dexter.listener.single.BasePermissionListener;
  34  import com.karumi.dexter.listener.single.PermissionListener;
  35  import com.simperium.Simperium;
  36  import com.simperium.client.Bucket;
  37  import com.simperium.client.BucketObjectMissingException;
  38  import com.simperium.client.BucketObjectNameInvalid;
  39  import com.simperium.client.User;
  40  
  41  import java.lang.ref.WeakReference;
  42  
  43  import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  44  
  45  /**
  46   * A simple {@link Fragment} subclass.
  47   */
  48  public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener,
  49          Simperium.OnUserCreatedListener {
  50  
  51      private static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  52  
  53      private Bucket&lt;Preferences&gt; mPreferencesBucket;
  54      private SwitchPreferenceCompat mAnalyticsSwitch;
  55  
  56      public PreferencesFragment() {
  57          // Required empty public constructor
  58      }
  59  
  60      @Override
  61      public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  62          addPreferencesFromResource(R.xml.preferences);
  63      }
  64  
  65      @Override
  66      public void onActivityCreated(Bundle savedInstanceState) {
  67          super.onActivityCreated(savedInstanceState);
  68  
  69          Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  70          Simplenote currentApp = (Simplenote) getActivity().getApplication();
  71          Simperium simperium = currentApp.getSimperium();
  72          simperium.setUserStatusChangeListener(this);
  73          simperium.setOnUserCreatedListener(this);
  74          mPreferencesBucket = currentApp.getPreferencesBucket();
  75          mPreferencesBucket.start();
  76  
  77          authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  78          if (simperium.needsAuthorization()) {
  79              authenticatePreference.setTitle(R.string.sign_in);
  80          } else {
  81              authenticatePreference.setTitle(R.string.sign_out);
  82          }
  83  
  84          authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
  85              @Override
  86              public boolean onPreferenceClick(Preference preference) {
  87                  if (!isAdded()) {
  88                      return false;
  89                  }
  90  
  91                  Simplenote currentApp = (Simplenote) getActivity().getApplication();
  92                  if (currentApp.getSimperium().needsAuthorization()) {
  93                      Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);
  94                      startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
  95                  } else {
  96                      new SignOutAsyncTask(PreferencesFragment.this).execute();
  97                  }
  98                  return true;
  99              }
 100          });
 101  
<abbr title=" 102          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 102          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener()ðŸ”µ</abbr>
 103              @Override
 104              public boolean onPreferenceClick(Preference preference) {
 105                  try {
 106                      startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(&quot;http://simplenote.com&quot;)));
 107                  } catch (Exception e) {
 108                      Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();
 109                  }
 110                  return true;
 111              }
 112          });
 113  
 114          findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 115              @Override
 116              public boolean onPreferenceClick(Preference preference) {
 117                  startActivity(new Intent(getActivity(), AboutActivity.class));
 118                  return true;
 119              }
 120          });
 121  
 122          final ListPreference themePreference = (ListPreference) findPreference(PrefUtils.PREF_THEME);
 123          themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 124  
 125              @Override
 126              public boolean onPreferenceChange(Preference preference, Object newValue) {
 127  
 128                  final Activity activity = getActivity();
 129                  final int index = Integer.parseInt(newValue.toString());
 130                  if (index == ThemeUtils.THEME_AUTO) {
 131  
 132                      PermissionListener permissionListener = new BasePermissionListener() {
 133                          @Override
 134                          public void onPermissionGranted(PermissionGrantedResponse response) {
 135                              updateTheme(activity, index);
 136                          }
 137                          @Override
 138                          public void onPermissionDenied(PermissionDeniedResponse response) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -                            new AlertDialog.Builder(activity)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +                            new AlertDialog.Builder(new ContextThemeWrapper(activity, R.style.Dialog))</span>
 141                                      .setTitle(R.string.location_permission_denied)
 142                                      .setMessage(R.string.location_permission_explanation)
<abbr title=" 143                                      .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {"> 143                                      .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() ðŸ”µ</abbr>
 144                                          @Override public void onClick(DialogInterface dialog, int which) {
 145                                              dialog.dismiss();
 146                                          }
 147                                      })
 148                                      .show();
 149                          }
 150                      };
 151                      Dexter.withActivity(activity)
 152                              .withPermission(Manifest.permission.ACCESS_COARSE_LOCATION)
 153                              .withListener(permissionListener)
 154                              .check();
 155                      updateTheme(activity, index);
 156                  } else {
 157                      updateTheme(activity, index);
 158                  }
 159  

 160                  return true;
 161              }
 162  
 163              private void updateTheme(Activity activity, int index) {
 164                  CharSequence[] entries = themePreference.getEntries();
 165                  themePreference.setSummary(entries[index]);
 166  
 167                  AnalyticsTracker.track(
 168                          AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 169                          AnalyticsTracker.CATEGORY_USER,
 170                          &quot;theme_preference&quot;
 171                  );
 172  
 173                  // recreate the activity so new theme is applied
 174                  activity.recreate();
 175              }
 176          });
 177  
 178          final ListPreference sortPreference = (ListPreference) findPreference(PrefUtils.PREF_SORT_ORDER);
 179          sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 180  
 181              @Override
 182              public boolean onPreferenceChange(Preference preference, Object newValue) {
 183                  int index = Integer.parseInt(newValue.toString());
 184                  CharSequence[] entries = sortPreference.getEntries();
 185                  sortPreference.setSummary(entries[index]);
 186  
 187                  return true;
 188              }
 189          });
 190  
 191          Preference versionPref = findPreference(&quot;pref_key_build&quot;);
 192          versionPref.setSummary(PrefUtils.versionInfo());
 193  
<abbr title=" 194          SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_note_list&quot;);"> 194          SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_noteðŸ”µ</abbr>
 195          switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 196              @Override
 197              public boolean onPreferenceChange(Preference preference, Object o) {
 198                  if (((SwitchPreferenceCompat) preference).isChecked()) {
 199                      AnalyticsTracker.track(
 200                              AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 201                              AnalyticsTracker.CATEGORY_USER,
 202                              &quot;condensed_list_preference&quot;
 203                      );
 204                  }
 205  
 206                  return true;
 207              }
 208          });
 209  
 210          // Add the hyperlink to the analytics summary
 211          Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 212          String formattedSummary = String.format(
 213                  getString(R.string.share_analytics_summary),
 214                  &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 215                  &quot;&lt;/a&gt;&quot;
 216          );
 217          analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 218  
 219          mAnalyticsSwitch = (SwitchPreferenceCompat)findPreference(&quot;pref_key_analytics_switch&quot;);
 220          mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 221              @Override
 222              public boolean onPreferenceChange(Preference preference, Object newValue) {
 223                  try {
 224                      boolean isChecked = (boolean)newValue;
 225                      Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 226                      prefs.setAnalyticsEnabled(isChecked);
 227                      prefs.save();
 228                  } catch (BucketObjectMissingException e) {
 229                      e.printStackTrace();
 230                  }
 231  
 232                  return true;
 233              }
 234          });
 235  
 236          updateAnalyticsSwitchState();
 237      }
 238  
 239      @Override
 240      public void onPause() {
 241          super.onPause();
 242          mPreferencesBucket.stop();
 243      }
 244  
 245      private DialogInterface.OnClickListener signOutClickListener = new DialogInterface.OnClickListener() {
 246          @Override
 247          public void onClick(DialogInterface dialogInterface, int i) {
 248              signOut();
 249          }
 250      };
 251  
 252      private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListener() {
 253          @Override
 254          public void onClick(DialogInterface dialogInterface, int i) {
 255              startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(WEB_APP_URL)));
 256          }
 257      };
 258  
 259      private boolean hasUnsyncedNotes() {
 260          Simplenote application = (Simplenote) getActivity().getApplication();
 261          Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 262          Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 263          while (notesCursor.moveToNext()) {
 264              Note note = notesCursor.getObject();
 265              if (note.isNew() || note.isModified()) {
 266                  return true;
 267              }
 268          }
 269  
 270          return false;
 271      }
 272  
 273      private void signOut() {
 274          Simplenote application = (Simplenote) getActivity().getApplication();
 275          application.getSimperium().deauthorizeUser();
 276  
 277          application.getNotesBucket().reset();
 278          application.getTagsBucket().reset();
 279          application.getPreferencesBucket().reset();
 280  
 281          application.getNotesBucket().stop();
 282          application.getTagsBucket().stop();
 283          application.getPreferencesBucket().stop();
 284  
 285          AnalyticsTracker.track(
 286                  AnalyticsTracker.Stat.USER_SIGNED_OUT,
 287                  AnalyticsTracker.CATEGORY_USER,
 288                  &quot;preferences_sign_out_button&quot;
 289          );
 290  
 291          // Resets analytics user back to &#x27;anon&#x27; type
 292          AnalyticsTracker.refreshMetadata(null);
 293          CrashUtils.clearCurrentUser();
 294  
 295          // Remove wp.com token
 296          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();
 297          editor.remove(PrefUtils.PREF_WP_TOKEN);
 298  
 299          // Remove WordPress sites
 300          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 301          editor.apply();
 302  
 303          WidgetUtils.updateNoteWidgets(getActivity());
 304  
 305          getActivity().finish();
 306      }
 307  
 308      @Override
 309      public void onUserStatusChange(User.Status status) {
 310          if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 311              // User signed in
 312              getActivity().runOnUiThread(new Runnable() {
 313                  public void run() {
 314                      Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 315                      authenticatePreference.setTitle(R.string.sign_out);
 316                  }
 317              });
 318  
 319              Simplenote app = (Simplenote) getActivity().getApplication();
 320              AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 321              CrashUtils.setCurrentUser(app.getSimperium().getUser());
 322  
 323              AnalyticsTracker.track(
 324                      AnalyticsTracker.Stat.USER_SIGNED_IN,
 325                      AnalyticsTracker.CATEGORY_USER,
 326                      &quot;signed_in_from_preferences_activity&quot;
 327              );
 328          }
 329      }
 330  
 331      @Override
 332      public void onUserCreated(User user) {
 333          AnalyticsTracker.track(
 334                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 335                  AnalyticsTracker.CATEGORY_USER,
 336                  &quot;account_created_from_preferences_activity&quot;
 337          );
 338      }
 339  
 340      private void updateAnalyticsSwitchState() {
 341          try {
 342              Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 343              mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 344          } catch (BucketObjectMissingException e) {
 345              // The preferences object doesn&#x27;t exist for this user yet, create it
 346              try {
 347                  Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 348                  prefs.setAnalyticsEnabled(true);
 349                  prefs.save();
 350              } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 351                  bucketObjectNameInvalid.printStackTrace();
 352              }
 353          }
 354      }
 355  
 356      private static class SignOutAsyncTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 357          private WeakReference&lt;PreferencesFragment&gt; fragmentWeakReference;
 358  
 359          SignOutAsyncTask(PreferencesFragment fragment) {
 360              fragmentWeakReference = new WeakReference&lt;&gt;(fragment);
 361          }
 362  
 363          @Override
 364          protected Boolean doInBackground(Void... voids) {
 365              PreferencesFragment fragment = fragmentWeakReference.get();
 366              return fragment == null || fragment.hasUnsyncedNotes();
 367          }
 368  
 369          @Override
 370          protected void onPostExecute(Boolean hasUnsyncedNotes) {
 371              PreferencesFragment fragment = fragmentWeakReference.get();
 372              if (fragment == null) {
 373                  return;
 374              }
 375  
 376              // Safety first! Check if any notes are unsynced and warn the user if so.
 377              if (hasUnsyncedNotes) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 378 -                new AlertDialog.Builder(fragment.getContext())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +                new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))</span>
 380                          .setTitle(R.string.unsynced_notes)
 381                          .setMessage(R.string.unsynced_notes_message)
 382                          .setPositiveButton(R.string.delete_notes, fragment.signOutClickListener)
 383                          .setNeutralButton(R.string.visit_web_app, fragment.loadWebAppClickListener)
 384                          .setNegativeButton(R.string.cancel, null)
 385                          .show();
 386              } else {
 387                  fragment.signOut();
 388              }
 389          }
 390      }
 391  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 -import android.Manifest;</span>
   4  import android.app.Activity;
   5  import android.app.Fragment;
   6  import android.content.DialogInterface;
   7  import android.content.Intent;
   8  import android.content.SharedPreferences;
   9  import android.net.Uri;
  10  import android.os.AsyncTask;
  11  import android.os.Bundle;
  12  import android.widget.Toast;
  13  
  14  import androidx.appcompat.app.AlertDialog;

  15  import androidx.preference.ListPreference;
  16  import androidx.preference.Preference;
  17  import androidx.preference.PreferenceFragmentCompat;
  18  import androidx.preference.PreferenceManager;
  19  import androidx.preference.SwitchPreferenceCompat;
  20  
  21  import com.automattic.simplenote.analytics.AnalyticsTracker;
  22  import com.automattic.simplenote.models.Note;
  23  import com.automattic.simplenote.models.Preferences;
  24  import com.automattic.simplenote.utils.CrashUtils;
  25  import com.automattic.simplenote.utils.HtmlCompat;
  26  import com.automattic.simplenote.utils.PrefUtils;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import com.automattic.simplenote.utils.ThemeUtils;</span>
  28  import com.automattic.simplenote.utils.WidgetUtils;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import com.karumi.dexter.Dexter;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import com.karumi.dexter.listener.PermissionDeniedResponse;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import com.karumi.dexter.listener.PermissionGrantedResponse;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import com.karumi.dexter.listener.single.BasePermissionListener;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import com.karumi.dexter.listener.single.PermissionListener;</span>
  34  import com.simperium.Simperium;
  35  import com.simperium.client.Bucket;
  36  import com.simperium.client.BucketObjectMissingException;
  37  import com.simperium.client.BucketObjectNameInvalid;
  38  import com.simperium.client.User;
  39  
  40  import java.lang.ref.WeakReference;
  41  
  42  import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  43  
  44  /**
  45   * A simple {@link Fragment} subclass.
  46   */
  47  public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener,
  48          Simperium.OnUserCreatedListener {
  49  
  50      private static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  51  
  52      private Bucket&lt;Preferences&gt; mPreferencesBucket;
  53      private SwitchPreferenceCompat mAnalyticsSwitch;
  54  
  55      public PreferencesFragment() {
  56          // Required empty public constructor
  57      }
  58  
  59      @Override
  60      public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  61          addPreferencesFromResource(R.xml.preferences);
  62      }
  63  
  64      @Override
  65      public void onActivityCreated(Bundle savedInstanceState) {
  66          super.onActivityCreated(savedInstanceState);
  67  
  68          Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  69          Simplenote currentApp = (Simplenote) getActivity().getApplication();
  70          Simperium simperium = currentApp.getSimperium();
  71          simperium.setUserStatusChangeListener(this);
  72          simperium.setOnUserCreatedListener(this);
  73          mPreferencesBucket = currentApp.getPreferencesBucket();
  74          mPreferencesBucket.start();
  75  
  76          authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  77          if (simperium.needsAuthorization()) {
  78              authenticatePreference.setTitle(R.string.sign_in);
  79          } else {
  80              authenticatePreference.setTitle(R.string.sign_out);
  81          }
  82  
  83          authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
  84              @Override
  85              public boolean onPreferenceClick(Preference preference) {
  86                  if (!isAdded()) {
  87                      return false;
  88                  }
  89  
  90                  Simplenote currentApp = (Simplenote) getActivity().getApplication();
  91                  if (currentApp.getSimperium().needsAuthorization()) {
  92                      Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);
  93                      startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
  94                  } else {
  95                      new SignOutAsyncTask(PreferencesFragment.this).execute();
  96                  }
  97                  return true;
  98              }
  99          });
 100  
<abbr title=" 101          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 101          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener()ðŸ”µ</abbr>
 102              @Override
 103              public boolean onPreferenceClick(Preference preference) {
 104                  try {
 105                      startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(&quot;http://simplenote.com&quot;)));
 106                  } catch (Exception e) {
 107                      Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();
 108                  }
 109                  return true;
 110              }
 111          });
 112  
 113          findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 114              @Override
 115              public boolean onPreferenceClick(Preference preference) {
 116                  startActivity(new Intent(getActivity(), AboutActivity.class));
 117                  return true;
 118              }
 119          });
 120  
 121          final ListPreference themePreference = (ListPreference) findPreference(PrefUtils.PREF_THEME);
 122          themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -</span>
 124              @Override
 125              public boolean onPreferenceChange(Preference preference, Object newValue) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -                final Activity activity = getActivity();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -                final int index = Integer.parseInt(newValue.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -                if (index == ThemeUtils.THEME_AUTO) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -                    PermissionListener permissionListener = new BasePermissionListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -                        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -                        public void onPermissionGranted(PermissionGrantedResponse response) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -                            updateTheme(activity, index);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -                        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -                        public void onPermissionDenied(PermissionDeniedResponse response) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -                            new AlertDialog.Builder(activity)</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -                                    .setTitle(R.string.location_permission_denied)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -                                    .setMessage(R.string.location_permission_explanation)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 141 -                                    .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {"> 141 -                                    .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -                                        @Override public void onClick(DialogInterface dialog, int which) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -                                            dialog.dismiss();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -                                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -                                    })</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -                                    .show();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -                    };</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -                    Dexter.withActivity(activity)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -                            .withPermission(Manifest.permission.ACCESS_COARSE_LOCATION)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -                            .withListener(permissionListener)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -                            .check();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -                    updateTheme(activity, index);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -                    updateTheme(activity, index);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +                updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));</span>
 159                  return true;
 160              }
 161  
 162              private void updateTheme(Activity activity, int index) {
 163                  CharSequence[] entries = themePreference.getEntries();
 164                  themePreference.setSummary(entries[index]);
 165  
 166                  AnalyticsTracker.track(
 167                          AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 168                          AnalyticsTracker.CATEGORY_USER,
 169                          &quot;theme_preference&quot;
 170                  );
 171  
 172                  // recreate the activity so new theme is applied
 173                  activity.recreate();
 174              }
 175          });
 176  
 177          final ListPreference sortPreference = (ListPreference) findPreference(PrefUtils.PREF_SORT_ORDER);
 178          sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -</span>
 180              @Override
 181              public boolean onPreferenceChange(Preference preference, Object newValue) {
 182                  int index = Integer.parseInt(newValue.toString());
 183                  CharSequence[] entries = sortPreference.getEntries();
 184                  sortPreference.setSummary(entries[index]);
 185  
 186                  return true;
 187              }
 188          });
 189  
 190          Preference versionPref = findPreference(&quot;pref_key_build&quot;);
 191          versionPref.setSummary(PrefUtils.versionInfo());
 192  
<abbr title=" 193          SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_note_list&quot;);"> 193          SwitchPreferenceCompat switchPreference = (SwitchPreferenceCompat) findPreference(&quot;pref_key_condensed_noteðŸ”µ</abbr>
 194          switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 195              @Override
 196              public boolean onPreferenceChange(Preference preference, Object o) {
 197                  if (((SwitchPreferenceCompat) preference).isChecked()) {
 198                      AnalyticsTracker.track(
 199                              AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 200                              AnalyticsTracker.CATEGORY_USER,
 201                              &quot;condensed_list_preference&quot;
 202                      );
 203                  }
 204  
 205                  return true;
 206              }
 207          });
 208  
 209          // Add the hyperlink to the analytics summary
 210          Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 211          String formattedSummary = String.format(
 212                  getString(R.string.share_analytics_summary),
 213                  &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 214                  &quot;&lt;/a&gt;&quot;
 215          );
 216          analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 217  
 218          mAnalyticsSwitch = (SwitchPreferenceCompat)findPreference(&quot;pref_key_analytics_switch&quot;);
 219          mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 220              @Override
 221              public boolean onPreferenceChange(Preference preference, Object newValue) {
 222                  try {
 223                      boolean isChecked = (boolean)newValue;
 224                      Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 225                      prefs.setAnalyticsEnabled(isChecked);
 226                      prefs.save();
 227                  } catch (BucketObjectMissingException e) {
 228                      e.printStackTrace();
 229                  }
 230  
 231                  return true;
 232              }
 233          });
 234  
 235          updateAnalyticsSwitchState();
 236      }
 237  
 238      @Override
 239      public void onPause() {
 240          super.onPause();
 241          mPreferencesBucket.stop();
 242      }
 243  
 244      private DialogInterface.OnClickListener signOutClickListener = new DialogInterface.OnClickListener() {
 245          @Override
 246          public void onClick(DialogInterface dialogInterface, int i) {
 247              signOut();
 248          }
 249      };
 250  
 251      private DialogInterface.OnClickListener loadWebAppClickListener = new DialogInterface.OnClickListener() {
 252          @Override
 253          public void onClick(DialogInterface dialogInterface, int i) {
 254              startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(WEB_APP_URL)));
 255          }
 256      };
 257  
 258      private boolean hasUnsyncedNotes() {
 259          Simplenote application = (Simplenote) getActivity().getApplication();
 260          Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 261          Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 262          while (notesCursor.moveToNext()) {
 263              Note note = notesCursor.getObject();
 264              if (note.isNew() || note.isModified()) {
 265                  return true;
 266              }
 267          }
 268  
 269          return false;
 270      }
 271  
 272      private void signOut() {
 273          Simplenote application = (Simplenote) getActivity().getApplication();
 274          application.getSimperium().deauthorizeUser();
 275  
 276          application.getNotesBucket().reset();
 277          application.getTagsBucket().reset();
 278          application.getPreferencesBucket().reset();
 279  
 280          application.getNotesBucket().stop();
 281          application.getTagsBucket().stop();
 282          application.getPreferencesBucket().stop();
 283  
 284          AnalyticsTracker.track(
 285                  AnalyticsTracker.Stat.USER_SIGNED_OUT,
 286                  AnalyticsTracker.CATEGORY_USER,
 287                  &quot;preferences_sign_out_button&quot;
 288          );
 289  
 290          // Resets analytics user back to &#x27;anon&#x27; type
 291          AnalyticsTracker.refreshMetadata(null);
 292          CrashUtils.clearCurrentUser();
 293  
 294          // Remove wp.com token
 295          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(getActivity()).edit();
 296          editor.remove(PrefUtils.PREF_WP_TOKEN);
 297  
 298          // Remove WordPress sites
 299          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 300          editor.apply();
 301  
 302          WidgetUtils.updateNoteWidgets(getActivity());
 303  
 304          getActivity().finish();
 305      }
 306  
 307      @Override
 308      public void onUserStatusChange(User.Status status) {
 309          if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 310              // User signed in
 311              getActivity().runOnUiThread(new Runnable() {
 312                  public void run() {
 313                      Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 314                      authenticatePreference.setTitle(R.string.sign_out);
 315                  }
 316              });
 317  
 318              Simplenote app = (Simplenote) getActivity().getApplication();
 319              AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 320              CrashUtils.setCurrentUser(app.getSimperium().getUser());
 321  
 322              AnalyticsTracker.track(
 323                      AnalyticsTracker.Stat.USER_SIGNED_IN,
 324                      AnalyticsTracker.CATEGORY_USER,
 325                      &quot;signed_in_from_preferences_activity&quot;
 326              );
 327          }
 328      }
 329  
 330      @Override
 331      public void onUserCreated(User user) {
 332          AnalyticsTracker.track(
 333                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 334                  AnalyticsTracker.CATEGORY_USER,
 335                  &quot;account_created_from_preferences_activity&quot;
 336          );
 337      }
 338  
 339      private void updateAnalyticsSwitchState() {
 340          try {
 341              Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 342              mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 343          } catch (BucketObjectMissingException e) {
 344              // The preferences object doesn&#x27;t exist for this user yet, create it
 345              try {
 346                  Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 347                  prefs.setAnalyticsEnabled(true);
 348                  prefs.save();
 349              } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 350                  bucketObjectNameInvalid.printStackTrace();
 351              }
 352          }
 353      }
 354  
 355      private static class SignOutAsyncTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 356          private WeakReference&lt;PreferencesFragment&gt; fragmentWeakReference;
 357  
 358          SignOutAsyncTask(PreferencesFragment fragment) {
 359              fragmentWeakReference = new WeakReference&lt;&gt;(fragment);
 360          }
 361  
 362          @Override
 363          protected Boolean doInBackground(Void... voids) {
 364              PreferencesFragment fragment = fragmentWeakReference.get();
 365              return fragment == null || fragment.hasUnsyncedNotes();
 366          }
 367  
 368          @Override
 369          protected void onPostExecute(Boolean hasUnsyncedNotes) {
 370              PreferencesFragment fragment = fragmentWeakReference.get();
 371              if (fragment == null) {
 372                  return;
 373              }
 374  
 375              // Safety first! Check if any notes are unsynced and warn the user if so.
 376              if (hasUnsyncedNotes) {
 377                  new AlertDialog.Builder(fragment.getContext())

 378                          .setTitle(R.string.unsynced_notes)
 379                          .setMessage(R.string.unsynced_notes_message)
 380                          .setPositiveButton(R.string.delete_notes, fragment.signOutClickListener)
 381                          .setNeutralButton(R.string.visit_web_app, fragment.loadWebAppClickListener)
 382                          .setNegativeButton(R.string.cancel, null)
 383                          .show();
 384              } else {
 385                  fragment.signOut();
 386              }
 387          }
 388      }
 389  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            