<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>279</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    279
                    <a href="278.html">prev</a>
                    <a href="280.html">next</a>
                    <a href="279_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_289d73798436413d6717ebe27ac4225c1b72220a_Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;289d73798436413d6717ebe27ac4225c1b72220a:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;289d73798436413d6717ebe27ac4225c1b72220a^1:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;289d73798436413d6717ebe27ac4225c1b72220a^2:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;e8c0cc6eb145965734732c7ccbf4c00c49ed6e23:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj], [bj]], subset: [[sbj], [bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.AlertDialog;
   5 import android.app.FragmentManager;
   6 import android.app.FragmentTransaction;
   7 import android.content.DialogInterface;
   8 import android.content.Intent;
   9 import android.content.SharedPreferences;
  10 import android.content.res.Configuration;
  11 import android.os.AsyncTask;
  12 import android.os.Build;
  13 import android.os.Bundle;
  14 import android.os.Parcelable;
  15 import android.preference.PreferenceManager;
  16 import android.support.v4.view.MenuItemCompat;
  17 import android.support.v7.app.ActionBarDrawerToggle;
  18 import android.support.v4.widget.DrawerLayout;
  19 import android.support.v7.app.ActionBar;
  20 import android.support.v7.app.ActionBarActivity;
  21 import android.support.v7.widget.Toolbar;
  22 import android.text.Spannable;
  23 import android.text.SpannableString;
  24 import android.text.TextUtils;
  25 import android.view.Gravity;
  26 import android.view.Menu;
  27 import android.view.MenuInflater;
  28 import android.view.MenuItem;
  29 import android.view.View;
  30 import android.view.Window;
  31 import android.widget.AdapterView;
  32 import android.widget.ListView;
  33 import android.support.v7.widget.SearchView;
  34 
  35 import com.automattic.simplenote.models.Note;
  36 import com.automattic.simplenote.models.Tag;
  37 import com.automattic.simplenote.utils.PrefUtils;
  38 import com.automattic.simplenote.utils.TagsAdapter;
  39 import com.automattic.simplenote.utils.ThemeUtils;
  40 import com.automattic.simplenote.widgets.FloatingActionButton;
  41 import com.automattic.simplenote.widgets.TypefaceSpan;
  42 import com.automattic.simplenote.utils.UndoBarController;
  43 import com.google.android.gms.analytics.HitBuilders;
  44 import com.google.android.gms.analytics.Tracker;
  45 import com.simperium.Simperium;
  46 import com.simperium.android.LoginActivity;
  47 import com.simperium.client.Bucket;
  48 import com.simperium.client.BucketObjectMissingException;
  49 import com.simperium.client.BucketObjectNameInvalid;
  50 import com.simperium.client.Query;
  51 import com.simperium.client.User;
  52 
  53 import java.util.ArrayList;
  54 import java.util.Calendar;
  55 import java.util.List;
  56 
  57 public class NotesActivity extends ActionBarActivity implements
<abbr title="  58         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  58         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  59         Bucket.Listener&lt;Note&gt; {
  60 
  61     private boolean mIsLargeScreen, mIsLandscape, mShouldSelectNewNote;
  62     private String mTabletSearchQuery;
  63     private UndoBarController mUndoBarController;
  64     private SearchView mSearchView;
  65     private MenuItem mSearchMenuItem;
  66     private NoteListFragment mNoteListFragment;
  67     private NoteEditorFragment mNoteEditorFragment;
  68     private Note mCurrentNote;
  69     protected Bucket&lt;Note&gt; mNotesBucket;
  70     protected Bucket&lt;Tag&gt; mTagsBucket;
  71     private int TRASH_SELECTED_ID = 1;
  72     private ActionBar mActionBar;
  73     private MenuItem mEmptyTrashMenuItem;
  74 
  75     // Menu drawer
  76     private DrawerLayout mDrawerLayout;
  77     private ListView mDrawerList;
  78     private ActionBarDrawerToggle mDrawerToggle;
  79     private TagsAdapter mTagsAdapter;
  80     private TagsAdapter.TagMenuItem mSelectedTag;
  81     private CharSequence mActionBarTitle;
  82 
  83     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  84     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  85 
  86     // Google Analytics tracker
  87     private Tracker mTracker;
  88 
  89     @Override
  90     protected void onCreate(Bundle savedInstanceState) {
  91         supportRequestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);
  92 
  93         ThemeUtils.setTheme(this);
  94 
  95         super.onCreate(savedInstanceState);
  96         Simplenote currentApp = (Simplenote) getApplication();
  97 
  98         if (mNotesBucket == null)
  99             mNotesBucket = currentApp.getNotesBucket();
 100 
 101         if (mTagsBucket == null)
 102             mTagsBucket = currentApp.getTagsBucket();
 103 
 104         setContentView(R.layout.activity_notes);
 105 
 106 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107         Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108         setSupportActionBar(toolbar);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110         EasyTracker.getInstance().activityStart(this);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111         mTracker = EasyTracker.getTracker();</span>
 112 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         EasyTracker.getInstance().activityStart(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         mTracker = EasyTracker.getTracker();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116         if (savedInstanceState == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117             mNoteListFragment = new NoteListFragment();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118             FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119             fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120             fragmentTransaction.commit();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122             mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);</span>
 123 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124         mTracker = currentApp.getTracker();</span>
 125 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 126 
 127         if (savedInstanceState == null) {
 128             mNoteListFragment = new NoteListFragment();
 129             FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
 130             fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
 131             fragmentTransaction.commit();
 132         } else {
 133             mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 134         }
 135 
 136         Configuration config = getBaseContext().getResources().getConfiguration();
 137         if ((config.screenLayout
 138                 &amp; Configuration.SCREENLAYOUT_SIZE_MASK)
 139                 &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {
 140             mIsLargeScreen = true;
 141 
 142             if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 143                 mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 143                 mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTðŸ”µ</abbr>
 144             } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 145                 mIsLandscape = true;
 146                 addEditorFragment();
 147             }
 148         }
 149 
 150         // Set up the menu drawer
 151         mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);
 152         mDrawerList = (ListView) findViewById(R.id.left_drawer);
 153         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 154         mDrawerList.setAdapter(mTagsAdapter);
 155         // Set the list&#x27;s click listener
 156         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 157 
 158         if (mSelectedTag == null)
 159             mSelectedTag = mTagsAdapter.getDefaultItem();
 160 
 161         mDrawerToggle = new ActionBarDrawerToggle(
 162                 this,  mDrawerLayout, toolbar,
 163                 R.string.open_drawer, R.string.close_drawer
 164         ) {
 165             public void onDrawerClosed(View view) {
 166                 setTitle(mActionBarTitle);
 167                 invalidateOptionsMenu();
 168             }
 169 
 170             public void onDrawerOpened(View drawerView) {
 171                 setTitleWithCustomFont(getString(R.string.app_name));
 172                 invalidateOptionsMenu();
 173             }
 174         };
 175         mDrawerLayout.setDrawerListener(mDrawerToggle);
 176 
 177         // enable ActionBar app icon to behave as action to toggle nav drawer
 178         mActionBar = getSupportActionBar();
 179         mActionBar.setDisplayHomeAsUpEnabled(true);
 180         mActionBar.setHomeButtonEnabled(true);
 181 
 182         mDrawerLayout.setDrawerListener(mDrawerToggle);
 183 
 184         mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);
 185 
 186         FloatingActionButton fabButton = new FloatingActionButton.Builder(this)
 187                 .withDrawable(getResources().getDrawable(R.drawable.ic_create_white))
 188                 .withButtonColor(getResources().getColor(R.color.simplenote_blue))
 189                 .withGravity(Gravity.BOTTOM | Gravity.RIGHT)
 190                 .withMargins(0, 0, 16, 16)
 191                 .create();
 192 
 193         fabButton.setOnClickListener(new View.OnClickListener() {
 194             @Override
 195             public void onClick(View v) {
 196                 if (getNoteListFragment() != null) {
 197                     getNoteListFragment().addNote();
 198                     mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;action_bar_button&quot;, null);
 199                 }
 200             }
 201         });
 202 
 203         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 204             // Create the welcome note
 205             try {
 206                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 207                 welcomeNote.setCreationDate(Calendar.getInstance());
 208                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 209                 welcomeNote.setContent(getString(R.string.welcome_note));
 210                 welcomeNote.getTitle();
 211                 welcomeNote.save();
 212             } catch (BucketObjectNameInvalid e) {
 213                 // this won&#x27;t happen because welcome-android is a valid name
 214             }
 215 
 216             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 217             SharedPreferences.Editor editor = preferences.edit();
 218             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 219             editor.commit();
 220         }
 221 
 222         if (Intent.ACTION_SEND.equals(getIntent().getAction())) {
 223             // Check share action
 224             Intent intent = getIntent();
 225             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 226             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 227             if (text != null &amp;&amp; !text.equals(&quot;&quot;)) {
 228                 if (subject != null &amp;&amp; !subject.equals(&quot;&quot;)) {
 229                     text = subject + &quot;\n\n&quot; + text;
 230                 }
 231                 Note note = mNotesBucket.newObject();
 232                 note.setCreationDate(Calendar.getInstance());
 233                 note.setModificationDate(note.getCreationDate());
 234                 note.setContent(text);
 235                 note.save();
 236                 setCurrentNote(note);
 237                 mShouldSelectNewNote = true;
 238                 mTracker.send(
 239                         new HitBuilders.EventBuilder()
 240                                 .setCategory(&quot;note&quot;)
 241                                 .setAction(&quot;create_note&quot;)
 242                                 .setLabel(&quot;external_share&quot;)
 243                                 .build()
 244                 );
 245             }
 246         }
 247         currentApp.getSimperium().setOnUserCreatedListener(this);
 248         currentApp.getSimperium().setUserStatusChangeListener(this);
 249         setProgressBarIndeterminateVisibility(false);
 250     }
 251 
 252     @Override
 253     protected void onResume() {
 254         super.onResume();
 255 
 256         // Ensure user has valid authorization
 257         if (userAuthenticationIsInvalid())
 258             startLoginActivity(true);
 259 
 260         mNotesBucket.start();
 261         mTagsBucket.start();
 262 
 263         mNotesBucket.addOnNetworkChangeListener(this);
 264         mNotesBucket.addOnSaveObjectListener(this);
 265         mNotesBucket.addOnDeleteObjectListener(this);
 266         mTagsBucket.addListener(mTagsMenuUpdater);
 267 
 268         updateNavigationDrawerItems();
 269 
 270         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 271         Simplenote currentApp = (Simplenote)getApplication();
 272         if (currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED) {
 273             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 274                 mSelectedTag = null;
 275                 mDrawerList.setSelection(mTagsAdapter.DEFAULT_ITEM_POSITION);
 276             }
 277         }
 278 
 279         setSelectedTagActive();
 280 
 281         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 282             onNoteSelected(mCurrentNote.getSimperiumKey(), true, null);
 283             mShouldSelectNewNote = false;
 284         }
 285     }
 286 
 287     @Override
 288     protected void onPause() {
 289         super.onPause();
 290 
 291         mTagsBucket.removeListener(mTagsMenuUpdater);
 292 
 293         mNotesBucket.removeOnNetworkChangeListener(this);
 294         mNotesBucket.removeOnSaveObjectListener(this);
 295         mNotesBucket.removeOnDeleteObjectListener(this);
 296     }
 297 
 298     @Override
 299     public void setTitle(CharSequence title) {
 300         mActionBarTitle = (title != null) ? title : &quot;&quot;;
 301         setTitleWithCustomFont(mActionBarTitle);
 302     }
 303 
 304     private void setTitleWithCustomFont(CharSequence title) {
 305         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 306         if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 307                 &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 308             mActionBar.setTitle(title);
 309             return;
 310         }
 311 
 312         SpannableString s = new SpannableString(title);
 313         s.setSpan(new TypefaceSpan(this), 0, s.length(),
 314                 Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 315         mActionBar.setTitle(s);
 316     }
 317 
 318     private void updateNavigationDrawerItems() {
 319         Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 320         mTagsAdapter.changeCursor(tagCursor);
 321     }
 322 
 323     private void setSelectedTagActive() {
 324         if (mSelectedTag == null)
 325             mSelectedTag = mTagsAdapter.getDefaultItem();
 326 
 327         setTitle(mSelectedTag.name);
 328         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag), true);
 329     }
 330 
 331     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 332     public void updateTrashMenuItem() {
 333         if (mEmptyTrashMenuItem == null)
 334             return;
 335         // Disable the trash icon if there are no notes trashed.
 336         Simplenote application = (Simplenote) getApplication();
 337         Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 338         Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 339         if (query.count() == 0) {
 340             mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash_disabled);
 341             mEmptyTrashMenuItem.setEnabled(false);
 342         } else {
 343             mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash);
 344             mEmptyTrashMenuItem.setEnabled(true);
 345         }
 346     }
 347 
 348     /* The click listener for ListView in the navigation drawer */
 349     private class DrawerItemClickListener implements ListView.OnItemClickListener {
 350         @Override
 351         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 352 
 353             mSelectedTag = mTagsAdapter.getItem(position);
 354             checkEmptyListText(false);
 355             // Update checked item in navigation drawer and close it
 356             setSelectedTagActive();
 357             mDrawerLayout.closeDrawer(mDrawerList);
 358 
 359             // Disable long press on notes if we&#x27;re viewing the trash
 360             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 361                 getNoteListFragment().getListView().setLongClickable(false);
 362             } else {
 363                 getNoteListFragment().getListView().setLongClickable(true);
 364             }
 365 
 366             getNoteListFragment().refreshListFromNavSelect();
 367             if (position &gt; 1) {
 368                 mTracker.send(
 369                         new HitBuilders.EventBuilder()
 370                                 .setCategory(&quot;tag&quot;)
 371                                 .setAction(&quot;viewed_notes_for_tag&quot;)
 372                                 .setLabel(&quot;selected_tag_in_navigation_drawer&quot;)
 373                                 .build()
 374                 );
 375             }
 376         }
 377     }
 378 
 379     public TagsAdapter.TagMenuItem getSelectedTag() {
 380         return mSelectedTag;
 381     }
 382 
 383     private void addEditorFragment() {
 384         FragmentManager fm = getFragmentManager();
 385         FragmentTransaction ft = fm.beginTransaction();
 386         mNoteEditorFragment = new NoteEditorFragment();
 387         ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 388         ft.commitAllowingStateLoss();
 389         fm.executePendingTransactions();
 390     }
 391 
 392     /**
 393      * Checks for a previously valid user that is now not authenticated
 394      *
 395      * @return true if user has invalid authorization
 396      */
 397     private boolean userAuthenticationIsInvalid() {
 398         Simplenote currentApp = (Simplenote) getApplication();
 399         Simperium simperium = currentApp.getSimperium();
 400         User user = simperium.getUser();
 401         return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 402     }
 403 
 404     public void setCurrentNote(Note note) {
 405         mCurrentNote = note;
 406     }
 407 
 408     // received a change from the network, refresh the list
 409     @Override
 410     public void onChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
 411         runOnUiThread(new Runnable() {
 412             @Override
 413             public void run() {
 414                 if (type == Bucket.ChangeType.INDEX)
 415                     setProgressBarIndeterminateVisibility(false);
 416                 mNoteListFragment.refreshList();
 417             }
 418         });
 419     }
 420 
 421     @Override
 422     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 423         runOnUiThread(new Runnable() {
 424             @Override
 425             public void run() {
 426                 mNoteListFragment.refreshList();
 427             }
 428         });
 429     }
 430 
 431     @Override
 432     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 433         runOnUiThread(new Runnable() {
 434             @Override
 435             public void run() {
 436                 mNoteListFragment.refreshList();
 437             }
 438         });
 439     }
 440 
 441     @Override
 442     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 443 
 444         // noop, NoteEditorFragment will handle this
 445 
 446     }
 447 
 448     // Tags bucket listener
 449     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 450         void updateNavigationDrawer() {
 451             runOnUiThread(new Runnable() {
 452                 public void run() {
 453                     updateNavigationDrawerItems();
 454                 }
 455             });
 456         }
 457 
 458         @Override
 459         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 460             updateNavigationDrawer();
 461         }
 462 
 463         @Override
 464         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 465             updateNavigationDrawer();
 466         }
 467 
 468         @Override
 469         public void onChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 470             updateNavigationDrawer();
 471         }
 472 
 473         @Override
 474         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 475             // noop
 476         }
 477     };
 478 
 479     public boolean isLargeScreenLandscape() {
 480         return mIsLargeScreen &amp;&amp; mIsLandscape;
 481     }
 482 
 483     // nbradbury 01-Apr-2013
 484     public NoteListFragment getNoteListFragment() {
 485         return mNoteListFragment;
 486     }
 487 
 488     @Override
 489     public boolean onCreateOptionsMenu(Menu menu) {
 490         super.onCreateOptionsMenu(menu);
 491         MenuInflater inflater = getMenuInflater();
 492         inflater.inflate(R.menu.notes_list, menu);
 493 
 494         boolean drawerOpen = mDrawerLayout.isDrawerOpen(mDrawerList);
 495 
 496         // restore the search query if on a landscape tablet
 497         String searchQuery = null;
 498         if (isLargeScreenLandscape() &amp;&amp; mSearchView != null)
 499             searchQuery = mSearchView.getQuery().toString();
 500 
 501         mSearchMenuItem = menu.findItem(R.id.menu_search);
 502         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 503 
 504         if (!TextUtils.isEmpty(searchQuery)) {
 505             mSearchView.setQuery(searchQuery, false);
 506             mSearchMenuItem.expandActionView();
 507         }
 508 
 509         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 510             @Override
 511             public boolean onQueryTextChange(String newText) {
 512                 if (mSearchMenuItem.isActionViewExpanded()) {
 513                     getNoteListFragment().searchNotes(newText);
 514                 }
 515                 return true;
 516             }
 517 
 518             @Override
 519             public boolean onQueryTextSubmit(String queryText) {
 520                 getNoteListFragment().searchNotes(queryText);
 521                 return true;
 522             }
 523 
 524         });
 525 
<abbr title=" 526         MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListener() {"> 526         MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListenðŸ”µ</abbr>
 527             @Override
 528             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 529                 checkEmptyListText(true);
 530                 getNoteListFragment().hideWelcomeView();
 531                 mTracker.send(
 532                         new HitBuilders.EventBuilder()
 533                                 .setCategory(&quot;note&quot;)
 534                                 .setAction(&quot;searched_notes&quot;)
 535                                 .setLabel(&quot;action_bar_search_tap&quot;)
 536                                 .build()
 537                 );
 538                 return true;
 539             }
 540 
 541             @Override
 542             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 543                 // Show all notes again
 544                 mTabletSearchQuery = &quot;&quot;;
 545                 mSearchView.setQuery(&quot;&quot;, false);
 546                 checkEmptyListText(false);
 547                 getNoteListFragment().clearSearch();
 548                 getNoteListFragment().setWelcomeViewVisibility();
 549                 return true;
 550             }
 551         });
 552 
 553         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 554             @Override
 555             public boolean onMenuItemClick(MenuItem item) {
 556                 if (!mSearchMenuItem.isActionViewExpanded())
 557                     showDetailPlaceholder();
 558                 return false;
 559             }
 560         });
 561 
 562         // Restore the search query on landscape tablets
 563         if (isLargeScreenLandscape() &amp;&amp; !TextUtils.isEmpty(mTabletSearchQuery)) {
 564             mSearchView.setQuery(mTabletSearchQuery, false);
 565             mSearchMenuItem.expandActionView();
 566             mSearchView.clearFocus();
 567         }
 568 
 569         Simplenote currentApp = (Simplenote) getApplication();
 570         menu.findItem(R.id.menu_sign_in).setVisible(currentApp.getSimperium().needsAuthorization());
 571 
 572 
 573         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 574         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 575             trashItem.setTitle(R.string.undelete);
 576         else
 577             trashItem.setTitle(R.string.delete);
 578 
 579         if (isLargeScreenLandscape()) {
 580             menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 581             menu.findItem(R.id.menu_preferences).setVisible(true);
 582             if (mCurrentNote != null) {
 583                 menu.findItem(R.id.menu_share).setVisible(!drawerOpen);
 584                 trashItem.setVisible(true);
 585             } else {
 586                 menu.findItem(R.id.menu_share).setVisible(false);
 587                 trashItem.setVisible(false);
 588             }
 589             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 590             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 591         } else {
 592             menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 593             menu.findItem(R.id.menu_preferences).setVisible(true);
 594             menu.findItem(R.id.menu_share).setVisible(false);
 595             trashItem.setVisible(false);
 596             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 597             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 598         }
 599 
 600         // Are we looking at the trash? Adjust menu accordingly.
 601         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 602             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 603             mEmptyTrashMenuItem.setVisible(!drawerOpen);
 604 
 605             updateTrashMenuItem();
 606 
 607             menu.findItem(R.id.menu_search).setVisible(false);
 608             menu.findItem(R.id.menu_share).setVisible(false);
 609         }
 610 
 611         return true;
 612     }
 613 
 614     @Override
 615     public boolean onOptionsItemSelected(MenuItem item) {
 616         if (mDrawerToggle.onOptionsItemSelected(item)) {
 617             return true;
 618         }
 619         switch (item.getItemId()) {
 620             case R.id.menu_preferences:
<abbr title=" 621                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 621                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returnðŸ”µ</abbr>
 622                 Intent i = new Intent(this, PreferencesActivity.class);
 623                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 624                 return true;
 625             case R.id.menu_sign_in:
 626                 startLoginActivity(true);
 627                 return true;
 628             case R.id.menu_edit_tags:
 629                 Intent editTagsIntent = new Intent(this, TagsActivity.class);
 630                 startActivity(editTagsIntent);
 631                 return true;
 632 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 633 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 634                 return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 635             case R.id.menu_delete:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 636                 if (mNoteEditorFragment != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 637                     if (mCurrentNote != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 638                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 639                         mCurrentNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 640                         mCurrentNote.save();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 641 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 642                         if (mCurrentNote.isDeleted()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 643                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();</span>
 644 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645             case R.id.menu_create_note:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646                 getNoteListFragment().addNote();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647                 mTracker.send(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648                         new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649                                 .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650                                 .setAction(&quot;create_note&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651                                 .setLabel(&quot;action_bar_button&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652                                 .build()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653                 );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654                 return true;</span>
 655 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 656             case R.id.menu_share:
 657                 if (mCurrentNote != null) {
 658                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 659                     shareIntent.setType(&quot;text/plain&quot;);
 660                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 661                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 661                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
 662                     mTracker.send(
 663                             new HitBuilders.EventBuilder()
 664                                     .setCategory(&quot;note&quot;)
 665                                     .setAction(&quot;shared_note&quot;)
 666                                     .setLabel(&quot;action_bar_share_button&quot;)
 667                                     .build()
 668                     );
 669                 }
 670                 return true;
 671             case R.id.menu_delete:
 672                 if (mNoteEditorFragment != null) {
 673                     if (mCurrentNote != null) {
 674                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 675                         mCurrentNote.setModificationDate(Calendar.getInstance());
 676                         mCurrentNote.save();
 677 
 678                         if (mCurrentNote.isDeleted()) {
 679                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 680                             deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 681                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 682                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);"> 682                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null)ðŸ”µ</abbr>
 683                             mTracker.send(
 684                                     new HitBuilders.EventBuilder()
 685                                             .setCategory(&quot;note&quot;)
 686                                             .setAction(&quot;deleted_note&quot;)
 687                                             .setLabel(&quot;overflow_menu&quot;)
 688                                             .build()
 689                             );
 690                         } else {
 691                             mTracker.send(
 692                                     new HitBuilders.EventBuilder()
 693                                             .setCategory(&quot;note&quot;)
 694                                             .setAction(&quot;restored_note&quot;)
 695                                             .setLabel(&quot;overflow_menu&quot;)
 696                                             .build()
 697                             );
 698                         }
 699                         showDetailPlaceholder();
 700                     }
 701                     NoteListFragment fragment = getNoteListFragment();
 702                     if (fragment != null) {
 703                         fragment.getPrefs();
 704                         fragment.refreshList();
 705                     }
 706                 }
 707                 return true;
 708             case R.id.menu_empty_trash:
 709                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 710 
 711                 alert.setTitle(R.string.empty_trash);
 712                 alert.setMessage(R.string.confirm_empty_trash);
 713                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 714                     public void onClick(DialogInterface dialog, int whichButton) {
 715                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 716                         mTracker.send(
 717                                 new HitBuilders.EventBuilder()
 718                                         .setCategory(&quot;note&quot;)
 719                                         .setAction(&quot;trash_emptied&quot;)
 720                                         .setLabel(&quot;overflow_menu&quot;)
 721                                         .build()
 722                         );
 723                     }
 724                 });
 725                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 726                     public void onClick(DialogInterface dialog, int whichButton) {
 727                         // Do nothing, just closing the dialog
 728                     }
 729                 });
 730                 alert.show();
 731                 return true;
 732             case android.R.id.home:
 733                 invalidateOptionsMenu();
 734                 return true;
 735             default:
 736                 return super.onOptionsItemSelected(item);
 737         }
 738     }
 739 
 740     /**
 741      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 742      * the item with the given ID was selected.
 743      */
 744     @Override
 745     public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {
 746 
 747         if (!isLargeScreenLandscape()) {
 748             // Launch the editor activity
 749             Bundle arguments = new Bundle();
 750             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 751             arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);
 752 
 753             if (matchOffsets != null)
 754                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 755 
 756             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 757             editNoteIntent.putExtras(arguments);
 758             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 759         } else {
 760             mNoteEditorFragment.setIsNewNote(isNew);
 761             mNoteEditorFragment.setNote(noteID, matchOffsets);
 762             getNoteListFragment().setNoteSelected(noteID);
 763             if (mSearchView != null &amp;&amp; mSearchView.getQuery().length() &gt; 0) {
 764                 mTabletSearchQuery = mSearchView.getQuery().toString();
 765             }
 766             invalidateOptionsMenu();
 767         }
 768 
 769         mTracker.send(
 770                 new HitBuilders.EventBuilder()
 771                         .setCategory(&quot;note&quot;)
 772                         .setAction(&quot;viewed_note&quot;)
 773                         .setLabel(&quot;note_list_row_tap&quot;)
 774                         .build()
 775         );
 776     }
 777 
 778     @Override
 779     public void onUserCreated(User user) {
 780         // New account created
 781         mTracker.send(
 782                 new HitBuilders.EventBuilder()
 783                         .setCategory(&quot;user&quot;)
 784                         .setAction(&quot;new_account_created&quot;)
 785                         .setLabel(&quot;account_created_from_login_activity&quot;)
 786                         .build()
 787         );
 788     }
 789 
 790     public void onUserStatusChange(User.Status status) {
 791         switch (status) {
 792 
 793             // successfully used access token to connect to simperium bucket
 794             case AUTHORIZED:
 795                 mTracker.send(
 796                         new HitBuilders.EventBuilder()
 797                                 .setCategory(&quot;user&quot;)
 798                                 .setAction(&quot;signed_in&quot;)
 799                                 .setLabel(&quot;signed_in_from_login_activity&quot;)
 800                                 .build()
 801                 );
 802                 runOnUiThread(new Runnable() {
 803                     @Override
 804                     public void run() {
 805                         if (!mNotesBucket.hasChangeVersion()) {
 806                             setProgressBarIndeterminateVisibility(true);
 807                         }
 808                     }
 809                 });
 810                 break;
 811 
 812             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 813             case NOT_AUTHORIZED:
 814                 runOnUiThread(new Runnable() {
 815                     @Override
 816                     public void run() {
 817                         startLoginActivity(true);
 818                     }
 819                 });
 820                 break;
 821 
<abbr title=" 822             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 822             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 823             case UNKNOWN:
 824                 break;
 825         }
 826     }
 827 
 828     public void startLoginActivity(boolean signInFirst) {
 829         Intent loginIntent = new Intent(this, LoginActivity.class);
 830         if (signInFirst)
 831             loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 832         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 833     }
 834 
 835 
 836     @Override
 837     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 838         super.onActivityResult(requestCode, resultCode, data);
 839         switch (requestCode) {
 840             case Simplenote.INTENT_PREFERENCES:
 841                 if (ThemeUtils.themeWasChanged(data)) {
 842                     // Restart this activity to apply the new theme
 843                     recreate();
 844                     break;
 845                 }
<abbr title=" 846                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 846                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 847                 invalidateOptionsMenu();
 848                 NoteListFragment fragment = getNoteListFragment();
 849                 if (fragment != null) {
 850                     fragment.getPrefs();
 851                     fragment.refreshList();
 852                 }
 853                 break;
 854             case Simplenote.INTENT_EDIT_NOTE:
<abbr title=" 855                 if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {"> 855                 if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID))ðŸ”µ</abbr>
 856                     String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 857                     if (noteId != null) {
 858                         List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 859                         deletedNoteIds.add(noteId);
 860                         mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 861                         mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
 862                     }
 863                 }
 864                 break;
 865             case Simperium.SIGNUP_SIGNIN_REQUEST:
 866                 invalidateOptionsMenu();
 867                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 868                     finish();
 869                 }
 870                 break;
 871         }
 872     }
 873 
 874     @Override
 875     public void onUndo(Parcelable p) {
 876         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 877         if (mUndoBarController != null &amp;&amp; deletedNoteIds != null) {
 878 
 879             for (int i=0; i &lt; deletedNoteIds.size(); i++) {
 880                 Note deletedNote = null;
 881                 try {
 882                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 883                 } catch (BucketObjectMissingException e) {
 884                     return;
 885                 }
 886                 if (deletedNote != null) {
 887                     deletedNote.setDeleted(false);
 888                     deletedNote.setModificationDate(Calendar.getInstance());
 889                     deletedNote.save();
 890                     NoteListFragment fragment = getNoteListFragment();
 891                     if (fragment != null) {
 892                         fragment.getPrefs();
 893                         fragment.refreshList();
 894                     }
 895                 }
 896             }
 897         }
 898     }
 899 
 900     @Override
 901     protected void onPostCreate(Bundle savedInstanceState) {
 902         super.onPostCreate(savedInstanceState);
 903         // Sync the toggle state after onRestoreInstanceState has occurred.
 904         mDrawerToggle.syncState();
 905     }
 906 
 907     @Override
 908     public void onConfigurationChanged(Configuration newConfig) {
 909         super.onConfigurationChanged(newConfig);
 910 
 911         mDrawerToggle.onConfigurationChanged(newConfig);
 912 
 913         if (mIsLargeScreen) {
 914             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 915                 // Add the editor fragment
 916                 mIsLandscape = true;
 917                 addEditorFragment();
 918                 if (mNoteListFragment != null) {
 919                     mNoteListFragment.setActivateOnItemClick(true);
 920                     mNoteListFragment.setDividerVisible(true);
 921                 }
 922                 // Select the current note on a tablet
 923                 if (mCurrentNote != null)
 924                     onNoteSelected(mCurrentNote.getSimperiumKey(), false, null);
 925                 else {
 926                     mNoteEditorFragment.setPlaceholderVisible(true);
 927                     mNoteListFragment.getListView().clearChoices();
 928                 }
 929                 invalidateOptionsMenu();
<abbr title=" 930             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {"> 930             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragmentðŸ”µ</abbr>
 931                 // Remove the editor fragment when rotating back to portrait
 932                 mIsLandscape = false;
 933                 mCurrentNote = null;
 934                 if (mNoteListFragment != null) {
 935                     mNoteListFragment.setActivateOnItemClick(false);
 936                     mNoteListFragment.setDividerVisible(false);
 937                     mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 938                     mNoteListFragment.refreshList();
 939                 }
 940                 FragmentManager fm = getFragmentManager();
 941                 FragmentTransaction ft = fm.beginTransaction();
 942                 ft.remove(mNoteEditorFragment);
 943                 mNoteEditorFragment = null;
 944                 ft.commitAllowingStateLoss();
 945                 fm.executePendingTransactions();
 946                 invalidateOptionsMenu();
 947             }
 948         }
 949     }
 950 
 951     public void checkEmptyListText(boolean isSearch) {
 952         if (isSearch) {
<abbr title=" 953             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);"> 953             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
 954             getNoteListFragment().setEmptyListViewClickable(false);
 955         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title=" 956             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);"> 956             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
 957             mTracker.send(
 958                     new HitBuilders.EventBuilder()
 959                             .setCategory(&quot;user&quot;)
 960                             .setAction(&quot;viewed_trash&quot;)
 961                             .setLabel(&quot;trash_filter_selected&quot;)
 962                             .build()
 963             );
 964             getNoteListFragment().setEmptyListViewClickable(false);
 965         } else {
<abbr title=" 966             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 966             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
 967             getNoteListFragment().setEmptyListViewClickable(true);
 968         }
 969     }
 970 
 971     public void showDetailPlaceholder() {
 972         if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 973             mCurrentNote = null;
 974             mNoteEditorFragment.setPlaceholderVisible(true);
 975             invalidateOptionsMenu();
 976         }
 977     }
 978 
 979     public void stopListeningToNotesBucket() {
 980         mNotesBucket.removeOnNetworkChangeListener(this);
 981         mNotesBucket.removeOnSaveObjectListener(this);
 982         mNotesBucket.removeOnDeleteObjectListener(this);
 983     }
 984 
 985     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
 986         if (mUndoBarController != null) {
 987             mUndoBarController.setDeletedNoteIds(noteIds);
<abbr title=" 988             mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()), null);"> 988             mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_noteðŸ”µ</abbr>
 989         }
 990     }
 991 
 992     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 993 
 994         @Override
 995         protected Void doInBackground(Void... voids) {
 996             Simplenote application = (Simplenote) getApplication();
 997             Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 998             Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 999             Bucket.ObjectCursor c = query.execute();
1000             while (c.moveToNext()) {
1001                 c.getObject().delete();
1002             }
1003             return null;
1004         }
1005 
1006         @Override
1007         protected void onPostExecute(Void nada) {
1008             showDetailPlaceholder();
1009         }
1010     }
1011 
1012 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.AlertDialog;
   5 import android.app.FragmentManager;
   6 import android.app.FragmentTransaction;
   7 import android.content.DialogInterface;
   8 import android.content.Intent;
   9 import android.content.SharedPreferences;
  10 import android.content.res.Configuration;
  11 import android.os.AsyncTask;
  12 import android.os.Build;
  13 import android.os.Bundle;
  14 import android.os.Parcelable;
  15 import android.preference.PreferenceManager;
  16 import android.support.v4.view.MenuItemCompat;
  17 import android.support.v7.app.ActionBarDrawerToggle;
  18 import android.support.v4.widget.DrawerLayout;
  19 import android.support.v7.app.ActionBar;
  20 import android.support.v7.app.ActionBarActivity;
  21 import android.support.v7.widget.Toolbar;
  22 import android.text.Spannable;
  23 import android.text.SpannableString;
  24 import android.text.TextUtils;
  25 import android.view.Gravity;
  26 import android.view.Menu;
  27 import android.view.MenuInflater;
  28 import android.view.MenuItem;
  29 import android.view.View;
  30 import android.view.Window;
  31 import android.widget.AdapterView;
  32 import android.widget.ListView;
  33 import android.support.v7.widget.SearchView;
  34 
  35 import com.automattic.simplenote.models.Note;
  36 import com.automattic.simplenote.models.Tag;
  37 import com.automattic.simplenote.utils.PrefUtils;
  38 import com.automattic.simplenote.utils.TagsAdapter;
  39 import com.automattic.simplenote.utils.ThemeUtils;
  40 import com.automattic.simplenote.widgets.FloatingActionButton;
  41 import com.automattic.simplenote.widgets.TypefaceSpan;
  42 import com.automattic.simplenote.utils.UndoBarController;
  43 import com.google.android.gms.analytics.HitBuilders;
  44 import com.google.android.gms.analytics.Tracker;
  45 import com.simperium.Simperium;
  46 import com.simperium.android.LoginActivity;
  47 import com.simperium.client.Bucket;
  48 import com.simperium.client.BucketObjectMissingException;
  49 import com.simperium.client.BucketObjectNameInvalid;
  50 import com.simperium.client.Query;
  51 import com.simperium.client.User;
  52 
  53 import java.util.ArrayList;
  54 import java.util.Calendar;
  55 import java.util.List;
  56 
  57 public class NotesActivity extends ActionBarActivity implements
<abbr title="  58         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  58         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  59         Bucket.Listener&lt;Note&gt; {
  60 
  61     private boolean mIsLargeScreen, mIsLandscape, mShouldSelectNewNote;
  62     private String mTabletSearchQuery;
  63     private UndoBarController mUndoBarController;
  64     private SearchView mSearchView;
  65     private MenuItem mSearchMenuItem;
  66     private NoteListFragment mNoteListFragment;
  67     private NoteEditorFragment mNoteEditorFragment;
  68     private Note mCurrentNote;
  69     protected Bucket&lt;Note&gt; mNotesBucket;
  70     protected Bucket&lt;Tag&gt; mTagsBucket;
  71     private int TRASH_SELECTED_ID = 1;
  72     private ActionBar mActionBar;
  73     private MenuItem mEmptyTrashMenuItem;
  74 
  75     // Menu drawer
  76     private DrawerLayout mDrawerLayout;
  77     private ListView mDrawerList;
  78     private ActionBarDrawerToggle mDrawerToggle;
  79     private TagsAdapter mTagsAdapter;
  80     private TagsAdapter.TagMenuItem mSelectedTag;
  81     private CharSequence mActionBarTitle;
  82 
  83     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  84     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  85 
  86     // Google Analytics tracker
  87     private Tracker mTracker;
  88 
  89     @Override
  90     protected void onCreate(Bundle savedInstanceState) {
  91         supportRequestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);
  92 
  93         ThemeUtils.setTheme(this);
  94 
  95         super.onCreate(savedInstanceState);
  96         Simplenote currentApp = (Simplenote) getApplication();
  97 
  98         if (mNotesBucket == null)
  99             mNotesBucket = currentApp.getNotesBucket();
 100 
 101         if (mTagsBucket == null)
 102             mTagsBucket = currentApp.getTagsBucket();
 103 
 104         setContentView(R.layout.activity_notes);
 105 
 106 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107         Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108         setSupportActionBar(toolbar);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110         EasyTracker.getInstance().activityStart(this);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111         mTracker = EasyTracker.getTracker();</span>
 112 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         EasyTracker.getInstance().activityStart(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         mTracker = EasyTracker.getTracker();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116         if (savedInstanceState == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117             mNoteListFragment = new NoteListFragment();</span>
 118 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119         mTracker = currentApp.getTracker();</span>
 120 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 121 
 122         if (savedInstanceState == null) {
 123             mNoteListFragment = new NoteListFragment();
 124             FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
 125             fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
 126             fragmentTransaction.commit();
 127         } else {
 128             mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 129         }
 130 
 131         Configuration config = getBaseContext().getResources().getConfiguration();
 132         if ((config.screenLayout
 133                 &amp; Configuration.SCREENLAYOUT_SIZE_MASK)
 134                 &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {
 135             mIsLargeScreen = true;
 136 
 137             if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 138                 mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 138                 mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTðŸ”µ</abbr>
 139             } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 140                 mIsLandscape = true;
 141                 addEditorFragment();
 142             }
 143         }
 144 
 145         // Set up the menu drawer
 146         mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);
 147         mDrawerList = (ListView) findViewById(R.id.left_drawer);
 148         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 149         mDrawerList.setAdapter(mTagsAdapter);
 150         // Set the list&#x27;s click listener
 151         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 152 
 153         if (mSelectedTag == null)
 154             mSelectedTag = mTagsAdapter.getDefaultItem();
 155 
 156         mDrawerToggle = new ActionBarDrawerToggle(
 157                 this,  mDrawerLayout, toolbar,
 158                 R.string.open_drawer, R.string.close_drawer
 159         ) {
 160             public void onDrawerClosed(View view) {
 161                 setTitle(mActionBarTitle);
 162                 invalidateOptionsMenu();
 163             }
 164 
 165             public void onDrawerOpened(View drawerView) {
 166                 setTitleWithCustomFont(getString(R.string.app_name));
 167                 invalidateOptionsMenu();
 168             }
 169         };
 170         mDrawerLayout.setDrawerListener(mDrawerToggle);
 171 
 172         // enable ActionBar app icon to behave as action to toggle nav drawer
 173         mActionBar = getSupportActionBar();
 174         mActionBar.setDisplayHomeAsUpEnabled(true);
 175         mActionBar.setHomeButtonEnabled(true);
 176 
 177         mDrawerLayout.setDrawerListener(mDrawerToggle);
 178 
 179         mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);
 180 
 181         FloatingActionButton fabButton = new FloatingActionButton.Builder(this)
 182                 .withDrawable(getResources().getDrawable(R.drawable.ic_create_white))
 183                 .withButtonColor(getResources().getColor(R.color.simplenote_blue))
 184                 .withGravity(Gravity.BOTTOM | Gravity.RIGHT)
 185                 .withMargins(0, 0, 16, 16)
 186                 .create();
 187 
 188         fabButton.setOnClickListener(new View.OnClickListener() {
 189             @Override
 190             public void onClick(View v) {
 191                 if (getNoteListFragment() != null) {
 192                     getNoteListFragment().addNote();
 193                     mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;action_bar_button&quot;, null);
 194                 }
 195             }
 196         });
 197 
 198         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 199             // Create the welcome note
 200             try {
 201                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 202                 welcomeNote.setCreationDate(Calendar.getInstance());
 203                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 204                 welcomeNote.setContent(getString(R.string.welcome_note));
 205                 welcomeNote.getTitle();
 206                 welcomeNote.save();
 207             } catch (BucketObjectNameInvalid e) {
 208                 // this won&#x27;t happen because welcome-android is a valid name
 209             }
 210 
 211             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 212             SharedPreferences.Editor editor = preferences.edit();
 213             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 214             editor.commit();
 215         }
 216 
 217         if (Intent.ACTION_SEND.equals(getIntent().getAction())) {
 218             // Check share action
 219             Intent intent = getIntent();
 220             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 221             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 222             if (text != null &amp;&amp; !text.equals(&quot;&quot;)) {
 223                 if (subject != null &amp;&amp; !subject.equals(&quot;&quot;)) {
 224                     text = subject + &quot;\n\n&quot; + text;
 225                 }
 226                 Note note = mNotesBucket.newObject();
 227                 note.setCreationDate(Calendar.getInstance());
 228                 note.setModificationDate(note.getCreationDate());
 229                 note.setContent(text);
 230                 note.save();
 231                 setCurrentNote(note);
 232                 mShouldSelectNewNote = true;
 233                 mTracker.send(
 234                         new HitBuilders.EventBuilder()
 235                                 .setCategory(&quot;note&quot;)
 236                                 .setAction(&quot;create_note&quot;)
 237                                 .setLabel(&quot;external_share&quot;)
 238                                 .build()
 239                 );
 240             }
 241         }
 242         currentApp.getSimperium().setOnUserCreatedListener(this);
 243         currentApp.getSimperium().setUserStatusChangeListener(this);
 244         setProgressBarIndeterminateVisibility(false);
 245     }
 246 
 247     @Override
 248     protected void onResume() {
 249         super.onResume();
 250 
 251         // Ensure user has valid authorization
 252         if (userAuthenticationIsInvalid())
 253             startLoginActivity(true);
 254 
 255         mNotesBucket.start();
 256         mTagsBucket.start();
 257 
 258         mNotesBucket.addOnNetworkChangeListener(this);
 259         mNotesBucket.addOnSaveObjectListener(this);
 260         mNotesBucket.addOnDeleteObjectListener(this);
 261         mTagsBucket.addListener(mTagsMenuUpdater);
 262 
 263         updateNavigationDrawerItems();
 264 
 265         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 266         Simplenote currentApp = (Simplenote)getApplication();
 267         if (currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED) {
 268             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 269                 mSelectedTag = null;
 270                 mDrawerList.setSelection(mTagsAdapter.DEFAULT_ITEM_POSITION);
 271             }
 272         }
 273 
 274         setSelectedTagActive();
 275 
 276         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 277             onNoteSelected(mCurrentNote.getSimperiumKey(), true, null);
 278             mShouldSelectNewNote = false;
 279         }
 280     }
 281 
 282     @Override
 283     protected void onPause() {
 284         super.onPause();
 285 
 286         mTagsBucket.removeListener(mTagsMenuUpdater);
 287 
 288         mNotesBucket.removeOnNetworkChangeListener(this);
 289         mNotesBucket.removeOnSaveObjectListener(this);
 290         mNotesBucket.removeOnDeleteObjectListener(this);
 291     }
 292 
 293     @Override
 294     public void setTitle(CharSequence title) {
 295         mActionBarTitle = (title != null) ? title : &quot;&quot;;
 296         setTitleWithCustomFont(mActionBarTitle);
 297     }
 298 
 299     private void setTitleWithCustomFont(CharSequence title) {
 300         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 301         if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 302                 &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 303             mActionBar.setTitle(title);
 304             return;
 305         }
 306 
 307         SpannableString s = new SpannableString(title);
 308         s.setSpan(new TypefaceSpan(this), 0, s.length(),
 309                 Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 310         mActionBar.setTitle(s);
 311     }
 312 
 313     private void updateNavigationDrawerItems() {
 314         Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 315         mTagsAdapter.changeCursor(tagCursor);
 316     }
 317 
 318     private void setSelectedTagActive() {
 319         if (mSelectedTag == null)
 320             mSelectedTag = mTagsAdapter.getDefaultItem();
 321 
 322         setTitle(mSelectedTag.name);
 323         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag), true);
 324     }
 325 
 326     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 327     public void updateTrashMenuItem() {
 328         if (mEmptyTrashMenuItem == null)
 329             return;
 330         // Disable the trash icon if there are no notes trashed.
 331         Simplenote application = (Simplenote) getApplication();
 332         Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 333         Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 334         if (query.count() == 0) {
 335             mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash_disabled);
 336             mEmptyTrashMenuItem.setEnabled(false);
 337         } else {
 338             mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash);
 339             mEmptyTrashMenuItem.setEnabled(true);
 340         }
 341     }
 342 
 343     /* The click listener for ListView in the navigation drawer */
 344     private class DrawerItemClickListener implements ListView.OnItemClickListener {
 345         @Override
 346         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 347 
 348             mSelectedTag = mTagsAdapter.getItem(position);
 349             checkEmptyListText(false);
 350             // Update checked item in navigation drawer and close it
 351             setSelectedTagActive();
 352             mDrawerLayout.closeDrawer(mDrawerList);
 353 
 354             // Disable long press on notes if we&#x27;re viewing the trash
 355             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 356                 getNoteListFragment().getListView().setLongClickable(false);
 357             } else {
 358                 getNoteListFragment().getListView().setLongClickable(true);
 359             }
 360 
 361             getNoteListFragment().refreshListFromNavSelect();
 362             if (position &gt; 1) {
 363                 mTracker.send(
 364                         new HitBuilders.EventBuilder()
 365                                 .setCategory(&quot;tag&quot;)
 366                                 .setAction(&quot;viewed_notes_for_tag&quot;)
 367                                 .setLabel(&quot;selected_tag_in_navigation_drawer&quot;)
 368                                 .build()
 369                 );
 370             }
 371         }
 372     }
 373 
 374     public TagsAdapter.TagMenuItem getSelectedTag() {
 375         return mSelectedTag;
 376     }
 377 
 378     private void addEditorFragment() {
 379         FragmentManager fm = getFragmentManager();
 380         FragmentTransaction ft = fm.beginTransaction();
 381         mNoteEditorFragment = new NoteEditorFragment();
 382         ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 383         ft.commitAllowingStateLoss();
 384         fm.executePendingTransactions();
 385     }
 386 
 387     /**
 388      * Checks for a previously valid user that is now not authenticated
 389      *
 390      * @return true if user has invalid authorization
 391      */
 392     private boolean userAuthenticationIsInvalid() {
 393         Simplenote currentApp = (Simplenote) getApplication();
 394         Simperium simperium = currentApp.getSimperium();
 395         User user = simperium.getUser();
 396         return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 397     }
 398 
 399     public void setCurrentNote(Note note) {
 400         mCurrentNote = note;
 401     }
 402 
 403     // received a change from the network, refresh the list
 404     @Override
 405     public void onChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
 406         runOnUiThread(new Runnable() {
 407             @Override
 408             public void run() {
 409                 if (type == Bucket.ChangeType.INDEX)
 410                     setProgressBarIndeterminateVisibility(false);
 411                 mNoteListFragment.refreshList();
 412             }
 413         });
 414     }
 415 
 416     @Override
 417     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 418         runOnUiThread(new Runnable() {
 419             @Override
 420             public void run() {
 421                 mNoteListFragment.refreshList();
 422             }
 423         });
 424     }
 425 
 426     @Override
 427     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 428         runOnUiThread(new Runnable() {
 429             @Override
 430             public void run() {
 431                 mNoteListFragment.refreshList();
 432             }
 433         });
 434     }
 435 
 436     @Override
 437     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 438 
 439         // noop, NoteEditorFragment will handle this
 440 
 441     }
 442 
 443     // Tags bucket listener
 444     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 445         void updateNavigationDrawer() {
 446             runOnUiThread(new Runnable() {
 447                 public void run() {
 448                     updateNavigationDrawerItems();
 449                 }
 450             });
 451         }
 452 
 453         @Override
 454         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 455             updateNavigationDrawer();
 456         }
 457 
 458         @Override
 459         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 460             updateNavigationDrawer();
 461         }
 462 
 463         @Override
 464         public void onChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 465             updateNavigationDrawer();
 466         }
 467 
 468         @Override
 469         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 470             // noop
 471         }
 472     };
 473 
 474     public boolean isLargeScreenLandscape() {
 475         return mIsLargeScreen &amp;&amp; mIsLandscape;
 476     }
 477 
 478     // nbradbury 01-Apr-2013
 479     public NoteListFragment getNoteListFragment() {
 480         return mNoteListFragment;
 481     }
 482 
 483     @Override
 484     public boolean onCreateOptionsMenu(Menu menu) {
 485         super.onCreateOptionsMenu(menu);
 486         MenuInflater inflater = getMenuInflater();
 487         inflater.inflate(R.menu.notes_list, menu);
 488 
 489         boolean drawerOpen = mDrawerLayout.isDrawerOpen(mDrawerList);
 490 
 491         // restore the search query if on a landscape tablet
 492         String searchQuery = null;
 493         if (isLargeScreenLandscape() &amp;&amp; mSearchView != null)
 494             searchQuery = mSearchView.getQuery().toString();
 495 
 496         mSearchMenuItem = menu.findItem(R.id.menu_search);
 497         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 498 
 499         if (!TextUtils.isEmpty(searchQuery)) {
 500             mSearchView.setQuery(searchQuery, false);
 501             mSearchMenuItem.expandActionView();
 502         }
 503 
 504         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 505             @Override
 506             public boolean onQueryTextChange(String newText) {
 507                 if (mSearchMenuItem.isActionViewExpanded()) {
 508                     getNoteListFragment().searchNotes(newText);
 509                 }
 510                 return true;
 511             }
 512 
 513             @Override
 514             public boolean onQueryTextSubmit(String queryText) {
 515                 getNoteListFragment().searchNotes(queryText);
 516                 return true;
 517             }
 518 
 519         });
 520 
<abbr title=" 521         MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListener() {"> 521         MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListenðŸ”µ</abbr>
 522             @Override
 523             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 524                 checkEmptyListText(true);
 525                 getNoteListFragment().hideWelcomeView();
 526                 mTracker.send(
 527                         new HitBuilders.EventBuilder()
 528                                 .setCategory(&quot;note&quot;)
 529                                 .setAction(&quot;searched_notes&quot;)
 530                                 .setLabel(&quot;action_bar_search_tap&quot;)
 531                                 .build()
 532                 );
 533                 return true;
 534             }
 535 
 536             @Override
 537             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 538                 // Show all notes again
 539                 mTabletSearchQuery = &quot;&quot;;
 540                 mSearchView.setQuery(&quot;&quot;, false);
 541                 checkEmptyListText(false);
 542                 getNoteListFragment().clearSearch();
 543                 getNoteListFragment().setWelcomeViewVisibility();
 544                 return true;
 545             }
 546         });
 547 
 548         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 549             @Override
 550             public boolean onMenuItemClick(MenuItem item) {
 551                 if (!mSearchMenuItem.isActionViewExpanded())
 552                     showDetailPlaceholder();
 553                 return false;
 554             }
 555         });
 556 
 557         // Restore the search query on landscape tablets
 558         if (isLargeScreenLandscape() &amp;&amp; !TextUtils.isEmpty(mTabletSearchQuery)) {
 559             mSearchView.setQuery(mTabletSearchQuery, false);
 560             mSearchMenuItem.expandActionView();
 561             mSearchView.clearFocus();
 562         }
 563 
 564         Simplenote currentApp = (Simplenote) getApplication();
 565         menu.findItem(R.id.menu_sign_in).setVisible(currentApp.getSimperium().needsAuthorization());
 566 
 567 
 568         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 569         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 570             trashItem.setTitle(R.string.undelete);
 571         else
 572             trashItem.setTitle(R.string.delete);
 573 
 574         if (isLargeScreenLandscape()) {
 575             menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 576             menu.findItem(R.id.menu_preferences).setVisible(true);
 577             if (mCurrentNote != null) {
 578                 menu.findItem(R.id.menu_share).setVisible(!drawerOpen);
 579                 trashItem.setVisible(true);
 580             } else {
 581                 menu.findItem(R.id.menu_share).setVisible(false);
 582                 trashItem.setVisible(false);
 583             }
 584             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 585             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 586         } else {
 587             menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 588             menu.findItem(R.id.menu_preferences).setVisible(true);
 589             menu.findItem(R.id.menu_share).setVisible(false);
 590             trashItem.setVisible(false);
 591             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 592             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 593         }
 594 
 595         // Are we looking at the trash? Adjust menu accordingly.
 596         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 597             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 598             mEmptyTrashMenuItem.setVisible(!drawerOpen);
 599 
 600             updateTrashMenuItem();
 601 
 602             menu.findItem(R.id.menu_search).setVisible(false);
 603             menu.findItem(R.id.menu_share).setVisible(false);
 604         }
 605 
 606         return true;
 607     }
 608 
 609     @Override
 610     public boolean onOptionsItemSelected(MenuItem item) {
 611         if (mDrawerToggle.onOptionsItemSelected(item)) {
 612             return true;
 613         }
 614         switch (item.getItemId()) {
 615             case R.id.menu_preferences:
<abbr title=" 616                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 616                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returnðŸ”µ</abbr>
 617                 Intent i = new Intent(this, PreferencesActivity.class);
 618                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 619                 return true;
 620             case R.id.menu_sign_in:
 621                 startLoginActivity(true);
 622                 return true;
 623             case R.id.menu_edit_tags:
 624                 Intent editTagsIntent = new Intent(this, TagsActivity.class);
 625                 startActivity(editTagsIntent);
 626                 return true;
 627 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 628 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 629             case R.id.menu_create_note:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 630                 getNoteListFragment().addNote();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 631                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;action_bar_button&quot;, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 632                 return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 633             case R.id.menu_share:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 634                 if (mCurrentNote != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 635                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 636                     shareIntent.setType(&quot;text/plain&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 637                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 638                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 638                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr></span>
 639 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640             case R.id.menu_create_note:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641                 getNoteListFragment().addNote();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642                 mTracker.send(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643                         new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644                                 .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645                                 .setAction(&quot;create_note&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646                                 .setLabel(&quot;action_bar_button&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647                                 .build()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648                 );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649                 return true;</span>
 650 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 651             case R.id.menu_share:
 652                 if (mCurrentNote != null) {
 653                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 654                     shareIntent.setType(&quot;text/plain&quot;);
 655                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 656                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 656                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
 657                     mTracker.send(
 658                             new HitBuilders.EventBuilder()
 659                                     .setCategory(&quot;note&quot;)
 660                                     .setAction(&quot;shared_note&quot;)
 661                                     .setLabel(&quot;action_bar_share_button&quot;)
 662                                     .build()
 663                     );
 664                 }
 665                 return true;
 666             case R.id.menu_delete:
 667                 if (mNoteEditorFragment != null) {
 668                     if (mCurrentNote != null) {
 669                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 670                         mCurrentNote.setModificationDate(Calendar.getInstance());
 671                         mCurrentNote.save();
 672 
 673                         if (mCurrentNote.isDeleted()) {
 674                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 675                             deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 676                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 677                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);"> 677                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null)ðŸ”µ</abbr>
 678                             mTracker.send(
 679                                     new HitBuilders.EventBuilder()
 680                                             .setCategory(&quot;note&quot;)
 681                                             .setAction(&quot;deleted_note&quot;)
 682                                             .setLabel(&quot;overflow_menu&quot;)
 683                                             .build()
 684                             );
 685                         } else {
 686                             mTracker.send(
 687                                     new HitBuilders.EventBuilder()
 688                                             .setCategory(&quot;note&quot;)
 689                                             .setAction(&quot;restored_note&quot;)
 690                                             .setLabel(&quot;overflow_menu&quot;)
 691                                             .build()
 692                             );
 693                         }
 694                         showDetailPlaceholder();
 695                     }
 696                     NoteListFragment fragment = getNoteListFragment();
 697                     if (fragment != null) {
 698                         fragment.getPrefs();
 699                         fragment.refreshList();
 700                     }
 701                 }
 702                 return true;
 703             case R.id.menu_empty_trash:
 704                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 705 
 706                 alert.setTitle(R.string.empty_trash);
 707                 alert.setMessage(R.string.confirm_empty_trash);
 708                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 709                     public void onClick(DialogInterface dialog, int whichButton) {
 710                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 711                         mTracker.send(
 712                                 new HitBuilders.EventBuilder()
 713                                         .setCategory(&quot;note&quot;)
 714                                         .setAction(&quot;trash_emptied&quot;)
 715                                         .setLabel(&quot;overflow_menu&quot;)
 716                                         .build()
 717                         );
 718                     }
 719                 });
 720                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 721                     public void onClick(DialogInterface dialog, int whichButton) {
 722                         // Do nothing, just closing the dialog
 723                     }
 724                 });
 725                 alert.show();
 726                 return true;
 727             case android.R.id.home:
 728                 invalidateOptionsMenu();
 729                 return true;
 730             default:
 731                 return super.onOptionsItemSelected(item);
 732         }
 733     }
 734 
 735     /**
 736      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 737      * the item with the given ID was selected.
 738      */
 739     @Override
 740     public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {
 741 
 742         if (!isLargeScreenLandscape()) {
 743             // Launch the editor activity
 744             Bundle arguments = new Bundle();
 745             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 746             arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);
 747 
 748             if (matchOffsets != null)
 749                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 750 
 751             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 752             editNoteIntent.putExtras(arguments);
 753             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 754         } else {
 755             mNoteEditorFragment.setIsNewNote(isNew);
 756             mNoteEditorFragment.setNote(noteID, matchOffsets);
 757             getNoteListFragment().setNoteSelected(noteID);
 758             if (mSearchView != null &amp;&amp; mSearchView.getQuery().length() &gt; 0) {
 759                 mTabletSearchQuery = mSearchView.getQuery().toString();
 760             }
 761             invalidateOptionsMenu();
 762         }
 763 
 764         mTracker.send(
 765                 new HitBuilders.EventBuilder()
 766                         .setCategory(&quot;note&quot;)
 767                         .setAction(&quot;viewed_note&quot;)
 768                         .setLabel(&quot;note_list_row_tap&quot;)
 769                         .build()
 770         );
 771     }
 772 
 773     @Override
 774     public void onUserCreated(User user) {
 775         // New account created
 776         mTracker.send(
 777                 new HitBuilders.EventBuilder()
 778                         .setCategory(&quot;user&quot;)
 779                         .setAction(&quot;new_account_created&quot;)
 780                         .setLabel(&quot;account_created_from_login_activity&quot;)
 781                         .build()
 782         );
 783     }
 784 
 785     public void onUserStatusChange(User.Status status) {
 786         switch (status) {
 787 
 788             // successfully used access token to connect to simperium bucket
 789             case AUTHORIZED:
 790                 mTracker.send(
 791                         new HitBuilders.EventBuilder()
 792                                 .setCategory(&quot;user&quot;)
 793                                 .setAction(&quot;signed_in&quot;)
 794                                 .setLabel(&quot;signed_in_from_login_activity&quot;)
 795                                 .build()
 796                 );
 797                 runOnUiThread(new Runnable() {
 798                     @Override
 799                     public void run() {
 800                         if (!mNotesBucket.hasChangeVersion()) {
 801                             setProgressBarIndeterminateVisibility(true);
 802                         }
 803                     }
 804                 });
 805                 break;
 806 
 807             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 808             case NOT_AUTHORIZED:
 809                 runOnUiThread(new Runnable() {
 810                     @Override
 811                     public void run() {
 812                         startLoginActivity(true);
 813                     }
 814                 });
 815                 break;
 816 
<abbr title=" 817             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 817             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 818             case UNKNOWN:
 819                 break;
 820         }
 821     }
 822 
 823     public void startLoginActivity(boolean signInFirst) {
 824         Intent loginIntent = new Intent(this, LoginActivity.class);
 825         if (signInFirst)
 826             loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 827         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 828     }
 829 
 830 
 831     @Override
 832     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 833         super.onActivityResult(requestCode, resultCode, data);
 834         switch (requestCode) {
 835             case Simplenote.INTENT_PREFERENCES:
 836                 if (ThemeUtils.themeWasChanged(data)) {
 837                     // Restart this activity to apply the new theme
 838                     recreate();
 839                     break;
 840                 }
<abbr title=" 841                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 841                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 842                 invalidateOptionsMenu();
 843                 NoteListFragment fragment = getNoteListFragment();
 844                 if (fragment != null) {
 845                     fragment.getPrefs();
 846                     fragment.refreshList();
 847                 }
 848                 break;
 849             case Simplenote.INTENT_EDIT_NOTE:
<abbr title=" 850                 if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {"> 850                 if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID))ðŸ”µ</abbr>
 851                     String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 852                     if (noteId != null) {
 853                         List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 854                         deletedNoteIds.add(noteId);
 855                         mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 856                         mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
 857                     }
 858                 }
 859                 break;
 860             case Simperium.SIGNUP_SIGNIN_REQUEST:
 861                 invalidateOptionsMenu();
 862                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 863                     finish();
 864                 }
 865                 break;
 866         }
 867     }
 868 
 869     @Override
 870     public void onUndo(Parcelable p) {
 871         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 872         if (mUndoBarController != null &amp;&amp; deletedNoteIds != null) {
 873 
 874             for (int i=0; i &lt; deletedNoteIds.size(); i++) {
 875                 Note deletedNote = null;
 876                 try {
 877                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 878                 } catch (BucketObjectMissingException e) {
 879                     return;
 880                 }
 881                 if (deletedNote != null) {
 882                     deletedNote.setDeleted(false);
 883                     deletedNote.setModificationDate(Calendar.getInstance());
 884                     deletedNote.save();
 885                     NoteListFragment fragment = getNoteListFragment();
 886                     if (fragment != null) {
 887                         fragment.getPrefs();
 888                         fragment.refreshList();
 889                     }
 890                 }
 891             }
 892         }
 893     }
 894 
 895     @Override
 896     protected void onPostCreate(Bundle savedInstanceState) {
 897         super.onPostCreate(savedInstanceState);
 898         // Sync the toggle state after onRestoreInstanceState has occurred.
 899         mDrawerToggle.syncState();
 900     }
 901 
 902     @Override
 903     public void onConfigurationChanged(Configuration newConfig) {
 904         super.onConfigurationChanged(newConfig);
 905 
 906         mDrawerToggle.onConfigurationChanged(newConfig);
 907 
 908         if (mIsLargeScreen) {
 909             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 910                 // Add the editor fragment
 911                 mIsLandscape = true;
 912                 addEditorFragment();
 913                 if (mNoteListFragment != null) {
 914                     mNoteListFragment.setActivateOnItemClick(true);
 915                     mNoteListFragment.setDividerVisible(true);
 916                 }
 917                 // Select the current note on a tablet
 918                 if (mCurrentNote != null)
 919                     onNoteSelected(mCurrentNote.getSimperiumKey(), false, null);
 920                 else {
 921                     mNoteEditorFragment.setPlaceholderVisible(true);
 922                     mNoteListFragment.getListView().clearChoices();
 923                 }
 924                 invalidateOptionsMenu();
<abbr title=" 925             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {"> 925             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragmentðŸ”µ</abbr>
 926                 // Remove the editor fragment when rotating back to portrait
 927                 mIsLandscape = false;
 928                 mCurrentNote = null;
 929                 if (mNoteListFragment != null) {
 930                     mNoteListFragment.setActivateOnItemClick(false);
 931                     mNoteListFragment.setDividerVisible(false);
 932                     mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 933                     mNoteListFragment.refreshList();
 934                 }
 935                 FragmentManager fm = getFragmentManager();
 936                 FragmentTransaction ft = fm.beginTransaction();
 937                 ft.remove(mNoteEditorFragment);
 938                 mNoteEditorFragment = null;
 939                 ft.commitAllowingStateLoss();
 940                 fm.executePendingTransactions();
 941                 invalidateOptionsMenu();
 942             }
 943         }
 944     }
 945 
 946     public void checkEmptyListText(boolean isSearch) {
 947         if (isSearch) {
<abbr title=" 948             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);"> 948             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
 949             getNoteListFragment().setEmptyListViewClickable(false);
 950         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title=" 951             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);"> 951             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
 952             mTracker.send(
 953                     new HitBuilders.EventBuilder()
 954                             .setCategory(&quot;user&quot;)
 955                             .setAction(&quot;viewed_trash&quot;)
 956                             .setLabel(&quot;trash_filter_selected&quot;)
 957                             .build()
 958             );
 959             getNoteListFragment().setEmptyListViewClickable(false);
 960         } else {
<abbr title=" 961             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 961             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
 962             getNoteListFragment().setEmptyListViewClickable(true);
 963         }
 964     }
 965 
 966     public void showDetailPlaceholder() {
 967         if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 968             mCurrentNote = null;
 969             mNoteEditorFragment.setPlaceholderVisible(true);
 970             invalidateOptionsMenu();
 971         }
 972     }
 973 
 974     public void stopListeningToNotesBucket() {
 975         mNotesBucket.removeOnNetworkChangeListener(this);
 976         mNotesBucket.removeOnSaveObjectListener(this);
 977         mNotesBucket.removeOnDeleteObjectListener(this);
 978     }
 979 
 980     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
 981         if (mUndoBarController != null) {
 982             mUndoBarController.setDeletedNoteIds(noteIds);
<abbr title=" 983             mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()), null);"> 983             mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_noteðŸ”µ</abbr>
 984         }
 985     }
 986 
 987     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 988 
 989         @Override
 990         protected Void doInBackground(Void... voids) {
 991             Simplenote application = (Simplenote) getApplication();
 992             Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 993             Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 994             Bucket.ObjectCursor c = query.execute();
 995             while (c.moveToNext()) {
 996                 c.getObject().delete();
 997             }
 998             return null;
 999         }
1000 
1001         @Override
1002         protected void onPostExecute(Void nada) {
1003             showDetailPlaceholder();
1004         }
1005     }
1006 
1007 }
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.AlertDialog;
   5 import android.app.FragmentManager;
   6 import android.app.FragmentTransaction;
   7 import android.content.DialogInterface;
   8 import android.content.Intent;
   9 import android.content.SharedPreferences;
  10 import android.content.res.Configuration;
  11 import android.os.AsyncTask;
  12 import android.os.Build;
  13 import android.os.Bundle;
  14 import android.os.Parcelable;
  15 import android.preference.PreferenceManager;
  16 import android.support.v4.view.MenuItemCompat;
  17 import android.support.v4.widget.DrawerLayout;
  18 import android.support.v7.app.ActionBar;
  19 import android.support.v7.app.ActionBarActivity;
  20 import android.support.v7.app.ActionBarDrawerToggle;
  21 import android.support.v7.widget.SearchView;
  22 import android.support.v7.widget.Toolbar;
  23 import android.text.Spannable;
  24 import android.text.SpannableString;
  25 import android.text.TextUtils;
  26 import android.view.Gravity;
  27 import android.view.Menu;
  28 import android.view.MenuInflater;
  29 import android.view.MenuItem;
  30 import android.view.View;
  31 import android.view.Window;
  32 import android.widget.AdapterView;
  33 import android.widget.ListView;
  34 import com.automattic.simplenote.models.Note;
  35 import com.automattic.simplenote.models.Tag;
  36 import com.automattic.simplenote.utils.PrefUtils;
  37 import com.automattic.simplenote.utils.TagsAdapter;
  38 import com.automattic.simplenote.utils.ThemeUtils;
  39 import com.automattic.simplenote.utils.UndoBarController;
  40 import com.automattic.simplenote.widgets.FloatingActionButton;
  41 import com.automattic.simplenote.widgets.TypefaceSpan;
  42 import com.google.android.gms.analytics.HitBuilders;
  43 import com.google.android.gms.analytics.Tracker;
  44 import com.simperium.Simperium;
  45 import com.simperium.android.LoginActivity;
  46 import com.simperium.client.Bucket;
  47 import com.simperium.client.BucketObjectMissingException;
  48 import com.simperium.client.BucketObjectNameInvalid;
  49 import com.simperium.client.Query;
  50 import com.simperium.client.User;
  51 import java.util.ArrayList;
  52 import java.util.Calendar;
  53 import java.util.List;
  54 
  55 
<abbr title="  56 public class NotesActivity extends ActionBarActivity implements NoteListFragment.Callbacks , User.StatusChangeListener , Simperium.OnUserCreatedListener , UndoBarController.UndoListener , Bucket.Listener&lt;Note&gt; {">  56 public class NotesActivity extends ActionBarActivity implements NoteListFragment.Callbacks , User.StatusCðŸ”µ</abbr>
  57     private boolean mIsLargeScreen;
  58 
  59     private boolean mIsLandscape;
  60 
  61     private boolean mShouldSelectNewNote;
  62 
  63     private String mTabletSearchQuery;
  64 
  65     private UndoBarController mUndoBarController;
  66 
  67     private SearchView mSearchView;
  68 
  69     private MenuItem mSearchMenuItem;
  70 
  71     private NoteListFragment mNoteListFragment;
  72 
  73     private NoteEditorFragment mNoteEditorFragment;
  74 
  75     private Note mCurrentNote;
  76 
  77     protected Bucket&lt;Note&gt; mNotesBucket;
  78 
  79     protected Bucket&lt;Tag&gt; mTagsBucket;
  80 
  81     private int TRASH_SELECTED_ID = 1;
  82 
  83     private ActionBar mActionBar;
  84 
  85     private MenuItem mEmptyTrashMenuItem;
  86 
  87     // Menu drawer
  88     // Menu drawer
  89     private DrawerLayout mDrawerLayout;
  90 
  91     private ListView mDrawerList;
  92 
  93     private ActionBarDrawerToggle mDrawerToggle;
  94 
  95     private TagsAdapter mTagsAdapter;
  96 
  97     private TagsAdapter.TagMenuItem mSelectedTag;
  98 
  99     private CharSequence mActionBarTitle;
 100 
 101     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
 102 
 103     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
 104 
 105     // Google Analytics tracker
 106     private Tracker mTracker;
 107 
 108     @Override
 109     protected void onCreate(Bundle savedInstanceState) {
 110         supportRequestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);
 111 
 112         ThemeUtils.setTheme(this);
 113 
 114         super.onCreate(savedInstanceState);
 115         Simplenote currentApp = (Simplenote) getApplication();
 116 
 117         if (mNotesBucket == null)
 118             mNotesBucket = currentApp.getNotesBucket();
 119 
 120         if (mTagsBucket == null)
 121             mTagsBucket = currentApp.getTagsBucket();
 122 
 123         setContentView(R.layout.activity_notes);
 124 
 125 
 126 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127         Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128         setSupportActionBar(toolbar);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         EasyTracker.getInstance().activityStart(this);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         mTracker = EasyTracker.getTracker();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132 </span>
 133 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 134 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 134 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 135 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137         mTracker = currentApp.getTracker();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138 </span>
 139 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 140 
 141         if (savedInstanceState == null) {
 142             mNoteListFragment = new NoteListFragment();
 143             FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
 144             fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
 145             fragmentTransaction.commit();
 146         } else {
 147             mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 148         }
 149 
 150         Configuration config = getBaseContext().getResources().getConfiguration();
 151         if ((config.screenLayout
 152                 &amp; Configuration.SCREENLAYOUT_SIZE_MASK)
 153                 &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {
 154             mIsLargeScreen = true;
 155 
 156             if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 157                 mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 157                 mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTðŸ”µ</abbr>
 158             } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 159                 mIsLandscape = true;
 160                 addEditorFragment();
 161             }
 162         }
 163 
 164         // Set up the menu drawer
 165         mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);
 166         mDrawerList = (ListView) findViewById(R.id.left_drawer);
 167         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 168         mDrawerList.setAdapter(mTagsAdapter);
 169         // Set the list&#x27;s click listener
 170         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 171 
 172         if (mSelectedTag == null)
 173             mSelectedTag = mTagsAdapter.getDefaultItem();
 174 
 175         mDrawerToggle = new ActionBarDrawerToggle(
 176                 this,  mDrawerLayout, toolbar,
 177                 R.string.open_drawer, R.string.close_drawer
 178         ) {
 179             public void onDrawerClosed(View view) {
 180                 setTitle(mActionBarTitle);
 181                 invalidateOptionsMenu();
 182             }
 183 
 184             public void onDrawerOpened(View drawerView) {
 185                 setTitleWithCustomFont(getString(R.string.app_name));
 186                 invalidateOptionsMenu();
 187             }
 188         };
 189         mDrawerLayout.setDrawerListener(mDrawerToggle);
 190 
 191         // enable ActionBar app icon to behave as action to toggle nav drawer
 192         mActionBar = getSupportActionBar();
 193         mActionBar.setDisplayHomeAsUpEnabled(true);
 194         mActionBar.setHomeButtonEnabled(true);
 195 
 196         mDrawerLayout.setDrawerListener(mDrawerToggle);
 197 
 198         mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);
 199 
 200         FloatingActionButton fabButton = new FloatingActionButton.Builder(this)
 201                 .withDrawable(getResources().getDrawable(R.drawable.ic_create_white))
 202                 .withButtonColor(getResources().getColor(R.color.simplenote_blue))
 203                 .withGravity(Gravity.BOTTOM | Gravity.RIGHT)
 204                 .withMargins(0, 0, 16, 16)
 205                 .create();
 206 
 207         fabButton.setOnClickListener(new View.OnClickListener() {
 208             @Override
 209             public void onClick(View v) {
 210                 if (getNoteListFragment() != null) {
 211                     getNoteListFragment().addNote();
 212                     mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;action_bar_button&quot;, null);
 213                 }
 214             }
 215         });
 216 
 217         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 218             // Create the welcome note
 219             try {
 220                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 221                 welcomeNote.setCreationDate(Calendar.getInstance());
 222                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 223                 welcomeNote.setContent(getString(R.string.welcome_note));
 224                 welcomeNote.getTitle();
 225                 welcomeNote.save();
 226             } catch (BucketObjectNameInvalid e) {
 227                 // this won&#x27;t happen because welcome-android is a valid name
 228             }
 229 
 230             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 231             SharedPreferences.Editor editor = preferences.edit();
 232             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 233             editor.commit();
 234         }
 235 
 236         if (Intent.ACTION_SEND.equals(getIntent().getAction())) {
 237             // Check share action
 238             Intent intent = getIntent();
 239             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 240             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 241             if (text != null &amp;&amp; !text.equals(&quot;&quot;)) {
 242                 if (subject != null &amp;&amp; !subject.equals(&quot;&quot;)) {
 243                     text = subject + &quot;\n\n&quot; + text;
 244                 }
 245                 Note note = mNotesBucket.newObject();
 246                 note.setCreationDate(Calendar.getInstance());
 247                 note.setModificationDate(note.getCreationDate());
 248                 note.setContent(text);
 249                 note.save();
 250                 setCurrentNote(note);
 251                 mShouldSelectNewNote = true;
 252                 mTracker.send(
 253                         new HitBuilders.EventBuilder()
 254                                 .setCategory(&quot;note&quot;)
 255                                 .setAction(&quot;create_note&quot;)
 256                                 .setLabel(&quot;external_share&quot;)
 257                                 .build()
 258                 );
 259             }
 260         }
 261         currentApp.getSimperium().setOnUserCreatedListener(this);
 262         currentApp.getSimperium().setUserStatusChangeListener(this);
 263         setProgressBarIndeterminateVisibility(false);
 264     }
 265 
 266     @Override
 267     protected void onResume() {
 268         super.onResume();
 269         // Ensure user has valid authorization
 270         if (userAuthenticationIsInvalid()) {
 271             startLoginActivity(true);
 272         }
 273         mNotesBucket.start();
 274         mTagsBucket.start();
 275         mNotesBucket.addOnNetworkChangeListener(this);
 276         mNotesBucket.addOnSaveObjectListener(this);
 277         mNotesBucket.addOnDeleteObjectListener(this);
 278         mTagsBucket.addListener(mTagsMenuUpdater);
 279         updateNavigationDrawerItems();
 280         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 281         Simplenote currentApp = ((Simplenote) (getApplication()));
 282         if (currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED) {
 283             if ((-1) == mTagsAdapter.getPosition(mSelectedTag)) {
 284                 mSelectedTag = null;
 285                 mDrawerList.setSelection(mTagsAdapter.DEFAULT_ITEM_POSITION);
 286             }
 287         }
 288         setSelectedTagActive();
 289         if ((mCurrentNote != null) &amp;&amp; mShouldSelectNewNote) {
 290             onNoteSelected(mCurrentNote.getSimperiumKey(), true, null);
 291             mShouldSelectNewNote = false;
 292         }
 293     }
 294 
 295     @Override
 296     protected void onPause() {
 297         super.onPause();
 298         mTagsBucket.removeListener(mTagsMenuUpdater);
 299         mNotesBucket.removeOnNetworkChangeListener(this);
 300         mNotesBucket.removeOnSaveObjectListener(this);
 301         mNotesBucket.removeOnDeleteObjectListener(this);
 302     }
 303 
 304     @Override
 305     public void setTitle(CharSequence title) {
 306         mActionBarTitle = (title != null) ? title : &quot;&quot;;
 307         setTitleWithCustomFont(mActionBarTitle);
 308     }
 309 
 310     private void setTitleWithCustomFont(CharSequence title) {
 311         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
<abbr title=" 312         if (((!TextUtils.isEmpty(Build.BRAND)) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;)) &amp;&amp; (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN)) {"> 312         if (((!TextUtils.isEmpty(Build.BRAND)) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;)) &amp;&amp; (Build.VEðŸ”µ</abbr>
 313             mActionBar.setTitle(title);
 314             return;
 315         }
 316         SpannableString s = new SpannableString(title);
 317         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 318         mActionBar.setTitle(s);
 319     }
 320 
 321     private void updateNavigationDrawerItems() {
 322         Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 323         mTagsAdapter.changeCursor(tagCursor);
 324     }
 325 
 326     private void setSelectedTagActive() {
 327         if (mSelectedTag == null)
 328             mSelectedTag = mTagsAdapter.getDefaultItem();
 329 
 330         setTitle(mSelectedTag.name);
 331         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag), true);
 332     }
 333 
 334     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 335     public void updateTrashMenuItem() {
 336         if (mEmptyTrashMenuItem == null)
 337             return;
 338         // Disable the trash icon if there are no notes trashed.
 339         Simplenote application = (Simplenote) getApplication();
 340         Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 341         Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 342         if (query.count() == 0) {
 343             mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash_disabled);
 344             mEmptyTrashMenuItem.setEnabled(false);
 345         } else {
 346             mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash);
 347             mEmptyTrashMenuItem.setEnabled(true);
 348         }
 349     }
 350 
 351     /* The click listener for ListView in the navigation drawer */
 352     private class DrawerItemClickListener implements ListView.OnItemClickListener {
 353         @Override
 354         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 355             mSelectedTag = mTagsAdapter.getItem(position);
 356             checkEmptyListText(false);
 357             // Update checked item in navigation drawer and close it
 358             setSelectedTagActive();
 359             mDrawerLayout.closeDrawer(mDrawerList);
 360             // Disable long press on notes if we&#x27;re viewing the trash
 361             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 362                 getNoteListFragment().getListView().setLongClickable(false);
 363             } else {
 364                 getNoteListFragment().getListView().setLongClickable(true);
 365             }
 366             getNoteListFragment().refreshListFromNavSelect();
 367             if (position &gt; 1) {
<abbr title=" 368                 mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;tag&quot;).setAction(&quot;viewed_notes_for_tag&quot;).setLabel(&quot;selected_tag_in_navigation_drawer&quot;).build());"> 368                 mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;tag&quot;).setAction(&quot;viewed_notes_fðŸ”µ</abbr>
 369             }
 370         }
 371     }
 372 
 373     public TagsAdapter.TagMenuItem getSelectedTag() {
 374         return mSelectedTag;
 375     }
 376 
 377     private void addEditorFragment() {
 378         FragmentManager fm = getFragmentManager();
 379         FragmentTransaction ft = fm.beginTransaction();
 380         mNoteEditorFragment = new NoteEditorFragment();
 381         ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 382         ft.commitAllowingStateLoss();
 383         fm.executePendingTransactions();
 384     }
 385 
 386     /**
 387      * Checks for a previously valid user that is now not authenticated
 388      *
 389      * @return true if user has invalid authorization
 390      */
 391     private boolean userAuthenticationIsInvalid() {
 392         Simplenote currentApp = (Simplenote) getApplication();
 393         Simperium simperium = currentApp.getSimperium();
 394         User user = simperium.getUser();
 395         return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 396     }
 397 
 398     public void setCurrentNote(Note note) {
 399         mCurrentNote = note;
 400     }
 401 
 402     // received a change from the network, refresh the list
 403     @Override
 404     public void onChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
 405         runOnUiThread(new Runnable() {
 406             @Override
 407             public void run() {
 408                 if (type == Bucket.ChangeType.INDEX)
 409                     setProgressBarIndeterminateVisibility(false);
 410                 mNoteListFragment.refreshList();
 411             }
 412         });
 413     }
 414 
 415     @Override
 416     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 417         runOnUiThread(new Runnable() {
 418             @Override
 419             public void run() {
 420                 mNoteListFragment.refreshList();
 421             }
 422         });
 423     }
 424 
 425     @Override
 426     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 427         runOnUiThread(new Runnable() {
 428             @Override
 429             public void run() {
 430                 mNoteListFragment.refreshList();
 431             }
 432         });
 433     }
 434 
 435     @Override
 436     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 437 
 438         // noop, NoteEditorFragment will handle this
 439 
 440     }
 441 
 442     // Tags bucket listener
 443     // Tags bucket listener
 444     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 445         void updateNavigationDrawer() {
 446             runOnUiThread(new Runnable() {
 447                 public void run() {
 448                     updateNavigationDrawerItems();
 449                 }
 450             });
 451         }
 452 
 453         @Override
 454         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 455             updateNavigationDrawer();
 456         }
 457 
 458         @Override
 459         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 460             updateNavigationDrawer();
 461         }
 462 
 463         @Override
 464         public void onChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 465             updateNavigationDrawer();
 466         }
 467 
 468         @Override
 469         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 470             // noop
 471         }
 472     };
 473 
 474     public boolean isLargeScreenLandscape() {
 475         return mIsLargeScreen &amp;&amp; mIsLandscape;
 476     }
 477 
 478     // nbradbury 01-Apr-2013
 479     public NoteListFragment getNoteListFragment() {
 480         return mNoteListFragment;
 481     }
 482 
 483     @Override
 484     public boolean onCreateOptionsMenu(Menu menu) {
 485         super.onCreateOptionsMenu(menu);
 486         MenuInflater inflater = getMenuInflater();
 487         inflater.inflate(R.menu.notes_list, menu);
 488         boolean drawerOpen = mDrawerLayout.isDrawerOpen(mDrawerList);
 489         // restore the search query if on a landscape tablet
 490         String searchQuery = null;
 491         if (isLargeScreenLandscape() &amp;&amp; (mSearchView != null)) {
 492             searchQuery = mSearchView.getQuery().toString();
 493         }
 494         mSearchMenuItem = menu.findItem(R.id.menu_search);
 495         mSearchView = ((SearchView) (mSearchMenuItem.getActionView()));
 496         if (!TextUtils.isEmpty(searchQuery)) {
 497             mSearchView.setQuery(searchQuery, false);
 498             mSearchMenuItem.expandActionView();
 499         }
 500         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 501             @Override
 502             public boolean onQueryTextChange(String newText) {
 503                 if (mSearchMenuItem.isActionViewExpanded()) {
 504                     getNoteListFragment().searchNotes(newText);
 505                 }
 506                 return true;
 507             }
 508 
 509             @Override
 510             public boolean onQueryTextSubmit(String queryText) {
 511                 getNoteListFragment().searchNotes(queryText);
 512                 return true;
 513             }
 514         });
<abbr title=" 515         MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListener() {"> 515         MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListenðŸ”µ</abbr>
 516             @Override
 517             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 518                 checkEmptyListText(true);
 519                 getNoteListFragment().hideWelcomeView();
<abbr title=" 520                 mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;searched_notes&quot;).setLabel(&quot;action_bar_search_tap&quot;).build());"> 520                 mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;searched_noteðŸ”µ</abbr>
 521                 return true;
 522             }
 523 
 524             @Override
 525             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 526                 // Show all notes again
 527                 mTabletSearchQuery = &quot;&quot;;
 528                 mSearchView.setQuery(&quot;&quot;, false);
 529                 checkEmptyListText(false);
 530                 getNoteListFragment().clearSearch();
 531                 getNoteListFragment().setWelcomeViewVisibility();
 532                 return true;
 533             }
 534         });
 535         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 536             @Override
 537             public boolean onMenuItemClick(MenuItem item) {
 538                 if (!mSearchMenuItem.isActionViewExpanded()) {
 539                     showDetailPlaceholder();
 540                 }
 541                 return false;
 542             }
 543         });
 544         // Restore the search query on landscape tablets
 545         if (isLargeScreenLandscape() &amp;&amp; (!TextUtils.isEmpty(mTabletSearchQuery))) {
 546             mSearchView.setQuery(mTabletSearchQuery, false);
 547             mSearchMenuItem.expandActionView();
 548             mSearchView.clearFocus();
 549         }
 550         Simplenote currentApp = ((Simplenote) (getApplication()));
 551         menu.findItem(R.id.menu_sign_in).setVisible(currentApp.getSimperium().needsAuthorization());
 552         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 553         if ((mCurrentNote != null) &amp;&amp; mCurrentNote.isDeleted()) {
 554             trashItem.setTitle(R.string.undelete);
 555         } else {
 556             trashItem.setTitle(R.string.delete);
 557         }
 558         if (isLargeScreenLandscape()) {
 559             menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 560             menu.findItem(R.id.menu_preferences).setVisible(true);
 561             if (mCurrentNote != null) {
 562                 menu.findItem(R.id.menu_share).setVisible(!drawerOpen);
 563                 trashItem.setVisible(true);
 564             } else {
 565                 menu.findItem(R.id.menu_share).setVisible(false);
 566                 trashItem.setVisible(false);
 567             }
 568             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 569             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 570         } else {
 571             menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 572             menu.findItem(R.id.menu_preferences).setVisible(true);
 573             menu.findItem(R.id.menu_share).setVisible(false);
 574             trashItem.setVisible(false);
 575             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 576             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 577         }
 578         // Are we looking at the trash? Adjust menu accordingly.
 579         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 580             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 581             mEmptyTrashMenuItem.setVisible(!drawerOpen);
 582             updateTrashMenuItem();
 583             menu.findItem(R.id.menu_search).setVisible(false);
 584             menu.findItem(R.id.menu_share).setVisible(false);
 585         }
 586         return true;
 587     }
 588 
 589     @Override
 590     public boolean onOptionsItemSelected(MenuItem item) {
 591         if (mDrawerToggle.onOptionsItemSelected(item)) {
 592             return true;
 593         }
 594         switch (item.getItemId()) {
 595             case R.id.menu_preferences :
<abbr title=" 596                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 596                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returnðŸ”µ</abbr>
 597                 Intent i = new Intent(this, PreferencesActivity.class);
 598                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 599                 return true;
 600             case R.id.menu_sign_in :
 601                 startLoginActivity(true);
 602                 return true;
 603             case R.id.menu_edit_tags :
 604                 Intent editTagsIntent = new Intent(this, TagsActivity.class);
 605                 startActivity(editTagsIntent);
 606                 return true;
 607             case R.id.menu_share :
 608                 if (mCurrentNote != null) {
 609                     Intent shareIntent = new Intent(Intent.ACTION_SEND);
 610                     shareIntent.setType(&quot;text/plain&quot;);
 611                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 612                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 612                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
<abbr title=" 613                     mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;shared_note&quot;).setLabel(&quot;action_bar_share_button&quot;).build());"> 613                     mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;shared_noðŸ”µ</abbr>
 614                 }
 615                 return true;
 616             case R.id.menu_delete :
 617                 if (mNoteEditorFragment != null) {
 618                     if (mCurrentNote != null) {
 619                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 620                         mCurrentNote.setModificationDate(Calendar.getInstance());
 621                         mCurrentNote.save();
 622                         if (mCurrentNote.isDeleted()) {
 623                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 624                             deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 625                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 626                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);"> 626                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null)ðŸ”µ</abbr>
<abbr title=" 627                             mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;deleted_note&quot;).setLabel(&quot;overflow_menu&quot;).build());"> 627                             mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;dðŸ”µ</abbr>
 628                         } else {
<abbr title=" 629                             mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;restored_note&quot;).setLabel(&quot;overflow_menu&quot;).build());"> 629                             mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;rðŸ”µ</abbr>
 630                         }
 631                         showDetailPlaceholder();
 632                     }
 633                     NoteListFragment fragment = getNoteListFragment();
 634                     if (fragment != null) {
 635                         fragment.getPrefs();
 636                         fragment.refreshList();
 637                     }
 638                 }
 639                 return true;
 640             case R.id.menu_empty_trash :
 641                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 642                 alert.setTitle(R.string.empty_trash);
 643                 alert.setMessage(R.string.confirm_empty_trash);
 644                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 645                     public void onClick(DialogInterface dialog, int whichButton) {
 646                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
<abbr title=" 647                         mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;trash_emptied&quot;).setLabel(&quot;overflow_menu&quot;).build());"> 647                         mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;trashðŸ”µ</abbr>
 648                     }
 649                 });
 650                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 651                     public void onClick(DialogInterface dialog, int whichButton) {
 652                         // Do nothing, just closing the dialog
 653                     }
 654                 });
 655                 alert.show();
 656                 return true;
 657             case android.R.id.home :
 658                 invalidateOptionsMenu();
 659                 return true;
 660             default :
 661                 return super.onOptionsItemSelected(item);
 662         }
 663     }
 664 
 665     /**
 666      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 667      * the item with the given ID was selected.
 668      */
 669     @Override
 670     public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {
 671         if (!isLargeScreenLandscape()) {
 672             // Launch the editor activity
 673             Bundle arguments = new Bundle();
 674             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 675             arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);
 676             if (matchOffsets != null) {
 677                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 678             }
 679             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 680             editNoteIntent.putExtras(arguments);
 681             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 682         } else {
 683             mNoteEditorFragment.setIsNewNote(isNew);
 684             mNoteEditorFragment.setNote(noteID, matchOffsets);
 685             getNoteListFragment().setNoteSelected(noteID);
 686             if ((mSearchView != null) &amp;&amp; (mSearchView.getQuery().length() &gt; 0)) {
 687                 mTabletSearchQuery = mSearchView.getQuery().toString();
 688             }
 689             invalidateOptionsMenu();
 690         }
<abbr title=" 691         mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;viewed_note&quot;).setLabel(&quot;note_list_row_tap&quot;).build());"> 691         mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;viewed_note&quot;).setLabeðŸ”µ</abbr>
 692     }
 693 
 694     @Override
 695     public void onUserCreated(User user) {
 696         // New account created
<abbr title=" 697         mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;user&quot;).setAction(&quot;new_account_created&quot;).setLabel(&quot;account_created_from_login_activity&quot;).build());"> 697         mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;user&quot;).setAction(&quot;new_account_created&quot;)ðŸ”µ</abbr>
 698     }
 699 
 700     public void onUserStatusChange(User.Status status) {
 701         switch (status) {
 702             // successfully used access token to connect to simperium bucket
 703             case AUTHORIZED :
<abbr title=" 704                 mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;user&quot;).setAction(&quot;signed_in&quot;).setLabel(&quot;signed_in_from_login_activity&quot;).build());"> 704                 mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;user&quot;).setAction(&quot;signed_in&quot;).sðŸ”µ</abbr>
 705                 runOnUiThread(new Runnable() {
 706                     @Override
 707                     public void run() {
 708                         if (!mNotesBucket.hasChangeVersion()) {
 709                             setProgressBarIndeterminateVisibility(true);
 710                         }
 711                     }
 712                 });
 713                 break;
 714             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 715             case NOT_AUTHORIZED :
 716                 runOnUiThread(new Runnable() {
 717                     @Override
 718                     public void run() {
 719                         startLoginActivity(true);
 720                     }
 721                 });
 722                 break;
<abbr title=" 723                 // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 723                 // Default starting state of User, don&#x27;t do anything we allow use of app while not signedðŸ”µ</abbr>
 724             case UNKNOWN :
 725                 break;
 726         }
 727     }
 728 
 729     public void startLoginActivity(boolean signInFirst) {
 730         Intent loginIntent = new Intent(this, LoginActivity.class);
 731         if (signInFirst)
 732             loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 733         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 734     }
 735 
 736     @Override
 737     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 738         super.onActivityResult(requestCode, resultCode, data);
 739         switch (requestCode) {
 740             case Simplenote.INTENT_PREFERENCES :
 741                 if (ThemeUtils.themeWasChanged(data)) {
 742                     // Restart this activity to apply the new theme
 743                     recreate();
 744                     break;
 745                 }
<abbr title=" 746                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 746                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 747                 invalidateOptionsMenu();
 748                 NoteListFragment fragment = getNoteListFragment();
 749                 if (fragment != null) {
 750                     fragment.getPrefs();
 751                     fragment.refreshList();
 752                 }
 753                 break;
 754             case Simplenote.INTENT_EDIT_NOTE :
<abbr title=" 755                 if (((resultCode == RESULT_OK) &amp;&amp; (data != null)) &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {"> 755                 if (((resultCode == RESULT_OK) &amp;&amp; (data != null)) &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTðŸ”µ</abbr>
 756                     String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 757                     if (noteId != null) {
 758                         List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 759                         deletedNoteIds.add(noteId);
 760                         mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 761                         mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
 762                     }
 763                 }
 764                 break;
 765             case Simperium.SIGNUP_SIGNIN_REQUEST :
 766                 invalidateOptionsMenu();
 767                 if ((resultCode == Activity.RESULT_CANCELED) &amp;&amp; userAuthenticationIsInvalid()) {
 768                     finish();
 769                 }
 770                 break;
 771         }
 772     }
 773 
 774     @Override
 775     public void onUndo(Parcelable p) {
 776         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 777         if (mUndoBarController != null &amp;&amp; deletedNoteIds != null) {
 778 
 779             for (int i=0; i &lt; deletedNoteIds.size(); i++) {
 780                 Note deletedNote = null;
 781                 try {
 782                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 783                 } catch (BucketObjectMissingException e) {
 784                     return;
 785                 }
 786                 if (deletedNote != null) {
 787                     deletedNote.setDeleted(false);
 788                     deletedNote.setModificationDate(Calendar.getInstance());
 789                     deletedNote.save();
 790                     NoteListFragment fragment = getNoteListFragment();
 791                     if (fragment != null) {
 792                         fragment.getPrefs();
 793                         fragment.refreshList();
 794                     }
 795                 }
 796             }
 797         }
 798     }
 799 
 800     @Override
 801     protected void onPostCreate(Bundle savedInstanceState) {
 802         super.onPostCreate(savedInstanceState);
 803         // Sync the toggle state after onRestoreInstanceState has occurred.
 804         mDrawerToggle.syncState();
 805     }
 806 
 807     @Override
 808     public void onConfigurationChanged(Configuration newConfig) {
 809         super.onConfigurationChanged(newConfig);
 810         mDrawerToggle.onConfigurationChanged(newConfig);
 811         if (mIsLargeScreen) {
 812             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 813                 // Add the editor fragment
 814                 mIsLandscape = true;
 815                 addEditorFragment();
 816                 if (mNoteListFragment != null) {
 817                     mNoteListFragment.setActivateOnItemClick(true);
 818                     mNoteListFragment.setDividerVisible(true);
 819                 }
 820                 // Select the current note on a tablet
 821                 if (mCurrentNote != null) {
 822                     onNoteSelected(mCurrentNote.getSimperiumKey(), false, null);
 823                 } else {
 824                     mNoteEditorFragment.setPlaceholderVisible(true);
 825                     mNoteListFragment.getListView().clearChoices();
 826                 }
 827                 invalidateOptionsMenu();
<abbr title=" 828             } else if ((newConfig.orientation == Configuration.ORIENTATION_PORTRAIT) &amp;&amp; (mNoteEditorFragment != null)) {"> 828             } else if ((newConfig.orientation == Configuration.ORIENTATION_PORTRAIT) &amp;&amp; (mNoteEditorFragmðŸ”µ</abbr>
 829                 // Remove the editor fragment when rotating back to portrait
 830                 mIsLandscape = false;
 831                 mCurrentNote = null;
 832                 if (mNoteListFragment != null) {
 833                     mNoteListFragment.setActivateOnItemClick(false);
 834                     mNoteListFragment.setDividerVisible(false);
 835                     mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 836                     mNoteListFragment.refreshList();
 837                 }
 838                 FragmentManager fm = getFragmentManager();
 839                 FragmentTransaction ft = fm.beginTransaction();
 840                 ft.remove(mNoteEditorFragment);
 841                 mNoteEditorFragment = null;
 842                 ft.commitAllowingStateLoss();
 843                 fm.executePendingTransactions();
 844                 invalidateOptionsMenu();
 845             }
 846         }
 847     }
 848 
 849     public void checkEmptyListText(boolean isSearch) {
 850         if (isSearch) {
<abbr title=" 851             getNoteListFragment().setEmptyListMessage((&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found)) + &quot;&lt;/strong&gt;&quot;);"> 851             getNoteListFragment().setEmptyListMessage((&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found)) +ðŸ”µ</abbr>
 852             getNoteListFragment().setEmptyListViewClickable(false);
 853         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title=" 854             getNoteListFragment().setEmptyListMessage((&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty)) + &quot;&lt;/strong&gt;&quot;);"> 854             getNoteListFragment().setEmptyListMessage((&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty)) +ðŸ”µ</abbr>
<abbr title=" 855             mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;user&quot;).setAction(&quot;viewed_trash&quot;).setLabel(&quot;trash_filter_selected&quot;).build());"> 855             mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;user&quot;).setAction(&quot;viewed_trash&quot;).seðŸ”µ</abbr>
 856             getNoteListFragment().setEmptyListViewClickable(false);
 857         } else {
<abbr title=" 858             getNoteListFragment().setEmptyListMessage(((&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here)) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot;) + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 858             getNoteListFragment().setEmptyListMessage(((&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here)) +ðŸ”µ</abbr>
 859             getNoteListFragment().setEmptyListViewClickable(true);
 860         }
 861     }
 862 
 863     public void showDetailPlaceholder() {
 864         if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 865             mCurrentNote = null;
 866             mNoteEditorFragment.setPlaceholderVisible(true);
 867             invalidateOptionsMenu();
 868         }
 869     }
 870 
 871     public void stopListeningToNotesBucket() {
 872         mNotesBucket.removeOnNetworkChangeListener(this);
 873         mNotesBucket.removeOnSaveObjectListener(this);
 874         mNotesBucket.removeOnDeleteObjectListener(this);
 875     }
 876 
 877     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
 878         if (mUndoBarController != null) {
 879             mUndoBarController.setDeletedNoteIds(noteIds);
<abbr title=" 880             mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()), null);"> 880             mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_noteðŸ”µ</abbr>
 881         }
 882     }
 883 
 884     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 885         @Override
 886         protected Void doInBackground(Void... voids) {
 887             Simplenote application = ((Simplenote) (getApplication()));
 888             Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 889             Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 890             Bucket.ObjectCursor c = query.execute();
 891             while (c.moveToNext()) {
 892                 c.getObject().delete();
 893             }
 894             return null;
 895         }
 896 
 897         @Override
 898         protected void onPostExecute(Void nada) {
 899             showDetailPlaceholder();
 900         }
 901     }
 902 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 -import android.app.ActionBar;</span>
   4  import android.app.Activity;
   5  import android.app.AlertDialog;
   6  import android.app.FragmentManager;
   7  import android.app.FragmentTransaction;
   8  import android.content.DialogInterface;
   9  import android.content.Intent;
  10  import android.content.SharedPreferences;
  11  import android.content.res.Configuration;
  12  import android.os.AsyncTask;
  13  import android.os.Build;
  14  import android.os.Bundle;
  15  import android.os.Parcelable;
  16  import android.preference.PreferenceManager;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 -import android.support.v4.app.ActionBarDrawerToggle;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +import android.support.v4.view.MenuItemCompat;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +import android.support.v7.app.ActionBarDrawerToggle;</span>
  20  import android.support.v4.widget.DrawerLayout;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import android.support.v7.app.ActionBar;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import android.support.v7.app.ActionBarActivity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import android.support.v7.widget.Toolbar;</span>
  24  import android.text.Spannable;
  25  import android.text.SpannableString;
  26  import android.text.TextUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import android.view.Gravity;</span>
  28  import android.view.Menu;
  29  import android.view.MenuInflater;
  30  import android.view.MenuItem;
  31  import android.view.View;
  32  import android.view.Window;
  33  import android.widget.AdapterView;
  34  import android.widget.ListView;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import android.widget.SearchView;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import android.support.v7.widget.SearchView;</span>
  37  
  38  import com.automattic.simplenote.models.Note;
  39  import com.automattic.simplenote.models.Tag;
  40  import com.automattic.simplenote.utils.PrefUtils;
  41  import com.automattic.simplenote.utils.TagsAdapter;
  42  import com.automattic.simplenote.utils.ThemeUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +import com.automattic.simplenote.widgets.FloatingActionButton;</span>
  44  import com.automattic.simplenote.widgets.TypefaceSpan;
  45  import com.automattic.simplenote.utils.UndoBarController;
  46  import com.google.analytics.tracking.android.EasyTracker;
  47  import com.google.analytics.tracking.android.Tracker;


  48  import com.simperium.Simperium;
  49  import com.simperium.android.LoginActivity;
  50  import com.simperium.client.Bucket;
  51  import com.simperium.client.BucketObjectMissingException;
  52  import com.simperium.client.BucketObjectNameInvalid;
  53  import com.simperium.client.Query;
  54  import com.simperium.client.User;
  55  
  56  import java.util.ArrayList;
  57  import java.util.Calendar;
  58  import java.util.List;
  59  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -public class NotesActivity extends Activity implements</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +public class NotesActivity extends ActionBarActivity implements</span>
<abbr title="  62          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  62          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  63          Bucket.Listener&lt;Note&gt; {
  64  
  65      private boolean mIsLargeScreen, mIsLandscape, mShouldSelectNewNote;
  66      private String mTabletSearchQuery;
  67      private UndoBarController mUndoBarController;
  68      private SearchView mSearchView;
  69      private MenuItem mSearchMenuItem;
  70      private NoteListFragment mNoteListFragment;
  71      private NoteEditorFragment mNoteEditorFragment;
  72      private Note mCurrentNote;
  73      protected Bucket&lt;Note&gt; mNotesBucket;
  74      protected Bucket&lt;Tag&gt; mTagsBucket;
  75      private int TRASH_SELECTED_ID = 1;
  76      private ActionBar mActionBar;
  77      private MenuItem mEmptyTrashMenuItem;
  78  
  79      // Menu drawer
  80      private DrawerLayout mDrawerLayout;
  81      private ListView mDrawerList;
  82      private ActionBarDrawerToggle mDrawerToggle;
  83      private TagsAdapter mTagsAdapter;
  84      private TagsAdapter.TagMenuItem mSelectedTag;
  85      private CharSequence mActionBarTitle;
  86  
  87      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  88      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  89  
  90      // Google Analytics tracker
  91      private Tracker mTracker;
  92  
  93      @Override
  94      protected void onCreate(Bundle savedInstanceState) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -        requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +        supportRequestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);</span>
  97  
  98          ThemeUtils.setTheme(this);
  99  
 100          super.onCreate(savedInstanceState);
 101          Simplenote currentApp = (Simplenote) getApplication();
 102  
 103          if (mNotesBucket == null)
 104              mNotesBucket = currentApp.getNotesBucket();
 105  
 106          if (mTagsBucket == null)
 107              mTagsBucket = currentApp.getTagsBucket();
 108  
 109          setContentView(R.layout.activity_notes);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +        Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +        setSupportActionBar(toolbar);</span>
 113  
 114          EasyTracker.getInstance().activityStart(this);
 115          mTracker = EasyTracker.getTracker();

 116  
 117          if (savedInstanceState == null) {
 118              mNoteListFragment = new NoteListFragment();
 119              FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
 120              fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
 121              fragmentTransaction.commit();
 122          } else {
 123              mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 124          }
 125  
 126          Configuration config = getBaseContext().getResources().getConfiguration();
 127          if ((config.screenLayout
 128                  &amp; Configuration.SCREENLAYOUT_SIZE_MASK)
 129                  &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {
 130              mIsLargeScreen = true;
 131  
 132              if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 133                  mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 133                  mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR)ðŸ”µ</abbr>
 134              } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 135                  mIsLandscape = true;
 136                  addEditorFragment();
 137              }
 138          }
 139  
 140          // Set up the menu drawer
 141          mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);
 142          mDrawerList = (ListView) findViewById(R.id.left_drawer);
 143          mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 144          mDrawerList.setAdapter(mTagsAdapter);
 145          // Set the list&#x27;s click listener
 146          mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 147  
 148          if (mSelectedTag == null)
 149              mSelectedTag = mTagsAdapter.getDefaultItem();
 150  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -        // enable ActionBar app icon to behave as action to toggle nav drawer</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -        mActionBar = getActionBar();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -        mActionBar.setDisplayHomeAsUpEnabled(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -        mActionBar.setHomeButtonEnabled(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -        // ActionBarDrawerToggle ties together the the proper interactions</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -        // between the sliding drawer and the action bar app icon</span>
 158          mDrawerToggle = new ActionBarDrawerToggle(
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -                this,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -                mDrawerLayout,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -                R.drawable.ic_drawer,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -                R.string.open_drawer,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -                R.string.close_drawer</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +                this,  mDrawerLayout, toolbar,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +                R.string.open_drawer, R.string.close_drawer</span>
 166          ) {
 167              public void onDrawerClosed(View view) {
 168                  setTitle(mActionBarTitle);
 169                  invalidateOptionsMenu();
 170              }
 171  
 172              public void onDrawerOpened(View drawerView) {
 173                  setTitleWithCustomFont(getString(R.string.app_name));
 174                  invalidateOptionsMenu();
 175              }
 176          };
 177          mDrawerLayout.setDrawerListener(mDrawerToggle);
 178  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +        // enable ActionBar app icon to behave as action to toggle nav drawer</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +        mActionBar = getSupportActionBar();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +        mActionBar.setDisplayHomeAsUpEnabled(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +        mActionBar.setHomeButtonEnabled(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +        mDrawerLayout.setDrawerListener(mDrawerToggle);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +</span>
 186          mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +        FloatingActionButton fabButton = new FloatingActionButton.Builder(this)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +                .withDrawable(getResources().getDrawable(R.drawable.ic_create_white))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +                .withButtonColor(getResources().getColor(R.color.simplenote_blue))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +                .withGravity(Gravity.BOTTOM | Gravity.RIGHT)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +                .withMargins(0, 0, 16, 16)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +                .create();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +        fabButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +            public void onClick(View v) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +                if (getNoteListFragment() != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +                    getNoteListFragment().addNote();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +                    mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;action_bar_button&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +        });</span>
 204  
 205          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 206              // Create the welcome note
 207              try {
 208                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 209                  welcomeNote.setCreationDate(Calendar.getInstance());
 210                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 211                  welcomeNote.setContent(getString(R.string.welcome_note));
 212                  welcomeNote.getTitle();
 213                  welcomeNote.save();
 214              } catch (BucketObjectNameInvalid e) {
 215                  // this won&#x27;t happen because welcome-android is a valid name
 216              }
 217  
 218              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 219              SharedPreferences.Editor editor = preferences.edit();
 220              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 221              editor.commit();
 222          }
 223  
 224          if (Intent.ACTION_SEND.equals(getIntent().getAction())) {
 225              // Check share action
 226              Intent intent = getIntent();
 227              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 228              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 229              if (text != null &amp;&amp; !text.equals(&quot;&quot;)) {
 230                  if (subject != null &amp;&amp; !subject.equals(&quot;&quot;)) {
 231                      text = subject + &quot;\n\n&quot; + text;
 232                  }
 233                  Note note = mNotesBucket.newObject();
 234                  note.setCreationDate(Calendar.getInstance());
 235                  note.setModificationDate(note.getCreationDate());
 236                  note.setContent(text);
 237                  note.save();
 238                  setCurrentNote(note);
 239                  mShouldSelectNewNote = true;
 240                  mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;external_share&quot;, null);







 241              }
 242          }
 243          currentApp.getSimperium().setOnUserCreatedListener(this);
 244          currentApp.getSimperium().setUserStatusChangeListener(this);
 245          setProgressBarIndeterminateVisibility(false);
 246      }
 247  
 248      @Override
 249      protected void onResume() {
 250          super.onResume();
 251  
 252          // Ensure user has valid authorization
 253          if (userAuthenticationIsInvalid())
 254              startLoginActivity(true);
 255  
 256          mNotesBucket.start();
 257          mTagsBucket.start();
 258  
 259          mNotesBucket.addOnNetworkChangeListener(this);
 260          mNotesBucket.addOnSaveObjectListener(this);
 261          mNotesBucket.addOnDeleteObjectListener(this);
 262          mTagsBucket.addListener(mTagsMenuUpdater);
 263  
 264          updateNavigationDrawerItems();
 265  
 266          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 267          Simplenote currentApp = (Simplenote)getApplication();
 268          if (currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED) {
 269              if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 270                  mSelectedTag = null;
 271                  mDrawerList.setSelection(mTagsAdapter.DEFAULT_ITEM_POSITION);
 272              }
 273          }
 274  
 275          setSelectedTagActive();
 276  
 277          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 278              onNoteSelected(mCurrentNote.getSimperiumKey(), true, null);
 279              mShouldSelectNewNote = false;
 280          }
 281      }
 282  
 283      @Override
 284      protected void onPause() {
 285          super.onPause();
 286  
 287          mTagsBucket.removeListener(mTagsMenuUpdater);
 288  
 289          mNotesBucket.removeOnNetworkChangeListener(this);
 290          mNotesBucket.removeOnSaveObjectListener(this);
 291          mNotesBucket.removeOnDeleteObjectListener(this);
 292      }
 293  
 294      @Override
 295      public void onStop() {
 296          super.onStop();
 297          EasyTracker.getInstance().activityStop(this);
 298      }
 299  
 300      @Override
 301      public void setTitle(CharSequence title) {
 302          mActionBarTitle = (title != null) ? title : &quot;&quot;;
 303          setTitleWithCustomFont(mActionBarTitle);
 304      }
 305  
 306      private void setTitleWithCustomFont(CharSequence title) {
 307          // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 308          if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 309                  &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 310              mActionBar.setTitle(title);
 311              return;
 312          }
 313  
 314          SpannableString s = new SpannableString(title);
 315          s.setSpan(new TypefaceSpan(this), 0, s.length(),
 316                  Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 317          mActionBar.setTitle(s);
 318      }
 319  
 320      private void updateNavigationDrawerItems() {
 321          Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 322          mTagsAdapter.changeCursor(tagCursor);
 323      }
 324  
 325      private void setSelectedTagActive() {
 326          if (mSelectedTag == null)
 327              mSelectedTag = mTagsAdapter.getDefaultItem();
 328  
 329          setTitle(mSelectedTag.name);
 330          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag), true);
 331      }
 332  
 333      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 334      public void updateTrashMenuItem() {
 335          if (mEmptyTrashMenuItem == null)
 336              return;
 337          // Disable the trash icon if there are no notes trashed.
 338          Simplenote application = (Simplenote) getApplication();
 339          Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 340          Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 341          if (query.count() == 0) {
 342              mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash_disabled);
 343              mEmptyTrashMenuItem.setEnabled(false);
 344          } else {
 345              mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash);
 346              mEmptyTrashMenuItem.setEnabled(true);
 347          }
 348      }
 349  
 350      /* The click listener for ListView in the navigation drawer */
 351      private class DrawerItemClickListener implements ListView.OnItemClickListener {
 352          @Override
 353          public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 354  
 355              mSelectedTag = mTagsAdapter.getItem(position);
 356              checkEmptyListText(false);
 357              // Update checked item in navigation drawer and close it
 358              setSelectedTagActive();
 359              mDrawerLayout.closeDrawer(mDrawerList);
 360  
 361              // Disable long press on notes if we&#x27;re viewing the trash
 362              if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 363                  getNoteListFragment().getListView().setLongClickable(false);
 364              } else {
 365                  getNoteListFragment().getListView().setLongClickable(true);
 366              }
 367  
 368              getNoteListFragment().refreshListFromNavSelect();
 369              if (position &gt; 1)
 370                  mTracker.sendEvent(&quot;tag&quot;, &quot;viewed_notes_for_tag&quot;, &quot;selected_tag_in_navigation_drawer&quot;, null);









 371          }
 372      }
 373  
 374      public TagsAdapter.TagMenuItem getSelectedTag() {
 375          return mSelectedTag;
 376      }
 377  
 378      private void addEditorFragment() {
 379          FragmentManager fm = getFragmentManager();
 380          FragmentTransaction ft = fm.beginTransaction();
 381          mNoteEditorFragment = new NoteEditorFragment();
 382          ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 383          ft.commitAllowingStateLoss();
 384          fm.executePendingTransactions();
 385      }
 386  
 387      /**
 388       * Checks for a previously valid user that is now not authenticated
 389       *
 390       * @return true if user has invalid authorization
 391       */
 392      private boolean userAuthenticationIsInvalid() {
 393          Simplenote currentApp = (Simplenote) getApplication();
 394          Simperium simperium = currentApp.getSimperium();
 395          User user = simperium.getUser();
 396          return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 397      }
 398  
 399      public void setCurrentNote(Note note) {
 400          mCurrentNote = note;
 401      }
 402  
 403      // received a change from the network, refresh the list
 404      @Override
 405      public void onChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
 406          runOnUiThread(new Runnable() {
 407              @Override
 408              public void run() {
 409                  if (type == Bucket.ChangeType.INDEX)
 410                      setProgressBarIndeterminateVisibility(false);
 411                  mNoteListFragment.refreshList();
 412              }
 413          });
 414      }
 415  
 416      @Override
 417      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 418          runOnUiThread(new Runnable() {
 419              @Override
 420              public void run() {
 421                  mNoteListFragment.refreshList();
 422              }
 423          });
 424      }
 425  
 426      @Override
 427      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 428          runOnUiThread(new Runnable() {
 429              @Override
 430              public void run() {
 431                  mNoteListFragment.refreshList();
 432              }
 433          });
 434      }
 435  
 436      @Override
 437      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 438  
 439          // noop, NoteEditorFragment will handle this
 440  
 441      }
 442  
 443      // Tags bucket listener
 444      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 445          void updateNavigationDrawer() {
 446              runOnUiThread(new Runnable() {
 447                  public void run() {
 448                      updateNavigationDrawerItems();
 449                  }
 450              });
 451          }
 452  
 453          @Override
 454          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 455              updateNavigationDrawer();
 456          }
 457  
 458          @Override
 459          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 460              updateNavigationDrawer();
 461          }
 462  
 463          @Override
 464          public void onChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 465              updateNavigationDrawer();
 466          }
 467  
 468          @Override
 469          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 470              // noop
 471          }
 472      };
 473  
 474      public boolean isLargeScreenLandscape() {
 475          return mIsLargeScreen &amp;&amp; mIsLandscape;
 476      }
 477  
 478      // nbradbury 01-Apr-2013
 479      public NoteListFragment getNoteListFragment() {
 480          return mNoteListFragment;
 481      }
 482  
 483      @Override
 484      public boolean onCreateOptionsMenu(Menu menu) {
 485          super.onCreateOptionsMenu(menu);
 486          MenuInflater inflater = getMenuInflater();
 487          inflater.inflate(R.menu.notes_list, menu);
 488  
 489          boolean drawerOpen = mDrawerLayout.isDrawerOpen(mDrawerList);
 490  
 491          // restore the search query if on a landscape tablet
 492          String searchQuery = null;
 493          if (isLargeScreenLandscape() &amp;&amp; mSearchView != null)
 494              searchQuery = mSearchView.getQuery().toString();
 495  
 496          mSearchMenuItem = menu.findItem(R.id.menu_search);
 497          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 498  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 499 -        // Set a custom search view drawable</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 500 -        int searchPlateId = mSearchView.getContext().getResources().getIdentifier(&quot;android:id/search_plate&quot;, null, null);"> 500 -        int searchPlateId = mSearchView.getContext().getResources().getIdentifier(&quot;android:id/search_plate&quot;, null,ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 501 -        View searchPlate = mSearchView.findViewById(searchPlateId);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 502 -        if (searchPlate != null)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 503 -            searchPlate.setBackgroundResource(R.drawable.search_view_selector);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 504 -</span>
 505          if (!TextUtils.isEmpty(searchQuery)) {
 506              mSearchView.setQuery(searchQuery, false);
 507              mSearchMenuItem.expandActionView();
 508          }
 509  
 510          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 511              @Override
 512              public boolean onQueryTextChange(String newText) {
 513                  if (mSearchMenuItem.isActionViewExpanded()) {
 514                      getNoteListFragment().searchNotes(newText);
 515                  }
 516                  return true;
 517              }
 518  
 519              @Override
 520              public boolean onQueryTextSubmit(String queryText) {
 521                  getNoteListFragment().searchNotes(queryText);
 522                  return true;
 523              }
 524  
 525          });
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 526 -        mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 527 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 528 +        MenuItemCompat.setOnActionExpandListener(mSearchMenuItem, new MenuItemCompat.OnActionExpandListener() {</span>
 529              @Override
 530              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 531                  checkEmptyListText(true);
 532                  getNoteListFragment().hideWelcomeView();
 533                  mTracker.sendEvent(&quot;note&quot;, &quot;searched_notes&quot;, &quot;action_bar_search_tap&quot;, null);







 534                  return true;
 535              }
 536  
 537              @Override
 538              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 539                  // Show all notes again
 540                  mTabletSearchQuery = &quot;&quot;;
 541                  mSearchView.setQuery(&quot;&quot;, false);
 542                  checkEmptyListText(false);
 543                  getNoteListFragment().clearSearch();
 544                  getNoteListFragment().setWelcomeViewVisibility();
 545                  return true;
 546              }
 547          });
 548  
 549          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 550              @Override
 551              public boolean onMenuItemClick(MenuItem item) {
 552                  if (!mSearchMenuItem.isActionViewExpanded())
 553                      showDetailPlaceholder();
 554                  return false;
 555              }
 556          });
 557  
 558          // Restore the search query on landscape tablets
 559          if (isLargeScreenLandscape() &amp;&amp; !TextUtils.isEmpty(mTabletSearchQuery)) {
 560              mSearchView.setQuery(mTabletSearchQuery, false);
 561              mSearchMenuItem.expandActionView();
 562              mSearchView.clearFocus();
 563          }
 564  
 565          Simplenote currentApp = (Simplenote) getApplication();
 566          menu.findItem(R.id.menu_sign_in).setVisible(currentApp.getSimperium().needsAuthorization());
 567  
 568  
 569          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 570          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 571              trashItem.setTitle(R.string.undelete);
 572          else
 573              trashItem.setTitle(R.string.delete);
 574  
 575          if (isLargeScreenLandscape()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 576 -            menu.findItem(R.id.menu_create_note).setVisible(!drawerOpen);</span>
 577              menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 578              menu.findItem(R.id.menu_preferences).setVisible(true);
 579              if (mCurrentNote != null) {
 580                  menu.findItem(R.id.menu_share).setVisible(!drawerOpen);
 581                  trashItem.setVisible(true);
 582              } else {
 583                  menu.findItem(R.id.menu_share).setVisible(false);
 584                  trashItem.setVisible(false);
 585              }
 586              menu.findItem(R.id.menu_edit_tags).setVisible(true);
 587              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 588          } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 589 -            menu.findItem(R.id.menu_create_note).setVisible(!drawerOpen);</span>
 590              menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 591              menu.findItem(R.id.menu_preferences).setVisible(true);
 592              menu.findItem(R.id.menu_share).setVisible(false);
 593              trashItem.setVisible(false);
 594              menu.findItem(R.id.menu_edit_tags).setVisible(true);
 595              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 596          }
 597  
 598          // Are we looking at the trash? Adjust menu accordingly.
 599          if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 600              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 601              mEmptyTrashMenuItem.setVisible(!drawerOpen);
 602  
 603              updateTrashMenuItem();
 604  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 605 -            menu.findItem(R.id.menu_create_note).setVisible(false);</span>
 606              menu.findItem(R.id.menu_search).setVisible(false);
 607              menu.findItem(R.id.menu_share).setVisible(false);
 608          }
 609  
 610          return true;
 611      }
 612  
 613      @Override
 614      public boolean onOptionsItemSelected(MenuItem item) {
 615          if (mDrawerToggle.onOptionsItemSelected(item)) {
 616              return true;
 617          }
 618          switch (item.getItemId()) {
 619              case R.id.menu_preferences:
<abbr title=" 620                  // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 620                  // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from prðŸ”µ</abbr>
 621                  Intent i = new Intent(this, PreferencesActivity.class);
 622                  startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 623                  return true;
 624              case R.id.menu_sign_in:
 625                  startLoginActivity(true);
 626                  return true;
 627              case R.id.menu_edit_tags:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 628 -                Intent editTagsIntent = new Intent(this, TagsListActivity.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 629 +                Intent editTagsIntent = new Intent(this, TagsActivity.class);</span>
 630                  startActivity(editTagsIntent);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 631 -                return true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 632 -            case R.id.menu_create_note:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 633 -                getNoteListFragment().addNote();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 634 -                mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;action_bar_button&quot;, null);</span>







 635                  return true;
 636              case R.id.menu_share:
 637                  if (mCurrentNote != null) {
 638                      Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 639                      shareIntent.setType(&quot;text/plain&quot;);
 640                      shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 641                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 641                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note))ðŸ”µ</abbr>
 642                      mTracker.sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, null);







 643                  }
 644                  return true;
 645              case R.id.menu_delete:
 646                  if (mNoteEditorFragment != null) {
 647                      if (mCurrentNote != null) {
 648                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 649                          mCurrentNote.setModificationDate(Calendar.getInstance());
 650                          mCurrentNote.save();
 651  
 652                          if (mCurrentNote.isDeleted()) {
 653                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 654                              deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 655                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 656                              mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
 657                              mTracker.sendEvent(&quot;note&quot;, &quot;deleted_note&quot;, &quot;overflow_menu&quot;, null);







 658                          } else {
 659                              mTracker.sendEvent(&quot;note&quot;, &quot;restored_note&quot;, &quot;overflow_menu&quot;, null);







 660                          }
 661                          showDetailPlaceholder();
 662                      }
 663                      NoteListFragment fragment = getNoteListFragment();
 664                      if (fragment != null) {
 665                          fragment.getPrefs();
 666                          fragment.refreshList();
 667                      }
 668                  }
 669                  return true;
 670              case R.id.menu_empty_trash:
 671                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 672  
 673                  alert.setTitle(R.string.empty_trash);
 674                  alert.setMessage(R.string.confirm_empty_trash);
 675                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 676                      public void onClick(DialogInterface dialog, int whichButton) {
 677                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 678                          mTracker.sendEvent(&quot;note&quot;, &quot;trash_emptied&quot;, &quot;overflow_menu&quot;, null);







 679                      }
 680                  });
 681                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 682                      public void onClick(DialogInterface dialog, int whichButton) {
 683                          // Do nothing, just closing the dialog
 684                      }
 685                  });
 686                  alert.show();
 687                  return true;
 688              case android.R.id.home:
 689                  invalidateOptionsMenu();
 690                  return true;
 691              default:
 692                  return super.onOptionsItemSelected(item);
 693          }
 694      }
 695  
 696      /**
 697       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 698       * the item with the given ID was selected.
 699       */
 700      @Override
 701      public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {
 702  
 703          if (!isLargeScreenLandscape()) {
 704              // Launch the editor activity
 705              Bundle arguments = new Bundle();
 706              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 707              arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);
 708  
 709              if (matchOffsets != null)
 710                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 711  
 712              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 713              editNoteIntent.putExtras(arguments);
 714              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 715          } else {
 716              mNoteEditorFragment.setIsNewNote(isNew);
 717              mNoteEditorFragment.setNote(noteID, matchOffsets);
 718              getNoteListFragment().setNoteSelected(noteID);
 719              if (mSearchView != null &amp;&amp; mSearchView.getQuery().length() &gt; 0) {
 720                  mTabletSearchQuery = mSearchView.getQuery().toString();
 721              }
 722              invalidateOptionsMenu();
 723          }
 724  
 725          mTracker.sendEvent(&quot;note&quot;, &quot;viewed_note&quot;, &quot;note_list_row_tap&quot;, null);







 726      }
 727  
 728      @Override
 729      public void onUserCreated(User user) {
 730          // New account created
 731          mTracker.sendEvent(&quot;user&quot;, &quot;new_account_created&quot;, &quot;account_created_from_login_activity&quot;, null);







 732      }
 733  
 734      public void onUserStatusChange(User.Status status) {
 735          switch (status) {
 736  
 737              // successfully used access token to connect to simperium bucket
 738              case AUTHORIZED:
 739                  mTracker.sendEvent(&quot;user&quot;, &quot;signed_in&quot;, &quot;signed_in_from_login_activity&quot;, null);







 740                  runOnUiThread(new Runnable() {
 741                      @Override
 742                      public void run() {
 743                          if (!mNotesBucket.hasChangeVersion()) {
 744                              setProgressBarIndeterminateVisibility(true);
 745                          }
 746                      }
 747                  });
 748                  break;
 749  
 750              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 751              case NOT_AUTHORIZED:
 752                  runOnUiThread(new Runnable() {
 753                      @Override
 754                      public void run() {
 755                          startLoginActivity(true);
 756                      }
 757                  });
 758                  break;
 759  
<abbr title=" 760              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 760              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
 761              case UNKNOWN:
 762                  break;
 763          }
 764      }
 765  
 766      public void startLoginActivity(boolean signInFirst) {
 767          Intent loginIntent = new Intent(this, LoginActivity.class);
 768          if (signInFirst)
 769              loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 770          startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 771      }
 772  
 773  
 774      @Override
 775      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 776          super.onActivityResult(requestCode, resultCode, data);
 777          switch (requestCode) {
 778              case Simplenote.INTENT_PREFERENCES:
 779                  if (ThemeUtils.themeWasChanged(data)) {
 780                      // Restart this activity to apply the new theme
 781                      recreate();
 782                      break;
 783                  }
<abbr title=" 784                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 784                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
 785                  invalidateOptionsMenu();
 786                  NoteListFragment fragment = getNoteListFragment();
 787                  if (fragment != null) {
 788                      fragment.getPrefs();
 789                      fragment.refreshList();
 790                  }
 791                  break;
 792              case Simplenote.INTENT_EDIT_NOTE:
 793                  if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 794                      String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 795                      if (noteId != null) {
 796                          List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 797                          deletedNoteIds.add(noteId);
 798                          mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 799                          mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
 800                      }
 801                  }
 802                  break;
 803              case Simperium.SIGNUP_SIGNIN_REQUEST:
 804                  invalidateOptionsMenu();
 805                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 806                      finish();
 807                  }
 808                  break;
 809          }
 810      }
 811  
 812      @Override
 813      public void onUndo(Parcelable p) {
 814          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 815          if (mUndoBarController != null &amp;&amp; deletedNoteIds != null) {
 816  
 817              for (int i=0; i &lt; deletedNoteIds.size(); i++) {
 818                  Note deletedNote = null;
 819                  try {
 820                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 821                  } catch (BucketObjectMissingException e) {
 822                      return;
 823                  }
 824                  if (deletedNote != null) {
 825                      deletedNote.setDeleted(false);
 826                      deletedNote.setModificationDate(Calendar.getInstance());
 827                      deletedNote.save();
 828                      NoteListFragment fragment = getNoteListFragment();
 829                      if (fragment != null) {
 830                          fragment.getPrefs();
 831                          fragment.refreshList();
 832                      }
 833                  }
 834              }
 835          }
 836      }
 837  
 838      @Override
 839      protected void onPostCreate(Bundle savedInstanceState) {
 840          super.onPostCreate(savedInstanceState);
 841          // Sync the toggle state after onRestoreInstanceState has occurred.
 842          mDrawerToggle.syncState();
 843      }
 844  
 845      @Override
 846      public void onConfigurationChanged(Configuration newConfig) {
 847          super.onConfigurationChanged(newConfig);
 848  
 849          mDrawerToggle.onConfigurationChanged(newConfig);
 850  
 851          if (mIsLargeScreen) {
 852              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 853                  // Add the editor fragment
 854                  mIsLandscape = true;
 855                  addEditorFragment();
 856                  if (mNoteListFragment != null) {
 857                      mNoteListFragment.setActivateOnItemClick(true);
 858                      mNoteListFragment.setDividerVisible(true);
 859                  }
 860                  // Select the current note on a tablet
 861                  if (mCurrentNote != null)
 862                      onNoteSelected(mCurrentNote.getSimperiumKey(), false, null);
 863                  else {
 864                      mNoteEditorFragment.setPlaceholderVisible(true);
 865                      mNoteListFragment.getListView().clearChoices();
 866                  }
 867                  invalidateOptionsMenu();
<abbr title=" 868              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {"> 868              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null)ðŸ”µ</abbr>
 869                  // Remove the editor fragment when rotating back to portrait
 870                  mIsLandscape = false;
 871                  mCurrentNote = null;
 872                  if (mNoteListFragment != null) {
 873                      mNoteListFragment.setActivateOnItemClick(false);
 874                      mNoteListFragment.setDividerVisible(false);
 875                      mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 876                      mNoteListFragment.refreshList();
 877                  }
 878                  FragmentManager fm = getFragmentManager();
 879                  FragmentTransaction ft = fm.beginTransaction();
 880                  ft.remove(mNoteEditorFragment);
 881                  mNoteEditorFragment = null;
 882                  ft.commitAllowingStateLoss();
 883                  fm.executePendingTransactions();
 884                  invalidateOptionsMenu();
 885              }
 886          }
 887      }
 888  
 889      public void checkEmptyListText(boolean isSearch) {
 890          if (isSearch) {
<abbr title=" 891              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);"> 891              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
 892              getNoteListFragment().setEmptyListViewClickable(false);
 893          } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title=" 894              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);"> 894              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
 895              EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;viewed_trash&quot;, &quot;trash_filter_selected&quot;, null);







 896              getNoteListFragment().setEmptyListViewClickable(false);
 897          } else {
<abbr title=" 898              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 898              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
 899              getNoteListFragment().setEmptyListViewClickable(true);
 900          }
 901      }
 902  
 903      public void showDetailPlaceholder() {
 904          if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 905              mCurrentNote = null;
 906              mNoteEditorFragment.setPlaceholderVisible(true);
 907              invalidateOptionsMenu();
 908          }
 909      }
 910  
 911      public void stopListeningToNotesBucket() {
 912          mNotesBucket.removeOnNetworkChangeListener(this);
 913          mNotesBucket.removeOnSaveObjectListener(this);
 914          mNotesBucket.removeOnDeleteObjectListener(this);
 915      }
 916  
 917      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
 918          if (mUndoBarController != null) {
 919              mUndoBarController.setDeletedNoteIds(noteIds);
<abbr title=" 920              mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()), null);"> 920              mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_notes, noteIdðŸ”µ</abbr>
 921          }
 922      }
 923  
 924      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 925  
 926          @Override
 927          protected Void doInBackground(Void... voids) {
 928              Simplenote application = (Simplenote) getApplication();
 929              Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 930              Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 931              Bucket.ObjectCursor c = query.execute();
 932              while (c.moveToNext()) {
 933                  c.getObject().delete();
 934              }
 935              return null;
 936          }
 937  
 938          @Override
 939          protected void onPostExecute(Void nada) {
 940              showDetailPlaceholder();
 941          }
 942      }
 943  
 944  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.ActionBar;
   4  import android.app.Activity;
   5  import android.app.AlertDialog;
   6  import android.app.FragmentManager;
   7  import android.app.FragmentTransaction;
   8  import android.content.DialogInterface;
   9  import android.content.Intent;
  10  import android.content.SharedPreferences;
  11  import android.content.res.Configuration;
  12  import android.os.AsyncTask;
  13  import android.os.Build;
  14  import android.os.Bundle;
  15  import android.os.Parcelable;
  16  import android.preference.PreferenceManager;
  17  import android.support.v4.app.ActionBarDrawerToggle;


  18  import android.support.v4.widget.DrawerLayout;



  19  import android.text.Spannable;
  20  import android.text.SpannableString;
  21  import android.text.TextUtils;

  22  import android.view.Menu;
  23  import android.view.MenuInflater;
  24  import android.view.MenuItem;
  25  import android.view.View;
  26  import android.view.Window;
  27  import android.widget.AdapterView;
  28  import android.widget.ListView;
  29  import android.widget.SearchView;

  30  
  31  import com.automattic.simplenote.models.Note;
  32  import com.automattic.simplenote.models.Tag;
  33  import com.automattic.simplenote.utils.PrefUtils;
  34  import com.automattic.simplenote.utils.TagsAdapter;
  35  import com.automattic.simplenote.utils.ThemeUtils;

  36  import com.automattic.simplenote.widgets.TypefaceSpan;
  37  import com.automattic.simplenote.utils.UndoBarController;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import com.google.analytics.tracking.android.EasyTracker;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import com.google.analytics.tracking.android.Tracker;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import com.google.android.gms.analytics.HitBuilders;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import com.google.android.gms.analytics.Tracker;</span>
  42  import com.simperium.Simperium;
  43  import com.simperium.android.LoginActivity;
  44  import com.simperium.client.Bucket;
  45  import com.simperium.client.BucketObjectMissingException;
  46  import com.simperium.client.BucketObjectNameInvalid;
  47  import com.simperium.client.Query;
  48  import com.simperium.client.User;
  49  
  50  import java.util.ArrayList;
  51  import java.util.Calendar;
  52  import java.util.List;
  53  
  54  public class NotesActivity extends Activity implements

<abbr title="  55          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  55          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  56          Bucket.Listener&lt;Note&gt; {
  57  
  58      private boolean mIsLargeScreen, mIsLandscape, mShouldSelectNewNote;
  59      private String mTabletSearchQuery;
  60      private UndoBarController mUndoBarController;
  61      private SearchView mSearchView;
  62      private MenuItem mSearchMenuItem;
  63      private NoteListFragment mNoteListFragment;
  64      private NoteEditorFragment mNoteEditorFragment;
  65      private Note mCurrentNote;
  66      protected Bucket&lt;Note&gt; mNotesBucket;
  67      protected Bucket&lt;Tag&gt; mTagsBucket;
  68      private int TRASH_SELECTED_ID = 1;
  69      private ActionBar mActionBar;
  70      private MenuItem mEmptyTrashMenuItem;
  71  
  72      // Menu drawer
  73      private DrawerLayout mDrawerLayout;
  74      private ListView mDrawerList;
  75      private ActionBarDrawerToggle mDrawerToggle;
  76      private TagsAdapter mTagsAdapter;
  77      private TagsAdapter.TagMenuItem mSelectedTag;
  78      private CharSequence mActionBarTitle;
  79  
  80      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  81      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  82  
  83      // Google Analytics tracker
  84      private Tracker mTracker;
  85  
  86      @Override
  87      protected void onCreate(Bundle savedInstanceState) {
  88          requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);

  89  
  90          ThemeUtils.setTheme(this);
  91  
  92          super.onCreate(savedInstanceState);
  93          Simplenote currentApp = (Simplenote) getApplication();
  94  
  95          if (mNotesBucket == null)
  96              mNotesBucket = currentApp.getNotesBucket();
  97  
  98          if (mTagsBucket == null)
  99              mTagsBucket = currentApp.getTagsBucket();
 100  
 101          setContentView(R.layout.activity_notes);



 102  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        EasyTracker.getInstance().activityStart(this);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        mTracker = EasyTracker.getTracker();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +        mTracker = currentApp.getTracker();</span>
 106  
 107          if (savedInstanceState == null) {
 108              mNoteListFragment = new NoteListFragment();
 109              FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
 110              fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
 111              fragmentTransaction.commit();
 112          } else {
 113              mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 114          }
 115  
 116          Configuration config = getBaseContext().getResources().getConfiguration();
 117          if ((config.screenLayout
 118                  &amp; Configuration.SCREENLAYOUT_SIZE_MASK)
 119                  &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {
 120              mIsLargeScreen = true;
 121  
 122              if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 123                  mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 123                  mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR)ðŸ”µ</abbr>
 124              } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 125                  mIsLandscape = true;
 126                  addEditorFragment();
 127              }
 128          }
 129  
 130          // Set up the menu drawer
 131          mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);
 132          mDrawerList = (ListView) findViewById(R.id.left_drawer);
 133          mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 134          mDrawerList.setAdapter(mTagsAdapter);
 135          // Set the list&#x27;s click listener
 136          mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 137  
 138          if (mSelectedTag == null)
 139              mSelectedTag = mTagsAdapter.getDefaultItem();
 140  
 141          // enable ActionBar app icon to behave as action to toggle nav drawer
 142          mActionBar = getActionBar();
 143          mActionBar.setDisplayHomeAsUpEnabled(true);
 144          mActionBar.setHomeButtonEnabled(true);
 145  
 146          // ActionBarDrawerToggle ties together the the proper interactions
 147          // between the sliding drawer and the action bar app icon
 148          mDrawerToggle = new ActionBarDrawerToggle(
 149                  this,
 150                  mDrawerLayout,
 151                  R.drawable.ic_drawer,
 152                  R.string.open_drawer,
 153                  R.string.close_drawer


 154          ) {
 155              public void onDrawerClosed(View view) {
 156                  setTitle(mActionBarTitle);
 157                  invalidateOptionsMenu();
 158              }
 159  
 160              public void onDrawerOpened(View drawerView) {
 161                  setTitleWithCustomFont(getString(R.string.app_name));
 162                  invalidateOptionsMenu();
 163              }
 164          };
 165          mDrawerLayout.setDrawerListener(mDrawerToggle);
 166  







 167          mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);

















 168  
 169          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 170              // Create the welcome note
 171              try {
 172                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 173                  welcomeNote.setCreationDate(Calendar.getInstance());
 174                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 175                  welcomeNote.setContent(getString(R.string.welcome_note));
 176                  welcomeNote.getTitle();
 177                  welcomeNote.save();
 178              } catch (BucketObjectNameInvalid e) {
 179                  // this won&#x27;t happen because welcome-android is a valid name
 180              }
 181  
 182              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 183              SharedPreferences.Editor editor = preferences.edit();
 184              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 185              editor.commit();
 186          }
 187  
 188          if (Intent.ACTION_SEND.equals(getIntent().getAction())) {
 189              // Check share action
 190              Intent intent = getIntent();
 191              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 192              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 193              if (text != null &amp;&amp; !text.equals(&quot;&quot;)) {
 194                  if (subject != null &amp;&amp; !subject.equals(&quot;&quot;)) {
 195                      text = subject + &quot;\n\n&quot; + text;
 196                  }
 197                  Note note = mNotesBucket.newObject();
 198                  note.setCreationDate(Calendar.getInstance());
 199                  note.setModificationDate(note.getCreationDate());
 200                  note.setContent(text);
 201                  note.save();
 202                  setCurrentNote(note);
 203                  mShouldSelectNewNote = true;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -                mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;external_share&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +                mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +                        new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +                                .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +                                .setAction(&quot;create_note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +                                .setLabel(&quot;external_share&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +                                .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +                );</span>
 212              }
 213          }
 214          currentApp.getSimperium().setOnUserCreatedListener(this);
 215          currentApp.getSimperium().setUserStatusChangeListener(this);
 216          setProgressBarIndeterminateVisibility(false);
 217      }
 218  
 219      @Override
 220      protected void onResume() {
 221          super.onResume();
 222  
 223          // Ensure user has valid authorization
 224          if (userAuthenticationIsInvalid())
 225              startLoginActivity(true);
 226  
 227          mNotesBucket.start();
 228          mTagsBucket.start();
 229  
 230          mNotesBucket.addOnNetworkChangeListener(this);
 231          mNotesBucket.addOnSaveObjectListener(this);
 232          mNotesBucket.addOnDeleteObjectListener(this);
 233          mTagsBucket.addListener(mTagsMenuUpdater);
 234  
 235          updateNavigationDrawerItems();
 236  
 237          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 238          Simplenote currentApp = (Simplenote)getApplication();
 239          if (currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED) {
 240              if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 241                  mSelectedTag = null;
 242                  mDrawerList.setSelection(mTagsAdapter.DEFAULT_ITEM_POSITION);
 243              }
 244          }
 245  
 246          setSelectedTagActive();
 247  
 248          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 249              onNoteSelected(mCurrentNote.getSimperiumKey(), true, null);
 250              mShouldSelectNewNote = false;
 251          }
 252      }
 253  
 254      @Override
 255      protected void onPause() {
 256          super.onPause();
 257  
 258          mTagsBucket.removeListener(mTagsMenuUpdater);
 259  
 260          mNotesBucket.removeOnNetworkChangeListener(this);
 261          mNotesBucket.removeOnSaveObjectListener(this);
 262          mNotesBucket.removeOnDeleteObjectListener(this);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -    public void onStop() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -        super.onStop();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -        EasyTracker.getInstance().activityStop(this);</span>
 269      }
 270  
 271      @Override
 272      public void setTitle(CharSequence title) {
 273          mActionBarTitle = (title != null) ? title : &quot;&quot;;
 274          setTitleWithCustomFont(mActionBarTitle);
 275      }
 276  
 277      private void setTitleWithCustomFont(CharSequence title) {
 278          // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 279          if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 280                  &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 281              mActionBar.setTitle(title);
 282              return;
 283          }
 284  
 285          SpannableString s = new SpannableString(title);
 286          s.setSpan(new TypefaceSpan(this), 0, s.length(),
 287                  Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 288          mActionBar.setTitle(s);
 289      }
 290  
 291      private void updateNavigationDrawerItems() {
 292          Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 293          mTagsAdapter.changeCursor(tagCursor);
 294      }
 295  
 296      private void setSelectedTagActive() {
 297          if (mSelectedTag == null)
 298              mSelectedTag = mTagsAdapter.getDefaultItem();
 299  
 300          setTitle(mSelectedTag.name);
 301          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag), true);
 302      }
 303  
 304      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 305      public void updateTrashMenuItem() {
 306          if (mEmptyTrashMenuItem == null)
 307              return;
 308          // Disable the trash icon if there are no notes trashed.
 309          Simplenote application = (Simplenote) getApplication();
 310          Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 311          Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 312          if (query.count() == 0) {
 313              mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash_disabled);
 314              mEmptyTrashMenuItem.setEnabled(false);
 315          } else {
 316              mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash);
 317              mEmptyTrashMenuItem.setEnabled(true);
 318          }
 319      }
 320  
 321      /* The click listener for ListView in the navigation drawer */
 322      private class DrawerItemClickListener implements ListView.OnItemClickListener {
 323          @Override
 324          public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 325  
 326              mSelectedTag = mTagsAdapter.getItem(position);
 327              checkEmptyListText(false);
 328              // Update checked item in navigation drawer and close it
 329              setSelectedTagActive();
 330              mDrawerLayout.closeDrawer(mDrawerList);
 331  
 332              // Disable long press on notes if we&#x27;re viewing the trash
 333              if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 334                  getNoteListFragment().getListView().setLongClickable(false);
 335              } else {
 336                  getNoteListFragment().getListView().setLongClickable(true);
 337              }
 338  
 339              getNoteListFragment().refreshListFromNavSelect();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -            if (position &gt; 1)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 341 -                mTracker.sendEvent(&quot;tag&quot;, &quot;viewed_notes_for_tag&quot;, &quot;selected_tag_in_navigation_drawer&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +            if (position &gt; 1) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +                mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +                        new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +                                .setCategory(&quot;tag&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +                                .setAction(&quot;viewed_notes_for_tag&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +                                .setLabel(&quot;selected_tag_in_navigation_drawer&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +                                .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +                );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +            }</span>
 351          }
 352      }
 353  
 354      public TagsAdapter.TagMenuItem getSelectedTag() {
 355          return mSelectedTag;
 356      }
 357  
 358      private void addEditorFragment() {
 359          FragmentManager fm = getFragmentManager();
 360          FragmentTransaction ft = fm.beginTransaction();
 361          mNoteEditorFragment = new NoteEditorFragment();
 362          ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 363          ft.commitAllowingStateLoss();
 364          fm.executePendingTransactions();
 365      }
 366  
 367      /**
 368       * Checks for a previously valid user that is now not authenticated
 369       *
 370       * @return true if user has invalid authorization
 371       */
 372      private boolean userAuthenticationIsInvalid() {
 373          Simplenote currentApp = (Simplenote) getApplication();
 374          Simperium simperium = currentApp.getSimperium();
 375          User user = simperium.getUser();
 376          return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 377      }
 378  
 379      public void setCurrentNote(Note note) {
 380          mCurrentNote = note;
 381      }
 382  
 383      // received a change from the network, refresh the list
 384      @Override
 385      public void onChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
 386          runOnUiThread(new Runnable() {
 387              @Override
 388              public void run() {
 389                  if (type == Bucket.ChangeType.INDEX)
 390                      setProgressBarIndeterminateVisibility(false);
 391                  mNoteListFragment.refreshList();
 392              }
 393          });
 394      }
 395  
 396      @Override
 397      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 398          runOnUiThread(new Runnable() {
 399              @Override
 400              public void run() {
 401                  mNoteListFragment.refreshList();
 402              }
 403          });
 404      }
 405  
 406      @Override
 407      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 408          runOnUiThread(new Runnable() {
 409              @Override
 410              public void run() {
 411                  mNoteListFragment.refreshList();
 412              }
 413          });
 414      }
 415  
 416      @Override
 417      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 418  
 419          // noop, NoteEditorFragment will handle this
 420  
 421      }
 422  
 423      // Tags bucket listener
 424      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 425          void updateNavigationDrawer() {
 426              runOnUiThread(new Runnable() {
 427                  public void run() {
 428                      updateNavigationDrawerItems();
 429                  }
 430              });
 431          }
 432  
 433          @Override
 434          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 435              updateNavigationDrawer();
 436          }
 437  
 438          @Override
 439          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 440              updateNavigationDrawer();
 441          }
 442  
 443          @Override
 444          public void onChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 445              updateNavigationDrawer();
 446          }
 447  
 448          @Override
 449          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 450              // noop
 451          }
 452      };
 453  
 454      public boolean isLargeScreenLandscape() {
 455          return mIsLargeScreen &amp;&amp; mIsLandscape;
 456      }
 457  
 458      // nbradbury 01-Apr-2013
 459      public NoteListFragment getNoteListFragment() {
 460          return mNoteListFragment;
 461      }
 462  
 463      @Override
 464      public boolean onCreateOptionsMenu(Menu menu) {
 465          super.onCreateOptionsMenu(menu);
 466          MenuInflater inflater = getMenuInflater();
 467          inflater.inflate(R.menu.notes_list, menu);
 468  
 469          boolean drawerOpen = mDrawerLayout.isDrawerOpen(mDrawerList);
 470  
 471          // restore the search query if on a landscape tablet
 472          String searchQuery = null;
 473          if (isLargeScreenLandscape() &amp;&amp; mSearchView != null)
 474              searchQuery = mSearchView.getQuery().toString();
 475  
 476          mSearchMenuItem = menu.findItem(R.id.menu_search);
 477          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 478  
 479          // Set a custom search view drawable
<abbr title=" 480          int searchPlateId = mSearchView.getContext().getResources().getIdentifier(&quot;android:id/search_plate&quot;, null, null);"> 480          int searchPlateId = mSearchView.getContext().getResources().getIdentifier(&quot;android:id/search_plate&quot;, null,ðŸ”µ</abbr>
 481          View searchPlate = mSearchView.findViewById(searchPlateId);
 482          if (searchPlate != null)
 483              searchPlate.setBackgroundResource(R.drawable.search_view_selector);
 484  
 485          if (!TextUtils.isEmpty(searchQuery)) {
 486              mSearchView.setQuery(searchQuery, false);
 487              mSearchMenuItem.expandActionView();
 488          }
 489  
 490          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 491              @Override
 492              public boolean onQueryTextChange(String newText) {
 493                  if (mSearchMenuItem.isActionViewExpanded()) {
 494                      getNoteListFragment().searchNotes(newText);
 495                  }
 496                  return true;
 497              }
 498  
 499              @Override
 500              public boolean onQueryTextSubmit(String queryText) {
 501                  getNoteListFragment().searchNotes(queryText);
 502                  return true;
 503              }
 504  
 505          });
 506          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {


 507              @Override
 508              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 509                  checkEmptyListText(true);
 510                  getNoteListFragment().hideWelcomeView();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 511 -                mTracker.sendEvent(&quot;note&quot;, &quot;searched_notes&quot;, &quot;action_bar_search_tap&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 512 +                mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 513 +                        new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 514 +                                .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 515 +                                .setAction(&quot;searched_notes&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 516 +                                .setLabel(&quot;action_bar_search_tap&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 517 +                                .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 518 +                );</span>
 519                  return true;
 520              }
 521  
 522              @Override
 523              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 524                  // Show all notes again
 525                  mTabletSearchQuery = &quot;&quot;;
 526                  mSearchView.setQuery(&quot;&quot;, false);
 527                  checkEmptyListText(false);
 528                  getNoteListFragment().clearSearch();
 529                  getNoteListFragment().setWelcomeViewVisibility();
 530                  return true;
 531              }
 532          });
 533  
 534          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 535              @Override
 536              public boolean onMenuItemClick(MenuItem item) {
 537                  if (!mSearchMenuItem.isActionViewExpanded())
 538                      showDetailPlaceholder();
 539                  return false;
 540              }
 541          });
 542  
 543          // Restore the search query on landscape tablets
 544          if (isLargeScreenLandscape() &amp;&amp; !TextUtils.isEmpty(mTabletSearchQuery)) {
 545              mSearchView.setQuery(mTabletSearchQuery, false);
 546              mSearchMenuItem.expandActionView();
 547              mSearchView.clearFocus();
 548          }
 549  
 550          Simplenote currentApp = (Simplenote) getApplication();
 551          menu.findItem(R.id.menu_sign_in).setVisible(currentApp.getSimperium().needsAuthorization());
 552  
 553  
 554          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 555          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 556              trashItem.setTitle(R.string.undelete);
 557          else
 558              trashItem.setTitle(R.string.delete);
 559  
 560          if (isLargeScreenLandscape()) {
 561              menu.findItem(R.id.menu_create_note).setVisible(!drawerOpen);
 562              menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 563              menu.findItem(R.id.menu_preferences).setVisible(true);
 564              if (mCurrentNote != null) {
 565                  menu.findItem(R.id.menu_share).setVisible(!drawerOpen);
 566                  trashItem.setVisible(true);
 567              } else {
 568                  menu.findItem(R.id.menu_share).setVisible(false);
 569                  trashItem.setVisible(false);
 570              }
 571              menu.findItem(R.id.menu_edit_tags).setVisible(true);
 572              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 573          } else {
 574              menu.findItem(R.id.menu_create_note).setVisible(!drawerOpen);
 575              menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 576              menu.findItem(R.id.menu_preferences).setVisible(true);
 577              menu.findItem(R.id.menu_share).setVisible(false);
 578              trashItem.setVisible(false);
 579              menu.findItem(R.id.menu_edit_tags).setVisible(true);
 580              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 581          }
 582  
 583          // Are we looking at the trash? Adjust menu accordingly.
 584          if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 585              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 586              mEmptyTrashMenuItem.setVisible(!drawerOpen);
 587  
 588              updateTrashMenuItem();
 589  
 590              menu.findItem(R.id.menu_create_note).setVisible(false);
 591              menu.findItem(R.id.menu_search).setVisible(false);
 592              menu.findItem(R.id.menu_share).setVisible(false);
 593          }
 594  
 595          return true;
 596      }
 597  
 598      @Override
 599      public boolean onOptionsItemSelected(MenuItem item) {
 600          if (mDrawerToggle.onOptionsItemSelected(item)) {
 601              return true;
 602          }
 603          switch (item.getItemId()) {
 604              case R.id.menu_preferences:
<abbr title=" 605                  // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 605                  // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from prðŸ”µ</abbr>
 606                  Intent i = new Intent(this, PreferencesActivity.class);
 607                  startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 608                  return true;
 609              case R.id.menu_sign_in:
 610                  startLoginActivity(true);
 611                  return true;
 612              case R.id.menu_edit_tags:
 613                  Intent editTagsIntent = new Intent(this, TagsListActivity.class);

 614                  startActivity(editTagsIntent);
 615                  return true;
 616              case R.id.menu_create_note:
 617                  getNoteListFragment().addNote();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 618 -                mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;action_bar_button&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 619 +                mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 620 +                        new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 621 +                                .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 622 +                                .setAction(&quot;create_note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 623 +                                .setLabel(&quot;action_bar_button&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 624 +                                .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 625 +                );</span>
 626                  return true;
 627              case R.id.menu_share:
 628                  if (mCurrentNote != null) {
 629                      Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 630                      shareIntent.setType(&quot;text/plain&quot;);
 631                      shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 632                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 632                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note))ðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 633 -                    mTracker.sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 634 +                    mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 635 +                            new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 636 +                                    .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 637 +                                    .setAction(&quot;shared_note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 638 +                                    .setLabel(&quot;action_bar_share_button&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 639 +                                    .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 640 +                    );</span>
 641                  }
 642                  return true;
 643              case R.id.menu_delete:
 644                  if (mNoteEditorFragment != null) {
 645                      if (mCurrentNote != null) {
 646                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 647                          mCurrentNote.setModificationDate(Calendar.getInstance());
 648                          mCurrentNote.save();
 649  
 650                          if (mCurrentNote.isDeleted()) {
 651                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 652                              deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 653                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 654                              mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 655 -                            mTracker.sendEvent(&quot;note&quot;, &quot;deleted_note&quot;, &quot;overflow_menu&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 656 +                            mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 657 +                                    new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 658 +                                            .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 659 +                                            .setAction(&quot;deleted_note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 660 +                                            .setLabel(&quot;overflow_menu&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 661 +                                            .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 662 +                            );</span>
 663                          } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 664 -                            mTracker.sendEvent(&quot;note&quot;, &quot;restored_note&quot;, &quot;overflow_menu&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 665 +                            mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 666 +                                    new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 667 +                                            .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 668 +                                            .setAction(&quot;restored_note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 669 +                                            .setLabel(&quot;overflow_menu&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 670 +                                            .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 671 +                            );</span>
 672                          }
 673                          showDetailPlaceholder();
 674                      }
 675                      NoteListFragment fragment = getNoteListFragment();
 676                      if (fragment != null) {
 677                          fragment.getPrefs();
 678                          fragment.refreshList();
 679                      }
 680                  }
 681                  return true;
 682              case R.id.menu_empty_trash:
 683                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 684  
 685                  alert.setTitle(R.string.empty_trash);
 686                  alert.setMessage(R.string.confirm_empty_trash);
 687                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 688                      public void onClick(DialogInterface dialog, int whichButton) {
 689                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 690 -                        mTracker.sendEvent(&quot;note&quot;, &quot;trash_emptied&quot;, &quot;overflow_menu&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 691 +                        mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 692 +                                new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 693 +                                        .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 694 +                                        .setAction(&quot;trash_emptied&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 695 +                                        .setLabel(&quot;overflow_menu&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 696 +                                        .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 697 +                        );</span>
 698                      }
 699                  });
 700                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 701                      public void onClick(DialogInterface dialog, int whichButton) {
 702                          // Do nothing, just closing the dialog
 703                      }
 704                  });
 705                  alert.show();
 706                  return true;
 707              case android.R.id.home:
 708                  invalidateOptionsMenu();
 709                  return true;
 710              default:
 711                  return super.onOptionsItemSelected(item);
 712          }
 713      }
 714  
 715      /**
 716       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 717       * the item with the given ID was selected.
 718       */
 719      @Override
 720      public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {
 721  
 722          if (!isLargeScreenLandscape()) {
 723              // Launch the editor activity
 724              Bundle arguments = new Bundle();
 725              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 726              arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);
 727  
 728              if (matchOffsets != null)
 729                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 730  
 731              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 732              editNoteIntent.putExtras(arguments);
 733              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 734          } else {
 735              mNoteEditorFragment.setIsNewNote(isNew);
 736              mNoteEditorFragment.setNote(noteID, matchOffsets);
 737              getNoteListFragment().setNoteSelected(noteID);
 738              if (mSearchView != null &amp;&amp; mSearchView.getQuery().length() &gt; 0) {
 739                  mTabletSearchQuery = mSearchView.getQuery().toString();
 740              }
 741              invalidateOptionsMenu();
 742          }
 743  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 744 -        mTracker.sendEvent(&quot;note&quot;, &quot;viewed_note&quot;, &quot;note_list_row_tap&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 745 +        mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 746 +                new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 747 +                        .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 748 +                        .setAction(&quot;viewed_note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 749 +                        .setLabel(&quot;note_list_row_tap&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 750 +                        .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 751 +        );</span>
 752      }
 753  
 754      @Override
 755      public void onUserCreated(User user) {
 756          // New account created
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 757 -        mTracker.sendEvent(&quot;user&quot;, &quot;new_account_created&quot;, &quot;account_created_from_login_activity&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 758 +        mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 759 +                new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 760 +                        .setCategory(&quot;user&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 761 +                        .setAction(&quot;new_account_created&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 762 +                        .setLabel(&quot;account_created_from_login_activity&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 763 +                        .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 764 +        );</span>
 765      }
 766  
 767      public void onUserStatusChange(User.Status status) {
 768          switch (status) {
 769  
 770              // successfully used access token to connect to simperium bucket
 771              case AUTHORIZED:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 772 -                mTracker.sendEvent(&quot;user&quot;, &quot;signed_in&quot;, &quot;signed_in_from_login_activity&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 773 +                mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 774 +                        new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 775 +                                .setCategory(&quot;user&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 776 +                                .setAction(&quot;signed_in&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 777 +                                .setLabel(&quot;signed_in_from_login_activity&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 778 +                                .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 779 +                );</span>
 780                  runOnUiThread(new Runnable() {
 781                      @Override
 782                      public void run() {
 783                          if (!mNotesBucket.hasChangeVersion()) {
 784                              setProgressBarIndeterminateVisibility(true);
 785                          }
 786                      }
 787                  });
 788                  break;
 789  
 790              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 791              case NOT_AUTHORIZED:
 792                  runOnUiThread(new Runnable() {
 793                      @Override
 794                      public void run() {
 795                          startLoginActivity(true);
 796                      }
 797                  });
 798                  break;
 799  
<abbr title=" 800              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 800              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
 801              case UNKNOWN:
 802                  break;
 803          }
 804      }
 805  
 806      public void startLoginActivity(boolean signInFirst) {
 807          Intent loginIntent = new Intent(this, LoginActivity.class);
 808          if (signInFirst)
 809              loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 810          startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 811      }
 812  
 813  
 814      @Override
 815      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 816          super.onActivityResult(requestCode, resultCode, data);
 817          switch (requestCode) {
 818              case Simplenote.INTENT_PREFERENCES:
 819                  if (ThemeUtils.themeWasChanged(data)) {
 820                      // Restart this activity to apply the new theme
 821                      recreate();
 822                      break;
 823                  }
<abbr title=" 824                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 824                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
 825                  invalidateOptionsMenu();
 826                  NoteListFragment fragment = getNoteListFragment();
 827                  if (fragment != null) {
 828                      fragment.getPrefs();
 829                      fragment.refreshList();
 830                  }
 831                  break;
 832              case Simplenote.INTENT_EDIT_NOTE:
 833                  if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 834                      String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 835                      if (noteId != null) {
 836                          List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 837                          deletedNoteIds.add(noteId);
 838                          mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 839                          mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
 840                      }
 841                  }
 842                  break;
 843              case Simperium.SIGNUP_SIGNIN_REQUEST:
 844                  invalidateOptionsMenu();
 845                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 846                      finish();
 847                  }
 848                  break;
 849          }
 850      }
 851  
 852      @Override
 853      public void onUndo(Parcelable p) {
 854          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 855          if (mUndoBarController != null &amp;&amp; deletedNoteIds != null) {
 856  
 857              for (int i=0; i &lt; deletedNoteIds.size(); i++) {
 858                  Note deletedNote = null;
 859                  try {
 860                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 861                  } catch (BucketObjectMissingException e) {
 862                      return;
 863                  }
 864                  if (deletedNote != null) {
 865                      deletedNote.setDeleted(false);
 866                      deletedNote.setModificationDate(Calendar.getInstance());
 867                      deletedNote.save();
 868                      NoteListFragment fragment = getNoteListFragment();
 869                      if (fragment != null) {
 870                          fragment.getPrefs();
 871                          fragment.refreshList();
 872                      }
 873                  }
 874              }
 875          }
 876      }
 877  
 878      @Override
 879      protected void onPostCreate(Bundle savedInstanceState) {
 880          super.onPostCreate(savedInstanceState);
 881          // Sync the toggle state after onRestoreInstanceState has occurred.
 882          mDrawerToggle.syncState();
 883      }
 884  
 885      @Override
 886      public void onConfigurationChanged(Configuration newConfig) {
 887          super.onConfigurationChanged(newConfig);
 888  
 889          mDrawerToggle.onConfigurationChanged(newConfig);
 890  
 891          if (mIsLargeScreen) {
 892              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 893                  // Add the editor fragment
 894                  mIsLandscape = true;
 895                  addEditorFragment();
 896                  if (mNoteListFragment != null) {
 897                      mNoteListFragment.setActivateOnItemClick(true);
 898                      mNoteListFragment.setDividerVisible(true);
 899                  }
 900                  // Select the current note on a tablet
 901                  if (mCurrentNote != null)
 902                      onNoteSelected(mCurrentNote.getSimperiumKey(), false, null);
 903                  else {
 904                      mNoteEditorFragment.setPlaceholderVisible(true);
 905                      mNoteListFragment.getListView().clearChoices();
 906                  }
 907                  invalidateOptionsMenu();
<abbr title=" 908              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {"> 908              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null)ðŸ”µ</abbr>
 909                  // Remove the editor fragment when rotating back to portrait
 910                  mIsLandscape = false;
 911                  mCurrentNote = null;
 912                  if (mNoteListFragment != null) {
 913                      mNoteListFragment.setActivateOnItemClick(false);
 914                      mNoteListFragment.setDividerVisible(false);
 915                      mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 916                      mNoteListFragment.refreshList();
 917                  }
 918                  FragmentManager fm = getFragmentManager();
 919                  FragmentTransaction ft = fm.beginTransaction();
 920                  ft.remove(mNoteEditorFragment);
 921                  mNoteEditorFragment = null;
 922                  ft.commitAllowingStateLoss();
 923                  fm.executePendingTransactions();
 924                  invalidateOptionsMenu();
 925              }
 926          }
 927      }
 928  
 929      public void checkEmptyListText(boolean isSearch) {
 930          if (isSearch) {
<abbr title=" 931              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);"> 931              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
 932              getNoteListFragment().setEmptyListViewClickable(false);
 933          } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title=" 934              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);"> 934              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 935 -            EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;viewed_trash&quot;, &quot;trash_filter_selected&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 936 +            mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 937 +                    new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 938 +                            .setCategory(&quot;user&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 939 +                            .setAction(&quot;viewed_trash&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 940 +                            .setLabel(&quot;trash_filter_selected&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 941 +                            .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 942 +            );</span>
 943              getNoteListFragment().setEmptyListViewClickable(false);
 944          } else {
<abbr title=" 945              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 945              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
 946              getNoteListFragment().setEmptyListViewClickable(true);
 947          }
 948      }
 949  
 950      public void showDetailPlaceholder() {
 951          if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 952              mCurrentNote = null;
 953              mNoteEditorFragment.setPlaceholderVisible(true);
 954              invalidateOptionsMenu();
 955          }
 956      }
 957  
 958      public void stopListeningToNotesBucket() {
 959          mNotesBucket.removeOnNetworkChangeListener(this);
 960          mNotesBucket.removeOnSaveObjectListener(this);
 961          mNotesBucket.removeOnDeleteObjectListener(this);
 962      }
 963  
 964      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
 965          if (mUndoBarController != null) {
 966              mUndoBarController.setDeletedNoteIds(noteIds);
<abbr title=" 967              mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()), null);"> 967              mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_notes, noteIdðŸ”µ</abbr>
 968          }
 969      }
 970  
 971      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 972  
 973          @Override
 974          protected Void doInBackground(Void... voids) {
 975              Simplenote application = (Simplenote) getApplication();
 976              Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 977              Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 978              Bucket.ObjectCursor c = query.execute();
 979              while (c.moveToNext()) {
 980                  c.getObject().delete();
 981              }
 982              return null;
 983          }
 984  
 985          @Override
 986          protected void onPostExecute(Void nada) {
 987              showDetailPlaceholder();
 988          }
 989      }
 990  
 991  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            