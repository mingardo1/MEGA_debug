<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>273</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    273
                    <a href="272.html">prev</a>
                    <a href="274.html">next</a>
                    <a href="273_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_a7cd7082e498c729c448f021ebf72d3234bc2186_Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;a7cd7082e498c729c448f021ebf72d3234bc2186:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;a7cd7082e498c729c448f021ebf72d3234bc2186^1:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;a7cd7082e498c729c448f021ebf72d3234bc2186^2:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;e8c0cc6eb145965734732c7ccbf4c00c49ed6e23:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [j], [s]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.ActionBar;
   4 import android.app.Activity;
   5 import android.app.AlertDialog;
   6 import android.app.FragmentManager;
   7 import android.app.FragmentTransaction;
   8 import android.content.DialogInterface;
   9 import android.content.Intent;
  10 import android.content.SharedPreferences;
  11 import android.content.res.Configuration;
  12 import android.os.AsyncTask;
  13 import android.os.Build;
  14 import android.os.Bundle;
  15 import android.os.Parcelable;
  16 import android.preference.PreferenceManager;
  17 import android.support.v4.app.ActionBarDrawerToggle;
  18 import android.support.v4.widget.DrawerLayout;
  19 import android.text.Spannable;
  20 import android.text.SpannableString;
  21 import android.text.TextUtils;
  22 import android.view.Menu;
  23 import android.view.MenuInflater;
  24 import android.view.MenuItem;
  25 import android.view.View;
  26 import android.view.Window;
  27 import android.widget.AdapterView;
  28 import android.widget.ListView;
  29 import android.widget.SearchView;
  30 
  31 import com.automattic.simplenote.models.Note;
  32 import com.automattic.simplenote.models.Tag;
  33 import com.automattic.simplenote.utils.PrefUtils;
  34 import com.automattic.simplenote.utils.StrUtils;
  35 import com.automattic.simplenote.utils.TagsAdapter;
  36 import com.automattic.simplenote.utils.ThemeUtils;
  37 import com.automattic.simplenote.widgets.TypefaceSpan;
  38 import com.automattic.simplenote.utils.UndoBarController;
  39 import com.google.android.gms.analytics.HitBuilders;
  40 import com.google.android.gms.analytics.Tracker;
  41 import com.simperium.Simperium;
  42 import com.simperium.android.LoginActivity;
  43 import com.simperium.client.Bucket;
  44 import com.simperium.client.BucketObjectMissingException;
  45 import com.simperium.client.BucketObjectNameInvalid;
  46 import com.simperium.client.Query;
  47 import com.simperium.client.User;
  48 
  49 import java.util.ArrayList;
  50 import java.util.Calendar;
  51 import java.util.List;
  52 
  53 public class NotesActivity extends Activity implements
<abbr title="  54         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  54         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  55         Bucket.Listener&lt;Note&gt; {
  56 
  57     private boolean mIsLargeScreen, mIsLandscape, mShouldSelectNewNote;
  58     private String mTabletSearchQuery;
  59     private UndoBarController mUndoBarController;
  60     private SearchView mSearchView;
  61     private MenuItem mSearchMenuItem;
  62     private NoteListFragment mNoteListFragment;
  63     private NoteEditorFragment mNoteEditorFragment;
  64     private Note mCurrentNote;
  65     protected Bucket&lt;Note&gt; mNotesBucket;
  66     protected Bucket&lt;Tag&gt; mTagsBucket;
  67     private int TRASH_SELECTED_ID = 1;
  68     private ActionBar mActionBar;
  69     private MenuItem mEmptyTrashMenuItem;
  70 
  71     // Menu drawer
  72     private DrawerLayout mDrawerLayout;
  73     private ListView mDrawerList;
  74     private ActionBarDrawerToggle mDrawerToggle;
  75     private TagsAdapter mTagsAdapter;
  76     private TagsAdapter.TagMenuItem mSelectedTag;
  77     private CharSequence mActionBarTitle;
  78 
  79     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  80     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  81 
  82     // Google Analytics tracker
  83     private Tracker mTracker;
  84 
  85     @Override
  86     protected void onCreate(Bundle savedInstanceState) {
  87         requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);
  88 
  89         ThemeUtils.setTheme(this);
  90 
  91         super.onCreate(savedInstanceState);
  92         Simplenote currentApp = (Simplenote) getApplication();
  93 
  94         if (mNotesBucket == null)
  95             mNotesBucket = currentApp.getNotesBucket();
  96 
  97         if (mTagsBucket == null)
  98             mTagsBucket = currentApp.getTagsBucket();
  99 
 100         setContentView(R.layout.activity_notes);
 101 
 102         mTracker = currentApp.getTracker();
 103 
 104         if (savedInstanceState == null) {
 105             mNoteListFragment = new NoteListFragment();
 106             FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
 107             fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
 108             fragmentTransaction.commit();
 109         } else {
 110             mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 111         }
 112 
 113         Configuration config = getBaseContext().getResources().getConfiguration();
 114         if ((config.screenLayout
 115                 &amp; Configuration.SCREENLAYOUT_SIZE_MASK)
 116                 &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {
 117             mIsLargeScreen = true;
 118 
 119             if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 120                 mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 120                 mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTðŸ”µ</abbr>
 121             } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 122                 mIsLandscape = true;
 123                 addEditorFragment();
 124             }
 125         }
 126 
 127         // Set up the menu drawer
 128         mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);
 129         mDrawerList = (ListView) findViewById(R.id.left_drawer);
 130         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 131         mDrawerList.setAdapter(mTagsAdapter);
 132         // Set the list&#x27;s click listener
 133         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 134 
 135         if (mSelectedTag == null)
 136             mSelectedTag = mTagsAdapter.getDefaultItem();
 137 
 138         // enable ActionBar app icon to behave as action to toggle nav drawer
 139         mActionBar = getActionBar();
 140         mActionBar.setDisplayHomeAsUpEnabled(true);
 141         mActionBar.setHomeButtonEnabled(true);
 142 
 143         // ActionBarDrawerToggle ties together the the proper interactions
 144         // between the sliding drawer and the action bar app icon
 145         mDrawerToggle = new ActionBarDrawerToggle(
 146                 this,
 147                 mDrawerLayout,
 148                 R.drawable.ic_drawer,
 149                 R.string.open_drawer,
 150                 R.string.close_drawer
 151         ) {
 152             public void onDrawerClosed(View view) {
 153                 setTitle(mActionBarTitle);
 154                 invalidateOptionsMenu();
 155             }
 156 
 157             public void onDrawerOpened(View drawerView) {
 158                 setTitleWithCustomFont(getString(R.string.app_name));
 159                 invalidateOptionsMenu();
 160             }
 161         };
 162         mDrawerLayout.setDrawerListener(mDrawerToggle);
 163 
 164         mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);
 165 
 166         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 167             // Create the welcome note
 168             try {
 169                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 170                 welcomeNote.setCreationDate(Calendar.getInstance());
 171                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 172                 welcomeNote.setContent(getString(R.string.welcome_note));
 173                 welcomeNote.getTitle();
 174                 welcomeNote.save();
 175             } catch (BucketObjectNameInvalid e) {
 176                 // this won&#x27;t happen because welcome-android is a valid name
 177             }
 178 
 179             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 180             SharedPreferences.Editor editor = preferences.edit();
 181             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 182             editor.commit();
 183         }
 184 
 185         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 186             // Check share action
 187             Intent intent = getIntent();
 188             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 189             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 190 
<abbr title=" 191             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 191             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 192             String intentAction = StrUtils.notNullStr(intent.getAction());
 193             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 194             if (!TextUtils.isEmpty(text)) {
 195                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 196                     text = subject + &quot;\n\n&quot; + text;
 197                 }
 198                 Note note = mNotesBucket.newObject();
 199                 note.setCreationDate(Calendar.getInstance());
 200                 note.setModificationDate(note.getCreationDate());
 201                 note.setContent(text);
 202                 note.save();
 203                 setCurrentNote(note);
 204 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205                 if (!isVoiceShare) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206                     mShouldSelectNewNote = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 209                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, isVoiceShare ? &quot;google_voice_command&quot; : &quot;external_share&quot;, null);"> 209                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, isVoiceShare ? &quot;google_voice_command&quot; : &quot;externðŸ”µ</abbr></span>
 210 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211                 setCurrentNote(note);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212                 mShouldSelectNewNote = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;external_share&quot;, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216         currentApp.getSimperium().setOnUserCreatedListener(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217         currentApp.getSimperium().setUserStatusChangeListener(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218         setProgressBarIndeterminateVisibility(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221     @Override</span>
 222 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223                 mShouldSelectNewNote = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224                 mTracker.send(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225                         new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226                                 .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227                                 .setAction(&quot;create_note&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228                                 .setLabel(&quot;external_share&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229                                 .build()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230                 );</span>
 231 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 232             }
 233         }
 234         currentApp.getSimperium().setOnUserCreatedListener(this);
 235         currentApp.getSimperium().setUserStatusChangeListener(this);
 236         setProgressBarIndeterminateVisibility(false);
 237     }
 238 
 239     @Override
 240     protected void onResume() {
 241         super.onResume();
 242 
 243         // Ensure user has valid authorization
 244         if (userAuthenticationIsInvalid())
 245             startLoginActivity(true);
 246 
 247         mNotesBucket.start();
 248         mTagsBucket.start();
 249 
 250         mNotesBucket.addOnNetworkChangeListener(this);
 251         mNotesBucket.addOnSaveObjectListener(this);
 252         mNotesBucket.addOnDeleteObjectListener(this);
 253         mTagsBucket.addListener(mTagsMenuUpdater);
 254 
 255         updateNavigationDrawerItems();
 256 
 257         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 258         Simplenote currentApp = (Simplenote)getApplication();
 259         if (currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED) {
 260             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 261                 mSelectedTag = null;
 262                 mDrawerList.setSelection(mTagsAdapter.DEFAULT_ITEM_POSITION);
 263             }
 264         }
 265 
 266         setSelectedTagActive();
 267 
 268         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 269             onNoteSelected(mCurrentNote.getSimperiumKey(), true, null);
 270             mShouldSelectNewNote = false;
 271         }
 272     }
 273 
 274     @Override
 275     protected void onPause() {
 276         super.onPause();
 277 
 278         mTagsBucket.removeListener(mTagsMenuUpdater);
 279 
 280         mNotesBucket.removeOnNetworkChangeListener(this);
 281         mNotesBucket.removeOnSaveObjectListener(this);
 282         mNotesBucket.removeOnDeleteObjectListener(this);
 283     }
 284 
 285     @Override
 286     public void setTitle(CharSequence title) {
 287         mActionBarTitle = (title != null) ? title : &quot;&quot;;
 288         setTitleWithCustomFont(mActionBarTitle);
 289     }
 290 
 291     private void setTitleWithCustomFont(CharSequence title) {
 292         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 293         if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 294                 &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 295             mActionBar.setTitle(title);
 296             return;
 297         }
 298 
 299         SpannableString s = new SpannableString(title);
 300         s.setSpan(new TypefaceSpan(this), 0, s.length(),
 301                 Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 302         mActionBar.setTitle(s);
 303     }
 304 
 305     private void updateNavigationDrawerItems() {
 306         Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 307         mTagsAdapter.changeCursor(tagCursor);
 308     }
 309 
 310     private void setSelectedTagActive() {
 311         if (mSelectedTag == null)
 312             mSelectedTag = mTagsAdapter.getDefaultItem();
 313 
 314         setTitle(mSelectedTag.name);
 315         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag), true);
 316     }
 317 
 318     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 319     public void updateTrashMenuItem() {
 320         if (mEmptyTrashMenuItem == null)
 321             return;
 322         // Disable the trash icon if there are no notes trashed.
 323         Simplenote application = (Simplenote) getApplication();
 324         Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 325         Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 326         if (query.count() == 0) {
 327             mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash_disabled);
 328             mEmptyTrashMenuItem.setEnabled(false);
 329         } else {
 330             mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash);
 331             mEmptyTrashMenuItem.setEnabled(true);
 332         }
 333     }
 334 
 335     /* The click listener for ListView in the navigation drawer */
 336     private class DrawerItemClickListener implements ListView.OnItemClickListener {
 337         @Override
 338         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 339 
 340             mSelectedTag = mTagsAdapter.getItem(position);
 341             checkEmptyListText(false);
 342             // Update checked item in navigation drawer and close it
 343             setSelectedTagActive();
 344             mDrawerLayout.closeDrawer(mDrawerList);
 345 
 346             // Disable long press on notes if we&#x27;re viewing the trash
 347             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 348                 getNoteListFragment().getListView().setLongClickable(false);
 349             } else {
 350                 getNoteListFragment().getListView().setLongClickable(true);
 351             }
 352 
 353             getNoteListFragment().refreshListFromNavSelect();
 354             if (position &gt; 1) {
 355                 mTracker.send(
 356                         new HitBuilders.EventBuilder()
 357                                 .setCategory(&quot;tag&quot;)
 358                                 .setAction(&quot;viewed_notes_for_tag&quot;)
 359                                 .setLabel(&quot;selected_tag_in_navigation_drawer&quot;)
 360                                 .build()
 361                 );
 362             }
 363         }
 364     }
 365 
 366     public TagsAdapter.TagMenuItem getSelectedTag() {
 367         return mSelectedTag;
 368     }
 369 
 370     private void addEditorFragment() {
 371         FragmentManager fm = getFragmentManager();
 372         FragmentTransaction ft = fm.beginTransaction();
 373         mNoteEditorFragment = new NoteEditorFragment();
 374         ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 375         ft.commitAllowingStateLoss();
 376         fm.executePendingTransactions();
 377     }
 378 
 379     /**
 380      * Checks for a previously valid user that is now not authenticated
 381      *
 382      * @return true if user has invalid authorization
 383      */
 384     private boolean userAuthenticationIsInvalid() {
 385         Simplenote currentApp = (Simplenote) getApplication();
 386         Simperium simperium = currentApp.getSimperium();
 387         User user = simperium.getUser();
 388         return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 389     }
 390 
 391     public void setCurrentNote(Note note) {
 392         mCurrentNote = note;
 393     }
 394 
 395     // received a change from the network, refresh the list
 396     @Override
 397     public void onChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
 398         runOnUiThread(new Runnable() {
 399             @Override
 400             public void run() {
 401                 if (type == Bucket.ChangeType.INDEX)
 402                     setProgressBarIndeterminateVisibility(false);
 403                 mNoteListFragment.refreshList();
 404             }
 405         });
 406     }
 407 
 408     @Override
 409     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 410         runOnUiThread(new Runnable() {
 411             @Override
 412             public void run() {
 413                 mNoteListFragment.refreshList();
 414             }
 415         });
 416     }
 417 
 418     @Override
 419     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 420         runOnUiThread(new Runnable() {
 421             @Override
 422             public void run() {
 423                 mNoteListFragment.refreshList();
 424             }
 425         });
 426     }
 427 
 428     @Override
 429     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 430 
 431         // noop, NoteEditorFragment will handle this
 432 
 433     }
 434 
 435     // Tags bucket listener
 436     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 437         void updateNavigationDrawer() {
 438             runOnUiThread(new Runnable() {
 439                 public void run() {
 440                     updateNavigationDrawerItems();
 441                 }
 442             });
 443         }
 444 
 445         @Override
 446         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 447             updateNavigationDrawer();
 448         }
 449 
 450         @Override
 451         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 452             updateNavigationDrawer();
 453         }
 454 
 455         @Override
 456         public void onChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 457             updateNavigationDrawer();
 458         }
 459 
 460         @Override
 461         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 462             // noop
 463         }
 464     };
 465 
 466     public boolean isLargeScreenLandscape() {
 467         return mIsLargeScreen &amp;&amp; mIsLandscape;
 468     }
 469 
 470     // nbradbury 01-Apr-2013
 471     public NoteListFragment getNoteListFragment() {
 472         return mNoteListFragment;
 473     }
 474 
 475     @Override
 476     public boolean onCreateOptionsMenu(Menu menu) {
 477         super.onCreateOptionsMenu(menu);
 478         MenuInflater inflater = getMenuInflater();
 479         inflater.inflate(R.menu.notes_list, menu);
 480 
 481         boolean drawerOpen = mDrawerLayout.isDrawerOpen(mDrawerList);
 482 
 483         // restore the search query if on a landscape tablet
 484         String searchQuery = null;
 485         if (isLargeScreenLandscape() &amp;&amp; mSearchView != null)
 486             searchQuery = mSearchView.getQuery().toString();
 487 
 488         mSearchMenuItem = menu.findItem(R.id.menu_search);
 489         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 490 
 491         // Set a custom search view drawable
<abbr title=" 492         int searchPlateId = mSearchView.getContext().getResources().getIdentifier(&quot;android:id/search_plate&quot;, null, null);"> 492         int searchPlateId = mSearchView.getContext().getResources().getIdentifier(&quot;android:id/search_platðŸ”µ</abbr>
 493         View searchPlate = mSearchView.findViewById(searchPlateId);
 494         if (searchPlate != null)
 495             searchPlate.setBackgroundResource(R.drawable.search_view_selector);
 496 
 497         if (!TextUtils.isEmpty(searchQuery)) {
 498             mSearchView.setQuery(searchQuery, false);
 499             mSearchMenuItem.expandActionView();
 500         }
 501 
 502         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 503             @Override
 504             public boolean onQueryTextChange(String newText) {
 505                 if (mSearchMenuItem.isActionViewExpanded()) {
 506                     getNoteListFragment().searchNotes(newText);
 507                 }
 508                 return true;
 509             }
 510 
 511             @Override
 512             public boolean onQueryTextSubmit(String queryText) {
 513                 getNoteListFragment().searchNotes(queryText);
 514                 return true;
 515             }
 516 
 517         });
 518         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 519             @Override
 520             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 521                 checkEmptyListText(true);
 522                 getNoteListFragment().hideWelcomeView();
 523                 mTracker.send(
 524                         new HitBuilders.EventBuilder()
 525                                 .setCategory(&quot;note&quot;)
 526                                 .setAction(&quot;searched_notes&quot;)
 527                                 .setLabel(&quot;action_bar_search_tap&quot;)
 528                                 .build()
 529                 );
 530                 return true;
 531             }
 532 
 533             @Override
 534             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 535                 // Show all notes again
 536                 mTabletSearchQuery = &quot;&quot;;
 537                 mSearchView.setQuery(&quot;&quot;, false);
 538                 checkEmptyListText(false);
 539                 getNoteListFragment().clearSearch();
 540                 getNoteListFragment().setWelcomeViewVisibility();
 541                 return true;
 542             }
 543         });
 544 
 545         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 546             @Override
 547             public boolean onMenuItemClick(MenuItem item) {
 548                 if (!mSearchMenuItem.isActionViewExpanded())
 549                     showDetailPlaceholder();
 550                 return false;
 551             }
 552         });
 553 
 554         // Restore the search query on landscape tablets
 555         if (isLargeScreenLandscape() &amp;&amp; !TextUtils.isEmpty(mTabletSearchQuery)) {
 556             mSearchView.setQuery(mTabletSearchQuery, false);
 557             mSearchMenuItem.expandActionView();
 558             mSearchView.clearFocus();
 559         }
 560 
 561         Simplenote currentApp = (Simplenote) getApplication();
 562         menu.findItem(R.id.menu_sign_in).setVisible(currentApp.getSimperium().needsAuthorization());
 563 
 564 
 565         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 566         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 567             trashItem.setTitle(R.string.undelete);
 568         else
 569             trashItem.setTitle(R.string.delete);
 570 
 571         if (isLargeScreenLandscape()) {
 572             menu.findItem(R.id.menu_create_note).setVisible(!drawerOpen);
 573             menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 574             menu.findItem(R.id.menu_preferences).setVisible(true);
 575             if (mCurrentNote != null) {
 576                 menu.findItem(R.id.menu_share).setVisible(!drawerOpen);
 577                 trashItem.setVisible(true);
 578             } else {
 579                 menu.findItem(R.id.menu_share).setVisible(false);
 580                 trashItem.setVisible(false);
 581             }
 582             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 583             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 584         } else {
 585             menu.findItem(R.id.menu_create_note).setVisible(!drawerOpen);
 586             menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 587             menu.findItem(R.id.menu_preferences).setVisible(true);
 588             menu.findItem(R.id.menu_share).setVisible(false);
 589             trashItem.setVisible(false);
 590             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 591             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 592         }
 593 
 594         // Are we looking at the trash? Adjust menu accordingly.
 595         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 596             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 597             mEmptyTrashMenuItem.setVisible(!drawerOpen);
 598 
 599             updateTrashMenuItem();
 600 
 601             menu.findItem(R.id.menu_create_note).setVisible(false);
 602             menu.findItem(R.id.menu_search).setVisible(false);
 603             menu.findItem(R.id.menu_share).setVisible(false);
 604         }
 605 
 606         return true;
 607     }
 608 
 609     @Override
 610     public boolean onOptionsItemSelected(MenuItem item) {
 611         if (mDrawerToggle.onOptionsItemSelected(item)) {
 612             return true;
 613         }
 614         switch (item.getItemId()) {
 615             case R.id.menu_preferences:
<abbr title=" 616                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 616                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returnðŸ”µ</abbr>
 617                 Intent i = new Intent(this, PreferencesActivity.class);
 618                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 619                 return true;
 620             case R.id.menu_sign_in:
 621                 startLoginActivity(true);
 622                 return true;
 623             case R.id.menu_edit_tags:
 624                 Intent editTagsIntent = new Intent(this, TagsListActivity.class);
 625                 startActivity(editTagsIntent);
 626                 return true;
 627             case R.id.menu_create_note:
 628                 getNoteListFragment().addNote();
 629                 mTracker.send(
 630                         new HitBuilders.EventBuilder()
 631                                 .setCategory(&quot;note&quot;)
 632                                 .setAction(&quot;create_note&quot;)
 633                                 .setLabel(&quot;action_bar_button&quot;)
 634                                 .build()
 635                 );
 636                 return true;
 637             case R.id.menu_share:
 638                 if (mCurrentNote != null) {
 639                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 640                     shareIntent.setType(&quot;text/plain&quot;);
 641                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 642                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 642                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
 643                     mTracker.send(
 644                             new HitBuilders.EventBuilder()
 645                                     .setCategory(&quot;note&quot;)
 646                                     .setAction(&quot;shared_note&quot;)
 647                                     .setLabel(&quot;action_bar_share_button&quot;)
 648                                     .build()
 649                     );
 650                 }
 651                 return true;
 652             case R.id.menu_delete:
 653                 if (mNoteEditorFragment != null) {
 654                     if (mCurrentNote != null) {
 655                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 656                         mCurrentNote.setModificationDate(Calendar.getInstance());
 657                         mCurrentNote.save();
 658 
 659                         if (mCurrentNote.isDeleted()) {
 660                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 661                             deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 662                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 663                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);"> 663                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null)ðŸ”µ</abbr>
 664                             mTracker.send(
 665                                     new HitBuilders.EventBuilder()
 666                                             .setCategory(&quot;note&quot;)
 667                                             .setAction(&quot;deleted_note&quot;)
 668                                             .setLabel(&quot;overflow_menu&quot;)
 669                                             .build()
 670                             );
 671                         } else {
 672                             mTracker.send(
 673                                     new HitBuilders.EventBuilder()
 674                                             .setCategory(&quot;note&quot;)
 675                                             .setAction(&quot;restored_note&quot;)
 676                                             .setLabel(&quot;overflow_menu&quot;)
 677                                             .build()
 678                             );
 679                         }
 680                         showDetailPlaceholder();
 681                     }
 682                     NoteListFragment fragment = getNoteListFragment();
 683                     if (fragment != null) {
 684                         fragment.getPrefs();
 685                         fragment.refreshList();
 686                     }
 687                 }
 688                 return true;
 689             case R.id.menu_empty_trash:
 690                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 691 
 692                 alert.setTitle(R.string.empty_trash);
 693                 alert.setMessage(R.string.confirm_empty_trash);
 694                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 695                     public void onClick(DialogInterface dialog, int whichButton) {
 696                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 697                         mTracker.send(
 698                                 new HitBuilders.EventBuilder()
 699                                         .setCategory(&quot;note&quot;)
 700                                         .setAction(&quot;trash_emptied&quot;)
 701                                         .setLabel(&quot;overflow_menu&quot;)
 702                                         .build()
 703                         );
 704                     }
 705                 });
 706                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 707                     public void onClick(DialogInterface dialog, int whichButton) {
 708                         // Do nothing, just closing the dialog
 709                     }
 710                 });
 711                 alert.show();
 712                 return true;
 713             case android.R.id.home:
 714                 invalidateOptionsMenu();
 715                 return true;
 716             default:
 717                 return super.onOptionsItemSelected(item);
 718         }
 719     }
 720 
 721     /**
 722      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 723      * the item with the given ID was selected.
 724      */
 725     @Override
 726     public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {
 727 
 728         if (!isLargeScreenLandscape()) {
 729             // Launch the editor activity
 730             Bundle arguments = new Bundle();
 731             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 732             arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);
 733 
 734             if (matchOffsets != null)
 735                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 736 
 737             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 738             editNoteIntent.putExtras(arguments);
 739             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 740         } else {
 741             mNoteEditorFragment.setIsNewNote(isNew);
 742             mNoteEditorFragment.setNote(noteID, matchOffsets);
 743             getNoteListFragment().setNoteSelected(noteID);
 744             if (mSearchView != null &amp;&amp; mSearchView.getQuery().length() &gt; 0) {
 745                 mTabletSearchQuery = mSearchView.getQuery().toString();
 746             }
 747             invalidateOptionsMenu();
 748         }
 749 
 750         mTracker.send(
 751                 new HitBuilders.EventBuilder()
 752                         .setCategory(&quot;note&quot;)
 753                         .setAction(&quot;viewed_note&quot;)
 754                         .setLabel(&quot;note_list_row_tap&quot;)
 755                         .build()
 756         );
 757     }
 758 
 759     @Override
 760     public void onUserCreated(User user) {
 761         // New account created
 762         mTracker.send(
 763                 new HitBuilders.EventBuilder()
 764                         .setCategory(&quot;user&quot;)
 765                         .setAction(&quot;new_account_created&quot;)
 766                         .setLabel(&quot;account_created_from_login_activity&quot;)
 767                         .build()
 768         );
 769     }
 770 
 771     public void onUserStatusChange(User.Status status) {
 772         switch (status) {
 773 
 774             // successfully used access token to connect to simperium bucket
 775             case AUTHORIZED:
 776                 mTracker.send(
 777                         new HitBuilders.EventBuilder()
 778                                 .setCategory(&quot;user&quot;)
 779                                 .setAction(&quot;signed_in&quot;)
 780                                 .setLabel(&quot;signed_in_from_login_activity&quot;)
 781                                 .build()
 782                 );
 783                 runOnUiThread(new Runnable() {
 784                     @Override
 785                     public void run() {
 786                         if (!mNotesBucket.hasChangeVersion()) {
 787                             setProgressBarIndeterminateVisibility(true);
 788                         }
 789                     }
 790                 });
 791                 break;
 792 
 793             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 794             case NOT_AUTHORIZED:
 795                 runOnUiThread(new Runnable() {
 796                     @Override
 797                     public void run() {
 798                         startLoginActivity(true);
 799                     }
 800                 });
 801                 break;
 802 
<abbr title=" 803             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 803             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 804             case UNKNOWN:
 805                 break;
 806         }
 807     }
 808 
 809     public void startLoginActivity(boolean signInFirst) {
 810         Intent loginIntent = new Intent(this, LoginActivity.class);
 811         if (signInFirst)
 812             loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 813         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 814     }
 815 
 816 
 817     @Override
 818     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 819         super.onActivityResult(requestCode, resultCode, data);
 820         switch (requestCode) {
 821             case Simplenote.INTENT_PREFERENCES:
 822                 if (ThemeUtils.themeWasChanged(data)) {
 823                     // Restart this activity to apply the new theme
 824                     recreate();
 825                     break;
 826                 }
<abbr title=" 827                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 827                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 828                 invalidateOptionsMenu();
 829                 NoteListFragment fragment = getNoteListFragment();
 830                 if (fragment != null) {
 831                     fragment.getPrefs();
 832                     fragment.refreshList();
 833                 }
 834                 break;
 835             case Simplenote.INTENT_EDIT_NOTE:
<abbr title=" 836                 if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {"> 836                 if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID))ðŸ”µ</abbr>
 837                     String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 838                     if (noteId != null) {
 839                         List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 840                         deletedNoteIds.add(noteId);
 841                         mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 842                         mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
 843                     }
 844                 }
 845                 break;
 846             case Simperium.SIGNUP_SIGNIN_REQUEST:
 847                 invalidateOptionsMenu();
 848                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 849                     finish();
 850                 }
 851                 break;
 852         }
 853     }
 854 
 855     @Override
 856     public void onUndo(Parcelable p) {
 857         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 858         if (mUndoBarController != null &amp;&amp; deletedNoteIds != null) {
 859 
 860             for (int i=0; i &lt; deletedNoteIds.size(); i++) {
 861                 Note deletedNote = null;
 862                 try {
 863                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 864                 } catch (BucketObjectMissingException e) {
 865                     return;
 866                 }
 867                 if (deletedNote != null) {
 868                     deletedNote.setDeleted(false);
 869                     deletedNote.setModificationDate(Calendar.getInstance());
 870                     deletedNote.save();
 871                     NoteListFragment fragment = getNoteListFragment();
 872                     if (fragment != null) {
 873                         fragment.getPrefs();
 874                         fragment.refreshList();
 875                     }
 876                 }
 877             }
 878         }
 879     }
 880 
 881     @Override
 882     protected void onPostCreate(Bundle savedInstanceState) {
 883         super.onPostCreate(savedInstanceState);
 884         // Sync the toggle state after onRestoreInstanceState has occurred.
 885         mDrawerToggle.syncState();
 886     }
 887 
 888     @Override
 889     public void onConfigurationChanged(Configuration newConfig) {
 890         super.onConfigurationChanged(newConfig);
 891 
 892         mDrawerToggle.onConfigurationChanged(newConfig);
 893 
 894         if (mIsLargeScreen) {
 895             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 896                 // Add the editor fragment
 897                 mIsLandscape = true;
 898                 addEditorFragment();
 899                 if (mNoteListFragment != null) {
 900                     mNoteListFragment.setActivateOnItemClick(true);
 901                     mNoteListFragment.setDividerVisible(true);
 902                 }
 903                 // Select the current note on a tablet
 904                 if (mCurrentNote != null)
 905                     onNoteSelected(mCurrentNote.getSimperiumKey(), false, null);
 906                 else {
 907                     mNoteEditorFragment.setPlaceholderVisible(true);
 908                     mNoteListFragment.getListView().clearChoices();
 909                 }
 910                 invalidateOptionsMenu();
<abbr title=" 911             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {"> 911             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragmentðŸ”µ</abbr>
 912                 // Remove the editor fragment when rotating back to portrait
 913                 mIsLandscape = false;
 914                 mCurrentNote = null;
 915                 if (mNoteListFragment != null) {
 916                     mNoteListFragment.setActivateOnItemClick(false);
 917                     mNoteListFragment.setDividerVisible(false);
 918                     mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 919                     mNoteListFragment.refreshList();
 920                 }
 921                 FragmentManager fm = getFragmentManager();
 922                 FragmentTransaction ft = fm.beginTransaction();
 923                 ft.remove(mNoteEditorFragment);
 924                 mNoteEditorFragment = null;
 925                 ft.commitAllowingStateLoss();
 926                 fm.executePendingTransactions();
 927                 invalidateOptionsMenu();
 928             }
 929         }
 930     }
 931 
 932     public void checkEmptyListText(boolean isSearch) {
 933         if (isSearch) {
<abbr title=" 934             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);"> 934             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
 935             getNoteListFragment().setEmptyListViewClickable(false);
 936         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title=" 937             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);"> 937             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
 938             mTracker.send(
 939                     new HitBuilders.EventBuilder()
 940                             .setCategory(&quot;user&quot;)
 941                             .setAction(&quot;viewed_trash&quot;)
 942                             .setLabel(&quot;trash_filter_selected&quot;)
 943                             .build()
 944             );
 945             getNoteListFragment().setEmptyListViewClickable(false);
 946         } else {
<abbr title=" 947             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 947             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
 948             getNoteListFragment().setEmptyListViewClickable(true);
 949         }
 950     }
 951 
 952     public void showDetailPlaceholder() {
 953         if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 954             mCurrentNote = null;
 955             mNoteEditorFragment.setPlaceholderVisible(true);
 956             invalidateOptionsMenu();
 957         }
 958     }
 959 
 960     public void stopListeningToNotesBucket() {
 961         mNotesBucket.removeOnNetworkChangeListener(this);
 962         mNotesBucket.removeOnSaveObjectListener(this);
 963         mNotesBucket.removeOnDeleteObjectListener(this);
 964     }
 965 
 966     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
 967         if (mUndoBarController != null) {
 968             mUndoBarController.setDeletedNoteIds(noteIds);
<abbr title=" 969             mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()), null);"> 969             mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_noteðŸ”µ</abbr>
 970         }
 971     }
 972 
 973     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 974 
 975         @Override
 976         protected Void doInBackground(Void... voids) {
 977             Simplenote application = (Simplenote) getApplication();
 978             Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 979             Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 980             Bucket.ObjectCursor c = query.execute();
 981             while (c.moveToNext()) {
 982                 c.getObject().delete();
 983             }
 984             return null;
 985         }
 986 
 987         @Override
 988         protected void onPostExecute(Void nada) {
 989             showDetailPlaceholder();
 990         }
 991     }
 992 
 993 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.ActionBar;
   4 import android.app.Activity;
   5 import android.app.AlertDialog;
   6 import android.app.FragmentManager;
   7 import android.app.FragmentTransaction;
   8 import android.content.DialogInterface;
   9 import android.content.Intent;
  10 import android.content.SharedPreferences;
  11 import android.content.res.Configuration;
  12 import android.os.AsyncTask;
  13 import android.os.Build;
  14 import android.os.Bundle;
  15 import android.os.Parcelable;
  16 import android.preference.PreferenceManager;
  17 import android.support.v4.app.ActionBarDrawerToggle;
  18 import android.support.v4.widget.DrawerLayout;
  19 import android.text.Spannable;
  20 import android.text.SpannableString;
  21 import android.text.TextUtils;
  22 import android.view.Menu;
  23 import android.view.MenuInflater;
  24 import android.view.MenuItem;
  25 import android.view.View;
  26 import android.view.Window;
  27 import android.widget.AdapterView;
  28 import android.widget.ListView;
  29 import android.widget.SearchView;
  30 
  31 import com.automattic.simplenote.models.Note;
  32 import com.automattic.simplenote.models.Tag;
  33 import com.automattic.simplenote.utils.PrefUtils;
  34 import com.automattic.simplenote.utils.StrUtils;
  35 import com.automattic.simplenote.utils.TagsAdapter;
  36 import com.automattic.simplenote.utils.ThemeUtils;
  37 import com.automattic.simplenote.widgets.TypefaceSpan;
  38 import com.automattic.simplenote.utils.UndoBarController;
  39 import com.google.android.gms.analytics.HitBuilders;
  40 import com.google.android.gms.analytics.Tracker;
  41 import com.simperium.Simperium;
  42 import com.simperium.android.LoginActivity;
  43 import com.simperium.client.Bucket;
  44 import com.simperium.client.BucketObjectMissingException;
  45 import com.simperium.client.BucketObjectNameInvalid;
  46 import com.simperium.client.Query;
  47 import com.simperium.client.User;
  48 
  49 import java.util.ArrayList;
  50 import java.util.Calendar;
  51 import java.util.List;
  52 
  53 public class NotesActivity extends Activity implements
<abbr title="  54         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  54         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  55         Bucket.Listener&lt;Note&gt; {
  56 
  57     private boolean mIsLargeScreen, mIsLandscape, mShouldSelectNewNote;
  58     private String mTabletSearchQuery;
  59     private UndoBarController mUndoBarController;
  60     private SearchView mSearchView;
  61     private MenuItem mSearchMenuItem;
  62     private NoteListFragment mNoteListFragment;
  63     private NoteEditorFragment mNoteEditorFragment;
  64     private Note mCurrentNote;
  65     protected Bucket&lt;Note&gt; mNotesBucket;
  66     protected Bucket&lt;Tag&gt; mTagsBucket;
  67     private int TRASH_SELECTED_ID = 1;
  68     private ActionBar mActionBar;
  69     private MenuItem mEmptyTrashMenuItem;
  70 
  71     // Menu drawer
  72     private DrawerLayout mDrawerLayout;
  73     private ListView mDrawerList;
  74     private ActionBarDrawerToggle mDrawerToggle;
  75     private TagsAdapter mTagsAdapter;
  76     private TagsAdapter.TagMenuItem mSelectedTag;
  77     private CharSequence mActionBarTitle;
  78 
  79     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  80     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  81 
  82     // Google Analytics tracker
  83     private Tracker mTracker;
  84 
  85     @Override
  86     protected void onCreate(Bundle savedInstanceState) {
  87         requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);
  88 
  89         ThemeUtils.setTheme(this);
  90 
  91         super.onCreate(savedInstanceState);
  92         Simplenote currentApp = (Simplenote) getApplication();
  93 
  94         if (mNotesBucket == null)
  95             mNotesBucket = currentApp.getNotesBucket();
  96 
  97         if (mTagsBucket == null)
  98             mTagsBucket = currentApp.getTagsBucket();
  99 
 100         setContentView(R.layout.activity_notes);
 101 
 102         mTracker = currentApp.getTracker();
 103 
 104         if (savedInstanceState == null) {
 105             mNoteListFragment = new NoteListFragment();
 106             FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
 107             fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
 108             fragmentTransaction.commit();
 109         } else {
 110             mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 111         }
 112 
 113         Configuration config = getBaseContext().getResources().getConfiguration();
 114         if ((config.screenLayout
 115                 &amp; Configuration.SCREENLAYOUT_SIZE_MASK)
 116                 &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {
 117             mIsLargeScreen = true;
 118 
 119             if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 120                 mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 120                 mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTðŸ”µ</abbr>
 121             } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 122                 mIsLandscape = true;
 123                 addEditorFragment();
 124             }
 125         }
 126 
 127         // Set up the menu drawer
 128         mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);
 129         mDrawerList = (ListView) findViewById(R.id.left_drawer);
 130         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 131         mDrawerList.setAdapter(mTagsAdapter);
 132         // Set the list&#x27;s click listener
 133         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 134 
 135         if (mSelectedTag == null)
 136             mSelectedTag = mTagsAdapter.getDefaultItem();
 137 
 138         // enable ActionBar app icon to behave as action to toggle nav drawer
 139         mActionBar = getActionBar();
 140         mActionBar.setDisplayHomeAsUpEnabled(true);
 141         mActionBar.setHomeButtonEnabled(true);
 142 
 143         // ActionBarDrawerToggle ties together the the proper interactions
 144         // between the sliding drawer and the action bar app icon
 145         mDrawerToggle = new ActionBarDrawerToggle(
 146                 this,
 147                 mDrawerLayout,
 148                 R.drawable.ic_drawer,
 149                 R.string.open_drawer,
 150                 R.string.close_drawer
 151         ) {
 152             public void onDrawerClosed(View view) {
 153                 setTitle(mActionBarTitle);
 154                 invalidateOptionsMenu();
 155             }
 156 
 157             public void onDrawerOpened(View drawerView) {
 158                 setTitleWithCustomFont(getString(R.string.app_name));
 159                 invalidateOptionsMenu();
 160             }
 161         };
 162         mDrawerLayout.setDrawerListener(mDrawerToggle);
 163 
 164         mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);
 165 
 166         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 167             // Create the welcome note
 168             try {
 169                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 170                 welcomeNote.setCreationDate(Calendar.getInstance());
 171                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 172                 welcomeNote.setContent(getString(R.string.welcome_note));
 173                 welcomeNote.getTitle();
 174                 welcomeNote.save();
 175             } catch (BucketObjectNameInvalid e) {
 176                 // this won&#x27;t happen because welcome-android is a valid name
 177             }
 178 
 179             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 180             SharedPreferences.Editor editor = preferences.edit();
 181             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 182             editor.commit();
 183         }
 184 
 185         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 186             // Check share action
 187             Intent intent = getIntent();
 188             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 189             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 190 
<abbr title=" 191             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 191             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 192             String intentAction = StrUtils.notNullStr(intent.getAction());
 193             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 194             if (!TextUtils.isEmpty(text)) {
 195                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 196                     text = subject + &quot;\n\n&quot; + text;
 197                 }
 198                 Note note = mNotesBucket.newObject();
 199                 note.setCreationDate(Calendar.getInstance());
 200                 note.setModificationDate(note.getCreationDate());
 201                 note.setContent(text);
 202                 note.save();
 203                 setCurrentNote(note);
 204                 if (!isVoiceShare) {
 205                 mShouldSelectNewNote = true;
 206 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 209                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, isVoiceShare ? &quot;google_voice_command&quot; : &quot;external_share&quot;, null);"> 209                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, isVoiceShare ? &quot;google_voice_command&quot; : &quot;externðŸ”µ</abbr></span>
 210 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211                 mShouldSelectNewNote = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;external_share&quot;, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215         currentApp.getSimperium().setOnUserCreatedListener(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216         currentApp.getSimperium().setUserStatusChangeListener(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217         setProgressBarIndeterminateVisibility(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218     }</span>
 219 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220                 mTracker.send(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221                         new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222                                 .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223                                 .setAction(&quot;create_note&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224                                 .setLabel(&quot;external_share&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225                                 .build()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226                 );</span>
 227 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 228             }
 229         }
 230         currentApp.getSimperium().setOnUserCreatedListener(this);
 231         currentApp.getSimperium().setUserStatusChangeListener(this);
 232         setProgressBarIndeterminateVisibility(false);
 233     }
 234 
 235     @Override
 236     protected void onResume() {
 237         super.onResume();
 238 
 239         // Ensure user has valid authorization
 240         if (userAuthenticationIsInvalid())
 241             startLoginActivity(true);
 242 
 243         mNotesBucket.start();
 244         mTagsBucket.start();
 245 
 246         mNotesBucket.addOnNetworkChangeListener(this);
 247         mNotesBucket.addOnSaveObjectListener(this);
 248         mNotesBucket.addOnDeleteObjectListener(this);
 249         mTagsBucket.addListener(mTagsMenuUpdater);
 250 
 251         updateNavigationDrawerItems();
 252 
 253         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 254         Simplenote currentApp = (Simplenote)getApplication();
 255         if (currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED) {
 256             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 257                 mSelectedTag = null;
 258                 mDrawerList.setSelection(mTagsAdapter.DEFAULT_ITEM_POSITION);
 259             }
 260         }
 261 
 262         setSelectedTagActive();
 263 
 264         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 265             onNoteSelected(mCurrentNote.getSimperiumKey(), true, null);
 266             mShouldSelectNewNote = false;
 267         }
 268     }
 269 
 270     @Override
 271     protected void onPause() {
 272         super.onPause();
 273 
 274         mTagsBucket.removeListener(mTagsMenuUpdater);
 275 
 276         mNotesBucket.removeOnNetworkChangeListener(this);
 277         mNotesBucket.removeOnSaveObjectListener(this);
 278         mNotesBucket.removeOnDeleteObjectListener(this);
 279     }
 280 
 281     @Override
 282     public void setTitle(CharSequence title) {
 283         mActionBarTitle = (title != null) ? title : &quot;&quot;;
 284         setTitleWithCustomFont(mActionBarTitle);
 285     }
 286 
 287     private void setTitleWithCustomFont(CharSequence title) {
 288         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 289         if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 290                 &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 291             mActionBar.setTitle(title);
 292             return;
 293         }
 294 
 295         SpannableString s = new SpannableString(title);
 296         s.setSpan(new TypefaceSpan(this), 0, s.length(),
 297                 Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 298         mActionBar.setTitle(s);
 299     }
 300 
 301     private void updateNavigationDrawerItems() {
 302         Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 303         mTagsAdapter.changeCursor(tagCursor);
 304     }
 305 
 306     private void setSelectedTagActive() {
 307         if (mSelectedTag == null)
 308             mSelectedTag = mTagsAdapter.getDefaultItem();
 309 
 310         setTitle(mSelectedTag.name);
 311         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag), true);
 312     }
 313 
 314     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 315     public void updateTrashMenuItem() {
 316         if (mEmptyTrashMenuItem == null)
 317             return;
 318         // Disable the trash icon if there are no notes trashed.
 319         Simplenote application = (Simplenote) getApplication();
 320         Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 321         Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 322         if (query.count() == 0) {
 323             mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash_disabled);
 324             mEmptyTrashMenuItem.setEnabled(false);
 325         } else {
 326             mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash);
 327             mEmptyTrashMenuItem.setEnabled(true);
 328         }
 329     }
 330 
 331     /* The click listener for ListView in the navigation drawer */
 332     private class DrawerItemClickListener implements ListView.OnItemClickListener {
 333         @Override
 334         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 335 
 336             mSelectedTag = mTagsAdapter.getItem(position);
 337             checkEmptyListText(false);
 338             // Update checked item in navigation drawer and close it
 339             setSelectedTagActive();
 340             mDrawerLayout.closeDrawer(mDrawerList);
 341 
 342             // Disable long press on notes if we&#x27;re viewing the trash
 343             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 344                 getNoteListFragment().getListView().setLongClickable(false);
 345             } else {
 346                 getNoteListFragment().getListView().setLongClickable(true);
 347             }
 348 
 349             getNoteListFragment().refreshListFromNavSelect();
 350             if (position &gt; 1) {
 351                 mTracker.send(
 352                         new HitBuilders.EventBuilder()
 353                                 .setCategory(&quot;tag&quot;)
 354                                 .setAction(&quot;viewed_notes_for_tag&quot;)
 355                                 .setLabel(&quot;selected_tag_in_navigation_drawer&quot;)
 356                                 .build()
 357                 );
 358             }
 359         }
 360     }
 361 
 362     public TagsAdapter.TagMenuItem getSelectedTag() {
 363         return mSelectedTag;
 364     }
 365 
 366     private void addEditorFragment() {
 367         FragmentManager fm = getFragmentManager();
 368         FragmentTransaction ft = fm.beginTransaction();
 369         mNoteEditorFragment = new NoteEditorFragment();
 370         ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 371         ft.commitAllowingStateLoss();
 372         fm.executePendingTransactions();
 373     }
 374 
 375     /**
 376      * Checks for a previously valid user that is now not authenticated
 377      *
 378      * @return true if user has invalid authorization
 379      */
 380     private boolean userAuthenticationIsInvalid() {
 381         Simplenote currentApp = (Simplenote) getApplication();
 382         Simperium simperium = currentApp.getSimperium();
 383         User user = simperium.getUser();
 384         return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 385     }
 386 
 387     public void setCurrentNote(Note note) {
 388         mCurrentNote = note;
 389     }
 390 
 391     // received a change from the network, refresh the list
 392     @Override
 393     public void onChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
 394         runOnUiThread(new Runnable() {
 395             @Override
 396             public void run() {
 397                 if (type == Bucket.ChangeType.INDEX)
 398                     setProgressBarIndeterminateVisibility(false);
 399                 mNoteListFragment.refreshList();
 400             }
 401         });
 402     }
 403 
 404     @Override
 405     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 406         runOnUiThread(new Runnable() {
 407             @Override
 408             public void run() {
 409                 mNoteListFragment.refreshList();
 410             }
 411         });
 412     }
 413 
 414     @Override
 415     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 416         runOnUiThread(new Runnable() {
 417             @Override
 418             public void run() {
 419                 mNoteListFragment.refreshList();
 420             }
 421         });
 422     }
 423 
 424     @Override
 425     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 426 
 427         // noop, NoteEditorFragment will handle this
 428 
 429     }
 430 
 431     // Tags bucket listener
 432     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 433         void updateNavigationDrawer() {
 434             runOnUiThread(new Runnable() {
 435                 public void run() {
 436                     updateNavigationDrawerItems();
 437                 }
 438             });
 439         }
 440 
 441         @Override
 442         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 443             updateNavigationDrawer();
 444         }
 445 
 446         @Override
 447         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 448             updateNavigationDrawer();
 449         }
 450 
 451         @Override
 452         public void onChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 453             updateNavigationDrawer();
 454         }
 455 
 456         @Override
 457         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 458             // noop
 459         }
 460     };
 461 
 462     public boolean isLargeScreenLandscape() {
 463         return mIsLargeScreen &amp;&amp; mIsLandscape;
 464     }
 465 
 466     // nbradbury 01-Apr-2013
 467     public NoteListFragment getNoteListFragment() {
 468         return mNoteListFragment;
 469     }
 470 
 471     @Override
 472     public boolean onCreateOptionsMenu(Menu menu) {
 473         super.onCreateOptionsMenu(menu);
 474         MenuInflater inflater = getMenuInflater();
 475         inflater.inflate(R.menu.notes_list, menu);
 476 
 477         boolean drawerOpen = mDrawerLayout.isDrawerOpen(mDrawerList);
 478 
 479         // restore the search query if on a landscape tablet
 480         String searchQuery = null;
 481         if (isLargeScreenLandscape() &amp;&amp; mSearchView != null)
 482             searchQuery = mSearchView.getQuery().toString();
 483 
 484         mSearchMenuItem = menu.findItem(R.id.menu_search);
 485         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 486 
 487         // Set a custom search view drawable
<abbr title=" 488         int searchPlateId = mSearchView.getContext().getResources().getIdentifier(&quot;android:id/search_plate&quot;, null, null);"> 488         int searchPlateId = mSearchView.getContext().getResources().getIdentifier(&quot;android:id/search_platðŸ”µ</abbr>
 489         View searchPlate = mSearchView.findViewById(searchPlateId);
 490         if (searchPlate != null)
 491             searchPlate.setBackgroundResource(R.drawable.search_view_selector);
 492 
 493         if (!TextUtils.isEmpty(searchQuery)) {
 494             mSearchView.setQuery(searchQuery, false);
 495             mSearchMenuItem.expandActionView();
 496         }
 497 
 498         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 499             @Override
 500             public boolean onQueryTextChange(String newText) {
 501                 if (mSearchMenuItem.isActionViewExpanded()) {
 502                     getNoteListFragment().searchNotes(newText);
 503                 }
 504                 return true;
 505             }
 506 
 507             @Override
 508             public boolean onQueryTextSubmit(String queryText) {
 509                 getNoteListFragment().searchNotes(queryText);
 510                 return true;
 511             }
 512 
 513         });
 514         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 515             @Override
 516             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 517                 checkEmptyListText(true);
 518                 getNoteListFragment().hideWelcomeView();
 519                 mTracker.send(
 520                         new HitBuilders.EventBuilder()
 521                                 .setCategory(&quot;note&quot;)
 522                                 .setAction(&quot;searched_notes&quot;)
 523                                 .setLabel(&quot;action_bar_search_tap&quot;)
 524                                 .build()
 525                 );
 526                 return true;
 527             }
 528 
 529             @Override
 530             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 531                 // Show all notes again
 532                 mTabletSearchQuery = &quot;&quot;;
 533                 mSearchView.setQuery(&quot;&quot;, false);
 534                 checkEmptyListText(false);
 535                 getNoteListFragment().clearSearch();
 536                 getNoteListFragment().setWelcomeViewVisibility();
 537                 return true;
 538             }
 539         });
 540 
 541         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 542             @Override
 543             public boolean onMenuItemClick(MenuItem item) {
 544                 if (!mSearchMenuItem.isActionViewExpanded())
 545                     showDetailPlaceholder();
 546                 return false;
 547             }
 548         });
 549 
 550         // Restore the search query on landscape tablets
 551         if (isLargeScreenLandscape() &amp;&amp; !TextUtils.isEmpty(mTabletSearchQuery)) {
 552             mSearchView.setQuery(mTabletSearchQuery, false);
 553             mSearchMenuItem.expandActionView();
 554             mSearchView.clearFocus();
 555         }
 556 
 557         Simplenote currentApp = (Simplenote) getApplication();
 558         menu.findItem(R.id.menu_sign_in).setVisible(currentApp.getSimperium().needsAuthorization());
 559 
 560 
 561         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 562         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 563             trashItem.setTitle(R.string.undelete);
 564         else
 565             trashItem.setTitle(R.string.delete);
 566 
 567         if (isLargeScreenLandscape()) {
 568             menu.findItem(R.id.menu_create_note).setVisible(!drawerOpen);
 569             menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 570             menu.findItem(R.id.menu_preferences).setVisible(true);
 571             if (mCurrentNote != null) {
 572                 menu.findItem(R.id.menu_share).setVisible(!drawerOpen);
 573                 trashItem.setVisible(true);
 574             } else {
 575                 menu.findItem(R.id.menu_share).setVisible(false);
 576                 trashItem.setVisible(false);
 577             }
 578             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 579             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 580         } else {
 581             menu.findItem(R.id.menu_create_note).setVisible(!drawerOpen);
 582             menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 583             menu.findItem(R.id.menu_preferences).setVisible(true);
 584             menu.findItem(R.id.menu_share).setVisible(false);
 585             trashItem.setVisible(false);
 586             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 587             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 588         }
 589 
 590         // Are we looking at the trash? Adjust menu accordingly.
 591         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 592             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 593             mEmptyTrashMenuItem.setVisible(!drawerOpen);
 594 
 595             updateTrashMenuItem();
 596 
 597             menu.findItem(R.id.menu_create_note).setVisible(false);
 598             menu.findItem(R.id.menu_search).setVisible(false);
 599             menu.findItem(R.id.menu_share).setVisible(false);
 600         }
 601 
 602         return true;
 603     }
 604 
 605     @Override
 606     public boolean onOptionsItemSelected(MenuItem item) {
 607         if (mDrawerToggle.onOptionsItemSelected(item)) {
 608             return true;
 609         }
 610         switch (item.getItemId()) {
 611             case R.id.menu_preferences:
<abbr title=" 612                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 612                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returnðŸ”µ</abbr>
 613                 Intent i = new Intent(this, PreferencesActivity.class);
 614                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 615                 return true;
 616             case R.id.menu_sign_in:
 617                 startLoginActivity(true);
 618                 return true;
 619             case R.id.menu_edit_tags:
 620                 Intent editTagsIntent = new Intent(this, TagsListActivity.class);
 621                 startActivity(editTagsIntent);
 622                 return true;
 623             case R.id.menu_create_note:
 624                 getNoteListFragment().addNote();
 625                 mTracker.send(
 626                         new HitBuilders.EventBuilder()
 627                                 .setCategory(&quot;note&quot;)
 628                                 .setAction(&quot;create_note&quot;)
 629                                 .setLabel(&quot;action_bar_button&quot;)
 630                                 .build()
 631                 );
 632                 return true;
 633             case R.id.menu_share:
 634                 if (mCurrentNote != null) {
 635                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 636                     shareIntent.setType(&quot;text/plain&quot;);
 637                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 638                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 638                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
 639                     mTracker.send(
 640                             new HitBuilders.EventBuilder()
 641                                     .setCategory(&quot;note&quot;)
 642                                     .setAction(&quot;shared_note&quot;)
 643                                     .setLabel(&quot;action_bar_share_button&quot;)
 644                                     .build()
 645                     );
 646                 }
 647                 return true;
 648             case R.id.menu_delete:
 649                 if (mNoteEditorFragment != null) {
 650                     if (mCurrentNote != null) {
 651                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 652                         mCurrentNote.setModificationDate(Calendar.getInstance());
 653                         mCurrentNote.save();
 654 
 655                         if (mCurrentNote.isDeleted()) {
 656                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 657                             deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 658                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 659                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);"> 659                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null)ðŸ”µ</abbr>
 660                             mTracker.send(
 661                                     new HitBuilders.EventBuilder()
 662                                             .setCategory(&quot;note&quot;)
 663                                             .setAction(&quot;deleted_note&quot;)
 664                                             .setLabel(&quot;overflow_menu&quot;)
 665                                             .build()
 666                             );
 667                         } else {
 668                             mTracker.send(
 669                                     new HitBuilders.EventBuilder()
 670                                             .setCategory(&quot;note&quot;)
 671                                             .setAction(&quot;restored_note&quot;)
 672                                             .setLabel(&quot;overflow_menu&quot;)
 673                                             .build()
 674                             );
 675                         }
 676                         showDetailPlaceholder();
 677                     }
 678                     NoteListFragment fragment = getNoteListFragment();
 679                     if (fragment != null) {
 680                         fragment.getPrefs();
 681                         fragment.refreshList();
 682                     }
 683                 }
 684                 return true;
 685             case R.id.menu_empty_trash:
 686                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 687 
 688                 alert.setTitle(R.string.empty_trash);
 689                 alert.setMessage(R.string.confirm_empty_trash);
 690                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 691                     public void onClick(DialogInterface dialog, int whichButton) {
 692                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 693                         mTracker.send(
 694                                 new HitBuilders.EventBuilder()
 695                                         .setCategory(&quot;note&quot;)
 696                                         .setAction(&quot;trash_emptied&quot;)
 697                                         .setLabel(&quot;overflow_menu&quot;)
 698                                         .build()
 699                         );
 700                     }
 701                 });
 702                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 703                     public void onClick(DialogInterface dialog, int whichButton) {
 704                         // Do nothing, just closing the dialog
 705                     }
 706                 });
 707                 alert.show();
 708                 return true;
 709             case android.R.id.home:
 710                 invalidateOptionsMenu();
 711                 return true;
 712             default:
 713                 return super.onOptionsItemSelected(item);
 714         }
 715     }
 716 
 717     /**
 718      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 719      * the item with the given ID was selected.
 720      */
 721     @Override
 722     public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {
 723 
 724         if (!isLargeScreenLandscape()) {
 725             // Launch the editor activity
 726             Bundle arguments = new Bundle();
 727             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 728             arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);
 729 
 730             if (matchOffsets != null)
 731                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 732 
 733             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 734             editNoteIntent.putExtras(arguments);
 735             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 736         } else {
 737             mNoteEditorFragment.setIsNewNote(isNew);
 738             mNoteEditorFragment.setNote(noteID, matchOffsets);
 739             getNoteListFragment().setNoteSelected(noteID);
 740             if (mSearchView != null &amp;&amp; mSearchView.getQuery().length() &gt; 0) {
 741                 mTabletSearchQuery = mSearchView.getQuery().toString();
 742             }
 743             invalidateOptionsMenu();
 744         }
 745 
 746         mTracker.send(
 747                 new HitBuilders.EventBuilder()
 748                         .setCategory(&quot;note&quot;)
 749                         .setAction(&quot;viewed_note&quot;)
 750                         .setLabel(&quot;note_list_row_tap&quot;)
 751                         .build()
 752         );
 753     }
 754 
 755     @Override
 756     public void onUserCreated(User user) {
 757         // New account created
 758         mTracker.send(
 759                 new HitBuilders.EventBuilder()
 760                         .setCategory(&quot;user&quot;)
 761                         .setAction(&quot;new_account_created&quot;)
 762                         .setLabel(&quot;account_created_from_login_activity&quot;)
 763                         .build()
 764         );
 765     }
 766 
 767     public void onUserStatusChange(User.Status status) {
 768         switch (status) {
 769 
 770             // successfully used access token to connect to simperium bucket
 771             case AUTHORIZED:
 772                 mTracker.send(
 773                         new HitBuilders.EventBuilder()
 774                                 .setCategory(&quot;user&quot;)
 775                                 .setAction(&quot;signed_in&quot;)
 776                                 .setLabel(&quot;signed_in_from_login_activity&quot;)
 777                                 .build()
 778                 );
 779                 runOnUiThread(new Runnable() {
 780                     @Override
 781                     public void run() {
 782                         if (!mNotesBucket.hasChangeVersion()) {
 783                             setProgressBarIndeterminateVisibility(true);
 784                         }
 785                     }
 786                 });
 787                 break;
 788 
 789             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 790             case NOT_AUTHORIZED:
 791                 runOnUiThread(new Runnable() {
 792                     @Override
 793                     public void run() {
 794                         startLoginActivity(true);
 795                     }
 796                 });
 797                 break;
 798 
<abbr title=" 799             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 799             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 800             case UNKNOWN:
 801                 break;
 802         }
 803     }
 804 
 805     public void startLoginActivity(boolean signInFirst) {
 806         Intent loginIntent = new Intent(this, LoginActivity.class);
 807         if (signInFirst)
 808             loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 809         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 810     }
 811 
 812 
 813     @Override
 814     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 815         super.onActivityResult(requestCode, resultCode, data);
 816         switch (requestCode) {
 817             case Simplenote.INTENT_PREFERENCES:
 818                 if (ThemeUtils.themeWasChanged(data)) {
 819                     // Restart this activity to apply the new theme
 820                     recreate();
 821                     break;
 822                 }
<abbr title=" 823                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 823                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 824                 invalidateOptionsMenu();
 825                 NoteListFragment fragment = getNoteListFragment();
 826                 if (fragment != null) {
 827                     fragment.getPrefs();
 828                     fragment.refreshList();
 829                 }
 830                 break;
 831             case Simplenote.INTENT_EDIT_NOTE:
<abbr title=" 832                 if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {"> 832                 if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID))ðŸ”µ</abbr>
 833                     String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 834                     if (noteId != null) {
 835                         List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 836                         deletedNoteIds.add(noteId);
 837                         mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 838                         mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
 839                     }
 840                 }
 841                 break;
 842             case Simperium.SIGNUP_SIGNIN_REQUEST:
 843                 invalidateOptionsMenu();
 844                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 845                     finish();
 846                 }
 847                 break;
 848         }
 849     }
 850 
 851     @Override
 852     public void onUndo(Parcelable p) {
 853         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 854         if (mUndoBarController != null &amp;&amp; deletedNoteIds != null) {
 855 
 856             for (int i=0; i &lt; deletedNoteIds.size(); i++) {
 857                 Note deletedNote = null;
 858                 try {
 859                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 860                 } catch (BucketObjectMissingException e) {
 861                     return;
 862                 }
 863                 if (deletedNote != null) {
 864                     deletedNote.setDeleted(false);
 865                     deletedNote.setModificationDate(Calendar.getInstance());
 866                     deletedNote.save();
 867                     NoteListFragment fragment = getNoteListFragment();
 868                     if (fragment != null) {
 869                         fragment.getPrefs();
 870                         fragment.refreshList();
 871                     }
 872                 }
 873             }
 874         }
 875     }
 876 
 877     @Override
 878     protected void onPostCreate(Bundle savedInstanceState) {
 879         super.onPostCreate(savedInstanceState);
 880         // Sync the toggle state after onRestoreInstanceState has occurred.
 881         mDrawerToggle.syncState();
 882     }
 883 
 884     @Override
 885     public void onConfigurationChanged(Configuration newConfig) {
 886         super.onConfigurationChanged(newConfig);
 887 
 888         mDrawerToggle.onConfigurationChanged(newConfig);
 889 
 890         if (mIsLargeScreen) {
 891             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 892                 // Add the editor fragment
 893                 mIsLandscape = true;
 894                 addEditorFragment();
 895                 if (mNoteListFragment != null) {
 896                     mNoteListFragment.setActivateOnItemClick(true);
 897                     mNoteListFragment.setDividerVisible(true);
 898                 }
 899                 // Select the current note on a tablet
 900                 if (mCurrentNote != null)
 901                     onNoteSelected(mCurrentNote.getSimperiumKey(), false, null);
 902                 else {
 903                     mNoteEditorFragment.setPlaceholderVisible(true);
 904                     mNoteListFragment.getListView().clearChoices();
 905                 }
 906                 invalidateOptionsMenu();
<abbr title=" 907             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {"> 907             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragmentðŸ”µ</abbr>
 908                 // Remove the editor fragment when rotating back to portrait
 909                 mIsLandscape = false;
 910                 mCurrentNote = null;
 911                 if (mNoteListFragment != null) {
 912                     mNoteListFragment.setActivateOnItemClick(false);
 913                     mNoteListFragment.setDividerVisible(false);
 914                     mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 915                     mNoteListFragment.refreshList();
 916                 }
 917                 FragmentManager fm = getFragmentManager();
 918                 FragmentTransaction ft = fm.beginTransaction();
 919                 ft.remove(mNoteEditorFragment);
 920                 mNoteEditorFragment = null;
 921                 ft.commitAllowingStateLoss();
 922                 fm.executePendingTransactions();
 923                 invalidateOptionsMenu();
 924             }
 925         }
 926     }
 927 
 928     public void checkEmptyListText(boolean isSearch) {
 929         if (isSearch) {
<abbr title=" 930             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);"> 930             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
 931             getNoteListFragment().setEmptyListViewClickable(false);
 932         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title=" 933             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);"> 933             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
 934             mTracker.send(
 935                     new HitBuilders.EventBuilder()
 936                             .setCategory(&quot;user&quot;)
 937                             .setAction(&quot;viewed_trash&quot;)
 938                             .setLabel(&quot;trash_filter_selected&quot;)
 939                             .build()
 940             );
 941             getNoteListFragment().setEmptyListViewClickable(false);
 942         } else {
<abbr title=" 943             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 943             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
 944             getNoteListFragment().setEmptyListViewClickable(true);
 945         }
 946     }
 947 
 948     public void showDetailPlaceholder() {
 949         if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 950             mCurrentNote = null;
 951             mNoteEditorFragment.setPlaceholderVisible(true);
 952             invalidateOptionsMenu();
 953         }
 954     }
 955 
 956     public void stopListeningToNotesBucket() {
 957         mNotesBucket.removeOnNetworkChangeListener(this);
 958         mNotesBucket.removeOnSaveObjectListener(this);
 959         mNotesBucket.removeOnDeleteObjectListener(this);
 960     }
 961 
 962     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
 963         if (mUndoBarController != null) {
 964             mUndoBarController.setDeletedNoteIds(noteIds);
<abbr title=" 965             mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()), null);"> 965             mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_noteðŸ”µ</abbr>
 966         }
 967     }
 968 
 969     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 970 
 971         @Override
 972         protected Void doInBackground(Void... voids) {
 973             Simplenote application = (Simplenote) getApplication();
 974             Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 975             Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 976             Bucket.ObjectCursor c = query.execute();
 977             while (c.moveToNext()) {
 978                 c.getObject().delete();
 979             }
 980             return null;
 981         }
 982 
 983         @Override
 984         protected void onPostExecute(Void nada) {
 985             showDetailPlaceholder();
 986         }
 987     }
 988 
 989 }
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.ActionBar;
   4 import android.app.Activity;
   5 import android.app.AlertDialog;
   6 import android.app.FragmentManager;
   7 import android.app.FragmentTransaction;
   8 import android.content.DialogInterface;
   9 import android.content.Intent;
  10 import android.content.SharedPreferences;
  11 import android.content.res.Configuration;
  12 import android.os.AsyncTask;
  13 import android.os.Build;
  14 import android.os.Bundle;
  15 import android.os.Parcelable;
  16 import android.preference.PreferenceManager;
  17 import android.support.v4.app.ActionBarDrawerToggle;
  18 import android.support.v4.widget.DrawerLayout;
  19 import android.text.Spannable;
  20 import android.text.SpannableString;
  21 import android.text.TextUtils;
  22 import android.view.Menu;
  23 import android.view.MenuInflater;
  24 import android.view.MenuItem;
  25 import android.view.View;
  26 import android.view.Window;
  27 import android.widget.AdapterView;
  28 import android.widget.ListView;
  29 import android.widget.SearchView;
  30 import com.automattic.simplenote.models.Note;
  31 import com.automattic.simplenote.models.Tag;
  32 import com.automattic.simplenote.utils.PrefUtils;
  33 import com.automattic.simplenote.utils.StrUtils;
  34 import com.automattic.simplenote.utils.TagsAdapter;
  35 import com.automattic.simplenote.utils.ThemeUtils;
  36 import com.automattic.simplenote.utils.UndoBarController;
  37 import com.automattic.simplenote.widgets.TypefaceSpan;
  38 import com.google.android.gms.analytics.HitBuilders;
  39 import com.google.android.gms.analytics.Tracker;
  40 import com.simperium.Simperium;
  41 import com.simperium.android.LoginActivity;
  42 import com.simperium.client.Bucket;
  43 import com.simperium.client.BucketObjectMissingException;
  44 import com.simperium.client.BucketObjectNameInvalid;
  45 import com.simperium.client.Query;
  46 import com.simperium.client.User;
  47 import java.util.ArrayList;
  48 import java.util.Calendar;
  49 import java.util.List;
  50 
  51 
<abbr title="  52 public class NotesActivity extends Activity implements NoteListFragment.Callbacks , User.StatusChangeListener , Simperium.OnUserCreatedListener , UndoBarController.UndoListener , Bucket.Listener&lt;Note&gt; {">  52 public class NotesActivity extends Activity implements NoteListFragment.Callbacks , User.StatusChangeListðŸ”µ</abbr>
  53     private boolean mIsLargeScreen;
  54 
  55     private boolean mIsLandscape;
  56 
  57     private boolean mShouldSelectNewNote;
  58 
  59     private String mTabletSearchQuery;
  60 
  61     private UndoBarController mUndoBarController;
  62 
  63     private SearchView mSearchView;
  64 
  65     private MenuItem mSearchMenuItem;
  66 
  67     private NoteListFragment mNoteListFragment;
  68 
  69     private NoteEditorFragment mNoteEditorFragment;
  70 
  71     private Note mCurrentNote;
  72 
  73     protected Bucket&lt;Note&gt; mNotesBucket;
  74 
  75     protected Bucket&lt;Tag&gt; mTagsBucket;
  76 
  77     private int TRASH_SELECTED_ID = 1;
  78 
  79     private ActionBar mActionBar;
  80 
  81     private MenuItem mEmptyTrashMenuItem;
  82 
  83     // Menu drawer
  84     // Menu drawer
  85     private DrawerLayout mDrawerLayout;
  86 
  87     private ListView mDrawerList;
  88 
  89     private ActionBarDrawerToggle mDrawerToggle;
  90 
  91     private TagsAdapter mTagsAdapter;
  92 
  93     private TagsAdapter.TagMenuItem mSelectedTag;
  94 
  95     private CharSequence mActionBarTitle;
  96 
  97     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  98 
  99     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
 100 
 101     // Google Analytics tracker
 102     private Tracker mTracker;
 103 
 104     @Override
 105     protected void onCreate(Bundle savedInstanceState) {
 106         requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);
 107         ThemeUtils.setTheme(this);
 108         super.onCreate(savedInstanceState);
 109         Simplenote currentApp = ((Simplenote) (getApplication()));
 110         if (mNotesBucket == null) {
 111             mNotesBucket = currentApp.getNotesBucket();
 112         }
 113         if (mTagsBucket == null) {
 114             mTagsBucket = currentApp.getTagsBucket();
 115         }
 116         setContentView(R.layout.activity_notes);
 117         mTracker = currentApp.getTracker();
 118         if (savedInstanceState == null) {
 119             mNoteListFragment = new NoteListFragment();
 120             FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
 121             fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
 122             fragmentTransaction.commit();
 123         } else {
<abbr title=" 124             mNoteListFragment = ((NoteListFragment) (getFragmentManager().findFragmentByTag(TAG_NOTE_LIST)));"> 124             mNoteListFragment = ((NoteListFragment) (getFragmentManager().findFragmentByTag(TAG_NOTE_LISTðŸ”µ</abbr>
 125         }
 126         Configuration config = getBaseContext().getResources().getConfiguration();
<abbr title=" 127         if ((config.screenLayout &amp; Configuration.SCREENLAYOUT_SIZE_MASK) &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {"> 127         if ((config.screenLayout &amp; Configuration.SCREENLAYOUT_SIZE_MASK) &gt;= Configuration.SCREENLAYOUT_SIðŸ”µ</abbr>
 128             mIsLargeScreen = true;
 129             if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 130                 mNoteEditorFragment = ((NoteEditorFragment) (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR)));"> 130                 mNoteEditorFragment = ((NoteEditorFragment) (getFragmentManager().findFragmentByTag(TAG_NðŸ”µ</abbr>
 131             } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 132                 mIsLandscape = true;
 133                 addEditorFragment();
 134             }
 135         }
 136         // Set up the menu drawer
 137         mDrawerLayout = ((DrawerLayout) (findViewById(R.id.drawer_layout)));
 138         mDrawerList = ((ListView) (findViewById(R.id.left_drawer)));
 139         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 140         mDrawerList.setAdapter(mTagsAdapter);
 141         // Set the list&#x27;s click listener
 142         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 143         if (mSelectedTag == null) {
 144             mSelectedTag = mTagsAdapter.getDefaultItem();
 145         }
 146         // enable ActionBar app icon to behave as action to toggle nav drawer
 147         mActionBar = getActionBar();
 148         mActionBar.setDisplayHomeAsUpEnabled(true);
 149         mActionBar.setHomeButtonEnabled(true);
 150         // ActionBarDrawerToggle ties together the the proper interactions
 151         // between the sliding drawer and the action bar app icon
<abbr title=" 152         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, R.drawable.ic_drawer, R.string.open_drawer, R.string.close_drawer) {"> 152         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, R.drawable.ic_drawer, R.string.opeðŸ”µ</abbr>
 153             public void onDrawerClosed(View view) {
 154                 setTitle(mActionBarTitle);
 155                 invalidateOptionsMenu();
 156             }
 157 
 158             public void onDrawerOpened(View drawerView) {
 159                 setTitleWithCustomFont(getString(R.string.app_name));
 160                 invalidateOptionsMenu();
 161             }
 162         };
 163         mDrawerLayout.setDrawerListener(mDrawerToggle);
 164         mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);
 165         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 166             // Create the welcome note
 167             try {
 168                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 169                 welcomeNote.setCreationDate(Calendar.getInstance());
 170                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 171                 welcomeNote.setContent(getString(R.string.welcome_note));
 172                 welcomeNote.getTitle();
 173                 welcomeNote.save();
 174             } catch (BucketObjectNameInvalid e) {
 175                 // this won&#x27;t happen because welcome-android is a valid name
 176             }
 177             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 178             SharedPreferences.Editor editor = preferences.edit();
 179             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 180             editor.commit();
 181         }
 182         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 183             // Check share action
 184             Intent intent = getIntent();
 185             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 186             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
<abbr title=" 187             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 187             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 188             String intentAction = StrUtils.notNullStr(intent.getAction());
 189             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 190             if (!TextUtils.isEmpty(text)) {
 191                 if ((!TextUtils.isEmpty(subject)) &amp;&amp; (!isVoiceShare)) {
 192                     text = (subject + &quot;\n\n&quot;) + text;
 193                 }
 194                 Note note = mNotesBucket.newObject();
 195                 note.setCreationDate(Calendar.getInstance());
 196                 note.setModificationDate(note.getCreationDate());
 197                 note.setContent(text);
 198                 note.save();
 199                 setCurrentNote(note);
 200                 if (!isVoiceShare) {
 201                     mShouldSelectNewNote = true;
 202                 }
 203 
 204 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 205                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, isVoiceShare ? &quot;google_voice_command&quot; : &quot;external_share&quot;, null);"> 205                 mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, isVoiceShare ? &quot;google_voice_command&quot; : &quot;externðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206 </span>
 207 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 208 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 208 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 209 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211                 mTracker.send(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212                         new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213                                 .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214                                 .setAction(&quot;create_note&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215                                 .setLabel(&quot;external_share&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216                                 .build()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217                 );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218 </span>
 219 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 220             }
 221         }
 222         currentApp.getSimperium().setOnUserCreatedListener(this);
 223         currentApp.getSimperium().setUserStatusChangeListener(this);
 224         setProgressBarIndeterminateVisibility(false);
 225     }
 226 
 227     @Override
 228     protected void onResume() {
 229         super.onResume();
 230 
 231         // Ensure user has valid authorization
 232         if (userAuthenticationIsInvalid())
 233             startLoginActivity(true);
 234 
 235         mNotesBucket.start();
 236         mTagsBucket.start();
 237 
 238         mNotesBucket.addOnNetworkChangeListener(this);
 239         mNotesBucket.addOnSaveObjectListener(this);
 240         mNotesBucket.addOnDeleteObjectListener(this);
 241         mTagsBucket.addListener(mTagsMenuUpdater);
 242 
 243         updateNavigationDrawerItems();
 244 
 245         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 246         Simplenote currentApp = (Simplenote)getApplication();
 247         if (currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED) {
 248             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 249                 mSelectedTag = null;
 250                 mDrawerList.setSelection(mTagsAdapter.DEFAULT_ITEM_POSITION);
 251             }
 252         }
 253 
 254         setSelectedTagActive();
 255 
 256         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 257             onNoteSelected(mCurrentNote.getSimperiumKey(), true, null);
 258             mShouldSelectNewNote = false;
 259         }
 260     }
 261 
 262     @Override
 263     protected void onPause() {
 264         super.onPause();
 265 
 266         mTagsBucket.removeListener(mTagsMenuUpdater);
 267 
 268         mNotesBucket.removeOnNetworkChangeListener(this);
 269         mNotesBucket.removeOnSaveObjectListener(this);
 270         mNotesBucket.removeOnDeleteObjectListener(this);
 271     }
 272 
 273     @Override
 274     public void setTitle(CharSequence title) {
 275         mActionBarTitle = (title != null) ? title : &quot;&quot;;
 276         setTitleWithCustomFont(mActionBarTitle);
 277     }
 278 
 279     private void setTitleWithCustomFont(CharSequence title) {
 280         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 281         if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 282                 &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 283             mActionBar.setTitle(title);
 284             return;
 285         }
 286 
 287         SpannableString s = new SpannableString(title);
 288         s.setSpan(new TypefaceSpan(this), 0, s.length(),
 289                 Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 290         mActionBar.setTitle(s);
 291     }
 292 
 293     private void updateNavigationDrawerItems() {
 294         Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 295         mTagsAdapter.changeCursor(tagCursor);
 296     }
 297 
 298     private void setSelectedTagActive() {
 299         if (mSelectedTag == null)
 300             mSelectedTag = mTagsAdapter.getDefaultItem();
 301 
 302         setTitle(mSelectedTag.name);
 303         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag), true);
 304     }
 305 
 306     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 307     public void updateTrashMenuItem() {
 308         if (mEmptyTrashMenuItem == null)
 309             return;
 310         // Disable the trash icon if there are no notes trashed.
 311         Simplenote application = (Simplenote) getApplication();
 312         Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 313         Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 314         if (query.count() == 0) {
 315             mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash_disabled);
 316             mEmptyTrashMenuItem.setEnabled(false);
 317         } else {
 318             mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash);
 319             mEmptyTrashMenuItem.setEnabled(true);
 320         }
 321     }
 322 
 323     /* The click listener for ListView in the navigation drawer */
 324     private class DrawerItemClickListener implements ListView.OnItemClickListener {
 325         @Override
 326         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 327             mSelectedTag = mTagsAdapter.getItem(position);
 328             checkEmptyListText(false);
 329             // Update checked item in navigation drawer and close it
 330             setSelectedTagActive();
 331             mDrawerLayout.closeDrawer(mDrawerList);
 332             // Disable long press on notes if we&#x27;re viewing the trash
 333             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 334                 getNoteListFragment().getListView().setLongClickable(false);
 335             } else {
 336                 getNoteListFragment().getListView().setLongClickable(true);
 337             }
 338             getNoteListFragment().refreshListFromNavSelect();
 339             if (position &gt; 1) {
<abbr title=" 340                 mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;tag&quot;).setAction(&quot;viewed_notes_for_tag&quot;).setLabel(&quot;selected_tag_in_navigation_drawer&quot;).build());"> 340                 mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;tag&quot;).setAction(&quot;viewed_notes_fðŸ”µ</abbr>
 341             }
 342         }
 343     }
 344 
 345     public TagsAdapter.TagMenuItem getSelectedTag() {
 346         return mSelectedTag;
 347     }
 348 
 349     private void addEditorFragment() {
 350         FragmentManager fm = getFragmentManager();
 351         FragmentTransaction ft = fm.beginTransaction();
 352         mNoteEditorFragment = new NoteEditorFragment();
 353         ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 354         ft.commitAllowingStateLoss();
 355         fm.executePendingTransactions();
 356     }
 357 
 358     /**
 359      * Checks for a previously valid user that is now not authenticated
 360      *
 361      * @return true if user has invalid authorization
 362      */
 363     private boolean userAuthenticationIsInvalid() {
 364         Simplenote currentApp = (Simplenote) getApplication();
 365         Simperium simperium = currentApp.getSimperium();
 366         User user = simperium.getUser();
 367         return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 368     }
 369 
 370     public void setCurrentNote(Note note) {
 371         mCurrentNote = note;
 372     }
 373 
 374     // received a change from the network, refresh the list
 375     @Override
 376     public void onChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
 377         runOnUiThread(new Runnable() {
 378             @Override
 379             public void run() {
 380                 if (type == Bucket.ChangeType.INDEX)
 381                     setProgressBarIndeterminateVisibility(false);
 382                 mNoteListFragment.refreshList();
 383             }
 384         });
 385     }
 386 
 387     @Override
 388     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 389         runOnUiThread(new Runnable() {
 390             @Override
 391             public void run() {
 392                 mNoteListFragment.refreshList();
 393             }
 394         });
 395     }
 396 
 397     @Override
 398     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 399         runOnUiThread(new Runnable() {
 400             @Override
 401             public void run() {
 402                 mNoteListFragment.refreshList();
 403             }
 404         });
 405     }
 406 
 407     @Override
 408     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 409 
 410         // noop, NoteEditorFragment will handle this
 411 
 412     }
 413 
 414     // Tags bucket listener
 415     // Tags bucket listener
 416     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 417         void updateNavigationDrawer() {
 418             runOnUiThread(new Runnable() {
 419                 public void run() {
 420                     updateNavigationDrawerItems();
 421                 }
 422             });
 423         }
 424 
 425         @Override
 426         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 427             updateNavigationDrawer();
 428         }
 429 
 430         @Override
 431         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 432             updateNavigationDrawer();
 433         }
 434 
 435         @Override
 436         public void onChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 437             updateNavigationDrawer();
 438         }
 439 
 440         @Override
 441         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 442             // noop
 443         }
 444     };
 445 
 446     public boolean isLargeScreenLandscape() {
 447         return mIsLargeScreen &amp;&amp; mIsLandscape;
 448     }
 449 
 450     // nbradbury 01-Apr-2013
 451     public NoteListFragment getNoteListFragment() {
 452         return mNoteListFragment;
 453     }
 454 
 455     @Override
 456     public boolean onCreateOptionsMenu(Menu menu) {
 457         super.onCreateOptionsMenu(menu);
 458         MenuInflater inflater = getMenuInflater();
 459         inflater.inflate(R.menu.notes_list, menu);
 460         boolean drawerOpen = mDrawerLayout.isDrawerOpen(mDrawerList);
 461         // restore the search query if on a landscape tablet
 462         String searchQuery = null;
 463         if (isLargeScreenLandscape() &amp;&amp; (mSearchView != null)) {
 464             searchQuery = mSearchView.getQuery().toString();
 465         }
 466         mSearchMenuItem = menu.findItem(R.id.menu_search);
 467         mSearchView = ((SearchView) (mSearchMenuItem.getActionView()));
 468         // Set a custom search view drawable
<abbr title=" 469         int searchPlateId = mSearchView.getContext().getResources().getIdentifier(&quot;android:id/search_plate&quot;, null, null);"> 469         int searchPlateId = mSearchView.getContext().getResources().getIdentifier(&quot;android:id/search_platðŸ”µ</abbr>
 470         View searchPlate = mSearchView.findViewById(searchPlateId);
 471         if (searchPlate != null) {
 472             searchPlate.setBackgroundResource(R.drawable.search_view_selector);
 473         }
 474         if (!TextUtils.isEmpty(searchQuery)) {
 475             mSearchView.setQuery(searchQuery, false);
 476             mSearchMenuItem.expandActionView();
 477         }
 478         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 479             @Override
 480             public boolean onQueryTextChange(String newText) {
 481                 if (mSearchMenuItem.isActionViewExpanded()) {
 482                     getNoteListFragment().searchNotes(newText);
 483                 }
 484                 return true;
 485             }
 486 
 487             @Override
 488             public boolean onQueryTextSubmit(String queryText) {
 489                 getNoteListFragment().searchNotes(queryText);
 490                 return true;
 491             }
 492         });
 493         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 494             @Override
 495             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 496                 checkEmptyListText(true);
 497                 getNoteListFragment().hideWelcomeView();
<abbr title=" 498                 mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;searched_notes&quot;).setLabel(&quot;action_bar_search_tap&quot;).build());"> 498                 mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;searched_noteðŸ”µ</abbr>
 499                 return true;
 500             }
 501 
 502             @Override
 503             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 504                 // Show all notes again
 505                 mTabletSearchQuery = &quot;&quot;;
 506                 mSearchView.setQuery(&quot;&quot;, false);
 507                 checkEmptyListText(false);
 508                 getNoteListFragment().clearSearch();
 509                 getNoteListFragment().setWelcomeViewVisibility();
 510                 return true;
 511             }
 512         });
 513         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 514             @Override
 515             public boolean onMenuItemClick(MenuItem item) {
 516                 if (!mSearchMenuItem.isActionViewExpanded()) {
 517                     showDetailPlaceholder();
 518                 }
 519                 return false;
 520             }
 521         });
 522         // Restore the search query on landscape tablets
 523         if (isLargeScreenLandscape() &amp;&amp; (!TextUtils.isEmpty(mTabletSearchQuery))) {
 524             mSearchView.setQuery(mTabletSearchQuery, false);
 525             mSearchMenuItem.expandActionView();
 526             mSearchView.clearFocus();
 527         }
 528         Simplenote currentApp = ((Simplenote) (getApplication()));
 529         menu.findItem(R.id.menu_sign_in).setVisible(currentApp.getSimperium().needsAuthorization());
 530         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 531         if ((mCurrentNote != null) &amp;&amp; mCurrentNote.isDeleted()) {
 532             trashItem.setTitle(R.string.undelete);
 533         } else {
 534             trashItem.setTitle(R.string.delete);
 535         }
 536         if (isLargeScreenLandscape()) {
 537             menu.findItem(R.id.menu_create_note).setVisible(!drawerOpen);
 538             menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 539             menu.findItem(R.id.menu_preferences).setVisible(true);
 540             if (mCurrentNote != null) {
 541                 menu.findItem(R.id.menu_share).setVisible(!drawerOpen);
 542                 trashItem.setVisible(true);
 543             } else {
 544                 menu.findItem(R.id.menu_share).setVisible(false);
 545                 trashItem.setVisible(false);
 546             }
 547             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 548             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 549         } else {
 550             menu.findItem(R.id.menu_create_note).setVisible(!drawerOpen);
 551             menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 552             menu.findItem(R.id.menu_preferences).setVisible(true);
 553             menu.findItem(R.id.menu_share).setVisible(false);
 554             trashItem.setVisible(false);
 555             menu.findItem(R.id.menu_edit_tags).setVisible(true);
 556             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 557         }
 558         // Are we looking at the trash? Adjust menu accordingly.
 559         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 560             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 561             mEmptyTrashMenuItem.setVisible(!drawerOpen);
 562             updateTrashMenuItem();
 563             menu.findItem(R.id.menu_create_note).setVisible(false);
 564             menu.findItem(R.id.menu_search).setVisible(false);
 565             menu.findItem(R.id.menu_share).setVisible(false);
 566         }
 567         return true;
 568     }
 569 
 570     @Override
 571     public boolean onOptionsItemSelected(MenuItem item) {
 572         if (mDrawerToggle.onOptionsItemSelected(item)) {
 573             return true;
 574         }
 575         switch (item.getItemId()) {
 576             case R.id.menu_preferences :
<abbr title=" 577                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 577                 // nbradbury - use startActivityForResult so onActivityResult can detect when user returnðŸ”µ</abbr>
 578                 Intent i = new Intent(this, PreferencesActivity.class);
 579                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 580                 return true;
 581             case R.id.menu_sign_in :
 582                 startLoginActivity(true);
 583                 return true;
 584             case R.id.menu_edit_tags :
 585                 Intent editTagsIntent = new Intent(this, TagsListActivity.class);
 586                 startActivity(editTagsIntent);
 587                 return true;
 588             case R.id.menu_create_note :
 589                 getNoteListFragment().addNote();
<abbr title=" 590                 mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;create_note&quot;).setLabel(&quot;action_bar_button&quot;).build());"> 590                 mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;create_note&quot;)ðŸ”µ</abbr>
 591                 return true;
 592             case R.id.menu_share :
 593                 if (mCurrentNote != null) {
 594                     Intent shareIntent = new Intent(Intent.ACTION_SEND);
 595                     shareIntent.setType(&quot;text/plain&quot;);
 596                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 597                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 597                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
<abbr title=" 598                     mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;shared_note&quot;).setLabel(&quot;action_bar_share_button&quot;).build());"> 598                     mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;shared_noðŸ”µ</abbr>
 599                 }
 600                 return true;
 601             case R.id.menu_delete :
 602                 if (mNoteEditorFragment != null) {
 603                     if (mCurrentNote != null) {
 604                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 605                         mCurrentNote.setModificationDate(Calendar.getInstance());
 606                         mCurrentNote.save();
 607                         if (mCurrentNote.isDeleted()) {
 608                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 609                             deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 610                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 611                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);"> 611                             mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null)ðŸ”µ</abbr>
<abbr title=" 612                             mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;deleted_note&quot;).setLabel(&quot;overflow_menu&quot;).build());"> 612                             mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;dðŸ”µ</abbr>
 613                         } else {
<abbr title=" 614                             mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;restored_note&quot;).setLabel(&quot;overflow_menu&quot;).build());"> 614                             mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;rðŸ”µ</abbr>
 615                         }
 616                         showDetailPlaceholder();
 617                     }
 618                     NoteListFragment fragment = getNoteListFragment();
 619                     if (fragment != null) {
 620                         fragment.getPrefs();
 621                         fragment.refreshList();
 622                     }
 623                 }
 624                 return true;
 625             case R.id.menu_empty_trash :
 626                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 627                 alert.setTitle(R.string.empty_trash);
 628                 alert.setMessage(R.string.confirm_empty_trash);
 629                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 630                     public void onClick(DialogInterface dialog, int whichButton) {
 631                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
<abbr title=" 632                         mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;trash_emptied&quot;).setLabel(&quot;overflow_menu&quot;).build());"> 632                         mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;trashðŸ”µ</abbr>
 633                     }
 634                 });
 635                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 636                     public void onClick(DialogInterface dialog, int whichButton) {
 637                         // Do nothing, just closing the dialog
 638                     }
 639                 });
 640                 alert.show();
 641                 return true;
 642             case android.R.id.home :
 643                 invalidateOptionsMenu();
 644                 return true;
 645             default :
 646                 return super.onOptionsItemSelected(item);
 647         }
 648     }
 649 
 650     /**
 651      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 652      * the item with the given ID was selected.
 653      */
 654     @Override
 655     public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {
 656         if (!isLargeScreenLandscape()) {
 657             // Launch the editor activity
 658             Bundle arguments = new Bundle();
 659             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 660             arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);
 661             if (matchOffsets != null) {
 662                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 663             }
 664             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 665             editNoteIntent.putExtras(arguments);
 666             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 667         } else {
 668             mNoteEditorFragment.setIsNewNote(isNew);
 669             mNoteEditorFragment.setNote(noteID, matchOffsets);
 670             getNoteListFragment().setNoteSelected(noteID);
 671             if ((mSearchView != null) &amp;&amp; (mSearchView.getQuery().length() &gt; 0)) {
 672                 mTabletSearchQuery = mSearchView.getQuery().toString();
 673             }
 674             invalidateOptionsMenu();
 675         }
<abbr title=" 676         mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;viewed_note&quot;).setLabel(&quot;note_list_row_tap&quot;).build());"> 676         mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;viewed_note&quot;).setLabeðŸ”µ</abbr>
 677     }
 678 
 679     @Override
 680     public void onUserCreated(User user) {
 681         // New account created
<abbr title=" 682         mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;user&quot;).setAction(&quot;new_account_created&quot;).setLabel(&quot;account_created_from_login_activity&quot;).build());"> 682         mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;user&quot;).setAction(&quot;new_account_created&quot;)ðŸ”µ</abbr>
 683     }
 684 
 685     public void onUserStatusChange(User.Status status) {
 686         switch (status) {
 687             // successfully used access token to connect to simperium bucket
 688             case AUTHORIZED :
<abbr title=" 689                 mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;user&quot;).setAction(&quot;signed_in&quot;).setLabel(&quot;signed_in_from_login_activity&quot;).build());"> 689                 mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;user&quot;).setAction(&quot;signed_in&quot;).sðŸ”µ</abbr>
 690                 runOnUiThread(new Runnable() {
 691                     @Override
 692                     public void run() {
 693                         if (!mNotesBucket.hasChangeVersion()) {
 694                             setProgressBarIndeterminateVisibility(true);
 695                         }
 696                     }
 697                 });
 698                 break;
 699             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 700             case NOT_AUTHORIZED :
 701                 runOnUiThread(new Runnable() {
 702                     @Override
 703                     public void run() {
 704                         startLoginActivity(true);
 705                     }
 706                 });
 707                 break;
<abbr title=" 708                 // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 708                 // Default starting state of User, don&#x27;t do anything we allow use of app while not signedðŸ”µ</abbr>
 709             case UNKNOWN :
 710                 break;
 711         }
 712     }
 713 
 714     public void startLoginActivity(boolean signInFirst) {
 715         Intent loginIntent = new Intent(this, LoginActivity.class);
 716         if (signInFirst)
 717             loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 718         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 719     }
 720 
 721     @Override
 722     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 723         super.onActivityResult(requestCode, resultCode, data);
 724         switch (requestCode) {
 725             case Simplenote.INTENT_PREFERENCES:
 726                 if (ThemeUtils.themeWasChanged(data)) {
 727                     // Restart this activity to apply the new theme
 728                     recreate();
 729                     break;
 730                 }
<abbr title=" 731                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 731                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 732                 invalidateOptionsMenu();
 733                 NoteListFragment fragment = getNoteListFragment();
 734                 if (fragment != null) {
 735                     fragment.getPrefs();
 736                     fragment.refreshList();
 737                 }
 738                 break;
 739             case Simplenote.INTENT_EDIT_NOTE:
<abbr title=" 740                 if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {"> 740                 if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID))ðŸ”µ</abbr>
 741                     String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 742                     if (noteId != null) {
 743                         List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 744                         deletedNoteIds.add(noteId);
 745                         mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 746                         mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
 747                     }
 748                 }
 749                 break;
 750             case Simperium.SIGNUP_SIGNIN_REQUEST:
 751                 invalidateOptionsMenu();
 752                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 753                     finish();
 754                 }
 755                 break;
 756         }
 757     }
 758 
 759     @Override
 760     public void onUndo(Parcelable p) {
 761         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 762         if (mUndoBarController != null &amp;&amp; deletedNoteIds != null) {
 763 
 764             for (int i=0; i &lt; deletedNoteIds.size(); i++) {
 765                 Note deletedNote = null;
 766                 try {
 767                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 768                 } catch (BucketObjectMissingException e) {
 769                     return;
 770                 }
 771                 if (deletedNote != null) {
 772                     deletedNote.setDeleted(false);
 773                     deletedNote.setModificationDate(Calendar.getInstance());
 774                     deletedNote.save();
 775                     NoteListFragment fragment = getNoteListFragment();
 776                     if (fragment != null) {
 777                         fragment.getPrefs();
 778                         fragment.refreshList();
 779                     }
 780                 }
 781             }
 782         }
 783     }
 784 
 785     @Override
 786     protected void onPostCreate(Bundle savedInstanceState) {
 787         super.onPostCreate(savedInstanceState);
 788         // Sync the toggle state after onRestoreInstanceState has occurred.
 789         mDrawerToggle.syncState();
 790     }
 791 
 792     @Override
 793     public void onConfigurationChanged(Configuration newConfig) {
 794         super.onConfigurationChanged(newConfig);
 795 
 796         mDrawerToggle.onConfigurationChanged(newConfig);
 797 
 798         if (mIsLargeScreen) {
 799             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 800                 // Add the editor fragment
 801                 mIsLandscape = true;
 802                 addEditorFragment();
 803                 if (mNoteListFragment != null) {
 804                     mNoteListFragment.setActivateOnItemClick(true);
 805                     mNoteListFragment.setDividerVisible(true);
 806                 }
 807                 // Select the current note on a tablet
 808                 if (mCurrentNote != null)
 809                     onNoteSelected(mCurrentNote.getSimperiumKey(), false, null);
 810                 else {
 811                     mNoteEditorFragment.setPlaceholderVisible(true);
 812                     mNoteListFragment.getListView().clearChoices();
 813                 }
 814                 invalidateOptionsMenu();
<abbr title=" 815             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {"> 815             } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragmentðŸ”µ</abbr>
 816                 // Remove the editor fragment when rotating back to portrait
 817                 mIsLandscape = false;
 818                 mCurrentNote = null;
 819                 if (mNoteListFragment != null) {
 820                     mNoteListFragment.setActivateOnItemClick(false);
 821                     mNoteListFragment.setDividerVisible(false);
 822                     mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 823                     mNoteListFragment.refreshList();
 824                 }
 825                 FragmentManager fm = getFragmentManager();
 826                 FragmentTransaction ft = fm.beginTransaction();
 827                 ft.remove(mNoteEditorFragment);
 828                 mNoteEditorFragment = null;
 829                 ft.commitAllowingStateLoss();
 830                 fm.executePendingTransactions();
 831                 invalidateOptionsMenu();
 832             }
 833         }
 834     }
 835 
 836     public void checkEmptyListText(boolean isSearch) {
 837         if (isSearch) {
<abbr title=" 838             getNoteListFragment().setEmptyListMessage((&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found)) + &quot;&lt;/strong&gt;&quot;);"> 838             getNoteListFragment().setEmptyListMessage((&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found)) +ðŸ”µ</abbr>
 839             getNoteListFragment().setEmptyListViewClickable(false);
 840         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title=" 841             getNoteListFragment().setEmptyListMessage((&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty)) + &quot;&lt;/strong&gt;&quot;);"> 841             getNoteListFragment().setEmptyListMessage((&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty)) +ðŸ”µ</abbr>
<abbr title=" 842             mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;user&quot;).setAction(&quot;viewed_trash&quot;).setLabel(&quot;trash_filter_selected&quot;).build());"> 842             mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;user&quot;).setAction(&quot;viewed_trash&quot;).seðŸ”µ</abbr>
 843             getNoteListFragment().setEmptyListViewClickable(false);
 844         } else {
<abbr title=" 845             getNoteListFragment().setEmptyListMessage(((&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here)) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot;) + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 845             getNoteListFragment().setEmptyListMessage(((&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here)) +ðŸ”µ</abbr>
 846             getNoteListFragment().setEmptyListViewClickable(true);
 847         }
 848     }
 849 
 850     public void showDetailPlaceholder() {
 851         if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 852             mCurrentNote = null;
 853             mNoteEditorFragment.setPlaceholderVisible(true);
 854             invalidateOptionsMenu();
 855         }
 856     }
 857 
 858     public void stopListeningToNotesBucket() {
 859         mNotesBucket.removeOnNetworkChangeListener(this);
 860         mNotesBucket.removeOnSaveObjectListener(this);
 861         mNotesBucket.removeOnDeleteObjectListener(this);
 862     }
 863 
 864     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
 865         if (mUndoBarController != null) {
 866             mUndoBarController.setDeletedNoteIds(noteIds);
<abbr title=" 867             mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()), null);"> 867             mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_noteðŸ”µ</abbr>
 868         }
 869     }
 870 
 871     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 872         @Override
 873         protected Void doInBackground(Void... voids) {
 874             Simplenote application = ((Simplenote) (getApplication()));
 875             Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 876             Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 877             Bucket.ObjectCursor c = query.execute();
 878             while (c.moveToNext()) {
 879                 c.getObject().delete();
 880             }
 881             return null;
 882         }
 883 
 884         @Override
 885         protected void onPostExecute(Void nada) {
 886             showDetailPlaceholder();
 887         }
 888     }
 889 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.ActionBar;
   4  import android.app.Activity;
   5  import android.app.AlertDialog;
   6  import android.app.FragmentManager;
   7  import android.app.FragmentTransaction;
   8  import android.content.DialogInterface;
   9  import android.content.Intent;
  10  import android.content.SharedPreferences;
  11  import android.content.res.Configuration;
  12  import android.os.AsyncTask;
  13  import android.os.Build;
  14  import android.os.Bundle;
  15  import android.os.Parcelable;
  16  import android.preference.PreferenceManager;
  17  import android.support.v4.app.ActionBarDrawerToggle;
  18  import android.support.v4.widget.DrawerLayout;
  19  import android.text.Spannable;
  20  import android.text.SpannableString;
  21  import android.text.TextUtils;
  22  import android.view.Menu;
  23  import android.view.MenuInflater;
  24  import android.view.MenuItem;
  25  import android.view.View;
  26  import android.view.Window;
  27  import android.widget.AdapterView;
  28  import android.widget.ListView;
  29  import android.widget.SearchView;
  30  
  31  import com.automattic.simplenote.models.Note;
  32  import com.automattic.simplenote.models.Tag;
  33  import com.automattic.simplenote.utils.PrefUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import com.automattic.simplenote.utils.StrUtils;</span>
  35  import com.automattic.simplenote.utils.TagsAdapter;
  36  import com.automattic.simplenote.utils.ThemeUtils;
  37  import com.automattic.simplenote.widgets.TypefaceSpan;
  38  import com.automattic.simplenote.utils.UndoBarController;
  39  import com.google.analytics.tracking.android.EasyTracker;
  40  import com.google.analytics.tracking.android.Tracker;


  41  import com.simperium.Simperium;
  42  import com.simperium.android.LoginActivity;
  43  import com.simperium.client.Bucket;
  44  import com.simperium.client.BucketObjectMissingException;
  45  import com.simperium.client.BucketObjectNameInvalid;
  46  import com.simperium.client.Query;
  47  import com.simperium.client.User;
  48  
  49  import java.util.ArrayList;
  50  import java.util.Calendar;
  51  import java.util.List;
  52  
  53  public class NotesActivity extends Activity implements
<abbr title="  54          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  54          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  55          Bucket.Listener&lt;Note&gt; {
  56  
  57      private boolean mIsLargeScreen, mIsLandscape, mShouldSelectNewNote;
  58      private String mTabletSearchQuery;
  59      private UndoBarController mUndoBarController;
  60      private SearchView mSearchView;
  61      private MenuItem mSearchMenuItem;
  62      private NoteListFragment mNoteListFragment;
  63      private NoteEditorFragment mNoteEditorFragment;
  64      private Note mCurrentNote;
  65      protected Bucket&lt;Note&gt; mNotesBucket;
  66      protected Bucket&lt;Tag&gt; mTagsBucket;
  67      private int TRASH_SELECTED_ID = 1;
  68      private ActionBar mActionBar;
  69      private MenuItem mEmptyTrashMenuItem;
  70  
  71      // Menu drawer
  72      private DrawerLayout mDrawerLayout;
  73      private ListView mDrawerList;
  74      private ActionBarDrawerToggle mDrawerToggle;
  75      private TagsAdapter mTagsAdapter;
  76      private TagsAdapter.TagMenuItem mSelectedTag;
  77      private CharSequence mActionBarTitle;
  78  
  79      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  80      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  81  
  82      // Google Analytics tracker
  83      private Tracker mTracker;
  84  
  85      @Override
  86      protected void onCreate(Bundle savedInstanceState) {
  87          requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);
  88  
  89          ThemeUtils.setTheme(this);
  90  
  91          super.onCreate(savedInstanceState);
  92          Simplenote currentApp = (Simplenote) getApplication();
  93  
  94          if (mNotesBucket == null)
  95              mNotesBucket = currentApp.getNotesBucket();
  96  
  97          if (mTagsBucket == null)
  98              mTagsBucket = currentApp.getTagsBucket();
  99  
 100          setContentView(R.layout.activity_notes);
 101  
 102          EasyTracker.getInstance().activityStart(this);
 103          mTracker = EasyTracker.getTracker();

 104  
 105          if (savedInstanceState == null) {
 106              mNoteListFragment = new NoteListFragment();
 107              FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
 108              fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
 109              fragmentTransaction.commit();
 110          } else {
 111              mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 112          }
 113  
 114          Configuration config = getBaseContext().getResources().getConfiguration();
 115          if ((config.screenLayout
 116                  &amp; Configuration.SCREENLAYOUT_SIZE_MASK)
 117                  &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {
 118              mIsLargeScreen = true;
 119  
 120              if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 121                  mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 121                  mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR)ðŸ”µ</abbr>
 122              } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 123                  mIsLandscape = true;
 124                  addEditorFragment();
 125              }
 126          }
 127  
 128          // Set up the menu drawer
 129          mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);
 130          mDrawerList = (ListView) findViewById(R.id.left_drawer);
 131          mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 132          mDrawerList.setAdapter(mTagsAdapter);
 133          // Set the list&#x27;s click listener
 134          mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 135  
 136          if (mSelectedTag == null)
 137              mSelectedTag = mTagsAdapter.getDefaultItem();
 138  
 139          // enable ActionBar app icon to behave as action to toggle nav drawer
 140          mActionBar = getActionBar();
 141          mActionBar.setDisplayHomeAsUpEnabled(true);
 142          mActionBar.setHomeButtonEnabled(true);
 143  
 144          // ActionBarDrawerToggle ties together the the proper interactions
 145          // between the sliding drawer and the action bar app icon
 146          mDrawerToggle = new ActionBarDrawerToggle(
 147                  this,
 148                  mDrawerLayout,
 149                  R.drawable.ic_drawer,
 150                  R.string.open_drawer,
 151                  R.string.close_drawer
 152          ) {
 153              public void onDrawerClosed(View view) {
 154                  setTitle(mActionBarTitle);
 155                  invalidateOptionsMenu();
 156              }
 157  
 158              public void onDrawerOpened(View drawerView) {
 159                  setTitleWithCustomFont(getString(R.string.app_name));
 160                  invalidateOptionsMenu();
 161              }
 162          };
 163          mDrawerLayout.setDrawerListener(mDrawerToggle);
 164  
 165          mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);
 166  
 167          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 168              // Create the welcome note
 169              try {
 170                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 171                  welcomeNote.setCreationDate(Calendar.getInstance());
 172                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 173                  welcomeNote.setContent(getString(R.string.welcome_note));
 174                  welcomeNote.getTitle();
 175                  welcomeNote.save();
 176              } catch (BucketObjectNameInvalid e) {
 177                  // this won&#x27;t happen because welcome-android is a valid name
 178              }
 179  
 180              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 181              SharedPreferences.Editor editor = preferences.edit();
 182              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 183              editor.commit();
 184          }
 185  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -        if (Intent.ACTION_SEND.equals(getIntent().getAction())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +        if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {</span>
 188              // Check share action
 189              Intent intent = getIntent();
 190              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 191              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -            if (text != null &amp;&amp; !text.equals(&quot;&quot;)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -                if (subject != null &amp;&amp; !subject.equals(&quot;&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +            // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +            String intentAction = StrUtils.notNullStr(intent.getAction());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +            boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +            if (!TextUtils.isEmpty(text)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +                if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {</span>
 200                      text = subject + &quot;\n\n&quot; + text;
 201                  }
 202                  Note note = mNotesBucket.newObject();
 203                  note.setCreationDate(Calendar.getInstance());
 204                  note.setModificationDate(note.getCreationDate());
 205                  note.setContent(text);
 206                  note.save();
 207                  setCurrentNote(note);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -                mShouldSelectNewNote = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -                mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;external_share&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +                if (!isVoiceShare) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +                    mShouldSelectNewNote = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 214 +                mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, isVoiceShare ? &quot;google_voice_command&quot; : &quot;external_share&quot;, null);"> 214 +                mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, isVoiceShare ? &quot;google_voice_command&quot; : &quot;external_share&quot;ðŸ”µ</abbr></span>


 215              }
 216          }
 217          currentApp.getSimperium().setOnUserCreatedListener(this);
 218          currentApp.getSimperium().setUserStatusChangeListener(this);
 219          setProgressBarIndeterminateVisibility(false);
 220      }
 221  
 222      @Override
 223      protected void onResume() {
 224          super.onResume();
 225  
 226          // Ensure user has valid authorization
 227          if (userAuthenticationIsInvalid())
 228              startLoginActivity(true);
 229  
 230          mNotesBucket.start();
 231          mTagsBucket.start();
 232  
 233          mNotesBucket.addOnNetworkChangeListener(this);
 234          mNotesBucket.addOnSaveObjectListener(this);
 235          mNotesBucket.addOnDeleteObjectListener(this);
 236          mTagsBucket.addListener(mTagsMenuUpdater);
 237  
 238          updateNavigationDrawerItems();
 239  
 240          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 241          Simplenote currentApp = (Simplenote)getApplication();
 242          if (currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED) {
 243              if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 244                  mSelectedTag = null;
 245                  mDrawerList.setSelection(mTagsAdapter.DEFAULT_ITEM_POSITION);
 246              }
 247          }
 248  
 249          setSelectedTagActive();
 250  
 251          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 252              onNoteSelected(mCurrentNote.getSimperiumKey(), true, null);
 253              mShouldSelectNewNote = false;
 254          }
 255      }
 256  
 257      @Override
 258      protected void onPause() {
 259          super.onPause();
 260  
 261          mTagsBucket.removeListener(mTagsMenuUpdater);
 262  
 263          mNotesBucket.removeOnNetworkChangeListener(this);
 264          mNotesBucket.removeOnSaveObjectListener(this);
 265          mNotesBucket.removeOnDeleteObjectListener(this);
 266      }
 267  
 268      @Override
 269      public void onStop() {
 270          super.onStop();
 271          EasyTracker.getInstance().activityStop(this);
 272      }
 273  
 274      @Override
 275      public void setTitle(CharSequence title) {
 276          mActionBarTitle = (title != null) ? title : &quot;&quot;;
 277          setTitleWithCustomFont(mActionBarTitle);
 278      }
 279  
 280      private void setTitleWithCustomFont(CharSequence title) {
 281          // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 282          if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 283                  &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 284              mActionBar.setTitle(title);
 285              return;
 286          }
 287  
 288          SpannableString s = new SpannableString(title);
 289          s.setSpan(new TypefaceSpan(this), 0, s.length(),
 290                  Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 291          mActionBar.setTitle(s);
 292      }
 293  
 294      private void updateNavigationDrawerItems() {
 295          Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 296          mTagsAdapter.changeCursor(tagCursor);
 297      }
 298  
 299      private void setSelectedTagActive() {
 300          if (mSelectedTag == null)
 301              mSelectedTag = mTagsAdapter.getDefaultItem();
 302  
 303          setTitle(mSelectedTag.name);
 304          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag), true);
 305      }
 306  
 307      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 308      public void updateTrashMenuItem() {
 309          if (mEmptyTrashMenuItem == null)
 310              return;
 311          // Disable the trash icon if there are no notes trashed.
 312          Simplenote application = (Simplenote) getApplication();
 313          Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 314          Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 315          if (query.count() == 0) {
 316              mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash_disabled);
 317              mEmptyTrashMenuItem.setEnabled(false);
 318          } else {
 319              mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash);
 320              mEmptyTrashMenuItem.setEnabled(true);
 321          }
 322      }
 323  
 324      /* The click listener for ListView in the navigation drawer */
 325      private class DrawerItemClickListener implements ListView.OnItemClickListener {
 326          @Override
 327          public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 328  
 329              mSelectedTag = mTagsAdapter.getItem(position);
 330              checkEmptyListText(false);
 331              // Update checked item in navigation drawer and close it
 332              setSelectedTagActive();
 333              mDrawerLayout.closeDrawer(mDrawerList);
 334  
 335              // Disable long press on notes if we&#x27;re viewing the trash
 336              if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 337                  getNoteListFragment().getListView().setLongClickable(false);
 338              } else {
 339                  getNoteListFragment().getListView().setLongClickable(true);
 340              }
 341  
 342              getNoteListFragment().refreshListFromNavSelect();
 343              if (position &gt; 1)
 344                  mTracker.sendEvent(&quot;tag&quot;, &quot;viewed_notes_for_tag&quot;, &quot;selected_tag_in_navigation_drawer&quot;, null);









 345          }
 346      }
 347  
 348      public TagsAdapter.TagMenuItem getSelectedTag() {
 349          return mSelectedTag;
 350      }
 351  
 352      private void addEditorFragment() {
 353          FragmentManager fm = getFragmentManager();
 354          FragmentTransaction ft = fm.beginTransaction();
 355          mNoteEditorFragment = new NoteEditorFragment();
 356          ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 357          ft.commitAllowingStateLoss();
 358          fm.executePendingTransactions();
 359      }
 360  
 361      /**
 362       * Checks for a previously valid user that is now not authenticated
 363       *
 364       * @return true if user has invalid authorization
 365       */
 366      private boolean userAuthenticationIsInvalid() {
 367          Simplenote currentApp = (Simplenote) getApplication();
 368          Simperium simperium = currentApp.getSimperium();
 369          User user = simperium.getUser();
 370          return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 371      }
 372  
 373      public void setCurrentNote(Note note) {
 374          mCurrentNote = note;
 375      }
 376  
 377      // received a change from the network, refresh the list
 378      @Override
 379      public void onChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
 380          runOnUiThread(new Runnable() {
 381              @Override
 382              public void run() {
 383                  if (type == Bucket.ChangeType.INDEX)
 384                      setProgressBarIndeterminateVisibility(false);
 385                  mNoteListFragment.refreshList();
 386              }
 387          });
 388      }
 389  
 390      @Override
 391      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 392          runOnUiThread(new Runnable() {
 393              @Override
 394              public void run() {
 395                  mNoteListFragment.refreshList();
 396              }
 397          });
 398      }
 399  
 400      @Override
 401      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 402          runOnUiThread(new Runnable() {
 403              @Override
 404              public void run() {
 405                  mNoteListFragment.refreshList();
 406              }
 407          });
 408      }
 409  
 410      @Override
 411      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 412  
 413          // noop, NoteEditorFragment will handle this
 414  
 415      }
 416  
 417      // Tags bucket listener
 418      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 419          void updateNavigationDrawer() {
 420              runOnUiThread(new Runnable() {
 421                  public void run() {
 422                      updateNavigationDrawerItems();
 423                  }
 424              });
 425          }
 426  
 427          @Override
 428          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 429              updateNavigationDrawer();
 430          }
 431  
 432          @Override
 433          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 434              updateNavigationDrawer();
 435          }
 436  
 437          @Override
 438          public void onChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 439              updateNavigationDrawer();
 440          }
 441  
 442          @Override
 443          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 444              // noop
 445          }
 446      };
 447  
 448      public boolean isLargeScreenLandscape() {
 449          return mIsLargeScreen &amp;&amp; mIsLandscape;
 450      }
 451  
 452      // nbradbury 01-Apr-2013
 453      public NoteListFragment getNoteListFragment() {
 454          return mNoteListFragment;
 455      }
 456  
 457      @Override
 458      public boolean onCreateOptionsMenu(Menu menu) {
 459          super.onCreateOptionsMenu(menu);
 460          MenuInflater inflater = getMenuInflater();
 461          inflater.inflate(R.menu.notes_list, menu);
 462  
 463          boolean drawerOpen = mDrawerLayout.isDrawerOpen(mDrawerList);
 464  
 465          // restore the search query if on a landscape tablet
 466          String searchQuery = null;
 467          if (isLargeScreenLandscape() &amp;&amp; mSearchView != null)
 468              searchQuery = mSearchView.getQuery().toString();
 469  
 470          mSearchMenuItem = menu.findItem(R.id.menu_search);
 471          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 472  
 473          // Set a custom search view drawable
<abbr title=" 474          int searchPlateId = mSearchView.getContext().getResources().getIdentifier(&quot;android:id/search_plate&quot;, null, null);"> 474          int searchPlateId = mSearchView.getContext().getResources().getIdentifier(&quot;android:id/search_plate&quot;, null,ðŸ”µ</abbr>
 475          View searchPlate = mSearchView.findViewById(searchPlateId);
 476          if (searchPlate != null)
 477              searchPlate.setBackgroundResource(R.drawable.search_view_selector);
 478  
 479          if (!TextUtils.isEmpty(searchQuery)) {
 480              mSearchView.setQuery(searchQuery, false);
 481              mSearchMenuItem.expandActionView();
 482          }
 483  
 484          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 485              @Override
 486              public boolean onQueryTextChange(String newText) {
 487                  if (mSearchMenuItem.isActionViewExpanded()) {
 488                      getNoteListFragment().searchNotes(newText);
 489                  }
 490                  return true;
 491              }
 492  
 493              @Override
 494              public boolean onQueryTextSubmit(String queryText) {
 495                  getNoteListFragment().searchNotes(queryText);
 496                  return true;
 497              }
 498  
 499          });
 500          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 501              @Override
 502              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 503                  checkEmptyListText(true);
 504                  getNoteListFragment().hideWelcomeView();
 505                  mTracker.sendEvent(&quot;note&quot;, &quot;searched_notes&quot;, &quot;action_bar_search_tap&quot;, null);







 506                  return true;
 507              }
 508  
 509              @Override
 510              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 511                  // Show all notes again
 512                  mTabletSearchQuery = &quot;&quot;;
 513                  mSearchView.setQuery(&quot;&quot;, false);
 514                  checkEmptyListText(false);
 515                  getNoteListFragment().clearSearch();
 516                  getNoteListFragment().setWelcomeViewVisibility();
 517                  return true;
 518              }
 519          });
 520  
 521          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 522              @Override
 523              public boolean onMenuItemClick(MenuItem item) {
 524                  if (!mSearchMenuItem.isActionViewExpanded())
 525                      showDetailPlaceholder();
 526                  return false;
 527              }
 528          });
 529  
 530          // Restore the search query on landscape tablets
 531          if (isLargeScreenLandscape() &amp;&amp; !TextUtils.isEmpty(mTabletSearchQuery)) {
 532              mSearchView.setQuery(mTabletSearchQuery, false);
 533              mSearchMenuItem.expandActionView();
 534              mSearchView.clearFocus();
 535          }
 536  
 537          Simplenote currentApp = (Simplenote) getApplication();
 538          menu.findItem(R.id.menu_sign_in).setVisible(currentApp.getSimperium().needsAuthorization());
 539  
 540  
 541          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 542          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 543              trashItem.setTitle(R.string.undelete);
 544          else
 545              trashItem.setTitle(R.string.delete);
 546  
 547          if (isLargeScreenLandscape()) {
 548              menu.findItem(R.id.menu_create_note).setVisible(!drawerOpen);
 549              menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 550              menu.findItem(R.id.menu_preferences).setVisible(true);
 551              if (mCurrentNote != null) {
 552                  menu.findItem(R.id.menu_share).setVisible(!drawerOpen);
 553                  trashItem.setVisible(true);
 554              } else {
 555                  menu.findItem(R.id.menu_share).setVisible(false);
 556                  trashItem.setVisible(false);
 557              }
 558              menu.findItem(R.id.menu_edit_tags).setVisible(true);
 559              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 560          } else {
 561              menu.findItem(R.id.menu_create_note).setVisible(!drawerOpen);
 562              menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 563              menu.findItem(R.id.menu_preferences).setVisible(true);
 564              menu.findItem(R.id.menu_share).setVisible(false);
 565              trashItem.setVisible(false);
 566              menu.findItem(R.id.menu_edit_tags).setVisible(true);
 567              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 568          }
 569  
 570          // Are we looking at the trash? Adjust menu accordingly.
 571          if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 572              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 573              mEmptyTrashMenuItem.setVisible(!drawerOpen);
 574  
 575              updateTrashMenuItem();
 576  
 577              menu.findItem(R.id.menu_create_note).setVisible(false);
 578              menu.findItem(R.id.menu_search).setVisible(false);
 579              menu.findItem(R.id.menu_share).setVisible(false);
 580          }
 581  
 582          return true;
 583      }
 584  
 585      @Override
 586      public boolean onOptionsItemSelected(MenuItem item) {
 587          if (mDrawerToggle.onOptionsItemSelected(item)) {
 588              return true;
 589          }
 590          switch (item.getItemId()) {
 591              case R.id.menu_preferences:
<abbr title=" 592                  // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 592                  // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from prðŸ”µ</abbr>
 593                  Intent i = new Intent(this, PreferencesActivity.class);
 594                  startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 595                  return true;
 596              case R.id.menu_sign_in:
 597                  startLoginActivity(true);
 598                  return true;
 599              case R.id.menu_edit_tags:
 600                  Intent editTagsIntent = new Intent(this, TagsListActivity.class);
 601                  startActivity(editTagsIntent);
 602                  return true;
 603              case R.id.menu_create_note:
 604                  getNoteListFragment().addNote();
 605                  mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;action_bar_button&quot;, null);







 606                  return true;
 607              case R.id.menu_share:
 608                  if (mCurrentNote != null) {
 609                      Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 610                      shareIntent.setType(&quot;text/plain&quot;);
 611                      shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 612                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 612                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note))ðŸ”µ</abbr>
 613                      mTracker.sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, null);







 614                  }
 615                  return true;
 616              case R.id.menu_delete:
 617                  if (mNoteEditorFragment != null) {
 618                      if (mCurrentNote != null) {
 619                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 620                          mCurrentNote.setModificationDate(Calendar.getInstance());
 621                          mCurrentNote.save();
 622  
 623                          if (mCurrentNote.isDeleted()) {
 624                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 625                              deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 626                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 627                              mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
 628                              mTracker.sendEvent(&quot;note&quot;, &quot;deleted_note&quot;, &quot;overflow_menu&quot;, null);







 629                          } else {
 630                              mTracker.sendEvent(&quot;note&quot;, &quot;restored_note&quot;, &quot;overflow_menu&quot;, null);







 631                          }
 632                          showDetailPlaceholder();
 633                      }
 634                      NoteListFragment fragment = getNoteListFragment();
 635                      if (fragment != null) {
 636                          fragment.getPrefs();
 637                          fragment.refreshList();
 638                      }
 639                  }
 640                  return true;
 641              case R.id.menu_empty_trash:
 642                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 643  
 644                  alert.setTitle(R.string.empty_trash);
 645                  alert.setMessage(R.string.confirm_empty_trash);
 646                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 647                      public void onClick(DialogInterface dialog, int whichButton) {
 648                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 649                          mTracker.sendEvent(&quot;note&quot;, &quot;trash_emptied&quot;, &quot;overflow_menu&quot;, null);







 650                      }
 651                  });
 652                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 653                      public void onClick(DialogInterface dialog, int whichButton) {
 654                          // Do nothing, just closing the dialog
 655                      }
 656                  });
 657                  alert.show();
 658                  return true;
 659              case android.R.id.home:
 660                  invalidateOptionsMenu();
 661                  return true;
 662              default:
 663                  return super.onOptionsItemSelected(item);
 664          }
 665      }
 666  
 667      /**
 668       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 669       * the item with the given ID was selected.
 670       */
 671      @Override
 672      public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {
 673  
 674          if (!isLargeScreenLandscape()) {
 675              // Launch the editor activity
 676              Bundle arguments = new Bundle();
 677              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 678              arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);
 679  
 680              if (matchOffsets != null)
 681                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 682  
 683              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 684              editNoteIntent.putExtras(arguments);
 685              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 686          } else {
 687              mNoteEditorFragment.setIsNewNote(isNew);
 688              mNoteEditorFragment.setNote(noteID, matchOffsets);
 689              getNoteListFragment().setNoteSelected(noteID);
 690              if (mSearchView != null &amp;&amp; mSearchView.getQuery().length() &gt; 0) {
 691                  mTabletSearchQuery = mSearchView.getQuery().toString();
 692              }
 693              invalidateOptionsMenu();
 694          }
 695  
 696          mTracker.sendEvent(&quot;note&quot;, &quot;viewed_note&quot;, &quot;note_list_row_tap&quot;, null);







 697      }
 698  
 699      @Override
 700      public void onUserCreated(User user) {
 701          // New account created
 702          mTracker.sendEvent(&quot;user&quot;, &quot;new_account_created&quot;, &quot;account_created_from_login_activity&quot;, null);







 703      }
 704  
 705      public void onUserStatusChange(User.Status status) {
 706          switch (status) {
 707  
 708              // successfully used access token to connect to simperium bucket
 709              case AUTHORIZED:
 710                  mTracker.sendEvent(&quot;user&quot;, &quot;signed_in&quot;, &quot;signed_in_from_login_activity&quot;, null);







 711                  runOnUiThread(new Runnable() {
 712                      @Override
 713                      public void run() {
 714                          if (!mNotesBucket.hasChangeVersion()) {
 715                              setProgressBarIndeterminateVisibility(true);
 716                          }
 717                      }
 718                  });
 719                  break;
 720  
 721              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 722              case NOT_AUTHORIZED:
 723                  runOnUiThread(new Runnable() {
 724                      @Override
 725                      public void run() {
 726                          startLoginActivity(true);
 727                      }
 728                  });
 729                  break;
 730  
<abbr title=" 731              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 731              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
 732              case UNKNOWN:
 733                  break;
 734          }
 735      }
 736  
 737      public void startLoginActivity(boolean signInFirst) {
 738          Intent loginIntent = new Intent(this, LoginActivity.class);
 739          if (signInFirst)
 740              loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 741          startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 742      }
 743  
 744  
 745      @Override
 746      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 747          super.onActivityResult(requestCode, resultCode, data);
 748          switch (requestCode) {
 749              case Simplenote.INTENT_PREFERENCES:
 750                  if (ThemeUtils.themeWasChanged(data)) {
 751                      // Restart this activity to apply the new theme
 752                      recreate();
 753                      break;
 754                  }
<abbr title=" 755                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 755                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
 756                  invalidateOptionsMenu();
 757                  NoteListFragment fragment = getNoteListFragment();
 758                  if (fragment != null) {
 759                      fragment.getPrefs();
 760                      fragment.refreshList();
 761                  }
 762                  break;
 763              case Simplenote.INTENT_EDIT_NOTE:
 764                  if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 765                      String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 766                      if (noteId != null) {
 767                          List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 768                          deletedNoteIds.add(noteId);
 769                          mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 770                          mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
 771                      }
 772                  }
 773                  break;
 774              case Simperium.SIGNUP_SIGNIN_REQUEST:
 775                  invalidateOptionsMenu();
 776                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 777                      finish();
 778                  }
 779                  break;
 780          }
 781      }
 782  
 783      @Override
 784      public void onUndo(Parcelable p) {
 785          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 786          if (mUndoBarController != null &amp;&amp; deletedNoteIds != null) {
 787  
 788              for (int i=0; i &lt; deletedNoteIds.size(); i++) {
 789                  Note deletedNote = null;
 790                  try {
 791                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 792                  } catch (BucketObjectMissingException e) {
 793                      return;
 794                  }
 795                  if (deletedNote != null) {
 796                      deletedNote.setDeleted(false);
 797                      deletedNote.setModificationDate(Calendar.getInstance());
 798                      deletedNote.save();
 799                      NoteListFragment fragment = getNoteListFragment();
 800                      if (fragment != null) {
 801                          fragment.getPrefs();
 802                          fragment.refreshList();
 803                      }
 804                  }
 805              }
 806          }
 807      }
 808  
 809      @Override
 810      protected void onPostCreate(Bundle savedInstanceState) {
 811          super.onPostCreate(savedInstanceState);
 812          // Sync the toggle state after onRestoreInstanceState has occurred.
 813          mDrawerToggle.syncState();
 814      }
 815  
 816      @Override
 817      public void onConfigurationChanged(Configuration newConfig) {
 818          super.onConfigurationChanged(newConfig);
 819  
 820          mDrawerToggle.onConfigurationChanged(newConfig);
 821  
 822          if (mIsLargeScreen) {
 823              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 824                  // Add the editor fragment
 825                  mIsLandscape = true;
 826                  addEditorFragment();
 827                  if (mNoteListFragment != null) {
 828                      mNoteListFragment.setActivateOnItemClick(true);
 829                      mNoteListFragment.setDividerVisible(true);
 830                  }
 831                  // Select the current note on a tablet
 832                  if (mCurrentNote != null)
 833                      onNoteSelected(mCurrentNote.getSimperiumKey(), false, null);
 834                  else {
 835                      mNoteEditorFragment.setPlaceholderVisible(true);
 836                      mNoteListFragment.getListView().clearChoices();
 837                  }
 838                  invalidateOptionsMenu();
<abbr title=" 839              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {"> 839              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null)ðŸ”µ</abbr>
 840                  // Remove the editor fragment when rotating back to portrait
 841                  mIsLandscape = false;
 842                  mCurrentNote = null;
 843                  if (mNoteListFragment != null) {
 844                      mNoteListFragment.setActivateOnItemClick(false);
 845                      mNoteListFragment.setDividerVisible(false);
 846                      mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 847                      mNoteListFragment.refreshList();
 848                  }
 849                  FragmentManager fm = getFragmentManager();
 850                  FragmentTransaction ft = fm.beginTransaction();
 851                  ft.remove(mNoteEditorFragment);
 852                  mNoteEditorFragment = null;
 853                  ft.commitAllowingStateLoss();
 854                  fm.executePendingTransactions();
 855                  invalidateOptionsMenu();
 856              }
 857          }
 858      }
 859  
 860      public void checkEmptyListText(boolean isSearch) {
 861          if (isSearch) {
<abbr title=" 862              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);"> 862              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
 863              getNoteListFragment().setEmptyListViewClickable(false);
 864          } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title=" 865              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);"> 865              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
 866              EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;viewed_trash&quot;, &quot;trash_filter_selected&quot;, null);







 867              getNoteListFragment().setEmptyListViewClickable(false);
 868          } else {
<abbr title=" 869              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 869              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
 870              getNoteListFragment().setEmptyListViewClickable(true);
 871          }
 872      }
 873  
 874      public void showDetailPlaceholder() {
 875          if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 876              mCurrentNote = null;
 877              mNoteEditorFragment.setPlaceholderVisible(true);
 878              invalidateOptionsMenu();
 879          }
 880      }
 881  
 882      public void stopListeningToNotesBucket() {
 883          mNotesBucket.removeOnNetworkChangeListener(this);
 884          mNotesBucket.removeOnSaveObjectListener(this);
 885          mNotesBucket.removeOnDeleteObjectListener(this);
 886      }
 887  
 888      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
 889          if (mUndoBarController != null) {
 890              mUndoBarController.setDeletedNoteIds(noteIds);
<abbr title=" 891              mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()), null);"> 891              mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_notes, noteIdðŸ”µ</abbr>
 892          }
 893      }
 894  
 895      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 896  
 897          @Override
 898          protected Void doInBackground(Void... voids) {
 899              Simplenote application = (Simplenote) getApplication();
 900              Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 901              Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 902              Bucket.ObjectCursor c = query.execute();
 903              while (c.moveToNext()) {
 904                  c.getObject().delete();
 905              }
 906              return null;
 907          }
 908  
 909          @Override
 910          protected void onPostExecute(Void nada) {
 911              showDetailPlaceholder();
 912          }
 913      }
 914  
 915  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.ActionBar;
   4  import android.app.Activity;
   5  import android.app.AlertDialog;
   6  import android.app.FragmentManager;
   7  import android.app.FragmentTransaction;
   8  import android.content.DialogInterface;
   9  import android.content.Intent;
  10  import android.content.SharedPreferences;
  11  import android.content.res.Configuration;
  12  import android.os.AsyncTask;
  13  import android.os.Build;
  14  import android.os.Bundle;
  15  import android.os.Parcelable;
  16  import android.preference.PreferenceManager;
  17  import android.support.v4.app.ActionBarDrawerToggle;
  18  import android.support.v4.widget.DrawerLayout;
  19  import android.text.Spannable;
  20  import android.text.SpannableString;
  21  import android.text.TextUtils;
  22  import android.view.Menu;
  23  import android.view.MenuInflater;
  24  import android.view.MenuItem;
  25  import android.view.View;
  26  import android.view.Window;
  27  import android.widget.AdapterView;
  28  import android.widget.ListView;
  29  import android.widget.SearchView;
  30  
  31  import com.automattic.simplenote.models.Note;
  32  import com.automattic.simplenote.models.Tag;
  33  import com.automattic.simplenote.utils.PrefUtils;

  34  import com.automattic.simplenote.utils.TagsAdapter;
  35  import com.automattic.simplenote.utils.ThemeUtils;
  36  import com.automattic.simplenote.widgets.TypefaceSpan;
  37  import com.automattic.simplenote.utils.UndoBarController;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import com.google.analytics.tracking.android.EasyTracker;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import com.google.analytics.tracking.android.Tracker;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import com.google.android.gms.analytics.HitBuilders;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import com.google.android.gms.analytics.Tracker;</span>
  42  import com.simperium.Simperium;
  43  import com.simperium.android.LoginActivity;
  44  import com.simperium.client.Bucket;
  45  import com.simperium.client.BucketObjectMissingException;
  46  import com.simperium.client.BucketObjectNameInvalid;
  47  import com.simperium.client.Query;
  48  import com.simperium.client.User;
  49  
  50  import java.util.ArrayList;
  51  import java.util.Calendar;
  52  import java.util.List;
  53  
  54  public class NotesActivity extends Activity implements
<abbr title="  55          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  55          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  56          Bucket.Listener&lt;Note&gt; {
  57  
  58      private boolean mIsLargeScreen, mIsLandscape, mShouldSelectNewNote;
  59      private String mTabletSearchQuery;
  60      private UndoBarController mUndoBarController;
  61      private SearchView mSearchView;
  62      private MenuItem mSearchMenuItem;
  63      private NoteListFragment mNoteListFragment;
  64      private NoteEditorFragment mNoteEditorFragment;
  65      private Note mCurrentNote;
  66      protected Bucket&lt;Note&gt; mNotesBucket;
  67      protected Bucket&lt;Tag&gt; mTagsBucket;
  68      private int TRASH_SELECTED_ID = 1;
  69      private ActionBar mActionBar;
  70      private MenuItem mEmptyTrashMenuItem;
  71  
  72      // Menu drawer
  73      private DrawerLayout mDrawerLayout;
  74      private ListView mDrawerList;
  75      private ActionBarDrawerToggle mDrawerToggle;
  76      private TagsAdapter mTagsAdapter;
  77      private TagsAdapter.TagMenuItem mSelectedTag;
  78      private CharSequence mActionBarTitle;
  79  
  80      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  81      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  82  
  83      // Google Analytics tracker
  84      private Tracker mTracker;
  85  
  86      @Override
  87      protected void onCreate(Bundle savedInstanceState) {
  88          requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);
  89  
  90          ThemeUtils.setTheme(this);
  91  
  92          super.onCreate(savedInstanceState);
  93          Simplenote currentApp = (Simplenote) getApplication();
  94  
  95          if (mNotesBucket == null)
  96              mNotesBucket = currentApp.getNotesBucket();
  97  
  98          if (mTagsBucket == null)
  99              mTagsBucket = currentApp.getTagsBucket();
 100  
 101          setContentView(R.layout.activity_notes);
 102  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        EasyTracker.getInstance().activityStart(this);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        mTracker = EasyTracker.getTracker();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +        mTracker = currentApp.getTracker();</span>
 106  
 107          if (savedInstanceState == null) {
 108              mNoteListFragment = new NoteListFragment();
 109              FragmentTransaction fragmentTransaction = getFragmentManager().beginTransaction();
 110              fragmentTransaction.add(R.id.noteFragmentContainer, mNoteListFragment, TAG_NOTE_LIST);
 111              fragmentTransaction.commit();
 112          } else {
 113              mNoteListFragment = (NoteListFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 114          }
 115  
 116          Configuration config = getBaseContext().getResources().getConfiguration();
 117          if ((config.screenLayout
 118                  &amp; Configuration.SCREENLAYOUT_SIZE_MASK)
 119                  &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE) {
 120              mIsLargeScreen = true;
 121  
 122              if (getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 123                  mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 123                  mNoteEditorFragment = (NoteEditorFragment) getFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR)ðŸ”µ</abbr>
 124              } else if (config.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 125                  mIsLandscape = true;
 126                  addEditorFragment();
 127              }
 128          }
 129  
 130          // Set up the menu drawer
 131          mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);
 132          mDrawerList = (ListView) findViewById(R.id.left_drawer);
 133          mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 134          mDrawerList.setAdapter(mTagsAdapter);
 135          // Set the list&#x27;s click listener
 136          mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 137  
 138          if (mSelectedTag == null)
 139              mSelectedTag = mTagsAdapter.getDefaultItem();
 140  
 141          // enable ActionBar app icon to behave as action to toggle nav drawer
 142          mActionBar = getActionBar();
 143          mActionBar.setDisplayHomeAsUpEnabled(true);
 144          mActionBar.setHomeButtonEnabled(true);
 145  
 146          // ActionBarDrawerToggle ties together the the proper interactions
 147          // between the sliding drawer and the action bar app icon
 148          mDrawerToggle = new ActionBarDrawerToggle(
 149                  this,
 150                  mDrawerLayout,
 151                  R.drawable.ic_drawer,
 152                  R.string.open_drawer,
 153                  R.string.close_drawer
 154          ) {
 155              public void onDrawerClosed(View view) {
 156                  setTitle(mActionBarTitle);
 157                  invalidateOptionsMenu();
 158              }
 159  
 160              public void onDrawerOpened(View drawerView) {
 161                  setTitleWithCustomFont(getString(R.string.app_name));
 162                  invalidateOptionsMenu();
 163              }
 164          };
 165          mDrawerLayout.setDrawerListener(mDrawerToggle);
 166  
 167          mUndoBarController = new UndoBarController(findViewById(R.id.undobar), this);
 168  
 169          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 170              // Create the welcome note
 171              try {
 172                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 173                  welcomeNote.setCreationDate(Calendar.getInstance());
 174                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 175                  welcomeNote.setContent(getString(R.string.welcome_note));
 176                  welcomeNote.getTitle();
 177                  welcomeNote.save();
 178              } catch (BucketObjectNameInvalid e) {
 179                  // this won&#x27;t happen because welcome-android is a valid name
 180              }
 181  
 182              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 183              SharedPreferences.Editor editor = preferences.edit();
 184              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 185              editor.commit();
 186          }
 187  
 188          if (Intent.ACTION_SEND.equals(getIntent().getAction())) {

 189              // Check share action
 190              Intent intent = getIntent();
 191              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 192              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 193              if (text != null &amp;&amp; !text.equals(&quot;&quot;)) {
 194                  if (subject != null &amp;&amp; !subject.equals(&quot;&quot;)) {






 195                      text = subject + &quot;\n\n&quot; + text;
 196                  }
 197                  Note note = mNotesBucket.newObject();
 198                  note.setCreationDate(Calendar.getInstance());
 199                  note.setModificationDate(note.getCreationDate());
 200                  note.setContent(text);
 201                  note.save();
 202                  setCurrentNote(note);
 203                  mShouldSelectNewNote = true;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -                mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;external_share&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +                mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +                        new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +                                .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +                                .setAction(&quot;create_note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +                                .setLabel(&quot;external_share&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +                                .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +                );</span>
 212              }
 213          }
 214          currentApp.getSimperium().setOnUserCreatedListener(this);
 215          currentApp.getSimperium().setUserStatusChangeListener(this);
 216          setProgressBarIndeterminateVisibility(false);
 217      }
 218  
 219      @Override
 220      protected void onResume() {
 221          super.onResume();
 222  
 223          // Ensure user has valid authorization
 224          if (userAuthenticationIsInvalid())
 225              startLoginActivity(true);
 226  
 227          mNotesBucket.start();
 228          mTagsBucket.start();
 229  
 230          mNotesBucket.addOnNetworkChangeListener(this);
 231          mNotesBucket.addOnSaveObjectListener(this);
 232          mNotesBucket.addOnDeleteObjectListener(this);
 233          mTagsBucket.addListener(mTagsMenuUpdater);
 234  
 235          updateNavigationDrawerItems();
 236  
 237          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 238          Simplenote currentApp = (Simplenote)getApplication();
 239          if (currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED) {
 240              if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 241                  mSelectedTag = null;
 242                  mDrawerList.setSelection(mTagsAdapter.DEFAULT_ITEM_POSITION);
 243              }
 244          }
 245  
 246          setSelectedTagActive();
 247  
 248          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 249              onNoteSelected(mCurrentNote.getSimperiumKey(), true, null);
 250              mShouldSelectNewNote = false;
 251          }
 252      }
 253  
 254      @Override
 255      protected void onPause() {
 256          super.onPause();
 257  
 258          mTagsBucket.removeListener(mTagsMenuUpdater);
 259  
 260          mNotesBucket.removeOnNetworkChangeListener(this);
 261          mNotesBucket.removeOnSaveObjectListener(this);
 262          mNotesBucket.removeOnDeleteObjectListener(this);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -    public void onStop() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -        super.onStop();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -        EasyTracker.getInstance().activityStop(this);</span>
 269      }
 270  
 271      @Override
 272      public void setTitle(CharSequence title) {
 273          mActionBarTitle = (title != null) ? title : &quot;&quot;;
 274          setTitleWithCustomFont(mActionBarTitle);
 275      }
 276  
 277      private void setTitleWithCustomFont(CharSequence title) {
 278          // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 279          if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 280                  &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 281              mActionBar.setTitle(title);
 282              return;
 283          }
 284  
 285          SpannableString s = new SpannableString(title);
 286          s.setSpan(new TypefaceSpan(this), 0, s.length(),
 287                  Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 288          mActionBar.setTitle(s);
 289      }
 290  
 291      private void updateNavigationDrawerItems() {
 292          Bucket.ObjectCursor&lt;Tag&gt; tagCursor = Tag.allWithCount(mTagsBucket).execute();
 293          mTagsAdapter.changeCursor(tagCursor);
 294      }
 295  
 296      private void setSelectedTagActive() {
 297          if (mSelectedTag == null)
 298              mSelectedTag = mTagsAdapter.getDefaultItem();
 299  
 300          setTitle(mSelectedTag.name);
 301          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag), true);
 302      }
 303  
 304      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 305      public void updateTrashMenuItem() {
 306          if (mEmptyTrashMenuItem == null)
 307              return;
 308          // Disable the trash icon if there are no notes trashed.
 309          Simplenote application = (Simplenote) getApplication();
 310          Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 311          Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 312          if (query.count() == 0) {
 313              mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash_disabled);
 314              mEmptyTrashMenuItem.setEnabled(false);
 315          } else {
 316              mEmptyTrashMenuItem.setIcon(R.drawable.ab_icon_empty_trash);
 317              mEmptyTrashMenuItem.setEnabled(true);
 318          }
 319      }
 320  
 321      /* The click listener for ListView in the navigation drawer */
 322      private class DrawerItemClickListener implements ListView.OnItemClickListener {
 323          @Override
 324          public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
 325  
 326              mSelectedTag = mTagsAdapter.getItem(position);
 327              checkEmptyListText(false);
 328              // Update checked item in navigation drawer and close it
 329              setSelectedTagActive();
 330              mDrawerLayout.closeDrawer(mDrawerList);
 331  
 332              // Disable long press on notes if we&#x27;re viewing the trash
 333              if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 334                  getNoteListFragment().getListView().setLongClickable(false);
 335              } else {
 336                  getNoteListFragment().getListView().setLongClickable(true);
 337              }
 338  
 339              getNoteListFragment().refreshListFromNavSelect();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -            if (position &gt; 1)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 341 -                mTracker.sendEvent(&quot;tag&quot;, &quot;viewed_notes_for_tag&quot;, &quot;selected_tag_in_navigation_drawer&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +            if (position &gt; 1) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +                mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +                        new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +                                .setCategory(&quot;tag&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +                                .setAction(&quot;viewed_notes_for_tag&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +                                .setLabel(&quot;selected_tag_in_navigation_drawer&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +                                .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +                );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +            }</span>
 351          }
 352      }
 353  
 354      public TagsAdapter.TagMenuItem getSelectedTag() {
 355          return mSelectedTag;
 356      }
 357  
 358      private void addEditorFragment() {
 359          FragmentManager fm = getFragmentManager();
 360          FragmentTransaction ft = fm.beginTransaction();
 361          mNoteEditorFragment = new NoteEditorFragment();
 362          ft.add(R.id.noteFragmentContainer, mNoteEditorFragment, TAG_NOTE_EDITOR);
 363          ft.commitAllowingStateLoss();
 364          fm.executePendingTransactions();
 365      }
 366  
 367      /**
 368       * Checks for a previously valid user that is now not authenticated
 369       *
 370       * @return true if user has invalid authorization
 371       */
 372      private boolean userAuthenticationIsInvalid() {
 373          Simplenote currentApp = (Simplenote) getApplication();
 374          Simperium simperium = currentApp.getSimperium();
 375          User user = simperium.getUser();
 376          return user.hasAccessToken() &amp;&amp; user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 377      }
 378  
 379      public void setCurrentNote(Note note) {
 380          mCurrentNote = note;
 381      }
 382  
 383      // received a change from the network, refresh the list
 384      @Override
 385      public void onChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
 386          runOnUiThread(new Runnable() {
 387              @Override
 388              public void run() {
 389                  if (type == Bucket.ChangeType.INDEX)
 390                      setProgressBarIndeterminateVisibility(false);
 391                  mNoteListFragment.refreshList();
 392              }
 393          });
 394      }
 395  
 396      @Override
 397      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
 398          runOnUiThread(new Runnable() {
 399              @Override
 400              public void run() {
 401                  mNoteListFragment.refreshList();
 402              }
 403          });
 404      }
 405  
 406      @Override
 407      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
 408          runOnUiThread(new Runnable() {
 409              @Override
 410              public void run() {
 411                  mNoteListFragment.refreshList();
 412              }
 413          });
 414      }
 415  
 416      @Override
 417      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 418  
 419          // noop, NoteEditorFragment will handle this
 420  
 421      }
 422  
 423      // Tags bucket listener
 424      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 425          void updateNavigationDrawer() {
 426              runOnUiThread(new Runnable() {
 427                  public void run() {
 428                      updateNavigationDrawerItems();
 429                  }
 430              });
 431          }
 432  
 433          @Override
 434          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 435              updateNavigationDrawer();
 436          }
 437  
 438          @Override
 439          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 440              updateNavigationDrawer();
 441          }
 442  
 443          @Override
 444          public void onChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 445              updateNavigationDrawer();
 446          }
 447  
 448          @Override
 449          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 450              // noop
 451          }
 452      };
 453  
 454      public boolean isLargeScreenLandscape() {
 455          return mIsLargeScreen &amp;&amp; mIsLandscape;
 456      }
 457  
 458      // nbradbury 01-Apr-2013
 459      public NoteListFragment getNoteListFragment() {
 460          return mNoteListFragment;
 461      }
 462  
 463      @Override
 464      public boolean onCreateOptionsMenu(Menu menu) {
 465          super.onCreateOptionsMenu(menu);
 466          MenuInflater inflater = getMenuInflater();
 467          inflater.inflate(R.menu.notes_list, menu);
 468  
 469          boolean drawerOpen = mDrawerLayout.isDrawerOpen(mDrawerList);
 470  
 471          // restore the search query if on a landscape tablet
 472          String searchQuery = null;
 473          if (isLargeScreenLandscape() &amp;&amp; mSearchView != null)
 474              searchQuery = mSearchView.getQuery().toString();
 475  
 476          mSearchMenuItem = menu.findItem(R.id.menu_search);
 477          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 478  
 479          // Set a custom search view drawable
<abbr title=" 480          int searchPlateId = mSearchView.getContext().getResources().getIdentifier(&quot;android:id/search_plate&quot;, null, null);"> 480          int searchPlateId = mSearchView.getContext().getResources().getIdentifier(&quot;android:id/search_plate&quot;, null,ðŸ”µ</abbr>
 481          View searchPlate = mSearchView.findViewById(searchPlateId);
 482          if (searchPlate != null)
 483              searchPlate.setBackgroundResource(R.drawable.search_view_selector);
 484  
 485          if (!TextUtils.isEmpty(searchQuery)) {
 486              mSearchView.setQuery(searchQuery, false);
 487              mSearchMenuItem.expandActionView();
 488          }
 489  
 490          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 491              @Override
 492              public boolean onQueryTextChange(String newText) {
 493                  if (mSearchMenuItem.isActionViewExpanded()) {
 494                      getNoteListFragment().searchNotes(newText);
 495                  }
 496                  return true;
 497              }
 498  
 499              @Override
 500              public boolean onQueryTextSubmit(String queryText) {
 501                  getNoteListFragment().searchNotes(queryText);
 502                  return true;
 503              }
 504  
 505          });
 506          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 507              @Override
 508              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 509                  checkEmptyListText(true);
 510                  getNoteListFragment().hideWelcomeView();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 511 -                mTracker.sendEvent(&quot;note&quot;, &quot;searched_notes&quot;, &quot;action_bar_search_tap&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 512 +                mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 513 +                        new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 514 +                                .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 515 +                                .setAction(&quot;searched_notes&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 516 +                                .setLabel(&quot;action_bar_search_tap&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 517 +                                .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 518 +                );</span>
 519                  return true;
 520              }
 521  
 522              @Override
 523              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 524                  // Show all notes again
 525                  mTabletSearchQuery = &quot;&quot;;
 526                  mSearchView.setQuery(&quot;&quot;, false);
 527                  checkEmptyListText(false);
 528                  getNoteListFragment().clearSearch();
 529                  getNoteListFragment().setWelcomeViewVisibility();
 530                  return true;
 531              }
 532          });
 533  
 534          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 535              @Override
 536              public boolean onMenuItemClick(MenuItem item) {
 537                  if (!mSearchMenuItem.isActionViewExpanded())
 538                      showDetailPlaceholder();
 539                  return false;
 540              }
 541          });
 542  
 543          // Restore the search query on landscape tablets
 544          if (isLargeScreenLandscape() &amp;&amp; !TextUtils.isEmpty(mTabletSearchQuery)) {
 545              mSearchView.setQuery(mTabletSearchQuery, false);
 546              mSearchMenuItem.expandActionView();
 547              mSearchView.clearFocus();
 548          }
 549  
 550          Simplenote currentApp = (Simplenote) getApplication();
 551          menu.findItem(R.id.menu_sign_in).setVisible(currentApp.getSimperium().needsAuthorization());
 552  
 553  
 554          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 555          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted())
 556              trashItem.setTitle(R.string.undelete);
 557          else
 558              trashItem.setTitle(R.string.delete);
 559  
 560          if (isLargeScreenLandscape()) {
 561              menu.findItem(R.id.menu_create_note).setVisible(!drawerOpen);
 562              menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 563              menu.findItem(R.id.menu_preferences).setVisible(true);
 564              if (mCurrentNote != null) {
 565                  menu.findItem(R.id.menu_share).setVisible(!drawerOpen);
 566                  trashItem.setVisible(true);
 567              } else {
 568                  menu.findItem(R.id.menu_share).setVisible(false);
 569                  trashItem.setVisible(false);
 570              }
 571              menu.findItem(R.id.menu_edit_tags).setVisible(true);
 572              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 573          } else {
 574              menu.findItem(R.id.menu_create_note).setVisible(!drawerOpen);
 575              menu.findItem(R.id.menu_search).setVisible(!drawerOpen);
 576              menu.findItem(R.id.menu_preferences).setVisible(true);
 577              menu.findItem(R.id.menu_share).setVisible(false);
 578              trashItem.setVisible(false);
 579              menu.findItem(R.id.menu_edit_tags).setVisible(true);
 580              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 581          }
 582  
 583          // Are we looking at the trash? Adjust menu accordingly.
 584          if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 585              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 586              mEmptyTrashMenuItem.setVisible(!drawerOpen);
 587  
 588              updateTrashMenuItem();
 589  
 590              menu.findItem(R.id.menu_create_note).setVisible(false);
 591              menu.findItem(R.id.menu_search).setVisible(false);
 592              menu.findItem(R.id.menu_share).setVisible(false);
 593          }
 594  
 595          return true;
 596      }
 597  
 598      @Override
 599      public boolean onOptionsItemSelected(MenuItem item) {
 600          if (mDrawerToggle.onOptionsItemSelected(item)) {
 601              return true;
 602          }
 603          switch (item.getItemId()) {
 604              case R.id.menu_preferences:
<abbr title=" 605                  // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from preferences"> 605                  // nbradbury - use startActivityForResult so onActivityResult can detect when user returns from prðŸ”µ</abbr>
 606                  Intent i = new Intent(this, PreferencesActivity.class);
 607                  startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 608                  return true;
 609              case R.id.menu_sign_in:
 610                  startLoginActivity(true);
 611                  return true;
 612              case R.id.menu_edit_tags:
 613                  Intent editTagsIntent = new Intent(this, TagsListActivity.class);
 614                  startActivity(editTagsIntent);
 615                  return true;
 616              case R.id.menu_create_note:
 617                  getNoteListFragment().addNote();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 618 -                mTracker.sendEvent(&quot;note&quot;, &quot;create_note&quot;, &quot;action_bar_button&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 619 +                mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 620 +                        new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 621 +                                .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 622 +                                .setAction(&quot;create_note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 623 +                                .setLabel(&quot;action_bar_button&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 624 +                                .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 625 +                );</span>
 626                  return true;
 627              case R.id.menu_share:
 628                  if (mCurrentNote != null) {
 629                      Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 630                      shareIntent.setType(&quot;text/plain&quot;);
 631                      shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mCurrentNote.getContent());
<abbr title=" 632                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 632                      startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note))ðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 633 -                    mTracker.sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 634 +                    mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 635 +                            new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 636 +                                    .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 637 +                                    .setAction(&quot;shared_note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 638 +                                    .setLabel(&quot;action_bar_share_button&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 639 +                                    .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 640 +                    );</span>
 641                  }
 642                  return true;
 643              case R.id.menu_delete:
 644                  if (mNoteEditorFragment != null) {
 645                      if (mCurrentNote != null) {
 646                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 647                          mCurrentNote.setModificationDate(Calendar.getInstance());
 648                          mCurrentNote.save();
 649  
 650                          if (mCurrentNote.isDeleted()) {
 651                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 652                              deletedNoteIds.add(mCurrentNote.getSimperiumKey());
 653                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 654                              mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 655 -                            mTracker.sendEvent(&quot;note&quot;, &quot;deleted_note&quot;, &quot;overflow_menu&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 656 +                            mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 657 +                                    new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 658 +                                            .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 659 +                                            .setAction(&quot;deleted_note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 660 +                                            .setLabel(&quot;overflow_menu&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 661 +                                            .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 662 +                            );</span>
 663                          } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 664 -                            mTracker.sendEvent(&quot;note&quot;, &quot;restored_note&quot;, &quot;overflow_menu&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 665 +                            mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 666 +                                    new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 667 +                                            .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 668 +                                            .setAction(&quot;restored_note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 669 +                                            .setLabel(&quot;overflow_menu&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 670 +                                            .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 671 +                            );</span>
 672                          }
 673                          showDetailPlaceholder();
 674                      }
 675                      NoteListFragment fragment = getNoteListFragment();
 676                      if (fragment != null) {
 677                          fragment.getPrefs();
 678                          fragment.refreshList();
 679                      }
 680                  }
 681                  return true;
 682              case R.id.menu_empty_trash:
 683                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 684  
 685                  alert.setTitle(R.string.empty_trash);
 686                  alert.setMessage(R.string.confirm_empty_trash);
 687                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 688                      public void onClick(DialogInterface dialog, int whichButton) {
 689                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 690 -                        mTracker.sendEvent(&quot;note&quot;, &quot;trash_emptied&quot;, &quot;overflow_menu&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 691 +                        mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 692 +                                new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 693 +                                        .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 694 +                                        .setAction(&quot;trash_emptied&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 695 +                                        .setLabel(&quot;overflow_menu&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 696 +                                        .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 697 +                        );</span>
 698                      }
 699                  });
 700                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 701                      public void onClick(DialogInterface dialog, int whichButton) {
 702                          // Do nothing, just closing the dialog
 703                      }
 704                  });
 705                  alert.show();
 706                  return true;
 707              case android.R.id.home:
 708                  invalidateOptionsMenu();
 709                  return true;
 710              default:
 711                  return super.onOptionsItemSelected(item);
 712          }
 713      }
 714  
 715      /**
 716       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 717       * the item with the given ID was selected.
 718       */
 719      @Override
 720      public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {
 721  
 722          if (!isLargeScreenLandscape()) {
 723              // Launch the editor activity
 724              Bundle arguments = new Bundle();
 725              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 726              arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, isNew);
 727  
 728              if (matchOffsets != null)
 729                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 730  
 731              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 732              editNoteIntent.putExtras(arguments);
 733              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 734          } else {
 735              mNoteEditorFragment.setIsNewNote(isNew);
 736              mNoteEditorFragment.setNote(noteID, matchOffsets);
 737              getNoteListFragment().setNoteSelected(noteID);
 738              if (mSearchView != null &amp;&amp; mSearchView.getQuery().length() &gt; 0) {
 739                  mTabletSearchQuery = mSearchView.getQuery().toString();
 740              }
 741              invalidateOptionsMenu();
 742          }
 743  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 744 -        mTracker.sendEvent(&quot;note&quot;, &quot;viewed_note&quot;, &quot;note_list_row_tap&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 745 +        mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 746 +                new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 747 +                        .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 748 +                        .setAction(&quot;viewed_note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 749 +                        .setLabel(&quot;note_list_row_tap&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 750 +                        .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 751 +        );</span>
 752      }
 753  
 754      @Override
 755      public void onUserCreated(User user) {
 756          // New account created
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 757 -        mTracker.sendEvent(&quot;user&quot;, &quot;new_account_created&quot;, &quot;account_created_from_login_activity&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 758 +        mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 759 +                new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 760 +                        .setCategory(&quot;user&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 761 +                        .setAction(&quot;new_account_created&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 762 +                        .setLabel(&quot;account_created_from_login_activity&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 763 +                        .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 764 +        );</span>
 765      }
 766  
 767      public void onUserStatusChange(User.Status status) {
 768          switch (status) {
 769  
 770              // successfully used access token to connect to simperium bucket
 771              case AUTHORIZED:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 772 -                mTracker.sendEvent(&quot;user&quot;, &quot;signed_in&quot;, &quot;signed_in_from_login_activity&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 773 +                mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 774 +                        new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 775 +                                .setCategory(&quot;user&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 776 +                                .setAction(&quot;signed_in&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 777 +                                .setLabel(&quot;signed_in_from_login_activity&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 778 +                                .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 779 +                );</span>
 780                  runOnUiThread(new Runnable() {
 781                      @Override
 782                      public void run() {
 783                          if (!mNotesBucket.hasChangeVersion()) {
 784                              setProgressBarIndeterminateVisibility(true);
 785                          }
 786                      }
 787                  });
 788                  break;
 789  
 790              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 791              case NOT_AUTHORIZED:
 792                  runOnUiThread(new Runnable() {
 793                      @Override
 794                      public void run() {
 795                          startLoginActivity(true);
 796                      }
 797                  });
 798                  break;
 799  
<abbr title=" 800              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 800              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
 801              case UNKNOWN:
 802                  break;
 803          }
 804      }
 805  
 806      public void startLoginActivity(boolean signInFirst) {
 807          Intent loginIntent = new Intent(this, LoginActivity.class);
 808          if (signInFirst)
 809              loginIntent.putExtra(LoginActivity.EXTRA_SIGN_IN_FIRST, true);
 810          startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 811      }
 812  
 813  
 814      @Override
 815      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 816          super.onActivityResult(requestCode, resultCode, data);
 817          switch (requestCode) {
 818              case Simplenote.INTENT_PREFERENCES:
 819                  if (ThemeUtils.themeWasChanged(data)) {
 820                      // Restart this activity to apply the new theme
 821                      recreate();
 822                      break;
 823                  }
<abbr title=" 824                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 824                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
 825                  invalidateOptionsMenu();
 826                  NoteListFragment fragment = getNoteListFragment();
 827                  if (fragment != null) {
 828                      fragment.getPrefs();
 829                      fragment.refreshList();
 830                  }
 831                  break;
 832              case Simplenote.INTENT_EDIT_NOTE:
 833                  if (resultCode == RESULT_OK &amp;&amp; data != null &amp;&amp; data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 834                      String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 835                      if (noteId != null) {
 836                          List&lt;String&gt; deletedNoteIds = new ArrayList&lt;String&gt;();
 837                          deletedNoteIds.add(noteId);
 838                          mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 839                          mUndoBarController.showUndoBar(false, getString(R.string.note_deleted), null);
 840                      }
 841                  }
 842                  break;
 843              case Simperium.SIGNUP_SIGNIN_REQUEST:
 844                  invalidateOptionsMenu();
 845                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 846                      finish();
 847                  }
 848                  break;
 849          }
 850      }
 851  
 852      @Override
 853      public void onUndo(Parcelable p) {
 854          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 855          if (mUndoBarController != null &amp;&amp; deletedNoteIds != null) {
 856  
 857              for (int i=0; i &lt; deletedNoteIds.size(); i++) {
 858                  Note deletedNote = null;
 859                  try {
 860                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 861                  } catch (BucketObjectMissingException e) {
 862                      return;
 863                  }
 864                  if (deletedNote != null) {
 865                      deletedNote.setDeleted(false);
 866                      deletedNote.setModificationDate(Calendar.getInstance());
 867                      deletedNote.save();
 868                      NoteListFragment fragment = getNoteListFragment();
 869                      if (fragment != null) {
 870                          fragment.getPrefs();
 871                          fragment.refreshList();
 872                      }
 873                  }
 874              }
 875          }
 876      }
 877  
 878      @Override
 879      protected void onPostCreate(Bundle savedInstanceState) {
 880          super.onPostCreate(savedInstanceState);
 881          // Sync the toggle state after onRestoreInstanceState has occurred.
 882          mDrawerToggle.syncState();
 883      }
 884  
 885      @Override
 886      public void onConfigurationChanged(Configuration newConfig) {
 887          super.onConfigurationChanged(newConfig);
 888  
 889          mDrawerToggle.onConfigurationChanged(newConfig);
 890  
 891          if (mIsLargeScreen) {
 892              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 893                  // Add the editor fragment
 894                  mIsLandscape = true;
 895                  addEditorFragment();
 896                  if (mNoteListFragment != null) {
 897                      mNoteListFragment.setActivateOnItemClick(true);
 898                      mNoteListFragment.setDividerVisible(true);
 899                  }
 900                  // Select the current note on a tablet
 901                  if (mCurrentNote != null)
 902                      onNoteSelected(mCurrentNote.getSimperiumKey(), false, null);
 903                  else {
 904                      mNoteEditorFragment.setPlaceholderVisible(true);
 905                      mNoteListFragment.getListView().clearChoices();
 906                  }
 907                  invalidateOptionsMenu();
<abbr title=" 908              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {"> 908              } else if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null)ðŸ”µ</abbr>
 909                  // Remove the editor fragment when rotating back to portrait
 910                  mIsLandscape = false;
 911                  mCurrentNote = null;
 912                  if (mNoteListFragment != null) {
 913                      mNoteListFragment.setActivateOnItemClick(false);
 914                      mNoteListFragment.setDividerVisible(false);
 915                      mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 916                      mNoteListFragment.refreshList();
 917                  }
 918                  FragmentManager fm = getFragmentManager();
 919                  FragmentTransaction ft = fm.beginTransaction();
 920                  ft.remove(mNoteEditorFragment);
 921                  mNoteEditorFragment = null;
 922                  ft.commitAllowingStateLoss();
 923                  fm.executePendingTransactions();
 924                  invalidateOptionsMenu();
 925              }
 926          }
 927      }
 928  
 929      public void checkEmptyListText(boolean isSearch) {
 930          if (isSearch) {
<abbr title=" 931              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);"> 931              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
 932              getNoteListFragment().setEmptyListViewClickable(false);
 933          } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title=" 934              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);"> 934              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 935 -            EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;viewed_trash&quot;, &quot;trash_filter_selected&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 936 +            mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 937 +                    new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 938 +                            .setCategory(&quot;user&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 939 +                            .setAction(&quot;viewed_trash&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 940 +                            .setLabel(&quot;trash_filter_selected&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 941 +                            .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 942 +            );</span>
 943              getNoteListFragment().setEmptyListViewClickable(false);
 944          } else {
<abbr title=" 945              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 945              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
 946              getNoteListFragment().setEmptyListViewClickable(true);
 947          }
 948      }
 949  
 950      public void showDetailPlaceholder() {
 951          if (isLargeScreenLandscape() &amp;&amp; mNoteEditorFragment != null) {
 952              mCurrentNote = null;
 953              mNoteEditorFragment.setPlaceholderVisible(true);
 954              invalidateOptionsMenu();
 955          }
 956      }
 957  
 958      public void stopListeningToNotesBucket() {
 959          mNotesBucket.removeOnNetworkChangeListener(this);
 960          mNotesBucket.removeOnSaveObjectListener(this);
 961          mNotesBucket.removeOnDeleteObjectListener(this);
 962      }
 963  
 964      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
 965          if (mUndoBarController != null) {
 966              mUndoBarController.setDeletedNoteIds(noteIds);
<abbr title=" 967              mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size()), null);"> 967              mUndoBarController.showUndoBar(false, getResources().getQuantityString(R.plurals.trashed_notes, noteIdðŸ”µ</abbr>
 968          }
 969      }
 970  
 971      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
 972  
 973          @Override
 974          protected Void doInBackground(Void... voids) {
 975              Simplenote application = (Simplenote) getApplication();
 976              Bucket&lt;Note&gt; noteBucket = application.getNotesBucket();
 977              Query&lt;Note&gt; query = Note.allDeleted(noteBucket);
 978              Bucket.ObjectCursor c = query.execute();
 979              while (c.moveToNext()) {
 980                  c.getObject().delete();
 981              }
 982              return null;
 983          }
 984  
 985          @Override
 986          protected void onPostExecute(Void nada) {
 987              showDetailPlaceholder();
 988          }
 989      }
 990  
 991  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            