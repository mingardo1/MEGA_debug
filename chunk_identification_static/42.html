<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>42</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    42
                    <a href="41.html">prev</a>
                    <a href="43.html">next</a>
                    <a href="42_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_28120f3be90421c75a68114a093c7ec725656310_Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;28120f3be90421c75a68114a093c7ec725656310:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;28120f3be90421c75a68114a093c7ec725656310^1:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;28120f3be90421c75a68114a093c7ec725656310^2:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;390cbc83d83f86ec754b6eb80272f7f4277bd7c3:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.Context;
   6 import android.content.DialogInterface;
   7 import android.content.Intent;
   8 import android.net.Uri;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.ParcelFileDescriptor;
  12 import android.widget.Toast;
  13 
  14 import androidx.appcompat.app.AlertDialog;
  15 import androidx.appcompat.view.ContextThemeWrapper;
  16 import androidx.core.app.ShareCompat;
  17 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  18 import androidx.core.content.ContextCompat;</span>
  19 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 import androidx.preference.ListPreference;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 import androidx.preference.Preference;</span>
  22 =======
  23 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  24 import androidx.fragment.app.FragmentActivity;
  25 import androidx.preference.ListPreference;
  26 import androidx.preference.Preference;
  27 import androidx.preference.PreferenceFragmentCompat;
  28 import androidx.preference.SwitchPreferenceCompat;
  29 
  30 import com.automattic.simplenote.analytics.AnalyticsTracker;
  31 import com.automattic.simplenote.authentication.SimplenoteAuthenticationActivity;
  32 import com.automattic.simplenote.models.Note;
  33 import com.automattic.simplenote.models.Preferences;
  34 import com.automattic.simplenote.utils.AccountNetworkUtils;
  35 import com.automattic.simplenote.utils.AccountNetworkUtils.DeleteAccountRequestHandler;
  36 import com.automattic.simplenote.utils.AppLog;
  37 import com.automattic.simplenote.utils.AppLog.Type;
  38 import com.automattic.simplenote.utils.AuthUtils;
  39 import com.automattic.simplenote.utils.BrowserUtils;
  40 import com.automattic.simplenote.utils.CrashUtils;
  41 import com.automattic.simplenote.utils.DialogUtils;
  42 import com.automattic.simplenote.utils.HtmlCompat;
  43 import com.automattic.simplenote.utils.PrefUtils;
  44 import com.automattic.simplenote.utils.SimplenoteProgressDialogFragment;
  45 import com.simperium.Simperium;
  46 import com.simperium.android.ProgressDialogFragment;
  47 import com.simperium.client.Bucket;
  48 import com.simperium.client.BucketObjectMissingException;
  49 import com.simperium.client.BucketObjectNameInvalid;
  50 import com.simperium.client.User;
  51 
  52 import org.json.JSONArray;
  53 import org.json.JSONObject;
  54 
  55 import java.io.FileOutputStream;
  56 import java.lang.ref.WeakReference;
  57 import java.util.Collections;
  58 import java.util.Comparator;
  59 import java.util.List;
  60 
  61 import static android.app.Activity.RESULT_OK;
  62 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  63 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING;
  64 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING_LABEL;
  65 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING;
  66 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING_LABEL;
  67 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING;
  68 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING_LABEL;
  69 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING;
  70 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING_LABEL;
  71 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING;
  72 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING_LABEL;
  73 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING;
  74 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING_LABEL;
  75 
  76 /**
  77  * A simple {@link Fragment} subclass.
  78  */
<abbr title="  79 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.OnUserCreatedListener {">  79 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, SðŸ”µ</abbr>
  80     public static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  81 
  82     private static final int REQUEST_EXPORT_DATA = 9001;
  83     private static final int REQUEST_EXPORT_UNSYNCED = 9002;
  84     private static final int REQUEST_IMPORT_DATA = 9003;
  85 
  86     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  87     private SwitchPreferenceCompat mAnalyticsSwitch;
  88     private SimplenoteProgressDialogFragment mProgressDialogFragment;
  89 
  90     public PreferencesFragment() {
  91         // Required empty public constructor
  92     }
  93 
  94     @Override
  95     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  96         addPreferencesFromResource(R.xml.preferences);
  97     }
  98 
  99     @Override
 100     public void onActivityCreated(Bundle savedInstanceState) {
 101         super.onActivityCreated(savedInstanceState);
 102 
 103         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 104         Simplenote currentApp = (Simplenote) getActivity().getApplication();
 105         Simperium simperium = currentApp.getSimperium();
 106         simperium.setUserStatusChangeListener(this);
 107         simperium.setOnUserCreatedListener(this);
 108         mPreferencesBucket = currentApp.getPreferencesBucket();
 109 
 110         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
 111         if (simperium.needsAuthorization()) {
 112             authenticatePreference.setTitle(R.string.log_in);
 113         } else {
 114             authenticatePreference.setTitle(R.string.log_out);
 115         }
 116 
 117         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 118             @Override
 119             public boolean onPreferenceClick(Preference preference) {
 120                 if (!isAdded()) {
 121                     return false;
 122                 }
 123 
 124                 Simplenote currentApp = (Simplenote) getActivity().getApplication();
 125                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 126                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);"> 126                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
 127                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 128                 } else {
 129                     new LogOutTask(PreferencesFragment.this).execute();
 130                 }
 131                 return true;
 132             }
 133         });
 134 
 135         Preference deleteAppPreference = findPreference(&quot;pref_key_delete_account&quot;);
 136         deleteAppPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 137             @Override
 138             public boolean onPreferenceClick(Preference preference) {
 139                 AnalyticsTracker.track(
 140                         AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED,
 141                         AnalyticsTracker.CATEGORY_USER,
 142                         &quot;preferences_delete_account_button&quot;
 143                 );
 144 
 145                 showDeleteAccountDialog();
 146                 return true;
 147             }
 148         });
 149 
<abbr title=" 150         findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 150         findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 151             @Override
 152             public boolean onPreferenceClick(Preference preference) {
 153                 try {
<abbr title=" 154                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;);"> 154                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;ðŸ”µ</abbr>
 155                 } catch (Exception e) {
 156                     toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 157                 }
 158                 return true;
 159             }
 160         });
 161 
<abbr title=" 162         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 162         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
 163             @Override
 164             public boolean onPreferenceClick(Preference preference) {
 165                 try {
 166                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 167                 } catch (Exception e) {
 168                     toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 169                 }
 170                 return true;
 171             }
 172         });
 173 
<abbr title=" 174         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 174         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
 175             @Override
 176             public boolean onPreferenceClick(Preference preference) {
 177                 startActivity(new Intent(getActivity(), AboutActivity.class));
 178                 return true;
 179             }
 180         });
 181 
<abbr title=" 182         findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 182         findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 183             @Override
 184             public boolean onPreferenceClick(Preference preference) {
 185                 AnalyticsTracker.track(
 186                         AnalyticsTracker.Stat.SETTINGS_IMPORT_NOTES,
 187                         AnalyticsTracker.CATEGORY_NOTE,
 188                         &quot;preferences_import_data_button&quot;
 189                 );
 190 
 191                 Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
 192                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 193                 intent.setType(&quot;*/*&quot;);
 194                 intent.putExtra(Intent.EXTRA_MIME_TYPES, new String[]{&quot;text/*&quot;, &quot;application/json&quot;});
 195                 startActivityForResult(intent, REQUEST_IMPORT_DATA);
 196                 return true;
 197             }
 198         });
 199 
<abbr title=" 200         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 200         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 201             @Override
 202             public boolean onPreferenceClick(Preference preference) {
 203                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 204                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 205                 intent.setType(&quot;application/json&quot;);
 206                 intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 207                 startActivityForResult(intent, REQUEST_EXPORT_DATA);
 208                 return true;
 209             }
 210         });
 211 
 212         final ListPreference themePreference = findPreference(PrefUtils.PREF_THEME);
 213         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 214             @Override
 215             public boolean onPreferenceChange(Preference preference, Object newValue) {
 216                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 217                 return true;
 218             }
 219 
 220             private void updateTheme(Activity activity, int index) {
 221                 CharSequence[] entries = themePreference.getEntries();
 222                 themePreference.setSummary(entries[index]);
 223 
 224                 AnalyticsTracker.track(
 225                         AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 226                         AnalyticsTracker.CATEGORY_USER,
 227                         &quot;theme_preference&quot;
 228                 );
 229             }
 230         });
 231 
 232         final Preference stylePreference = findPreference(&quot;pref_key_style&quot;);
 233         stylePreference.setSummary(
 234             PrefUtils.isPremium(requireContext()) ?
 235                 PrefUtils.getStyleNameFromIndexSelected(requireContext()) :
 236                 PrefUtils.getStyleNameDefault(requireContext())
 237         );
 238         stylePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 239             @Override
 240             public boolean onPreferenceClick(Preference preference) {
 241                 startActivity(new Intent(requireContext(), StyleActivity.class));
 242                 return true;
 243             }
 244         });
 245 
 246         final Preference membershipPreference = findPreference(&quot;pref_key_membership&quot;);
 247         membershipPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 248             @Override
 249             public boolean onPreferenceClick(Preference preference) {
 250                 ((PreferencesActivity) requireActivity()).openBrowserForMembership(getView());
 251                 return true;
 252             }
 253         });
 254 
 255         if (PrefUtils.isPremium(requireContext())) {
 256             membershipPreference.setLayoutResource(R.layout.preference_default);
 257             membershipPreference.setSummary(R.string.membership_premium);
 258         } else {
 259             membershipPreference.setLayoutResource(R.layout.preference_button);
 260             membershipPreference.setSummary(R.string.membership_free);
 261         }
 262 
 263         final ListPreference sortPreference = findPreference(PrefUtils.PREF_SORT_ORDER);
 264         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 265             @Override
 266             public boolean onPreferenceChange(Preference preference, Object newValue) {
 267                 int index = Integer.parseInt(newValue.toString());
 268                 CharSequence[] entries = sortPreference.getEntries();
 269                 sortPreference.setSummary(entries[index]);
 270 
 271                 if (!sortPreference.getValue().equals(newValue)) {
 272                     switch (index) {
 273                         case ALPHABETICAL_ASCENDING:
 274                             trackSortOrder(ALPHABETICAL_ASCENDING_LABEL);
 275                             break;
 276                         case ALPHABETICAL_DESCENDING:
 277                             trackSortOrder(ALPHABETICAL_DESCENDING_LABEL);
 278                             break;
 279                         case DATE_CREATED_ASCENDING:
 280                             trackSortOrder(DATE_CREATED_ASCENDING_LABEL);
 281                             break;
 282                         case DATE_CREATED_DESCENDING:
 283                             trackSortOrder(DATE_CREATED_DESCENDING_LABEL);
 284                             break;
 285                         case DATE_MODIFIED_ASCENDING:
 286                             trackSortOrder(DATE_MODIFIED_ASCENDING_LABEL);
 287                             break;
 288                         case DATE_MODIFIED_DESCENDING:
 289                             trackSortOrder(DATE_MODIFIED_DESCENDING_LABEL);
 290                             break;
 291                     }
 292                 }
 293 
 294                 return true;
 295             }
 296         });
 297 
 298         SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);
 299         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 300             @Override
 301             public boolean onPreferenceChange(Preference preference, Object o) {
 302                 if (((SwitchPreferenceCompat) preference).isChecked()) {
 303                     AnalyticsTracker.track(
 304                             AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 305                             AnalyticsTracker.CATEGORY_USER,
 306                             &quot;condensed_list_preference&quot;
 307                     );
 308                 }
 309 
 310                 return true;
 311             }
 312         });
 313 
 314         // Add the hyperlink to the analytics summary
 315         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 316         String formattedSummary = String.format(
 317                 getString(R.string.share_analytics_summary),
 318                 &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 319                 &quot;&lt;/a&gt;&quot;
 320         );
 321         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 322 
 323         mAnalyticsSwitch = findPreference(&quot;pref_key_analytics_switch&quot;);
 324         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 325             @Override
 326             public boolean onPreferenceChange(Preference preference, Object newValue) {
 327                 try {
 328                     boolean isChecked = (boolean)newValue;
 329                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 330                     prefs.setAnalyticsEnabled(isChecked);
 331                     prefs.save();
 332                 } catch (BucketObjectMissingException e) {
 333                     e.printStackTrace();
 334                 }
 335 
 336                 return true;
 337             }
 338         });
 339 
 340         updateAnalyticsSwitchState();
 341 
<abbr title=" 342         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 342         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 343             @Override
 344             public boolean onPreferenceClick(Preference preference) {
 345                 startActivity(
 346                     ShareCompat.IntentBuilder.from(requireActivity())
 347                         .setText(AppLog.get())
 348                         .setType(&quot;text/plain&quot;)
 349                         .createChooserIntent()
 350                 );
 351                 return true;
 352             }
 353         });
 354     }
 355 
 356     private void showProgressDialogDeleteAccount() {
 357         FragmentActivity activity = getActivity();
 358         if (activity == null) {
 359             return;
 360         }
 361 
<abbr title=" 362         mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requesting_message));"> 362         mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requestðŸ”µ</abbr>
 363         mProgressDialogFragment.show(activity.getSupportFragmentManager(), ProgressDialogFragment.TAG);
 364     }
 365 
 366     private void closeProgressDialogDeleteAccount() {
 367         if (mProgressDialogFragment != null &amp;&amp; !mProgressDialogFragment.isHidden()) {
 368             mProgressDialogFragment.dismiss();
 369             mProgressDialogFragment = null;
 370         }
 371     }
 372 
 373     private void showDeleteAccountDialog() {
 374         Context context = getContext();
 375         if (context == null) {
 376             return;
 377         }
 378 
<abbr title=" 379         final DeleteAccountRequestHandler deleteAccountHandler = new DeleteAccountRequestHandlerImpl(this);"> 379         final DeleteAccountRequestHandler deleteAccountHandler = new DeleteAccountRequestHandlerImpl(thisðŸ”µ</abbr>
 380 
<abbr title=" 381         final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, R.style.Dialog))"> 381         final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, ðŸ”µ</abbr>
 382                 .setTitle(R.string.delete_account)
 383                 .setMessage(R.string.delete_account_message)
 384                 .setPositiveButton(R.string.delete_account, new DialogInterface.OnClickListener() {
 385                         @Override
 386                         public void onClick(DialogInterface dialogInterface, int i) {
 387                             FragmentActivity activity = getActivity();
 388                             if (activity == null) {
 389                                 return;
 390                             }
 391 
 392                             showProgressDialogDeleteAccount();
 393 
 394                             Simplenote currentApp = (Simplenote) activity.getApplication();
 395                             Simperium simperium = currentApp.getSimperium();
 396                             String userEmail = simperium.getUser().getEmail();
 397                             String userToken = simperium.getUser().getAccessToken();
 398 
 399                             // makeDeleteAccountRequest can throw an exception when it cannot build
 400                             // the JSON object. In those cases, we show the error dialog since
 401                             // it can be related to memory constraints or something else that is
 402                             // just a transient fault
 403                             try {
 404                                 AppLog.add(Type.ACCOUNT, &quot;Making request to delete account&quot;);
 405 
 406                                 AccountNetworkUtils.makeDeleteAccountRequest(
 407                                         userEmail,
 408                                         userToken,
 409                                         deleteAccountHandler);
 410                             } catch (IllegalArgumentException exception) {
 411                                 AppLog.add(Type.ACCOUNT, &quot;Error trying to make request &quot; +
 412                                         &quot;to delete account. Error: &quot; + exception.getMessage());
 413 
 414                                 showDialogDeleteAccountError();
 415                             }
 416                         }
 417                     }
 418                 )
 419                 .setNegativeButton(R.string.cancel, null)
 420                 .create();
 421 
 422         dialogDeleteAccount.setOnShowListener(new DialogInterface.OnShowListener() {
 423             @Override
 424             public void onShow(DialogInterface dialog) {
 425                 FragmentActivity activity = getActivity();
 426                 if (activity == null) {
 427                     return;
 428                 }
 429 
 430                 int colorRed = ContextCompat.getColor(activity, R.color.text_button_red);
 431                 dialogDeleteAccount
 432                         .getButton(AlertDialog.BUTTON_POSITIVE)
 433                         .setTextColor(colorRed);
 434             }
 435         });
 436         dialogDeleteAccount.show();
 437     }
 438 
 439     private void showDialogDeleteAccountError() {
 440         Context context = getContext();
 441         if (context == null) {
 442             return;
 443         }
 444 
 445         DialogUtils.showDialogWithEmail(
 446                 context,
 447                 getString(R.string.error_ocurred_message)
 448         );
 449     }
 450 
 451     private void showDeleteAccountConfirmationDialog() {
 452         FragmentActivity activity = getActivity();
 453         if (activity == null) {
 454             return;
 455         }
 456 
 457         Simplenote currentApp = (Simplenote) activity.getApplication();
 458         Simperium simperium = currentApp.getSimperium();
 459         String userEmail = simperium.getUser().getEmail();
 460 
 461         AlertDialog dialogDeleteAccountConfirmation = new AlertDialog.Builder(
 462                 new ContextThemeWrapper(activity, R.style.Dialog))
 463                 .setTitle(R.string.request_received)
 464                 .setMessage(getString(R.string.account_deletion_message, userEmail))
 465                 .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {
 466                             @Override
 467                             public void onClick(DialogInterface dialogInterface, int i) {
 468                                 dialogInterface.dismiss();
 469                             }
 470                         }
 471                 )
 472                 .create();
 473 
 474         dialogDeleteAccountConfirmation.show();
 475     }
 476 
 477     @Override
 478     public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 479         if (resultCode != RESULT_OK || resultData == null) {
 480             return;
 481         }
 482 
 483         if (resultData.getData() == null) {
 484             toast(R.string.export_message_failure);
 485             return;
 486         }
 487 
 488         switch (requestCode) {
 489             case REQUEST_EXPORT_DATA:
 490                 exportData(resultData.getData(), false);
 491                 break;
 492             case REQUEST_EXPORT_UNSYNCED:
 493                 exportData(resultData.getData(), true);
 494                 break;
 495             case REQUEST_IMPORT_DATA:
 496                 importData(resultData.getData());
 497                 break;
 498         }
 499     }
 500 
 501     private boolean hasUnsyncedNotes() {
 502         Simplenote application = (Simplenote) getActivity().getApplication();
 503         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 504         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 505         while (notesCursor.moveToNext()) {
 506             Note note = notesCursor.getObject();
 507             if (note.isNew() || note.isModified()) {
 508                 return true;
 509             }
 510         }
 511 
 512         return false;
 513     }
 514 
 515     private void logOut() {
 516         AppLog.add(Type.ACTION, &quot;Tapped logout button (PreferencesFragment)&quot;);
 517         AnalyticsTracker.track(
 518                 AnalyticsTracker.Stat.USER_SIGNED_OUT,
 519                 AnalyticsTracker.CATEGORY_USER,
 520                 &quot;preferences_sign_out_button&quot;
 521         );
 522 
 523         AuthUtils.logOut((Simplenote) requireActivity().getApplication());
 524 
 525         getActivity().finish();
 526     }
 527 
 528     @Override
 529     public void onUserStatusChange(User.Status status) {
 530         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 531             // User signed in
 532             getActivity().runOnUiThread(new Runnable() {
 533                 public void run() {
 534                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 535                     authenticatePreference.setTitle(R.string.log_out);
 536                 }
 537             });
 538 
 539             Simplenote app = (Simplenote) getActivity().getApplication();
 540             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 541             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 542 
 543             AnalyticsTracker.track(
 544                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 545                     AnalyticsTracker.CATEGORY_USER,
 546                     &quot;signed_in_from_preferences_activity&quot;
 547             );
 548         }
 549     }
 550 
 551     @Override
 552     public void onUserCreated(User user) {
 553         AnalyticsTracker.track(
 554                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 555                 AnalyticsTracker.CATEGORY_USER,
 556                 &quot;account_created_from_preferences_activity&quot;
 557         );
 558     }
 559 
 560     private void exportData(Uri uri, boolean isUnsyncedNotes) {
 561         Simplenote currentApp = (Simplenote) requireActivity().getApplication();
 562         Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 563         JSONObject account = new JSONObject();
 564         Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 565 
 566         try {
 567             JSONArray activeNotes = new JSONArray();
 568             JSONArray trashedNotes = new JSONArray();
 569             Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 570                 @Override
 571                 public int compare(String text1, String text2) {
 572                     return text1.compareToIgnoreCase(text2);
 573                 }
 574             };
 575 
 576             while (cursor.moveToNext()) {
 577                 Note note = cursor.getObject();
 578 
 579                 if (isUnsyncedNotes &amp;&amp; !note.isNew() &amp;&amp; !note.isModified()) {
 580                     continue;
 581                 }
 582 
 583                 JSONObject noteJson = new JSONObject();
 584 
 585                 noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 586                 noteJson.put(&quot;content&quot;, note.getContent());
 587                 noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 588                 noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 589 
 590                 if (note.isPinned()) {
 591                     noteJson.put(&quot;pinned&quot;, note.isPinned());
 592                 }
 593 
 594                 if (note.isMarkdownEnabled()) {
 595                     noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 596                 }
 597 
 598                 if (note.getTags().size() &gt; 0) {
 599                     List&lt;String&gt; tags = note.getTags();
 600                     Collections.sort(tags, comparator);
 601                     noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 602                 }
 603 
 604                 if (!note.getPublishedUrl().isEmpty()) {
 605                     noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 606                 }
 607 
 608                 if (note.isDeleted()) {
 609                     trashedNotes.put(noteJson);
 610                 } else {
 611                     activeNotes.put(noteJson);
 612                 }
 613             }
 614 
 615             account.put(&quot;activeNotes&quot;, activeNotes);
 616             account.put(&quot;trashedNotes&quot;, trashedNotes);
 617 
<abbr title=" 618             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 618             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDesðŸ”µ</abbr>
 619 
 620             if (parcelFileDescriptor != null) {
<abbr title=" 621                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 621                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescðŸ”µ</abbr>
 622                 fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;,&quot;/&quot;).getBytes());
 623                 parcelFileDescriptor.close();
 624                 toast(R.string.export_message_success);
 625             } else {
 626                 toast(R.string.export_message_failure);
 627             }
 628         } catch (Exception e) {
 629             toast(R.string.export_message_failure);
 630         }
 631     }
 632 
 633     private void importData(Uri uri) {
 634         try {
 635             AppLog.add(Type.IMPORT, &quot;Importing notes from &quot; + uri + &quot;.&quot;);
 636 
 637             FragmentActivity activity = getActivity();
 638             if (activity == null) {
 639                 AppLog.add(Type.IMPORT, &quot;Could not import notes since activity is null&quot;);
 640                 return;
 641             }
 642 
 643             Importer.fromUri(activity, uri);
 644             toast(R.string.import_message_success);
 645 
 646             AppLog.add(Type.IMPORT, &quot;Notes imported correctly!&quot;);
 647         } catch (Importer.ImportException e) {
 648             switch (e.getReason()) {
 649                 case FileError:
<abbr title=" 650                     AppLog.add(Type.IMPORT, &quot;File error while importing note. Exception: &quot; + e.getMessage());"> 650                     AppLog.add(Type.IMPORT, &quot;File error while importing note. Exception: &quot; + e.getMessageðŸ”µ</abbr>
 651 
 652                     toast(R.string.import_error_file);
 653                     break;
 654                 case ParseError:
<abbr title=" 655                     AppLog.add(Type.IMPORT, &quot;Parse error while importing note. Exception: &quot; + e.getMessage());"> 655                     AppLog.add(Type.IMPORT, &quot;Parse error while importing note. Exception: &quot; + e.getMessagðŸ”µ</abbr>
 656 
 657                     toast(R.string.import_error_parse);
 658                     break;
 659                 case UnknownExportType:
<abbr title=" 660                     AppLog.add(Type.IMPORT, &quot;Unknown error while importing note. Exception: &quot; + e.getMessage());"> 660                     AppLog.add(Type.IMPORT, &quot;Unknown error while importing note. Exception: &quot; + e.getMessðŸ”µ</abbr>
 661 
 662                     toast(R.string.import_unknown);
 663                     break;
 664             }
 665         }
 666     }
 667 
 668     private void trackSortOrder(String label) {
 669         AnalyticsTracker.track(
 670             AnalyticsTracker.Stat.SETTINGS_SEARCH_SORT_MODE,
 671             AnalyticsTracker.CATEGORY_SETTING,
 672             label
 673         );
 674     }
 675 
 676     private void updateAnalyticsSwitchState() {
 677         try {
 678             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 679             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 680         } catch (BucketObjectMissingException e) {
 681             // The preferences object doesn&#x27;t exist for this user yet, create it
 682             try {
 683                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 684                 prefs.setAnalyticsEnabled(true);
 685                 prefs.save();
 686             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 687                 bucketObjectNameInvalid.printStackTrace();
 688             }
 689         }
 690     }
 691 
 692     private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 693         private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 694 
 695         LogOutTask(PreferencesFragment fragment) {
 696             mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 697         }
 698 
 699         @Override
 700         protected Boolean doInBackground(Void... voids) {
 701             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 702             return fragment == null || fragment.hasUnsyncedNotes();
 703         }
 704 
 705         @Override
 706         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 707             final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 708 
 709             if (fragment == null) {
 710                 return;
 711             }
 712 
 713             // Safety first! Check if any notes are unsynced and warn the user if so.
 714             if (hasUnsyncedNotes) {
<abbr title=" 715                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))"> 715                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 716                     .setTitle(R.string.unsynced_notes)
 717                     .setMessage(R.string.unsynced_notes_message)
 718                     .setPositiveButton(R.string.log_out_anyway,
 719                         new DialogInterface.OnClickListener() {
 720                             @Override
 721                             public void onClick(DialogInterface dialogInterface, int i) {
 722                                 fragment.logOut();
 723                             }
 724                         }
 725                     )
 726                     .setNeutralButton(R.string.export_unsynced_notes,
 727                         new DialogInterface.OnClickListener() {
 728                             @Override
 729                             public void onClick(DialogInterface dialogInterface, int i) {
 730                                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 731                                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 732                                 intent.setType(&quot;application/json&quot;);
<abbr title=" 733                                 intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));"> 733                                 intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_fiðŸ”µ</abbr>
 734                                 fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 735                             }
 736                         }
 737                     )
 738                     .setNegativeButton(R.string.cancel, null)
 739                     .show();
 740             } else {
 741                 fragment.logOut();
 742             }
 743         }
 744     }
 745   
 746     private void toast(int stringId) {
 747         toast(stringId, Toast.LENGTH_SHORT);
 748     }
 749 
 750     private void toast(int stringId, int length) {
 751         Toast.makeText(requireContext(), getString(stringId), length).show();
 752     }
 753 
 754     static class DeleteAccountRequestHandlerImpl implements DeleteAccountRequestHandler {
 755         final WeakReference&lt;PreferencesFragment&gt; preferencesFragment;
 756 
 757         DeleteAccountRequestHandlerImpl(PreferencesFragment fragment) {
 758             this.preferencesFragment = new WeakReference&lt;&gt;(fragment);
 759         }
 760 
 761         @Override
 762         public void onSuccess() {
 763             final PreferencesFragment fragment = preferencesFragment.get();
 764             if (fragment == null) {
 765                 return;
 766             }
 767 
 768             FragmentActivity activity = fragment.getActivity();
 769             if (activity == null) {
 770                 return;
 771             }
 772 
 773             AppLog.add(Type.ACCOUNT, &quot;Request to delete account was successful&quot;);
 774             AnalyticsTracker.track(
 775                     AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED,
 776                     AnalyticsTracker.CATEGORY_USER,
 777                     &quot;delete_account_request_success&quot;
 778             );
 779 
 780             activity.runOnUiThread(new Runnable() {
 781                 @Override
 782                 public void run() {
 783                     fragment.closeProgressDialogDeleteAccount();
 784                     fragment.showDeleteAccountConfirmationDialog();
 785                 }
 786             });
 787         }
 788 
 789         @Override
 790         public void onFailure() {
 791             final PreferencesFragment fragment = preferencesFragment.get();
 792             if (fragment == null) {
 793                 return;
 794             }
 795 
 796             FragmentActivity activity = fragment.getActivity();
 797             if (activity == null) {
 798                 return;
 799             }
 800 
 801             AppLog.add(Type.ACCOUNT, &quot;Failure while calling server to delete account&quot;);
 802             AnalyticsTracker.track(
 803                     AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED,
 804                     AnalyticsTracker.CATEGORY_USER,
 805                     &quot;delete_account_request_failure&quot;
 806             );
 807 
 808             activity.runOnUiThread(new Runnable() {
 809                 @Override
 810                 public void run() {
 811                     fragment.closeProgressDialogDeleteAccount();
 812                     fragment.showDialogDeleteAccountError();
 813                 }
 814             });
 815         }
 816     }
 817 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.Context;
   6 import android.content.DialogInterface;
   7 import android.content.Intent;
   8 import android.net.Uri;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.ParcelFileDescriptor;
  12 import android.widget.Toast;
  13 
  14 import androidx.appcompat.app.AlertDialog;
  15 import androidx.appcompat.view.ContextThemeWrapper;
  16 import androidx.core.app.ShareCompat;
  17 import androidx.core.content.ContextCompat;
  18 import androidx.fragment.app.FragmentActivity;
  19 import androidx.preference.ListPreference;
  20 import androidx.preference.Preference;
  21 import androidx.preference.PreferenceFragmentCompat;
  22 import androidx.preference.SwitchPreferenceCompat;
  23 
  24 import com.automattic.simplenote.analytics.AnalyticsTracker;
  25 import com.automattic.simplenote.authentication.SimplenoteAuthenticationActivity;
  26 import com.automattic.simplenote.models.Note;
  27 import com.automattic.simplenote.models.Preferences;
  28 import com.automattic.simplenote.utils.AccountNetworkUtils;
  29 import com.automattic.simplenote.utils.AccountNetworkUtils.DeleteAccountRequestHandler;
  30 import com.automattic.simplenote.utils.AppLog;
  31 import com.automattic.simplenote.utils.AppLog.Type;
  32 import com.automattic.simplenote.utils.AuthUtils;
  33 import com.automattic.simplenote.utils.BrowserUtils;
  34 import com.automattic.simplenote.utils.CrashUtils;
  35 import com.automattic.simplenote.utils.DialogUtils;
  36 import com.automattic.simplenote.utils.HtmlCompat;
  37 import com.automattic.simplenote.utils.PrefUtils;
  38 import com.automattic.simplenote.utils.SimplenoteProgressDialogFragment;
  39 import com.simperium.Simperium;
  40 import com.simperium.android.ProgressDialogFragment;
  41 import com.simperium.client.Bucket;
  42 import com.simperium.client.BucketObjectMissingException;
  43 import com.simperium.client.BucketObjectNameInvalid;
  44 import com.simperium.client.User;
  45 
  46 import org.json.JSONArray;
  47 import org.json.JSONObject;
  48 
  49 import java.io.FileOutputStream;
  50 import java.lang.ref.WeakReference;
  51 import java.util.Collections;
  52 import java.util.Comparator;
  53 import java.util.List;
  54 
  55 import static android.app.Activity.RESULT_OK;
  56 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  57 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING;
  58 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING_LABEL;
  59 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING;
  60 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING_LABEL;
  61 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING;
  62 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING_LABEL;
  63 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING;
  64 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING_LABEL;
  65 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING;
  66 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING_LABEL;
  67 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING;
  68 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING_LABEL;
  69 
  70 /**
  71  * A simple {@link Fragment} subclass.
  72  */
<abbr title="  73 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.OnUserCreatedListener {">  73 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, SðŸ”µ</abbr>
  74     public static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  75 
  76     private static final int REQUEST_EXPORT_DATA = 9001;
  77     private static final int REQUEST_EXPORT_UNSYNCED = 9002;
  78     private static final int REQUEST_IMPORT_DATA = 9003;
  79 
  80     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  81     private SwitchPreferenceCompat mAnalyticsSwitch;
  82     private SimplenoteProgressDialogFragment mProgressDialogFragment;
  83 
  84     public PreferencesFragment() {
  85         // Required empty public constructor
  86     }
  87 
  88     @Override
  89     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  90         addPreferencesFromResource(R.xml.preferences);
  91     }
  92 
  93     @Override
  94     public void onActivityCreated(Bundle savedInstanceState) {
  95         super.onActivityCreated(savedInstanceState);
  96 
  97         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  98         Simplenote currentApp = (Simplenote) getActivity().getApplication();
  99         Simperium simperium = currentApp.getSimperium();
 100         simperium.setUserStatusChangeListener(this);
 101         simperium.setOnUserCreatedListener(this);
 102         mPreferencesBucket = currentApp.getPreferencesBucket();
 103 
 104         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
 105         if (simperium.needsAuthorization()) {
 106             authenticatePreference.setTitle(R.string.log_in);
 107         } else {
 108             authenticatePreference.setTitle(R.string.log_out);
 109         }
 110 
 111         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 112             @Override
 113             public boolean onPreferenceClick(Preference preference) {
 114                 if (!isAdded()) {
 115                     return false;
 116                 }
 117 
 118                 Simplenote currentApp = (Simplenote) getActivity().getApplication();
 119                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 120                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);"> 120                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
 121                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 122                 } else {
 123                     new LogOutTask(PreferencesFragment.this).execute();
 124                 }
 125                 return true;
 126             }
 127         });
 128 
 129         Preference deleteAppPreference = findPreference(&quot;pref_key_delete_account&quot;);
 130         deleteAppPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 131             @Override
 132             public boolean onPreferenceClick(Preference preference) {
 133                 AnalyticsTracker.track(
 134                         AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED,
 135                         AnalyticsTracker.CATEGORY_USER,
 136                         &quot;preferences_delete_account_button&quot;
 137                 );
 138 
 139                 showDeleteAccountDialog();
 140                 return true;
 141             }
 142         });
 143 
<abbr title=" 144         findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 144         findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 145             @Override
 146             public boolean onPreferenceClick(Preference preference) {
 147                 try {
<abbr title=" 148                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;);"> 148                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;ðŸ”µ</abbr>
 149                 } catch (Exception e) {
 150                     toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 151                 }
 152                 return true;
 153             }
 154         });
 155 
<abbr title=" 156         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 156         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
 157             @Override
 158             public boolean onPreferenceClick(Preference preference) {
 159                 try {
 160                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 161                 } catch (Exception e) {
 162                     toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 163                 }
 164                 return true;
 165             }
 166         });
 167 
<abbr title=" 168         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 168         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
 169             @Override
 170             public boolean onPreferenceClick(Preference preference) {
 171                 startActivity(new Intent(getActivity(), AboutActivity.class));
 172                 return true;
 173             }
 174         });
 175 
<abbr title=" 176         findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 176         findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 177             @Override
 178             public boolean onPreferenceClick(Preference preference) {
 179                 AnalyticsTracker.track(
 180                         AnalyticsTracker.Stat.SETTINGS_IMPORT_NOTES,
 181                         AnalyticsTracker.CATEGORY_NOTE,
 182                         &quot;preferences_import_data_button&quot;
 183                 );
 184 
 185                 Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
 186                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 187                 intent.setType(&quot;*/*&quot;);
 188                 intent.putExtra(Intent.EXTRA_MIME_TYPES, new String[]{&quot;text/*&quot;, &quot;application/json&quot;});
 189                 startActivityForResult(intent, REQUEST_IMPORT_DATA);
 190                 return true;
 191             }
 192         });
 193 
<abbr title=" 194         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 194         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 195             @Override
 196             public boolean onPreferenceClick(Preference preference) {
 197                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 198                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 199                 intent.setType(&quot;application/json&quot;);
 200                 intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 201                 startActivityForResult(intent, REQUEST_EXPORT_DATA);
 202                 return true;
 203             }
 204         });
 205 
 206         final ListPreference themePreference = findPreference(PrefUtils.PREF_THEME);
 207         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 208             @Override
 209             public boolean onPreferenceChange(Preference preference, Object newValue) {
 210                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 211                 return true;
 212             }
 213 
 214             private void updateTheme(Activity activity, int index) {
 215                 CharSequence[] entries = themePreference.getEntries();
 216                 themePreference.setSummary(entries[index]);
 217 
 218                 AnalyticsTracker.track(
 219                         AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 220                         AnalyticsTracker.CATEGORY_USER,
 221                         &quot;theme_preference&quot;
 222                 );
 223             }
 224         });
 225 
 226         final Preference stylePreference = findPreference(&quot;pref_key_style&quot;);
 227         stylePreference.setSummary(
 228             PrefUtils.isPremium(requireContext()) ?
 229                 PrefUtils.getStyleNameFromIndexSelected(requireContext()) :
 230                 PrefUtils.getStyleNameDefault(requireContext())
 231         );
 232         stylePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 233             @Override
 234             public boolean onPreferenceClick(Preference preference) {
 235                 startActivity(new Intent(requireContext(), StyleActivity.class));
 236                 return true;
 237             }
 238         });
 239 
 240         final Preference membershipPreference = findPreference(&quot;pref_key_membership&quot;);
 241         membershipPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 242             @Override
 243             public boolean onPreferenceClick(Preference preference) {
 244                 ((PreferencesActivity) requireActivity()).openBrowserForMembership(getView());
 245                 return true;
 246             }
 247         });
 248 
 249         if (PrefUtils.isPremium(requireContext())) {
 250             membershipPreference.setLayoutResource(R.layout.preference_default);
 251             membershipPreference.setSummary(R.string.membership_premium);
 252         } else {
 253             membershipPreference.setLayoutResource(R.layout.preference_button);
 254             membershipPreference.setSummary(R.string.membership_free);
 255         }
 256 
 257         final ListPreference sortPreference = findPreference(PrefUtils.PREF_SORT_ORDER);
 258         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 259             @Override
 260             public boolean onPreferenceChange(Preference preference, Object newValue) {
 261                 int index = Integer.parseInt(newValue.toString());
 262                 CharSequence[] entries = sortPreference.getEntries();
 263                 sortPreference.setSummary(entries[index]);
 264 
 265                 if (!sortPreference.getValue().equals(newValue)) {
 266                     switch (index) {
 267                         case ALPHABETICAL_ASCENDING:
 268                             trackSortOrder(ALPHABETICAL_ASCENDING_LABEL);
 269                             break;
 270                         case ALPHABETICAL_DESCENDING:
 271                             trackSortOrder(ALPHABETICAL_DESCENDING_LABEL);
 272                             break;
 273                         case DATE_CREATED_ASCENDING:
 274                             trackSortOrder(DATE_CREATED_ASCENDING_LABEL);
 275                             break;
 276                         case DATE_CREATED_DESCENDING:
 277                             trackSortOrder(DATE_CREATED_DESCENDING_LABEL);
 278                             break;
 279                         case DATE_MODIFIED_ASCENDING:
 280                             trackSortOrder(DATE_MODIFIED_ASCENDING_LABEL);
 281                             break;
 282                         case DATE_MODIFIED_DESCENDING:
 283                             trackSortOrder(DATE_MODIFIED_DESCENDING_LABEL);
 284                             break;
 285                     }
 286                 }
 287 
 288                 return true;
 289             }
 290         });
 291 
 292         SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);
 293         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 294             @Override
 295             public boolean onPreferenceChange(Preference preference, Object o) {
 296                 if (((SwitchPreferenceCompat) preference).isChecked()) {
 297                     AnalyticsTracker.track(
 298                             AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 299                             AnalyticsTracker.CATEGORY_USER,
 300                             &quot;condensed_list_preference&quot;
 301                     );
 302                 }
 303 
 304                 return true;
 305             }
 306         });
 307 
 308         // Add the hyperlink to the analytics summary
 309         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 310         String formattedSummary = String.format(
 311                 getString(R.string.share_analytics_summary),
 312                 &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 313                 &quot;&lt;/a&gt;&quot;
 314         );
 315         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 316 
 317         mAnalyticsSwitch = findPreference(&quot;pref_key_analytics_switch&quot;);
 318         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 319             @Override
 320             public boolean onPreferenceChange(Preference preference, Object newValue) {
 321                 try {
 322                     boolean isChecked = (boolean)newValue;
 323                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 324                     prefs.setAnalyticsEnabled(isChecked);
 325                     prefs.save();
 326                 } catch (BucketObjectMissingException e) {
 327                     e.printStackTrace();
 328                 }
 329 
 330                 return true;
 331             }
 332         });
 333 
 334         updateAnalyticsSwitchState();
 335 
<abbr title=" 336         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 336         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 337             @Override
 338             public boolean onPreferenceClick(Preference preference) {
 339                 startActivity(
 340                     ShareCompat.IntentBuilder.from(requireActivity())
 341                         .setText(AppLog.get())
 342                         .setType(&quot;text/plain&quot;)
 343                         .createChooserIntent()
 344                 );
 345                 return true;
 346             }
 347         });
 348     }
 349 
 350     private void showProgressDialogDeleteAccount() {
 351         FragmentActivity activity = getActivity();
 352         if (activity == null) {
 353             return;
 354         }
 355 
<abbr title=" 356         mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requesting_message));"> 356         mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requestðŸ”µ</abbr>
 357         mProgressDialogFragment.show(activity.getSupportFragmentManager(), ProgressDialogFragment.TAG);
 358     }
 359 
 360     private void closeProgressDialogDeleteAccount() {
 361         if (mProgressDialogFragment != null &amp;&amp; !mProgressDialogFragment.isHidden()) {
 362             mProgressDialogFragment.dismiss();
 363             mProgressDialogFragment = null;
 364         }
 365     }
 366 
 367     private void showDeleteAccountDialog() {
 368         Context context = getContext();
 369         if (context == null) {
 370             return;
 371         }
 372 
<abbr title=" 373         final DeleteAccountRequestHandler deleteAccountHandler = new DeleteAccountRequestHandlerImpl(this);"> 373         final DeleteAccountRequestHandler deleteAccountHandler = new DeleteAccountRequestHandlerImpl(thisðŸ”µ</abbr>
 374 
<abbr title=" 375         final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, R.style.Dialog))"> 375         final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, ðŸ”µ</abbr>
 376                 .setTitle(R.string.delete_account)
 377                 .setMessage(R.string.delete_account_message)
 378                 .setPositiveButton(R.string.delete_account, new DialogInterface.OnClickListener() {
 379                         @Override
 380                         public void onClick(DialogInterface dialogInterface, int i) {
 381                             FragmentActivity activity = getActivity();
 382                             if (activity == null) {
 383                                 return;
 384                             }
 385 
 386                             showProgressDialogDeleteAccount();
 387 
 388                             Simplenote currentApp = (Simplenote) activity.getApplication();
 389                             Simperium simperium = currentApp.getSimperium();
 390                             String userEmail = simperium.getUser().getEmail();
 391                             String userToken = simperium.getUser().getAccessToken();
 392 
 393                             // makeDeleteAccountRequest can throw an exception when it cannot build
 394                             // the JSON object. In those cases, we show the error dialog since
 395                             // it can be related to memory constraints or something else that is
 396                             // just a transient fault
 397                             try {
 398                                 AppLog.add(Type.ACCOUNT, &quot;Making request to delete account&quot;);
 399 
 400                                 AccountNetworkUtils.makeDeleteAccountRequest(
 401                                         userEmail,
 402                                         userToken,
 403                                         deleteAccountHandler);
 404                             } catch (IllegalArgumentException exception) {
 405                                 AppLog.add(Type.ACCOUNT, &quot;Error trying to make request &quot; +
 406                                         &quot;to delete account. Error: &quot; + exception.getMessage());
 407 
 408                                 showDialogDeleteAccountError();
 409                             }
 410                         }
 411                     }
 412                 )
 413                 .setNegativeButton(R.string.cancel, null)
 414                 .create();
 415 
 416         dialogDeleteAccount.setOnShowListener(new DialogInterface.OnShowListener() {
 417             @Override
 418             public void onShow(DialogInterface dialog) {
 419                 FragmentActivity activity = getActivity();
 420                 if (activity == null) {
 421                     return;
 422                 }
 423 
 424                 int colorRed = ContextCompat.getColor(activity, R.color.text_button_red);
 425                 dialogDeleteAccount
 426                         .getButton(AlertDialog.BUTTON_POSITIVE)
 427                         .setTextColor(colorRed);
 428             }
 429         });
 430         dialogDeleteAccount.show();
 431     }
 432 
 433     private void showDialogDeleteAccountError() {
 434         Context context = getContext();
 435         if (context == null) {
 436             return;
 437         }
 438 
 439         DialogUtils.showDialogWithEmail(
 440                 context,
 441                 getString(R.string.error_ocurred_message)
 442         );
 443     }
 444 
 445     private void showDeleteAccountConfirmationDialog() {
 446         FragmentActivity activity = getActivity();
 447         if (activity == null) {
 448             return;
 449         }
 450 
 451         Simplenote currentApp = (Simplenote) activity.getApplication();
 452         Simperium simperium = currentApp.getSimperium();
 453         String userEmail = simperium.getUser().getEmail();
 454 
 455         AlertDialog dialogDeleteAccountConfirmation = new AlertDialog.Builder(
 456                 new ContextThemeWrapper(activity, R.style.Dialog))
 457                 .setTitle(R.string.request_received)
 458                 .setMessage(getString(R.string.account_deletion_message, userEmail))
 459                 .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {
 460                             @Override
 461                             public void onClick(DialogInterface dialogInterface, int i) {
 462                                 dialogInterface.dismiss();
 463                             }
 464                         }
 465                 )
 466                 .create();
 467 
 468         dialogDeleteAccountConfirmation.show();
 469     }
 470 
 471     @Override
 472     public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 473         if (resultCode != RESULT_OK || resultData == null) {
 474             return;
 475         }
 476 
 477         if (resultData.getData() == null) {
 478             toast(R.string.export_message_failure);
 479             return;
 480         }
 481 
 482         switch (requestCode) {
 483             case REQUEST_EXPORT_DATA:
 484                 exportData(resultData.getData(), false);
 485                 break;
 486             case REQUEST_EXPORT_UNSYNCED:
 487                 exportData(resultData.getData(), true);
 488                 break;
 489             case REQUEST_IMPORT_DATA:
 490                 importData(resultData.getData());
 491                 break;
 492         }
 493     }
 494 
 495     private boolean hasUnsyncedNotes() {
 496         Simplenote application = (Simplenote) getActivity().getApplication();
 497         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 498         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 499         while (notesCursor.moveToNext()) {
 500             Note note = notesCursor.getObject();
 501             if (note.isNew() || note.isModified()) {
 502                 return true;
 503             }
 504         }
 505 
 506         return false;
 507     }
 508 
 509     private void logOut() {
 510         AppLog.add(Type.ACTION, &quot;Tapped logout button (PreferencesFragment)&quot;);
 511         AnalyticsTracker.track(
 512                 AnalyticsTracker.Stat.USER_SIGNED_OUT,
 513                 AnalyticsTracker.CATEGORY_USER,
 514                 &quot;preferences_sign_out_button&quot;
 515         );
 516 
 517         AuthUtils.logOut((Simplenote) requireActivity().getApplication());
 518 
 519         getActivity().finish();
 520     }
 521 
 522     @Override
 523     public void onUserStatusChange(User.Status status) {
 524         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 525             // User signed in
 526             getActivity().runOnUiThread(new Runnable() {
 527                 public void run() {
 528                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 529                     authenticatePreference.setTitle(R.string.log_out);
 530                 }
 531             });
 532 
 533             Simplenote app = (Simplenote) getActivity().getApplication();
 534             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 535             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 536 
 537             AnalyticsTracker.track(
 538                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 539                     AnalyticsTracker.CATEGORY_USER,
 540                     &quot;signed_in_from_preferences_activity&quot;
 541             );
 542         }
 543     }
 544 
 545     @Override
 546     public void onUserCreated(User user) {
 547         AnalyticsTracker.track(
 548                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 549                 AnalyticsTracker.CATEGORY_USER,
 550                 &quot;account_created_from_preferences_activity&quot;
 551         );
 552     }
 553 
 554     private void exportData(Uri uri, boolean isUnsyncedNotes) {
 555         Simplenote currentApp = (Simplenote) requireActivity().getApplication();
 556         Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 557         JSONObject account = new JSONObject();
 558         Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 559 
 560         try {
 561             JSONArray activeNotes = new JSONArray();
 562             JSONArray trashedNotes = new JSONArray();
 563             Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 564                 @Override
 565                 public int compare(String text1, String text2) {
 566                     return text1.compareToIgnoreCase(text2);
 567                 }
 568             };
 569 
 570             while (cursor.moveToNext()) {
 571                 Note note = cursor.getObject();
 572 
 573                 if (isUnsyncedNotes &amp;&amp; !note.isNew() &amp;&amp; !note.isModified()) {
 574                     continue;
 575                 }
 576 
 577                 JSONObject noteJson = new JSONObject();
 578 
 579                 noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 580                 noteJson.put(&quot;content&quot;, note.getContent());
 581                 noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 582                 noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 583 
 584                 if (note.isPinned()) {
 585                     noteJson.put(&quot;pinned&quot;, note.isPinned());
 586                 }
 587 
 588                 if (note.isMarkdownEnabled()) {
 589                     noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 590                 }
 591 
 592                 if (note.getTags().size() &gt; 0) {
 593                     List&lt;String&gt; tags = note.getTags();
 594                     Collections.sort(tags, comparator);
 595                     noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 596                 }
 597 
 598                 if (!note.getPublishedUrl().isEmpty()) {
 599                     noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 600                 }
 601 
 602                 if (note.isDeleted()) {
 603                     trashedNotes.put(noteJson);
 604                 } else {
 605                     activeNotes.put(noteJson);
 606                 }
 607             }
 608 
 609             account.put(&quot;activeNotes&quot;, activeNotes);
 610             account.put(&quot;trashedNotes&quot;, trashedNotes);
 611 
<abbr title=" 612             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 612             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDesðŸ”µ</abbr>
 613 
 614             if (parcelFileDescriptor != null) {
<abbr title=" 615                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 615                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescðŸ”µ</abbr>
 616                 fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;,&quot;/&quot;).getBytes());
 617                 parcelFileDescriptor.close();
 618                 toast(R.string.export_message_success);
 619             } else {
 620                 toast(R.string.export_message_failure);
 621             }
 622         } catch (Exception e) {
 623             toast(R.string.export_message_failure);
 624         }
 625     }
 626 
 627     private void importData(Uri uri) {
 628         try {
 629             AppLog.add(Type.IMPORT, &quot;Importing notes from &quot; + uri + &quot;.&quot;);
 630 
 631             FragmentActivity activity = getActivity();
 632             if (activity == null) {
 633                 AppLog.add(Type.IMPORT, &quot;Could not import notes since activity is null&quot;);
 634                 return;
 635             }
 636 
 637             Importer.fromUri(activity, uri);
 638             toast(R.string.import_message_success);
 639 
 640             AppLog.add(Type.IMPORT, &quot;Notes imported correctly!&quot;);
 641         } catch (Importer.ImportException e) {
 642             switch (e.getReason()) {
 643                 case FileError:
<abbr title=" 644                     AppLog.add(Type.IMPORT, &quot;File error while importing note. Exception: &quot; + e.getMessage());"> 644                     AppLog.add(Type.IMPORT, &quot;File error while importing note. Exception: &quot; + e.getMessageðŸ”µ</abbr>
 645 
 646                     toast(R.string.import_error_file);
 647                     break;
 648                 case ParseError:
<abbr title=" 649                     AppLog.add(Type.IMPORT, &quot;Parse error while importing note. Exception: &quot; + e.getMessage());"> 649                     AppLog.add(Type.IMPORT, &quot;Parse error while importing note. Exception: &quot; + e.getMessagðŸ”µ</abbr>
 650 
 651                     toast(R.string.import_error_parse);
 652                     break;
 653                 case UnknownExportType:
<abbr title=" 654                     AppLog.add(Type.IMPORT, &quot;Unknown error while importing note. Exception: &quot; + e.getMessage());"> 654                     AppLog.add(Type.IMPORT, &quot;Unknown error while importing note. Exception: &quot; + e.getMessðŸ”µ</abbr>
 655 
 656                     toast(R.string.import_unknown);
 657                     break;
 658             }
 659         }
 660     }
 661 
 662     private void trackSortOrder(String label) {
 663         AnalyticsTracker.track(
 664             AnalyticsTracker.Stat.SETTINGS_SEARCH_SORT_MODE,
 665             AnalyticsTracker.CATEGORY_SETTING,
 666             label
 667         );
 668     }
 669 
 670     private void updateAnalyticsSwitchState() {
 671         try {
 672             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 673             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 674         } catch (BucketObjectMissingException e) {
 675             // The preferences object doesn&#x27;t exist for this user yet, create it
 676             try {
 677                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 678                 prefs.setAnalyticsEnabled(true);
 679                 prefs.save();
 680             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 681                 bucketObjectNameInvalid.printStackTrace();
 682             }
 683         }
 684     }
 685 
 686     private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 687         private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 688 
 689         LogOutTask(PreferencesFragment fragment) {
 690             mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 691         }
 692 
 693         @Override
 694         protected Boolean doInBackground(Void... voids) {
 695             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 696             return fragment == null || fragment.hasUnsyncedNotes();
 697         }
 698 
 699         @Override
 700         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 701             final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 702 
 703             if (fragment == null) {
 704                 return;
 705             }
 706 
 707             // Safety first! Check if any notes are unsynced and warn the user if so.
 708             if (hasUnsyncedNotes) {
<abbr title=" 709                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))"> 709                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 710                     .setTitle(R.string.unsynced_notes)
 711                     .setMessage(R.string.unsynced_notes_message)
 712                     .setPositiveButton(R.string.log_out_anyway,
 713                         new DialogInterface.OnClickListener() {
 714                             @Override
 715                             public void onClick(DialogInterface dialogInterface, int i) {
 716                                 fragment.logOut();
 717                             }
 718                         }
 719                     )
 720                     .setNeutralButton(R.string.export_unsynced_notes,
 721                         new DialogInterface.OnClickListener() {
 722                             @Override
 723                             public void onClick(DialogInterface dialogInterface, int i) {
 724                                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 725                                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 726                                 intent.setType(&quot;application/json&quot;);
<abbr title=" 727                                 intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));"> 727                                 intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_fiðŸ”µ</abbr>
 728                                 fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 729                             }
 730                         }
 731                     )
 732                     .setNegativeButton(R.string.cancel, null)
 733                     .show();
 734             } else {
 735                 fragment.logOut();
 736             }
 737         }
 738     }
 739 
 740     private void toast(int stringId) {
 741         toast(stringId, Toast.LENGTH_SHORT);
 742     }
 743 
 744     private void toast(int stringId, int length) {
 745         Toast.makeText(requireContext(), getString(stringId), length).show();
 746     }
 747 
 748     static class DeleteAccountRequestHandlerImpl implements DeleteAccountRequestHandler {
 749         final WeakReference&lt;PreferencesFragment&gt; preferencesFragment;
 750 
 751         DeleteAccountRequestHandlerImpl(PreferencesFragment fragment) {
 752             this.preferencesFragment = new WeakReference&lt;&gt;(fragment);
 753         }
 754 
 755         @Override
 756         public void onSuccess() {
 757             final PreferencesFragment fragment = preferencesFragment.get();
 758             if (fragment == null) {
 759                 return;
 760             }
 761 
 762             FragmentActivity activity = fragment.getActivity();
 763             if (activity == null) {
 764                 return;
 765             }
 766 
 767             AppLog.add(Type.ACCOUNT, &quot;Request to delete account was successful&quot;);
 768             AnalyticsTracker.track(
 769                     AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED,
 770                     AnalyticsTracker.CATEGORY_USER,
 771                     &quot;delete_account_request_success&quot;
 772             );
 773 
 774             activity.runOnUiThread(new Runnable() {
 775                 @Override
 776                 public void run() {
 777                     fragment.closeProgressDialogDeleteAccount();
 778                     fragment.showDeleteAccountConfirmationDialog();
 779                 }
 780             });
 781         }
 782 
 783         @Override
 784         public void onFailure() {
 785             final PreferencesFragment fragment = preferencesFragment.get();
 786             if (fragment == null) {
 787                 return;
 788             }
 789 
 790             FragmentActivity activity = fragment.getActivity();
 791             if (activity == null) {
 792                 return;
 793             }
 794 
 795             AppLog.add(Type.ACCOUNT, &quot;Failure while calling server to delete account&quot;);
 796             AnalyticsTracker.track(
 797                     AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED,
 798                     AnalyticsTracker.CATEGORY_USER,
 799                     &quot;delete_account_request_failure&quot;
 800             );
 801 
 802             activity.runOnUiThread(new Runnable() {
 803                 @Override
 804                 public void run() {
 805                     fragment.closeProgressDialogDeleteAccount();
 806                     fragment.showDialogDeleteAccountError();
 807                 }
 808             });
 809         }
 810     }
 811 }
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.Context;
   6 import android.content.DialogInterface;
   7 import android.content.Intent;
   8 import android.net.Uri;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.ParcelFileDescriptor;
  12 import android.widget.Toast;
  13 import androidx.appcompat.app.AlertDialog;
  14 import androidx.appcompat.view.ContextThemeWrapper;
  15 import androidx.core.app.ShareCompat;
  16 import androidx.core.content.ContextCompat;
  17 import androidx.fragment.app.FragmentActivity;
  18 import androidx.preference.ListPreference;
  19 import androidx.preference.Preference;
  20 import androidx.preference.PreferenceFragmentCompat;
  21 import androidx.preference.SwitchPreferenceCompat;
  22 import com.automattic.simplenote.analytics.AnalyticsTracker;
  23 import com.automattic.simplenote.authentication.SimplenoteAuthenticationActivity;
  24 import com.automattic.simplenote.models.Note;
  25 import com.automattic.simplenote.models.Preferences;
  26 import com.automattic.simplenote.utils.AccountNetworkUtils.DeleteAccountRequestHandler;
  27 import com.automattic.simplenote.utils.AccountNetworkUtils;
  28 import com.automattic.simplenote.utils.AppLog.Type;
  29 import com.automattic.simplenote.utils.AppLog;
  30 import com.automattic.simplenote.utils.AuthUtils;
  31 import com.automattic.simplenote.utils.BrowserUtils;
  32 import com.automattic.simplenote.utils.CrashUtils;
  33 import com.automattic.simplenote.utils.DialogUtils;
  34 import com.automattic.simplenote.utils.HtmlCompat;
  35 import com.automattic.simplenote.utils.PrefUtils;
  36 import com.automattic.simplenote.utils.SimplenoteProgressDialogFragment;
  37 import com.simperium.Simperium;
  38 import com.simperium.android.ProgressDialogFragment;
  39 import com.simperium.client.Bucket;
  40 import com.simperium.client.BucketObjectMissingException;
  41 import com.simperium.client.BucketObjectNameInvalid;
  42 import com.simperium.client.User;
  43 import java.io.FileOutputStream;
  44 import java.lang.ref.WeakReference;
  45 import java.util.Collections;
  46 import java.util.Comparator;
  47 import java.util.List;
  48 import org.json.JSONArray;
  49 import org.json.JSONObject;
  50 import static android.app.Activity.RESULT_OK;
  51 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  52 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING;
  53 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING_LABEL;
  54 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING;
  55 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING_LABEL;
  56 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING;
  57 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING_LABEL;
  58 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING;
  59 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING_LABEL;
  60 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING;
  61 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING_LABEL;
  62 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING;
  63 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING_LABEL;
  64 
  65 
  66 /**
  67  * A simple {@link Fragment} subclass.
  68  */
<abbr title="  69 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener , Simperium.OnUserCreatedListener {">  69 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener , ðŸ”µ</abbr>
  70     public static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  71 
  72     private static final int REQUEST_EXPORT_DATA = 9001;
  73 
  74     private static final int REQUEST_EXPORT_UNSYNCED = 9002;
  75 
  76     private static final int REQUEST_IMPORT_DATA = 9003;
  77 
  78     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  79 
  80     private SwitchPreferenceCompat mAnalyticsSwitch;
  81 
  82     private SimplenoteProgressDialogFragment mProgressDialogFragment;
  83 
  84     public PreferencesFragment() {
  85         // Required empty public constructor
  86     }
  87 
  88     @Override
  89     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  90         addPreferencesFromResource(R.xml.preferences);
  91     }
  92 
  93     @Override
  94     public void onActivityCreated(Bundle savedInstanceState) {
  95         super.onActivityCreated(savedInstanceState);
  96         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  97         Simplenote currentApp = ((Simplenote) (getActivity().getApplication()));
  98         Simperium simperium = currentApp.getSimperium();
  99         simperium.setUserStatusChangeListener(this);
 100         simperium.setOnUserCreatedListener(this);
 101         mPreferencesBucket = currentApp.getPreferencesBucket();
 102         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
 103         if (simperium.needsAuthorization()) {
 104             authenticatePreference.setTitle(R.string.log_in);
 105         } else {
 106             authenticatePreference.setTitle(R.string.log_out);
 107         }
 108         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 109             @Override
 110             public boolean onPreferenceClick(Preference preference) {
 111                 if (!isAdded()) {
 112                     return false;
 113                 }
 114                 Simplenote currentApp = ((Simplenote) (getActivity().getApplication()));
 115                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 116                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);"> 116                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
 117                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 118                 } else {
 119                     new LogOutTask(PreferencesFragment.this).execute();
 120                 }
 121                 return true;
 122             }
 123         });
 124         Preference deleteAppPreference = findPreference(&quot;pref_key_delete_account&quot;);
 125         deleteAppPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 126             @Override
 127             public boolean onPreferenceClick(Preference preference) {
<abbr title=" 128                 AnalyticsTracker.track(AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED, AnalyticsTracker.CATEGORY_USER, &quot;preferences_delete_account_button&quot;);"> 128                 AnalyticsTracker.track(AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED, AnalyticsTracðŸ”µ</abbr>
 129                 showDeleteAccountDialog();
 130                 return true;
 131             }
 132         });
<abbr title=" 133         findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 133         findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 134             @Override
 135             public boolean onPreferenceClick(Preference preference) {
 136                 try {
<abbr title=" 137                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;);"> 137                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;ðŸ”µ</abbr>
 138                 } catch (java.lang.Exception e) {
 139                     toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 140                 }
 141                 return true;
 142             }
 143         });
<abbr title=" 144         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 144         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
 145             @Override
 146             public boolean onPreferenceClick(Preference preference) {
 147                 try {
 148                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 149                 } catch (java.lang.Exception e) {
 150                     toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 151                 }
 152                 return true;
 153             }
 154         });
<abbr title=" 155         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 155         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
 156             @Override
 157             public boolean onPreferenceClick(Preference preference) {
 158                 startActivity(new Intent(getActivity(), AboutActivity.class));
 159                 return true;
 160             }
 161         });
<abbr title=" 162         findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 162         findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 163             @Override
 164             public boolean onPreferenceClick(Preference preference) {
<abbr title=" 165                 AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_IMPORT_NOTES, AnalyticsTracker.CATEGORY_NOTE, &quot;preferences_import_data_button&quot;);"> 165                 AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_IMPORT_NOTES, AnalyticsTracker.CATEðŸ”µ</abbr>
 166                 Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
 167                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 168                 intent.setType(&quot;*/*&quot;);
 169                 intent.putExtra(Intent.EXTRA_MIME_TYPES, new String[]{ &quot;text/*&quot;, &quot;application/json&quot; });
 170                 startActivityForResult(intent, REQUEST_IMPORT_DATA);
 171                 return true;
 172             }
 173         });
<abbr title=" 174         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 174         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 175             @Override
 176             public boolean onPreferenceClick(Preference preference) {
 177                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 178                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 179                 intent.setType(&quot;application/json&quot;);
 180                 intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 181                 startActivityForResult(intent, REQUEST_EXPORT_DATA);
 182                 return true;
 183             }
 184         });
 185         final ListPreference themePreference = findPreference(PrefUtils.PREF_THEME);
 186         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 187             @Override
 188             public boolean onPreferenceChange(Preference preference, Object newValue) {
 189                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 190                 return true;
 191             }
 192 
 193             private void updateTheme(Activity activity, int index) {
 194                 CharSequence[] entries = themePreference.getEntries();
 195                 themePreference.setSummary(entries[index]);
<abbr title=" 196                 AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED, AnalyticsTracker.CATEGORY_USER, &quot;theme_preference&quot;);"> 196                 AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED, AnalyticsTracker.CATðŸ”µ</abbr>
 197             }
 198         });
 199         final Preference stylePreference = findPreference(&quot;pref_key_style&quot;);
<abbr title=" 200         stylePreference.setSummary(PrefUtils.isPremium(requireContext()) ? PrefUtils.getStyleNameFromIndexSelected(requireContext()) : PrefUtils.getStyleNameDefault(requireContext()));"> 200         stylePreference.setSummary(PrefUtils.isPremium(requireContext()) ? PrefUtils.getStyleNameFromIndeðŸ”µ</abbr>
 201         stylePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 202             @Override
 203             public boolean onPreferenceClick(Preference preference) {
 204                 startActivity(new Intent(requireContext(), StyleActivity.class));
 205                 return true;
 206             }
 207         });
 208         final Preference membershipPreference = findPreference(&quot;pref_key_membership&quot;);
 209         membershipPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 210             @Override
 211             public boolean onPreferenceClick(Preference preference) {
 212                 ((PreferencesActivity) (requireActivity())).openBrowserForMembership(getView());
 213                 return true;
 214             }
 215         });
 216         if (PrefUtils.isPremium(requireContext())) {
 217             membershipPreference.setLayoutResource(R.layout.preference_default);
 218             membershipPreference.setSummary(R.string.membership_premium);
 219         } else {
 220             membershipPreference.setLayoutResource(R.layout.preference_button);
 221             membershipPreference.setSummary(R.string.membership_free);
 222         }
 223         final ListPreference sortPreference = findPreference(PrefUtils.PREF_SORT_ORDER);
 224         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 225             @Override
 226             public boolean onPreferenceChange(Preference preference, Object newValue) {
 227                 int index = Integer.parseInt(newValue.toString());
 228                 CharSequence[] entries = sortPreference.getEntries();
 229                 sortPreference.setSummary(entries[index]);
 230                 if (!sortPreference.getValue().equals(newValue)) {
 231                     switch (index) {
 232                         case ALPHABETICAL_ASCENDING :
 233                             trackSortOrder(ALPHABETICAL_ASCENDING_LABEL);
 234                             break;
 235                         case ALPHABETICAL_DESCENDING :
 236                             trackSortOrder(ALPHABETICAL_DESCENDING_LABEL);
 237                             break;
 238                         case DATE_CREATED_ASCENDING :
 239                             trackSortOrder(DATE_CREATED_ASCENDING_LABEL);
 240                             break;
 241                         case DATE_CREATED_DESCENDING :
 242                             trackSortOrder(DATE_CREATED_DESCENDING_LABEL);
 243                             break;
 244                         case DATE_MODIFIED_ASCENDING :
 245                             trackSortOrder(DATE_MODIFIED_ASCENDING_LABEL);
 246                             break;
 247                         case DATE_MODIFIED_DESCENDING :
 248                             trackSortOrder(DATE_MODIFIED_DESCENDING_LABEL);
 249                             break;
 250                     }
 251                 }
 252                 return true;
 253             }
 254         });
 255         SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);
 256         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 257             @Override
 258             public boolean onPreferenceChange(Preference preference, Object o) {
 259                 if (((SwitchPreferenceCompat) (preference)).isChecked()) {
<abbr title=" 260                     AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED, AnalyticsTracker.CATEGORY_USER, &quot;condensed_list_preference&quot;);"> 260                     AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED, AnalytiðŸ”µ</abbr>
 261                 }
 262                 return true;
 263             }
 264         });
 265         // Add the hyperlink to the analytics summary
 266         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
<abbr title=" 267         String formattedSummary = String.format(getString(R.string.share_analytics_summary), &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;, &quot;&lt;/a&gt;&quot;);"> 267         String formattedSummary = String.format(getString(R.string.share_analytics_summary), &quot;&lt;a href=\&quot;hðŸ”µ</abbr>
 268         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 269         mAnalyticsSwitch = findPreference(&quot;pref_key_analytics_switch&quot;);
 270         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 271             @Override
 272             public boolean onPreferenceChange(Preference preference, Object newValue) {
 273                 try {
 274                     boolean isChecked = ((boolean) (newValue));
 275                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 276                     prefs.setAnalyticsEnabled(isChecked);
 277                     prefs.save();
 278                 } catch (BucketObjectMissingException e) {
 279                     e.printStackTrace();
 280                 }
 281                 return true;
 282             }
 283         });
 284         updateAnalyticsSwitchState();
<abbr title=" 285         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 285         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 286             @Override
 287             public boolean onPreferenceClick(Preference preference) {
<abbr title=" 288                 startActivity(ShareCompat.IntentBuilder.from(requireActivity()).setText(AppLog.get()).setType(&quot;text/plain&quot;).createChooserIntent());"> 288                 startActivity(ShareCompat.IntentBuilder.from(requireActivity()).setText(AppLog.get()).setðŸ”µ</abbr>
 289                 return true;
 290             }
 291         });
 292     }
 293 
 294     private void showProgressDialogDeleteAccount() {
 295         FragmentActivity activity = getActivity();
 296         if (activity == null) {
 297             return;
 298         }
 299 
<abbr title=" 300         mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requesting_message));"> 300         mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requestðŸ”µ</abbr>
 301         mProgressDialogFragment.show(activity.getSupportFragmentManager(), ProgressDialogFragment.TAG);
 302     }
 303 
 304     private void closeProgressDialogDeleteAccount() {
 305         if (mProgressDialogFragment != null &amp;&amp; !mProgressDialogFragment.isHidden()) {
 306             mProgressDialogFragment.dismiss();
 307             mProgressDialogFragment = null;
 308         }
 309     }
 310 
 311     private void showDeleteAccountDialog() {
 312         Context context = getContext();
 313         if (context == null) {
 314             return;
 315         }
 316 
<abbr title=" 317         final DeleteAccountRequestHandler deleteAccountHandler = new DeleteAccountRequestHandlerImpl(this);"> 317         final DeleteAccountRequestHandler deleteAccountHandler = new DeleteAccountRequestHandlerImpl(thisðŸ”µ</abbr>
 318 
<abbr title=" 319         final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, R.style.Dialog))"> 319         final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, ðŸ”µ</abbr>
 320                 .setTitle(R.string.delete_account)
 321                 .setMessage(R.string.delete_account_message)
 322                 .setPositiveButton(R.string.delete_account, new DialogInterface.OnClickListener() {
 323                         @Override
 324                         public void onClick(DialogInterface dialogInterface, int i) {
 325                             FragmentActivity activity = getActivity();
 326                             if (activity == null) {
 327                                 return;
 328                             }
 329 
 330                             showProgressDialogDeleteAccount();
 331 
 332                             Simplenote currentApp = (Simplenote) activity.getApplication();
 333                             Simperium simperium = currentApp.getSimperium();
 334                             String userEmail = simperium.getUser().getEmail();
 335                             String userToken = simperium.getUser().getAccessToken();
 336 
 337                             // makeDeleteAccountRequest can throw an exception when it cannot build
 338                             // the JSON object. In those cases, we show the error dialog since
 339                             // it can be related to memory constraints or something else that is
 340                             // just a transient fault
 341                             try {
 342                                 AppLog.add(Type.ACCOUNT, &quot;Making request to delete account&quot;);
 343 
 344                                 AccountNetworkUtils.makeDeleteAccountRequest(
 345                                         userEmail,
 346                                         userToken,
 347                                         deleteAccountHandler);
 348                             } catch (IllegalArgumentException exception) {
 349                                 AppLog.add(Type.ACCOUNT, &quot;Error trying to make request &quot; +
 350                                         &quot;to delete account. Error: &quot; + exception.getMessage());
 351 
 352                                 showDialogDeleteAccountError();
 353                             }
 354                         }
 355                     }
 356                 )
 357                 .setNegativeButton(R.string.cancel, null)
 358                 .create();
 359 
 360         dialogDeleteAccount.setOnShowListener(new DialogInterface.OnShowListener() {
 361             @Override
 362             public void onShow(DialogInterface dialog) {
 363                 FragmentActivity activity = getActivity();
 364                 if (activity == null) {
 365                     return;
 366                 }
 367 
 368                 int colorRed = ContextCompat.getColor(activity, R.color.text_button_red);
 369                 dialogDeleteAccount
 370                         .getButton(AlertDialog.BUTTON_POSITIVE)
 371                         .setTextColor(colorRed);
 372             }
 373         });
 374         dialogDeleteAccount.show();
 375     }
 376 
 377     private void showDialogDeleteAccountError() {
 378         Context context = getContext();
 379         if (context == null) {
 380             return;
 381         }
 382 
 383         DialogUtils.showDialogWithEmail(
 384                 context,
 385                 getString(R.string.error_ocurred_message)
 386         );
 387     }
 388 
 389     private void showDeleteAccountConfirmationDialog() {
 390         FragmentActivity activity = getActivity();
 391         if (activity == null) {
 392             return;
 393         }
 394 
 395         Simplenote currentApp = (Simplenote) activity.getApplication();
 396         Simperium simperium = currentApp.getSimperium();
 397         String userEmail = simperium.getUser().getEmail();
 398 
 399         AlertDialog dialogDeleteAccountConfirmation = new AlertDialog.Builder(
 400                 new ContextThemeWrapper(activity, R.style.Dialog))
 401                 .setTitle(R.string.request_received)
 402                 .setMessage(getString(R.string.account_deletion_message, userEmail))
 403                 .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {
 404                             @Override
 405                             public void onClick(DialogInterface dialogInterface, int i) {
 406                                 dialogInterface.dismiss();
 407                             }
 408                         }
 409                 )
 410                 .create();
 411 
 412         dialogDeleteAccountConfirmation.show();
 413     }
 414 
 415     @Override
 416     public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 417         if (resultCode != RESULT_OK || resultData == null) {
 418             return;
 419         }
 420 
 421         if (resultData.getData() == null) {
 422             toast(R.string.export_message_failure);
 423             return;
 424         }
 425 
 426         switch (requestCode) {
 427             case REQUEST_EXPORT_DATA:
 428                 exportData(resultData.getData(), false);
 429                 break;
 430             case REQUEST_EXPORT_UNSYNCED:
 431                 exportData(resultData.getData(), true);
 432                 break;
 433             case REQUEST_IMPORT_DATA:
 434                 importData(resultData.getData());
 435                 break;
 436         }
 437     }
 438 
 439     private boolean hasUnsyncedNotes() {
 440         Simplenote application = (Simplenote) getActivity().getApplication();
 441         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 442         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 443         while (notesCursor.moveToNext()) {
 444             Note note = notesCursor.getObject();
 445             if (note.isNew() || note.isModified()) {
 446                 return true;
 447             }
 448         }
 449 
 450         return false;
 451     }
 452 
 453     private void logOut() {
 454         AppLog.add(Type.ACTION, &quot;Tapped logout button (PreferencesFragment)&quot;);
 455         AnalyticsTracker.track(
 456                 AnalyticsTracker.Stat.USER_SIGNED_OUT,
 457                 AnalyticsTracker.CATEGORY_USER,
 458                 &quot;preferences_sign_out_button&quot;
 459         );
 460 
 461         AuthUtils.logOut((Simplenote) requireActivity().getApplication());
 462 
 463         getActivity().finish();
 464     }
 465 
 466     @Override
 467     public void onUserStatusChange(User.Status status) {
 468         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 469             // User signed in
 470             getActivity().runOnUiThread(new Runnable() {
 471                 public void run() {
 472                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 473                     authenticatePreference.setTitle(R.string.log_out);
 474                 }
 475             });
 476 
 477             Simplenote app = (Simplenote) getActivity().getApplication();
 478             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 479             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 480 
 481             AnalyticsTracker.track(
 482                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 483                     AnalyticsTracker.CATEGORY_USER,
 484                     &quot;signed_in_from_preferences_activity&quot;
 485             );
 486         }
 487     }
 488 
 489     @Override
 490     public void onUserCreated(User user) {
 491         AnalyticsTracker.track(
 492                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 493                 AnalyticsTracker.CATEGORY_USER,
 494                 &quot;account_created_from_preferences_activity&quot;
 495         );
 496     }
 497 
 498     private void exportData(Uri uri, boolean isUnsyncedNotes) {
 499         Simplenote currentApp = (Simplenote) requireActivity().getApplication();
 500         Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 501         JSONObject account = new JSONObject();
 502         Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 503 
 504         try {
 505             JSONArray activeNotes = new JSONArray();
 506             JSONArray trashedNotes = new JSONArray();
 507             Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 508                 @Override
 509                 public int compare(String text1, String text2) {
 510                     return text1.compareToIgnoreCase(text2);
 511                 }
 512             };
 513 
 514             while (cursor.moveToNext()) {
 515                 Note note = cursor.getObject();
 516 
 517                 if (isUnsyncedNotes &amp;&amp; !note.isNew() &amp;&amp; !note.isModified()) {
 518                     continue;
 519                 }
 520 
 521                 JSONObject noteJson = new JSONObject();
 522 
 523                 noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 524                 noteJson.put(&quot;content&quot;, note.getContent());
 525                 noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 526                 noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 527 
 528                 if (note.isPinned()) {
 529                     noteJson.put(&quot;pinned&quot;, note.isPinned());
 530                 }
 531 
 532                 if (note.isMarkdownEnabled()) {
 533                     noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 534                 }
 535 
 536                 if (note.getTags().size() &gt; 0) {
 537                     List&lt;String&gt; tags = note.getTags();
 538                     Collections.sort(tags, comparator);
 539                     noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 540                 }
 541 
 542                 if (!note.getPublishedUrl().isEmpty()) {
 543                     noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 544                 }
 545 
 546                 if (note.isDeleted()) {
 547                     trashedNotes.put(noteJson);
 548                 } else {
 549                     activeNotes.put(noteJson);
 550                 }
 551             }
 552 
 553             account.put(&quot;activeNotes&quot;, activeNotes);
 554             account.put(&quot;trashedNotes&quot;, trashedNotes);
 555 
<abbr title=" 556             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 556             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDesðŸ”µ</abbr>
 557 
 558             if (parcelFileDescriptor != null) {
<abbr title=" 559                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 559                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescðŸ”µ</abbr>
 560                 fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;,&quot;/&quot;).getBytes());
 561                 parcelFileDescriptor.close();
 562                 toast(R.string.export_message_success);
 563             } else {
 564                 toast(R.string.export_message_failure);
 565             }
 566         } catch (Exception e) {
 567             toast(R.string.export_message_failure);
 568         }
 569     }
 570 
 571     private void importData(Uri uri) {
 572         try {
 573             AppLog.add(Type.IMPORT, (&quot;Importing notes from &quot; + uri) + &quot;.&quot;);
 574             FragmentActivity activity = getActivity();
 575             if (activity == null) {
 576                 AppLog.add(Type.IMPORT, &quot;Could not import notes since activity is null&quot;);
 577                 return;
 578             }
 579             Importer.fromUri(activity, uri);
 580             toast(R.string.import_message_success);
 581             AppLog.add(Type.IMPORT, &quot;Notes imported correctly!&quot;);
 582         } catch (Importer e) {
 583             switch (e.getReason()) {
 584                 case FileError :
<abbr title=" 585                     AppLog.add(Type.IMPORT, &quot;File error while importing note. Exception: &quot; + e.getMessage());"> 585                     AppLog.add(Type.IMPORT, &quot;File error while importing note. Exception: &quot; + e.getMessageðŸ”µ</abbr>
 586                     toast(R.string.import_error_file);
 587                     break;
 588                 case ParseError :
<abbr title=" 589                     AppLog.add(Type.IMPORT, &quot;Parse error while importing note. Exception: &quot; + e.getMessage());"> 589                     AppLog.add(Type.IMPORT, &quot;Parse error while importing note. Exception: &quot; + e.getMessagðŸ”µ</abbr>
 590                     toast(R.string.import_error_parse);
 591                     break;
 592                 case UnknownExportType :
<abbr title=" 593                     AppLog.add(Type.IMPORT, &quot;Unknown error while importing note. Exception: &quot; + e.getMessage());"> 593                     AppLog.add(Type.IMPORT, &quot;Unknown error while importing note. Exception: &quot; + e.getMessðŸ”µ</abbr>
 594                     toast(R.string.import_unknown);
 595                     break;
 596             }
 597         }
 598     }
 599 
 600     private void trackSortOrder(String label) {
 601         AnalyticsTracker.track(
 602             AnalyticsTracker.Stat.SETTINGS_SEARCH_SORT_MODE,
 603             AnalyticsTracker.CATEGORY_SETTING,
 604             label
 605         );
 606     }
 607 
 608     private void updateAnalyticsSwitchState() {
 609         try {
 610             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 611             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 612         } catch (BucketObjectMissingException e) {
 613             // The preferences object doesn&#x27;t exist for this user yet, create it
 614             try {
 615                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 616                 prefs.setAnalyticsEnabled(true);
 617                 prefs.save();
 618             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 619                 bucketObjectNameInvalid.printStackTrace();
 620             }
 621         }
 622     }
 623 
 624     private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 625         private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 626 
 627         LogOutTask(PreferencesFragment fragment) {
 628             mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 629         }
 630 
 631         @Override
 632         protected Boolean doInBackground(Void... voids) {
 633             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 634             return (fragment == null) || fragment.hasUnsyncedNotes();
 635         }
 636 
 637         @Override
 638         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 639             final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 640             if (fragment == null) {
 641                 return;
 642             }
 643             // Safety first! Check if any notes are unsynced and warn the user if so.
 644             if (hasUnsyncedNotes) {
<abbr title=" 645                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog)).setTitle(R.string.unsynced_notes).setMessage(R.string.unsynced_notes_message).setPositiveButton(R.string.log_out_anyway, new DialogInterface.OnClickListener() {"> 645                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 646                     @Override
 647                     public void onClick(DialogInterface dialogInterface, int i) {
 648                         fragment.logOut();
 649                     }
<abbr title=" 650                 }).setNeutralButton(R.string.export_unsynced_notes, new DialogInterface.OnClickListener() {"> 650                 }).setNeutralButton(R.string.export_unsynced_notes, new DialogInterface.OnClickListener()ðŸ”µ</abbr>
 651                     @Override
 652                     public void onClick(DialogInterface dialogInterface, int i) {
 653                         Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 654                         intent.addCategory(Intent.CATEGORY_OPENABLE);
 655                         intent.setType(&quot;application/json&quot;);
 656                         intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));
 657                         fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 658                     }
 659                 }).setNegativeButton(R.string.cancel, null).show();
 660             } else {
 661                 fragment.logOut();
 662             }
 663         }
 664     }
 665 
 666     private void toast(int stringId) {
 667         toast(stringId, Toast.LENGTH_SHORT);
 668     }
 669 
 670     private void toast(int stringId, int length) {
 671         Toast.makeText(requireContext(), getString(stringId), length).show();
 672     }
 673 
 674     static class DeleteAccountRequestHandlerImpl implements DeleteAccountRequestHandler {
 675         final WeakReference&lt;PreferencesFragment&gt; preferencesFragment;
 676 
 677         DeleteAccountRequestHandlerImpl(PreferencesFragment fragment) {
 678             this.preferencesFragment = new WeakReference&lt;&gt;(fragment);
 679         }
 680 
 681         @Override
 682         public void onSuccess() {
 683             final PreferencesFragment fragment = preferencesFragment.get();
 684             if (fragment == null) {
 685                 return;
 686             }
 687             FragmentActivity activity = fragment.getActivity();
 688             if (activity == null) {
 689                 return;
 690             }
 691             AppLog.add(Type.ACCOUNT, &quot;Request to delete account was successful&quot;);
<abbr title=" 692             AnalyticsTracker.track(AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED, AnalyticsTracker.CATEGORY_USER, &quot;delete_account_request_success&quot;);"> 692             AnalyticsTracker.track(AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED, AnalyticsTracker.ðŸ”µ</abbr>
 693             activity.runOnUiThread(new Runnable() {
 694                 @Override
 695                 public void run() {
 696                     fragment.closeProgressDialogDeleteAccount();
 697                     fragment.showDeleteAccountConfirmationDialog();
 698                 }
 699             });
 700         }
 701 
 702         @Override
 703         public void onFailure() {
 704             final PreferencesFragment fragment = preferencesFragment.get();
 705             if (fragment == null) {
 706                 return;
 707             }
 708             FragmentActivity activity = fragment.getActivity();
 709             if (activity == null) {
 710                 return;
 711             }
 712             AppLog.add(Type.ACCOUNT, &quot;Failure while calling server to delete account&quot;);
<abbr title=" 713             AnalyticsTracker.track(AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED, AnalyticsTracker.CATEGORY_USER, &quot;delete_account_request_failure&quot;);"> 713             AnalyticsTracker.track(AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED, AnalyticsTracker.ðŸ”µ</abbr>
 714             activity.runOnUiThread(new Runnable() {
 715                 @Override
 716                 public void run() {
 717                     fragment.closeProgressDialogDeleteAccount();
 718                     fragment.showDialogDeleteAccountError();
 719                 }
 720             });
 721         }
 722     }
 723 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.Fragment;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 +import android.content.Context;</span>
   6  import android.content.DialogInterface;
   7  import android.content.Intent;
   8  import android.net.Uri;
   9  import android.os.AsyncTask;
  10  import android.os.Bundle;
  11  import android.os.ParcelFileDescriptor;
  12  import android.widget.Toast;
  13  
  14  import androidx.appcompat.app.AlertDialog;
  15  import androidx.appcompat.view.ContextThemeWrapper;
  16  import androidx.core.app.ShareCompat;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 +import androidx.core.content.ContextCompat;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +import androidx.fragment.app.FragmentActivity;</span>
  19  import androidx.preference.ListPreference;
  20  import androidx.preference.Preference;
  21  import androidx.preference.PreferenceFragmentCompat;
  22  import androidx.preference.SwitchPreferenceCompat;
  23  
  24  import com.automattic.simplenote.analytics.AnalyticsTracker;
  25  import com.automattic.simplenote.authentication.SimplenoteAuthenticationActivity;
  26  import com.automattic.simplenote.models.Note;
  27  import com.automattic.simplenote.models.Preferences;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import com.automattic.simplenote.utils.AccountNetworkUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import com.automattic.simplenote.utils.AccountNetworkUtils.DeleteAccountRequestHandler;</span>
  30  import com.automattic.simplenote.utils.AppLog;
  31  import com.automattic.simplenote.utils.AppLog.Type;
  32  import com.automattic.simplenote.utils.AuthUtils;
  33  import com.automattic.simplenote.utils.BrowserUtils;
  34  import com.automattic.simplenote.utils.CrashUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import com.automattic.simplenote.utils.DialogUtils;</span>
  36  import com.automattic.simplenote.utils.HtmlCompat;
  37  import com.automattic.simplenote.utils.PrefUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import com.automattic.simplenote.utils.SimplenoteProgressDialogFragment;</span>
  39  import com.simperium.Simperium;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import com.simperium.android.ProgressDialogFragment;</span>
  41  import com.simperium.client.Bucket;
  42  import com.simperium.client.BucketObjectMissingException;
  43  import com.simperium.client.BucketObjectNameInvalid;
  44  import com.simperium.client.User;
  45  
  46  import org.json.JSONArray;
  47  import org.json.JSONObject;
  48  
  49  import java.io.FileOutputStream;
  50  import java.lang.ref.WeakReference;
  51  import java.util.Collections;
  52  import java.util.Comparator;
  53  import java.util.List;
  54  
  55  import static android.app.Activity.RESULT_OK;
  56  import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  57  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING;
  58  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING_LABEL;
  59  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING;
  60  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING_LABEL;
  61  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING;
  62  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING_LABEL;
  63  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING;
  64  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING_LABEL;
  65  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING;
  66  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING_LABEL;
  67  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING;
  68  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING_LABEL;
  69  
  70  /**
  71   * A simple {@link Fragment} subclass.
  72   */
<abbr title="  73  public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.OnUserCreatedListener {">  73  public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.ðŸ”µ</abbr>
  74      public static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  75  
  76      private static final int REQUEST_EXPORT_DATA = 9001;
  77      private static final int REQUEST_EXPORT_UNSYNCED = 9002;
  78      private static final int REQUEST_IMPORT_DATA = 9003;
  79  
  80      private Bucket&lt;Preferences&gt; mPreferencesBucket;
  81      private SwitchPreferenceCompat mAnalyticsSwitch;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +    private SimplenoteProgressDialogFragment mProgressDialogFragment;</span>
  83  
  84      public PreferencesFragment() {
  85          // Required empty public constructor
  86      }
  87  
  88      @Override
  89      public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  90          addPreferencesFromResource(R.xml.preferences);
  91      }
  92  
  93      @Override
  94      public void onActivityCreated(Bundle savedInstanceState) {
  95          super.onActivityCreated(savedInstanceState);
  96  
  97          Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  98          Simplenote currentApp = (Simplenote) getActivity().getApplication();
  99          Simperium simperium = currentApp.getSimperium();
 100          simperium.setUserStatusChangeListener(this);
 101          simperium.setOnUserCreatedListener(this);
 102          mPreferencesBucket = currentApp.getPreferencesBucket();
 103  
 104          authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
 105          if (simperium.needsAuthorization()) {
 106              authenticatePreference.setTitle(R.string.log_in);
 107          } else {
 108              authenticatePreference.setTitle(R.string.log_out);
 109          }
 110  
 111          authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 112              @Override
 113              public boolean onPreferenceClick(Preference preference) {
 114                  if (!isAdded()) {
 115                      return false;
 116                  }
 117  
 118                  Simplenote currentApp = (Simplenote) getActivity().getApplication();
 119                  if (currentApp.getSimperium().needsAuthorization()) {
 120                      Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);
 121                      startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 122                  } else {
 123                      new LogOutTask(PreferencesFragment.this).execute();
 124                  }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        Preference deleteAppPreference = findPreference(&quot;pref_key_delete_account&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +        deleteAppPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +            public boolean onPreferenceClick(Preference preference) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +                AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +                        AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +                        AnalyticsTracker.CATEGORY_USER,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +                        &quot;preferences_delete_account_button&quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +                );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +                showDeleteAccountDialog();</span>
 140                  return true;
 141              }
 142          });
 143  
 144          findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 145              @Override
 146              public boolean onPreferenceClick(Preference preference) {
 147                  try {
 148                      BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;);
 149                  } catch (Exception e) {
 150                      toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 151                  }
 152                  return true;
 153              }
 154          });
 155  
<abbr title=" 156          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 156          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener()ðŸ”µ</abbr>
 157              @Override
 158              public boolean onPreferenceClick(Preference preference) {
 159                  try {
 160                      BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 161                  } catch (Exception e) {
 162                      toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 163                  }
 164                  return true;
 165              }
 166          });
 167  
 168          findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 169              @Override
 170              public boolean onPreferenceClick(Preference preference) {
 171                  startActivity(new Intent(getActivity(), AboutActivity.class));
 172                  return true;
 173              }
 174          });
 175  
<abbr title=" 176          findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 176          findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() ðŸ”µ</abbr>
 177              @Override
 178              public boolean onPreferenceClick(Preference preference) {






 179                  Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
 180                  intent.addCategory(Intent.CATEGORY_OPENABLE);
 181                  intent.setType(&quot;*/*&quot;);
 182                  intent.putExtra(Intent.EXTRA_MIME_TYPES, new String[]{&quot;text/*&quot;, &quot;application/json&quot;});
 183                  startActivityForResult(intent, REQUEST_IMPORT_DATA);
 184                  return true;
 185              }
 186          });
 187  
<abbr title=" 188          findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 188          findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() ðŸ”µ</abbr>
 189              @Override
 190              public boolean onPreferenceClick(Preference preference) {
 191                  Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 192                  intent.addCategory(Intent.CATEGORY_OPENABLE);
 193                  intent.setType(&quot;application/json&quot;);
 194                  intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 195                  startActivityForResult(intent, REQUEST_EXPORT_DATA);
 196                  return true;
 197              }
 198          });
 199  
 200          final ListPreference themePreference = findPreference(PrefUtils.PREF_THEME);
 201          themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 202              @Override
 203              public boolean onPreferenceChange(Preference preference, Object newValue) {
 204                  updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 205                  return true;
 206              }
 207  
 208              private void updateTheme(Activity activity, int index) {
 209                  CharSequence[] entries = themePreference.getEntries();
 210                  themePreference.setSummary(entries[index]);
 211  
 212                  AnalyticsTracker.track(
 213                          AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 214                          AnalyticsTracker.CATEGORY_USER,
 215                          &quot;theme_preference&quot;
 216                  );
 217              }
 218          });
 219  
 220          final Preference stylePreference = findPreference(&quot;pref_key_style&quot;);
 221          stylePreference.setSummary(
 222              PrefUtils.isPremium(requireContext()) ?
 223                  PrefUtils.getStyleNameFromIndexSelected(requireContext()) :
 224                  PrefUtils.getStyleNameDefault(requireContext())
 225          );
 226          stylePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 227              @Override
 228              public boolean onPreferenceClick(Preference preference) {
 229                  startActivity(new Intent(requireContext(), StyleActivity.class));
 230                  return true;
 231              }
 232          });
 233  
 234          final Preference membershipPreference = findPreference(&quot;pref_key_membership&quot;);
 235          membershipPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 236              @Override
 237              public boolean onPreferenceClick(Preference preference) {
 238                  ((PreferencesActivity) requireActivity()).openBrowserForMembership(getView());
 239                  return true;
 240              }
 241          });
 242  
 243          if (PrefUtils.isPremium(requireContext())) {
 244              membershipPreference.setLayoutResource(R.layout.preference_default);
 245              membershipPreference.setSummary(R.string.membership_premium);
 246          } else {
 247              membershipPreference.setLayoutResource(R.layout.preference_button);
 248              membershipPreference.setSummary(R.string.membership_free);
 249          }
 250  
 251          final ListPreference sortPreference = findPreference(PrefUtils.PREF_SORT_ORDER);
 252          sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 253              @Override
 254              public boolean onPreferenceChange(Preference preference, Object newValue) {
 255                  int index = Integer.parseInt(newValue.toString());
 256                  CharSequence[] entries = sortPreference.getEntries();
 257                  sortPreference.setSummary(entries[index]);
 258  
 259                  if (!sortPreference.getValue().equals(newValue)) {
 260                      switch (index) {
 261                          case ALPHABETICAL_ASCENDING:
 262                              trackSortOrder(ALPHABETICAL_ASCENDING_LABEL);
 263                              break;
 264                          case ALPHABETICAL_DESCENDING:
 265                              trackSortOrder(ALPHABETICAL_DESCENDING_LABEL);
 266                              break;
 267                          case DATE_CREATED_ASCENDING:
 268                              trackSortOrder(DATE_CREATED_ASCENDING_LABEL);
 269                              break;
 270                          case DATE_CREATED_DESCENDING:
 271                              trackSortOrder(DATE_CREATED_DESCENDING_LABEL);
 272                              break;
 273                          case DATE_MODIFIED_ASCENDING:
 274                              trackSortOrder(DATE_MODIFIED_ASCENDING_LABEL);
 275                              break;
 276                          case DATE_MODIFIED_DESCENDING:
 277                              trackSortOrder(DATE_MODIFIED_DESCENDING_LABEL);
 278                              break;
 279                      }
 280                  }
 281  
 282                  return true;
 283              }
 284          });
 285  
 286          SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);
 287          switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 288              @Override
 289              public boolean onPreferenceChange(Preference preference, Object o) {
 290                  if (((SwitchPreferenceCompat) preference).isChecked()) {
 291                      AnalyticsTracker.track(
 292                              AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 293                              AnalyticsTracker.CATEGORY_USER,
 294                              &quot;condensed_list_preference&quot;
 295                      );
 296                  }
 297  
 298                  return true;
 299              }
 300          });
 301  
 302          // Add the hyperlink to the analytics summary
 303          Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 304          String formattedSummary = String.format(
 305                  getString(R.string.share_analytics_summary),
 306                  &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 307                  &quot;&lt;/a&gt;&quot;
 308          );
 309          analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 310  
 311          mAnalyticsSwitch = findPreference(&quot;pref_key_analytics_switch&quot;);
 312          mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 313              @Override
 314              public boolean onPreferenceChange(Preference preference, Object newValue) {
 315                  try {
 316                      boolean isChecked = (boolean)newValue;
 317                      Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 318                      prefs.setAnalyticsEnabled(isChecked);
 319                      prefs.save();
 320                  } catch (BucketObjectMissingException e) {
 321                      e.printStackTrace();
 322                  }
 323  
 324                  return true;
 325              }
 326          });
 327  
 328          updateAnalyticsSwitchState();
 329  
 330          findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 331              @Override
 332              public boolean onPreferenceClick(Preference preference) {
 333                  startActivity(
 334                      ShareCompat.IntentBuilder.from(requireActivity())
 335                          .setText(AppLog.get())
 336                          .setType(&quot;text/plain&quot;)
 337                          .createChooserIntent()
 338                  );
 339                  return true;
 340              }
 341          });
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +    private void showProgressDialogDeleteAccount() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +        FragmentActivity activity = getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +        if (activity == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 350 +        mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requesting_message));"> 350 +        mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requesting_messaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +        mProgressDialogFragment.show(activity.getSupportFragmentManager(), ProgressDialogFragment.TAG);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +    private void closeProgressDialogDeleteAccount() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +        if (mProgressDialogFragment != null &amp;&amp; !mProgressDialogFragment.isHidden()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +            mProgressDialogFragment.dismiss();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +            mProgressDialogFragment = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +    private void showDeleteAccountDialog() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +        Context context = getContext();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +        if (context == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 367 +        final DeleteAccountRequestHandler deleteAccountHandler = new DeleteAccountRequestHandlerImpl(this);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 368 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 369 +        final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, R.style.Dialog))"> 369 +        final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, R.style.DðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 370 +                .setTitle(R.string.delete_account)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 371 +                .setMessage(R.string.delete_account_message)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 372 +                .setPositiveButton(R.string.delete_account, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 373 +                        @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 374 +                        public void onClick(DialogInterface dialogInterface, int i) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 375 +                            FragmentActivity activity = getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 376 +                            if (activity == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +                                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 378 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 380 +                            showProgressDialogDeleteAccount();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 381 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 382 +                            Simplenote currentApp = (Simplenote) activity.getApplication();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +                            Simperium simperium = currentApp.getSimperium();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 384 +                            String userEmail = simperium.getUser().getEmail();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +                            String userToken = simperium.getUser().getAccessToken();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +                            // makeDeleteAccountRequest can throw an exception when it cannot build</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +                            // the JSON object. In those cases, we show the error dialog since</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +                            // it can be related to memory constraints or something else that is</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +                            // just a transient fault</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +                            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +                                AppLog.add(Type.ACCOUNT, &quot;Making request to delete account&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +                                AccountNetworkUtils.makeDeleteAccountRequest(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 395 +                                        userEmail,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 396 +                                        userToken,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 397 +                                        deleteAccountHandler);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 398 +                            } catch (IllegalArgumentException exception) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 399 +                                AppLog.add(Type.ACCOUNT, &quot;Error trying to make request &quot; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 400 +                                        &quot;to delete account. Error: &quot; + exception.getMessage());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 401 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 402 +                                showDialogDeleteAccountError();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 403 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 404 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 405 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 406 +                )</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 407 +                .setNegativeButton(R.string.cancel, null)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 408 +                .create();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 409 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 410 +        dialogDeleteAccount.setOnShowListener(new DialogInterface.OnShowListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 411 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 412 +            public void onShow(DialogInterface dialog) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 413 +                FragmentActivity activity = getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 414 +                if (activity == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 415 +                    return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 416 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 417 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +                int colorRed = ContextCompat.getColor(activity, R.color.text_button_red);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 419 +                dialogDeleteAccount</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 420 +                        .getButton(AlertDialog.BUTTON_POSITIVE)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 421 +                        .setTextColor(colorRed);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 422 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 423 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 424 +        dialogDeleteAccount.show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 425 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 426 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 427 +    private void showDialogDeleteAccountError() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 428 +        Context context = getContext();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 429 +        if (context == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 430 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 431 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 432 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 433 +        DialogUtils.showDialogWithEmail(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 434 +                context,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 435 +                getString(R.string.error_ocurred_message)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 436 +        );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 437 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 438 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 439 +    private void showDeleteAccountConfirmationDialog() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 440 +        FragmentActivity activity = getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 441 +        if (activity == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 442 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 443 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 444 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 445 +        Simplenote currentApp = (Simplenote) activity.getApplication();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 446 +        Simperium simperium = currentApp.getSimperium();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 447 +        String userEmail = simperium.getUser().getEmail();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 448 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 449 +        AlertDialog dialogDeleteAccountConfirmation = new AlertDialog.Builder(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 450 +                new ContextThemeWrapper(activity, R.style.Dialog))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 451 +                .setTitle(R.string.request_received)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 452 +                .setMessage(getString(R.string.account_deletion_message, userEmail))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 453 +                .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 454 +                            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 455 +                            public void onClick(DialogInterface dialogInterface, int i) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 456 +                                dialogInterface.dismiss();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 457 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 458 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 459 +                )</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 460 +                .create();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 461 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 462 +        dialogDeleteAccountConfirmation.show();</span>
 463      }
 464  
 465      @Override
 466      public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 467          if (resultCode != RESULT_OK || resultData == null) {
 468              return;
 469          }
 470  
 471          if (resultData.getData() == null) {
 472              toast(R.string.export_message_failure);
 473              return;
 474          }
 475  
 476          switch (requestCode) {
 477              case REQUEST_EXPORT_DATA:
 478                  exportData(resultData.getData(), false);
 479                  break;
 480              case REQUEST_EXPORT_UNSYNCED:
 481                  exportData(resultData.getData(), true);
 482                  break;
 483              case REQUEST_IMPORT_DATA:
 484                  importData(resultData.getData());
 485                  break;
 486          }
 487      }
 488  
 489      private boolean hasUnsyncedNotes() {
 490          Simplenote application = (Simplenote) getActivity().getApplication();
 491          Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 492          Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 493          while (notesCursor.moveToNext()) {
 494              Note note = notesCursor.getObject();
 495              if (note.isNew() || note.isModified()) {
 496                  return true;
 497              }
 498          }
 499  
 500          return false;
 501      }
 502  
 503      private void logOut() {
 504          AppLog.add(Type.ACTION, &quot;Tapped logout button (PreferencesFragment)&quot;);
 505          AnalyticsTracker.track(
 506                  AnalyticsTracker.Stat.USER_SIGNED_OUT,
 507                  AnalyticsTracker.CATEGORY_USER,
 508                  &quot;preferences_sign_out_button&quot;
 509          );
 510  
 511          AuthUtils.logOut((Simplenote) requireActivity().getApplication());
 512  
 513          getActivity().finish();
 514      }
 515  
 516      @Override
 517      public void onUserStatusChange(User.Status status) {
 518          if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 519              // User signed in
 520              getActivity().runOnUiThread(new Runnable() {
 521                  public void run() {
 522                      Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 523                      authenticatePreference.setTitle(R.string.log_out);
 524                  }
 525              });
 526  
 527              Simplenote app = (Simplenote) getActivity().getApplication();
 528              AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 529              CrashUtils.setCurrentUser(app.getSimperium().getUser());
 530  
 531              AnalyticsTracker.track(
 532                      AnalyticsTracker.Stat.USER_SIGNED_IN,
 533                      AnalyticsTracker.CATEGORY_USER,
 534                      &quot;signed_in_from_preferences_activity&quot;
 535              );
 536          }
 537      }
 538  
 539      @Override
 540      public void onUserCreated(User user) {
 541          AnalyticsTracker.track(
 542                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 543                  AnalyticsTracker.CATEGORY_USER,
 544                  &quot;account_created_from_preferences_activity&quot;
 545          );
 546      }
 547  
 548      private void exportData(Uri uri, boolean isUnsyncedNotes) {
 549          Simplenote currentApp = (Simplenote) requireActivity().getApplication();
 550          Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 551          JSONObject account = new JSONObject();
 552          Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 553  
 554          try {
 555              JSONArray activeNotes = new JSONArray();
 556              JSONArray trashedNotes = new JSONArray();
 557              Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 558                  @Override
 559                  public int compare(String text1, String text2) {
 560                      return text1.compareToIgnoreCase(text2);
 561                  }
 562              };
 563  
 564              while (cursor.moveToNext()) {
 565                  Note note = cursor.getObject();
 566  
 567                  if (isUnsyncedNotes &amp;&amp; !note.isNew() &amp;&amp; !note.isModified()) {
 568                      continue;
 569                  }
 570  
 571                  JSONObject noteJson = new JSONObject();
 572  
 573                  noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 574                  noteJson.put(&quot;content&quot;, note.getContent());
 575                  noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 576                  noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 577  
 578                  if (note.isPinned()) {
 579                      noteJson.put(&quot;pinned&quot;, note.isPinned());
 580                  }
 581  
 582                  if (note.isMarkdownEnabled()) {
 583                      noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 584                  }
 585  
 586                  if (note.getTags().size() &gt; 0) {
 587                      List&lt;String&gt; tags = note.getTags();
 588                      Collections.sort(tags, comparator);
 589                      noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 590                  }
 591  
 592                  if (!note.getPublishedUrl().isEmpty()) {
 593                      noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 594                  }
 595  
 596                  if (note.isDeleted()) {
 597                      trashedNotes.put(noteJson);
 598                  } else {
 599                      activeNotes.put(noteJson);
 600                  }
 601              }
 602  
 603              account.put(&quot;activeNotes&quot;, activeNotes);
 604              account.put(&quot;trashedNotes&quot;, trashedNotes);
 605  
<abbr title=" 606              ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 606              ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uðŸ”µ</abbr>
 607  
 608              if (parcelFileDescriptor != null) {
<abbr title=" 609                  FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 609                  FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor())ðŸ”µ</abbr>
 610                  fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;,&quot;/&quot;).getBytes());
 611                  parcelFileDescriptor.close();
 612                  toast(R.string.export_message_success);
 613              } else {
 614                  toast(R.string.export_message_failure);
 615              }
 616          } catch (Exception e) {
 617              toast(R.string.export_message_failure);
 618          }
 619      }
 620  
 621      private void importData(Uri uri) {
 622          try {
 623              Importer.fromUri(this, uri);









 624              toast(R.string.import_message_success);


 625          } catch (Importer.ImportException e) {
 626              switch (e.getReason()) {
 627                  case FileError:


 628                      toast(R.string.import_error_file);
 629                      break;
 630                  case ParseError:


 631                      toast(R.string.import_error_parse);
 632                      break;
 633                  case UnknownExportType:


 634                      toast(R.string.import_unknown);
 635                      break;
 636              }
 637          }
 638      }
 639  
 640      private void trackSortOrder(String label) {
 641          AnalyticsTracker.track(
 642              AnalyticsTracker.Stat.SETTINGS_SEARCH_SORT_MODE,
 643              AnalyticsTracker.CATEGORY_SETTING,
 644              label
 645          );
 646      }
 647  
 648      private void updateAnalyticsSwitchState() {
 649          try {
 650              Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 651              mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 652          } catch (BucketObjectMissingException e) {
 653              // The preferences object doesn&#x27;t exist for this user yet, create it
 654              try {
 655                  Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 656                  prefs.setAnalyticsEnabled(true);
 657                  prefs.save();
 658              } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 659                  bucketObjectNameInvalid.printStackTrace();
 660              }
 661          }
 662      }
 663  
 664      private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 665          private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 666  
 667          LogOutTask(PreferencesFragment fragment) {
 668              mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 669          }
 670  
 671          @Override
 672          protected Boolean doInBackground(Void... voids) {
 673              PreferencesFragment fragment = mPreferencesFragmentReference.get();
 674              return fragment == null || fragment.hasUnsyncedNotes();
 675          }
 676  
 677          @Override
 678          protected void onPostExecute(Boolean hasUnsyncedNotes) {
 679              final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 680  
 681              if (fragment == null) {
 682                  return;
 683              }
 684  
 685              // Safety first! Check if any notes are unsynced and warn the user if so.
 686              if (hasUnsyncedNotes) {
 687                  new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))
 688                      .setTitle(R.string.unsynced_notes)
 689                      .setMessage(R.string.unsynced_notes_message)
 690                      .setPositiveButton(R.string.log_out_anyway,
 691                          new DialogInterface.OnClickListener() {
 692                              @Override
 693                              public void onClick(DialogInterface dialogInterface, int i) {
 694                                  fragment.logOut();
 695                              }
 696                          }
 697                      )
 698                      .setNeutralButton(R.string.export_unsynced_notes,
 699                          new DialogInterface.OnClickListener() {
 700                              @Override
 701                              public void onClick(DialogInterface dialogInterface, int i) {
 702                                  Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 703                                  intent.addCategory(Intent.CATEGORY_OPENABLE);
 704                                  intent.setType(&quot;application/json&quot;);
 705                                  intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));
 706                                  fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 707                              }
 708                          }
 709                      )
 710                      .setNegativeButton(R.string.cancel, null)
 711                      .show();
 712              } else {
 713                  fragment.logOut();
 714              }
 715          }
 716      }
 717  
 718      private void toast(int stringId) {
 719          toast(stringId, Toast.LENGTH_SHORT);
 720      }
 721  
 722      private void toast(int stringId, int length) {
 723          Toast.makeText(requireContext(), getString(stringId), length).show();
 724      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 725 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 726 +    static class DeleteAccountRequestHandlerImpl implements DeleteAccountRequestHandler {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 727 +        final WeakReference&lt;PreferencesFragment&gt; preferencesFragment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 728 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 729 +        DeleteAccountRequestHandlerImpl(PreferencesFragment fragment) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 730 +            this.preferencesFragment = new WeakReference&lt;&gt;(fragment);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 731 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 732 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 733 +        @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 734 +        public void onSuccess() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 735 +            final PreferencesFragment fragment = preferencesFragment.get();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 736 +            if (fragment == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 737 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 738 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 739 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 740 +            FragmentActivity activity = fragment.getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 741 +            if (activity == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 742 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 743 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 744 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 745 +            AppLog.add(Type.ACCOUNT, &quot;Request to delete account was successful&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 746 +            AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 747 +                    AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 748 +                    AnalyticsTracker.CATEGORY_USER,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 749 +                    &quot;delete_account_request_success&quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 750 +            );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 751 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 752 +            activity.runOnUiThread(new Runnable() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 753 +                @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 754 +                public void run() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 755 +                    fragment.closeProgressDialogDeleteAccount();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 756 +                    fragment.showDeleteAccountConfirmationDialog();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 757 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 758 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 759 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 760 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 761 +        @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 762 +        public void onFailure() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 763 +            final PreferencesFragment fragment = preferencesFragment.get();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 764 +            if (fragment == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 765 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 766 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 767 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 768 +            FragmentActivity activity = fragment.getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 769 +            if (activity == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 770 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 771 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 772 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 773 +            AppLog.add(Type.ACCOUNT, &quot;Failure while calling server to delete account&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 774 +            AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 775 +                    AnalyticsTracker.Stat.USER_ACCOUNT_DELETE_REQUESTED,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 776 +                    AnalyticsTracker.CATEGORY_USER,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 777 +                    &quot;delete_account_request_failure&quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 778 +            );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 779 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 780 +            activity.runOnUiThread(new Runnable() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 781 +                @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 782 +                public void run() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 783 +                    fragment.closeProgressDialogDeleteAccount();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 784 +                    fragment.showDialogDeleteAccountError();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 785 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 786 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 787 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 788 +    }</span>
 789  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.Fragment;

   5  import android.content.DialogInterface;
   6  import android.content.Intent;
   7  import android.net.Uri;
   8  import android.os.AsyncTask;
   9  import android.os.Bundle;
  10  import android.os.ParcelFileDescriptor;
  11  import android.widget.Toast;
  12  
  13  import androidx.appcompat.app.AlertDialog;
  14  import androidx.appcompat.view.ContextThemeWrapper;
  15  import androidx.core.app.ShareCompat;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 +import androidx.fragment.app.FragmentActivity;</span>

  17  import androidx.preference.ListPreference;
  18  import androidx.preference.Preference;
  19  import androidx.preference.PreferenceFragmentCompat;
  20  import androidx.preference.SwitchPreferenceCompat;
  21  
  22  import com.automattic.simplenote.analytics.AnalyticsTracker;
  23  import com.automattic.simplenote.authentication.SimplenoteAuthenticationActivity;
  24  import com.automattic.simplenote.models.Note;
  25  import com.automattic.simplenote.models.Preferences;


  26  import com.automattic.simplenote.utils.AppLog;
  27  import com.automattic.simplenote.utils.AppLog.Type;
  28  import com.automattic.simplenote.utils.AuthUtils;
  29  import com.automattic.simplenote.utils.BrowserUtils;
  30  import com.automattic.simplenote.utils.CrashUtils;

  31  import com.automattic.simplenote.utils.HtmlCompat;
  32  import com.automattic.simplenote.utils.PrefUtils;

  33  import com.simperium.Simperium;

  34  import com.simperium.client.Bucket;
  35  import com.simperium.client.BucketObjectMissingException;
  36  import com.simperium.client.BucketObjectNameInvalid;
  37  import com.simperium.client.User;
  38  
  39  import org.json.JSONArray;
  40  import org.json.JSONObject;
  41  
  42  import java.io.FileOutputStream;
  43  import java.lang.ref.WeakReference;
  44  import java.util.Collections;
  45  import java.util.Comparator;
  46  import java.util.List;
  47  
  48  import static android.app.Activity.RESULT_OK;
  49  import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  50  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING;
  51  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING_LABEL;
  52  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING;
  53  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING_LABEL;
  54  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING;
  55  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING_LABEL;
  56  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING;
  57  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING_LABEL;
  58  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING;
  59  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING_LABEL;
  60  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING;
  61  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING_LABEL;
  62  
  63  /**
  64   * A simple {@link Fragment} subclass.
  65   */
<abbr title="  66  public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.OnUserCreatedListener {">  66  public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.ðŸ”µ</abbr>
  67      public static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  68  
  69      private static final int REQUEST_EXPORT_DATA = 9001;
  70      private static final int REQUEST_EXPORT_UNSYNCED = 9002;
  71      private static final int REQUEST_IMPORT_DATA = 9003;
  72  
  73      private Bucket&lt;Preferences&gt; mPreferencesBucket;
  74      private SwitchPreferenceCompat mAnalyticsSwitch;

  75  
  76      public PreferencesFragment() {
  77          // Required empty public constructor
  78      }
  79  
  80      @Override
  81      public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  82          addPreferencesFromResource(R.xml.preferences);
  83      }
  84  
  85      @Override
  86      public void onActivityCreated(Bundle savedInstanceState) {
  87          super.onActivityCreated(savedInstanceState);
  88  
  89          Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  90          Simplenote currentApp = (Simplenote) getActivity().getApplication();
  91          Simperium simperium = currentApp.getSimperium();
  92          simperium.setUserStatusChangeListener(this);
  93          simperium.setOnUserCreatedListener(this);
  94          mPreferencesBucket = currentApp.getPreferencesBucket();
  95  
  96          authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  97          if (simperium.needsAuthorization()) {
  98              authenticatePreference.setTitle(R.string.log_in);
  99          } else {
 100              authenticatePreference.setTitle(R.string.log_out);
 101          }
 102  
 103          authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 104              @Override
 105              public boolean onPreferenceClick(Preference preference) {
 106                  if (!isAdded()) {
 107                      return false;
 108                  }
 109  
 110                  Simplenote currentApp = (Simplenote) getActivity().getApplication();
 111                  if (currentApp.getSimperium().needsAuthorization()) {
 112                      Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);
 113                      startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 114                  } else {
 115                      new LogOutTask(PreferencesFragment.this).execute();
 116                  }















 117                  return true;
 118              }
 119          });
 120  
 121          findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 122              @Override
 123              public boolean onPreferenceClick(Preference preference) {
 124                  try {
 125                      BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;);
 126                  } catch (Exception e) {
 127                      toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 128                  }
 129                  return true;
 130              }
 131          });
 132  
<abbr title=" 133          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 133          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener()ðŸ”µ</abbr>
 134              @Override
 135              public boolean onPreferenceClick(Preference preference) {
 136                  try {
 137                      BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 138                  } catch (Exception e) {
 139                      toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 140                  }
 141                  return true;
 142              }
 143          });
 144  
 145          findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 146              @Override
 147              public boolean onPreferenceClick(Preference preference) {
 148                  startActivity(new Intent(getActivity(), AboutActivity.class));
 149                  return true;
 150              }
 151          });
 152  
<abbr title=" 153          findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 153          findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() ðŸ”µ</abbr>
 154              @Override
 155              public boolean onPreferenceClick(Preference preference) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +                AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +                        AnalyticsTracker.Stat.SETTINGS_IMPORT_NOTES,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +                        AnalyticsTracker.CATEGORY_NOTE,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +                        &quot;preferences_import_data_button&quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +                );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +</span>
 162                  Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
 163                  intent.addCategory(Intent.CATEGORY_OPENABLE);
 164                  intent.setType(&quot;*/*&quot;);
 165                  intent.putExtra(Intent.EXTRA_MIME_TYPES, new String[]{&quot;text/*&quot;, &quot;application/json&quot;});
 166                  startActivityForResult(intent, REQUEST_IMPORT_DATA);
 167                  return true;
 168              }
 169          });
 170  
<abbr title=" 171          findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 171          findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() ðŸ”µ</abbr>
 172              @Override
 173              public boolean onPreferenceClick(Preference preference) {
 174                  Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 175                  intent.addCategory(Intent.CATEGORY_OPENABLE);
 176                  intent.setType(&quot;application/json&quot;);
 177                  intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 178                  startActivityForResult(intent, REQUEST_EXPORT_DATA);
 179                  return true;
 180              }
 181          });
 182  
 183          final ListPreference themePreference = findPreference(PrefUtils.PREF_THEME);
 184          themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 185              @Override
 186              public boolean onPreferenceChange(Preference preference, Object newValue) {
 187                  updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 188                  return true;
 189              }
 190  
 191              private void updateTheme(Activity activity, int index) {
 192                  CharSequence[] entries = themePreference.getEntries();
 193                  themePreference.setSummary(entries[index]);
 194  
 195                  AnalyticsTracker.track(
 196                          AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 197                          AnalyticsTracker.CATEGORY_USER,
 198                          &quot;theme_preference&quot;
 199                  );
 200              }
 201          });
 202  
 203          final Preference stylePreference = findPreference(&quot;pref_key_style&quot;);
 204          stylePreference.setSummary(
 205              PrefUtils.isPremium(requireContext()) ?
 206                  PrefUtils.getStyleNameFromIndexSelected(requireContext()) :
 207                  PrefUtils.getStyleNameDefault(requireContext())
 208          );
 209          stylePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 210              @Override
 211              public boolean onPreferenceClick(Preference preference) {
 212                  startActivity(new Intent(requireContext(), StyleActivity.class));
 213                  return true;
 214              }
 215          });
 216  
 217          final Preference membershipPreference = findPreference(&quot;pref_key_membership&quot;);
 218          membershipPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 219              @Override
 220              public boolean onPreferenceClick(Preference preference) {
 221                  ((PreferencesActivity) requireActivity()).openBrowserForMembership(getView());
 222                  return true;
 223              }
 224          });
 225  
 226          if (PrefUtils.isPremium(requireContext())) {
 227              membershipPreference.setLayoutResource(R.layout.preference_default);
 228              membershipPreference.setSummary(R.string.membership_premium);
 229          } else {
 230              membershipPreference.setLayoutResource(R.layout.preference_button);
 231              membershipPreference.setSummary(R.string.membership_free);
 232          }
 233  
 234          final ListPreference sortPreference = findPreference(PrefUtils.PREF_SORT_ORDER);
 235          sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 236              @Override
 237              public boolean onPreferenceChange(Preference preference, Object newValue) {
 238                  int index = Integer.parseInt(newValue.toString());
 239                  CharSequence[] entries = sortPreference.getEntries();
 240                  sortPreference.setSummary(entries[index]);
 241  
 242                  if (!sortPreference.getValue().equals(newValue)) {
 243                      switch (index) {
 244                          case ALPHABETICAL_ASCENDING:
 245                              trackSortOrder(ALPHABETICAL_ASCENDING_LABEL);
 246                              break;
 247                          case ALPHABETICAL_DESCENDING:
 248                              trackSortOrder(ALPHABETICAL_DESCENDING_LABEL);
 249                              break;
 250                          case DATE_CREATED_ASCENDING:
 251                              trackSortOrder(DATE_CREATED_ASCENDING_LABEL);
 252                              break;
 253                          case DATE_CREATED_DESCENDING:
 254                              trackSortOrder(DATE_CREATED_DESCENDING_LABEL);
 255                              break;
 256                          case DATE_MODIFIED_ASCENDING:
 257                              trackSortOrder(DATE_MODIFIED_ASCENDING_LABEL);
 258                              break;
 259                          case DATE_MODIFIED_DESCENDING:
 260                              trackSortOrder(DATE_MODIFIED_DESCENDING_LABEL);
 261                              break;
 262                      }
 263                  }
 264  
 265                  return true;
 266              }
 267          });
 268  
 269          SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);
 270          switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 271              @Override
 272              public boolean onPreferenceChange(Preference preference, Object o) {
 273                  if (((SwitchPreferenceCompat) preference).isChecked()) {
 274                      AnalyticsTracker.track(
 275                              AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 276                              AnalyticsTracker.CATEGORY_USER,
 277                              &quot;condensed_list_preference&quot;
 278                      );
 279                  }
 280  
 281                  return true;
 282              }
 283          });
 284  
 285          // Add the hyperlink to the analytics summary
 286          Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 287          String formattedSummary = String.format(
 288                  getString(R.string.share_analytics_summary),
 289                  &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 290                  &quot;&lt;/a&gt;&quot;
 291          );
 292          analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 293  
 294          mAnalyticsSwitch = findPreference(&quot;pref_key_analytics_switch&quot;);
 295          mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 296              @Override
 297              public boolean onPreferenceChange(Preference preference, Object newValue) {
 298                  try {
 299                      boolean isChecked = (boolean)newValue;
 300                      Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 301                      prefs.setAnalyticsEnabled(isChecked);
 302                      prefs.save();
 303                  } catch (BucketObjectMissingException e) {
 304                      e.printStackTrace();
 305                  }
 306  
 307                  return true;
 308              }
 309          });
 310  
 311          updateAnalyticsSwitchState();
 312  
 313          findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 314              @Override
 315              public boolean onPreferenceClick(Preference preference) {
 316                  startActivity(
 317                      ShareCompat.IntentBuilder.from(requireActivity())
 318                          .setText(AppLog.get())
 319                          .setType(&quot;text/plain&quot;)
 320                          .createChooserIntent()
 321                  );
 322                  return true;
 323              }
 324          });

























































































































 325      }
 326  
 327      @Override
 328      public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 329          if (resultCode != RESULT_OK || resultData == null) {
 330              return;
 331          }
 332  
 333          if (resultData.getData() == null) {
 334              toast(R.string.export_message_failure);
 335              return;
 336          }
 337  
 338          switch (requestCode) {
 339              case REQUEST_EXPORT_DATA:
 340                  exportData(resultData.getData(), false);
 341                  break;
 342              case REQUEST_EXPORT_UNSYNCED:
 343                  exportData(resultData.getData(), true);
 344                  break;
 345              case REQUEST_IMPORT_DATA:
 346                  importData(resultData.getData());
 347                  break;
 348          }
 349      }
 350  
 351      private boolean hasUnsyncedNotes() {
 352          Simplenote application = (Simplenote) getActivity().getApplication();
 353          Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 354          Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 355          while (notesCursor.moveToNext()) {
 356              Note note = notesCursor.getObject();
 357              if (note.isNew() || note.isModified()) {
 358                  return true;
 359              }
 360          }
 361  
 362          return false;
 363      }
 364  
 365      private void logOut() {
 366          AppLog.add(Type.ACTION, &quot;Tapped logout button (PreferencesFragment)&quot;);
 367          AnalyticsTracker.track(
 368                  AnalyticsTracker.Stat.USER_SIGNED_OUT,
 369                  AnalyticsTracker.CATEGORY_USER,
 370                  &quot;preferences_sign_out_button&quot;
 371          );
 372  
 373          AuthUtils.logOut((Simplenote) requireActivity().getApplication());
 374  
 375          getActivity().finish();
 376      }
 377  
 378      @Override
 379      public void onUserStatusChange(User.Status status) {
 380          if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 381              // User signed in
 382              getActivity().runOnUiThread(new Runnable() {
 383                  public void run() {
 384                      Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 385                      authenticatePreference.setTitle(R.string.log_out);
 386                  }
 387              });
 388  
 389              Simplenote app = (Simplenote) getActivity().getApplication();
 390              AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 391              CrashUtils.setCurrentUser(app.getSimperium().getUser());
 392  
 393              AnalyticsTracker.track(
 394                      AnalyticsTracker.Stat.USER_SIGNED_IN,
 395                      AnalyticsTracker.CATEGORY_USER,
 396                      &quot;signed_in_from_preferences_activity&quot;
 397              );
 398          }
 399      }
 400  
 401      @Override
 402      public void onUserCreated(User user) {
 403          AnalyticsTracker.track(
 404                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 405                  AnalyticsTracker.CATEGORY_USER,
 406                  &quot;account_created_from_preferences_activity&quot;
 407          );
 408      }
 409  
 410      private void exportData(Uri uri, boolean isUnsyncedNotes) {
 411          Simplenote currentApp = (Simplenote) requireActivity().getApplication();
 412          Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 413          JSONObject account = new JSONObject();
 414          Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 415  
 416          try {
 417              JSONArray activeNotes = new JSONArray();
 418              JSONArray trashedNotes = new JSONArray();
 419              Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 420                  @Override
 421                  public int compare(String text1, String text2) {
 422                      return text1.compareToIgnoreCase(text2);
 423                  }
 424              };
 425  
 426              while (cursor.moveToNext()) {
 427                  Note note = cursor.getObject();
 428  
 429                  if (isUnsyncedNotes &amp;&amp; !note.isNew() &amp;&amp; !note.isModified()) {
 430                      continue;
 431                  }
 432  
 433                  JSONObject noteJson = new JSONObject();
 434  
 435                  noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 436                  noteJson.put(&quot;content&quot;, note.getContent());
 437                  noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 438                  noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 439  
 440                  if (note.isPinned()) {
 441                      noteJson.put(&quot;pinned&quot;, note.isPinned());
 442                  }
 443  
 444                  if (note.isMarkdownEnabled()) {
 445                      noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 446                  }
 447  
 448                  if (note.getTags().size() &gt; 0) {
 449                      List&lt;String&gt; tags = note.getTags();
 450                      Collections.sort(tags, comparator);
 451                      noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 452                  }
 453  
 454                  if (!note.getPublishedUrl().isEmpty()) {
 455                      noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 456                  }
 457  
 458                  if (note.isDeleted()) {
 459                      trashedNotes.put(noteJson);
 460                  } else {
 461                      activeNotes.put(noteJson);
 462                  }
 463              }
 464  
 465              account.put(&quot;activeNotes&quot;, activeNotes);
 466              account.put(&quot;trashedNotes&quot;, trashedNotes);
 467  
<abbr title=" 468              ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 468              ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uðŸ”µ</abbr>
 469  
 470              if (parcelFileDescriptor != null) {
<abbr title=" 471                  FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 471                  FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor())ðŸ”µ</abbr>
 472                  fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;,&quot;/&quot;).getBytes());
 473                  parcelFileDescriptor.close();
 474                  toast(R.string.export_message_success);
 475              } else {
 476                  toast(R.string.export_message_failure);
 477              }
 478          } catch (Exception e) {
 479              toast(R.string.export_message_failure);
 480          }
 481      }
 482  
 483      private void importData(Uri uri) {
 484          try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 485 -            Importer.fromUri(this, uri);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 486 +            AppLog.add(Type.IMPORT, &quot;Importing notes from &quot; + uri + &quot;.&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 487 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 488 +            FragmentActivity activity = getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 489 +            if (activity == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 490 +                AppLog.add(Type.IMPORT, &quot;Could not import notes since activity is null&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 491 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 492 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 493 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 494 +            Importer.fromUri(activity, uri);</span>
 495              toast(R.string.import_message_success);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 496 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 497 +            AppLog.add(Type.IMPORT, &quot;Notes imported correctly!&quot;);</span>
 498          } catch (Importer.ImportException e) {
 499              switch (e.getReason()) {
 500                  case FileError:
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 501 +                    AppLog.add(Type.IMPORT, &quot;File error while importing note. Exception: &quot; + e.getMessage());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 502 +</span>
 503                      toast(R.string.import_error_file);
 504                      break;
 505                  case ParseError:
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 506 +                    AppLog.add(Type.IMPORT, &quot;Parse error while importing note. Exception: &quot; + e.getMessage());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 507 +</span>
 508                      toast(R.string.import_error_parse);
 509                      break;
 510                  case UnknownExportType:
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 511 +                    AppLog.add(Type.IMPORT, &quot;Unknown error while importing note. Exception: &quot; + e.getMessage());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 512 +</span>
 513                      toast(R.string.import_unknown);
 514                      break;
 515              }
 516          }
 517      }
 518  
 519      private void trackSortOrder(String label) {
 520          AnalyticsTracker.track(
 521              AnalyticsTracker.Stat.SETTINGS_SEARCH_SORT_MODE,
 522              AnalyticsTracker.CATEGORY_SETTING,
 523              label
 524          );
 525      }
 526  
 527      private void updateAnalyticsSwitchState() {
 528          try {
 529              Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 530              mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 531          } catch (BucketObjectMissingException e) {
 532              // The preferences object doesn&#x27;t exist for this user yet, create it
 533              try {
 534                  Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 535                  prefs.setAnalyticsEnabled(true);
 536                  prefs.save();
 537              } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 538                  bucketObjectNameInvalid.printStackTrace();
 539              }
 540          }
 541      }
 542  
 543      private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 544          private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 545  
 546          LogOutTask(PreferencesFragment fragment) {
 547              mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 548          }
 549  
 550          @Override
 551          protected Boolean doInBackground(Void... voids) {
 552              PreferencesFragment fragment = mPreferencesFragmentReference.get();
 553              return fragment == null || fragment.hasUnsyncedNotes();
 554          }
 555  
 556          @Override
 557          protected void onPostExecute(Boolean hasUnsyncedNotes) {
 558              final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 559  
 560              if (fragment == null) {
 561                  return;
 562              }
 563  
 564              // Safety first! Check if any notes are unsynced and warn the user if so.
 565              if (hasUnsyncedNotes) {
 566                  new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))
 567                      .setTitle(R.string.unsynced_notes)
 568                      .setMessage(R.string.unsynced_notes_message)
 569                      .setPositiveButton(R.string.log_out_anyway,
 570                          new DialogInterface.OnClickListener() {
 571                              @Override
 572                              public void onClick(DialogInterface dialogInterface, int i) {
 573                                  fragment.logOut();
 574                              }
 575                          }
 576                      )
 577                      .setNeutralButton(R.string.export_unsynced_notes,
 578                          new DialogInterface.OnClickListener() {
 579                              @Override
 580                              public void onClick(DialogInterface dialogInterface, int i) {
 581                                  Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 582                                  intent.addCategory(Intent.CATEGORY_OPENABLE);
 583                                  intent.setType(&quot;application/json&quot;);
 584                                  intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));
 585                                  fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 586                              }
 587                          }
 588                      )
 589                      .setNegativeButton(R.string.cancel, null)
 590                      .show();
 591              } else {
 592                  fragment.logOut();
 593              }
 594          }
 595      }
 596  
 597      private void toast(int stringId) {
 598          toast(stringId, Toast.LENGTH_SHORT);
 599      }
 600  
 601      private void toast(int stringId, int length) {
 602          Toast.makeText(requireContext(), getString(stringId), length).show();
 603      }
































































 604  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            