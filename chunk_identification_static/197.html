<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>197</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    197
                    <a href="196.html">prev</a>
                    <a href="198.html">next</a>
                    <a href="197_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_ca7ad284b68b41fd53b2a9e24cafe6fadaee52e8_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ca7ad284b68b41fd53b2a9e24cafe6fadaee52e8:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ca7ad284b68b41fd53b2a9e24cafe6fadaee52e8^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ca7ad284b68b41fd53b2a9e24cafe6fadaee52e8^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;1d8f70a5cd049c3d229a6ef9441390c91fb57271:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18 package org.broadleafcommerce.core.offer.service;                                                        </span>
<span  style="">  19                                                                                                          </span>
<span class="8596464405353709537" onmouseenter="enter('8596464405353709537');" onmouseout="out('8596464405353709537');" style="">  20 import org.apache.commons.collections.CollectionUtils;                                                   </span>
<span class="2953846583056246827" onmouseenter="enter('2953846583056246827');" onmouseout="out('2953846583056246827');" style="">  21 import org.apache.commons.collections.Transformer;                                                       </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  22 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  23 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-2193028153657877676" onmouseenter="enter('-2193028153657877676');" onmouseout="out('-2193028153657877676');" style="">  24 import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;                                 </span>
<span class="-3349026188166660873" onmouseenter="enter('-3349026188166660873');" onmouseout="out('-3349026188166660873');" style="">  25 import org.broadleafcommerce.common.persistence.EntityDuplicator;                                        </span>
<span class="-2818686525334833130" onmouseenter="enter('-2818686525334833130');" onmouseout="out('-2818686525334833130');" style="">  26 import org.broadleafcommerce.common.sandbox.SandBoxHelper;                                               </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  27 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                     </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  28 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                </span>
<span class="6205208880685044389" onmouseenter="enter('6205208880685044389');" onmouseout="out('6205208880685044389');" style="">  29 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;                                            </span>
<span class="-7911436562744873568" onmouseenter="enter('-7911436562744873568');" onmouseout="out('-7911436562744873568');" style="">  30 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;                                                </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  31 import org.broadleafcommerce.core.offer.dao.OfferDao;                                                    </span>
<span class="-1633608357492319903" onmouseenter="enter('-1633608357492319903');" onmouseout="out('-1633608357492319903');" style="">  32 import org.broadleafcommerce.core.offer.domain.Adjustment;                                               </span>
<span class="984981432680799531" onmouseenter="enter('984981432680799531');" onmouseout="out('984981432680799531');" style="">  33 import org.broadleafcommerce.core.offer.domain.CustomerOffer;                                            </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  34 import org.broadleafcommerce.core.offer.domain.Offer;                                                    </span>
<span class="1521662235446319191" onmouseenter="enter('1521662235446319191');" onmouseout="out('1521662235446319191');" style="">  35 import org.broadleafcommerce.core.offer.domain.OfferCode;                                                </span>
<span class="-7025591891527881733" onmouseenter="enter('-7025591891527881733');" onmouseout="out('-7025591891527881733');" style="">  36 import org.broadleafcommerce.core.offer.domain.OfferImpl;                                                </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  37 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                           </span>
<span class="4287099423657810905" onmouseenter="enter('4287099423657810905');" onmouseout="out('4287099423657810905');" style="">  38 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;</span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  39 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;            </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  40 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;           </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                   </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                         </span>
<span class="5713212224635448284" onmouseenter="enter('5713212224635448284');" onmouseout="out('5713212224635448284');" style="">  43 import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;                </span>
<span class="-2454758753718589449" onmouseenter="enter('-2454758753718589449');" onmouseout="out('-2454758753718589449');" style="">  44 import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;                            </span>
<span class="8227287359407176835" onmouseenter="enter('8227287359407176835');" onmouseout="out('8227287359407176835');" style="">  45 import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;                           </span>
<span class="-2230425701287318422" onmouseenter="enter('-2230425701287318422');" onmouseout="out('-2230425701287318422');" style="">  46 import org.broadleafcommerce.core.offer.service.type.CustomerMaxUsesStrategyType;                        </span>
<span class="-5727938558534008634" onmouseenter="enter('-5727938558534008634');" onmouseout="out('-5727938558534008634');" style="">  47 import org.broadleafcommerce.core.offer.service.type.OfferType;                                          </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  48 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                         </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  49 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  50 import org.broadleafcommerce.core.order.domain.OrderItem;                                                </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  51 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                     </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  52 import org.broadleafcommerce.core.order.service.OrderService;                                            </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  53 import org.broadleafcommerce.core.pricing.service.exception.PricingException;                            </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  54 import org.broadleafcommerce.profile.core.domain.Customer;                                               </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  55 import org.springframework.stereotype.Service;                                                           </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  56 import org.springframework.transaction.annotation.Transactional;                                         </span>
<span  style="">  57                                                                                                          </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  58 import java.util.ArrayList;                                                                              </span>
<span class="-112105277767313938" onmouseenter="enter('-112105277767313938');" onmouseout="out('-112105277767313938');" style="">  59 import java.util.Collection;                                                                             </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  60 import java.util.HashMap;                                                                                </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  61 import java.util.HashSet;                                                                                </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  62 import java.util.Iterator;                                                                               </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  63 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  64 import java.util.Map;                                                                                    </span>
<span class="6306724220981822255" onmouseenter="enter('6306724220981822255');" onmouseout="out('6306724220981822255');" style="">  65 import java.util.Objects;                                                                                </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  66 import java.util.Set;                                                                                    </span>
<span  style="">  67                                                                                                          </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  68 import javax.annotation.Resource;                                                                        </span>
<span class="7911938180110628123" onmouseenter="enter('7911938180110628123');" onmouseout="out('7911938180110628123');" style="">  69 import javax.persistence.EntityManager;                                                                  </span>
<span class="3821515051839343306" onmouseenter="enter('3821515051839343306');" onmouseout="out('3821515051839343306');" style="">  70 import javax.persistence.PersistenceContext;                                                             </span>
<span  style="">  71                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  72 /**                                                                                                      </span>
<span class="-2667338179687874348" onmouseenter="enter('-2667338179687874348');" onmouseout="out('-2667338179687874348');" style="">  73  * The Class OfferServiceImpl.                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  74  */                                                                                                      </span>
<span class="504450232350438262" onmouseenter="enter('504450232350438262');" onmouseout="out('504450232350438262');" style="">  75 @Service(&quot;blOfferService&quot;)                                                                               </span>
<span class="6786430150403502423" onmouseenter="enter('6786430150403502423');" onmouseout="out('6786430150403502423');" style="">  76 public class OfferServiceImpl implements OfferService {                                                  </span>
<span  style="">  77                                                                                                          </span>
<span class="8897944981470617719" onmouseenter="enter('8897944981470617719');" onmouseout="out('8897944981470617719');" style="">  78     private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);                            </span>
<span  style="">  79                                                                                                          </span>
<span class="3846751699212951796" onmouseenter="enter('3846751699212951796');" onmouseout="out('3846751699212951796');" style="">  80     // should be called outside of Offer service after Offer service is executed                         </span>
<span class="-5484979233832760683" onmouseenter="enter('-5484979233832760683');" onmouseout="out('-5484979233832760683');" style="">  81     @Resource(name=&quot;blCustomerOfferDao&quot;)                                                                 </span>
<span class="-5771823415174942027" onmouseenter="enter('-5771823415174942027');" onmouseout="out('-5771823415174942027');" style="">  82     protected CustomerOfferDao customerOfferDao;                                                         </span>
<span  style="">  83                                                                                                          </span>
<span class="-1524144969871346405" onmouseenter="enter('-1524144969871346405');" onmouseout="out('-1524144969871346405');" style="">  84     @Resource(name=&quot;blOfferCodeDao&quot;)                                                                     </span>
<span class="-6984238934820524758" onmouseenter="enter('-6984238934820524758');" onmouseout="out('-6984238934820524758');" style="">  85     protected OfferCodeDao offerCodeDao;                                                                 </span>
<span  style="">  86                                                                                                          </span>
<span class="-8247969455122443370" onmouseenter="enter('-8247969455122443370');" onmouseout="out('-8247969455122443370');" style="">  87     @Resource(name=&quot;blOfferAuditService&quot;)                                                                </span>
<span class="-6742419488595856311" onmouseenter="enter('-6742419488595856311');" onmouseout="out('-6742419488595856311');" style="">  88     protected OfferAuditService offerAuditService;                                                       </span>
<span  style="">  89                                                                                                          </span>
<span class="-6976077299079381435" onmouseenter="enter('-6976077299079381435');" onmouseout="out('-6976077299079381435');" style="">  90     @Resource(name=&quot;blOfferDao&quot;)                                                                         </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  91     protected OfferDao offerDao;                                                                         </span>
<span  style="">  92                                                                                                          </span>
<span class="-3191658961867656636" onmouseenter="enter('-3191658961867656636');" onmouseout="out('-3191658961867656636');" style="">  93     @Resource(name=&quot;blOrderOfferProcessor&quot;)                                                              </span>
<span class="-3818126380928091101" onmouseenter="enter('-3818126380928091101');" onmouseout="out('-3818126380928091101');" style="">  94     protected OrderOfferProcessor orderOfferProcessor;                                                   </span>
<span  style="">  95                                                                                                          </span>
<span class="-6223428528083119866" onmouseenter="enter('-6223428528083119866');" onmouseout="out('-6223428528083119866');" style="">  96     @Resource(name=&quot;blItemOfferProcessor&quot;)                                                               </span>
<span class="-7827297227357944415" onmouseenter="enter('-7827297227357944415');" onmouseout="out('-7827297227357944415');" style="">  97     protected ItemOfferProcessor itemOfferProcessor;                                                     </span>
<span  style="">  98                                                                                                          </span>
<span class="-1476654469985531605" onmouseenter="enter('-1476654469985531605');" onmouseout="out('-1476654469985531605');" style="">  99     @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)                                                   </span>
<span class="7634983124983010999" onmouseenter="enter('7634983124983010999');" onmouseout="out('7634983124983010999');" style=""> 100     protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;                             </span>
<span  style=""> 101                                                                                                          </span>
<span class="-4330844585159307437" onmouseenter="enter('-4330844585159307437');" onmouseout="out('-4330844585159307437');" style=""> 102     @Resource(name=&quot;blPromotableItemFactory&quot;)                                                            </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style=""> 103     protected PromotableItemFactory promotableItemFactory;                                               </span>
<span  style=""> 104                                                                                                          </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style=""> 105     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                   </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style=""> 106     protected OfferServiceExtensionManager extensionManager;                                             </span>
<span  style=""> 107                                                                                                          </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 108     @Resource(name = &quot;blOrderService&quot;)                                                                   </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 109     protected OrderService orderService;                                                                 </span>
<span  style=""> 110                                                                                                          </span>
<span class="-3946461589801993391" onmouseenter="enter('-3946461589801993391');" onmouseout="out('-3946461589801993391');" style=""> 111     @Resource(name = &quot;blSandBoxHelper&quot;)                                                                  </span>
<span class="-7799183597372200632" onmouseenter="enter('-7799183597372200632');" onmouseout="out('-7799183597372200632');" style=""> 112     protected SandBoxHelper sandBoxHelper;                                                               </span>
<span  style=""> 113                                                                                                          </span>
<span class="-4259734795637808055" onmouseenter="enter('-4259734795637808055');" onmouseout="out('-4259734795637808055');" style=""> 114     @PersistenceContext(unitName=&quot;blPU&quot;)                                                                 </span>
<span class="-5741815223868414625" onmouseenter="enter('-5741815223868414625');" onmouseout="out('-5741815223868414625');" style=""> 115     protected EntityManager em;                                                                          </span>
<span  style=""> 116                                                                                                          </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 117     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                  </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 118     protected StreamingTransactionCapableUtil transUtil;                                                 </span>
<span  style=""> 119                                                                                                          </span>
<span class="-8384326529234094002" onmouseenter="enter('-8384326529234094002');" onmouseout="out('-8384326529234094002');" style=""> 120     @Resource(name=&quot;blEntityDuplicator&quot;)                                                                 </span>
<span class="-9194612273021432316" onmouseenter="enter('-9194612273021432316');" onmouseout="out('-9194612273021432316');" style=""> 121     protected EntityDuplicator duplicator;                                                               </span>
<span  style=""> 122                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 123     /**                                                                                                  </span>
<span class="-5719913168774156893" onmouseenter="enter('-5719913168774156893');" onmouseout="out('-5719913168774156893');" style=""> 124      * @deprecated Add {@link EntityDuplicateModifier}s to {@code blEntityDuplicationHelpers}            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 125      */                                                                                                  </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 126     @Deprecated                                                                                          </span>
<span class="8658910844320022950" onmouseenter="enter('8658910844320022950');" onmouseout="out('8658910844320022950');" style=""> 127     protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;                                     </span>
<span  style=""> 128                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 129     @Override                                                                                            </span>
<span class="-2033305286790048708" onmouseenter="enter('-2033305286790048708');" onmouseout="out('-2033305286790048708');" style=""> 130     public List&lt;Offer&gt; findAllOffers() {                                                                 </span>
<span class="2132174063530273788" onmouseenter="enter('2132174063530273788');" onmouseout="out('2132174063530273788');" style=""> 131         return offerDao.readAllOffers();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 132     }                                                                                                    </span>
<span  style=""> 133                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 134     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 135     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="7144811092176845141" onmouseenter="enter('7144811092176845141');" onmouseout="out('7144811092176845141');" style=""> 136     public Offer save(Offer offer) {                                                                     </span>
<span class="-264708178039771798" onmouseenter="enter('-264708178039771798');" onmouseout="out('-264708178039771798');" style=""> 137         return offerDao.save(offer);                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 138     }                                                                                                    </span>
<span  style=""> 139                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 140     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 141     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-5514670765130856091" onmouseenter="enter('-5514670765130856091');" onmouseout="out('-5514670765130856091');" style=""> 142     public OfferCode saveOfferCode(OfferCode offerCode) {                                                </span>
<span class="3125778008044685658" onmouseenter="enter('3125778008044685658');" onmouseout="out('3125778008044685658');" style=""> 143         offerCode.setOffer(offerDao.save(offerCode.getOffer()));                                         </span>
<span class="6906137479190051982" onmouseenter="enter('6906137479190051982');" onmouseout="out('6906137479190051982');" style=""> 144         return offerCodeDao.save(offerCode);                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 145     }                                                                                                    </span>
<span  style=""> 146                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 147     /**                                                                                                  </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""><abbr title=" 148      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 148      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr></span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""><abbr title=" 149      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 149      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr></span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 150      * cannot appear more than once in the list.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 151      *                                                                                                   </span>
<span class="-709313334493645866" onmouseenter="enter('-709313334493645866');" onmouseout="out('-709313334493645866');" style=""> 152      * @param code                                                                                       </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 153      * @return a List of offers that may apply to this order                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 154      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 155     @Override                                                                                            </span>
<span class="-6840847083603451180" onmouseenter="enter('-6840847083603451180');" onmouseout="out('-6840847083603451180');" style=""> 156     public Offer lookupOfferByCode(String code) {                                                        </span>
<span class="-531732708503781646" onmouseenter="enter('-531732708503781646');" onmouseout="out('-531732708503781646');" style=""> 157         Offer offer = null;                                                                              </span>
<span class="-8218576552188075283" onmouseenter="enter('-8218576552188075283');" onmouseout="out('-8218576552188075283');" style=""> 158         OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);                                    </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 159         if (offerCode != null) {                                                                         </span>
<span class="-2561785727340284423" onmouseenter="enter('-2561785727340284423');" onmouseout="out('-2561785727340284423');" style=""> 160             offer = offerCode.getOffer();                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161         }                                                                                                </span>
<span class="-8963791522625561917" onmouseenter="enter('-8963791522625561917');" onmouseout="out('-8963791522625561917');" style=""> 162         return offer;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 163     }                                                                                                    </span>
<span  style=""> 164                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 165     @Override                                                                                            </span>
<span class="2883322601430833612" onmouseenter="enter('2883322601430833612');" onmouseout="out('2883322601430833612');" style=""> 166     public OfferCode lookupOfferCodeByCode(String code){                                                 </span>
<span class="8795189428566002896" onmouseenter="enter('8795189428566002896');" onmouseout="out('8795189428566002896');" style=""> 167         return offerCodeDao.readOfferCodeByCode(code);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 168     }                                                                                                    </span>
<span  style=""> 169                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 170     @Override                                                                                            </span>
<span class="-2543778591938191529" onmouseenter="enter('-2543778591938191529');" onmouseout="out('-2543778591938191529');" style=""> 171     public List&lt;Offer&gt; lookupAllOffersByCode(String code) {                                              </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 172         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                     </span>
<span class="-3360697953765841703" onmouseenter="enter('-3360697953765841703');" onmouseout="out('-3360697953765841703');" style=""> 173         List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);                         </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 174         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 175             if (offerCode != null) {                                                                     </span>
<span class="-7816274075460376657" onmouseenter="enter('-7816274075460376657');" onmouseout="out('-7816274075460376657');" style=""> 176                 offers.add(offerCode.getOffer());                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 177             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 178         }                                                                                                </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 179         return offers;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180     }                                                                                                    </span>
<span  style=""> 181                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 182     @Override                                                                                            </span>
<span class="4676855439599320404" onmouseenter="enter('4676855439599320404');" onmouseout="out('4676855439599320404');" style=""> 183     public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){                                       </span>
<span class="-4234235759448675045" onmouseenter="enter('-4234235759448675045');" onmouseout="out('-4234235759448675045');" style=""> 184         return offerCodeDao.readAllOfferCodesByCode(code);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 185     }                                                                                                    </span>
<span  style=""> 186                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 187     /**                                                                                                  </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""><abbr title=" 188      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 188      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr></span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""><abbr title=" 189      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 189      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr></span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 190      * cannot appear more than once in the list.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 191      *                                                                                                   </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 192      * @param order                                                                                      </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 193      * @return a List of offers that may apply to this order                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 194      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 195     @Override                                                                                            </span>
<span class="-5814298891852821500" onmouseenter="enter('-5814298891852821500');" onmouseout="out('-5814298891852821500');" style=""> 196     public List&lt;Offer&gt; buildOfferListForOrder(Order order) {                                             </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 197         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                     </span>
<span class="-3235900677601494398" onmouseenter="enter('-3235900677601494398');" onmouseout="out('-3235900677601494398');" style=""> 198         List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());         </span>
<span class="7699769166343685501" onmouseenter="enter('7699769166343685501');" onmouseout="out('7699769166343685501');" style=""> 199         for (CustomerOffer customerOffer : customerOffers) {                                             </span>
<span class="-2310400538171319838" onmouseenter="enter('-2310400538171319838');" onmouseout="out('-2310400538171319838');" style=""> 200             if (!offers.contains(customerOffer.getOffer())) {                                            </span>
<span class="5233078073066950969" onmouseenter="enter('5233078073066950969');" onmouseout="out('5233078073066950969');" style=""> 201                 offers.add(customerOffer.getOffer());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 202             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 203         }                                                                                                </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style=""> 204         List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                          </span>
<span class="-6665865767746694239" onmouseenter="enter('-6665865767746694239');" onmouseout="out('-6665865767746694239');" style=""> 205         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                    </span>
<span class="2682597879629079185" onmouseenter="enter('2682597879629079185');" onmouseout="out('2682597879629079185');" style=""> 206         for (OfferCode orderOfferCode : orderOfferCodes) {                                               </span>
<span class="-1857624084667800558" onmouseenter="enter('-1857624084667800558');" onmouseout="out('-1857624084667800558');" style=""> 207             if (!offers.contains(orderOfferCode.getOffer())) {                                           </span>
<span class="4188766124804405127" onmouseenter="enter('4188766124804405127');" onmouseout="out('4188766124804405127');" style=""> 208                 offers.add(orderOfferCode.getOffer());                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 209             }                                                                                            </span>
<span class="-4468546552745233084" onmouseenter="enter('-4468546552745233084');" onmouseout="out('-4468546552745233084');" style=""> 210             extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 211         }                                                                                                </span>
<span class="-9188634082558155234" onmouseenter="enter('-9188634082558155234');" onmouseout="out('-9188634082558155234');" style=""> 212         List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();                                      </span>
<span class="-8411171878687156520" onmouseenter="enter('-8411171878687156520');" onmouseout="out('-8411171878687156520');" style=""> 213         for (Offer globalOffer : globalOffers) {                                                         </span>
<span class="2071278729839157974" onmouseenter="enter('2071278729839157974');" onmouseout="out('2071278729839157974');" style=""> 214             if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {  </span>
<span class="-3050025518373868772" onmouseenter="enter('-3050025518373868772');" onmouseout="out('-3050025518373868772');" style=""> 215                 offers.add(globalOffer);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 216             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 217         }                                                                                                </span>
<span  style=""> 218                                                                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 219         if (extensionManager != null) {                                                                  </span>
<span class="1817402996237899777" onmouseenter="enter('1817402996237899777');" onmouseout="out('1817402996237899777');" style=""> 220             extensionManager.applyAdditionalFilters(offers, order);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 221         }                                                                                                </span>
<span  style=""> 222                                                                                                          </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 223         return offers;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 224     }                                                                                                    </span>
<span  style=""> 225                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 226     @Override                                                                                            </span>
<span class="2056305643902587707" onmouseenter="enter('2056305643902587707');" onmouseout="out('2056305643902587707');" style=""> 227     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {                                  </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 228         Customer customer = order.getCustomer();                                                         </span>
<span class="-5041998041456755776" onmouseenter="enter('-5041998041456755776');" onmouseout="out('-5041998041456755776');" style=""> 229         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();                                             </span>
<span  style=""> 230                                                                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 231         if (extensionManager != null) {                                                                  </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 232             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 233         }                                                                                                </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 234         if (!offerCodes.isEmpty()) {                                                                     </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 235             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                             </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 236             while (itr.hasNext()) {                                                                      </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 237                 OfferCode offerCode = itr.next();                                                        </span>
<span class="-776136422183497161" onmouseenter="enter('-776136422183497161');" onmouseout="out('-776136422183497161');" style=""> 238                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {       </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 239                     itr.remove();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 240                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 241             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 242         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 243         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 244     }                                                                                                    </span>
<span  style=""> 245                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 246     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 247     @Override                                                                                            </span>
<span class="3843851677430304310" onmouseenter="enter('3843851677430304310');" onmouseout="out('3843851677430304310');" style=""> 248     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {                            </span>
<span class="-6957816096303048614" onmouseenter="enter('-6957816096303048614');" onmouseout="out('-6957816096303048614');" style=""> 249         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 250         if (extensionManager != null) {                                                                  </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 251             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 252         }                                                                                                </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 253         if (!offerCodes.isEmpty()) {                                                                     </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 254             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                             </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 255             while (itr.hasNext()) {                                                                      </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 256                 OfferCode offerCode = itr.next();                                                        </span>
<span class="6086018267170409432" onmouseenter="enter('6086018267170409432');" onmouseout="out('6086018267170409432');" style=""> 257                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {    </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 258                     itr.remove();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 259                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 260             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 261         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 262         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 263     }                                                                                                    </span>
<span  style=""> 264                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 265     /**                                                                                                  </span>
<span class="2837560355574155003" onmouseenter="enter('2837560355574155003');" onmouseout="out('2837560355574155003');" style=""> 266      * Private method used to retrieve all offers assigned to this customer.  These offers are           </span>
<span class="4852710310174118924" onmouseenter="enter('4852710310174118924');" onmouseout="out('4852710310174118924');" style=""> 267      * programmatically assigned to the customer.                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 268      *                                                                                                   </span>
<span class="1094425505394812731" onmouseenter="enter('1094425505394812731');" onmouseout="out('1094425505394812731');" style=""> 269      * @param customer                                                                                   </span>
<span class="-3868237647402015492" onmouseenter="enter('-3868237647402015492');" onmouseout="out('-3868237647402015492');" style=""> 270      * @return a List of offers assigned to the customer                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 271      */                                                                                                  </span>
<span class="-1064959765029423996" onmouseenter="enter('-1064959765029423996');" onmouseout="out('-1064959765029423996');" style=""> 272     protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {                     </span>
<span class="1699675085073278700" onmouseenter="enter('1699675085073278700');" onmouseout="out('1699675085073278700');" style=""> 273         List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);    </span>
<span class="5611761187435301880" onmouseenter="enter('5611761187435301880');" onmouseout="out('5611761187435301880');" style=""> 274         return offerCustomers;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 275     }                                                                                                    </span>
<span  style=""> 276                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 277     /**                                                                                                  </span>
<span class="-8831229104457932482" onmouseenter="enter('-8831229104457932482');" onmouseout="out('-8831229104457932482');" style=""> 278      * Private method used to retrieve all offers with automaticallyAdded set to true                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 279      *                                                                                                   </span>
<span class="-2057313490179191281" onmouseenter="enter('-2057313490179191281');" onmouseout="out('-2057313490179191281');" style=""> 280      * @return a List of automatic delivery offers                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 281      */                                                                                                  </span>
<span class="-9186908469762752320" onmouseenter="enter('-9186908469762752320');" onmouseout="out('-9186908469762752320');" style=""> 282     protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {                                              </span>
<span class="-2657712449795339218" onmouseenter="enter('-2657712449795339218');" onmouseout="out('-2657712449795339218');" style=""> 283         List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();                         </span>
<span class="-7738403477037597046" onmouseenter="enter('-7738403477037597046');" onmouseout="out('-7738403477037597046');" style=""> 284         return globalOffers;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 285     }                                                                                                    </span>
<span  style=""> 286                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 287     /**                                                                                                  </span>
<span class="-582485916100204765" onmouseenter="enter('-582485916100204765');" onmouseout="out('-582485916100204765');" style=""> 288      * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end           </span>
<span class="-591413864231465226" onmouseenter="enter('-591413864231465226');" onmouseout="out('-591413864231465226');" style=""> 289      * date.  If an offerCode has a later start date, that offerCode will be removed.                    </span>
<span class="-1600892852414517397" onmouseenter="enter('-1600892852414517397');" onmouseout="out('-1600892852414517397');" style=""> 290      * OfferCodes without a start date will still be processed. If the offerCode                         </span>
<span class="-6972954356288154926" onmouseenter="enter('-6972954356288154926');" onmouseout="out('-6972954356288154926');" style=""> 291      * has a end date that has already passed, that offerCode will be removed.  OfferCodes               </span>
<span class="-7007360996659097530" onmouseenter="enter('-7007360996659097530');" onmouseout="out('-7007360996659097530');" style=""> 292      * without a end date will be processed.  The start and end dates on the offer will                  </span>
<span class="-216139196908541615" onmouseenter="enter('-216139196908541615');" onmouseout="out('-216139196908541615');" style=""> 293      * still need to be evaluated.                                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 294      *                                                                                                   </span>
<span class="-142155654396048960" onmouseenter="enter('-142155654396048960');" onmouseout="out('-142155654396048960');" style=""> 295      * @param offerCodes                                                                                 </span>
<span class="-7645314644020819692" onmouseenter="enter('-7645314644020819692');" onmouseout="out('-7645314644020819692');" style=""> 296      * @return a List of non-expired offers                                                              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 297      */                                                                                                  </span>
<span class="3097073257270455619" onmouseenter="enter('3097073257270455619');" onmouseout="out('3097073257270455619');" style=""> 298     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){                     </span>
<span class="-71581284051087612" onmouseenter="enter('-71581284051087612');" onmouseout="out('-71581284051087612');" style=""> 299         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();                                 </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 300         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="4179739580098873664" onmouseenter="enter('4179739580098873664');" onmouseout="out('4179739580098873664');" style=""> 301             if (!offerCode.isActive()){                                                                  </span>
<span class="2973899686965396382" onmouseenter="enter('2973899686965396382');" onmouseout="out('2973899686965396382');" style=""> 302                 offerCodesToRemove.add(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 303             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 304         }                                                                                                </span>
<span class="3113103044265464111" onmouseenter="enter('3113103044265464111');" onmouseout="out('3113103044265464111');" style=""> 305         // remove all offers in the offersToRemove list from original offers list                        </span>
<span class="6883206030034557562" onmouseenter="enter('6883206030034557562');" onmouseout="out('6883206030034557562');" style=""> 306         for (OfferCode offerCode : offerCodesToRemove) {                                                 </span>
<span class="-8473869847996752510" onmouseenter="enter('-8473869847996752510');" onmouseout="out('-8473869847996752510');" style=""> 307             offerCodes.remove(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 308         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 309         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 310     }                                                                                                    </span>
<span  style=""> 311                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 312     /**                                                                                                  </span>
<span class="5637961435104982406" onmouseenter="enter('5637961435104982406');" onmouseout="out('5637961435104982406');" style=""> 313      * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with       </span>
<span class="1724276086246688719" onmouseenter="enter('1724276086246688719');" onmouseout="out('1724276086246688719');" style=""> 314      * current sandbox status.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 315      *                                                                                                   </span>
<span class="202872854140107873" onmouseenter="enter('202872854140107873');" onmouseout="out('202872854140107873');" style=""> 316      * @param order the order to check                                                                   </span>
<span class="2772482249434351691" onmouseenter="enter('2772482249434351691');" onmouseout="out('2772482249434351691');" style=""> 317      * @return the refreshed list of OfferCodes                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 318      */                                                                                                  </span>
<span class="7210051143895905366" onmouseenter="enter('7210051143895905366');" onmouseout="out('7210051143895905366');" style=""> 319     protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {                         </span>
<span class="7464496307728629396" onmouseenter="enter('7464496307728629396');" onmouseout="out('7464496307728629396');" style=""> 320         final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();                              </span>
<span  style=""> 321                                                                                                          </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 322         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 323             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 324             public void execute() {                                                                      </span>
<span class="-6058145000184664425" onmouseenter="enter('-6058145000184664425');" onmouseout="out('-6058145000184664425');" style=""> 325                 for (OfferCode offerCode : orderOfferCodes) {                                            </span>
<span class="-4263515828536000223" onmouseenter="enter('-4263515828536000223');" onmouseout="out('-4263515828536000223');" style=""> 326                     if (offerCode.getOffer() != null) {                                                  </span>
<span class="8507823172595815939" onmouseenter="enter('8507823172595815939');" onmouseout="out('8507823172595815939');" style=""><abbr title=" 327                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 327                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCðŸ”µ</abbr></span>
<span class="-4217337457935304447" onmouseenter="enter('-4217337457935304447');" onmouseout="out('-4217337457935304447');" style=""><abbr title=" 328                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 328                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOfðŸ”µ</abbr></span>
<span class="-6104864632261418874" onmouseenter="enter('-6104864632261418874');" onmouseout="out('-6104864632261418874');" style=""> 329                             em.refresh(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 330                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 331                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 332                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 333             }                                                                                            </span>
<span  style=""> 334                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 335             @Override                                                                                    </span>
<span class="1336357167460974281" onmouseenter="enter('1336357167460974281');" onmouseout="out('1336357167460974281');" style=""> 336             public boolean shouldRetryOnTransactionLockAcquisitionFailure() {                            </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 337                 return true;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 338             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 339         }, RuntimeException.class);                                                                      </span>
<span  style=""> 340                                                                                                          </span>
<span class="720292142172901868" onmouseenter="enter('720292142172901868');" onmouseout="out('720292142172901868');" style=""> 341         return orderOfferCodes;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 342     }                                                                                                    </span>
<span  style=""> 343                                                                                                          </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 344     /*                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 345      *                                                                                                   </span>
<span class="-1078885518483632555" onmouseenter="enter('-1078885518483632555');" onmouseout="out('-1078885518483632555');" style=""> 346      * Offers Logic:                                                                                     </span>
<span class="-6544489594486398439" onmouseenter="enter('-6544489594486398439');" onmouseout="out('-6544489594486398439');" style=""> 347      * 1) Remove all existing offers in the Order (order, item, and fulfillment)                         </span>
<span class="472654013095872963" onmouseenter="enter('472654013095872963');" onmouseout="out('472654013095872963');" style=""> 348      * 2) Check and remove offers                                                                        </span>
<span class="8111384560802328496" onmouseenter="enter('8111384560802328496');" onmouseout="out('8111384560802328496');" style=""> 349      *    a) Remove out of date offers                                                                   </span>
<span class="3025649188866691570" onmouseenter="enter('3025649188866691570');" onmouseout="out('3025649188866691570');" style=""> 350      *    b) Remove offers that do not apply to this customer                                            </span>
<span class="5156402814943015913" onmouseenter="enter('5156402814943015913');" onmouseout="out('5156402814943015913');" style=""> 351      * 3) Loop through offers                                                                            </span>
<span class="6235203245796610706" onmouseenter="enter('6235203245796610706');" onmouseout="out('6235203245796610706');" style=""> 352      *    a) Verifies type of offer (order, order item, fulfillment)                                     </span>
<span class="7315686159335672158" onmouseenter="enter('7315686159335672158');" onmouseout="out('7315686159335672158');" style=""> 353      *    b) Verifies if offer can be applies                                                            </span>
<span class="-6634234506054969031" onmouseenter="enter('-6634234506054969031');" onmouseout="out('-6634234506054969031');" style=""> 354      *    c) Assign offer to type (order, order item, or fulfillment)                                    </span>
<span class="-4584093434328536587" onmouseenter="enter('-4584093434328536587');" onmouseout="out('-4584093434328536587');" style=""> 355      * 4) Sorts the order and item offers list by priority and then discount                             </span>
<span class="-2042995489836168848" onmouseenter="enter('-2042995489836168848');" onmouseout="out('-2042995489836168848');" style=""> 356      * 5) Identify the best offers to apply to order item and create adjustments for each item offer     </span>
<span class="8597383329030492662" onmouseenter="enter('8597383329030492662');" onmouseout="out('8597383329030492662');" style=""><abbr title=" 357      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better"> 357      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is betðŸ”µ</abbr></span>
<span class="-5003028621529242985" onmouseenter="enter('-5003028621529242985');" onmouseout="out('-5003028621529242985');" style=""> 358      * 7) Identify the best offers to apply to the order and create adjustments for each order offer     </span>
<span class="-1324083657955785943" onmouseenter="enter('-1324083657955785943');" onmouseout="out('-1324083657955785943');" style=""><abbr title=" 359      * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 359      * 8) If item contains non-combinable offers remove either the item or order adjustments based on disðŸ”µ</abbr></span>
<span class="-8610949319074908232" onmouseenter="enter('-8610949319074908232');" onmouseout="out('-8610949319074908232');" style=""> 360      * 9) Set final order item prices and reapply order offers                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 361      *                                                                                                   </span>
<span class="9071544830737596533" onmouseenter="enter('9071544830737596533');" onmouseout="out('9071544830737596533');" style=""> 362      * Assumptions:                                                                                      </span>
<span class="7676524731541901514" onmouseenter="enter('7676524731541901514');" onmouseout="out('7676524731541901514');" style=""> 363      * 1) % off all items will be created as an item offer with no expression                            </span>
<span class="-814522364757940962" onmouseenter="enter('-814522364757940962');" onmouseout="out('-814522364757940962');" style=""> 364      * 2) $ off order will be created as an order offer                                                  </span>
<span class="7365449813142531261" onmouseenter="enter('7365449813142531261');" onmouseout="out('7365449813142531261');" style=""> 365      * 3) Order offers applies to the best price for each item (not just retail price)                   </span>
<span class="-1636653647835076359" onmouseenter="enter('-1636653647835076359');" onmouseout="out('-1636653647835076359');" style=""> 366      * 4) Fulfillment offers apply to best price for each item (not just retail price)                   </span>
<span class="-5866280996345915157" onmouseenter="enter('-5866280996345915157');" onmouseout="out('-5866280996345915157');" style=""><abbr title=" 367      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 367      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used witðŸ”µ</abbr></span>
<span class="-8022045642448063338" onmouseenter="enter('-8022045642448063338');" onmouseout="out('-8022045642448063338');" style=""> 368      * 6) Fulfillment offers cannot be not combinable                                                    </span>
<span class="-5108644804585013203" onmouseenter="enter('-5108644804585013203');" onmouseout="out('-5108644804585013203');" style=""> 369      * 7) Order offers cannot be FIXED_PRICE                                                             </span>
<span class="6161153439596163093" onmouseenter="enter('6161153439596163093');" onmouseout="out('6161153439596163093');" style=""> 370      * 8) FIXED_PRICE offers cannot be stackable                                                         </span>
<span class="7044504232316014062" onmouseenter="enter('7044504232316014062');" onmouseout="out('7044504232316014062');" style=""><abbr title=" 371      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 371      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will alðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 372      *                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 373      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 374     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 375     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-4704847871427432866" onmouseenter="enter('-4704847871427432866');" onmouseout="out('-4704847871427432866');" style=""> 376     public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {    </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 377         /*                                                                                               </span>
<span class="-6180845550366984877" onmouseenter="enter('-6180845550366984877');" onmouseout="out('-6180845550366984877');" style=""> 378         TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to </span>
<span class="9161254164549280190" onmouseenter="enter('9161254164549280190');" onmouseout="out('9161254164549280190');" style=""> 379         use a richer object to describe the parameters of the pricing call. This object would include    </span>
<span class="1561516658361300705" onmouseenter="enter('1561516658361300705');" onmouseout="out('1561516658361300705');" style=""> 380         the pricing boolean, but would also include a list of activities to include or exclude in the    </span>
<span class="-6797832594843538707" onmouseenter="enter('-6797832594843538707');" onmouseout="out('-6797832594843538707');" style=""> 381         call - see http://jira.broadleafcommerce.org/browse/BLC-664                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 382          */                                                                                              </span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 383         OfferContext offerContext = OfferContext.getOfferContext();                                      </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 384         if (offerContext == null || offerContext.executePromotionCalculation) {                          </span>
<span class="-2683885994659783076" onmouseenter="enter('-2683885994659783076');" onmouseout="out('-2683885994659783076');" style=""> 385             PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false); </span>
<span class="-9066266687178937853" onmouseenter="enter('-9066266687178937853');" onmouseout="out('-9066266687178937853');" style=""> 386             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());  </span>
<span class="-1421782411503697087" onmouseenter="enter('-1421782411503697087');" onmouseout="out('-1421782411503697087');" style=""> 387             if ((filteredOffers == null) || (filteredOffers.isEmpty())) {                                </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 388                 if (LOG.isTraceEnabled()) {                                                              </span>
<span class="2760579588161124045" onmouseenter="enter('2760579588161124045');" onmouseout="out('2760579588161124045');" style=""> 389                     LOG.trace(&quot;No offers applicable to this order.&quot;);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 390                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 391             } else {                                                                                     </span>
<span class="7300520529047311728" onmouseenter="enter('7300520529047311728');" onmouseout="out('7300520529047311728');" style=""><abbr title=" 392                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 392                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidðŸ”µ</abbr></span>
<span class="-7404348590242143631" onmouseenter="enter('-7404348590242143631');" onmouseout="out('-7404348590242143631');" style=""><abbr title=" 393                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 393                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr></span>
<span  style=""> 394                                                                                                          </span>
<span class="-5526882442984993330" onmouseenter="enter('-5526882442984993330');" onmouseout="out('-5526882442984993330');" style=""><abbr title=" 395                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 395                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, quðŸ”µ</abbr></span>
<span  style=""> 396                                                                                                          </span>
<span class="-6480919216777131248" onmouseenter="enter('-6480919216777131248');" onmouseout="out('-6480919216777131248');" style=""><abbr title=" 397                 if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {                "> 397                 if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {               ðŸ”µ</abbr></span>
<span class="-2723881742436166059" onmouseenter="enter('-2723881742436166059');" onmouseout="out('-2723881742436166059');" style=""><abbr title=" 398                     // At this point, we should have a PromotableOrder that contains PromotableItems each of which"> 398                     // At this point, we should have a PromotableOrder that contains PromotableItems eachðŸ”µ</abbr></span>
<span class="751015906320167144" onmouseenter="enter('751015906320167144');" onmouseout="out('751015906320167144');" style=""> 399                     // has a list of candidatePromotions that might be applied.                          </span>
<span  style=""> 400                                                                                                          </span>
<span class="5941864862011378901" onmouseenter="enter('5941864862011378901');" onmouseout="out('5941864862011378901');" style=""><abbr title=" 401                     // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 401                     // We also have a list of orderOffers that might apply and a list of itemOffers that ðŸ”µ</abbr></span>
<span class="1127078869550353626" onmouseenter="enter('1127078869550353626');" onmouseout="out('1127078869550353626');" style=""><abbr title=" 402                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 402                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 403                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 404             }                                                                                            </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 405             orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                        </span>
<span  style=""> 406                                                                                                          </span>
<span class="514986819999277890" onmouseenter="enter('514986819999277890');" onmouseout="out('514986819999277890');" style=""> 407             verifyAdjustments(order, true);                                                              </span>
<span  style=""> 408                                                                                                          </span>
<span class="-8901364638816691349" onmouseenter="enter('-8901364638816691349');" onmouseout="out('-8901364638816691349');" style=""> 409             order.setSubTotal(order.calculateSubTotal());                                                </span>
<span class="8881079200386597596" onmouseenter="enter('8881079200386597596');" onmouseout="out('8881079200386597596');" style=""> 410             order.finalizeItemPrices();                                                                  </span>
<span  style=""> 411                                                                                                          </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 412             order = orderService.save(order, false);                                                     </span>
<span  style=""> 413                                                                                                          </span>
<span class="-5335273514929397197" onmouseenter="enter('-5335273514929397197');" onmouseout="out('-5335273514929397197');" style=""> 414             boolean madeChange = verifyAdjustments(order, false);                                        </span>
<span class="-3218959195648057803" onmouseenter="enter('-3218959195648057803');" onmouseout="out('-3218959195648057803');" style=""> 415             if (madeChange) {                                                                            </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 416                 order = orderService.save(order, false);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 417             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 418         }                                                                                                </span>
<span  style=""> 419                                                                                                          </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 420         return order;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 421     }                                                                                                    </span>
<span  style=""> 422                                                                                                          </span>
<span class="219209447823395758" onmouseenter="enter('219209447823395758');" onmouseout="out('219209447823395758');" style=""> 423     protected boolean verifyAdjustments(Order order, boolean beforeSave) {                               </span>
<span class="79408939766017075" onmouseenter="enter('79408939766017075');" onmouseout="out('79408939766017075');" style=""> 424         boolean madeChange = false;                                                                      </span>
<span  style=""> 425                                                                                                          </span>
<span class="-8966123689509035198" onmouseenter="enter('-8966123689509035198');" onmouseout="out('-8966123689509035198');" style=""> 426         if (order.getOrderItems() == null) {                                                             </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 427             return madeChange;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 428         }                                                                                                </span>
<span  style=""> 429                                                                                                          </span>
<span class="8447029191885982498" onmouseenter="enter('8447029191885982498');" onmouseout="out('8447029191885982498');" style=""> 430         for (OrderItem oi : order.getOrderItems()) {                                                     </span>
<span class="-5982197742320851056" onmouseenter="enter('-5982197742320851056');" onmouseout="out('-5982197742320851056');" style=""> 431             if (oi.getOrderItemPriceDetails() == null) {                                                 </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 432                 continue;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 433             }                                                                                            </span>
<span  style=""> 434                                                                                                          </span>
<span class="7391296704731194189" onmouseenter="enter('7391296704731194189');" onmouseout="out('7391296704731194189');" style=""> 435             for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {                              </span>
<span class="-8259157388002947293" onmouseenter="enter('-8259157388002947293');" onmouseout="out('-8259157388002947293');" style=""> 436                 if (pd.getOrderItemPriceDetailAdjustments() == null) {                                   </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 437                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 438                 }                                                                                        </span>
<span  style=""> 439                                                                                                          </span>
<span class="-8160497408394725913" onmouseenter="enter('-8160497408394725913');" onmouseout="out('-8160497408394725913');" style=""><abbr title=" 440                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 440                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdðŸ”µ</abbr></span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 441                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 441                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDeðŸ”µ</abbr></span>
<span class="-3008507732031274392" onmouseenter="enter('-3008507732031274392');" onmouseout="out('-3008507732031274392');" style=""> 442                 for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {     </span>
<span class="-1975641521768786423" onmouseenter="enter('-1975641521768786423');" onmouseout="out('-1975641521768786423');" style=""> 443                     if (adjs.containsKey(adj.getOffer().getId())) {                                      </span>
<span class="-6913168070672082713" onmouseenter="enter('-6913168070672082713');" onmouseout="out('-6913168070672082713');" style=""> 444                         adjustmentsToRemove.add(adj);                                                    </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 445                         if (LOG.isDebugEnabled()) {                                                      </span>
<span class="-2834336870885753779" onmouseenter="enter('-2834336870885753779');" onmouseout="out('-2834336870885753779');" style=""> 446                             StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)                 </span>
<span class="201513945492742471" onmouseenter="enter('201513945492742471');" onmouseout="out('201513945492742471');" style=""> 447                                 .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)                   </span>
<span class="2195430440089355634" onmouseenter="enter('2195430440089355634');" onmouseout="out('2195430440089355634');" style=""> 448                                 .append(&quot; with ids &quot;)                                                    </span>
<span class="-3149719647859419210" onmouseenter="enter('-3149719647859419210');" onmouseout="out('-3149719647859419210');" style=""> 449                                 .append(adjs.get(adj.getOffer().getId()).getId())                        </span>
<span class="7312533819175146387" onmouseenter="enter('7312533819175146387');" onmouseout="out('7312533819175146387');" style=""> 450                                 .append(&quot; and &quot;)                                                         </span>
<span class="6832270653349147085" onmouseenter="enter('6832270653349147085');" onmouseout="out('6832270653349147085');" style=""> 451                                 .append(adj.getId());                                                    </span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 452                             LOG.debug(sb.toString());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 453                         }                                                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 454                     } else {                                                                             </span>
<span class="-7759509127049565554" onmouseenter="enter('-7759509127049565554');" onmouseout="out('-7759509127049565554');" style=""> 455                         adjs.put(adj.getOffer().getId(), adj);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 456                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 457                 }                                                                                        </span>
<span  style=""> 458                                                                                                          </span>
<span class="7848730128284985932" onmouseenter="enter('7848730128284985932');" onmouseout="out('7848730128284985932');" style=""> 459                 for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {                         </span>
<span class="6756116260498887863" onmouseenter="enter('6756116260498887863');" onmouseout="out('6756116260498887863');" style=""> 460                     pd.getOrderItemPriceDetailAdjustments().remove(adj);                                 </span>
<span class="5571803755205047298" onmouseenter="enter('5571803755205047298');" onmouseout="out('5571803755205047298');" style=""> 461                     madeChange = true;                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 462                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 463             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 464         }                                                                                                </span>
<span  style=""> 465                                                                                                          </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 466         return madeChange;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 467      }                                                                                                   </span>
<span  style=""> 468                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 469     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 470     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 471     @Deprecated                                                                                          </span>
<span class="-3021599232242429775" onmouseenter="enter('-3021599232242429775');" onmouseout="out('-3021599232242429775');" style=""> 472     public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {            </span>
<span class="-6341015309393843959" onmouseenter="enter('-6341015309393843959');" onmouseout="out('-6341015309393843959');" style=""> 473         applyAndSaveOffersToOrder(offers, order);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 474     }                                                                                                    </span>
<span  style=""> 475                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 476     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 477     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 478     @Deprecated                                                                                          </span>
<span class="-5535279977913938928" onmouseenter="enter('-5535279977913938928');" onmouseout="out('-5535279977913938928');" style=""><abbr title=" 479     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 479     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptiðŸ”µ</abbr></span>
<span class="6394386461467124428" onmouseenter="enter('6394386461467124428');" onmouseout="out('6394386461467124428');" style=""> 480         applyAndSaveFulfillmentGroupOffersToOrder(offers, order);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 481     }                                                                                                    </span>
<span  style=""> 482                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 483     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 484     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="2855881782634007850" onmouseenter="enter('2855881782634007850');" onmouseout="out('2855881782634007850');" style=""><abbr title=" 485     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 485     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricinðŸ”µ</abbr></span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 486         OfferContext offerContext = OfferContext.getOfferContext();                                      </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 487         if (offerContext == null || offerContext.executePromotionCalculation) {                          </span>
<span class="-791836473256513905" onmouseenter="enter('-791836473256513905');" onmouseout="out('-791836473256513905');" style=""> 488             PromotableOrder promotableOrder =                                                            </span>
<span class="-5771222684966163235" onmouseenter="enter('-5771222684966163235');" onmouseout="out('-5771222684966163235');" style=""> 489                     promotableItemFactory.createPromotableOrder(order, true);                            </span>
<span class="-6252467951249219732" onmouseenter="enter('-6252467951249219732');" onmouseout="out('-6252467951249219732');" style=""> 490             List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();                                       </span>
<span class="-8689854403875612694" onmouseenter="enter('-8689854403875612694');" onmouseout="out('-8689854403875612694');" style=""> 491             for (Offer offer : offers) {                                                                 </span>
<span class="3344482016035270743" onmouseenter="enter('3344482016035270743');" onmouseout="out('3344482016035270743');" style=""> 492                 if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {           </span>
<span class="2965579239059640859" onmouseenter="enter('2965579239059640859');" onmouseout="out('2965579239059640859');" style=""> 493                     possibleFGOffers.add(offer);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 494                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 495             }                                                                                            </span>
<span class="7272445213685933500" onmouseenter="enter('7272445213685933500');" onmouseout="out('7272445213685933500');" style=""><abbr title=" 496             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());"> 496             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustðŸ”µ</abbr></span>
<span class="-380250791493510209" onmouseenter="enter('-380250791493510209');" onmouseout="out('-380250791493510209');" style=""><abbr title=" 497             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 497             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCaðŸ”µ</abbr></span>
<span class="5471512156259214352" onmouseenter="enter('5471512156259214352');" onmouseout="out('5471512156259214352');" style=""> 498             for (Offer offer : filteredOffers) {                                                         </span>
<span class="6341701119621727258" onmouseenter="enter('6341701119621727258');" onmouseout="out('6341701119621727258');" style=""><abbr title=" 499                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 499                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifieðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 500             }                                                                                            </span>
<span class="6757974448768463" onmouseenter="enter('6757974448768463');" onmouseout="out('6757974448768463');" style=""> 501             if (!qualifiedFGOffers.isEmpty()) {                                                          </span>
<span class="-3737539762239464744" onmouseenter="enter('-3737539762239464744');" onmouseout="out('-3737539762239464744');" style=""><abbr title=" 502                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);"> 502                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotabðŸ”µ</abbr></span>
<span class="-1748187190347404908" onmouseenter="enter('-1748187190347404908');" onmouseout="out('-1748187190347404908');" style=""> 503                 fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);          </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 504                 orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 505             }                                                                                            </span>
<span  style=""> 506                                                                                                          </span>
<span class="-7204486914274790826" onmouseenter="enter('-7204486914274790826');" onmouseout="out('-7204486914274790826');" style=""> 507             return orderService.save(order, false);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 508         }                                                                                                </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 509         return order;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 510     }                                                                                                    </span>
<span  style=""> 511                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 512     @Override                                                                                            </span>
<span class="-8983195686564092827" onmouseenter="enter('-8983195686564092827');" onmouseout="out('-8983195686564092827');" style=""> 513     public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {                           </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 514 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 515         if (offer.isLimitedUsePerCustomer()) {                                                           </span>
<span class="-3564809625752937907" onmouseenter="enter('-3564809625752937907');" onmouseout="out('-3564809625752937907');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 516             CustomerMaxUsesStrategyType strategy = offer.getMaxUsesStrategyType();                       </span>
<span class="7811178892856243955" onmouseenter="enter('7811178892856243955');" onmouseout="out('7811178892856243955');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 517             boolean checkUsingCustomer = (strategy == null || strategy.equals(CustomerMaxUsesStrategyType.CUSTOMER));"> 517             boolean checkUsingCustomer = (strategy == null || strategy.equals(CustomerMaxUsesStrategyTypeðŸ”µ</abbr></span>
<span class="-4186001467963498158" onmouseenter="enter('-4186001467963498158');" onmouseout="out('-4186001467963498158');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 518             Long currentUses;                                                                            </span>
<span class="943186304180287912" onmouseenter="enter('943186304180287912');" onmouseout="out('943186304180287912');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 519             if (checkUsingCustomer) {                                                                    </span>
<span class="7194263595725243761" onmouseenter="enter('7194263595725243761');" onmouseout="out('7194263595725243761');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 520                 currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 520                 currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), oðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 521             } else {                                                                                     </span>
<span class="5949149386596450267" onmouseenter="enter('5949149386596450267');" onmouseout="out('5949149386596450267');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 522                 currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 522                 currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 523             }                                                                                            </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 524 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525         Customer customer = order.getCustomer();                                                         </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526                                                                                                          </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527         if (offer.isLimitedUsePerCustomer()) {                                                           </span>
<span class="-8305970541390666259" onmouseenter="enter('-8305970541390666259');" onmouseout="out('-8305970541390666259');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 528             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());"> 528             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getIdðŸ”µ</abbr></span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529                                                                                                          </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531                 return false;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533         }                                                                                                </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 534                                                                                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 535         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 536     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 537                                                                                                          </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 538 =======                                                                                                  </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539         Customer customer = order.getCustomer();                                                         </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540                                                                                                          </span>
<span class="5393081257737861323" onmouseenter="enter('5393081257737861323');" onmouseout="out('5393081257737861323');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541         if (customer != null &amp;&amp; customer.isRegistered() &amp;&amp; offer.isLimitedUsePerCustomer()) {            </span>
<span class="-8305970541390666259" onmouseenter="enter('-8305970541390666259');" onmouseout="out('-8305970541390666259');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 542             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());"> 542             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getIdðŸ”µ</abbr></span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 543 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span  style=""> 544                                                                                                          </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 545             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 546                 return false;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 547             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 548         }                                                                                                </span>
<span  style=""> 549                                                                                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 550         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 551     }                                                                                                    </span>
<span  style=""> 552                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 553     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 554     @Override                                                                                            </span>
<span class="4849754295577860926" onmouseenter="enter('4849754295577860926');" onmouseout="out('4849754295577860926');" style=""> 555     public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {                     </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 556         if (offer.isLimitedUsePerCustomer()) {                                                           </span>
<span class="8084739095609490454" onmouseenter="enter('8084739095609490454');" onmouseout="out('8084739095609490454');" style=""> 557             Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());   </span>
<span  style=""> 558                                                                                                          </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 559             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 560                 return false;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 561             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 562         }                                                                                                </span>
<span  style=""> 563                                                                                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 564         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 565     }                                                                                                    </span>
<span  style=""> 566                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 567     @Override                                                                                            </span>
<span class="-4305912419408886648" onmouseenter="enter('-4305912419408886648');" onmouseout="out('-4305912419408886648');" style=""> 568     public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {                        </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 569         boolean underCodeMaxUses = true;                                                                 </span>
<span  style=""> 570                                                                                                          </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 571         if (code.isLimitedUse()) {                                                                       </span>
<span class="-7378740545085856894" onmouseenter="enter('-7378740545085856894');" onmouseout="out('-7378740545085856894');" style=""> 572             Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());            </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 573             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 574         }                                                                                                </span>
<span  style=""> 575                                                                                                          </span>
<span class="5446263071698048925" onmouseenter="enter('5446263071698048925');" onmouseout="out('5446263071698048925');" style=""> 576         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 577     }                                                                                                    </span>
<span  style=""> 578                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 579     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 580     @Override                                                                                            </span>
<span class="135967723667379112" onmouseenter="enter('135967723667379112');" onmouseout="out('135967723667379112');" style=""> 581     public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {                  </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 582         boolean underCodeMaxUses = true;                                                                 </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 583         if (code.isLimitedUse()) {                                                                       </span>
<span class="5487567461678823803" onmouseenter="enter('5487567461678823803');" onmouseout="out('5487567461678823803');" style=""> 584             Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());                   </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 585             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 586         }                                                                                                </span>
<span class="7193079189056024188" onmouseenter="enter('7193079189056024188');" onmouseout="out('7193079189056024188');" style=""> 587         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 588     }                                                                                                    </span>
<span  style=""> 589                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 590     @Override                                                                                            </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 591     @SuppressWarnings(&quot;unchecked&quot;)                                                                       </span>
<span class="-640784293225096821" onmouseenter="enter('-640784293225096821');" onmouseout="out('-640784293225096821');" style=""> 592     public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {                                            </span>
<span class="-348027159212233091" onmouseenter="enter('-348027159212233091');" onmouseout="out('-348027159212233091');" style=""> 593         HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();                                                    </span>
<span  style=""> 594                                                                                                          </span>
<span class="-7949809618309864364" onmouseenter="enter('-7949809618309864364');" onmouseout="out('-7949809618309864364');" style=""> 595         Transformer adjustmentToOfferTransformer = new Transformer() {                                   </span>
<span  style=""> 596                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 597             @Override                                                                                    </span>
<span class="-2718541205900117239" onmouseenter="enter('-2718541205900117239');" onmouseout="out('-2718541205900117239');" style=""> 598             public Object transform(Object input) {                                                      </span>
<span class="4176981446584954696" onmouseenter="enter('4176981446584954696');" onmouseout="out('4176981446584954696');" style=""> 599                 return ((Adjustment)input).getOffer();                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 600             }                                                                                            </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 601         };                                                                                               </span>
<span  style=""> 602                                                                                                          </span>
<span class="-8370514600917699300" onmouseenter="enter('-8370514600917699300');" onmouseout="out('-8370514600917699300');" style=""><abbr title=" 603         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));"> 603         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer))ðŸ”µ</abbr></span>
<span  style=""> 604                                                                                                          </span>
<span class="3897119298100986011" onmouseenter="enter('3897119298100986011');" onmouseout="out('3897119298100986011');" style=""> 605         if (order.getOrderItems() != null) {                                                             </span>
<span class="820796442257070700" onmouseenter="enter('820796442257070700');" onmouseout="out('820796442257070700');" style=""> 606             for (OrderItem item : order.getOrderItems()) {                                               </span>
<span class="722957474719034118" onmouseenter="enter('722957474719034118');" onmouseout="out('722957474719034118');" style=""><abbr title=" 607                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 607                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTrðŸ”µ</abbr></span>
<span  style=""> 608                                                                                                          </span>
<span class="-3519908190158496681" onmouseenter="enter('-3519908190158496681');" onmouseout="out('-3519908190158496681');" style=""> 609                 //record usage for price details on the item as well                                     </span>
<span class="-2952948196187271811" onmouseenter="enter('-2952948196187271811');" onmouseout="out('-2952948196187271811');" style=""> 610                 if (item.getOrderItemPriceDetails() != null) {                                           </span>
<span class="773323050474809935" onmouseenter="enter('773323050474809935');" onmouseout="out('773323050474809935');" style=""> 611                     for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {                </span>
<span class="7134713472391876911" onmouseenter="enter('7134713472391876911');" onmouseout="out('7134713472391876911');" style=""><abbr title=" 612                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 612                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments()ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 613                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 614                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 615             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 616         }                                                                                                </span>
<span  style=""> 617                                                                                                          </span>
<span class="7944520279780748823" onmouseenter="enter('7944520279780748823');" onmouseout="out('7944520279780748823');" style=""> 618         if (order.getFulfillmentGroups() != null) {                                                      </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 619             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                   </span>
<span class="-293187079687761920" onmouseenter="enter('-293187079687761920');" onmouseout="out('-293187079687761920');" style=""><abbr title=" 620                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 620                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 621             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 622         }                                                                                                </span>
<span class="-6419540350677864751" onmouseenter="enter('-6419540350677864751');" onmouseout="out('-6419540350677864751');" style=""> 623         return result;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 624     }                                                                                                    </span>
<span  style=""> 625                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 626     @Override                                                                                            </span>
<span class="-2491837224879773303" onmouseenter="enter('-2491837224879773303');" onmouseout="out('-2491837224879773303');" style=""> 627     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {                             </span>
<span class="-1370687283458217641" onmouseenter="enter('-1370687283458217641');" onmouseout="out('-1370687283458217641');" style=""> 628         return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order)); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 629     }                                                                                                    </span>
<span  style=""> 630                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 631     @Override                                                                                            </span>
<span class="-6407317956511861474" onmouseenter="enter('-6407317956511861474');" onmouseout="out('-6407317956511861474');" style=""><abbr title=" 632     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {"> 632     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffðŸ”µ</abbr></span>
<span class="-4490485247927949218" onmouseenter="enter('-4490485247927949218');" onmouseout="out('-4490485247927949218');" style=""> 633         HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();                  </span>
<span class="983580358500385861" onmouseenter="enter('983580358500385861');" onmouseout="out('983580358500385861');" style=""> 634         for (OfferCode code : codes) {                                                                   </span>
<span class="6305098044991751707" onmouseenter="enter('6305098044991751707');" onmouseout="out('6305098044991751707');" style=""> 635             if (appliedOffers.contains(code.getOffer())) {                                               </span>
<span class="3746501443462939384" onmouseenter="enter('3746501443462939384');" onmouseout="out('3746501443462939384');" style=""> 636                 offerToCodeMapping.put(code.getOffer(), code);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 637             }                                                                                            </span>
<span  style=""> 638                                                                                                          </span>
<span class="-240986298797431748" onmouseenter="enter('-240986298797431748');" onmouseout="out('-240986298797431748');" style=""> 639             List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();                            </span>
<span  style=""> 640                                                                                                          </span>
<span class="7454577566794152811" onmouseenter="enter('7454577566794152811');" onmouseout="out('7454577566794152811');" style=""> 641             extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);   </span>
<span class="-7985615425314556326" onmouseenter="enter('-7985615425314556326');" onmouseout="out('-7985615425314556326');" style=""> 642             for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {                       </span>
<span class="-808811284028256215" onmouseenter="enter('-808811284028256215');" onmouseout="out('-808811284028256215');" style=""> 643                 offerToCodeMapping.put(additionalOfferToBeApplied, code);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 644             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 645         }                                                                                                </span>
<span class="7175253914401568841" onmouseenter="enter('7175253914401568841');" onmouseout="out('7175253914401568841');" style=""> 646         return offerToCodeMapping;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 647     }                                                                                                    </span>
<span  style=""> 648                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 649     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 650     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-1347767159915315738" onmouseenter="enter('-1347767159915315738');" onmouseout="out('-1347767159915315738');" style=""> 651     public Boolean deleteOfferCode(OfferCode code) {                                                     </span>
<span class="-5986603348121186173" onmouseenter="enter('-5986603348121186173');" onmouseout="out('-5986603348121186173');" style=""> 652         if (offerCodeDao.offerCodeIsUsed(code)) {                                                        </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 653             return false;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 654         }                                                                                                </span>
<span  style=""> 655                                                                                                          </span>
<span class="-9122073777393685295" onmouseenter="enter('-9122073777393685295');" onmouseout="out('-9122073777393685295');" style=""> 656         offerCodeDao.delete(code);                                                                       </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 657         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 658     }                                                                                                    </span>
<span  style=""> 659                                                                                                          </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 660     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 661     @Override                                                                                            </span>
<span class="-3816301958562278169" onmouseenter="enter('-3816301958562278169');" onmouseout="out('-3816301958562278169');" style=""> 662     public Offer duplicate(Long originalOfferId) {                                                       </span>
<span class="5769078866234041335" onmouseenter="enter('5769078866234041335');" onmouseout="out('5769078866234041335');" style=""> 663         return duplicator.copy(OfferImpl.class, originalOfferId);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 664     }                                                                                                    </span>
<span  style=""> 665                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 666     @Override                                                                                            </span>
<span class="3228088005821970316" onmouseenter="enter('3228088005821970316');" onmouseout="out('3228088005821970316');" style=""> 667     public CustomerOfferDao getCustomerOfferDao() {                                                      </span>
<span class="-801333879424417122" onmouseenter="enter('-801333879424417122');" onmouseout="out('-801333879424417122');" style=""> 668         return customerOfferDao;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 669     }                                                                                                    </span>
<span  style=""> 670                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 671     @Override                                                                                            </span>
<span class="6308179313298689001" onmouseenter="enter('6308179313298689001');" onmouseout="out('6308179313298689001');" style=""> 672     public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {                                 </span>
<span class="438520929977701037" onmouseenter="enter('438520929977701037');" onmouseout="out('438520929977701037');" style=""> 673         this.customerOfferDao = customerOfferDao;                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 674     }                                                                                                    </span>
<span  style=""> 675                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 676     @Override                                                                                            </span>
<span class="8266606365944954497" onmouseenter="enter('8266606365944954497');" onmouseout="out('8266606365944954497');" style=""> 677     public OfferCodeDao getOfferCodeDao() {                                                              </span>
<span class="-4005874311041664572" onmouseenter="enter('-4005874311041664572');" onmouseout="out('-4005874311041664572');" style=""> 678         return offerCodeDao;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 679     }                                                                                                    </span>
<span  style=""> 680                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 681     @Override                                                                                            </span>
<span class="-5083072655758254890" onmouseenter="enter('-5083072655758254890');" onmouseout="out('-5083072655758254890');" style=""> 682     public void setOfferCodeDao(OfferCodeDao offerCodeDao) {                                             </span>
<span class="-7060255547979502806" onmouseenter="enter('-7060255547979502806');" onmouseout="out('-7060255547979502806');" style=""> 683         this.offerCodeDao = offerCodeDao;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 684     }                                                                                                    </span>
<span  style=""> 685                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 686     @Override                                                                                            </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 687     public OfferDao getOfferDao() {                                                                      </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 688         return offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 689     }                                                                                                    </span>
<span  style=""> 690                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 691     @Override                                                                                            </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 692     public void setOfferDao(OfferDao offerDao) {                                                         </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 693         this.offerDao = offerDao;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 694     }                                                                                                    </span>
<span  style=""> 695                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 696     @Override                                                                                            </span>
<span class="3012408951835963759" onmouseenter="enter('3012408951835963759');" onmouseout="out('3012408951835963759');" style=""> 697     public OrderOfferProcessor getOrderOfferProcessor() {                                                </span>
<span class="-5069105522766505260" onmouseenter="enter('-5069105522766505260');" onmouseout="out('-5069105522766505260');" style=""> 698         return orderOfferProcessor;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 699     }                                                                                                    </span>
<span  style=""> 700                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 701     @Override                                                                                            </span>
<span class="-2542583147665382651" onmouseenter="enter('-2542583147665382651');" onmouseout="out('-2542583147665382651');" style=""> 702     public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {                        </span>
<span class="1533378703496715943" onmouseenter="enter('1533378703496715943');" onmouseout="out('1533378703496715943');" style=""> 703         this.orderOfferProcessor = orderOfferProcessor;                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 704     }                                                                                                    </span>
<span  style=""> 705                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 706     @Override                                                                                            </span>
<span class="1694843298235251985" onmouseenter="enter('1694843298235251985');" onmouseout="out('1694843298235251985');" style=""> 707     public ItemOfferProcessor getItemOfferProcessor() {                                                  </span>
<span class="1583504692330339191" onmouseenter="enter('1583504692330339191');" onmouseout="out('1583504692330339191');" style=""> 708         return itemOfferProcessor;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 709     }                                                                                                    </span>
<span  style=""> 710                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 711     @Override                                                                                            </span>
<span class="145400756853488798" onmouseenter="enter('145400756853488798');" onmouseout="out('145400756853488798');" style=""> 712     public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {                           </span>
<span class="-102405468021411755" onmouseenter="enter('-102405468021411755');" onmouseout="out('-102405468021411755');" style=""> 713         this.itemOfferProcessor = itemOfferProcessor;                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 714     }                                                                                                    </span>
<span  style=""> 715                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 716     @Override                                                                                            </span>
<span class="3022939772369206873" onmouseenter="enter('3022939772369206873');" onmouseout="out('3022939772369206873');" style=""> 717     public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {                          </span>
<span class="-3088775944214719317" onmouseenter="enter('-3088775944214719317');" onmouseout="out('-3088775944214719317');" style=""> 718         return fulfillmentGroupOfferProcessor;                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 719     }                                                                                                    </span>
<span  style=""> 720                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 721     @Override                                                                                            </span>
<span class="-8855456203149015957" onmouseenter="enter('-8855456203149015957');" onmouseout="out('-8855456203149015957');" style=""><abbr title=" 722     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {"> 722     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProðŸ”µ</abbr></span>
<span class="-7108053920330155376" onmouseenter="enter('-7108053920330155376');" onmouseout="out('-7108053920330155376');" style=""> 723         this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 724     }                                                                                                    </span>
<span  style=""> 725                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 726     @Override                                                                                            </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 727     public PromotableItemFactory getPromotableItemFactory() {                                            </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 728         return promotableItemFactory;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 729     }                                                                                                    </span>
<span  style=""> 730                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 731     @Override                                                                                            </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 732     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                  </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 733         this.promotableItemFactory = promotableItemFactory;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 734     }                                                                                                    </span>
<span  style=""> 735                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 736     @Override                                                                                            </span>
<span class="-285725005067991728" onmouseenter="enter('-285725005067991728');" onmouseout="out('-285725005067991728');" style=""> 737     public OfferCode findOfferCodeById(Long id) {                                                        </span>
<span class="4928857363700364693" onmouseenter="enter('4928857363700364693');" onmouseout="out('4928857363700364693');" style=""> 738         return offerCodeDao.readOfferCodeById(id);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 739     }                                                                                                    </span>
<span  style=""> 740                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 741     @Override                                                                                            </span>
<span class="-6829155498814719074" onmouseenter="enter('-6829155498814719074');" onmouseout="out('-6829155498814719074');" style=""> 742     public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {                                   </span>
<span class="-1521639274006709657" onmouseenter="enter('-1521639274006709657');" onmouseout="out('-1521639274006709657');" style=""> 743         return offerCodeDao.readOfferCodesByIds(ids);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 744     }                                                                                                    </span>
<span  style=""> 745                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 746     @Override                                                                                            </span>
<span class="5587340050529616033" onmouseenter="enter('5587340050529616033');" onmouseout="out('5587340050529616033');" style=""> 747     public OrderService getOrderService() {                                                              </span>
<span class="-7558473787756148723" onmouseenter="enter('-7558473787756148723');" onmouseout="out('-7558473787756148723');" style=""> 748         return orderService;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 749     }                                                                                                    </span>
<span  style=""> 750                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 751     @Override                                                                                            </span>
<span class="4536819371590947172" onmouseenter="enter('4536819371590947172');" onmouseout="out('4536819371590947172');" style=""> 752     public void setOrderService(OrderService orderService) {                                             </span>
<span class="7368861914925934250" onmouseenter="enter('7368861914925934250');" onmouseout="out('7368861914925934250');" style=""> 753         this.orderService = orderService;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 754     }                                                                                                    </span>
<span  style=""> 755                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 756     @Override                                                                                            </span>
<span class="-2217088353489190987" onmouseenter="enter('-2217088353489190987');" onmouseout="out('-2217088353489190987');" style=""> 757     public Offer findOfferById(Long offerId) {                                                           </span>
<span class="-5171648678549667040" onmouseenter="enter('-5171648678549667040');" onmouseout="out('-5171648678549667040');" style=""> 758         return offerDao.readOfferById(offerId);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 759     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 760 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18 package org.broadleafcommerce.core.offer.service;                                                        </span>
<span  style="">  19                                                                                                          </span>
<span class="8596464405353709537" onmouseenter="enter('8596464405353709537');" onmouseout="out('8596464405353709537');" style="">  20 import org.apache.commons.collections.CollectionUtils;                                                   </span>
<span class="2953846583056246827" onmouseenter="enter('2953846583056246827');" onmouseout="out('2953846583056246827');" style="">  21 import org.apache.commons.collections.Transformer;                                                       </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  22 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  23 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-2193028153657877676" onmouseenter="enter('-2193028153657877676');" onmouseout="out('-2193028153657877676');" style="">  24 import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;                                 </span>
<span class="-3349026188166660873" onmouseenter="enter('-3349026188166660873');" onmouseout="out('-3349026188166660873');" style="">  25 import org.broadleafcommerce.common.persistence.EntityDuplicator;                                        </span>
<span class="-2818686525334833130" onmouseenter="enter('-2818686525334833130');" onmouseout="out('-2818686525334833130');" style="">  26 import org.broadleafcommerce.common.sandbox.SandBoxHelper;                                               </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  27 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                     </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  28 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                </span>
<span class="6205208880685044389" onmouseenter="enter('6205208880685044389');" onmouseout="out('6205208880685044389');" style="">  29 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;                                            </span>
<span class="-7911436562744873568" onmouseenter="enter('-7911436562744873568');" onmouseout="out('-7911436562744873568');" style="">  30 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;                                                </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  31 import org.broadleafcommerce.core.offer.dao.OfferDao;                                                    </span>
<span class="-1633608357492319903" onmouseenter="enter('-1633608357492319903');" onmouseout="out('-1633608357492319903');" style="">  32 import org.broadleafcommerce.core.offer.domain.Adjustment;                                               </span>
<span class="984981432680799531" onmouseenter="enter('984981432680799531');" onmouseout="out('984981432680799531');" style="">  33 import org.broadleafcommerce.core.offer.domain.CustomerOffer;                                            </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  34 import org.broadleafcommerce.core.offer.domain.Offer;                                                    </span>
<span class="1521662235446319191" onmouseenter="enter('1521662235446319191');" onmouseout="out('1521662235446319191');" style="">  35 import org.broadleafcommerce.core.offer.domain.OfferCode;                                                </span>
<span class="-7025591891527881733" onmouseenter="enter('-7025591891527881733');" onmouseout="out('-7025591891527881733');" style="">  36 import org.broadleafcommerce.core.offer.domain.OfferImpl;                                                </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  37 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                           </span>
<span class="4287099423657810905" onmouseenter="enter('4287099423657810905');" onmouseout="out('4287099423657810905');" style="">  38 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;</span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  39 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;            </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  40 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;           </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                   </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                         </span>
<span class="5713212224635448284" onmouseenter="enter('5713212224635448284');" onmouseout="out('5713212224635448284');" style="">  43 import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;                </span>
<span class="-2454758753718589449" onmouseenter="enter('-2454758753718589449');" onmouseout="out('-2454758753718589449');" style="">  44 import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;                            </span>
<span class="8227287359407176835" onmouseenter="enter('8227287359407176835');" onmouseout="out('8227287359407176835');" style="">  45 import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;                           </span>
<span class="-2230425701287318422" onmouseenter="enter('-2230425701287318422');" onmouseout="out('-2230425701287318422');" style="">  46 import org.broadleafcommerce.core.offer.service.type.CustomerMaxUsesStrategyType;                        </span>
<span class="-5727938558534008634" onmouseenter="enter('-5727938558534008634');" onmouseout="out('-5727938558534008634');" style="">  47 import org.broadleafcommerce.core.offer.service.type.OfferType;                                          </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  48 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                         </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  49 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  50 import org.broadleafcommerce.core.order.domain.OrderItem;                                                </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  51 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                     </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  52 import org.broadleafcommerce.core.order.service.OrderService;                                            </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  53 import org.broadleafcommerce.core.pricing.service.exception.PricingException;                            </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  54 import org.broadleafcommerce.profile.core.domain.Customer;                                               </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  55 import org.springframework.stereotype.Service;                                                           </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  56 import org.springframework.transaction.annotation.Transactional;                                         </span>
<span  style="">  57                                                                                                          </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  58 import java.util.ArrayList;                                                                              </span>
<span class="-112105277767313938" onmouseenter="enter('-112105277767313938');" onmouseout="out('-112105277767313938');" style="">  59 import java.util.Collection;                                                                             </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  60 import java.util.HashMap;                                                                                </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  61 import java.util.HashSet;                                                                                </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  62 import java.util.Iterator;                                                                               </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  63 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  64 import java.util.Map;                                                                                    </span>
<span class="6306724220981822255" onmouseenter="enter('6306724220981822255');" onmouseout="out('6306724220981822255');" style="">  65 import java.util.Objects;                                                                                </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  66 import java.util.Set;                                                                                    </span>
<span  style="">  67                                                                                                          </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  68 import javax.annotation.Resource;                                                                        </span>
<span class="7911938180110628123" onmouseenter="enter('7911938180110628123');" onmouseout="out('7911938180110628123');" style="">  69 import javax.persistence.EntityManager;                                                                  </span>
<span class="3821515051839343306" onmouseenter="enter('3821515051839343306');" onmouseout="out('3821515051839343306');" style="">  70 import javax.persistence.PersistenceContext;                                                             </span>
<span  style="">  71                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  72 /**                                                                                                      </span>
<span class="-2667338179687874348" onmouseenter="enter('-2667338179687874348');" onmouseout="out('-2667338179687874348');" style="">  73  * The Class OfferServiceImpl.                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  74  */                                                                                                      </span>
<span class="504450232350438262" onmouseenter="enter('504450232350438262');" onmouseout="out('504450232350438262');" style="">  75 @Service(&quot;blOfferService&quot;)                                                                               </span>
<span class="6786430150403502423" onmouseenter="enter('6786430150403502423');" onmouseout="out('6786430150403502423');" style="">  76 public class OfferServiceImpl implements OfferService {                                                  </span>
<span  style="">  77                                                                                                          </span>
<span class="8897944981470617719" onmouseenter="enter('8897944981470617719');" onmouseout="out('8897944981470617719');" style="">  78     private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);                            </span>
<span  style="">  79                                                                                                          </span>
<span class="3846751699212951796" onmouseenter="enter('3846751699212951796');" onmouseout="out('3846751699212951796');" style="">  80     // should be called outside of Offer service after Offer service is executed                         </span>
<span class="-5484979233832760683" onmouseenter="enter('-5484979233832760683');" onmouseout="out('-5484979233832760683');" style="">  81     @Resource(name=&quot;blCustomerOfferDao&quot;)                                                                 </span>
<span class="-5771823415174942027" onmouseenter="enter('-5771823415174942027');" onmouseout="out('-5771823415174942027');" style="">  82     protected CustomerOfferDao customerOfferDao;                                                         </span>
<span  style="">  83                                                                                                          </span>
<span class="-1524144969871346405" onmouseenter="enter('-1524144969871346405');" onmouseout="out('-1524144969871346405');" style="">  84     @Resource(name=&quot;blOfferCodeDao&quot;)                                                                     </span>
<span class="-6984238934820524758" onmouseenter="enter('-6984238934820524758');" onmouseout="out('-6984238934820524758');" style="">  85     protected OfferCodeDao offerCodeDao;                                                                 </span>
<span  style="">  86                                                                                                          </span>
<span class="-8247969455122443370" onmouseenter="enter('-8247969455122443370');" onmouseout="out('-8247969455122443370');" style="">  87     @Resource(name=&quot;blOfferAuditService&quot;)                                                                </span>
<span class="-6742419488595856311" onmouseenter="enter('-6742419488595856311');" onmouseout="out('-6742419488595856311');" style="">  88     protected OfferAuditService offerAuditService;                                                       </span>
<span  style="">  89                                                                                                          </span>
<span class="-6976077299079381435" onmouseenter="enter('-6976077299079381435');" onmouseout="out('-6976077299079381435');" style="">  90     @Resource(name=&quot;blOfferDao&quot;)                                                                         </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  91     protected OfferDao offerDao;                                                                         </span>
<span  style="">  92                                                                                                          </span>
<span class="-3191658961867656636" onmouseenter="enter('-3191658961867656636');" onmouseout="out('-3191658961867656636');" style="">  93     @Resource(name=&quot;blOrderOfferProcessor&quot;)                                                              </span>
<span class="-3818126380928091101" onmouseenter="enter('-3818126380928091101');" onmouseout="out('-3818126380928091101');" style="">  94     protected OrderOfferProcessor orderOfferProcessor;                                                   </span>
<span  style="">  95                                                                                                          </span>
<span class="-6223428528083119866" onmouseenter="enter('-6223428528083119866');" onmouseout="out('-6223428528083119866');" style="">  96     @Resource(name=&quot;blItemOfferProcessor&quot;)                                                               </span>
<span class="-7827297227357944415" onmouseenter="enter('-7827297227357944415');" onmouseout="out('-7827297227357944415');" style="">  97     protected ItemOfferProcessor itemOfferProcessor;                                                     </span>
<span  style="">  98                                                                                                          </span>
<span class="-1476654469985531605" onmouseenter="enter('-1476654469985531605');" onmouseout="out('-1476654469985531605');" style="">  99     @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)                                                   </span>
<span class="7634983124983010999" onmouseenter="enter('7634983124983010999');" onmouseout="out('7634983124983010999');" style=""> 100     protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;                             </span>
<span  style=""> 101                                                                                                          </span>
<span class="-4330844585159307437" onmouseenter="enter('-4330844585159307437');" onmouseout="out('-4330844585159307437');" style=""> 102     @Resource(name=&quot;blPromotableItemFactory&quot;)                                                            </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style=""> 103     protected PromotableItemFactory promotableItemFactory;                                               </span>
<span  style=""> 104                                                                                                          </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style=""> 105     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                   </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style=""> 106     protected OfferServiceExtensionManager extensionManager;                                             </span>
<span  style=""> 107                                                                                                          </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 108     @Resource(name = &quot;blOrderService&quot;)                                                                   </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 109     protected OrderService orderService;                                                                 </span>
<span  style=""> 110                                                                                                          </span>
<span class="-3946461589801993391" onmouseenter="enter('-3946461589801993391');" onmouseout="out('-3946461589801993391');" style=""> 111     @Resource(name = &quot;blSandBoxHelper&quot;)                                                                  </span>
<span class="-7799183597372200632" onmouseenter="enter('-7799183597372200632');" onmouseout="out('-7799183597372200632');" style=""> 112     protected SandBoxHelper sandBoxHelper;                                                               </span>
<span  style=""> 113                                                                                                          </span>
<span class="-4259734795637808055" onmouseenter="enter('-4259734795637808055');" onmouseout="out('-4259734795637808055');" style=""> 114     @PersistenceContext(unitName=&quot;blPU&quot;)                                                                 </span>
<span class="-5741815223868414625" onmouseenter="enter('-5741815223868414625');" onmouseout="out('-5741815223868414625');" style=""> 115     protected EntityManager em;                                                                          </span>
<span  style=""> 116                                                                                                          </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 117     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                  </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 118     protected StreamingTransactionCapableUtil transUtil;                                                 </span>
<span  style=""> 119                                                                                                          </span>
<span class="-8384326529234094002" onmouseenter="enter('-8384326529234094002');" onmouseout="out('-8384326529234094002');" style=""> 120     @Resource(name=&quot;blEntityDuplicator&quot;)                                                                 </span>
<span class="-9194612273021432316" onmouseenter="enter('-9194612273021432316');" onmouseout="out('-9194612273021432316');" style=""> 121     protected EntityDuplicator duplicator;                                                               </span>
<span  style=""> 122                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 123     /**                                                                                                  </span>
<span class="-5719913168774156893" onmouseenter="enter('-5719913168774156893');" onmouseout="out('-5719913168774156893');" style=""> 124      * @deprecated Add {@link EntityDuplicateModifier}s to {@code blEntityDuplicationHelpers}            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 125      */                                                                                                  </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 126     @Deprecated                                                                                          </span>
<span class="8658910844320022950" onmouseenter="enter('8658910844320022950');" onmouseout="out('8658910844320022950');" style=""> 127     protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;                                     </span>
<span  style=""> 128                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 129     @Override                                                                                            </span>
<span class="-2033305286790048708" onmouseenter="enter('-2033305286790048708');" onmouseout="out('-2033305286790048708');" style=""> 130     public List&lt;Offer&gt; findAllOffers() {                                                                 </span>
<span class="2132174063530273788" onmouseenter="enter('2132174063530273788');" onmouseout="out('2132174063530273788');" style=""> 131         return offerDao.readAllOffers();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 132     }                                                                                                    </span>
<span  style=""> 133                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 134     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 135     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="7144811092176845141" onmouseenter="enter('7144811092176845141');" onmouseout="out('7144811092176845141');" style=""> 136     public Offer save(Offer offer) {                                                                     </span>
<span class="-264708178039771798" onmouseenter="enter('-264708178039771798');" onmouseout="out('-264708178039771798');" style=""> 137         return offerDao.save(offer);                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 138     }                                                                                                    </span>
<span  style=""> 139                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 140     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 141     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-5514670765130856091" onmouseenter="enter('-5514670765130856091');" onmouseout="out('-5514670765130856091');" style=""> 142     public OfferCode saveOfferCode(OfferCode offerCode) {                                                </span>
<span class="3125778008044685658" onmouseenter="enter('3125778008044685658');" onmouseout="out('3125778008044685658');" style=""> 143         offerCode.setOffer(offerDao.save(offerCode.getOffer()));                                         </span>
<span class="6906137479190051982" onmouseenter="enter('6906137479190051982');" onmouseout="out('6906137479190051982');" style=""> 144         return offerCodeDao.save(offerCode);                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 145     }                                                                                                    </span>
<span  style=""> 146                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 147     /**                                                                                                  </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""><abbr title=" 148      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 148      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr></span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""><abbr title=" 149      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 149      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr></span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 150      * cannot appear more than once in the list.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 151      *                                                                                                   </span>
<span class="-709313334493645866" onmouseenter="enter('-709313334493645866');" onmouseout="out('-709313334493645866');" style=""> 152      * @param code                                                                                       </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 153      * @return a List of offers that may apply to this order                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 154      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 155     @Override                                                                                            </span>
<span class="-6840847083603451180" onmouseenter="enter('-6840847083603451180');" onmouseout="out('-6840847083603451180');" style=""> 156     public Offer lookupOfferByCode(String code) {                                                        </span>
<span class="-531732708503781646" onmouseenter="enter('-531732708503781646');" onmouseout="out('-531732708503781646');" style=""> 157         Offer offer = null;                                                                              </span>
<span class="-8218576552188075283" onmouseenter="enter('-8218576552188075283');" onmouseout="out('-8218576552188075283');" style=""> 158         OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);                                    </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 159         if (offerCode != null) {                                                                         </span>
<span class="-2561785727340284423" onmouseenter="enter('-2561785727340284423');" onmouseout="out('-2561785727340284423');" style=""> 160             offer = offerCode.getOffer();                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161         }                                                                                                </span>
<span class="-8963791522625561917" onmouseenter="enter('-8963791522625561917');" onmouseout="out('-8963791522625561917');" style=""> 162         return offer;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 163     }                                                                                                    </span>
<span  style=""> 164                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 165     @Override                                                                                            </span>
<span class="2883322601430833612" onmouseenter="enter('2883322601430833612');" onmouseout="out('2883322601430833612');" style=""> 166     public OfferCode lookupOfferCodeByCode(String code){                                                 </span>
<span class="8795189428566002896" onmouseenter="enter('8795189428566002896');" onmouseout="out('8795189428566002896');" style=""> 167         return offerCodeDao.readOfferCodeByCode(code);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 168     }                                                                                                    </span>
<span  style=""> 169                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 170     @Override                                                                                            </span>
<span class="-2543778591938191529" onmouseenter="enter('-2543778591938191529');" onmouseout="out('-2543778591938191529');" style=""> 171     public List&lt;Offer&gt; lookupAllOffersByCode(String code) {                                              </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 172         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                     </span>
<span class="-3360697953765841703" onmouseenter="enter('-3360697953765841703');" onmouseout="out('-3360697953765841703');" style=""> 173         List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);                         </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 174         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 175             if (offerCode != null) {                                                                     </span>
<span class="-7816274075460376657" onmouseenter="enter('-7816274075460376657');" onmouseout="out('-7816274075460376657');" style=""> 176                 offers.add(offerCode.getOffer());                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 177             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 178         }                                                                                                </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 179         return offers;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180     }                                                                                                    </span>
<span  style=""> 181                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 182     @Override                                                                                            </span>
<span class="4676855439599320404" onmouseenter="enter('4676855439599320404');" onmouseout="out('4676855439599320404');" style=""> 183     public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){                                       </span>
<span class="-4234235759448675045" onmouseenter="enter('-4234235759448675045');" onmouseout="out('-4234235759448675045');" style=""> 184         return offerCodeDao.readAllOfferCodesByCode(code);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 185     }                                                                                                    </span>
<span  style=""> 186                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 187     /**                                                                                                  </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""><abbr title=" 188      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 188      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr></span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""><abbr title=" 189      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 189      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr></span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 190      * cannot appear more than once in the list.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 191      *                                                                                                   </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 192      * @param order                                                                                      </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 193      * @return a List of offers that may apply to this order                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 194      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 195     @Override                                                                                            </span>
<span class="-5814298891852821500" onmouseenter="enter('-5814298891852821500');" onmouseout="out('-5814298891852821500');" style=""> 196     public List&lt;Offer&gt; buildOfferListForOrder(Order order) {                                             </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 197         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                     </span>
<span class="-3235900677601494398" onmouseenter="enter('-3235900677601494398');" onmouseout="out('-3235900677601494398');" style=""> 198         List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());         </span>
<span class="7699769166343685501" onmouseenter="enter('7699769166343685501');" onmouseout="out('7699769166343685501');" style=""> 199         for (CustomerOffer customerOffer : customerOffers) {                                             </span>
<span class="-2310400538171319838" onmouseenter="enter('-2310400538171319838');" onmouseout="out('-2310400538171319838');" style=""> 200             if (!offers.contains(customerOffer.getOffer())) {                                            </span>
<span class="5233078073066950969" onmouseenter="enter('5233078073066950969');" onmouseout="out('5233078073066950969');" style=""> 201                 offers.add(customerOffer.getOffer());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 202             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 203         }                                                                                                </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style=""> 204         List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                          </span>
<span class="-6665865767746694239" onmouseenter="enter('-6665865767746694239');" onmouseout="out('-6665865767746694239');" style=""> 205         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                    </span>
<span class="2682597879629079185" onmouseenter="enter('2682597879629079185');" onmouseout="out('2682597879629079185');" style=""> 206         for (OfferCode orderOfferCode : orderOfferCodes) {                                               </span>
<span class="-1857624084667800558" onmouseenter="enter('-1857624084667800558');" onmouseout="out('-1857624084667800558');" style=""> 207             if (!offers.contains(orderOfferCode.getOffer())) {                                           </span>
<span class="4188766124804405127" onmouseenter="enter('4188766124804405127');" onmouseout="out('4188766124804405127');" style=""> 208                 offers.add(orderOfferCode.getOffer());                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 209             }                                                                                            </span>
<span class="-4468546552745233084" onmouseenter="enter('-4468546552745233084');" onmouseout="out('-4468546552745233084');" style=""> 210             extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 211         }                                                                                                </span>
<span class="-9188634082558155234" onmouseenter="enter('-9188634082558155234');" onmouseout="out('-9188634082558155234');" style=""> 212         List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();                                      </span>
<span class="-8411171878687156520" onmouseenter="enter('-8411171878687156520');" onmouseout="out('-8411171878687156520');" style=""> 213         for (Offer globalOffer : globalOffers) {                                                         </span>
<span class="2071278729839157974" onmouseenter="enter('2071278729839157974');" onmouseout="out('2071278729839157974');" style=""> 214             if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {  </span>
<span class="-3050025518373868772" onmouseenter="enter('-3050025518373868772');" onmouseout="out('-3050025518373868772');" style=""> 215                 offers.add(globalOffer);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 216             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 217         }                                                                                                </span>
<span  style=""> 218                                                                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 219         if (extensionManager != null) {                                                                  </span>
<span class="1817402996237899777" onmouseenter="enter('1817402996237899777');" onmouseout="out('1817402996237899777');" style=""> 220             extensionManager.applyAdditionalFilters(offers, order);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 221         }                                                                                                </span>
<span  style=""> 222                                                                                                          </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 223         return offers;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 224     }                                                                                                    </span>
<span  style=""> 225                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 226     @Override                                                                                            </span>
<span class="2056305643902587707" onmouseenter="enter('2056305643902587707');" onmouseout="out('2056305643902587707');" style=""> 227     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {                                  </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 228         Customer customer = order.getCustomer();                                                         </span>
<span class="-5041998041456755776" onmouseenter="enter('-5041998041456755776');" onmouseout="out('-5041998041456755776');" style=""> 229         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();                                             </span>
<span  style=""> 230                                                                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 231         if (extensionManager != null) {                                                                  </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 232             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 233         }                                                                                                </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 234         if (!offerCodes.isEmpty()) {                                                                     </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 235             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                             </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 236             while (itr.hasNext()) {                                                                      </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 237                 OfferCode offerCode = itr.next();                                                        </span>
<span class="-776136422183497161" onmouseenter="enter('-776136422183497161');" onmouseout="out('-776136422183497161');" style=""> 238                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {       </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 239                     itr.remove();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 240                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 241             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 242         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 243         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 244     }                                                                                                    </span>
<span  style=""> 245                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 246     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 247     @Override                                                                                            </span>
<span class="3843851677430304310" onmouseenter="enter('3843851677430304310');" onmouseout="out('3843851677430304310');" style=""> 248     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {                            </span>
<span class="-6957816096303048614" onmouseenter="enter('-6957816096303048614');" onmouseout="out('-6957816096303048614');" style=""> 249         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 250         if (extensionManager != null) {                                                                  </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 251             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 252         }                                                                                                </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 253         if (!offerCodes.isEmpty()) {                                                                     </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 254             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                             </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 255             while (itr.hasNext()) {                                                                      </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 256                 OfferCode offerCode = itr.next();                                                        </span>
<span class="6086018267170409432" onmouseenter="enter('6086018267170409432');" onmouseout="out('6086018267170409432');" style=""> 257                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {    </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 258                     itr.remove();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 259                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 260             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 261         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 262         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 263     }                                                                                                    </span>
<span  style=""> 264                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 265     /**                                                                                                  </span>
<span class="2837560355574155003" onmouseenter="enter('2837560355574155003');" onmouseout="out('2837560355574155003');" style=""> 266      * Private method used to retrieve all offers assigned to this customer.  These offers are           </span>
<span class="4852710310174118924" onmouseenter="enter('4852710310174118924');" onmouseout="out('4852710310174118924');" style=""> 267      * programmatically assigned to the customer.                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 268      *                                                                                                   </span>
<span class="1094425505394812731" onmouseenter="enter('1094425505394812731');" onmouseout="out('1094425505394812731');" style=""> 269      * @param customer                                                                                   </span>
<span class="-3868237647402015492" onmouseenter="enter('-3868237647402015492');" onmouseout="out('-3868237647402015492');" style=""> 270      * @return a List of offers assigned to the customer                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 271      */                                                                                                  </span>
<span class="-1064959765029423996" onmouseenter="enter('-1064959765029423996');" onmouseout="out('-1064959765029423996');" style=""> 272     protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {                     </span>
<span class="1699675085073278700" onmouseenter="enter('1699675085073278700');" onmouseout="out('1699675085073278700');" style=""> 273         List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);    </span>
<span class="5611761187435301880" onmouseenter="enter('5611761187435301880');" onmouseout="out('5611761187435301880');" style=""> 274         return offerCustomers;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 275     }                                                                                                    </span>
<span  style=""> 276                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 277     /**                                                                                                  </span>
<span class="-8831229104457932482" onmouseenter="enter('-8831229104457932482');" onmouseout="out('-8831229104457932482');" style=""> 278      * Private method used to retrieve all offers with automaticallyAdded set to true                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 279      *                                                                                                   </span>
<span class="-2057313490179191281" onmouseenter="enter('-2057313490179191281');" onmouseout="out('-2057313490179191281');" style=""> 280      * @return a List of automatic delivery offers                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 281      */                                                                                                  </span>
<span class="-9186908469762752320" onmouseenter="enter('-9186908469762752320');" onmouseout="out('-9186908469762752320');" style=""> 282     protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {                                              </span>
<span class="-2657712449795339218" onmouseenter="enter('-2657712449795339218');" onmouseout="out('-2657712449795339218');" style=""> 283         List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();                         </span>
<span class="-7738403477037597046" onmouseenter="enter('-7738403477037597046');" onmouseout="out('-7738403477037597046');" style=""> 284         return globalOffers;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 285     }                                                                                                    </span>
<span  style=""> 286                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 287     /**                                                                                                  </span>
<span class="-582485916100204765" onmouseenter="enter('-582485916100204765');" onmouseout="out('-582485916100204765');" style=""> 288      * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end           </span>
<span class="-591413864231465226" onmouseenter="enter('-591413864231465226');" onmouseout="out('-591413864231465226');" style=""> 289      * date.  If an offerCode has a later start date, that offerCode will be removed.                    </span>
<span class="-1600892852414517397" onmouseenter="enter('-1600892852414517397');" onmouseout="out('-1600892852414517397');" style=""> 290      * OfferCodes without a start date will still be processed. If the offerCode                         </span>
<span class="-6972954356288154926" onmouseenter="enter('-6972954356288154926');" onmouseout="out('-6972954356288154926');" style=""> 291      * has a end date that has already passed, that offerCode will be removed.  OfferCodes               </span>
<span class="-7007360996659097530" onmouseenter="enter('-7007360996659097530');" onmouseout="out('-7007360996659097530');" style=""> 292      * without a end date will be processed.  The start and end dates on the offer will                  </span>
<span class="-216139196908541615" onmouseenter="enter('-216139196908541615');" onmouseout="out('-216139196908541615');" style=""> 293      * still need to be evaluated.                                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 294      *                                                                                                   </span>
<span class="-142155654396048960" onmouseenter="enter('-142155654396048960');" onmouseout="out('-142155654396048960');" style=""> 295      * @param offerCodes                                                                                 </span>
<span class="-7645314644020819692" onmouseenter="enter('-7645314644020819692');" onmouseout="out('-7645314644020819692');" style=""> 296      * @return a List of non-expired offers                                                              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 297      */                                                                                                  </span>
<span class="3097073257270455619" onmouseenter="enter('3097073257270455619');" onmouseout="out('3097073257270455619');" style=""> 298     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){                     </span>
<span class="-71581284051087612" onmouseenter="enter('-71581284051087612');" onmouseout="out('-71581284051087612');" style=""> 299         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();                                 </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 300         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="4179739580098873664" onmouseenter="enter('4179739580098873664');" onmouseout="out('4179739580098873664');" style=""> 301             if (!offerCode.isActive()){                                                                  </span>
<span class="2973899686965396382" onmouseenter="enter('2973899686965396382');" onmouseout="out('2973899686965396382');" style=""> 302                 offerCodesToRemove.add(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 303             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 304         }                                                                                                </span>
<span class="3113103044265464111" onmouseenter="enter('3113103044265464111');" onmouseout="out('3113103044265464111');" style=""> 305         // remove all offers in the offersToRemove list from original offers list                        </span>
<span class="6883206030034557562" onmouseenter="enter('6883206030034557562');" onmouseout="out('6883206030034557562');" style=""> 306         for (OfferCode offerCode : offerCodesToRemove) {                                                 </span>
<span class="-8473869847996752510" onmouseenter="enter('-8473869847996752510');" onmouseout="out('-8473869847996752510');" style=""> 307             offerCodes.remove(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 308         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 309         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 310     }                                                                                                    </span>
<span  style=""> 311                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 312     /**                                                                                                  </span>
<span class="5637961435104982406" onmouseenter="enter('5637961435104982406');" onmouseout="out('5637961435104982406');" style=""> 313      * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with       </span>
<span class="1724276086246688719" onmouseenter="enter('1724276086246688719');" onmouseout="out('1724276086246688719');" style=""> 314      * current sandbox status.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 315      *                                                                                                   </span>
<span class="202872854140107873" onmouseenter="enter('202872854140107873');" onmouseout="out('202872854140107873');" style=""> 316      * @param order the order to check                                                                   </span>
<span class="2772482249434351691" onmouseenter="enter('2772482249434351691');" onmouseout="out('2772482249434351691');" style=""> 317      * @return the refreshed list of OfferCodes                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 318      */                                                                                                  </span>
<span class="7210051143895905366" onmouseenter="enter('7210051143895905366');" onmouseout="out('7210051143895905366');" style=""> 319     protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {                         </span>
<span class="7464496307728629396" onmouseenter="enter('7464496307728629396');" onmouseout="out('7464496307728629396');" style=""> 320         final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();                              </span>
<span  style=""> 321                                                                                                          </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 322         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 323             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 324             public void execute() {                                                                      </span>
<span class="-6058145000184664425" onmouseenter="enter('-6058145000184664425');" onmouseout="out('-6058145000184664425');" style=""> 325                 for (OfferCode offerCode : orderOfferCodes) {                                            </span>
<span class="-4263515828536000223" onmouseenter="enter('-4263515828536000223');" onmouseout="out('-4263515828536000223');" style=""> 326                     if (offerCode.getOffer() != null) {                                                  </span>
<span class="8507823172595815939" onmouseenter="enter('8507823172595815939');" onmouseout="out('8507823172595815939');" style=""><abbr title=" 327                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 327                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCðŸ”µ</abbr></span>
<span class="-4217337457935304447" onmouseenter="enter('-4217337457935304447');" onmouseout="out('-4217337457935304447');" style=""><abbr title=" 328                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 328                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOfðŸ”µ</abbr></span>
<span class="-6104864632261418874" onmouseenter="enter('-6104864632261418874');" onmouseout="out('-6104864632261418874');" style=""> 329                             em.refresh(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 330                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 331                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 332                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 333             }                                                                                            </span>
<span  style=""> 334                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 335             @Override                                                                                    </span>
<span class="1336357167460974281" onmouseenter="enter('1336357167460974281');" onmouseout="out('1336357167460974281');" style=""> 336             public boolean shouldRetryOnTransactionLockAcquisitionFailure() {                            </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 337                 return true;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 338             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 339         }, RuntimeException.class);                                                                      </span>
<span  style=""> 340                                                                                                          </span>
<span class="720292142172901868" onmouseenter="enter('720292142172901868');" onmouseout="out('720292142172901868');" style=""> 341         return orderOfferCodes;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 342     }                                                                                                    </span>
<span  style=""> 343                                                                                                          </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 344     /*                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 345      *                                                                                                   </span>
<span class="-1078885518483632555" onmouseenter="enter('-1078885518483632555');" onmouseout="out('-1078885518483632555');" style=""> 346      * Offers Logic:                                                                                     </span>
<span class="-6544489594486398439" onmouseenter="enter('-6544489594486398439');" onmouseout="out('-6544489594486398439');" style=""> 347      * 1) Remove all existing offers in the Order (order, item, and fulfillment)                         </span>
<span class="472654013095872963" onmouseenter="enter('472654013095872963');" onmouseout="out('472654013095872963');" style=""> 348      * 2) Check and remove offers                                                                        </span>
<span class="8111384560802328496" onmouseenter="enter('8111384560802328496');" onmouseout="out('8111384560802328496');" style=""> 349      *    a) Remove out of date offers                                                                   </span>
<span class="3025649188866691570" onmouseenter="enter('3025649188866691570');" onmouseout="out('3025649188866691570');" style=""> 350      *    b) Remove offers that do not apply to this customer                                            </span>
<span class="5156402814943015913" onmouseenter="enter('5156402814943015913');" onmouseout="out('5156402814943015913');" style=""> 351      * 3) Loop through offers                                                                            </span>
<span class="6235203245796610706" onmouseenter="enter('6235203245796610706');" onmouseout="out('6235203245796610706');" style=""> 352      *    a) Verifies type of offer (order, order item, fulfillment)                                     </span>
<span class="7315686159335672158" onmouseenter="enter('7315686159335672158');" onmouseout="out('7315686159335672158');" style=""> 353      *    b) Verifies if offer can be applies                                                            </span>
<span class="-6634234506054969031" onmouseenter="enter('-6634234506054969031');" onmouseout="out('-6634234506054969031');" style=""> 354      *    c) Assign offer to type (order, order item, or fulfillment)                                    </span>
<span class="-4584093434328536587" onmouseenter="enter('-4584093434328536587');" onmouseout="out('-4584093434328536587');" style=""> 355      * 4) Sorts the order and item offers list by priority and then discount                             </span>
<span class="-2042995489836168848" onmouseenter="enter('-2042995489836168848');" onmouseout="out('-2042995489836168848');" style=""> 356      * 5) Identify the best offers to apply to order item and create adjustments for each item offer     </span>
<span class="8597383329030492662" onmouseenter="enter('8597383329030492662');" onmouseout="out('8597383329030492662');" style=""><abbr title=" 357      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better"> 357      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is betðŸ”µ</abbr></span>
<span class="-5003028621529242985" onmouseenter="enter('-5003028621529242985');" onmouseout="out('-5003028621529242985');" style=""> 358      * 7) Identify the best offers to apply to the order and create adjustments for each order offer     </span>
<span class="-1324083657955785943" onmouseenter="enter('-1324083657955785943');" onmouseout="out('-1324083657955785943');" style=""><abbr title=" 359      * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 359      * 8) If item contains non-combinable offers remove either the item or order adjustments based on disðŸ”µ</abbr></span>
<span class="-8610949319074908232" onmouseenter="enter('-8610949319074908232');" onmouseout="out('-8610949319074908232');" style=""> 360      * 9) Set final order item prices and reapply order offers                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 361      *                                                                                                   </span>
<span class="9071544830737596533" onmouseenter="enter('9071544830737596533');" onmouseout="out('9071544830737596533');" style=""> 362      * Assumptions:                                                                                      </span>
<span class="7676524731541901514" onmouseenter="enter('7676524731541901514');" onmouseout="out('7676524731541901514');" style=""> 363      * 1) % off all items will be created as an item offer with no expression                            </span>
<span class="-814522364757940962" onmouseenter="enter('-814522364757940962');" onmouseout="out('-814522364757940962');" style=""> 364      * 2) $ off order will be created as an order offer                                                  </span>
<span class="7365449813142531261" onmouseenter="enter('7365449813142531261');" onmouseout="out('7365449813142531261');" style=""> 365      * 3) Order offers applies to the best price for each item (not just retail price)                   </span>
<span class="-1636653647835076359" onmouseenter="enter('-1636653647835076359');" onmouseout="out('-1636653647835076359');" style=""> 366      * 4) Fulfillment offers apply to best price for each item (not just retail price)                   </span>
<span class="-5866280996345915157" onmouseenter="enter('-5866280996345915157');" onmouseout="out('-5866280996345915157');" style=""><abbr title=" 367      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 367      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used witðŸ”µ</abbr></span>
<span class="-8022045642448063338" onmouseenter="enter('-8022045642448063338');" onmouseout="out('-8022045642448063338');" style=""> 368      * 6) Fulfillment offers cannot be not combinable                                                    </span>
<span class="-5108644804585013203" onmouseenter="enter('-5108644804585013203');" onmouseout="out('-5108644804585013203');" style=""> 369      * 7) Order offers cannot be FIXED_PRICE                                                             </span>
<span class="6161153439596163093" onmouseenter="enter('6161153439596163093');" onmouseout="out('6161153439596163093');" style=""> 370      * 8) FIXED_PRICE offers cannot be stackable                                                         </span>
<span class="7044504232316014062" onmouseenter="enter('7044504232316014062');" onmouseout="out('7044504232316014062');" style=""><abbr title=" 371      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 371      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will alðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 372      *                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 373      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 374     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 375     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-4704847871427432866" onmouseenter="enter('-4704847871427432866');" onmouseout="out('-4704847871427432866');" style=""> 376     public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {    </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 377         /*                                                                                               </span>
<span class="-6180845550366984877" onmouseenter="enter('-6180845550366984877');" onmouseout="out('-6180845550366984877');" style=""> 378         TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to </span>
<span class="9161254164549280190" onmouseenter="enter('9161254164549280190');" onmouseout="out('9161254164549280190');" style=""> 379         use a richer object to describe the parameters of the pricing call. This object would include    </span>
<span class="1561516658361300705" onmouseenter="enter('1561516658361300705');" onmouseout="out('1561516658361300705');" style=""> 380         the pricing boolean, but would also include a list of activities to include or exclude in the    </span>
<span class="-6797832594843538707" onmouseenter="enter('-6797832594843538707');" onmouseout="out('-6797832594843538707');" style=""> 381         call - see http://jira.broadleafcommerce.org/browse/BLC-664                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 382          */                                                                                              </span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 383         OfferContext offerContext = OfferContext.getOfferContext();                                      </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 384         if (offerContext == null || offerContext.executePromotionCalculation) {                          </span>
<span class="-2683885994659783076" onmouseenter="enter('-2683885994659783076');" onmouseout="out('-2683885994659783076');" style=""> 385             PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false); </span>
<span class="-9066266687178937853" onmouseenter="enter('-9066266687178937853');" onmouseout="out('-9066266687178937853');" style=""> 386             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());  </span>
<span class="-1421782411503697087" onmouseenter="enter('-1421782411503697087');" onmouseout="out('-1421782411503697087');" style=""> 387             if ((filteredOffers == null) || (filteredOffers.isEmpty())) {                                </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 388                 if (LOG.isTraceEnabled()) {                                                              </span>
<span class="2760579588161124045" onmouseenter="enter('2760579588161124045');" onmouseout="out('2760579588161124045');" style=""> 389                     LOG.trace(&quot;No offers applicable to this order.&quot;);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 390                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 391             } else {                                                                                     </span>
<span class="7300520529047311728" onmouseenter="enter('7300520529047311728');" onmouseout="out('7300520529047311728');" style=""><abbr title=" 392                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 392                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidðŸ”µ</abbr></span>
<span class="-7404348590242143631" onmouseenter="enter('-7404348590242143631');" onmouseout="out('-7404348590242143631');" style=""><abbr title=" 393                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 393                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr></span>
<span  style=""> 394                                                                                                          </span>
<span class="-5526882442984993330" onmouseenter="enter('-5526882442984993330');" onmouseout="out('-5526882442984993330');" style=""><abbr title=" 395                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 395                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, quðŸ”µ</abbr></span>
<span  style=""> 396                                                                                                          </span>
<span class="-6480919216777131248" onmouseenter="enter('-6480919216777131248');" onmouseout="out('-6480919216777131248');" style=""> 397                 if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {               </span>
<span class="-2723881742436166059" onmouseenter="enter('-2723881742436166059');" onmouseout="out('-2723881742436166059');" style=""><abbr title=" 398                     // At this point, we should have a PromotableOrder that contains PromotableItems each of which"> 398                     // At this point, we should have a PromotableOrder that contains PromotableItems eachðŸ”µ</abbr></span>
<span class="751015906320167144" onmouseenter="enter('751015906320167144');" onmouseout="out('751015906320167144');" style=""> 399                     // has a list of candidatePromotions that might be applied.                          </span>
<span  style=""> 400                                                                                                          </span>
<span class="5941864862011378901" onmouseenter="enter('5941864862011378901');" onmouseout="out('5941864862011378901');" style=""><abbr title=" 401                     // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 401                     // We also have a list of orderOffers that might apply and a list of itemOffers that ðŸ”µ</abbr></span>
<span class="1127078869550353626" onmouseenter="enter('1127078869550353626');" onmouseout="out('1127078869550353626');" style=""><abbr title=" 402                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 402                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 403                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 404             }                                                                                            </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 405             orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                        </span>
<span  style=""> 406                                                                                                          </span>
<span class="514986819999277890" onmouseenter="enter('514986819999277890');" onmouseout="out('514986819999277890');" style=""> 407             verifyAdjustments(order, true);                                                              </span>
<span  style=""> 408                                                                                                          </span>
<span class="-8901364638816691349" onmouseenter="enter('-8901364638816691349');" onmouseout="out('-8901364638816691349');" style=""> 409             order.setSubTotal(order.calculateSubTotal());                                                </span>
<span class="8881079200386597596" onmouseenter="enter('8881079200386597596');" onmouseout="out('8881079200386597596');" style=""> 410             order.finalizeItemPrices();                                                                  </span>
<span  style=""> 411                                                                                                          </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 412             order = orderService.save(order, false);                                                     </span>
<span  style=""> 413                                                                                                          </span>
<span class="-5335273514929397197" onmouseenter="enter('-5335273514929397197');" onmouseout="out('-5335273514929397197');" style=""> 414             boolean madeChange = verifyAdjustments(order, false);                                        </span>
<span class="-3218959195648057803" onmouseenter="enter('-3218959195648057803');" onmouseout="out('-3218959195648057803');" style=""> 415             if (madeChange) {                                                                            </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 416                 order = orderService.save(order, false);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 417             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 418         }                                                                                                </span>
<span  style=""> 419                                                                                                          </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 420         return order;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 421     }                                                                                                    </span>
<span  style=""> 422                                                                                                          </span>
<span class="219209447823395758" onmouseenter="enter('219209447823395758');" onmouseout="out('219209447823395758');" style=""> 423     protected boolean verifyAdjustments(Order order, boolean beforeSave) {                               </span>
<span class="79408939766017075" onmouseenter="enter('79408939766017075');" onmouseout="out('79408939766017075');" style=""> 424         boolean madeChange = false;                                                                      </span>
<span  style=""> 425                                                                                                          </span>
<span class="-8966123689509035198" onmouseenter="enter('-8966123689509035198');" onmouseout="out('-8966123689509035198');" style=""> 426         if (order.getOrderItems() == null) {                                                             </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 427             return madeChange;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 428         }                                                                                                </span>
<span  style=""> 429                                                                                                          </span>
<span class="8447029191885982498" onmouseenter="enter('8447029191885982498');" onmouseout="out('8447029191885982498');" style=""> 430         for (OrderItem oi : order.getOrderItems()) {                                                     </span>
<span class="-5982197742320851056" onmouseenter="enter('-5982197742320851056');" onmouseout="out('-5982197742320851056');" style=""> 431             if (oi.getOrderItemPriceDetails() == null) {                                                 </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 432                 continue;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 433             }                                                                                            </span>
<span  style=""> 434                                                                                                          </span>
<span class="7391296704731194189" onmouseenter="enter('7391296704731194189');" onmouseout="out('7391296704731194189');" style=""> 435             for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {                              </span>
<span class="-8259157388002947293" onmouseenter="enter('-8259157388002947293');" onmouseout="out('-8259157388002947293');" style=""> 436                 if (pd.getOrderItemPriceDetailAdjustments() == null) {                                   </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 437                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 438                 }                                                                                        </span>
<span  style=""> 439                                                                                                          </span>
<span class="-8160497408394725913" onmouseenter="enter('-8160497408394725913');" onmouseout="out('-8160497408394725913');" style=""><abbr title=" 440                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 440                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdðŸ”µ</abbr></span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 441                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 441                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDeðŸ”µ</abbr></span>
<span class="-3008507732031274392" onmouseenter="enter('-3008507732031274392');" onmouseout="out('-3008507732031274392');" style=""> 442                 for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {     </span>
<span class="-1975641521768786423" onmouseenter="enter('-1975641521768786423');" onmouseout="out('-1975641521768786423');" style=""> 443                     if (adjs.containsKey(adj.getOffer().getId())) {                                      </span>
<span class="-6913168070672082713" onmouseenter="enter('-6913168070672082713');" onmouseout="out('-6913168070672082713');" style=""> 444                         adjustmentsToRemove.add(adj);                                                    </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 445                         if (LOG.isDebugEnabled()) {                                                      </span>
<span class="-2834336870885753779" onmouseenter="enter('-2834336870885753779');" onmouseout="out('-2834336870885753779');" style=""> 446                             StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)                 </span>
<span class="201513945492742471" onmouseenter="enter('201513945492742471');" onmouseout="out('201513945492742471');" style=""> 447                                 .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)                   </span>
<span class="2195430440089355634" onmouseenter="enter('2195430440089355634');" onmouseout="out('2195430440089355634');" style=""> 448                                 .append(&quot; with ids &quot;)                                                    </span>
<span class="-3149719647859419210" onmouseenter="enter('-3149719647859419210');" onmouseout="out('-3149719647859419210');" style=""> 449                                 .append(adjs.get(adj.getOffer().getId()).getId())                        </span>
<span class="7312533819175146387" onmouseenter="enter('7312533819175146387');" onmouseout="out('7312533819175146387');" style=""> 450                                 .append(&quot; and &quot;)                                                         </span>
<span class="6832270653349147085" onmouseenter="enter('6832270653349147085');" onmouseout="out('6832270653349147085');" style=""> 451                                 .append(adj.getId());                                                    </span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 452                             LOG.debug(sb.toString());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 453                         }                                                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 454                     } else {                                                                             </span>
<span class="-7759509127049565554" onmouseenter="enter('-7759509127049565554');" onmouseout="out('-7759509127049565554');" style=""> 455                         adjs.put(adj.getOffer().getId(), adj);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 456                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 457                 }                                                                                        </span>
<span  style=""> 458                                                                                                          </span>
<span class="7848730128284985932" onmouseenter="enter('7848730128284985932');" onmouseout="out('7848730128284985932');" style=""> 459                 for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {                         </span>
<span class="6756116260498887863" onmouseenter="enter('6756116260498887863');" onmouseout="out('6756116260498887863');" style=""> 460                     pd.getOrderItemPriceDetailAdjustments().remove(adj);                                 </span>
<span class="5571803755205047298" onmouseenter="enter('5571803755205047298');" onmouseout="out('5571803755205047298');" style=""> 461                     madeChange = true;                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 462                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 463             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 464         }                                                                                                </span>
<span  style=""> 465                                                                                                          </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 466         return madeChange;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 467      }                                                                                                   </span>
<span  style=""> 468                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 469     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 470     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 471     @Deprecated                                                                                          </span>
<span class="-3021599232242429775" onmouseenter="enter('-3021599232242429775');" onmouseout="out('-3021599232242429775');" style=""> 472     public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {            </span>
<span class="-6341015309393843959" onmouseenter="enter('-6341015309393843959');" onmouseout="out('-6341015309393843959');" style=""> 473         applyAndSaveOffersToOrder(offers, order);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 474     }                                                                                                    </span>
<span  style=""> 475                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 476     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 477     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 478     @Deprecated                                                                                          </span>
<span class="-5535279977913938928" onmouseenter="enter('-5535279977913938928');" onmouseout="out('-5535279977913938928');" style=""><abbr title=" 479     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 479     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptiðŸ”µ</abbr></span>
<span class="6394386461467124428" onmouseenter="enter('6394386461467124428');" onmouseout="out('6394386461467124428');" style=""> 480         applyAndSaveFulfillmentGroupOffersToOrder(offers, order);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 481     }                                                                                                    </span>
<span  style=""> 482                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 483     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 484     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="2855881782634007850" onmouseenter="enter('2855881782634007850');" onmouseout="out('2855881782634007850');" style=""><abbr title=" 485     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 485     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricinðŸ”µ</abbr></span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 486         OfferContext offerContext = OfferContext.getOfferContext();                                      </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 487         if (offerContext == null || offerContext.executePromotionCalculation) {                          </span>
<span class="-791836473256513905" onmouseenter="enter('-791836473256513905');" onmouseout="out('-791836473256513905');" style=""> 488             PromotableOrder promotableOrder =                                                            </span>
<span class="-5771222684966163235" onmouseenter="enter('-5771222684966163235');" onmouseout="out('-5771222684966163235');" style=""> 489                     promotableItemFactory.createPromotableOrder(order, true);                            </span>
<span class="-6252467951249219732" onmouseenter="enter('-6252467951249219732');" onmouseout="out('-6252467951249219732');" style=""> 490             List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();                                       </span>
<span class="-8689854403875612694" onmouseenter="enter('-8689854403875612694');" onmouseout="out('-8689854403875612694');" style=""> 491             for (Offer offer : offers) {                                                                 </span>
<span class="3344482016035270743" onmouseenter="enter('3344482016035270743');" onmouseout="out('3344482016035270743');" style=""> 492                 if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {           </span>
<span class="2965579239059640859" onmouseenter="enter('2965579239059640859');" onmouseout="out('2965579239059640859');" style=""> 493                     possibleFGOffers.add(offer);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 494                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 495             }                                                                                            </span>
<span class="7272445213685933500" onmouseenter="enter('7272445213685933500');" onmouseout="out('7272445213685933500');" style=""><abbr title=" 496             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());"> 496             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustðŸ”µ</abbr></span>
<span class="-380250791493510209" onmouseenter="enter('-380250791493510209');" onmouseout="out('-380250791493510209');" style=""><abbr title=" 497             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 497             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCaðŸ”µ</abbr></span>
<span class="5471512156259214352" onmouseenter="enter('5471512156259214352');" onmouseout="out('5471512156259214352');" style=""> 498             for (Offer offer : filteredOffers) {                                                         </span>
<span class="6341701119621727258" onmouseenter="enter('6341701119621727258');" onmouseout="out('6341701119621727258');" style=""><abbr title=" 499                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 499                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifieðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 500             }                                                                                            </span>
<span class="6757974448768463" onmouseenter="enter('6757974448768463');" onmouseout="out('6757974448768463');" style=""> 501             if (!qualifiedFGOffers.isEmpty()) {                                                          </span>
<span class="-3737539762239464744" onmouseenter="enter('-3737539762239464744');" onmouseout="out('-3737539762239464744');" style=""><abbr title=" 502                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);"> 502                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotabðŸ”µ</abbr></span>
<span class="-1748187190347404908" onmouseenter="enter('-1748187190347404908');" onmouseout="out('-1748187190347404908');" style=""> 503                 fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);          </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 504                 orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 505             }                                                                                            </span>
<span  style=""> 506                                                                                                          </span>
<span class="-7204486914274790826" onmouseenter="enter('-7204486914274790826');" onmouseout="out('-7204486914274790826');" style=""> 507             return orderService.save(order, false);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 508         }                                                                                                </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 509         return order;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 510     }                                                                                                    </span>
<span  style=""> 511                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 512     @Override                                                                                            </span>
<span class="-8983195686564092827" onmouseenter="enter('-8983195686564092827');" onmouseout="out('-8983195686564092827');" style=""> 513     public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {                           </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style=""> 514 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 515         if (offer.isLimitedUsePerCustomer()) {                                                           </span>
<span class="-3564809625752937907" onmouseenter="enter('-3564809625752937907');" onmouseout="out('-3564809625752937907');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 516             CustomerMaxUsesStrategyType strategy = offer.getMaxUsesStrategyType();                       </span>
<span class="7811178892856243955" onmouseenter="enter('7811178892856243955');" onmouseout="out('7811178892856243955');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 517             boolean checkUsingCustomer = (strategy == null || strategy.equals(CustomerMaxUsesStrategyType.CUSTOMER));"> 517             boolean checkUsingCustomer = (strategy == null || strategy.equals(CustomerMaxUsesStrategyTypeðŸ”µ</abbr></span>
<span class="-4186001467963498158" onmouseenter="enter('-4186001467963498158');" onmouseout="out('-4186001467963498158');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 518             Long currentUses;                                                                            </span>
<span class="943186304180287912" onmouseenter="enter('943186304180287912');" onmouseout="out('943186304180287912');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 519             if (checkUsingCustomer) {                                                                    </span>
<span class="7194263595725243761" onmouseenter="enter('7194263595725243761');" onmouseout="out('7194263595725243761');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 520                 currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 520                 currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), oðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 521             } else {                                                                                     </span>
<span class="5949149386596450267" onmouseenter="enter('5949149386596450267');" onmouseout="out('5949149386596450267');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 522                 currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 522                 currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 523             }                                                                                            </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 524 ||||||| BASE                                                                                             </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525         Customer customer = order.getCustomer();                                                         </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526                                                                                                          </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527         if (offer.isLimitedUsePerCustomer()) {                                                           </span>
<span class="-8305970541390666259" onmouseenter="enter('-8305970541390666259');" onmouseout="out('-8305970541390666259');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 528             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());"> 528             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getIdðŸ”µ</abbr></span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529                                                                                                          </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531                 return false;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533         }                                                                                                </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 534 =======                                                                                                  </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535         Customer customer = order.getCustomer();                                                         </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536                                                                                                          </span>
<span class="5393081257737861323" onmouseenter="enter('5393081257737861323');" onmouseout="out('5393081257737861323');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537         if (customer != null &amp;&amp; customer.isRegistered() &amp;&amp; offer.isLimitedUsePerCustomer()) {            </span>
<span class="-8305970541390666259" onmouseenter="enter('-8305970541390666259');" onmouseout="out('-8305970541390666259');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 538             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());"> 538             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getIdðŸ”µ</abbr></span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 539 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span  style=""> 540                                                                                                          </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 541             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 542                 return false;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 543             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 544         }                                                                                                </span>
<span  style=""> 545                                                                                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 546         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 547     }                                                                                                    </span>
<span  style=""> 548                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 549     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 550     @Override                                                                                            </span>
<span class="4849754295577860926" onmouseenter="enter('4849754295577860926');" onmouseout="out('4849754295577860926');" style=""> 551     public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {                     </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 552         if (offer.isLimitedUsePerCustomer()) {                                                           </span>
<span class="8084739095609490454" onmouseenter="enter('8084739095609490454');" onmouseout="out('8084739095609490454');" style=""> 553             Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());   </span>
<span  style=""> 554                                                                                                          </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 555             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 556                 return false;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 557             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 558         }                                                                                                </span>
<span  style=""> 559                                                                                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 560         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 561     }                                                                                                    </span>
<span  style=""> 562                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 563     @Override                                                                                            </span>
<span class="-4305912419408886648" onmouseenter="enter('-4305912419408886648');" onmouseout="out('-4305912419408886648');" style=""> 564     public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {                        </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 565         boolean underCodeMaxUses = true;                                                                 </span>
<span  style=""> 566                                                                                                          </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 567         if (code.isLimitedUse()) {                                                                       </span>
<span class="-7378740545085856894" onmouseenter="enter('-7378740545085856894');" onmouseout="out('-7378740545085856894');" style=""> 568             Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());            </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 569             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 570         }                                                                                                </span>
<span  style=""> 571                                                                                                          </span>
<span class="5446263071698048925" onmouseenter="enter('5446263071698048925');" onmouseout="out('5446263071698048925');" style=""> 572         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 573     }                                                                                                    </span>
<span  style=""> 574                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 575     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 576     @Override                                                                                            </span>
<span class="135967723667379112" onmouseenter="enter('135967723667379112');" onmouseout="out('135967723667379112');" style=""> 577     public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {                  </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 578         boolean underCodeMaxUses = true;                                                                 </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 579         if (code.isLimitedUse()) {                                                                       </span>
<span class="5487567461678823803" onmouseenter="enter('5487567461678823803');" onmouseout="out('5487567461678823803');" style=""> 580             Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());                   </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 581             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 582         }                                                                                                </span>
<span class="7193079189056024188" onmouseenter="enter('7193079189056024188');" onmouseout="out('7193079189056024188');" style=""> 583         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 584     }                                                                                                    </span>
<span  style=""> 585                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 586     @Override                                                                                            </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 587     @SuppressWarnings(&quot;unchecked&quot;)                                                                       </span>
<span class="-640784293225096821" onmouseenter="enter('-640784293225096821');" onmouseout="out('-640784293225096821');" style=""> 588     public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {                                            </span>
<span class="-348027159212233091" onmouseenter="enter('-348027159212233091');" onmouseout="out('-348027159212233091');" style=""> 589         HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();                                                    </span>
<span  style=""> 590                                                                                                          </span>
<span class="-7949809618309864364" onmouseenter="enter('-7949809618309864364');" onmouseout="out('-7949809618309864364');" style=""> 591         Transformer adjustmentToOfferTransformer = new Transformer() {                                   </span>
<span  style=""> 592                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 593             @Override                                                                                    </span>
<span class="-2718541205900117239" onmouseenter="enter('-2718541205900117239');" onmouseout="out('-2718541205900117239');" style=""> 594             public Object transform(Object input) {                                                      </span>
<span class="4176981446584954696" onmouseenter="enter('4176981446584954696');" onmouseout="out('4176981446584954696');" style=""> 595                 return ((Adjustment)input).getOffer();                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 596             }                                                                                            </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 597         };                                                                                               </span>
<span  style=""> 598                                                                                                          </span>
<span class="-8370514600917699300" onmouseenter="enter('-8370514600917699300');" onmouseout="out('-8370514600917699300');" style=""><abbr title=" 599         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));"> 599         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer))ðŸ”µ</abbr></span>
<span  style=""> 600                                                                                                          </span>
<span class="3897119298100986011" onmouseenter="enter('3897119298100986011');" onmouseout="out('3897119298100986011');" style=""> 601         if (order.getOrderItems() != null) {                                                             </span>
<span class="820796442257070700" onmouseenter="enter('820796442257070700');" onmouseout="out('820796442257070700');" style=""> 602             for (OrderItem item : order.getOrderItems()) {                                               </span>
<span class="722957474719034118" onmouseenter="enter('722957474719034118');" onmouseout="out('722957474719034118');" style=""><abbr title=" 603                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 603                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTrðŸ”µ</abbr></span>
<span  style=""> 604                                                                                                          </span>
<span class="-3519908190158496681" onmouseenter="enter('-3519908190158496681');" onmouseout="out('-3519908190158496681');" style=""> 605                 //record usage for price details on the item as well                                     </span>
<span class="-2952948196187271811" onmouseenter="enter('-2952948196187271811');" onmouseout="out('-2952948196187271811');" style=""> 606                 if (item.getOrderItemPriceDetails() != null) {                                           </span>
<span class="773323050474809935" onmouseenter="enter('773323050474809935');" onmouseout="out('773323050474809935');" style=""> 607                     for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {                </span>
<span class="7134713472391876911" onmouseenter="enter('7134713472391876911');" onmouseout="out('7134713472391876911');" style=""><abbr title=" 608                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 608                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments()ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 609                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 610                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 611             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 612         }                                                                                                </span>
<span  style=""> 613                                                                                                          </span>
<span class="7944520279780748823" onmouseenter="enter('7944520279780748823');" onmouseout="out('7944520279780748823');" style=""> 614         if (order.getFulfillmentGroups() != null) {                                                      </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 615             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                   </span>
<span class="-293187079687761920" onmouseenter="enter('-293187079687761920');" onmouseout="out('-293187079687761920');" style=""><abbr title=" 616                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 616                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 617             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 618         }                                                                                                </span>
<span class="-6419540350677864751" onmouseenter="enter('-6419540350677864751');" onmouseout="out('-6419540350677864751');" style=""> 619         return result;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 620     }                                                                                                    </span>
<span  style=""> 621                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 622     @Override                                                                                            </span>
<span class="-2491837224879773303" onmouseenter="enter('-2491837224879773303');" onmouseout="out('-2491837224879773303');" style=""> 623     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {                             </span>
<span class="-1370687283458217641" onmouseenter="enter('-1370687283458217641');" onmouseout="out('-1370687283458217641');" style=""> 624         return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order)); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 625     }                                                                                                    </span>
<span  style=""> 626                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 627     @Override                                                                                            </span>
<span class="-6407317956511861474" onmouseenter="enter('-6407317956511861474');" onmouseout="out('-6407317956511861474');" style=""><abbr title=" 628     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {"> 628     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffðŸ”µ</abbr></span>
<span class="-4490485247927949218" onmouseenter="enter('-4490485247927949218');" onmouseout="out('-4490485247927949218');" style=""> 629         HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();                  </span>
<span class="983580358500385861" onmouseenter="enter('983580358500385861');" onmouseout="out('983580358500385861');" style=""> 630         for (OfferCode code : codes) {                                                                   </span>
<span class="6305098044991751707" onmouseenter="enter('6305098044991751707');" onmouseout="out('6305098044991751707');" style=""> 631             if (appliedOffers.contains(code.getOffer())) {                                               </span>
<span class="3746501443462939384" onmouseenter="enter('3746501443462939384');" onmouseout="out('3746501443462939384');" style=""> 632                 offerToCodeMapping.put(code.getOffer(), code);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 633             }                                                                                            </span>
<span  style=""> 634                                                                                                          </span>
<span class="-240986298797431748" onmouseenter="enter('-240986298797431748');" onmouseout="out('-240986298797431748');" style=""> 635             List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();                            </span>
<span  style=""> 636                                                                                                          </span>
<span class="7454577566794152811" onmouseenter="enter('7454577566794152811');" onmouseout="out('7454577566794152811');" style=""> 637             extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);   </span>
<span class="-7985615425314556326" onmouseenter="enter('-7985615425314556326');" onmouseout="out('-7985615425314556326');" style=""> 638             for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {                       </span>
<span class="-808811284028256215" onmouseenter="enter('-808811284028256215');" onmouseout="out('-808811284028256215');" style=""> 639                 offerToCodeMapping.put(additionalOfferToBeApplied, code);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 640             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 641         }                                                                                                </span>
<span class="7175253914401568841" onmouseenter="enter('7175253914401568841');" onmouseout="out('7175253914401568841');" style=""> 642         return offerToCodeMapping;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 643     }                                                                                                    </span>
<span  style=""> 644                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 645     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 646     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-1347767159915315738" onmouseenter="enter('-1347767159915315738');" onmouseout="out('-1347767159915315738');" style=""> 647     public Boolean deleteOfferCode(OfferCode code) {                                                     </span>
<span class="-5986603348121186173" onmouseenter="enter('-5986603348121186173');" onmouseout="out('-5986603348121186173');" style=""> 648         if (offerCodeDao.offerCodeIsUsed(code)) {                                                        </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 649             return false;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 650         }                                                                                                </span>
<span  style=""> 651                                                                                                          </span>
<span class="-9122073777393685295" onmouseenter="enter('-9122073777393685295');" onmouseout="out('-9122073777393685295');" style=""> 652         offerCodeDao.delete(code);                                                                       </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 653         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 654     }                                                                                                    </span>
<span  style=""> 655                                                                                                          </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 656     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 657     @Override                                                                                            </span>
<span class="-3816301958562278169" onmouseenter="enter('-3816301958562278169');" onmouseout="out('-3816301958562278169');" style=""> 658     public Offer duplicate(Long originalOfferId) {                                                       </span>
<span class="5769078866234041335" onmouseenter="enter('5769078866234041335');" onmouseout="out('5769078866234041335');" style=""> 659         return duplicator.copy(OfferImpl.class, originalOfferId);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 660     }                                                                                                    </span>
<span  style=""> 661                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 662     @Override                                                                                            </span>
<span class="3228088005821970316" onmouseenter="enter('3228088005821970316');" onmouseout="out('3228088005821970316');" style=""> 663     public CustomerOfferDao getCustomerOfferDao() {                                                      </span>
<span class="-801333879424417122" onmouseenter="enter('-801333879424417122');" onmouseout="out('-801333879424417122');" style=""> 664         return customerOfferDao;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 665     }                                                                                                    </span>
<span  style=""> 666                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 667     @Override                                                                                            </span>
<span class="6308179313298689001" onmouseenter="enter('6308179313298689001');" onmouseout="out('6308179313298689001');" style=""> 668     public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {                                 </span>
<span class="438520929977701037" onmouseenter="enter('438520929977701037');" onmouseout="out('438520929977701037');" style=""> 669         this.customerOfferDao = customerOfferDao;                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 670     }                                                                                                    </span>
<span  style=""> 671                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 672     @Override                                                                                            </span>
<span class="8266606365944954497" onmouseenter="enter('8266606365944954497');" onmouseout="out('8266606365944954497');" style=""> 673     public OfferCodeDao getOfferCodeDao() {                                                              </span>
<span class="-4005874311041664572" onmouseenter="enter('-4005874311041664572');" onmouseout="out('-4005874311041664572');" style=""> 674         return offerCodeDao;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 675     }                                                                                                    </span>
<span  style=""> 676                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 677     @Override                                                                                            </span>
<span class="-5083072655758254890" onmouseenter="enter('-5083072655758254890');" onmouseout="out('-5083072655758254890');" style=""> 678     public void setOfferCodeDao(OfferCodeDao offerCodeDao) {                                             </span>
<span class="-7060255547979502806" onmouseenter="enter('-7060255547979502806');" onmouseout="out('-7060255547979502806');" style=""> 679         this.offerCodeDao = offerCodeDao;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 680     }                                                                                                    </span>
<span  style=""> 681                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 682     @Override                                                                                            </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 683     public OfferDao getOfferDao() {                                                                      </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 684         return offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 685     }                                                                                                    </span>
<span  style=""> 686                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 687     @Override                                                                                            </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 688     public void setOfferDao(OfferDao offerDao) {                                                         </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 689         this.offerDao = offerDao;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 690     }                                                                                                    </span>
<span  style=""> 691                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 692     @Override                                                                                            </span>
<span class="3012408951835963759" onmouseenter="enter('3012408951835963759');" onmouseout="out('3012408951835963759');" style=""> 693     public OrderOfferProcessor getOrderOfferProcessor() {                                                </span>
<span class="-5069105522766505260" onmouseenter="enter('-5069105522766505260');" onmouseout="out('-5069105522766505260');" style=""> 694         return orderOfferProcessor;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 695     }                                                                                                    </span>
<span  style=""> 696                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 697     @Override                                                                                            </span>
<span class="-2542583147665382651" onmouseenter="enter('-2542583147665382651');" onmouseout="out('-2542583147665382651');" style=""> 698     public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {                        </span>
<span class="1533378703496715943" onmouseenter="enter('1533378703496715943');" onmouseout="out('1533378703496715943');" style=""> 699         this.orderOfferProcessor = orderOfferProcessor;                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 700     }                                                                                                    </span>
<span  style=""> 701                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 702     @Override                                                                                            </span>
<span class="1694843298235251985" onmouseenter="enter('1694843298235251985');" onmouseout="out('1694843298235251985');" style=""> 703     public ItemOfferProcessor getItemOfferProcessor() {                                                  </span>
<span class="1583504692330339191" onmouseenter="enter('1583504692330339191');" onmouseout="out('1583504692330339191');" style=""> 704         return itemOfferProcessor;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 705     }                                                                                                    </span>
<span  style=""> 706                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 707     @Override                                                                                            </span>
<span class="145400756853488798" onmouseenter="enter('145400756853488798');" onmouseout="out('145400756853488798');" style=""> 708     public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {                           </span>
<span class="-102405468021411755" onmouseenter="enter('-102405468021411755');" onmouseout="out('-102405468021411755');" style=""> 709         this.itemOfferProcessor = itemOfferProcessor;                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 710     }                                                                                                    </span>
<span  style=""> 711                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 712     @Override                                                                                            </span>
<span class="3022939772369206873" onmouseenter="enter('3022939772369206873');" onmouseout="out('3022939772369206873');" style=""> 713     public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {                          </span>
<span class="-3088775944214719317" onmouseenter="enter('-3088775944214719317');" onmouseout="out('-3088775944214719317');" style=""> 714         return fulfillmentGroupOfferProcessor;                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 715     }                                                                                                    </span>
<span  style=""> 716                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 717     @Override                                                                                            </span>
<span class="-8855456203149015957" onmouseenter="enter('-8855456203149015957');" onmouseout="out('-8855456203149015957');" style=""><abbr title=" 718     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {"> 718     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProðŸ”µ</abbr></span>
<span class="-7108053920330155376" onmouseenter="enter('-7108053920330155376');" onmouseout="out('-7108053920330155376');" style=""> 719         this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 720     }                                                                                                    </span>
<span  style=""> 721                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 722     @Override                                                                                            </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 723     public PromotableItemFactory getPromotableItemFactory() {                                            </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 724         return promotableItemFactory;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 725     }                                                                                                    </span>
<span  style=""> 726                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 727     @Override                                                                                            </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 728     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                  </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 729         this.promotableItemFactory = promotableItemFactory;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 730     }                                                                                                    </span>
<span  style=""> 731                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 732     @Override                                                                                            </span>
<span class="-285725005067991728" onmouseenter="enter('-285725005067991728');" onmouseout="out('-285725005067991728');" style=""> 733     public OfferCode findOfferCodeById(Long id) {                                                        </span>
<span class="4928857363700364693" onmouseenter="enter('4928857363700364693');" onmouseout="out('4928857363700364693');" style=""> 734         return offerCodeDao.readOfferCodeById(id);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 735     }                                                                                                    </span>
<span  style=""> 736                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 737     @Override                                                                                            </span>
<span class="-6829155498814719074" onmouseenter="enter('-6829155498814719074');" onmouseout="out('-6829155498814719074');" style=""> 738     public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {                                   </span>
<span class="-1521639274006709657" onmouseenter="enter('-1521639274006709657');" onmouseout="out('-1521639274006709657');" style=""> 739         return offerCodeDao.readOfferCodesByIds(ids);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 740     }                                                                                                    </span>
<span  style=""> 741                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 742     @Override                                                                                            </span>
<span class="5587340050529616033" onmouseenter="enter('5587340050529616033');" onmouseout="out('5587340050529616033');" style=""> 743     public OrderService getOrderService() {                                                              </span>
<span class="-7558473787756148723" onmouseenter="enter('-7558473787756148723');" onmouseout="out('-7558473787756148723');" style=""> 744         return orderService;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 745     }                                                                                                    </span>
<span  style=""> 746                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 747     @Override                                                                                            </span>
<span class="4536819371590947172" onmouseenter="enter('4536819371590947172');" onmouseout="out('4536819371590947172');" style=""> 748     public void setOrderService(OrderService orderService) {                                             </span>
<span class="7368861914925934250" onmouseenter="enter('7368861914925934250');" onmouseout="out('7368861914925934250');" style=""> 749         this.orderService = orderService;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 750     }                                                                                                    </span>
<span  style=""> 751                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 752     @Override                                                                                            </span>
<span class="-2217088353489190987" onmouseenter="enter('-2217088353489190987');" onmouseout="out('-2217088353489190987');" style=""> 753     public Offer findOfferById(Long offerId) {                                                           </span>
<span class="-5171648678549667040" onmouseenter="enter('-5171648678549667040');" onmouseout="out('-5171648678549667040');" style=""> 754         return offerDao.readOfferById(offerId);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 755     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 756 }                                                                                                        </span>


</pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18 package org.broadleafcommerce.core.offer.service;                                                        </span>
<span  style="">  19                                                                                                          </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  20 import java.util.ArrayList;                                                                              </span>
<span class="-112105277767313938" onmouseenter="enter('-112105277767313938');" onmouseout="out('-112105277767313938');" style="">  21 import java.util.Collection;                                                                             </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  22 import java.util.HashMap;                                                                                </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  23 import java.util.HashSet;                                                                                </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  24 import java.util.Iterator;                                                                               </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  25 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  26 import java.util.Map;                                                                                    </span>
<span class="6306724220981822255" onmouseenter="enter('6306724220981822255');" onmouseout="out('6306724220981822255');" style="">  27 import java.util.Objects;                                                                                </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  28 import java.util.Set;                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  29 import javax.annotation.Resource;                                                                        </span>
<span class="7911938180110628123" onmouseenter="enter('7911938180110628123');" onmouseout="out('7911938180110628123');" style="">  30 import javax.persistence.EntityManager;                                                                  </span>
<span class="3821515051839343306" onmouseenter="enter('3821515051839343306');" onmouseout="out('3821515051839343306');" style="">  31 import javax.persistence.PersistenceContext;                                                             </span>
<span class="8596464405353709537" onmouseenter="enter('8596464405353709537');" onmouseout="out('8596464405353709537');" style="">  32 import org.apache.commons.collections.CollectionUtils;                                                   </span>
<span class="2953846583056246827" onmouseenter="enter('2953846583056246827');" onmouseout="out('2953846583056246827');" style="">  33 import org.apache.commons.collections.Transformer;                                                       </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  34 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  35 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-2193028153657877676" onmouseenter="enter('-2193028153657877676');" onmouseout="out('-2193028153657877676');" style="">  36 import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;                                 </span>
<span class="-3349026188166660873" onmouseenter="enter('-3349026188166660873');" onmouseout="out('-3349026188166660873');" style="">  37 import org.broadleafcommerce.common.persistence.EntityDuplicator;                                        </span>
<span class="-2818686525334833130" onmouseenter="enter('-2818686525334833130');" onmouseout="out('-2818686525334833130');" style="">  38 import org.broadleafcommerce.common.sandbox.SandBoxHelper;                                               </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  39 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                     </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  40 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                </span>
<span class="6205208880685044389" onmouseenter="enter('6205208880685044389');" onmouseout="out('6205208880685044389');" style="">  41 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;                                            </span>
<span class="-7911436562744873568" onmouseenter="enter('-7911436562744873568');" onmouseout="out('-7911436562744873568');" style="">  42 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;                                                </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  43 import org.broadleafcommerce.core.offer.dao.OfferDao;                                                    </span>
<span class="-1633608357492319903" onmouseenter="enter('-1633608357492319903');" onmouseout="out('-1633608357492319903');" style="">  44 import org.broadleafcommerce.core.offer.domain.Adjustment;                                               </span>
<span class="984981432680799531" onmouseenter="enter('984981432680799531');" onmouseout="out('984981432680799531');" style="">  45 import org.broadleafcommerce.core.offer.domain.CustomerOffer;                                            </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  46 import org.broadleafcommerce.core.offer.domain.Offer;                                                    </span>
<span class="1521662235446319191" onmouseenter="enter('1521662235446319191');" onmouseout="out('1521662235446319191');" style="">  47 import org.broadleafcommerce.core.offer.domain.OfferCode;                                                </span>
<span class="-7025591891527881733" onmouseenter="enter('-7025591891527881733');" onmouseout="out('-7025591891527881733');" style="">  48 import org.broadleafcommerce.core.offer.domain.OfferImpl;                                                </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  49 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                           </span>
<span class="4287099423657810905" onmouseenter="enter('4287099423657810905');" onmouseout="out('4287099423657810905');" style="">  50 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;</span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  51 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;            </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  52 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;           </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  53 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                   </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  54 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                         </span>
<span class="5713212224635448284" onmouseenter="enter('5713212224635448284');" onmouseout="out('5713212224635448284');" style="">  55 import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;                </span>
<span class="-2454758753718589449" onmouseenter="enter('-2454758753718589449');" onmouseout="out('-2454758753718589449');" style="">  56 import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;                            </span>
<span class="8227287359407176835" onmouseenter="enter('8227287359407176835');" onmouseout="out('8227287359407176835');" style="">  57 import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;                           </span>
<span class="-2230425701287318422" onmouseenter="enter('-2230425701287318422');" onmouseout="out('-2230425701287318422');" style="">  58 import org.broadleafcommerce.core.offer.service.type.CustomerMaxUsesStrategyType;                        </span>
<span class="-5727938558534008634" onmouseenter="enter('-5727938558534008634');" onmouseout="out('-5727938558534008634');" style="">  59 import org.broadleafcommerce.core.offer.service.type.OfferType;                                          </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  60 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                         </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  61 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  62 import org.broadleafcommerce.core.order.domain.OrderItem;                                                </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  63 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                     </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  64 import org.broadleafcommerce.core.order.service.OrderService;                                            </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  65 import org.broadleafcommerce.core.pricing.service.exception.PricingException;                            </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  66 import org.broadleafcommerce.profile.core.domain.Customer;                                               </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  67 import org.springframework.stereotype.Service;                                                           </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  68 import org.springframework.transaction.annotation.Transactional;                                         </span>
<span  style="">  69                                                                                                          </span>
<span  style="">  70                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  71 /**                                                                                                      </span>
<span class="-2667338179687874348" onmouseenter="enter('-2667338179687874348');" onmouseout="out('-2667338179687874348');" style="">  72  * The Class OfferServiceImpl.                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  73  */                                                                                                      </span>
<span class="504450232350438262" onmouseenter="enter('504450232350438262');" onmouseout="out('504450232350438262');" style="">  74 @Service(&quot;blOfferService&quot;)                                                                               </span>
<span class="6786430150403502423" onmouseenter="enter('6786430150403502423');" onmouseout="out('6786430150403502423');" style="">  75 public class OfferServiceImpl implements OfferService {                                                  </span>
<span class="8897944981470617719" onmouseenter="enter('8897944981470617719');" onmouseout="out('8897944981470617719');" style="">  76     private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);                            </span>
<span  style="">  77                                                                                                          </span>
<span class="3846751699212951796" onmouseenter="enter('3846751699212951796');" onmouseout="out('3846751699212951796');" style="">  78     // should be called outside of Offer service after Offer service is executed                         </span>
<span class="3846751699212951796" onmouseenter="enter('3846751699212951796');" onmouseout="out('3846751699212951796');" style="">  79     // should be called outside of Offer service after Offer service is executed                         </span>
<span class="-5484979233832760683" onmouseenter="enter('-5484979233832760683');" onmouseout="out('-5484979233832760683');" style="">  80     @Resource(name=&quot;blCustomerOfferDao&quot;)                                                                 </span>
<span class="-5771823415174942027" onmouseenter="enter('-5771823415174942027');" onmouseout="out('-5771823415174942027');" style="">  81     protected CustomerOfferDao customerOfferDao;                                                         </span>
<span  style="">  82                                                                                                          </span>
<span class="-1524144969871346405" onmouseenter="enter('-1524144969871346405');" onmouseout="out('-1524144969871346405');" style="">  83     @Resource(name=&quot;blOfferCodeDao&quot;)                                                                     </span>
<span class="-6984238934820524758" onmouseenter="enter('-6984238934820524758');" onmouseout="out('-6984238934820524758');" style="">  84     protected OfferCodeDao offerCodeDao;                                                                 </span>
<span  style="">  85                                                                                                          </span>
<span class="-8247969455122443370" onmouseenter="enter('-8247969455122443370');" onmouseout="out('-8247969455122443370');" style="">  86     @Resource(name=&quot;blOfferAuditService&quot;)                                                                </span>
<span class="-6742419488595856311" onmouseenter="enter('-6742419488595856311');" onmouseout="out('-6742419488595856311');" style="">  87     protected OfferAuditService offerAuditService;                                                       </span>
<span  style="">  88                                                                                                          </span>
<span class="-6976077299079381435" onmouseenter="enter('-6976077299079381435');" onmouseout="out('-6976077299079381435');" style="">  89     @Resource(name=&quot;blOfferDao&quot;)                                                                         </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  90     protected OfferDao offerDao;                                                                         </span>
<span  style="">  91                                                                                                          </span>
<span class="-3191658961867656636" onmouseenter="enter('-3191658961867656636');" onmouseout="out('-3191658961867656636');" style="">  92     @Resource(name=&quot;blOrderOfferProcessor&quot;)                                                              </span>
<span class="-3818126380928091101" onmouseenter="enter('-3818126380928091101');" onmouseout="out('-3818126380928091101');" style="">  93     protected OrderOfferProcessor orderOfferProcessor;                                                   </span>
<span  style="">  94                                                                                                          </span>
<span class="-6223428528083119866" onmouseenter="enter('-6223428528083119866');" onmouseout="out('-6223428528083119866');" style="">  95     @Resource(name=&quot;blItemOfferProcessor&quot;)                                                               </span>
<span class="-7827297227357944415" onmouseenter="enter('-7827297227357944415');" onmouseout="out('-7827297227357944415');" style="">  96     protected ItemOfferProcessor itemOfferProcessor;                                                     </span>
<span  style="">  97                                                                                                          </span>
<span class="-1476654469985531605" onmouseenter="enter('-1476654469985531605');" onmouseout="out('-1476654469985531605');" style="">  98     @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)                                                   </span>
<span class="7634983124983010999" onmouseenter="enter('7634983124983010999');" onmouseout="out('7634983124983010999');" style="">  99     protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;                             </span>
<span  style=""> 100                                                                                                          </span>
<span class="-4330844585159307437" onmouseenter="enter('-4330844585159307437');" onmouseout="out('-4330844585159307437');" style=""> 101     @Resource(name=&quot;blPromotableItemFactory&quot;)                                                            </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style=""> 102     protected PromotableItemFactory promotableItemFactory;                                               </span>
<span  style=""> 103                                                                                                          </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style=""> 104     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                   </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style=""> 105     protected OfferServiceExtensionManager extensionManager;                                             </span>
<span  style=""> 106                                                                                                          </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 107     @Resource(name = &quot;blOrderService&quot;)                                                                   </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 108     protected OrderService orderService;                                                                 </span>
<span  style=""> 109                                                                                                          </span>
<span class="-3946461589801993391" onmouseenter="enter('-3946461589801993391');" onmouseout="out('-3946461589801993391');" style=""> 110     @Resource(name = &quot;blSandBoxHelper&quot;)                                                                  </span>
<span class="-7799183597372200632" onmouseenter="enter('-7799183597372200632');" onmouseout="out('-7799183597372200632');" style=""> 111     protected SandBoxHelper sandBoxHelper;                                                               </span>
<span  style=""> 112                                                                                                          </span>
<span class="-4259734795637808055" onmouseenter="enter('-4259734795637808055');" onmouseout="out('-4259734795637808055');" style=""> 113     @PersistenceContext(unitName=&quot;blPU&quot;)                                                                 </span>
<span class="-5741815223868414625" onmouseenter="enter('-5741815223868414625');" onmouseout="out('-5741815223868414625');" style=""> 114     protected EntityManager em;                                                                          </span>
<span  style=""> 115                                                                                                          </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 116     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                  </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 117     protected StreamingTransactionCapableUtil transUtil;                                                 </span>
<span  style=""> 118                                                                                                          </span>
<span class="-8384326529234094002" onmouseenter="enter('-8384326529234094002');" onmouseout="out('-8384326529234094002');" style=""> 119     @Resource(name=&quot;blEntityDuplicator&quot;)                                                                 </span>
<span class="-9194612273021432316" onmouseenter="enter('-9194612273021432316');" onmouseout="out('-9194612273021432316');" style=""> 120     protected EntityDuplicator duplicator;                                                               </span>
<span  style=""> 121                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 122     /**                                                                                                  </span>
<span class="-5719913168774156893" onmouseenter="enter('-5719913168774156893');" onmouseout="out('-5719913168774156893');" style=""> 123      * @deprecated Add {@link EntityDuplicateModifier}s to {@code blEntityDuplicationHelpers}            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 124      */                                                                                                  </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 125     @Deprecated                                                                                          </span>
<span class="8658910844320022950" onmouseenter="enter('8658910844320022950');" onmouseout="out('8658910844320022950');" style=""> 126     protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;                                     </span>
<span  style=""> 127                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 128     @Override                                                                                            </span>
<span class="-2033305286790048708" onmouseenter="enter('-2033305286790048708');" onmouseout="out('-2033305286790048708');" style=""> 129     public List&lt;Offer&gt; findAllOffers() {                                                                 </span>
<span class="2132174063530273788" onmouseenter="enter('2132174063530273788');" onmouseout="out('2132174063530273788');" style=""> 130         return offerDao.readAllOffers();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 131     }                                                                                                    </span>
<span  style=""> 132                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 133     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 134     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="7144811092176845141" onmouseenter="enter('7144811092176845141');" onmouseout="out('7144811092176845141');" style=""> 135     public Offer save(Offer offer) {                                                                     </span>
<span class="-264708178039771798" onmouseenter="enter('-264708178039771798');" onmouseout="out('-264708178039771798');" style=""> 136         return offerDao.save(offer);                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137     }                                                                                                    </span>
<span  style=""> 138                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 139     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 140     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-5514670765130856091" onmouseenter="enter('-5514670765130856091');" onmouseout="out('-5514670765130856091');" style=""> 141     public OfferCode saveOfferCode(OfferCode offerCode) {                                                </span>
<span class="3125778008044685658" onmouseenter="enter('3125778008044685658');" onmouseout="out('3125778008044685658');" style=""> 142         offerCode.setOffer(offerDao.save(offerCode.getOffer()));                                         </span>
<span class="6906137479190051982" onmouseenter="enter('6906137479190051982');" onmouseout="out('6906137479190051982');" style=""> 143         return offerCodeDao.save(offerCode);                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 144     }                                                                                                    </span>
<span  style=""> 145                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 146     /**                                                                                                  </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""><abbr title=" 147      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 147      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr></span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""><abbr title=" 148      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 148      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr></span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 149      * cannot appear more than once in the list.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 150      *                                                                                                   </span>
<span class="-709313334493645866" onmouseenter="enter('-709313334493645866');" onmouseout="out('-709313334493645866');" style=""> 151      * @param code                                                                                       </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 152      * @return a List of offers that may apply to this order                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 153      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 154     @Override                                                                                            </span>
<span class="-6840847083603451180" onmouseenter="enter('-6840847083603451180');" onmouseout="out('-6840847083603451180');" style=""> 155     public Offer lookupOfferByCode(String code) {                                                        </span>
<span class="-531732708503781646" onmouseenter="enter('-531732708503781646');" onmouseout="out('-531732708503781646');" style=""> 156         Offer offer = null;                                                                              </span>
<span class="-8218576552188075283" onmouseenter="enter('-8218576552188075283');" onmouseout="out('-8218576552188075283');" style=""> 157         OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);                                    </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 158         if (offerCode != null) {                                                                         </span>
<span class="-2561785727340284423" onmouseenter="enter('-2561785727340284423');" onmouseout="out('-2561785727340284423');" style=""> 159             offer = offerCode.getOffer();                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 160         }                                                                                                </span>
<span class="-8963791522625561917" onmouseenter="enter('-8963791522625561917');" onmouseout="out('-8963791522625561917');" style=""> 161         return offer;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 162     }                                                                                                    </span>
<span  style=""> 163                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 164     @Override                                                                                            </span>
<span class="2883322601430833612" onmouseenter="enter('2883322601430833612');" onmouseout="out('2883322601430833612');" style=""> 165     public OfferCode lookupOfferCodeByCode(String code){                                                 </span>
<span class="8795189428566002896" onmouseenter="enter('8795189428566002896');" onmouseout="out('8795189428566002896');" style=""> 166         return offerCodeDao.readOfferCodeByCode(code);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 167     }                                                                                                    </span>
<span  style=""> 168                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 169     @Override                                                                                            </span>
<span class="-2543778591938191529" onmouseenter="enter('-2543778591938191529');" onmouseout="out('-2543778591938191529');" style=""> 170     public List&lt;Offer&gt; lookupAllOffersByCode(String code) {                                              </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 171         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                     </span>
<span class="-3360697953765841703" onmouseenter="enter('-3360697953765841703');" onmouseout="out('-3360697953765841703');" style=""> 172         List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);                         </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 173         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 174             if (offerCode != null) {                                                                     </span>
<span class="-7816274075460376657" onmouseenter="enter('-7816274075460376657');" onmouseout="out('-7816274075460376657');" style=""> 175                 offers.add(offerCode.getOffer());                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 176             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 177         }                                                                                                </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 178         return offers;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179     }                                                                                                    </span>
<span  style=""> 180                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 181     @Override                                                                                            </span>
<span class="4676855439599320404" onmouseenter="enter('4676855439599320404');" onmouseout="out('4676855439599320404');" style=""> 182     public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){                                       </span>
<span class="-4234235759448675045" onmouseenter="enter('-4234235759448675045');" onmouseout="out('-4234235759448675045');" style=""> 183         return offerCodeDao.readAllOfferCodesByCode(code);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 184     }                                                                                                    </span>
<span  style=""> 185                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 186     /**                                                                                                  </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""><abbr title=" 187      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 187      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr></span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""><abbr title=" 188      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 188      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr></span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 189      * cannot appear more than once in the list.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 190      *                                                                                                   </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 191      * @param order                                                                                      </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 192      * @return a List of offers that may apply to this order                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 193      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 194     @Override                                                                                            </span>
<span class="-5814298891852821500" onmouseenter="enter('-5814298891852821500');" onmouseout="out('-5814298891852821500');" style=""> 195     public List&lt;Offer&gt; buildOfferListForOrder(Order order) {                                             </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 196         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                     </span>
<span class="-3235900677601494398" onmouseenter="enter('-3235900677601494398');" onmouseout="out('-3235900677601494398');" style=""> 197         List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());         </span>
<span class="7699769166343685501" onmouseenter="enter('7699769166343685501');" onmouseout="out('7699769166343685501');" style=""> 198         for (CustomerOffer customerOffer : customerOffers) {                                             </span>
<span class="-2310400538171319838" onmouseenter="enter('-2310400538171319838');" onmouseout="out('-2310400538171319838');" style=""> 199             if (!offers.contains(customerOffer.getOffer())) {                                            </span>
<span class="5233078073066950969" onmouseenter="enter('5233078073066950969');" onmouseout="out('5233078073066950969');" style=""> 200                 offers.add(customerOffer.getOffer());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 201             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 202         }                                                                                                </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style=""> 203         List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                          </span>
<span class="-6665865767746694239" onmouseenter="enter('-6665865767746694239');" onmouseout="out('-6665865767746694239');" style=""> 204         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                    </span>
<span class="2682597879629079185" onmouseenter="enter('2682597879629079185');" onmouseout="out('2682597879629079185');" style=""> 205         for (OfferCode orderOfferCode : orderOfferCodes) {                                               </span>
<span class="-1857624084667800558" onmouseenter="enter('-1857624084667800558');" onmouseout="out('-1857624084667800558');" style=""> 206             if (!offers.contains(orderOfferCode.getOffer())) {                                           </span>
<span class="4188766124804405127" onmouseenter="enter('4188766124804405127');" onmouseout="out('4188766124804405127');" style=""> 207                 offers.add(orderOfferCode.getOffer());                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 208             }                                                                                            </span>
<span class="-4468546552745233084" onmouseenter="enter('-4468546552745233084');" onmouseout="out('-4468546552745233084');" style=""> 209             extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 210         }                                                                                                </span>
<span class="-9188634082558155234" onmouseenter="enter('-9188634082558155234');" onmouseout="out('-9188634082558155234');" style=""> 211         List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();                                      </span>
<span class="-8411171878687156520" onmouseenter="enter('-8411171878687156520');" onmouseout="out('-8411171878687156520');" style=""> 212         for (Offer globalOffer : globalOffers) {                                                         </span>
<span class="2071278729839157974" onmouseenter="enter('2071278729839157974');" onmouseout="out('2071278729839157974');" style=""> 213             if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {  </span>
<span class="-3050025518373868772" onmouseenter="enter('-3050025518373868772');" onmouseout="out('-3050025518373868772');" style=""> 214                 offers.add(globalOffer);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 215             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 216         }                                                                                                </span>
<span  style=""> 217                                                                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 218         if (extensionManager != null) {                                                                  </span>
<span class="1817402996237899777" onmouseenter="enter('1817402996237899777');" onmouseout="out('1817402996237899777');" style=""> 219             extensionManager.applyAdditionalFilters(offers, order);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 220         }                                                                                                </span>
<span  style=""> 221                                                                                                          </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 222         return offers;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 223     }                                                                                                    </span>
<span  style=""> 224                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 225     @Override                                                                                            </span>
<span class="2056305643902587707" onmouseenter="enter('2056305643902587707');" onmouseout="out('2056305643902587707');" style=""> 226     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {                                  </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 227         Customer customer = order.getCustomer();                                                         </span>
<span class="-5041998041456755776" onmouseenter="enter('-5041998041456755776');" onmouseout="out('-5041998041456755776');" style=""> 228         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();                                             </span>
<span  style=""> 229                                                                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 230         if (extensionManager != null) {                                                                  </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 231             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 232         }                                                                                                </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 233         if (!offerCodes.isEmpty()) {                                                                     </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 234             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                             </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 235             while (itr.hasNext()) {                                                                      </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 236                 OfferCode offerCode = itr.next();                                                        </span>
<span class="-776136422183497161" onmouseenter="enter('-776136422183497161');" onmouseout="out('-776136422183497161');" style=""> 237                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {       </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 238                     itr.remove();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 239                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 240             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 241         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 242         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 243     }                                                                                                    </span>
<span  style=""> 244                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 245     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 246     @Override                                                                                            </span>
<span class="3843851677430304310" onmouseenter="enter('3843851677430304310');" onmouseout="out('3843851677430304310');" style=""> 247     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {                            </span>
<span class="-6957816096303048614" onmouseenter="enter('-6957816096303048614');" onmouseout="out('-6957816096303048614');" style=""> 248         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 249         if (extensionManager != null) {                                                                  </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 250             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251         }                                                                                                </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 252         if (!offerCodes.isEmpty()) {                                                                     </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 253             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                             </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 254             while (itr.hasNext()) {                                                                      </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 255                 OfferCode offerCode = itr.next();                                                        </span>
<span class="6086018267170409432" onmouseenter="enter('6086018267170409432');" onmouseout="out('6086018267170409432');" style=""> 256                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {    </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 257                     itr.remove();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 258                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 259             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 260         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 261         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 262     }                                                                                                    </span>
<span  style=""> 263                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 264     /**                                                                                                  </span>
<span class="2837560355574155003" onmouseenter="enter('2837560355574155003');" onmouseout="out('2837560355574155003');" style=""> 265      * Private method used to retrieve all offers assigned to this customer.  These offers are           </span>
<span class="4852710310174118924" onmouseenter="enter('4852710310174118924');" onmouseout="out('4852710310174118924');" style=""> 266      * programmatically assigned to the customer.                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 267      *                                                                                                   </span>
<span class="1094425505394812731" onmouseenter="enter('1094425505394812731');" onmouseout="out('1094425505394812731');" style=""> 268      * @param customer                                                                                   </span>
<span class="-3868237647402015492" onmouseenter="enter('-3868237647402015492');" onmouseout="out('-3868237647402015492');" style=""> 269      * @return a List of offers assigned to the customer                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 270      */                                                                                                  </span>
<span class="-1064959765029423996" onmouseenter="enter('-1064959765029423996');" onmouseout="out('-1064959765029423996');" style=""> 271     protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {                     </span>
<span class="1699675085073278700" onmouseenter="enter('1699675085073278700');" onmouseout="out('1699675085073278700');" style=""> 272         List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);    </span>
<span class="5611761187435301880" onmouseenter="enter('5611761187435301880');" onmouseout="out('5611761187435301880');" style=""> 273         return offerCustomers;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 274     }                                                                                                    </span>
<span  style=""> 275                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 276     /**                                                                                                  </span>
<span class="-8831229104457932482" onmouseenter="enter('-8831229104457932482');" onmouseout="out('-8831229104457932482');" style=""> 277      * Private method used to retrieve all offers with automaticallyAdded set to true                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 278      *                                                                                                   </span>
<span class="-2057313490179191281" onmouseenter="enter('-2057313490179191281');" onmouseout="out('-2057313490179191281');" style=""> 279      * @return a List of automatic delivery offers                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 280      */                                                                                                  </span>
<span class="-9186908469762752320" onmouseenter="enter('-9186908469762752320');" onmouseout="out('-9186908469762752320');" style=""> 281     protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {                                              </span>
<span class="-2657712449795339218" onmouseenter="enter('-2657712449795339218');" onmouseout="out('-2657712449795339218');" style=""> 282         List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();                         </span>
<span class="-7738403477037597046" onmouseenter="enter('-7738403477037597046');" onmouseout="out('-7738403477037597046');" style=""> 283         return globalOffers;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 284     }                                                                                                    </span>
<span  style=""> 285                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 286     /**                                                                                                  </span>
<span class="-582485916100204765" onmouseenter="enter('-582485916100204765');" onmouseout="out('-582485916100204765');" style=""> 287      * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end           </span>
<span class="-591413864231465226" onmouseenter="enter('-591413864231465226');" onmouseout="out('-591413864231465226');" style=""> 288      * date.  If an offerCode has a later start date, that offerCode will be removed.                    </span>
<span class="-1600892852414517397" onmouseenter="enter('-1600892852414517397');" onmouseout="out('-1600892852414517397');" style=""> 289      * OfferCodes without a start date will still be processed. If the offerCode                         </span>
<span class="-6972954356288154926" onmouseenter="enter('-6972954356288154926');" onmouseout="out('-6972954356288154926');" style=""> 290      * has a end date that has already passed, that offerCode will be removed.  OfferCodes               </span>
<span class="-7007360996659097530" onmouseenter="enter('-7007360996659097530');" onmouseout="out('-7007360996659097530');" style=""> 291      * without a end date will be processed.  The start and end dates on the offer will                  </span>
<span class="-216139196908541615" onmouseenter="enter('-216139196908541615');" onmouseout="out('-216139196908541615');" style=""> 292      * still need to be evaluated.                                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 293      *                                                                                                   </span>
<span class="-142155654396048960" onmouseenter="enter('-142155654396048960');" onmouseout="out('-142155654396048960');" style=""> 294      * @param offerCodes                                                                                 </span>
<span class="-7645314644020819692" onmouseenter="enter('-7645314644020819692');" onmouseout="out('-7645314644020819692');" style=""> 295      * @return a List of non-expired offers                                                              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 296      */                                                                                                  </span>
<span class="3097073257270455619" onmouseenter="enter('3097073257270455619');" onmouseout="out('3097073257270455619');" style=""> 297     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){                     </span>
<span class="-71581284051087612" onmouseenter="enter('-71581284051087612');" onmouseout="out('-71581284051087612');" style=""> 298         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();                                 </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 299         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="4179739580098873664" onmouseenter="enter('4179739580098873664');" onmouseout="out('4179739580098873664');" style=""> 300             if (!offerCode.isActive()){                                                                  </span>
<span class="2973899686965396382" onmouseenter="enter('2973899686965396382');" onmouseout="out('2973899686965396382');" style=""> 301                 offerCodesToRemove.add(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 302             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 303         }                                                                                                </span>
<span class="3113103044265464111" onmouseenter="enter('3113103044265464111');" onmouseout="out('3113103044265464111');" style=""> 304         // remove all offers in the offersToRemove list from original offers list                        </span>
<span class="6883206030034557562" onmouseenter="enter('6883206030034557562');" onmouseout="out('6883206030034557562');" style=""> 305         for (OfferCode offerCode : offerCodesToRemove) {                                                 </span>
<span class="-8473869847996752510" onmouseenter="enter('-8473869847996752510');" onmouseout="out('-8473869847996752510');" style=""> 306             offerCodes.remove(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 307         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 308         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 309     }                                                                                                    </span>
<span  style=""> 310                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 311     /**                                                                                                  </span>
<span class="5637961435104982406" onmouseenter="enter('5637961435104982406');" onmouseout="out('5637961435104982406');" style=""> 312      * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with       </span>
<span class="1724276086246688719" onmouseenter="enter('1724276086246688719');" onmouseout="out('1724276086246688719');" style=""> 313      * current sandbox status.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 314      *                                                                                                   </span>
<span class="202872854140107873" onmouseenter="enter('202872854140107873');" onmouseout="out('202872854140107873');" style=""> 315      * @param order the order to check                                                                   </span>
<span class="2772482249434351691" onmouseenter="enter('2772482249434351691');" onmouseout="out('2772482249434351691');" style=""> 316      * @return the refreshed list of OfferCodes                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 317      */                                                                                                  </span>
<span class="7210051143895905366" onmouseenter="enter('7210051143895905366');" onmouseout="out('7210051143895905366');" style=""> 318     protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {                         </span>
<span class="7464496307728629396" onmouseenter="enter('7464496307728629396');" onmouseout="out('7464496307728629396');" style=""> 319         final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();                              </span>
<span  style=""> 320                                                                                                          </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 321         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 322             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 323             public void execute() {                                                                      </span>
<span class="-6058145000184664425" onmouseenter="enter('-6058145000184664425');" onmouseout="out('-6058145000184664425');" style=""> 324                 for (OfferCode offerCode : orderOfferCodes) {                                            </span>
<span class="-4263515828536000223" onmouseenter="enter('-4263515828536000223');" onmouseout="out('-4263515828536000223');" style=""> 325                     if (offerCode.getOffer() != null) {                                                  </span>
<span class="8507823172595815939" onmouseenter="enter('8507823172595815939');" onmouseout="out('8507823172595815939');" style=""><abbr title=" 326                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 326                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCðŸ”µ</abbr></span>
<span class="-4217337457935304447" onmouseenter="enter('-4217337457935304447');" onmouseout="out('-4217337457935304447');" style=""><abbr title=" 327                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 327                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOfðŸ”µ</abbr></span>
<span class="-6104864632261418874" onmouseenter="enter('-6104864632261418874');" onmouseout="out('-6104864632261418874');" style=""> 328                             em.refresh(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 329                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 330                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 331                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 332             }                                                                                            </span>
<span  style=""> 333                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 334             @Override                                                                                    </span>
<span class="1336357167460974281" onmouseenter="enter('1336357167460974281');" onmouseout="out('1336357167460974281');" style=""> 335             public boolean shouldRetryOnTransactionLockAcquisitionFailure() {                            </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 336                 return true;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 337             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 338         }, RuntimeException.class);                                                                      </span>
<span  style=""> 339                                                                                                          </span>
<span class="720292142172901868" onmouseenter="enter('720292142172901868');" onmouseout="out('720292142172901868');" style=""> 340         return orderOfferCodes;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 341     }                                                                                                    </span>
<span  style=""> 342                                                                                                          </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 343     /*                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 344      *                                                                                                   </span>
<span class="-1078885518483632555" onmouseenter="enter('-1078885518483632555');" onmouseout="out('-1078885518483632555');" style=""> 345      * Offers Logic:                                                                                     </span>
<span class="-6544489594486398439" onmouseenter="enter('-6544489594486398439');" onmouseout="out('-6544489594486398439');" style=""> 346      * 1) Remove all existing offers in the Order (order, item, and fulfillment)                         </span>
<span class="472654013095872963" onmouseenter="enter('472654013095872963');" onmouseout="out('472654013095872963');" style=""> 347      * 2) Check and remove offers                                                                        </span>
<span class="8111384560802328496" onmouseenter="enter('8111384560802328496');" onmouseout="out('8111384560802328496');" style=""> 348      *    a) Remove out of date offers                                                                   </span>
<span class="3025649188866691570" onmouseenter="enter('3025649188866691570');" onmouseout="out('3025649188866691570');" style=""> 349      *    b) Remove offers that do not apply to this customer                                            </span>
<span class="5156402814943015913" onmouseenter="enter('5156402814943015913');" onmouseout="out('5156402814943015913');" style=""> 350      * 3) Loop through offers                                                                            </span>
<span class="6235203245796610706" onmouseenter="enter('6235203245796610706');" onmouseout="out('6235203245796610706');" style=""> 351      *    a) Verifies type of offer (order, order item, fulfillment)                                     </span>
<span class="7315686159335672158" onmouseenter="enter('7315686159335672158');" onmouseout="out('7315686159335672158');" style=""> 352      *    b) Verifies if offer can be applies                                                            </span>
<span class="-6634234506054969031" onmouseenter="enter('-6634234506054969031');" onmouseout="out('-6634234506054969031');" style=""> 353      *    c) Assign offer to type (order, order item, or fulfillment)                                    </span>
<span class="-4584093434328536587" onmouseenter="enter('-4584093434328536587');" onmouseout="out('-4584093434328536587');" style=""> 354      * 4) Sorts the order and item offers list by priority and then discount                             </span>
<span class="-2042995489836168848" onmouseenter="enter('-2042995489836168848');" onmouseout="out('-2042995489836168848');" style=""> 355      * 5) Identify the best offers to apply to order item and create adjustments for each item offer     </span>
<span class="8597383329030492662" onmouseenter="enter('8597383329030492662');" onmouseout="out('8597383329030492662');" style=""><abbr title=" 356      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better"> 356      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is betðŸ”µ</abbr></span>
<span class="-5003028621529242985" onmouseenter="enter('-5003028621529242985');" onmouseout="out('-5003028621529242985');" style=""> 357      * 7) Identify the best offers to apply to the order and create adjustments for each order offer     </span>
<span class="-1324083657955785943" onmouseenter="enter('-1324083657955785943');" onmouseout="out('-1324083657955785943');" style=""><abbr title=" 358      * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 358      * 8) If item contains non-combinable offers remove either the item or order adjustments based on disðŸ”µ</abbr></span>
<span class="-8610949319074908232" onmouseenter="enter('-8610949319074908232');" onmouseout="out('-8610949319074908232');" style=""> 359      * 9) Set final order item prices and reapply order offers                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 360      *                                                                                                   </span>
<span class="9071544830737596533" onmouseenter="enter('9071544830737596533');" onmouseout="out('9071544830737596533');" style=""> 361      * Assumptions:                                                                                      </span>
<span class="7676524731541901514" onmouseenter="enter('7676524731541901514');" onmouseout="out('7676524731541901514');" style=""> 362      * 1) % off all items will be created as an item offer with no expression                            </span>
<span class="-814522364757940962" onmouseenter="enter('-814522364757940962');" onmouseout="out('-814522364757940962');" style=""> 363      * 2) $ off order will be created as an order offer                                                  </span>
<span class="7365449813142531261" onmouseenter="enter('7365449813142531261');" onmouseout="out('7365449813142531261');" style=""> 364      * 3) Order offers applies to the best price for each item (not just retail price)                   </span>
<span class="-1636653647835076359" onmouseenter="enter('-1636653647835076359');" onmouseout="out('-1636653647835076359');" style=""> 365      * 4) Fulfillment offers apply to best price for each item (not just retail price)                   </span>
<span class="-5866280996345915157" onmouseenter="enter('-5866280996345915157');" onmouseout="out('-5866280996345915157');" style=""><abbr title=" 366      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 366      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used witðŸ”µ</abbr></span>
<span class="-8022045642448063338" onmouseenter="enter('-8022045642448063338');" onmouseout="out('-8022045642448063338');" style=""> 367      * 6) Fulfillment offers cannot be not combinable                                                    </span>
<span class="-5108644804585013203" onmouseenter="enter('-5108644804585013203');" onmouseout="out('-5108644804585013203');" style=""> 368      * 7) Order offers cannot be FIXED_PRICE                                                             </span>
<span class="6161153439596163093" onmouseenter="enter('6161153439596163093');" onmouseout="out('6161153439596163093');" style=""> 369      * 8) FIXED_PRICE offers cannot be stackable                                                         </span>
<span class="7044504232316014062" onmouseenter="enter('7044504232316014062');" onmouseout="out('7044504232316014062');" style=""><abbr title=" 370      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 370      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will alðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 371      *                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 372      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 373     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 374     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-4704847871427432866" onmouseenter="enter('-4704847871427432866');" onmouseout="out('-4704847871427432866');" style=""> 375     public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {    </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 376         /*                                                                                               </span>
<span class="-6180845550366984877" onmouseenter="enter('-6180845550366984877');" onmouseout="out('-6180845550366984877');" style=""> 377         TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to </span>
<span class="9161254164549280190" onmouseenter="enter('9161254164549280190');" onmouseout="out('9161254164549280190');" style=""> 378         use a richer object to describe the parameters of the pricing call. This object would include    </span>
<span class="1561516658361300705" onmouseenter="enter('1561516658361300705');" onmouseout="out('1561516658361300705');" style=""> 379         the pricing boolean, but would also include a list of activities to include or exclude in the    </span>
<span class="-6797832594843538707" onmouseenter="enter('-6797832594843538707');" onmouseout="out('-6797832594843538707');" style=""> 380         call - see http://jira.broadleafcommerce.org/browse/BLC-664                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 381          */                                                                                              </span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 382         OfferContext offerContext = OfferContext.getOfferContext();                                      </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 383         if (offerContext == null || offerContext.executePromotionCalculation) {                          </span>
<span class="-2683885994659783076" onmouseenter="enter('-2683885994659783076');" onmouseout="out('-2683885994659783076');" style=""> 384             PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false); </span>
<span class="-9066266687178937853" onmouseenter="enter('-9066266687178937853');" onmouseout="out('-9066266687178937853');" style=""> 385             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());  </span>
<span class="-1421782411503697087" onmouseenter="enter('-1421782411503697087');" onmouseout="out('-1421782411503697087');" style=""> 386             if ((filteredOffers == null) || (filteredOffers.isEmpty())) {                                </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 387                 if (LOG.isTraceEnabled()) {                                                              </span>
<span class="2760579588161124045" onmouseenter="enter('2760579588161124045');" onmouseout="out('2760579588161124045');" style=""> 388                     LOG.trace(&quot;No offers applicable to this order.&quot;);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 389                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 390             } else {                                                                                     </span>
<span class="7300520529047311728" onmouseenter="enter('7300520529047311728');" onmouseout="out('7300520529047311728');" style=""><abbr title=" 391                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 391                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidðŸ”µ</abbr></span>
<span class="-7404348590242143631" onmouseenter="enter('-7404348590242143631');" onmouseout="out('-7404348590242143631');" style=""><abbr title=" 392                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 392                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr></span>
<span  style=""> 393                                                                                                          </span>
<span class="-5526882442984993330" onmouseenter="enter('-5526882442984993330');" onmouseout="out('-5526882442984993330');" style=""><abbr title=" 394                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 394                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, quðŸ”µ</abbr></span>
<span  style=""> 395                                                                                                          </span>
<span class="-6480919216777131248" onmouseenter="enter('-6480919216777131248');" onmouseout="out('-6480919216777131248');" style=""> 396                 if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {               </span>
<span class="-2723881742436166059" onmouseenter="enter('-2723881742436166059');" onmouseout="out('-2723881742436166059');" style=""><abbr title=" 397                     // At this point, we should have a PromotableOrder that contains PromotableItems each of which"> 397                     // At this point, we should have a PromotableOrder that contains PromotableItems eachðŸ”µ</abbr></span>
<span class="751015906320167144" onmouseenter="enter('751015906320167144');" onmouseout="out('751015906320167144');" style=""> 398                     // has a list of candidatePromotions that might be applied.                          </span>
<span  style=""> 399                                                                                                          </span>
<span class="5941864862011378901" onmouseenter="enter('5941864862011378901');" onmouseout="out('5941864862011378901');" style=""><abbr title=" 400                     // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 400                     // We also have a list of orderOffers that might apply and a list of itemOffers that ðŸ”µ</abbr></span>
<span class="1127078869550353626" onmouseenter="enter('1127078869550353626');" onmouseout="out('1127078869550353626');" style=""><abbr title=" 401                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 401                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 402                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 403             }                                                                                            </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 404             orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                        </span>
<span  style=""> 405                                                                                                          </span>
<span class="514986819999277890" onmouseenter="enter('514986819999277890');" onmouseout="out('514986819999277890');" style=""> 406             verifyAdjustments(order, true);                                                              </span>
<span  style=""> 407                                                                                                          </span>
<span class="-8901364638816691349" onmouseenter="enter('-8901364638816691349');" onmouseout="out('-8901364638816691349');" style=""> 408             order.setSubTotal(order.calculateSubTotal());                                                </span>
<span class="8881079200386597596" onmouseenter="enter('8881079200386597596');" onmouseout="out('8881079200386597596');" style=""> 409             order.finalizeItemPrices();                                                                  </span>
<span  style=""> 410                                                                                                          </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 411             order = orderService.save(order, false);                                                     </span>
<span  style=""> 412                                                                                                          </span>
<span class="-5335273514929397197" onmouseenter="enter('-5335273514929397197');" onmouseout="out('-5335273514929397197');" style=""> 413             boolean madeChange = verifyAdjustments(order, false);                                        </span>
<span class="-3218959195648057803" onmouseenter="enter('-3218959195648057803');" onmouseout="out('-3218959195648057803');" style=""> 414             if (madeChange) {                                                                            </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 415                 order = orderService.save(order, false);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 416             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 417         }                                                                                                </span>
<span  style=""> 418                                                                                                          </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 419         return order;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 420     }                                                                                                    </span>
<span  style=""> 421                                                                                                          </span>
<span class="219209447823395758" onmouseenter="enter('219209447823395758');" onmouseout="out('219209447823395758');" style=""> 422     protected boolean verifyAdjustments(Order order, boolean beforeSave) {                               </span>
<span class="79408939766017075" onmouseenter="enter('79408939766017075');" onmouseout="out('79408939766017075');" style=""> 423         boolean madeChange = false;                                                                      </span>
<span  style=""> 424                                                                                                          </span>
<span class="-8966123689509035198" onmouseenter="enter('-8966123689509035198');" onmouseout="out('-8966123689509035198');" style=""> 425         if (order.getOrderItems() == null) {                                                             </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 426             return madeChange;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 427         }                                                                                                </span>
<span  style=""> 428                                                                                                          </span>
<span class="8447029191885982498" onmouseenter="enter('8447029191885982498');" onmouseout="out('8447029191885982498');" style=""> 429         for (OrderItem oi : order.getOrderItems()) {                                                     </span>
<span class="-5982197742320851056" onmouseenter="enter('-5982197742320851056');" onmouseout="out('-5982197742320851056');" style=""> 430             if (oi.getOrderItemPriceDetails() == null) {                                                 </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 431                 continue;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 432             }                                                                                            </span>
<span  style=""> 433                                                                                                          </span>
<span class="7391296704731194189" onmouseenter="enter('7391296704731194189');" onmouseout="out('7391296704731194189');" style=""> 434             for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {                              </span>
<span class="-8259157388002947293" onmouseenter="enter('-8259157388002947293');" onmouseout="out('-8259157388002947293');" style=""> 435                 if (pd.getOrderItemPriceDetailAdjustments() == null) {                                   </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 436                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 437                 }                                                                                        </span>
<span  style=""> 438                                                                                                          </span>
<span class="-8160497408394725913" onmouseenter="enter('-8160497408394725913');" onmouseout="out('-8160497408394725913');" style=""><abbr title=" 439                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 439                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdðŸ”µ</abbr></span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 440                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 440                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDeðŸ”µ</abbr></span>
<span class="-3008507732031274392" onmouseenter="enter('-3008507732031274392');" onmouseout="out('-3008507732031274392');" style=""> 441                 for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {     </span>
<span class="-1975641521768786423" onmouseenter="enter('-1975641521768786423');" onmouseout="out('-1975641521768786423');" style=""> 442                     if (adjs.containsKey(adj.getOffer().getId())) {                                      </span>
<span class="-6913168070672082713" onmouseenter="enter('-6913168070672082713');" onmouseout="out('-6913168070672082713');" style=""> 443                         adjustmentsToRemove.add(adj);                                                    </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 444                         if (LOG.isDebugEnabled()) {                                                      </span>
<span class="-2834336870885753779" onmouseenter="enter('-2834336870885753779');" onmouseout="out('-2834336870885753779');" style=""> 445                             StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)                 </span>
<span class="201513945492742471" onmouseenter="enter('201513945492742471');" onmouseout="out('201513945492742471');" style=""> 446                                 .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)                   </span>
<span class="2195430440089355634" onmouseenter="enter('2195430440089355634');" onmouseout="out('2195430440089355634');" style=""> 447                                 .append(&quot; with ids &quot;)                                                    </span>
<span class="-3149719647859419210" onmouseenter="enter('-3149719647859419210');" onmouseout="out('-3149719647859419210');" style=""> 448                                 .append(adjs.get(adj.getOffer().getId()).getId())                        </span>
<span class="7312533819175146387" onmouseenter="enter('7312533819175146387');" onmouseout="out('7312533819175146387');" style=""> 449                                 .append(&quot; and &quot;)                                                         </span>
<span class="6832270653349147085" onmouseenter="enter('6832270653349147085');" onmouseout="out('6832270653349147085');" style=""> 450                                 .append(adj.getId());                                                    </span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 451                             LOG.debug(sb.toString());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 452                         }                                                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 453                     } else {                                                                             </span>
<span class="-7759509127049565554" onmouseenter="enter('-7759509127049565554');" onmouseout="out('-7759509127049565554');" style=""> 454                         adjs.put(adj.getOffer().getId(), adj);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 455                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 456                 }                                                                                        </span>
<span  style=""> 457                                                                                                          </span>
<span class="7848730128284985932" onmouseenter="enter('7848730128284985932');" onmouseout="out('7848730128284985932');" style=""> 458                 for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {                         </span>
<span class="6756116260498887863" onmouseenter="enter('6756116260498887863');" onmouseout="out('6756116260498887863');" style=""> 459                     pd.getOrderItemPriceDetailAdjustments().remove(adj);                                 </span>
<span class="5571803755205047298" onmouseenter="enter('5571803755205047298');" onmouseout="out('5571803755205047298');" style=""> 460                     madeChange = true;                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 461                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 462             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 463         }                                                                                                </span>
<span  style=""> 464                                                                                                          </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 465         return madeChange;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 466      }                                                                                                   </span>
<span  style=""> 467                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 468     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 469     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 470     @Deprecated                                                                                          </span>
<span class="-3021599232242429775" onmouseenter="enter('-3021599232242429775');" onmouseout="out('-3021599232242429775');" style=""> 471     public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {            </span>
<span class="-6341015309393843959" onmouseenter="enter('-6341015309393843959');" onmouseout="out('-6341015309393843959');" style=""> 472         applyAndSaveOffersToOrder(offers, order);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 473     }                                                                                                    </span>
<span  style=""> 474                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 475     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 476     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 477     @Deprecated                                                                                          </span>
<span class="-5535279977913938928" onmouseenter="enter('-5535279977913938928');" onmouseout="out('-5535279977913938928');" style=""><abbr title=" 478     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 478     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptiðŸ”µ</abbr></span>
<span class="6394386461467124428" onmouseenter="enter('6394386461467124428');" onmouseout="out('6394386461467124428');" style=""> 479         applyAndSaveFulfillmentGroupOffersToOrder(offers, order);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 480     }                                                                                                    </span>
<span  style=""> 481                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 482     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 483     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="2855881782634007850" onmouseenter="enter('2855881782634007850');" onmouseout="out('2855881782634007850');" style=""><abbr title=" 484     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 484     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricinðŸ”µ</abbr></span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 485         OfferContext offerContext = OfferContext.getOfferContext();                                      </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 486         if (offerContext == null || offerContext.executePromotionCalculation) {                          </span>
<span class="-791836473256513905" onmouseenter="enter('-791836473256513905');" onmouseout="out('-791836473256513905');" style=""> 487             PromotableOrder promotableOrder =                                                            </span>
<span class="-5771222684966163235" onmouseenter="enter('-5771222684966163235');" onmouseout="out('-5771222684966163235');" style=""> 488                     promotableItemFactory.createPromotableOrder(order, true);                            </span>
<span class="-6252467951249219732" onmouseenter="enter('-6252467951249219732');" onmouseout="out('-6252467951249219732');" style=""> 489             List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();                                       </span>
<span class="-8689854403875612694" onmouseenter="enter('-8689854403875612694');" onmouseout="out('-8689854403875612694');" style=""> 490             for (Offer offer : offers) {                                                                 </span>
<span class="3344482016035270743" onmouseenter="enter('3344482016035270743');" onmouseout="out('3344482016035270743');" style=""> 491                 if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {           </span>
<span class="2965579239059640859" onmouseenter="enter('2965579239059640859');" onmouseout="out('2965579239059640859');" style=""> 492                     possibleFGOffers.add(offer);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 493                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 494             }                                                                                            </span>
<span class="7272445213685933500" onmouseenter="enter('7272445213685933500');" onmouseout="out('7272445213685933500');" style=""><abbr title=" 495             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());"> 495             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustðŸ”µ</abbr></span>
<span class="-380250791493510209" onmouseenter="enter('-380250791493510209');" onmouseout="out('-380250791493510209');" style=""><abbr title=" 496             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 496             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCaðŸ”µ</abbr></span>
<span class="5471512156259214352" onmouseenter="enter('5471512156259214352');" onmouseout="out('5471512156259214352');" style=""> 497             for (Offer offer : filteredOffers) {                                                         </span>
<span class="6341701119621727258" onmouseenter="enter('6341701119621727258');" onmouseout="out('6341701119621727258');" style=""><abbr title=" 498                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 498                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifieðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 499             }                                                                                            </span>
<span class="6757974448768463" onmouseenter="enter('6757974448768463');" onmouseout="out('6757974448768463');" style=""> 500             if (!qualifiedFGOffers.isEmpty()) {                                                          </span>
<span class="-3737539762239464744" onmouseenter="enter('-3737539762239464744');" onmouseout="out('-3737539762239464744');" style=""><abbr title=" 501                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);"> 501                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotabðŸ”µ</abbr></span>
<span class="-1748187190347404908" onmouseenter="enter('-1748187190347404908');" onmouseout="out('-1748187190347404908');" style=""> 502                 fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);          </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 503                 orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 504             }                                                                                            </span>
<span  style=""> 505                                                                                                          </span>
<span class="-7204486914274790826" onmouseenter="enter('-7204486914274790826');" onmouseout="out('-7204486914274790826');" style=""> 506             return orderService.save(order, false);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 507         }                                                                                                </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 508         return order;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 509     }                                                                                                    </span>
<span  style=""> 510                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 511     @Override                                                                                            </span>
<span class="-8983195686564092827" onmouseenter="enter('-8983195686564092827');" onmouseout="out('-8983195686564092827');" style=""> 512     public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {                           </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 513         if (offer.isLimitedUsePerCustomer()) {                                                           </span>
<span class="-3564809625752937907" onmouseenter="enter('-3564809625752937907');" onmouseout="out('-3564809625752937907');" style=""> 514             CustomerMaxUsesStrategyType strategy = offer.getMaxUsesStrategyType();                       </span>
<span class="-8350632326266801195" onmouseenter="enter('-8350632326266801195');" onmouseout="out('-8350632326266801195');" style=""><abbr title=" 515             boolean checkUsingCustomer = (strategy == null) || strategy.equals(CustomerMaxUsesStrategyType.CUSTOMER);"> 515             boolean checkUsingCustomer = (strategy == null) || strategy.equals(CustomerMaxUsesStrategyTypðŸ”µ</abbr></span>
<span class="-4186001467963498158" onmouseenter="enter('-4186001467963498158');" onmouseout="out('-4186001467963498158');" style=""> 516             Long currentUses;                                                                            </span>
<span class="943186304180287912" onmouseenter="enter('943186304180287912');" onmouseout="out('943186304180287912');" style=""> 517             if (checkUsingCustomer) {                                                                    </span>
<span class="7194263595725243761" onmouseenter="enter('7194263595725243761');" onmouseout="out('7194263595725243761');" style=""><abbr title=" 518                 currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 518                 currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), oðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 519             } else {                                                                                     </span>
<span class="5949149386596450267" onmouseenter="enter('5949149386596450267');" onmouseout="out('5949149386596450267');" style=""><abbr title=" 520                 currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 520                 currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 521             }                                                                                            </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 522             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 523                 return false;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 524             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 525         }                                                                                                </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 526         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 527     }                                                                                                    </span>
<span  style=""> 528                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 529     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 530     @Override                                                                                            </span>
<span class="4849754295577860926" onmouseenter="enter('4849754295577860926');" onmouseout="out('4849754295577860926');" style=""> 531     public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {                     </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 532         if (offer.isLimitedUsePerCustomer()) {                                                           </span>
<span class="8084739095609490454" onmouseenter="enter('8084739095609490454');" onmouseout="out('8084739095609490454');" style=""> 533             Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());   </span>
<span  style=""> 534                                                                                                          </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 535             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 536                 return false;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 537             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 538         }                                                                                                </span>
<span  style=""> 539                                                                                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 540         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 541     }                                                                                                    </span>
<span  style=""> 542                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 543     @Override                                                                                            </span>
<span class="-4305912419408886648" onmouseenter="enter('-4305912419408886648');" onmouseout="out('-4305912419408886648');" style=""> 544     public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {                        </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 545         boolean underCodeMaxUses = true;                                                                 </span>
<span  style=""> 546                                                                                                          </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 547         if (code.isLimitedUse()) {                                                                       </span>
<span class="-7378740545085856894" onmouseenter="enter('-7378740545085856894');" onmouseout="out('-7378740545085856894');" style=""> 548             Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());            </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 549             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 550         }                                                                                                </span>
<span  style=""> 551                                                                                                          </span>
<span class="5446263071698048925" onmouseenter="enter('5446263071698048925');" onmouseout="out('5446263071698048925');" style=""> 552         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 553     }                                                                                                    </span>
<span  style=""> 554                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 555     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 556     @Override                                                                                            </span>
<span class="135967723667379112" onmouseenter="enter('135967723667379112');" onmouseout="out('135967723667379112');" style=""> 557     public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {                  </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 558         boolean underCodeMaxUses = true;                                                                 </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 559         if (code.isLimitedUse()) {                                                                       </span>
<span class="5487567461678823803" onmouseenter="enter('5487567461678823803');" onmouseout="out('5487567461678823803');" style=""> 560             Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());                   </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 561             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 562         }                                                                                                </span>
<span class="7193079189056024188" onmouseenter="enter('7193079189056024188');" onmouseout="out('7193079189056024188');" style=""> 563         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 564     }                                                                                                    </span>
<span  style=""> 565                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 566     @Override                                                                                            </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 567     @SuppressWarnings(&quot;unchecked&quot;)                                                                       </span>
<span class="-640784293225096821" onmouseenter="enter('-640784293225096821');" onmouseout="out('-640784293225096821');" style=""> 568     public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {                                            </span>
<span class="-348027159212233091" onmouseenter="enter('-348027159212233091');" onmouseout="out('-348027159212233091');" style=""> 569         HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();                                                    </span>
<span  style=""> 570                                                                                                          </span>
<span class="-7949809618309864364" onmouseenter="enter('-7949809618309864364');" onmouseout="out('-7949809618309864364');" style=""> 571         Transformer adjustmentToOfferTransformer = new Transformer() {                                   </span>
<span  style=""> 572                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 573             @Override                                                                                    </span>
<span class="-2718541205900117239" onmouseenter="enter('-2718541205900117239');" onmouseout="out('-2718541205900117239');" style=""> 574             public Object transform(Object input) {                                                      </span>
<span class="4176981446584954696" onmouseenter="enter('4176981446584954696');" onmouseout="out('4176981446584954696');" style=""> 575                 return ((Adjustment)input).getOffer();                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 576             }                                                                                            </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 577         };                                                                                               </span>
<span  style=""> 578                                                                                                          </span>
<span class="-8370514600917699300" onmouseenter="enter('-8370514600917699300');" onmouseout="out('-8370514600917699300');" style=""><abbr title=" 579         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));"> 579         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer))ðŸ”µ</abbr></span>
<span  style=""> 580                                                                                                          </span>
<span class="3897119298100986011" onmouseenter="enter('3897119298100986011');" onmouseout="out('3897119298100986011');" style=""> 581         if (order.getOrderItems() != null) {                                                             </span>
<span class="820796442257070700" onmouseenter="enter('820796442257070700');" onmouseout="out('820796442257070700');" style=""> 582             for (OrderItem item : order.getOrderItems()) {                                               </span>
<span class="722957474719034118" onmouseenter="enter('722957474719034118');" onmouseout="out('722957474719034118');" style=""><abbr title=" 583                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 583                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTrðŸ”µ</abbr></span>
<span  style=""> 584                                                                                                          </span>
<span class="-3519908190158496681" onmouseenter="enter('-3519908190158496681');" onmouseout="out('-3519908190158496681');" style=""> 585                 //record usage for price details on the item as well                                     </span>
<span class="-2952948196187271811" onmouseenter="enter('-2952948196187271811');" onmouseout="out('-2952948196187271811');" style=""> 586                 if (item.getOrderItemPriceDetails() != null) {                                           </span>
<span class="773323050474809935" onmouseenter="enter('773323050474809935');" onmouseout="out('773323050474809935');" style=""> 587                     for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {                </span>
<span class="7134713472391876911" onmouseenter="enter('7134713472391876911');" onmouseout="out('7134713472391876911');" style=""><abbr title=" 588                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 588                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments()ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 589                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 590                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 591             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 592         }                                                                                                </span>
<span  style=""> 593                                                                                                          </span>
<span class="7944520279780748823" onmouseenter="enter('7944520279780748823');" onmouseout="out('7944520279780748823');" style=""> 594         if (order.getFulfillmentGroups() != null) {                                                      </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 595             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                   </span>
<span class="-293187079687761920" onmouseenter="enter('-293187079687761920');" onmouseout="out('-293187079687761920');" style=""><abbr title=" 596                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 596                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 597             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 598         }                                                                                                </span>
<span class="-6419540350677864751" onmouseenter="enter('-6419540350677864751');" onmouseout="out('-6419540350677864751');" style=""> 599         return result;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 600     }                                                                                                    </span>
<span  style=""> 601                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 602     @Override                                                                                            </span>
<span class="-2491837224879773303" onmouseenter="enter('-2491837224879773303');" onmouseout="out('-2491837224879773303');" style=""> 603     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {                             </span>
<span class="-1370687283458217641" onmouseenter="enter('-1370687283458217641');" onmouseout="out('-1370687283458217641');" style=""> 604         return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order)); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 605     }                                                                                                    </span>
<span  style=""> 606                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 607     @Override                                                                                            </span>
<span class="-6407317956511861474" onmouseenter="enter('-6407317956511861474');" onmouseout="out('-6407317956511861474');" style=""><abbr title=" 608     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {"> 608     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffðŸ”µ</abbr></span>
<span class="-4490485247927949218" onmouseenter="enter('-4490485247927949218');" onmouseout="out('-4490485247927949218');" style=""> 609         HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();                  </span>
<span class="983580358500385861" onmouseenter="enter('983580358500385861');" onmouseout="out('983580358500385861');" style=""> 610         for (OfferCode code : codes) {                                                                   </span>
<span class="6305098044991751707" onmouseenter="enter('6305098044991751707');" onmouseout="out('6305098044991751707');" style=""> 611             if (appliedOffers.contains(code.getOffer())) {                                               </span>
<span class="3746501443462939384" onmouseenter="enter('3746501443462939384');" onmouseout="out('3746501443462939384');" style=""> 612                 offerToCodeMapping.put(code.getOffer(), code);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 613             }                                                                                            </span>
<span  style=""> 614                                                                                                          </span>
<span class="-240986298797431748" onmouseenter="enter('-240986298797431748');" onmouseout="out('-240986298797431748');" style=""> 615             List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();                            </span>
<span  style=""> 616                                                                                                          </span>
<span class="7454577566794152811" onmouseenter="enter('7454577566794152811');" onmouseout="out('7454577566794152811');" style=""> 617             extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);   </span>
<span class="-7985615425314556326" onmouseenter="enter('-7985615425314556326');" onmouseout="out('-7985615425314556326');" style=""> 618             for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {                       </span>
<span class="-808811284028256215" onmouseenter="enter('-808811284028256215');" onmouseout="out('-808811284028256215');" style=""> 619                 offerToCodeMapping.put(additionalOfferToBeApplied, code);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 620             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 621         }                                                                                                </span>
<span class="7175253914401568841" onmouseenter="enter('7175253914401568841');" onmouseout="out('7175253914401568841');" style=""> 622         return offerToCodeMapping;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 623     }                                                                                                    </span>
<span  style=""> 624                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 625     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 626     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-1347767159915315738" onmouseenter="enter('-1347767159915315738');" onmouseout="out('-1347767159915315738');" style=""> 627     public Boolean deleteOfferCode(OfferCode code) {                                                     </span>
<span class="-5986603348121186173" onmouseenter="enter('-5986603348121186173');" onmouseout="out('-5986603348121186173');" style=""> 628         if (offerCodeDao.offerCodeIsUsed(code)) {                                                        </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 629             return false;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 630         }                                                                                                </span>
<span  style=""> 631                                                                                                          </span>
<span class="-9122073777393685295" onmouseenter="enter('-9122073777393685295');" onmouseout="out('-9122073777393685295');" style=""> 632         offerCodeDao.delete(code);                                                                       </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 633         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 634     }                                                                                                    </span>
<span  style=""> 635                                                                                                          </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 636     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 637     @Override                                                                                            </span>
<span class="-3816301958562278169" onmouseenter="enter('-3816301958562278169');" onmouseout="out('-3816301958562278169');" style=""> 638     public Offer duplicate(Long originalOfferId) {                                                       </span>
<span class="5769078866234041335" onmouseenter="enter('5769078866234041335');" onmouseout="out('5769078866234041335');" style=""> 639         return duplicator.copy(OfferImpl.class, originalOfferId);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 640     }                                                                                                    </span>
<span  style=""> 641                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 642     @Override                                                                                            </span>
<span class="3228088005821970316" onmouseenter="enter('3228088005821970316');" onmouseout="out('3228088005821970316');" style=""> 643     public CustomerOfferDao getCustomerOfferDao() {                                                      </span>
<span class="-801333879424417122" onmouseenter="enter('-801333879424417122');" onmouseout="out('-801333879424417122');" style=""> 644         return customerOfferDao;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 645     }                                                                                                    </span>
<span  style=""> 646                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 647     @Override                                                                                            </span>
<span class="6308179313298689001" onmouseenter="enter('6308179313298689001');" onmouseout="out('6308179313298689001');" style=""> 648     public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {                                 </span>
<span class="438520929977701037" onmouseenter="enter('438520929977701037');" onmouseout="out('438520929977701037');" style=""> 649         this.customerOfferDao = customerOfferDao;                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 650     }                                                                                                    </span>
<span  style=""> 651                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 652     @Override                                                                                            </span>
<span class="8266606365944954497" onmouseenter="enter('8266606365944954497');" onmouseout="out('8266606365944954497');" style=""> 653     public OfferCodeDao getOfferCodeDao() {                                                              </span>
<span class="-4005874311041664572" onmouseenter="enter('-4005874311041664572');" onmouseout="out('-4005874311041664572');" style=""> 654         return offerCodeDao;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 655     }                                                                                                    </span>
<span  style=""> 656                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 657     @Override                                                                                            </span>
<span class="-5083072655758254890" onmouseenter="enter('-5083072655758254890');" onmouseout="out('-5083072655758254890');" style=""> 658     public void setOfferCodeDao(OfferCodeDao offerCodeDao) {                                             </span>
<span class="-7060255547979502806" onmouseenter="enter('-7060255547979502806');" onmouseout="out('-7060255547979502806');" style=""> 659         this.offerCodeDao = offerCodeDao;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 660     }                                                                                                    </span>
<span  style=""> 661                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 662     @Override                                                                                            </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 663     public OfferDao getOfferDao() {                                                                      </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 664         return offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 665     }                                                                                                    </span>
<span  style=""> 666                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 667     @Override                                                                                            </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 668     public void setOfferDao(OfferDao offerDao) {                                                         </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 669         this.offerDao = offerDao;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 670     }                                                                                                    </span>
<span  style=""> 671                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 672     @Override                                                                                            </span>
<span class="3012408951835963759" onmouseenter="enter('3012408951835963759');" onmouseout="out('3012408951835963759');" style=""> 673     public OrderOfferProcessor getOrderOfferProcessor() {                                                </span>
<span class="-5069105522766505260" onmouseenter="enter('-5069105522766505260');" onmouseout="out('-5069105522766505260');" style=""> 674         return orderOfferProcessor;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 675     }                                                                                                    </span>
<span  style=""> 676                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 677     @Override                                                                                            </span>
<span class="-2542583147665382651" onmouseenter="enter('-2542583147665382651');" onmouseout="out('-2542583147665382651');" style=""> 678     public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {                        </span>
<span class="1533378703496715943" onmouseenter="enter('1533378703496715943');" onmouseout="out('1533378703496715943');" style=""> 679         this.orderOfferProcessor = orderOfferProcessor;                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 680     }                                                                                                    </span>
<span  style=""> 681                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 682     @Override                                                                                            </span>
<span class="1694843298235251985" onmouseenter="enter('1694843298235251985');" onmouseout="out('1694843298235251985');" style=""> 683     public ItemOfferProcessor getItemOfferProcessor() {                                                  </span>
<span class="1583504692330339191" onmouseenter="enter('1583504692330339191');" onmouseout="out('1583504692330339191');" style=""> 684         return itemOfferProcessor;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 685     }                                                                                                    </span>
<span  style=""> 686                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 687     @Override                                                                                            </span>
<span class="145400756853488798" onmouseenter="enter('145400756853488798');" onmouseout="out('145400756853488798');" style=""> 688     public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {                           </span>
<span class="-102405468021411755" onmouseenter="enter('-102405468021411755');" onmouseout="out('-102405468021411755');" style=""> 689         this.itemOfferProcessor = itemOfferProcessor;                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 690     }                                                                                                    </span>
<span  style=""> 691                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 692     @Override                                                                                            </span>
<span class="3022939772369206873" onmouseenter="enter('3022939772369206873');" onmouseout="out('3022939772369206873');" style=""> 693     public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {                          </span>
<span class="-3088775944214719317" onmouseenter="enter('-3088775944214719317');" onmouseout="out('-3088775944214719317');" style=""> 694         return fulfillmentGroupOfferProcessor;                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 695     }                                                                                                    </span>
<span  style=""> 696                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 697     @Override                                                                                            </span>
<span class="-8855456203149015957" onmouseenter="enter('-8855456203149015957');" onmouseout="out('-8855456203149015957');" style=""><abbr title=" 698     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {"> 698     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProðŸ”µ</abbr></span>
<span class="-7108053920330155376" onmouseenter="enter('-7108053920330155376');" onmouseout="out('-7108053920330155376');" style=""> 699         this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 700     }                                                                                                    </span>
<span  style=""> 701                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 702     @Override                                                                                            </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 703     public PromotableItemFactory getPromotableItemFactory() {                                            </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 704         return promotableItemFactory;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 705     }                                                                                                    </span>
<span  style=""> 706                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 707     @Override                                                                                            </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 708     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                  </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 709         this.promotableItemFactory = promotableItemFactory;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 710     }                                                                                                    </span>
<span  style=""> 711                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 712     @Override                                                                                            </span>
<span class="-285725005067991728" onmouseenter="enter('-285725005067991728');" onmouseout="out('-285725005067991728');" style=""> 713     public OfferCode findOfferCodeById(Long id) {                                                        </span>
<span class="4928857363700364693" onmouseenter="enter('4928857363700364693');" onmouseout="out('4928857363700364693');" style=""> 714         return offerCodeDao.readOfferCodeById(id);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 715     }                                                                                                    </span>
<span  style=""> 716                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 717     @Override                                                                                            </span>
<span class="-6829155498814719074" onmouseenter="enter('-6829155498814719074');" onmouseout="out('-6829155498814719074');" style=""> 718     public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {                                   </span>
<span class="-1521639274006709657" onmouseenter="enter('-1521639274006709657');" onmouseout="out('-1521639274006709657');" style=""> 719         return offerCodeDao.readOfferCodesByIds(ids);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 720     }                                                                                                    </span>
<span  style=""> 721                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 722     @Override                                                                                            </span>
<span class="5587340050529616033" onmouseenter="enter('5587340050529616033');" onmouseout="out('5587340050529616033');" style=""> 723     public OrderService getOrderService() {                                                              </span>
<span class="-7558473787756148723" onmouseenter="enter('-7558473787756148723');" onmouseout="out('-7558473787756148723');" style=""> 724         return orderService;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 725     }                                                                                                    </span>
<span  style=""> 726                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 727     @Override                                                                                            </span>
<span class="4536819371590947172" onmouseenter="enter('4536819371590947172');" onmouseout="out('4536819371590947172');" style=""> 728     public void setOrderService(OrderService orderService) {                                             </span>
<span class="7368861914925934250" onmouseenter="enter('7368861914925934250');" onmouseout="out('7368861914925934250');" style=""> 729         this.orderService = orderService;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 730     }                                                                                                    </span>
<span  style=""> 731                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 732     @Override                                                                                            </span>
<span class="-2217088353489190987" onmouseenter="enter('-2217088353489190987');" onmouseout="out('-2217088353489190987');" style=""> 733     public Offer findOfferById(Long offerId) {                                                           </span>
<span class="-5171648678549667040" onmouseenter="enter('-5171648678549667040');" onmouseout="out('-5171648678549667040');" style=""> 734         return offerDao.readOfferById(offerId);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 735     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 736 }                                                                                                        </span>






















</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3   * BroadleafCommerce Framework                                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18  package org.broadleafcommerce.core.offer.service;                                                                 </span>
<span  style="">  19                                                                                                                    </span>
<span class="8596464405353709537" onmouseenter="enter('8596464405353709537');" onmouseout="out('8596464405353709537');" style="">  20  import org.apache.commons.collections.CollectionUtils;                                                            </span>
<span class="2953846583056246827" onmouseenter="enter('2953846583056246827');" onmouseout="out('2953846583056246827');" style="">  21  import org.apache.commons.collections.Transformer;                                                                </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  22  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  23  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="-2193028153657877676" onmouseenter="enter('-2193028153657877676');" onmouseout="out('-2193028153657877676');" style="">  24  import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;                                          </span>
<span class="-3349026188166660873" onmouseenter="enter('-3349026188166660873');" onmouseout="out('-3349026188166660873');" style="">  25  import org.broadleafcommerce.common.persistence.EntityDuplicator;                                                 </span>
<span class="-2818686525334833130" onmouseenter="enter('-2818686525334833130');" onmouseout="out('-2818686525334833130');" style="">  26  import org.broadleafcommerce.common.sandbox.SandBoxHelper;                                                        </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  27  import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                              </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  28  import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                         </span>
<span class="6205208880685044389" onmouseenter="enter('6205208880685044389');" onmouseout="out('6205208880685044389');" style="">  29  import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;                                                     </span>
<span class="-7911436562744873568" onmouseenter="enter('-7911436562744873568');" onmouseout="out('-7911436562744873568');" style="">  30  import org.broadleafcommerce.core.offer.dao.OfferCodeDao;                                                         </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  31  import org.broadleafcommerce.core.offer.dao.OfferDao;                                                             </span>
<span class="-1633608357492319903" onmouseenter="enter('-1633608357492319903');" onmouseout="out('-1633608357492319903');" style="">  32  import org.broadleafcommerce.core.offer.domain.Adjustment;                                                        </span>
<span class="984981432680799531" onmouseenter="enter('984981432680799531');" onmouseout="out('984981432680799531');" style="">  33  import org.broadleafcommerce.core.offer.domain.CustomerOffer;                                                     </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  34  import org.broadleafcommerce.core.offer.domain.Offer;                                                             </span>
<span class="1521662235446319191" onmouseenter="enter('1521662235446319191');" onmouseout="out('1521662235446319191');" style="">  35  import org.broadleafcommerce.core.offer.domain.OfferCode;                                                         </span>
<span class="-7025591891527881733" onmouseenter="enter('-7025591891527881733');" onmouseout="out('-7025591891527881733');" style="">  36  import org.broadleafcommerce.core.offer.domain.OfferImpl;                                                         </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  37  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                                    </span>
<span class="4287099423657810905" onmouseenter="enter('4287099423657810905');" onmouseout="out('4287099423657810905');" style="">  38  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;         </span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  39  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;                     </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;                    </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                            </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  42  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                                  </span>
<span class="5713212224635448284" onmouseenter="enter('5713212224635448284');" onmouseout="out('5713212224635448284');" style="">  43  import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;                         </span>
<span class="-2454758753718589449" onmouseenter="enter('-2454758753718589449');" onmouseout="out('-2454758753718589449');" style="">  44  import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;                                     </span>
<span class="8227287359407176835" onmouseenter="enter('8227287359407176835');" onmouseout="out('8227287359407176835');" style="">  45  import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;                                    </span>
<span class="-2230425701287318422" onmouseenter="enter('-2230425701287318422');" onmouseout="out('-2230425701287318422');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +import org.broadleafcommerce.core.offer.service.type.CustomerMaxUsesStrategyType;                                 </span>
<span class="-5727938558534008634" onmouseenter="enter('-5727938558534008634');" onmouseout="out('-5727938558534008634');" style="">  47  import org.broadleafcommerce.core.offer.service.type.OfferType;                                                   </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  48  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                                  </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  49  import org.broadleafcommerce.core.order.domain.Order;                                                             </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  50  import org.broadleafcommerce.core.order.domain.OrderItem;                                                         </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  51  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                              </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  52  import org.broadleafcommerce.core.order.service.OrderService;                                                     </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  53  import org.broadleafcommerce.core.pricing.service.exception.PricingException;                                     </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  54  import org.broadleafcommerce.profile.core.domain.Customer;                                                        </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  55  import org.springframework.stereotype.Service;                                                                    </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  56  import org.springframework.transaction.annotation.Transactional;                                                  </span>
<span  style="">  57                                                                                                                    </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  58  import java.util.ArrayList;                                                                                       </span>
<span class="-112105277767313938" onmouseenter="enter('-112105277767313938');" onmouseout="out('-112105277767313938');" style="">  59  import java.util.Collection;                                                                                      </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  60  import java.util.HashMap;                                                                                         </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  61  import java.util.HashSet;                                                                                         </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  62  import java.util.Iterator;                                                                                        </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  63  import java.util.List;                                                                                            </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  64  import java.util.Map;                                                                                             </span>
<span class="6306724220981822255" onmouseenter="enter('6306724220981822255');" onmouseout="out('6306724220981822255');" style="">  65  import java.util.Objects;                                                                                         </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  66  import java.util.Set;                                                                                             </span>
<span  style="">  67                                                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  68  import javax.annotation.Resource;                                                                                 </span>
<span class="7911938180110628123" onmouseenter="enter('7911938180110628123');" onmouseout="out('7911938180110628123');" style="">  69  import javax.persistence.EntityManager;                                                                           </span>
<span class="3821515051839343306" onmouseenter="enter('3821515051839343306');" onmouseout="out('3821515051839343306');" style="">  70  import javax.persistence.PersistenceContext;                                                                      </span>
<span  style="">  71                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  72  /**                                                                                                               </span>
<span class="-2667338179687874348" onmouseenter="enter('-2667338179687874348');" onmouseout="out('-2667338179687874348');" style="">  73   * The Class OfferServiceImpl.                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  74   */                                                                                                               </span>
<span class="504450232350438262" onmouseenter="enter('504450232350438262');" onmouseout="out('504450232350438262');" style="">  75  @Service(&quot;blOfferService&quot;)                                                                                        </span>
<span class="6786430150403502423" onmouseenter="enter('6786430150403502423');" onmouseout="out('6786430150403502423');" style="">  76  public class OfferServiceImpl implements OfferService {                                                           </span>
<span  style="">  77                                                                                                                    </span>
<span class="8897944981470617719" onmouseenter="enter('8897944981470617719');" onmouseout="out('8897944981470617719');" style="">  78      private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);                                     </span>
<span  style="">  79                                                                                                                    </span>
<span class="3846751699212951796" onmouseenter="enter('3846751699212951796');" onmouseout="out('3846751699212951796');" style="">  80      // should be called outside of Offer service after Offer service is executed                                  </span>
<span class="-5484979233832760683" onmouseenter="enter('-5484979233832760683');" onmouseout="out('-5484979233832760683');" style="">  81      @Resource(name=&quot;blCustomerOfferDao&quot;)                                                                          </span>
<span class="-5771823415174942027" onmouseenter="enter('-5771823415174942027');" onmouseout="out('-5771823415174942027');" style="">  82      protected CustomerOfferDao customerOfferDao;                                                                  </span>
<span  style="">  83                                                                                                                    </span>
<span class="-1524144969871346405" onmouseenter="enter('-1524144969871346405');" onmouseout="out('-1524144969871346405');" style="">  84      @Resource(name=&quot;blOfferCodeDao&quot;)                                                                              </span>
<span class="-6984238934820524758" onmouseenter="enter('-6984238934820524758');" onmouseout="out('-6984238934820524758');" style="">  85      protected OfferCodeDao offerCodeDao;                                                                          </span>
<span  style="">  86                                                                                                                    </span>
<span class="-8247969455122443370" onmouseenter="enter('-8247969455122443370');" onmouseout="out('-8247969455122443370');" style="">  87      @Resource(name=&quot;blOfferAuditService&quot;)                                                                         </span>
<span class="-6742419488595856311" onmouseenter="enter('-6742419488595856311');" onmouseout="out('-6742419488595856311');" style="">  88      protected OfferAuditService offerAuditService;                                                                </span>
<span  style="">  89                                                                                                                    </span>
<span class="-6976077299079381435" onmouseenter="enter('-6976077299079381435');" onmouseout="out('-6976077299079381435');" style="">  90      @Resource(name=&quot;blOfferDao&quot;)                                                                                  </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  91      protected OfferDao offerDao;                                                                                  </span>
<span  style="">  92                                                                                                                    </span>
<span class="-3191658961867656636" onmouseenter="enter('-3191658961867656636');" onmouseout="out('-3191658961867656636');" style="">  93      @Resource(name=&quot;blOrderOfferProcessor&quot;)                                                                       </span>
<span class="-3818126380928091101" onmouseenter="enter('-3818126380928091101');" onmouseout="out('-3818126380928091101');" style="">  94      protected OrderOfferProcessor orderOfferProcessor;                                                            </span>
<span  style="">  95                                                                                                                    </span>
<span class="-6223428528083119866" onmouseenter="enter('-6223428528083119866');" onmouseout="out('-6223428528083119866');" style="">  96      @Resource(name=&quot;blItemOfferProcessor&quot;)                                                                        </span>
<span class="-7827297227357944415" onmouseenter="enter('-7827297227357944415');" onmouseout="out('-7827297227357944415');" style="">  97      protected ItemOfferProcessor itemOfferProcessor;                                                              </span>
<span  style="">  98                                                                                                                    </span>
<span class="-1476654469985531605" onmouseenter="enter('-1476654469985531605');" onmouseout="out('-1476654469985531605');" style="">  99      @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)                                                            </span>
<span class="7634983124983010999" onmouseenter="enter('7634983124983010999');" onmouseout="out('7634983124983010999');" style=""> 100      protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;                                      </span>
<span  style=""> 101                                                                                                                    </span>
<span class="-4330844585159307437" onmouseenter="enter('-4330844585159307437');" onmouseout="out('-4330844585159307437');" style=""> 102      @Resource(name=&quot;blPromotableItemFactory&quot;)                                                                     </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style=""> 103      protected PromotableItemFactory promotableItemFactory;                                                        </span>
<span  style=""> 104                                                                                                                    </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style=""> 105      @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                            </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style=""> 106      protected OfferServiceExtensionManager extensionManager;                                                      </span>
<span  style=""> 107                                                                                                                    </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 108      @Resource(name = &quot;blOrderService&quot;)                                                                            </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 109      protected OrderService orderService;                                                                          </span>
<span  style=""> 110                                                                                                                    </span>
<span class="-3946461589801993391" onmouseenter="enter('-3946461589801993391');" onmouseout="out('-3946461589801993391');" style=""> 111      @Resource(name = &quot;blSandBoxHelper&quot;)                                                                           </span>
<span class="-7799183597372200632" onmouseenter="enter('-7799183597372200632');" onmouseout="out('-7799183597372200632');" style=""> 112      protected SandBoxHelper sandBoxHelper;                                                                        </span>
<span  style=""> 113                                                                                                                    </span>
<span class="-4259734795637808055" onmouseenter="enter('-4259734795637808055');" onmouseout="out('-4259734795637808055');" style=""> 114      @PersistenceContext(unitName=&quot;blPU&quot;)                                                                          </span>
<span class="-5741815223868414625" onmouseenter="enter('-5741815223868414625');" onmouseout="out('-5741815223868414625');" style=""> 115      protected EntityManager em;                                                                                   </span>
<span  style=""> 116                                                                                                                    </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 117      @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                           </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 118      protected StreamingTransactionCapableUtil transUtil;                                                          </span>
<span  style=""> 119                                                                                                                    </span>
<span class="-8384326529234094002" onmouseenter="enter('-8384326529234094002');" onmouseout="out('-8384326529234094002');" style=""> 120      @Resource(name=&quot;blEntityDuplicator&quot;)                                                                          </span>
<span class="-9194612273021432316" onmouseenter="enter('-9194612273021432316');" onmouseout="out('-9194612273021432316');" style=""> 121      protected EntityDuplicator duplicator;                                                                        </span>
<span  style=""> 122                                                                                                                    </span>
<span class="723166851410757036" onmouseenter="enter('723166851410757036');" onmouseout="out('723166851410757036');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 123 -    @Resource(name=&quot;blOfferDuplicateModifier&quot;)                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +    /**                                                                                                           </span>
<span class="-5719913168774156893" onmouseenter="enter('-5719913168774156893');" onmouseout="out('-5719913168774156893');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +     * @deprecated Add {@link EntityDuplicateModifier}s to {@code blEntityDuplicationHelpers}                     </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +     */                                                                                                           </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +    @Deprecated                                                                                                   </span>
<span class="8658910844320022950" onmouseenter="enter('8658910844320022950');" onmouseout="out('8658910844320022950');" style=""> 128      protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;                                              </span>
<span  style=""> 129                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 130      @Override                                                                                                     </span>
<span class="-2033305286790048708" onmouseenter="enter('-2033305286790048708');" onmouseout="out('-2033305286790048708');" style=""> 131      public List&lt;Offer&gt; findAllOffers() {                                                                          </span>
<span class="2132174063530273788" onmouseenter="enter('2132174063530273788');" onmouseout="out('2132174063530273788');" style=""> 132          return offerDao.readAllOffers();                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 133      }                                                                                                             </span>
<span  style=""> 134                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 135      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 136      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="7144811092176845141" onmouseenter="enter('7144811092176845141');" onmouseout="out('7144811092176845141');" style=""> 137      public Offer save(Offer offer) {                                                                              </span>
<span class="-264708178039771798" onmouseenter="enter('-264708178039771798');" onmouseout="out('-264708178039771798');" style=""> 138          return offerDao.save(offer);                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 139      }                                                                                                             </span>
<span  style=""> 140                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 141      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 142      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-5514670765130856091" onmouseenter="enter('-5514670765130856091');" onmouseout="out('-5514670765130856091');" style=""> 143      public OfferCode saveOfferCode(OfferCode offerCode) {                                                         </span>
<span class="3125778008044685658" onmouseenter="enter('3125778008044685658');" onmouseout="out('3125778008044685658');" style=""> 144          offerCode.setOffer(offerDao.save(offerCode.getOffer()));                                                  </span>
<span class="6906137479190051982" onmouseenter="enter('6906137479190051982');" onmouseout="out('6906137479190051982');" style=""> 145          return offerCodeDao.save(offerCode);                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 146      }                                                                                                             </span>
<span  style=""> 147                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 148      /**                                                                                                           </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""> 149       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,        </span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""> 150       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer        </span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 151       * cannot appear more than once in the list.                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 152       *                                                                                                            </span>
<span class="-709313334493645866" onmouseenter="enter('-709313334493645866');" onmouseout="out('-709313334493645866');" style=""> 153       * @param code                                                                                                </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 154       * @return a List of offers that may apply to this order                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 155       */                                                                                                           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 156      @Override                                                                                                     </span>
<span class="-6840847083603451180" onmouseenter="enter('-6840847083603451180');" onmouseout="out('-6840847083603451180');" style=""> 157      public Offer lookupOfferByCode(String code) {                                                                 </span>
<span class="-531732708503781646" onmouseenter="enter('-531732708503781646');" onmouseout="out('-531732708503781646');" style=""> 158          Offer offer = null;                                                                                       </span>
<span class="-8218576552188075283" onmouseenter="enter('-8218576552188075283');" onmouseout="out('-8218576552188075283');" style=""> 159          OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);                                             </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 160          if (offerCode != null) {                                                                                  </span>
<span class="-2561785727340284423" onmouseenter="enter('-2561785727340284423');" onmouseout="out('-2561785727340284423');" style=""> 161              offer = offerCode.getOffer();                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 162          }                                                                                                         </span>
<span class="-8963791522625561917" onmouseenter="enter('-8963791522625561917');" onmouseout="out('-8963791522625561917');" style=""> 163          return offer;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 164      }                                                                                                             </span>
<span  style=""> 165                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 166      @Override                                                                                                     </span>
<span class="2883322601430833612" onmouseenter="enter('2883322601430833612');" onmouseout="out('2883322601430833612');" style=""> 167      public OfferCode lookupOfferCodeByCode(String code){                                                          </span>
<span class="8795189428566002896" onmouseenter="enter('8795189428566002896');" onmouseout="out('8795189428566002896');" style=""> 168          return offerCodeDao.readOfferCodeByCode(code);                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 169      }                                                                                                             </span>
<span  style=""> 170                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 171      @Override                                                                                                     </span>
<span class="-2543778591938191529" onmouseenter="enter('-2543778591938191529');" onmouseout="out('-2543778591938191529');" style=""> 172      public List&lt;Offer&gt; lookupAllOffersByCode(String code) {                                                       </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 173          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                              </span>
<span class="-3360697953765841703" onmouseenter="enter('-3360697953765841703');" onmouseout="out('-3360697953765841703');" style=""> 174          List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);                                  </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 175          for (OfferCode offerCode : offerCodes) {                                                                  </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 176              if (offerCode != null) {                                                                              </span>
<span class="-7816274075460376657" onmouseenter="enter('-7816274075460376657');" onmouseout="out('-7816274075460376657');" style=""> 177                  offers.add(offerCode.getOffer());                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 178              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179          }                                                                                                         </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 180          return offers;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181      }                                                                                                             </span>
<span  style=""> 182                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 183      @Override                                                                                                     </span>
<span class="4676855439599320404" onmouseenter="enter('4676855439599320404');" onmouseout="out('4676855439599320404');" style=""> 184      public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){                                                </span>
<span class="-4234235759448675045" onmouseenter="enter('-4234235759448675045');" onmouseout="out('-4234235759448675045');" style=""> 185          return offerCodeDao.readAllOfferCodesByCode(code);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 186      }                                                                                                             </span>
<span  style=""> 187                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 188      /**                                                                                                           </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""> 189       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,        </span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""> 190       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer        </span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 191       * cannot appear more than once in the list.                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 192       *                                                                                                            </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 193       * @param order                                                                                               </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 194       * @return a List of offers that may apply to this order                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 195       */                                                                                                           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 196      @Override                                                                                                     </span>
<span class="-5814298891852821500" onmouseenter="enter('-5814298891852821500');" onmouseout="out('-5814298891852821500');" style=""> 197      public List&lt;Offer&gt; buildOfferListForOrder(Order order) {                                                      </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 198          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                              </span>
<span class="-3235900677601494398" onmouseenter="enter('-3235900677601494398');" onmouseout="out('-3235900677601494398');" style=""> 199          List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());                  </span>
<span class="7699769166343685501" onmouseenter="enter('7699769166343685501');" onmouseout="out('7699769166343685501');" style=""> 200          for (CustomerOffer customerOffer : customerOffers) {                                                      </span>
<span class="-2310400538171319838" onmouseenter="enter('-2310400538171319838');" onmouseout="out('-2310400538171319838');" style=""> 201              if (!offers.contains(customerOffer.getOffer())) {                                                     </span>
<span class="5233078073066950969" onmouseenter="enter('5233078073066950969');" onmouseout="out('5233078073066950969');" style=""> 202                  offers.add(customerOffer.getOffer());                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 203              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 204          }                                                                                                         </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style=""> 205          List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                                   </span>
<span class="-6665865767746694239" onmouseenter="enter('-6665865767746694239');" onmouseout="out('-6665865767746694239');" style=""> 206          orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                             </span>
<span class="2682597879629079185" onmouseenter="enter('2682597879629079185');" onmouseout="out('2682597879629079185');" style=""> 207          for (OfferCode orderOfferCode : orderOfferCodes) {                                                        </span>
<span class="-1857624084667800558" onmouseenter="enter('-1857624084667800558');" onmouseout="out('-1857624084667800558');" style=""> 208              if (!offers.contains(orderOfferCode.getOffer())) {                                                    </span>
<span class="4188766124804405127" onmouseenter="enter('4188766124804405127');" onmouseout="out('4188766124804405127');" style=""> 209                  offers.add(orderOfferCode.getOffer());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 210              }                                                                                                     </span>
<span class="-4468546552745233084" onmouseenter="enter('-4468546552745233084');" onmouseout="out('-4468546552745233084');" style=""> 211              extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 212          }                                                                                                         </span>
<span class="-9188634082558155234" onmouseenter="enter('-9188634082558155234');" onmouseout="out('-9188634082558155234');" style=""> 213          List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();                                               </span>
<span class="-8411171878687156520" onmouseenter="enter('-8411171878687156520');" onmouseout="out('-8411171878687156520');" style=""> 214          for (Offer globalOffer : globalOffers) {                                                                  </span>
<span class="2071278729839157974" onmouseenter="enter('2071278729839157974');" onmouseout="out('2071278729839157974');" style=""> 215              if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {           </span>
<span class="-3050025518373868772" onmouseenter="enter('-3050025518373868772');" onmouseout="out('-3050025518373868772');" style=""> 216                  offers.add(globalOffer);                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 217              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 218          }                                                                                                         </span>
<span  style=""> 219                                                                                                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 220          if (extensionManager != null) {                                                                           </span>
<span class="1817402996237899777" onmouseenter="enter('1817402996237899777');" onmouseout="out('1817402996237899777');" style=""> 221              extensionManager.applyAdditionalFilters(offers, order);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 222          }                                                                                                         </span>
<span  style=""> 223                                                                                                                    </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 224          return offers;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 225      }                                                                                                             </span>
<span  style=""> 226                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 227      @Override                                                                                                     </span>
<span class="2056305643902587707" onmouseenter="enter('2056305643902587707');" onmouseout="out('2056305643902587707');" style=""> 228      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {                                           </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 229          Customer customer = order.getCustomer();                                                                  </span>
<span class="-5041998041456755776" onmouseenter="enter('-5041998041456755776');" onmouseout="out('-5041998041456755776');" style=""> 230          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();                                                      </span>
<span  style=""> 231                                                                                                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 232          if (extensionManager != null) {                                                                           </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 233              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 234          }                                                                                                         </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 235          if (!offerCodes.isEmpty()) {                                                                              </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 236              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                                      </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 237              while (itr.hasNext()) {                                                                               </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 238                  OfferCode offerCode = itr.next();                                                                 </span>
<span class="-776136422183497161" onmouseenter="enter('-776136422183497161');" onmouseout="out('-776136422183497161');" style=""> 239                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {                </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 240                      itr.remove();                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 241                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 242              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 243          }                                                                                                         </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 244          return offerCodes;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 245      }                                                                                                             </span>
<span  style=""> 246                                                                                                                    </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 247      @Deprecated                                                                                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 248      @Override                                                                                                     </span>
<span class="3843851677430304310" onmouseenter="enter('3843851677430304310');" onmouseout="out('3843851677430304310');" style=""> 249      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {                                     </span>
<span class="-6957816096303048614" onmouseenter="enter('-6957816096303048614');" onmouseout="out('-6957816096303048614');" style=""> 250          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();                                             </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 251          if (extensionManager != null) {                                                                           </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 252              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 253          }                                                                                                         </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 254          if (!offerCodes.isEmpty()) {                                                                              </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 255              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                                      </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 256              while (itr.hasNext()) {                                                                               </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 257                  OfferCode offerCode = itr.next();                                                                 </span>
<span class="6086018267170409432" onmouseenter="enter('6086018267170409432');" onmouseout="out('6086018267170409432');" style=""> 258                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {             </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 259                      itr.remove();                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 260                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 261              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 262          }                                                                                                         </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 263          return offerCodes;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 264      }                                                                                                             </span>
<span  style=""> 265                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 266      /**                                                                                                           </span>
<span class="2837560355574155003" onmouseenter="enter('2837560355574155003');" onmouseout="out('2837560355574155003');" style=""> 267       * Private method used to retrieve all offers assigned to this customer.  These offers are                    </span>
<span class="4852710310174118924" onmouseenter="enter('4852710310174118924');" onmouseout="out('4852710310174118924');" style=""> 268       * programmatically assigned to the customer.                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 269       *                                                                                                            </span>
<span class="1094425505394812731" onmouseenter="enter('1094425505394812731');" onmouseout="out('1094425505394812731');" style=""> 270       * @param customer                                                                                            </span>
<span class="-3868237647402015492" onmouseenter="enter('-3868237647402015492');" onmouseout="out('-3868237647402015492');" style=""> 271       * @return a List of offers assigned to the customer                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 272       */                                                                                                           </span>
<span class="-1064959765029423996" onmouseenter="enter('-1064959765029423996');" onmouseout="out('-1064959765029423996');" style=""> 273      protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {                              </span>
<span class="1699675085073278700" onmouseenter="enter('1699675085073278700');" onmouseout="out('1699675085073278700');" style=""> 274          List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);             </span>
<span class="5611761187435301880" onmouseenter="enter('5611761187435301880');" onmouseout="out('5611761187435301880');" style=""> 275          return offerCustomers;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 276      }                                                                                                             </span>
<span  style=""> 277                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 278      /**                                                                                                           </span>
<span class="-8831229104457932482" onmouseenter="enter('-8831229104457932482');" onmouseout="out('-8831229104457932482');" style=""> 279       * Private method used to retrieve all offers with automaticallyAdded set to true                             </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 280       *                                                                                                            </span>
<span class="-2057313490179191281" onmouseenter="enter('-2057313490179191281');" onmouseout="out('-2057313490179191281');" style=""> 281       * @return a List of automatic delivery offers                                                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 282       */                                                                                                           </span>
<span class="-9186908469762752320" onmouseenter="enter('-9186908469762752320');" onmouseout="out('-9186908469762752320');" style=""> 283      protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {                                                       </span>
<span class="-2657712449795339218" onmouseenter="enter('-2657712449795339218');" onmouseout="out('-2657712449795339218');" style=""> 284          List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();                                  </span>
<span class="-7738403477037597046" onmouseenter="enter('-7738403477037597046');" onmouseout="out('-7738403477037597046');" style=""> 285          return globalOffers;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 286      }                                                                                                             </span>
<span  style=""> 287                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 288      /**                                                                                                           </span>
<span class="-582485916100204765" onmouseenter="enter('-582485916100204765');" onmouseout="out('-582485916100204765');" style=""> 289       * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end                    </span>
<span class="-591413864231465226" onmouseenter="enter('-591413864231465226');" onmouseout="out('-591413864231465226');" style=""> 290       * date.  If an offerCode has a later start date, that offerCode will be removed.                             </span>
<span class="-1600892852414517397" onmouseenter="enter('-1600892852414517397');" onmouseout="out('-1600892852414517397');" style=""> 291       * OfferCodes without a start date will still be processed. If the offerCode                                  </span>
<span class="-6972954356288154926" onmouseenter="enter('-6972954356288154926');" onmouseout="out('-6972954356288154926');" style=""> 292       * has a end date that has already passed, that offerCode will be removed.  OfferCodes                        </span>
<span class="-7007360996659097530" onmouseenter="enter('-7007360996659097530');" onmouseout="out('-7007360996659097530');" style=""> 293       * without a end date will be processed.  The start and end dates on the offer will                           </span>
<span class="-216139196908541615" onmouseenter="enter('-216139196908541615');" onmouseout="out('-216139196908541615');" style=""> 294       * still need to be evaluated.                                                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 295       *                                                                                                            </span>
<span class="-142155654396048960" onmouseenter="enter('-142155654396048960');" onmouseout="out('-142155654396048960');" style=""> 296       * @param offerCodes                                                                                          </span>
<span class="-7645314644020819692" onmouseenter="enter('-7645314644020819692');" onmouseout="out('-7645314644020819692');" style=""> 297       * @return a List of non-expired offers                                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 298       */                                                                                                           </span>
<span class="3097073257270455619" onmouseenter="enter('3097073257270455619');" onmouseout="out('3097073257270455619');" style=""> 299      protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){                              </span>
<span class="-71581284051087612" onmouseenter="enter('-71581284051087612');" onmouseout="out('-71581284051087612');" style=""> 300          List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();                                          </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 301          for (OfferCode offerCode : offerCodes) {                                                                  </span>
<span class="4179739580098873664" onmouseenter="enter('4179739580098873664');" onmouseout="out('4179739580098873664');" style=""> 302              if (!offerCode.isActive()){                                                                           </span>
<span class="2973899686965396382" onmouseenter="enter('2973899686965396382');" onmouseout="out('2973899686965396382');" style=""> 303                  offerCodesToRemove.add(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 304              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 305          }                                                                                                         </span>
<span class="3113103044265464111" onmouseenter="enter('3113103044265464111');" onmouseout="out('3113103044265464111');" style=""> 306          // remove all offers in the offersToRemove list from original offers list                                 </span>
<span class="6883206030034557562" onmouseenter="enter('6883206030034557562');" onmouseout="out('6883206030034557562');" style=""> 307          for (OfferCode offerCode : offerCodesToRemove) {                                                          </span>
<span class="-8473869847996752510" onmouseenter="enter('-8473869847996752510');" onmouseout="out('-8473869847996752510');" style=""> 308              offerCodes.remove(offerCode);                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 309          }                                                                                                         </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 310          return offerCodes;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 311      }                                                                                                             </span>
<span  style=""> 312                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 313      /**                                                                                                           </span>
<span class="5637961435104982406" onmouseenter="enter('5637961435104982406');" onmouseout="out('5637961435104982406');" style=""> 314       * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with                </span>
<span class="1724276086246688719" onmouseenter="enter('1724276086246688719');" onmouseout="out('1724276086246688719');" style=""> 315       * current sandbox status.                                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 316       *                                                                                                            </span>
<span class="202872854140107873" onmouseenter="enter('202872854140107873');" onmouseout="out('202872854140107873');" style=""> 317       * @param order the order to check                                                                            </span>
<span class="2772482249434351691" onmouseenter="enter('2772482249434351691');" onmouseout="out('2772482249434351691');" style=""> 318       * @return the refreshed list of OfferCodes                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 319       */                                                                                                           </span>
<span class="7210051143895905366" onmouseenter="enter('7210051143895905366');" onmouseout="out('7210051143895905366');" style=""> 320      protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {                                  </span>
<span class="7464496307728629396" onmouseenter="enter('7464496307728629396');" onmouseout="out('7464496307728629396');" style=""> 321          final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();                                       </span>
<span  style=""> 322                                                                                                                    </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 323          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 324              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 325              public void execute() {                                                                               </span>
<span class="-6058145000184664425" onmouseenter="enter('-6058145000184664425');" onmouseout="out('-6058145000184664425');" style=""> 326                  for (OfferCode offerCode : orderOfferCodes) {                                                     </span>
<span class="-4263515828536000223" onmouseenter="enter('-4263515828536000223');" onmouseout="out('-4263515828536000223');" style=""> 327                      if (offerCode.getOffer() != null) {                                                           </span>
<span class="8507823172595815939" onmouseenter="enter('8507823172595815939');" onmouseout="out('8507823172595815939');" style=""><abbr title=" 328                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 328                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOfðŸ”µ</abbr></span>
<span class="-4217337457935304447" onmouseenter="enter('-4217337457935304447');" onmouseout="out('-4217337457935304447');" style=""><abbr title=" 329                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 329                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getðŸ”µ</abbr></span>
<span class="-6104864632261418874" onmouseenter="enter('-6104864632261418874');" onmouseout="out('-6104864632261418874');" style=""> 330                              em.refresh(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 331                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 332                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 333                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 334              }                                                                                                     </span>
<span  style=""> 335                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 336              @Override                                                                                             </span>
<span class="1336357167460974281" onmouseenter="enter('1336357167460974281');" onmouseout="out('1336357167460974281');" style=""> 337              public boolean shouldRetryOnTransactionLockAcquisitionFailure() {                                     </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 338                  return true;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 339              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 340          }, RuntimeException.class);                                                                               </span>
<span  style=""> 341                                                                                                                    </span>
<span class="720292142172901868" onmouseenter="enter('720292142172901868');" onmouseout="out('720292142172901868');" style=""> 342          return orderOfferCodes;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 343      }                                                                                                             </span>
<span  style=""> 344                                                                                                                    </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 345      /*                                                                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 346       *                                                                                                            </span>
<span class="-1078885518483632555" onmouseenter="enter('-1078885518483632555');" onmouseout="out('-1078885518483632555');" style=""> 347       * Offers Logic:                                                                                              </span>
<span class="-6544489594486398439" onmouseenter="enter('-6544489594486398439');" onmouseout="out('-6544489594486398439');" style=""> 348       * 1) Remove all existing offers in the Order (order, item, and fulfillment)                                  </span>
<span class="472654013095872963" onmouseenter="enter('472654013095872963');" onmouseout="out('472654013095872963');" style=""> 349       * 2) Check and remove offers                                                                                 </span>
<span class="8111384560802328496" onmouseenter="enter('8111384560802328496');" onmouseout="out('8111384560802328496');" style=""> 350       *    a) Remove out of date offers                                                                            </span>
<span class="3025649188866691570" onmouseenter="enter('3025649188866691570');" onmouseout="out('3025649188866691570');" style=""> 351       *    b) Remove offers that do not apply to this customer                                                     </span>
<span class="5156402814943015913" onmouseenter="enter('5156402814943015913');" onmouseout="out('5156402814943015913');" style=""> 352       * 3) Loop through offers                                                                                     </span>
<span class="6235203245796610706" onmouseenter="enter('6235203245796610706');" onmouseout="out('6235203245796610706');" style=""> 353       *    a) Verifies type of offer (order, order item, fulfillment)                                              </span>
<span class="7315686159335672158" onmouseenter="enter('7315686159335672158');" onmouseout="out('7315686159335672158');" style=""> 354       *    b) Verifies if offer can be applies                                                                     </span>
<span class="-6634234506054969031" onmouseenter="enter('-6634234506054969031');" onmouseout="out('-6634234506054969031');" style=""> 355       *    c) Assign offer to type (order, order item, or fulfillment)                                             </span>
<span class="-4584093434328536587" onmouseenter="enter('-4584093434328536587');" onmouseout="out('-4584093434328536587');" style=""> 356       * 4) Sorts the order and item offers list by priority and then discount                                      </span>
<span class="-2042995489836168848" onmouseenter="enter('-2042995489836168848');" onmouseout="out('-2042995489836168848');" style=""> 357       * 5) Identify the best offers to apply to order item and create adjustments for each item offer              </span>
<span class="8597383329030492662" onmouseenter="enter('8597383329030492662');" onmouseout="out('8597383329030492662');" style=""> 358       * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better      </span>
<span class="-5003028621529242985" onmouseenter="enter('-5003028621529242985');" onmouseout="out('-5003028621529242985');" style=""> 359       * 7) Identify the best offers to apply to the order and create adjustments for each order offer              </span>
<span class="-1324083657955785943" onmouseenter="enter('-1324083657955785943');" onmouseout="out('-1324083657955785943');" style=""><abbr title=" 360       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 360       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount valðŸ”µ</abbr></span>
<span class="-8610949319074908232" onmouseenter="enter('-8610949319074908232');" onmouseout="out('-8610949319074908232');" style=""> 361       * 9) Set final order item prices and reapply order offers                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 362       *                                                                                                            </span>
<span class="9071544830737596533" onmouseenter="enter('9071544830737596533');" onmouseout="out('9071544830737596533');" style=""> 363       * Assumptions:                                                                                               </span>
<span class="7676524731541901514" onmouseenter="enter('7676524731541901514');" onmouseout="out('7676524731541901514');" style=""> 364       * 1) % off all items will be created as an item offer with no expression                                     </span>
<span class="-814522364757940962" onmouseenter="enter('-814522364757940962');" onmouseout="out('-814522364757940962');" style=""> 365       * 2) $ off order will be created as an order offer                                                           </span>
<span class="7365449813142531261" onmouseenter="enter('7365449813142531261');" onmouseout="out('7365449813142531261');" style=""> 366       * 3) Order offers applies to the best price for each item (not just retail price)                            </span>
<span class="-1636653647835076359" onmouseenter="enter('-1636653647835076359');" onmouseout="out('-1636653647835076359');" style=""> 367       * 4) Fulfillment offers apply to best price for each item (not just retail price)                            </span>
<span class="-5866280996345915157" onmouseenter="enter('-5866280996345915157');" onmouseout="out('-5866280996345915157');" style=""><abbr title=" 368       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 368       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item ofðŸ”µ</abbr></span>
<span class="-8022045642448063338" onmouseenter="enter('-8022045642448063338');" onmouseout="out('-8022045642448063338');" style=""> 369       * 6) Fulfillment offers cannot be not combinable                                                             </span>
<span class="-5108644804585013203" onmouseenter="enter('-5108644804585013203');" onmouseout="out('-5108644804585013203');" style=""> 370       * 7) Order offers cannot be FIXED_PRICE                                                                      </span>
<span class="6161153439596163093" onmouseenter="enter('6161153439596163093');" onmouseout="out('6161153439596163093');" style=""> 371       * 8) FIXED_PRICE offers cannot be stackable                                                                  </span>
<span class="7044504232316014062" onmouseenter="enter('7044504232316014062');" onmouseout="out('7044504232316014062');" style=""><abbr title=" 372       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 372       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always applðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 373       *                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 374       */                                                                                                           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 375      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 376      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-4704847871427432866" onmouseenter="enter('-4704847871427432866');" onmouseout="out('-4704847871427432866');" style=""> 377      public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {             </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 378          /*                                                                                                        </span>
<span class="-6180845550366984877" onmouseenter="enter('-6180845550366984877');" onmouseout="out('-6180845550366984877');" style=""> 379          TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to          </span>
<span class="9161254164549280190" onmouseenter="enter('9161254164549280190');" onmouseout="out('9161254164549280190');" style=""> 380          use a richer object to describe the parameters of the pricing call. This object would include             </span>
<span class="1561516658361300705" onmouseenter="enter('1561516658361300705');" onmouseout="out('1561516658361300705');" style=""> 381          the pricing boolean, but would also include a list of activities to include or exclude in the             </span>
<span class="-6797832594843538707" onmouseenter="enter('-6797832594843538707');" onmouseout="out('-6797832594843538707');" style=""> 382          call - see http://jira.broadleafcommerce.org/browse/BLC-664                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 383           */                                                                                                       </span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 384          OfferContext offerContext = OfferContext.getOfferContext();                                               </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 385          if (offerContext == null || offerContext.executePromotionCalculation) {                                   </span>
<span class="-2683885994659783076" onmouseenter="enter('-2683885994659783076');" onmouseout="out('-2683885994659783076');" style=""> 386              PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false);          </span>
<span class="-9066266687178937853" onmouseenter="enter('-9066266687178937853');" onmouseout="out('-9066266687178937853');" style=""> 387              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());           </span>
<span class="-1421782411503697087" onmouseenter="enter('-1421782411503697087');" onmouseout="out('-1421782411503697087');" style=""> 388              if ((filteredOffers == null) || (filteredOffers.isEmpty())) {                                         </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 389                  if (LOG.isTraceEnabled()) {                                                                       </span>
<span class="2760579588161124045" onmouseenter="enter('2760579588161124045');" onmouseout="out('2760579588161124045');" style=""> 390                      LOG.trace(&quot;No offers applicable to this order.&quot;);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 391                  }                                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 392              } else {                                                                                              </span>
<span class="7300520529047311728" onmouseenter="enter('7300520529047311728');" onmouseout="out('7300520529047311728');" style=""><abbr title=" 393                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 393                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOðŸ”µ</abbr></span>
<span class="-7404348590242143631" onmouseenter="enter('-7404348590242143631');" onmouseout="out('-7404348590242143631');" style=""><abbr title=" 394                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 394                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffeðŸ”µ</abbr></span>
<span  style=""> 395                                                                                                                    </span>
<span class="-5526882442984993330" onmouseenter="enter('-5526882442984993330');" onmouseout="out('-5526882442984993330');" style=""><abbr title=" 396                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 396                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItðŸ”µ</abbr></span>
<span  style=""> 397                                                                                                                    </span>
<span class="-6480919216777131248" onmouseenter="enter('-6480919216777131248');" onmouseout="out('-6480919216777131248');" style=""> 398                  if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {                        </span>
<span class="-2723881742436166059" onmouseenter="enter('-2723881742436166059');" onmouseout="out('-2723881742436166059');" style=""> 399                      // At this point, we should have a PromotableOrder that contains PromotableItems each of which</span>
<span class="751015906320167144" onmouseenter="enter('751015906320167144');" onmouseout="out('751015906320167144');" style=""> 400                      // has a list of candidatePromotions that might be applied.                                   </span>
<span  style=""> 401                                                                                                                    </span>
<span class="5941864862011378901" onmouseenter="enter('5941864862011378901');" onmouseout="out('5941864862011378901');" style=""><abbr title=" 402                      // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 402                      // We also have a list of orderOffers that might apply and a list of itemOffers that might appðŸ”µ</abbr></span>
<span class="1127078869550353626" onmouseenter="enter('1127078869550353626');" onmouseout="out('1127078869550353626');" style=""><abbr title=" 403                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 403                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, quðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 404                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 405              }                                                                                                     </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 406              orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                                 </span>
<span  style=""> 407                                                                                                                    </span>
<span class="514986819999277890" onmouseenter="enter('514986819999277890');" onmouseout="out('514986819999277890');" style=""> 408              verifyAdjustments(order, true);                                                                       </span>
<span  style=""> 409                                                                                                                    </span>
<span class="-8901364638816691349" onmouseenter="enter('-8901364638816691349');" onmouseout="out('-8901364638816691349');" style=""> 410              order.setSubTotal(order.calculateSubTotal());                                                         </span>
<span class="8881079200386597596" onmouseenter="enter('8881079200386597596');" onmouseout="out('8881079200386597596');" style=""> 411              order.finalizeItemPrices();                                                                           </span>
<span  style=""> 412                                                                                                                    </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 413              order = orderService.save(order, false);                                                              </span>
<span  style=""> 414                                                                                                                    </span>
<span class="-5335273514929397197" onmouseenter="enter('-5335273514929397197');" onmouseout="out('-5335273514929397197');" style=""> 415              boolean madeChange = verifyAdjustments(order, false);                                                 </span>
<span class="-3218959195648057803" onmouseenter="enter('-3218959195648057803');" onmouseout="out('-3218959195648057803');" style=""> 416              if (madeChange) {                                                                                     </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 417                  order = orderService.save(order, false);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 418              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 419          }                                                                                                         </span>
<span  style=""> 420                                                                                                                    </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 421          return order;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 422      }                                                                                                             </span>
<span  style=""> 423                                                                                                                    </span>
<span class="219209447823395758" onmouseenter="enter('219209447823395758');" onmouseout="out('219209447823395758');" style=""> 424      protected boolean verifyAdjustments(Order order, boolean beforeSave) {                                        </span>
<span class="79408939766017075" onmouseenter="enter('79408939766017075');" onmouseout="out('79408939766017075');" style=""> 425          boolean madeChange = false;                                                                               </span>
<span  style=""> 426                                                                                                                    </span>
<span class="-8966123689509035198" onmouseenter="enter('-8966123689509035198');" onmouseout="out('-8966123689509035198');" style=""> 427          if (order.getOrderItems() == null) {                                                                      </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 428              return madeChange;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 429          }                                                                                                         </span>
<span  style=""> 430                                                                                                                    </span>
<span class="8447029191885982498" onmouseenter="enter('8447029191885982498');" onmouseout="out('8447029191885982498');" style=""> 431          for (OrderItem oi : order.getOrderItems()) {                                                              </span>
<span class="-5982197742320851056" onmouseenter="enter('-5982197742320851056');" onmouseout="out('-5982197742320851056');" style=""> 432              if (oi.getOrderItemPriceDetails() == null) {                                                          </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 433                  continue;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 434              }                                                                                                     </span>
<span  style=""> 435                                                                                                                    </span>
<span class="7391296704731194189" onmouseenter="enter('7391296704731194189');" onmouseout="out('7391296704731194189');" style=""> 436              for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {                                       </span>
<span class="-8259157388002947293" onmouseenter="enter('-8259157388002947293');" onmouseout="out('-8259157388002947293');" style=""> 437                  if (pd.getOrderItemPriceDetailAdjustments() == null) {                                            </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 438                      continue;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 439                  }                                                                                                 </span>
<span  style=""> 440                                                                                                                    </span>
<span class="-8160497408394725913" onmouseenter="enter('-8160497408394725913');" onmouseout="out('-8160497408394725913');" style=""><abbr title=" 441                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 441                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;ðŸ”µ</abbr></span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 442                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 442                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjusðŸ”µ</abbr></span>
<span class="-3008507732031274392" onmouseenter="enter('-3008507732031274392');" onmouseout="out('-3008507732031274392');" style=""> 443                  for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {              </span>
<span class="-1975641521768786423" onmouseenter="enter('-1975641521768786423');" onmouseout="out('-1975641521768786423');" style=""> 444                      if (adjs.containsKey(adj.getOffer().getId())) {                                               </span>
<span class="-6913168070672082713" onmouseenter="enter('-6913168070672082713');" onmouseout="out('-6913168070672082713');" style=""> 445                          adjustmentsToRemove.add(adj);                                                             </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 446                          if (LOG.isDebugEnabled()) {                                                               </span>
<span class="-2834336870885753779" onmouseenter="enter('-2834336870885753779');" onmouseout="out('-2834336870885753779');" style=""> 447                              StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)                          </span>
<span class="201513945492742471" onmouseenter="enter('201513945492742471');" onmouseout="out('201513945492742471');" style=""> 448                                  .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)                            </span>
<span class="2195430440089355634" onmouseenter="enter('2195430440089355634');" onmouseout="out('2195430440089355634');" style=""> 449                                  .append(&quot; with ids &quot;)                                                             </span>
<span class="-3149719647859419210" onmouseenter="enter('-3149719647859419210');" onmouseout="out('-3149719647859419210');" style=""> 450                                  .append(adjs.get(adj.getOffer().getId()).getId())                                 </span>
<span class="7312533819175146387" onmouseenter="enter('7312533819175146387');" onmouseout="out('7312533819175146387');" style=""> 451                                  .append(&quot; and &quot;)                                                                  </span>
<span class="6832270653349147085" onmouseenter="enter('6832270653349147085');" onmouseout="out('6832270653349147085');" style=""> 452                                  .append(adj.getId());                                                             </span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 453                              LOG.debug(sb.toString());                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 454                          }                                                                                         </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 455                      } else {                                                                                      </span>
<span class="-7759509127049565554" onmouseenter="enter('-7759509127049565554');" onmouseout="out('-7759509127049565554');" style=""> 456                          adjs.put(adj.getOffer().getId(), adj);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 457                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 458                  }                                                                                                 </span>
<span  style=""> 459                                                                                                                    </span>
<span class="7848730128284985932" onmouseenter="enter('7848730128284985932');" onmouseout="out('7848730128284985932');" style=""> 460                  for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {                                  </span>
<span class="6756116260498887863" onmouseenter="enter('6756116260498887863');" onmouseout="out('6756116260498887863');" style=""> 461                      pd.getOrderItemPriceDetailAdjustments().remove(adj);                                          </span>
<span class="5571803755205047298" onmouseenter="enter('5571803755205047298');" onmouseout="out('5571803755205047298');" style=""> 462                      madeChange = true;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 463                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 464              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 465          }                                                                                                         </span>
<span  style=""> 466                                                                                                                    </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 467          return madeChange;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 468       }                                                                                                            </span>
<span  style=""> 469                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 470      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 471      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 472      @Deprecated                                                                                                   </span>
<span class="-3021599232242429775" onmouseenter="enter('-3021599232242429775');" onmouseout="out('-3021599232242429775');" style=""> 473      public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {                     </span>
<span class="-6341015309393843959" onmouseenter="enter('-6341015309393843959');" onmouseout="out('-6341015309393843959');" style=""> 474          applyAndSaveOffersToOrder(offers, order);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 475      }                                                                                                             </span>
<span  style=""> 476                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 477      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 478      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 479      @Deprecated                                                                                                   </span>
<span class="-5535279977913938928" onmouseenter="enter('-5535279977913938928');" onmouseout="out('-5535279977913938928');" style=""> 480      public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {     </span>
<span class="6394386461467124428" onmouseenter="enter('6394386461467124428');" onmouseout="out('6394386461467124428');" style=""> 481          applyAndSaveFulfillmentGroupOffersToOrder(offers, order);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 482      }                                                                                                             </span>
<span  style=""> 483                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 484      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 485      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="2855881782634007850" onmouseenter="enter('2855881782634007850');" onmouseout="out('2855881782634007850');" style=""><abbr title=" 486      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 486      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptioðŸ”µ</abbr></span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 487          OfferContext offerContext = OfferContext.getOfferContext();                                               </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 488          if (offerContext == null || offerContext.executePromotionCalculation) {                                   </span>
<span class="-791836473256513905" onmouseenter="enter('-791836473256513905');" onmouseout="out('-791836473256513905');" style=""> 489              PromotableOrder promotableOrder =                                                                     </span>
<span class="-5771222684966163235" onmouseenter="enter('-5771222684966163235');" onmouseout="out('-5771222684966163235');" style=""> 490                      promotableItemFactory.createPromotableOrder(order, true);                                     </span>
<span class="-6252467951249219732" onmouseenter="enter('-6252467951249219732');" onmouseout="out('-6252467951249219732');" style=""> 491              List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();                                                </span>
<span class="-8689854403875612694" onmouseenter="enter('-8689854403875612694');" onmouseout="out('-8689854403875612694');" style=""> 492              for (Offer offer : offers) {                                                                          </span>
<span class="3344482016035270743" onmouseenter="enter('3344482016035270743');" onmouseout="out('3344482016035270743');" style=""> 493                  if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {                    </span>
<span class="2965579239059640859" onmouseenter="enter('2965579239059640859');" onmouseout="out('2965579239059640859');" style=""> 494                      possibleFGOffers.add(offer);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 495                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 496              }                                                                                                     </span>
<span class="7272445213685933500" onmouseenter="enter('7272445213685933500');" onmouseout="out('7272445213685933500');" style=""> 497              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer()); </span>
<span class="-380250791493510209" onmouseenter="enter('-380250791493510209');" onmouseout="out('-380250791493510209');" style=""><abbr title=" 498              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 498              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFuðŸ”µ</abbr></span>
<span class="5471512156259214352" onmouseenter="enter('5471512156259214352');" onmouseout="out('5471512156259214352');" style=""> 499              for (Offer offer : filteredOffers) {                                                                  </span>
<span class="6341701119621727258" onmouseenter="enter('6341701119621727258');" onmouseout="out('6341701119621727258');" style=""><abbr title=" 500                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 500                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffersðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 501              }                                                                                                     </span>
<span class="6757974448768463" onmouseenter="enter('6757974448768463');" onmouseout="out('6757974448768463');" style=""> 502              if (!qualifiedFGOffers.isEmpty()) {                                                                   </span>
<span class="-3737539762239464744" onmouseenter="enter('-3737539762239464744');" onmouseout="out('-3737539762239464744');" style=""> 503                  fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);</span>
<span class="-1748187190347404908" onmouseenter="enter('-1748187190347404908');" onmouseout="out('-1748187190347404908');" style=""> 504                  fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);                   </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 505                  orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 506              }                                                                                                     </span>
<span  style=""> 507                                                                                                                    </span>
<span class="-7204486914274790826" onmouseenter="enter('-7204486914274790826');" onmouseout="out('-7204486914274790826');" style=""> 508              return orderService.save(order, false);                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 509          }                                                                                                         </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 510          return order;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 511      }                                                                                                             </span>
<span  style=""> 512                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 513      @Override                                                                                                     </span>
<span class="-8983195686564092827" onmouseenter="enter('-8983195686564092827');" onmouseout="out('-8983195686564092827');" style=""> 514      public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {                                    </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 515 -        Customer customer = order.getCustomer();                                                                  </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 516 -                                                                                                                  </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 517          if (offer.isLimitedUsePerCustomer()) {                                                                    </span>

<span class="-8305970541390666259" onmouseenter="enter('-8305970541390666259');" onmouseout="out('-8305970541390666259');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 518 -            Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());     </span>
<span class="-3564809625752937907" onmouseenter="enter('-3564809625752937907');" onmouseout="out('-3564809625752937907');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 519 +            CustomerMaxUsesStrategyType strategy = offer.getMaxUsesStrategyType();                                </span>
<span class="7811178892856243955" onmouseenter="enter('7811178892856243955');" onmouseout="out('7811178892856243955');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 520 +            boolean checkUsingCustomer = (strategy == null || strategy.equals(CustomerMaxUsesStrategyType.CUSTOMER));"> 520 +            boolean checkUsingCustomer = (strategy == null || strategy.equals(CustomerMaxUsesStrategyType.CUSTOMERðŸ”µ</abbr></span>
<span class="-4186001467963498158" onmouseenter="enter('-4186001467963498158');" onmouseout="out('-4186001467963498158');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 521 +            Long currentUses;                                                                                     </span>
<span class="943186304180287912" onmouseenter="enter('943186304180287912');" onmouseout="out('943186304180287912');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 522 +            if (checkUsingCustomer) {                                                                             </span>
<span class="7194263595725243761" onmouseenter="enter('7194263595725243761');" onmouseout="out('7194263595725243761');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 523 +                currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 523 +                currentUses = offerAuditService.countUsesByCustomer(order, order.getCustomer().getId(), offer.getIðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 524 +            } else {                                                                                              </span>
<span class="5949149386596450267" onmouseenter="enter('5949149386596450267');" onmouseout="out('5949149386596450267');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 525 +                currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), offer.getId(), offer.getMinimumDaysPerUsage());"> 525 +                currentUses = offerAuditService.countUsesByAccount(order, order.getBroadleafAccountId(), offer.getðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 526 +            }                                                                                                     </span>
<span  style=""> 527                                                                                                                    </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 528              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                                   </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 529                  return false;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 530              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 531          }                                                                                                         </span>
<span  style=""> 532                                                                                                                    </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 533          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 534      }                                                                                                             </span>
<span  style=""> 535                                                                                                                    </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 536      @Deprecated                                                                                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 537      @Override                                                                                                     </span>
<span class="4849754295577860926" onmouseenter="enter('4849754295577860926');" onmouseout="out('4849754295577860926');" style=""> 538      public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {                              </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 539          if (offer.isLimitedUsePerCustomer()) {                                                                    </span>
<span class="8084739095609490454" onmouseenter="enter('8084739095609490454');" onmouseout="out('8084739095609490454');" style=""> 540              Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());            </span>
<span  style=""> 541                                                                                                                    </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 542              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                                   </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 543                  return false;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 544              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 545          }                                                                                                         </span>
<span  style=""> 546                                                                                                                    </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 547          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 548      }                                                                                                             </span>
<span  style=""> 549                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 550      @Override                                                                                                     </span>
<span class="-4305912419408886648" onmouseenter="enter('-4305912419408886648');" onmouseout="out('-4305912419408886648');" style=""> 551      public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {                                 </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 552          boolean underCodeMaxUses = true;                                                                          </span>
<span  style=""> 553                                                                                                                    </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 554          if (code.isLimitedUse()) {                                                                                </span>
<span class="-7378740545085856894" onmouseenter="enter('-7378740545085856894');" onmouseout="out('-7378740545085856894');" style=""> 555              Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());                     </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 556              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 557          }                                                                                                         </span>
<span  style=""> 558                                                                                                                    </span>
<span class="5446263071698048925" onmouseenter="enter('5446263071698048925');" onmouseout="out('5446263071698048925');" style=""> 559          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 560      }                                                                                                             </span>
<span  style=""> 561                                                                                                                    </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 562      @Deprecated                                                                                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 563      @Override                                                                                                     </span>
<span class="135967723667379112" onmouseenter="enter('135967723667379112');" onmouseout="out('135967723667379112');" style=""> 564      public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {                           </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 565          boolean underCodeMaxUses = true;                                                                          </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 566          if (code.isLimitedUse()) {                                                                                </span>
<span class="5487567461678823803" onmouseenter="enter('5487567461678823803');" onmouseout="out('5487567461678823803');" style=""> 567              Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());                            </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 568              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 569          }                                                                                                         </span>
<span class="7193079189056024188" onmouseenter="enter('7193079189056024188');" onmouseout="out('7193079189056024188');" style=""> 570          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 571      }                                                                                                             </span>
<span  style=""> 572                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 573      @Override                                                                                                     </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 574      @SuppressWarnings(&quot;unchecked&quot;)                                                                                </span>
<span class="-640784293225096821" onmouseenter="enter('-640784293225096821');" onmouseout="out('-640784293225096821');" style=""> 575      public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {                                                     </span>
<span class="-348027159212233091" onmouseenter="enter('-348027159212233091');" onmouseout="out('-348027159212233091');" style=""> 576          HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();                                                             </span>
<span  style=""> 577                                                                                                                    </span>
<span class="-7949809618309864364" onmouseenter="enter('-7949809618309864364');" onmouseout="out('-7949809618309864364');" style=""> 578          Transformer adjustmentToOfferTransformer = new Transformer() {                                            </span>
<span  style=""> 579                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 580              @Override                                                                                             </span>
<span class="-2718541205900117239" onmouseenter="enter('-2718541205900117239');" onmouseout="out('-2718541205900117239');" style=""> 581              public Object transform(Object input) {                                                               </span>
<span class="4176981446584954696" onmouseenter="enter('4176981446584954696');" onmouseout="out('4176981446584954696');" style=""> 582                  return ((Adjustment)input).getOffer();                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 583              }                                                                                                     </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 584          };                                                                                                        </span>
<span  style=""> 585                                                                                                                    </span>
<span class="-8370514600917699300" onmouseenter="enter('-8370514600917699300');" onmouseout="out('-8370514600917699300');" style=""> 586          result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));        </span>
<span  style=""> 587                                                                                                                    </span>
<span class="3897119298100986011" onmouseenter="enter('3897119298100986011');" onmouseout="out('3897119298100986011');" style=""> 588          if (order.getOrderItems() != null) {                                                                      </span>
<span class="820796442257070700" onmouseenter="enter('820796442257070700');" onmouseout="out('820796442257070700');" style=""> 589              for (OrderItem item : order.getOrderItems()) {                                                        </span>
<span class="722957474719034118" onmouseenter="enter('722957474719034118');" onmouseout="out('722957474719034118');" style=""><abbr title=" 590                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 590                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformerðŸ”µ</abbr></span>
<span  style=""> 591                                                                                                                    </span>
<span class="-3519908190158496681" onmouseenter="enter('-3519908190158496681');" onmouseout="out('-3519908190158496681');" style=""> 592                  //record usage for price details on the item as well                                              </span>
<span class="-2952948196187271811" onmouseenter="enter('-2952948196187271811');" onmouseout="out('-2952948196187271811');" style=""> 593                  if (item.getOrderItemPriceDetails() != null) {                                                    </span>
<span class="773323050474809935" onmouseenter="enter('773323050474809935');" onmouseout="out('773323050474809935');" style=""> 594                      for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {                         </span>
<span class="7134713472391876911" onmouseenter="enter('7134713472391876911');" onmouseout="out('7134713472391876911');" style=""><abbr title=" 595                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 595                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 596                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 597                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 598              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 599          }                                                                                                         </span>
<span  style=""> 600                                                                                                                    </span>
<span class="7944520279780748823" onmouseenter="enter('7944520279780748823');" onmouseout="out('7944520279780748823');" style=""> 601          if (order.getFulfillmentGroups() != null) {                                                               </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 602              for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                            </span>
<span class="-293187079687761920" onmouseenter="enter('-293187079687761920');" onmouseout="out('-293187079687761920');" style=""><abbr title=" 603                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 603                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransfðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 604              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 605          }                                                                                                         </span>
<span class="-6419540350677864751" onmouseenter="enter('-6419540350677864751');" onmouseout="out('-6419540350677864751');" style=""> 606          return result;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 607      }                                                                                                             </span>
<span  style=""> 608                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 609      @Override                                                                                                     </span>
<span class="-2491837224879773303" onmouseenter="enter('-2491837224879773303');" onmouseout="out('-2491837224879773303');" style=""> 610      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {                                      </span>
<span class="-1370687283458217641" onmouseenter="enter('-1370687283458217641');" onmouseout="out('-1370687283458217641');" style=""> 611          return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order));          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 612      }                                                                                                             </span>
<span  style=""> 613                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 614      @Override                                                                                                     </span>
<span class="-6407317956511861474" onmouseenter="enter('-6407317956511861474');" onmouseout="out('-6407317956511861474');" style=""> 615      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {   </span>
<span class="-4490485247927949218" onmouseenter="enter('-4490485247927949218');" onmouseout="out('-4490485247927949218');" style=""> 616          HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();                           </span>
<span class="983580358500385861" onmouseenter="enter('983580358500385861');" onmouseout="out('983580358500385861');" style=""> 617          for (OfferCode code : codes) {                                                                            </span>
<span class="6305098044991751707" onmouseenter="enter('6305098044991751707');" onmouseout="out('6305098044991751707');" style=""> 618              if (appliedOffers.contains(code.getOffer())) {                                                        </span>
<span class="3746501443462939384" onmouseenter="enter('3746501443462939384');" onmouseout="out('3746501443462939384');" style=""> 619                  offerToCodeMapping.put(code.getOffer(), code);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 620              }                                                                                                     </span>
<span  style=""> 621                                                                                                                    </span>
<span class="-240986298797431748" onmouseenter="enter('-240986298797431748');" onmouseout="out('-240986298797431748');" style=""> 622              List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();                                     </span>
<span  style=""> 623                                                                                                                    </span>
<span class="7454577566794152811" onmouseenter="enter('7454577566794152811');" onmouseout="out('7454577566794152811');" style=""> 624              extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);            </span>
<span class="-7985615425314556326" onmouseenter="enter('-7985615425314556326');" onmouseout="out('-7985615425314556326');" style=""> 625              for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {                                </span>
<span class="-808811284028256215" onmouseenter="enter('-808811284028256215');" onmouseout="out('-808811284028256215');" style=""> 626                  offerToCodeMapping.put(additionalOfferToBeApplied, code);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 627              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 628          }                                                                                                         </span>
<span class="7175253914401568841" onmouseenter="enter('7175253914401568841');" onmouseout="out('7175253914401568841');" style=""> 629          return offerToCodeMapping;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 630      }                                                                                                             </span>
<span  style=""> 631                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 632      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 633      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-1347767159915315738" onmouseenter="enter('-1347767159915315738');" onmouseout="out('-1347767159915315738');" style=""> 634      public Boolean deleteOfferCode(OfferCode code) {                                                              </span>
<span class="-5986603348121186173" onmouseenter="enter('-5986603348121186173');" onmouseout="out('-5986603348121186173');" style=""> 635          if (offerCodeDao.offerCodeIsUsed(code)) {                                                                 </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 636              return false;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 637          }                                                                                                         </span>
<span  style=""> 638                                                                                                                    </span>
<span class="-9122073777393685295" onmouseenter="enter('-9122073777393685295');" onmouseout="out('-9122073777393685295');" style=""> 639          offerCodeDao.delete(code);                                                                                </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 640          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 641      }                                                                                                             </span>
<span  style=""> 642                                                                                                                    </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 643      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 644      @Override                                                                                                     </span>
<span class="-3816301958562278169" onmouseenter="enter('-3816301958562278169');" onmouseout="out('-3816301958562278169');" style=""> 645      public Offer duplicate(Long originalOfferId) {                                                                </span>
<span class="-5738299300293223874" onmouseenter="enter('-5738299300293223874');" onmouseout="out('-5738299300293223874');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 646 -        Map&lt;String, String&gt; copyHints = new HashMap&lt;String, String&gt;();                                            </span>
<span class="2715783386963629594" onmouseenter="enter('2715783386963629594');" onmouseout="out('2715783386963629594');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 647 -        copyHints.put(OfferImpl.EXCLUDE_OFFERCODE_COPY_HINT, &quot;true&quot;);                                             </span>
<span class="-2013584672995219797" onmouseenter="enter('-2013584672995219797');" onmouseout="out('-2013584672995219797');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 648 -        return duplicator.copy(OfferImpl.class, originalOfferId, copyHints, offerDuplicateModifier);              </span>
<span class="5769078866234041335" onmouseenter="enter('5769078866234041335');" onmouseout="out('5769078866234041335');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 649 +        return duplicator.copy(OfferImpl.class, originalOfferId);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 650      }                                                                                                             </span>
<span  style=""> 651                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 652      @Override                                                                                                     </span>
<span class="3228088005821970316" onmouseenter="enter('3228088005821970316');" onmouseout="out('3228088005821970316');" style=""> 653      public CustomerOfferDao getCustomerOfferDao() {                                                               </span>
<span class="-801333879424417122" onmouseenter="enter('-801333879424417122');" onmouseout="out('-801333879424417122');" style=""> 654          return customerOfferDao;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 655      }                                                                                                             </span>
<span  style=""> 656                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 657      @Override                                                                                                     </span>
<span class="6308179313298689001" onmouseenter="enter('6308179313298689001');" onmouseout="out('6308179313298689001');" style=""> 658      public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {                                          </span>
<span class="438520929977701037" onmouseenter="enter('438520929977701037');" onmouseout="out('438520929977701037');" style=""> 659          this.customerOfferDao = customerOfferDao;                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 660      }                                                                                                             </span>
<span  style=""> 661                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 662      @Override                                                                                                     </span>
<span class="8266606365944954497" onmouseenter="enter('8266606365944954497');" onmouseout="out('8266606365944954497');" style=""> 663      public OfferCodeDao getOfferCodeDao() {                                                                       </span>
<span class="-4005874311041664572" onmouseenter="enter('-4005874311041664572');" onmouseout="out('-4005874311041664572');" style=""> 664          return offerCodeDao;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 665      }                                                                                                             </span>
<span  style=""> 666                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 667      @Override                                                                                                     </span>
<span class="-5083072655758254890" onmouseenter="enter('-5083072655758254890');" onmouseout="out('-5083072655758254890');" style=""> 668      public void setOfferCodeDao(OfferCodeDao offerCodeDao) {                                                      </span>
<span class="-7060255547979502806" onmouseenter="enter('-7060255547979502806');" onmouseout="out('-7060255547979502806');" style=""> 669          this.offerCodeDao = offerCodeDao;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 670      }                                                                                                             </span>
<span  style=""> 671                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 672      @Override                                                                                                     </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 673      public OfferDao getOfferDao() {                                                                               </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 674          return offerDao;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 675      }                                                                                                             </span>
<span  style=""> 676                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 677      @Override                                                                                                     </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 678      public void setOfferDao(OfferDao offerDao) {                                                                  </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 679          this.offerDao = offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 680      }                                                                                                             </span>
<span  style=""> 681                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 682      @Override                                                                                                     </span>
<span class="3012408951835963759" onmouseenter="enter('3012408951835963759');" onmouseout="out('3012408951835963759');" style=""> 683      public OrderOfferProcessor getOrderOfferProcessor() {                                                         </span>
<span class="-5069105522766505260" onmouseenter="enter('-5069105522766505260');" onmouseout="out('-5069105522766505260');" style=""> 684          return orderOfferProcessor;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 685      }                                                                                                             </span>
<span  style=""> 686                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 687      @Override                                                                                                     </span>
<span class="-2542583147665382651" onmouseenter="enter('-2542583147665382651');" onmouseout="out('-2542583147665382651');" style=""> 688      public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {                                 </span>
<span class="1533378703496715943" onmouseenter="enter('1533378703496715943');" onmouseout="out('1533378703496715943');" style=""> 689          this.orderOfferProcessor = orderOfferProcessor;                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 690      }                                                                                                             </span>
<span  style=""> 691                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 692      @Override                                                                                                     </span>
<span class="1694843298235251985" onmouseenter="enter('1694843298235251985');" onmouseout="out('1694843298235251985');" style=""> 693      public ItemOfferProcessor getItemOfferProcessor() {                                                           </span>
<span class="1583504692330339191" onmouseenter="enter('1583504692330339191');" onmouseout="out('1583504692330339191');" style=""> 694          return itemOfferProcessor;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 695      }                                                                                                             </span>
<span  style=""> 696                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 697      @Override                                                                                                     </span>
<span class="145400756853488798" onmouseenter="enter('145400756853488798');" onmouseout="out('145400756853488798');" style=""> 698      public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {                                    </span>
<span class="-102405468021411755" onmouseenter="enter('-102405468021411755');" onmouseout="out('-102405468021411755');" style=""> 699          this.itemOfferProcessor = itemOfferProcessor;                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 700      }                                                                                                             </span>
<span  style=""> 701                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 702      @Override                                                                                                     </span>
<span class="3022939772369206873" onmouseenter="enter('3022939772369206873');" onmouseout="out('3022939772369206873');" style=""> 703      public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {                                   </span>
<span class="-3088775944214719317" onmouseenter="enter('-3088775944214719317');" onmouseout="out('-3088775944214719317');" style=""> 704          return fulfillmentGroupOfferProcessor;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 705      }                                                                                                             </span>
<span  style=""> 706                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 707      @Override                                                                                                     </span>
<span class="-8855456203149015957" onmouseenter="enter('-8855456203149015957');" onmouseout="out('-8855456203149015957');" style=""> 708      public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {</span>
<span class="-7108053920330155376" onmouseenter="enter('-7108053920330155376');" onmouseout="out('-7108053920330155376');" style=""> 709          this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 710      }                                                                                                             </span>
<span  style=""> 711                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 712      @Override                                                                                                     </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 713      public PromotableItemFactory getPromotableItemFactory() {                                                     </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 714          return promotableItemFactory;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 715      }                                                                                                             </span>
<span  style=""> 716                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 717      @Override                                                                                                     </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 718      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                           </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 719          this.promotableItemFactory = promotableItemFactory;                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 720      }                                                                                                             </span>
<span  style=""> 721                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 722      @Override                                                                                                     </span>
<span class="-285725005067991728" onmouseenter="enter('-285725005067991728');" onmouseout="out('-285725005067991728');" style=""> 723      public OfferCode findOfferCodeById(Long id) {                                                                 </span>
<span class="4928857363700364693" onmouseenter="enter('4928857363700364693');" onmouseout="out('4928857363700364693');" style=""> 724          return offerCodeDao.readOfferCodeById(id);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 725      }                                                                                                             </span>
<span  style=""> 726                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 727      @Override                                                                                                     </span>
<span class="-6829155498814719074" onmouseenter="enter('-6829155498814719074');" onmouseout="out('-6829155498814719074');" style=""> 728      public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {                                            </span>
<span class="-1521639274006709657" onmouseenter="enter('-1521639274006709657');" onmouseout="out('-1521639274006709657');" style=""> 729          return offerCodeDao.readOfferCodesByIds(ids);                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 730      }                                                                                                             </span>
<span  style=""> 731                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 732      @Override                                                                                                     </span>
<span class="5587340050529616033" onmouseenter="enter('5587340050529616033');" onmouseout="out('5587340050529616033');" style=""> 733      public OrderService getOrderService() {                                                                       </span>
<span class="-7558473787756148723" onmouseenter="enter('-7558473787756148723');" onmouseout="out('-7558473787756148723');" style=""> 734          return orderService;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 735      }                                                                                                             </span>
<span  style=""> 736                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 737      @Override                                                                                                     </span>
<span class="4536819371590947172" onmouseenter="enter('4536819371590947172');" onmouseout="out('4536819371590947172');" style=""> 738      public void setOrderService(OrderService orderService) {                                                      </span>
<span class="7368861914925934250" onmouseenter="enter('7368861914925934250');" onmouseout="out('7368861914925934250');" style=""> 739          this.orderService = orderService;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 740      }                                                                                                             </span>
<span  style=""> 741                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 742      @Override                                                                                                     </span>
<span class="-2217088353489190987" onmouseenter="enter('-2217088353489190987');" onmouseout="out('-2217088353489190987');" style=""> 743      public Offer findOfferById(Long offerId) {                                                                    </span>
<span class="-5171648678549667040" onmouseenter="enter('-5171648678549667040');" onmouseout="out('-5171648678549667040');" style=""> 744          return offerDao.readOfferById(offerId);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 745      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 746  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3   * BroadleafCommerce Framework                                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18  package org.broadleafcommerce.core.offer.service;                                                                 </span>
<span  style="">  19                                                                                                                    </span>
<span class="8596464405353709537" onmouseenter="enter('8596464405353709537');" onmouseout="out('8596464405353709537');" style="">  20  import org.apache.commons.collections.CollectionUtils;                                                            </span>
<span class="2953846583056246827" onmouseenter="enter('2953846583056246827');" onmouseout="out('2953846583056246827');" style="">  21  import org.apache.commons.collections.Transformer;                                                                </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  22  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  23  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="-2193028153657877676" onmouseenter="enter('-2193028153657877676');" onmouseout="out('-2193028153657877676');" style="">  24  import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;                                          </span>
<span class="-3349026188166660873" onmouseenter="enter('-3349026188166660873');" onmouseout="out('-3349026188166660873');" style="">  25  import org.broadleafcommerce.common.persistence.EntityDuplicator;                                                 </span>
<span class="-2818686525334833130" onmouseenter="enter('-2818686525334833130');" onmouseout="out('-2818686525334833130');" style="">  26  import org.broadleafcommerce.common.sandbox.SandBoxHelper;                                                        </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  27  import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                              </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  28  import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                         </span>
<span class="6205208880685044389" onmouseenter="enter('6205208880685044389');" onmouseout="out('6205208880685044389');" style="">  29  import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;                                                     </span>
<span class="-7911436562744873568" onmouseenter="enter('-7911436562744873568');" onmouseout="out('-7911436562744873568');" style="">  30  import org.broadleafcommerce.core.offer.dao.OfferCodeDao;                                                         </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  31  import org.broadleafcommerce.core.offer.dao.OfferDao;                                                             </span>
<span class="-1633608357492319903" onmouseenter="enter('-1633608357492319903');" onmouseout="out('-1633608357492319903');" style="">  32  import org.broadleafcommerce.core.offer.domain.Adjustment;                                                        </span>
<span class="984981432680799531" onmouseenter="enter('984981432680799531');" onmouseout="out('984981432680799531');" style="">  33  import org.broadleafcommerce.core.offer.domain.CustomerOffer;                                                     </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  34  import org.broadleafcommerce.core.offer.domain.Offer;                                                             </span>
<span class="1521662235446319191" onmouseenter="enter('1521662235446319191');" onmouseout="out('1521662235446319191');" style="">  35  import org.broadleafcommerce.core.offer.domain.OfferCode;                                                         </span>
<span class="-7025591891527881733" onmouseenter="enter('-7025591891527881733');" onmouseout="out('-7025591891527881733');" style="">  36  import org.broadleafcommerce.core.offer.domain.OfferImpl;                                                         </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  37  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                                    </span>
<span class="4287099423657810905" onmouseenter="enter('4287099423657810905');" onmouseout="out('4287099423657810905');" style="">  38  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;         </span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  39  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;                     </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;                    </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                            </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  42  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                                  </span>
<span class="5713212224635448284" onmouseenter="enter('5713212224635448284');" onmouseout="out('5713212224635448284');" style="">  43  import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;                         </span>
<span class="-2454758753718589449" onmouseenter="enter('-2454758753718589449');" onmouseout="out('-2454758753718589449');" style="">  44  import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;                                     </span>
<span class="8227287359407176835" onmouseenter="enter('8227287359407176835');" onmouseout="out('8227287359407176835');" style="">  45  import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;                                    </span>

<span class="-5727938558534008634" onmouseenter="enter('-5727938558534008634');" onmouseout="out('-5727938558534008634');" style="">  46  import org.broadleafcommerce.core.offer.service.type.OfferType;                                                   </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  47  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                                  </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  48  import org.broadleafcommerce.core.order.domain.Order;                                                             </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  49  import org.broadleafcommerce.core.order.domain.OrderItem;                                                         </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  50  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                              </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  51  import org.broadleafcommerce.core.order.service.OrderService;                                                     </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  52  import org.broadleafcommerce.core.pricing.service.exception.PricingException;                                     </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  53  import org.broadleafcommerce.profile.core.domain.Customer;                                                        </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  54  import org.springframework.stereotype.Service;                                                                    </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  55  import org.springframework.transaction.annotation.Transactional;                                                  </span>
<span  style="">  56                                                                                                                    </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  57  import java.util.ArrayList;                                                                                       </span>
<span class="-112105277767313938" onmouseenter="enter('-112105277767313938');" onmouseout="out('-112105277767313938');" style="">  58  import java.util.Collection;                                                                                      </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  59  import java.util.HashMap;                                                                                         </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  60  import java.util.HashSet;                                                                                         </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  61  import java.util.Iterator;                                                                                        </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  62  import java.util.List;                                                                                            </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  63  import java.util.Map;                                                                                             </span>
<span class="6306724220981822255" onmouseenter="enter('6306724220981822255');" onmouseout="out('6306724220981822255');" style="">  64  import java.util.Objects;                                                                                         </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  65  import java.util.Set;                                                                                             </span>
<span  style="">  66                                                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  67  import javax.annotation.Resource;                                                                                 </span>
<span class="7911938180110628123" onmouseenter="enter('7911938180110628123');" onmouseout="out('7911938180110628123');" style="">  68  import javax.persistence.EntityManager;                                                                           </span>
<span class="3821515051839343306" onmouseenter="enter('3821515051839343306');" onmouseout="out('3821515051839343306');" style="">  69  import javax.persistence.PersistenceContext;                                                                      </span>
<span  style="">  70                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  71  /**                                                                                                               </span>
<span class="-2667338179687874348" onmouseenter="enter('-2667338179687874348');" onmouseout="out('-2667338179687874348');" style="">  72   * The Class OfferServiceImpl.                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  73   */                                                                                                               </span>
<span class="504450232350438262" onmouseenter="enter('504450232350438262');" onmouseout="out('504450232350438262');" style="">  74  @Service(&quot;blOfferService&quot;)                                                                                        </span>
<span class="6786430150403502423" onmouseenter="enter('6786430150403502423');" onmouseout="out('6786430150403502423');" style="">  75  public class OfferServiceImpl implements OfferService {                                                           </span>
<span  style="">  76                                                                                                                    </span>
<span class="8897944981470617719" onmouseenter="enter('8897944981470617719');" onmouseout="out('8897944981470617719');" style="">  77      private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);                                     </span>
<span  style="">  78                                                                                                                    </span>
<span class="3846751699212951796" onmouseenter="enter('3846751699212951796');" onmouseout="out('3846751699212951796');" style="">  79      // should be called outside of Offer service after Offer service is executed                                  </span>
<span class="-5484979233832760683" onmouseenter="enter('-5484979233832760683');" onmouseout="out('-5484979233832760683');" style="">  80      @Resource(name=&quot;blCustomerOfferDao&quot;)                                                                          </span>
<span class="-5771823415174942027" onmouseenter="enter('-5771823415174942027');" onmouseout="out('-5771823415174942027');" style="">  81      protected CustomerOfferDao customerOfferDao;                                                                  </span>
<span  style="">  82                                                                                                                    </span>
<span class="-1524144969871346405" onmouseenter="enter('-1524144969871346405');" onmouseout="out('-1524144969871346405');" style="">  83      @Resource(name=&quot;blOfferCodeDao&quot;)                                                                              </span>
<span class="-6984238934820524758" onmouseenter="enter('-6984238934820524758');" onmouseout="out('-6984238934820524758');" style="">  84      protected OfferCodeDao offerCodeDao;                                                                          </span>
<span  style="">  85                                                                                                                    </span>
<span class="-8247969455122443370" onmouseenter="enter('-8247969455122443370');" onmouseout="out('-8247969455122443370');" style="">  86      @Resource(name=&quot;blOfferAuditService&quot;)                                                                         </span>
<span class="-6742419488595856311" onmouseenter="enter('-6742419488595856311');" onmouseout="out('-6742419488595856311');" style="">  87      protected OfferAuditService offerAuditService;                                                                </span>
<span  style="">  88                                                                                                                    </span>
<span class="-6976077299079381435" onmouseenter="enter('-6976077299079381435');" onmouseout="out('-6976077299079381435');" style="">  89      @Resource(name=&quot;blOfferDao&quot;)                                                                                  </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  90      protected OfferDao offerDao;                                                                                  </span>
<span  style="">  91                                                                                                                    </span>
<span class="-3191658961867656636" onmouseenter="enter('-3191658961867656636');" onmouseout="out('-3191658961867656636');" style="">  92      @Resource(name=&quot;blOrderOfferProcessor&quot;)                                                                       </span>
<span class="-3818126380928091101" onmouseenter="enter('-3818126380928091101');" onmouseout="out('-3818126380928091101');" style="">  93      protected OrderOfferProcessor orderOfferProcessor;                                                            </span>
<span  style="">  94                                                                                                                    </span>
<span class="-6223428528083119866" onmouseenter="enter('-6223428528083119866');" onmouseout="out('-6223428528083119866');" style="">  95      @Resource(name=&quot;blItemOfferProcessor&quot;)                                                                        </span>
<span class="-7827297227357944415" onmouseenter="enter('-7827297227357944415');" onmouseout="out('-7827297227357944415');" style="">  96      protected ItemOfferProcessor itemOfferProcessor;                                                              </span>
<span  style="">  97                                                                                                                    </span>
<span class="-1476654469985531605" onmouseenter="enter('-1476654469985531605');" onmouseout="out('-1476654469985531605');" style="">  98      @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)                                                            </span>
<span class="7634983124983010999" onmouseenter="enter('7634983124983010999');" onmouseout="out('7634983124983010999');" style="">  99      protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;                                      </span>
<span  style=""> 100                                                                                                                    </span>
<span class="-4330844585159307437" onmouseenter="enter('-4330844585159307437');" onmouseout="out('-4330844585159307437');" style=""> 101      @Resource(name=&quot;blPromotableItemFactory&quot;)                                                                     </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style=""> 102      protected PromotableItemFactory promotableItemFactory;                                                        </span>
<span  style=""> 103                                                                                                                    </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style=""> 104      @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                            </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style=""> 105      protected OfferServiceExtensionManager extensionManager;                                                      </span>
<span  style=""> 106                                                                                                                    </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 107      @Resource(name = &quot;blOrderService&quot;)                                                                            </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 108      protected OrderService orderService;                                                                          </span>
<span  style=""> 109                                                                                                                    </span>
<span class="-3946461589801993391" onmouseenter="enter('-3946461589801993391');" onmouseout="out('-3946461589801993391');" style=""> 110      @Resource(name = &quot;blSandBoxHelper&quot;)                                                                           </span>
<span class="-7799183597372200632" onmouseenter="enter('-7799183597372200632');" onmouseout="out('-7799183597372200632');" style=""> 111      protected SandBoxHelper sandBoxHelper;                                                                        </span>
<span  style=""> 112                                                                                                                    </span>
<span class="-4259734795637808055" onmouseenter="enter('-4259734795637808055');" onmouseout="out('-4259734795637808055');" style=""> 113      @PersistenceContext(unitName=&quot;blPU&quot;)                                                                          </span>
<span class="-5741815223868414625" onmouseenter="enter('-5741815223868414625');" onmouseout="out('-5741815223868414625');" style=""> 114      protected EntityManager em;                                                                                   </span>
<span  style=""> 115                                                                                                                    </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 116      @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                           </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 117      protected StreamingTransactionCapableUtil transUtil;                                                          </span>
<span  style=""> 118                                                                                                                    </span>
<span class="-8384326529234094002" onmouseenter="enter('-8384326529234094002');" onmouseout="out('-8384326529234094002');" style=""> 119      @Resource(name=&quot;blEntityDuplicator&quot;)                                                                          </span>
<span class="-9194612273021432316" onmouseenter="enter('-9194612273021432316');" onmouseout="out('-9194612273021432316');" style=""> 120      protected EntityDuplicator duplicator;                                                                        </span>
<span  style=""> 121                                                                                                                    </span>
<span class="723166851410757036" onmouseenter="enter('723166851410757036');" onmouseout="out('723166851410757036');" style=""> 122      @Resource(name=&quot;blOfferDuplicateModifier&quot;)                                                                    </span>




<span class="8658910844320022950" onmouseenter="enter('8658910844320022950');" onmouseout="out('8658910844320022950');" style=""> 123      protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;                                              </span>
<span  style=""> 124                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 125      @Override                                                                                                     </span>
<span class="-2033305286790048708" onmouseenter="enter('-2033305286790048708');" onmouseout="out('-2033305286790048708');" style=""> 126      public List&lt;Offer&gt; findAllOffers() {                                                                          </span>
<span class="2132174063530273788" onmouseenter="enter('2132174063530273788');" onmouseout="out('2132174063530273788');" style=""> 127          return offerDao.readAllOffers();                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 128      }                                                                                                             </span>
<span  style=""> 129                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 130      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 131      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="7144811092176845141" onmouseenter="enter('7144811092176845141');" onmouseout="out('7144811092176845141');" style=""> 132      public Offer save(Offer offer) {                                                                              </span>
<span class="-264708178039771798" onmouseenter="enter('-264708178039771798');" onmouseout="out('-264708178039771798');" style=""> 133          return offerDao.save(offer);                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 134      }                                                                                                             </span>
<span  style=""> 135                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 136      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 137      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-5514670765130856091" onmouseenter="enter('-5514670765130856091');" onmouseout="out('-5514670765130856091');" style=""> 138      public OfferCode saveOfferCode(OfferCode offerCode) {                                                         </span>
<span class="3125778008044685658" onmouseenter="enter('3125778008044685658');" onmouseout="out('3125778008044685658');" style=""> 139          offerCode.setOffer(offerDao.save(offerCode.getOffer()));                                                  </span>
<span class="6906137479190051982" onmouseenter="enter('6906137479190051982');" onmouseout="out('6906137479190051982');" style=""> 140          return offerCodeDao.save(offerCode);                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 141      }                                                                                                             </span>
<span  style=""> 142                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 143      /**                                                                                                           </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""> 144       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,        </span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""> 145       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer        </span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 146       * cannot appear more than once in the list.                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 147       *                                                                                                            </span>
<span class="-709313334493645866" onmouseenter="enter('-709313334493645866');" onmouseout="out('-709313334493645866');" style=""> 148       * @param code                                                                                                </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 149       * @return a List of offers that may apply to this order                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 150       */                                                                                                           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 151      @Override                                                                                                     </span>
<span class="-6840847083603451180" onmouseenter="enter('-6840847083603451180');" onmouseout="out('-6840847083603451180');" style=""> 152      public Offer lookupOfferByCode(String code) {                                                                 </span>
<span class="-531732708503781646" onmouseenter="enter('-531732708503781646');" onmouseout="out('-531732708503781646');" style=""> 153          Offer offer = null;                                                                                       </span>
<span class="-8218576552188075283" onmouseenter="enter('-8218576552188075283');" onmouseout="out('-8218576552188075283');" style=""> 154          OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);                                             </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 155          if (offerCode != null) {                                                                                  </span>
<span class="-2561785727340284423" onmouseenter="enter('-2561785727340284423');" onmouseout="out('-2561785727340284423');" style=""> 156              offer = offerCode.getOffer();                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 157          }                                                                                                         </span>
<span class="-8963791522625561917" onmouseenter="enter('-8963791522625561917');" onmouseout="out('-8963791522625561917');" style=""> 158          return offer;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 159      }                                                                                                             </span>
<span  style=""> 160                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 161      @Override                                                                                                     </span>
<span class="2883322601430833612" onmouseenter="enter('2883322601430833612');" onmouseout="out('2883322601430833612');" style=""> 162      public OfferCode lookupOfferCodeByCode(String code){                                                          </span>
<span class="8795189428566002896" onmouseenter="enter('8795189428566002896');" onmouseout="out('8795189428566002896');" style=""> 163          return offerCodeDao.readOfferCodeByCode(code);                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 164      }                                                                                                             </span>
<span  style=""> 165                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 166      @Override                                                                                                     </span>
<span class="-2543778591938191529" onmouseenter="enter('-2543778591938191529');" onmouseout="out('-2543778591938191529');" style=""> 167      public List&lt;Offer&gt; lookupAllOffersByCode(String code) {                                                       </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 168          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                              </span>
<span class="-3360697953765841703" onmouseenter="enter('-3360697953765841703');" onmouseout="out('-3360697953765841703');" style=""> 169          List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);                                  </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 170          for (OfferCode offerCode : offerCodes) {                                                                  </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 171              if (offerCode != null) {                                                                              </span>
<span class="-7816274075460376657" onmouseenter="enter('-7816274075460376657');" onmouseout="out('-7816274075460376657');" style=""> 172                  offers.add(offerCode.getOffer());                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 173              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 174          }                                                                                                         </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 175          return offers;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 176      }                                                                                                             </span>
<span  style=""> 177                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 178      @Override                                                                                                     </span>
<span class="4676855439599320404" onmouseenter="enter('4676855439599320404');" onmouseout="out('4676855439599320404');" style=""> 179      public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){                                                </span>
<span class="-4234235759448675045" onmouseenter="enter('-4234235759448675045');" onmouseout="out('-4234235759448675045');" style=""> 180          return offerCodeDao.readAllOfferCodesByCode(code);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181      }                                                                                                             </span>
<span  style=""> 182                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 183      /**                                                                                                           </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""> 184       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,        </span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""> 185       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer        </span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 186       * cannot appear more than once in the list.                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 187       *                                                                                                            </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 188       * @param order                                                                                               </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 189       * @return a List of offers that may apply to this order                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 190       */                                                                                                           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 191      @Override                                                                                                     </span>
<span class="-5814298891852821500" onmouseenter="enter('-5814298891852821500');" onmouseout="out('-5814298891852821500');" style=""> 192      public List&lt;Offer&gt; buildOfferListForOrder(Order order) {                                                      </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 193          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                              </span>
<span class="-3235900677601494398" onmouseenter="enter('-3235900677601494398');" onmouseout="out('-3235900677601494398');" style=""> 194          List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());                  </span>
<span class="7699769166343685501" onmouseenter="enter('7699769166343685501');" onmouseout="out('7699769166343685501');" style=""> 195          for (CustomerOffer customerOffer : customerOffers) {                                                      </span>
<span class="-2310400538171319838" onmouseenter="enter('-2310400538171319838');" onmouseout="out('-2310400538171319838');" style=""> 196              if (!offers.contains(customerOffer.getOffer())) {                                                     </span>
<span class="5233078073066950969" onmouseenter="enter('5233078073066950969');" onmouseout="out('5233078073066950969');" style=""> 197                  offers.add(customerOffer.getOffer());                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 198              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 199          }                                                                                                         </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style=""> 200          List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                                   </span>
<span class="-6665865767746694239" onmouseenter="enter('-6665865767746694239');" onmouseout="out('-6665865767746694239');" style=""> 201          orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                             </span>
<span class="2682597879629079185" onmouseenter="enter('2682597879629079185');" onmouseout="out('2682597879629079185');" style=""> 202          for (OfferCode orderOfferCode : orderOfferCodes) {                                                        </span>
<span class="-1857624084667800558" onmouseenter="enter('-1857624084667800558');" onmouseout="out('-1857624084667800558');" style=""> 203              if (!offers.contains(orderOfferCode.getOffer())) {                                                    </span>
<span class="4188766124804405127" onmouseenter="enter('4188766124804405127');" onmouseout="out('4188766124804405127');" style=""> 204                  offers.add(orderOfferCode.getOffer());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 205              }                                                                                                     </span>
<span class="-4468546552745233084" onmouseenter="enter('-4468546552745233084');" onmouseout="out('-4468546552745233084');" style=""> 206              extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 207          }                                                                                                         </span>
<span class="-9188634082558155234" onmouseenter="enter('-9188634082558155234');" onmouseout="out('-9188634082558155234');" style=""> 208          List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();                                               </span>
<span class="-8411171878687156520" onmouseenter="enter('-8411171878687156520');" onmouseout="out('-8411171878687156520');" style=""> 209          for (Offer globalOffer : globalOffers) {                                                                  </span>
<span class="2071278729839157974" onmouseenter="enter('2071278729839157974');" onmouseout="out('2071278729839157974');" style=""> 210              if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {           </span>
<span class="-3050025518373868772" onmouseenter="enter('-3050025518373868772');" onmouseout="out('-3050025518373868772');" style=""> 211                  offers.add(globalOffer);                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 212              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 213          }                                                                                                         </span>
<span  style=""> 214                                                                                                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 215          if (extensionManager != null) {                                                                           </span>
<span class="1817402996237899777" onmouseenter="enter('1817402996237899777');" onmouseout="out('1817402996237899777');" style=""> 216              extensionManager.applyAdditionalFilters(offers, order);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 217          }                                                                                                         </span>
<span  style=""> 218                                                                                                                    </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 219          return offers;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 220      }                                                                                                             </span>
<span  style=""> 221                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 222      @Override                                                                                                     </span>
<span class="2056305643902587707" onmouseenter="enter('2056305643902587707');" onmouseout="out('2056305643902587707');" style=""> 223      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {                                           </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 224          Customer customer = order.getCustomer();                                                                  </span>
<span class="-5041998041456755776" onmouseenter="enter('-5041998041456755776');" onmouseout="out('-5041998041456755776');" style=""> 225          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();                                                      </span>
<span  style=""> 226                                                                                                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 227          if (extensionManager != null) {                                                                           </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 228              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 229          }                                                                                                         </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 230          if (!offerCodes.isEmpty()) {                                                                              </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 231              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                                      </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 232              while (itr.hasNext()) {                                                                               </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 233                  OfferCode offerCode = itr.next();                                                                 </span>
<span class="-776136422183497161" onmouseenter="enter('-776136422183497161');" onmouseout="out('-776136422183497161');" style=""> 234                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {                </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 235                      itr.remove();                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 236                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 237              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 238          }                                                                                                         </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 239          return offerCodes;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 240      }                                                                                                             </span>
<span  style=""> 241                                                                                                                    </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 242      @Deprecated                                                                                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 243      @Override                                                                                                     </span>
<span class="3843851677430304310" onmouseenter="enter('3843851677430304310');" onmouseout="out('3843851677430304310');" style=""> 244      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {                                     </span>
<span class="-6957816096303048614" onmouseenter="enter('-6957816096303048614');" onmouseout="out('-6957816096303048614');" style=""> 245          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();                                             </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 246          if (extensionManager != null) {                                                                           </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 247              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 248          }                                                                                                         </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 249          if (!offerCodes.isEmpty()) {                                                                              </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 250              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                                      </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 251              while (itr.hasNext()) {                                                                               </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 252                  OfferCode offerCode = itr.next();                                                                 </span>
<span class="6086018267170409432" onmouseenter="enter('6086018267170409432');" onmouseout="out('6086018267170409432');" style=""> 253                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {             </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 254                      itr.remove();                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 255                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 256              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 257          }                                                                                                         </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 258          return offerCodes;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 259      }                                                                                                             </span>
<span  style=""> 260                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 261      /**                                                                                                           </span>
<span class="2837560355574155003" onmouseenter="enter('2837560355574155003');" onmouseout="out('2837560355574155003');" style=""> 262       * Private method used to retrieve all offers assigned to this customer.  These offers are                    </span>
<span class="4852710310174118924" onmouseenter="enter('4852710310174118924');" onmouseout="out('4852710310174118924');" style=""> 263       * programmatically assigned to the customer.                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 264       *                                                                                                            </span>
<span class="1094425505394812731" onmouseenter="enter('1094425505394812731');" onmouseout="out('1094425505394812731');" style=""> 265       * @param customer                                                                                            </span>
<span class="-3868237647402015492" onmouseenter="enter('-3868237647402015492');" onmouseout="out('-3868237647402015492');" style=""> 266       * @return a List of offers assigned to the customer                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 267       */                                                                                                           </span>
<span class="-1064959765029423996" onmouseenter="enter('-1064959765029423996');" onmouseout="out('-1064959765029423996');" style=""> 268      protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {                              </span>
<span class="1699675085073278700" onmouseenter="enter('1699675085073278700');" onmouseout="out('1699675085073278700');" style=""> 269          List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);             </span>
<span class="5611761187435301880" onmouseenter="enter('5611761187435301880');" onmouseout="out('5611761187435301880');" style=""> 270          return offerCustomers;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 271      }                                                                                                             </span>
<span  style=""> 272                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 273      /**                                                                                                           </span>
<span class="-8831229104457932482" onmouseenter="enter('-8831229104457932482');" onmouseout="out('-8831229104457932482');" style=""> 274       * Private method used to retrieve all offers with automaticallyAdded set to true                             </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 275       *                                                                                                            </span>
<span class="-2057313490179191281" onmouseenter="enter('-2057313490179191281');" onmouseout="out('-2057313490179191281');" style=""> 276       * @return a List of automatic delivery offers                                                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 277       */                                                                                                           </span>
<span class="-9186908469762752320" onmouseenter="enter('-9186908469762752320');" onmouseout="out('-9186908469762752320');" style=""> 278      protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {                                                       </span>
<span class="-2657712449795339218" onmouseenter="enter('-2657712449795339218');" onmouseout="out('-2657712449795339218');" style=""> 279          List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();                                  </span>
<span class="-7738403477037597046" onmouseenter="enter('-7738403477037597046');" onmouseout="out('-7738403477037597046');" style=""> 280          return globalOffers;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 281      }                                                                                                             </span>
<span  style=""> 282                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 283      /**                                                                                                           </span>
<span class="-582485916100204765" onmouseenter="enter('-582485916100204765');" onmouseout="out('-582485916100204765');" style=""> 284       * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end                    </span>
<span class="-591413864231465226" onmouseenter="enter('-591413864231465226');" onmouseout="out('-591413864231465226');" style=""> 285       * date.  If an offerCode has a later start date, that offerCode will be removed.                             </span>
<span class="-1600892852414517397" onmouseenter="enter('-1600892852414517397');" onmouseout="out('-1600892852414517397');" style=""> 286       * OfferCodes without a start date will still be processed. If the offerCode                                  </span>
<span class="-6972954356288154926" onmouseenter="enter('-6972954356288154926');" onmouseout="out('-6972954356288154926');" style=""> 287       * has a end date that has already passed, that offerCode will be removed.  OfferCodes                        </span>
<span class="-7007360996659097530" onmouseenter="enter('-7007360996659097530');" onmouseout="out('-7007360996659097530');" style=""> 288       * without a end date will be processed.  The start and end dates on the offer will                           </span>
<span class="-216139196908541615" onmouseenter="enter('-216139196908541615');" onmouseout="out('-216139196908541615');" style=""> 289       * still need to be evaluated.                                                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 290       *                                                                                                            </span>
<span class="-142155654396048960" onmouseenter="enter('-142155654396048960');" onmouseout="out('-142155654396048960');" style=""> 291       * @param offerCodes                                                                                          </span>
<span class="-7645314644020819692" onmouseenter="enter('-7645314644020819692');" onmouseout="out('-7645314644020819692');" style=""> 292       * @return a List of non-expired offers                                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 293       */                                                                                                           </span>
<span class="3097073257270455619" onmouseenter="enter('3097073257270455619');" onmouseout="out('3097073257270455619');" style=""> 294      protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){                              </span>
<span class="-71581284051087612" onmouseenter="enter('-71581284051087612');" onmouseout="out('-71581284051087612');" style=""> 295          List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();                                          </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 296          for (OfferCode offerCode : offerCodes) {                                                                  </span>
<span class="4179739580098873664" onmouseenter="enter('4179739580098873664');" onmouseout="out('4179739580098873664');" style=""> 297              if (!offerCode.isActive()){                                                                           </span>
<span class="2973899686965396382" onmouseenter="enter('2973899686965396382');" onmouseout="out('2973899686965396382');" style=""> 298                  offerCodesToRemove.add(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 299              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 300          }                                                                                                         </span>
<span class="3113103044265464111" onmouseenter="enter('3113103044265464111');" onmouseout="out('3113103044265464111');" style=""> 301          // remove all offers in the offersToRemove list from original offers list                                 </span>
<span class="6883206030034557562" onmouseenter="enter('6883206030034557562');" onmouseout="out('6883206030034557562');" style=""> 302          for (OfferCode offerCode : offerCodesToRemove) {                                                          </span>
<span class="-8473869847996752510" onmouseenter="enter('-8473869847996752510');" onmouseout="out('-8473869847996752510');" style=""> 303              offerCodes.remove(offerCode);                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 304          }                                                                                                         </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 305          return offerCodes;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 306      }                                                                                                             </span>
<span  style=""> 307                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 308      /**                                                                                                           </span>
<span class="5637961435104982406" onmouseenter="enter('5637961435104982406');" onmouseout="out('5637961435104982406');" style=""> 309       * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with                </span>
<span class="1724276086246688719" onmouseenter="enter('1724276086246688719');" onmouseout="out('1724276086246688719');" style=""> 310       * current sandbox status.                                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 311       *                                                                                                            </span>
<span class="202872854140107873" onmouseenter="enter('202872854140107873');" onmouseout="out('202872854140107873');" style=""> 312       * @param order the order to check                                                                            </span>
<span class="2772482249434351691" onmouseenter="enter('2772482249434351691');" onmouseout="out('2772482249434351691');" style=""> 313       * @return the refreshed list of OfferCodes                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 314       */                                                                                                           </span>
<span class="7210051143895905366" onmouseenter="enter('7210051143895905366');" onmouseout="out('7210051143895905366');" style=""> 315      protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {                                  </span>
<span class="7464496307728629396" onmouseenter="enter('7464496307728629396');" onmouseout="out('7464496307728629396');" style=""> 316          final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();                                       </span>
<span  style=""> 317                                                                                                                    </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 318          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 319              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 320              public void execute() {                                                                               </span>
<span class="-6058145000184664425" onmouseenter="enter('-6058145000184664425');" onmouseout="out('-6058145000184664425');" style=""> 321                  for (OfferCode offerCode : orderOfferCodes) {                                                     </span>
<span class="-4263515828536000223" onmouseenter="enter('-4263515828536000223');" onmouseout="out('-4263515828536000223');" style=""> 322                      if (offerCode.getOffer() != null) {                                                           </span>
<span class="8507823172595815939" onmouseenter="enter('8507823172595815939');" onmouseout="out('8507823172595815939');" style=""><abbr title=" 323                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 323                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOfðŸ”µ</abbr></span>
<span class="-4217337457935304447" onmouseenter="enter('-4217337457935304447');" onmouseout="out('-4217337457935304447');" style=""><abbr title=" 324                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 324                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getðŸ”µ</abbr></span>
<span class="-6104864632261418874" onmouseenter="enter('-6104864632261418874');" onmouseout="out('-6104864632261418874');" style=""> 325                              em.refresh(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 326                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 327                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 328                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 329              }                                                                                                     </span>
<span  style=""> 330                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 331              @Override                                                                                             </span>
<span class="1336357167460974281" onmouseenter="enter('1336357167460974281');" onmouseout="out('1336357167460974281');" style=""> 332              public boolean shouldRetryOnTransactionLockAcquisitionFailure() {                                     </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 333                  return true;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 334              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 335          }, RuntimeException.class);                                                                               </span>
<span  style=""> 336                                                                                                                    </span>
<span class="720292142172901868" onmouseenter="enter('720292142172901868');" onmouseout="out('720292142172901868');" style=""> 337          return orderOfferCodes;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 338      }                                                                                                             </span>
<span  style=""> 339                                                                                                                    </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 340      /*                                                                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 341       *                                                                                                            </span>
<span class="-1078885518483632555" onmouseenter="enter('-1078885518483632555');" onmouseout="out('-1078885518483632555');" style=""> 342       * Offers Logic:                                                                                              </span>
<span class="-6544489594486398439" onmouseenter="enter('-6544489594486398439');" onmouseout="out('-6544489594486398439');" style=""> 343       * 1) Remove all existing offers in the Order (order, item, and fulfillment)                                  </span>
<span class="472654013095872963" onmouseenter="enter('472654013095872963');" onmouseout="out('472654013095872963');" style=""> 344       * 2) Check and remove offers                                                                                 </span>
<span class="8111384560802328496" onmouseenter="enter('8111384560802328496');" onmouseout="out('8111384560802328496');" style=""> 345       *    a) Remove out of date offers                                                                            </span>
<span class="3025649188866691570" onmouseenter="enter('3025649188866691570');" onmouseout="out('3025649188866691570');" style=""> 346       *    b) Remove offers that do not apply to this customer                                                     </span>
<span class="5156402814943015913" onmouseenter="enter('5156402814943015913');" onmouseout="out('5156402814943015913');" style=""> 347       * 3) Loop through offers                                                                                     </span>
<span class="6235203245796610706" onmouseenter="enter('6235203245796610706');" onmouseout="out('6235203245796610706');" style=""> 348       *    a) Verifies type of offer (order, order item, fulfillment)                                              </span>
<span class="7315686159335672158" onmouseenter="enter('7315686159335672158');" onmouseout="out('7315686159335672158');" style=""> 349       *    b) Verifies if offer can be applies                                                                     </span>
<span class="-6634234506054969031" onmouseenter="enter('-6634234506054969031');" onmouseout="out('-6634234506054969031');" style=""> 350       *    c) Assign offer to type (order, order item, or fulfillment)                                             </span>
<span class="-4584093434328536587" onmouseenter="enter('-4584093434328536587');" onmouseout="out('-4584093434328536587');" style=""> 351       * 4) Sorts the order and item offers list by priority and then discount                                      </span>
<span class="-2042995489836168848" onmouseenter="enter('-2042995489836168848');" onmouseout="out('-2042995489836168848');" style=""> 352       * 5) Identify the best offers to apply to order item and create adjustments for each item offer              </span>
<span class="8597383329030492662" onmouseenter="enter('8597383329030492662');" onmouseout="out('8597383329030492662');" style=""> 353       * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better      </span>
<span class="-5003028621529242985" onmouseenter="enter('-5003028621529242985');" onmouseout="out('-5003028621529242985');" style=""> 354       * 7) Identify the best offers to apply to the order and create adjustments for each order offer              </span>
<span class="-1324083657955785943" onmouseenter="enter('-1324083657955785943');" onmouseout="out('-1324083657955785943');" style=""><abbr title=" 355       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 355       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount valðŸ”µ</abbr></span>
<span class="-8610949319074908232" onmouseenter="enter('-8610949319074908232');" onmouseout="out('-8610949319074908232');" style=""> 356       * 9) Set final order item prices and reapply order offers                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 357       *                                                                                                            </span>
<span class="9071544830737596533" onmouseenter="enter('9071544830737596533');" onmouseout="out('9071544830737596533');" style=""> 358       * Assumptions:                                                                                               </span>
<span class="7676524731541901514" onmouseenter="enter('7676524731541901514');" onmouseout="out('7676524731541901514');" style=""> 359       * 1) % off all items will be created as an item offer with no expression                                     </span>
<span class="-814522364757940962" onmouseenter="enter('-814522364757940962');" onmouseout="out('-814522364757940962');" style=""> 360       * 2) $ off order will be created as an order offer                                                           </span>
<span class="7365449813142531261" onmouseenter="enter('7365449813142531261');" onmouseout="out('7365449813142531261');" style=""> 361       * 3) Order offers applies to the best price for each item (not just retail price)                            </span>
<span class="-1636653647835076359" onmouseenter="enter('-1636653647835076359');" onmouseout="out('-1636653647835076359');" style=""> 362       * 4) Fulfillment offers apply to best price for each item (not just retail price)                            </span>
<span class="-5866280996345915157" onmouseenter="enter('-5866280996345915157');" onmouseout="out('-5866280996345915157');" style=""><abbr title=" 363       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 363       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item ofðŸ”µ</abbr></span>
<span class="-8022045642448063338" onmouseenter="enter('-8022045642448063338');" onmouseout="out('-8022045642448063338');" style=""> 364       * 6) Fulfillment offers cannot be not combinable                                                             </span>
<span class="-5108644804585013203" onmouseenter="enter('-5108644804585013203');" onmouseout="out('-5108644804585013203');" style=""> 365       * 7) Order offers cannot be FIXED_PRICE                                                                      </span>
<span class="6161153439596163093" onmouseenter="enter('6161153439596163093');" onmouseout="out('6161153439596163093');" style=""> 366       * 8) FIXED_PRICE offers cannot be stackable                                                                  </span>
<span class="7044504232316014062" onmouseenter="enter('7044504232316014062');" onmouseout="out('7044504232316014062');" style=""><abbr title=" 367       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 367       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always applðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 368       *                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 369       */                                                                                                           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 370      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 371      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-4704847871427432866" onmouseenter="enter('-4704847871427432866');" onmouseout="out('-4704847871427432866');" style=""> 372      public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {             </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 373          /*                                                                                                        </span>
<span class="-6180845550366984877" onmouseenter="enter('-6180845550366984877');" onmouseout="out('-6180845550366984877');" style=""> 374          TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to          </span>
<span class="9161254164549280190" onmouseenter="enter('9161254164549280190');" onmouseout="out('9161254164549280190');" style=""> 375          use a richer object to describe the parameters of the pricing call. This object would include             </span>
<span class="1561516658361300705" onmouseenter="enter('1561516658361300705');" onmouseout="out('1561516658361300705');" style=""> 376          the pricing boolean, but would also include a list of activities to include or exclude in the             </span>
<span class="-6797832594843538707" onmouseenter="enter('-6797832594843538707');" onmouseout="out('-6797832594843538707');" style=""> 377          call - see http://jira.broadleafcommerce.org/browse/BLC-664                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 378           */                                                                                                       </span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 379          OfferContext offerContext = OfferContext.getOfferContext();                                               </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 380          if (offerContext == null || offerContext.executePromotionCalculation) {                                   </span>
<span class="-2683885994659783076" onmouseenter="enter('-2683885994659783076');" onmouseout="out('-2683885994659783076');" style=""> 381              PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false);          </span>
<span class="-9066266687178937853" onmouseenter="enter('-9066266687178937853');" onmouseout="out('-9066266687178937853');" style=""> 382              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());           </span>
<span class="-1421782411503697087" onmouseenter="enter('-1421782411503697087');" onmouseout="out('-1421782411503697087');" style=""> 383              if ((filteredOffers == null) || (filteredOffers.isEmpty())) {                                         </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 384                  if (LOG.isTraceEnabled()) {                                                                       </span>
<span class="2760579588161124045" onmouseenter="enter('2760579588161124045');" onmouseout="out('2760579588161124045');" style=""> 385                      LOG.trace(&quot;No offers applicable to this order.&quot;);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 386                  }                                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 387              } else {                                                                                              </span>
<span class="7300520529047311728" onmouseenter="enter('7300520529047311728');" onmouseout="out('7300520529047311728');" style=""><abbr title=" 388                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 388                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOðŸ”µ</abbr></span>
<span class="-7404348590242143631" onmouseenter="enter('-7404348590242143631');" onmouseout="out('-7404348590242143631');" style=""><abbr title=" 389                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 389                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffeðŸ”µ</abbr></span>
<span  style=""> 390                                                                                                                    </span>
<span class="-5526882442984993330" onmouseenter="enter('-5526882442984993330');" onmouseout="out('-5526882442984993330');" style=""><abbr title=" 391                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 391                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItðŸ”µ</abbr></span>
<span  style=""> 392                                                                                                                    </span>
<span class="-6480919216777131248" onmouseenter="enter('-6480919216777131248');" onmouseout="out('-6480919216777131248');" style=""> 393                  if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {                        </span>
<span class="-2723881742436166059" onmouseenter="enter('-2723881742436166059');" onmouseout="out('-2723881742436166059');" style=""> 394                      // At this point, we should have a PromotableOrder that contains PromotableItems each of which</span>
<span class="751015906320167144" onmouseenter="enter('751015906320167144');" onmouseout="out('751015906320167144');" style=""> 395                      // has a list of candidatePromotions that might be applied.                                   </span>
<span  style=""> 396                                                                                                                    </span>
<span class="5941864862011378901" onmouseenter="enter('5941864862011378901');" onmouseout="out('5941864862011378901');" style=""><abbr title=" 397                      // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 397                      // We also have a list of orderOffers that might apply and a list of itemOffers that might appðŸ”µ</abbr></span>
<span class="1127078869550353626" onmouseenter="enter('1127078869550353626');" onmouseout="out('1127078869550353626');" style=""><abbr title=" 398                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 398                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, quðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 399                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 400              }                                                                                                     </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 401              orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                                 </span>
<span  style=""> 402                                                                                                                    </span>
<span class="514986819999277890" onmouseenter="enter('514986819999277890');" onmouseout="out('514986819999277890');" style=""> 403              verifyAdjustments(order, true);                                                                       </span>
<span  style=""> 404                                                                                                                    </span>
<span class="-8901364638816691349" onmouseenter="enter('-8901364638816691349');" onmouseout="out('-8901364638816691349');" style=""> 405              order.setSubTotal(order.calculateSubTotal());                                                         </span>
<span class="8881079200386597596" onmouseenter="enter('8881079200386597596');" onmouseout="out('8881079200386597596');" style=""> 406              order.finalizeItemPrices();                                                                           </span>
<span  style=""> 407                                                                                                                    </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 408              order = orderService.save(order, false);                                                              </span>
<span  style=""> 409                                                                                                                    </span>
<span class="-5335273514929397197" onmouseenter="enter('-5335273514929397197');" onmouseout="out('-5335273514929397197');" style=""> 410              boolean madeChange = verifyAdjustments(order, false);                                                 </span>
<span class="-3218959195648057803" onmouseenter="enter('-3218959195648057803');" onmouseout="out('-3218959195648057803');" style=""> 411              if (madeChange) {                                                                                     </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 412                  order = orderService.save(order, false);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 413              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 414          }                                                                                                         </span>
<span  style=""> 415                                                                                                                    </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 416          return order;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 417      }                                                                                                             </span>
<span  style=""> 418                                                                                                                    </span>
<span class="219209447823395758" onmouseenter="enter('219209447823395758');" onmouseout="out('219209447823395758');" style=""> 419      protected boolean verifyAdjustments(Order order, boolean beforeSave) {                                        </span>
<span class="79408939766017075" onmouseenter="enter('79408939766017075');" onmouseout="out('79408939766017075');" style=""> 420          boolean madeChange = false;                                                                               </span>
<span  style=""> 421                                                                                                                    </span>
<span class="-8966123689509035198" onmouseenter="enter('-8966123689509035198');" onmouseout="out('-8966123689509035198');" style=""> 422          if (order.getOrderItems() == null) {                                                                      </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 423              return madeChange;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 424          }                                                                                                         </span>
<span  style=""> 425                                                                                                                    </span>
<span class="8447029191885982498" onmouseenter="enter('8447029191885982498');" onmouseout="out('8447029191885982498');" style=""> 426          for (OrderItem oi : order.getOrderItems()) {                                                              </span>
<span class="-5982197742320851056" onmouseenter="enter('-5982197742320851056');" onmouseout="out('-5982197742320851056');" style=""> 427              if (oi.getOrderItemPriceDetails() == null) {                                                          </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 428                  continue;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 429              }                                                                                                     </span>
<span  style=""> 430                                                                                                                    </span>
<span class="7391296704731194189" onmouseenter="enter('7391296704731194189');" onmouseout="out('7391296704731194189');" style=""> 431              for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {                                       </span>
<span class="-8259157388002947293" onmouseenter="enter('-8259157388002947293');" onmouseout="out('-8259157388002947293');" style=""> 432                  if (pd.getOrderItemPriceDetailAdjustments() == null) {                                            </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 433                      continue;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 434                  }                                                                                                 </span>
<span  style=""> 435                                                                                                                    </span>
<span class="-8160497408394725913" onmouseenter="enter('-8160497408394725913');" onmouseout="out('-8160497408394725913');" style=""><abbr title=" 436                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 436                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;ðŸ”µ</abbr></span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 437                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 437                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjusðŸ”µ</abbr></span>
<span class="-3008507732031274392" onmouseenter="enter('-3008507732031274392');" onmouseout="out('-3008507732031274392');" style=""> 438                  for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {              </span>
<span class="-1975641521768786423" onmouseenter="enter('-1975641521768786423');" onmouseout="out('-1975641521768786423');" style=""> 439                      if (adjs.containsKey(adj.getOffer().getId())) {                                               </span>
<span class="-6913168070672082713" onmouseenter="enter('-6913168070672082713');" onmouseout="out('-6913168070672082713');" style=""> 440                          adjustmentsToRemove.add(adj);                                                             </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 441                          if (LOG.isDebugEnabled()) {                                                               </span>
<span class="-2834336870885753779" onmouseenter="enter('-2834336870885753779');" onmouseout="out('-2834336870885753779');" style=""> 442                              StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)                          </span>
<span class="201513945492742471" onmouseenter="enter('201513945492742471');" onmouseout="out('201513945492742471');" style=""> 443                                  .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)                            </span>
<span class="2195430440089355634" onmouseenter="enter('2195430440089355634');" onmouseout="out('2195430440089355634');" style=""> 444                                  .append(&quot; with ids &quot;)                                                             </span>
<span class="-3149719647859419210" onmouseenter="enter('-3149719647859419210');" onmouseout="out('-3149719647859419210');" style=""> 445                                  .append(adjs.get(adj.getOffer().getId()).getId())                                 </span>
<span class="7312533819175146387" onmouseenter="enter('7312533819175146387');" onmouseout="out('7312533819175146387');" style=""> 446                                  .append(&quot; and &quot;)                                                                  </span>
<span class="6832270653349147085" onmouseenter="enter('6832270653349147085');" onmouseout="out('6832270653349147085');" style=""> 447                                  .append(adj.getId());                                                             </span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 448                              LOG.debug(sb.toString());                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 449                          }                                                                                         </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 450                      } else {                                                                                      </span>
<span class="-7759509127049565554" onmouseenter="enter('-7759509127049565554');" onmouseout="out('-7759509127049565554');" style=""> 451                          adjs.put(adj.getOffer().getId(), adj);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 452                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 453                  }                                                                                                 </span>
<span  style=""> 454                                                                                                                    </span>
<span class="7848730128284985932" onmouseenter="enter('7848730128284985932');" onmouseout="out('7848730128284985932');" style=""> 455                  for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {                                  </span>
<span class="6756116260498887863" onmouseenter="enter('6756116260498887863');" onmouseout="out('6756116260498887863');" style=""> 456                      pd.getOrderItemPriceDetailAdjustments().remove(adj);                                          </span>
<span class="5571803755205047298" onmouseenter="enter('5571803755205047298');" onmouseout="out('5571803755205047298');" style=""> 457                      madeChange = true;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 458                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 459              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 460          }                                                                                                         </span>
<span  style=""> 461                                                                                                                    </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 462          return madeChange;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 463       }                                                                                                            </span>
<span  style=""> 464                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 465      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 466      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 467      @Deprecated                                                                                                   </span>
<span class="-3021599232242429775" onmouseenter="enter('-3021599232242429775');" onmouseout="out('-3021599232242429775');" style=""> 468      public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {                     </span>
<span class="-6341015309393843959" onmouseenter="enter('-6341015309393843959');" onmouseout="out('-6341015309393843959');" style=""> 469          applyAndSaveOffersToOrder(offers, order);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 470      }                                                                                                             </span>
<span  style=""> 471                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 472      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 473      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 474      @Deprecated                                                                                                   </span>
<span class="-5535279977913938928" onmouseenter="enter('-5535279977913938928');" onmouseout="out('-5535279977913938928');" style=""> 475      public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {     </span>
<span class="6394386461467124428" onmouseenter="enter('6394386461467124428');" onmouseout="out('6394386461467124428');" style=""> 476          applyAndSaveFulfillmentGroupOffersToOrder(offers, order);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 477      }                                                                                                             </span>
<span  style=""> 478                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 479      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 480      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="2855881782634007850" onmouseenter="enter('2855881782634007850');" onmouseout="out('2855881782634007850');" style=""><abbr title=" 481      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 481      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptioðŸ”µ</abbr></span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 482          OfferContext offerContext = OfferContext.getOfferContext();                                               </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 483          if (offerContext == null || offerContext.executePromotionCalculation) {                                   </span>
<span class="-791836473256513905" onmouseenter="enter('-791836473256513905');" onmouseout="out('-791836473256513905');" style=""> 484              PromotableOrder promotableOrder =                                                                     </span>
<span class="-5771222684966163235" onmouseenter="enter('-5771222684966163235');" onmouseout="out('-5771222684966163235');" style=""> 485                      promotableItemFactory.createPromotableOrder(order, true);                                     </span>
<span class="-6252467951249219732" onmouseenter="enter('-6252467951249219732');" onmouseout="out('-6252467951249219732');" style=""> 486              List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();                                                </span>
<span class="-8689854403875612694" onmouseenter="enter('-8689854403875612694');" onmouseout="out('-8689854403875612694');" style=""> 487              for (Offer offer : offers) {                                                                          </span>
<span class="3344482016035270743" onmouseenter="enter('3344482016035270743');" onmouseout="out('3344482016035270743');" style=""> 488                  if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {                    </span>
<span class="2965579239059640859" onmouseenter="enter('2965579239059640859');" onmouseout="out('2965579239059640859');" style=""> 489                      possibleFGOffers.add(offer);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 490                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 491              }                                                                                                     </span>
<span class="7272445213685933500" onmouseenter="enter('7272445213685933500');" onmouseout="out('7272445213685933500');" style=""> 492              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer()); </span>
<span class="-380250791493510209" onmouseenter="enter('-380250791493510209');" onmouseout="out('-380250791493510209');" style=""><abbr title=" 493              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 493              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFuðŸ”µ</abbr></span>
<span class="5471512156259214352" onmouseenter="enter('5471512156259214352');" onmouseout="out('5471512156259214352');" style=""> 494              for (Offer offer : filteredOffers) {                                                                  </span>
<span class="6341701119621727258" onmouseenter="enter('6341701119621727258');" onmouseout="out('6341701119621727258');" style=""><abbr title=" 495                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 495                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffersðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 496              }                                                                                                     </span>
<span class="6757974448768463" onmouseenter="enter('6757974448768463');" onmouseout="out('6757974448768463');" style=""> 497              if (!qualifiedFGOffers.isEmpty()) {                                                                   </span>
<span class="-3737539762239464744" onmouseenter="enter('-3737539762239464744');" onmouseout="out('-3737539762239464744');" style=""> 498                  fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);</span>
<span class="-1748187190347404908" onmouseenter="enter('-1748187190347404908');" onmouseout="out('-1748187190347404908');" style=""> 499                  fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);                   </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 500                  orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 501              }                                                                                                     </span>
<span  style=""> 502                                                                                                                    </span>
<span class="-7204486914274790826" onmouseenter="enter('-7204486914274790826');" onmouseout="out('-7204486914274790826');" style=""> 503              return orderService.save(order, false);                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 504          }                                                                                                         </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 505          return order;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 506      }                                                                                                             </span>
<span  style=""> 507                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 508      @Override                                                                                                     </span>
<span class="-8983195686564092827" onmouseenter="enter('-8983195686564092827');" onmouseout="out('-8983195686564092827');" style=""> 509      public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {                                    </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 510          Customer customer = order.getCustomer();                                                                  </span>
<span  style=""> 511                                                                                                                    </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 512 -        if (offer.isLimitedUsePerCustomer()) {                                                                    </span>
<span class="5393081257737861323" onmouseenter="enter('5393081257737861323');" onmouseout="out('5393081257737861323');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 513 +        if (customer != null &amp;&amp; customer.isRegistered() &amp;&amp; offer.isLimitedUsePerCustomer()) {                     </span>
<span class="-8305970541390666259" onmouseenter="enter('-8305970541390666259');" onmouseout="out('-8305970541390666259');" style=""> 514              Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());     </span>








<span  style=""> 515                                                                                                                    </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 516              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                                   </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 517                  return false;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 518              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 519          }                                                                                                         </span>
<span  style=""> 520                                                                                                                    </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 521          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 522      }                                                                                                             </span>
<span  style=""> 523                                                                                                                    </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 524      @Deprecated                                                                                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 525      @Override                                                                                                     </span>
<span class="4849754295577860926" onmouseenter="enter('4849754295577860926');" onmouseout="out('4849754295577860926');" style=""> 526      public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {                              </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 527          if (offer.isLimitedUsePerCustomer()) {                                                                    </span>
<span class="8084739095609490454" onmouseenter="enter('8084739095609490454');" onmouseout="out('8084739095609490454');" style=""> 528              Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());            </span>
<span  style=""> 529                                                                                                                    </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 530              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                                   </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 531                  return false;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 532              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 533          }                                                                                                         </span>
<span  style=""> 534                                                                                                                    </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 535          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 536      }                                                                                                             </span>
<span  style=""> 537                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 538      @Override                                                                                                     </span>
<span class="-4305912419408886648" onmouseenter="enter('-4305912419408886648');" onmouseout="out('-4305912419408886648');" style=""> 539      public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {                                 </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 540          boolean underCodeMaxUses = true;                                                                          </span>
<span  style=""> 541                                                                                                                    </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 542          if (code.isLimitedUse()) {                                                                                </span>
<span class="-7378740545085856894" onmouseenter="enter('-7378740545085856894');" onmouseout="out('-7378740545085856894');" style=""> 543              Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());                     </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 544              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 545          }                                                                                                         </span>
<span  style=""> 546                                                                                                                    </span>
<span class="5446263071698048925" onmouseenter="enter('5446263071698048925');" onmouseout="out('5446263071698048925');" style=""> 547          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 548      }                                                                                                             </span>
<span  style=""> 549                                                                                                                    </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 550      @Deprecated                                                                                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 551      @Override                                                                                                     </span>
<span class="135967723667379112" onmouseenter="enter('135967723667379112');" onmouseout="out('135967723667379112');" style=""> 552      public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {                           </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 553          boolean underCodeMaxUses = true;                                                                          </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 554          if (code.isLimitedUse()) {                                                                                </span>
<span class="5487567461678823803" onmouseenter="enter('5487567461678823803');" onmouseout="out('5487567461678823803');" style=""> 555              Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());                            </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 556              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 557          }                                                                                                         </span>
<span class="7193079189056024188" onmouseenter="enter('7193079189056024188');" onmouseout="out('7193079189056024188');" style=""> 558          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 559      }                                                                                                             </span>
<span  style=""> 560                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 561      @Override                                                                                                     </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 562      @SuppressWarnings(&quot;unchecked&quot;)                                                                                </span>
<span class="-640784293225096821" onmouseenter="enter('-640784293225096821');" onmouseout="out('-640784293225096821');" style=""> 563      public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {                                                     </span>
<span class="-348027159212233091" onmouseenter="enter('-348027159212233091');" onmouseout="out('-348027159212233091');" style=""> 564          HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();                                                             </span>
<span  style=""> 565                                                                                                                    </span>
<span class="-7949809618309864364" onmouseenter="enter('-7949809618309864364');" onmouseout="out('-7949809618309864364');" style=""> 566          Transformer adjustmentToOfferTransformer = new Transformer() {                                            </span>
<span  style=""> 567                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 568              @Override                                                                                             </span>
<span class="-2718541205900117239" onmouseenter="enter('-2718541205900117239');" onmouseout="out('-2718541205900117239');" style=""> 569              public Object transform(Object input) {                                                               </span>
<span class="4176981446584954696" onmouseenter="enter('4176981446584954696');" onmouseout="out('4176981446584954696');" style=""> 570                  return ((Adjustment)input).getOffer();                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 571              }                                                                                                     </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 572          };                                                                                                        </span>
<span  style=""> 573                                                                                                                    </span>
<span class="-8370514600917699300" onmouseenter="enter('-8370514600917699300');" onmouseout="out('-8370514600917699300');" style=""> 574          result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));        </span>
<span  style=""> 575                                                                                                                    </span>
<span class="3897119298100986011" onmouseenter="enter('3897119298100986011');" onmouseout="out('3897119298100986011');" style=""> 576          if (order.getOrderItems() != null) {                                                                      </span>
<span class="820796442257070700" onmouseenter="enter('820796442257070700');" onmouseout="out('820796442257070700');" style=""> 577              for (OrderItem item : order.getOrderItems()) {                                                        </span>
<span class="722957474719034118" onmouseenter="enter('722957474719034118');" onmouseout="out('722957474719034118');" style=""><abbr title=" 578                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 578                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformerðŸ”µ</abbr></span>
<span  style=""> 579                                                                                                                    </span>
<span class="-3519908190158496681" onmouseenter="enter('-3519908190158496681');" onmouseout="out('-3519908190158496681');" style=""> 580                  //record usage for price details on the item as well                                              </span>
<span class="-2952948196187271811" onmouseenter="enter('-2952948196187271811');" onmouseout="out('-2952948196187271811');" style=""> 581                  if (item.getOrderItemPriceDetails() != null) {                                                    </span>
<span class="773323050474809935" onmouseenter="enter('773323050474809935');" onmouseout="out('773323050474809935');" style=""> 582                      for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {                         </span>
<span class="7134713472391876911" onmouseenter="enter('7134713472391876911');" onmouseout="out('7134713472391876911');" style=""><abbr title=" 583                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 583                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 584                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 585                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 586              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 587          }                                                                                                         </span>
<span  style=""> 588                                                                                                                    </span>
<span class="7944520279780748823" onmouseenter="enter('7944520279780748823');" onmouseout="out('7944520279780748823');" style=""> 589          if (order.getFulfillmentGroups() != null) {                                                               </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 590              for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                            </span>
<span class="-293187079687761920" onmouseenter="enter('-293187079687761920');" onmouseout="out('-293187079687761920');" style=""><abbr title=" 591                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 591                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransfðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 592              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 593          }                                                                                                         </span>
<span class="-6419540350677864751" onmouseenter="enter('-6419540350677864751');" onmouseout="out('-6419540350677864751');" style=""> 594          return result;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 595      }                                                                                                             </span>
<span  style=""> 596                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 597      @Override                                                                                                     </span>
<span class="-2491837224879773303" onmouseenter="enter('-2491837224879773303');" onmouseout="out('-2491837224879773303');" style=""> 598      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {                                      </span>
<span class="-1370687283458217641" onmouseenter="enter('-1370687283458217641');" onmouseout="out('-1370687283458217641');" style=""> 599          return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order));          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 600      }                                                                                                             </span>
<span  style=""> 601                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 602      @Override                                                                                                     </span>
<span class="-6407317956511861474" onmouseenter="enter('-6407317956511861474');" onmouseout="out('-6407317956511861474');" style=""> 603      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {   </span>
<span class="-4490485247927949218" onmouseenter="enter('-4490485247927949218');" onmouseout="out('-4490485247927949218');" style=""> 604          HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();                           </span>
<span class="983580358500385861" onmouseenter="enter('983580358500385861');" onmouseout="out('983580358500385861');" style=""> 605          for (OfferCode code : codes) {                                                                            </span>
<span class="6305098044991751707" onmouseenter="enter('6305098044991751707');" onmouseout="out('6305098044991751707');" style=""> 606              if (appliedOffers.contains(code.getOffer())) {                                                        </span>
<span class="3746501443462939384" onmouseenter="enter('3746501443462939384');" onmouseout="out('3746501443462939384');" style=""> 607                  offerToCodeMapping.put(code.getOffer(), code);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 608              }                                                                                                     </span>
<span  style=""> 609                                                                                                                    </span>
<span class="-240986298797431748" onmouseenter="enter('-240986298797431748');" onmouseout="out('-240986298797431748');" style=""> 610              List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();                                     </span>
<span  style=""> 611                                                                                                                    </span>
<span class="7454577566794152811" onmouseenter="enter('7454577566794152811');" onmouseout="out('7454577566794152811');" style=""> 612              extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);            </span>
<span class="-7985615425314556326" onmouseenter="enter('-7985615425314556326');" onmouseout="out('-7985615425314556326');" style=""> 613              for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {                                </span>
<span class="-808811284028256215" onmouseenter="enter('-808811284028256215');" onmouseout="out('-808811284028256215');" style=""> 614                  offerToCodeMapping.put(additionalOfferToBeApplied, code);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 615              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 616          }                                                                                                         </span>
<span class="7175253914401568841" onmouseenter="enter('7175253914401568841');" onmouseout="out('7175253914401568841');" style=""> 617          return offerToCodeMapping;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 618      }                                                                                                             </span>
<span  style=""> 619                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 620      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 621      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-1347767159915315738" onmouseenter="enter('-1347767159915315738');" onmouseout="out('-1347767159915315738');" style=""> 622      public Boolean deleteOfferCode(OfferCode code) {                                                              </span>
<span class="-5986603348121186173" onmouseenter="enter('-5986603348121186173');" onmouseout="out('-5986603348121186173');" style=""> 623          if (offerCodeDao.offerCodeIsUsed(code)) {                                                                 </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 624              return false;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 625          }                                                                                                         </span>
<span  style=""> 626                                                                                                                    </span>
<span class="-9122073777393685295" onmouseenter="enter('-9122073777393685295');" onmouseout="out('-9122073777393685295');" style=""> 627          offerCodeDao.delete(code);                                                                                </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 628          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 629      }                                                                                                             </span>
<span  style=""> 630                                                                                                                    </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 631      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 632      @Override                                                                                                     </span>
<span class="-3816301958562278169" onmouseenter="enter('-3816301958562278169');" onmouseout="out('-3816301958562278169');" style=""> 633      public Offer duplicate(Long originalOfferId) {                                                                </span>
<span class="-5738299300293223874" onmouseenter="enter('-5738299300293223874');" onmouseout="out('-5738299300293223874');" style=""> 634          Map&lt;String, String&gt; copyHints = new HashMap&lt;String, String&gt;();                                            </span>
<span class="2715783386963629594" onmouseenter="enter('2715783386963629594');" onmouseout="out('2715783386963629594');" style=""> 635          copyHints.put(OfferImpl.EXCLUDE_OFFERCODE_COPY_HINT, &quot;true&quot;);                                             </span>
<span class="-2013584672995219797" onmouseenter="enter('-2013584672995219797');" onmouseout="out('-2013584672995219797');" style=""> 636          return duplicator.copy(OfferImpl.class, originalOfferId, copyHints, offerDuplicateModifier);              </span>

<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 637      }                                                                                                             </span>
<span  style=""> 638                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 639      @Override                                                                                                     </span>
<span class="3228088005821970316" onmouseenter="enter('3228088005821970316');" onmouseout="out('3228088005821970316');" style=""> 640      public CustomerOfferDao getCustomerOfferDao() {                                                               </span>
<span class="-801333879424417122" onmouseenter="enter('-801333879424417122');" onmouseout="out('-801333879424417122');" style=""> 641          return customerOfferDao;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 642      }                                                                                                             </span>
<span  style=""> 643                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 644      @Override                                                                                                     </span>
<span class="6308179313298689001" onmouseenter="enter('6308179313298689001');" onmouseout="out('6308179313298689001');" style=""> 645      public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {                                          </span>
<span class="438520929977701037" onmouseenter="enter('438520929977701037');" onmouseout="out('438520929977701037');" style=""> 646          this.customerOfferDao = customerOfferDao;                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 647      }                                                                                                             </span>
<span  style=""> 648                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 649      @Override                                                                                                     </span>
<span class="8266606365944954497" onmouseenter="enter('8266606365944954497');" onmouseout="out('8266606365944954497');" style=""> 650      public OfferCodeDao getOfferCodeDao() {                                                                       </span>
<span class="-4005874311041664572" onmouseenter="enter('-4005874311041664572');" onmouseout="out('-4005874311041664572');" style=""> 651          return offerCodeDao;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 652      }                                                                                                             </span>
<span  style=""> 653                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 654      @Override                                                                                                     </span>
<span class="-5083072655758254890" onmouseenter="enter('-5083072655758254890');" onmouseout="out('-5083072655758254890');" style=""> 655      public void setOfferCodeDao(OfferCodeDao offerCodeDao) {                                                      </span>
<span class="-7060255547979502806" onmouseenter="enter('-7060255547979502806');" onmouseout="out('-7060255547979502806');" style=""> 656          this.offerCodeDao = offerCodeDao;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 657      }                                                                                                             </span>
<span  style=""> 658                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 659      @Override                                                                                                     </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 660      public OfferDao getOfferDao() {                                                                               </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 661          return offerDao;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 662      }                                                                                                             </span>
<span  style=""> 663                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 664      @Override                                                                                                     </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 665      public void setOfferDao(OfferDao offerDao) {                                                                  </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 666          this.offerDao = offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 667      }                                                                                                             </span>
<span  style=""> 668                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 669      @Override                                                                                                     </span>
<span class="3012408951835963759" onmouseenter="enter('3012408951835963759');" onmouseout="out('3012408951835963759');" style=""> 670      public OrderOfferProcessor getOrderOfferProcessor() {                                                         </span>
<span class="-5069105522766505260" onmouseenter="enter('-5069105522766505260');" onmouseout="out('-5069105522766505260');" style=""> 671          return orderOfferProcessor;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 672      }                                                                                                             </span>
<span  style=""> 673                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 674      @Override                                                                                                     </span>
<span class="-2542583147665382651" onmouseenter="enter('-2542583147665382651');" onmouseout="out('-2542583147665382651');" style=""> 675      public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {                                 </span>
<span class="1533378703496715943" onmouseenter="enter('1533378703496715943');" onmouseout="out('1533378703496715943');" style=""> 676          this.orderOfferProcessor = orderOfferProcessor;                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 677      }                                                                                                             </span>
<span  style=""> 678                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 679      @Override                                                                                                     </span>
<span class="1694843298235251985" onmouseenter="enter('1694843298235251985');" onmouseout="out('1694843298235251985');" style=""> 680      public ItemOfferProcessor getItemOfferProcessor() {                                                           </span>
<span class="1583504692330339191" onmouseenter="enter('1583504692330339191');" onmouseout="out('1583504692330339191');" style=""> 681          return itemOfferProcessor;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 682      }                                                                                                             </span>
<span  style=""> 683                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 684      @Override                                                                                                     </span>
<span class="145400756853488798" onmouseenter="enter('145400756853488798');" onmouseout="out('145400756853488798');" style=""> 685      public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {                                    </span>
<span class="-102405468021411755" onmouseenter="enter('-102405468021411755');" onmouseout="out('-102405468021411755');" style=""> 686          this.itemOfferProcessor = itemOfferProcessor;                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 687      }                                                                                                             </span>
<span  style=""> 688                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 689      @Override                                                                                                     </span>
<span class="3022939772369206873" onmouseenter="enter('3022939772369206873');" onmouseout="out('3022939772369206873');" style=""> 690      public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {                                   </span>
<span class="-3088775944214719317" onmouseenter="enter('-3088775944214719317');" onmouseout="out('-3088775944214719317');" style=""> 691          return fulfillmentGroupOfferProcessor;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 692      }                                                                                                             </span>
<span  style=""> 693                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 694      @Override                                                                                                     </span>
<span class="-8855456203149015957" onmouseenter="enter('-8855456203149015957');" onmouseout="out('-8855456203149015957');" style=""> 695      public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {</span>
<span class="-7108053920330155376" onmouseenter="enter('-7108053920330155376');" onmouseout="out('-7108053920330155376');" style=""> 696          this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 697      }                                                                                                             </span>
<span  style=""> 698                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 699      @Override                                                                                                     </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 700      public PromotableItemFactory getPromotableItemFactory() {                                                     </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 701          return promotableItemFactory;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 702      }                                                                                                             </span>
<span  style=""> 703                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 704      @Override                                                                                                     </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 705      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                           </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 706          this.promotableItemFactory = promotableItemFactory;                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 707      }                                                                                                             </span>
<span  style=""> 708                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 709      @Override                                                                                                     </span>
<span class="-285725005067991728" onmouseenter="enter('-285725005067991728');" onmouseout="out('-285725005067991728');" style=""> 710      public OfferCode findOfferCodeById(Long id) {                                                                 </span>
<span class="4928857363700364693" onmouseenter="enter('4928857363700364693');" onmouseout="out('4928857363700364693');" style=""> 711          return offerCodeDao.readOfferCodeById(id);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 712      }                                                                                                             </span>
<span  style=""> 713                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 714      @Override                                                                                                     </span>
<span class="-6829155498814719074" onmouseenter="enter('-6829155498814719074');" onmouseout="out('-6829155498814719074');" style=""> 715      public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {                                            </span>
<span class="-1521639274006709657" onmouseenter="enter('-1521639274006709657');" onmouseout="out('-1521639274006709657');" style=""> 716          return offerCodeDao.readOfferCodesByIds(ids);                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 717      }                                                                                                             </span>
<span  style=""> 718                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 719      @Override                                                                                                     </span>
<span class="5587340050529616033" onmouseenter="enter('5587340050529616033');" onmouseout="out('5587340050529616033');" style=""> 720      public OrderService getOrderService() {                                                                       </span>
<span class="-7558473787756148723" onmouseenter="enter('-7558473787756148723');" onmouseout="out('-7558473787756148723');" style=""> 721          return orderService;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 722      }                                                                                                             </span>
<span  style=""> 723                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 724      @Override                                                                                                     </span>
<span class="4536819371590947172" onmouseenter="enter('4536819371590947172');" onmouseout="out('4536819371590947172');" style=""> 725      public void setOrderService(OrderService orderService) {                                                      </span>
<span class="7368861914925934250" onmouseenter="enter('7368861914925934250');" onmouseout="out('7368861914925934250');" style=""> 726          this.orderService = orderService;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 727      }                                                                                                             </span>
<span  style=""> 728                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 729      @Override                                                                                                     </span>
<span class="-2217088353489190987" onmouseenter="enter('-2217088353489190987');" onmouseout="out('-2217088353489190987');" style=""> 730      public Offer findOfferById(Long offerId) {                                                                    </span>
<span class="-5171648678549667040" onmouseenter="enter('-5171648678549667040');" onmouseout="out('-5171648678549667040');" style=""> 731          return offerDao.readOfferById(offerId);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 732      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 733  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            