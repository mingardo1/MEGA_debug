<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>102</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    102
                    <a href="101.html">prev</a>
                    <a href="103.html">next</a>
                    <a href="102_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_72a9a4e9dfa438ca1540c22c9254af8e66507e49_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/service/ProductDuplicateModifier.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;72a9a4e9dfa438ca1540c22c9254af8e66507e49:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/service/ProductDuplicateModifier.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;72a9a4e9dfa438ca1540c22c9254af8e66507e49^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/service/ProductDuplicateModifier.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;72a9a4e9dfa438ca1540c22c9254af8e66507e49^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/service/ProductDuplicateModifier.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;71daf3b1e15a8ce4593b747732610cd22ec2371e:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/service/ProductDuplicateModifier.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj], [b], [j]], subset: [[sbj], [b], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2021 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.catalog.service;
  19 
  20 import lombok.SneakyThrows;
  21 import org.broadleafcommerce.common.copy.MultiTenantCloneable;
  22 import org.broadleafcommerce.common.copy.MultiTenantCopyContext;
  23 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  24 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  25 import org.broadleafcommerce.common.persistence.AbstractEntityDuplicationHelper;
  26 import org.broadleafcommerce.common.persistence.EntityDuplicatorExtensionManager;
  27 import org.broadleafcommerce.common.service.GenericEntityService;
  28 import org.broadleafcommerce.core.catalog.domain.Category;
  29 import org.broadleafcommerce.core.catalog.domain.CategoryImpl;
  30 import org.broadleafcommerce.core.catalog.domain.CategoryProductXref;
  31 import org.broadleafcommerce.core.catalog.domain.Product;
  32 import org.broadleafcommerce.core.catalog.domain.ProductImpl;
  33 import org.broadleafcommerce.core.catalog.domain.ProductOption;
  34 import org.broadleafcommerce.core.catalog.domain.ProductOptionImpl;
  35 import org.broadleafcommerce.core.catalog.domain.ProductOptionXref;
  36 import org.broadleafcommerce.core.catalog.service.extension.ProductUrlDuplicatorExtensionManager;
  37 import org.springframework.beans.factory.annotation.Autowired;
  38 import org.springframework.core.env.Environment;
  39 import org.springframework.stereotype.Component;
  40 
  41 import java.util.ArrayList;
  42 import java.util.Calendar;
  43 import java.util.List;
  44 import java.util.Map;
  45 
  46 import javax.annotation.Resource;
  47 
  48 import static org.broadleafcommerce.common.copy.MultiTenantCopyContext.PROPAGATION;
  49 
  50 @Component(&quot;blProductDuplicateModifier&quot;)
  51 public class ProductDuplicateModifier extends AbstractEntityDuplicationHelper&lt;Product&gt; {
  52 
  53     private static final String COPY_NUMBER_SEPARATOR = &quot;#&quot;;
  54 
  55     @Resource(name = &quot;blEntityDuplicatorExtensionManager&quot;)
  56     protected EntityDuplicatorExtensionManager extensionManager;
  57 
  58     @Resource(name = &quot;blGenericEntityService&quot;)
  59     protected GenericEntityService genericEntityService;
  60 
  61     @Resource(name = &quot;blProductUrlDuplicatorExtensionManager&quot;)
  62     protected ProductUrlDuplicatorExtensionManager productUrlDuplicatorExtensionManager;
  63 
  64     @Autowired
  65     public ProductDuplicateModifier(final Environment environment) {
  66 
  67         super(environment);
  68 
  69         addCopyHint(ProductImpl.EXCLUDE_PRODUCT_CODE_COPY_HINT, Boolean.TRUE.toString());
  70     }
  71 
  72     @Override
  73     public boolean canHandle(final MultiTenantCloneable candidate) {
  74         return Product.class.isAssignableFrom(candidate.getClass());
  75     }
  76 
  77     @Override
<abbr title="  78     public void modifyInitialDuplicateState(final Product original, final Product copy, final MultiTenantCopyContext context) throws CloneNotSupportedException {">  78     public void modifyInitialDuplicateState(final Product original, final Product copy, final MultiTenantðŸ”µ</abbr>
<abbr title="  79         if(context.getCopyHints().get(PROPAGATION)!=null &amp;&amp; &quot;TRUE&quot;.equalsIgnoreCase(context.getCopyHints().get(PROPAGATION))){">  79         if(context.getCopyHints().get(PROPAGATION)!=null &amp;&amp; &quot;TRUE&quot;.equalsIgnoreCase(context.getCopyHints(ðŸ”µ</abbr>
  80             for (CategoryProductXref allParentCategoryXref : original.getAllParentCategoryXrefs()) {
<abbr title="  81                 final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(context).getClone();">  81                 final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(contðŸ”µ</abbr>
  82                 clone.setProduct(copy);
<abbr title="  83                 ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();">  83                 ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHoldeðŸ”µ</abbr>
  84                 Long categoryId = clone.getCategory().getId();
  85                 extensionManager.getClonesByCatalogs(&quot;BLC_CATEGORY&quot;, categoryId, context, resultHolder);
<abbr title="  86                 Long aLong = resultHolder.getResult().get(categoryId).get(context.getToCatalog().getId());">  86                 Long aLong = resultHolder.getResult().get(categoryId).get(context.getToCatalog().getId())ðŸ”µ</abbr>
<abbr title="  87                 Category category = (Category) genericEntityService.readGenericEntity(genericEntityService.getCeilingImplClass(CategoryImpl.class.getName()), aLong);">  87                 Category category = (Category) genericEntityService.readGenericEntity(genericEntityServicðŸ”µ</abbr>
  88                 clone.setCategory(category);
  89                 copy.getAllParentCategoryXrefs().add(clone);
  90             }
  91             List&lt;ProductOptionXref&gt; productOptionXrefs = new ArrayList&lt;&gt;();
  92             for (ProductOptionXref productOptionXref : original.getProductOptionXrefs()) {
<abbr title="  93                 final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).getClone();">  93                 final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).gðŸ”µ</abbr>
<abbr title="  94                 ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();">  94                 ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHoldeðŸ”µ</abbr>
  95                 Long optionId = clone.getProductOption().getId();
<abbr title="  96                 extensionManager.getClonesByCatalogs(&quot;BLC_PRODUCT_OPTION&quot;, optionId, context, resultHolder);">  96                 extensionManager.getClonesByCatalogs(&quot;BLC_PRODUCT_OPTION&quot;, optionId, context, resultHoldeðŸ”µ</abbr>
  97                 Long aLong = resultHolder.getResult().get(optionId).get(context.getToCatalog().getId());
<abbr title="  98                 ProductOption productOption = (ProductOption) genericEntityService.readGenericEntity(genericEntityService.getCeilingImplClass(ProductOptionImpl.class.getName()), aLong);">  98                 ProductOption productOption = (ProductOption) genericEntityService.readGenericEntity(geneðŸ”µ</abbr>
  99                 clone.setProductOption(productOption);
 100                 clone.setProduct(copy);
 101                 productOptionXrefs.add(clone);
 102             }
 103             copy.setProductOptionXrefs(productOptionXrefs);
 104 
 105         }else {
 106             if(!context.getToCatalog().getId().equals(context.getFromCatalog().getId())){
 107                 copy.setAllParentCategoryXrefs(new ArrayList&lt;&gt;());
 108                 copy.setProductOptionXrefs(new ArrayList&lt;&gt;());
 109             }else {
 110                 for (CategoryProductXref allParentCategoryXref : original.getAllParentCategoryXrefs()) {
<abbr title=" 111                     final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(context).getClone();"> 111                     final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(ðŸ”µ</abbr>
 112                     clone.setProduct(copy);
 113                     copy.getAllParentCategoryXrefs().add(clone);
 114                 }
 115                 List&lt;ProductOptionXref&gt; productOptionXrefs = new ArrayList&lt;&gt;();
 116                 for (ProductOptionXref productOptionXref : original.getProductOptionXrefs()) {
<abbr title=" 117                     final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).getClone();"> 117                     final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(contexðŸ”µ</abbr>
 118                     clone.setProduct(copy);
 119                     productOptionXrefs.add(clone);
 120                 }
 121                 copy.setProductOptionXrefs(productOptionXrefs);
 122             }
 123         }
 124 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125         Calendar instance = Calendar.getInstance();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126         instance.add(Calendar.YEAR, 1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127         instance.set(Calendar.MILLISECOND, 0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128         instance.set(Calendar.SECOND, 0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129         instance.set(Calendar.MINUTE, 0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         instance.set(Calendar.HOUR, 0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         copy.setActiveStartDate(instance.getTime());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132         copy.setActiveEndDate(null);</span>
 133 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         Calendar instance = Calendar.getInstance();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135         instance.add(Calendar.YEAR, 1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136         copy.setActiveStartDate(instance.getTime());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         copy.setActiveEndDate(null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139         setNameAndUrl(copy);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143     private void setNameAndUrl(Product copy) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         String suffix = getCopySuffix();</span>
 145 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146         final Date currentDate = new Date();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147         copy.setActiveStartDate(currentDate);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148         copy.setActiveEndDate(currentDate);</span>
 149 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 150 
 151         setNameAndUrl(copy, context);
 152 
 153     }
 154 
 155 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156     protected void setNameAndUrl(Product copy, MultiTenantCopyContext context) {</span>
 157 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159     private void setNameAndUrl(Product copy) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160         String suffix = getCopySuffix();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161         String name = copy.getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163         if (name.contains(suffix)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164             if (name.contains(COPY_NUMBER_SEPARATOR)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165                 final String copyNumber = name.split(suffix)[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 166                 suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1]) + 1);"> 166                 suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1]) +ðŸ”µ</abbr></span>
 167 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168     protected void setNameAndUrl(Product copy) {</span>
 169 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 170         String suffix = getCopySuffix();
 171         String name = copy.getName();
 172         if(!context.getCopyHints().containsKey(&quot;PROPAGATION&quot;)) {
 173             int index = 0;
 174             if (name.contains(suffix)) {
 175                 index = name.indexOf(COPY_NUMBER_SEPARATOR);
 176                 if (index &gt; 0) {
 177                     final String copyNumber = name.split(suffix)[1];
<abbr title=" 178                     suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1]) + 1);"> 178                     suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1ðŸ”µ</abbr>
 179                 } else {
 180                     suffix = COPY_NUMBER_SEPARATOR + 1;
 181                 }
 182                 if(index&gt;0) {
 183                     name = name.substring(0, index+1) + suffix;
 184                 }else{
 185                     name = name + suffix;
 186                 }
 187             } else {
 188                 name = name + suffix;
 189             }
 190         }
 191         copy.setName(name);
<abbr title=" 192         String url = &quot;/&quot; + copy.getName().replace(&quot;-&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;-&quot;).replace(&quot;#&quot;,&quot;_&quot;).toLowerCase();"> 192         String url = &quot;/&quot; + copy.getName().replace(&quot;-&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;-&quot;).replace(&quot;#&quot;,&quot;_&quot;).toLowerCaseðŸ”µ</abbr>
<abbr title=" 193         ExtensionResultStatusType extensionResultStatusType = productUrlDuplicatorExtensionManager.getProxy().modifyUrl(url, copy, new ExtensionResultHolder&lt;&gt;());"> 193         ExtensionResultStatusType extensionResultStatusType = productUrlDuplicatorExtensionManager.getProðŸ”µ</abbr>
 194         if(extensionResultStatusType == ExtensionResultStatusType.NOT_HANDLED) {
 195             copy.setUrl(url);
 196         }
 197     }
 198 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2021 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.catalog.service;
  19 
  20 import lombok.SneakyThrows;
  21 import org.broadleafcommerce.common.copy.MultiTenantCloneable;
  22 import org.broadleafcommerce.common.copy.MultiTenantCopyContext;
  23 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  24 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  25 import org.broadleafcommerce.common.persistence.AbstractEntityDuplicationHelper;
  26 import org.broadleafcommerce.common.persistence.EntityDuplicatorExtensionManager;
  27 import org.broadleafcommerce.common.service.GenericEntityService;
  28 import org.broadleafcommerce.core.catalog.domain.Category;
  29 import org.broadleafcommerce.core.catalog.domain.CategoryImpl;
  30 import org.broadleafcommerce.core.catalog.domain.CategoryProductXref;
  31 import org.broadleafcommerce.core.catalog.domain.Product;
  32 import org.broadleafcommerce.core.catalog.domain.ProductImpl;
  33 import org.broadleafcommerce.core.catalog.domain.ProductOption;
  34 import org.broadleafcommerce.core.catalog.domain.ProductOptionImpl;
  35 import org.broadleafcommerce.core.catalog.domain.ProductOptionXref;
  36 import org.broadleafcommerce.core.catalog.service.extension.ProductUrlDuplicatorExtensionManager;
  37 import org.springframework.beans.factory.annotation.Autowired;
  38 import org.springframework.core.env.Environment;
  39 import org.springframework.stereotype.Component;
  40 
  41 import java.util.ArrayList;
  42 import java.util.Calendar;
  43 import java.util.List;
  44 import java.util.Map;
  45 
  46 import javax.annotation.Resource;
  47 
  48 import static org.broadleafcommerce.common.copy.MultiTenantCopyContext.PROPAGATION;
  49 
  50 @Component(&quot;blProductDuplicateModifier&quot;)
  51 public class ProductDuplicateModifier extends AbstractEntityDuplicationHelper&lt;Product&gt; {
  52 
  53     private static final String COPY_NUMBER_SEPARATOR = &quot;#&quot;;
  54 
  55     @Resource(name = &quot;blEntityDuplicatorExtensionManager&quot;)
  56     protected EntityDuplicatorExtensionManager extensionManager;
  57 
  58     @Resource(name = &quot;blGenericEntityService&quot;)
  59     protected GenericEntityService genericEntityService;
  60 
  61     @Resource(name = &quot;blProductUrlDuplicatorExtensionManager&quot;)
  62     protected ProductUrlDuplicatorExtensionManager productUrlDuplicatorExtensionManager;
  63 
  64     @Autowired
  65     public ProductDuplicateModifier(final Environment environment) {
  66 
  67         super(environment);
  68 
  69         addCopyHint(ProductImpl.EXCLUDE_PRODUCT_CODE_COPY_HINT, Boolean.TRUE.toString());
  70     }
  71 
  72     @Override
  73     public boolean canHandle(final MultiTenantCloneable candidate) {
  74         return Product.class.isAssignableFrom(candidate.getClass());
  75     }
  76 
  77         @Override
<abbr title="  78     public void modifyInitialDuplicateState(final Product original, final Product copy, final MultiTenantCopyContext context) throws CloneNotSupportedException {">  78     public void modifyInitialDuplicateState(final Product original, final Product copy, final MultiTenantðŸ”µ</abbr>
<abbr title="  79         if(context.getCopyHints().get(PROPAGATION)!=null &amp;&amp; &quot;TRUE&quot;.equalsIgnoreCase(context.getCopyHints().get(PROPAGATION))){">  79         if(context.getCopyHints().get(PROPAGATION)!=null &amp;&amp; &quot;TRUE&quot;.equalsIgnoreCase(context.getCopyHints(ðŸ”µ</abbr>
  80             for (CategoryProductXref allParentCategoryXref : original.getAllParentCategoryXrefs()) {
<abbr title="  81                 final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(context).getClone();">  81                 final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(contðŸ”µ</abbr>
  82                 clone.setProduct(copy);
<abbr title="  83                 ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();">  83                 ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHoldeðŸ”µ</abbr>
  84                 Long categoryId = clone.getCategory().getId();
  85                 extensionManager.getClonesByCatalogs(&quot;BLC_CATEGORY&quot;, categoryId, context, resultHolder);
<abbr title="  86                 Long aLong = resultHolder.getResult().get(categoryId).get(context.getToCatalog().getId());">  86                 Long aLong = resultHolder.getResult().get(categoryId).get(context.getToCatalog().getId())ðŸ”µ</abbr>
<abbr title="  87                 Category category = (Category) genericEntityService.readGenericEntity(genericEntityService.getCeilingImplClass(CategoryImpl.class.getName()), aLong);">  87                 Category category = (Category) genericEntityService.readGenericEntity(genericEntityServicðŸ”µ</abbr>
  88                 clone.setCategory(category);
  89                 copy.getAllParentCategoryXrefs().add(clone);
  90             }
  91             List&lt;ProductOptionXref&gt; productOptionXrefs = new ArrayList&lt;&gt;();
  92             for (ProductOptionXref productOptionXref : original.getProductOptionXrefs()) {
<abbr title="  93                 final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).getClone();">  93                 final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).gðŸ”µ</abbr>
<abbr title="  94                 ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();">  94                 ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHoldeðŸ”µ</abbr>
  95                 Long optionId = clone.getProductOption().getId();
<abbr title="  96                 extensionManager.getClonesByCatalogs(&quot;BLC_PRODUCT_OPTION&quot;, optionId, context, resultHolder);">  96                 extensionManager.getClonesByCatalogs(&quot;BLC_PRODUCT_OPTION&quot;, optionId, context, resultHoldeðŸ”µ</abbr>
  97                 Long aLong = resultHolder.getResult().get(optionId).get(context.getToCatalog().getId());
<abbr title="  98                 ProductOption productOption = (ProductOption) genericEntityService.readGenericEntity(genericEntityService.getCeilingImplClass(ProductOptionImpl.class.getName()), aLong);">  98                 ProductOption productOption = (ProductOption) genericEntityService.readGenericEntity(geneðŸ”µ</abbr>
  99                 clone.setProductOption(productOption);
 100                 clone.setProduct(copy);
 101                 productOptionXrefs.add(clone);
 102             }
 103             copy.setProductOptionXrefs(productOptionXrefs);
 104 
 105         }else {
 106             if(!context.getToCatalog().getId().equals(context.getFromCatalog().getId())){
 107                 copy.setAllParentCategoryXrefs(new ArrayList&lt;&gt;());
 108                 copy.setProductOptionXrefs(new ArrayList&lt;&gt;());
 109             }else {
 110                 for (CategoryProductXref allParentCategoryXref : original.getAllParentCategoryXrefs()) {
<abbr title=" 111                     final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(context).getClone();"> 111                     final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(ðŸ”µ</abbr>
 112                     clone.setProduct(copy);
 113                     copy.getAllParentCategoryXrefs().add(clone);
 114                 }
 115                 List&lt;ProductOptionXref&gt; productOptionXrefs = new ArrayList&lt;&gt;();
 116                 for (ProductOptionXref productOptionXref : original.getProductOptionXrefs()) {
<abbr title=" 117                     final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).getClone();"> 117                     final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(contexðŸ”µ</abbr>
 118                     clone.setProduct(copy);
 119                     productOptionXrefs.add(clone);
 120                 }
 121                 copy.setProductOptionXrefs(productOptionXrefs);
 122             }
 123         }
 124 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125         Calendar instance = Calendar.getInstance();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126         instance.add(Calendar.YEAR, 1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127         instance.set(Calendar.MILLISECOND, 0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128         instance.set(Calendar.SECOND, 0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129         instance.set(Calendar.MINUTE, 0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         instance.set(Calendar.HOUR, 0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         copy.setActiveStartDate(instance.getTime());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132         copy.setActiveEndDate(null);</span>
 133 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135         Calendar instance = Calendar.getInstance();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136         instance.add(Calendar.YEAR, 1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         copy.setActiveStartDate(instance.getTime());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         copy.setActiveEndDate(null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         setNameAndUrl(copy);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141 </span>
 142 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143         final Date currentDate = new Date();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144         copy.setActiveStartDate(currentDate);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145         copy.setActiveEndDate(currentDate);</span>
 146 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 147 
 148         setNameAndUrl(copy, context);
 149 
 150     }
 151 
 152     protected void setNameAndUrl(Product copy, MultiTenantCopyContext context) {
 153         String suffix = getCopySuffix();
 154         String name = copy.getName();
 155         if(!context.getCopyHints().containsKey(&quot;PROPAGATION&quot;)) {
 156             int index = 0;
 157             if (name.contains(suffix)) {
 158                 index = name.indexOf(COPY_NUMBER_SEPARATOR);
 159                 if (index &gt; 0) {
 160                     final String copyNumber = name.split(suffix)[1];
<abbr title=" 161                     suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1]) + 1);"> 161                     suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1ðŸ”µ</abbr>
 162                 } else {
 163                     suffix = COPY_NUMBER_SEPARATOR + 1;
 164                 }
 165                 if(index&gt;0) {
 166                     name = name.substring(0, index+1) + suffix;
 167                 }else{
 168                     name = name + suffix;
 169                 }
 170             } else {
 171                 name = name + suffix;
 172             }
 173         }
 174         copy.setName(name);
<abbr title=" 175         String url = &quot;/&quot; + copy.getName().replace(&quot;-&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;-&quot;).replace(&quot;#&quot;,&quot;_&quot;).toLowerCase();"> 175         String url = &quot;/&quot; + copy.getName().replace(&quot;-&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;-&quot;).replace(&quot;#&quot;,&quot;_&quot;).toLowerCaseðŸ”µ</abbr>
<abbr title=" 176         ExtensionResultStatusType extensionResultStatusType = productUrlDuplicatorExtensionManager.getProxy().modifyUrl(url, copy, new ExtensionResultHolder&lt;&gt;());"> 176         ExtensionResultStatusType extensionResultStatusType = productUrlDuplicatorExtensionManager.getProðŸ”µ</abbr>
 177         if(extensionResultStatusType == ExtensionResultStatusType.NOT_HANDLED) {
 178             copy.setUrl(url);
 179         }
 180     }
 181 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 182 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183 private void setNameAndUrl(Product copy) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184         String suffix = getCopySuffix();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185         String name = copy.getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         if (name.contains(suffix)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188             if (name.contains(COPY_NUMBER_SEPARATOR)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                 final String copyNumber = name.split(suffix)[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 190                 suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1]) + 1);"> 190                 suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1]) +ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                 suffix = COPY_NUMBER_SEPARATOR + 1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194             name = name.substring(0, name.length() - 1) + suffix;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196             name = name + suffix;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         copy.setName(name);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199         copy.setUrl(&quot;/&quot; + copy.getName().replace(&quot;-&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;-&quot;).toLowerCase());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200     }</span>
 201 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202 protected void setNameAndUrl(Product copy) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203         String suffix = getCopySuffix();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204         String name = copy.getName();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206         if (name.contains(suffix)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207             if (name.contains(COPY_NUMBER_SEPARATOR)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208                 final String copyNumber = name.split(suffix)[1];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 209                 suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1]) + 1);"> 209                 suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1]) +ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211                 suffix = COPY_NUMBER_SEPARATOR + 1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213             name = name.substring(0, name.length() - 1) + suffix;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215             name = name + suffix;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217         copy.setName(name);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218         copy.setUrl(&quot;/&quot; + copy.getName().replace(&quot;-&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;-&quot;).toLowerCase());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219     }</span>
 220 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 221 
 222 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2021 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.catalog.service;
  19 
  20 import java.util.ArrayList;
  21 import java.util.Calendar;
  22 import java.util.List;
  23 import java.util.Map;
  24 import javax.annotation.Resource;
  25 import lombok.SneakyThrows;
  26 import org.broadleafcommerce.common.copy.MultiTenantCloneable;
  27 import org.broadleafcommerce.common.copy.MultiTenantCopyContext;
  28 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  29 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  30 import org.broadleafcommerce.common.persistence.AbstractEntityDuplicationHelper;
  31 import org.broadleafcommerce.common.persistence.EntityDuplicatorExtensionManager;
  32 import org.broadleafcommerce.common.service.GenericEntityService;
  33 import org.broadleafcommerce.core.catalog.domain.Category;
  34 import org.broadleafcommerce.core.catalog.domain.CategoryImpl;
  35 import org.broadleafcommerce.core.catalog.domain.CategoryProductXref;
  36 import org.broadleafcommerce.core.catalog.domain.Product;
  37 import org.broadleafcommerce.core.catalog.domain.ProductImpl;
  38 import org.broadleafcommerce.core.catalog.domain.ProductOption;
  39 import org.broadleafcommerce.core.catalog.domain.ProductOptionImpl;
  40 import org.broadleafcommerce.core.catalog.domain.ProductOptionXref;
  41 import org.broadleafcommerce.core.catalog.service.extension.ProductUrlDuplicatorExtensionManager;
  42 import org.springframework.beans.factory.annotation.Autowired;
  43 import org.springframework.core.env.Environment;
  44 import org.springframework.stereotype.Component;
  45 import static org.broadleafcommerce.common.copy.MultiTenantCopyContext.PROPAGATION;
  46 
  47 
  48 @Component(&quot;blProductDuplicateModifier&quot;)
  49 public class ProductDuplicateModifier extends AbstractEntityDuplicationHelper&lt;Product&gt; {
  50     @Override
<abbr title="  51     public void modifyInitialDuplicateState(final Product original, final Product copy, final MultiTenantCopyContext context) throws CloneNotSupportedException {">  51     public void modifyInitialDuplicateState(final Product original, final Product copy, final MultiTenantðŸ”µ</abbr>
<abbr title="  52         if(context.getCopyHints().get(PROPAGATION)!=null &amp;&amp; &quot;TRUE&quot;.equalsIgnoreCase(context.getCopyHints().get(PROPAGATION))){">  52         if(context.getCopyHints().get(PROPAGATION)!=null &amp;&amp; &quot;TRUE&quot;.equalsIgnoreCase(context.getCopyHints(ðŸ”µ</abbr>
  53             for (CategoryProductXref allParentCategoryXref : original.getAllParentCategoryXrefs()) {
<abbr title="  54                 final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(context).getClone();">  54                 final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(contðŸ”µ</abbr>
  55                 clone.setProduct(copy);
<abbr title="  56                 ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();">  56                 ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHoldeðŸ”µ</abbr>
  57                 Long categoryId = clone.getCategory().getId();
  58                 extensionManager.getClonesByCatalogs(&quot;BLC_CATEGORY&quot;, categoryId, context, resultHolder);
<abbr title="  59                 Long aLong = resultHolder.getResult().get(categoryId).get(context.getToCatalog().getId());">  59                 Long aLong = resultHolder.getResult().get(categoryId).get(context.getToCatalog().getId())ðŸ”µ</abbr>
<abbr title="  60                 Category category = (Category) genericEntityService.readGenericEntity(genericEntityService.getCeilingImplClass(CategoryImpl.class.getName()), aLong);">  60                 Category category = (Category) genericEntityService.readGenericEntity(genericEntityServicðŸ”µ</abbr>
  61                 clone.setCategory(category);
  62                 copy.getAllParentCategoryXrefs().add(clone);
  63             }
  64             List&lt;ProductOptionXref&gt; productOptionXrefs = new ArrayList&lt;&gt;();
  65             for (ProductOptionXref productOptionXref : original.getProductOptionXrefs()) {
<abbr title="  66                 final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).getClone();">  66                 final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).gðŸ”µ</abbr>
<abbr title="  67                 ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();">  67                 ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHoldeðŸ”µ</abbr>
  68                 Long optionId = clone.getProductOption().getId();
<abbr title="  69                 extensionManager.getClonesByCatalogs(&quot;BLC_PRODUCT_OPTION&quot;, optionId, context, resultHolder);">  69                 extensionManager.getClonesByCatalogs(&quot;BLC_PRODUCT_OPTION&quot;, optionId, context, resultHoldeðŸ”µ</abbr>
  70                 Long aLong = resultHolder.getResult().get(optionId).get(context.getToCatalog().getId());
<abbr title="  71                 ProductOption productOption = (ProductOption) genericEntityService.readGenericEntity(genericEntityService.getCeilingImplClass(ProductOptionImpl.class.getName()), aLong);">  71                 ProductOption productOption = (ProductOption) genericEntityService.readGenericEntity(geneðŸ”µ</abbr>
  72                 clone.setProductOption(productOption);
  73                 clone.setProduct(copy);
  74                 productOptionXrefs.add(clone);
  75             }
  76             copy.setProductOptionXrefs(productOptionXrefs);
  77 
  78         }else {
  79             if(!context.getToCatalog().getId().equals(context.getFromCatalog().getId())){
  80                 copy.setAllParentCategoryXrefs(new ArrayList&lt;&gt;());
  81                 copy.setProductOptionXrefs(new ArrayList&lt;&gt;());
  82             }else {
  83                 for (CategoryProductXref allParentCategoryXref : original.getAllParentCategoryXrefs()) {
<abbr title="  84                     final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(context).getClone();">  84                     final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(ðŸ”µ</abbr>
  85                     clone.setProduct(copy);
  86                     copy.getAllParentCategoryXrefs().add(clone);
  87                 }
  88                 List&lt;ProductOptionXref&gt; productOptionXrefs = new ArrayList&lt;&gt;();
  89                 for (ProductOptionXref productOptionXref : original.getProductOptionXrefs()) {
<abbr title="  90                     final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).getClone();">  90                     final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(contexðŸ”µ</abbr>
  91                     clone.setProduct(copy);
  92                     productOptionXrefs.add(clone);
  93                 }
  94                 copy.setProductOptionXrefs(productOptionXrefs);
  95             }
  96         }
  97 
  98 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99         Calendar instance = Calendar.getInstance();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100         instance.add(Calendar.YEAR, 1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101         instance.set(Calendar.MILLISECOND, 0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         instance.set(Calendar.SECOND, 0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         instance.set(Calendar.MINUTE, 0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         instance.set(Calendar.HOUR, 0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105         copy.setActiveStartDate(instance.getTime());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106         copy.setActiveEndDate(null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107 </span>
 108 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 109 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 109 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 110 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112         final Date currentDate = new Date();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113         copy.setActiveStartDate(currentDate);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114         copy.setActiveEndDate(currentDate);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115 </span>
 116 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 117 
 118         setNameAndUrl(copy, context);
 119 
 120     }
 121 
 122     private static final String COPY_NUMBER_SEPARATOR = &quot;#&quot;;
 123 
 124     @Resource(name = &quot;blEntityDuplicatorExtensionManager&quot;)
 125     protected EntityDuplicatorExtensionManager extensionManager;
 126 
 127     @Resource(name = &quot;blGenericEntityService&quot;)
 128     protected GenericEntityService genericEntityService;
 129 
 130     @Resource(name = &quot;blProductUrlDuplicatorExtensionManager&quot;)
 131     protected ProductUrlDuplicatorExtensionManager productUrlDuplicatorExtensionManager;
 132 
 133     @Autowired
 134     public ProductDuplicateModifier(final Environment environment) {
 135         super(environment);
 136         addCopyHint(ProductImpl.EXCLUDE_PRODUCT_CODE_COPY_HINT, Boolean.TRUE.toString());
 137     }
 138 
 139     @Override
 140     public boolean canHandle(final MultiTenantCloneable candidate) {
 141         return Product.class.isAssignableFrom(candidate.getClass());
 142     }
 143 
 144     protected void setNameAndUrl(Product copy, MultiTenantCopyContext context) {
 145         String suffix = getCopySuffix();
 146         String name = copy.getName();
 147         if (!context.getCopyHints().containsKey(&quot;PROPAGATION&quot;)) {
 148             int index = 0;
 149             if (name.contains(suffix)) {
 150                 index = name.indexOf(COPY_NUMBER_SEPARATOR);
 151                 if (index &gt; 0) {
 152                     final String copyNumber = name.split(suffix)[1];
<abbr title=" 153                     suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1]) + 1);"> 153                     suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1ðŸ”µ</abbr>
 154                 } else {
 155                     suffix = COPY_NUMBER_SEPARATOR + 1;
 156                 }
 157                 if (index &gt; 0) {
 158                     name = name.substring(0, index + 1) + suffix;
 159                 } else {
 160                     name = name + suffix;
 161                 }
 162             } else {
 163                 name = name + suffix;
 164             }
 165         }
 166         copy.setName(name);
<abbr title=" 167         String url = &quot;/&quot; + copy.getName().replace(&quot;-&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;-&quot;).replace(&quot;#&quot;, &quot;_&quot;).toLowerCase();"> 167         String url = &quot;/&quot; + copy.getName().replace(&quot;-&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;-&quot;).replace(&quot;#&quot;, &quot;_&quot;).toLowerCasðŸ”µ</abbr>
<abbr title=" 168         ExtensionResultStatusType extensionResultStatusType = productUrlDuplicatorExtensionManager.getProxy().modifyUrl(url, copy, new ExtensionResultHolder&lt;&gt;());"> 168         ExtensionResultStatusType extensionResultStatusType = productUrlDuplicatorExtensionManager.getProðŸ”µ</abbr>
 169         if (extensionResultStatusType == ExtensionResultStatusType.NOT_HANDLED) {
 170             copy.setUrl(url);
 171         }
 172     }
 173 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2021 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.catalog.service;
  19  
  20  import lombok.SneakyThrows;
  21  import org.broadleafcommerce.common.copy.MultiTenantCloneable;
  22  import org.broadleafcommerce.common.copy.MultiTenantCopyContext;
  23  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import org.broadleafcommerce.common.extension.ExtensionResultStatusType;</span>
  25  import org.broadleafcommerce.common.persistence.AbstractEntityDuplicationHelper;
  26  import org.broadleafcommerce.common.persistence.EntityDuplicatorExtensionManager;
  27  import org.broadleafcommerce.common.service.GenericEntityService;
  28  import org.broadleafcommerce.core.catalog.domain.Category;
  29  import org.broadleafcommerce.core.catalog.domain.CategoryImpl;
  30  import org.broadleafcommerce.core.catalog.domain.CategoryProductXref;
  31  import org.broadleafcommerce.core.catalog.domain.Product;
  32  import org.broadleafcommerce.core.catalog.domain.ProductImpl;
  33  import org.broadleafcommerce.core.catalog.domain.ProductOption;
  34  import org.broadleafcommerce.core.catalog.domain.ProductOptionImpl;
  35  import org.broadleafcommerce.core.catalog.domain.ProductOptionXref;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import org.broadleafcommerce.core.catalog.service.extension.ProductUrlDuplicatorExtensionManager;</span>
  37  import org.springframework.beans.factory.annotation.Autowired;
  38  import org.springframework.core.env.Environment;
  39  import org.springframework.stereotype.Component;
  40  
  41  import java.util.ArrayList;
  42  import java.util.Calendar;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import java.util.Date;</span>
  44  import java.util.List;
  45  import java.util.Map;
  46  
  47  import javax.annotation.Resource;
  48  
  49  import static org.broadleafcommerce.common.copy.MultiTenantCopyContext.PROPAGATION;
  50  
  51  @Component(&quot;blProductDuplicateModifier&quot;)
  52  public class ProductDuplicateModifier extends AbstractEntityDuplicationHelper&lt;Product&gt; {
  53  
  54      private static final String COPY_NUMBER_SEPARATOR = &quot;#&quot;;
  55  
  56      @Resource(name = &quot;blEntityDuplicatorExtensionManager&quot;)
  57      protected EntityDuplicatorExtensionManager extensionManager;
  58  
  59      @Resource(name = &quot;blGenericEntityService&quot;)
  60      protected GenericEntityService genericEntityService;
  61  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +    @Resource(name = &quot;blProductUrlDuplicatorExtensionManager&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +    protected ProductUrlDuplicatorExtensionManager productUrlDuplicatorExtensionManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +</span>
  65      @Autowired
  66      public ProductDuplicateModifier(final Environment environment) {
  67  
  68          super(environment);
  69  
  70          addCopyHint(ProductImpl.EXCLUDE_PRODUCT_CODE_COPY_HINT, Boolean.TRUE.toString());
  71      }
  72  
  73      @Override
  74      public boolean canHandle(final MultiTenantCloneable candidate) {
  75          return Product.class.isAssignableFrom(candidate.getClass());
  76      }
  77  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -    @SneakyThrows</span>
  79      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  80 -    public void modifyInitialDuplicateState(final Product original, final Product copy, final MultiTenantCopyContext context) {">  80 -    public void modifyInitialDuplicateState(final Product original, final Product copy, final MultiTenantCopyConteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  81 +    public void modifyInitialDuplicateState(final Product original, final Product copy, final MultiTenantCopyContext context) throws CloneNotSupportedException {">  81 +    public void modifyInitialDuplicateState(final Product original, final Product copy, final MultiTenantCopyConteðŸ”µ</abbr></span>
<abbr title="  82          if(context.getCopyHints().get(PROPAGATION)!=null &amp;&amp; &quot;TRUE&quot;.equalsIgnoreCase(context.getCopyHints().get(PROPAGATION))){">  82          if(context.getCopyHints().get(PROPAGATION)!=null &amp;&amp; &quot;TRUE&quot;.equalsIgnoreCase(context.getCopyHints().get(PROðŸ”µ</abbr>
  83              for (CategoryProductXref allParentCategoryXref : original.getAllParentCategoryXrefs()) {
<abbr title="  84                  final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(context).getClone();">  84                  final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(context).getCðŸ”µ</abbr>
  85                  clone.setProduct(copy);
  86                  ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
  87                  Long categoryId = clone.getCategory().getId();
  88                  extensionManager.getClonesByCatalogs(&quot;BLC_CATEGORY&quot;, categoryId, context, resultHolder);
  89                  Long aLong = resultHolder.getResult().get(categoryId).get(context.getToCatalog().getId());
<abbr title="  90                  Category category = (Category) genericEntityService.readGenericEntity(genericEntityService.getCeilingImplClass(CategoryImpl.class.getName()), aLong);">  90                  Category category = (Category) genericEntityService.readGenericEntity(genericEntityService.getCeilðŸ”µ</abbr>
  91                  clone.setCategory(category);
  92                  copy.getAllParentCategoryXrefs().add(clone);
  93              }
  94              List&lt;ProductOptionXref&gt; productOptionXrefs = new ArrayList&lt;&gt;();
  95              for (ProductOptionXref productOptionXref : original.getProductOptionXrefs()) {
<abbr title="  96                  final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).getClone();">  96                  final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).getClone()ðŸ”µ</abbr>
  97                  ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
  98                  Long optionId = clone.getProductOption().getId();
  99                  extensionManager.getClonesByCatalogs(&quot;BLC_PRODUCT_OPTION&quot;, optionId, context, resultHolder);
 100                  Long aLong = resultHolder.getResult().get(optionId).get(context.getToCatalog().getId());
<abbr title=" 101                  ProductOption productOption = (ProductOption) genericEntityService.readGenericEntity(genericEntityService.getCeilingImplClass(ProductOptionImpl.class.getName()), aLong);"> 101                  ProductOption productOption = (ProductOption) genericEntityService.readGenericEntity(genericEntityðŸ”µ</abbr>
 102                  clone.setProductOption(productOption);
 103                  clone.setProduct(copy);
 104                  productOptionXrefs.add(clone);
 105              }
 106              copy.setProductOptionXrefs(productOptionXrefs);
 107  
 108          }else {
 109              if(!context.getToCatalog().getId().equals(context.getFromCatalog().getId())){
 110                  copy.setAllParentCategoryXrefs(new ArrayList&lt;&gt;());
 111                  copy.setProductOptionXrefs(new ArrayList&lt;&gt;());
 112              }else {
 113                  for (CategoryProductXref allParentCategoryXref : original.getAllParentCategoryXrefs()) {
<abbr title=" 114                      final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(context).getClone();"> 114                      final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(context).ðŸ”µ</abbr>
 115                      clone.setProduct(copy);
 116                      copy.getAllParentCategoryXrefs().add(clone);
 117                  }
 118                  List&lt;ProductOptionXref&gt; productOptionXrefs = new ArrayList&lt;&gt;();
 119                  for (ProductOptionXref productOptionXref : original.getProductOptionXrefs()) {
<abbr title=" 120                      final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).getClone();"> 120                      final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).getCloðŸ”µ</abbr>
 121                      clone.setProduct(copy);
 122                      productOptionXrefs.add(clone);
 123                  }
 124                  copy.setProductOptionXrefs(productOptionXrefs);
 125              }
 126          }
 127          Calendar instance = Calendar.getInstance();
 128          instance.add(Calendar.YEAR, 1);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        instance.set(Calendar.MILLISECOND, 0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +        instance.set(Calendar.SECOND, 0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        instance.set(Calendar.MINUTE, 0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +        instance.set(Calendar.HOUR, 0);</span>
 133          copy.setActiveStartDate(instance.getTime());
 134          copy.setActiveEndDate(null);



 135  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -        setNameAndUrl(copy);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +        setNameAndUrl(copy, context);</span>
 138  
 139      }
 140  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -    private void setNameAndUrl(Product copy) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +    protected void setNameAndUrl(Product copy, MultiTenantCopyContext context) {</span>
 143          String suffix = getCopySuffix();
 144          String name = copy.getName();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -        if (name.contains(suffix)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -            if (name.contains(COPY_NUMBER_SEPARATOR)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -                final String copyNumber = name.split(suffix)[1];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -                suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1]) + 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +        if(!context.getCopyHints().containsKey(&quot;PROPAGATION&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +            int index = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +            if (name.contains(suffix)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +                index = name.indexOf(COPY_NUMBER_SEPARATOR);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +                if (index &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +                    final String copyNumber = name.split(suffix)[1];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +                    suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1]) + 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +                    suffix = COPY_NUMBER_SEPARATOR + 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +                if(index&gt;0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                    name = name.substring(0, index+1) + suffix;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +                }else{</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +                    name = name + suffix;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +                }</span>
 165              } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -                suffix = COPY_NUMBER_SEPARATOR + 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +                name = name + suffix;</span>
 168              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -            name = name.substring(0, name.length() - 1) + suffix;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -            name = name + suffix;</span>
 172          }
 173          copy.setName(name);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -        copy.setUrl(&quot;/&quot; + copy.getName().replace(&quot;-&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;-&quot;).toLowerCase());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +        String url = &quot;/&quot; + copy.getName().replace(&quot;-&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;-&quot;).replace(&quot;#&quot;,&quot;_&quot;).toLowerCase();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 176 +        ExtensionResultStatusType extensionResultStatusType = productUrlDuplicatorExtensionManager.getProxy().modifyUrl(url, copy, new ExtensionResultHolder&lt;&gt;());"> 176 +        ExtensionResultStatusType extensionResultStatusType = productUrlDuplicatorExtensionManager.getProxy().modiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +        if(extensionResultStatusType == ExtensionResultStatusType.NOT_HANDLED) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +            copy.setUrl(url);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +        }</span>
 180      }
 181  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2021 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.catalog.service;
  19  
  20  import lombok.SneakyThrows;
  21  import org.broadleafcommerce.common.copy.MultiTenantCloneable;
  22  import org.broadleafcommerce.common.copy.MultiTenantCopyContext;
  23  import org.broadleafcommerce.common.extension.ExtensionResultHolder;

  24  import org.broadleafcommerce.common.persistence.AbstractEntityDuplicationHelper;
  25  import org.broadleafcommerce.common.persistence.EntityDuplicatorExtensionManager;
  26  import org.broadleafcommerce.common.service.GenericEntityService;
  27  import org.broadleafcommerce.core.catalog.domain.Category;
  28  import org.broadleafcommerce.core.catalog.domain.CategoryImpl;
  29  import org.broadleafcommerce.core.catalog.domain.CategoryProductXref;
  30  import org.broadleafcommerce.core.catalog.domain.Product;
  31  import org.broadleafcommerce.core.catalog.domain.ProductImpl;
  32  import org.broadleafcommerce.core.catalog.domain.ProductOption;
  33  import org.broadleafcommerce.core.catalog.domain.ProductOptionImpl;
  34  import org.broadleafcommerce.core.catalog.domain.ProductOptionXref;

  35  import org.springframework.beans.factory.annotation.Autowired;
  36  import org.springframework.core.env.Environment;
  37  import org.springframework.stereotype.Component;
  38  
  39  import java.util.ArrayList;
  40  import java.util.Calendar;
  41  import java.util.Date;
  42  import java.util.List;
  43  import java.util.Map;
  44  
  45  import javax.annotation.Resource;
  46  
  47  import static org.broadleafcommerce.common.copy.MultiTenantCopyContext.PROPAGATION;
  48  
  49  @Component(&quot;blProductDuplicateModifier&quot;)
  50  public class ProductDuplicateModifier extends AbstractEntityDuplicationHelper&lt;Product&gt; {
  51  
  52      private static final String COPY_NUMBER_SEPARATOR = &quot;#&quot;;
  53  
  54      @Resource(name = &quot;blEntityDuplicatorExtensionManager&quot;)
  55      protected EntityDuplicatorExtensionManager extensionManager;
  56  
  57      @Resource(name = &quot;blGenericEntityService&quot;)
  58      protected GenericEntityService genericEntityService;
  59  



  60      @Autowired
  61      public ProductDuplicateModifier(final Environment environment) {
  62  
  63          super(environment);
  64  
  65          addCopyHint(ProductImpl.EXCLUDE_PRODUCT_CODE_COPY_HINT, Boolean.TRUE.toString());
  66      }
  67  
  68      @Override
  69      public boolean canHandle(final MultiTenantCloneable candidate) {
  70          return Product.class.isAssignableFrom(candidate.getClass());
  71      }
  72  
  73      @SneakyThrows
  74      @Override
<abbr title="  75      public void modifyInitialDuplicateState(final Product original, final Product copy, final MultiTenantCopyContext context) {">  75      public void modifyInitialDuplicateState(final Product original, final Product copy, final MultiTenantCopyConteðŸ”µ</abbr>

<abbr title="  76          if(context.getCopyHints().get(PROPAGATION)!=null &amp;&amp; &quot;TRUE&quot;.equalsIgnoreCase(context.getCopyHints().get(PROPAGATION))){">  76          if(context.getCopyHints().get(PROPAGATION)!=null &amp;&amp; &quot;TRUE&quot;.equalsIgnoreCase(context.getCopyHints().get(PROðŸ”µ</abbr>
  77              for (CategoryProductXref allParentCategoryXref : original.getAllParentCategoryXrefs()) {
<abbr title="  78                  final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(context).getClone();">  78                  final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(context).getCðŸ”µ</abbr>
  79                  clone.setProduct(copy);
  80                  ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
  81                  Long categoryId = clone.getCategory().getId();
  82                  extensionManager.getClonesByCatalogs(&quot;BLC_CATEGORY&quot;, categoryId, context, resultHolder);
  83                  Long aLong = resultHolder.getResult().get(categoryId).get(context.getToCatalog().getId());
<abbr title="  84                  Category category = (Category) genericEntityService.readGenericEntity(genericEntityService.getCeilingImplClass(CategoryImpl.class.getName()), aLong);">  84                  Category category = (Category) genericEntityService.readGenericEntity(genericEntityService.getCeilðŸ”µ</abbr>
  85                  clone.setCategory(category);
  86                  copy.getAllParentCategoryXrefs().add(clone);
  87              }
  88              List&lt;ProductOptionXref&gt; productOptionXrefs = new ArrayList&lt;&gt;();
  89              for (ProductOptionXref productOptionXref : original.getProductOptionXrefs()) {
<abbr title="  90                  final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).getClone();">  90                  final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).getClone()ðŸ”µ</abbr>
  91                  ExtensionResultHolder&lt;Map&lt;Long, Map&lt;Long, Long&gt;&gt;&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
  92                  Long optionId = clone.getProductOption().getId();
  93                  extensionManager.getClonesByCatalogs(&quot;BLC_PRODUCT_OPTION&quot;, optionId, context, resultHolder);
  94                  Long aLong = resultHolder.getResult().get(optionId).get(context.getToCatalog().getId());
<abbr title="  95                  ProductOption productOption = (ProductOption) genericEntityService.readGenericEntity(genericEntityService.getCeilingImplClass(ProductOptionImpl.class.getName()), aLong);">  95                  ProductOption productOption = (ProductOption) genericEntityService.readGenericEntity(genericEntityðŸ”µ</abbr>
  96                  clone.setProductOption(productOption);
  97                  clone.setProduct(copy);
  98                  productOptionXrefs.add(clone);
  99              }
 100              copy.setProductOptionXrefs(productOptionXrefs);
 101  
 102          }else {
 103              if(!context.getToCatalog().getId().equals(context.getFromCatalog().getId())){
 104                  copy.setAllParentCategoryXrefs(new ArrayList&lt;&gt;());
 105                  copy.setProductOptionXrefs(new ArrayList&lt;&gt;());
 106              }else {
 107                  for (CategoryProductXref allParentCategoryXref : original.getAllParentCategoryXrefs()) {
<abbr title=" 108                      final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(context).getClone();"> 108                      final CategoryProductXref clone = allParentCategoryXref.createOrRetrieveCopyInstance(context).ðŸ”µ</abbr>
 109                      clone.setProduct(copy);
 110                      copy.getAllParentCategoryXrefs().add(clone);
 111                  }
 112                  List&lt;ProductOptionXref&gt; productOptionXrefs = new ArrayList&lt;&gt;();
 113                  for (ProductOptionXref productOptionXref : original.getProductOptionXrefs()) {
<abbr title=" 114                      final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).getClone();"> 114                      final ProductOptionXref clone = productOptionXref.createOrRetrieveCopyInstance(context).getCloðŸ”µ</abbr>
 115                      clone.setProduct(copy);
 116                      productOptionXrefs.add(clone);
 117                  }
 118                  copy.setProductOptionXrefs(productOptionXrefs);
 119              }
 120          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -        Calendar instance = Calendar.getInstance();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -        instance.add(Calendar.YEAR, 1);</span>




<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -        copy.setActiveStartDate(instance.getTime());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -        copy.setActiveEndDate(null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +        final Date currentDate = new Date();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        copy.setActiveStartDate(currentDate);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +        copy.setActiveEndDate(currentDate);</span>
 128  
 129          setNameAndUrl(copy);

 130  
 131      }
 132  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -    private void setNameAndUrl(Product copy) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +    protected void setNameAndUrl(Product copy) {</span>
 135          String suffix = getCopySuffix();
 136          String name = copy.getName();
 137  
 138          if (name.contains(suffix)) {
 139              if (name.contains(COPY_NUMBER_SEPARATOR)) {
 140                  final String copyNumber = name.split(suffix)[1];
 141                  suffix = String.format(&quot;%d&quot;, Long.parseLong(copyNumber.split(COPY_NUMBER_SEPARATOR)[1]) + 1);















 142              } else {
 143                  suffix = COPY_NUMBER_SEPARATOR + 1;

 144              }
 145              name = name.substring(0, name.length() - 1) + suffix;
 146          } else {
 147              name = name + suffix;
 148          }
 149          copy.setName(name);
 150          copy.setUrl(&quot;/&quot; + copy.getName().replace(&quot;-&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;-&quot;).toLowerCase());





 151      }
 152  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            