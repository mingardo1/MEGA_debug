<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>19</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    19
                    <a href="18.html">prev</a>
                    <a href="20.html">next</a>
                    <a href="19_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    AriaLyy/Aria_1469ca1ceaae9c691eee7790de89a3ee1f571403_app/src/main/java/com/arialyy/simple/core/download/SingleTaskActivity.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;1469ca1ceaae9c691eee7790de89a3ee1f571403:app/src/main/java/com/arialyy/simple/core/download/SingleTaskActivity.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;1469ca1ceaae9c691eee7790de89a3ee1f571403^1:app/src/main/java/com/arialyy/simple/core/download/SingleTaskActivity.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;1469ca1ceaae9c691eee7790de89a3ee1f571403^2:app/src/main/java/com/arialyy/simple/core/download/SingleTaskActivity.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;39a43c836d3309cbbf82de6d51309fe71fc25292:app/src/main/java/com/arialyy/simple/core/download/SingleTaskActivity.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 
  17 package com.arialyy.simple.core.download;
  18 
  19 import android.arch.lifecycle.Observer;
  20 import android.arch.lifecycle.ViewModelProviders;
  21 import android.content.BroadcastReceiver;
  22 import android.content.Context;
  23 import android.content.Intent;
  24 import android.os.Bundle;
  25 import android.support.annotation.Nullable;
  26 import android.util.Log;
  27 import android.view.Menu;
  28 import android.view.MenuItem;
  29 import android.view.View;
  30 import android.widget.Toast;
  31 
  32 import com.arialyy.annotations.Download;
  33 import com.arialyy.aria.core.Aria;
  34 import com.arialyy.aria.core.download.DownloadEntity;
  35 import com.arialyy.aria.core.download.DownloadTarget;
  36 import com.arialyy.aria.core.download.DownloadTask;
  37 import com.arialyy.aria.core.inf.IEntity;
  38 import com.arialyy.aria.core.inf.IHttpFileLenAdapter;
  39 import com.arialyy.aria.core.scheduler.ISchedulers;
  40 import com.arialyy.aria.util.ALog;
  41 import com.arialyy.aria.util.CommonUtil;
  42 import com.arialyy.frame.util.show.T;
  43 import com.arialyy.simple.R;
  44 import com.arialyy.simple.base.BaseActivity;
  45 import com.arialyy.simple.common.ModifyPathDialog;
  46 import com.arialyy.simple.common.ModifyUrlDialog;
  47 import com.arialyy.simple.databinding.ActivitySingleBinding;
  48 
  49 import com.arialyy.simple.util.AppUtil;
  50 import java.io.File;
  51 import java.io.IOException;
  52 import java.util.List;
  53 import java.util.Map;
  54 
  55 public class SingleTaskActivity extends BaseActivity&lt;ActivitySingleBinding&gt; {
  56 
  57   private String mUrl;
  58   private String mFilePath;
  59   private HttpDownloadModule mModule;
  60   private DownloadTarget mTarget;
  61 
  62   BroadcastReceiver receiver = new BroadcastReceiver() {
  63     @Override
  64     public void onReceive(Context context, Intent intent) {
  65       if (intent.getAction().equals(ISchedulers.ARIA_TASK_INFO_ACTION)) {
  66         ALog.d(TAG, &quot;state = &quot; + intent.getIntExtra(ISchedulers.TASK_STATE, -1));
  67         ALog.d(TAG, &quot;type = &quot; + intent.getIntExtra(ISchedulers.TASK_TYPE, -1));
  68         ALog.d(TAG, &quot;speed = &quot; + intent.getLongExtra(ISchedulers.TASK_SPEED, -1));
  69         ALog.d(TAG, &quot;percent = &quot; + intent.getIntExtra(ISchedulers.TASK_PERCENT, -1));
  70         ALog.d(TAG, &quot;entity = &quot; + intent.getParcelableExtra(ISchedulers.TASK_ENTITY).toString());
  71       }
  72     }
  73   };
  74 
  75   @Override
  76   protected void onResume() {
  77     super.onResume();
  78     //registerReceiver(receiver, new IntentFilter(ISchedulers.ARIA_TASK_INFO_ACTION));
  79   }
  80 
  81   @Override
  82   protected void onDestroy() {
  83     super.onDestroy();
  84     //unregisterReceiver(receiver);
  85     Aria.download(this).unRegister();
  86   }
  87 
  88   @Override
  89   protected void init(Bundle savedInstanceState) {
  90     super.init(savedInstanceState);
  91     setTitle(&quot;单任务下载&quot;);
  92     Aria.download(this).register();
  93     mModule = ViewModelProviders.of(this).get(HttpDownloadModule.class);
  94     mModule.getHttpDownloadInfo(this).observe(this, new Observer&lt;DownloadEntity&gt;() {
  95 
  96       @Override public void onChanged(@Nullable DownloadEntity entity) {
  97         if (entity == null) {
  98           return;
  99         }
 100         mTarget = Aria.download(SingleTaskActivity.this).load(entity.getUrl());
 101         if (mTarget.getTaskState() == IEntity.STATE_STOP) {
 102           getBinding().setStateStr(getString(R.string.resume));
 103         } else if (mTarget.isRunning()) {
 104           getBinding().setStateStr(getString(R.string.stop));
 105         }
 106 
 107         if (entity.getFileSize() != 0) {
 108           getBinding().setFileSize(CommonUtil.formatFileSize(entity.getFileSize()));
 109           getBinding().setProgress(entity.isComplete() ? 100
 110               : (int) (entity.getCurrentProgress() * 100 / entity.getFileSize()));
 111         }
 112         getBinding().setUrl(entity.getUrl());
 113         getBinding().setFilePath(entity.getFilePath());
 114         mUrl = entity.getUrl();
 115         mFilePath = entity.getFilePath();
 116       }
 117     });
 118     getBinding().setViewModel(this);
 119     try {
 120       getBinding().codeView.setSource(AppUtil.getHelpCode(this, &quot;HttpDownload.java&quot;));
 121     } catch (IOException e) {
 122       e.printStackTrace();
 123     }
 124   }
 125 
 126   public void chooseUrl() {
 127     ModifyUrlDialog dialog =
 128         new ModifyUrlDialog(this, getString(R.string.modify_url_dialog_title), mUrl);
 129     dialog.show(getSupportFragmentManager(), &quot;ModifyUrlDialog&quot;);
 130   }
 131 
 132   public void chooseFilePath() {
 133     ModifyPathDialog dialog =
 134         new ModifyPathDialog(this, getString(R.string.modify_file_path), mFilePath);
 135     dialog.show(getSupportFragmentManager(), &quot;ModifyPathDialog&quot;);
 136   }
 137 
 138   @Override
 139   public boolean onCreateOptionsMenu(Menu menu) {
 140     getMenuInflater().inflate(R.menu.menu_single_task_activity, menu);
 141     return super.onCreateOptionsMenu(menu);
 142   }
 143 
 144   @Override
 145   public boolean onMenuItemClick(MenuItem item) {
 146     int speed = -1;
 147     String msg = &quot;&quot;;
 148     switch (item.getItemId()) {
 149       case R.id.help:
 150         msg = &quot;一些小知识点：\n&quot;
 151             + &quot;1、你可以在注解中增加链接，用于指定被注解的方法只能被特定的下载任务回调，以防止progress乱跳\n&quot;
 152             + &quot;2、当遇到网络慢的情况时，你可以先使用onPre()更新UI界面，待连接成功时，再在onTaskPre()获取完整的task数据，然后给UI界面设置正确的数据\n&quot;
 153             + &quot;3、你可以在界面初始化时通过Aria.download(this).load(URL).getPercent()等方法快速获取相关任务的一些数据&quot;;
 154         showMsgDialog(&quot;tip&quot;, msg);
 155         break;
 156       case R.id.speed_0:
 157         speed = 0;
 158         break;
 159       case R.id.speed_128:
 160         speed = 128;
 161         break;
 162       case R.id.speed_256:
 163         speed = 256;
 164         break;
 165       case R.id.speed_512:
 166         speed = 512;
 167         break;
 168       case R.id.speed_1m:
 169         speed = 1024;
 170         break;
 171     }
 172     if (speed &gt; -1) {
 173       msg = item.getTitle().toString();
 174       Aria.download(this).setMaxSpeed(speed);
 175       T.showShort(this, msg);
 176     }
 177     return true;
 178   }
 179 
 180   @Download.onWait
 181   void onWait(DownloadTask task) {
 182     if (task.getKey().equals(mUrl)) {
 183       Log.d(TAG, &quot;wait ==&gt; &quot; + task.getDownloadEntity().getFileName());
 184     }
 185   }
 186 
 187   @Download.onPre
 188   protected void onPre(DownloadTask task) {
 189     if (task.getKey().equals(mUrl)) {
 190       getBinding().setStateStr(getString(R.string.stop));
 191     }
 192   }
 193 
 194   @Download.onTaskStart
 195   void taskStart(DownloadTask task) {
 196     if (task.getKey().equals(mUrl)) {
 197       getBinding().setFileSize(task.getConvertFileSize());
 198       ALog.d(TAG, &quot;isComplete = &quot; + task.isComplete() + &quot;, state = &quot; + task.getState());
 199     }
 200   }
 201 
 202   @Download.onTaskRunning
 203   protected void running(DownloadTask task) {
 204     if (task.getKey().equals(mUrl)) {
 205       ALog.d(TAG, &quot;isRunning&quot;);
 206       //Log.d(TAG, task.getKey());
 207       long len = task.getFileSize();
 208       if (len == 0) {
 209         getBinding().setProgress(0);
 210       } else {
 211         getBinding().setProgress(task.getPercent());
 212       }
 213       getBinding().setSpeed(task.getConvertSpeed());
 214     }
 215   }
 216 
 217   @Download.onTaskResume
 218   void taskResume(DownloadTask task) {
 219     if (task.getKey().equals(mUrl)) {
 220       getBinding().setStateStr(getString(R.string.stop));
 221     }
 222   }
 223 
 224   @Download.onTaskStop
 225   void taskStop(DownloadTask task) {
 226     if (task.getKey().equals(mUrl)) {
 227       getBinding().setStateStr(getString(R.string.resume));
 228       getBinding().setSpeed(&quot;&quot;);
 229     }
 230   }
 231 
 232   @Download.onTaskCancel
 233   void taskCancel(DownloadTask task) {
 234     if (task.getKey().equals(mUrl)) {
 235       getBinding().setProgress(0);
 236       getBinding().setStateStr(getString(R.string.start));
 237       getBinding().setSpeed(&quot;&quot;);
 238       Log.d(TAG, &quot;cancel&quot;);
 239     }
 240   }
 241 
 242   @Download.onTaskFail
 243   void taskFail(DownloadTask task, Exception e) {
 244     if (task.getKey().equals(mUrl)) {
 245       Toast.makeText(SingleTaskActivity.this, getString(R.string.download_fail), Toast.LENGTH_SHORT)
 246           .show();
 247       getBinding().setStateStr(getString(R.string.start));
 248     }
 249   }
 250 
 251   @Download.onTaskComplete
 252   void taskComplete(DownloadTask task) {
 253     if (task.getKey().equals(mUrl)) {
 254       getBinding().setProgress(100);
 255       Toast.makeText(SingleTaskActivity.this, getString(R.string.download_success),
 256           Toast.LENGTH_SHORT).show();
 257       getBinding().setStateStr(getString(R.string.re_start));
 258       getBinding().setSpeed(&quot;&quot;);
 259 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260       ALog.d(TAG, &quot;md5: &quot; + CommonUtil.getFileMD5(new File(task.getDownloadPath())));</span>
 261 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262   }</span>
 263 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264       ALog.d(TAG, &quot;md5: &quot; + CommonUtil.getFileMD5(new File(task.getFilePath())));</span>
 265 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 266     }
 267   }
 268 
 269   @Override
 270   protected int setLayoutId() {
 271     return R.layout.activity_single;
 272   }
 273 
 274   public void onClick(View view) {
 275     switch (view.getId()) {
 276       case R.id.start:
 277         if (mTarget.isRunning()) {
 278           Aria.download(this).load(mUrl).stop();
 279         } else {
 280           startD();
 281         }
 282         break;
 283       case R.id.cancel:
 284         Aria.download(this).load(mUrl).cancel(true);
 285         break;
 286     }
 287   }
 288 
 289   private void startD() {
 290     Aria.download(SingleTaskActivity.this)
 291         .load(mUrl)
<abbr title=" 292         //.addHeader(&quot;Accept&quot;, &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;)"> 292         //.addHeader(&quot;Accept&quot;, &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/ap🔵</abbr>
 293         //.addHeader(&quot;Accept-Encoding&quot;, &quot;gzip, deflate&quot;)
 294         //.addHeader(&quot;DNT&quot;, &quot;1&quot;)
<abbr title=" 295         //.addHeader(&quot;Cookie&quot;, &quot;BAIDUID=648E5FF020CC69E8DD6F492D1068AAA9:FG=1; BIDUPSID=648E5FF020CC69E8DD6F492D1068AAA9; PSTM=1519099573; BD_UPN=12314753; locale=zh; BDSVRTM=0&quot;)"> 295         //.addHeader(&quot;Cookie&quot;, &quot;BAIDUID=648E5FF020CC69E8DD6F492D1068AAA9:FG=1; BIDUPSID=648E5FF020CC69E8D🔵</abbr>
 296         .useServerFileName(true)
 297         .setFilePath(mFilePath, true)
 298         .setFileLenAdapter(new IHttpFileLenAdapter() {
 299           @Override public long handleFileLen(Map&lt;String, List&lt;String&gt;&gt; headers) {
 300 
 301             List&lt;String&gt; sLength = headers.get(&quot;Content-Length&quot;);
 302             if (sLength == null || sLength.isEmpty()) {
 303               return -1;
 304             }
 305             String temp = sLength.get(0);
 306 
 307             return Long.parseLong(temp);
 308           }
 309         })
 310         .start();
 311   }
 312 
 313   @Override
 314   protected void onStop() {
 315     super.onStop();
 316     //Aria.download(this).unRegister();
 317   }
 318 
 319   @Override protected void dataCallback(int result, Object data) {
 320     super.dataCallback(result, data);
 321     if (result == ModifyUrlDialog.MODIFY_URL_DIALOG_RESULT) {
 322       mModule.uploadUrl(this, String.valueOf(data));
 323     } else if (result == ModifyPathDialog.MODIFY_PATH_RESULT) {
 324       mModule.updateFilePath(this, String.valueOf(data));
 325     }
 326   }
 327 }
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 
  17 package com.arialyy.simple.core.download;
  18 
  19 import android.arch.lifecycle.Observer;
  20 import android.arch.lifecycle.ViewModelProviders;
  21 import android.content.BroadcastReceiver;
  22 import android.content.Context;
  23 import android.content.Intent;
  24 import android.os.Bundle;
  25 import android.support.annotation.Nullable;
  26 import android.util.Log;
  27 import android.view.Menu;
  28 import android.view.MenuItem;
  29 import android.view.View;
  30 import android.widget.Toast;
  31 
  32 import com.arialyy.annotations.Download;
  33 import com.arialyy.aria.core.Aria;
  34 import com.arialyy.aria.core.download.DownloadEntity;
  35 import com.arialyy.aria.core.download.DownloadTarget;
  36 import com.arialyy.aria.core.download.DownloadTask;
  37 import com.arialyy.aria.core.inf.IEntity;
  38 import com.arialyy.aria.core.inf.IHttpFileLenAdapter;
  39 import com.arialyy.aria.core.scheduler.ISchedulers;
  40 import com.arialyy.aria.util.ALog;
  41 import com.arialyy.aria.util.CommonUtil;
  42 import com.arialyy.frame.util.show.T;
  43 import com.arialyy.simple.R;
  44 import com.arialyy.simple.base.BaseActivity;
  45 import com.arialyy.simple.common.ModifyPathDialog;
  46 import com.arialyy.simple.common.ModifyUrlDialog;
  47 import com.arialyy.simple.databinding.ActivitySingleBinding;
  48 
  49 import com.arialyy.simple.util.AppUtil;
  50 import java.io.File;
  51 import java.io.IOException;
  52 import java.util.List;
  53 import java.util.Map;
  54 
  55 public class SingleTaskActivity extends BaseActivity&lt;ActivitySingleBinding&gt; {
  56 
  57   private String mUrl;
  58   private String mFilePath;
  59   private HttpDownloadModule mModule;
  60   private DownloadTarget mTarget;
  61 
  62   BroadcastReceiver receiver = new BroadcastReceiver() {
  63     @Override
  64     public void onReceive(Context context, Intent intent) {
  65       if (intent.getAction().equals(ISchedulers.ARIA_TASK_INFO_ACTION)) {
  66         ALog.d(TAG, &quot;state = &quot; + intent.getIntExtra(ISchedulers.TASK_STATE, -1));
  67         ALog.d(TAG, &quot;type = &quot; + intent.getIntExtra(ISchedulers.TASK_TYPE, -1));
  68         ALog.d(TAG, &quot;speed = &quot; + intent.getLongExtra(ISchedulers.TASK_SPEED, -1));
  69         ALog.d(TAG, &quot;percent = &quot; + intent.getIntExtra(ISchedulers.TASK_PERCENT, -1));
  70         ALog.d(TAG, &quot;entity = &quot; + intent.getParcelableExtra(ISchedulers.TASK_ENTITY).toString());
  71       }
  72     }
  73   };
  74 
  75   @Override
  76   protected void onResume() {
  77     super.onResume();
  78     //registerReceiver(receiver, new IntentFilter(ISchedulers.ARIA_TASK_INFO_ACTION));
  79   }
  80 
  81   @Override
  82   protected void onDestroy() {
  83     super.onDestroy();
  84     //unregisterReceiver(receiver);
  85     Aria.download(this).unRegister();
  86   }
  87 
  88   @Override
  89   protected void init(Bundle savedInstanceState) {
  90     super.init(savedInstanceState);
  91     setTitle(&quot;单任务下载&quot;);
  92     Aria.download(this).register();
  93     mModule = ViewModelProviders.of(this).get(HttpDownloadModule.class);
  94     mModule.getHttpDownloadInfo(this).observe(this, new Observer&lt;DownloadEntity&gt;() {
  95 
  96       @Override public void onChanged(@Nullable DownloadEntity entity) {
  97         if (entity == null) {
  98           return;
  99         }
 100         mTarget = Aria.download(SingleTaskActivity.this).load(entity.getUrl());
 101         if (mTarget.getTaskState() == IEntity.STATE_STOP) {
 102           getBinding().setStateStr(getString(R.string.resume));
 103         } else if (mTarget.isRunning()) {
 104           getBinding().setStateStr(getString(R.string.stop));
 105         }
 106 
 107         if (entity.getFileSize() != 0) {
 108           getBinding().setFileSize(CommonUtil.formatFileSize(entity.getFileSize()));
 109           getBinding().setProgress(entity.isComplete() ? 100
 110               : (int) (entity.getCurrentProgress() * 100 / entity.getFileSize()));
 111         }
 112         getBinding().setUrl(entity.getUrl());
 113         getBinding().setFilePath(entity.getFilePath());
 114         mUrl = entity.getUrl();
 115         mFilePath = entity.getFilePath();
 116       }
 117     });
 118     getBinding().setViewModel(this);
 119     try {
 120       getBinding().codeView.setSource(AppUtil.getHelpCode(this, &quot;HttpDownload.java&quot;));
 121     } catch (IOException e) {
 122       e.printStackTrace();
 123     }
 124   }
 125 
 126   public void chooseUrl() {
 127     ModifyUrlDialog dialog =
 128         new ModifyUrlDialog(this, getString(R.string.modify_url_dialog_title), mUrl);
 129     dialog.show(getSupportFragmentManager(), &quot;ModifyUrlDialog&quot;);
 130   }
 131 
 132   public void chooseFilePath() {
 133     ModifyPathDialog dialog =
 134         new ModifyPathDialog(this, getString(R.string.modify_file_path), mFilePath);
 135     dialog.show(getSupportFragmentManager(), &quot;ModifyPathDialog&quot;);
 136   }
 137 
 138   @Override
 139   public boolean onCreateOptionsMenu(Menu menu) {
 140     getMenuInflater().inflate(R.menu.menu_single_task_activity, menu);
 141     return super.onCreateOptionsMenu(menu);
 142   }
 143 
 144   @Override
 145   public boolean onMenuItemClick(MenuItem item) {
 146     int speed = -1;
 147     String msg = &quot;&quot;;
 148     switch (item.getItemId()) {
 149       case R.id.help:
 150         msg = &quot;一些小知识点：\n&quot;
 151             + &quot;1、你可以在注解中增加链接，用于指定被注解的方法只能被特定的下载任务回调，以防止progress乱跳\n&quot;
 152             + &quot;2、当遇到网络慢的情况时，你可以先使用onPre()更新UI界面，待连接成功时，再在onTaskPre()获取完整的task数据，然后给UI界面设置正确的数据\n&quot;
 153             + &quot;3、你可以在界面初始化时通过Aria.download(this).load(URL).getPercent()等方法快速获取相关任务的一些数据&quot;;
 154         showMsgDialog(&quot;tip&quot;, msg);
 155         break;
 156       case R.id.speed_0:
 157         speed = 0;
 158         break;
 159       case R.id.speed_128:
 160         speed = 128;
 161         break;
 162       case R.id.speed_256:
 163         speed = 256;
 164         break;
 165       case R.id.speed_512:
 166         speed = 512;
 167         break;
 168       case R.id.speed_1m:
 169         speed = 1024;
 170         break;
 171     }
 172     if (speed &gt; -1) {
 173       msg = item.getTitle().toString();
 174       Aria.download(this).setMaxSpeed(speed);
 175       T.showShort(this, msg);
 176     }
 177     return true;
 178   }
 179 
 180   @Download.onWait
 181   void onWait(DownloadTask task) {
 182     if (task.getKey().equals(mUrl)) {
 183       Log.d(TAG, &quot;wait ==&gt; &quot; + task.getDownloadEntity().getFileName());
 184     }
 185   }
 186 
 187   @Download.onPre
 188   protected void onPre(DownloadTask task) {
 189     if (task.getKey().equals(mUrl)) {
 190       getBinding().setStateStr(getString(R.string.stop));
 191     }
 192   }
 193 
 194   @Download.onTaskStart
 195   void taskStart(DownloadTask task) {
 196     if (task.getKey().equals(mUrl)) {
 197       getBinding().setFileSize(task.getConvertFileSize());
 198       ALog.d(TAG, &quot;isComplete = &quot; + task.isComplete() + &quot;, state = &quot; + task.getState());
 199     }
 200   }
 201 
 202   @Download.onTaskRunning
 203   protected void running(DownloadTask task) {
 204     if (task.getKey().equals(mUrl)) {
 205       ALog.d(TAG, &quot;isRunning&quot;);
 206       //Log.d(TAG, task.getKey());
 207       long len = task.getFileSize();
 208       if (len == 0) {
 209         getBinding().setProgress(0);
 210       } else {
 211         getBinding().setProgress(task.getPercent());
 212       }
 213       getBinding().setSpeed(task.getConvertSpeed());
 214     }
 215   }
 216 
 217   @Download.onTaskResume
 218   void taskResume(DownloadTask task) {
 219     if (task.getKey().equals(mUrl)) {
 220       getBinding().setStateStr(getString(R.string.stop));
 221     }
 222   }
 223 
 224   @Download.onTaskStop
 225   void taskStop(DownloadTask task) {
 226     if (task.getKey().equals(mUrl)) {
 227       getBinding().setStateStr(getString(R.string.resume));
 228       getBinding().setSpeed(&quot;&quot;);
 229     }
 230   }
 231 
 232   @Download.onTaskCancel
 233   void taskCancel(DownloadTask task) {
 234     if (task.getKey().equals(mUrl)) {
 235       getBinding().setProgress(0);
 236       getBinding().setStateStr(getString(R.string.start));
 237       getBinding().setSpeed(&quot;&quot;);
 238       Log.d(TAG, &quot;cancel&quot;);
 239     }
 240   }
 241 
 242   @Download.onTaskFail
 243   void taskFail(DownloadTask task, Exception e) {
 244     if (task.getKey().equals(mUrl)) {
 245       Toast.makeText(SingleTaskActivity.this, getString(R.string.download_fail), Toast.LENGTH_SHORT)
 246           .show();
 247       getBinding().setStateStr(getString(R.string.start));
 248     }
 249   }
 250 
 251   @Download.onTaskComplete
 252   void taskComplete(DownloadTask task) {
 253     if (task.getKey().equals(mUrl)) {
 254       getBinding().setProgress(100);
 255       Toast.makeText(SingleTaskActivity.this, getString(R.string.download_success),
 256           Toast.LENGTH_SHORT).show();
 257       getBinding().setStateStr(getString(R.string.re_start));
 258       getBinding().setSpeed(&quot;&quot;);
 259 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260       ALog.d(TAG, &quot;md5: &quot; + CommonUtil.getFileMD5(new File(task.getDownloadPath())));</span>
 261 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262       getBinding().setSpeed(&quot;&quot;);</span>
 263 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264       ALog.d(TAG, &quot;md5: &quot; + CommonUtil.getFileMD5(new File(task.getFilePath())));</span>
 265 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 266     }
 267   }
 268 
 269   @Override
 270   protected int setLayoutId() {
 271     return R.layout.activity_single;
 272   }
 273 
 274   public void onClick(View view) {
 275     switch (view.getId()) {
 276       case R.id.start:
 277         if (mTarget.isRunning()) {
 278           Aria.download(this).load(mUrl).stop();
 279         } else {
 280           startD();
 281         }
 282         break;
 283       case R.id.cancel:
 284         Aria.download(this).load(mUrl).cancel(true);
 285         break;
 286     }
 287   }
 288 
 289   private void startD() {
 290     Aria.download(SingleTaskActivity.this)
 291         .load(mUrl)
<abbr title=" 292         //.addHeader(&quot;Accept&quot;, &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;)"> 292         //.addHeader(&quot;Accept&quot;, &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/ap🔵</abbr>
 293         //.addHeader(&quot;Accept-Encoding&quot;, &quot;gzip, deflate&quot;)
 294         //.addHeader(&quot;DNT&quot;, &quot;1&quot;)
<abbr title=" 295         //.addHeader(&quot;Cookie&quot;, &quot;BAIDUID=648E5FF020CC69E8DD6F492D1068AAA9:FG=1; BIDUPSID=648E5FF020CC69E8DD6F492D1068AAA9; PSTM=1519099573; BD_UPN=12314753; locale=zh; BDSVRTM=0&quot;)"> 295         //.addHeader(&quot;Cookie&quot;, &quot;BAIDUID=648E5FF020CC69E8DD6F492D1068AAA9:FG=1; BIDUPSID=648E5FF020CC69E8D🔵</abbr>
 296         .useServerFileName(true)
 297         .setFilePath(mFilePath, true)
 298         .setFileLenAdapter(new IHttpFileLenAdapter() {
 299           @Override public long handleFileLen(Map&lt;String, List&lt;String&gt;&gt; headers) {
 300 
 301             List&lt;String&gt; sLength = headers.get(&quot;Content-Length&quot;);
 302             if (sLength == null || sLength.isEmpty()) {
 303               return -1;
 304             }
 305             String temp = sLength.get(0);
 306 
 307             return Long.parseLong(temp);
 308           }
 309         })
 310         .start();
 311   }
 312 
 313   @Override
 314   protected void onStop() {
 315     super.onStop();
 316     //Aria.download(this).unRegister();
 317   }
 318 
 319   @Override protected void dataCallback(int result, Object data) {
 320     super.dataCallback(result, data);
 321     if (result == ModifyUrlDialog.MODIFY_URL_DIALOG_RESULT) {
 322       mModule.uploadUrl(this, String.valueOf(data));
 323     } else if (result == ModifyPathDialog.MODIFY_PATH_RESULT) {
 324       mModule.updateFilePath(this, String.valueOf(data));
 325     }
 326   }
 327 }
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.simple.core.download;
  17 
  18 import android.arch.lifecycle.Observer;
  19 import android.arch.lifecycle.ViewModelProviders;
  20 import android.content.BroadcastReceiver;
  21 import android.content.Context;
  22 import android.content.Intent;
  23 import android.os.Bundle;
  24 import android.support.annotation.Nullable;
  25 import android.util.Log;
  26 import android.view.Menu;
  27 import android.view.MenuItem;
  28 import android.view.View;
  29 import android.widget.Toast;
  30 import com.arialyy.annotations.Download;
  31 import com.arialyy.aria.core.Aria;
  32 import com.arialyy.aria.core.download.DownloadEntity;
  33 import com.arialyy.aria.core.download.DownloadTarget;
  34 import com.arialyy.aria.core.download.DownloadTask;
  35 import com.arialyy.aria.core.inf.IEntity;
  36 import com.arialyy.aria.core.inf.IHttpFileLenAdapter;
  37 import com.arialyy.aria.core.scheduler.ISchedulers;
  38 import com.arialyy.aria.util.ALog;
  39 import com.arialyy.aria.util.CommonUtil;
  40 import com.arialyy.frame.util.show.T;
  41 import com.arialyy.simple.R;
  42 import com.arialyy.simple.base.BaseActivity;
  43 import com.arialyy.simple.common.ModifyPathDialog;
  44 import com.arialyy.simple.common.ModifyUrlDialog;
  45 import com.arialyy.simple.databinding.ActivitySingleBinding;
  46 import com.arialyy.simple.util.AppUtil;
  47 import java.io.File;
  48 import java.io.IOException;
  49 import java.util.List;
  50 import java.util.Map;
  51 
  52 
  53 public class SingleTaskActivity extends BaseActivity&lt;ActivitySingleBinding&gt; {
  54   private String mUrl;
  55 
  56   private String mFilePath;
  57 
  58   private HttpDownloadModule mModule;
  59 
  60   private DownloadTarget mTarget;
  61 
  62   BroadcastReceiver receiver = new BroadcastReceiver() {
  63     @Override
  64     public void onReceive(Context context, Intent intent) {
  65       if (intent.getAction().equals(ISchedulers.ARIA_TASK_INFO_ACTION)) {
  66         ALog.d(TAG, &quot;state = &quot; + intent.getIntExtra(ISchedulers.TASK_STATE, -1));
  67         ALog.d(TAG, &quot;type = &quot; + intent.getIntExtra(ISchedulers.TASK_TYPE, -1));
  68         ALog.d(TAG, &quot;speed = &quot; + intent.getLongExtra(ISchedulers.TASK_SPEED, -1));
  69         ALog.d(TAG, &quot;percent = &quot; + intent.getIntExtra(ISchedulers.TASK_PERCENT, -1));
  70         ALog.d(TAG, &quot;entity = &quot; + intent.getParcelableExtra(ISchedulers.TASK_ENTITY).toString());
  71       }
  72     }
  73   };
  74 
  75   @Override
  76   protected void onResume() {
  77     super.onResume();
  78     //registerReceiver(receiver, new IntentFilter(ISchedulers.ARIA_TASK_INFO_ACTION));
  79   }
  80 
  81   @Override
  82   protected void onDestroy() {
  83     super.onDestroy();
  84     //unregisterReceiver(receiver);
  85     Aria.download(this).unRegister();
  86   }
  87 
  88   @Override
  89   protected void init(Bundle savedInstanceState) {
  90     super.init(savedInstanceState);
  91     setTitle(&quot;单任务下载&quot;);
  92     Aria.download(this).register();
  93     mModule = ViewModelProviders.of(this).get(HttpDownloadModule.class);
  94     mModule.getHttpDownloadInfo(this).observe(this, new Observer&lt;DownloadEntity&gt;() {
  95 
  96       @Override public void onChanged(@Nullable DownloadEntity entity) {
  97         if (entity == null) {
  98           return;
  99         }
 100         mTarget = Aria.download(SingleTaskActivity.this).load(entity.getUrl());
 101         if (mTarget.getTaskState() == IEntity.STATE_STOP) {
 102           getBinding().setStateStr(getString(R.string.resume));
 103         } else if (mTarget.isRunning()) {
 104           getBinding().setStateStr(getString(R.string.stop));
 105         }
 106 
 107         if (entity.getFileSize() != 0) {
 108           getBinding().setFileSize(CommonUtil.formatFileSize(entity.getFileSize()));
 109           getBinding().setProgress(entity.isComplete() ? 100
 110               : (int) (entity.getCurrentProgress() * 100 / entity.getFileSize()));
 111         }
 112         getBinding().setUrl(entity.getUrl());
 113         getBinding().setFilePath(entity.getFilePath());
 114         mUrl = entity.getUrl();
 115         mFilePath = entity.getFilePath();
 116       }
 117     });
 118     getBinding().setViewModel(this);
 119     try {
 120       getBinding().codeView.setSource(AppUtil.getHelpCode(this, &quot;HttpDownload.java&quot;));
 121     } catch (IOException e) {
 122       e.printStackTrace();
 123     }
 124   }
 125 
 126   public void chooseUrl() {
 127     ModifyUrlDialog dialog =
 128         new ModifyUrlDialog(this, getString(R.string.modify_url_dialog_title), mUrl);
 129     dialog.show(getSupportFragmentManager(), &quot;ModifyUrlDialog&quot;);
 130   }
 131 
 132   public void chooseFilePath() {
 133     ModifyPathDialog dialog =
 134         new ModifyPathDialog(this, getString(R.string.modify_file_path), mFilePath);
 135     dialog.show(getSupportFragmentManager(), &quot;ModifyPathDialog&quot;);
 136   }
 137 
 138   @Override
 139   public boolean onCreateOptionsMenu(Menu menu) {
 140     getMenuInflater().inflate(R.menu.menu_single_task_activity, menu);
 141     return super.onCreateOptionsMenu(menu);
 142   }
 143 
 144   @Override
 145   public boolean onMenuItemClick(MenuItem item) {
 146     int speed = -1;
 147     String msg = &quot;&quot;;
 148     switch (item.getItemId()) {
 149       case R.id.help:
 150         msg = &quot;一些小知识点：\n&quot;
 151             + &quot;1、你可以在注解中增加链接，用于指定被注解的方法只能被特定的下载任务回调，以防止progress乱跳\n&quot;
 152             + &quot;2、当遇到网络慢的情况时，你可以先使用onPre()更新UI界面，待连接成功时，再在onTaskPre()获取完整的task数据，然后给UI界面设置正确的数据\n&quot;
 153             + &quot;3、你可以在界面初始化时通过Aria.download(this).load(URL).getPercent()等方法快速获取相关任务的一些数据&quot;;
 154         showMsgDialog(&quot;tip&quot;, msg);
 155         break;
 156       case R.id.speed_0:
 157         speed = 0;
 158         break;
 159       case R.id.speed_128:
 160         speed = 128;
 161         break;
 162       case R.id.speed_256:
 163         speed = 256;
 164         break;
 165       case R.id.speed_512:
 166         speed = 512;
 167         break;
 168       case R.id.speed_1m:
 169         speed = 1024;
 170         break;
 171     }
 172     if (speed &gt; -1) {
 173       msg = item.getTitle().toString();
 174       Aria.download(this).setMaxSpeed(speed);
 175       T.showShort(this, msg);
 176     }
 177     return true;
 178   }
 179 
 180   @Download.onWait
 181   void onWait(DownloadTask task) {
 182     if (task.getKey().equals(mUrl)) {
 183       Log.d(TAG, &quot;wait ==&gt; &quot; + task.getDownloadEntity().getFileName());
 184     }
 185   }
 186 
 187   @Download.onPre
 188   protected void onPre(DownloadTask task) {
 189     if (task.getKey().equals(mUrl)) {
 190       getBinding().setStateStr(getString(R.string.stop));
 191     }
 192   }
 193 
 194   @Download.onTaskStart
 195   void taskStart(DownloadTask task) {
 196     if (task.getKey().equals(mUrl)) {
 197       getBinding().setFileSize(task.getConvertFileSize());
 198       ALog.d(TAG, &quot;isComplete = &quot; + task.isComplete() + &quot;, state = &quot; + task.getState());
 199     }
 200   }
 201 
 202   @Download.onTaskRunning
 203   protected void running(DownloadTask task) {
 204     if (task.getKey().equals(mUrl)) {
 205       ALog.d(TAG, &quot;isRunning&quot;);
 206       // Log.d(TAG, task.getKey());
 207       long len = task.getFileSize();
 208       if (len == 0) {
 209         getBinding().setProgress(0);
 210       } else {
 211         getBinding().setProgress(task.getPercent());
 212       }
 213       getBinding().setSpeed(task.getConvertSpeed());
 214     }
 215   }
 216 
 217   @Download.onTaskResume
 218   void taskResume(DownloadTask task) {
 219     if (task.getKey().equals(mUrl)) {
 220       getBinding().setStateStr(getString(R.string.stop));
 221     }
 222   }
 223 
 224   @Download.onTaskStop
 225   void taskStop(DownloadTask task) {
 226     if (task.getKey().equals(mUrl)) {
 227       getBinding().setStateStr(getString(R.string.resume));
 228       getBinding().setSpeed(&quot;&quot;);
 229     }
 230   }
 231 
 232   @Download.onTaskCancel
 233   void taskCancel(DownloadTask task) {
 234     if (task.getKey().equals(mUrl)) {
 235       getBinding().setProgress(0);
 236       getBinding().setStateStr(getString(R.string.start));
 237       getBinding().setSpeed(&quot;&quot;);
 238       Log.d(TAG, &quot;cancel&quot;);
 239     }
 240   }
 241 
 242   @Download.onTaskFail
 243   void taskFail(DownloadTask task, Exception e) {
 244     if (task.getKey().equals(mUrl)) {
 245       Toast.makeText(SingleTaskActivity.this, getString(R.string.download_fail), Toast.LENGTH_SHORT)
 246           .show();
 247       getBinding().setStateStr(getString(R.string.start));
 248     }
 249   }
 250 
 251   @Download.onTaskComplete
 252   void taskComplete(DownloadTask task) {
 253     if (task.getKey().equals(mUrl)) {
 254       getBinding().setProgress(100);
 255       Toast.makeText(this, getString(R.string.download_success), Toast.LENGTH_SHORT).show();
 256       getBinding().setStateStr(getString(R.string.re_start));
 257       getBinding().setSpeed(&quot;&quot;);
 258 
 259 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260       ALog.d(TAG, &quot;md5: &quot; + CommonUtil.getFileMD5(new File(task.getDownloadPath())));</span>
 261 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 262 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 262 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 263 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265       ALog.d(TAG, &quot;md5: &quot; + CommonUtil.getFileMD5(new File(task.getFilePath())));</span>
 266 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 267 
 268     }
 269   }
 270 
 271   @Override
 272   protected int setLayoutId() {
 273     return R.layout.activity_single;
 274   }
 275 
 276   public void onClick(View view) {
 277     switch (view.getId()) {
 278       case R.id.start:
 279         if (mTarget.isRunning()) {
 280           Aria.download(this).load(mUrl).stop();
 281         } else {
 282           startD();
 283         }
 284         break;
 285       case R.id.cancel:
 286         Aria.download(this).load(mUrl).cancel(true);
 287         break;
 288     }
 289   }
 290 
 291   private void startD() {
 292     Aria.download(SingleTaskActivity.this)
 293         .load(mUrl)
<abbr title=" 294         //.addHeader(&quot;Accept&quot;, &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;)"> 294         //.addHeader(&quot;Accept&quot;, &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/ap🔵</abbr>
 295         //.addHeader(&quot;Accept-Encoding&quot;, &quot;gzip, deflate&quot;)
 296         //.addHeader(&quot;DNT&quot;, &quot;1&quot;)
<abbr title=" 297         //.addHeader(&quot;Cookie&quot;, &quot;BAIDUID=648E5FF020CC69E8DD6F492D1068AAA9:FG=1; BIDUPSID=648E5FF020CC69E8DD6F492D1068AAA9; PSTM=1519099573; BD_UPN=12314753; locale=zh; BDSVRTM=0&quot;)"> 297         //.addHeader(&quot;Cookie&quot;, &quot;BAIDUID=648E5FF020CC69E8DD6F492D1068AAA9:FG=1; BIDUPSID=648E5FF020CC69E8D🔵</abbr>
 298         .useServerFileName(true)
 299         .setFilePath(mFilePath, true)
 300         .setFileLenAdapter(new IHttpFileLenAdapter() {
 301           @Override public long handleFileLen(Map&lt;String, List&lt;String&gt;&gt; headers) {
 302 
 303             List&lt;String&gt; sLength = headers.get(&quot;Content-Length&quot;);
 304             if (sLength == null || sLength.isEmpty()) {
 305               return -1;
 306             }
 307             String temp = sLength.get(0);
 308 
 309             return Long.parseLong(temp);
 310           }
 311         })
 312         .start();
 313   }
 314 
 315   @Override
 316   protected void onStop() {
 317     super.onStop();
 318     //Aria.download(this).unRegister();
 319   }
 320 
 321   @Override protected void dataCallback(int result, Object data) {
 322     super.dataCallback(result, data);
 323     if (result == ModifyUrlDialog.MODIFY_URL_DIALOG_RESULT) {
 324       mModule.uploadUrl(this, String.valueOf(data));
 325     } else if (result == ModifyPathDialog.MODIFY_PATH_RESULT) {
 326       mModule.updateFilePath(this, String.valueOf(data));
 327     }
 328   }
 329 }</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  
  17  package com.arialyy.simple.core.download;
  18  
  19  import android.arch.lifecycle.Observer;
  20  import android.arch.lifecycle.ViewModelProviders;
  21  import android.content.BroadcastReceiver;
  22  import android.content.Context;
  23  import android.content.Intent;
  24  import android.os.Bundle;
  25  import android.support.annotation.Nullable;
  26  import android.util.Log;
  27  import android.view.Menu;
  28  import android.view.MenuItem;
  29  import android.view.View;
  30  import android.widget.Toast;
  31  
  32  import com.arialyy.annotations.Download;
  33  import com.arialyy.aria.core.Aria;
  34  import com.arialyy.aria.core.download.DownloadEntity;
  35  import com.arialyy.aria.core.download.DownloadTarget;
  36  import com.arialyy.aria.core.download.DownloadTask;
  37  import com.arialyy.aria.core.inf.IEntity;
  38  import com.arialyy.aria.core.inf.IHttpFileLenAdapter;
  39  import com.arialyy.aria.core.scheduler.ISchedulers;
  40  import com.arialyy.aria.util.ALog;
  41  import com.arialyy.aria.util.CommonUtil;
  42  import com.arialyy.frame.util.show.T;
  43  import com.arialyy.simple.R;
  44  import com.arialyy.simple.base.BaseActivity;
  45  import com.arialyy.simple.common.ModifyPathDialog;
  46  import com.arialyy.simple.common.ModifyUrlDialog;
  47  import com.arialyy.simple.databinding.ActivitySingleBinding;
  48  
  49  import com.arialyy.simple.util.AppUtil;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +import java.io.File;</span>
  51  import java.io.IOException;
  52  import java.util.List;
  53  import java.util.Map;
  54  
  55  public class SingleTaskActivity extends BaseActivity&lt;ActivitySingleBinding&gt; {
  56  
  57    private String mUrl;
  58    private String mFilePath;
  59    private HttpDownloadModule mModule;
  60    private DownloadTarget mTarget;
  61  
  62    BroadcastReceiver receiver = new BroadcastReceiver() {
  63      @Override
  64      public void onReceive(Context context, Intent intent) {
  65        if (intent.getAction().equals(ISchedulers.ARIA_TASK_INFO_ACTION)) {
  66          ALog.d(TAG, &quot;state = &quot; + intent.getIntExtra(ISchedulers.TASK_STATE, -1));
  67          ALog.d(TAG, &quot;type = &quot; + intent.getIntExtra(ISchedulers.TASK_TYPE, -1));
  68          ALog.d(TAG, &quot;speed = &quot; + intent.getLongExtra(ISchedulers.TASK_SPEED, -1));
  69          ALog.d(TAG, &quot;percent = &quot; + intent.getIntExtra(ISchedulers.TASK_PERCENT, -1));
  70          ALog.d(TAG, &quot;entity = &quot; + intent.getParcelableExtra(ISchedulers.TASK_ENTITY).toString());
  71        }
  72      }
  73    };
  74  
  75    @Override
  76    protected void onResume() {
  77      super.onResume();
  78      //registerReceiver(receiver, new IntentFilter(ISchedulers.ARIA_TASK_INFO_ACTION));
  79    }
  80  
  81    @Override
  82    protected void onDestroy() {
  83      super.onDestroy();
  84      //unregisterReceiver(receiver);
  85      Aria.download(this).unRegister();
  86    }
  87  
  88    @Override
  89    protected void init(Bundle savedInstanceState) {
  90      super.init(savedInstanceState);
  91      setTitle(&quot;单任务下载&quot;);
  92      Aria.download(this).register();
  93      mModule = ViewModelProviders.of(this).get(HttpDownloadModule.class);
  94      mModule.getHttpDownloadInfo(this).observe(this, new Observer&lt;DownloadEntity&gt;() {
  95  
  96        @Override public void onChanged(@Nullable DownloadEntity entity) {
  97          if (entity == null) {
  98            return;
  99          }
 100          mTarget = Aria.download(SingleTaskActivity.this).load(entity.getUrl());
 101          if (mTarget.getTaskState() == IEntity.STATE_STOP) {
 102            getBinding().setStateStr(getString(R.string.resume));
 103          } else if (mTarget.isRunning()) {
 104            getBinding().setStateStr(getString(R.string.stop));
 105          }
 106  
 107          if (entity.getFileSize() != 0) {
 108            getBinding().setFileSize(CommonUtil.formatFileSize(entity.getFileSize()));
 109            getBinding().setProgress(entity.isComplete() ? 100
 110                : (int) (entity.getCurrentProgress() * 100 / entity.getFileSize()));
 111          }
 112          getBinding().setUrl(entity.getUrl());
 113          getBinding().setFilePath(entity.getFilePath());
 114          mUrl = entity.getUrl();
 115          mFilePath = entity.getFilePath();
 116        }
 117      });
 118      getBinding().setViewModel(this);
 119      try {
 120        getBinding().codeView.setSource(AppUtil.getHelpCode(this, &quot;HttpDownload.java&quot;));
 121      } catch (IOException e) {
 122        e.printStackTrace();
 123      }
 124    }
 125  
 126    public void chooseUrl() {
 127      ModifyUrlDialog dialog =
 128          new ModifyUrlDialog(this, getString(R.string.modify_url_dialog_title), mUrl);
 129      dialog.show(getSupportFragmentManager(), &quot;ModifyUrlDialog&quot;);
 130    }
 131  
 132    public void chooseFilePath() {
 133      ModifyPathDialog dialog =
 134          new ModifyPathDialog(this, getString(R.string.modify_file_path), mFilePath);
 135      dialog.show(getSupportFragmentManager(), &quot;ModifyPathDialog&quot;);
 136    }
 137  
 138    @Override
 139    public boolean onCreateOptionsMenu(Menu menu) {
 140      getMenuInflater().inflate(R.menu.menu_single_task_activity, menu);
 141      return super.onCreateOptionsMenu(menu);
 142    }
 143  
 144    @Override
 145    public boolean onMenuItemClick(MenuItem item) {
 146      int speed = -1;
 147      String msg = &quot;&quot;;
 148      switch (item.getItemId()) {
 149        case R.id.help:
 150          msg = &quot;一些小知识点：\n&quot;
 151              + &quot;1、你可以在注解中增加链接，用于指定被注解的方法只能被特定的下载任务回调，以防止progress乱跳\n&quot;
 152              + &quot;2、当遇到网络慢的情况时，你可以先使用onPre()更新UI界面，待连接成功时，再在onTaskPre()获取完整的task数据，然后给UI界面设置正确的数据\n&quot;
 153              + &quot;3、你可以在界面初始化时通过Aria.download(this).load(URL).getPercent()等方法快速获取相关任务的一些数据&quot;;
 154          showMsgDialog(&quot;tip&quot;, msg);
 155          break;
 156        case R.id.speed_0:
 157          speed = 0;
 158          break;
 159        case R.id.speed_128:
 160          speed = 128;
 161          break;
 162        case R.id.speed_256:
 163          speed = 256;
 164          break;
 165        case R.id.speed_512:
 166          speed = 512;
 167          break;
 168        case R.id.speed_1m:
 169          speed = 1024;
 170          break;
 171      }
 172      if (speed &gt; -1) {
 173        msg = item.getTitle().toString();
 174        Aria.download(this).setMaxSpeed(speed);
 175        T.showShort(this, msg);
 176      }
 177      return true;
 178    }
 179  
 180    @Download.onWait
 181    void onWait(DownloadTask task) {
 182      if (task.getKey().equals(mUrl)) {
 183        Log.d(TAG, &quot;wait ==&gt; &quot; + task.getDownloadEntity().getFileName());
 184      }
 185    }
 186  
 187    @Download.onPre
 188    protected void onPre(DownloadTask task) {
 189      if (task.getKey().equals(mUrl)) {
 190        getBinding().setStateStr(getString(R.string.stop));
 191      }
 192    }
 193  
 194    @Download.onTaskStart
 195    void taskStart(DownloadTask task) {
 196      if (task.getKey().equals(mUrl)) {
 197        getBinding().setFileSize(task.getConvertFileSize());
 198        ALog.d(TAG, &quot;isComplete = &quot; + task.isComplete() + &quot;, state = &quot; + task.getState());
 199      }
 200    }
 201  
 202    @Download.onTaskRunning
 203    protected void running(DownloadTask task) {
 204      if (task.getKey().equals(mUrl)) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +      ALog.d(TAG, &quot;isRunning&quot;);</span>
 206        //Log.d(TAG, task.getKey());
 207        long len = task.getFileSize();
 208        if (len == 0) {
 209          getBinding().setProgress(0);
 210        } else {
 211          getBinding().setProgress(task.getPercent());
 212        }
 213        getBinding().setSpeed(task.getConvertSpeed());
 214      }
 215    }
 216  
 217    @Download.onTaskResume
 218    void taskResume(DownloadTask task) {
 219      if (task.getKey().equals(mUrl)) {
 220        getBinding().setStateStr(getString(R.string.stop));
 221      }
 222    }
 223  
 224    @Download.onTaskStop
 225    void taskStop(DownloadTask task) {
 226      if (task.getKey().equals(mUrl)) {
 227        getBinding().setStateStr(getString(R.string.resume));
 228        getBinding().setSpeed(&quot;&quot;);
 229      }
 230    }
 231  
 232    @Download.onTaskCancel
 233    void taskCancel(DownloadTask task) {
 234      if (task.getKey().equals(mUrl)) {
 235        getBinding().setProgress(0);
 236        getBinding().setStateStr(getString(R.string.start));
 237        getBinding().setSpeed(&quot;&quot;);
 238        Log.d(TAG, &quot;cancel&quot;);
 239      }
 240    }
 241  
 242    @Download.onTaskFail
 243    void taskFail(DownloadTask task, Exception e) {
 244      if (task.getKey().equals(mUrl)) {
 245        Toast.makeText(SingleTaskActivity.this, getString(R.string.download_fail), Toast.LENGTH_SHORT)
 246            .show();
 247        getBinding().setStateStr(getString(R.string.start));
 248      }
 249    }
 250  
 251    @Download.onTaskComplete
 252    void taskComplete(DownloadTask task) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -</span>
 254      if (task.getKey().equals(mUrl)) {
 255        getBinding().setProgress(100);
 256        Toast.makeText(SingleTaskActivity.this, getString(R.string.download_success),
 257            Toast.LENGTH_SHORT).show();
 258        getBinding().setStateStr(getString(R.string.re_start));
 259        getBinding().setSpeed(&quot;&quot;);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +      ALog.d(TAG, &quot;md5: &quot; + CommonUtil.getFileMD5(new File(task.getDownloadPath())));</span>
 261      }
 262    }
 263  
 264    @Override
 265    protected int setLayoutId() {
 266      return R.layout.activity_single;
 267    }
 268  
 269    public void onClick(View view) {
 270      switch (view.getId()) {
 271        case R.id.start:
 272          if (mTarget.isRunning()) {
 273            Aria.download(this).load(mUrl).stop();
 274          } else {
 275            startD();
 276          }
 277          break;
 278        case R.id.cancel:
 279          Aria.download(this).load(mUrl).cancel(true);
 280          break;
 281      }
 282    }
 283  
 284    private void startD() {
 285      Aria.download(SingleTaskActivity.this)
 286          .load(mUrl)
<abbr title=" 287          //.addHeader(&quot;Accept&quot;, &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;)"> 287          //.addHeader(&quot;Accept&quot;, &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=🔵</abbr>
 288          //.addHeader(&quot;Accept-Encoding&quot;, &quot;gzip, deflate&quot;)
 289          //.addHeader(&quot;DNT&quot;, &quot;1&quot;)
<abbr title=" 290          //.addHeader(&quot;Cookie&quot;, &quot;BAIDUID=648E5FF020CC69E8DD6F492D1068AAA9:FG=1; BIDUPSID=648E5FF020CC69E8DD6F492D1068AAA9; PSTM=1519099573; BD_UPN=12314753; locale=zh; BDSVRTM=0&quot;)"> 290          //.addHeader(&quot;Cookie&quot;, &quot;BAIDUID=648E5FF020CC69E8DD6F492D1068AAA9:FG=1; BIDUPSID=648E5FF020CC69E8DD6F492D10🔵</abbr>
 291          .useServerFileName(true)
 292          .setFilePath(mFilePath, true)
 293          .setFileLenAdapter(new IHttpFileLenAdapter() {
 294            @Override public long handleFileLen(Map&lt;String, List&lt;String&gt;&gt; headers) {
 295  
 296              List&lt;String&gt; sLength = headers.get(&quot;Content-Length&quot;);
 297              if (sLength == null || sLength.isEmpty()) {
 298                return -1;
 299              }
 300              String temp = sLength.get(0);
 301  
 302              return Long.parseLong(temp);
 303            }
 304          })
 305          .start();
 306    }
 307  
 308    @Override
 309    protected void onStop() {
 310      super.onStop();
 311      //Aria.download(this).unRegister();
 312    }
 313  
 314    @Override protected void dataCallback(int result, Object data) {
 315      super.dataCallback(result, data);
 316      if (result == ModifyUrlDialog.MODIFY_URL_DIALOG_RESULT) {
 317        mModule.uploadUrl(this, String.valueOf(data));
 318      } else if (result == ModifyPathDialog.MODIFY_PATH_RESULT) {
 319        mModule.updateFilePath(this, String.valueOf(data));
 320      }
 321    }
 322  }</pre></td>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  
  17  package com.arialyy.simple.core.download;
  18  
  19  import android.arch.lifecycle.Observer;
  20  import android.arch.lifecycle.ViewModelProviders;
  21  import android.content.BroadcastReceiver;
  22  import android.content.Context;
  23  import android.content.Intent;
  24  import android.os.Bundle;
  25  import android.support.annotation.Nullable;
  26  import android.util.Log;
  27  import android.view.Menu;
  28  import android.view.MenuItem;
  29  import android.view.View;
  30  import android.widget.Toast;
  31  
  32  import com.arialyy.annotations.Download;
  33  import com.arialyy.aria.core.Aria;
  34  import com.arialyy.aria.core.download.DownloadEntity;
  35  import com.arialyy.aria.core.download.DownloadTarget;
  36  import com.arialyy.aria.core.download.DownloadTask;
  37  import com.arialyy.aria.core.inf.IEntity;
  38  import com.arialyy.aria.core.inf.IHttpFileLenAdapter;
  39  import com.arialyy.aria.core.scheduler.ISchedulers;
  40  import com.arialyy.aria.util.ALog;
  41  import com.arialyy.aria.util.CommonUtil;
  42  import com.arialyy.frame.util.show.T;
  43  import com.arialyy.simple.R;
  44  import com.arialyy.simple.base.BaseActivity;
  45  import com.arialyy.simple.common.ModifyPathDialog;
  46  import com.arialyy.simple.common.ModifyUrlDialog;
  47  import com.arialyy.simple.databinding.ActivitySingleBinding;
  48  
  49  import com.arialyy.simple.util.AppUtil;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +import java.io.File;</span>
  51  import java.io.IOException;
  52  import java.util.List;
  53  import java.util.Map;
  54  
  55  public class SingleTaskActivity extends BaseActivity&lt;ActivitySingleBinding&gt; {
  56  
  57    private String mUrl;
  58    private String mFilePath;
  59    private HttpDownloadModule mModule;
  60    private DownloadTarget mTarget;
  61  
  62    BroadcastReceiver receiver = new BroadcastReceiver() {
  63      @Override
  64      public void onReceive(Context context, Intent intent) {
  65        if (intent.getAction().equals(ISchedulers.ARIA_TASK_INFO_ACTION)) {
  66          ALog.d(TAG, &quot;state = &quot; + intent.getIntExtra(ISchedulers.TASK_STATE, -1));
  67          ALog.d(TAG, &quot;type = &quot; + intent.getIntExtra(ISchedulers.TASK_TYPE, -1));
  68          ALog.d(TAG, &quot;speed = &quot; + intent.getLongExtra(ISchedulers.TASK_SPEED, -1));
  69          ALog.d(TAG, &quot;percent = &quot; + intent.getIntExtra(ISchedulers.TASK_PERCENT, -1));
  70          ALog.d(TAG, &quot;entity = &quot; + intent.getParcelableExtra(ISchedulers.TASK_ENTITY).toString());
  71        }
  72      }
  73    };
  74  
  75    @Override
  76    protected void onResume() {
  77      super.onResume();
  78      //registerReceiver(receiver, new IntentFilter(ISchedulers.ARIA_TASK_INFO_ACTION));
  79    }
  80  
  81    @Override
  82    protected void onDestroy() {
  83      super.onDestroy();
  84      //unregisterReceiver(receiver);
  85      Aria.download(this).unRegister();
  86    }
  87  
  88    @Override
  89    protected void init(Bundle savedInstanceState) {
  90      super.init(savedInstanceState);
  91      setTitle(&quot;单任务下载&quot;);
  92      Aria.download(this).register();
  93      mModule = ViewModelProviders.of(this).get(HttpDownloadModule.class);
  94      mModule.getHttpDownloadInfo(this).observe(this, new Observer&lt;DownloadEntity&gt;() {
  95  
  96        @Override public void onChanged(@Nullable DownloadEntity entity) {
  97          if (entity == null) {
  98            return;
  99          }
 100          mTarget = Aria.download(SingleTaskActivity.this).load(entity.getUrl());
 101          if (mTarget.getTaskState() == IEntity.STATE_STOP) {
 102            getBinding().setStateStr(getString(R.string.resume));
 103          } else if (mTarget.isRunning()) {
 104            getBinding().setStateStr(getString(R.string.stop));
 105          }
 106  
 107          if (entity.getFileSize() != 0) {
 108            getBinding().setFileSize(CommonUtil.formatFileSize(entity.getFileSize()));
 109            getBinding().setProgress(entity.isComplete() ? 100
 110                : (int) (entity.getCurrentProgress() * 100 / entity.getFileSize()));
 111          }
 112          getBinding().setUrl(entity.getUrl());
 113          getBinding().setFilePath(entity.getFilePath());
 114          mUrl = entity.getUrl();
 115          mFilePath = entity.getFilePath();
 116        }
 117      });
 118      getBinding().setViewModel(this);
 119      try {
 120        getBinding().codeView.setSource(AppUtil.getHelpCode(this, &quot;HttpDownload.java&quot;));
 121      } catch (IOException e) {
 122        e.printStackTrace();
 123      }
 124    }
 125  
 126    public void chooseUrl() {
 127      ModifyUrlDialog dialog =
 128          new ModifyUrlDialog(this, getString(R.string.modify_url_dialog_title), mUrl);
 129      dialog.show(getSupportFragmentManager(), &quot;ModifyUrlDialog&quot;);
 130    }
 131  
 132    public void chooseFilePath() {
 133      ModifyPathDialog dialog =
 134          new ModifyPathDialog(this, getString(R.string.modify_file_path), mFilePath);
 135      dialog.show(getSupportFragmentManager(), &quot;ModifyPathDialog&quot;);
 136    }
 137  
 138    @Override
 139    public boolean onCreateOptionsMenu(Menu menu) {
 140      getMenuInflater().inflate(R.menu.menu_single_task_activity, menu);
 141      return super.onCreateOptionsMenu(menu);
 142    }
 143  
 144    @Override
 145    public boolean onMenuItemClick(MenuItem item) {
 146      int speed = -1;
 147      String msg = &quot;&quot;;
 148      switch (item.getItemId()) {
 149        case R.id.help:
 150          msg = &quot;一些小知识点：\n&quot;
 151              + &quot;1、你可以在注解中增加链接，用于指定被注解的方法只能被特定的下载任务回调，以防止progress乱跳\n&quot;
 152              + &quot;2、当遇到网络慢的情况时，你可以先使用onPre()更新UI界面，待连接成功时，再在onTaskPre()获取完整的task数据，然后给UI界面设置正确的数据\n&quot;
 153              + &quot;3、你可以在界面初始化时通过Aria.download(this).load(URL).getPercent()等方法快速获取相关任务的一些数据&quot;;
 154          showMsgDialog(&quot;tip&quot;, msg);
 155          break;
 156        case R.id.speed_0:
 157          speed = 0;
 158          break;
 159        case R.id.speed_128:
 160          speed = 128;
 161          break;
 162        case R.id.speed_256:
 163          speed = 256;
 164          break;
 165        case R.id.speed_512:
 166          speed = 512;
 167          break;
 168        case R.id.speed_1m:
 169          speed = 1024;
 170          break;
 171      }
 172      if (speed &gt; -1) {
 173        msg = item.getTitle().toString();
 174        Aria.download(this).setMaxSpeed(speed);
 175        T.showShort(this, msg);
 176      }
 177      return true;
 178    }
 179  
 180    @Download.onWait
 181    void onWait(DownloadTask task) {
 182      if (task.getKey().equals(mUrl)) {
 183        Log.d(TAG, &quot;wait ==&gt; &quot; + task.getDownloadEntity().getFileName());
 184      }
 185    }
 186  
 187    @Download.onPre
 188    protected void onPre(DownloadTask task) {
 189      if (task.getKey().equals(mUrl)) {
 190        getBinding().setStateStr(getString(R.string.stop));
 191      }
 192    }
 193  
 194    @Download.onTaskStart
 195    void taskStart(DownloadTask task) {
 196      if (task.getKey().equals(mUrl)) {
 197        getBinding().setFileSize(task.getConvertFileSize());
 198        ALog.d(TAG, &quot;isComplete = &quot; + task.isComplete() + &quot;, state = &quot; + task.getState());
 199      }
 200    }
 201  
 202    @Download.onTaskRunning
 203    protected void running(DownloadTask task) {
 204      if (task.getKey().equals(mUrl)) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +      ALog.d(TAG, &quot;isRunning&quot;);</span>
 206        //Log.d(TAG, task.getKey());
 207        long len = task.getFileSize();
 208        if (len == 0) {
 209          getBinding().setProgress(0);
 210        } else {
 211          getBinding().setProgress(task.getPercent());
 212        }
 213        getBinding().setSpeed(task.getConvertSpeed());
 214      }
 215    }
 216  
 217    @Download.onTaskResume
 218    void taskResume(DownloadTask task) {
 219      if (task.getKey().equals(mUrl)) {
 220        getBinding().setStateStr(getString(R.string.stop));
 221      }
 222    }
 223  
 224    @Download.onTaskStop
 225    void taskStop(DownloadTask task) {
 226      if (task.getKey().equals(mUrl)) {
 227        getBinding().setStateStr(getString(R.string.resume));
 228        getBinding().setSpeed(&quot;&quot;);
 229      }
 230    }
 231  
 232    @Download.onTaskCancel
 233    void taskCancel(DownloadTask task) {
 234      if (task.getKey().equals(mUrl)) {
 235        getBinding().setProgress(0);
 236        getBinding().setStateStr(getString(R.string.start));
 237        getBinding().setSpeed(&quot;&quot;);
 238        Log.d(TAG, &quot;cancel&quot;);
 239      }
 240    }
 241  
 242    @Download.onTaskFail
 243    void taskFail(DownloadTask task, Exception e) {
 244      if (task.getKey().equals(mUrl)) {
 245        Toast.makeText(SingleTaskActivity.this, getString(R.string.download_fail), Toast.LENGTH_SHORT)
 246            .show();
 247        getBinding().setStateStr(getString(R.string.start));
 248      }
 249    }
 250  
 251    @Download.onTaskComplete
 252    void taskComplete(DownloadTask task) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -</span>
 254      if (task.getKey().equals(mUrl)) {
 255        getBinding().setProgress(100);
 256        Toast.makeText(SingleTaskActivity.this, getString(R.string.download_success),
 257            Toast.LENGTH_SHORT).show();
 258        getBinding().setStateStr(getString(R.string.re_start));
 259        getBinding().setSpeed(&quot;&quot;);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +      ALog.d(TAG, &quot;md5: &quot; + CommonUtil.getFileMD5(new File(task.getFilePath())));</span>
 261      }
 262    }
 263  
 264    @Override
 265    protected int setLayoutId() {
 266      return R.layout.activity_single;
 267    }
 268  
 269    public void onClick(View view) {
 270      switch (view.getId()) {
 271        case R.id.start:
 272          if (mTarget.isRunning()) {
 273            Aria.download(this).load(mUrl).stop();
 274          } else {
 275            startD();
 276          }
 277          break;
 278        case R.id.cancel:
 279          Aria.download(this).load(mUrl).cancel(true);
 280          break;
 281      }
 282    }
 283  
 284    private void startD() {
 285      Aria.download(SingleTaskActivity.this)
 286          .load(mUrl)
<abbr title=" 287          //.addHeader(&quot;Accept&quot;, &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;)"> 287          //.addHeader(&quot;Accept&quot;, &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=🔵</abbr>
 288          //.addHeader(&quot;Accept-Encoding&quot;, &quot;gzip, deflate&quot;)
 289          //.addHeader(&quot;DNT&quot;, &quot;1&quot;)
<abbr title=" 290          //.addHeader(&quot;Cookie&quot;, &quot;BAIDUID=648E5FF020CC69E8DD6F492D1068AAA9:FG=1; BIDUPSID=648E5FF020CC69E8DD6F492D1068AAA9; PSTM=1519099573; BD_UPN=12314753; locale=zh; BDSVRTM=0&quot;)"> 290          //.addHeader(&quot;Cookie&quot;, &quot;BAIDUID=648E5FF020CC69E8DD6F492D1068AAA9:FG=1; BIDUPSID=648E5FF020CC69E8DD6F492D10🔵</abbr>
 291          .useServerFileName(true)
 292          .setFilePath(mFilePath, true)
 293          .setFileLenAdapter(new IHttpFileLenAdapter() {
 294            @Override public long handleFileLen(Map&lt;String, List&lt;String&gt;&gt; headers) {
 295  
 296              List&lt;String&gt; sLength = headers.get(&quot;Content-Length&quot;);
 297              if (sLength == null || sLength.isEmpty()) {
 298                return -1;
 299              }
 300              String temp = sLength.get(0);
 301  
 302              return Long.parseLong(temp);
 303            }
 304          })
 305          .start();
 306    }
 307  
 308    @Override
 309    protected void onStop() {
 310      super.onStop();
 311      //Aria.download(this).unRegister();
 312    }
 313  
 314    @Override protected void dataCallback(int result, Object data) {
 315      super.dataCallback(result, data);
 316      if (result == ModifyUrlDialog.MODIFY_URL_DIALOG_RESULT) {
 317        mModule.uploadUrl(this, String.valueOf(data));
 318      } else if (result == ModifyPathDialog.MODIFY_PATH_RESULT) {
 319        mModule.updateFilePath(this, String.valueOf(data));
 320      }
 321    }
 322  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            